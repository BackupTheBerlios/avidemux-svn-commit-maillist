<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r7299 - in	branches/avidemux_2.5_branch_gruntster:	avidemux/ADM_audiocodec avidemux/ADM_codecs	avidemux/ADM_core/src avidemux/ADM_libraries	avidemux/ADM_outputs cmake cmake/patches	plugins/ADM_videoEncoder/ADM_vidEnc_avcodec
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2011-June/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r7299%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster%3A%0A%09avidemux/ADM_audiocodec%20avidemux/ADM_codecs%0A%09avidemux/ADM_core/src%20avidemux/ADM_libraries%0A%09avidemux/ADM_outputs%20cmake%20cmake/patches%0A%09plugins/ADM_videoEncoder/ADM_vidEnc_avcodec&In-Reply-To=%3C20110624174357.EDCB248294E%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004452.html">
   <LINK REL="Next"  HREF="004454.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r7299 - in	branches/avidemux_2.5_branch_gruntster:	avidemux/ADM_audiocodec avidemux/ADM_codecs	avidemux/ADM_core/src avidemux/ADM_libraries	avidemux/ADM_outputs cmake cmake/patches	plugins/ADM_videoEncoder/ADM_vidEnc_avcodec</H1>
    <B>gruntster at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r7299%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster%3A%0A%09avidemux/ADM_audiocodec%20avidemux/ADM_codecs%0A%09avidemux/ADM_core/src%20avidemux/ADM_libraries%0A%09avidemux/ADM_outputs%20cmake%20cmake/patches%0A%09plugins/ADM_videoEncoder/ADM_vidEnc_avcodec&In-Reply-To=%3C20110624174357.EDCB248294E%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r7299 - in	branches/avidemux_2.5_branch_gruntster:	avidemux/ADM_audiocodec avidemux/ADM_codecs	avidemux/ADM_core/src avidemux/ADM_libraries	avidemux/ADM_outputs cmake cmake/patches	plugins/ADM_videoEncoder/ADM_vidEnc_avcodec">gruntster at mail.berlios.de
       </A><BR>
    <I>Fri Jun 24 19:43:57 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004452.html">[Avidemux-svn-commit] r7298 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/vdpauFilters
</A></li>
        <LI>Next message: <A HREF="004454.html">[Avidemux-svn-commit] r7300 - in	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core:	include src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4453">[ date ]</a>
              <a href="thread.html#4453">[ thread ]</a>
              <a href="subject.html#4453">[ subject ]</a>
              <a href="author.html#4453">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: gruntster
Date: 2011-06-24 19:43:57 +0200 (Fri, 24 Jun 2011)
New Revision: 7299

Added:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.tar.bz2
Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.7-rc1.tar.gz
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmp43.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_memcpy.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/ADM_lavformat.cpp
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegPrepareTar.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_ffv1.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12enc.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_vc1dec.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_matroskaenc.c.patch
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
Log:
[ffmpeg] upgrade ffmpeg to 0.8

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp	2011-06-24 17:43:57 UTC (rev 7299)
@@ -60,7 +60,7 @@
     _channels=info-&gt;channels;
     _blockalign=_context-&gt;block_align = info-&gt;blockalign;
     _context-&gt;bit_rate = info-&gt;byterate*8;
-    _context-&gt;codec_type=CODEC_TYPE_AUDIO;
+    _context-&gt;codec_type = AVMEDIA_TYPE_AUDIO;
     switch(fourcc)
     {
       case WAV_WMA:

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmp43.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmp43.cpp	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmp43.cpp	2011-06-24 17:43:57 UTC (rev 7299)
@@ -278,16 +278,15 @@
 }
 uint8_t decoderFF::decodeHeaderOnly (void)
 {
-  if (codecId == CODEC_ID_H264)
-    _context-&gt;hurry_up = 4;
-  else
-    _context-&gt;hurry_up = 5;
-  printf (&quot;\n[lavc] Hurry up\n&quot;);
+  _context-&gt;skip_frame = AVDISCARD_ALL;
+
+  printf (&quot;\n[lavc] decode header only\n&quot;);
   return 1;
 }
 uint8_t decoderFF::decodeFull (void)
 {
-  _context-&gt;hurry_up = 0;
+  _context-&gt;skip_frame = AVDISCARD_DEFAULT;
+
   printf (&quot;\n[lavc] full decoding\n&quot;);
   return 1;
 }
@@ -340,13 +339,13 @@
 
   ret = avcodec_decode_video2(_context, &amp;_frame, &amp;got_picture, &amp;avpkt);
   out-&gt;_qStride = 0;		//Default = no quant
-  if (0 &gt; ret &amp;&amp; !_context-&gt;hurry_up)
+  if (0 &gt; ret &amp;&amp; _context-&gt;skip_frame &lt;= AVDISCARD_DEFAULT)
     {
       printf (&quot;\n[lavc] error in FFMP43/mpeg4!\n&quot;);
       printf (&quot;[lavc] Err: %d, size :%d\n&quot;, ret, in-&gt;dataLength);
       return 0;
     }
-  if (!got_picture &amp;&amp; !_context-&gt;hurry_up)
+  if (!got_picture &amp;&amp; _context-&gt;skip_frame &lt;= AVDISCARD_DEFAULT)
     {
       // Some encoder code a vop header with the 
       // vop flag set to 0
@@ -385,7 +384,7 @@
       //return 1;
       return 0;
     }
-  if (_context-&gt;hurry_up)
+  if (_context-&gt;skip_frame &gt; AVDISCARD_DEFAULT)
     {
       out-&gt;flags = frameType ();
       return 1;
@@ -601,7 +600,8 @@
 
 uint8_t   decoderFFH264::uncompress (ADMCompressedImage * in, ADMImage * out)
 {
-  if(!_context-&gt;hurry_up) return decoderFF::uncompress (in, out);
+  if (_context-&gt;skip_frame &lt;= AVDISCARD_DEFAULT)
+	  return decoderFF::uncompress (in, out);
   
   uint32_t nalSize, isAvc;
   av_getAVCStreamInfo(_context,&amp;nalSize,&amp;isAvc);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_memcpy.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_memcpy.cpp	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_memcpy.cpp	2011-06-24 17:43:57 UTC (rev 7299)
@@ -375,33 +375,7 @@
 }
 #endif /* ARCH_X86 */
 
-static struct {
-  const char *name;
-  void *(* function)(void *to, const void *from, size_t len);
-
-  uint64_t time; /* This type could be used for non-MSC build too! */
-
-  uint32_t cpu_require;
-} memcpy_method[] =
-{
-  { NULL, NULL, 0, 0 },
-  { &quot;libc memcpy()&quot;, memcpy, 0, 0 },
 #if defined(ADM_CPU_X86)
-  { &quot;linux kernel memcpy()&quot;, linux_kernel_memcpy, 0, 0 },
-#if defined(ADM_CPU_X86)
-  { &quot;MMX optimized memcpy()&quot;, mmx_memcpy, 0, FF_MM_MMX },
-  { &quot;MMXEXT optimized memcpy()&quot;, mmx2_memcpy, 0, FF_MM_MMXEXT },
-  { &quot;SSE optimized memcpy()&quot;, sse_memcpy, 0, FF_MM_MMXEXT|FF_MM_SSE },
-#endif
-#endif /* ARCH_X86 */
-#if 0 &amp;&amp; defined(ADM_CPU_PPC) &amp;&amp; !defined (__APPLE__)
-  { &quot;ppcasm_memcpy()&quot;, ppcasm_memcpy, 0, 0 },
-  { &quot;ppcasm_cacheable_memcpy()&quot;, ppcasm_cacheable_memcpy, 0, FF_MM_ACCEL_PPC_CACHE32 },
-#endif /* ARCH_PPC &amp;&amp; !HOST_OS_DARWIN */
-  { NULL, NULL, 0, 0 }
-};
-
-#if defined(ADM_CPU_X86)
 static unsigned long long int rdtsc(void)
 {
   unsigned long long int x;

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.7-rc1.tar.gz
===================================================================
(Binary files differ)

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.tar.bz2 (from rev 7295, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.7-rc1.tar.gz)
===================================================================
(Binary files differ)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/ADM_lavformat.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/ADM_lavformat.cpp	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/ADM_lavformat.cpp	2011-06-24 17:43:57 UTC (rev 7299)
@@ -190,8 +190,9 @@
 
 					 break;
                 case MUXER_MATROSKA:
-                        strcpy(oc-&gt;title,&quot;Avidemux&quot;);
-                        strcpy(oc-&gt;author,&quot;Avidemux&quot;);
+						av_dict_set(&amp;oc-&gt;metadata, &quot;title&quot;, &quot;Avidemux&quot;, 0);
+						av_dict_set(&amp;oc-&gt;metadata, &quot;author&quot;, &quot;Avidemux&quot;, 0);
+
                         if(isMpeg4Compatible(info-&gt;fcc))
                         {
                                 c-&gt;codec_id = CODEC_ID_MPEG4;
@@ -225,11 +226,9 @@
                 case MUXER_MP4:
                 case MUXER_PSP:
                 {
-                        // probably a memeleak here
-                        char *foo=ADM_strdup(filename);
+                        av_dict_set(&amp;oc-&gt;metadata, &quot;title&quot;, ADM_GetFileName(filename), 0);
+						av_dict_set(&amp;oc-&gt;metadata, &quot;author&quot;, &quot;Avidemux&quot;, 0);
 
-                        strcpy(oc-&gt;title,ADM_GetFileName(foo));
-                        strcpy(oc-&gt;author,&quot;Avidemux&quot;);
                         if(isMpeg4Compatible(info-&gt;fcc))
                         {
                                 c-&gt;codec_id = CODEC_ID_MPEG4;
@@ -335,7 +334,7 @@
 			ADM_assert(0);
 	}
 
-	c-&gt;codec_type = CODEC_TYPE_VIDEO;
+	c-&gt;codec_type = AVMEDIA_TYPE_VIDEO;
 	c-&gt;flags=CODEC_FLAG_QSCALE;
 	c-&gt;width = info-&gt;width;
 	c-&gt;height = info-&gt;height;
@@ -442,7 +441,7 @@
                           return 0;
                           break;
           }
-          c-&gt;codec_type = CODEC_TYPE_AUDIO;
+          c-&gt;codec_type = AVMEDIA_TYPE_AUDIO;
 
           c-&gt;bit_rate = audioheader-&gt;byterate*8;
           c-&gt;rc_buffer_size=(c-&gt;bit_rate/(2*8)); // 500 ms worth
@@ -546,7 +545,7 @@
             aprintf(&quot;Adm audio dts: %&quot;LLU&quot;\n&quot;,pkt.dts);
             //printf(&quot;F:%f Q:%u D=%u\n&quot;,f,pkt.pts,timeInUs-_lastAudioDts);
 
-            pkt.flags |= PKT_FLAG_KEY;
+            pkt.flags |= AV_PKT_FLAG_KEY;
             pkt.data= buf;
             pkt.size= len;
             pkt.stream_index=1;
@@ -640,12 +639,12 @@
         if(_type==MUXER_MP4 || _type==MUXER_PSP || _type==MUXER_FLV || _type==MUXER_MATROSKA)
         {
             if(bitstream-&gt;flags &amp; AVI_KEY_FRAME)
-                        pkt.flags |= PKT_FLAG_KEY;
+                        pkt.flags |= AV_PKT_FLAG_KEY;
         }else
             if(!bitstream-&gt;data[0] &amp;&amp;  !bitstream-&gt;data[1] &amp;&amp; bitstream-&gt;data[2]==1)
 	{
             if(bitstream-&gt;data[3]==0xb3 || bitstream-&gt;data[3]==0xb8 ) // Seq start or gop start
-		pkt.flags |= PKT_FLAG_KEY;
+		pkt.flags |= AV_PKT_FLAG_KEY;
 		//printf(&quot;Intra\n&quot;);
 	}
     //printf(&quot;Adm video dts=:%u\n&quot;,pkt.dts);

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2011-06-24 17:43:57 UTC (rev 7299)
@@ -1,7 +1,7 @@
 include(admFFmpegUtil)
 
-set(FFMPEG_VERSION 0.7-rc1)
-set(FFMPEG_SOURCE_ARCHIVE &quot;ffmpeg-${FFMPEG_VERSION}.tar.gz&quot;)
+set(FFMPEG_VERSION 0.8)
+set(FFMPEG_SOURCE_ARCHIVE &quot;ffmpeg-${FFMPEG_VERSION}.tar.bz2&quot;)
 set(FFMPEG_SOURCE_ARCHIVE_DIR &quot;ffmpeg-${FFMPEG_VERSION}&quot;)
 
 #set(FFMPEG_VERSION 26061)	# <A HREF="http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz">http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz</A>
@@ -18,6 +18,7 @@
 set(FFMPEG_MUXERS  flv  matroska  mpeg1vcd  mpeg2dvd  mpeg2svcd  mpegts  mov  mp4  psp)
 set(FFMPEG_PARSERS  ac3  h263  h264  mpeg4video)
 set(FFMPEG_PROTOCOLS  file)
+set(FFMPEG_FILTERS  buffersink)
 set(FFMPEG_FLAGS  --enable-shared --disable-static --disable-everything --enable-hwaccels --enable-postproc --enable-gpl 
 				  --enable-runtime-cpudetect --disable-network --disable-ffplay --disable-ffprobe --prefix=${CMAKE_INSTALL_PREFIX})
 
@@ -70,6 +71,10 @@
 	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-protocol=${protocol})
 endforeach (protocol)
 
+foreach (filter ${FFMPEG_FILTERS})
+	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-filter=${filter})
+endforeach (filter)
+
 if (WIN32)
 	if (ADM_CPU_X86_32)
 		set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-memalign-hack)

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegPrepareTar.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegPrepareTar.cmake	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegPrepareTar.cmake	2011-06-24 17:43:57 UTC (rev 7299)
@@ -6,22 +6,23 @@
 #set(SWSCALE_SOURCE_ARCHIVE &quot;libswscale_r${SWSCALE_VERSION}.tar.gz&quot;)
 
 if (EXISTS &quot;${LIBRARY_SOURCE_DIR}/${FFMPEG_SOURCE_ARCHIVE}&quot;) # AND EXISTS &quot;${LIBRARY_SOURCE_DIR}/${SWSCALE_SOURCE_ARCHIVE}&quot;)
-	if (NOT EXISTS &quot;${FFMPEG_SOURCE_DIR}/ffmpeg.c&quot; OR NOT ${LAST_FFMPEG_VERSION} EQUAL ${FFMPEG_VERSION})
+	if (NOT EXISTS &quot;${FFMPEG_SOURCE_DIR}/ffmpeg.c&quot; OR NOT &quot;${LAST_FFMPEG_VERSION}&quot; EQUAL &quot;${FFMPEG_VERSION}&quot;)
 		find_package(Tar)
+		message(STATUS &quot;Extracting FFmpeg&quot;)
 
 		execute_process(COMMAND ${CMAKE_COMMAND} -E remove_directory &quot;ffmpeg&quot;
 					WORKING_DIRECTORY &quot;${LIBRARY_SOURCE_DIR}&quot;)
 
-		execute_process(COMMAND ${TAR_EXECUTABLE} xvf ${FFMPEG_SOURCE_ARCHIVE}
+		execute_process(COMMAND ${TAR_EXECUTABLE} xvfj ${FFMPEG_SOURCE_ARCHIVE}
 					WORKING_DIRECTORY &quot;${LIBRARY_SOURCE_DIR}&quot;
 					${ffmpegExtractOutput})
 
-		execute_process(COMMAND ${CMAKE_COMMAND} -E rename &quot;ffmpeg-0.7-rc1&quot; &quot;ffmpeg&quot;
+		execute_process(COMMAND ${CMAKE_COMMAND} -E rename &quot;${FFMPEG_SOURCE_ARCHIVE_DIR}&quot; &quot;ffmpeg&quot;
 					WORKING_DIRECTORY &quot;${LIBRARY_SOURCE_DIR}&quot;)
 
 		set(FFMPEG_PERFORM_PATCH 1)
 		set(FFMPEG_PERFORM_BUILD 1)
-	endif (NOT EXISTS &quot;${FFMPEG_SOURCE_DIR}/ffmpeg.c&quot; OR NOT ${LAST_FFMPEG_VERSION} EQUAL ${FFMPEG_VERSION})
+	endif (NOT EXISTS &quot;${FFMPEG_SOURCE_DIR}/ffmpeg.c&quot; OR NOT &quot;${LAST_FFMPEG_VERSION}&quot; EQUAL &quot;${FFMPEG_VERSION}&quot;)
 
 	#if (NOT EXISTS &quot;${FFMPEG_SOURCE_DIR}/libswscale/swscale.c&quot; OR NOT ${LAST_SWSCALE_VERSION} EQUAL ${SWSCALE_VERSION})
 		#find_package(Tar)

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2011-06-24 17:43:57 UTC (rev 7299)
@@ -2,6 +2,7 @@
 
 export curDir=$PWD
 export ffmpegPath=../../avidemux/ADM_libraries/ffmpeg
+export origFfmpegPath=../ffmpeg-0.8
 
 function updatePatch {
 	#cd $ffmpegPath
@@ -18,8 +19,8 @@
 
 	cd $ffmpegPath
 	unix2dos $1/$2
-	unix2dos $1/$2.orig
-	diff -u $1/$2.orig $1/$2 &gt; $curDir/$1_$2.patch
+	unix2dos $origFfmpegPath/$1/$2
+	diff -u $origFfmpegPath/$1/$2 $1/$2 &gt; $curDir/$1_$2.patch
 	cd $curDir
 	dos2unix $1_$2.patch
 }

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2011-06-24 17:43:57 UTC (rev 7299)
@@ -1,6 +1,6 @@
---- libavcodec/avcodec.h.orig	2011-05-10 22:40:28 +0100
-+++ libavcodec/avcodec.h	2011-05-10 22:40:28 +0100
-@@ -636,6 +636,8 @@
+--- ../ffmpeg-0.8/libavcodec/avcodec.h	2011-06-23 20:23:53 +0100
++++ libavcodec/avcodec.h	2011-06-23 20:23:53 +0100
+@@ -619,6 +619,8 @@
  #define CODEC_FLAG2_PSY           0x00080000 ///&lt; Use psycho visual optimizations.
  #define CODEC_FLAG2_SSIM          0x00100000 ///&lt; Compute SSIM during encoding, error[] values are undefined.
  #define CODEC_FLAG2_INTRA_REFRESH 0x00200000 ///&lt; Use periodic insertion of intra blocks instead of keyframes.
@@ -9,7 +9,7 @@
  
  /* Unsupported options :
   *              Syntax Arithmetic coding (SAC)
-@@ -1589,6 +1591,7 @@
+@@ -1594,6 +1596,7 @@
       * - decoding: unused
       */
      int rc_max_rate;
@@ -17,7 +17,7 @@
  
      /**
       * minimum bitrate
-@@ -1603,6 +1606,8 @@
+@@ -1608,6 +1611,8 @@
       * - decoding: unused
       */
      int rc_buffer_size;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_ffv1.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_ffv1.c.patch	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_ffv1.c.patch	2011-06-24 17:43:57 UTC (rev 7299)
@@ -1,6 +1,6 @@
---- libavcodec/ffv1.c.old	2010-12-20 13:49:20 +0000
-+++ libavcodec/ffv1.c	2010-12-20 13:49:20 +0000
-@@ -1734,6 +1734,8 @@
+--- ../ffmpeg-0.8/libavcodec/ffv1.c	2011-06-23 20:23:53 +0100
++++ libavcodec/ffv1.c	2011-06-23 20:23:53 +0100
+@@ -1783,6 +1783,8 @@
          clear_state(f);
      }else{
          p-&gt;key_frame= 0;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch	2011-06-24 17:43:57 UTC (rev 7299)
@@ -1,6 +1,6 @@
---- libavcodec/h263dec.c.orig	2011-05-10 22:40:29 +0100
-+++ libavcodec/h263dec.c	2011-05-10 22:40:29 +0100
-@@ -121,6 +121,25 @@
+--- ../ffmpeg-0.8/libavcodec/h263dec.c	2011-06-23 20:23:53 +0100
++++ libavcodec/h263dec.c	2011-06-23 20:23:53 +0100
+@@ -115,6 +115,25 @@
  
      return 0;
  }
@@ -26,7 +26,7 @@
  
  av_cold int ff_h263_decode_end(AVCodecContext *avctx)
  {
-@@ -437,6 +456,12 @@
+@@ -431,6 +450,12 @@
      } else {
          ret = h263_decode_picture_header(s);
      }
@@ -39,18 +39,16 @@
  
      if(ret==FRAME_SKIPPED) return get_consumed_bytes(s, buf_size);
  
-@@ -738,6 +763,14 @@
+@@ -715,6 +740,12 @@
  
  assert(s-&gt;current_picture.pict_type == s-&gt;current_picture_ptr-&gt;pict_type);
  assert(s-&gt;current_picture.pict_type == s-&gt;pict_type);
++
 +/* MEANX */
-+  if(s-&gt;current_picture_ptr)
-+      s-&gt;current_picture_ptr-&gt;opaque=pict-&gt;opaque;
++    if(s-&gt;current_picture_ptr)
++        s-&gt;current_picture_ptr-&gt;opaque=pict-&gt;opaque;
 +/* MEANX */
 +
-+
-+
-+
-     if (s-&gt;pict_type == FF_B_TYPE || s-&gt;low_delay) {
+     if (s-&gt;pict_type == AV_PICTURE_TYPE_B || s-&gt;low_delay) {
          *pict= *(AVFrame*)s-&gt;current_picture_ptr;
      } else if (s-&gt;last_picture_ptr != NULL) {

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2011-06-24 17:43:57 UTC (rev 7299)
@@ -1,6 +1,6 @@
---- libavcodec/h264.c.orig	2011-04-26 23:58:23 +0100
-+++ libavcodec/h264.c	2011-05-10 22:34:57 +0100
-@@ -3458,6 +3458,20 @@
+--- ../ffmpeg-0.8/libavcodec/h264.c	2011-06-23 20:23:54 +0100
++++ libavcodec/h264.c	2011-06-23 20:23:54 +0100
+@@ -4178,6 +4178,20 @@
      { FF_PROFILE_UNKNOWN },
  };
  

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12.c.patch	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12.c.patch	2011-06-24 17:43:57 UTC (rev 7299)
@@ -1,6 +1,6 @@
---- libavcodec/mpeg12.c.orig	2011-05-10 22:40:29 +0100
-+++ libavcodec/mpeg12.c	2011-05-10 22:40:29 +0100
-@@ -1999,6 +1999,11 @@
+--- ../ffmpeg-0.8/libavcodec/mpeg12.c	2011-06-23 20:23:54 +0100
++++ libavcodec/mpeg12.c	2011-06-23 20:23:54 +0100
+@@ -1998,6 +1998,11 @@
          ff_er_frame_end(s);
  
          MPV_frame_end(s);
@@ -10,5 +10,5 @@
 +/* MEANX */
 +
  
-         if (s-&gt;pict_type == FF_B_TYPE || s-&gt;low_delay) {
+         if (s-&gt;pict_type == AV_PICTURE_TYPE_B || s-&gt;low_delay) {
              *pict= *(AVFrame*)s-&gt;current_picture_ptr;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12enc.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12enc.c.patch	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12enc.c.patch	2011-06-24 17:43:57 UTC (rev 7299)
@@ -1,5 +1,5 @@
---- libavcodec/mpeg12enc.c.old	2010-12-20 13:49:24 +0000
-+++ libavcodec/mpeg12enc.c	2010-12-20 13:49:24 +0000
+--- ../ffmpeg-0.8/libavcodec/mpeg12enc.c	2011-06-23 20:23:54 +0100
++++ libavcodec/mpeg12enc.c	2011-06-23 20:23:54 +0100
 @@ -127,10 +127,19 @@
              s-&gt;frame_rate_index= i;
          }
@@ -156,7 +156,7 @@
 +
          put_header(s, EXT_START_CODE);
          put_bits(&amp;s-&gt;pb, 4, 8); //pic ext
-         if (s-&gt;pict_type == FF_P_TYPE || s-&gt;pict_type == FF_B_TYPE) {
+         if (s-&gt;pict_type == AV_PICTURE_TYPE_P || s-&gt;pict_type == AV_PICTURE_TYPE_B) {
 @@ -393,11 +481,16 @@
  
          assert(s-&gt;picture_structure == PICT_FRAME);

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo.c.patch	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo.c.patch	2011-06-24 17:43:57 UTC (rev 7299)
@@ -1,6 +1,6 @@
---- libavcodec/mpegvideo.c.orig	2011-05-10 22:40:30 +0100
-+++ libavcodec/mpegvideo.c	2011-05-10 22:40:29 +0100
-@@ -735,7 +735,11 @@
+--- ../ffmpeg-0.8/libavcodec/mpegvideo.c	2011-06-23 20:23:54 +0100
++++ libavcodec/mpegvideo.c	2011-06-23 20:23:54 +0100
+@@ -736,7 +736,11 @@
      FF_ALLOCZ_OR_GOTO(s-&gt;avctx, s-&gt;prev_pict_types, PREV_PICT_TYPES_BUFFER_SIZE, fail);
  
      s-&gt;parse_context.state= -1;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2011-06-24 17:43:57 UTC (rev 7299)
@@ -1,6 +1,6 @@
---- libavcodec/utils.c.orig	2011-05-10 22:40:30 +0100
-+++ libavcodec/utils.c	2011-05-10 22:40:30 +0100
-@@ -766,10 +766,12 @@
+--- ../ffmpeg-0.8/libavcodec/utils.c	2011-06-23 20:23:55 +0100
++++ libavcodec/utils.c	2011-06-23 20:23:55 +0100
+@@ -783,10 +783,12 @@
  
      if((avctx-&gt;codec-&gt;capabilities &amp; CODEC_CAP_DELAY) || avpkt-&gt;size){
          //FIXME remove the check below _after_ ensuring that all audio check that the available space is enough

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_vc1dec.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_vc1dec.c.patch	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_vc1dec.c.patch	2011-06-24 17:43:57 UTC (rev 7299)
@@ -1,6 +1,6 @@
---- libavcodec/vc1dec.c.orig	2011-04-26 23:58:23 +0100
-+++ libavcodec/vc1dec.c	2011-05-10 21:01:54 +0100
-@@ -3390,6 +3390,11 @@
+--- ../ffmpeg-0.8/libavcodec/vc1dec.c	2011-06-23 20:23:55 +0100
++++ libavcodec/vc1dec.c	2011-06-23 20:23:55 +0100
+@@ -3587,6 +3587,11 @@
          int mby_start;
      } *slices = NULL;
  

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch	2011-06-24 17:43:57 UTC (rev 7299)
@@ -1,6 +1,6 @@
---- libavformat/isom.c.orig	2011-05-10 22:40:30 +0100
-+++ libavformat/isom.c	2011-05-10 22:40:30 +0100
-@@ -234,7 +234,10 @@
+--- ../ffmpeg-0.8/libavformat/isom.c	2011-06-23 20:23:55 +0100
++++ libavformat/isom.c	2011-06-23 20:23:55 +0100
+@@ -237,7 +237,10 @@
      { CODEC_ID_MP1, MKTAG('.', 'm', 'p', '1') }, /* MPEG layer 1 */
      { CODEC_ID_MP2, MKTAG('.', 'm', 'p', '2') }, /* MPEG layer 2 */
  

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_matroskaenc.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_matroskaenc.c.patch	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_matroskaenc.c.patch	2011-06-24 17:43:57 UTC (rev 7299)
@@ -1,6 +1,6 @@
---- libavformat/matroskaenc.c.orig	2011-05-10 22:40:30 +0100
-+++ libavformat/matroskaenc.c	2011-05-10 22:40:30 +0100
-@@ -410,6 +410,7 @@
+--- ../ffmpeg-0.8/libavformat/matroskaenc.c	2011-06-23 20:23:55 +0100
++++ libavformat/matroskaenc.c	2011-06-23 20:23:55 +0100
+@@ -409,6 +409,7 @@
  
  static int put_xiph_codecpriv(AVFormatContext *s, AVIOContext *pb, AVCodecContext *codec)
  {
@@ -8,7 +8,7 @@
      uint8_t *header_start[3];
      int header_len[3];
      int first_header_size;
-@@ -434,6 +435,28 @@
+@@ -433,6 +434,28 @@
          avio_write(pb, header_start[j], header_len[j]);
  
      return 0;
@@ -37,28 +37,28 @@
  }
  
  static void get_aac_sample_rates(AVFormatContext *s, AVCodecContext *codec, int *sample_rate, int *output_sample_rate)
-@@ -538,6 +561,24 @@
+@@ -537,6 +560,24 @@
          put_ebml_uint (pb, MATROSKA_ID_TRACKUID        , i + 1);
          put_ebml_uint (pb, MATROSKA_ID_TRACKFLAGLACING , 0);    // no lacing (yet)
  
 + 		/**  MEANX : Add a default duration for video **/
-+ 		if(codec-&gt;codec_type==CODEC_TYPE_VIDEO)
-+ 		{
-+ 			if(codec-&gt;time_base.den &amp;&amp; codec-&gt;time_base.num)
-+ 			{
-+ 				int num = codec-&gt;time_base.num;
-+ 				int den = codec-&gt;time_base.den;
-+ 				unsigned int default_duration;
-+ 				float period = num;
++        if(codec-&gt;codec_type == AVMEDIA_TYPE_VIDEO)
++        {
++            if(codec-&gt;time_base.den &amp;&amp; codec-&gt;time_base.num)
++            {
++                int num = codec-&gt;time_base.num;
++                int den = codec-&gt;time_base.den;
++                unsigned int default_duration;
++                float period = num;
 + 
-+ 				period /= den;
-+ 				period *= 1000*1000*1000; // in ns
-+ 				default_duration = (unsigned int)floor(period);
-+ 				put_ebml_uint(pb, MATROSKA_ID_TRACKDEFAULTDURATION, default_duration);
-+ 			}
-+ 		}
-+ 		/**  MEANX : Add a default duration for video **/
++                period /= den;
++                period *= 1000 * 1000 * 1000; // in ns
++                default_duration = (unsigned int)floor(period);
++                put_ebml_uint(pb, MATROSKA_ID_TRACKDEFAULTDURATION, default_duration);
++            }
++        }
++        /**  MEANX : Add a default duration for video **/
 +
-         if ((tag = av_metadata_get(st-&gt;metadata, &quot;title&quot;, NULL, 0)))
+         if ((tag = av_dict_get(st-&gt;metadata, &quot;title&quot;, NULL, 0)))
              put_ebml_string(pb, MATROSKA_ID_TRACKNAME, tag-&gt;value);
-         tag = av_metadata_get(st-&gt;metadata, &quot;language&quot;, NULL, 0);
+         tag = av_dict_get(st-&gt;metadata, &quot;language&quot;, NULL, 0);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2011-06-22 06:05:32 UTC (rev 7298)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2011-06-24 17:43:57 UTC (rev 7299)
@@ -358,7 +358,7 @@
 		return ADM_VIDENC_ERR_CLOSED;
 
 	_frame.key_frame = 0;
-	_frame.pict_type = 0;
+	_frame.pict_type = (AVPictureType)0;
 
 	if (_supportedCsps[0] == ADM_CSP_YV12)
 	{
@@ -433,7 +433,6 @@
 	printf(&quot;height: %d\n&quot;, _context-&gt;height);
 	printf(&quot;gop_size: %d\n&quot;, _context-&gt;gop_size);
 	printf(&quot;pix_fmt: %d\n&quot;, _context-&gt;pix_fmt);
-	printf(&quot;rate_emu: %d\n&quot;, _context-&gt;rate_emu);
 	printf(&quot;frame_size: %d\n&quot;, _context-&gt;frame_size);
 	printf(&quot;frame_number: %d\n&quot;, _context-&gt;frame_number);
 	printf(&quot;delay: %d\n&quot;, _context-&gt;delay);
@@ -446,7 +445,7 @@
 	printf(&quot;b_quant_factor: %f\n&quot;, _context-&gt;b_quant_factor);
 	printf(&quot;rc_strategy: %d\n&quot;, _context-&gt;rc_strategy);
 	printf(&quot;b_frame_strategy: %d\n&quot;, _context-&gt;b_frame_strategy);
-	printf(&quot;hurry_up: %d\n&quot;, _context-&gt;hurry_up);
+	printf(&quot;skip_frame: %d\n&quot;, _context-&gt;skip_frame);
 	printf(&quot;rtp_payload_size: %d\n&quot;, _context-&gt;rtp_payload_size);
 	printf(&quot;mv_bits: %d\n&quot;, _context-&gt;mv_bits);
 	printf(&quot;header_bits: %d\n&quot;, _context-&gt;header_bits);
@@ -501,8 +500,6 @@
 	printf(&quot;sample_aspect_ratio: %d, %d\n&quot;, _context-&gt;sample_aspect_ratio.num, _context-&gt;sample_aspect_ratio.den);
 	printf(&quot;debug: %d\n&quot;, _context-&gt;debug);
 	printf(&quot;debug_mv: %d\n&quot;, _context-&gt;debug_mv);
-	printf(&quot;mb_qmin: %d\n&quot;, _context-&gt;mb_qmin);
-	printf(&quot;mb_qmax: %d\n&quot;, _context-&gt;mb_qmax);
 	printf(&quot;me_cmp: %d\n&quot;, _context-&gt;me_cmp);
 	printf(&quot;me_sub_cmp: %d\n&quot;, _context-&gt;me_sub_cmp);
 	printf(&quot;mb_cmp: %d\n&quot;, _context-&gt;mb_cmp);
@@ -578,7 +575,6 @@
 	printf(&quot;mv0_threshold: %d\n&quot;, _context-&gt;mv0_threshold);
 	printf(&quot;b_sensitivity: %d\n&quot;, _context-&gt;b_sensitivity);
 	printf(&quot;compression_level: %d\n&quot;, _context-&gt;compression_level);
-	printf(&quot;use_lpc: %d\n&quot;, _context-&gt;use_lpc);
 	printf(&quot;lpc_coeff_precision: %d\n&quot;, _context-&gt;lpc_coeff_precision);
 	printf(&quot;min_prediction_order: %d\n&quot;, _context-&gt;min_prediction_order);
 	printf(&quot;max_prediction_order: %d\n&quot;, _context-&gt;max_prediction_order);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004452.html">[Avidemux-svn-commit] r7298 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/vdpauFilters
</A></li>
	<LI>Next message: <A HREF="004454.html">[Avidemux-svn-commit] r7300 - in	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core:	include src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4453">[ date ]</a>
              <a href="thread.html#4453">[ thread ]</a>
              <a href="subject.html#4453">[ subject ]</a>
              <a href="author.html#4453">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
