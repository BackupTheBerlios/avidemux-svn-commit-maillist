From mean at mail.berlios.de  Wed Sep  1 08:07:42 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  1 Sep 2010 08:07:42 +0200
Subject: [Avidemux-svn-commit] r6560 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo
Message-ID: <20100901060742.B2F2B480FEB@sheep.berlios.de>

Author: mean
Date: 2010-09-01 08:07:42 +0200 (Wed, 01 Sep 2010)
New Revision: 6560

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo/CMakeLists.txt
Log:
[logo] Link to coreImageLoader (win32 link deps)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo/CMakeLists.txt	2010-08-31 16:07:09 UTC (rev 6559)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo/CMakeLists.txt	2010-09-01 06:07:42 UTC (rev 6560)
@@ -4,6 +4,6 @@
 SET(ADM_vf_logo_SRCS ADM_vidLogo.cpp)
 
 ADD_LIBRARY(ADM_vf_logo SHARED ${ADM_vf_logo_SRCS})
-
+TARGET_LINK_LIBRARIES(ADM_vf_logo ADM_coreImageLoader6 )
 INIT_VIDEO_FILTER(ADM_vf_logo)
 INSTALL_VIDEO_FILTER(ADM_vf_logo)



From mean at mail.berlios.de  Wed Sep  1 08:17:14 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  1 Sep 2010 08:17:14 +0200
Subject: [Avidemux-svn-commit] r6561 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo
Message-ID: <20100901061714.7354D480FEB@sheep.berlios.de>

Author: mean
Date: 2010-09-01 08:17:14 +0200 (Wed, 01 Sep 2010)
New Revision: 6561

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo/CMakeLists.txt
Log:
[logo] Build fix

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo/CMakeLists.txt	2010-09-01 06:07:42 UTC (rev 6560)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo/CMakeLists.txt	2010-09-01 06:17:14 UTC (rev 6561)
@@ -3,7 +3,7 @@
 
 SET(ADM_vf_logo_SRCS ADM_vidLogo.cpp)
 
-ADD_LIBRARY(ADM_vf_logo SHARED ${ADM_vf_logo_SRCS})
+ADD_VIDEO_FILTER(ADM_vf_logo ${ADM_vf_logo_SRCS})
 TARGET_LINK_LIBRARIES(ADM_vf_logo ADM_coreImageLoader6 )
 INIT_VIDEO_FILTER(ADM_vf_logo)
 INSTALL_VIDEO_FILTER(ADM_vf_logo)



From mean at mail.berlios.de  Wed Sep  1 08:31:53 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  1 Sep 2010 08:31:53 +0200
Subject: [Avidemux-svn-commit] r6562 - in branches/avidemux_2.6_branch_mean:
	avidemux_plugins/ADM_videoFilters6/logo myOwnPlugins/videoFilter
Message-ID: <20100901063154.0437F480FEB@sheep.berlios.de>

Author: mean
Date: 2010-09-01 08:31:53 +0200 (Wed, 01 Sep 2010)
New Revision: 6562

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/myOwnPlugins/videoFilter/CMakeLists.txt
Log:
[logo] build fix

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo/CMakeLists.txt	2010-09-01 06:17:14 UTC (rev 6561)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/logo/CMakeLists.txt	2010-09-01 06:31:53 UTC (rev 6562)
@@ -4,6 +4,8 @@
 SET(ADM_vf_logo_SRCS ADM_vidLogo.cpp)
 
 ADD_VIDEO_FILTER(ADM_vf_logo ${ADM_vf_logo_SRCS})
-TARGET_LINK_LIBRARIES(ADM_vf_logo ADM_coreImageLoader6 )
+IF(DO_COMMON)
+  TARGET_LINK_LIBRARIES(ADM_vf_logo ADM_coreImageLoader6 )
+ENDIF(DO_COMMON)
 INIT_VIDEO_FILTER(ADM_vf_logo)
 INSTALL_VIDEO_FILTER(ADM_vf_logo)

Modified: branches/avidemux_2.6_branch_mean/myOwnPlugins/videoFilter/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/myOwnPlugins/videoFilter/CMakeLists.txt	2010-09-01 06:17:14 UTC (rev 6561)
+++ branches/avidemux_2.6_branch_mean/myOwnPlugins/videoFilter/CMakeLists.txt	2010-09-01 06:31:53 UTC (rev 6562)
@@ -51,7 +51,9 @@
 
 SET(ADM_vf_logo_SRCS ADM_vidLogo.cpp)
 
-ADD_LIBRARY(ADM_vf_logo SHARED ${ADM_vf_logo_SRCS})
-
+ADD_VIDEO_FILTER(ADM_vf_logo ${ADM_vf_logo_SRCS})
+IF(DO_COMMON)
+TARGET_LINK_LIBRARIES(ADM_vf_logo ADM_coreImageLoader6 )
+ENDIF(DO_COMMON)
 INIT_VIDEO_FILTER(ADM_vf_logo)
 INSTALL_VIDEO_FILTER(ADM_vf_logo)



From mean at mail.berlios.de  Wed Sep  1 11:12:52 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  1 Sep 2010 11:12:52 +0200
Subject: [Avidemux-svn-commit] r6563 -
	branches/avidemux_2.6_branch_mean/cmake
Message-ID: <20100901091252.8D4EF480FBA@sheep.berlios.de>

Author: mean
Date: 2010-09-01 11:12:52 +0200 (Wed, 01 Sep 2010)
New Revision: 6563

Modified:
   branches/avidemux_2.6_branch_mean/cmake/admMainChecks.cmake
Log:
[build] Plugins do not need vdpau, misc lib and pthread

Modified: branches/avidemux_2.6_branch_mean/cmake/admMainChecks.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admMainChecks.cmake	2010-09-01 06:31:53 UTC (rev 6562)
+++ branches/avidemux_2.6_branch_mean/cmake/admMainChecks.cmake	2010-09-01 09:12:52 UTC (rev 6563)
@@ -111,9 +111,11 @@
 ########################################
 SET(MSG_DISABLE_OPTION "Disabled per request")
 INCLUDE(admCheckRequiredLibs)
+IF(NOT PLUGINS)
 INCLUDE(admCheckMiscLibs)
 INCLUDE(FindThreads)
 INCLUDE(admCheckVDPAU)
+ENDIF(NOT PLUGINS)
 
 ########################################
 # Check functions and includes



From mean at mail.berlios.de  Wed Sep  1 15:46:35 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  1 Sep 2010 15:46:35 +0200
Subject: [Avidemux-svn-commit] r6564 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6:
	. blackenBorder
Message-ID: <20100901134635.9BA10480FC4@sheep.berlios.de>

Author: mean
Date: 2010-09-01 15:46:35 +0200 (Wed, 01 Sep 2010)
New Revision: 6564

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/ADM_vidBlackBorder.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/ADM_vidBlackBorder.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/blackenBorder.conf
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/blackenBorder.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/blackenBorder_desc.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
Log:
[filter] Blacken Borders

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-01 09:12:52 UTC (rev 6563)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-01 13:46:35 UTC (rev 6564)
@@ -11,3 +11,4 @@
 ADD_SUBDIRECTORY(resampleFps)
 ADD_SUBDIRECTORY(stackField)
 ADD_SUBDIRECTORY(logo)
+ADD_SUBDIRECTORY(blackenBorder)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/ADM_vidBlackBorder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/ADM_vidBlackBorder.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/ADM_vidBlackBorder.cpp	2010-09-01 13:46:35 UTC (rev 6564)
@@ -0,0 +1,183 @@
+/***************************************************************************
+                          ADM_vidAddBorder.cpp  -  description
+                             -------------------
+    begin                : Sun Aug 11 2002
+    copyright            : (C) 2002 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "ADM_default.h"
+#include "ADM_coreVideoFilterInternal.h"
+#include "DIA_coreToolkit.h"
+#include "ADM_vidBlackBorder.h"
+#include "DIA_factory.h"
+#include "blackenBorder_desc.cpp"
+
+/**
+    \fn getConfiguration
+    \brief Return current setting as a string
+*/
+const char *blackenBorders::getConfiguration(void)
+{
+    static char conf[100];
+    conf[0]=0;
+    snprintf(conf,100,"blacken Borders : Left:%"LU" Right:%"LU" Top:%"LU" Bottom:%"LU"\n",
+                param.left,param.right,param.top,param.bottom);
+    return conf;
+}
+/**
+    \fn ctor
+*/
+blackenBorders::blackenBorders( ADM_coreVideoFilter *in,CONFcouple *setup) : ADM_coreVideoFilter(in,setup)
+{	
+	 if(!setup || !ADM_paramLoad(setup,blackenBorder_param,&param))
+    {
+        // Default value
+        param.left=0;
+        param.right=0;
+        param.top=0;
+        param.bottom=0;
+    }  	  	
+}
+/**
+    \fn dtor
+*/
+blackenBorders::~blackenBorders()
+{
+
+}
+
+/**
+    \fn getCoupledConf
+    \brief Return our current configuration as couple name=value
+*/
+bool         blackenBorders::getCoupledConf(CONFcouple **couples)
+{
+    return ADM_paramSave(couples, blackenBorder_param,&param);
+}
+#define Y_BLACK 16
+#define UV_BLACK 128
+static bool blackenHz(uint32_t w,uint32_t nbLine,uint8_t *ptr[3],uint32_t strides[3])
+{
+    // y
+    uint8_t *p=ptr[0];
+    uint32_t s=strides[0];
+    for(int y=0;y<nbLine;y++)
+    {
+        memset(p,Y_BLACK,w);
+        p+=s;
+    }
+    p=ptr[1];
+    s=strides[1];
+    nbLine/=2;
+    w/=2;
+    for(int y=0;y<nbLine;y++)
+    {
+        memset(p,UV_BLACK,w);
+        p+=s;
+    }
+    p=ptr[2];
+    s=strides[2];
+    for(int y=0;y<nbLine;y++)
+    {
+        memset(p,UV_BLACK,w);
+        p+=s;
+    }
+    return true;
+}
+
+/**
+    \fn getNextFrame
+*/
+bool blackenBorders::getNextFrame(uint32_t *fn,ADMImage *image)
+{
+    if(!previousFilter->getNextFrame(fn,image))
+    {
+        ADM_info("[blackenBorder] Cannot get previous image\n");
+        return false;
+    }
+ 
+
+    // Top...
+    uint8_t *ptr[3];
+    uint32_t stride[3];
+    image->GetPitches(stride);
+    image->GetWritePlanes(ptr);
+    // top
+    blackenHz(image->_width,param.top,ptr,stride);
+    // Left
+    blackenHz(param.left,image->_height,ptr,stride);
+    // Right
+    uint32_t pWidth=previousFilter->getInfo()->width-param.right;
+    ptr[0]+=pWidth;
+    ptr[1]+=(pWidth)/2;
+    ptr[2]+=(pWidth)/2;
+    blackenHz(param.right,image->_height,ptr,stride);
+    // Bottom
+    image->GetPitches(stride);
+    image->GetWritePlanes(ptr);
+    uint32_t offsetLine=previousFilter->getInfo()->height-param.top;
+    ptr[0]+=offsetLine*stride[0];
+    ptr[1]+=(offsetLine/2)*stride[1];
+    ptr[2]+=(offsetLine/2)*stride[2];
+    blackenHz(image->_width,param.bottom,ptr,stride);
+    return true;
+}
+
+/**
+    \fn configure
+*/
+bool blackenBorders::configure(void)
+{
+        uint32_t width,height;
+#define MAKEME(x) uint32_t x=param.x;
+        while(1)
+        {
+          MAKEME(left);
+          MAKEME(right);
+          MAKEME(top);
+          MAKEME(bottom);
+          
+          width=previousFilter->getInfo()->width;
+          height=previousFilter->getInfo()->height;
+          
+          diaElemUInteger dleft(&left,QT_TR_NOOP("_Left border:"),       0,width/2);
+          diaElemUInteger dright(&right,QT_TR_NOOP("_Right border:"),    0,width/2);
+          diaElemUInteger dtop(&(top),QT_TR_NOOP("_Top border:"),          0,height/2);
+          diaElemUInteger dbottom(&(bottom),QT_TR_NOOP("_Bottom border:"), 0,height/2);
+            
+          diaElem *elems[4]={&dleft,&dright,&dtop,&dbottom};
+          if(diaFactoryRun(QT_TR_NOOP("Blacken Borders"),4,elems))
+          {
+            if((left&1) || (right&1)|| (top&1) || (bottom&1))
+            {
+              GUI_Error_HIG(QT_TR_NOOP("Incorrect parameters"),QT_TR_NOOP("All parameters must be even and within range.")); 
+              continue;
+            }
+            else
+            {
+  #undef MAKEME
+  #define MAKEME(x) param.x=x;
+                MAKEME(left);
+                MAKEME(right);
+                MAKEME(top);
+                MAKEME(bottom);
+                return true;
+            }
+          }
+          return false;
+      }
+}
+
+
+
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/ADM_vidBlackBorder.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/ADM_vidBlackBorder.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/ADM_vidBlackBorder.h	2010-09-01 13:46:35 UTC (rev 6564)
@@ -0,0 +1,47 @@
+/***************************************************************************
+                          ADM_vidAddBorder.h  -  description
+                             -------------------
+    begin                : Sun Aug 11 2002
+    copyright            : (C) 2002 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef __BLACKEN_BORDER__
+#define     __BLACKEN_BORDER__
+
+#include "blackenBorder.h"
+class blackenBorders : public  ADM_coreVideoFilter
+{
+protected:
+        blackenBorder   param;
+public:
+                    blackenBorders(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                    ~blackenBorders();
+
+        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
+	 //  virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) ;           /// Start graphical user interface
+};
+
+// Add the hook to make it valid plugin
+DECLARE_VIDEO_FILTER(   blackenBorders,   // Class
+                        1,0,0,              // Version
+                        ADM_UI_ALL,         // UI
+                        VF_TRANSFORM,            // Category
+                        "blackenBorder",            // internal name (must be uniq!)
+                        "Blacken Borders.",            // Display name
+                        "Remove noisy edge by turning them to black." // Description
+                    );
+
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/CMakeLists.txt	2010-09-01 13:46:35 UTC (rev 6564)
@@ -0,0 +1,9 @@
+INCLUDE(vf_plugin)
+
+
+SET(ADM_vf_blackenBorders_SRCS ADM_vidBlackBorder.cpp )
+
+ADD_VIDEO_FILTER(ADM_vf_blackenBorders ${ADM_vf_blackenBorders_SRCS})
+
+INIT_VIDEO_FILTER(ADM_vf_blackenBorders)
+INSTALL_VIDEO_FILTER(ADM_vf_blackenBorders)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/blackenBorder.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/blackenBorder.conf	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/blackenBorder.conf	2010-09-01 13:46:35 UTC (rev 6564)
@@ -0,0 +1,4 @@
+uint32_t:left; 
+uint32_t:right; 
+uint32_t:top; 
+uint32_t:bottom; 

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/blackenBorder.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/blackenBorder.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/blackenBorder.h	2010-09-01 13:46:35 UTC (rev 6564)
@@ -0,0 +1,11 @@
+// Automatically generated, do not edit!
+#ifndef ADM_blackenBorder_CONF_H
+#define ADM_blackenBorder_CONF_H
+typedef struct {
+   uint32_t left;
+   uint32_t right;
+   uint32_t top;
+   uint32_t bottom;
+}blackenBorder;
+#endif //blackenBorder
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/blackenBorder_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/blackenBorder_desc.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/blackenBorder/blackenBorder_desc.cpp	2010-09-01 13:46:35 UTC (rev 6564)
@@ -0,0 +1,8 @@
+// Automatically generated, do not edit!
+const ADM_paramList blackenBorder_param[]={
+ {"left",offsetof( blackenBorder,left),"uint32_t",ADM_param_uint32_t},
+ {"right",offsetof( blackenBorder,right),"uint32_t",ADM_param_uint32_t},
+ {"top",offsetof( blackenBorder,top),"uint32_t",ADM_param_uint32_t},
+ {"bottom",offsetof( blackenBorder,bottom),"uint32_t",ADM_param_uint32_t},
+{NULL,0,NULL}
+};



From mean at mail.berlios.de  Wed Sep  1 15:46:36 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  1 Sep 2010 15:46:36 +0200
Subject: [Avidemux-svn-commit] r6565 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6:
	. kernelDeint
Message-ID: <20100901134636.EBC65480FC4@sheep.berlios.de>

Author: mean
Date: 2010-09-01 15:46:36 +0200 (Wed, 01 Sep 2010)
New Revision: 6565

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/ADM_vidKernelDeint.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/ADM_vidKernelDeint.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/kdeint.conf
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/kdeint.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/kdeint_desc.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
Log:
[filter] Add kernel deint

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-01 13:46:35 UTC (rev 6564)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-01 13:46:36 UTC (rev 6565)
@@ -12,3 +12,4 @@
 ADD_SUBDIRECTORY(stackField)
 ADD_SUBDIRECTORY(logo)
 ADD_SUBDIRECTORY(blackenBorder)
+ADD_SUBDIRECTORY(kernelDeint)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/ADM_vidKernelDeint.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/ADM_vidKernelDeint.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/ADM_vidKernelDeint.cpp	2010-09-01 13:46:36 UTC (rev 6565)
@@ -0,0 +1,372 @@
+/***************************************************************************
+                          ADM_vidKernelDeint  -  description
+                             -------------------
+ 			Port of another D Graft deinterlacer
+			http://neuron2.net/kerneldeint/kerneldeint.html
+     ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+
+/*
+	KernelDeint() plugin for Avisynth.
+
+	Copyright (C) 2003 Donald A. Graft
+
+	This program is free software; you can redistribute it and/or modify
+	it under the terms of the GNU General Public License as published by
+	the Free Software Foundation.
+
+	This program is distributed in the hope that it will be useful,
+	but WITHOUT ANY WARRANTY; without even the implied warranty of
+	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+	GNU General Public License for more details.
+
+	You should have received a copy of the GNU General Public License
+	along with this program; if not, write to the Free Software
+	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+*/
+
+#include "ADM_default.h"
+#include "ADM_coreVideoFilterInternal.h"
+#include "DIA_coreToolkit.h"
+#include "ADM_vidKernelDeint.h"
+#include "kdeint_desc.cpp"
+
+#include "DIA_factory.h"
+// Add the hook to make it valid plugin
+DECLARE_VIDEO_FILTER(   kernelDeint,   // Class
+                        1,0,0,              // Version
+                        ADM_UI_ALL,         // UI
+                        VF_INTERLACING,            // Category
+                        "kerndelDeint",            // internal name (must be uniq!)
+                        "Kernel Deint.",            // Display name
+                        "Port of Donald Graft Kernel Deinterlacer." // Description
+                    );
+
+extern int PutHintingData(uint8_t *video, unsigned int hint);
+extern int GetHintingData(uint8_t *video, unsigned int *hint);
+
+#define PROGRESSIVE  0x00000001
+
+/**
+    \fn goToTime
+    \brief called when seeking. Need to cleanup our stuff.
+*/
+bool         kernelDeint::goToTime(uint64_t usSeek)
+{
+    vidCache->flush();
+    return ADM_coreVideoFilter::goToTime(usSeek);
+}
+
+
+/**
+    \fn configure
+*/
+bool kernelDeint::configure( void)
+{
+  #define PX(x) &(param.x)
+
+   diaMenuEntry menuField[2]={{1,QT_TR_NOOP("Top"),NULL},
+                             {0,QT_TR_NOOP("Bottom"),NULL}
+                          };
+  
+    
+    diaElemMenu     menu1(PX(order),QT_TR_NOOP("_Field order:"), 2,menuField);
+    diaElemUInteger threshold(PX(threshold),QT_TR_NOOP("_Threshold:"),0,100,QT_TR_NOOP("Smaller means more deinterlacing"));
+    diaElemToggle   sharp(PX(sharp),QT_TR_NOOP("_Sharp"),QT_TR_NOOP("_Sharper engine:"));
+    diaElemToggle   twoway(PX(twoway),QT_TR_NOOP("T_woway"),QT_TR_NOOP("Extrapolate better (better not to use it)"));
+    diaElemToggle   map(PX(map),QT_TR_NOOP("_Map"),QT_TR_NOOP("Show interlaced areas (for test!)"));
+    
+    diaElem *elems[5]={&menu1,&threshold,&sharp,&twoway,&map};
+  
+   return  diaFactoryRun(QT_TR_NOOP("KernelDeint"),5,elems);
+}
+/**
+    \fn getCoupledConf
+*/
+bool         kernelDeint::getCoupledConf(CONFcouple **couples)
+{
+    return ADM_paramSave(couples, kdeint_param,&param);
+}
+/**
+    
+*/
+const char *kernelDeint::getConfiguration(void)
+{
+ 	static char conf[100];
+    conf[0]=0;
+    snprintf(conf,100,"kdeint Borders : order:%"LU" threshold:%"LU" sharp:%"LU" twoway:%"LU" map:%"LU"\n",
+                param.order,param.threshold,param.sharp,param.twoway,param.map);
+    return conf;
+}
+/**
+    \fn dtor
+*/
+kernelDeint::~kernelDeint()
+{
+    if(vidCache) delete vidCache;
+    vidCache=NULL;
+ 	
+}
+
+/**
+    \fn ctor
+*/
+ kernelDeint::kernelDeint(ADM_coreVideoFilter *previous,CONFcouple *setup)
+            :  ADM_coreVideoFilter(previous,setup)
+{
+    if(!setup || !ADM_paramLoad(setup,kdeint_param,&param))
+    {
+        // Default value
+        param.order=1;// Bff=0 / 1=tff
+        param.threshold=10;
+        param.sharp=0;
+        param.twoway=0;
+        param.map=0;
+    }  	  			
+    debug=false;   
+	vidCache=new VideoCache(4,previous);
+}
+/**
+    \fn getNextFrame
+*/
+bool kernelDeint::getNextFrame(uint32_t *fn,ADMImage *image)
+{
+
+    uint32_t page=info.width*info.height;
+    ADMImage *src=NULL, *prv=NULL;
+
+    uint32_t		order, threshold;
+	uint8_t			sharp, twoway, map;
+	
+	order=param.order;
+	threshold=param.threshold;
+	sharp=param.sharp;
+	twoway=param.twoway;
+	map=param.map;				
+    uint32_t frame_prev=nextFrame;
+    if(frame_prev) frame_prev--;
+    
+        src=vidCache->getImage(nextFrame);
+        if(!src) 
+        {
+            ADM_warning("kerneldeint:Cannot get frame\n");
+            vidCache->unlockAll();
+            nextFrame++;
+            return false;
+        }
+        prv=vidCache->getImage(frame_prev);
+        if(!prv)
+        {
+            vidCache->unlockAll();
+            image->duplicate(src);
+            image->copyInfo(src);
+            nextFrame++;
+            return true;
+        }
+/** From here it is mostly untouched .. */
+    const unsigned char *srcp, *prvp, *prvpp, *prvpn, *prvppp, *prvpnn, *prvp4p, *prvp4n;
+	const unsigned char *srcp_saved;
+	const unsigned char *srcpp, *srcppp, *srcpn, *srcpnn, *srcp3p, *srcp3n, *srcp4p, *srcp4n;
+    unsigned char *dstp;
+	unsigned char *dstp_saved;
+ 
+	ADM_PLANE plane;
+	int src_pitch;
+    int dst_pitch;
+    int w;
+    int h;
+	int x, y, z;
+	int val, hi, lo;
+	double valf;
+	unsigned int hint;
+	
+
+	for ( z = 0; z <  3; z++)
+	{
+		if (z == 0) plane = PLANAR_Y;
+		else if (z == 1) plane = PLANAR_U;
+		else plane = PLANAR_V;
+
+		srcp = srcp_saved = src->GetReadPtr(plane);
+		if (plane == PLANAR_Y && (GetHintingData((unsigned char *) srcp, &hint) == false) && (hint & PROGRESSIVE))
+		{
+			if (debug ==true)
+			{
+				ADM_info( "KernelDeint: frame %d: progressive\n", nextFrame); 
+				
+			}
+            image->duplicate(src);
+			image->copyInfo(src);
+			vidCache->unlockAll();
+            nextFrame++;
+			return true;
+		}
+		else
+		{
+			if (debug == true)
+			{
+				ADM_info( "KernelDeint: frame %d: interlaced\n", nextFrame); 
+			}
+		}
+		src_pitch = src->GetPitch(plane);
+		dstp = dstp_saved = image->GetWritePtr(plane);
+		dst_pitch = image->GetPitch(plane);
+		w = image->GetRowSize(plane);
+		h = image->GetHeight(plane);
+		srcp = srcp_saved  + (1-order) * src_pitch;
+		dstp = dstp_saved  + (1-order) * dst_pitch;
+		for (y = 0; y < h; y+=2)
+		{
+			memcpy(dstp, srcp, w);
+			srcp += 2*src_pitch;
+			dstp += 2*dst_pitch;
+		}
+
+		// Copy through the lines that will be missed below.
+		memcpy(dstp_saved + order*dst_pitch, srcp_saved + (1-order)*src_pitch, w);
+		memcpy(dstp_saved + (2+order)*dst_pitch, srcp_saved + (3-order)*src_pitch, w);
+		memcpy(dstp_saved + (h-2+order)*dst_pitch, srcp_saved + (h-1-order)*src_pitch, w);
+		memcpy(dstp_saved + (h-4+order)*dst_pitch, srcp_saved + (h-3-order)*src_pitch, w);
+		/* For the other field choose adaptively between using the previous field
+		   or the interpolant from the current field. */
+		prvp = prv->GetReadPtr(plane) + 5*src_pitch - (1-order)*src_pitch;
+		prvpp = prvp - src_pitch;
+		prvppp = prvp - 2*src_pitch;
+		prvp4p = prvp - 4*src_pitch;
+		prvpn = prvp + src_pitch;
+		prvpnn = prvp + 2*src_pitch;
+		prvp4n = prvp + 4*src_pitch;
+		srcp = srcp_saved + 5*src_pitch - (1-order)*src_pitch;
+		srcpp = srcp - src_pitch;
+		srcppp = srcp - 2*src_pitch;
+		srcp3p = srcp - 3*src_pitch;
+		srcp4p = srcp - 4*src_pitch;
+		srcpn = srcp + src_pitch;
+		srcpnn = srcp + 2*src_pitch;
+		srcp3n = srcp + 3*src_pitch;
+		srcp4n = srcp + 4*src_pitch;
+		dstp =  dstp_saved  + 5*dst_pitch - (1-order)*dst_pitch;
+		for (y = 5 - (1-order); y <= h - 5 - (1-order); y+=2)
+		{
+			for (x = 0; x < w; x++)
+			{
+				if ((threshold == 0) || (!nextFrame) ||
+					(abs((int)prvp[x] - (int)srcp[x]) > threshold) ||
+					(abs((int)prvpp[x] - (int)srcpp[x]) > threshold) ||
+					(abs((int)prvpn[x] - (int)srcpn[x]) > threshold))
+				{
+					if (map == true)
+					{
+						int g = x & ~3;
+						if (0) // RGB
+						{
+							dstp[g++] = 255;
+							dstp[g++] = 255;
+							dstp[g++] = 255;
+							dstp[g] = 255;
+							x = g;
+						}
+						else if (0) // YUY2
+						{
+							dstp[g++] = 235;
+							dstp[g++] = 128;
+							dstp[g++] = 235;
+							dstp[g] = 128;
+							x = g;
+						}
+						else
+						{
+							if (plane == PLANAR_Y) dstp[x] = 235;
+							else dstp[x] = 128;
+						}
+					}
+					else
+					{
+						if (0)
+						{
+							hi = 255;
+							lo = 0;
+						}
+						else if (1)
+						{
+							hi = (plane == PLANAR_Y) ? 235 : 240;
+							lo = 16;
+						}
+						else if (0)
+						{
+							hi = (x & 1) ? 240 : 235;
+							lo = 16;
+						}
+						//else env->ThrowError("KernelDeint: Unknown color space");
+						if (sharp == true)
+						{
+							if (twoway == true)
+								valf = + 0.526*((int)srcpp[x] + (int)srcpn[x])
+								   + 0.170*((int)srcp[x] + (int)prvp[x])
+								   - 0.116*((int)srcppp[x] + (int)srcpnn[x] + (int)prvppp[x] + (int)prvpnn[x])
+					 			   - 0.026*((int)srcp3p[x] + (int)srcp3n[x])
+								   + 0.031*((int)srcp4p[x] + (int)srcp4n[x] + (int)prvp4p[x] + (int)prvp4n[x]);
+							else
+								valf = + 0.526*((int)srcpp[x] + (int)srcpn[x])
+								   + 0.170*((int)prvp[x])
+								   - 0.116*((int)prvppp[x] + (int)prvpnn[x])
+					 			   - 0.026*((int)srcp3p[x] + (int)srcp3n[x])
+								   + 0.031*((int)prvp4p[x] + (int)prvp4n[x]);
+							if (valf > hi) valf = hi;
+							else if (valf < lo) valf = lo;
+							dstp[x] = (int) valf;
+						}
+						else
+						{
+							if (twoway == true)
+								val = (8*((int)srcpp[x] + (int)srcpn[x]) + 2*((int)srcp[x] + (int)prvp[x]) -
+									(int)(srcppp[x]) - (int)(srcpnn[x]) -
+									(int)(prvppp[x]) - (int)(prvpnn[x])) >> 4;
+							else
+								val = (8*((int)srcpp[x] + (int)srcpn[x]) + 2*((int)prvp[x]) -
+									(int)(prvppp[x]) - (int)(prvpnn[x])) >> 4;
+							if (val > hi) val = hi;
+							else if (val < lo) val = lo;
+							dstp[x] = (int) val;
+						}
+					}
+				}
+				else
+				{
+					dstp[x] = srcp[x];
+				}
+			}
+			prvp  += 2*src_pitch;
+			prvpp  += 2*src_pitch;
+			prvppp  += 2*src_pitch;
+			prvpn  += 2*src_pitch;
+			prvpnn  += 2*src_pitch;
+			prvp4p  += 2*src_pitch;
+			prvp4n  += 2*src_pitch;
+			srcp  += 2*src_pitch;
+			srcpp += 2*src_pitch;
+			srcppp += 2*src_pitch;
+			srcp3p += 2*src_pitch;
+			srcp4p += 2*src_pitch;
+			srcpn += 2*src_pitch;
+			srcpnn += 2*src_pitch;
+			srcp3n += 2*src_pitch;
+			srcp4n += 2*src_pitch;
+			dstp  += 2*dst_pitch;
+		}
+	}
+    vidCache->unlockAll();
+    image->copyInfo(src);
+    nextFrame++;
+    return true;
+}
+// EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/ADM_vidKernelDeint.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/ADM_vidKernelDeint.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/ADM_vidKernelDeint.h	2010-09-01 13:46:36 UTC (rev 6565)
@@ -0,0 +1,26 @@
+
+#ifndef ADM_KERNELDEINT
+#define ADM_KERNELDEINT
+#include "kdeint.h"
+/**
+    \class kernelDeint
+*/
+class kernelDeint : public  ADM_coreVideoFilter
+{
+protected:
+        kdeint       param;
+        bool         debug;
+        bool         goToTime(uint64_t usSeek);
+public:
+                    kernelDeint(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                    ~kernelDeint();
+
+        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
+	 //  virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) ;           /// Start graphical user interface
+};
+
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/CMakeLists.txt	2010-09-01 13:46:36 UTC (rev 6565)
@@ -0,0 +1,9 @@
+INCLUDE(vf_plugin)
+
+
+SET(ADM_vf_kernelDeint_SRCS ADM_vidKernelDeint.cpp)
+
+ADD_VIDEO_FILTER(ADM_vf_kernelDeint ${ADM_vf_kernelDeint_SRCS})
+
+INIT_VIDEO_FILTER(ADM_vf_kernelDeint)
+INSTALL_VIDEO_FILTER(ADM_vf_kernelDeint)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/kdeint.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/kdeint.conf	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/kdeint.conf	2010-09-01 13:46:36 UTC (rev 6565)
@@ -0,0 +1,5 @@
+uint32_t:order
+uint32_t:threshold
+uint32_t:sharp
+uint32_t:twoway
+uint32_t:map

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/kdeint.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/kdeint.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/kdeint.h	2010-09-01 13:46:36 UTC (rev 6565)
@@ -0,0 +1,12 @@
+// Automatically generated, do not edit!
+#ifndef ADM_kdeint_CONF_H
+#define ADM_kdeint_CONF_H
+typedef struct {
+   uint32_t order;
+   uint32_t threshold;
+   uint32_t sharp;
+   uint32_t twoway;
+   uint32_t map;
+}kdeint;
+#endif //kdeint
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/kdeint_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/kdeint_desc.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/kernelDeint/kdeint_desc.cpp	2010-09-01 13:46:36 UTC (rev 6565)
@@ -0,0 +1,9 @@
+// Automatically generated, do not edit!
+const ADM_paramList kdeint_param[]={
+ {"order",offsetof( kdeint,order),"uint32_t",ADM_param_uint32_t},
+ {"threshold",offsetof( kdeint,threshold),"uint32_t",ADM_param_uint32_t},
+ {"sharp",offsetof( kdeint,sharp),"uint32_t",ADM_param_uint32_t},
+ {"twoway",offsetof( kdeint,twoway),"uint32_t",ADM_param_uint32_t},
+ {"map",offsetof( kdeint,map),"uint32_t",ADM_param_uint32_t},
+{NULL,0,NULL}
+};



From mean at mail.berlios.de  Wed Sep  1 15:46:38 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  1 Sep 2010 15:46:38 +0200
Subject: [Avidemux-svn-commit] r6566 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter:
	include src
Message-ID: <20100901134638.51C31480FC4@sheep.berlios.de>

Author: mean
Date: 2010-09-01 15:46:38 +0200 (Wed, 01 Sep 2010)
New Revision: 6566

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilter.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_coreVideoFilter.cpp
Log:
[coreFilter] Add HintingData functions, used by a lot of Donald Graft filters

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilter.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilter.h	2010-09-01 13:46:36 UTC (rev 6565)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilter.h	2010-09-01 13:46:38 UTC (rev 6566)
@@ -58,6 +58,8 @@
 protected:
             ADM_coreVideoFilter *previousFilter;
 };
-
+// Avisynth compatibility functions
+int PutHintingData(uint8_t *video, unsigned int hint);
+int GetHintingData(uint8_t *video, unsigned int *hint);
 #endif
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_coreVideoFilter.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_coreVideoFilter.cpp	2010-09-01 13:46:36 UTC (rev 6565)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_coreVideoFilter.cpp	2010-09-01 13:46:38 UTC (rev 6566)
@@ -87,4 +87,52 @@
     return  previousFilter->goToTime((uint64_t)newSeek);
 
 }
+// Some useful functions often used by Donald Graft filters
+#define MAGIC_NUMBER (0xdeadbeef)
+
+int PutHintingData(uint8_t *video, unsigned int hint)
+{
+	uint8_t *p;
+	unsigned int i, magic_number = MAGIC_NUMBER;
+	int error = false;
+
+	p = video;
+	for (i = 0; i < 32; i++)
+	{
+		*p &= ~1; 
+		*p++ |= ((magic_number & (1 << i)) >> i);
+	}
+	for (i = 0; i < 32; i++)
+	{
+		*p &= ~1;
+		*p++ |= ((hint & (1 << i)) >> i);
+	}
+	return error;
+}
+
+int GetHintingData(uint8_t *video, unsigned int *hint)
+{
+	uint8_t *p;
+	unsigned int i, magic_number = 0;
+	int error = false;
+
+	p = video;
+	for (i = 0; i < 32; i++)
+	{
+		magic_number |= ((*p++ & 1) << i);
+	}
+	if (magic_number != MAGIC_NUMBER)
+	{
+		error = true;
+	}
+	else
+	{
+		*hint = 0;
+		for (i = 0; i < 32; i++)
+		{
+			*hint |= ((*p++ & 1) << i);
+		}
+	}
+	return error;
+}
 // EOF



From mean at mail.berlios.de  Thu Sep  2 09:16:46 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu,  2 Sep 2010 09:16:46 +0200
Subject: [Avidemux-svn-commit] r6567 - in
	branches/avidemux_2.5_branch_gruntster: avidemux
	plugins/ADM_videoFilters
Message-ID: <20100902071646.F413A480FF9@sheep.berlios.de>

Author: mean
Date: 2010-09-02 09:16:46 +0200 (Thu, 02 Sep 2010)
New Revision: 6567

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/CMakeLists.txt
Log:
[logoFilter] Re-enable it on non win32 platform + force symbol createImageFromFile

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp	2010-09-01 13:46:38 UTC (rev 6566)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp	2010-09-02 07:16:46 UTC (rev 6567)
@@ -318,7 +318,9 @@
 #endif
 }
 extern void checkCrashFile(void);
+extern ADMImage *createImageFromFile(const char *filename);
 void dummyXref(void)
 {
     checkCrashFile();
+    createImageFromFile("foobar");
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/CMakeLists.txt	2010-09-01 13:46:38 UTC (rev 6566)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/CMakeLists.txt	2010-09-02 07:16:46 UTC (rev 6567)
@@ -39,7 +39,10 @@
 ADD_SUBDIRECTORY(MSmooth)
 ADD_SUBDIRECTORY(Soften)
 ADD_SUBDIRECTORY(lavDeinterlace)
-# Dependancy toward codecs ADD_SUBDIRECTORY(Logo)
+# Dependancy toward codecs 
+IF(NOT WIN32)
+  ADD_SUBDIRECTORY(Logo)
+ENDIF(NOT WIN32)
 ADD_SUBDIRECTORY(ChromaShift)
 ADD_SUBDIRECTORY(CNR2)
 ADD_SUBDIRECTORY(colorYUV)



From mean at mail.berlios.de  Thu Sep  2 10:16:10 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu,  2 Sep 2010 10:16:10 +0200
Subject: [Avidemux-svn-commit] r6568 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6:
	. rotate
Message-ID: <20100902081610.C4F5A480FF9@sheep.berlios.de>

Author: mean
Date: 2010-09-02 10:16:10 +0200 (Thu, 02 Sep 2010)
New Revision: 6568

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rotate.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rte.conf
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rte.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rte_desc.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
Log:
[Filter] Rotate filer

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-02 07:16:46 UTC (rev 6567)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-02 08:16:10 UTC (rev 6568)
@@ -13,3 +13,4 @@
 ADD_SUBDIRECTORY(logo)
 ADD_SUBDIRECTORY(blackenBorder)
 ADD_SUBDIRECTORY(kernelDeint)
+ADD_SUBDIRECTORY(rotate)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/CMakeLists.txt	2010-09-02 08:16:10 UTC (rev 6568)
@@ -0,0 +1,9 @@
+INCLUDE(vf_plugin)
+
+
+SET(ADM_vf_rotate_SRCS rotate.cpp)
+
+ADD_VIDEO_FILTER(ADM_vf_rotate ${ADM_vf_rotate_SRCS})
+
+INIT_VIDEO_FILTER(ADM_vf_rotate)
+INSTALL_VIDEO_FILTER(ADM_vf_rotate)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rotate.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rotate.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rotate.cpp	2010-09-02 08:16:10 UTC (rev 6568)
@@ -0,0 +1,212 @@
+/** *************************************************************************
+                    \fn       rotateFilter.cpp  
+                    \brief simplest of all video filters, it does nothing
+
+    copyright            : (C) 2009 by mean
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "ADM_default.h"
+#include "ADM_coreVideoFilterInternal.h"
+#include "DIA_factory.h"
+#include "rte.h"
+#include "rte_desc.cpp"
+
+static void do_rotate(ADMImage *source,ADMImage *target,uint32_t angle);
+/**
+    \class rotateFilter
+*/
+class rotateFilter : public  ADM_coreVideoFilter
+{
+protected:
+        rte                  param;
+        bool                 reset(void);
+        ADMImage             *src;
+public:
+                    rotateFilter(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                    ~rotateFilter();
+
+        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
+	 //  virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) ;     /// Start graphical user interface
+};
+
+// Add the hook to make it valid plugin
+DECLARE_VIDEO_FILTER(   rotateFilter,   // Class
+                        1,0,0,              // Version
+                        ADM_UI_ALL,         // UI
+                        VF_TRANSFORM,            // Category
+                        "rotate",            // internal name (must be uniq!)
+                        "Rotate",            // Display name
+                        "Rotate the image by 90/180/270 degrees." // Description
+                    );
+
+/**
+    \fn reset
+*/
+bool rotateFilter::reset(void)
+{
+    uint32_t w=previousFilter->getInfo()->width;
+    uint32_t h=previousFilter->getInfo()->height;
+    switch(param.angle)
+    {
+            case 0:case 180: info.width=w;info.height=h;break;
+            case 90:case 270: info.width=h;info.height=w;break;
+            default: ADM_assert(0);
+    }
+    
+    return true;
+
+}
+/**
+    \fn rotateFilter
+    \brief constructor
+*/
+rotateFilter::rotateFilter(  ADM_coreVideoFilter *in,CONFcouple *setup) : ADM_coreVideoFilter(in,setup)
+{
+    src=NULL;
+    if(!setup || !ADM_paramLoad(setup,rte_param,&param))
+    {
+        // Default value
+        param.angle=0;// Bff=0 / 1=tff
+    }  	  	
+    src=new ADMImageDefault(previousFilter->getInfo()->width,previousFilter->getInfo()->height);		
+    reset();
+}
+/**
+    \fn rotateFilter
+    \brief destructor
+*/
+rotateFilter::~rotateFilter()
+{
+      if(src) delete src;
+      src=NULL;
+}
+
+/**
+    \fn getFrame
+    \brief Get a processed frame
+*/
+bool rotateFilter::getNextFrame(uint32_t *fn,ADMImage *image)
+{
+    // since we do nothing, just get the output of previous filter
+    if(false==previousFilter->getNextFrame(fn,src))
+    {
+        ADM_warning("rotate : Cannot get frame\n");
+        return false;
+    }
+    do_rotate(src,image,param.angle);
+    image->copyInfo(src);
+    return true;
+}
+/**
+    \fn getCoupledConf
+    \brief Return our current configuration as couple name=value
+*/
+bool         rotateFilter::getCoupledConf(CONFcouple **couples)
+{
+   return ADM_paramSave(couples, rte_param,&param);
+}
+/**
+    \fn getConfiguration
+    \brief Return current setting as a string
+*/
+const char *rotateFilter::getConfiguration(void)
+{
+    static char buffer[80];
+    snprintf(buffer,80,"Rotate by %"LU" degrees.",param.angle);
+    return buffer;
+}
+/**
+    \fn rotatePlane
+*/
+void rotatePlane(uint32_t angle,uint8_t *src,      uint32_t srcPitch, 
+                 uint8_t *dst,  uint32_t dstPitch, uint32_t width,    uint32_t height)
+{
+    int32_t dstIncPix, dstIncLine;
+    
+    switch(angle)
+    {
+        case 0:   BitBlit(dst,dstPitch,src,srcPitch,width,height);return;break;
+        case 180: dstIncPix=-1;       dstIncLine=-dstPitch; dst=dst+((height-1)*dstPitch)+width-1;break;
+
+        case 90:  dstIncPix=-dstPitch;dstIncLine=1;         dst=dst+((width-1)*dstPitch);break;
+        case 270: dstIncPix=dstPitch; dstIncLine=-1;        dst=dst+height-1;break;
+        default:
+            break;
+    }
+    
+    uint8_t *lineIn,*lineOut;
+    for(int y=0;y<height;y++)
+    {
+        lineIn=src+srcPitch*y;
+        lineOut=dst+dstIncLine*y;
+        for(int x=0;x<width;x++)
+        {
+            *lineOut=*lineIn;
+            lineIn++;
+            lineOut+=dstIncPix;
+        }
+    }
+
+
+}
+
+/**
+    \fn do_rotate
+*/
+void do_rotate(ADMImage *source,ADMImage *target,uint32_t angle)
+{
+uint8_t *in,*out;
+uint32_t width,height;
+uint32_t srcPitch,dstPitch;
+
+    for(int i=0;i<3;i++)
+    {
+         ADM_PLANE plane=(ADM_PLANE)i;
+         width=source->_width;
+         height=source->_height;
+         if(i)
+            {
+                width>>=1;
+                height>>=1;
+            }
+          in=source->GetReadPtr(plane);
+          srcPitch=source->GetPitch(plane);
+          dstPitch=target->GetPitch(plane);
+          out=target->GetWritePtr(plane);
+          rotatePlane(angle,in,  srcPitch, out,  dstPitch,  width,  height);
+    }
+}
+
+/**
+    \fn configure
+*/
+bool rotateFilter::configure( void)
+{
+  uint8_t r;
+  
+  diaMenuEntry rotateValues[]={
+      {0,QT_TR_NOOP("None"),QT_TR_NOOP("None")},
+      {90,QT_TR_NOOP("90 degrees"),QT_TR_NOOP("90?")},
+      {180,QT_TR_NOOP("180 degrees"),QT_TR_NOOP("180?")},
+      {270,QT_TR_NOOP("270 degrees"),QT_TR_NOOP("270?")}
+  };
+  diaElemMenu     rotate(&(param.angle),QT_TR_NOOP("_Angle:"),4,rotateValues,NULL);
+  diaElem *allWidgets[]={&rotate};
+  if( !diaFactoryRun(QT_TR_NOOP("Rotate"),1,allWidgets)) return false;
+  reset();
+  return true;
+}
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rte.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rte.conf	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rte.conf	2010-09-02 08:16:10 UTC (rev 6568)
@@ -0,0 +1 @@
+uint32_t:angle

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rte.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rte.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rte.h	2010-09-02 08:16:10 UTC (rev 6568)
@@ -0,0 +1,8 @@
+// Automatically generated, do not edit!
+#ifndef ADM_rte_CONF_H
+#define ADM_rte_CONF_H
+typedef struct {
+   uint32_t angle;
+}rte;
+#endif //rte
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rte_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rte_desc.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/rotate/rte_desc.cpp	2010-09-02 08:16:10 UTC (rev 6568)
@@ -0,0 +1,5 @@
+// Automatically generated, do not edit!
+const ADM_paramList rte_param[]={
+ {"angle",offsetof( rte,angle),"uint32_t",ADM_param_uint32_t},
+{NULL,0,NULL}
+};



From mean at mail.berlios.de  Thu Sep  2 11:21:39 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu,  2 Sep 2010 11:21:39 +0200
Subject: [Avidemux-svn-commit] r6569 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6:
	. lavDeint
Message-ID: <20100902092139.D4CA348100F@sheep.berlios.de>

Author: mean
Date: 2010-09-02 11:21:39 +0200 (Thu, 02 Sep 2010)
New Revision: 6569

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lav.conf
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lav.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lavDeint.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lav_desc.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
Log:
[filters] lavcodec deinterlacers

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-02 08:16:10 UTC (rev 6568)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-02 09:21:39 UTC (rev 6569)
@@ -14,3 +14,4 @@
 ADD_SUBDIRECTORY(blackenBorder)
 ADD_SUBDIRECTORY(kernelDeint)
 ADD_SUBDIRECTORY(rotate)
+ADD_SUBDIRECTORY(lavDeint)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/CMakeLists.txt	2010-09-02 09:21:39 UTC (rev 6569)
@@ -0,0 +1,9 @@
+INCLUDE(vf_plugin)
+
+
+SET(ADM_vf_lavDeint_SRCS lavDeint.cpp)
+
+ADD_VIDEO_FILTER(ADM_vf_lavDeint ${ADM_vf_lavDeint_SRCS})
+
+INIT_VIDEO_FILTER(ADM_vf_lavDeint)
+INSTALL_VIDEO_FILTER(ADM_vf_lavDeint)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lav.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lav.conf	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lav.conf	2010-09-02 09:21:39 UTC (rev 6569)
@@ -0,0 +1,2 @@
+uint32_t:deintType
+uint32_t:autoLevel

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lav.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lav.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lav.h	2010-09-02 09:21:39 UTC (rev 6569)
@@ -0,0 +1,9 @@
+// Automatically generated, do not edit!
+#ifndef ADM_lav_CONF_H
+#define ADM_lav_CONF_H
+typedef struct {
+   uint32_t deintType;
+   uint32_t autoLevel;
+}lav;
+#endif //lav
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lavDeint.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lavDeint.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lavDeint.cpp	2010-09-02 09:21:39 UTC (rev 6569)
@@ -0,0 +1,261 @@
+/** *************************************************************************
+                    \fn       lavDeint.cpp  
+                    \brief simplest of all video filters, it does nothing
+
+    copyright            : (C) 2009 by mean
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "ADM_includeFfmpeg.h"
+#include "ADM_lavcodec.h"
+extern "C" {
+#include "ADM_ffmpeg/libpostproc/postprocess.h"
+}
+
+#include "ADM_default.h"
+#include "ADM_coreVideoFilterInternal.h"
+#include "DIA_factory.h"
+#include "lav.h"
+#include "lav_desc.cpp"
+#include "ADM_imageFlags.h"
+
+enum 
+{
+  PP_BM_NONE           =0x0000,
+  PP_BM_LINEAR_BLEND   =0x0001, 
+  PP_BM_LINEAR_INTER   =0x0002, 
+  PP_BM_CUBIC_INTER    =0x0003, 
+  PP_BM_MEDIAN_INTER   =0x0004, 
+  PP_BM_FFMPEG_DEINT   =0x0005,  
+};
+
+/**
+    \class lavDeint
+*/
+class lavDeint : public  ADM_coreVideoFilter
+{
+protected:
+        lav                  param;
+        ADMImage             *src;
+        bool                 cleanup(void);
+        bool                 setup(void);
+        void                 *ppcontext;
+        void                 *ppmode;
+
+public:
+                    lavDeint(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                    ~lavDeint();
+
+        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
+	 //  virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) ;     /// Start graphical user interface
+};
+
+// Add the hook to make it valid plugin
+DECLARE_VIDEO_FILTER(   lavDeint,   // Class
+                        1,0,0,              // Version
+                        ADM_UI_ALL,         // UI
+                        VF_INTERLACING,            // Category
+                        "lavdeint",            // internal name (must be uniq!)
+                        "Libavdec Deinterlacers",            // Display name
+                        "Lavcodec deinterlacer family." // Description
+                    );
+
+/**
+    \fn lavDeint
+    \brief constructor
+*/
+lavDeint::lavDeint(  ADM_coreVideoFilter *in,CONFcouple *setup) : ADM_coreVideoFilter(in,setup)
+{
+    src=NULL;
+    ppcontext=NULL;
+    ppmode=NULL;
+
+    if(!setup || !ADM_paramLoad(setup,lav_param,&param))
+    {
+        // Default value
+        param.deintType=PP_BM_FFMPEG_DEINT;
+        param.autoLevel=false;
+    }  	  	
+    src=new ADMImageDefault(previousFilter->getInfo()->width,previousFilter->getInfo()->height);		
+    this->setup();
+}
+/**
+    \fn lavDeint
+    \brief destructor
+*/
+lavDeint::~lavDeint()
+{
+      if(src) delete src;
+      src=NULL;
+      cleanup();
+}
+
+/**
+    \fn getFrame
+    \brief Get a processed frame
+*/
+bool lavDeint::getNextFrame(uint32_t *fn,ADMImage *image)
+{
+    // since we do nothing, just get the output of previous filter
+    if(false==previousFilter->getNextFrame(fn,src))
+    {
+        ADM_warning("rotate : Cannot get frame\n");
+        return false;
+    }
+ 
+  //
+  const uint8_t *iBuff[3];
+  uint8_t *oBuff[3];
+  int strideIn[3],strideOut[3];
+  uint32_t stride[3];
+
+  image->GetWritePlanes(oBuff);
+  src->GetReadPlanes((uint8_t **)iBuff);
+
+  image->GetPitches(stride);
+  for(int i=0;i<3;i++) strideOut[i]=stride[i];
+
+  src->GetPitches(stride);
+  for(int i=0;i<3;i++) strideIn[i]=stride[i];
+        
+  int type;
+  if(src->flags&AVI_KEY_FRAME)
+    type=1;
+  else if(src->flags & AVI_B_FRAME)
+    type=3;
+  else
+    type=2;
+  pp_postprocess(
+        iBuff,
+        strideIn,
+        oBuff,
+        strideOut,
+        info.width,
+        info.height,
+        NULL,
+        0,
+        ppmode,
+        ppcontext,
+        type); // I ?
+                                
+    image->copyInfo(src);
+    return true;
+}
+/**
+    \fn getCoupledConf
+    \brief Return our current configuration as couple name=value
+*/
+bool         lavDeint::getCoupledConf(CONFcouple **couples)
+{
+   return ADM_paramSave(couples, lav_param,&param);
+}
+/**
+    \fn getConfiguration
+    \brief Return current setting as a string
+*/
+const char *lavDeint::getConfiguration(void)
+{
+    static char buffer[80];
+    snprintf(buffer,80,"lavdeint type %d, autolevel=%d.",(int)param.deintType, (int)param.autoLevel);
+    return buffer;
+}
+
+/**
+    \fn configure
+*/
+bool lavDeint::configure( void)
+{
+
+  #define PX(x) &(param.x)
+   diaMenuEntry menuField[6]={{PP_BM_NONE,        QT_TR_NOOP("None"),NULL},
+                             {PP_BM_LINEAR_BLEND, QT_TR_NOOP("Linear blend"),NULL},
+                             {PP_BM_LINEAR_INTER, QT_TR_NOOP("Linear interpolate"),NULL},
+                             {PP_BM_CUBIC_INTER,  QT_TR_NOOP("Cubic interpolate"),NULL},
+                             {PP_BM_MEDIAN_INTER, QT_TR_NOOP("Median interpolate"),NULL},
+                             {PP_BM_FFMPEG_DEINT, QT_TR_NOOP("FFmpeg deint"),NULL},
+                          };
+  
+    
+    diaElemMenu     menu1(PX(deintType),QT_TR_NOOP("_Deinterlacing:"), 6,menuField);
+    diaElemToggle   autolevel(PX(autoLevel),QT_TR_NOOP("_Autolevel"));
+    
+    diaElem *elems[2]={&menu1,&autolevel};
+  
+   if(diaFactoryRun(QT_TR_NOOP("libavcodec deinterlacer"),2,elems))
+  {
+    setup();
+    return true; 
+  }
+  return false;        
+}
+/**
+    \fn setup
+*/
+bool lavDeint::setup(void)
+{
+  char string[1024];
+  uint32_t ppCaps=0;
+                
+  string[0]=0;
+  
+        cleanup();
+#ifdef ADM_CPU_X86
+#define ADD(x,y) if( CpuCaps::has##x()) ppCaps|=PP_CPU_CAPS_##y;                
+                ADD(MMX,MMX);           
+                ADD(3DNOW,3DNOW);
+                ADD(MMXEXT,MMX2);
+#endif             
+        cleanup();
+#undef ADD       
+#define ADD(z)  { if(string[0]) strcat(string,","#z); else strcpy(string,#z);}        
+               
+        if(param.autoLevel) ADD(al);
+        switch(param.deintType)
+        {
+          case PP_BM_NONE:break;
+          case PP_BM_LINEAR_BLEND: ADD(lb);break;
+          case PP_BM_LINEAR_INTER: ADD(li);break;
+          case PP_BM_CUBIC_INTER: ADD(ci);break;
+          case PP_BM_MEDIAN_INTER: ADD(md);break;
+          case PP_BM_FFMPEG_DEINT: ADD(fd);break;                             
+        }        
+
+
+        ppcontext=pp_get_context(info.width, info.height, ppCaps);           
+        ppmode=pp_get_mode_by_name_and_quality(string,1);;
+        
+        ADM_assert(ppcontext);
+        ADM_assert(ppmode);
+        return true;
+} 
+
+/**
+    \fn cleanup
+*/
+bool lavDeint::cleanup(void)
+{
+  if(ppcontext)
+  {
+    pp_free_context(ppcontext);
+    ppcontext=NULL;
+  }
+  if(ppmode)
+  {
+    pp_free_mode(ppmode);
+    ppmode=NULL;
+  }
+  
+} 
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lav_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lav_desc.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/lav_desc.cpp	2010-09-02 09:21:39 UTC (rev 6569)
@@ -0,0 +1,6 @@
+// Automatically generated, do not edit!
+const ADM_paramList lav_param[]={
+ {"deintType",offsetof( lav,deintType),"uint32_t",ADM_param_uint32_t},
+ {"autoLevel",offsetof( lav,autoLevel),"uint32_t",ADM_param_uint32_t},
+{NULL,0,NULL}
+};



From mean at mail.berlios.de  Thu Sep  2 11:43:42 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu,  2 Sep 2010 11:43:42 +0200
Subject: [Avidemux-svn-commit] r6570 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint
Message-ID: <20100902094342.356D648100F@sheep.berlios.de>

Author: mean
Date: 2010-09-02 11:43:42 +0200 (Thu, 02 Sep 2010)
New Revision: 6570

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/CMakeLists.txt
Log:
[lavDeint] Link to libpostproc

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/CMakeLists.txt	2010-09-02 09:21:39 UTC (rev 6569)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lavDeint/CMakeLists.txt	2010-09-02 09:43:42 UTC (rev 6570)
@@ -4,6 +4,8 @@
 SET(ADM_vf_lavDeint_SRCS lavDeint.cpp)
 
 ADD_VIDEO_FILTER(ADM_vf_lavDeint ${ADM_vf_lavDeint_SRCS})
-
+IF(DO_COMMON)
+  TARGET_LINK_LIBRARIES(ADM_vf_lavDeint ADM_libpostproc6 )
+ENDIF(DO_COMMON)
 INIT_VIDEO_FILTER(ADM_vf_lavDeint)
 INSTALL_VIDEO_FILTER(ADM_vf_lavDeint)



From mean at mail.berlios.de  Thu Sep  2 18:42:57 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu,  2 Sep 2010 18:42:57 +0200
Subject: [Avidemux-svn-commit] r6571 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4
Message-ID: <20100902164257.AF5EE481018@sheep.berlios.de>

Author: mean
Date: 2010-09-02 18:42:57 +0200 (Thu, 02 Sep 2010)
New Revision: 6571

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4/ADM_mp4Analyzer.cpp
Log:
[MOV] Skip chan atom, fix playback of IMG_XX.MOV

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4/ADM_mp4Analyzer.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4/ADM_mp4Analyzer.cpp	2010-09-02 09:43:42 UTC (rev 6570)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4/ADM_mp4Analyzer.cpp	2010-09-02 16:42:57 UTC (rev 6571)
@@ -857,7 +857,16 @@
                                                         audioCodec(AAC);
                                             if(left>10)
                                             {
-                                              adm_atom wave(&son);
+                                            nochan:
+                                                adm_atom wave(&son);
+                                                if(MKFCCR('c','h','a','n')==wave.getFCC())
+                                                {
+                                                        printf("Found chan atom, skipping\n");
+                                                        wave.skipAtom();
+                                                        goto nochan;
+                                                }
+                                              
+
                                               printf("Reading wave, got %s\n",fourCC::tostringBE(wave.getFCC()));
                                               if(MKFCCR('w','a','v','e')==wave.getFCC())
                                               {



From mean at mail.berlios.de  Fri Sep  3 11:09:56 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri,  3 Sep 2010 11:09:56 +0200
Subject: [Avidemux-svn-commit] r6572 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad
Message-ID: <20100903090956.8784C480ED6@sheep.berlios.de>

Author: mean
Date: 2010-09-03 11:09:56 +0200 (Fri, 03 Sep 2010)
New Revision: 6572

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp
Log:
[faad] Cleaner code + workaround FAAD bad handling of mono stream

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp	2010-09-02 16:42:57 UTC (rev 6571)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp	2010-09-03 09:09:56 UTC (rev 6572)
@@ -10,7 +10,7 @@
 // The big drawback if that in some case you can eat up a lot of the stream
 // before finding a packet start code to enable correct init of the codec
 //
-// Author: mean <fixounet at free.fr>, (C) 2004
+// Author: mean <fixounet at free.fr>, (C) 2004/2010
 //
 // Copyright: See COPYING file that comes with this distribution
 //
@@ -20,15 +20,16 @@
 #include "ADM_default.h"
 #include "ADM_ad_plugin.h"
 
-#define FAAD_BUFFER 2048
+#define FAAD_BUFFER (10*1024)
 
 class ADM_faad : public     ADM_Audiocodec
 {
 	protected:
 		uint8_t _inited;
 		void	*_instance;
-		uint8_t _buffer[FAAD_BUFFER];
-		uint32_t _inbuffer;
+		uint8_t  _buffer[FAAD_BUFFER*2];
+		uint32_t head, tail;
+        bool     monoFaadBug; // if true, the stream is mono, but faad outputs stereo
 
 	public:
 		ADM_faad(uint32_t fourcc, WAVHeader *info, uint32_t l, uint8_t *d);
@@ -65,11 +66,12 @@
 unsigned char chan;
 		_inited=0;
 		_instance=NULL;
-		_inbuffer=0;
+        head=tail=0;
+        monoFaadBug=false;
 		_instance = faacDecOpen();
 		conf=faacDecGetCurrentConfiguration(_instance);
 		// Update the field we know about
-		conf->outputFormat=FAAD_FMT_16BIT;
+		conf->outputFormat=FAAD_FMT_FLOAT;
 		conf->defSampleRate=info->frequency;
   	    conf->defObjectType =LC;
 		faacDecSetConfiguration(_instance, conf);
@@ -87,8 +89,13 @@
                         }
                         if(chan!=info->channels) // Ask for stereo !
                         {
-                             printf("[FAAD]channel mismatch!!! %d to %d \n",info->channels,chan);
-                            info->channels=chan;
+                            printf("[FAAD]channel mismatch!!! %d to %d \n",info->channels,chan);
+                            if(info->channels==1 && chan==2) 
+                            {
+                                    ADM_warning("Workaround Faad mono stream handling... \n");
+                                    monoFaadBug=true;
+                            }
+                            
                         }
 		}
 		else // we will init it later on...
@@ -131,23 +138,26 @@
 
 void ADM_faad::purge(void)
 {
-	_inbuffer=0;
-	 faacDecPostSeekReset(_instance, 0);
+	head=tail=0;
+	faacDecPostSeekReset(_instance, 0);
 }
 uint8_t ADM_faad:: beginDecompress( void )
 {
-	_inbuffer=0;
+	head=tail=0;
     return 1;
 }
 uint8_t ADM_faad::endDecompress( void )
 {
-	_inbuffer=0;
+	 head=tail=0;
 	 faacDecPostSeekReset(_instance, 0);
      return 1;
 }
+/**
+    \fn run
+*/
 uint8_t ADM_faad::run(uint8_t *inptr, uint32_t nbIn, float *outptr, uint32_t *nbOut)
 {
-uint32_t xin;
+uint32_t consumed;
 long int res;
 void *outbuf;
 faacDecFrameInfo info;
@@ -173,10 +183,9 @@
 				printf("Faad Inited : rate:%"LU" chan:%"LU" off:%ld\n",srate,chan,res);
 				_inited=1;
 				first=1;
-				_inbuffer=0;
+				head=tail=0;
 				inptr+=res;
 				nbIn-=res;
-
 			}
 		}
 		if(!_inited)
@@ -187,27 +196,29 @@
 		// The codec is initialized, feed him
 		do
 		{
-			max=FAAD_BUFFER-_inbuffer;
+            // Shrink ? The buffer is 2*FAAD_BUFFER
+            if(tail>FAAD_BUFFER && head)
+            {
+                memmove(_buffer,_buffer+head,tail-head);
+                tail-=head;
+                head=0;
+            }
+            // Add incoming data to our own buffer
+			max=FAAD_BUFFER*2-tail;
 			if(nbIn<max) max=nbIn;
-			memcpy(_buffer+_inbuffer,inptr,max);
+			memcpy(_buffer+tail,inptr,max);
 			inptr+=max;
 			nbIn-=max;
-			_inbuffer+=max;
-			/*
-			if(_inbuffer<FAAD_MIN_STREAMSIZE*2)
-			{
-				return 1;
-			}*/
+			tail+=max;
 			memset(&info,0,sizeof(info));
 			//printf("%x %x\n",_buffer[0],_buffer[1]);
-		 	outbuf = faacDecDecode(_instance, &info, _buffer, _inbuffer);
+		 	outbuf = faacDecDecode(_instance, &info, _buffer+head, tail-head);
 			if(info.error)
 			{
-				printf("Faad: Error %d :%s\n",info.error,
-					faacDecGetErrorMessage(info.error));
-				printf("Bye consumed %"LLU", bytes dropped %"LU" \n",info.bytesconsumed,_inbuffer);
+				ADM_warning("Faad: Error %d :%s\n",info.error,faacDecGetErrorMessage(info.error));
+				ADM_warning("Bye consumed %"LLU", bytes dropped %"LU" \n",info.bytesconsumed,tail-head);
 
-                                _inbuffer=0; // Purge buffer
+                head=tail=0; // Purge buffer
 				return 1;
 			}
 			if(first)
@@ -215,24 +226,30 @@
 				printf("Channels : %d\n",info.channels);
 				printf("Frequency: %"LLU"\n",info.samplerate);
 				printf("SBR      : %d\n",info.sbr);
-
-
 			}
-			xin=info.bytesconsumed ;
-			if(xin>_inbuffer) xin=0;
-
-			memmove(_buffer,_buffer+xin,_inbuffer-xin);
-			_inbuffer-=xin;
+			consumed=info.bytesconsumed ;
+			if(consumed>(tail-head)) consumed=0;
+            head+=consumed;
 			if(info.samples)
 			{
-				*nbOut+= info.samples;
-				int16_t *in = (int16_t *) outbuf;
-				for (int i = 0; i < info.samples; i++) {
-					*(outptr++) = (float)*in / 32768;
-					in++;
-				}
+                if(monoFaadBug)
+                {
+                    uint32_t n=info.samples/2;
+                    float *f=(float *)outbuf;
+                    for(int i=0;i<n;i++)
+                    {
+                        *outptr++=*f; // drop one out of two samples
+                        f+=2;
+                    }
+                    *nbOut+=n;
+                }else   
+                {
+                    *nbOut+= info.samples;
+                    memcpy(outptr,outbuf,info.samples*sizeof(float));
+                    outptr+=info.samples;
+                }
 			}
-		}while(nbIn);
+		}while(nbIn || (tail-head));
 		return 1;
 }
 



From mean at mail.berlios.de  Fri Sep  3 11:09:57 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri,  3 Sep 2010 11:09:57 +0200
Subject: [Avidemux-svn-commit] r6573 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4
Message-ID: <20100903090957.B639A480ED6@sheep.berlios.de>

Author: mean
Date: 2010-09-03 11:09:57 +0200 (Fri, 03 Sep 2010)
New Revision: 6573

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp
Log:
[mov/demuxer] More generic decoding of unknown atom when we seek one in particular

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4.cpp	2010-09-03 09:09:56 UTC (rev 6572)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4.cpp	2010-09-03 09:09:57 UTC (rev 6573)
@@ -380,6 +380,18 @@
         if(nbAudioTrack) _isaudiopresent=1; // Still needed ?
         for(int audio=0;audio<nbAudioTrack;audio++)
         {
+            // Lookup if AAC is lying about # of channels
+            if(_tracks[1+audio]._rdWav.encoding==WAV_AAC)
+            {
+                if(_tracks[1+audio].extraDataSize==2)
+                {
+                    // Channels 
+                    uint32_t word=(_tracks[1+audio].extraData[0]<<8)+_tracks[1+audio].extraData[1];
+                    uint32_t chan=(word>>3)&0xf;
+                    uint32_t fqIndex=(word>>7)&0xf;
+                    printf("0x%x word, Channel : %d, fqIndex=%d\n",word,chan,fqIndex);
+                }
+            }
             audioAccess[audio]=new ADM_mp4AudioAccess(name,&(_tracks[1+audio]));
             audioStream[audio]=ADM_audioCreateStream(&(_tracks[1+audio]._rdWav), audioAccess[audio]);
         }

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp	2010-09-03 09:09:56 UTC (rev 6572)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp	2010-09-03 09:09:57 UTC (rev 6573)
@@ -865,74 +865,84 @@
                                                         audioCodec(AAC);
                                             if(left>10)
                                             {
-                                              adm_atom wave(&son);
-                                              printf("Reading wave, got %s\n",fourCC::tostringBE(wave.getFCC()));
-                                              if(MKFCCR('w','a','v','e')==wave.getFCC())
+                                            
+                                            
+                                              while(!son.isDone())
                                               {
-                                                 // mp4a
-                                                 //   wave
-                                                 //     frma
-                                                 //     mp4a
-                                                 //     esds
-                                                 while(!wave.isDone())
-                                                 {
-                                                     adm_atom item(&wave);
-                                                     printf("parsing wave, got %s,0x%x\n",fourCC::tostringBE(item.getFCC()),
-                                                                  item.getFCC());
-                                                     switch(item.getFCC())
+                                                adm_atom wave(&son);
+                                                printf("> got %s atom\n",fourCC::tostringBE(wave.getFCC()));
+                                                switch(wave.getFCC())
+                                                {
+                                                case MKFCCR('c','h','a','n'):
+                                                           printf("Found channel layout atom, skipping\n");
+                                                           break;
+                                                case MKFCCR('w','a','v','e'):
+                                                  {
+                                                     // mp4a
+                                                     //   wave
+                                                     //     frma
+                                                     //     mp4a
+                                                     //     esds
+                                                     while(!wave.isDone())
                                                      {
-                                                       case MKFCCR('f','r','m','a'):
-                                                          {
-                                                          uint32_t codecid=item.read32();
-                                                          printf("frma Codec Id :%s\n",fourCC::tostringBE(codecid));
-                                                          }
-                                                          break;
-                                                       case MKFCCR('m','s',0,0x55):
-                                                       case MKFCCR('m','s',0,0x11):
-                                                        {
-                                                          // We have a waveformat here
-                                                          printf("[STSD]Found MS audio header:\n");
-                                                          ADIO.encoding=ADM_swap16(item.read16());
-                                                          ADIO.channels=ADM_swap16(item.read16());
-                                                          ADIO.frequency=ADM_swap32(item.read32());
-                                                          ADIO.byterate=ADM_swap32(item.read32());
-                                                          ADIO.blockalign=ADM_swap16(item.read16());
-                                                          ADIO.bitspersample=ADM_swap16(item.read16());
-                                                          printWavHeader(&(ADIO));
+                                                         adm_atom item(&wave);
+                                                         printf("parsing wave, got %s,0x%x\n",fourCC::tostringBE(item.getFCC()),
+                                                                      item.getFCC());
+                                                         
+                                                         switch(item.getFCC())
+                                                         {
+                                                           case MKFCCR('f','r','m','a'):
+                                                              {
+                                                              uint32_t codecid=item.read32();
+                                                              printf("frma Codec Id :%s\n",fourCC::tostringBE(codecid));
+                                                              }
+                                                              break;
+                                                           case MKFCCR('m','s',0,0x55):
+                                                           case MKFCCR('m','s',0,0x11):
+                                                            {
+                                                              // We have a waveformat here
+                                                              printf("[STSD]Found MS audio header:\n");
+                                                              ADIO.encoding=ADM_swap16(item.read16());
+                                                              ADIO.channels=ADM_swap16(item.read16());
+                                                              ADIO.frequency=ADM_swap32(item.read32());
+                                                              ADIO.byterate=ADM_swap32(item.read32());
+                                                              ADIO.blockalign=ADM_swap16(item.read16());
+                                                              ADIO.bitspersample=ADM_swap16(item.read16());
+                                                              printWavHeader(&(ADIO));
 
-                                                        }
-                                                       break;
-                                                        case MKFCCR('m','p','4','a'):
-                                                          break;
-                                                        case MKFCCR('e','s','d','s'):
-                                                          {
-                                                               decodeEsds(&item,TRACK_AUDIO);
-                                                          goto foundit; // FIXME!!!
-                                                          }
-                                                          break;
-                                                       default:
-                                                         break;
-                                                     }
+                                                            }
+                                                           break;
+                                                            case MKFCCR('m','p','4','a'):
+                                                              break;
+                                                            case MKFCCR('e','s','d','s'):
+                                                              {
+                                                                   decodeEsds(&item,TRACK_AUDIO);
+                                                                   break;
+                                                              }
+                                                              break;
+                                                           default:
+                                                             break;
+                                                         }
 
-                                                     item.skipAtom();
+                                                         item.skipAtom();
 
-                                                 }  // Wave iddone
-                                                 left=0;
-                                              }  // if ==wave
-                                              else
-                                              {
-                                                if(wave.getFCC()==MKFCCR('e','s','d','s'))
+                                                     }  // Wave iddone
+                                                     left=0;
+                                                     
+                                                  }  // if ==wave
+                                                  break;
+                                              case MKFCCR('e','s','d','s'):
                                                           {
                                                                decodeEsds(&wave,TRACK_AUDIO);
-                                                               goto foundit; // FIXME!!!
+                                                               break;
                                                           }
-                                                else
-                                                {
+                                              default:
                                                   printf("UNHANDLED ATOM : %s\n",fourCC::tostringBE(wave.getFCC()));
-                                                }
+                                                  break;
                                               }
+                                              wave.skipAtom();
+                                             } // while
                                             } // if left > 10
-foundit: // HACK FIXME
                                             left=0;
                                     }
                                             break; // mp4a
@@ -1096,7 +1106,8 @@
                                             _tracks[1+nbAudioTrack].extraDataSize=l;
                                             _tracks[1+nbAudioTrack].extraData=new uint8_t[l];
                                             fread(_tracks[1+nbAudioTrack].extraData,
-                                                _tracks[1+nbAudioTrack].extraDataSize,1,_fd);
+                                            _tracks[1+nbAudioTrack].extraDataSize,1,_fd);
+                                            printf("\t %d bytes of extraData\n",(int)l);
                                             break;
                                         default: printf("Unknown track type for esds %d\n",trackType);
                                     }



From mean at mail.berlios.de  Sat Sep  4 11:05:54 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  4 Sep 2010 11:05:54 +0200
Subject: [Avidemux-svn-commit] r6574 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src
Message-ID: <20100904090554.4438F48100F@sheep.berlios.de>

Author: mean
Date: 2010-09-04 11:05:54 +0200 (Sat, 04 Sep 2010)
New Revision: 6574

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp
Log:
[core/color] support for YUV422

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp	2010-09-03 09:09:57 UTC (rev 6573)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp	2010-09-04 09:05:54 UTC (rev 6574)
@@ -85,6 +85,7 @@
 {
   switch(fromColor)
   {
+    case ADM_COLOR_YUV422: return PIX_FMT_YUYV422;
     case ADM_COLOR_YV12: return PIX_FMT_YUV420P;
     case ADM_COLOR_YUV422P: return PIX_FMT_YUV422P;
     case ADM_COLOR_RGB32A: return PIX_FMT_RGB32;
@@ -133,6 +134,14 @@
             srcStride[1]=width>>1;
             srcStride[2]=width>>1;
             break;
+    case  ADM_COLOR_YUV422:
+            srcData[0]=from;
+            srcData[1]=NULL;
+            srcData[2]=NULL;
+            srcStride[0]=width*2;
+            srcStride[1]=0;
+            srcStride[2]=0;
+            break;
     case  ADM_COLOR_YUV422P:
             srcData[0]=from;
             srcData[1]=from+width*height;



From mean at mail.berlios.de  Sat Sep  4 11:05:55 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  4 Sep 2010 11:05:55 +0200
Subject: [Avidemux-svn-commit] r6575 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src
Message-ID: <20100904090555.6D23948100F@sheep.berlios.de>

Author: mean
Date: 2010-09-04 11:05:55 +0200 (Sat, 04 Sep 2010)
New Revision: 6575

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
Log:
[Codec] Fix mixup between 422 and 422P

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2010-09-04 09:05:54 UTC (rev 6574)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2010-09-04 09:05:55 UTC (rev 6575)
@@ -424,10 +424,12 @@
     case PIX_FMT_YUV411P:
       out->_colorspace = ADM_COLOR_YUV411;
       break;
-
+    case PIX_FMT_YUYV422:
+      out->_colorspace = ADM_COLOR_YUV422;
+      break;
     case PIX_FMT_YUV422P:
     case PIX_FMT_YUVJ422P:
-      out->_colorspace = ADM_COLOR_YUV422;
+      out->_colorspace = ADM_COLOR_YUV422P;
       break;
 
     case PIX_FMT_YUV444P:



From mean at mail.berlios.de  Sat Sep  4 11:05:56 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  4 Sep 2010 11:05:56 +0200
Subject: [Avidemux-svn-commit] r6576 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad
Message-ID: <20100904090556.864BC48100F@sheep.berlios.de>

Author: mean
Date: 2010-09-04 11:05:56 +0200 (Sat, 04 Sep 2010)
New Revision: 6576

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp
Log:
[faad] Avoid potential lockup

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp	2010-09-04 09:05:55 UTC (rev 6575)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp	2010-09-04 09:05:56 UTC (rev 6576)
@@ -228,8 +228,8 @@
 				printf("SBR      : %d\n",info.sbr);
 			}
 			consumed=info.bytesconsumed ;
-			if(consumed>(tail-head)) consumed=0;
-            head+=consumed;
+			if(consumed>(tail-head)) {head=tail=0;}
+                else head+=consumed;
 			if(info.samples)
 			{
                 if(monoFaadBug)



From mean at mail.berlios.de  Sat Sep  4 11:05:58 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  4 Sep 2010 11:05:58 +0200
Subject: [Avidemux-svn-commit] r6577 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters:
	AddBorders AvisynthResize AvisynthResize/gtk
	AvisynthResize/qt4 BlackenBorders Crop Crop/gtk Crop/qt4
	KernelDeint Logo MplayerDenoise3D MplayerResize
	MplayerResize/gtk MplayerResize/qt4 ResampleFps Rotate SwapUV
	VerticalFlip lavDeinterlace
Message-ID: <20100904090558.CE3DB48100F@sheep.berlios.de>

Author: mean
Date: 2010-09-04 11:05:58 +0200 (Sat, 04 Sep 2010)
New Revision: 6577

Removed:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AddBorders/ADM_vidAddBorder.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AddBorders/ADM_vidAddBorder.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AddBorders/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_resizebis.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_resizebis.hxx
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_resizeter.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_vidResize.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_vidResize.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/gtk/gtk_resize.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/Q_resize.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/Q_resize.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/Q_resize.h.orig
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/resizing.ui
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/BlackenBorders/ADM_vidBlackenBorders.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/BlackenBorders/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/ADM_vidCrop.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/ADM_vidCrop_param.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/DIA_flyCrop.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/DIA_flyCrop.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/gtk/DIA_crop.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/qt4/Q_crop.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/qt4/Q_crop.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/qt4/crop.ui
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/KernelDeint/ADM_vidKernelDeint.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/KernelDeint/ADM_vidKernelDeint.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/KernelDeint/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Logo/ADM_vidLogo.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Logo/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3D.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3D.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3Dlow.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3Dlow.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/ADM_vidMPLResize.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/gtk/gtk_resize.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/Q_resize.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/Q_resize.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/Q_resize.h.orig
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/resizing.ui
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/ResampleFps/ADM_vidResampleFPS.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/ResampleFps/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Rotate/ADM_vidRotate.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Rotate/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/SwapUV/ADM_vidUVSwap.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/SwapUV/ADM_vidUVSwap.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/SwapUV/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/VerticalFlip/ADM_vidFlipV.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/VerticalFlip/ADM_vidFlipV.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/VerticalFlip/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deint.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deintparam.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/lavDeinterlace/CMakeLists.txt
Log:
[filter] Remove ported filters

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AddBorders/ADM_vidAddBorder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AddBorders/ADM_vidAddBorder.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AddBorders/ADM_vidAddBorder.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,246 +0,0 @@
-/***************************************************************************
-                          ADM_vidAddBorder.cpp  -  description
-                             -------------------
-    begin                : Sun Aug 11 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-#include "DIA_coreToolkit.h"
-#include "ADM_vidAddBorder.h"
-
-
-
-#include "DIA_factory.h"
-
-static FILTER_PARAM cropParam={4,{"left","right","top","bottom"}};
-
-
-VF_DEFINE_FILTER(AVDMVideoAddBorder,cropParam,
-                addblack,
-                QT_TR_NOOP("Add black borders"),
-                1,
-                VF_TRANSFORM,
-                QT_TR_NOOP("Add pure black border(s)."));
-
-char *AVDMVideoAddBorder::printConf( void )
-{
- 	ADM_FILTER_DECLARE_CONF(" Add Borders %lu x %lu --> %lu x %lu",
- 				_in->getInfo()->width,
- 				_in->getInfo()->height,
- 				_info.width,
- 				_info.height);
-        
-}
-
-AVDMVideoAddBorder::AVDMVideoAddBorder(  AVDMGenericVideoStream *in,CONFcouple *couples)
-{
-
- 	_in=in;		
-   	memcpy(&_info,_in->getInfo(),sizeof(_info));  		
-	
-		if(couples)
-		{
-
-			 _param=NEW(ADDBORDER_PARAMS);
-
-				GET(left);
-				GET(right);
-				GET(top);
-				GET(bottom);
-				_info.width+=_param->right+_param->left;
-				_info.height+=_param->bottom+_param->top;
-		}	
-			else 			
-		{	// default parameter	
-				_param=NEW(ADDBORDER_PARAMS);
-				_param->left=_param->top=
-				_param->right=_param->bottom=0;
-		}				
-					
- 	//_uncompressed=(uint8_t *)malloc(3*_in->getInfo()->width*_in->getInfo()->height);
- 	//_uncompressed=new uint8_t [3*_in->getInfo()->width*_in->getInfo()->height];
-	_uncompressed=new ADMImage(_in->getInfo()->width,_in->getInfo()->height);
-  ADM_assert(_uncompressed);
-  _info.encoding=1;
-
-  	  	
-}
-AVDMGenericVideoStream *create_addBorder(AVDMGenericVideoStream *in,uint32_t x,uint32_t x2,uint32_t y,uint32_t y2)
-{
-	return new AVDMVideoAddBorder(in,x,x2,y,y2);
-}
-AVDMVideoAddBorder::AVDMVideoAddBorder(  AVDMGenericVideoStream *in,uint32_t x,uint32_t x2,uint32_t y,uint32_t y2)
-{
-
- 	_in=in;		
-   	memcpy(&_info,_in->getInfo(),sizeof(_info));  		
-
-				_param=NEW(ADDBORDER_PARAMS);
-				_param->left=x;
-				_param->top=y;
-				_param->right=x2;
-				_param->bottom=y2;
-	_info.width+=_param->right+_param->left;
-	_info.height+=_param->bottom+_param->top;
- 	//_uncompressed=(uint8_t *)malloc(3*_in->getInfo()->width*_in->getInfo()->height);
- 	//_uncompressed=new uint8_t [3*_in->getInfo()->width*_in->getInfo()->height];
-	_uncompressed=new ADMImage(_in->getInfo()->width,_in->getInfo()->height);
-  ADM_assert(_uncompressed);
-  _info.encoding=1;
-
-
-}
-
-uint8_t	AVDMVideoAddBorder::getCoupledConf( CONFcouple **couples)
-{
-
-			ADM_assert(_param);
-			*couples=new CONFcouple(4);
-
-
-	CSET(left);
-	CSET(right);
-	CSET(top);
-	CSET(bottom);
-			return 1;
-
-}
-AVDMVideoAddBorder::~AVDMVideoAddBorder()
-{
- 	delete _uncompressed;
-	DELETE(_param);
-	_uncompressed=NULL;
- 	
-}
-uint8_t AVDMVideoAddBorder::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-
-		if(frame>=_info.nb_frames) 
-		{
-			printf("Filter : out of bound!\n");
-			return 0;
-		}
-	
-		ADM_assert(_param);									
-								
-			// read uncompressed frame
-       		if(!_in->getFrameNumberNoAlloc(frame, len,_uncompressed,flags)) return 0;
-       		
-				// blacken screen
-				memset(YPLANE(data),16,_info.width*_info.height);
-				memset(UPLANE(data),128,(_info.width*_info.height)>>2);
-				memset(VPLANE(data),128,(_info.width*_info.height)>>2);
-
-				// do luma
-				uint8_t *src,*dest;
-       		uint32_t y,x,line,lineout;
-       		
-       		y=_in->getInfo()->height;
-       		x=_in->getInfo()->width;
-       		line=x;
-		lineout=_info.width;
-		
-		// copy Luma
-       		src=YPLANE(_uncompressed);
-       		dest=YPLANE(data)+_param->left+_info.width*_param->top;
-       		
-       		for(uint32_t k=y;k>0;k--)
-       		{
-       		 	    memcpy(dest,src,line);
-       		 	    src+=line;
-       		 	    dest+=lineout;
-       		}
-       		 
-		// U and V now
-		uint8_t *src_u,*src_v;
-		uint8_t *dst_u,*dst_v;
-
-       		src_u=UPLANE(_uncompressed);
-       		src_v=VPLANE(_uncompressed);
-       		line>>=1;
-       		lineout>>=1;       		       		 	
-		dst_u=UPLANE( data)+(_info.width*_param->top>>2)+
-						(_param->left>>1);;
-		dst_v= VPLANE( data)+(_info.width*_param->top>>2)+
-						(_param->left>>1);;
-
-       		 for(uint32_t k=y>>1;k>0;k--)
-       		 {
-       		 	memcpy(dst_u,src_u,line);
-       		 	memcpy(dst_v,src_v,line);
-
-       			src_u+=line;
-       			src_v+=line;
-
-       			dst_u+=lineout;
-       		    	dst_v+=lineout;
-
-       		 }
-       		  *len= _info.width*_info.height+(_info.width*_info.height>>1);
-		  data->copyInfo(_uncompressed);
-      return 1;
-}
-uint8_t AVDMVideoAddBorder::configure(AVDMGenericVideoStream *in)
-{
-	_in=in;
-	ADM_assert(_param);
-        uint32_t width,height;
-#define MAKEME(x) uint32_t x=_param->x;
-        while(1)
-        {
-          MAKEME(left);
-          MAKEME(right);
-          MAKEME(top);
-          MAKEME(bottom);
-          
-          width=_in->getInfo()->width;
-          height=_in->getInfo()->height;
-          
-          diaElemUInteger dleft(&left,QT_TR_NOOP("_Left border:"),       0,width);
-          diaElemUInteger dright(&right,QT_TR_NOOP("_Right border:"),    0,width);
-          diaElemUInteger dtop(&(top),QT_TR_NOOP("_Top border:"),          0,height);
-          diaElemUInteger dbottom(&(bottom),QT_TR_NOOP("_Bottom border:"), 0,height);
-            
-          diaElem *elems[4]={&dleft,&dright,&dtop,&dbottom};
-          if(diaFactoryRun(QT_TR_NOOP("Add Borders"),4,elems))
-          {
-            if((left&1) || (right&1)|| (top&1) || (bottom&1))
-            {
-              GUI_Error_HIG(QT_TR_NOOP("Incorrect parameters"),QT_TR_NOOP("All parameters must be even and within range.")); 
-              continue;
-            }
-            else
-            {
-  #undef MAKEME
-  #define MAKEME(x) _param->x=x;
-                MAKEME(left);
-                MAKEME(right);
-                MAKEME(top);
-                MAKEME(bottom);
-                _info.width=width+left+right;
-                _info.height=height+top+bottom;
-                return 1;
-            }
-          }
-          return 0;
-      }
-}
-
-
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AddBorders/ADM_vidAddBorder.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AddBorders/ADM_vidAddBorder.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AddBorders/ADM_vidAddBorder.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,45 +0,0 @@
-/***************************************************************************
-                          ADM_vidAddBorder.h  -  description
-                             -------------------
-    begin                : Sun Aug 11 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef __ADDBORDER__
-#define     __ADDBORDER__
-
-
-typedef struct
-{
-        uint32_t left,right;
-        uint32_t top,bottom;
-}ADDBORDER_PARAMS;
-
-  class  AVDMVideoAddBorder:public AVDMGenericVideoStream
- {
-
- protected:
-              virtual char        *printConf(void);
-              ADDBORDER_PARAMS         *_param;
- public:
-
-                                    AVDMVideoAddBorder(  AVDMGenericVideoStream *in,CONFcouple *setup);
-                                    AVDMVideoAddBorder(  AVDMGenericVideoStream *in,uint32_t x,uint32_t x2,
-                                                              uint32_t y,uint32_t y2);
-            virtual                 ~AVDMVideoAddBorder();
-            virtual 	uint8_t     getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-                                            ADMImage *data,uint32_t *flags);
-                        uint8_t     configure( AVDMGenericVideoStream *instream) ;
-                        uint8_t     getCoupledConf( CONFcouple **couples);
- }     ;
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AddBorders/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AddBorders/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AddBorders/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,9 +0,0 @@
-INCLUDE(vf_plugin)
-
-
-SET(ADM_vf_addborders_SRCS ADM_vidAddBorder.cpp)
-
-ADD_LIBRARY(ADM_vf_addborders SHARED ${ADM_vf_addborders_SRCS})
-
-INIT_VIDEOFILTER_PLUGIN(ADM_vf_addborders)
-INSTALL_VIDEOFILTER(ADM_vf_addborders)

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_resizebis.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_resizebis.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_resizebis.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,356 +0,0 @@
-/***************************************************************************
-                          ADM_resizebis.cpp  -  description
-                             -------------------
-
-      Strongly derivated from avisynth
-
-      Seems that int on VC++ is a long integer, hence the INT cast.
-
-
-    begin                : Sun Mar 24 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include <math.h>
-
-#include "ADM_default.h"
-
-#include "ADM_videoFilterDynamic.h"
-#include "ADM_vidResize.h"
-#include "ADM_resizebis.hxx"
-
-#define SLOW
-
-// General purpose, no need to put them inside class
-// declare static as it could lead to some optimizations
-// the original file was plain C
-
-double TriangleFunc(double x);
-double MitchellFunc(double x);
-double Lanczos3f(double x);
-double Lanczos3sinc(double x);
-
-
-ResampleFunc TriangleFilter = {
-    TriangleFunc, 1.0
-};
-
-ResampleFunc MitchellFilter = {
-    MitchellFunc, 2.0
-};
-
-ResampleFunc LanczosFilter = {
-    Lanczos3f, 3.0
-};
-
-
-
-ResampleFunc RFuncs[3] = {
-    TriangleFilter, MitchellFilter,LanczosFilter
-};
-
-
-//________________________________________________
-
-double TriangleFunc(double x)
-{
-    x = fabs(x);
-    return (x < 1.0) ? 1.0 - x : 0.0;
-}
-
-
-#define bbb (1./3.)
-#define ccc (1./3.)
-#define p0  ((6. - 2. * bbb) / 6.)
-#define p2  ((-18. + 12. * bbb + 6. * ccc) / 6.)
-#define p3  ((12. - 9. * bbb - 6. * ccc) / 6. )
-#define q0  ((8. * bbb + 24. * ccc) / 6.   )
-#define q1  ((-12. * bbb - 48. * ccc) / 6.)
-#define q2  ((6. * bbb + 30. * ccc) / 6.)
-#define   q3 ( (     -     bbb -  6.*ccc) / 6.)
-double MitchellFunc(double x)
-{
-    x = fabs(x);
-    return (x < 1.0) ? (p0 + x * x * (p2 + x * p3)) :
-      (x <  2.) ? (q0 +     x * (q1 +  x *  (q2   +   x   *   q3))): 0.0;
-}
-double Lanczos3sinc(double value)
-{
-	if (value != 0.0)
-	{
-		value *= M_PI;
-		return sin(value) / value;
-	}
-	else
-	{
-		return 1.0;
-	}
-}
-
-double Lanczos3f(double value)
-{
-	if (value < 0.0)
-	{
-		value = -value;
-	}
-	if (value < 3.0)
-	{
-		return (Lanczos3sinc(value) * Lanczos3sinc(value / 3.0));
-	}
-	else
-	{
-		return 0.0;
-	}
-}
-
-
-
-// This function returns a resampling "program" which is interpreted by the
-// FilteredResize filters.  It handles edge conditions so FilteredResize
-// doesn't have to.
-//____________________________________________________________________________
-
-INT *GetResamplingPattern(uint32_t original_width,
-			      uint32_t target_width, ResampleFunc * func)
-{
-    double scale, filter_step,filter_support;
-    double pos_step ;
-
-    scale = double (target_width);
-    scale/= (double)original_width;
-    if (scale < 1.0)
-	filter_step = scale;
-
-    else
-	filter_step = 1.0;
-    filter_support = func->support;
-    filter_support /= filter_step;
-    int fir_filter_size = int (ceil(filter_support * 2));
-    INT *result = new INT[1 + target_width * (1 + fir_filter_size)];
-    INT *cur = result;
-    
-    *cur++ = fir_filter_size;
-   
-    printf("\n Fir size : %d",fir_filter_size);
-    pos_step=original_width;
-    pos_step /= target_width;
-
- 
-
-    // the following translates such that the image center remains fixed
-    double pos = original_width;
-
-       pos-= target_width ;
-       pos/= (target_width * 2);
-
-//   printf("\n In width : %lu out width : %lu pos_step : %lf pos_initial : %lf",original_width,target_width, pos_step,pos);
-
-    for (uint32_t i = 0; i < target_width; ++i)
-
-      {
-	  INT end_pos = (INT) (pos + filter_support);
-	  if (end_pos > (INT)original_width - 1)
-	      end_pos = original_width - 1;
-	  INT start_pos = end_pos - fir_filter_size + 1;
-	  if (start_pos < 0)
-	      start_pos = 0;
-	  *cur++ = start_pos;
-
-	  // the following code ensures that the coefficients add to exactly 65536
-	  double total = 0.0;
-	  for (int j = 0; j < fir_filter_size; ++j)
-	      total += func->f((start_pos + j - pos) * filter_step);
-	  double total2 = 0.0;
-	  for (int k = 0; k < fir_filter_size; ++k)
-
-	    {
-		double total3 =
-		    total2 +func->f((start_pos + k - pos) * filter_step) / total;
-		    *cur++ =int (total3 * 65536 + 0.5) - int (total2 * 65536 +
-						      0.5);
-		total2 = total3;
-	    } 
-            pos += pos_step;
-      } 
-      return result;
-}
-
-//
-//      Vertical resizing
-//              Resized one plane also
-//_______________________________
-void AVDMVideoStreamResize::ResizeV(Image * iin, Image * iout,
-				    INT *pattern)
-{
-    INT *cur = pattern;
-    int fir_filter_width = *cur++;
-    int row_size = iin->width;
-    unsigned char *out = iout->data;
-    unsigned char *srcbuffer = iin->data;
-    unsigned char *base ,*base2;
-	int total;
-
-    for (uint32_t y = 0; y < iout->height; ++y)
-
-      {
-	  			base = srcbuffer + row_size * (*cur++);
-	  			for (int x = 0; x < row_size; ++x)
-				  {
-					 total = 0;
-					 base2 = base + x;
-					for (int b = 0; b < fir_filter_width; ++b)
-				  	{	
-				      		total += *base2 * cur[b];
-		      				base2 += row_size;
-					  }
-					  *out++ = ScaledPixelClip(total);
-	  			  } 
-				cur += fir_filter_width;
-	}
-}
-
-//____________________________________
-//      Perform horizontal resizing
-//              On one plane
-//              Must be called 3 times for RGB or 3 times for YV12
-//____________________________________
-void AVDMVideoStreamResize::ResizeH(Image * iin, Image * iout,
-				    INT  *pattern)
-{
-    unsigned char *base = iin->data;
-    unsigned char *out = iout->data;
-    int src_row_size = iin->width;
-    int dst_row_size = iout->width;
-	uint8_t *ptr;
-	INT *cur;
-	int32_t total;
-   INT ofs;
-    
-    for (uint32_t y =  iin->height; y>0; y--)
-      {
-	  	cur = pattern + 1;
-	  for (int x = 0; x < dst_row_size ; x++)
-	    {
-			total=0;
-			ofs = *cur++;
-			ptr= &(base[(ofs )]);
-
-			for (int a =   pattern[0];a>0; a--)
-			  {
-			      total += (*ptr++) * (*cur++);
-		  		}
-		   		out[x] = ScaledPixelClip(total);
-	    } // next line...
-	     base += src_row_size;
-	  	out += dst_row_size;
-	}
-
-}
-
-///_____________
-
-/*  ____________________________________________________________________
-	zoom()
-
-	Resizes bitmaps while resampling them.
-	Returns -1 if error, 0 if success.
-*/
-void AVDMVideoStreamResize::precompute(Image * dst, Image * src,
-				       uint8_t algo)
-//____________________________________________________________________
-{
-
-#define FREE_USED(x) if(x) { delete [] x;x=NULL;}
-	FREE_USED(Hpattern_luma);
-	FREE_USED(Hpattern_chroma);
-	FREE_USED(Vpattern_luma);
-	FREE_USED(Vpattern_chroma);
-	
-#ifdef SLOW	 
-	#define MakePattern GetResamplingPattern
-#else
-	#define MakePattern GetResamplingPatternFIR4
-#endif
-
-    Hpattern_luma = MakePattern(src->width,  dst->width, &RFuncs[algo]);
-    Hpattern_chroma =MakePattern(src->width >> 1,  dst->width >> 1, &RFuncs[algo]);
-    Vpattern_luma =MakePattern(src->height,  dst->height,&RFuncs[algo]);
-    Vpattern_chroma =MakePattern(src->height >> 1,   dst->height >> 1, &RFuncs[algo]);
-
-
-}
-
-//__________________________________________________________________
-uint8_t AVDMVideoStreamResize::zoom(Image * dst, Image * src)				
-//__________________________________________________________________
-{
-  // First Horizontal resize from src -> intermediate
-  Image tmpin;
-                      tmpin.width=dst->width;
-                      tmpin.height=src->height;
-                      tmpin.data=_intermediate_buffer;
-		      
-
-#ifdef SLOW		 											
-					#define DORES(src,dst,patH,patV)   	ResizeH(src, &tmpin,patH)    ;  \
-													        		        ResizeV(&tmpin,dst,patV);        
-#else                     
-					#define DORES(src,dst,patH,patV)    ResizeHFIR4(src, &tmpin,patH)    ; \
-													           					ResizeVFIR4(&tmpin,dst,patV);      
-#endif
-		      
-		      
-		      //---------Y---------------
-		      
-		      	DORES(src,dst,Hpattern_luma, Vpattern_luma);
-    				
-
-				// update fields, 
-    				src->data+=src->width*src->height;
-    				dst->data+=dst->width*dst->height;
-    				
-    		    src->width>>=1;
-    		    src->height>>=1;
-    		    dst->width>>=1;
-    		    dst->height>>=1;
-          
-		       	tmpin.height=src->height;
-		       	tmpin.width=dst->width;
-		       	tmpin.data+= tmpin.height*tmpin.width;
-
-		       // --------- U -------------
-		      	DORES(src,dst,Hpattern_chroma, Vpattern_chroma);
-		          				
-    		    src->data+=src->width*src->height;
-    				dst->data+=dst->width*dst->height;
-    				tmpin.data+= tmpin.height*tmpin.width;
-		       // --------- V -------------
-		      
-		      	DORES(src,dst,Hpattern_chroma, Vpattern_chroma);    				
-    		       
-    return 1;
-}				/* zoom */
-
-
-// clean up insiders datas
-//
-void AVDMVideoStreamResize::endcompute(void)
-{
-	FREE_USED(Hpattern_luma);
-	FREE_USED(Hpattern_chroma);
-	FREE_USED(Vpattern_luma);
-	FREE_USED(Vpattern_chroma);
-}
-
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_resizebis.hxx
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_resizebis.hxx	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_resizebis.hxx	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,52 +0,0 @@
-/***************************************************************************
-                          ADM_resizebis.hxx  -  description
-                             -------------------
-    begin                : Sun Mar 24 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef __RESIZE_B_SUPPORT
-#define __RESIZE_B_SUPPORT
-
-typedef struct {
-    double (*f) (double x);
-    double support;
-} ResampleFunc;
-
-INT *GetResamplingPattern(uint32_t original_width,
-			      uint32_t target_width, ResampleFunc * func);
-
-INT *GetResamplingPatternFIR4(uint32_t original_width,
-			      uint32_t target_width, ResampleFunc * func);
-		
-static inline uint8_t PixelClip(int16_t in)
-{
-    if (in > 255)
-	in = 255;
-   if(in<0)
-   	in=0;
-    return (uint8_t) in;
-};
-			   	   
-static inline unsigned char ScaledPixelClip(INT i)
-{
-    return PixelClip(((i +32768) >> 16)); //  + 32768
-};
-
-static inline unsigned char ScaledPixelClip8(int16_t i)
-{
-    return PixelClip(((i +256) >> 8)); //  + 32768
-};
-
-			         
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_resizeter.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_resizeter.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_resizeter.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,193 +0,0 @@
-/***************************************************************************
-                          ADM_resizeter.cpp  -  description
-                             -------------------
-                             
-		This is an optimised with FIR size=4
-		of vidResizebis
-		
-    Faster but lesser quality		
-    (nb sample to compute is potentially smaller)                                                          
-                             
-    begin                : Sat Sep 21 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-#include "ADM_vidResize.h"
-#include "ADM_resizebis.hxx"
- 
- 
- /*
-  	Same as above but use a fixed size FIR size of 4
-   	Good until ~ half width
-
-
-*/
-INT *GetResamplingPatternFIR4(uint32_t original_width,
-			      uint32_t target_width, ResampleFunc * func)
-{
-    double scale, filter_step,filter_support;
-    double pos_step ;
-
-    scale = double (target_width);
-    scale/= (double)original_width;
-    if (scale < 1.0)
-	filter_step = scale;
-
-    else
-	filter_step = 1.0;
-    filter_support = func->support;
-    filter_support /= filter_step;
-    
-    int fir_filter_size = 3;
-    
-    
-    int16_t  *result = new int16_t[1 + target_width * (1 + fir_filter_size)];
-    int16_t  *cur = result;
-    
-    *cur++ = fir_filter_size;
-   
-    printf("\n Fixed Fir size : %d",fir_filter_size);
-    pos_step=original_width;
-    pos_step /= target_width;
-
- 
-
-    // the following translates such that the image center remains fixed
-    double pos = original_width;
-
-       pos-= target_width ;
-       pos/= (target_width * 2);
-
-//   printf("\n In width : %lu out width : %lu pos_step : %lf pos_initial : %lf",original_width,target_width, pos_step,pos);
-
-    for (uint32_t i = 0; i < target_width; ++i)
-
-      {
-	  INT end_pos = (INT) (pos + filter_support);
-	  if (end_pos > (INT)original_width - 1)
-	      end_pos = original_width - 1;
-	  INT start_pos = end_pos - fir_filter_size + 1;
-	  if (start_pos < 0)
-	      start_pos = 0;
-	  *cur++ = start_pos;
-
-	  // the following code ensures that the coefficients add to exactly 65536
-	  double total = 0.0;
-	  for (int j = 0; j < fir_filter_size; ++j)
-	      total += func->f((start_pos + j - pos) * filter_step);
-	  double total2 = 0.0;
-	  for (int k = 0; k < fir_filter_size; ++k)
-
-	    {
-		double total3 =
-		    total2 +func->f((start_pos + k - pos) * filter_step) / total;
-		    *cur++ =int (total3 * 256 + 0.5) - int (total2 * 256 +
-						      0.5);
-		total2 = total3;
-	    } 
-            pos += pos_step;
-      } 
-      return (INT *)result;
-}
-
-
-
-
-/*
-      Vertical resizing
-
-  		Fast resample, FIR= 4 hardcoded
-    
-    	the input is byte
-     	the coef are signed 16 bits integere
-
-*/
-void AVDMVideoStreamResize::ResizeVFIR4(Image * iin, Image * iout,
-				    INT *intpattern)
-{
-    int16_t *pattern = (int16_t *)intpattern;
-
-    int16_t *cur = pattern;
-    /*int fir_filter_width = *cur++*/cur++;
-    int row_size = iin->width;
-    unsigned char *out = iout->data;
-    unsigned char *srcbuffer = iin->data;
-    unsigned char *base ,*base2;
-		int total;
-		
-			
-
-    for (uint32_t y = 0; y < iout->height; ++y)
-
-      {
-	  			base = srcbuffer + row_size * (*cur++);
-	  			for (int x = 0; x < row_size; ++x)
-				  {
-					
-					 base2 = base + x;
-					 
-					    		total = *base2 							 * cur[0];
-					    		total += *(base2+row_size) 		 * cur[1];
-					    		total += *(base2+(row_size<<1)) * cur[2];		      			
-					    		//total += *(base2 + row_size*3) * cur[3];
-								  *out++ = ScaledPixelClip8(total);
-	  			  } 
-				cur += 3;
-		}
-}
-
-
-/*
-  		Fast resample, FIR= 4 hardcoded
-    
-    	the input is byte
-     	the coef are signed 16 bits integere
-
-*/
-void AVDMVideoStreamResize::ResizeHFIR4(Image * iin, Image * iout,
-				    INT  *bigpattern)
-{
-    uint8_t *base = iin->data;
-    uint8_t *out 	= iout->data;
-  
-    int src_row_size = iin->width;
-    int dst_row_size = iout->width;
-    int16_t *pattern=(int16_t *)bigpattern;
-    
-		uint8_t 				*ptr;
-		int16_t 				*cur;
-		static int32_t 	total;
-		//int32_t					*t=&total;
-  	int16_t 				ofs;
-   
-	for (uint32_t y =  iin->height; y>0; y--)
-      {
-	  	cur = pattern + 1;	   
-		  for (int x = 0; x < dst_row_size ; x++)
-	    {
-				ofs = *cur++;
-				ptr= &(base[(ofs )]);
-      	total=0;
-	
-				total =  *(ptr) 	* *(cur);
-				total += *(ptr+1) * *(cur+1);
-		  	total += *(ptr+2) * *(cur+2);
-//		  	total += *(ptr+3) * *(cur+3);   		   		
-      	cur+=3;
-		  	*out++ = ScaledPixelClip8(total);
-	    } // next line...
-	     base += src_row_size;
-	}
-}

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_vidResize.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_vidResize.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_vidResize.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,254 +0,0 @@
-/***************************************************************************
-                          ADM_vidResize.cpp  -  description
-                             -------------------
-   Resize a picture in YUV12
-
-   w,h 		size of final picture
-   dw,dh  size of black bordered picture
-
-
-    begin                : Thu Mar 21 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-
-#include "ADM_default.h"
-
-#include "ADM_videoFilterDynamic.h"
-#include "ADM_resizebis.hxx"
-#include "ADM_vidResize.h"
-
-#include "DIA_coreToolkit.h"
-
-
-static FILTER_PARAM mpresizeParam={3,{"w","h","algo"}};
-
-//********** Register chunk ************
-VF_DEFINE_FILTER_UI(AVDMVideoStreamResize,mpresizeParam,
-                resize,
-                QT_TR_NOOP("Resize"),
-                1,
-                VF_TRANSFORM,
-                QT_TR_NOOP("Picture resizer ported from Avisynth (C Version, slow)."));
-//****************************************
-
-char *AVDMVideoStreamResize::printConf( void )
-{
- 	ADM_FILTER_DECLARE_CONF(" Resize %lu x %lu --> %lu x %lu",
- 				_in->getInfo()->width,
- 				_in->getInfo()->height,
- 				_info.width,
- 				_info.height);
-        
-}
-//_______________________________________________________________
-AVDMVideoStreamResize::AVDMVideoStreamResize(
-									AVDMGenericVideoStream *in,CONFcouple *couples)
-{
-
-  	_in=in;
-   	memcpy(&_info,_in->getInfo(),sizeof(_info));
-	_uncompressed=new ADMImage(_info.width,_info.height);
-
-		if(couples)
-		{
-			 _param=NEW(RESIZE_PARAMS);
-			GET(w);
-			GET(h);
-			GET(algo);
-			_info.width=_param->w;
-			_info.height=_param->h;
-
-		}
-			else
-			{
-				_param=NEW( RESIZE_PARAMS);
-				_param->w=_info.width;
-				_param->h = _info.height;
-				_param->algo = 0;
-			}			
-			_intermediate_buffer=new uint8_t [3*_info.width*_in->getInfo()->height];	
-
-  _info.encoding=1;
-  _init=0;
-	Vpattern_luma=NULL;
-    Vpattern_chroma=NULL;
-	Hpattern_luma=NULL;
-    Hpattern_chroma=NULL;
-}
-#if !defined(MPLAYER_RESIZE_PREFFERED) 
-AVDMGenericVideoStream *createResizeFromParam(AVDMGenericVideoStream *in,uint32_t x,uint32_t y)
-{
-
-	return new AVDMVideoStreamResize(in,x,y);
-}
-#endif
-AVDMVideoStreamResize::AVDMVideoStreamResize(
-									AVDMGenericVideoStream *in,uint32_t x,uint32_t y)
-{
-
-  	_in=in;
-   	memcpy(&_info,_in->getInfo(),sizeof(_info));
-	_uncompressed=new ADMImage(_info.width,_info.height);
-	_param=NEW( RESIZE_PARAMS);
-	_param->w=x;
-	_param->h = y;
-	_info.width=_param->w;
-	_info.height=_param->h;
-	_param->algo = 0;
-	_intermediate_buffer=new uint8_t [3*_info.width*_in->getInfo()->height];
-
-	_info.encoding=1;
-	_init=0;
-	Vpattern_luma=NULL;
-	Vpattern_chroma=NULL;
-	Hpattern_luma=NULL;
-	Hpattern_chroma=NULL;
-}
-
-uint8_t	AVDMVideoStreamResize::getCoupledConf( CONFcouple **couples)
-{
-
-			ADM_assert(_param);
-			*couples=new CONFcouple(3);
-
-#define CSET(x)  (*couples)->setCouple((char *)#x,(_param->x))
-	CSET(w);
-	CSET(h);
-	CSET(algo);
-			return 1;
-
-}
-// ___ destructor_____________
-AVDMVideoStreamResize::~AVDMVideoStreamResize()
-{
- 	delete  _uncompressed;
-	delete [] _intermediate_buffer;
-	DELETE(_param);
-	_uncompressed=NULL;
-	_intermediate_buffer=NULL;
- 	endcompute();
-}
-
-//
-//	Basically ask a uncompressed frame from editor and ask
-//		GUI to decompress it .
-//
-
-uint8_t AVDMVideoStreamResize::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-static Image in,out;
-	if(frame>=_info.nb_frames) 
-	{
-		printf("Filter : out of bound!\n");
-		return 0;
-	}
-	
-	ADM_assert(_param);	
-	if(!_in->getFrameNumberNoAlloc(frame, len,_uncompressed,flags)) return 0;
-       		
-	// do the resize in 3 passes, Y, U then V
-	in.width=_in->getInfo()->width;
-	in.height=_in->getInfo()->height;
-	in.data=_uncompressed->data;
-
-	out.width=_info.width;
-	out.height=_info.height;
-	out.data=data->data;	
-	if(!_init)
-	{
-		_init=1;
-		printf("\n Precomputing with algo :%lu\n",_param->algo);
-		if(_param->algo>2)
-                {
-			printf("\n Wrong algorithm selection");
-			ADM_assert(0);
-		}
-		precompute(&out,&in, _param->algo );
-	}
-       	zoom(&out,&in)         ;       
-       data->flags=*flags=_uncompressed->flags;
-
-       *len= _info.width*_info.height+(_info.width*_info.height>>1);
-       data->copyInfo(_uncompressed);	
-      return 1;
-}
-
-
-static int getResizeParams(uint32_t * w, uint32_t * h, uint32_t * algo,uint32_t ow,uint32_t oh,uint32_t fps);
-
-
-extern uint8_t DIA_resize(uint32_t *width,uint32_t *height,uint32_t *algo,uint32_t originalw, uint32_t originalh,uint32_t fps1000);
-
-uint8_t AVDMVideoStreamResize::configure(AVDMGenericVideoStream * instream)
-{
-    UNUSED_ARG(instream);
-
-    RESIZE_PARAMS *par;
-//    uint8_t ret=0;
-
-    _init = 0;          // force recompute
-    par = _param;
-
-
-
-    if (!getResizeParams(&par->w, &par->h, &par->algo,instream->getInfo()->width,instream->getInfo()->height,_info.fps1000))
-      {
-      return 0;
-      }
-      printf("\n OK was selected \n");
-    // update other parameters
-    _info.width = _param->w;
-    _info.height = _param->h;
-    // intermediate buffer
-    if (_intermediate_buffer)
-      {
-      delete  [] _intermediate_buffer;
-      _intermediate_buffer = NULL;
-      }
-    //_intermediate_buffer=(uint8_t *)malloc(3*_info.width*_in->getInfo()->height);
-    _intermediate_buffer =
-    new uint8_t[3 * _info.width * _in->getInfo()->height];
-
-    return 1;
-
-}
-
-//
-//  
-//
-//
-//   static GtkWidget *resi;
-int getResizeParams(uint32_t * w, uint32_t * h, uint32_t * algo,uint32_t ow,uint32_t oh,uint32_t fps)
-{
-uint32_t ww,hh;
-    while(1)
-    {
-        ww=*w;
-        hh=*h;
-        if(!DIA_resize(&ww,&hh,algo,ow,oh,fps)) return 0;
-                if(!ww || !hh) GUI_Error_HIG(QT_TR_NOOP("Width and height cannot be 0"), NULL);
-        else
-                  if( ww&1 || hh &1) GUI_Error_HIG(QT_TR_NOOP("Width and height cannot be odd"), NULL);
-            else
-            {
-                *w=ww;
-                *h=hh;
-                return 1;
-            }
-    }
-}
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_vidResize.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_vidResize.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/ADM_vidResize.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,44 +0,0 @@
-/**
-    \file ADM_vidResize.h
-
-
-*/
-#ifndef ADM_VIDRESIZE_H
-#define ADM_VIDRESIZE_H
-class  AVDMVideoStreamResize:public AVDMGenericVideoStream
- {
-
- protected:
-            RESIZE_PARAMS           *_param;
-            uint8_t             _init;
-            INT                     *Hpattern_luma;
-            INT                     *Hpattern_chroma;
-            INT                     *Vpattern_luma;
-            INT                     *Vpattern_chroma;
-            uint8_t                 *_intermediate_buffer;
-        // engine
-        void ResizeV(Image * iin, Image * iout, INT *pattern) ;
-        void ResizeVFIR4(Image * iin, Image * iout, INT *pattern) ;
-
-        void ResizeH(Image * iin, Image * iout, INT *pattern) ;
-        void ResizeHFIR4(Image * iin, Image * iout, INT  *pattern)  ;
-
-        void precompute(Image * dst, Image * src, uint8_t algo);
-            uint8_t     zoom(Image * dst, Image * src);
-            void endcompute(void);
-
- public:
-
-                AVDMVideoStreamResize(  AVDMGenericVideoStream *in,CONFcouple *setup);
-                AVDMVideoStreamResize(  AVDMGenericVideoStream *in,uint32_t x,uint32_t y);
-                virtual         ~AVDMVideoStreamResize();
-          virtual       uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-                                                                            ADMImage *data,uint32_t *flags);
-                uint8_t configure( AVDMGenericVideoStream *instream);
-    virtual         char    *printConf(void) ;
-
-          virtual uint8_t   getCoupledConf( CONFcouple **couples);
-
-
- }     ;
- #endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,20 +0,0 @@
-INCLUDE(vf_plugin)
-
-SET(avisynthResizeCommon_SRCS 
-	ADM_resizebis.cpp  ADM_resizeter.cpp  ADM_vidResize.cpp
-)
-
-
-SET(resizeCommonGtk_SRCS gtk/gtk_resize.cpp)
-
-SET(resizeQt_SRCS qt4/Q_resize.cpp)
-SET(resizeQt_Headers qt4/Q_resize.h)
-SET(resizeQt_UI qt4/resizing)
-
-INCLUDE(vf_plugin_gtk)
-INCLUDE(vf_plugin_qt4)
-
-INIT_VIDEOFILTER_PLUGIN_QT4(ADM_vf_avisynthResize_qt4 
-                ${resizeQt_SRCS} ${resizeQt_Headers} ${resizeQt_UI} ${avisynthResizeCommon_SRCS})
-INIT_VIDEOFILTER_PLUGIN_GTK(ADM_vf_avisynthResize_gtk 
-                ${resizeCommonGtk_SRCS} ${avisynthResizeCommon_SRCS})

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/gtk/gtk_resize.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/gtk/gtk_resize.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/gtk/gtk_resize.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,561 +0,0 @@
-/*
-	Resize GUI
-
-*/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include <math.h>
-
-#include "ADM_toolkitGtk.h"
-#include "ADM_default.h"
-#define aprintf(...) {}
-
-#include <gdk/gdkkeysyms.h>
-#include <gtk/gtk.h>
-
-
-#include "ADM_gladeSupport.h"
-
-#define FILL_ENTRY(widget_name,string) 		{r=-1;   \
-gtk_editable_delete_text(GTK_EDITABLE(lookup_widget(dialog,#widget_name)), 0,-1);\
-gtk_editable_insert_text(GTK_EDITABLE(lookup_widget(dialog,#widget_name)), string, strlen(string), &r);}
-#define CHECKBOX(x,y) if(TRUE==gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(lookup_widget(dialog,#x))))  \
-			y=1; else y=0;
-#define READ_ENTRY(widget_name)   gtk_editable_get_chars(GTK_EDITABLE (lookup_widget(dialog,#widget_name)), 0, -1);
-
-#define SPIN_GET(x,y) {y= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(WID(x))) ;}
-#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(x)),(gfloat)y) ;}
-
-
-/*----------------------------------------------*/
-static GtkWidget	*create_dialog1 (void);
-static void drag(GtkButton * button, gpointer user_data);
-static void read (void );
-static void write (void );
-/*----------------------------------------------*/
-static GtkWidget *dialog;
-static uint32_t iw,ih,ow,oh;
-static GtkAdjustment *adj_angle;
-static gint  r;
-static int sar;
-static int dar;
-static int resizeMethod;
-static int roundBool;
-static float erx,ery;
-static double aspectRatio[2][3]={
-								{1.,0.888888,1.19}, // NTSC 1:1 4:3 16:9
-								{1.,1.066667,1.43} // PAL  1:1 4:3 16:9
-							};
-static int pal=1;
-/*----------------------------------------------*/
-uint8_t DIA_resize(uint32_t *width,uint32_t *height,uint32_t *alg,uint32_t originalw, uint32_t originalh,uint32_t fps1000)
-{
-
-
-	char str[100];
-	uint8_t ret=0;
-
-
-	if(fps1000>24600 && fps1000<25400)
-	{
-		aprintf("Pal\n");
-		pal=1;
-	}
-	else
-	{
-		aprintf("NTSC\n");
-		pal=0;
-	}
-
-	ow=originalw;
-	oh=originalh;
-
-	iw=*width;
-	ih=*height;
-	dialog=create_dialog1();
-	//gtk_transient(dialog);
-        gtk_register_dialog(dialog);
-	erx=ery=0;
-
-	double val;
-	val=100.*iw;
-	if(ow) val=val/ow;
-	adj_angle=	gtk_range_get_adjustment (GTK_RANGE(WID(hscale1)));
-	gtk_adjustment_set_value( GTK_ADJUSTMENT(adj_angle),(  gdouble  ) val );
-
-	// remember algo
- 	gtk_option_menu_set_history (GTK_OPTION_MENU (WID(optionmenu1)), *alg);
-
-
-	#define CONNECT(w,x) gtk_signal_connect(GTK_OBJECT(lookup_widget(dialog,#w)), #x, \
-		       GTK_SIGNAL_FUNC(drag), NULL)
-
-		       	CONNECT(hscale1,drag_data_received);
-			CONNECT(hscale1,drag_motion);
-			CONNECT(hscale1,drag_data_get);
-			CONNECT(hscale1,drag_begin);
-
-			gtk_signal_connect(GTK_OBJECT(adj_angle),"value_changed",    GTK_SIGNAL_FUNC(drag), NULL);
-
-	write();
-
-	ret=0;
-	uint8_t stop=0;
-	while(!stop)
-	{
-		switch(gtk_dialog_run(GTK_DIALOG(dialog)))
-		{
-			case GTK_RESPONSE_OK:
-				gchar *s;
-
-                                SPIN_GET(spinbutton_width,*width);
-                                SPIN_GET(spinbutton_height,*height);
-				*alg= getRangeInMenu(lookup_widget(dialog,"optionmenu1"));
-				ret=1;
-				stop=1;
-				break;
-		default:			
-		case GTK_RESPONSE_CANCEL:
-				stop=1;
-				break;
-		case GTK_RESPONSE_APPLY:
-				drag(NULL,NULL);
-				break;
-							
-		}
-
-	}
-        gtk_unregister_dialog(dialog);
-	gtk_widget_destroy(dialog);
-
-	return ret;
-
-}
-/*
-	Called when the hscale is changed
-*/
-void drag(GtkButton * button, gpointer user_data)
-{
-  UNUSED_ARG(button);
-  UNUSED_ARG(user_data);
-
-  double percent;
-  float x,y;
-  float sr_mul,dst_mul;
-
- int32_t xx,yy;
-
-
-
-  percent = GTK_ADJUSTMENT(adj_angle)->value;
-  if(percent<10.0) percent=10.;
-  read();
-
-  aprintf("drag called : %f \n",percent);
-  x=ow;
-  y=oh;
- erx=0;
- ery=0;
-  sr_mul=1.;
-  if(sar)
-  	{  // source is 4/3 or 16/9
-			sr_mul=aspectRatio[pal][sar];
-
-	}
-
-dst_mul=1.;
-  if(dar)
-  	{  // dst is 4/3 or 16/9
-
-			dst_mul=1/aspectRatio[pal][dar];
-	}
-	aprintf("source mul %02.2f , dst mul : %02.2f\n",sr_mul,dst_mul);
-	x=x*sr_mul*dst_mul;
-	y=y;
-
-	// normalize it to recover 100% width
-	y=y/(x/ow);
-	x=ow;
-
-	aprintf("AR:x,y  : %03f %03f \n",x,y);
-
-  	percent/=100.;
-  	x=x*percent;
-  	y=y*percent;
-
-
-	aprintf("AR x,y  : %03f %03f \n",x,y);
-  	xx=(uint32_t)floor(x+0.5);
-	yy=(uint32_t)floor(y+0.5);
-
-	if(xx&1) xx--;
-	if(yy&1) yy--;
-
-
-	if(roundBool)
-	{
-		int32_t ox=xx,oy=yy;
-		xx=(xx +7) & 0xfffff0;
-		yy=(yy +7) & 0xfffff0;
-
-		erx=(xx-ox);
-		erx=erx/xx;
-		ery=(yy-oy);
-		ery=ery/yy;
-
-		aprintf("x: %d -> %d : err %f\n",ox,xx,erx);
-		aprintf("y: %d -> %d : err %f\n",oy,yy,ery);
-	}
-
-	iw=xx;
-	ih=yy;
-	write();
-
-  }
-//---------------------------------------------
-// 	read all value from dialog
-//---------------------------------------------
-void read (void )
-{
-	// Read source and dest aspect ratio
- 	sar=getRangeInMenu(WID(optionmenu_source));
-	dar=getRangeInMenu(WID(optionmenu_dest));
-	// Read resizing method
-	resizeMethod=getRangeInMenu(WID(optionmenu1));
-	// Read round to neareast 16
-	CHECKBOX(checkbutton_16,roundBool);
-
-}
-//---------------------------------------------
-// 	update dialog with new value
-//---------------------------------------------
-
-void write (void )
-{
- char str[100];
-
-        SPIN_SET(spinbutton_width,iw);
-        SPIN_SET(spinbutton_height,ih);
-
-	sprintf(str,"%2.2f",erx*100.);
-	gtk_label_set_text(GTK_LABEL(WID(label_errorx)),str);
-
-	sprintf(str,"%2.2f",ery*100.);
-	gtk_label_set_text(GTK_LABEL(WID(label_errory)),str);
-
-}
-
-//----------------------------
-GtkWidget*
-create_dialog1 (void)
-{
-  GtkWidget *dialog1;
-  GtkWidget *dialog_vbox1;
-  GtkWidget *vbox1;
-  GtkWidget *table2;
-  GtkWidget *label1;
-  GtkWidget *label2;
-  GtkObject *spinbutton_width_adj;
-  GtkWidget *spinbutton_width;
-  GtkObject *spinbutton_height_adj;
-  GtkWidget *spinbutton_height;
-  GtkWidget *label5;
-  GtkWidget *label6;
-  GtkWidget *optionmenu_source;
-  GtkWidget *menu1;
-  GtkWidget *item1_1;
-  GtkWidget *_4_1;
-  GtkWidget *_16_1;
-  GtkWidget *optionmenu_dest;
-  GtkWidget *menu2;
-  GtkWidget *menuitem1;
-  GtkWidget *menuitem2;
-  GtkWidget *menuitem3;
-  GtkWidget *label3;
-  GtkWidget *label_errorx;
-  GtkWidget *label7;
-  GtkWidget *label_errory;
-  GtkWidget *checkbutton_16;
-  GtkWidget *optionmenu1;
-  GtkWidget *menu3;
-  GtkWidget *bilinear1;
-  GtkWidget *bicubic1;
-  GtkWidget *lanczos1;
-  GtkWidget *alignment1;
-  GtkWidget *fixed1;
-  GtkWidget *fixed2;
-  GtkWidget *hscale1;
-  GtkWidget *dialog_action_area1;
-  GtkWidget *cancelbutton1;
-  GtkWidget *applybutton1;
-  GtkWidget *okbutton1;
-
-  dialog1 = gtk_dialog_new ();
-  gtk_window_set_title (GTK_WINDOW (dialog1), QT_TR_NOOP("Resize"));
-  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
-
-  dialog_vbox1 = GTK_DIALOG (dialog1)->vbox;
-  gtk_widget_show (dialog_vbox1);
-
-  vbox1 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox1);
-  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
-
-  table2 = gtk_table_new (4, 4, FALSE);
-  gtk_widget_show (table2);
-  gtk_box_pack_start (GTK_BOX (vbox1), table2, FALSE, FALSE, 0);
-
-  label1 = gtk_label_new (QT_TR_NOOP(" Width "));
-  gtk_widget_show (label1);
-  gtk_table_attach (GTK_TABLE (table2), label1, 0, 1, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label1), 0, 0.5);
-
-  label2 = gtk_label_new (QT_TR_NOOP(" Height "));
-  gtk_widget_show (label2);
-  gtk_table_attach (GTK_TABLE (table2), label2, 0, 1, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label2), 0, 0.5);
-
-  spinbutton_width_adj = gtk_adjustment_new (2, 0, 3000, 1, 10, 10);
-  spinbutton_width = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton_width_adj), 1, 0);
-  gtk_widget_show (spinbutton_width);
-  gtk_table_attach (GTK_TABLE (table2), spinbutton_width, 1, 2, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton_width), TRUE);
-
-  spinbutton_height_adj = gtk_adjustment_new (1, 0, 3000, 1, 10, 10);
-  spinbutton_height = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton_height_adj), 1, 0);
-  gtk_widget_show (spinbutton_height);
-  gtk_table_attach (GTK_TABLE (table2), spinbutton_height, 1, 2, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton_height), TRUE);
-
-  label5 = gtk_label_new (QT_TR_NOOP("Source :"));
-  gtk_widget_show (label5);
-  gtk_table_attach (GTK_TABLE (table2), label5, 2, 3, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  label6 = gtk_label_new (QT_TR_NOOP("Destination"));
-  gtk_widget_show (label6);
-  gtk_table_attach (GTK_TABLE (table2), label6, 2, 3, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  optionmenu_source = gtk_option_menu_new ();
-  gtk_widget_show (optionmenu_source);
-  gtk_table_attach (GTK_TABLE (table2), optionmenu_source, 3, 4, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  menu1 = gtk_menu_new ();
-
-  item1_1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("1:1"));
-  gtk_widget_show (item1_1);
-  gtk_container_add (GTK_CONTAINER (menu1), item1_1);
-
-  _4_1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("4:3"));
-  gtk_widget_show (_4_1);
-  gtk_container_add (GTK_CONTAINER (menu1), _4_1);
-
-  _16_1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("16:9"));
-  gtk_widget_show (_16_1);
-  gtk_container_add (GTK_CONTAINER (menu1), _16_1);
-
-  gtk_option_menu_set_menu (GTK_OPTION_MENU (optionmenu_source), menu1);
-
-  optionmenu_dest = gtk_option_menu_new ();
-  gtk_widget_show (optionmenu_dest);
-  gtk_table_attach (GTK_TABLE (table2), optionmenu_dest, 3, 4, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  menu2 = gtk_menu_new ();
-
-  menuitem1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("1:1"));
-  gtk_widget_show (menuitem1);
-  gtk_container_add (GTK_CONTAINER (menu2), menuitem1);
-
-  menuitem2 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("4:3"));
-  gtk_widget_show (menuitem2);
-  gtk_container_add (GTK_CONTAINER (menu2), menuitem2);
-
-  menuitem3 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("16:9"));
-  gtk_widget_show (menuitem3);
-  gtk_container_add (GTK_CONTAINER (menu2), menuitem3);
-
-  gtk_option_menu_set_menu (GTK_OPTION_MENU (optionmenu_dest), menu2);
-
-  label3 = gtk_label_new (QT_TR_NOOP(" Error X:"));
-  gtk_widget_show (label3);
-  gtk_table_attach (GTK_TABLE (table2), label3, 0, 1, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label3), 0, 0.5);
-
-  label_errorx = gtk_label_new (QT_TR_NOOP("0"));
-  gtk_widget_show (label_errorx);
-  gtk_table_attach (GTK_TABLE (table2), label_errorx, 1, 2, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label_errorx), 0, 0.5);
-
-  label7 = gtk_label_new (QT_TR_NOOP(" Error Y:"));
-  gtk_widget_show (label7);
-  gtk_table_attach (GTK_TABLE (table2), label7, 0, 1, 3, 4,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label7), 0, 0.5);
-
-  label_errory = gtk_label_new (QT_TR_NOOP("0"));
-  gtk_widget_show (label_errory);
-  gtk_table_attach (GTK_TABLE (table2), label_errory, 1, 2, 3, 4,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label_errory), 0, 0.5);
-
-  checkbutton_16 = gtk_check_button_new_with_mnemonic (QT_TR_NOOP("16 round up"));
-  gtk_widget_show (checkbutton_16);
-  gtk_table_attach (GTK_TABLE (table2), checkbutton_16, 3, 4, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  optionmenu1 = gtk_option_menu_new ();
-  gtk_widget_show (optionmenu1);
-  gtk_table_attach (GTK_TABLE (table2), optionmenu1, 3, 4, 3, 4,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  menu3 = gtk_menu_new ();
-
-  bilinear1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("Bilinear"));
-  gtk_widget_show (bilinear1);
-  gtk_container_add (GTK_CONTAINER (menu3), bilinear1);
-
-  bicubic1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("Bicubic"));
-  gtk_widget_show (bicubic1);
-  gtk_container_add (GTK_CONTAINER (menu3), bicubic1);
-
-  lanczos1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("Lanczos3"));
-  gtk_widget_show (lanczos1);
-  gtk_container_add (GTK_CONTAINER (menu3), lanczos1);
-
-  gtk_option_menu_set_menu (GTK_OPTION_MENU (optionmenu1), menu3);
-
-  alignment1 = gtk_alignment_new (0.5, 0.5, 1, 1);
-  gtk_widget_show (alignment1);
-  gtk_table_attach (GTK_TABLE (table2), alignment1, 2, 3, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (GTK_FILL), 0, 0);
-
-  fixed1 = gtk_fixed_new ();
-  gtk_widget_show (fixed1);
-  gtk_container_add (GTK_CONTAINER (alignment1), fixed1);
-
-  fixed2 = gtk_fixed_new ();
-  gtk_widget_show (fixed2);
-  gtk_table_attach (GTK_TABLE (table2), fixed2, 2, 3, 3, 4,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (GTK_FILL), 0, 0);
-
-  hscale1 = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (100, 0, 100, 1, 1, 0)));
-  gtk_widget_show (hscale1);
-  gtk_box_pack_start (GTK_BOX (vbox1), hscale1, FALSE, FALSE, 0);
-  gtk_scale_set_digits (GTK_SCALE (hscale1), 0);
-
-  dialog_action_area1 = GTK_DIALOG (dialog1)->action_area;
-  gtk_widget_show (dialog_action_area1);
-  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
-
-  cancelbutton1 = gtk_button_new_from_stock ("gtk-cancel");
-  gtk_widget_show (cancelbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
-  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
-
-  applybutton1 = gtk_button_new_from_stock ("gtk-apply");
-  gtk_widget_show (applybutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), applybutton1, GTK_RESPONSE_APPLY);
-  GTK_WIDGET_SET_FLAGS (applybutton1, GTK_CAN_DEFAULT);
-
-  okbutton1 = gtk_button_new_from_stock ("gtk-ok");
-  gtk_widget_show (okbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
-  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
-/*
-  g_signal_connect ((gpointer) _4_1, "activate",
-                    G_CALLBACK (on_4_1_activate),
-                    NULL);
-  g_signal_connect ((gpointer) _16_1, "activate",
-                    G_CALLBACK (on_16_1_activate),
-                    NULL);
-  g_signal_connect ((gpointer) menuitem2, "activate",
-                    G_CALLBACK (on_4_1_activate),
-                    NULL);
-  g_signal_connect ((gpointer) menuitem3, "activate",
-                    G_CALLBACK (on_16_1_activate),
-                    NULL);
-  g_signal_connect ((gpointer) bilinear1, "activate",
-                    G_CALLBACK (on_bilinear1_activate),
-                    NULL);
-  g_signal_connect ((gpointer) bicubic1, "activate",
-                    G_CALLBACK (on_bicubic1_activate),
-                    NULL);
-  g_signal_connect ((gpointer) lanczos1, "activate",
-                    G_CALLBACK (on_lanczos1_activate),
-                    NULL);
-*/
-  /* Store pointers to all widgets, for use by lookup_widget(). */
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, "dialog1");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, "dialog_vbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, vbox1, "vbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, table2, "table2");
-  GLADE_HOOKUP_OBJECT (dialog1, label1, "label1");
-  GLADE_HOOKUP_OBJECT (dialog1, label2, "label2");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbutton_width, "spinbutton_width");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbutton_height, "spinbutton_height");
-  GLADE_HOOKUP_OBJECT (dialog1, label5, "label5");
-  GLADE_HOOKUP_OBJECT (dialog1, label6, "label6");
-  GLADE_HOOKUP_OBJECT (dialog1, optionmenu_source, "optionmenu_source");
-  GLADE_HOOKUP_OBJECT (dialog1, menu1, "menu1");
-  GLADE_HOOKUP_OBJECT (dialog1, item1_1, "item1_1");
-  GLADE_HOOKUP_OBJECT (dialog1, _4_1, "_4_1");
-  GLADE_HOOKUP_OBJECT (dialog1, _16_1, "_16_1");
-  GLADE_HOOKUP_OBJECT (dialog1, optionmenu_dest, "optionmenu_dest");
-  GLADE_HOOKUP_OBJECT (dialog1, menu2, "menu2");
-  GLADE_HOOKUP_OBJECT (dialog1, menuitem1, "menuitem1");
-  GLADE_HOOKUP_OBJECT (dialog1, menuitem2, "menuitem2");
-  GLADE_HOOKUP_OBJECT (dialog1, menuitem3, "menuitem3");
-  GLADE_HOOKUP_OBJECT (dialog1, label3, "label3");
-  GLADE_HOOKUP_OBJECT (dialog1, label_errorx, "label_errorx");
-  GLADE_HOOKUP_OBJECT (dialog1, label7, "label7");
-  GLADE_HOOKUP_OBJECT (dialog1, label_errory, "label_errory");
-  GLADE_HOOKUP_OBJECT (dialog1, checkbutton_16, "checkbutton_16");
-  GLADE_HOOKUP_OBJECT (dialog1, optionmenu1, "optionmenu1");
-  GLADE_HOOKUP_OBJECT (dialog1, menu3, "menu3");
-  GLADE_HOOKUP_OBJECT (dialog1, bilinear1, "bilinear1");
-  GLADE_HOOKUP_OBJECT (dialog1, bicubic1, "bicubic1");
-  GLADE_HOOKUP_OBJECT (dialog1, lanczos1, "lanczos1");
-  GLADE_HOOKUP_OBJECT (dialog1, alignment1, "alignment1");
-  GLADE_HOOKUP_OBJECT (dialog1, fixed1, "fixed1");
-  GLADE_HOOKUP_OBJECT (dialog1, fixed2, "fixed2");
-  GLADE_HOOKUP_OBJECT (dialog1, hscale1, "hscale1");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, "dialog_action_area1");
-  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, "cancelbutton1");
-  GLADE_HOOKUP_OBJECT (dialog1, applybutton1, "applybutton1");
-  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, "okbutton1");
-
-  return dialog1;
-}
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/Q_resize.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/Q_resize.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/Q_resize.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,278 +0,0 @@
-/***************************************************************************
-    copyright            : (C) 2001 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include <math.h>
-
-#include "Q_resize.h"
-#include "DIA_coreToolkit.h"
-
-static double aspectRatio[2][3]={
-                              {1.,0.888888,1.19}, // NTSC 1:1 4:3 16:9
-                              {1.,1.066667,1.43} // PAL  1:1 4:3 16:9
-                            };
-#define aprintf
-
-resizeWindow::resizeWindow(resParam *param) : QDialog()
- {
-     ui.setupUi(this);
-	 lastPercentage = 100;
-     _param=param;
-     ui.spinBoxWidth->setValue(_param->width);
-     ui.spinBoxHeight->setValue(_param->height);
-     ui.horizontalSlider->setValue(100);
-     updateWidthHeightSpinners();
-
-	 connect(ui.comboBoxSource, SIGNAL(currentIndexChanged(int)), this, SLOT(aspectRatioChanged(int)));
-	 connect(ui.comboBoxDestination, SIGNAL(currentIndexChanged(int)), this, SLOT(aspectRatioChanged(int)));
-	 connect(ui.checkBoxRoundup, SIGNAL(toggled(bool)), this, SLOT(roundupToggled(bool)));
-	 connect(ui.lockArCheckBox, SIGNAL(toggled(bool)), this, SLOT(lockArToggled(bool)));
-	 connect(ui.buttonBox, SIGNAL(accepted()), this, SLOT(okButtonClicked()));
-
-	 connectDimensionControls();
- }
-
- void resizeWindow::gather(void)
- {
-    _param->width=ui.spinBoxWidth->value();
-    _param->height=ui.spinBoxHeight->value();
-    _param->algo=ui.comboBoxAlgo->currentIndex();
- }
- 
- void resizeWindow::sliderChanged(int value)
-{
-	disconnectDimensionControls();
-
-	percentageSpinBoxChanged(value);
-
-	connectDimensionControls();
-}
-
-void resizeWindow::percentageSpinBoxChanged(int value)
-{
-	disconnectDimensionControls();
-
-	if (ui.checkBoxRoundup->isChecked())
-	{
-		if (lastPercentage > value)
-			ui.spinBoxWidth->setValue(ui.spinBoxWidth->value() - 16);
-		else
-			ui.spinBoxWidth->setValue(ui.spinBoxWidth->value() + 16);
-	}
-	else
-	{
-		float width = _param->originalWidth;
-
-		width /= 100.;
-		width *= value;
-
-		ui.spinBoxWidth->setValue(floor(width + 0.5));
-	}
-
-	updateWidthHeightSpinners(false);
-
-	lastPercentage = ui.percentageSpinBox->value();
-
-	connectDimensionControls();
-}
-
-void resizeWindow::widthSpinBoxChanged(int value)
-{
-	disconnectDimensionControls();
-
-	if (ui.lockArCheckBox->isChecked())
-		updateWidthHeightSpinners(false);
-
-	connectDimensionControls();
-}
-
-void resizeWindow::heightSpinBoxChanged(int value)
-{
-	disconnectDimensionControls();
-
-	if (ui.lockArCheckBox->isChecked())
-		updateWidthHeightSpinners(true);
-
-	connectDimensionControls();
-}
-
-void resizeWindow::aspectRatioChanged(int index)
-{
-	disconnectDimensionControls();
-
-	if (ui.lockArCheckBox->isChecked())
-		updateWidthHeightSpinners();
-
-	connectDimensionControls();
-}
-
-void resizeWindow::disconnectDimensionControls()
-{
-	disconnect(ui.spinBoxHeight, SIGNAL(valueChanged(int)), this, SLOT(heightSpinBoxChanged(int)));
-	disconnect(ui.spinBoxWidth, SIGNAL(valueChanged(int)), this, SLOT(widthSpinBoxChanged(int)));
-	disconnect(ui.horizontalSlider, SIGNAL(valueChanged(int)), this, SLOT(sliderChanged(int)));
-	disconnect(ui.percentageSpinBox, SIGNAL(valueChanged(int)), this, SLOT(percentageSpinBoxChanged(int)));
-}
-
-void resizeWindow::connectDimensionControls()
-{
-	connect(ui.spinBoxHeight, SIGNAL(valueChanged(int)), this, SLOT(heightSpinBoxChanged(int)));
-	connect(ui.spinBoxWidth, SIGNAL(valueChanged(int)), this, SLOT(widthSpinBoxChanged(int)));
-	connect(ui.horizontalSlider, SIGNAL(valueChanged(int)), this, SLOT(sliderChanged(int)));
-	connect(ui.percentageSpinBox, SIGNAL(valueChanged(int)), this, SLOT(percentageSpinBoxChanged(int)));
-}
-
-void resizeWindow::updateWidthHeightSpinners(bool useHeightAsRef)
-{
-	int sar = ui.comboBoxSource->currentIndex();
-	int dar = ui.comboBoxDestination->currentIndex();
-	float x = ui.spinBoxWidth->value();
-	float y = ui.spinBoxHeight->value();
-	float sr_mul = 1.;
-	float dst_mul = 1.;
-	float ar = 1.;
-
-	if (sar)
-	{  // source is 4/3 or 16/9
-		sr_mul = aspectRatio[_param->pal][sar];
-	}
-
-	if (dar)
-	{  // dst is 4/3 or 16/9
-		dst_mul = 1 / aspectRatio[_param->pal][dar];
-	}
-
-	aprintf("source mul %02.2f , dst mul: %02.2f\n", sr_mul, dst_mul);
-
-	ar = _param->originalWidth / (_param->originalHeight / (sr_mul * dst_mul));
-
-	if (useHeightAsRef)
-		x = y * ar;
-	else
-		y = x / ar;
-
-	aprintf("x, y: %03f, %03f\n", x, y);
-
-	int xx = floor(x + 0.5);
-	int yy = floor(y + 0.5);
-
-	if (xx & 1)
-		xx--;
-
-	if (yy & 1)
-		yy--;
-
-	roundUp(xx, yy);
-	updateSlider();
-}
-
-void resizeWindow::updateSlider()
-{
-	float percent = (((float)ui.spinBoxWidth->value() / (float)_param->originalWidth) * 100.) + 0.5;
-
-	ui.horizontalSlider->setValue(percent);
-	ui.percentageSpinBox->setValue(percent);
-}
-
-void resizeWindow::roundUp(int xx, int yy)
-{
-	float erx = 0.;
-	float ery = 0.;
-
-	if (ui.checkBoxRoundup->checkState())
-	{
-		int ox = xx, oy = yy;
-
-		xx = (xx + 7) & 0xfffff0;
-		yy = (yy + 7) & 0xfffff0;
-
-		erx = xx - ox;
-		erx = erx / xx;
-		ery = yy - oy;
-		ery = ery / yy;
-
-		aprintf("x: %d -> %d : err %f\n", ox, xx, erx);
-		aprintf("y: %d -> %d : err %f\n", oy, yy, ery);
-	}
-
-	ui.spinBoxWidth->setValue(xx);
-	ui.spinBoxHeight->setValue(yy);
-
-	ui.labelErrorXY->setText(QString("%1").arg(erx * 100., 0, 'f', 2) + " / " + QString("%1").arg(ery * 100., 0, 'f', 2));
-}
-
-void resizeWindow::lockArToggled(bool toggled)
-{
-	if (ui.lockArCheckBox->isChecked())
-		widthSpinBoxChanged(0);
-	else
-		ui.checkBoxRoundup->setChecked(false);
-}
-
-void resizeWindow::roundupToggled(bool toggled)
-{
-	if (toggled)
-	{
-		disconnectDimensionControls();
-
-		ui.spinBoxWidth->setSingleStep(16);
-		ui.spinBoxHeight->setSingleStep(16);
-		widthSpinBoxChanged(0);
-
-		connectDimensionControls();
-	}
-	else
-	{
-		ui.spinBoxWidth->setSingleStep(2);
-		ui.spinBoxHeight->setSingleStep(2);
-	}
-}
-
-void resizeWindow::okButtonClicked()
-{
-	if (ui.spinBoxWidth->value() & 1 || ui.spinBoxHeight->value() & 1)
-		GUI_Error_HIG(QT_TR_NOOP("Width and height cannot be odd"), NULL);
-	else
-		accept();
-}
-
-/**
-    \fn DIA_resize
-    \brief Handle resize dialo
-*/
-uint8_t DIA_resize(uint32_t *width,uint32_t *height,uint32_t *alg,uint32_t originalw, uint32_t originalh,uint32_t fps1000)
-{
-uint8_t r=0;
-      resParam param={*width,*height,originalw,originalh,fps1000,*alg,0};
-      //
-      if(fps1000>24600 && fps1000<25400)
-        {
-                param.pal=1;
-        }
-       
-
-     // Fetch info
-     resizeWindow resizewindow(&param) ;
-     ;
-     if(resizewindow.exec()==QDialog::Accepted)
-     {
-       resizewindow.gather();
-       *width=param.width;
-       *height=param.height;
-       *alg=param.algo;
-       r=1;
-     }
-     return r;
-}  
-//********************************************
-//EOF

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/Q_resize.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/Q_resize.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/Q_resize.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,45 +0,0 @@
-#ifndef Q_resizing_h
-#define Q_resizing_h
-
-#include "ui_resizing.h"
-
-typedef struct resParam
-{
-	uint32_t width,height;
-	uint32_t originalWidth, originalHeight;
-	uint32_t fps1000;
-	uint32_t algo;
-	uint32_t pal;
-} resParam;
-
-class resizeWindow : public QDialog
-{
-	Q_OBJECT
-
-private:
-	int lastPercentage;
-	void updateWidthHeightSpinners(bool useHeightAsRef = false);
-	void updateSlider();
-	void connectDimensionControls();
-	void disconnectDimensionControls();
-	void roundUp(int xx, int yy);
-
-protected:
-	resParam *_param;
-
-public:
-	resizeWindow(resParam *param);
-	Ui_resizeDialog ui;
-
-public slots:
-	void gather(void);
-	void okButtonClicked();
-	void sliderChanged(int value);
-	void percentageSpinBoxChanged(int value);
-	void widthSpinBoxChanged(int value);
-	void heightSpinBoxChanged(int value);
-	void lockArToggled(bool toggled);
-	void roundupToggled(bool toggled);
-	void aspectRatioChanged(int index);
-};
-#endif	// Q_resizing_h

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/Q_resize.h.orig
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/Q_resize.h.orig	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/Q_resize.h.orig	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,30 +0,0 @@
-#ifndef Q_resizing_h
-#define Q_resizing_h
-
-#include "ui_resizing.h"
-
-typedef struct resParam
-{
-	uint32_t width,height;
-	uint32_t originalWidth, originalHeight;
-	uint32_t fps1000;
-	uint32_t algo;
-	uint32_t pal;
-} resParam;
-
-class resizeWindow : public QDialog
-{
-	Q_OBJECT
-
-protected: 
-	resParam *_param;
-
-public:
-	resizeWindow(resParam *param);
-	Ui_resizeDialog ui;
-
-public slots:
-	void gather(void);
-	void update(int i);
-};
-#endif	// Q_resizing_h

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/resizing.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/resizing.ui	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/AvisynthResize/qt4/resizing.ui	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,724 +0,0 @@
-<ui version="4.0" >
- <class>resizeDialog</class>
- <widget class="QDialog" name="resizeDialog" >
-  <property name="geometry" >
-   <rect>
-    <x>0</x>
-    <y>0</y>
-    <width>350</width>
-    <height>342</height>
-   </rect>
-  </property>
-  <property name="windowTitle" >
-   <string>Resize</string>
-  </property>
-  <layout class="QVBoxLayout" >
-   <property name="margin" >
-    <number>9</number>
-   </property>
-   <property name="spacing" >
-    <number>6</number>
-   </property>
-   <item>
-    <widget class="QGroupBox" name="groupBox_2" >
-     <property name="title" >
-      <string>Aspect Ratio</string>
-     </property>
-     <layout class="QVBoxLayout" >
-      <property name="margin" >
-       <number>9</number>
-      </property>
-      <property name="spacing" >
-       <number>6</number>
-      </property>
-      <item>
-       <widget class="QCheckBox" name="lockArCheckBox" >
-        <property name="text" >
-         <string>Lock Aspect Ratio</string>
-        </property>
-        <property name="checked" >
-         <bool>true</bool>
-        </property>
-       </widget>
-      </item>
-      <item>
-       <layout class="QHBoxLayout" >
-        <property name="margin" >
-         <number>0</number>
-        </property>
-        <property name="spacing" >
-         <number>6</number>
-        </property>
-        <item>
-         <widget class="QLabel" name="label_4" >
-          <property name="text" >
-           <string>Source:</string>
-          </property>
-         </widget>
-        </item>
-        <item>
-         <widget class="QComboBox" name="comboBoxSource" >
-          <item>
-           <property name="text" >
-            <string>1:1</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>4:3</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>16:9</string>
-           </property>
-          </item>
-         </widget>
-        </item>
-        <item>
-         <spacer>
-          <property name="orientation" >
-           <enum>Qt::Horizontal</enum>
-          </property>
-          <property name="sizeType" >
-           <enum>QSizePolicy::Fixed</enum>
-          </property>
-          <property name="sizeHint" >
-           <size>
-            <width>30</width>
-            <height>20</height>
-           </size>
-          </property>
-         </spacer>
-        </item>
-        <item>
-         <widget class="QLabel" name="label_3" >
-          <property name="text" >
-           <string>Destination:</string>
-          </property>
-         </widget>
-        </item>
-        <item>
-         <widget class="QComboBox" name="comboBoxDestination" >
-          <item>
-           <property name="text" >
-            <string>1:1</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>4:3</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>16:9</string>
-           </property>
-          </item>
-         </widget>
-        </item>
-        <item>
-         <spacer>
-          <property name="orientation" >
-           <enum>Qt::Horizontal</enum>
-          </property>
-          <property name="sizeHint" >
-           <size>
-            <width>40</width>
-            <height>20</height>
-           </size>
-          </property>
-         </spacer>
-        </item>
-       </layout>
-      </item>
-     </layout>
-    </widget>
-   </item>
-   <item>
-    <widget class="QGroupBox" name="groupBox" >
-     <property name="title" >
-      <string>Resize Dimensions</string>
-     </property>
-     <layout class="QVBoxLayout" >
-      <property name="margin" >
-       <number>9</number>
-      </property>
-      <property name="spacing" >
-       <number>6</number>
-      </property>
-      <item>
-       <layout class="QHBoxLayout" >
-        <property name="margin" >
-         <number>0</number>
-        </property>
-        <property name="spacing" >
-         <number>6</number>
-        </property>
-        <item>
-         <widget class="QLabel" name="label" >
-          <property name="text" >
-           <string>Width:</string>
-          </property>
-         </widget>
-        </item>
-        <item>
-         <widget class="QSpinBox" name="spinBoxWidth" >
-          <property name="maximum" >
-           <number>2900</number>
-          </property>
-          <property name="minimum" >
-           <number>16</number>
-          </property>
-          <property name="singleStep" >
-           <number>2</number>
-          </property>
-         </widget>
-        </item>
-        <item>
-         <spacer>
-          <property name="orientation" >
-           <enum>Qt::Horizontal</enum>
-          </property>
-          <property name="sizeType" >
-           <enum>QSizePolicy::Fixed</enum>
-          </property>
-          <property name="sizeHint" >
-           <size>
-            <width>30</width>
-            <height>20</height>
-           </size>
-          </property>
-         </spacer>
-        </item>
-        <item>
-         <widget class="QLabel" name="label_2" >
-          <property name="text" >
-           <string>Height:</string>
-          </property>
-         </widget>
-        </item>
-        <item>
-         <widget class="QSpinBox" name="spinBoxHeight" >
-          <property name="maximum" >
-           <number>2000</number>
-          </property>
-          <property name="minimum" >
-           <number>16</number>
-          </property>
-          <property name="singleStep" >
-           <number>2</number>
-          </property>
-         </widget>
-        </item>
-        <item>
-         <spacer>
-          <property name="orientation" >
-           <enum>Qt::Horizontal</enum>
-          </property>
-          <property name="sizeHint" >
-           <size>
-            <width>40</width>
-            <height>20</height>
-           </size>
-          </property>
-         </spacer>
-        </item>
-       </layout>
-      </item>
-      <item>
-       <widget class="QCheckBox" name="checkBoxRoundup" >
-        <property name="text" >
-         <string>Round to the Nearest Multiple of 16</string>
-        </property>
-       </widget>
-      </item>
-      <item>
-       <spacer>
-        <property name="orientation" >
-         <enum>Qt::Vertical</enum>
-        </property>
-        <property name="sizeType" >
-         <enum>QSizePolicy::Fixed</enum>
-        </property>
-        <property name="sizeHint" >
-         <size>
-          <width>312</width>
-          <height>4</height>
-         </size>
-        </property>
-       </spacer>
-      </item>
-      <item>
-       <layout class="QVBoxLayout" >
-        <property name="margin" >
-         <number>0</number>
-        </property>
-        <property name="spacing" >
-         <number>6</number>
-        </property>
-        <item>
-         <layout class="QHBoxLayout" >
-          <property name="margin" >
-           <number>0</number>
-          </property>
-          <property name="spacing" >
-           <number>12</number>
-          </property>
-          <item>
-           <layout class="QVBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
-             <number>6</number>
-            </property>
-            <item>
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
-               <number>6</number>
-              </property>
-              <item>
-               <widget class="QLabel" name="label_8" >
-                <property name="text" >
-                 <string>1%</string>
-                </property>
-               </widget>
-              </item>
-              <item>
-               <spacer>
-                <property name="orientation" >
-                 <enum>Qt::Horizontal</enum>
-                </property>
-                <property name="sizeHint" >
-                 <size>
-                  <width>40</width>
-                  <height>20</height>
-                 </size>
-                </property>
-               </spacer>
-              </item>
-              <item>
-               <widget class="QLabel" name="label_5" >
-                <property name="text" >
-                 <string>Percent</string>
-                </property>
-               </widget>
-              </item>
-              <item>
-               <spacer>
-                <property name="orientation" >
-                 <enum>Qt::Horizontal</enum>
-                </property>
-                <property name="sizeHint" >
-                 <size>
-                  <width>40</width>
-                  <height>20</height>
-                 </size>
-                </property>
-               </spacer>
-              </item>
-              <item>
-               <widget class="QLabel" name="label_9" >
-                <property name="text" >
-                 <string>200%</string>
-                </property>
-               </widget>
-              </item>
-             </layout>
-            </item>
-            <item>
-             <widget class="QSlider" name="horizontalSlider" >
-              <property name="minimum" >
-               <number>1</number>
-              </property>
-              <property name="maximum" >
-               <number>200</number>
-              </property>
-              <property name="value" >
-               <number>100</number>
-              </property>
-              <property name="orientation" >
-               <enum>Qt::Horizontal</enum>
-              </property>
-             </widget>
-            </item>
-           </layout>
-          </item>
-          <item>
-           <widget class="QSpinBox" name="percentageSpinBox" >
-            <property name="maximum" >
-             <number>200</number>
-            </property>
-            <property name="minimum" >
-             <number>1</number>
-            </property>
-            <property name="value" >
-             <number>100</number>
-            </property>
-           </widget>
-          </item>
-         </layout>
-        </item>
-        <item>
-         <layout class="QHBoxLayout" >
-          <property name="margin" >
-           <number>0</number>
-          </property>
-          <property name="spacing" >
-           <number>6</number>
-          </property>
-          <item>
-           <widget class="QLabel" name="label_10" >
-            <property name="text" >
-             <string>Error X / Y:</string>
-            </property>
-           </widget>
-          </item>
-          <item>
-           <widget class="QLabel" name="labelErrorXY" >
-            <property name="text" >
-             <string>0.00 / 0.00</string>
-            </property>
-           </widget>
-          </item>
-          <item>
-           <spacer>
-            <property name="orientation" >
-             <enum>Qt::Horizontal</enum>
-            </property>
-            <property name="sizeHint" >
-             <size>
-              <width>40</width>
-              <height>20</height>
-             </size>
-            </property>
-           </spacer>
-          </item>
-         </layout>
-        </item>
-       </layout>
-      </item>
-     </layout>
-    </widget>
-   </item>
-   <item>
-    <spacer>
-     <property name="orientation" >
-      <enum>Qt::Vertical</enum>
-     </property>
-     <property name="sizeType" >
-      <enum>QSizePolicy::Fixed</enum>
-     </property>
-     <property name="sizeHint" >
-      <size>
-       <width>332</width>
-       <height>6</height>
-      </size>
-     </property>
-    </spacer>
-   </item>
-   <item>
-    <layout class="QHBoxLayout" >
-     <property name="margin" >
-      <number>0</number>
-     </property>
-     <property name="spacing" >
-      <number>6</number>
-     </property>
-     <item>
-      <widget class="QLabel" name="label_6" >
-       <property name="text" >
-        <string>Resize Method:</string>
-       </property>
-      </widget>
-     </item>
-     <item>
-      <widget class="QComboBox" name="comboBoxAlgo" >
-       <item>
-        <property name="text" >
-         <string>Bilinear</string>
-        </property>
-       </item>
-       <item>
-        <property name="text" >
-         <string>Bicubic</string>
-        </property>
-       </item>
-       <item>
-        <property name="text" >
-         <string>Lanzcos3</string>
-        </property>
-       </item>
-      </widget>
-     </item>
-     <item>
-      <spacer>
-       <property name="orientation" >
-        <enum>Qt::Horizontal</enum>
-       </property>
-       <property name="sizeHint" >
-        <size>
-         <width>40</width>
-         <height>20</height>
-        </size>
-       </property>
-      </spacer>
-     </item>
-    </layout>
-   </item>
-   <item>
-    <spacer>
-     <property name="orientation" >
-      <enum>Qt::Vertical</enum>
-     </property>
-     <property name="sizeType" >
-      <enum>QSizePolicy::MinimumExpanding</enum>
-     </property>
-     <property name="sizeHint" >
-      <size>
-       <width>20</width>
-       <height>16</height>
-      </size>
-     </property>
-    </spacer>
-   </item>
-   <item>
-    <widget class="QDialogButtonBox" name="buttonBox" >
-     <property name="orientation" >
-      <enum>Qt::Horizontal</enum>
-     </property>
-     <property name="standardButtons" >
-      <set>QDialogButtonBox::Cancel|QDialogButtonBox::NoButton|QDialogButtonBox::Ok</set>
-     </property>
-    </widget>
-   </item>
-  </layout>
- </widget>
- <tabstops>
-  <tabstop>lockArCheckBox</tabstop>
-  <tabstop>comboBoxSource</tabstop>
-  <tabstop>comboBoxDestination</tabstop>
-  <tabstop>spinBoxWidth</tabstop>
-  <tabstop>spinBoxHeight</tabstop>
-  <tabstop>checkBoxRoundup</tabstop>
-  <tabstop>horizontalSlider</tabstop>
-  <tabstop>percentageSpinBox</tabstop>
-  <tabstop>comboBoxAlgo</tabstop>
-  <tabstop>buttonBox</tabstop>
- </tabstops>
- <resources/>
- <connections>
-  <connection>
-   <sender>buttonBox</sender>
-   <signal>rejected()</signal>
-   <receiver>resizeDialog</receiver>
-   <slot>reject()</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>316</x>
-     <y>260</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>286</x>
-     <y>274</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>label_8</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>184</x>
-     <y>117</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>39</x>
-     <y>148</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>label_5</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>184</x>
-     <y>117</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>150</x>
-     <y>148</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>label_9</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>184</x>
-     <y>117</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>267</x>
-     <y>148</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>horizontalSlider</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>184</x>
-     <y>117</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>156</x>
-     <y>164</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>percentageSpinBox</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>184</x>
-     <y>117</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>317</x>
-     <y>155</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>checkBoxRoundup</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>184</x>
-     <y>95</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>184</x>
-     <y>117</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>label_10</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>182</x>
-     <y>155</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>55</x>
-     <y>251</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>labelErrorXY</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>182</x>
-     <y>155</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>114</x>
-     <y>251</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>label_4</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>182</x>
-     <y>69</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>46</x>
-     <y>95</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>comboBoxSource</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>182</x>
-     <y>69</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>94</x>
-     <y>95</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>label_3</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>182</x>
-     <y>69</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>188</x>
-     <y>95</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>comboBoxDestination</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>182</x>
-     <y>69</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>247</x>
-     <y>95</y>
-    </hint>
-   </hints>
-  </connection>
- </connections>
-</ui>

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/BlackenBorders/ADM_vidBlackenBorders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/BlackenBorders/ADM_vidBlackenBorders.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/BlackenBorders/ADM_vidBlackenBorders.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,242 +0,0 @@
-/***************************************************************************
-                          ADM_vidBSMear.cpp  -  description
-                             -------------------
-         change part of video into black borders
-
-          Each one ,must be even
-
-          Copy / Paste from crop,almost the same thing
-
-
-    begin                : Sun Mar 24 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-
-#include "ADM_default.h"
-#include "DIA_coreToolkit.h"
-#include "ADM_videoFilterDynamic.h"
-
-#include "DIA_factory.h"
-typedef struct
-{
-        uint32_t left,right;
-        uint32_t top,bottom;
-}BLACKEN_PARAMS;
-class  AVDMVideoStreamBSMear:public AVDMGenericVideoStream
- {
-
- protected:
-                BLACKEN_PARAMS          *_param;
-
- public:
-
-                                AVDMVideoStreamBSMear(  AVDMGenericVideoStream *in,CONFcouple *setup);
-                virtual         ~AVDMVideoStreamBSMear();
-                virtual uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-                                                                        ADMImage *data,uint32_t *flags);
-                virtual         char            *printConf(void) ;
-                                uint8_t         configure( AVDMGenericVideoStream *instream);
-                                uint8_t getCoupledConf( CONFcouple **couples);
- }     ;
-
-static FILTER_PARAM cropParam={4,{"left","right","top","bottom"}};
-
-//********************************************
-VF_DEFINE_FILTER(AVDMVideoStreamBSMear,cropParam,
-    blacken,
-                QT_TR_NOOP("Blacken borders"),
-                1,
-                VF_TRANSFORM,
-                QT_TR_NOOP("Fill borders with pure black. Doesn't alter size."));
-//********************************************
-char *AVDMVideoStreamBSMear::printConf( void )
-{
- 	ADM_FILTER_DECLARE_CONF(" Black l:%lu  r:%lu  u:%lu x d:%lu",
- 				_param->left,
- 					_param->right,
- 					_param->top,
- 					_param->bottom);
-        
-}
-
-//_______________________________________________________________
-
-AVDMVideoStreamBSMear::AVDMVideoStreamBSMear(  	AVDMGenericVideoStream *in,CONFcouple *couples)
-{
-
-
-  	_in=in;		
-   	memcpy(&_info,_in->getInfo(),sizeof(_info));  		
-
-		if(couples)
-		{
-			_param=NEW(BLACKEN_PARAMS);
-			GET(left);
-			GET(right);
-			GET(top);
-			GET(bottom);
-		}	
-			else 	
-		{	// default parameter	
-				_param=NEW(BLACKEN_PARAMS);
-				_param->left=_param->top=
-						_param->right=_param->bottom=0;
-		}										
- 	
-  _info.encoding=1;
-
-  	  	
-}
-
-uint8_t	AVDMVideoStreamBSMear::getCoupledConf( CONFcouple **couples)
-{
-
-			ADM_assert(_param);
-			*couples=new CONFcouple(4);
-
-#define CSET(x)  (*couples)->setCouple((char *)#x,(_param->x))
-	CSET(left);
-	CSET(right);
-	CSET(top);
-	CSET(bottom);
-			return 1;
-
-}
-AVDMVideoStreamBSMear::~AVDMVideoStreamBSMear()
-{
- 	DELETE(_param);
- 	
-}
-
-//
-//	Blacken borders, just setting luma to null should be enough
-//
-
-uint8_t AVDMVideoStreamBSMear::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-
-			if(frame>=_info.nb_frames) 
-			{
-				printf("Filter : out of bound!\n");
-				return 0;
-			}
-	
-			ADM_assert(_param);									
-								
-			// read uncompressed frame directly into follower
-			// and blacken there
-			
-       		if(!_in->getFrameNumberNoAlloc(frame, len,data,flags)) return 0;
-       		  *len= _info.width*_info.height+(_info.width*_info.height>>1);       			
-       		  // blacken top
-       		  uint8_t *srcY=YPLANE(data);
-		  uint8_t *srcU=UPLANE(data);
-		  uint8_t *srcV=VPLANE(data);
-       		  uint32_t bytes=_info.width*_param->top;
-		  uint32_t page=_info.width*_info.height;
-       		
-       		  memset(srcY,0x10,bytes);
-		  memset(srcU,0x80,bytes>>2);
-		  memset(srcV,0x80,bytes>>2);
-       		  // left & right
-       		  uint32_t stride=_info.width;
-		  
-       		  for(uint32_t y=_info.height;y>0;y--)
-       		  {
-       		        memset(srcY,0x10,_param->left);
-       		        memset(srcY+stride-_param->right,0,_param->right);       		
-       		        srcY+=stride;       		
-		 }
-		 for(uint32_t y=_info.height>>1;y>0;y--)
-       		  {
-       		        
-			memset(srcU,0x80,_param->left>>1);
-			memset(srcV,0x80,_param->left>>1);
-			memset(srcU+((stride-_param->right)>>1),0x80,_param->right>>1);
-			memset(srcV+((stride-_param->right)>>1),0x80,_param->right>>1);
-			srcU+=stride>>1;
-			srcV+=stride>>1;
-       		  }
-       		
-       		  // backen bottom
-       		  srcY=YPLANE(data)+_info.width*_info.height-1;
-       		
-       		 bytes=_info.width*_param->bottom;
-       	 	 srcY-=bytes;
-       		 memset(srcY,0x10,bytes);
-		// chroma
-		 srcU=UPLANE(data)+(page>>2)-1;
-		 srcU-=bytes>>2;
-       		 memset(srcU,0x80,bytes>>2);
-		 
-		 srcV=VPLANE(data)+(page>>2)-1;
-		 srcV-=bytes>>2;
-       		 memset(srcV,0x80,bytes>>2);
-		 
-		  
-       		  	
-       		         		       		
-      return 1;
-}
-uint8_t AVDMVideoStreamBSMear::configure(AVDMGenericVideoStream *in)
-{
-	_in=in;
-	ADM_assert(_param);
-        uint32_t width,height;
-#define MAKEME(x) uint32_t x=_param->x;
-        while(1)
-        {
-          MAKEME(left);
-          MAKEME(right);
-          MAKEME(top);
-          MAKEME(bottom);
-          
-          width=_in->getInfo()->width;
-          height=_in->getInfo()->height;
-          
-          diaElemUInteger dleft(&left, QT_TR_NOOP("_Left border:"), 0,width);
-          diaElemUInteger dright(&right, QT_TR_NOOP("_Right border:"), 0,width);
-          diaElemUInteger dtop(&(top), QT_TR_NOOP("_Top border:"), 0,height);
-          diaElemUInteger dbottom(&(bottom), QT_TR_NOOP("_Bottom border:"), 0,height);
-            
-          diaElem *elems[4]={&dleft,&dright,&dtop,&dbottom};
-          if(diaFactoryRun(QT_TR_NOOP("Blacken Borders"),4,elems))
-          {
-            if((left&1) || (right&1)|| (top&1) || (bottom&1) ||
-                     (top+bottom>=height)|| (left+right>width))
-            {
-              GUI_Error_HIG(QT_TR_NOOP("Incorrect parameters"), QT_TR_NOOP("All parameters must be even and within range."));
-              continue;
-            }
-            else
-            {
-  #undef MAKEME
-  #define MAKEME(x) _param->x=x;
-                MAKEME(left);
-                MAKEME(right);
-                MAKEME(top);
-                MAKEME(bottom);
-                _info.width=width+left+right;
-                _info.height=height+top+bottom;
-                return 1;
-            }
-          }
-          return 0;
-      }
-}
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/BlackenBorders/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/BlackenBorders/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/BlackenBorders/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,9 +0,0 @@
-INCLUDE(vf_plugin)
-
-
-SET(ADM_vf_blackenBorders_SRCS ADM_vidBlackenBorders.cpp)
-
-ADD_LIBRARY(ADM_vf_blackenBorders SHARED ${ADM_vf_blackenBorders_SRCS})
-
-INIT_VIDEOFILTER_PLUGIN(ADM_vf_blackenBorders)
-INSTALL_VIDEOFILTER(ADM_vf_blackenBorders)

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/ADM_vidCrop.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/ADM_vidCrop.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/ADM_vidCrop.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,215 +0,0 @@
-/***************************************************************************
-                          ADM_vidCrop.cpp  -  description
-                             -------------------
-          Crop top/left/right/bottom
-
-          Each one ,must be even
-
-
-    begin                : Sun Mar 24 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-#include "DIA_factory.h"
-
-
-#include "ADM_vidCrop_param.h"
-class  AVDMVideoStreamCrop:public AVDMGenericVideoStream
- {
-
- protected:
-                CROP_PARAMS          *_param;
-
- public:
-
-                                AVDMVideoStreamCrop(  AVDMGenericVideoStream *in,CONFcouple *couples);
-        virtual                 ~AVDMVideoStreamCrop();
-        virtual uint8_t         getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-                                                                ADMImage *data,uint32_t *flags);
-        virtual char    *printConf(void) ;
-                  uint8_t       configure( AVDMGenericVideoStream *instream);
-          virtual uint8_t       getCoupledConf( CONFcouple **couples);
-
-
- }     ;
- 
-static FILTER_PARAM cropParam={4,{"left","right","top","bottom"}};
-
-
-VF_DEFINE_FILTER_UI(AVDMVideoStreamCrop,cropParam,
-    crop,
-                                QT_TR_NOOP("Crop"),
-                                1,
-                                VF_TRANSFORM,
-                                QT_TR_NOOP("Remove lines from top/bottom/left/right."));
-
-
-char *AVDMVideoStreamCrop::printConf( void )
-{
- 	ADM_FILTER_DECLARE_CONF(" Crop %lu x %lu --> %lu x %lu",
- 				_in->getInfo()->width,
- 				_in->getInfo()->height,
- 				_info.width,
- 				_info.height);
- 
-}
-
-//_______________________________________________________________
-
-AVDMVideoStreamCrop::AVDMVideoStreamCrop(
-									AVDMGenericVideoStream *in,CONFcouple *couples)
-{
-
-
-  	_in=in;		
-   	memcpy(&_info,_in->getInfo(),sizeof(_info));
-	
-		if(couples)
-		{
-			_param=	NEW(CROP_PARAMS);
-			GET(left);
-			GET(right);
-			GET(top);
-			GET(bottom);
-				// Consistency check
-				if(  _in->getInfo()->width<(_param->right+_param->left))
-						{
-                      		printf("\n Warning Cropping too much width ! Width reseted !\n");
-								_param->right=_param->left=0;
-						}
-				if(  _in->getInfo()->height<(_param->bottom+_param->top))
-						{
-                      		printf("\n Warning Cropping too much height ! Height reseted !\n");
-								_param->bottom=_param->top=0;
-						}
-
-			_info.width=_in->getInfo()->width-_param->right-_param->left;		
-			_info.height=_in->getInfo()->height-_param->bottom-_param->top;	
-			
-		}	
-			else 			
-		{	// default parameter	
-				_param=	NEW(CROP_PARAMS); ;
-				_param->left=_param->top=
-				_param->right=_param->bottom=0;
-		}				
-					
- 	//_uncompressed=(uint8_t *)malloc(3*_in->getInfo()->width*_in->getInfo()->height);
- 	//_uncompressed=new uint8_t [3*_in->getInfo()->width*_in->getInfo()->height];
-	_uncompressed=new ADMImage(_in->getInfo()->width,_in->getInfo()->height);
-  	ADM_assert(_uncompressed);
-  	_info.encoding=1;
-	  
-
-  	  	
-}
-AVDMVideoStreamCrop::~AVDMVideoStreamCrop()
-{
- 	delete _uncompressed;
- 	DELETE(_param);
-}
-
-//
-//	Basically ask a uncompressed frame from editor and ask
-//		GUI to decompress it .
-//
-
-uint8_t AVDMVideoStreamCrop::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-
-			ADM_assert(frame<_info.nb_frames);
-			ADM_assert(_param);									
-		if(frame>= _info.nb_frames) return 0;
-			// read uncompressed frame
-       		if(!_in->getFrameNumberNoAlloc(frame, len,_uncompressed,flags)) return 0;
-       		
-       		// Crop Y luma
-       		uint32_t y,x,line;
-       		uint8_t *src,*src2,*dest;
-       		
-       		y=_in->getInfo()->height;
-       		x=_in->getInfo()->width;
-       		line=_info.width;
-       		src=YPLANE(_uncompressed)+_param->top*x+_param->left;
-       		dest=YPLANE(data);
-       		
-       		for(uint32_t k=_info.height;k>0;k--)
-       			{
-       			 	    memcpy(dest,src,line);
-       			 	    src+=x;
-       			 	    dest+=line;
-       			}
-       		 // Crop U  & V
-       		 	src=UPLANE(_uncompressed)+(x*_param->top>>2)+(_param->left>>1);
-       		 	src2=VPLANE(_uncompressed)+(x*_param->top>>2)+(_param->left>>1);
-			dest=UPLANE(data);
-       		 	line>>=1;
-       		 	x>>=1;       		       		 	
-       		 		for(uint32_t k=((_info.height)>>1);k>0;k--)
-       		 		{
-       		 	    	  	memcpy(dest,src,line);
-       			 	    	src+=x;
-       			 	    	dest+=line;
-       		 		}
-			dest=VPLANE(data);	
-       		 		for(uint32_t k=((_info.height)>>1);k>0;k--)
-       		 		{
-       		 	    	  	memcpy(dest,src2,line);
-       			 	    	src2+=x;
-       			 	    	dest+=line;
-       		 		}	
-       		  *flags=0;
-       		  *len= _info.width*_info.height+(_info.width*_info.height>>1);
-		  data->copyInfo(_uncompressed);
-      return 1;
-}
-/**
-	Return the configuration as a couple of string
-	Up to the client to free them afterward
-*/
-uint8_t	AVDMVideoStreamCrop::getCoupledConf( CONFcouple **couples)
-{
-
-			ADM_assert(_param);
-			*couples=new CONFcouple(4);
-
-#define CSET(x)  (*couples)->setCouple((char *)#x,(_param->x))
-			CSET(left);
-			CSET(right);
-			CSET(top);
-			CSET(bottom);
-			return 1;
-
-}
-extern int DIA_getCropParams(const char *name, CROP_PARAMS *param, AVDMGenericVideoStream *in);
-uint8_t AVDMVideoStreamCrop::configure( AVDMGenericVideoStream *instream)
-
-{
-		uint8_t r;
-		uint32_t w,h;
-    	if(r = (DIA_getCropParams("Crop Settings",_param,instream )))
-    	{
-			w=_param->left+_param->right;
-			h=_param->top+_param->bottom;
-			ADM_assert(w<instream->getInfo()->width);
-			ADM_assert(h<instream->getInfo()->height);
-			_info.width=instream->getInfo()->width-w;
-			_info.height=instream->getInfo()->height-h;
-		}
-		return r;
-}
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/ADM_vidCrop_param.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/ADM_vidCrop_param.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/ADM_vidCrop_param.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,10 +0,0 @@
-#ifndef DIA_CROP_PARAM_H
-#define DIA_CROP_PARAM_H
-typedef struct
-{
-        uint32_t left,right;
-        uint32_t top,bottom;
-}CROP_PARAMS;
-#endif
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,20 +0,0 @@
-INCLUDE(vf_plugin)
-
-
-SET(CropCommon_SRCS 
-ADM_vidCrop.cpp  DIA_flyCrop.cpp
-)
-
-INCLUDE(vf_plugin_gtk)
-INCLUDE(vf_plugin_qt4)
-
-SET(CropGtk_SRCS gtk/DIA_crop.cpp)
-SET(CropQT_SRCS  qt4/Q_crop.cpp)
-SET(CropQT_HEADERS  qt4/Q_crop.h)
-SET(CropQT_UI    qt4/crop)
-
-INIT_VIDEOFILTER_PLUGIN_QT4(ADM_vf_crop_qt4 
-                ${CropQT_SRCS} ${CropQT_HEADERS} ${CropQT_UI} ${CropCommon_SRCS})
-INIT_VIDEOFILTER_PLUGIN_GTK(  ADM_vf_Crop_gtk 
-                ${CropGtk_SRCS} ${CropCommon_SRCS})
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/DIA_flyCrop.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/DIA_flyCrop.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/DIA_flyCrop.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,235 +0,0 @@
-/***************************************************************************
-                          DIA_flyCrop.cpp  -  description
-                             -------------------
-
-        Common part of the crop dialog
-    
-    copyright            : (C) 2002/2007 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include "DIA_flyDialog.h"
-#include "ADM_default.h"
-
-#include "ADM_image.h"
-#include "ADM_videoFilter.h"
-
-
-
-#include "DIA_flyCrop.h"
-
-
-static uint8_t 		Metrics( uint8_t *in, uint32_t width,uint32_t *avg, uint32_t *eqt);
-static uint8_t 		MetricsV( uint8_t *in, uint32_t width,uint32_t height,uint32_t *avg, uint32_t *eqt);
-
-uint8_t    flyCrop::process(void)
-{
-        uint32_t x,y;
-        uint8_t  *in;
-        uint32_t w=_w,h=_h;
-  
-        
-        memcpy(_rgbBufferOut,_rgbBuffer,_w*_h*4);
-        in=_rgbBufferOut;
-        for(y=0;y<top;y++)
-        {
-                for(x=0;x<w;x++)
-                {
-                        *in++=0;
-                        
-                        
-                        *in++=0xff;
-                        
-                        *in++=0;
-                        *in++=0;
-                }
-        }
-        // bottom
-        in=_rgbBufferOut+(w*4)*(h-bottom);
-        for(y=0;y<bottom;y++)
-        {
-                for(x=0;x<w;x++)
-                {
-                        *in++=0;
-                        
-                        
-                        *in++=0xff;
-                        *in++=0;
-                        *in++=0;
-                }
-        }
-        // left
-        in=_rgbBufferOut;
-        uint32_t stride=4*w-4;
-        for(y=0;y<h;y++)
-        {
-                for(x=0;x<left;x++)
-                {
-                        *(in+4*x)=0;
-                        
-                        
-                        *(in+4*x+1)=0xff;
-                        *(in+4*x+2)=0;
-                        *(in+4*x+3)=0;
-                }
-                for(x=0;x<right;x++)
-                {
-                        *(in-4*x+stride-4)=0;
-                        
-                        
-                        *(in-4*x+stride-3)=0xff;
-                        *(in-4*x+stride-2)=0;
-                        *(in-4*x+stride-1)=0;
-                        
-                }
-                in+=4*w;
-  
-        }
-
-		copyRgbFinalToDisplay();
-}
-
-/*----------------------------------
-  autocrop
------------------------------------*/
-
-uint8_t  flyCrop::autocrop(void)
-{
-uint8_t *in;
-uint32_t y,avg,eqt;
-	// Top
-
-#define THRESH_AVG   30
-#define THRESH_EQT   50
-        
-        in=_yuvBuffer->data;
-        for(y=0;y<((_h>>1)-2);y++)	
-        {
-                Metrics(in,_w,&avg,&eqt);
-                in+=_w;
-                //printf("LineT :%d avg: %d eqt: %d\n",y,avg,eqt);
-                if(avg> THRESH_AVG || eqt > THRESH_EQT)
-                        break;
-        }
-//gotcha_:	
-        if(y)
-                top=y-1;
-        else 
-                top=0;
-                
-        in=_yuvBuffer->data+_w*(_h-1);
-        for(y=0;y<((_h>>1)-2);y++)	
-        {
-                Metrics(in,_w,&avg,&eqt);
-                in-=_w;
-                //printf("Line B :%d avg: %d eqt: %d\n",y,avg,eqt);
-                if(avg> THRESH_AVG || eqt > THRESH_EQT)
-                                break;
-        }
-//gotcha_:	
-        if(y)
-                bottom=y-1;
-        else
-                bottom=0;
-
-                
-// Left
-        in=_yuvBuffer->data;
-        for(y=0;y<((_w>>1)-2);y++)	
-        {
-                MetricsV(in,_w,_h,&avg,&eqt);
-                in++;
-                //printf("Line L :%d avg: %d eqt: %d\n",y,avg,eqt);
-                if(avg> THRESH_AVG || eqt > THRESH_EQT)
-                                break;
-        }
-//gotcha_:	
-        if(y)
-                left=y-1;
-        else
-                left=0;		
-// Right
-        in=_yuvBuffer->data+_w-1;
-        for(y=0;y<((_w>>1)-2);y++)	
-        {
-                MetricsV(in,_w,_h,&avg,&eqt);
-                in--;
-                //printf("Line R :%d avg: %d eqt: %d\n",y,avg,eqt);
-                if(avg> THRESH_AVG || eqt > THRESH_EQT)
-                                break;
-        }
-//gotcha_:	
-        if(y)
-                right=y-1;
-        else
-                right=0;
-  
-              
-        // Update display
-        top=top & 0xfffe;
-        bottom=bottom & 0xfffe;
-        upload();
-        process();
-        display();
-        return 1;
-}
-/*---------------------------------------------
-	Compute the average value of pixels
-	and eqt is the "ecart type"
-*/
-uint8_t Metrics( uint8_t *in, uint32_t width,uint32_t *avg, uint32_t *eqt)
-{
-
-uint32_t x;
-uint32_t sum=0,eq=0;
-uint8_t v;
-              for(x=0;x<width;x++)
-              {
-                      sum+=*(in+x);
-              }
-              sum=sum/width;
-              *avg=sum;
-              for(x=0;x<width;x++)
-              {
-                      v=*(in+x)-sum;
-                      eq+=v*v;
-              }
-              eq=eq/(width*width);
-              *eqt=eq;
-              return 1;
-}
-/*---------------------------------------------
-	Compute the average value of pixels
-	and eqt is the "ecart type"
-*/
-uint8_t MetricsV( uint8_t *in,uint32_t width, uint32_t height,uint32_t *avg, uint32_t *eqt)
-{
-
-uint32_t x;
-uint32_t sum=0,eq=0;
-uint8_t v;
-              for(x=0;x<height;x++)
-              {
-                      sum+=*(in+x*width);
-              }
-              sum=sum/height;
-              *avg=sum;
-              for(x=0;x<height;x++)
-              {
-                      v=*(in+x*width)-sum;
-                      eq+=v*v;
-              }
-              eq=eq/(height*height);
-              *eqt=eq;
-              return 1;
-}
-//EOF
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/DIA_flyCrop.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/DIA_flyCrop.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/DIA_flyCrop.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,16 +0,0 @@
-#ifndef FLY_CROP_H
-#define FLY_CROP_H
-class flyCrop : public FLY_DIALOG_TYPE
-{
-  
-  public:
-   uint32_t left,right,top,bottom;
-  public:
-   uint8_t    process(void);
-   uint8_t    download(void);
-   uint8_t    upload(void);
-   uint8_t    autocrop(void);
-   flyCrop (uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
-                                    void *canvas, void *slider) : FLY_DIALOG_TYPE(width, height,in,canvas, slider,0,RESIZE_LAST) {};
-};
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/gtk/DIA_crop.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/gtk/DIA_crop.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/gtk/DIA_crop.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,389 +0,0 @@
-/***************************************************************************
-                          DIA_crop.cpp  -  description
-                             -------------------
-
-			    GUI for cropping including autocrop
-			    +Revisted the Gtk2 way
-			     +Autocrop now in RGB space (more accurate)
-
-    begin                : Fri May 3 2002
-    copyright            : (C) 2002/2007 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include "ADM_toolkitGtk.h"
-
-#include "ADM_image.h"
-#include "ADM_videoFilter.h"
-
-#include "DIA_flyDialog.h"
-#include "DIA_flyCrop.h"
-#include "ADM_vidCrop_param.h"
-
-#if 1
-static GtkWidget	*create_dialog1 (void);
-
-/* Link between UI and core */
-static gboolean 	ui_draw( void );
-static void 		ui_autocrop (void );
-static void 		ui_reset( void );
-static void 		ui_upload(void);
-static void  		ui_read ( void);
-static void  		ui_update ( void);
-static void 		ui_frame_changed( void );
-
-static GtkWidget *dialog=NULL;
-
-/* Prevent loop when updating value */
-
-static int lock=0;
-static flyCrop *myCrop=NULL;
-//
-//	Video is in YV12 Colorspace
-//
-//
-int DIA_getCropParams(const char *name, CROP_PARAMS *param, AVDMGenericVideoStream *in)
-{
-	uint32_t width, height;
-
-	// Allocate space for green-ised video
-	width = in->getInfo()->width;
-	height = in->getInfo()->height;
-
-	uint8_t ret=0;
-
-	dialog=create_dialog1();
-	gtk_dialog_set_alternative_button_order(GTK_DIALOG(dialog),
-										GTK_RESPONSE_OK,
-										GTK_RESPONSE_CANCEL,
-										GTK_RESPONSE_APPLY,
-										-1);
-	gtk_register_dialog(dialog);
-	gtk_window_set_title(GTK_WINDOW(dialog), name);
-	gtk_widget_show(dialog);
-	
-#define CONNECT(x,y,z) 	gtk_signal_connect(GTK_OBJECT(WID(x)), #y, GTK_SIGNAL_FUNC(z), NULL);
-
-	CONNECT(drawingarea1,expose_event,ui_draw);
-	CONNECT(buttonAutocrop,clicked,ui_autocrop);
-	CONNECT(buttonReset,clicked,ui_reset);
-	CONNECT(scale,value_changed,ui_frame_changed);
-
-#define CONNECT_SPIN(x) CONNECT(spinbutton##x, value_changed,ui_update)
-          
-	CONNECT_SPIN(Top);
-	CONNECT_SPIN(Left);
-	CONNECT_SPIN(Right);
-	CONNECT_SPIN(Bottom);
-
-	myCrop=new flyCrop(width, height,in,WID(drawingarea1),WID(scale));
-	myCrop->left=param->left;
-	myCrop->right=param->right;
-	myCrop->top=param->top;
-	myCrop->bottom=param->bottom;
-	myCrop->upload();	
-	myCrop->sliderChanged();	
-
-	int response;
-
-	while((response = gtk_dialog_run(GTK_DIALOG(dialog))) == GTK_RESPONSE_APPLY)
-	{
-	  ui_update();
-	}
-
-	if(response==GTK_RESPONSE_OK)
-	{
-		ui_read( );
-		param->left=myCrop->left;
-		param->right=myCrop->right;
-		param->top=myCrop->top;
-		param->bottom=myCrop->bottom;
-		ret=1;
-	}
-
-	gtk_unregister_dialog(dialog);
-	gtk_widget_destroy(dialog);
-	delete myCrop;
-	return ret;
-}
-
-/*
-      Link GTK dialog and core
-*/
-void ui_frame_changed( void )
-{
-  myCrop->sliderChanged();
-}
-void ui_update(void)
-{
-  if(lock) return;
-  myCrop->download();
-  myCrop->process();
-  myCrop->display();
-}
-/*---------------------------------------------------------------------------
-	Actually draw the working frame on screen
-*/
-gboolean ui_draw( void )
-{
-        myCrop->display();
-}
-void ui_read (void )
-{
-        myCrop->download();
-}
-void ui_upload(void)
-{
-    myCrop->upload();
-}
-void ui_autocrop( void )
-{
-  myCrop->autocrop();
- 
-}
-void ui_reset( void )
-{
-        myCrop->left=0;
-        myCrop->right=0;
-        myCrop->bottom=0;
-        myCrop->top=0;
-        
-	myCrop->upload();
-        myCrop->process();
-        myCrop->display();
-}
-
-/*---------------------------------------------------------------------------
-	Read entried from dialog box
-*/
-
-#define SPIN_GET(x,y) {x= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(WID(spinbutton##y))) ;}
-#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(spinbutton##y)),(gfloat)x) ;}
-
-
-//____________________________________
-uint8_t flyCrop::upload(void)
-{
-        lock++;
-        SPIN_SET(left,Left);
-        SPIN_SET(right,Right);
-        SPIN_SET(top,Top);
-        SPIN_SET(bottom,Bottom);
-        lock--;
-        return 1;
-}
-uint8_t flyCrop::download(void)
-{
-        int reject=0;
-        
-                        SPIN_GET(left,Left);
-                        SPIN_GET(right,Right);
-                        SPIN_GET(top,Top);
-                        SPIN_GET(bottom,Bottom);
-                        
-                        printf("%d %d %d %d\n",left,right,top,bottom);
-                        
-                        left&=0xffffe;
-                        right&=0xffffe;
-                        top&=0xffffe;
-                        bottom&=0xffffe;
-                        
-                        if((top+bottom)>_h)
-                                {
-                                        top=bottom=0;
-                                        reject=1;
-                                }
-                        if((left+right)>_w)
-                                {
-                                        left=right=0;
-                                        reject=1;
-                                }
-                        if(reject)
-                                upload();
-}
-// End common part
-//--------------------------------------------
-GtkWidget*
-create_dialog1 (void)
-{
-  GtkWidget *dialog1;
-  GtkWidget *dialog_vbox1;
-  GtkWidget *vbox1;
-  GtkWidget *drawingarea1;
-  GtkWidget *scale;
-  GtkWidget *table1;
-  GtkWidget *label1;
-  GtkWidget *label2;
-  GtkWidget *label3;
-  GtkWidget *label4;
-  GtkObject *spinbuttonRight_adj;
-  GtkWidget *spinbuttonRight;
-  GtkObject *spinbuttonLeft_adj;
-  GtkWidget *spinbuttonLeft;
-  GtkObject *spinbuttonBottom_adj;
-  GtkWidget *spinbuttonBottom;
-  GtkObject *spinbuttonTop_adj;
-  GtkWidget *spinbuttonTop;
-  GtkWidget *hbox1;
-  GtkWidget *hbox2;
-  GtkWidget *buttonAutocrop;
-  GtkWidget *buttonReset;
-  GtkWidget *dialog_action_area1;
-  GtkWidget *applybutton1;
-  GtkWidget *cancelbutton1;
-  GtkWidget *okbutton1;
-
-  dialog1 = gtk_dialog_new ();
-  gtk_window_set_title (GTK_WINDOW (dialog1), QT_TR_NOOP("Crop Settings"));
-  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
-
-  dialog_vbox1 = GTK_DIALOG (dialog1)->vbox;
-  gtk_widget_show (dialog_vbox1);
-
-  vbox1 = gtk_vbox_new (FALSE, 6);
-  gtk_widget_show (vbox1);
-  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
-  gtk_container_set_border_width (GTK_CONTAINER (vbox1), 6);
-
-  drawingarea1 = gtk_drawing_area_new ();
-  gtk_widget_show (drawingarea1);
-  gtk_box_pack_start (GTK_BOX (vbox1), drawingarea1, TRUE, TRUE, 0);
-
-  scale = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 0, 0, 0, 0, 0)));
-  gtk_widget_show (scale);
-  gtk_box_pack_start (GTK_BOX (vbox1), scale, FALSE, TRUE, 0);
-
-  table1 = gtk_table_new (2, 4, FALSE);
-  gtk_widget_show (table1);
-  gtk_box_pack_start (GTK_BOX (vbox1), table1, FALSE, FALSE, 10);
-  gtk_table_set_row_spacings (GTK_TABLE (table1), 4);
-  gtk_table_set_col_spacings (GTK_TABLE (table1), 15);
-
-  label1 = gtk_label_new (QT_TR_NOOP("Crop Left:"));
-  gtk_widget_show (label1);
-  gtk_table_attach (GTK_TABLE (table1), label1, 0, 1, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label1), 0, 0.5);
-
-  label2 = gtk_label_new (QT_TR_NOOP("Crop Right:"));
-  gtk_widget_show (label2);
-  gtk_table_attach (GTK_TABLE (table1), label2, 0, 1, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label2), 0, 0.5);
-
-  label3 = gtk_label_new (QT_TR_NOOP("Crop Top:"));
-  gtk_widget_show (label3);
-  gtk_table_attach (GTK_TABLE (table1), label3, 2, 3, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label3), 0, 0.5);
-
-  label4 = gtk_label_new (QT_TR_NOOP("Crop Bottom:"));
-  gtk_widget_show (label4);
-  gtk_table_attach (GTK_TABLE (table1), label4, 2, 3, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label4), 0, 0.5);
-
-  spinbuttonRight_adj = gtk_adjustment_new (1, 0, 1000, 1, 10, 10);
-  spinbuttonRight = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonRight_adj), 1, 0);
-  gtk_widget_show (spinbuttonRight);
-  gtk_table_attach (GTK_TABLE (table1), spinbuttonRight, 1, 2, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  spinbuttonLeft_adj = gtk_adjustment_new (1, 0, 1000, 1, 10, 10);
-  spinbuttonLeft = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonLeft_adj), 1, 0);
-  gtk_widget_show (spinbuttonLeft);
-  gtk_table_attach (GTK_TABLE (table1), spinbuttonLeft, 1, 2, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  spinbuttonBottom_adj = gtk_adjustment_new (1, 0, 1000, 1, 10, 10);
-  spinbuttonBottom = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonBottom_adj), 1, 0);
-  gtk_widget_show (spinbuttonBottom);
-  gtk_table_attach (GTK_TABLE (table1), spinbuttonBottom, 3, 4, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  spinbuttonTop_adj = gtk_adjustment_new (1, 0, 1000, 1, 10, 10);
-  spinbuttonTop = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonTop_adj), 1, 0);
-  gtk_widget_show (spinbuttonTop);
-  gtk_table_attach (GTK_TABLE (table1), spinbuttonTop, 3, 4, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  hbox1 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox1);
-  gtk_box_pack_start (GTK_BOX (vbox1), hbox1, FALSE, TRUE, 0);
-
-  hbox2 = gtk_hbox_new (TRUE, 6);
-  gtk_widget_show (hbox2);
-  gtk_box_pack_start (GTK_BOX (hbox1), hbox2, FALSE, TRUE, 0);
-
-  buttonAutocrop = gtk_button_new_with_mnemonic (QT_TR_NOOP("Auto Crop"));
-  gtk_widget_show (buttonAutocrop);
-  gtk_box_pack_start (GTK_BOX (hbox2), buttonAutocrop, FALSE, TRUE, 0);
-
-  buttonReset = gtk_button_new_from_stock ("gtk-clear");
-  gtk_widget_show (buttonReset);
-  gtk_box_pack_start (GTK_BOX (hbox2), buttonReset, FALSE, TRUE, 0);
-
-  dialog_action_area1 = GTK_DIALOG (dialog1)->action_area;
-  gtk_widget_show (dialog_action_area1);
-  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
-
-  applybutton1 = gtk_button_new_from_stock ("gtk-apply");
-  gtk_widget_show (applybutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), applybutton1, GTK_RESPONSE_APPLY);
-  GTK_WIDGET_SET_FLAGS (applybutton1, GTK_CAN_DEFAULT);
-
-  cancelbutton1 = gtk_button_new_from_stock ("gtk-cancel");
-  gtk_widget_show (cancelbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
-  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
-
-  okbutton1 = gtk_button_new_from_stock ("gtk-ok");
-  gtk_widget_show (okbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
-  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
-
-  /* Store pointers to all widgets, for use by lookup_widget(). */
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, "dialog1");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, "dialog_vbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, vbox1, "vbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, drawingarea1, "drawingarea1");
-  GLADE_HOOKUP_OBJECT (dialog1, scale, "scale");
-  GLADE_HOOKUP_OBJECT (dialog1, table1, "table1");
-  GLADE_HOOKUP_OBJECT (dialog1, label1, "label1");
-  GLADE_HOOKUP_OBJECT (dialog1, label2, "label2");
-  GLADE_HOOKUP_OBJECT (dialog1, label3, "label3");
-  GLADE_HOOKUP_OBJECT (dialog1, label4, "label4");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonRight, "spinbuttonRight");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonLeft, "spinbuttonLeft");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonBottom, "spinbuttonBottom");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonTop, "spinbuttonTop");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox1, "hbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox2, "hbox2");
-  GLADE_HOOKUP_OBJECT (dialog1, buttonAutocrop, "buttonAutocrop");
-  GLADE_HOOKUP_OBJECT (dialog1, buttonReset, "buttonReset");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, "dialog_action_area1");
-  GLADE_HOOKUP_OBJECT (dialog1, applybutton1, "applybutton1");
-  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, "cancelbutton1");
-  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, "okbutton1");
-
-  return dialog1;
-}
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/qt4/Q_crop.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/qt4/Q_crop.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/qt4/Q_crop.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,171 +0,0 @@
-/***************************************************************************
-                          DIA_crop.cpp  -  description
-                             -------------------
-
-			    GUI for cropping including autocrop
-			    +Revisted the Gtk2 way
-			     +Autocrop now in RGB space (more accurate)
-
-    begin                : Fri May 3 2002
-    copyright            : (C) 2002/2007 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#if 1
-#include "Q_crop.h"
-
-//
-//	Video is in YV12 Colorspace
-//
-//
-  Ui_cropWindow::Ui_cropWindow(CROP_PARAMS *param,AVDMGenericVideoStream *in)
-  {
-    uint32_t width,height;
-        ui.setupUi(this);
-        lock=0;
-        // Allocate space for green-ised video
-        width=in->getInfo()->width;
-        height=in->getInfo()->height;
-
-        canvas=new ADM_QCanvas(ui.graphicsView,width,height);
-        
-        myCrop=new flyCrop( width, height,in,canvas,ui.horizontalSlider);
-        myCrop->left=param->left;
-        myCrop->right=param->right;
-        myCrop->top=param->top;
-        myCrop->bottom=param->bottom;
-        myCrop->_cookie=&ui;
-        myCrop->upload();
-        myCrop->sliderChanged();
-
-
-        connect( ui.horizontalSlider,SIGNAL(valueChanged(int)),this,SLOT(sliderUpdate(int)));
-        connect( ui.pushButtonAutoCrop,SIGNAL(clicked(bool)),this,SLOT(autoCrop(bool)));
-        connect( ui.pushButtonReset,SIGNAL(clicked(bool)),this,SLOT(reset(bool)));
-#define SPINNER(x) connect( ui.spinBox##x,SIGNAL(valueChanged(int)),this,SLOT(valueChanged(int))); 
-          SPINNER(Left);
-          SPINNER(Right);
-          SPINNER(Top);
-          SPINNER(Bottom);
-
-  }
-  void Ui_cropWindow::sliderUpdate(int foo)
-  {
-    myCrop->sliderChanged();
-  }
-  void Ui_cropWindow::gather(CROP_PARAMS *param)
-  {
-    
-        myCrop->download();
-        param->left=myCrop->left;
-        param->right=myCrop->right;
-        param->top=myCrop->top;
-        param->bottom=myCrop->bottom;
-  }
-Ui_cropWindow::~Ui_cropWindow()
-{
-  if(myCrop) delete myCrop;
-  myCrop=NULL; 
-  if(canvas) delete canvas;
-  canvas=NULL;
-}
-void Ui_cropWindow::valueChanged( int f )
-{
-  if(lock) return;
-  lock++;
-  myCrop->download();
-  myCrop->process();
-  myCrop->display();
-  lock--;
-}
-
-void Ui_cropWindow::autoCrop( bool f )
-{
-  lock++;
-  myCrop->autocrop();
-  lock--;
-}
-void Ui_cropWindow::reset( bool f )
-{
-         myCrop->left=0;
-         myCrop->right=0;
-         myCrop->bottom=0;
-         myCrop->top=0;
-         lock++;
-         myCrop->upload();
-         myCrop->process();
-         myCrop->display();
-         lock--;
-}
-
-//************************
-uint8_t flyCrop::upload(void)
-{
-      Ui_cropDialog *w=(Ui_cropDialog *)_cookie;
-        
-        w->spinBoxLeft->setValue(left);
-        w->spinBoxRight->setValue(right);
-        w->spinBoxTop->setValue(top);
-        w->spinBoxBottom->setValue(bottom);
-        
-        return 1;
-}
-uint8_t flyCrop::download(void)
-{
-        int reject=0;
-Ui_cropDialog *w=(Ui_cropDialog *)_cookie;
-#define SPIN_GET(x,y) x=w->spinBox##y->value();
-                        SPIN_GET(left,Left);
-                        SPIN_GET(right,Right);
-                        SPIN_GET(top,Top);
-                        SPIN_GET(bottom,Bottom);
-                        
-                        printf("%d %d %d %d\n",left,right,top,bottom);
-                        
-                        left&=0xffffe;
-                        right&=0xffffe;
-                        top&=0xffffe;
-                        bottom&=0xffffe;
-                        
-                        if((top+bottom)>_h)
-                                {
-                                        top=bottom=0;
-                                        reject=1;
-                                }
-                        if((left+right)>_w)
-                                {
-                                        left=right=0;
-                                        reject=1;
-                                }
-                        if(reject)
-                                upload();
-}
-
-/**
-      \fn     DIA_getCropParams
-      \brief  Handle crop dialog
-*/
-int DIA_getCropParams(	const char *name,CROP_PARAMS *param,AVDMGenericVideoStream *in)
-{
-        uint8_t ret=0;
-        
-        Ui_cropWindow dialog(param,in);        
-        if(dialog.exec()==QDialog::Accepted)
-        {
-            dialog.gather(param); 
-            ret=1;
-        }
-        return ret;
-}
-//____________________________________
-// EOF
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/qt4/Q_crop.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/qt4/Q_crop.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/qt4/Q_crop.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,38 +0,0 @@
-#ifndef Q_crop_h
-#define Q_crop_h
-#include "DIA_flyDialog.h"
-#include "ui_crop.h"
-#include "ADM_image.h"
-#include "ADM_videoFilter.h"
-
-#include "DIA_flyDialogQt4.h"
-#include "DIA_flyCrop.h"
-#include "ADM_vidCrop_param.h"
-#if 1
-class Ui_cropWindow : public QDialog
-{
-	Q_OBJECT
-
-protected: 
-	int lock;
-
-public:
-	flyCrop *myCrop;
-	ADM_QCanvas *canvas;
-	Ui_cropWindow(CROP_PARAMS *param,AVDMGenericVideoStream *in);
-	~Ui_cropWindow();
-	Ui_cropDialog ui;
-
-public slots:
-	void gather(CROP_PARAMS *param);
-
-private slots:
-	void sliderUpdate(int foo);
-	void valueChanged(int foo);
-	void autoCrop(bool f);
-	void reset(bool f);
-};
-
-#endif	// Q_crop_h
-#endif
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/qt4/crop.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/qt4/crop.ui	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Crop/qt4/crop.ui	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,231 +0,0 @@
-<ui version="4.0" >
- <class>cropDialog</class>
- <widget class="QDialog" name="cropDialog" >
-  <property name="geometry" >
-   <rect>
-    <x>0</x>
-    <y>0</y>
-    <width>348</width>
-    <height>300</height>
-   </rect>
-  </property>
-  <property name="windowTitle" >
-   <string>Crop</string>
-  </property>
-  <layout class="QVBoxLayout" >
-   <property name="margin" >
-    <number>9</number>
-   </property>
-   <property name="spacing" >
-    <number>6</number>
-   </property>
-   <item>
-    <layout class="QGridLayout" >
-     <property name="margin" >
-      <number>0</number>
-     </property>
-     <property name="spacing" >
-      <number>6</number>
-     </property>
-     <item row="0" column="3" >
-      <widget class="QLabel" name="label_2" >
-       <property name="text" >
-        <string>Right:</string>
-       </property>
-      </widget>
-     </item>
-     <item row="1" column="0" >
-      <widget class="QLabel" name="label_4" >
-       <property name="text" >
-        <string>Top:</string>
-       </property>
-      </widget>
-     </item>
-     <item row="0" column="4" >
-      <widget class="QSpinBox" name="spinBoxRight" >
-       <property name="maximum" >
-        <number>2147483647</number>
-       </property>
-      </widget>
-     </item>
-     <item row="0" column="2" >
-      <spacer>
-       <property name="orientation" >
-        <enum>Qt::Horizontal</enum>
-       </property>
-       <property name="sizeType" >
-        <enum>QSizePolicy::Fixed</enum>
-       </property>
-       <property name="sizeHint" >
-        <size>
-         <width>26</width>
-         <height>20</height>
-        </size>
-       </property>
-      </spacer>
-     </item>
-     <item row="1" column="5" >
-      <spacer>
-       <property name="orientation" >
-        <enum>Qt::Horizontal</enum>
-       </property>
-       <property name="sizeHint" >
-        <size>
-         <width>40</width>
-         <height>20</height>
-        </size>
-       </property>
-      </spacer>
-     </item>
-     <item row="1" column="6" >
-      <widget class="QPushButton" name="pushButtonReset" >
-       <property name="text" >
-        <string>Reset</string>
-       </property>
-      </widget>
-     </item>
-     <item row="1" column="1" >
-      <widget class="QSpinBox" name="spinBoxTop" >
-       <property name="maximum" >
-        <number>2147483647</number>
-       </property>
-      </widget>
-     </item>
-     <item row="1" column="4" >
-      <widget class="QSpinBox" name="spinBoxBottom" >
-       <property name="maximum" >
-        <number>2147483647</number>
-       </property>
-      </widget>
-     </item>
-     <item row="1" column="3" >
-      <widget class="QLabel" name="label_3" >
-       <property name="text" >
-        <string>Bottom:</string>
-       </property>
-      </widget>
-     </item>
-     <item row="0" column="0" >
-      <widget class="QLabel" name="label" >
-       <property name="text" >
-        <string>Left:</string>
-       </property>
-      </widget>
-     </item>
-     <item row="0" column="5" >
-      <spacer>
-       <property name="orientation" >
-        <enum>Qt::Horizontal</enum>
-       </property>
-       <property name="sizeType" >
-        <enum>QSizePolicy::MinimumExpanding</enum>
-       </property>
-       <property name="sizeHint" >
-        <size>
-         <width>40</width>
-         <height>20</height>
-        </size>
-       </property>
-      </spacer>
-     </item>
-     <item row="0" column="1" >
-      <widget class="QSpinBox" name="spinBoxLeft" >
-       <property name="maximum" >
-        <number>2147483647</number>
-       </property>
-      </widget>
-     </item>
-     <item row="0" column="6" >
-      <widget class="QPushButton" name="pushButtonAutoCrop" >
-       <property name="text" >
-        <string>Auto Crop</string>
-       </property>
-      </widget>
-     </item>
-     <item row="1" column="2" >
-      <spacer>
-       <property name="orientation" >
-        <enum>Qt::Horizontal</enum>
-       </property>
-       <property name="sizeType" >
-        <enum>QSizePolicy::Fixed</enum>
-       </property>
-       <property name="sizeHint" >
-        <size>
-         <width>26</width>
-         <height>20</height>
-        </size>
-       </property>
-      </spacer>
-     </item>
-    </layout>
-   </item>
-   <item>
-    <widget class="QSlider" name="horizontalSlider" >
-     <property name="orientation" >
-      <enum>Qt::Horizontal</enum>
-     </property>
-    </widget>
-   </item>
-   <item>
-    <widget class="QGraphicsView" name="graphicsView" />
-   </item>
-   <item>
-    <widget class="QDialogButtonBox" name="buttonBox" >
-     <property name="orientation" >
-      <enum>Qt::Horizontal</enum>
-     </property>
-     <property name="standardButtons" >
-      <set>QDialogButtonBox::Cancel|QDialogButtonBox::NoButton|QDialogButtonBox::Ok</set>
-     </property>
-    </widget>
-   </item>
-  </layout>
- </widget>
- <tabstops>
-  <tabstop>spinBoxLeft</tabstop>
-  <tabstop>spinBoxRight</tabstop>
-  <tabstop>spinBoxTop</tabstop>
-  <tabstop>spinBoxBottom</tabstop>
-  <tabstop>pushButtonAutoCrop</tabstop>
-  <tabstop>pushButtonReset</tabstop>
-  <tabstop>horizontalSlider</tabstop>
-  <tabstop>graphicsView</tabstop>
-  <tabstop>buttonBox</tabstop>
- </tabstops>
- <resources/>
- <connections>
-  <connection>
-   <sender>buttonBox</sender>
-   <signal>accepted()</signal>
-   <receiver>cropDialog</receiver>
-   <slot>accept()</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>248</x>
-     <y>254</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>157</x>
-     <y>274</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>buttonBox</sender>
-   <signal>rejected()</signal>
-   <receiver>cropDialog</receiver>
-   <slot>reject()</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>316</x>
-     <y>260</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>286</x>
-     <y>274</y>
-    </hint>
-   </hints>
-  </connection>
- </connections>
-</ui>

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/KernelDeint/ADM_vidKernelDeint.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/KernelDeint/ADM_vidKernelDeint.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/KernelDeint/ADM_vidKernelDeint.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,441 +0,0 @@
-/***************************************************************************
-                          ADM_vidKernelDeint  -  description
-                             -------------------
- 			Port of another D Graft deinterlacer
-			http://neuron2.net/kerneldeint/kerneldeint.html
-     ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-
-/*
-	KernelDeint() plugin for Avisynth.
-
-	Copyright (C) 2003 Donald A. Graft
-
-	This program is free software; you can redistribute it and/or modify
-	it under the terms of the GNU General Public License as published by
-	the Free Software Foundation.
-
-	This program is distributed in the hope that it will be useful,
-	but WITHOUT ANY WARRANTY; without even the implied warranty of
-	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-	GNU General Public License for more details.
-
-	You should have received a copy of the GNU General Public License
-	along with this program; if not, write to the Free Software
-	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-*/
-
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-#include "ADM_vidKernelDeint.h"
-
-#include "DIA_factory.h"
-
-static FILTER_PARAM kdintParam={5,{"order","threshold","sharp","twoway","map"}};
-
-
-VF_DEFINE_FILTER(ADMVideoKernelDeint,kdintParam,
-    kerneldeint,
-                QT_TR_NOOP("KernelDeint"),
-                1,
-                VF_INTERLACING,
-                QT_TR_NOOP("Kernel deinterlacer by Donald Graft."));
-static int PutHintingData(uint8_t *video, unsigned int hint);
-static int GetHintingData(uint8_t *video, unsigned int *hint);
-
-// extern uint8_t DIA_kerneldeint(uint32_t *order, uint32_t *threshold, uint32_t *sharp, 
-// 		uint32_t *twoway, uint32_t *map);
-
-#define PROGRESSIVE  0x00000001
-
-
-
-
-
-uint8_t ADMVideoKernelDeint::configure( AVDMGenericVideoStream *instream)
-{
-  #define PX(x) &(_param->x)
-_in=instream;
-
-   diaMenuEntry menuField[2]={{1,QT_TR_NOOP("Top"),NULL},
-                             {0,QT_TR_NOOP("Bottom"),NULL}
-                          };
-  
-    
-    diaElemMenu     menu1(PX(order),QT_TR_NOOP("_Field order:"), 2,menuField);
-    diaElemUInteger threshold(PX(threshold),QT_TR_NOOP("_Threshold:"),0,100,QT_TR_NOOP("Smaller means more deinterlacing"));
-    diaElemToggle   sharp(PX(sharp),QT_TR_NOOP("_Sharp"),QT_TR_NOOP("_Sharper engine:"));
-    diaElemToggle   twoway(PX(twoway),QT_TR_NOOP("T_woway"),QT_TR_NOOP("Extrapolate better (better not to use it)"));
-    diaElemToggle   map(PX(map),QT_TR_NOOP("_Map"),QT_TR_NOOP("Show interlaced areas (for test!)"));
-    
-    diaElem *elems[5]={&menu1,&threshold,&sharp,&twoway,&map};
-  
-   return  diaFactoryRun(QT_TR_NOOP("KernelDeint"),5,elems);
-}
-uint8_t	ADMVideoKernelDeint::getCoupledConf( CONFcouple **couples)
-{
-
-			*couples=new CONFcouple(5);
-
-			CSET(order);
-			CSET(threshold);
-			CSET(sharp);
-			CSET(twoway);
-			CSET(map);	
-
-		return 1;	
-}
-char *ADMVideoKernelDeint::printConf( void )
-{
- 	ADM_FILTER_DECLARE_CONF(" D Graft Kernel Deint");
-        
-}
-
-ADMVideoKernelDeint::~ADMVideoKernelDeint()
-{
- if(vidCache) delete vidCache;
- 	
-}
-
-
- ADMVideoKernelDeint::ADMVideoKernelDeint( AVDMGenericVideoStream *in,CONFcouple *couples)
-{
-
-		if(!couples)
-		{
-			_param=NEW(KERNEL_CONF);
-	    		_param->order=1; // Bff=0 / 1=tff
-	    		_param->threshold=10;
-	    		_param->sharp=0;
-	    		_param->twoway=0;
-	    		_param->map=0;
-		}
-		else
-		{
-			_param=NEW(KERNEL_CONF);
-			GET(order);
-			GET(threshold);
-			GET(sharp);
-			GET(twoway);
-			GET(map);
-						
-		}
-	    debug=0;   
-	    _in=in;
-	    
-	   _uncompressed=NULL;
-
-  	memcpy(&_info,_in->getInfo(),sizeof(_info));
-	vidCache=new VideoCache(4,_in);
-
-
-}
-uint8_t ADMVideoKernelDeint::getFrameNumberNoAlloc(uint32_t frame,
-							uint32_t *len,
-							ADMImage *data,
-							uint32_t *flags)
-{
-		
-		uint32_t frame_prev;
-		uint32_t page=_info.width*_info.height;
-		ADMImage *mysrc=NULL, *myprev=NULL;
-		
-		if(frame>_info.nb_frames-1) return 0;
-
-
-		
-		frame_prev=frame;
-		if(frame_prev) frame_prev--;
-		
-		
-		
-			mysrc=vidCache->getImage(frame);
-			myprev=vidCache->getImage(frame_prev);
-			ADM_assert(mysrc);
-			ADM_assert(myprev);
-		// Now go to kernel deint code
-			
-    const uint8_t *srcp, *prvp,*prvp_saved, *prvpp, *prvpn, *prvppp, *prvpnn, *prvp4p, *prvp4n;
-	const uint8_t *srcp_saved;
-	const uint8_t *srcpp, *srcppp, *srcpn, *srcpnn, *srcp3p, *srcp3n, *srcp4p, *srcp4n;
-    uint8_t *dstp;
-	uint8_t *dstp_saved;
- 
-	int plane;
-	int src_pitch;
-    int dst_pitch;
-    int w;
-    int h;
-	int x, y, z;
-	int val, hi, lo;
-	double valf;
-	unsigned int hint;
-	char buf[80];
-	
-	uint32_t pitch;
-	uint32_t offset;
-	
-	
-	uint32_t		order, threshold;
-	uint8_t			sharp, twoway, map;
-	
-	order=_param->order;
-	threshold=_param->threshold;
-	sharp=_param->sharp;
-	twoway=_param->twoway;
-	map=_param->map;
-	
-	
-	for (z = 0; z < 3; z++)
-	{
-		
-		pitch=_info.width;
-		switch(z)
-		{
-			case 0:		offset=0;
-					srcp=srcp_saved= YPLANE(mysrc);
-					dstp = dstp_saved=YPLANE(data);
-					prvp_saved=prvp=YPLANE(myprev);
-					break;
-			case 1:		offset=page;
-					pitch>>=1;
-					srcp=srcp_saved=UPLANE(mysrc);
-					dstp = dstp_saved=UPLANE(data);
-					prvp_saved=prvp=UPLANE(myprev);
-					break;
-			case 2:		offset=((page*5)>>2);
-					pitch>>=1;
-					srcp=srcp_saved=VPLANE(mysrc);
-					dstp = dstp_saved=VPLANE(data);
-					prvp_saved=prvp=VPLANE(myprev);
-					break;
-		
-		}
-		
-		if (z==0 && (GetHintingData((uint8_t *) srcp, &hint) == false) && (hint & PROGRESSIVE))
-		{
-			if (debug ==true)
-			{
-				printf( "KernelDeint: frame %d: progressive\n", frame); 
-				
-			}
-			memcpy(YPLANE(data),YPLANE(mysrc),page);
-			memcpy(UPLANE(data),UPLANE(mysrc),page>>2);
-			memcpy(VPLANE(data),VPLANE(mysrc),page>>2);
-			vidCache->unlockAll();
-			data->copyInfo(mysrc);
-			return 1;
-		}
-		else
-		{
-			if (debug == true)
-			{
-				printf( "KernelDeint: frame %d: interkaced\n", frame); 
-			}
-		}
-		
-		src_pitch = pitch;	
-		dst_pitch = pitch;
-		
-		w = pitch; //dst->GetRowSize(plane);
-		h=_info.height;
-		if(z) h>>=1;  //h = dst->GetHeight(plane);
-		
-		srcp = srcp_saved  + (1-order) * src_pitch;
-		dstp = dstp_saved  + (1-order) * dst_pitch;
-		for (y = 0; y < h; y+=2)
-		{
-			memcpy(dstp, srcp, w);
-			srcp += 2*src_pitch;
-			dstp += 2*dst_pitch;
-		}
-
-		// Copy through the lines that will be missed below.
-		memcpy(dstp_saved + order*dst_pitch, srcp_saved + (1-order)*src_pitch, w);
-		memcpy(dstp_saved + (2+order)*dst_pitch, srcp_saved + (3-order)*src_pitch, w);
-		memcpy(dstp_saved + (h-2+order)*dst_pitch, srcp_saved + (h-1-order)*src_pitch, w);
-		memcpy(dstp_saved + (h-4+order)*dst_pitch, srcp_saved + (h-3-order)*src_pitch, w);
-		/* For the other field choose adaptively between using the previous field
-		   or the interpolant from the current field. */
-		//prvp = prv->GetReadPtr(plane) + 5*src_pitch - (1-order)*src_pitch;
-		prvp = prvp_saved + 5*src_pitch - (1-order)*src_pitch;
-		
-		
-		prvpp = prvp - src_pitch;
-		prvppp = prvp - 2*src_pitch;
-		prvp4p = prvp - 4*src_pitch;
-		prvpn = prvp + src_pitch;
-		prvpnn = prvp + 2*src_pitch;
-		prvp4n = prvp + 4*src_pitch;
-		srcp = srcp_saved + 5*src_pitch - (1-order)*src_pitch;
-		srcpp = srcp - src_pitch;
-		srcppp = srcp - 2*src_pitch;
-		srcp3p = srcp - 3*src_pitch;
-		srcp4p = srcp - 4*src_pitch;
-		srcpn = srcp + src_pitch;
-		srcpnn = srcp + 2*src_pitch;
-		srcp3n = srcp + 3*src_pitch;
-		srcp4n = srcp + 4*src_pitch;
-		dstp =  dstp_saved  + 5*dst_pitch - (1-order)*dst_pitch;
-		for (y = 5 - (1-order); y <= h - 5 - (1-order); y+=2)
-		{
-			for (x = 0; x < w; x++)
-			{
-				if ((threshold == 0) || (frame == 0) ||
-					(abs((int)prvp[x] - (int)srcp[x]) > threshold) ||
-					(abs((int)prvpp[x] - (int)srcpp[x]) > threshold) ||
-					(abs((int)prvpn[x] - (int)srcpn[x]) > threshold))
-				{
-					if (map == true)
-					{
-						int g = x & ~3;
-						
-						{
-							if (z == 0) dstp[x] = 235;
-							else dstp[x] = 128;
-						}
-					}
-					else
-					{
-						
-						{
-							hi = (z == 0) ? 235 : 240;
-							lo = 16;
-						}
-						
-						if (sharp == true)
-						{
-							if (twoway == true)
-								valf = + 0.526*((int)srcpp[x] +
-								 (int)srcpn[x])
-								   + 0.170*((int)srcp[x] + (int)prvp[x])
-								   - 0.116*((int)srcppp[x] +
-								    (int)srcpnn[x] + (int)prvppp[x] +
-								    (int)prvpnn[x])
-					 			   - 0.026*((int)srcp3p[x] +
-								    (int)srcp3n[x])
-								   + 0.031*((int)srcp4p[x] +
-								    (int)srcp4n[x] + (int)prvp4p[x] +
-								    (int)prvp4n[x]);
-							else
-								valf = + 0.526*((int)srcpp[x] +
-								 (int)srcpn[x])
-								   + 0.170*((int)prvp[x])
-								   - 0.116*((int)prvppp[x] +
-								    (int)prvpnn[x])
-					 			   - 0.026*((int)srcp3p[x] +
-								    (int)srcp3n[x])
-								   + 0.031*((int)prvp4p[x] +
-								    (int)prvp4p[x]);
-							if (valf > hi) valf = hi;
-							else if (valf < lo) valf = lo;
-							dstp[x] = (int) valf;
-						}
-						else
-						{
-							if (twoway == true)
-								val = (8*((int)srcpp[x] + (int)srcpn[x]) +
-								 2*((int)srcp[x] + (int)prvp[x]) -
-								 			 
-									(int)(srcppp[x]) -
-									 (int)(srcpnn[x]) -
-									(int)(prvppp[x]) -
-									 (int)(prvpnn[x])) >> 4;
-							else
-								val = (8*((int)srcpp[x] + (int)srcpn[x]) +
-								 2*((int)prvp[x]) -
-									(int)(prvppp[x]) -
-									 (int)(prvpnn[x])) >> 4;
-							if (val > hi) val = hi;
-							else if (val < lo) val = lo;
-							dstp[x] = (int) val;
-						}
-					}
-				}
-				else
-				{
-					dstp[x] = srcp[x];
-				}
-			}
-			prvp  += 2*src_pitch;
-			prvpp  += 2*src_pitch;
-			prvppp  += 2*src_pitch;
-			prvpn  += 2*src_pitch;
-			prvpnn  += 2*src_pitch;
-			prvp4p  += 2*src_pitch;
-			prvp4n  += 2*src_pitch;
-			srcp  += 2*src_pitch;
-			srcpp += 2*src_pitch;
-			srcppp += 2*src_pitch;
-			srcp3p += 2*src_pitch;
-			srcp4p += 2*src_pitch;
-			srcpn += 2*src_pitch;
-			srcpnn += 2*src_pitch;
-			srcp3n += 2*src_pitch;
-			srcp4n += 2*src_pitch;
-			dstp  += 2*dst_pitch;
-		}
-	}
-	data->copyInfo(mysrc);
-	vidCache->unlockAll();
-	return 1;
-}
-
-
-
-#define MAGIC_NUMBER (0xdeadbeef)
-
-int PutHintingData(uint8_t *video, unsigned int hint)
-{
-	uint8_t *p;
-	unsigned int i, magic_number = MAGIC_NUMBER;
-	int error = false;
-
-	p = video;
-	for (i = 0; i < 32; i++)
-	{
-		*p &= ~1; 
-		*p++ |= ((magic_number & (1 << i)) >> i);
-	}
-	for (i = 0; i < 32; i++)
-	{
-		*p &= ~1;
-		*p++ |= ((hint & (1 << i)) >> i);
-	}
-	return error;
-}
-
-int GetHintingData(uint8_t *video, unsigned int *hint)
-{
-	uint8_t *p;
-	unsigned int i, magic_number = 0;
-	int error = false;
-
-	p = video;
-	for (i = 0; i < 32; i++)
-	{
-		magic_number |= ((*p++ & 1) << i);
-	}
-	if (magic_number != MAGIC_NUMBER)
-	{
-		error = true;
-	}
-	else
-	{
-		*hint = 0;
-		for (i = 0; i < 32; i++)
-		{
-			*hint |= ((*p++ & 1) << i);
-		}
-	}
-	return error;
-}

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/KernelDeint/ADM_vidKernelDeint.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/KernelDeint/ADM_vidKernelDeint.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/KernelDeint/ADM_vidKernelDeint.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,33 +0,0 @@
-
-#ifndef ADM_KERNELDEINT
-#define ADM_KERNELDEINT
-
-typedef struct  KERNEL_CONF
-{
-	uint32_t		order, threshold;
-	uint32_t		sharp, twoway, map;
-
-}KERNEL_CONF;
-
-class  ADMVideoKernelDeint:public AVDMGenericVideoStream
- {
-
- protected:
-        virtual char 		*printConf(void) ;
-	KERNEL_CONF		*_param;
-        int			 debug;
-	VideoCache		*vidCache;
-	   
-
- public:
- 		
-  			ADMVideoKernelDeint(  AVDMGenericVideoStream *in,CONFcouple *setup);
-  			~ADMVideoKernelDeint();
-	virtual uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-						ADMImage *data,uint32_t *flags);
-	virtual uint8_t	getCoupledConf( CONFcouple **couples)		;
-	virtual uint8_t configure( AVDMGenericVideoStream *instream);
-							
-};
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/KernelDeint/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/KernelDeint/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/KernelDeint/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,9 +0,0 @@
-INCLUDE(vf_plugin)
-
-
-SET(ADM_vf_kernelDeint_SRCS ADM_vidKernelDeint.cpp)
-
-ADD_LIBRARY(ADM_vf_kernelDeint SHARED ${ADM_vf_kernelDeint_SRCS})
-
-INIT_VIDEOFILTER_PLUGIN(ADM_vf_kernelDeint)
-INSTALL_VIDEOFILTER(ADM_vf_kernelDeint)

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Logo/ADM_vidLogo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Logo/ADM_vidLogo.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Logo/ADM_vidLogo.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,193 +0,0 @@
-/***************************************************************************
-
-		Put a logon on video
-
-    copyright            : (C) 2007 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-/*
-  Initial port from MPlayer by Moonz
-
-*/
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-#include "ADM_colorspace.h"
-#include "DIA_factory.h"
-
-static FILTER_PARAM logoParam={4,
-        { /* float */ "image",
-          /*float*/ "x",
-          /* int */ "y",
-          /* int */ "alpha"}};
-
-
-typedef struct 
-{
-		char *image;
-		uint32_t x,y;
-		uint32_t alpha;
-}PARAM_LOGO;
-
-
-class ADMVideoLogo : public AVDMGenericVideoStream
-{
-  
-	PARAM_LOGO   *_param;
-	ADMImage	 *_image;
-	uint32_t	 _inited;
-	uint8_t		 init(void);
-	uint8_t		 cleanup(void);
-  public:
-                                
-	  				ADMVideoLogo(AVDMGenericVideoStream *in,CONFcouple *couples);    
-                    ~ADMVideoLogo(void);
-    uint8_t         getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-                                          ADMImage *data,uint32_t *flags);
-        
-    char            *printConf( void );
-    uint8_t         configure(AVDMGenericVideoStream *in);
-    uint8_t         getCoupledConf( CONFcouple **couples);
-};
-
-//********** Register chunk ************
-//REGISTERX(VF_MISC, "logo",QT_TR_NOOP("Logo"),QT_TR_NOOP("Add a png as logo."),VF_LOGO,1,logo_create,logo_script);
-VF_DEFINE_FILTER(ADMVideoLogo,logoParam,
-    logo,
-                QT_TR_NOOP("Logo"),
-                1,
-                VF_MISC,
-                QT_TR_NOOP("Add a png as logo."));
-//********** Register chunk ************
-//***********************************
-char *ADMVideoLogo::printConf() 
-{
-	ADM_FILTER_DECLARE_CONF("Logo at %u %u, alpha %u",_param->x,_param->y);
-}
-
-
-uint8_t ADMVideoLogo::configure(AVDMGenericVideoStream * instream)
-{
-#define PX(x) &(_param->x)
-	   diaElemFile       file(0,(char **)PX(image),QT_TR_NOOP("_Logo (jpg file):"), NULL, QT_TR_NOOP("Select JPEG file"));
-	   diaElemUInteger   positionX(PX(x),QT_TR_NOOP("_X Position:"),0,_info.width);
-	   diaElemUInteger   positionY(PX(y),QT_TR_NOOP("_Y Position:"),0,_info.height);
-	   diaElemUInteger   alpha(PX(alpha),QT_TR_NOOP("_Alpha:"),0,255);
-	    
-	   diaElem *elems[4]={&file,&positionX,&positionY,&alpha};
-	  
-	   if( diaFactoryRun(QT_TR_NOOP("Logo"),4,elems))
-	   {
-		   init();
-		   return 1;
-	   }
-	   return 0;
-}
-
-//_______________________________________________________________
-
-ADMVideoLogo::ADMVideoLogo(AVDMGenericVideoStream *in, CONFcouple *couples) 
-{
-        _in=in;		
-        memcpy(&_info,_in->getInfo(),sizeof(_info));
-        _param = new PARAM_LOGO;
-        ADM_assert(_param);
-        
-        
-        if(couples) {
-        
-                GET(image)
-                GET(x)
-                GET(y)
-                GET(alpha)
-        }	
-        else {
-        	 		_param->image=ADM_strdup("/work/samples/r01.jpg");
-        	 		_param->x=0;
-        	 		_param->y=0;
-        	 		_param->alpha=255;
-        }
-        _image=NULL;
-        _inited=init();
-        
-        
-        _info.encoding=1;
-
-}
-// **********************************
-uint8_t ADMVideoLogo::init(void)
-{
-		cleanup();
-		_image=createImageFromFile(_param->image);
-		if(_image) return 1;
-        return 0;
-} 
-// **********************************
-uint8_t ADMVideoLogo::cleanup(void)
-{
-	if(_image) delete _image;
-	_image=NULL;
-	
-	return 1;
-} 
-
-//*******************************************
-ADMVideoLogo::~ADMVideoLogo() 
-{
-    
-      
-      if(_param) 
-      {
-    	 if(_param->image) delete _param->image;
-    	 _param->image=NULL;
-    	 delete _param;
-    	 _param=NULL;
-      }
-      cleanup();
-
-}
-//*******************************************
-uint8_t ADMVideoLogo::getFrameNumberNoAlloc(uint32_t frame, uint32_t *len, ADMImage *data, uint32_t *flags) 
-{
-       
-
-        if(frame>=_info.nb_frames)
-        {
-          printf("[Logo] out of bound %u/%u\n",frame,_info.nb_frames); 
-          return 0;
-        }
-        ADM_assert(_param);
-
-        if(!_in->getFrameNumberNoAlloc(frame, len, data, flags))
-                return 0;
-
-        if(!_image)
-        {
-        	printf("[LOGO] No image to put\n");
-        	return 1;
-        }
-        // No alpha ATM
-        _image->copyToAlpha(data,_param->x,_param->y,_param->alpha);
-        return 1;
-}
-
-uint8_t	ADMVideoLogo::getCoupledConf(CONFcouple **couples) 
-{
-        *couples=new CONFcouple(4);
-
-#define COUPLE_SET(x) (*couples)->setCouple((char *)#x,(_param->x));
-        COUPLE_SET(image)
-        COUPLE_SET(x)
-        COUPLE_SET(y)
-        COUPLE_SET(alpha)
-        return 1;
-}
-/************************************************/
-//EOF

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Logo/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Logo/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Logo/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,9 +0,0 @@
-INCLUDE(vf_plugin)
-
-
-SET(ADM_vf_logo_SRCS ADM_vidLogo.cpp)
-
-ADD_LIBRARY(ADM_vf_logo SHARED ${ADM_vf_logo_SRCS})
-
-INIT_VIDEOFILTER_PLUGIN(ADM_vf_logo)
-INSTALL_VIDEOFILTER(ADM_vf_logo)

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3D.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3D.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3D.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,350 +0,0 @@
-/***************************************************************************
-                          ADM_vidMPLD3D.cpp  -  description
-                             -------------------
-Mplayer HQDenoise3d port to avidemux2
-Original Authors
-Copyright (C) 2003
-Daniel Moreno <comac at comac.darktech.org>
-	& A'rpi
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include <math.h>
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-
-#include "ADM_vidMPLD3D.h"
-
-
-#include "DIA_factory.h"
-static FILTER_PARAM mp3Param={3,{"param1","param2","param3"}};
-#define aprintf(...) {}
-//********** Register chunk ************
-VF_DEFINE_FILTER(ADMVideoMPD3D,mp3Param,
-                mphqdenoise3d,
-                QT_TR_NOOP("MPlayer hqdn3d"),
-                1,
-                VF_NOISE,
-                QT_TR_NOOP("High quality version of denoise3d. Slower but more precise."));
-
-#define PARAM1_DEFAULT 4.0
-#define PARAM2_DEFAULT 3.0
-#define PARAM3_DEFAULT 6.0
-
- char 	*ADMVideoMPD3D::printConf(void)
- {
-	  ADM_FILTER_DECLARE_CONF(" MPlayer HQ Denoise 3D (%2.1f - %2.1f - %2.1f)'",
-						_param->param1,_param->param2,_param->param3);
-        
-}
-
-uint8_t ADMVideoMPD3D::configure(AVDMGenericVideoStream *instream)
-{
-
-        _in=instream;
-        ELEM_TYPE_FLOAT fluma,fchroma,ftemporal;
-#define PX(x) &x
-#define OOP(x,y) f##x=(ELEM_TYPE_FLOAT )_param->y;
-        
-        OOP(luma,param1);
-        OOP(chroma,param2);
-        OOP(temporal,param3);
-        
-    diaElemFloat   luma(PX(fluma),QT_TR_NOOP("_Spatial luma strength:"),0.,100.);
-    diaElemFloat   chroma(PX(fchroma),QT_TR_NOOP("S_patial chroma strength:"),0.,100.);
-    diaElemFloat   temporal(PX(ftemporal),QT_TR_NOOP("_Temporal strength:"),0.,100.);
-    
-       diaElem *elems[3]={&luma,&chroma,&temporal};
-  
-   if(  diaFactoryRun(QT_TR_NOOP("MPlayer hqdn3d"),3,elems))
-        {
-#undef OOP
-#define OOP(x,y) _param->y=(double) f##x
-                OOP(luma,param1);
-                OOP(chroma,param2);
-                OOP(temporal,param3);
-          
-                setup();
-                return 1;
-        }
-        return 0;}
-ADMVideoMPD3D::~ADMVideoMPD3D()
-{
-
- 	DELETE(_param);
-	if(_uncompressed)
-		delete [] _uncompressed;
-	if(Line)
-		delete [] Line;
-	if(_storage)
-		delete  _storage;
-
-	_storage=NULL;
-	Line=NULL;
-	_uncompressed=NULL;
-}
-
-static inline unsigned int LowPassMul(unsigned int PrevMul, unsigned int CurrMul, int* Coef){
-//    int dMul= (PrevMul&0xFFFFFF)-(CurrMul&0xFFFFFF);
-    int dMul= PrevMul-CurrMul;
-    int d=((dMul+0x10007FF)/(65536/16));
-    return CurrMul + Coef[d];
-}
-
-void ADMVideoMPD3D::deNoise(unsigned char *Frame,        // mpi->planes[x]
-                    unsigned char *FrameDest,    // dmpi->planes[x]
-                   uint32_t 		 *LineAnt,      // vf->priv->Line (width bytes)
-		    unsigned short 	*FrameAntPtr,
-                    int W, int H, int sStride, int dStride,
-                    int *Horizontal, int *Vertical, int *Temporal)
-{
-    int X, Y;
-    int sLineOffs = 0, dLineOffs = 0;
-    unsigned int PixelAnt;
-    int PixelDst;
-    unsigned short* FrameAnt=(FrameAntPtr);
-    
-
-    /* First pixel has no left nor top neightbour. Only previous frame */
-    LineAnt[0] = PixelAnt = Frame[0]<<16;
-    PixelDst = LowPassMul(FrameAnt[0]<<8, PixelAnt, Temporal);
-    FrameAnt[0] = ((PixelDst+0x1000007F)/256);
-    FrameDest[0]= ((PixelDst+0x10007FFF)/65536);
-
-    /* Fist line has no top neightbour. Only left one for each pixel and
-     * last frame */
-    for (X = 1; X < W; X++){
-        LineAnt[X] = PixelAnt = LowPassMul(PixelAnt, Frame[X]<<16, Horizontal);
-        PixelDst = LowPassMul(FrameAnt[X]<<8, PixelAnt, Temporal);
-	FrameAnt[X] = ((PixelDst+0x1000007F)/256);
-	FrameDest[X]= ((PixelDst+0x10007FFF)/65536);
-    }
-
-    for (Y = 1; Y < H; Y++){
-	unsigned int PixelAnt;
-	unsigned short* LinePrev=&FrameAnt[Y*W];
-	sLineOffs += sStride, dLineOffs += dStride;
-        /* First pixel on each line doesn't have previous pixel */
-        PixelAnt = Frame[sLineOffs]<<16;
-        LineAnt[0] = LowPassMul(LineAnt[0], PixelAnt, Vertical);
-	PixelDst = LowPassMul(LinePrev[0]<<8, LineAnt[0], Temporal);
-	LinePrev[0] = ((PixelDst+0x1000007F)/256);
-	FrameDest[dLineOffs]= ((PixelDst+0x10007FFF)/65536);
-
-        for (X = 1; X < W; X++){
-	    int PixelDst;
-            /* The rest are normal */
-            PixelAnt = LowPassMul(PixelAnt, Frame[sLineOffs+X]<<16, Horizontal);
-            LineAnt[X] = LowPassMul(LineAnt[X], PixelAnt, Vertical);
-	    PixelDst = LowPassMul(LinePrev[X]<<8, LineAnt[X], Temporal);
-	    LinePrev[X] = ((PixelDst+0x1000007F)/256);
-	    FrameDest[dLineOffs+X]= ((PixelDst+0x10007FFF)/65536);
-        }
-    }
-}
-
-
-uint8_t  ADMVideoMPD3D::setup(void)
-{
- double LumSpac, LumTmp, ChromSpac, ChromTmp;
-
-        LumSpac = _param->param1;
-        LumTmp = _param->param3;
-
-        ChromSpac = _param->param2;
-        ChromTmp = LumTmp * ChromSpac / LumSpac;
-
-        PrecalcCoefs((int *)Coefs[0], LumSpac);
-        PrecalcCoefs((int *)Coefs[1], LumTmp);
-        PrecalcCoefs((int *)Coefs[2], ChromSpac);
-        PrecalcCoefs((int *)Coefs[3], ChromTmp);
-
-	aprintf("\n Param : %lf %lf %lf \n",
-		_param->param1,
-		_param->param2,
-		_param->param3);
-
-	return 1;
-}
-//--------------------------------------------------------
-ADMVideoMPD3D::ADMVideoMPD3D(AVDMGenericVideoStream *in,CONFcouple *couples)
-
-{
-  //uint32_t frame;
-  _storage=NULL;
-  _uncompressed=NULL;
-  Line=NULL;
-
-  _in=in;
-
-  Line=new uint32_t[in->getInfo()->width];
-  memcpy(&_info,in->getInfo(),sizeof(_info));
-  _info.encoding=1;
-  if(couples)
-  {
-			_param=NEW(MPD3D_PARAM);
-			GET(param1);
-			GET(param2);
-			GET(param3);
-	}
-	else
-	{
-			_param=NEW( MPD3D_PARAM);
-			_param->param1=PARAM1_DEFAULT;
-			_param->param2=PARAM2_DEFAULT;
-			_param->param3=PARAM3_DEFAULT;
-	}
-	_uncompressed=new uint16_t[(_info.width*_info.height*3)>>1];
-	_storage=new ADMImage(_info.width,_info.height);
-	setup();
-
-	_last=0xFFFFFFF;
-}
-
-
-uint8_t	ADMVideoMPD3D::getCoupledConf( CONFcouple **couples)
-{
-
-			ADM_assert(_param);
-			*couples=new CONFcouple(3);
- 			//(*couples)->setCouple((char *)"param",*_param);
-#define CSET(x)  (*couples)->setCouple((char *)#x,(_param->x))
-			CSET(param1);
-			CSET(param2);
-			CSET(param3);
-			return 1;
-
-}
-//                     1
-//		Get in range in 121 + coeff matrix
-//                     1
-//
-// If the value is too far away we ignore it
-// else we blend
-
-uint8_t ADMVideoMPD3D::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-UNUSED_ARG(flags);
-
-	int cw= _info.width>>1;
-	int ch= _info.height>>1;
-        int W = _info.width;
-	int H  = _info.height;
-	uint32_t dlen,dflags;
-
-  		if(frame> _info.nb_frames-1) return 0;
-		*len=(W*H*3)>>1;
-		// First and last frame we don"t modify.
-		if(!frame || (frame!=_last+1))
-			{
-					 if(!_in->getFrameNumberNoAlloc(frame, &dlen,data,&dflags))
-					 {
-					 	return 0;
-					}
-				 	unsigned short* dst=_uncompressed;
-	    				unsigned char* src=YPLANE(data);
-					for (int Y = 0; Y < W*H; Y++)
-						{
-	    						 	*(dst++)=*(src++)<<8;
-						}
-					src=UPLANE(data);
-					dst=_uncompressed+(W*H);
-					for (int Y = 0; Y < (W*H)>>2; Y++)
-						{
-	    						 	*(dst++)=*(src++)<<8;
-						}
-					src=VPLANE(data);
-					dst=_uncompressed+((5*W*H)>>2);
-					for (int Y = 0; Y < (W*H)>>2; Y++)
-						{
-	    						 	*(dst++)=*(src++)<<8;
-						}
-					
-					_last=frame;
-					return 1;
-
-			}
-		ADM_assert(frame<_info.nb_frames);
-		// read uncompressed frame
-		// else we fill previous/current/next
-		if(!_in->getFrameNumberNoAlloc(frame, &dlen,_storage,&dflags))
-		{
-			return 0;
-		}
-
-		uint8_t *c,*n;
-		unsigned short *ant;
-
-		ant=(_uncompressed);
-		n=YPLANE(data);
-		c=YPLANE(_storage);
-//
-   		deNoise(c, n,
-			Line,ant, W, H,
-                	W,W,
-                	(int *)Coefs[0],
-                	(int *)Coefs[0],
-                	(int *)Coefs[1]);
-
-
-		ant=(_uncompressed)+W*H;
-		n=UPLANE(data);
-		c=UPLANE(_storage);
-
-		deNoise(c, n,
-			Line, ant, cw, ch,
-                	cw,cw,
-                	(int *)Coefs[2],
-                	(int *)Coefs[2],
-                	(int *)Coefs[3]);
-
-
-		ant=_uncompressed+((W*H*5)>>2);
-		n=VPLANE(data);
-		c=VPLANE(_storage);
-
-		deNoise(c, n,
-			Line, ant, cw, ch,
-                	cw,cw,
-                	(int *)Coefs[2],
-                	(int *)Coefs[2],
-                	(int *)Coefs[3]);
-
-	// n is out....
-	_last=frame;
-	data->copyInfo(_storage);
-	return 1;
-
-
-}
-
-#define ABS(A) ( (A) > 0 ? (A) : -(A) )
-
-void ADMVideoMPD3D::PrecalcCoefs(int *Ct, double Dist25)
-{
-    int i;
-    double Gamma, Simil, C;
-
-    Gamma = log(0.25) / log(1.0 - Dist25/255.0 - 0.00001);
-
-    for (i = -256*16; i < 256*16; i++)
-    {
-        Simil = 1.0 - ABS(i) / (16*255.0);
-	C=4096.*(double)i;
-        C *= pow(Simil, Gamma) ;
-       Ct[16*256+i] = (int)((C<0) ? (C-0.5) : (C+0.5));
-    }
-
-}
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3D.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3D.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3D.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,69 +0,0 @@
-/***************************************************************************
-                          ADM_vidMPLD3D.h  -  description
-                             -------------------
-Mplayer HQDenoise3d port to avidemux2
-Original Authors
-Copyright (C) 2003
-Daniel Moreno <comac at comac.darktech.org>
-	& A'rpi
-
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
- 
-#ifndef _D3D__
-#define _D3D__   
-
-typedef struct MPD3D_PARAM
-{
-	double  param1;  // Luma 
-	double  param2;  // Chroma
-	double  param3;  // Temporal
-}MPD3D_PARAM;
-
-class  ADMVideoMPD3D:public AVDMGenericVideoStream
- {
-
- protected:
-
-        			MPD3D_PARAM			*_param;
-
-				int	  					Coefs[4][512*16];
-        			uint32_t					*Line;
-
-				uint16_t				*_uncompressed;
-				ADMImage				*_storage;
-				uint32_t				_last;
-
-				void 	PrecalcCoefs(int *Ct, double Dist25);
-				uint8_t  	setup(void);
-				void 	deNoise(unsigned char *Frame,        // mpi->planes[x]
-                    					unsigned char *FrameDest,    // dmpi->planes[x]
-                    					uint32_t *LineAnt,      // vf->priv->Line (width bytes)
-		    					unsigned short *FrameAntPtr,
-                    					int W, int H, int sStride, int dStride,
-                    					int *Horizontal, int *Vertical, int *Temporal);
-
-
-
- public:
-
-
-						ADMVideoMPD3D(  AVDMGenericVideoStream *in,CONFcouple *setup);
-  						 ~ADMVideoMPD3D();
-		        virtual uint8_t 	getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-   								ADMImage *data,uint32_t *flags);
-
-			virtual uint8_t 	configure( AVDMGenericVideoStream *instream);
-     			virtual char 	*printConf(void);
-			virtual uint8_t 	getCoupledConf( CONFcouple **couples);
-							
- }     ;
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3Dlow.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3Dlow.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3Dlow.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,333 +0,0 @@
-/***************************************************************************
-                          ADM_vidMPLD3D.cpp  -  description
-                             -------------------
-Mplayer HQDenoise3d port to avidemux2
-Original Authors
-Copyright (C) 2003
-Daniel Moreno <comac at comac.darktech.org>
-	& A'rpi
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include <math.h>
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-
-#include "ADM_vidMPLD3Dlow.h"
-
-
-#include "DIA_factory.h"
-#define aprintf(...) {}
-static FILTER_PARAM mp3Param={3,{"param1","param2","param3"}};
-
-//********** Register chunk ************
-VF_DEFINE_FILTER(ADMVideoMPD3Dlow,mp3Param,
-                mpdenoise3d,
-                QT_TR_NOOP("MPlayer denoise3d"),
-                1,
-                VF_NOISE,
-                QT_TR_NOOP("Reduce noise, smooth image, increase compressibility."));
-#define PARAM1_DEFAULT 4.0
-#define PARAM2_DEFAULT 3.0
-#define PARAM3_DEFAULT 6.0
-
- char 	*ADMVideoMPD3Dlow::printConf(void)
- {
-	  ADM_FILTER_DECLARE_CONF(" MPlayer Denoise 3D (%2.1f - %2.1f - %2.1f)'",
-						_param->param1,_param->param2,_param->param3);
-        
-}
-
-uint8_t ADMVideoMPD3Dlow::configure(AVDMGenericVideoStream *instream)
-{
-
-        _in=instream;
-        ELEM_TYPE_FLOAT fluma,fchroma,ftemporal;
-#define PX(x) &x
-#define OOP(x,y) f##x=(ELEM_TYPE_FLOAT )_param->y;
-        
-        OOP(luma,param1);
-        OOP(chroma,param2);
-        OOP(temporal,param3);
-        
-    diaElemFloat   luma(PX(fluma),QT_TR_NOOP("_Spatial luma strength:"),0.,100.);
-    diaElemFloat   chroma(PX(fchroma),QT_TR_NOOP("S_patial chroma strength:"),0.,100.);
-    diaElemFloat   temporal(PX(ftemporal),QT_TR_NOOP("_Temporal strength:"),0.,100.);
-    
-       diaElem *elems[3]={&luma,&chroma,&temporal};
-  
-   if(  diaFactoryRun(QT_TR_NOOP("MPlayer denoise3d"),3,elems))
-        {
-#undef OOP
-#define OOP(x,y) _param->y=(double) f##x
-                OOP(luma,param1);
-                OOP(chroma,param2);
-                OOP(temporal,param3);
-          
-                setup();
-                return 1;
-        }
-        return 0;
-}
-ADMVideoMPD3Dlow::~ADMVideoMPD3Dlow()
-{
-
- 	DELETE(_param);
-	delete  _uncompressed;
-	delete  _stored;
-	delete [] Line;
-	Line=NULL;
-	_param=NULL;
-	_uncompressed=NULL;
-	_stored=NULL;
-}
-
-
-#define LowPass(Prev, Curr, Coef) (Curr + Coef[Prev - Curr])
-
-
-void ADMVideoMPD3Dlow::deNoise(unsigned char *Frame,        // mpi->planes[x]
-                    unsigned char *FramePrev,    // pmpi->planes[x]
-                    unsigned char *FrameDest,    // dmpi->planes[x]
-                    unsigned char *LineAnt,      // vf->priv->Line (width bytes)
-                    int W, int H, int sStride, int pStride, int dStride,
-                    int *Horizontal, int *Vertical, int *Temporal)
-{
-    int X, Y;
-    int sLineOffs = 0, pLineOffs = 0, dLineOffs = 0;
-    unsigned char PixelAnt;
-
-    /* First pixel has no left nor top neightbour. Only previous frame */
-    LineAnt[0] = PixelAnt = Frame[0];
-    FrameDest[0] = LowPass(FramePrev[0], LineAnt[0], Temporal);
-
-    /* Fist line has no top neightbour. Only left one for each pixel and
-     * last frame */
-    for (X = 1; X < W; X++)
-    {
-        PixelAnt = LowPass(PixelAnt, Frame[X], Horizontal);
-        LineAnt[X] = PixelAnt;
-        FrameDest[X] = LowPass(FramePrev[X], LineAnt[X], Temporal);
-    }
-
-    for (Y = 1; Y < H; Y++)
-    {
-	sLineOffs += sStride, pLineOffs += pStride, dLineOffs += dStride;
-        /* First pixel on each line doesn't have previous pixel */
-        PixelAnt = Frame[sLineOffs];
-        LineAnt[0] = LowPass(LineAnt[0], PixelAnt, Vertical);
-        FrameDest[dLineOffs] = LowPass(FramePrev[pLineOffs], LineAnt[0], Temporal);
-
-        for (X = 1; X < W; X++)
-        {
-            /* The rest are normal */
-            PixelAnt = LowPass(PixelAnt, Frame[sLineOffs+X], Horizontal);
-            LineAnt[X] = LowPass(LineAnt[X], PixelAnt, Vertical);
-            FrameDest[dLineOffs+X] = LowPass(FramePrev[pLineOffs+X], LineAnt[X], Temporal);
-        }
-    }
-}
-
-
-
-uint8_t  ADMVideoMPD3Dlow::setup(void)
-{
- double LumSpac, LumTmp, ChromSpac, ChromTmp;
-
-        LumSpac = _param->param1;
-        LumTmp = _param->param3;
-
-        ChromSpac = _param->param2;
-        ChromTmp = LumTmp * ChromSpac / LumSpac;
-
-        PrecalcCoefs((int *)Coefs[0], LumSpac);
-        PrecalcCoefs((int *)Coefs[1], LumTmp);
-        PrecalcCoefs((int *)Coefs[2], ChromSpac);
-        PrecalcCoefs((int *)Coefs[3], ChromTmp);
-
-	aprintf("\n Param : %lf %lf %lf \n",
-		_param->param1,
-		_param->param2,
-		_param->param3);
-
-	_last=0xFFFFFFF;
-
-	return 1;
-}
-//--------------------------------------------------------
-ADMVideoMPD3Dlow::ADMVideoMPD3Dlow(
-									AVDMGenericVideoStream *in,CONFcouple *couples)
-
-{
-uint32_t page;
-
-  Line=new uint8_t [in->getInfo()->width];
-  memcpy(&_info,in->getInfo(),sizeof(_info));
-
-	page=_info.width*_info.height;
-
- // _stored=new uint8_t[(page*3)>>1];
- // _uncompressed=new uint8_t[ (page*3)>>1];
- 	_stored=new ADMImage(_info.width,_info.height);
-	_uncompressed=new ADMImage(_info.width,_info.height);
-
-  _info.encoding=1;
-  _in=in;
-  if(couples)
-  {
-			_param=NEW(MPD3D_PARAM);
-			GET(param1);
-			GET(param2);
-			GET(param3);
-	}
-	else
-	{
-			_param=NEW( MPD3D_PARAM);
-			_param->param1=PARAM1_DEFAULT;
-			_param->param2=PARAM2_DEFAULT;
-			_param->param3=PARAM3_DEFAULT;
-	}
-	setup();
-
-}
-
-
-uint8_t	ADMVideoMPD3Dlow::getCoupledConf( CONFcouple **couples)
-{
-
-			ADM_assert(_param);
-			*couples=new CONFcouple(3);
- 			//(*couples)->setCouple((char *)"param",*_param);
-#define CSET(x)  (*couples)->setCouple((char *)#x,(_param->x))
-			CSET(param1);
-			CSET(param2);
-			CSET(param3);
-			return 1;
-
-}
-//                     1
-//		Get in range in 121 + coeff matrix
-//                     1
-//
-// If the value is too far away we ignore it
-// else we blend
-
-uint8_t ADMVideoMPD3Dlow::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-UNUSED_ARG(flags);
-
-	int cw= _info.width>>1;
-	int ch= _info.height>>1;
-        int W = _info.width;
-	int H  = _info.height;
-	uint32_t dlen,dflags;
-
-  		if(frame> _info.nb_frames-1) return 0;
-		*len=(W*H*3)>>1;
-		// First and last frame we don"t modify.
-		if(!frame || (frame!=_last+1))
-			{
-				aprintf("D3D: First /last frame\n");
-				 if(!_in->getFrameNumberNoAlloc(frame, &dlen,data,&dflags))
-				 {
-					 	return 0;
-				 }
-				// store for future use
-				memcpy(_stored->data,data->data,*len);
-				_last=frame;
-				
-				return 1;
-			}
-			ADM_assert(frame<_info.nb_frames);
-			aprintf("D3D: next frame\n");
-			// read uncompressed frame
-	 		if(!_in->getFrameNumberNoAlloc(frame, &dlen,_uncompressed,&dflags))
-				 {
-					 	return 0;
-				 }
-
-		uint8_t *c,*d,*p;
-
-		d=YPLANE(data);
-		c=YPLANE(_uncompressed);
-		p=YPLANE(_stored);
-//
-
-   	deNoise(c,p, d,
-		Line, W, H,
-                W,W,W,
-               	Coefs[0] + 256,
-                Coefs[0] + 256,
-                Coefs[1] + 256);
-
-	uint32_t page=W*H;
-		d=UPLANE(data);
-		c=UPLANE(_uncompressed);
-		p=UPLANE(_stored);
-
-	deNoise(c,p, d,
-		Line, cw, ch,
-                cw,cw,cw,
-               	Coefs[2] + 256,
-                Coefs[2] + 256,
-                Coefs[3] + 256);
-
-	page=page>>2;		
-		d=VPLANE(data);
-		c=VPLANE(_uncompressed);
-		p=VPLANE(_stored);
-
-	deNoise(c,p, d,
-		Line, cw, ch,
-                cw,cw,cw,
-               	Coefs[2] + 256,
-              	Coefs[2] + 256,
-                Coefs[3] + 256);
-
-
-	_last=frame;
-	memcpy(YPLANE(_stored),YPLANE(data),W*H);
-	memcpy(UPLANE(_stored),UPLANE(data),(W*H)>>2);
-	memcpy(VPLANE(_stored),VPLANE(data),(W*H)>>2);
-	data->copyInfo(_uncompressed);
-	return 1;
-
-
-}
-
-#define ABS(A) ( (A) > 0 ? (A) : -(A) )
-
-void ADMVideoMPD3Dlow::PrecalcCoefs(int *Ct, double Dist25)
-{
- int i;
-    double Gamma, Simil, C;
-    double d;
-    Gamma = log(0.25) / log(1.0 - Dist25/255.0);
-
-    for (i = -256; i <= 255; i++)
-    {
-    	if(i>0) d=(double)i/255.;
-		else d=(double)-i/255.;
-        Simil = 1.0 - d;
-//        Ct[256+i] = lround(pow(Simil, Gamma) * (double)i);
- 	C= (double)i;
-        C *= pow(Simil, Gamma);
-
-  	Ct[256+i] = (int)((C<0) ? (C-0.5) : (C+0.5));
-
-    }
-
-
-}
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3Dlow.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3Dlow.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/ADM_vidMPLD3Dlow.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,65 +0,0 @@
-/***************************************************************************
-                          ADM_vidMPLD3D.h  -  description
-                             -------------------
-Mplayer Denoise3d port to avidemux2
-Original Authors
-Copyright (C) 2003
-Daniel Moreno <comac at comac.darktech.org>
-
-
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef __D3DLOW__
-#define __D3DLOW__
-
-#include "ADM_vidMPLD3D.h"
-
-class  ADMVideoMPD3Dlow:public AVDMGenericVideoStream
- {
-
- protected:
-
-        			MPD3D_PARAM			*_param;
-
-				int				Coefs[4][512];
-        			uint8_t				*Line;
-				ADMImage			*_stored;
-				
-
-
-				uint32_t					_last;
-
-				void 	PrecalcCoefs(int *Ct, double Dist25);
-				uint8_t  	setup(void);
-				void 	deNoise(unsigned char *Frame,        // mpi->planes[x]
-                    						unsigned char *FramePrev,    // pmpi->planes[x]
-                    						unsigned char *FrameDest,    // dmpi->planes[x]
-                    						unsigned char *LineAnt,      // vf->priv->Line (width bytes)
-                    						int W, int H, int sStride, int pStride, int dStride,
-                    						int *Horizontal, int *Vertical, int *Temporal);
-
-
-
- public:
-
-
-						ADMVideoMPD3Dlow(  AVDMGenericVideoStream *in,CONFcouple *setup);
-  						 ~ADMVideoMPD3Dlow();
-		        virtual uint8_t 	getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
- 									ADMImage *data,uint32_t *flags);
-
-			virtual uint8_t 	configure( AVDMGenericVideoStream *instream);
-     			virtual char 		*printConf(void);
-			virtual uint8_t 	getCoupledConf( CONFcouple **couples);
-
- }     ;
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerDenoise3D/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,12 +0,0 @@
-INCLUDE(vf_plugin)
-
-
-SET(ADM_vf_denoise3dhq_SRCS ADM_vidMPLD3D.cpp)
-ADD_LIBRARY(ADM_vf_denoise3dhq SHARED ${ADM_vf_denoise3dhq_SRCS})
-INIT_VIDEOFILTER_PLUGIN(ADM_vf_denoise3dhq)
-INSTALL_VIDEOFILTER(ADM_vf_denoise3dhq)
-
-SET(ADM_vf_denoise3d_SRCS ADM_vidMPLD3Dlow.cpp)
-ADD_LIBRARY(ADM_vf_denoise3d SHARED ${ADM_vf_denoise3d_SRCS})
-INIT_VIDEOFILTER_PLUGIN(ADM_vf_denoise3d)
-INSTALL_VIDEOFILTER(ADM_vf_denoise3d)

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/ADM_vidMPLResize.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/ADM_vidMPLResize.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/ADM_vidMPLResize.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,338 +0,0 @@
-/***************************************************************************
-                          ADM_MPLvidResize.cpp  -  description
-                             -------------------
-
-			     Wrapper for Mplayer resizer by Michael Niedermayer
-			     See swscale* for the actual resizing code.
-
-
-    begin                : Thu Apr 16 2003
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include "ADM_default.h"
-#include "DIA_coreToolkit.h"
-#include "ADM_videoFilterDynamic.h"
-
-
-
-extern "C" {
-#include "ADM_libraries/ADM_ffmpeg/ADM_lavcodec/avcodec.h"
-#include "ADM_libraries/ADM_ffmpeg/ADM_lavutil/avutil.h"
-#include "ADM_libraries/ADM_ffmpeg/ADM_libswscale/swscale.h"
-}
-
-typedef struct alg
-{
-					int in;
-					char *name;
-}alg;
-#define DECLARE(y) {SWS_##y,(char *)#y}
-
-/**
-	Convert mplayer-resize numbering <--> avidemux one
-
-*/
-alg algs[]={
-				DECLARE(BILINEAR),
-				DECLARE(BICUBIC),
-				DECLARE(LANCZOS)
-		};
-
-
-
-
-class  AVDMVideoStreamMPResize:public AVDMGenericVideoStream
- {
-
- protected:
-				RESIZE_PARAMS 	*_param;
-				SwsContext	*_context;
-				uint8_t 	reset(uint32_t nw, uint32_t old,uint32_t algo);
-				uint8_t		clean( void );
- public:
-
-  				AVDMVideoStreamMPResize(  AVDMGenericVideoStream *in,CONFcouple *setup);
-				AVDMVideoStreamMPResize(	AVDMGenericVideoStream *in,uint32_t x,uint32_t y);
-  				virtual 		~AVDMVideoStreamMPResize();
-          virtual 		uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-          							ADMImage *data,uint32_t *flags);
-				uint8_t configure( AVDMGenericVideoStream *instream);
-	virtual 		char 	*printConf(void) ;
-
-          virtual uint8_t	getCoupledConf( CONFcouple **couples);
-
-
- }     ;
-static FILTER_PARAM mpresizeParam={3,{"w","h","algo"}};
-
-    
-
-//********** Register chunk ************
-VF_DEFINE_FILTER_UI(AVDMVideoStreamMPResize,mpresizeParam,
-                mpresize,
-                QT_TR_NOOP("MPlayer resize"),
-                1,
-                VF_TRANSFORM,
-                QT_TR_NOOP("Change image size. Faster than Avisynth's Resize."));
-//****************************************
-static int getResizeParams(uint32_t * w, uint32_t * h, uint32_t * algo,uint32_t ow,uint32_t oh,uint32_t fps);
-extern uint8_t DIA_resize(uint32_t *width,uint32_t *height,uint32_t *alg,uint32_t originalw, uint32_t originalh,uint32_t fps1000);
-
-uint8_t AVDMVideoStreamMPResize::configure(AVDMGenericVideoStream * instream)
-{
-    UNUSED_ARG(instream);
-
-    RESIZE_PARAMS *par;
-//    uint8_t ret=0;
-
-
-    par = _param;
-
-
-
-    if (!getResizeParams(&par->w, &par->h, &par->algo,instream->getInfo()->width,instream->getInfo()->height,
-    				_info.fps1000))
-      {
-	  return 0;
-      }
-      printf("\n OK was selected \n");
-    // update other parameters
-    _info.width = _param->w;
-    _info.height = _param->h;
-	// do update the filter
-	reset(_param->w,_param->h,_param->algo);
-    return 1;
-
-}
-
-//
-//  
-//
-
-int getResizeParams(uint32_t * w, uint32_t * h, uint32_t * algo,uint32_t ow,uint32_t oh,uint32_t fps)
-{
-uint32_t ww,hh;
-	while(1)
-	{
-		ww=*w;
-		hh=*h;
-  		if(!DIA_resize(&ww,&hh,algo,ow,oh,fps)) return 0;
-                if(!ww || !hh) GUI_Error_HIG(QT_TR_NOOP("Width and height cannot be 0"), NULL);
-		else
-                  if( ww&1 || hh &1) GUI_Error_HIG(QT_TR_NOOP("Width and height cannot be odd"), NULL);
-			else
-			{
-				*w=ww;
-				*h=hh;
-				return 1;
-			}
-	}
-}
-uint8_t AVDMVideoStreamMPResize::clean(void)
-{
-		if(_context)
-		{
-			sws_freeContext(_context);
-		}
-		_context=NULL;
-		return 1;
-}
-
-uint8_t AVDMVideoStreamMPResize::reset(uint32_t nw, uint32_t old,uint32_t algo)
-{
- 				 SwsFilter 		    *srcFilter=NULL;
-				 SwsFilter		    *dstFilter=NULL;
-				 int 			   flags=0;
-
-
-				clean();
-
-				 // swsGetFlagsAndFilterFromCmdLine(&flags, &srcFilter, &dstFilter);
-
-//SwsContext *getSwsContextFromCmdLine(int srcW, int srcH, int srcFormat, int dstW, int dstH, int dstFormat);
-
-					flags=algo;
-					switch(flags)
-					{
-						case 0: //bilinear
-								flags=SWS_BILINEAR;break;
-						case 1: //bicubic
-								flags=SWS_BICUBIC;break;
-						case 2: //Lanczos
-								flags=SWS_LANCZOS;break;
-						default:ADM_assert(0);
-
-					}
-#ifdef ADM_CPU_X86		
-		#define ADD(x,y) if( CpuCaps::has##x()) flags|=SWS_CPU_CAPS_##y;
-		ADD(MMX,MMX);		
-		ADD(3DNOW,3DNOW);
-		ADD(MMXEXT,MMX2);
-#endif	
-#ifdef ADM_CPU_ALTIVEC
-		flags|=SWS_CPU_CAPS_ALTIVEC;
-#endif
-				    _context=sws_getContext(
-				    		_in->getInfo()->width,_in->getInfo()->height,
-						PIX_FMT_YUV420P,
-		 				nw,old,
-	   					PIX_FMT_YUV420P,
-	    					flags, srcFilter, dstFilter,NULL);
-
-				if(!_context) return 0;
-				return 1;
-
-
-}
-char *AVDMVideoStreamMPResize::printConf( void )
-{
- 	ADM_FILTER_DECLARE_CONF(" MPL Resize %lu x %lu --> %lu x %lu (%s)",
- 				_in->getInfo()->width,
- 				_in->getInfo()->height,
- 				_info.width,
- 				_info.height,
-				algs[_param->algo].name);
-        
-}
-//_______________________________________________________________
-AVDMVideoStreamMPResize::AVDMVideoStreamMPResize(
-									AVDMGenericVideoStream *in,CONFcouple *couples)
-{
-
-  	_in=in;
-   	memcpy(&_info,_in->getInfo(),sizeof(_info));
-	//_uncompressed=(uint8_t *)malloc(3*_info.width*_info.height);
-//	_uncompressed=new uint8_t[3*_info.width*_info.height];
-	_uncompressed=new ADMImage(_info.width,_info.height);
-
-		if(couples)
-		{
-			 _param=NEW(RESIZE_PARAMS);
-			GET(w);
-			GET(h);
-			GET(algo);
-			_info.width=_param->w;
-			_info.height=_param->h;
-
-		}
-			else
-			{
-				_param=NEW( RESIZE_PARAMS);
-				_param->w=_info.width;
-				_param->h = _info.height;
-			    _param->algo = 0;
-			}
-
-	_context=NULL;
-	reset(_param->w,_param->h,_param->algo);
-  _info.encoding=1;
-
-}
-#ifdef MPLAYER_RESIZE_PREFFERED
-AVDMGenericVideoStream *createResizeFromParam(AVDMGenericVideoStream *in,uint32_t x,uint32_t y)
-{
-
-	return new AVDMVideoStreamMPResize(in,x,y);
-}
-#endif
-AVDMVideoStreamMPResize::AVDMVideoStreamMPResize(
-									AVDMGenericVideoStream *in,uint32_t x,uint32_t y)
-{
-
-  	_in=in;
-   	memcpy(&_info,_in->getInfo(),sizeof(_info));
-	_uncompressed=new ADMImage(_info.width,_info.height);
-	_param=NEW( RESIZE_PARAMS);
-	_param->w=x;
-	_param->h = y;
-	_info.width=_param->w;
-	_info.height=_param->h;
-	_param->algo = 0;
-
-	_context=NULL;
-	reset(_param->w,_param->h,_param->algo);
-
-}
-
-uint8_t	AVDMVideoStreamMPResize::getCoupledConf( CONFcouple **couples)
-{
-
-			ADM_assert(_param);
-			*couples=new CONFcouple(3);
-
-#define CSET(x)  (*couples)->setCouple((char *)#x,(_param->x))
-	CSET(w);
-	CSET(h);
-	CSET(algo);
-			return 1;
-
-}
-// ___ destructor_____________
-AVDMVideoStreamMPResize::~AVDMVideoStreamMPResize()
-{
- 	delete  _uncompressed;
-	_uncompressed=NULL;
-
-	DELETE(_param);
-	clean();
-
-}
-
-//
-//	Basically ask a uncompressed frame from editor and ask
-//		GUI to decompress it .
-//
-
-uint8_t AVDMVideoStreamMPResize::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-			if(frame>=_info.nb_frames) 
-			{
-				printf("Filter : out of bound!\n");
-				return 0;
-			}
-	
-			ADM_assert(_param);
-
-       			if(!_in->getFrameNumberNoAlloc(frame, len,_uncompressed,flags)) return 0;
-
-			uint8_t *src[3];
-			uint8_t *dst[3];
-			int ssrc[3];
-			int ddst[3];
-
-			uint32_t page;
-
-			page=_in->getInfo()->width*_in->getInfo()->height;
-			src[0]=YPLANE(_uncompressed);
-			src[1]=UPLANE(_uncompressed);
-			src[2]=VPLANE(_uncompressed);
-
-			ssrc[0]=_in->getInfo()->width;
-			ssrc[1]=ssrc[2]=_in->getInfo()->width>>1;
-
-			page=_info.width*_info.height;
-			dst[0]=YPLANE(data);
-			dst[1]=UPLANE(data);
-			dst[2]=VPLANE(data);
-			ddst[0]=_info.width;
-			ddst[1]=ddst[2]=_info.width>>1;
-
-			sws_scale(_context,src,ssrc,0,_in->getInfo()->height,dst,ddst);
-			data->copyInfo(_uncompressed);
-	return 1;
-}
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,24 +0,0 @@
-INCLUDE(vf_plugin)
-
-SET(resizeCommon_SRCS ADM_vidMPLResize.cpp)
-SET(resizeCommonGtk_SRCS gtk/gtk_resize.cpp)
-SET(resizeCommonQT_SRCS qt4/Q_resize.cpp)
-SET(resizeCommonQT_Headers qt4/Q_resize.h)
-SET(resizeCommonQT_UI qt4/resizing)
-
-INCLUDE_DIRECTORIES("${AVIDEMUX_SOURCE_DIR}/avidemux/")
-#INCLUDE_DIRECTORIES("${CMAKE_CURRENT_SOURCE_DIR}/../")
-
-INCLUDE(vf_plugin_gtk)
-INIT_VIDEOFILTER_PLUGIN_GTK(ADM_vf_mplayerResize_gtk ${resizeCommonGtk_SRCS} ${resizeCommon_SRCS})
-
-IF (GTK_FOUND AND GTHREAD_FOUND)
-	TARGET_LINK_LIBRARIES(ADM_vf_mplayerResize_gtk ADM_libswscale ADM_libavcodec ADM_libavutil ADM_UIGtk)
-ENDIF (GTK_FOUND AND GTHREAD_FOUND)
-
-INCLUDE(vf_plugin_qt4)
-INIT_VIDEOFILTER_PLUGIN_QT4(ADM_vf_mplayerResize_qt4 ${resizeCommonQT_SRCS} ${resizeCommonQT_Headers} ${resizeCommonQT_UI} ${resizeCommon_SRCS})
-
-IF (QT4_FOUND)
-	TARGET_LINK_LIBRARIES(ADM_vf_mplayerResize_qt4 ADM_libswscale ADM_libavcodec ADM_libavutil ADM_UIQT4)
-ENDIF (QT4_FOUND)

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/gtk/gtk_resize.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/gtk/gtk_resize.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/gtk/gtk_resize.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,561 +0,0 @@
-/*
-	Resize GUI
-
-*/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include <math.h>
-
-#include "ADM_toolkitGtk.h"
-#include "ADM_default.h"
-#define aprintf(...) {}
-
-#include <gdk/gdkkeysyms.h>
-#include <gtk/gtk.h>
-
-
-#include "ADM_gladeSupport.h"
-
-#define FILL_ENTRY(widget_name,string) 		{r=-1;   \
-gtk_editable_delete_text(GTK_EDITABLE(lookup_widget(dialog,#widget_name)), 0,-1);\
-gtk_editable_insert_text(GTK_EDITABLE(lookup_widget(dialog,#widget_name)), string, strlen(string), &r);}
-#define CHECKBOX(x,y) if(TRUE==gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(lookup_widget(dialog,#x))))  \
-			y=1; else y=0;
-#define READ_ENTRY(widget_name)   gtk_editable_get_chars(GTK_EDITABLE (lookup_widget(dialog,#widget_name)), 0, -1);
-
-#define SPIN_GET(x,y) {y= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(WID(x))) ;}
-#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(x)),(gfloat)y) ;}
-
-
-/*----------------------------------------------*/
-static GtkWidget	*create_dialog1 (void);
-static void drag(GtkButton * button, gpointer user_data);
-static void read (void );
-static void write (void );
-/*----------------------------------------------*/
-static GtkWidget *dialog;
-static uint32_t iw,ih,ow,oh;
-static GtkAdjustment *adj_angle;
-static gint  r;
-static int sar;
-static int dar;
-static int resizeMethod;
-static int roundBool;
-static float erx,ery;
-static double aspectRatio[2][3]={
-								{1.,0.888888,1.19}, // NTSC 1:1 4:3 16:9
-								{1.,1.066667,1.43} // PAL  1:1 4:3 16:9
-							};
-static int pal=1;
-/*----------------------------------------------*/
-uint8_t DIA_resize(uint32_t *width,uint32_t *height,uint32_t *alg,uint32_t originalw, uint32_t originalh,uint32_t fps1000)
-{
-
-
-	char str[100];
-	uint8_t ret=0;
-
-
-	if(fps1000>24600 && fps1000<25400)
-	{
-		aprintf("Pal\n");
-		pal=1;
-	}
-	else
-	{
-		aprintf("NTSC\n");
-		pal=0;
-	}
-
-	ow=originalw;
-	oh=originalh;
-
-	iw=*width;
-	ih=*height;
-	dialog=create_dialog1();
-	//gtk_transient(dialog);
-        gtk_register_dialog(dialog);
-	erx=ery=0;
-
-	double val;
-	val=100.*iw;
-	if(ow) val=val/ow;
-	adj_angle=	gtk_range_get_adjustment (GTK_RANGE(WID(hscale1)));
-	gtk_adjustment_set_value( GTK_ADJUSTMENT(adj_angle),(  gdouble  ) val );
-
-	// remember algo
- 	gtk_option_menu_set_history (GTK_OPTION_MENU (WID(optionmenu1)), *alg);
-
-
-	#define CONNECT(w,x) gtk_signal_connect(GTK_OBJECT(lookup_widget(dialog,#w)), #x, \
-		       GTK_SIGNAL_FUNC(drag), NULL)
-
-		       	CONNECT(hscale1,drag_data_received);
-			CONNECT(hscale1,drag_motion);
-			CONNECT(hscale1,drag_data_get);
-			CONNECT(hscale1,drag_begin);
-
-			gtk_signal_connect(GTK_OBJECT(adj_angle),"value_changed",    GTK_SIGNAL_FUNC(drag), NULL);
-
-	write();
-
-	ret=0;
-	uint8_t stop=0;
-	while(!stop)
-	{
-		switch(gtk_dialog_run(GTK_DIALOG(dialog)))
-		{
-			case GTK_RESPONSE_OK:
-				gchar *s;
-
-                                SPIN_GET(spinbutton_width,*width);
-                                SPIN_GET(spinbutton_height,*height);
-				*alg= getRangeInMenu(lookup_widget(dialog,"optionmenu1"));
-				ret=1;
-				stop=1;
-				break;
-		default:			
-		case GTK_RESPONSE_CANCEL:
-				stop=1;
-				break;
-		case GTK_RESPONSE_APPLY:
-				drag(NULL,NULL);
-				break;
-							
-		}
-
-	}
-        gtk_unregister_dialog(dialog);
-	gtk_widget_destroy(dialog);
-
-	return ret;
-
-}
-/*
-	Called when the hscale is changed
-*/
-void drag(GtkButton * button, gpointer user_data)
-{
-  UNUSED_ARG(button);
-  UNUSED_ARG(user_data);
-
-  double percent;
-  float x,y;
-  float sr_mul,dst_mul;
-
- int32_t xx,yy;
-
-
-
-  percent = GTK_ADJUSTMENT(adj_angle)->value;
-  if(percent<10.0) percent=10.;
-  read();
-
-  aprintf("drag called : %f \n",percent);
-  x=ow;
-  y=oh;
- erx=0;
- ery=0;
-  sr_mul=1.;
-  if(sar)
-  	{  // source is 4/3 or 16/9
-			sr_mul=aspectRatio[pal][sar];
-
-	}
-
-dst_mul=1.;
-  if(dar)
-  	{  // dst is 4/3 or 16/9
-
-			dst_mul=1/aspectRatio[pal][dar];
-	}
-	aprintf("source mul %02.2f , dst mul : %02.2f\n",sr_mul,dst_mul);
-	x=x*sr_mul*dst_mul;
-	y=y;
-
-	// normalize it to recover 100% width
-	y=y/(x/ow);
-	x=ow;
-
-	aprintf("AR:x,y  : %03f %03f \n",x,y);
-
-  	percent/=100.;
-  	x=x*percent;
-  	y=y*percent;
-
-
-	aprintf("AR x,y  : %03f %03f \n",x,y);
-  	xx=(uint32_t)floor(x+0.5);
-	yy=(uint32_t)floor(y+0.5);
-
-	if(xx&1) xx--;
-	if(yy&1) yy--;
-
-
-	if(roundBool)
-	{
-		int32_t ox=xx,oy=yy;
-		xx=(xx +7) & 0xfffff0;
-		yy=(yy +7) & 0xfffff0;
-
-		erx=(xx-ox);
-		erx=erx/xx;
-		ery=(yy-oy);
-		ery=ery/yy;
-
-		aprintf("x: %d -> %d : err %f\n",ox,xx,erx);
-		aprintf("y: %d -> %d : err %f\n",oy,yy,ery);
-	}
-
-	iw=xx;
-	ih=yy;
-	write();
-
-  }
-//---------------------------------------------
-// 	read all value from dialog
-//---------------------------------------------
-void read (void )
-{
-	// Read source and dest aspect ratio
- 	sar=getRangeInMenu(WID(optionmenu_source));
-	dar=getRangeInMenu(WID(optionmenu_dest));
-	// Read resizing method
-	resizeMethod=getRangeInMenu(WID(optionmenu1));
-	// Read round to neareast 16
-	CHECKBOX(checkbutton_16,roundBool);
-
-}
-//---------------------------------------------
-// 	update dialog with new value
-//---------------------------------------------
-
-void write (void )
-{
- char str[100];
-
-        SPIN_SET(spinbutton_width,iw);
-        SPIN_SET(spinbutton_height,ih);
-
-	sprintf(str,"%2.2f",erx*100.);
-	gtk_label_set_text(GTK_LABEL(WID(label_errorx)),str);
-
-	sprintf(str,"%2.2f",ery*100.);
-	gtk_label_set_text(GTK_LABEL(WID(label_errory)),str);
-
-}
-
-//----------------------------
-GtkWidget*
-create_dialog1 (void)
-{
-  GtkWidget *dialog1;
-  GtkWidget *dialog_vbox1;
-  GtkWidget *vbox1;
-  GtkWidget *table2;
-  GtkWidget *label1;
-  GtkWidget *label2;
-  GtkObject *spinbutton_width_adj;
-  GtkWidget *spinbutton_width;
-  GtkObject *spinbutton_height_adj;
-  GtkWidget *spinbutton_height;
-  GtkWidget *label5;
-  GtkWidget *label6;
-  GtkWidget *optionmenu_source;
-  GtkWidget *menu1;
-  GtkWidget *item1_1;
-  GtkWidget *_4_1;
-  GtkWidget *_16_1;
-  GtkWidget *optionmenu_dest;
-  GtkWidget *menu2;
-  GtkWidget *menuitem1;
-  GtkWidget *menuitem2;
-  GtkWidget *menuitem3;
-  GtkWidget *label3;
-  GtkWidget *label_errorx;
-  GtkWidget *label7;
-  GtkWidget *label_errory;
-  GtkWidget *checkbutton_16;
-  GtkWidget *optionmenu1;
-  GtkWidget *menu3;
-  GtkWidget *bilinear1;
-  GtkWidget *bicubic1;
-  GtkWidget *lanczos1;
-  GtkWidget *alignment1;
-  GtkWidget *fixed1;
-  GtkWidget *fixed2;
-  GtkWidget *hscale1;
-  GtkWidget *dialog_action_area1;
-  GtkWidget *cancelbutton1;
-  GtkWidget *applybutton1;
-  GtkWidget *okbutton1;
-
-  dialog1 = gtk_dialog_new ();
-  gtk_window_set_title (GTK_WINDOW (dialog1), QT_TR_NOOP("Resize"));
-  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
-
-  dialog_vbox1 = GTK_DIALOG (dialog1)->vbox;
-  gtk_widget_show (dialog_vbox1);
-
-  vbox1 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox1);
-  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
-
-  table2 = gtk_table_new (4, 4, FALSE);
-  gtk_widget_show (table2);
-  gtk_box_pack_start (GTK_BOX (vbox1), table2, FALSE, FALSE, 0);
-
-  label1 = gtk_label_new (QT_TR_NOOP(" Width "));
-  gtk_widget_show (label1);
-  gtk_table_attach (GTK_TABLE (table2), label1, 0, 1, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label1), 0, 0.5);
-
-  label2 = gtk_label_new (QT_TR_NOOP(" Height "));
-  gtk_widget_show (label2);
-  gtk_table_attach (GTK_TABLE (table2), label2, 0, 1, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label2), 0, 0.5);
-
-  spinbutton_width_adj = gtk_adjustment_new (2, 0, 3000, 1, 10, 10);
-  spinbutton_width = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton_width_adj), 1, 0);
-  gtk_widget_show (spinbutton_width);
-  gtk_table_attach (GTK_TABLE (table2), spinbutton_width, 1, 2, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton_width), TRUE);
-
-  spinbutton_height_adj = gtk_adjustment_new (1, 0, 3000, 1, 10, 10);
-  spinbutton_height = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton_height_adj), 1, 0);
-  gtk_widget_show (spinbutton_height);
-  gtk_table_attach (GTK_TABLE (table2), spinbutton_height, 1, 2, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton_height), TRUE);
-
-  label5 = gtk_label_new (QT_TR_NOOP("Source :"));
-  gtk_widget_show (label5);
-  gtk_table_attach (GTK_TABLE (table2), label5, 2, 3, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  label6 = gtk_label_new (QT_TR_NOOP("Destination"));
-  gtk_widget_show (label6);
-  gtk_table_attach (GTK_TABLE (table2), label6, 2, 3, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  optionmenu_source = gtk_option_menu_new ();
-  gtk_widget_show (optionmenu_source);
-  gtk_table_attach (GTK_TABLE (table2), optionmenu_source, 3, 4, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  menu1 = gtk_menu_new ();
-
-  item1_1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("1:1"));
-  gtk_widget_show (item1_1);
-  gtk_container_add (GTK_CONTAINER (menu1), item1_1);
-
-  _4_1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("4:3"));
-  gtk_widget_show (_4_1);
-  gtk_container_add (GTK_CONTAINER (menu1), _4_1);
-
-  _16_1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("16:9"));
-  gtk_widget_show (_16_1);
-  gtk_container_add (GTK_CONTAINER (menu1), _16_1);
-
-  gtk_option_menu_set_menu (GTK_OPTION_MENU (optionmenu_source), menu1);
-
-  optionmenu_dest = gtk_option_menu_new ();
-  gtk_widget_show (optionmenu_dest);
-  gtk_table_attach (GTK_TABLE (table2), optionmenu_dest, 3, 4, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  menu2 = gtk_menu_new ();
-
-  menuitem1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("1:1"));
-  gtk_widget_show (menuitem1);
-  gtk_container_add (GTK_CONTAINER (menu2), menuitem1);
-
-  menuitem2 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("4:3"));
-  gtk_widget_show (menuitem2);
-  gtk_container_add (GTK_CONTAINER (menu2), menuitem2);
-
-  menuitem3 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("16:9"));
-  gtk_widget_show (menuitem3);
-  gtk_container_add (GTK_CONTAINER (menu2), menuitem3);
-
-  gtk_option_menu_set_menu (GTK_OPTION_MENU (optionmenu_dest), menu2);
-
-  label3 = gtk_label_new (QT_TR_NOOP(" Error X:"));
-  gtk_widget_show (label3);
-  gtk_table_attach (GTK_TABLE (table2), label3, 0, 1, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label3), 0, 0.5);
-
-  label_errorx = gtk_label_new (QT_TR_NOOP("0"));
-  gtk_widget_show (label_errorx);
-  gtk_table_attach (GTK_TABLE (table2), label_errorx, 1, 2, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label_errorx), 0, 0.5);
-
-  label7 = gtk_label_new (QT_TR_NOOP(" Error Y:"));
-  gtk_widget_show (label7);
-  gtk_table_attach (GTK_TABLE (table2), label7, 0, 1, 3, 4,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label7), 0, 0.5);
-
-  label_errory = gtk_label_new (QT_TR_NOOP("0"));
-  gtk_widget_show (label_errory);
-  gtk_table_attach (GTK_TABLE (table2), label_errory, 1, 2, 3, 4,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label_errory), 0, 0.5);
-
-  checkbutton_16 = gtk_check_button_new_with_mnemonic (QT_TR_NOOP("16 round up"));
-  gtk_widget_show (checkbutton_16);
-  gtk_table_attach (GTK_TABLE (table2), checkbutton_16, 3, 4, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  optionmenu1 = gtk_option_menu_new ();
-  gtk_widget_show (optionmenu1);
-  gtk_table_attach (GTK_TABLE (table2), optionmenu1, 3, 4, 3, 4,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  menu3 = gtk_menu_new ();
-
-  bilinear1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("Bilinear"));
-  gtk_widget_show (bilinear1);
-  gtk_container_add (GTK_CONTAINER (menu3), bilinear1);
-
-  bicubic1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("Bicubic"));
-  gtk_widget_show (bicubic1);
-  gtk_container_add (GTK_CONTAINER (menu3), bicubic1);
-
-  lanczos1 = gtk_menu_item_new_with_mnemonic (QT_TR_NOOP("Lanczos3"));
-  gtk_widget_show (lanczos1);
-  gtk_container_add (GTK_CONTAINER (menu3), lanczos1);
-
-  gtk_option_menu_set_menu (GTK_OPTION_MENU (optionmenu1), menu3);
-
-  alignment1 = gtk_alignment_new (0.5, 0.5, 1, 1);
-  gtk_widget_show (alignment1);
-  gtk_table_attach (GTK_TABLE (table2), alignment1, 2, 3, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (GTK_FILL), 0, 0);
-
-  fixed1 = gtk_fixed_new ();
-  gtk_widget_show (fixed1);
-  gtk_container_add (GTK_CONTAINER (alignment1), fixed1);
-
-  fixed2 = gtk_fixed_new ();
-  gtk_widget_show (fixed2);
-  gtk_table_attach (GTK_TABLE (table2), fixed2, 2, 3, 3, 4,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (GTK_FILL), 0, 0);
-
-  hscale1 = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (100, 0, 100, 1, 1, 0)));
-  gtk_widget_show (hscale1);
-  gtk_box_pack_start (GTK_BOX (vbox1), hscale1, FALSE, FALSE, 0);
-  gtk_scale_set_digits (GTK_SCALE (hscale1), 0);
-
-  dialog_action_area1 = GTK_DIALOG (dialog1)->action_area;
-  gtk_widget_show (dialog_action_area1);
-  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
-
-  cancelbutton1 = gtk_button_new_from_stock ("gtk-cancel");
-  gtk_widget_show (cancelbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
-  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
-
-  applybutton1 = gtk_button_new_from_stock ("gtk-apply");
-  gtk_widget_show (applybutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), applybutton1, GTK_RESPONSE_APPLY);
-  GTK_WIDGET_SET_FLAGS (applybutton1, GTK_CAN_DEFAULT);
-
-  okbutton1 = gtk_button_new_from_stock ("gtk-ok");
-  gtk_widget_show (okbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
-  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
-/*
-  g_signal_connect ((gpointer) _4_1, "activate",
-                    G_CALLBACK (on_4_1_activate),
-                    NULL);
-  g_signal_connect ((gpointer) _16_1, "activate",
-                    G_CALLBACK (on_16_1_activate),
-                    NULL);
-  g_signal_connect ((gpointer) menuitem2, "activate",
-                    G_CALLBACK (on_4_1_activate),
-                    NULL);
-  g_signal_connect ((gpointer) menuitem3, "activate",
-                    G_CALLBACK (on_16_1_activate),
-                    NULL);
-  g_signal_connect ((gpointer) bilinear1, "activate",
-                    G_CALLBACK (on_bilinear1_activate),
-                    NULL);
-  g_signal_connect ((gpointer) bicubic1, "activate",
-                    G_CALLBACK (on_bicubic1_activate),
-                    NULL);
-  g_signal_connect ((gpointer) lanczos1, "activate",
-                    G_CALLBACK (on_lanczos1_activate),
-                    NULL);
-*/
-  /* Store pointers to all widgets, for use by lookup_widget(). */
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, "dialog1");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, "dialog_vbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, vbox1, "vbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, table2, "table2");
-  GLADE_HOOKUP_OBJECT (dialog1, label1, "label1");
-  GLADE_HOOKUP_OBJECT (dialog1, label2, "label2");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbutton_width, "spinbutton_width");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbutton_height, "spinbutton_height");
-  GLADE_HOOKUP_OBJECT (dialog1, label5, "label5");
-  GLADE_HOOKUP_OBJECT (dialog1, label6, "label6");
-  GLADE_HOOKUP_OBJECT (dialog1, optionmenu_source, "optionmenu_source");
-  GLADE_HOOKUP_OBJECT (dialog1, menu1, "menu1");
-  GLADE_HOOKUP_OBJECT (dialog1, item1_1, "item1_1");
-  GLADE_HOOKUP_OBJECT (dialog1, _4_1, "_4_1");
-  GLADE_HOOKUP_OBJECT (dialog1, _16_1, "_16_1");
-  GLADE_HOOKUP_OBJECT (dialog1, optionmenu_dest, "optionmenu_dest");
-  GLADE_HOOKUP_OBJECT (dialog1, menu2, "menu2");
-  GLADE_HOOKUP_OBJECT (dialog1, menuitem1, "menuitem1");
-  GLADE_HOOKUP_OBJECT (dialog1, menuitem2, "menuitem2");
-  GLADE_HOOKUP_OBJECT (dialog1, menuitem3, "menuitem3");
-  GLADE_HOOKUP_OBJECT (dialog1, label3, "label3");
-  GLADE_HOOKUP_OBJECT (dialog1, label_errorx, "label_errorx");
-  GLADE_HOOKUP_OBJECT (dialog1, label7, "label7");
-  GLADE_HOOKUP_OBJECT (dialog1, label_errory, "label_errory");
-  GLADE_HOOKUP_OBJECT (dialog1, checkbutton_16, "checkbutton_16");
-  GLADE_HOOKUP_OBJECT (dialog1, optionmenu1, "optionmenu1");
-  GLADE_HOOKUP_OBJECT (dialog1, menu3, "menu3");
-  GLADE_HOOKUP_OBJECT (dialog1, bilinear1, "bilinear1");
-  GLADE_HOOKUP_OBJECT (dialog1, bicubic1, "bicubic1");
-  GLADE_HOOKUP_OBJECT (dialog1, lanczos1, "lanczos1");
-  GLADE_HOOKUP_OBJECT (dialog1, alignment1, "alignment1");
-  GLADE_HOOKUP_OBJECT (dialog1, fixed1, "fixed1");
-  GLADE_HOOKUP_OBJECT (dialog1, fixed2, "fixed2");
-  GLADE_HOOKUP_OBJECT (dialog1, hscale1, "hscale1");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, "dialog_action_area1");
-  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, "cancelbutton1");
-  GLADE_HOOKUP_OBJECT (dialog1, applybutton1, "applybutton1");
-  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, "okbutton1");
-
-  return dialog1;
-}
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/Q_resize.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/Q_resize.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/Q_resize.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,278 +0,0 @@
-/***************************************************************************
-    copyright            : (C) 2001 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include <math.h>
-
-#include "Q_resize.h"
-#include "DIA_coreToolkit.h"
-
-static double aspectRatio[2][3]={
-                              {1.,0.888888,1.19}, // NTSC 1:1 4:3 16:9
-                              {1.,1.066667,1.43} // PAL  1:1 4:3 16:9
-                            };
-#define aprintf
-
-resizeWindow::resizeWindow(resParam *param) : QDialog()
- {
-     ui.setupUi(this);
-	 lastPercentage = 100;
-     _param=param;
-     ui.spinBoxWidth->setValue(_param->width);
-     ui.spinBoxHeight->setValue(_param->height);
-     ui.horizontalSlider->setValue(100);
-     updateWidthHeightSpinners();
-
-	 connect(ui.comboBoxSource, SIGNAL(currentIndexChanged(int)), this, SLOT(aspectRatioChanged(int)));
-	 connect(ui.comboBoxDestination, SIGNAL(currentIndexChanged(int)), this, SLOT(aspectRatioChanged(int)));
-	 connect(ui.checkBoxRoundup, SIGNAL(toggled(bool)), this, SLOT(roundupToggled(bool)));
-	 connect(ui.lockArCheckBox, SIGNAL(toggled(bool)), this, SLOT(lockArToggled(bool)));
-	 connect(ui.buttonBox, SIGNAL(accepted()), this, SLOT(okButtonClicked()));
-
-	 connectDimensionControls();
- }
-
- void resizeWindow::gather(void)
- {
-    _param->width=ui.spinBoxWidth->value();
-    _param->height=ui.spinBoxHeight->value();
-    _param->algo=ui.comboBoxAlgo->currentIndex();
- }
- 
- void resizeWindow::sliderChanged(int value)
-{
-	disconnectDimensionControls();
-
-	percentageSpinBoxChanged(value);
-
-	connectDimensionControls();
-}
-
-void resizeWindow::percentageSpinBoxChanged(int value)
-{
-	disconnectDimensionControls();
-
-	if (ui.checkBoxRoundup->isChecked())
-	{
-		if (lastPercentage > value)
-			ui.spinBoxWidth->setValue(ui.spinBoxWidth->value() - 16);
-		else
-			ui.spinBoxWidth->setValue(ui.spinBoxWidth->value() + 16);
-	}
-	else
-	{
-		float width = _param->originalWidth;
-
-		width /= 100.;
-		width *= value;
-
-		ui.spinBoxWidth->setValue(floor(width + 0.5));
-	}
-
-	updateWidthHeightSpinners(false);
-
-	lastPercentage = ui.percentageSpinBox->value();
-
-	connectDimensionControls();
-}
-
-void resizeWindow::widthSpinBoxChanged(int value)
-{
-	disconnectDimensionControls();
-
-	if (ui.lockArCheckBox->isChecked())
-		updateWidthHeightSpinners(false);
-
-	connectDimensionControls();
-}
-
-void resizeWindow::heightSpinBoxChanged(int value)
-{
-	disconnectDimensionControls();
-
-	if (ui.lockArCheckBox->isChecked())
-		updateWidthHeightSpinners(true);
-
-	connectDimensionControls();
-}
-
-void resizeWindow::aspectRatioChanged(int index)
-{
-	disconnectDimensionControls();
-
-	if (ui.lockArCheckBox->isChecked())
-		updateWidthHeightSpinners();
-
-	connectDimensionControls();
-}
-
-void resizeWindow::disconnectDimensionControls()
-{
-	disconnect(ui.spinBoxHeight, SIGNAL(valueChanged(int)), this, SLOT(heightSpinBoxChanged(int)));
-	disconnect(ui.spinBoxWidth, SIGNAL(valueChanged(int)), this, SLOT(widthSpinBoxChanged(int)));
-	disconnect(ui.horizontalSlider, SIGNAL(valueChanged(int)), this, SLOT(sliderChanged(int)));
-	disconnect(ui.percentageSpinBox, SIGNAL(valueChanged(int)), this, SLOT(percentageSpinBoxChanged(int)));
-}
-
-void resizeWindow::connectDimensionControls()
-{
-	connect(ui.spinBoxHeight, SIGNAL(valueChanged(int)), this, SLOT(heightSpinBoxChanged(int)));
-	connect(ui.spinBoxWidth, SIGNAL(valueChanged(int)), this, SLOT(widthSpinBoxChanged(int)));
-	connect(ui.horizontalSlider, SIGNAL(valueChanged(int)), this, SLOT(sliderChanged(int)));
-	connect(ui.percentageSpinBox, SIGNAL(valueChanged(int)), this, SLOT(percentageSpinBoxChanged(int)));
-}
-
-void resizeWindow::updateWidthHeightSpinners(bool useHeightAsRef)
-{
-	int sar = ui.comboBoxSource->currentIndex();
-	int dar = ui.comboBoxDestination->currentIndex();
-	float x = ui.spinBoxWidth->value();
-	float y = ui.spinBoxHeight->value();
-	float sr_mul = 1.;
-	float dst_mul = 1.;
-	float ar = 1.;
-
-	if (sar)
-	{  // source is 4/3 or 16/9
-		sr_mul = aspectRatio[_param->pal][sar];
-	}
-
-	if (dar)
-	{  // dst is 4/3 or 16/9
-		dst_mul = 1 / aspectRatio[_param->pal][dar];
-	}
-
-	aprintf("source mul %02.2f , dst mul: %02.2f\n", sr_mul, dst_mul);
-
-	ar = _param->originalWidth / (_param->originalHeight / (sr_mul * dst_mul));
-
-	if (useHeightAsRef)
-		x = y * ar;
-	else
-		y = x / ar;
-
-	aprintf("x, y: %03f, %03f\n", x, y);
-
-	int xx = floor(x + 0.5);
-	int yy = floor(y + 0.5);
-
-	if (xx & 1)
-		xx--;
-
-	if (yy & 1)
-		yy--;
-
-	roundUp(xx, yy);
-	updateSlider();
-}
-
-void resizeWindow::updateSlider()
-{
-	float percent = (((float)ui.spinBoxWidth->value() / (float)_param->originalWidth) * 100.) + 0.5;
-
-	ui.horizontalSlider->setValue(percent);
-	ui.percentageSpinBox->setValue(percent);
-}
-
-void resizeWindow::roundUp(int xx, int yy)
-{
-	float erx = 0.;
-	float ery = 0.;
-
-	if (ui.checkBoxRoundup->checkState())
-	{
-		int ox = xx, oy = yy;
-
-		xx = (xx + 7) & 0xfffff0;
-		yy = (yy + 7) & 0xfffff0;
-
-		erx = xx - ox;
-		erx = erx / xx;
-		ery = yy - oy;
-		ery = ery / yy;
-
-		aprintf("x: %d -> %d : err %f\n", ox, xx, erx);
-		aprintf("y: %d -> %d : err %f\n", oy, yy, ery);
-	}
-
-	ui.spinBoxWidth->setValue(xx);
-	ui.spinBoxHeight->setValue(yy);
-
-	ui.labelErrorXY->setText(QString("%1").arg(erx * 100., 0, 'f', 2) + " / " + QString("%1").arg(ery * 100., 0, 'f', 2));
-}
-
-void resizeWindow::lockArToggled(bool toggled)
-{
-	if (ui.lockArCheckBox->isChecked())
-		widthSpinBoxChanged(0);
-	else
-		ui.checkBoxRoundup->setChecked(false);
-}
-
-void resizeWindow::roundupToggled(bool toggled)
-{
-	if (toggled)
-	{
-		disconnectDimensionControls();
-
-		ui.spinBoxWidth->setSingleStep(16);
-		ui.spinBoxHeight->setSingleStep(16);
-		widthSpinBoxChanged(0);
-
-		connectDimensionControls();
-	}
-	else
-	{
-		ui.spinBoxWidth->setSingleStep(2);
-		ui.spinBoxHeight->setSingleStep(2);
-	}
-}
-
-void resizeWindow::okButtonClicked()
-{
-	if (ui.spinBoxWidth->value() & 1 || ui.spinBoxHeight->value() & 1)
-		GUI_Error_HIG(QT_TR_NOOP("Width and height cannot be odd"), NULL);
-	else
-		accept();
-}
-
-/**
-    \fn DIA_resize
-    \brief Handle resize dialo
-*/
-uint8_t DIA_resize(uint32_t *width,uint32_t *height,uint32_t *alg,uint32_t originalw, uint32_t originalh,uint32_t fps1000)
-{
-uint8_t r=0;
-      resParam param={*width,*height,originalw,originalh,fps1000,*alg,0};
-      //
-      if(fps1000>24600 && fps1000<25400)
-        {
-                param.pal=1;
-        }
-       
-
-     // Fetch info
-     resizeWindow resizewindow(&param) ;
-     ;
-     if(resizewindow.exec()==QDialog::Accepted)
-     {
-       resizewindow.gather();
-       *width=param.width;
-       *height=param.height;
-       *alg=param.algo;
-       r=1;
-     }
-     return r;
-}  
-//********************************************
-//EOF

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/Q_resize.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/Q_resize.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/Q_resize.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,31 +0,0 @@
-#ifndef Q_resizing_h
-#define Q_resizing_h
-
-#include "ui_resizing.h"
-
-typedef struct resParam
-{
-	uint32_t width,height;
-	uint32_t originalWidth, originalHeight;
-	uint32_t fps1000;
-	uint32_t algo;
-	uint32_t pal;
-} resParam;
-
-class resizeWindow : public QDialog
-{
-	Q_OBJECT
-
-protected: 
-	resParam *_param;
-
-public:
-	resizeWindow(resParam *param);
-	~resizeWindow();
-	Ui_resizeDialog ui;
-
-public slots:
-	void gather(void);
-	void update(int i);
-};
-#endif	// Q_resizing_h

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/Q_resize.h.orig
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/Q_resize.h.orig	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/Q_resize.h.orig	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,31 +0,0 @@
-#ifndef Q_resizing_h
-#define Q_resizing_h
-
-#include "ui_resizing.h"
-
-typedef struct resParam
-{
-	uint32_t width,height;
-	uint32_t originalWidth, originalHeight;
-	uint32_t fps1000;
-	uint32_t algo;
-	uint32_t pal;
-} resParam;
-
-class resizeWindow : public QDialog
-{
-	Q_OBJECT
-
-protected: 
-	resParam *_param;
-
-public:
-	resizeWindow(resParam *param);
-	~resizeWindow();
-	Ui_resizeDialog ui;
-
-public slots:
-	void gather(void);
-	void update(int i);
-};
-#endif	// Q_resizing_h

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/resizing.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/resizing.ui	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/MplayerResize/qt4/resizing.ui	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,724 +0,0 @@
-<ui version="4.0" >
- <class>resizeDialog</class>
- <widget class="QDialog" name="resizeDialog" >
-  <property name="geometry" >
-   <rect>
-    <x>0</x>
-    <y>0</y>
-    <width>350</width>
-    <height>342</height>
-   </rect>
-  </property>
-  <property name="windowTitle" >
-   <string>Resize</string>
-  </property>
-  <layout class="QVBoxLayout" >
-   <property name="margin" >
-    <number>9</number>
-   </property>
-   <property name="spacing" >
-    <number>6</number>
-   </property>
-   <item>
-    <widget class="QGroupBox" name="groupBox_2" >
-     <property name="title" >
-      <string>Aspect Ratio</string>
-     </property>
-     <layout class="QVBoxLayout" >
-      <property name="margin" >
-       <number>9</number>
-      </property>
-      <property name="spacing" >
-       <number>6</number>
-      </property>
-      <item>
-       <widget class="QCheckBox" name="lockArCheckBox" >
-        <property name="text" >
-         <string>Lock Aspect Ratio</string>
-        </property>
-        <property name="checked" >
-         <bool>true</bool>
-        </property>
-       </widget>
-      </item>
-      <item>
-       <layout class="QHBoxLayout" >
-        <property name="margin" >
-         <number>0</number>
-        </property>
-        <property name="spacing" >
-         <number>6</number>
-        </property>
-        <item>
-         <widget class="QLabel" name="label_4" >
-          <property name="text" >
-           <string>Source:</string>
-          </property>
-         </widget>
-        </item>
-        <item>
-         <widget class="QComboBox" name="comboBoxSource" >
-          <item>
-           <property name="text" >
-            <string>1:1</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>4:3</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>16:9</string>
-           </property>
-          </item>
-         </widget>
-        </item>
-        <item>
-         <spacer>
-          <property name="orientation" >
-           <enum>Qt::Horizontal</enum>
-          </property>
-          <property name="sizeType" >
-           <enum>QSizePolicy::Fixed</enum>
-          </property>
-          <property name="sizeHint" >
-           <size>
-            <width>30</width>
-            <height>20</height>
-           </size>
-          </property>
-         </spacer>
-        </item>
-        <item>
-         <widget class="QLabel" name="label_3" >
-          <property name="text" >
-           <string>Destination:</string>
-          </property>
-         </widget>
-        </item>
-        <item>
-         <widget class="QComboBox" name="comboBoxDestination" >
-          <item>
-           <property name="text" >
-            <string>1:1</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>4:3</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>16:9</string>
-           </property>
-          </item>
-         </widget>
-        </item>
-        <item>
-         <spacer>
-          <property name="orientation" >
-           <enum>Qt::Horizontal</enum>
-          </property>
-          <property name="sizeHint" >
-           <size>
-            <width>40</width>
-            <height>20</height>
-           </size>
-          </property>
-         </spacer>
-        </item>
-       </layout>
-      </item>
-     </layout>
-    </widget>
-   </item>
-   <item>
-    <widget class="QGroupBox" name="groupBox" >
-     <property name="title" >
-      <string>Resize Dimensions</string>
-     </property>
-     <layout class="QVBoxLayout" >
-      <property name="margin" >
-       <number>9</number>
-      </property>
-      <property name="spacing" >
-       <number>6</number>
-      </property>
-      <item>
-       <layout class="QHBoxLayout" >
-        <property name="margin" >
-         <number>0</number>
-        </property>
-        <property name="spacing" >
-         <number>6</number>
-        </property>
-        <item>
-         <widget class="QLabel" name="label" >
-          <property name="text" >
-           <string>Width:</string>
-          </property>
-         </widget>
-        </item>
-        <item>
-         <widget class="QSpinBox" name="spinBoxWidth" >
-          <property name="maximum" >
-           <number>2900</number>
-          </property>
-          <property name="minimum" >
-           <number>16</number>
-          </property>
-          <property name="singleStep" >
-           <number>2</number>
-          </property>
-         </widget>
-        </item>
-        <item>
-         <spacer>
-          <property name="orientation" >
-           <enum>Qt::Horizontal</enum>
-          </property>
-          <property name="sizeType" >
-           <enum>QSizePolicy::Fixed</enum>
-          </property>
-          <property name="sizeHint" >
-           <size>
-            <width>30</width>
-            <height>20</height>
-           </size>
-          </property>
-         </spacer>
-        </item>
-        <item>
-         <widget class="QLabel" name="label_2" >
-          <property name="text" >
-           <string>Height:</string>
-          </property>
-         </widget>
-        </item>
-        <item>
-         <widget class="QSpinBox" name="spinBoxHeight" >
-          <property name="maximum" >
-           <number>2000</number>
-          </property>
-          <property name="minimum" >
-           <number>16</number>
-          </property>
-          <property name="singleStep" >
-           <number>2</number>
-          </property>
-         </widget>
-        </item>
-        <item>
-         <spacer>
-          <property name="orientation" >
-           <enum>Qt::Horizontal</enum>
-          </property>
-          <property name="sizeHint" >
-           <size>
-            <width>40</width>
-            <height>20</height>
-           </size>
-          </property>
-         </spacer>
-        </item>
-       </layout>
-      </item>
-      <item>
-       <widget class="QCheckBox" name="checkBoxRoundup" >
-        <property name="text" >
-         <string>Round to the Nearest Multiple of 16</string>
-        </property>
-       </widget>
-      </item>
-      <item>
-       <spacer>
-        <property name="orientation" >
-         <enum>Qt::Vertical</enum>
-        </property>
-        <property name="sizeType" >
-         <enum>QSizePolicy::Fixed</enum>
-        </property>
-        <property name="sizeHint" >
-         <size>
-          <width>312</width>
-          <height>4</height>
-         </size>
-        </property>
-       </spacer>
-      </item>
-      <item>
-       <layout class="QVBoxLayout" >
-        <property name="margin" >
-         <number>0</number>
-        </property>
-        <property name="spacing" >
-         <number>6</number>
-        </property>
-        <item>
-         <layout class="QHBoxLayout" >
-          <property name="margin" >
-           <number>0</number>
-          </property>
-          <property name="spacing" >
-           <number>12</number>
-          </property>
-          <item>
-           <layout class="QVBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
-             <number>6</number>
-            </property>
-            <item>
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
-               <number>6</number>
-              </property>
-              <item>
-               <widget class="QLabel" name="label_8" >
-                <property name="text" >
-                 <string>1%</string>
-                </property>
-               </widget>
-              </item>
-              <item>
-               <spacer>
-                <property name="orientation" >
-                 <enum>Qt::Horizontal</enum>
-                </property>
-                <property name="sizeHint" >
-                 <size>
-                  <width>40</width>
-                  <height>20</height>
-                 </size>
-                </property>
-               </spacer>
-              </item>
-              <item>
-               <widget class="QLabel" name="label_5" >
-                <property name="text" >
-                 <string>Percent</string>
-                </property>
-               </widget>
-              </item>
-              <item>
-               <spacer>
-                <property name="orientation" >
-                 <enum>Qt::Horizontal</enum>
-                </property>
-                <property name="sizeHint" >
-                 <size>
-                  <width>40</width>
-                  <height>20</height>
-                 </size>
-                </property>
-               </spacer>
-              </item>
-              <item>
-               <widget class="QLabel" name="label_9" >
-                <property name="text" >
-                 <string>200%</string>
-                </property>
-               </widget>
-              </item>
-             </layout>
-            </item>
-            <item>
-             <widget class="QSlider" name="horizontalSlider" >
-              <property name="minimum" >
-               <number>1</number>
-              </property>
-              <property name="maximum" >
-               <number>200</number>
-              </property>
-              <property name="value" >
-               <number>100</number>
-              </property>
-              <property name="orientation" >
-               <enum>Qt::Horizontal</enum>
-              </property>
-             </widget>
-            </item>
-           </layout>
-          </item>
-          <item>
-           <widget class="QSpinBox" name="percentageSpinBox" >
-            <property name="maximum" >
-             <number>200</number>
-            </property>
-            <property name="minimum" >
-             <number>1</number>
-            </property>
-            <property name="value" >
-             <number>100</number>
-            </property>
-           </widget>
-          </item>
-         </layout>
-        </item>
-        <item>
-         <layout class="QHBoxLayout" >
-          <property name="margin" >
-           <number>0</number>
-          </property>
-          <property name="spacing" >
-           <number>6</number>
-          </property>
-          <item>
-           <widget class="QLabel" name="label_10" >
-            <property name="text" >
-             <string>Error X / Y:</string>
-            </property>
-           </widget>
-          </item>
-          <item>
-           <widget class="QLabel" name="labelErrorXY" >
-            <property name="text" >
-             <string>0.00 / 0.00</string>
-            </property>
-           </widget>
-          </item>
-          <item>
-           <spacer>
-            <property name="orientation" >
-             <enum>Qt::Horizontal</enum>
-            </property>
-            <property name="sizeHint" >
-             <size>
-              <width>40</width>
-              <height>20</height>
-             </size>
-            </property>
-           </spacer>
-          </item>
-         </layout>
-        </item>
-       </layout>
-      </item>
-     </layout>
-    </widget>
-   </item>
-   <item>
-    <spacer>
-     <property name="orientation" >
-      <enum>Qt::Vertical</enum>
-     </property>
-     <property name="sizeType" >
-      <enum>QSizePolicy::Fixed</enum>
-     </property>
-     <property name="sizeHint" >
-      <size>
-       <width>332</width>
-       <height>6</height>
-      </size>
-     </property>
-    </spacer>
-   </item>
-   <item>
-    <layout class="QHBoxLayout" >
-     <property name="margin" >
-      <number>0</number>
-     </property>
-     <property name="spacing" >
-      <number>6</number>
-     </property>
-     <item>
-      <widget class="QLabel" name="label_6" >
-       <property name="text" >
-        <string>Resize Method:</string>
-       </property>
-      </widget>
-     </item>
-     <item>
-      <widget class="QComboBox" name="comboBoxAlgo" >
-       <item>
-        <property name="text" >
-         <string>Bilinear</string>
-        </property>
-       </item>
-       <item>
-        <property name="text" >
-         <string>Bicubic</string>
-        </property>
-       </item>
-       <item>
-        <property name="text" >
-         <string>Lanzcos3</string>
-        </property>
-       </item>
-      </widget>
-     </item>
-     <item>
-      <spacer>
-       <property name="orientation" >
-        <enum>Qt::Horizontal</enum>
-       </property>
-       <property name="sizeHint" >
-        <size>
-         <width>40</width>
-         <height>20</height>
-        </size>
-       </property>
-      </spacer>
-     </item>
-    </layout>
-   </item>
-   <item>
-    <spacer>
-     <property name="orientation" >
-      <enum>Qt::Vertical</enum>
-     </property>
-     <property name="sizeType" >
-      <enum>QSizePolicy::MinimumExpanding</enum>
-     </property>
-     <property name="sizeHint" >
-      <size>
-       <width>20</width>
-       <height>16</height>
-      </size>
-     </property>
-    </spacer>
-   </item>
-   <item>
-    <widget class="QDialogButtonBox" name="buttonBox" >
-     <property name="orientation" >
-      <enum>Qt::Horizontal</enum>
-     </property>
-     <property name="standardButtons" >
-      <set>QDialogButtonBox::Cancel|QDialogButtonBox::NoButton|QDialogButtonBox::Ok</set>
-     </property>
-    </widget>
-   </item>
-  </layout>
- </widget>
- <tabstops>
-  <tabstop>lockArCheckBox</tabstop>
-  <tabstop>comboBoxSource</tabstop>
-  <tabstop>comboBoxDestination</tabstop>
-  <tabstop>spinBoxWidth</tabstop>
-  <tabstop>spinBoxHeight</tabstop>
-  <tabstop>checkBoxRoundup</tabstop>
-  <tabstop>horizontalSlider</tabstop>
-  <tabstop>percentageSpinBox</tabstop>
-  <tabstop>comboBoxAlgo</tabstop>
-  <tabstop>buttonBox</tabstop>
- </tabstops>
- <resources/>
- <connections>
-  <connection>
-   <sender>buttonBox</sender>
-   <signal>rejected()</signal>
-   <receiver>resizeDialog</receiver>
-   <slot>reject()</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>316</x>
-     <y>260</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>286</x>
-     <y>274</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>label_8</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>184</x>
-     <y>117</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>39</x>
-     <y>148</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>label_5</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>184</x>
-     <y>117</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>150</x>
-     <y>148</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>label_9</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>184</x>
-     <y>117</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>267</x>
-     <y>148</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>horizontalSlider</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>184</x>
-     <y>117</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>156</x>
-     <y>164</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>percentageSpinBox</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>184</x>
-     <y>117</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>317</x>
-     <y>155</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>checkBoxRoundup</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>184</x>
-     <y>95</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>184</x>
-     <y>117</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>label_10</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>182</x>
-     <y>155</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>55</x>
-     <y>251</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>labelErrorXY</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>182</x>
-     <y>155</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>114</x>
-     <y>251</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>label_4</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>182</x>
-     <y>69</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>46</x>
-     <y>95</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>comboBoxSource</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>182</x>
-     <y>69</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>94</x>
-     <y>95</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>label_3</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>182</x>
-     <y>69</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>188</x>
-     <y>95</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
-   <sender>lockArCheckBox</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>comboBoxDestination</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel" >
-     <x>182</x>
-     <y>69</y>
-    </hint>
-    <hint type="destinationlabel" >
-     <x>247</x>
-     <y>95</y>
-    </hint>
-   </hints>
-  </connection>
- </connections>
-</ui>

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/ResampleFps/ADM_vidResampleFPS.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/ResampleFps/ADM_vidResampleFPS.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/ResampleFps/ADM_vidResampleFPS.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,343 +0,0 @@
-/***************************************************************************
-                          Resample fps
-                             -------------------
-    begin                : Wed Nov 6 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include <math.h>
-
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-#include "DIA_enter.h"
-#include "DIA_factory.h"
-
-static FILTER_PARAM ResampParam={2,{"newfps","use_linear"}};
-typedef struct FPS_Param
-{
-  uint32_t  newfps; 
-  uint32_t  use_linear;
-}FPS_Param;
-class  ADMVideoResampleFPS:public AVDMGenericVideoStream
-{
-
-  protected:
-    AVDMGenericVideoStream  *_in;           
-    virtual char            *printConf(void);
-            FPS_Param       *_param;    
-            VideoCache      *vidCache; 
-  public:
-                
-                        ADMVideoResampleFPS(  AVDMGenericVideoStream *in,CONFcouple *setup);
-                        ADMVideoResampleFPS(  AVDMGenericVideoStream *in,uint32_t target1000);
-    virtual             ~ADMVideoResampleFPS();
-    virtual uint8_t     configure(AVDMGenericVideoStream *in);
-    virtual uint8_t     getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-                                          ADMImage *data,uint32_t *flags);
-
-             uint8_t     getCoupledConf( CONFcouple **couples);
-}     ;
-//***********************************
-VF_DEFINE_FILTER(ADMVideoResampleFPS,ResampParam,
-                resamplefps,
-                QT_TR_NOOP("Resample fps"),
-                1,
-                VF_TRANSFORM,
-                QT_TR_NOOP("Change framerate while keeping duration."));
-//***********************************
-
-AVDMGenericVideoStream *createResampleFps(AVDMGenericVideoStream *in,uint32_t targetfps1000)
-{
-  return new ADMVideoResampleFPS(in,targetfps1000);
-}
-
-uint8_t ADMVideoResampleFPS::configure(AVDMGenericVideoStream *in)
-{
-  float f=_param->newfps; 
-  f/=1000;
-  
-  _in=in;
-  
-    diaElemFloat fps(&f,QT_TR_NOOP("_New frame rate:"),1,200.);
-    diaElemToggle blend(&(_param->use_linear),QT_TR_NOOP("_Blend"));
-    
-    diaElem *elems[2]={&fps,&blend};
-  
-    if( diaFactoryRun(QT_TR_NOOP("Resample fps"),2,elems))
-    {
-        f*=1000;
-      _param->newfps=(uint32_t)floor(f+0.4); 
-      _info.fps1000=_param->newfps;
-      return 1;
-    }
-    return 0;
-}
-char *ADMVideoResampleFPS::printConf( void )
-{
- ADM_FILTER_DECLARE_CONF(" Resample to %2.2f fps (blend:%d)",(double)_param->newfps/1000.,
-                _param->use_linear);
-  
-}
-
-ADMVideoResampleFPS::ADMVideoResampleFPS(  AVDMGenericVideoStream *in,uint32_t target)
-{
-
-  _in=in;         
-  memcpy(&_info,_in->getInfo(),sizeof(_info));    
-  _info.encoding=1; 
-  _param=new  FPS_Param;
-   
-    _param->newfps =target;                
-    _param->use_linear=1;
- 
-  double newlength;
-  
-  newlength=_info.nb_frames;
-  newlength/=_info.fps1000;
-  newlength*=_param->newfps;
-  _info.nb_frames=(uint32_t)floor(newlength);
-  _info.fps1000=_param->newfps;
-  printf("[Resample FPS] %u -> %u\n",_in->getInfo()->nb_frames,_info.nb_frames);
-  vidCache=new VideoCache(3,_in);
-
-}
-
-ADMVideoResampleFPS::ADMVideoResampleFPS(  AVDMGenericVideoStream *in,CONFcouple *couples)
-{
-  
-  _in=in;         
-  memcpy(&_info,_in->getInfo(),sizeof(_info));    
-  _info.encoding=1; 
-  _param=new  FPS_Param;
-   
-  if(couples)
-  {                 
-    GET(newfps);    
-    GET(use_linear); 
-  }
-  else
-  {
-    _param->newfps =_info.fps1000;                
-    _param->use_linear=0;
-  }      
- 
-  double newlength;
-  
-  newlength=_info.nb_frames;
-  newlength/=_info.fps1000;
-  newlength*=_param->newfps;
-  _info.nb_frames=(uint32_t)floor(newlength);
-  _info.fps1000=_param->newfps;
-  vidCache=new VideoCache(3,_in);
-  
-}
-ADMVideoResampleFPS::~ADMVideoResampleFPS()
-{
-  delete _param;
-  delete vidCache;
-  
-}
-uint8_t ADMVideoResampleFPS::getCoupledConf( CONFcouple **couples)
-{
-  ADM_assert(_param);
-  *couples=new CONFcouple(2);
-
-
-                CSET(newfps);
-                CSET(use_linear);
-                return 1;
-}
-#ifdef ADM_CPU_X86
-static uint64_t FUNNY_MANGLE(low) , FUNNY_MANGLE(high);
-static void blendMMX(uint8_t *src, uint8_t *src2, uint8_t *dst, uint8_t alpha, uint8_t beta,uint32_t count)
-{
-uint32_t left=count&3;
-#define EXPAND(x) (x)+((x)<<16)+((x)<<32) +((x)<<48)
-        high=alpha;
-        low=beta;
-        high=EXPAND(high);
-        low=EXPAND(low);
-        count>>=2;
-#ifdef GCC_2_95_X
-         __asm__ __volatile__ (
-                                "movq "Mangle(high)", %mm0\n"
-                                "movq "Mangle(low)",  %mm1\n"                                
-                                "pxor %mm7        ,  %mm7\n"
-                                :: );
-#else
-         __asm__ __volatile__ (
-                                "movq "Mangle(high)", %%mm0\n"
-                                "movq "Mangle(low)",  %%mm1\n"                                
-                                "pxor %%mm7        ,  %%mm7\n"
-                                :: );
-#endif
-
-        while(count>0)
-        {
-                __asm__ __volatile__ (
-                               
-                                "movd      (%0),  %%mm2\n"
-                                "movd      (%1),  %%mm3\n"                               
-
-                                "punpcklbw %%mm7, %%mm2\n"
-                                "punpcklbw %%mm7, %%mm3\n"
-
-                                "pmullw   %%mm0, %%mm2\n"
-                                "pmullw   %%mm1, %%mm3\n"
-                
-                                "paddw    %%mm3, %%mm2\n"
-
-                                "psrlw    $8,    %%mm2 \n"
-
-                                "packuswb %%mm2,%%mm2\n"
-                                "movd     %%mm2, (%2)\n"
-
-                                :: "r" (src), "r" (src2), "r" (dst) );
-                                
-                src+=4;
-                src2+=4;
-                dst+=4;
-                count--;
-        }
-        __asm__ __volatile__ (
-                                "emms\n"
-                                :: );
-        for(uint32_t i=0;i<left;i++)
-        {
-                dst[i] = ((src[i]*alpha) + (src2[i]*beta))>>8;
-        }
-}
-
-#endif
-
-uint8_t ADMVideoResampleFPS::getFrameNumberNoAlloc(uint32_t frame,
-                                             uint32_t *len,
-                                             ADMImage *data,
-                                             uint32_t *flags)
-{
-  ADMImage *mysrc1=NULL;
-  ADMImage *mysrc2=NULL;
-
-  if(frame>=_info.nb_frames) return 0;
-  // read uncompressed frame
-  
-  // What frame are we seeking ?
-  double f;
-  uint32_t page=_info.width*_info.height;
-  
-  f=frame;
-  f*=_in->getInfo()->fps1000;
-  f/=_param->newfps;
-  
-  if(!_param->use_linear)
-  {
-      uint32_t nw;
-      
-      nw=(uint32_t)floor(f+0.4);
-      if(nw>_in->getInfo()->nb_frames-1)
-        nw=_in->getInfo()->nb_frames-1;
-    
-      mysrc1=vidCache->getImage(nw);
-      if(!mysrc1) return 0;
-      
-      memcpy(YPLANE(data),YPLANE(mysrc1),page);
-      memcpy(UPLANE(data),UPLANE(mysrc1),page>>2);
-      memcpy(VPLANE(data),VPLANE(mysrc1),page>>2);
-    
-      vidCache->unlockAll();
-      
-      return 1;
-  }
-  /* With linear blending */
-  uint32_t nw;
-  uint8_t lowweight;
-  uint8_t highweight;
-  
-  double diff;
-  
-  nw=(uint32_t)floor(f);
-  diff=f-floor(f);
-  highweight = (uint8_t)floor(diff*256);
-  lowweight = 256 - highweight;
-
-  if(nw>=_in->getInfo()->nb_frames-1)
-    {
-      printf("[ResampleFps] In %u Out %u\n",frame,nw);
-      nw=_in->getInfo()->nb_frames-1;
-      highweight=0;
-    }
-  //printf("New:%lu old:%lu\n",frame,nw);
-
-  if(highweight == 0)
-    {
-      mysrc1=vidCache->getImage(nw);  
-      if(!mysrc1) return 0;
-      
-      memcpy(YPLANE(data),YPLANE(mysrc1),page);
-      memcpy(UPLANE(data),UPLANE(mysrc1),page>>2);
-      memcpy(VPLANE(data),VPLANE(mysrc1),page>>2);
-      
-      vidCache->unlockAll();
-    }
-  else
-    {
-      mysrc1=vidCache->getImage(nw);
-      mysrc2=vidCache->getImage(nw+1);
-      if(!mysrc1 || !mysrc2) return 0;
-      
-      uint8_t *out, *in1, *in2;
-      uint32_t count;
-      uint32_t idx;
-      
-      out = YPLANE(data);
-      in1 = YPLANE(mysrc1);
-      in2 = YPLANE(mysrc2);
-        
-      count = page;
-
-#ifdef ADM_CPU_X86
-        if(CpuCaps::hasMMX())
-                blendMMX(in1,in2,out,lowweight,highweight,(count*3)>>1);
-        else
-#endif
-      {
-      for(idx = 0; idx < count; ++idx)
-	out[idx] = ((in1[idx]*lowweight) + (in2[idx]*highweight))>>8;
-
-      out = UPLANE(data);
-      in1 = UPLANE(mysrc1);
-      in2 = UPLANE(mysrc2);
-      count = page>>2;
-
-      for(idx = 0; idx < count; ++idx)
-        out[idx] = ((in1[idx]*lowweight) + (in2[idx]*highweight))>>8;      
-
-
-      out = VPLANE(data);
-      in1 = VPLANE(mysrc1);
-      in2 = VPLANE(mysrc2);
-      count = page>>2;
-
-      for(idx = 0; idx < count; ++idx)
-	out[idx] = ((in1[idx]*lowweight) + (in2[idx]*highweight))>>8;
-      }
-
-      vidCache->unlockAll();
-    }
-  return 1;
- 
-}
-
-
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/ResampleFps/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/ResampleFps/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/ResampleFps/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,9 +0,0 @@
-INCLUDE(vf_plugin)
-
-
-SET(ADM_vf_resampleFps_SRCS ADM_vidResampleFPS.cpp)
-
-ADD_LIBRARY(ADM_vf_resampleFps SHARED ${ADM_vf_resampleFps_SRCS})
-
-INIT_VIDEOFILTER_PLUGIN(ADM_vf_resampleFps)
-INSTALL_VIDEOFILTER(ADM_vf_resampleFps)

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Rotate/ADM_vidRotate.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Rotate/ADM_vidRotate.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Rotate/ADM_vidRotate.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,282 +0,0 @@
-/***************************************************************************
-                          ADM_vidRotate.cpp  -  description
-                             -------------------
-    begin                : Sat Jan 8 2003
-    copyright            : (C) 2003 by Tracy Harton
-    email                : tracy at amphibious.org
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-#include "DIA_factory.h"
-
-typedef struct ROTATE_PARAM
-{
-  uint32_t width;
-  uint32_t height;
-  uint32_t angle;
-}ROTATE_PARAM;
-
-class  ADMVideoRotate:public AVDMGenericVideoStream
-{
-
- protected:
-  virtual char                  *printConf(void);
-  ROTATE_PARAM                  *_param;
-
- public:
-                  ADMVideoRotate(AVDMGenericVideoStream *in, CONFcouple *setup);
-  virtual         ~ADMVideoRotate();
-  virtual uint8_t configure( AVDMGenericVideoStream *instream) ;
-  virtual uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len, ADMImage *data,uint32_t *flags);
-  virtual uint8_t	getCoupledConf( CONFcouple **couples)				;
- }     ;
-
-static FILTER_PARAM rotpParam={3,{"width","height","angle"}};
-
-
-//********** Register chunk ************
-static FILTER_PARAM flipParam={0,{""}};
-
-//REGISTERX(VF_TRANSFORM, "rotate",QT_TR_NOOP("Rotate"),QT_TR_NOOP(
-//    "Rotate the picture by 90, 180 or 270 degrees."),VF_ROTATE,1,rotate_create,rotate_script);
-VF_DEFINE_FILTER(ADMVideoRotate,flipParam,
-                                rotate,
-                                QT_TR_NOOP("Rotate"),
-                                1,
-                                VF_TRANSFORM,
-                                QT_TR_NOOP("Rotate the picture by 90, 180 or 270 degrees."));
-//************************************
-
-static void do_rotate(ADMImage *source,ADMImage *target,uint32_t angle);
-
-char *ADMVideoRotate::printConf( void )
-{
-  ADM_FILTER_DECLARE_CONF(" Rotate %u degrees", _param->angle);
-  
-}
-
-ADMVideoRotate::ADMVideoRotate(AVDMGenericVideoStream *in, CONFcouple *couples)
-{
-  _in=in;		
-
-  memcpy(&_info,_in->getInfo(),sizeof(_info)); 
-  _info.encoding=1;
-
- // _uncompressed=new uint8_t [3*_in->getInfo()->width*_in->getInfo()->height];
- 
-
-  if(couples)
-  {
-   	 _param=NEW(ROTATE_PARAM);
-	GET(width);
-	GET(height);
-	GET(angle);
-	_info.width=_param->width;
-	_info.height=_param->height;
-
-  }
-  else
-  {
-    _param = NEW( ROTATE_PARAM);
-    printf("New Angle 0.0\n");
-    _param->angle = 0;
-    _param->width = _info.width;
-    _param->height = _info.height;
-  }
- _uncompressed=new ADMImage(_in->getInfo()->width,_in->getInfo()->height);
-  printf("New Rotate %ld %ld %f\n", _info.width, _info.height, _param->angle);
-  ADM_assert(_uncompressed);    	  	
-
-}
-
-
-
-uint8_t	ADMVideoRotate::getCoupledConf( CONFcouple **couples)
-{
-
-			ADM_assert(_param);
-			*couples=new CONFcouple(3);
-
-#define CSET(x)  (*couples)->setCouple((char *)#x,(_param->x))
-			CSET(width);
-			CSET(height);
-			CSET(angle);
-
-			return 1;
-
-}
-
-
-ADMVideoRotate::~ADMVideoRotate()
-{
- 	delete  _uncompressed;
-	_uncompressed=NULL;
-	DELETE(_param);
-}
-uint8_t ADMVideoRotate::getFrameNumberNoAlloc(uint32_t frame,
-                                              uint32_t *len,
-                                              ADMImage *data,
-                                              uint32_t *flags)
-{
- if(frame>= _info.nb_frames) return 0;
-								
-  // read uncompressed frame
-  if(!_in->getFrameNumberNoAlloc(frame, len, _uncompressed, flags)) return 0;
-
-  
-  do_rotate(_uncompressed,data,_param->angle);
-
-  //printf("%ld,%ld\n", _info.width, _info.height);
-
-  *flags=_uncompressed->flags;
-  *len= (_info.width * _info.height) + ((_info.width * _info.height) / 2);
-   data->copyInfo(_uncompressed);	
-  return 1;
-}
-
-void do_rotate(ADMImage *source,ADMImage *target,uint32_t angle)
-{
-uint8_t *in;
-uint32_t in_w,in_h;
-
-in=source->data;
-in_w=source->_width;
-in_h=source->_height;
-
-uint32_t x, y;
-uint32_t u_offset = (in_w * in_h);
-uint32_t v_offset = u_offset + (in_w/2 * in_h/2);
-uint32_t in_sub_w = in_w/2;
-uint32_t in_sub_h = in_h/2;
-uint32_t out_sub_w, out_sub_h;
-
-uint8_t *out=target->data;
-uint32_t *out_w=&(target->_width);
-uint32_t *out_h=&(target->_height);
-
-ADM_assert(in_w*in_h==(*out_w)*(*out_h));
-
-// In general, for 0 <= i < width and 0 <= j < height, the pixel (x + i, y + j) is colored with red value 
-// red value   rgb_buf[(j * rowstride) + (i * 3) + 0], 
-// green value rgb_buf[(j * rowstride) + (i * 3) + 1], 
-// blue value  rgb_buf[(j * rowstride) + (i * 3) + 2].
-
-        switch(angle)
-        {
-        case 0:
-                *out_w = in_w;
-                *out_h = in_h;
-                out_sub_w = *out_w/2;
-                out_sub_h = *out_h/2;
-            
-                for(x = 0; x < *out_w; x++)
-                for(y = 0; y < *out_h; y++)
-                    *(out + (*out_w * y) + x) = *(in + (in_w * y) + x);
-            
-                for(x = 0; x < out_sub_w; x++)
-                for(y = 0; y < out_sub_h; y++)
-                {
-                    *(out + u_offset + (out_sub_w * y) + x) = *(in + u_offset + (in_sub_w * y) + x);
-                    *(out + v_offset + (out_sub_w * y) + x) = *(in + v_offset + (in_sub_w * y) + x);
-                }
-                break;
-        case 90:
-        {
-            *out_w = in_h;
-            *out_h = in_w;
-            out_sub_w = *out_w/2;
-            out_sub_h = *out_h/2;
-        
-            for(x = 0; x < *out_w; x++)
-            for(y = 0; y < *out_h; y++)
-                *(out + (*out_w * y) + x) = *(in + (in_w * (in_h-x-1)) + y);
-        
-            for(x = 0; x < out_sub_w; x++)
-            for(y = 0; y < out_sub_h; y++)
-            {
-                *(out + u_offset + (out_sub_w * y) + x) = *(in + u_offset + (in_sub_w * (in_sub_h-x-1)) + y);
-                *(out + v_offset + (out_sub_w * y) + x) = *(in + v_offset + (in_sub_w * (in_sub_h-x-1)) + y);
-            }
-        }
-        break;
-        case 180:
-        {
-            *out_w = in_w;
-            *out_h = in_h;
-            out_sub_w = *out_w/2;
-            out_sub_h = *out_h/2;
-        
-            for(x = 0; x < *out_w; x++)
-            for(y = 0; y < *out_h; y++)
-                *(out + (*out_w * y) + x) = *(in + (in_w * (in_h-y-1)) + in_w-x-1);
-        
-        
-            for(x = 0; x < out_sub_w; x++)
-            for(y = 0; y < out_sub_h; y++)
-                {
-                *(out + u_offset + (out_sub_w * y) + x) = *(in + u_offset + (in_sub_w * (in_sub_h-y-1)) + in_sub_w-x-1);
-                *(out + v_offset + (out_sub_w * y) + x) = *(in + v_offset + (in_sub_w * (in_sub_h-y-1)) + in_sub_w-x-1);
-                }
-        }
-            break;
-        case 270:
-        {
-            *out_w = in_h;
-            *out_h = in_w;
-            out_sub_w = *out_w/2;
-            out_sub_h = *out_h/2;
-        
-            for(x = 0; x < *out_w; x++)
-            for(y = 0; y < *out_h; y++)
-                *(out + (*out_w * y) + x) = *(in + (in_w * x) + (in_w-y-1));
-        
-            for(x = 0; x < out_sub_w; x++)
-            for(y = 0; y < out_sub_h; y++)
-            {
-                *(out + u_offset + (out_sub_w * y) + x) = *(in + u_offset + (in_sub_w * x) + (in_sub_w-y-1));
-                *(out + v_offset + (out_sub_w * y) + x) = *(in + v_offset + (in_sub_w * x) + (in_sub_w-y-1));
-            }
-        }
-        break;
-        default:
-            ADM_assert(0);
-        }
-}
-uint8_t ADMVideoRotate::configure( AVDMGenericVideoStream *instream)
-{
-  uint8_t r;
-  
-  diaMenuEntry rotateValues[]={
-      {0,QT_TR_NOOP("None"),QT_TR_NOOP("None")},
-      {90,QT_TR_NOOP("90 degrees"),QT_TR_NOOP("90?")},
-      {180,QT_TR_NOOP("180 degrees"),QT_TR_NOOP("180?")},
-      {270,QT_TR_NOOP("270 degrees"),QT_TR_NOOP("270?")}
-  };
-  diaElemMenu     rotate(&(_param->angle),QT_TR_NOOP("_Angle:"),4,rotateValues,NULL);
-  diaElem *allWidgets[]={&rotate};
-  if( !diaFactoryRun(QT_TR_NOOP("Rotate"),1,allWidgets)) return 0;
-  
-  uint32_t w,h;
-  w=_in->getInfo()->width;
-  h=_in->getInfo()->height;
-  if((_param->angle%180)==90)
-  {
-    _info.width=_param->width=h;
-    _info.height=_param->height=w;
-  }else
-  {
-      _info.width=_param->width=w;
-      _info.height=_param->height=h;
-  }
-  return 1;
-}
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Rotate/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Rotate/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Rotate/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,9 +0,0 @@
-INCLUDE(vf_plugin)
-
-
-SET(ADM_vf_rotate_SRCS ADM_vidRotate.cpp)
-
-ADD_LIBRARY(ADM_vf_rotate SHARED ${ADM_vf_rotate_SRCS})
-
-INIT_VIDEOFILTER_PLUGIN(ADM_vf_rotate)
-INSTALL_VIDEOFILTER(ADM_vf_rotate)

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/SwapUV/ADM_vidUVSwap.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/SwapUV/ADM_vidUVSwap.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/SwapUV/ADM_vidUVSwap.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,86 +0,0 @@
-/***************************************************************************
-                          ADM_vidUVSwap.cpp  -  description
-                             -------------------
-    begin                : Tue Sep 10 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-#include "ADM_vidUVSwap.h"
-
-
-static FILTER_PARAM nullParam={0,{""}};
-
-
-VF_DEFINE_FILTER(ADMVideoUVSwap,nullParam,
-                swapuv,
-                QT_TR_NOOP("Swap U and V"),
-                1,
-                VF_COLORS,
-                QT_TR_NOOP("Invert chroma U and chroma V."));
-//*********************************
-char *ADMVideoUVSwap::printConf( void )
-{
- 	ADM_FILTER_DECLARE_CONF(" UV Swap");
-        
-}
-
-ADMVideoUVSwap::ADMVideoUVSwap(  AVDMGenericVideoStream *in,CONFcouple *setup)
-{
-UNUSED_ARG(setup);
-	_buf=NULL;
- 	_in=in;
-   	memcpy(&_info,_in->getInfo(),sizeof(_info));
-
-		
-  _info.encoding=1;
- _buf=new uint8_t [(_info.width*_info.height)>>2];
-
-
-}
-ADMVideoUVSwap::~ADMVideoUVSwap()
-{
-		if(_buf)
-		{
-            		delete []_buf;
-			_buf=NULL;
-		}
-}
-uint8_t ADMVideoUVSwap::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-
-		if(frame>= _info.nb_frames) return 0;
-		// read uncompressed frame
-       		if(!_in->getFrameNumberNoAlloc(frame, len,data,flags)) return 0;
-
-		uint32_t sz;
-		uint8_t *start;
-					
-			sz=_info.width*_info.height;
-			sz>>=2;
-				
-			start=UPLANE(data);
-			memcpy(_buf,start,sz);
-					
-			memcpy(UPLANE(data),VPLANE(data),sz);
-			memcpy(VPLANE(data),_buf,sz);
-			
-
-
-      return 1;
-}
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/SwapUV/ADM_vidUVSwap.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/SwapUV/ADM_vidUVSwap.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/SwapUV/ADM_vidUVSwap.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,37 +0,0 @@
-/***************************************************************************
-                          ADM_vidUVSwap.h  -  description
-                             -------------------
-    begin                : Tue Sep 10 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef UVSWAP_
-#define UVSWAP_
-
- class  ADMVideoUVSwap:public AVDMGenericVideoStream
- {
-
- protected:
-
-           virtual 	char					*printConf(void);
-			uint8_t				*_buf;
-
- public:
-
-  						ADMVideoUVSwap(  AVDMGenericVideoStream *in,CONFcouple *setup);
-  			virtual 		~ADMVideoUVSwap();
-		        virtual uint8_t 	getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-          							ADMImage *data,uint32_t *flags);
-			virtual uint8_t 	configure( AVDMGenericVideoStream *instream) { UNUSED_ARG(instream); return 1;};
-
- }     ;
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/SwapUV/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/SwapUV/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/SwapUV/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,9 +0,0 @@
-INCLUDE(vf_plugin)
-
-
-SET(ADM_vf_swapuv_SRCS ADM_vidUVSwap.cpp)
-
-ADD_LIBRARY(ADM_vf_swapuv SHARED ${ADM_vf_swapuv_SRCS})
-
-INIT_VIDEOFILTER_PLUGIN(ADM_vf_swapuv)
-INSTALL_VIDEOFILTER(ADM_vf_swapuv)

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/VerticalFlip/ADM_vidFlipV.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/VerticalFlip/ADM_vidFlipV.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/VerticalFlip/ADM_vidFlipV.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,130 +0,0 @@
-/***************************************************************************
-                          ADM_vidFlipV.cpp  -  description
-                             -------------------
-    begin                : Wed Nov 6 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-//********** Class Definition ************
- class ADMVideoFlipV : public AVDMGenericVideoStream 
- {
-
-protected:
-	AVDMGenericVideoStream *_in;
-	virtual char *printConf(void);
-
-public:
-
-	ADMVideoFlipV(AVDMGenericVideoStream *in, CONFcouple *setup);
-	virtual ~ADMVideoFlipV();
-	virtual uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-			ADMImage *data, uint32_t *flags);
-	virtual uint8_t configure(AVDMGenericVideoStream *instream) 
-	{
-		UNUSED_ARG(instream);
-		return 1;
-	};
-};
-
-//********** Register chunk ************
-static FILTER_PARAM flipParam={0,{""}};
-
-
-VF_DEFINE_FILTER(ADMVideoFlipV,flipParam,
-				flipV,
-				QT_TR_NOOP("Vertical flip"),
-				1,
-				VF_TRANSFORM,
-				QT_TR_NOOP("Vertically flip the picture."));
-//************************************
-char *ADMVideoFlipV::printConf( void )
-{
- 	ADM_FILTER_DECLARE_CONF(" V-Flip");
-        
-}
-
-ADMVideoFlipV::ADMVideoFlipV(  AVDMGenericVideoStream *in,CONFcouple *setup)
-{
-    UNUSED_ARG(setup);
- 	_in=in;		
-   	memcpy(&_info,_in->getInfo(),sizeof(_info)); 	
-  	_info.encoding=1;	
-	_uncompressed=new ADMImage(_in->getInfo()->width,_in->getInfo()->height);
-	ADM_assert(_uncompressed);    	  	
-}
-ADMVideoFlipV::~ADMVideoFlipV()
-{
- 	delete  _uncompressed;	
-	_uncompressed=NULL;
-  
-}
-uint8_t ADMVideoFlipV::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-
-	if (frame>= _info.nb_frames)
-		return 0;
-	// read uncompressed frame
-	if (!_in->getFrameNumberNoAlloc(frame, len, _uncompressed, flags))
-		return 0;
-
-	uint8_t *in, *out;
-	uint32_t stride=_info.width;
-	uint32_t h=_info.height;
-	uint32_t page, qpage;
-
-	page=stride*h;
-	qpage=page>>2;
-
-	in=YPLANE(_uncompressed);
-	out=YPLANE(data)+(h-1)*stride;
-	// flip y
-	for (uint32_t y=h; y>0; y--) 
-	{
-		memcpy(out,in,stride);
-		in+=stride;
-		out-=stride;
-	}
-	// Flip U & V			         
-	stride>>=1;
-	in=UPLANE(_uncompressed);
-	out=UPLANE(data)+qpage-stride;
-	// flip u
-	for (uint32_t y=h>>1; y>0; y--) 
-	{
-		memcpy(out,in,stride);
-		in+=stride;
-		out-=stride;
-	}
-	in=VPLANE(_uncompressed);
-	out=VPLANE(data)+qpage-stride;
-
-	// flip u
-	for (uint32_t y=h>>1; y>0; y--)
-	{
-		memcpy(out,in,stride);
-		in+=stride;
-		out-=stride;
-	}
-	data->copyInfo(_uncompressed);
-	return 1;
-}
-//EOF
-
-
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/VerticalFlip/ADM_vidFlipV.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/VerticalFlip/ADM_vidFlipV.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/VerticalFlip/ADM_vidFlipV.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,37 +0,0 @@
-/***************************************************************************
-                          ADM_vidFlipV.h  -  description
-                             -------------------
-    begin                : Wed Nov 6 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef FLIP__
-#define FLIP__
-
- class  ADMVideoFlipV:public AVDMGenericVideoStream
- {
-
- protected:
-    		AVDMGenericVideoStream 	*_in;    	
-           virtual char 									*printConf(void);
-          
- public:
- 		
-  					ADMVideoFlipV(  AVDMGenericVideoStream *in,CONFcouple *setup);
-  					virtual ~ADMVideoFlipV();
-		          virtual uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-          																	ADMImage *data,uint32_t *flags);
-					virtual uint8_t configure( AVDMGenericVideoStream *instream) { UNUSED_ARG(instream); return 1;};          																	
-
-
- }     ;
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/VerticalFlip/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/VerticalFlip/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/VerticalFlip/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,9 +0,0 @@
-INCLUDE(vf_plugin)
-
-
-SET(ADM_vf_vflip_SRCS ADM_vidFlipV.cpp)
-
-ADD_LIBRARY(ADM_vf_vflip SHARED ${ADM_vf_vflip_SRCS})
-
-INIT_VIDEOFILTER_PLUGIN(ADM_vf_vflip)
-INSTALL_VIDEOFILTER(ADM_vf_vflip)

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deint.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deint.cpp	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deint.cpp	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,290 +0,0 @@
-//
-// C++ Implementation: %{MODULE}
-//
-// Description: 
-//
-//
-// Author: %{AUTHOR} <%{EMAIL}>, (C) %{YEAR}
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//  Small wrapper for lavcodec deinterlacer postprocessing
-
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include <math.h>
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-
-#include "DIA_fileSel.h"
-
-#include "ADM_colorspace.h"
-
-#include "ADM_lavpp_deintparam.h"
-extern "C"
-{
-#include "ADM_libraries/ADM_ffmpeg/ADM_libpostproc/postprocess.h"
-};
-#include "DIA_factory.h"
-/*
-{"al", "autolevels",            0, 1, 2, LEVEL_FIX},
-{"lb", "linblenddeint",         1, 1, 4, LINEAR_BLEND_DEINT_FILTER},
-{"li", "linipoldeint",          1, 1, 4, LINEAR_IPOL_DEINT_FILTER},
-{"ci", "cubicipoldeint",        1, 1, 4, CUBIC_IPOL_DEINT_FILTER},
-{"md", "mediandeint",           1, 1, 4, MEDIAN_DEINT_FILTER},
-{"fd", "ffmpegdeint",           1, 1, 4, FFMPEG_DEINT_FILTER},
-{"tn", "tmpnoise",              1, 7, 8, TEMP_NOISE_FILTER},
-
-{"fq", "forcequant",            1, 0, 0, FORCE_QUANT}, *******************
-{"l5", "lowpass5",              1, 1, 4, LOWPASS5_DEINT_FILTER}, *********
-*/
-
-#define AVI_KEY_FRAME 0x10  // FIXME
-#define AVI_B_FRAME 0x4000
-
-
-class  ADMVideoLavPPDeint:public AVDMGenericVideoStream
-{
-
-  protected:
-    virtual char                    *printConf(void);
-    void                            *ppcontext;
-    void                            *ppmode;
-    ADMImage                        *uncompressed;
-    lavc_pp_param                   *_param;
-    
-    void                            setup( void );
-    void                            cleanup( void );
-  public:
-    
-    
-    ADMVideoLavPPDeint(  AVDMGenericVideoStream *in,CONFcouple *setup);
-    ~ADMVideoLavPPDeint();
-    virtual uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-                                          ADMImage *data,uint32_t *flags);
-    virtual uint8_t getCoupledConf( CONFcouple **couples)           ;
-    virtual uint8_t configure( AVDMGenericVideoStream *instream);
-                                                        
-};
-
-
-static FILTER_PARAM lavppdeint_param={2,{"deintType","autolevel"}};
-//*************************************************************
-//
-
-//*************************************************************
-//********** Register chunk ************
-//REGISTERX(VF_INTERLACING, "lavcppdeint",QT_TR_NOOP("libavcodec deinterlacer"),
-//    QT_TR_NOOP("All FFmpeg deinterlace filters (bicubic, median, ...)."),VF_LAVPP_DEINT,1,lavppdeint_create,lavppdeint_script);
-
-VF_DEFINE_FILTER(ADMVideoLavPPDeint,lavppdeint_param,
-    lavcppdeint,
-                QT_TR_NOOP("libavcodec deinterlacer"),
-                1,
-                VF_INTERLACING,
-                QT_TR_NOOP("All FFmpeg deinterlace filters (bicubic, median, ...)."));
-//********** Register chunk ************
-
-
-
-//*************************************************************
-uint8_t ADMVideoLavPPDeint::configure(AVDMGenericVideoStream *in)
-{
-
-  #define PX(x) &(_param->x)
-  _in=in;
-  
-  
-   diaMenuEntry menuField[6]={{PP_BM_NONE,        QT_TR_NOOP("None"),NULL},
-                             {PP_BM_LINEAR_BLEND, QT_TR_NOOP("Linear blend"),NULL},
-                             {PP_BM_LINEAR_INTER, QT_TR_NOOP("Linear interpolate"),NULL},
-                             {PP_BM_CUBIC_INTER, QT_TR_NOOP("Cubic interpolate"),NULL},
-                             {PP_BM_MEDIAN_INTER, QT_TR_NOOP("Median interpolate"),NULL},
-                             {PP_BM_FFMPEG_DEINT, QT_TR_NOOP("FFmpeg deint"),NULL},
-                          };
-  
-    
-    diaElemMenu     menu1(PX(deintType),QT_TR_NOOP("_Deinterlacing:"), 6,menuField);
-    diaElemToggle   autolevel(PX(autolevel),QT_TR_NOOP("_Autolevel"));
-    
-    diaElem *elems[2]={&menu1,&autolevel};
-  
-   if(diaFactoryRun(QT_TR_NOOP("libavcodec deinterlacer"),2,elems))
-  {
-    setup();
-    return 1; 
-  }
-  return 0;        
-}
- 
-//*************************************************************
-char *ADMVideoLavPPDeint::printConf( void )
-{
- ADM_FILTER_DECLARE_CONF(" Lavcodec PP deinterlacer autolev:%d deint:%d",_param->autolevel,_param->deintType);
-  
-}
-//*************************************************************
-ADMVideoLavPPDeint::ADMVideoLavPPDeint(  AVDMGenericVideoStream *in,CONFcouple *couples)
-{
-
-  _in=in;         
-  memcpy(&_info,_in->getInfo(),sizeof(_info));    
-  _info.encoding=1;  
-  
-  ppcontext=NULL;  
-  ppmode=NULL;   
-  
-  _uncompressed=new ADMImage(_info.width,_info.height);
-  if(couples)
-  {   
-    _param=NEW(lavc_pp_param);
-    GET(deintType);    
-    GET(autolevel);
-  }      
-  else
-  {
-    _param=NEW(lavc_pp_param);
-    _param->deintType=0;
-    _param->autolevel=0;
-    
-  } 
-                 
-  setup();
- 
-}
-//*************************************************************
-void ADMVideoLavPPDeint::cleanup(void)
-{
-  if(ppcontext)
-  {
-    pp_free_context(ppcontext);
-    ppcontext=NULL;
-  }
-  if(ppmode)
-  {
-    pp_free_mode(ppmode);
-    ppmode=NULL;
-  }
-  
-} 
-//*************************************************************
-void ADMVideoLavPPDeint::setup(void)
-{
-  char string[1024];
-  uint32_t ppCaps=0;
-                
-  string[0]=0;
-  
-        cleanup();
-#ifdef ADM_CPU_X86
-#define ADD(x,y) if( CpuCaps::has##x()) ppCaps|=PP_CPU_CAPS_##y;                
-                ADD(MMX,MMX);           
-                ADD(3DNOW,3DNOW);
-                ADD(MMXEXT,MMX2);
-#endif             
-        cleanup();
-#undef ADD       
-#define ADD(z)  { if(string[0]) strcat(string,","#z); else strcpy(string,#z);}        
-               
-        if(_param->autolevel) ADD(al);
-        switch(_param->deintType)
-        {
-          case PP_BM_NONE:break;
-          case PP_BM_LINEAR_BLEND: ADD(lb);break;
-          case PP_BM_LINEAR_INTER: ADD(li);break;
-          case PP_BM_CUBIC_INTER: ADD(ci);break;
-          case PP_BM_MEDIAN_INTER: ADD(md);break;
-          case PP_BM_FFMPEG_DEINT: ADD(fd);break;                             
-        }        
-
-
-        ppcontext=pp_get_context(_info.width, _info.height, ppCaps);           
-        ppmode=pp_get_mode_by_name_and_quality(string,1);;
-        
-        ADM_assert(ppcontext);
-        ADM_assert(ppmode);
-  
-} 
-//*************************************************************
-ADMVideoLavPPDeint::~ADMVideoLavPPDeint()
-{
-  cleanup();
-  if(_uncompressed)
-        delete _uncompressed;
-  DELETE(_param);
-  _uncompressed=NULL;
-}
-
-//*************************************************************
-uint8_t ADMVideoLavPPDeint::getCoupledConf( CONFcouple **couples)
-{
-  
-  *couples=new CONFcouple(2);
-  CSET(deintType);    
-  CSET(autolevel);
-  
-  return 1;
-}
-//*************************************************************
-uint8_t ADMVideoLavPPDeint::getFrameNumberNoAlloc(uint32_t frame,
-                                              uint32_t *len,
-                                              ADMImage *data,
-                                              uint32_t *flags)
-{
-
- 
-  if(frame>= _info.nb_frames) return 0;
-        // read uncompressed frame
-  if(!_in->getFrameNumberNoAlloc(frame, len,_uncompressed,flags)) return 0;
-
-  
-  //
-  const uint8_t *iBuff[3];
-   uint8_t *oBuff[3];
-  int strideTab[3],strideTab2[3];                 
-                                                                
-  oBuff[0]=YPLANE(data);
-  oBuff[1]=UPLANE(data);
-  oBuff[2]=VPLANE(data);
-                                
-  iBuff[0]=YPLANE(_uncompressed);
-  iBuff[1]=UPLANE(_uncompressed);
-  iBuff[2]=VPLANE(_uncompressed);
-                                
-                                
-  strideTab[0]=strideTab2[0]=_info.width;
-  strideTab[1]=strideTab2[1]=_info.width>>1;
-  strideTab[2]=strideTab2[2]=_info.width>>1;
-        
-  int type;
-  if(_uncompressed->flags&AVI_KEY_FRAME)
-    type=1;
-  else if(_uncompressed->flags & AVI_B_FRAME)
-    type=3;
-  else
-    type=2;
-  pp_postprocess(
-        iBuff,
-        strideTab,
-        oBuff,
-        strideTab2,
-        _info.width,
-        _info.height,
-        NULL,
-        0,
-        ppmode,
-        ppcontext,
-        type); // I ?
-                                
-  
-  data->copyInfo(_uncompressed);
-  return 1;
-}

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deintparam.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deintparam.h	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deintparam.h	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,26 +0,0 @@
-//
-// C++ Interface: %{MODULE}
-//
-// Description: 
-//
-//
-// Author: %{AUTHOR} <%{EMAIL}>, (C) %{YEAR}
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-enum 
-{
-  PP_BM_NONE           =0x0000,
-  PP_BM_LINEAR_BLEND   =0x0001, 
-  PP_BM_LINEAR_INTER   =0x0002, 
-  PP_BM_CUBIC_INTER    =0x0003, 
-  PP_BM_MEDIAN_INTER   =0x0004, 
-  PP_BM_FFMPEG_DEINT   =0x0005,  
-};
-
-typedef struct 
-{
-  uint32_t      deintType;
-  uint32_t       autolevel;
-}lavc_pp_param;

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/lavDeinterlace/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/lavDeinterlace/CMakeLists.txt	2010-09-04 09:05:56 UTC (rev 6576)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/lavDeinterlace/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
@@ -1,10 +0,0 @@
-INCLUDE(vf_plugin)
-
-
-SET(ADM_vf_lavDeinterlace_SRCS ADM_lavpp_deint.cpp)
-INCLUDE_DIRECTORIES("${AVIDEMUX_SOURCE_DIR}/avidemux/")
-ADD_LIBRARY(ADM_vf_lavDeinterlace SHARED ${ADM_vf_lavDeinterlace_SRCS})
-TARGET_LINK_LIBRARIES(ADM_vf_lavDeinterlace ADM_libswscale ADM_libpostproc)
-
-INIT_VIDEOFILTER_PLUGIN(ADM_vf_lavDeinterlace)
-INSTALL_VIDEOFILTER(ADM_vf_lavDeinterlace)



From mean at mail.berlios.de  Sat Sep  4 11:06:00 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  4 Sep 2010 11:06:00 +0200
Subject: [Avidemux-svn-commit] r6578 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6
Message-ID: <20100904090600.2782248100F@sheep.berlios.de>

Author: mean
Date: 2010-09-04 11:05:59 +0200 (Sat, 04 Sep 2010)
New Revision: 6578

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
Log:
[Filter] List them alphabetically

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-04 09:05:58 UTC (rev 6577)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-04 09:05:59 UTC (rev 6578)
@@ -1,17 +1,18 @@
+ADD_SUBDIRECTORY(addBorder)
+#ADD_SUBDIRECTORY(ass)
+ADD_SUBDIRECTORY(blackenBorder)
+ADD_SUBDIRECTORY(crop)
 ADD_SUBDIRECTORY(dummy)
-ADD_SUBDIRECTORY(verticalFlip)
-ADD_SUBDIRECTORY(resize)
-ADD_SUBDIRECTORY(crop)
-ADD_SUBDIRECTORY(yadif)
+ADD_SUBDIRECTORY(kernelDeint)
+ADD_SUBDIRECTORY(lavDeint)
+ADD_SUBDIRECTORY(logo)
 ADD_SUBDIRECTORY(mplayerDenoise3D)
 ADD_SUBDIRECTORY(printInfo)
-ADD_SUBDIRECTORY(vdpauFilters)
-ADD_SUBDIRECTORY(addBorder)
-ADD_SUBDIRECTORY(swapUV)
 ADD_SUBDIRECTORY(resampleFps)
+ADD_SUBDIRECTORY(resize)
+ADD_SUBDIRECTORY(rotate)
 ADD_SUBDIRECTORY(stackField)
-ADD_SUBDIRECTORY(logo)
-ADD_SUBDIRECTORY(blackenBorder)
-ADD_SUBDIRECTORY(kernelDeint)
-ADD_SUBDIRECTORY(rotate)
-ADD_SUBDIRECTORY(lavDeint)
+ADD_SUBDIRECTORY(swapUV)
+ADD_SUBDIRECTORY(yadif)
+ADD_SUBDIRECTORY(vdpauFilters)
+ADD_SUBDIRECTORY(verticalFlip)



From mean at mail.berlios.de  Sat Sep  4 11:06:01 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  4 Sep 2010 11:06:01 +0200
Subject: [Avidemux-svn-commit] r6579 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml
Message-ID: <20100904090601.413E548100F@sheep.berlios.de>

Author: mean
Date: 2010-09-04 11:06:01 +0200 (Sat, 04 Sep 2010)
New Revision: 6579

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.cpp
Log:
[odml] Dont assert if chunks are too big

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.cpp	2010-09-04 09:05:59 UTC (rev 6578)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.cpp	2010-09-04 09:06:01 UTC (rev 6579)
@@ -124,7 +124,12 @@
             return 0;
         }
         fseeko(fd,index[currentIndex].offset,SEEK_SET);
-        if(index[currentIndex].size>maxSize) ADM_assert(0);
+        if(index[currentIndex].size>maxSize) 
+        {
+            ADM_error("Packet too large %d, maximum is %d\n",index[currentIndex].size,maxSize);
+            *size=0;
+            return false;
+         }
         fread(buffer,1,index[currentIndex].size,fd);
         if(!currentIndex) 
             *dts=0;



From mean at mail.berlios.de  Sat Sep  4 11:06:02 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  4 Sep 2010 11:06:02 +0200
Subject: [Avidemux-svn-commit] r6580 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml
Message-ID: <20100904090602.5694E48100F@sheep.berlios.de>

Author: mean
Date: 2010-09-04 11:06:02 +0200 (Sat, 04 Sep 2010)
New Revision: 6580

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.h
Log:
[odml] Split PCM chunk into smaller ones if needed

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.cpp	2010-09-04 09:06:01 UTC (rev 6579)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.cpp	2010-09-04 09:06:02 UTC (rev 6580)
@@ -37,8 +37,9 @@
     \fn ADM_aviAudioAccess
 
 */
+#define ODML_MAX_AUDIO_CHUNK (10*1024)
 ADM_aviAudioAccess::ADM_aviAudioAccess(odmlIndex *idx,WAVHeader *hdr,
-						uint32_t nbchunk,
+						uint32_t nbChunk,
 						const char *name,
 						uint32_t extraLen,
 						uint8_t  *extraData)
@@ -46,15 +47,50 @@
     this->extraData=new uint8_t[extraLen];
     memcpy(this->extraData,extraData,extraLen);
     this->extraDataLen=extraLen;
-    index=idx;
-    nbIndex=nbchunk;
     length=0;
-    for(int i=0;i<nbIndex;i++) length+=idx[i].size;
+    uint32_t mx=0;
+    for(int i=0;i<nbChunk;i++) 
+    {
+        length+=idx[i].size;    
+        if(idx[i].size>mx) mx=idx[i].size;
+    }
+    if((hdr->encoding==WAV_PCM || hdr->encoding==WAV_LPCM)&& mx>ODML_MAX_AUDIO_CHUNK)
+    {
+        // Split the huge chunk into smaller ones
+        for(int i=0;i<nbChunk;i++)
+        {
+            uint64_t start=idx[i].offset;
+            uint32_t size=idx[i].size;      
+            uint32_t ONE_CHUNK=(ODML_MAX_AUDIO_CHUNK)/(2*hdr->channels);
+            ONE_CHUNK*=2*hdr->channels;
+            while(size>ONE_CHUNK)
+            {
+                odmlIndex current;
+                current.offset=start;
+                current.size=ONE_CHUNK;
+                current.dts=ADM_NO_PTS;
+                myIndex.push_back(current);
+                start+=ONE_CHUNK;
+                size-=ONE_CHUNK;
+            }
+                odmlIndex current;
+                current.offset=start;
+                current.size=size;
+                current.dts=ADM_NO_PTS;
+                myIndex.push_back(current);
+        }
+
+    }else
+    {       // Duplicate index as is
+        for(int i=0;i<nbChunk;i++)
+          myIndex.push_back(idx[i]);
+    }
     fd=ADM_fopen(name,"r");
     ADM_assert(fd);
     pos=0;
     currentIndex=0;
     wavHeader=hdr;
+    nbIndex=myIndex.size(); // will not change
 }
 /**
     \fn isCBR
@@ -77,7 +113,7 @@
     if(currentIndex>=nbIndex) return length;
     for(int i=0;i<currentIndex;i++)
     {
-        total+=index[i].size;
+        total+=myIndex[i].size;
     }
     return total;
 }
@@ -91,6 +127,7 @@
     fd=NULL;
     if(extraData) delete[] extraData;
     extraData=NULL;
+    myIndex.clear();
 }
 /**
     \fn setPos
@@ -101,13 +138,13 @@
     uint64_t total=0;
     for(int i=0;i<nbIndex-1;i++)
     {
-        if(pos>=total && pos<=total+index[i].size)
+        if(pos>=total && pos<=total+myIndex[i].size)
         {
-            fseeko(fd,index[i].offset,SEEK_SET);
+            fseeko(fd,myIndex[i].offset,SEEK_SET);
             currentIndex=i;
             return 1;
         }
-        total+=index[i].size;
+        total+=myIndex[i].size;
     }
     printf("[aviAudioAccess] Seek to pos %"LLU" failed\n",pos);
     return 0;
@@ -123,19 +160,19 @@
             printf("[OpenDmlDemuxer] Index Exceeded %d/%d\n",currentIndex,nbIndex);
             return 0;
         }
-        fseeko(fd,index[currentIndex].offset,SEEK_SET);
-        if(index[currentIndex].size>maxSize) 
+        fseeko(fd,myIndex[currentIndex].offset,SEEK_SET);
+        if(myIndex[currentIndex].size>maxSize) 
         {
-            ADM_error("Packet too large %d, maximum is %d\n",index[currentIndex].size,maxSize);
+            ADM_error("Packet too large %d, maximum is %d\n",myIndex[currentIndex].size,maxSize);
             *size=0;
             return false;
          }
-        fread(buffer,1,index[currentIndex].size,fd);
+        fread(buffer,1,myIndex[currentIndex].size,fd);
         if(!currentIndex) 
             *dts=0;
         else
             *dts=ADM_AUDIO_NO_DTS;
-        *size=index[currentIndex].size;
+        *size=myIndex[currentIndex].size;
         currentIndex++;
         return 1;
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.h	2010-09-04 09:06:01 UTC (rev 6579)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.h	2010-09-04 09:06:02 UTC (rev 6580)
@@ -1,5 +1,7 @@
 #ifndef ADM_ODML_AUDIO_H
 #define ADM_ODML_AUDIO_H
+#include <vector>
+using std::vector;
 #include "ADM_audioStream.h"
 class odmlIndex;
 /**
@@ -14,7 +16,7 @@
                 uint32_t pos;
                 FILE     *fd;
                 uint32_t currentIndex;
-                odmlIndex *index;
+                vector <odmlIndex> myIndex;
                 uint32_t   nbIndex;
                 WAVHeader *wavHeader;
 public: 



From mean at mail.berlios.de  Sat Sep  4 11:34:14 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  4 Sep 2010 11:34:14 +0200
Subject: [Avidemux-svn-commit] r6581 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML
Message-ID: <20100904093414.E11A048100F@sheep.berlios.de>

Author: mean
Date: 2010-09-04 11:34:14 +0200 (Sat, 04 Sep 2010)
New Revision: 6581

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML/ADM_odml_regular.cpp
Log:
[opendml] Dont assert if header says there is audio wherease there is not

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML/ADM_odml_regular.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML/ADM_odml_regular.cpp	2010-09-04 09:06:02 UTC (rev 6580)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML/ADM_odml_regular.cpp	2010-09-04 09:34:14 UTC (rev 6581)
@@ -111,8 +111,14 @@
                          run++;
                 }
         }
-        ADM_assert(run==_nbAudioTracks);
+        if(!run) 
+        {
+            _nbAudioTracks=0;
+            printf("No audio chunk found in index..\n");
+        }else
+            ADM_assert(run==_nbAudioTracks);
 
+
         // Create index
         uint32_t nb;
         for(int i=0;i<_nbAudioTracks;i++)



From mean at mail.berlios.de  Sat Sep  4 11:34:35 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  4 Sep 2010 11:34:35 +0200
Subject: [Avidemux-svn-commit] r6582 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml
Message-ID: <20100904093435.93CBB48100F@sheep.berlios.de>

Author: mean
Date: 2010-09-04 11:34:35 +0200 (Sat, 04 Sep 2010)
New Revision: 6582

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_regular.cpp
Log:
[opendml] Dont assert if header says there is audio wherease there is not

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_regular.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_regular.cpp	2010-09-04 09:34:14 UTC (rev 6581)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_regular.cpp	2010-09-04 09:34:35 UTC (rev 6582)
@@ -105,7 +105,12 @@
                          run++;
                 }
         }
-        ADM_assert(run==_nbAudioTracks);
+        if(!run) 
+        {
+            _nbAudioTracks=0;
+            ADM_warning("No audio chunk found in index..\n");
+        }else
+            ADM_assert(run==_nbAudioTracks);
 
         // Create index
         uint32_t nb;



From mean at mail.berlios.de  Sat Sep  4 18:33:33 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  4 Sep 2010 18:33:33 +0200
Subject: [Avidemux-svn-commit] r6583 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6:
	. ass ass/ADM_libass
Message-ID: <20100904163333.C645048102A@sheep.berlios.de>

Author: mean
Date: 2010-09-04 18:33:33 +0200 (Sat, 04 Sep 2010)
New Revision: 6583

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_types.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/help_mp.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_vidASS.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ass_ssa.conf
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ass_ssa.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ass_ssa_desc.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
Log:
[VideoFilter] First import of Ass/ssa filter + libass

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-04 09:34:35 UTC (rev 6582)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-04 16:33:33 UTC (rev 6583)
@@ -1,5 +1,5 @@
 ADD_SUBDIRECTORY(addBorder)
-#ADD_SUBDIRECTORY(ass)
+ADD_SUBDIRECTORY(ass)
 ADD_SUBDIRECTORY(blackenBorder)
 ADD_SUBDIRECTORY(crop)
 ADD_SUBDIRECTORY(dummy)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/CMakeLists.txt	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,19 @@
+INCLUDE(admCheckFontConfig)
+checkFontConfig()
+
+SET(ADM_LIB ADM_libass)
+
+SET(${ADM_LIB}_SRCS 
+ass_bitmap.c  ass.c  ass_cache.c  ass_fontconfig.c  ass_library.c   ass_render.c  ass_utils.c  mputils.c
+ass_font.c)
+
+ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})
+ADD_DEFINITIONS(${FREETYPE2_CFLAGS} "-I${LIBICONV_INCLUDE_DIR}")
+
+IF (FONTCONFIG_FOUND)
+	ADD_DEFINITIONS(${FONTCONFIG_CFLAGS} "-DHAVE_FONTCONFIG=1")
+ENDIF (FONTCONFIG_FOUND)
+
+IF (UNIX)
+	ADD_TARGET_CFLAGS(${ADM_LIB} -fPIC)
+ENDIF (UNIX)
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.c	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,1092 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+//#include "config.h"
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include <assert.h>
+#include <errno.h>
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <unistd.h>
+#include <inttypes.h>
+
+#ifdef USE_ICONV
+#include <iconv.h>
+#endif
+
+#include "ass.h"
+#include "ass_utils.h"
+#include "ass_library.h"
+#include "mputils.h"
+
+typedef enum {PST_UNKNOWN = 0, PST_INFO, PST_STYLES, PST_EVENTS, PST_FONTS} parser_state_t;
+
+struct parser_priv_s {
+	parser_state_t state;
+	char* fontname;
+	char* fontdata;
+	int fontdata_size;
+	int fontdata_used;
+};
+
+#define ASS_STYLES_ALLOC 20
+#define ASS_EVENTS_ALLOC 200
+
+void ass_free_track(ass_track_t* track) {
+	int i;
+	
+	if (track->parser_priv) {
+		if (track->parser_priv->fontname)
+			free(track->parser_priv->fontname);
+		if (track->parser_priv->fontdata)
+			free(track->parser_priv->fontdata);
+		free(track->parser_priv);
+	}
+	if (track->style_format)
+		free(track->style_format);
+	if (track->event_format)
+		free(track->event_format);
+	if (track->styles) {
+		for (i = 0; i < track->n_styles; ++i)
+			ass_free_style(track, i);
+		free(track->styles);
+	}
+	if (track->events) {
+		for (i = 0; i < track->n_events; ++i)
+			ass_free_event(track, i);
+		free(track->events);
+	}
+}
+
+/// \brief Allocate a new style struct
+/// \param track track
+/// \return style id
+int ass_alloc_style(ass_track_t* track) {
+	int sid;
+	
+	assert(track->n_styles <= track->max_styles);
+
+	if (track->n_styles == track->max_styles) {
+		track->max_styles += ASS_STYLES_ALLOC;
+		track->styles = (ass_style_t*)realloc(track->styles, sizeof(ass_style_t)*track->max_styles);
+	}
+	
+	sid = track->n_styles++;
+	memset(track->styles + sid, 0, sizeof(ass_style_t));
+	return sid;
+}
+
+/// \brief Allocate a new event struct
+/// \param track track
+/// \return event id
+int ass_alloc_event(ass_track_t* track) {
+	int eid;
+	
+	assert(track->n_events <= track->max_events);
+
+	if (track->n_events == track->max_events) {
+		track->max_events += ASS_EVENTS_ALLOC;
+		track->events = (ass_event_t*)realloc(track->events, sizeof(ass_event_t)*track->max_events);
+	}
+	
+	eid = track->n_events++;
+	memset(track->events + eid, 0, sizeof(ass_event_t));
+	return eid;
+}
+
+void ass_free_event(ass_track_t* track, int eid) {
+	ass_event_t* event = track->events + eid;
+	if (event->Name)
+		free(event->Name);
+	if (event->Effect)
+		free(event->Effect);
+	if (event->Text)
+		free(event->Text);
+	if (event->render_priv)
+		free(event->render_priv);
+}
+
+void ass_free_style(ass_track_t* track, int sid) {
+	ass_style_t* style = track->styles + sid;
+	if (style->Name)
+		free(style->Name);
+	if (style->FontName)
+		free(style->FontName);
+}
+
+// ==============================================================================================
+
+static void skip_spaces(char** str) {
+	char* p = *str;
+	while ((*p==' ') || (*p=='\t'))
+		++p;
+	*str = p;
+}
+
+static void rskip_spaces(char** str, char* limit) {
+	char* p = *str;
+	while ((p >= limit) && ((*p==' ') || (*p=='\t')))
+		--p;
+	*str = p;
+}
+
+/**
+ * \brief find style by name
+ * \param track track
+ * \param name style name
+ * \return index in track->styles
+ * Returnes 0 if no styles found => expects at least 1 style.
+ * Parsing code always adds "Default" style in the end.
+ */
+static int lookup_style(ass_track_t* track, char* name) {
+	int i;
+	if (*name == '*') ++name; // FIXME: what does '*' really mean ?
+	for (i=0; i<track->n_styles; ++i) {
+		// FIXME: mb strcasecmp ?
+		if (strcmp(track->styles[i].Name, name) == 0)
+			return i;
+	}
+	i = track->default_style;
+	mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NoStyleNamedXFoundUsingY, track, name, track->styles[i].Name);
+	return i; // use the first style
+}
+
+static uint32_t string2color(char* p) {
+	uint32_t tmp;
+	(void)strtocolor(&p, &tmp);
+	return tmp;
+}
+
+static long long string2timecode(char* p) {
+	unsigned h, m, s, ms;
+	long long tm;
+	int res = sscanf(p, "%1d:%2d:%2d.%2d", &h, &m, &s, &ms);
+	if (res < 4) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_BadTimestamp);
+		return 0;
+	}
+	tm = ((h * 60 + m) * 60 + s) * 1000 + ms * 10;
+	return tm;
+}
+
+/**
+ * \brief converts numpad-style align to align.
+ */
+static int numpad2align(int val) {
+	int res, v;
+	v = (val - 1) / 3; // 0, 1 or 2 for vertical alignment
+	if (v != 0) v = 3 - v;
+	res = ((val - 1) % 3) + 1; // horizontal alignment
+	res += v*4;
+	return res;
+}
+
+#define NEXT(str,token) \
+	token = next_token(&str); \
+	if (!token) break;
+
+#define ANYVAL(name,func) \
+	} else if (strcasecmp(tname, #name) == 0) { \
+		target->name = func(token); \
+		mp_msg(MSGT_ASS, MSGL_DBG2, "%s = %s\n", #name, token);
+
+#define STRVAL(name) \
+	} else if (strcasecmp(tname, #name) == 0) { \
+		if (target->name != NULL) free(target->name); \
+		target->name = strdup(token); \
+		mp_msg(MSGT_ASS, MSGL_DBG2, "%s = %s\n", #name, token);
+		
+#define COLORVAL(name) ANYVAL(name,string2color)
+#define INTVAL(name) ANYVAL(name,atoi)
+#define FPVAL(name) ANYVAL(name,atof)
+#define TIMEVAL(name) ANYVAL(name,string2timecode)
+#define STYLEVAL(name) \
+	} else if (strcasecmp(tname, #name) == 0) { \
+		target->name = lookup_style(track, token); \
+		mp_msg(MSGT_ASS, MSGL_DBG2, "%s = %s\n", #name, token);
+
+#define ALIAS(alias,name) \
+	if (strcasecmp(tname, #alias) == 0) {tname = #name;}
+
+static char* next_token(char** str) {
+	char* p = *str;
+	char* start;
+	skip_spaces(&p);
+	if (*p == '\0') {
+		*str = p;
+		return 0;
+	}
+	start = p; // start of the token
+	for (; (*p != '\0') && (*p != ','); ++p) {}
+	if (*p == '\0') {
+		*str = p; // eos found, str will point to '\0' at exit
+	} else {
+		*p = '\0';
+		*str = p + 1; // ',' found, str will point to the next char (beginning of the next token)
+	}
+	--p; // end of current token
+	rskip_spaces(&p, start);
+	if (p < start)
+		p = start; // empty token
+	else
+		++p; // the first space character, or '\0'
+	*p = '\0';
+	return start;
+}
+/**
+ * \brief Parse the tail of Dialogue line
+ * \param track track
+ * \param event parsed data goes here
+ * \param str string to parse, zero-terminated
+ * \param n_ignored number of format options to skip at the beginning
+*/ 
+static int process_event_tail(ass_track_t* track, ass_event_t* event, char* str, int n_ignored)
+{
+	char* token;
+	char* tname;
+	char* p = str;
+	int i;
+	ass_event_t* target = event;
+
+	char* format = strdup(track->event_format);
+	char* q = format; // format scanning pointer
+
+	if (track->n_styles == 0) {
+		// add "Default" style to the end
+		// will be used if track does not contain a default style (or even does not contain styles at all)
+		int sid = ass_alloc_style(track);
+		track->styles[sid].Name = strdup("Default");
+		track->styles[sid].FontName = strdup("Arial");
+	}
+
+	for (i = 0; i < n_ignored; ++i) {
+		NEXT(q, tname);
+	}
+
+	while (1) {
+		NEXT(q, tname);
+		if (strcasecmp(tname, "Text") == 0) {
+			char* last;
+			event->Text = strdup(p);
+			if (*event->Text != 0) {
+				last = event->Text + strlen(event->Text) - 1;
+				if (last >= event->Text && *last == '\r')
+					*last = 0;
+			}
+			mp_msg(MSGT_ASS, MSGL_DBG2, "Text = %s\n", event->Text);
+			event->Duration -= event->Start;
+			free(format);
+			return 0; // "Text" is always the last
+		}
+		NEXT(p, token);
+
+		ALIAS(End,Duration) // temporarily store end timecode in event->Duration
+		if (0) { // cool ;)
+			INTVAL(Layer)
+			STYLEVAL(Style)
+			STRVAL(Name)
+			STRVAL(Effect)
+			INTVAL(MarginL)
+			INTVAL(MarginR)
+			INTVAL(MarginV)
+			TIMEVAL(Start)
+			TIMEVAL(Duration)
+		}
+	}
+	free(format);
+	return 1;
+}
+
+/**
+ * \brief Parse command line style overrides (--ass-force-style option)
+ * \param track track to apply overrides to
+ * The format for overrides is [StyleName.]Field=Value
+ */
+void process_force_style(ass_track_t* track) {
+	char **fs, *eq, *dt, *style, *tname, *token;
+	ass_style_t* target;
+	int sid;
+	char** list = track->library->style_overrides;
+	
+	if (!list) return;
+	
+	for (fs = list; *fs; ++fs) {
+		eq = strrchr(*fs, '=');
+		if (!eq)
+			continue;
+		*eq = '\0';
+		token = eq + 1;
+
+		dt = strrchr(*fs, '.');
+		if (dt) {
+			*dt = '\0';
+			style = *fs;
+			tname = dt + 1;
+		} else {
+			style = NULL;
+			tname = *fs;
+		}
+		for (sid = 0; sid < track->n_styles; ++sid) {
+			if (style == NULL || strcasecmp(track->styles[sid].Name, style) == 0) {
+				target = track->styles + sid;
+				if (0) {
+					STRVAL(FontName)
+					COLORVAL(PrimaryColour)
+					COLORVAL(SecondaryColour)
+					COLORVAL(OutlineColour)
+					COLORVAL(BackColour)
+					FPVAL(FontSize)
+					INTVAL(Bold)
+					INTVAL(Italic)
+					INTVAL(Underline)
+					INTVAL(StrikeOut)
+					FPVAL(Spacing)
+					INTVAL(Angle)
+					INTVAL(BorderStyle)
+					INTVAL(Alignment)
+					INTVAL(MarginL)
+					INTVAL(MarginR)
+					INTVAL(MarginV)
+					INTVAL(Encoding)
+					FPVAL(ScaleX)
+					FPVAL(ScaleY)
+					FPVAL(Outline)
+					FPVAL(Shadow)
+				}
+			}
+		}
+		*eq = '=';
+		if (dt) *dt = '.';
+	}
+}
+
+/**
+ * \brief Parse the Style line
+ * \param track track
+ * \param str string to parse, zero-terminated
+ * Allocates a new style struct.
+*/ 
+static int process_style(ass_track_t* track, char *str)
+{
+
+	char* token;
+	char* tname;
+	char* p = str;
+	char* format;
+	char* q; // format scanning pointer
+	int sid;
+	ass_style_t* style;
+	ass_style_t* target;
+
+	if (!track->style_format) {
+		// no style format header
+		// probably an ancient script version
+		if (track->track_type == TRACK_TYPE_SSA)
+			track->style_format = strdup("Name, Fontname, Fontsize, PrimaryColour, SecondaryColour,"
+					"TertiaryColour, BackColour, Bold, Italic, BorderStyle, Outline,"
+					"Shadow, Alignment, MarginL, MarginR, MarginV, AlphaLevel, Encoding");
+		else
+			track->style_format = strdup("Name, Fontname, Fontsize, PrimaryColour, SecondaryColour,"
+					"OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut,"
+					"ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow,"
+					"Alignment, MarginL, MarginR, MarginV, Encoding");
+	}
+
+	q = format = strdup(track->style_format);
+	
+	mp_msg(MSGT_ASS, MSGL_V, "[%p] Style: %s\n", track, str);
+	
+	sid = ass_alloc_style(track);
+
+	style = track->styles + sid;
+	target = style;
+// fill style with some default values
+	style->ScaleX = 100.;
+	style->ScaleY = 100.;
+	
+	while (1) {
+		NEXT(q, tname);
+		NEXT(p, token);
+		
+//		ALIAS(TertiaryColour,OutlineColour) // ignore TertiaryColour; it appears only in SSA, and is overridden by BackColour
+			
+		if (0) { // cool ;)
+			STRVAL(Name)
+				if ((strcmp(target->Name, "Default")==0) || (strcmp(target->Name, "*Default")==0))
+					track->default_style = sid;
+			STRVAL(FontName)
+			COLORVAL(PrimaryColour)
+			COLORVAL(SecondaryColour)
+			COLORVAL(OutlineColour) // TertiaryColor
+			COLORVAL(BackColour)
+				// SSA uses BackColour for both outline and shadow
+				// this will destroy SSA's TertiaryColour, but i'm not going to use it anyway
+				if (track->track_type == TRACK_TYPE_SSA)
+					target->OutlineColour = target->BackColour;
+			FPVAL(FontSize)
+			INTVAL(Bold)
+			INTVAL(Italic)
+			INTVAL(Underline)
+			INTVAL(StrikeOut)
+			FPVAL(Spacing)
+			INTVAL(Angle)
+			INTVAL(BorderStyle)
+			INTVAL(Alignment)
+				if (track->track_type == TRACK_TYPE_ASS)
+					target->Alignment = numpad2align(target->Alignment);
+			INTVAL(MarginL)
+			INTVAL(MarginR)
+			INTVAL(MarginV)
+			INTVAL(Encoding)
+			FPVAL(ScaleX)
+			FPVAL(ScaleY)
+			FPVAL(Outline)
+			FPVAL(Shadow)
+		}
+	}
+	style->ScaleX /= 100.;
+	style->ScaleY /= 100.;
+	style->Bold = !!style->Bold;
+	style->Italic = !!style->Italic;
+	style->Underline = !!style->Underline;
+	if (!style->Name)
+		style->Name = strdup("Default");
+	if (!style->FontName)
+		style->FontName = strdup("Arial");
+	free(format);
+	return 0;
+	
+}
+
+static int process_styles_line(ass_track_t* track, char *str)
+{
+	if (!strncmp(str,"Format:", 7)) {
+		char* p = str + 7;
+		skip_spaces(&p);
+		track->style_format = strdup(p);
+		mp_msg(MSGT_ASS, MSGL_DBG2, "Style format: %s\n", track->style_format);
+	} else if (!strncmp(str,"Style:", 6)) {
+		char* p = str + 6;
+		skip_spaces(&p);
+		process_style(track, p);
+	}
+	return 0;
+}
+
+static int process_info_line(ass_track_t* track, char *str)
+{
+	if (!strncmp(str, "PlayResX:", 9)) {
+		track->PlayResX = atoi(str + 9);
+	} else if (!strncmp(str,"PlayResY:", 9)) {
+		track->PlayResY = atoi(str + 9);
+	} else if (!strncmp(str,"Timer:", 6)) {
+		track->Timer = atof(str + 6);
+	} else if (!strncmp(str,"WrapStyle:", 10)) {
+		track->WrapStyle = atoi(str + 10);
+	}
+	return 0;
+}
+
+static int process_events_line(ass_track_t* track, char *str)
+{
+	if (!strncmp(str, "Format:", 7)) {
+		char* p = str + 7;
+		skip_spaces(&p);
+		track->event_format = strdup(p);
+		mp_msg(MSGT_ASS, MSGL_DBG2, "Event format: %s\n", track->event_format);
+	} else if (!strncmp(str, "Dialogue:", 9)) {
+		// This should never be reached for embedded subtitles.
+		// They have slightly different format and are parsed in ass_process_chunk,
+		// called directly from demuxer
+		int eid;
+		ass_event_t* event;
+		
+		str += 9;
+		skip_spaces(&str);
+
+		eid = ass_alloc_event(track);
+		event = track->events + eid;
+
+		process_event_tail(track, event, str, 0);
+	} else {
+		mp_msg(MSGT_ASS, MSGL_V, "Not understood: %s  \n", str);
+	}
+	return 0;
+}
+
+// Copied from mkvtoolnix
+static unsigned char* decode_chars(unsigned char c1, unsigned char c2,
+		unsigned char c3, unsigned char c4, unsigned char* dst, int cnt)
+{
+	uint32_t value;
+	unsigned char bytes[3];
+	int i;
+
+	value = ((c1 - 33) << 18) + ((c2 - 33) << 12) + ((c3 - 33) << 6) + (c4 - 33);
+	bytes[2] = value & 0xff;
+	bytes[1] = (value & 0xff00) >> 8;
+	bytes[0] = (value & 0xff0000) >> 16;
+
+	for (i = 0; i < cnt; ++i)
+		*dst++ = bytes[i];
+	return dst;
+}
+
+static int decode_font(ass_track_t* track)
+{
+	unsigned char* p;
+	unsigned char* q;
+	int i;
+	int size; // original size
+	int dsize; // decoded size
+	unsigned char* buf = 0;
+
+	mp_msg(MSGT_ASS, MSGL_V, "font: %d bytes encoded data \n", track->parser_priv->fontdata_used);
+	size = track->parser_priv->fontdata_used;
+	if (size % 4 == 1) {
+		mp_msg(MSGT_ASS, MSGL_ERR, MSGTR_LIBASS_BadEncodedDataSize);
+		goto error_decode_font;
+	}
+	buf = malloc(size / 4 * 3 + 2);
+	q = buf;
+	for (i = 0, p = (unsigned char*)track->parser_priv->fontdata; i < size / 4; i++, p+=4) {
+		q = decode_chars(p[0], p[1], p[2], p[3], q, 3);
+	}
+	if (size % 4 == 2) {
+		q = decode_chars(p[0], p[1], 0, 0, q, 1);
+	} else if (size % 4 == 3) {
+		q = decode_chars(p[0], p[1], p[2], 0, q, 2);
+	}
+	dsize = q - buf;
+	assert(dsize <= size / 4 * 3 + 2);
+	
+	if (track->library->extract_fonts) {
+		ass_add_font(track->library, track->parser_priv->fontname, (char*)buf, dsize);
+		buf = 0;
+	}
+
+error_decode_font:
+	if (buf) free(buf);
+	free(track->parser_priv->fontname);
+	free(track->parser_priv->fontdata);
+	track->parser_priv->fontname = 0;
+	track->parser_priv->fontdata = 0;
+	track->parser_priv->fontdata_size = 0;
+	track->parser_priv->fontdata_used = 0;
+	return 0;
+}
+
+static int process_fonts_line(ass_track_t* track, char *str)
+{
+	int len;
+
+	if (!strncmp(str, "fontname:", 9)) {
+		char* p = str + 9;
+		skip_spaces(&p);
+		if (track->parser_priv->fontname) {
+			decode_font(track);
+		}
+		track->parser_priv->fontname = strdup(p);
+		mp_msg(MSGT_ASS, MSGL_V, "fontname: %s\n", track->parser_priv->fontname);
+		return 0;
+	}
+	
+	if (!track->parser_priv->fontname) {
+		mp_msg(MSGT_ASS, MSGL_V, "Not understood: %s  \n", str);
+		return 0;
+	}
+
+	len = strlen(str);
+	if (len > 80) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FontLineTooLong, len, str);
+		return 0;
+	}
+	if (track->parser_priv->fontdata_used + len > track->parser_priv->fontdata_size) {
+		track->parser_priv->fontdata_size += 100 * 1024;
+		track->parser_priv->fontdata = realloc(track->parser_priv->fontdata, track->parser_priv->fontdata_size);
+	}
+	memcpy(track->parser_priv->fontdata + track->parser_priv->fontdata_used, str, len);
+	track->parser_priv->fontdata_used += len;
+	
+	return 0;
+}
+
+/**
+ * \brief Parse a header line
+ * \param track track
+ * \param str string to parse, zero-terminated
+*/ 
+static int process_line(ass_track_t* track, char *str)
+{
+	if (strstr(str, "[Script Info]")) { // FIXME: strstr to skip possible BOM at the beginning of the script
+		track->parser_priv->state = PST_INFO;
+	} else if (!strncmp(str, "[V4 Styles]", 11)) {
+		track->parser_priv->state = PST_STYLES;
+		track->track_type = TRACK_TYPE_SSA;
+	} else if (!strncmp(str, "[V4+ Styles]", 12)) {
+		track->parser_priv->state = PST_STYLES;
+		track->track_type = TRACK_TYPE_ASS;
+	} else if (!strncmp(str, "[Events]", 8)) {
+		track->parser_priv->state = PST_EVENTS;
+	} else if (!strncmp(str, "[Fonts]", 7)) {
+		track->parser_priv->state = PST_FONTS;
+	} else {
+		switch (track->parser_priv->state) {
+		case PST_INFO:
+			process_info_line(track, str);
+			break;
+		case PST_STYLES:
+			process_styles_line(track, str);
+			break;
+		case PST_EVENTS:
+			process_events_line(track, str);
+			break;
+		case PST_FONTS:
+			process_fonts_line(track, str);
+			break;
+		default:
+			break;
+		}
+	}
+
+	// there is no explicit end-of-font marker in ssa/ass
+	if ((track->parser_priv->state != PST_FONTS) && (track->parser_priv->fontname))
+		decode_font(track);
+
+	return 0;
+}
+
+static int process_text(ass_track_t* track, char* str)
+{
+	char* p = str;
+	while(1) {
+		char* q;
+		for (;((*p=='\r')||(*p=='\n'));++p) {}
+		for (q=p; ((*q!='\0')&&(*q!='\r')&&(*q!='\n')); ++q) {};
+		if (q==p)
+			break;
+		if (*q != '\0')
+			*(q++) = '\0';
+		process_line(track, p);
+		if (*q == '\0')
+			break;
+		p = q;
+	}
+	return 0;
+}
+
+/**
+ * \brief Process CodecPrivate section of subtitle stream
+ * \param track track
+ * \param data string to parse
+ * \param size length of data
+ CodecPrivate section contains [Stream Info] and [V4+ Styles] ([V4 Styles] for SSA) sections
+*/ 
+void ass_process_codec_private(ass_track_t* track, char *data, int size)
+{
+	char* str = malloc(size + 1);
+
+	memcpy(str, data, size);
+	str[size] = '\0';
+
+	process_text(track, str);
+	free(str);
+
+	if (!track->event_format) {
+		// probably an mkv produced by ancient mkvtoolnix
+		// such files don't have [Events] and Format: headers
+		track->parser_priv->state = PST_EVENTS;
+		if (track->track_type == TRACK_TYPE_SSA)
+			track->event_format = strdup("Format: Marked, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text");
+		else
+			track->event_format = strdup("Format: Layer, Start, End, Style, Actor, MarginL, MarginR, MarginV, Effect, Text");
+	}
+
+	process_force_style(track);
+}
+
+static int check_duplicate_event(ass_track_t* track, int ReadOrder)
+{
+	int i;
+	for (i = 0; i<track->n_events - 1; ++i) // ignoring last event, it is the one we are comparing with
+		if (track->events[i].ReadOrder == ReadOrder)
+			return 1;
+	return 0;
+}
+
+/**
+ * \brief Process a chunk of subtitle stream data. In matroska, this containes exactly 1 event (or a commentary)
+ * \param track track
+ * \param data string to parse
+ * \param size length of data
+ * \param timecode starting time of the event (milliseconds)
+ * \param duration duration of the event (milliseconds)
+*/ 
+void ass_process_chunk(ass_track_t* track, char *data, int size, long long timecode, long long duration)
+{
+	char* str;
+	int eid;
+	char* p;
+	char* token;
+	ass_event_t* event;
+
+	if (!track->event_format) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_EventFormatHeaderMissing);
+		return;
+	}
+	
+	str = malloc(size + 1);
+	memcpy(str, data, size);
+	str[size] = '\0';
+	mp_msg(MSGT_ASS, MSGL_V, "event at %" PRId64 ", +%" PRId64 ": %s  \n", (int64_t)timecode, (int64_t)duration, str);
+
+	eid = ass_alloc_event(track);
+	event = track->events + eid;
+
+	p = str;
+	
+	do { 
+		NEXT(p, token);
+		event->ReadOrder = atoi(token);
+		if (check_duplicate_event(track, event->ReadOrder))
+			break;
+
+		NEXT(p, token);
+		event->Layer = atoi(token);
+
+		process_event_tail(track, event, p, 3);
+
+		event->Start = timecode;
+		event->Duration = duration;
+		
+		free(str);
+		return;
+//		dump_events(tid);
+	} while (0);
+	// some error
+	ass_free_event(track, eid);
+	track->n_events--;
+	free(str);
+}
+
+#ifdef USE_ICONV
+/** \brief recode buffer to utf-8
+ * constraint: codepage != 0
+ * \param data pointer to text buffer
+ * \param size buffer size
+ * \return a pointer to recoded buffer, caller is responsible for freeing it
+**/
+static char* sub_recode(char* data, size_t size, char* codepage)
+{
+	static iconv_t icdsc = (iconv_t)(-1);
+	char* tocp = "UTF-8";
+	char* outbuf;
+	assert(codepage);
+
+	{
+		char* cp_tmp = codepage ? strdup(codepage) : 0;
+#ifdef HAVE_ENCA
+		char enca_lang[3], enca_fallback[100];
+		if (sscanf(codepage, "enca:%2s:%99s", enca_lang, enca_fallback) == 2
+				|| sscanf(codepage, "ENCA:%2s:%99s", enca_lang, enca_fallback) == 2) {
+			cp_tmp = guess_buffer_cp((unsigned char*)data, size, enca_lang, enca_fallback);
+		}
+#endif
+		if ((icdsc = iconv_open (tocp, cp_tmp)) != (iconv_t)(-1)){
+			mp_msg(MSGT_ASS,MSGL_V,"LIBSUB: opened iconv descriptor.\n");
+		} else
+			mp_msg(MSGT_ASS,MSGL_ERR,MSGTR_LIBASS_ErrorOpeningIconvDescriptor);
+#ifdef HAVE_ENCA
+		if (cp_tmp) free(cp_tmp);
+#endif
+	}
+
+	{
+		size_t osize = size;
+		size_t ileft = size;
+		size_t oleft = size - 1;
+		char* ip;
+		char* op;
+		size_t rc;
+		
+		outbuf = malloc(size);
+		ip = data;
+		op = outbuf;
+		
+		while (ileft) {
+			rc = iconv(icdsc, &ip, &ileft, &op, &oleft);
+			if (rc == (size_t)(-1)) {
+				if (errno == E2BIG) {
+					int offset = op - outbuf;
+					outbuf = (char*)realloc(outbuf, osize + size);
+					op = outbuf + offset;
+					osize += size;
+					oleft += size;
+				} else {
+					mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorRecodingFile);
+					return NULL;
+				}
+			}
+		}
+		outbuf[osize - oleft - 1] = 0;
+	}
+
+	if (icdsc != (iconv_t)(-1)) {
+		(void)iconv_close(icdsc);
+		icdsc = (iconv_t)(-1);
+		mp_msg(MSGT_ASS,MSGL_V,"LIBSUB: closed iconv descriptor.\n");
+	}
+	
+	return outbuf;
+}
+#endif // ICONV
+
+/**
+ * \brief read file contents into newly allocated buffer
+ * \param fname file name
+ * \param bufsize out: file size
+ * \return pointer to file contents. Caller is responsible for its deallocation.
+ */
+static char* read_file(char* fname, size_t *bufsize)
+{
+	int res;
+	long sz;
+	long bytes_read;
+	char* buf;
+
+	FILE* fp = fopen(fname, "rb");
+	if (!fp) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FopenFailed, fname);
+		return 0;
+	}
+	res = fseek(fp, 0, SEEK_END);
+	if (res == -1) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FseekFailed, fname);
+		fclose(fp);
+		return 0;
+	}
+	
+	sz = ftell(fp);
+	rewind(fp);
+
+	if (sz > 10*1024*1024) {
+		mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_RefusingToLoadSubtitlesLargerThan10M, fname);
+		fclose(fp);
+		return 0;
+	}
+	
+	mp_msg(MSGT_ASS, MSGL_V, "file size: %ld\n", sz);
+	
+	buf = malloc(sz + 1);
+	assert(buf);
+	bytes_read = 0;
+	do {
+		res = fread(buf + bytes_read, 1, sz - bytes_read, fp);
+		if (res <= 0) {
+			mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_ReadFailed, errno, strerror(errno));
+			fclose(fp);
+			free(buf);
+			return 0;
+		}
+		bytes_read += res;
+	} while (sz - bytes_read > 0);
+	buf[sz] = '\0';
+	fclose(fp);
+	
+	if (bufsize)
+		*bufsize = sz;
+	return buf;
+}
+
+/*
+ * \param buf pointer to subtitle text in utf-8
+ */
+static ass_track_t* parse_memory(ass_library_t* library, char* buf)
+{
+	ass_track_t* track;
+	int i;
+	
+	track = ass_new_track(library);
+	
+	// process header
+	process_text(track, buf);
+
+	// external SSA/ASS subs does not have ReadOrder field
+	for (i = 0; i < track->n_events; ++i)
+		track->events[i].ReadOrder = i;
+
+	// there is no explicit end-of-font marker in ssa/ass
+	if (track->parser_priv->fontname)
+		decode_font(track);
+
+	if (track->track_type == TRACK_TYPE_UNKNOWN) {
+		ass_free_track(track);
+		return 0;
+	}
+
+	process_force_style(track);
+
+	return track;
+}
+
+/**
+ * \brief Read subtitles from memory.
+ * \param library libass library object
+ * \param buf pointer to subtitles text
+ * \param bufsize size of buffer
+ * \param codepage recode buffer contents from given codepage
+ * \return newly allocated track
+*/ 
+ass_track_t* ass_read_memory(ass_library_t* library, char* buf, size_t bufsize, char* codepage)
+{
+	ass_track_t* track;
+	int need_free = 0;
+	
+	if (!buf)
+		return 0;
+	
+#ifdef USE_ICONV
+	if (codepage)
+		buf = sub_recode(buf, bufsize, codepage);
+	if (!buf)
+		return 0;
+	else
+		need_free = 1;
+#endif
+	track = parse_memory(library, buf);
+	if (need_free)
+		free(buf);
+	if (!track)
+		return 0;
+
+	mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_AddedSubtitleFileMemory, track->n_styles, track->n_events);
+	return track;
+}
+
+char* read_file_recode(char* fname, char* codepage, int* size)
+{
+	char* buf;
+	size_t bufsize;
+	
+	buf = read_file(fname, &bufsize);
+	if (!buf)
+		return 0;
+#ifdef USE_ICONV
+	if (codepage) {
+		 char* tmpbuf = sub_recode(buf, bufsize, codepage);
+		 free(buf);
+		 buf = tmpbuf;
+	}
+	if (!buf)
+		return 0;
+#endif
+	*size = bufsize;
+	return buf;
+}
+
+/**
+ * \brief Read subtitles from file.
+ * \param library libass library object
+ * \param fname file name
+ * \param codepage recode buffer contents from given codepage
+ * \return newly allocated track
+*/ 
+ass_track_t* ass_read_file(ass_library_t* library, char* fname, char* codepage)
+{
+	char* buf;
+	ass_track_t* track;
+	size_t bufsize;
+
+	buf = read_file_recode(fname, codepage, &bufsize);
+	if (!buf)
+		return 0;
+	track = parse_memory(library, buf);
+	free(buf);
+	if (!track)
+		return 0;
+	
+	track->name = strdup(fname);
+
+	mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_AddedSubtitleFileFname, fname, track->n_styles, track->n_events);
+	
+//	dump_events(forced_tid);
+	return track;
+}
+
+/**
+ * \brief read styles from file into already initialized track
+ */
+int ass_read_styles(ass_track_t* track, char* fname, char* codepage)
+{
+	char* buf;
+	parser_state_t old_state;
+	size_t sz;
+
+	buf = read_file(fname, &sz);
+	if (!buf)
+		return 1;
+#ifdef USE_ICONV
+	if (codepage) {
+		char* tmpbuf;
+		tmpbuf = sub_recode(buf, sz, codepage);
+		free(buf);
+		buf = tmpbuf;
+	}
+	if (!buf)
+		return 0;
+#endif
+
+	old_state = track->parser_priv->state;
+	track->parser_priv->state = PST_STYLES;
+	process_text(track, buf);
+	track->parser_priv->state = old_state;
+
+	return 0;
+}
+
+long long ass_step_sub(ass_track_t* track, long long now, int movement) {
+	int i;
+
+	if (movement == 0) return 0;
+	if (track->n_events == 0) return 0;
+	
+	if (movement < 0)
+		for (i = 0; (i < track->n_events) && ((long long)(track->events[i].Start + track->events[i].Duration) <= now); ++i) {}
+	else
+		for (i = track->n_events - 1; (i >= 0) && ((long long)(track->events[i].Start) > now); --i) {}
+	
+	// -1 and n_events are ok
+	assert(i >= -1); assert(i <= track->n_events);
+	i += movement;
+	if (i < 0) i = 0;
+	if (i >= track->n_events) i = track->n_events - 1;
+	return ((long long)track->events[i].Start) - now;
+}
+
+ass_track_t* ass_new_track(ass_library_t* library) {
+	ass_track_t* track = calloc(1, sizeof(ass_track_t));
+	track->library = library;
+	track->parser_priv = calloc(1, sizeof(parser_priv_t));
+	return track;
+}
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.h	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,209 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+#ifndef ASS_H
+#define ASS_H
+
+#include "ass_types.h"
+
+/// Libass renderer object. Contents are private.
+typedef struct ass_renderer_s ass_renderer_t;
+
+/// a linked list of images produced by ass renderer
+typedef struct ass_image_s {
+	int w, h; // bitmap width/height
+	int stride; // bitmap stride
+	unsigned char* bitmap; // 1bpp stride*h alpha buffer
+	uint32_t color; // RGBA
+	int dst_x, dst_y; // bitmap placement inside the video frame
+
+	struct ass_image_s* next; // linked list
+} ass_image_t;
+
+/// Hinting type
+typedef enum {ASS_HINTING_NONE = 0,
+	      ASS_HINTING_LIGHT,
+	      ASS_HINTING_NORMAL,
+	      ASS_HINTING_NATIVE
+} ass_hinting_t;
+
+/**
+ * \brief initialize the library
+ * \return library handle or NULL if failed
+ */
+ass_library_t* ass_library_init(void);
+
+/**
+ * \brief finalize the library
+ * \param priv library handle
+ */
+void ass_library_done(ass_library_t*);
+
+/**
+ * \brief set private font directory
+ * It is used for saving embedded fonts and also in font lookup.
+ */
+void ass_set_fonts_dir(ass_library_t* priv, const char* fonts_dir);
+
+void ass_set_extract_fonts(ass_library_t* priv, int extract);
+
+void ass_set_style_overrides(ass_library_t* priv, char** list);
+
+/**
+ * \brief initialize the renderer
+ * \param priv library handle
+ * \return renderer handle or NULL if failed
+ */
+ass_renderer_t* ass_renderer_init(ass_library_t*);
+
+/**
+ * \brief finalize the renderer
+ * \param priv renderer handle
+ */
+void ass_renderer_done(ass_renderer_t* priv);
+
+void ass_set_frame_size(ass_renderer_t* priv, int w, int h);
+void ass_set_margins(ass_renderer_t* priv, int t, int b, int l, int r);
+void ass_set_use_margins(ass_renderer_t* priv, int use);
+void ass_set_aspect_ratio(ass_renderer_t* priv, double ar);
+void ass_set_font_scale(ass_renderer_t* priv, double font_scale);
+void ass_set_hinting(ass_renderer_t* priv, ass_hinting_t ht);
+void ass_set_line_spacing(ass_renderer_t* priv, double line_spacing);
+
+/**
+ * \brief set font lookup defaults
+ */
+int  ass_set_fonts(ass_renderer_t* priv, const char* default_font, const char* default_family);
+
+/**
+ * \brief render a frame, producing a list of ass_image_t
+ * \param priv library
+ * \param track subtitle track
+ * \param now video timestamp in milliseconds
+ */
+ass_image_t* ass_render_frame(ass_renderer_t *priv, ass_track_t* track, long long now, int* detect_change);
+
+
+// The following functions operate on track objects and do not need an ass_renderer //
+
+/**
+ * \brief allocate a new empty track object
+ * \return pointer to empty track
+ */
+ass_track_t* ass_new_track(ass_library_t*);
+
+/**
+ * \brief deallocate track and all its child objects (styles and events)
+ * \param track track to deallocate
+ */
+void ass_free_track(ass_track_t* track);
+
+/**
+ * \brief allocate new style
+ * \param track track
+ * \return newly allocated style id
+ */
+int ass_alloc_style(ass_track_t* track);
+
+/**
+ * \brief allocate new event
+ * \param track track
+ * \return newly allocated event id
+ */
+int ass_alloc_event(ass_track_t* track);
+
+/**
+ * \brief delete a style
+ * \param track track
+ * \param sid style id
+ * Deallocates style data. Does not modify track->n_styles.
+ */
+void ass_free_style(ass_track_t* track, int sid);
+
+/**
+ * \brief delete an event
+ * \param track track
+ * \param eid event id
+ * Deallocates event data. Does not modify track->n_events.
+ */
+void ass_free_event(ass_track_t* track, int eid);
+
+/**
+ * \brief Process Codec Private section of subtitle stream
+ * \param track target track
+ * \param data string to parse
+ * \param size length of data
+ */
+void ass_process_codec_private(ass_track_t* track, char *data, int size);
+
+/**
+ * \brief Process a chunk of subtitle stream data. In matroska, this containes exactly 1 event (or a commentary)
+ * \param track track
+ * \param data string to parse
+ * \param size length of data
+ * \param timecode starting time of the event (milliseconds)
+ * \param duration duration of the event (milliseconds)
+*/
+void ass_process_chunk(ass_track_t* track, char *data, int size, long long timecode, long long duration);
+
+char* read_file_recode(char* fname, char* codepage, int* size);
+
+/**
+ * \brief Read subtitles from file.
+ * \param fname file name
+ * \return newly allocated track
+*/
+ass_track_t* ass_read_file(ass_library_t* library, char* fname, char* codepage);
+
+/**
+ * \brief Read subtitles from memory.
+ * \param library libass library object
+ * \param buf pointer to subtitles text
+ * \param bufsize size of buffer
+ * \param codepage recode buffer contents from given codepage
+ * \return newly allocated track
+*/ 
+ass_track_t* ass_read_memory(ass_library_t* library, char* buf, size_t bufsize, char* codepage);
+/**
+ * \brief read styles from file into already initialized track
+ * \return 0 on success
+ */
+int ass_read_styles(ass_track_t* track, char* fname, char* codepage);
+
+/**
+ * \brief Add a memory font.
+ * \param name attachment name
+ * \param data binary font data
+ * \param data_size data size
+*/
+void ass_add_font(ass_library_t* library, char* name, char* data, int data_size);
+
+/**
+ * \brief Calculates timeshift from now to the start of some other subtitle event, depending on movement parameter
+ * \param track subtitle track
+ * \param now current time, ms
+ * \param movement how many events to skip from the one currently displayed
+ * +2 means "the one after the next", -1 means "previous"
+ * \return timeshift, ms
+ */
+long long ass_step_sub(ass_track_t* track, long long now, int movement);
+
+#endif
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.c	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,272 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+#include <stdlib.h>
+#include <string.h>
+#include <math.h>
+#include <assert.h>
+#include <ft2build.h>
+#include FT_GLYPH_H
+
+#include "mputils.h"
+#include "ass_bitmap.h"
+
+struct ass_synth_priv_s {
+	int tmp_w, tmp_h;
+	unsigned short* tmp;
+
+	int g_r;
+	int g_w;
+
+	unsigned *g;
+	unsigned *gt2;
+};
+
+static const unsigned int maxcolor = 255;
+static const unsigned base = 256;
+static const double blur_radius = 1.5;
+
+static int generate_tables(ass_synth_priv_t* priv, double radius)
+{
+	double A = log(1.0/base)/(radius*radius*2);
+	int mx, i;
+	double volume_diff, volume_factor = 0;
+	unsigned volume;
+
+	priv->g_r = ceil(radius);
+	priv->g_w = 2*priv->g_r+1;
+
+	if (priv->g_r) {
+		priv->g = malloc(priv->g_w * sizeof(unsigned));
+		priv->gt2 = malloc(256 * priv->g_w * sizeof(unsigned));
+		if (priv->g==NULL || priv->gt2==NULL) {
+			return -1;
+		}
+	}
+
+	if (priv->g_r) {
+		// gaussian curve with volume = 256
+		for (volume_diff=10000000; volume_diff>0.0000001; volume_diff*=0.5){
+			volume_factor+= volume_diff;
+			volume=0;
+			for (i = 0; i<priv->g_w; ++i) {
+				priv->g[i] = (unsigned)(exp(A * (i-priv->g_r)*(i-priv->g_r)) * volume_factor + .5);
+				volume+= priv->g[i];
+			}
+			if(volume>256) volume_factor-= volume_diff;
+		}
+		volume=0;
+		for (i = 0; i<priv->g_w; ++i) {
+			priv->g[i] = (unsigned)(exp(A * (i-priv->g_r)*(i-priv->g_r)) * volume_factor + .5);
+			volume+= priv->g[i];
+		}
+
+		// gauss table:
+		for(mx=0;mx<priv->g_w;mx++){
+			for(i=0;i<256;i++){
+				priv->gt2[mx+i*priv->g_w] = i*priv->g[mx];
+			}
+		}
+	}
+
+	return 0;
+}
+
+static void resize_tmp(ass_synth_priv_t* priv, int w, int h)
+{
+	if (priv->tmp_w >= w && priv->tmp_h >= h)
+		return;
+	if (priv->tmp_w == 0)
+		priv->tmp_w = 64;
+	if (priv->tmp_h == 0)
+		priv->tmp_h = 64;
+	while (priv->tmp_w < w) priv->tmp_w *= 2;
+	while (priv->tmp_h < h) priv->tmp_h *= 2;
+	if (priv->tmp)
+		free(priv->tmp);
+	priv->tmp = malloc((priv->tmp_w + 1) * priv->tmp_h * sizeof(short));
+}
+
+ass_synth_priv_t* ass_synth_init(void)
+{
+	ass_synth_priv_t* priv = calloc(1, sizeof(ass_synth_priv_t));
+	generate_tables(priv, blur_radius);
+	return priv;
+}
+
+void ass_synth_done(ass_synth_priv_t* priv)
+{
+	if (priv->tmp)
+		free(priv->tmp);
+	if (priv->g)
+		free(priv->g);
+	if (priv->gt2)
+		free(priv->gt2);
+	free(priv);
+}
+
+static bitmap_t* alloc_bitmap(int w, int h)
+{
+	bitmap_t* bm;
+	bm = calloc(1, sizeof(bitmap_t));
+	bm->buffer = malloc(w*h);
+	bm->w = w;
+	bm->h = h;
+	bm->left = bm->top = 0;
+	return bm;
+}
+
+void ass_free_bitmap(bitmap_t* bm)
+{
+	if (bm) {
+		if (bm->buffer) free(bm->buffer);
+		free(bm);
+	}
+}
+
+static bitmap_t* copy_bitmap(const bitmap_t* src)
+{
+	bitmap_t* dst = alloc_bitmap(src->w, src->h);
+	dst->left = src->left;
+	dst->top = src->top;
+	memcpy(dst->buffer, src->buffer, src->w * src->h);
+	return dst;
+}
+
+static bitmap_t* glyph_to_bitmap_internal(FT_Glyph glyph, int bord)
+{
+	FT_BitmapGlyph bg;
+	FT_Bitmap* bit;
+	bitmap_t* bm;
+	int w, h;
+	unsigned char* src;
+	unsigned char* dst;
+	int i;
+	int error;
+
+	error = FT_Glyph_To_Bitmap(&glyph, FT_RENDER_MODE_NORMAL, 0, 0);
+	if (error) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FT_Glyph_To_BitmapError, error);
+		return 0;
+	}
+
+	bg = (FT_BitmapGlyph)glyph;
+	bit = &(bg->bitmap);
+	if (bit->pixel_mode != FT_PIXEL_MODE_GRAY) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_UnsupportedPixelMode, (int)(bit->pixel_mode));
+		FT_Done_Glyph(glyph);
+		return 0;
+	}
+
+	w = bit->width;
+	h = bit->rows;
+	bm = alloc_bitmap(w + 2*bord, h + 2*bord);
+	memset(bm->buffer, 0, bm->w * bm->h);
+	bm->left = bg->left - bord;
+	bm->top = - bg->top - bord;
+
+	src = bit->buffer;
+	dst = bm->buffer + bord + bm->w * bord;
+	for (i = 0; i < h; ++i) {
+		memcpy(dst, src, w);
+		src += bit->pitch;
+		dst += bm->w;
+	}
+
+	return bm;
+}
+
+/**
+ * \brief fix outline bitmap and generate shadow bitmap
+ * Two things are done here:
+ * 1. Glyph bitmap is subtracted from outline bitmap. This way looks much better in some cases.
+ * 2. Shadow bitmap is created as a sum of glyph and outline bitmaps.
+ */
+static bitmap_t* fix_outline_and_shadow(bitmap_t* bm_g, bitmap_t* bm_o)
+{
+	int x, y;
+	const int l = bm_o->left > bm_g->left ? bm_o->left : bm_g->left;
+	const int t = bm_o->top > bm_g->top ? bm_o->top : bm_g->top;
+	const int r = bm_o->left + bm_o->w < bm_g->left + bm_g->w ? bm_o->left + bm_o->w : bm_g->left + bm_g->w;
+	const int b = bm_o->top + bm_o->h < bm_g->top + bm_g->h ? bm_o->top + bm_o->h : bm_g->top + bm_g->h;
+
+	bitmap_t* bm_s = copy_bitmap(bm_o);
+
+	unsigned char* g = bm_g->buffer + (t - bm_g->top) * bm_g->w + (l - bm_g->left);
+	unsigned char* o = bm_o->buffer + (t - bm_o->top) * bm_o->w + (l - bm_o->left);
+	unsigned char* s = bm_s->buffer + (t - bm_s->top) * bm_s->w + (l - bm_s->left);
+	
+	for (y = 0; y < b - t; ++y) {
+		for (x = 0; x < r - l; ++x) {
+			unsigned char c_g, c_o;
+			c_g = g[x];
+			c_o = o[x];
+			o[x] = (c_o > c_g) ? c_o : 0;
+			s[x] = (c_o < 0xFF - c_g) ? c_o + c_g : 0xFF;
+		}
+		g += bm_g->w;
+		o += bm_o->w;
+		s += bm_s->w;
+	}
+
+	assert(bm_s);
+	return bm_s;
+}
+
+int glyph_to_bitmap(ass_synth_priv_t* priv, FT_Glyph glyph, FT_Glyph outline_glyph,
+		bitmap_t** bm_g, bitmap_t** bm_o, bitmap_t** bm_s, int be)
+{
+	const int bord = be ? ceil(blur_radius) : 0;
+
+	assert(bm_g && bm_o && bm_s);
+
+	*bm_g = *bm_o = *bm_s = 0;
+
+	if (glyph)
+		*bm_g = glyph_to_bitmap_internal(glyph, bord);
+	if (!*bm_g)
+		return 1;
+
+	if (outline_glyph) {
+		*bm_o = glyph_to_bitmap_internal(outline_glyph, bord);
+		if (!*bm_o) {
+			ass_free_bitmap(*bm_g);
+			return 1;
+		}
+	}
+	if (*bm_o)
+		resize_tmp(priv, (*bm_o)->w, (*bm_o)->h);
+	resize_tmp(priv, (*bm_g)->w, (*bm_g)->h);
+	
+	if (be) {
+		blur((*bm_g)->buffer, priv->tmp, (*bm_g)->w, (*bm_g)->h, (*bm_g)->w, (int*)priv->gt2, priv->g_r, priv->g_w);
+		if (*bm_o)
+			blur((*bm_o)->buffer, priv->tmp, (*bm_o)->w, (*bm_o)->h, (*bm_o)->w, (int*)priv->gt2, priv->g_r, priv->g_w);
+	}
+
+	if (*bm_o)
+		*bm_s = fix_outline_and_shadow(*bm_g, *bm_o);
+	else
+		*bm_s = copy_bitmap(*bm_g);
+
+	assert(bm_s);
+	return 0;
+}
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.h	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,49 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+#ifndef ASS_BITMAP_H
+#define ASS_BITMAP_H
+
+typedef struct ass_synth_priv_s ass_synth_priv_t;
+
+ass_synth_priv_t* ass_synth_init(void);
+void ass_synth_done(ass_synth_priv_t* priv);
+
+typedef struct bitmap_s {
+	int left, top;
+	int w, h; // width, height
+	unsigned char* buffer; // w x h buffer
+} bitmap_t;
+
+/**
+ * \brief perform glyph rendering
+ * \param glyph original glyph
+ * \param outline_glyph "border" glyph, produced from original by FreeType's glyph stroker
+ * \param bm_g out: pointer to the bitmap of original glyph is returned here
+ * \param bm_o out: pointer to the bitmap of outline (border) glyph is returned here
+ * \param bm_g out: pointer to the bitmap of glyph shadow is returned here
+ * \param be 1 = produces blurred bitmaps, 0 = normal bitmaps
+ */
+int glyph_to_bitmap(ass_synth_priv_t* priv, FT_Glyph glyph, FT_Glyph outline_glyph, bitmap_t** bm_g, bitmap_t** bm_o, bitmap_t** bm_s, int be);
+
+void ass_free_bitmap(bitmap_t* bm);
+
+#endif
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.c	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,324 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+//#include "config.h"
+
+#include <inttypes.h>
+#include <ft2build.h>
+#include FT_FREETYPE_H
+#include FT_GLYPH_H
+
+#include <assert.h>
+
+#include "mputils.h"
+#include "ass.h"
+#include "ass_fontconfig.h"
+#include "ass_font.h"
+#include "ass_bitmap.h"
+#include "ass_cache.h"
+
+
+typedef struct hashmap_item_s {
+	void* key;
+	void* value;
+	struct hashmap_item_s* next;
+} hashmap_item_t;
+typedef hashmap_item_t* hashmap_item_p;
+
+struct hashmap_s {
+	int nbuckets;
+	size_t key_size, value_size;
+	hashmap_item_p* root;
+	hashmap_item_dtor_t item_dtor; // a destructor for hashmap key/value pairs
+	hashmap_key_compare_t key_compare;
+	hashmap_hash_t hash;
+	// stats
+	int hit_count;
+	int miss_count;
+	int count;
+};
+
+#define FNV1_32A_INIT (unsigned)0x811c9dc5
+
+static inline unsigned fnv_32a_buf(void* buf, size_t len, unsigned hval)
+{
+	unsigned char *bp = buf;
+	unsigned char *be = bp + len;
+	while (bp < be) {
+		hval ^= (unsigned)*bp++;
+		hval += (hval<<1) + (hval<<4) + (hval<<7) + (hval<<8) + (hval<<24);
+	}
+	return hval;
+}
+static inline unsigned fnv_32a_str(char* str, unsigned hval)
+{
+	unsigned char* s = (unsigned char*)str;
+	while (*s) {
+		hval ^= (unsigned)*s++;
+		hval += (hval<<1) + (hval<<4) + (hval<<7) + (hval<<8) + (hval<<24);
+	}
+	return hval;
+}
+
+static unsigned hashmap_hash(void* buf, size_t len)
+{
+	return fnv_32a_buf(buf, len, FNV1_32A_INIT);
+}
+
+static int hashmap_key_compare(void* a, void* b, size_t size)
+{
+	return (memcmp(a, b, size) == 0);
+}
+
+static void hashmap_item_dtor(void* key, size_t key_size, void* value, size_t value_size)
+{
+	free(key);
+	free(value);
+}
+
+hashmap_t* hashmap_init(size_t key_size, size_t value_size, int nbuckets,
+			hashmap_item_dtor_t item_dtor, hashmap_key_compare_t key_compare,
+			hashmap_hash_t hash)
+{
+	hashmap_t* map = calloc(1, sizeof(hashmap_t));
+	map->nbuckets = nbuckets;
+	map->key_size = key_size;
+	map->value_size = value_size;
+	map->root = calloc(nbuckets, sizeof(hashmap_item_p));
+	map->item_dtor = item_dtor ? item_dtor : hashmap_item_dtor;
+	map->key_compare = key_compare ? key_compare : hashmap_key_compare;
+	map->hash = hash ? hash : hashmap_hash;
+	return map;
+}
+
+void hashmap_done(hashmap_t* map)
+{
+	int i;
+	// print stats
+	if (map->count > 0 || map->hit_count + map->miss_count > 0)
+		mp_msg(MSGT_ASS, MSGL_V, "cache statistics: \n  total accesses: %d\n  hits: %d\n  misses: %d\n  object count: %d\n",
+		       map->hit_count + map->miss_count, map->hit_count, map->miss_count, map->count);
+	
+	for (i = 0; i < map->nbuckets; ++i) {
+		hashmap_item_t* item = map->root[i];
+		while (item) {
+			hashmap_item_t* next = item->next;
+			map->item_dtor(item->key, map->key_size, item->value, map->value_size);
+			free(item);
+			item = next;
+		}
+	}
+	free(map->root);
+	free(map);
+}
+
+// does nothing if key already exists
+void* hashmap_insert(hashmap_t* map, void* key, void* value)
+{
+	unsigned hash = map->hash(key, map->key_size);
+	hashmap_item_t** next = map->root + (hash % map->nbuckets);
+	while (*next) {
+		if (map->key_compare(key, (*next)->key, map->key_size))
+			return (*next)->value;
+		next = &((*next)->next);
+		assert(next);
+	}
+	(*next) = malloc(sizeof(hashmap_item_t));
+	(*next)->key = malloc(map->key_size);
+	(*next)->value = malloc(map->value_size);
+	memcpy((*next)->key, key, map->key_size);
+	memcpy((*next)->value, value, map->value_size);
+	(*next)->next = 0;
+
+	map->count ++;
+	return (*next)->value;
+}
+
+void* hashmap_find(hashmap_t* map, void* key)
+{
+	unsigned hash = map->hash(key, map->key_size);
+	hashmap_item_t* item = map->root[hash % map->nbuckets];
+	while (item) {
+		if (map->key_compare(key, item->key, map->key_size)) {
+			map->hit_count++;
+			return item->value;
+		}
+		item = item->next;
+	}
+	map->miss_count++;
+	return 0;
+}
+
+//---------------------------------
+// font cache
+
+hashmap_t* font_cache;
+
+static unsigned font_desc_hash(void* buf, size_t len)
+{
+	ass_font_desc_t* desc = buf;
+	unsigned hval;
+	hval = fnv_32a_str(desc->family, FNV1_32A_INIT);
+	hval = fnv_32a_buf(&desc->bold, sizeof(desc->bold), hval);
+	hval = fnv_32a_buf(&desc->italic, sizeof(desc->italic), hval);
+	return hval;
+}
+
+static int font_compare(void* key1, void* key2, size_t key_size) {
+	ass_font_desc_t* a = key1;
+	ass_font_desc_t* b = key2;
+	if (strcmp(a->family, b->family) != 0)
+		return 0;
+	if (a->bold != b->bold)
+		return 0;
+	if (a->italic != b->italic)
+		return 0;
+	return 1;
+}
+
+static void font_hash_dtor(void* key, size_t key_size, void* value, size_t value_size)
+{
+	ass_font_free(value);
+	free(key);
+}
+
+ass_font_t* ass_font_cache_find(ass_font_desc_t* desc)
+{
+	return hashmap_find(font_cache, desc);
+}
+
+/**
+ * \brief Add a face struct to cache.
+ * \param font font struct
+*/
+void* ass_font_cache_add(ass_font_t* font)
+{
+	return hashmap_insert(font_cache, &(font->desc), font);
+}
+
+void ass_font_cache_init(void)
+{
+	font_cache = hashmap_init(sizeof(ass_font_desc_t),
+				  sizeof(ass_font_t),
+				  1000,
+				  font_hash_dtor, font_compare, font_desc_hash);
+}
+
+void ass_font_cache_done(void)
+{
+	hashmap_done(font_cache);
+}
+
+//---------------------------------
+// bitmap cache
+
+hashmap_t* bitmap_cache;
+
+static void bitmap_hash_dtor(void* key, size_t key_size, void* value, size_t value_size)
+{
+	bitmap_hash_val_t* v = value;
+	if (v->bm) ass_free_bitmap(v->bm);
+	if (v->bm_o) ass_free_bitmap(v->bm_o);
+	if (v->bm_s) ass_free_bitmap(v->bm_s);
+	free(key);
+	free(value);
+}
+
+void* cache_add_bitmap(bitmap_hash_key_t* key, bitmap_hash_val_t* val)
+{
+	return hashmap_insert(bitmap_cache, key, val);
+}
+
+/**
+ * \brief Get a bitmap from bitmap cache.
+ * \param key hash key
+ * \return requested hash val or 0 if not found
+*/ 
+bitmap_hash_val_t* cache_find_bitmap(bitmap_hash_key_t* key)
+{
+	return hashmap_find(bitmap_cache, key);
+}
+
+void ass_bitmap_cache_init(void)
+{
+	bitmap_cache = hashmap_init(sizeof(bitmap_hash_key_t),
+				   sizeof(bitmap_hash_val_t),
+				   0xFFFF + 13,
+				   bitmap_hash_dtor, NULL, NULL);
+}
+
+void ass_bitmap_cache_done(void)
+{
+	hashmap_done(bitmap_cache);
+}
+
+void ass_bitmap_cache_reset(void)
+{
+	ass_bitmap_cache_done();
+	ass_bitmap_cache_init();
+}
+
+//---------------------------------
+// glyph cache
+
+hashmap_t* glyph_cache;
+
+static void glyph_hash_dtor(void* key, size_t key_size, void* value, size_t value_size)
+{
+	glyph_hash_val_t* v = value;
+	if (v->glyph) FT_Done_Glyph(v->glyph);
+	if (v->outline_glyph) FT_Done_Glyph(v->outline_glyph);
+	free(key);
+	free(value);
+}
+
+void* cache_add_glyph(glyph_hash_key_t* key, glyph_hash_val_t* val)
+{
+	return hashmap_insert(glyph_cache, key, val);
+}
+
+/**
+ * \brief Get a glyph from glyph cache.
+ * \param key hash key
+ * \return requested hash val or 0 if not found
+*/ 
+glyph_hash_val_t* cache_find_glyph(glyph_hash_key_t* key)
+{
+	return hashmap_find(glyph_cache, key);
+}
+
+void ass_glyph_cache_init(void)
+{
+	glyph_cache = hashmap_init(sizeof(glyph_hash_key_t),
+				   sizeof(glyph_hash_val_t),
+				   0xFFFF + 13,
+				   glyph_hash_dtor, NULL, NULL);
+}
+
+void ass_glyph_cache_done(void)
+{
+	hashmap_done(glyph_cache);
+}
+
+void ass_glyph_cache_reset(void)
+{
+	ass_glyph_cache_done();
+	ass_glyph_cache_init();
+}

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.h	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,98 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+#ifndef ASS_CACHE_H
+#define ASS_CACHE_H
+
+void ass_font_cache_init(void);
+ass_font_t* ass_font_cache_find(ass_font_desc_t* desc);
+void* ass_font_cache_add(ass_font_t* font);
+void ass_font_cache_done(void);
+
+
+// describes a bitmap; bitmaps with equivalents structs are considered identical
+typedef struct bitmap_hash_key_s {
+	char bitmap; // bool : true = bitmap, false = outline
+	ass_font_t* font;
+	double size; // font size
+	uint32_t ch; // character code
+	unsigned outline; // border width, 16.16 fixed point value
+	int bold, italic;
+	char be; // blur edges
+
+	unsigned scale_x, scale_y; // 16.16
+	int frx, fry, frz; // signed 16.16
+	int shift_x, shift_y; // shift vector that was added to glyph before applying rotation
+	                      // = 0, if frx = fry = frx = 0
+	                      // = (glyph base point) - (rotation origin), otherwise
+	
+	FT_Vector advance; // subpixel shift vector
+} bitmap_hash_key_t;
+
+typedef struct bitmap_hash_val_s {
+	bitmap_t* bm; // the actual bitmaps
+	bitmap_t* bm_o;
+	bitmap_t* bm_s;
+} bitmap_hash_val_t;
+
+void ass_bitmap_cache_init(void);
+void* cache_add_bitmap(bitmap_hash_key_t* key, bitmap_hash_val_t* val);
+bitmap_hash_val_t* cache_find_bitmap(bitmap_hash_key_t* key);
+void ass_bitmap_cache_reset(void);
+void ass_bitmap_cache_done(void);
+
+// describes an outline glyph
+typedef struct glyph_hash_key_s {
+	ass_font_t* font;
+	double size; // font size
+	uint32_t ch; // character code
+	int bold, italic;
+	unsigned scale_x, scale_y; // 16.16
+	FT_Vector advance; // subpixel shift vector
+	unsigned outline; // border width, 16.16
+} glyph_hash_key_t;
+
+typedef struct glyph_hash_val_s {
+	FT_Glyph glyph;
+	FT_Glyph outline_glyph;
+	FT_BBox bbox_scaled; // bbox after scaling, but before rotation
+	FT_Vector advance; // 26.6, advance distance to the next bitmap in line
+} glyph_hash_val_t;
+
+void ass_glyph_cache_init(void);
+void* cache_add_glyph(glyph_hash_key_t* key, glyph_hash_val_t* val);
+glyph_hash_val_t* cache_find_glyph(glyph_hash_key_t* key);
+void ass_glyph_cache_reset(void);
+void ass_glyph_cache_done(void);
+
+typedef struct hashmap_s hashmap_t; 
+typedef void (*hashmap_item_dtor_t)(void* key, size_t key_size, void* value, size_t value_size);
+typedef int (*hashmap_key_compare_t)(void* key1, void* key2, size_t key_size);
+typedef unsigned (*hashmap_hash_t)(void* key, size_t key_size);
+
+hashmap_t* hashmap_init(size_t key_size, size_t value_size, int nbuckets,
+			hashmap_item_dtor_t item_dtor, hashmap_key_compare_t key_compare,
+			hashmap_hash_t hash);
+void hashmap_done(hashmap_t* map);
+void* hashmap_insert(hashmap_t* map, void* key, void* value);
+void* hashmap_find(hashmap_t* map, void* key);
+
+#endif
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.c	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,370 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+//#include "config.h"
+
+#include <inttypes.h>
+#include <ft2build.h>
+#include FT_FREETYPE_H
+#include FT_SYNTHESIS_H
+#include FT_GLYPH_H
+#include FT_TRUETYPE_TABLES_H
+
+#include "ass.h"
+#include "ass_library.h"
+#include "ass_font.h"
+#include "ass_bitmap.h"
+#include "ass_cache.h"
+#include "ass_fontconfig.h"
+#include "ass_utils.h"
+#include "mputils.h"
+
+/**
+ * Select Microfost Unicode CharMap, if the font has one.
+ * Otherwise, let FreeType decide.
+ */
+static void charmap_magic(FT_Face face)
+{
+	int i;
+	for (i = 0; i < face->num_charmaps; ++i) {
+		FT_CharMap cmap = face->charmaps[i];
+		unsigned pid = cmap->platform_id;
+		unsigned eid = cmap->encoding_id;
+		if (pid == 3 /*microsoft*/ && (eid == 1 /*unicode bmp*/ || eid == 10 /*full unicode*/)) {
+			FT_Set_Charmap(face, cmap);
+			return;
+		}
+	}
+
+	if (!face->charmap) {
+		if (face->num_charmaps == 0) {
+			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NoCharmaps);
+			return;
+		}
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NoCharmapAutodetected);
+		FT_Set_Charmap(face, face->charmaps[0]);
+		return;
+	}
+}
+
+static void update_transform(ass_font_t* font)
+{
+	int i;
+	FT_Matrix m;
+	m.xx = double_to_d16(font->scale_x);
+	m.yy = double_to_d16(font->scale_y);
+	m.xy = m.yx = 0;
+	for (i = 0; i < font->n_faces; ++i)
+		FT_Set_Transform(font->faces[i], &m, &font->v);
+}
+
+/**
+ * \brief find a memory font by name
+ */
+static int find_font(ass_library_t* library, char* name)
+{
+	int i;
+	for (i = 0; i < library->num_fontdata; ++i)
+		if (strcasecmp(name, library->fontdata[i].name) == 0)
+			return i;
+	return -1;
+}
+
+static void face_set_size(FT_Face face, double size);
+
+static void buggy_font_workaround(FT_Face face)
+{
+	// Some fonts have zero Ascender/Descender fields in 'hhea' table.
+	// In this case, get the information from 'os2' table or, as
+	// a last resort, from face.bbox.
+	if (face->ascender + face->descender == 0 || face->height == 0) {
+		TT_OS2 *os2 = FT_Get_Sfnt_Table(face, ft_sfnt_os2);
+		if (os2) {
+			face->ascender = os2->sTypoAscender;
+			face->descender = os2->sTypoDescender;
+			face->height = face->ascender - face->descender;
+		} else {
+			face->ascender = face->bbox.yMax;
+			face->descender = face->bbox.yMin;
+			face->height = face->ascender - face->descender;
+		}
+	}
+}
+
+/**
+ * \brief Select a face with the given charcode and add it to ass_font_t
+ * \return index of the new face in font->faces, -1 if failed
+ */
+static int add_face(void* fc_priv, ass_font_t* font, uint32_t ch)
+{
+	char* path;
+	int index;
+	FT_Face face;
+	int error;
+	int mem_idx;
+	
+	if (font->n_faces == ASS_FONT_MAX_FACES)
+		return -1;
+	
+	path = fontconfig_select(fc_priv, font->desc.family, font->desc.bold,
+					      font->desc.italic, &index, ch);
+
+	mem_idx = find_font(font->library, path);
+	if (mem_idx >= 0) {
+		error = FT_New_Memory_Face(font->ftlibrary, (unsigned char*)font->library->fontdata[mem_idx].data,
+					   font->library->fontdata[mem_idx].size, 0, &face);
+		if (error) {
+			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorOpeningMemoryFont, path);
+			return -1;
+		}
+	} else {
+		error = FT_New_Face(font->ftlibrary, path, index, &face);
+		if (error) {
+			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorOpeningFont, path, index);
+			return -1;
+		}
+	}
+	charmap_magic(face);
+	buggy_font_workaround(face);
+	
+	font->faces[font->n_faces++] = face;
+	update_transform(font);
+	face_set_size(face, font->size);
+	return font->n_faces - 1;
+}
+
+/**
+ * \brief Create a new ass_font_t according to "desc" argument
+ */
+ass_font_t* ass_font_new(ass_library_t* library, FT_Library ftlibrary, void* fc_priv, ass_font_desc_t* desc)
+{
+	int error;
+	ass_font_t* fontp;
+	ass_font_t font;
+
+	fontp = ass_font_cache_find(desc);
+	if (fontp)
+		return fontp;
+	
+	font.library = library;
+	font.ftlibrary = ftlibrary;
+	font.n_faces = 0;
+	font.desc.family = strdup(desc->family);
+	font.desc.bold = desc->bold;
+	font.desc.italic = desc->italic;
+
+	font.scale_x = font.scale_y = 1.;
+	font.v.x = font.v.y = 0;
+	font.size = 0.;
+
+	error = add_face(fc_priv, &font, 0);
+	if (error == -1) {
+		free(font.desc.family);
+		return 0;
+	} else
+		return ass_font_cache_add(&font);
+}
+
+/**
+ * \brief Set font transformation matrix and shift vector
+ **/
+void ass_font_set_transform(ass_font_t* font, double scale_x, double scale_y, FT_Vector* v)
+{
+	font->scale_x = scale_x;
+	font->scale_y = scale_y;
+	font->v.x = v->x;
+	font->v.y = v->y;
+	update_transform(font);
+}
+
+static void face_set_size(FT_Face face, double size)
+{
+#if (FREETYPE_MAJOR > 2) || ((FREETYPE_MAJOR == 2) && (FREETYPE_MINOR > 1))
+	TT_HoriHeader *hori = FT_Get_Sfnt_Table(face, ft_sfnt_hhea);
+	TT_OS2 *os2 = FT_Get_Sfnt_Table(face, ft_sfnt_os2);
+	double mscale = 1.;
+	FT_Size_RequestRec rq;
+	FT_Size_Metrics *m = &face->size->metrics;
+	// VSFilter uses metrics from TrueType OS/2 table
+	// The idea was borrowed from asa (http://asa.diac24.net)
+	if (hori && os2) {
+		int hori_height = hori->Ascender - hori->Descender;
+		int os2_height = os2->usWinAscent + os2->usWinDescent;
+		if (hori_height && os2_height)
+			mscale = (double)hori_height / os2_height;
+	}
+	memset(&rq, 0, sizeof(rq));
+	rq.type = FT_SIZE_REQUEST_TYPE_REAL_DIM;
+	rq.width = 0;
+	rq.height = double_to_d6(size * mscale);
+	rq.horiResolution = rq.vertResolution = 0;
+	FT_Request_Size(face, &rq);
+	m->ascender /= mscale;
+	m->descender /= mscale;
+	m->height /= mscale;
+#else
+	FT_Set_Char_Size(face, 0, double_to_d6(size), 0, 0);
+#endif
+}
+
+/**
+ * \brief Set font size
+ **/
+void ass_font_set_size(ass_font_t* font, double size)
+{
+	int i;
+	if (font->size != size) {
+		font->size = size;
+		for (i = 0; i < font->n_faces; ++i)
+			face_set_size(font->faces[i], size);
+	}
+}
+
+/**
+ * \brief Get maximal font ascender and descender.
+ * \param ch character code
+ * The values are extracted from the font face that provides glyphs for the given character
+ **/
+void ass_font_get_asc_desc(ass_font_t* font, uint32_t ch, int* asc, int* desc)
+{
+	int i;
+	for (i = 0; i < font->n_faces; ++i) {
+		FT_Face face = font->faces[i];
+		if (FT_Get_Char_Index(face, ch)) {
+			int v, v2;
+			v = face->size->metrics.ascender;
+			v2 = FT_MulFix(face->bbox.yMax, face->size->metrics.y_scale);
+			*asc = (v > v2 * 0.9) ? v : v2;
+				
+			v = - face->size->metrics.descender;
+			v2 = - FT_MulFix(face->bbox.yMin, face->size->metrics.y_scale);
+			*desc = (v > v2 * 0.9) ? v : v2;
+			return;
+		}
+	}
+	
+	*asc = *desc = 0;
+}
+
+/**
+ * \brief Get a glyph
+ * \param ch character code
+ **/
+FT_Glyph ass_font_get_glyph(void* fontconfig_priv, ass_font_t* font, uint32_t ch, ass_hinting_t hinting)
+{
+	int error;
+	int index = 0;
+	int i;
+	FT_Glyph glyph;
+	FT_Face face = 0;
+	int flags = 0;
+
+	if (ch < 0x20)
+		return 0;
+	if (font->n_faces == 0)
+		return 0;
+
+	for (i = 0; i < font->n_faces; ++i) {
+		face = font->faces[i];
+		index = FT_Get_Char_Index(face, ch);
+		if (index)
+			break;
+	}
+
+#ifdef HAVE_FONTCONFIG
+	if (index == 0) {
+		int face_idx;
+		mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_GlyphNotFoundReselectingFont,
+		       ch, font->desc.family, font->desc.bold, font->desc.italic);
+		face_idx = add_face(fontconfig_priv, font, ch);
+		face = font->faces[face_idx];
+		index = FT_Get_Char_Index(face, ch);
+		if (index == 0) {
+			mp_msg(MSGT_ASS, MSGL_ERR, MSGTR_LIBASS_GlyphNotFound,
+			       ch, font->desc.family, font->desc.bold, font->desc.italic);
+		}
+	}
+#endif
+
+	switch (hinting) {
+	case ASS_HINTING_NONE: flags = FT_LOAD_NO_HINTING; break;
+	case ASS_HINTING_LIGHT: flags = FT_LOAD_FORCE_AUTOHINT | FT_LOAD_TARGET_LIGHT; break;
+	case ASS_HINTING_NORMAL: flags = FT_LOAD_FORCE_AUTOHINT; break;
+	case ASS_HINTING_NATIVE: flags = 0; break;
+	}
+	
+	error = FT_Load_Glyph(face, index, FT_LOAD_NO_BITMAP | flags);
+	if (error) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorLoadingGlyph);
+		return 0;
+	}
+	
+#if (FREETYPE_MAJOR > 2) || \
+    ((FREETYPE_MAJOR == 2) && (FREETYPE_MINOR >= 2)) || \
+    ((FREETYPE_MAJOR == 2) && (FREETYPE_MINOR == 1) && (FREETYPE_PATCH >= 10))
+// FreeType >= 2.1.10 required
+	if (!(face->style_flags & FT_STYLE_FLAG_ITALIC) && 
+			(font->desc.italic > 55)) {
+		FT_GlyphSlot_Oblique(face->glyph);
+	}
+#endif
+	error = FT_Get_Glyph(face->glyph, &glyph);
+	if (error) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorLoadingGlyph);
+		return 0;
+	}
+	
+	return glyph;
+}
+
+/**
+ * \brief Get kerning for the pair of glyphs.
+ **/
+FT_Vector ass_font_get_kerning(ass_font_t* font, uint32_t c1, uint32_t c2)
+{
+	FT_Vector v = {0, 0};
+	int i;
+
+	for (i = 0; i < font->n_faces; ++i) {
+		FT_Face face = font->faces[i];
+		int i1 = FT_Get_Char_Index(face, c1);
+		int i2 = FT_Get_Char_Index(face, c2);
+		if (i1 && i2) {
+			if (FT_HAS_KERNING(face))
+				FT_Get_Kerning(face, i1, i2, FT_KERNING_DEFAULT, &v);
+			return v;
+		}
+		if (i1 || i2) // these glyphs are from different font faces, no kerning information
+			return v;
+	}
+	return v;
+}
+
+/**
+ * \brief Deallocate ass_font_t
+ **/
+void ass_font_free(ass_font_t* font)
+{
+	int i;
+	for (i = 0; i < font->n_faces; ++i)
+		if (font->faces[i]) FT_Done_Face(font->faces[i]);
+	if (font->desc.family) free(font->desc.family);
+	free(font);
+}

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.h	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,51 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+#ifndef ASS_FONT_H
+#define ASS_FONT_H
+
+typedef struct ass_font_desc_s {
+	char* family;
+	unsigned bold;
+	unsigned italic;
+} ass_font_desc_t;
+
+#define ASS_FONT_MAX_FACES 10
+
+typedef struct ass_font_s {
+	ass_font_desc_t desc;
+	ass_library_t* library;
+	FT_Library ftlibrary;
+	FT_Face faces[ASS_FONT_MAX_FACES];
+	int n_faces;
+	double scale_x, scale_y; // current transform
+	FT_Vector v; // current shift
+	double size;
+} ass_font_t;
+
+ass_font_t* ass_font_new(ass_library_t* library, FT_Library ftlibrary, void* fc_priv, ass_font_desc_t* desc);
+void ass_font_set_transform(ass_font_t* font, double scale_x, double scale_y, FT_Vector* v);
+void ass_font_set_size(ass_font_t* font, double size);
+void ass_font_get_asc_desc(ass_font_t* font, uint32_t ch, int* asc, int* desc);
+FT_Glyph ass_font_get_glyph(void* fontconfig_priv, ass_font_t* font, uint32_t ch, ass_hinting_t hinting);
+FT_Vector ass_font_get_kerning(ass_font_t* font, uint32_t c1, uint32_t c2);
+void ass_font_free(ass_font_t* font);
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.c	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,413 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+//#include "config.h"
+
+#include <stdlib.h>
+#include <stdio.h>
+#include <assert.h>
+#include <string.h>
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <inttypes.h>
+#include <ft2build.h>
+#include FT_FREETYPE_H
+
+#include "mputils.h"
+#include "ass.h"
+#include "ass_library.h"
+#include "ass_fontconfig.h"
+
+#ifdef HAVE_FONTCONFIG
+#include <fontconfig/fontconfig.h>
+#include <fontconfig/fcfreetype.h>
+#endif
+
+struct fc_instance_s {
+#ifdef HAVE_FONTCONFIG
+	FcConfig* config;
+#endif
+	char* family_default;
+	char* path_default;
+	int index_default;
+};
+
+#ifdef HAVE_FONTCONFIG
+/**
+ * \brief Low-level font selection.
+ * \param priv private data
+ * \param family font family
+ * \param bold font weight value
+ * \param italic font slant value
+ * \param index out: font index inside a file
+ * \param code: the character that should be present in the font, can be 0
+ * \return font file path
+*/ 
+static char* _select_font(fc_instance_t* priv, const char* family, unsigned bold, unsigned italic, int* index,
+			  uint32_t code)
+{
+	FcBool rc;
+	FcResult result;
+	FcPattern *pat = 0, *rpat;
+	int val_i;
+	FcChar8* val_s;
+	FcBool val_b;
+	FcCharSet* val_cs;
+	FcFontSet* fset = 0;
+	int curf;
+	char* retval = 0;
+	
+	*index = 0;
+
+	pat = FcPatternCreate();
+	if (!pat)
+		goto error;
+	
+	FcPatternAddString(pat, FC_FAMILY, (const FcChar8*)family);
+	FcPatternAddBool(pat, FC_OUTLINE, FcTrue);
+	FcPatternAddInteger(pat, FC_SLANT, italic);
+	FcPatternAddInteger(pat, FC_WEIGHT, bold);
+
+	FcDefaultSubstitute(pat);
+	
+	rc = FcConfigSubstitute(priv->config, pat, FcMatchPattern);
+	if (!rc)
+		goto error;
+
+	fset = FcFontSort(priv->config, pat, FcTrue, NULL, &result);
+
+	for (curf = 0; curf < fset->nfont; ++curf) {
+		rpat = fset->fonts[curf];
+		
+		result = FcPatternGetBool(rpat, FC_OUTLINE, 0, &val_b);
+		if (result != FcResultMatch)
+			continue;
+		if (val_b != FcTrue)
+			continue;
+		if (!code)
+			break;
+		result = FcPatternGetCharSet(rpat, FC_CHARSET, 0, &val_cs);
+		if (result != FcResultMatch)
+			continue;
+		if (FcCharSetHasChar(val_cs, code))
+			break;
+	}
+
+	if (curf >= fset->nfont)
+		goto error;
+
+	rpat = fset->fonts[curf];
+	
+	result = FcPatternGetInteger(rpat, FC_INDEX, 0, &val_i);
+	if (result != FcResultMatch)
+		goto error;
+	*index = val_i;
+
+	result = FcPatternGetString(rpat, FC_FAMILY, 0, &val_s);
+	if (result != FcResultMatch)
+		goto error;
+
+	if (strcasecmp((const char*)val_s, family) != 0)
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_SelectedFontFamilyIsNotTheRequestedOne,
+				(const char*)val_s, family);
+
+	result = FcPatternGetString(rpat, FC_FILE, 0, &val_s);
+	if (result != FcResultMatch)
+		goto error;
+	
+	retval = strdup((const char*)val_s);
+ error:
+	if (pat) FcPatternDestroy(pat);
+	if (fset) FcFontSetDestroy(fset);
+	return retval;
+}
+
+/**
+ * \brief Find a font. Use default family or path if necessary.
+ * \param priv_ private data
+ * \param family font family
+ * \param bold font weight value
+ * \param italic font slant value
+ * \param index out: font index inside a file
+ * \param code: the character that should be present in the font, can be 0
+ * \return font file path
+*/ 
+char* fontconfig_select(fc_instance_t* priv, const char* family, unsigned bold, unsigned italic, int* index,
+			uint32_t code)
+{
+	char* res = 0;
+	if (family && *family)
+		res = _select_font(priv, family, bold, italic, index, code);
+	if (!res && priv->family_default) {
+		res = _select_font(priv, priv->family_default, bold, italic, index, code);
+		if (res)
+			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_UsingDefaultFontFamily, 
+					family, bold, italic, res, *index);
+	}
+	if (!res && priv->path_default) {
+		res = priv->path_default;
+		*index = priv->index_default;
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_UsingDefaultFont, 
+		       family, bold, italic, res, *index);
+	}
+	if (!res) {
+		res = _select_font(priv, "Arial", bold, italic, index, code);
+		if (res)
+			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_UsingArialFontFamily, 
+					family, bold, italic, res, *index);
+	}
+	if (res)
+		mp_msg(MSGT_ASS, MSGL_V, "fontconfig_select: (%s, %d, %d) -> %s, %d\n", 
+				family, bold, italic, res, *index);
+	return res;
+}
+
+#if (FC_VERSION < 20402)
+static char* validate_fname(char* name)
+{
+	char* fname;
+	char* p;
+	char* q;
+	unsigned code;
+	int sz = strlen(name);
+
+	q = fname = malloc(sz + 1);
+	p = name;
+	while (*p) {
+		code = utf8_get_char(&p);
+		if (code == 0)
+			break;
+		if (	(code > 0x7F) ||
+			(code == '\\') ||
+			(code == '/') ||
+			(code == ':') ||
+			(code == '*') ||
+			(code == '?') ||
+			(code == '<') ||
+			(code == '>') ||
+			(code == '|') ||
+			(code == 0))
+		{
+			*q++ = '_';
+		} else {
+			*q++ = code;
+		}
+		if (p - name > sz)
+			break;
+	}
+	*q = 0;
+	return fname;
+}
+#endif
+
+/**
+ * \brief Process memory font.
+ * \param priv private data
+ * \param library library object
+ * \param ftlibrary freetype library object
+ * \param idx index of the processed font in library->fontdata
+ * With FontConfig >= 2.4.2, builds a font pattern in memory via FT_New_Memory_Face/FcFreeTypeQueryFace.
+ * With older FontConfig versions, save the font to ~/.mplayer/fonts.
+*/ 
+static void process_fontdata(fc_instance_t* priv, ass_library_t* library, FT_Library ftlibrary, int idx)
+{
+	int rc;
+	const char* name = library->fontdata[idx].name;
+	const char* data = library->fontdata[idx].data;
+	int data_size = library->fontdata[idx].size;
+
+#if (FC_VERSION < 20402)
+	struct stat st;
+	char* fname;
+	const char* fonts_dir = library->fonts_dir;
+	char buf[1000];
+	FILE* fp = 0;
+
+	if (!fonts_dir)
+		return;
+	rc = stat(fonts_dir, &st);
+	if (rc) {
+		int res;
+#ifndef __MINGW32__
+		res = mkdir(fonts_dir, 0700);
+#else
+		res = mkdir(fonts_dir);
+#endif
+		if (res) {
+			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FailedToCreateDirectory, fonts_dir);
+		}
+	} else if (!S_ISDIR(st.st_mode)) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NotADirectory, fonts_dir);
+	}
+	
+	fname = validate_fname((char*)name);
+
+	snprintf(buf, 1000, "%s/%s", fonts_dir, fname);
+	free(fname);
+
+	fp = fopen(buf, "wb");
+	if (!fp) return;
+
+	fwrite(data, data_size, 1, fp);
+	fclose(fp);
+
+#else // (FC_VERSION >= 20402)
+	FT_Face face;
+	FcPattern* pattern;
+	FcFontSet* fset;
+	FcBool res;
+
+	rc = FT_New_Memory_Face(ftlibrary, (unsigned char*)data, data_size, 0, &face);
+	if (rc) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorOpeningMemoryFont, name);
+		return;
+	}
+
+	pattern = FcFreeTypeQueryFace(face, (unsigned char*)name, 0, FcConfigGetBlanks(priv->config));
+	if (!pattern) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FunctionCallFailed, "FcFreeTypeQueryFace");
+		FT_Done_Face(face);
+		return;
+	}
+
+	fset = FcConfigGetFonts(priv->config, FcSetSystem); // somehow it failes when asked for FcSetApplication
+	if (!fset) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FunctionCallFailed, "FcConfigGetFonts");
+		FT_Done_Face(face);
+		return;
+	}
+
+	res = FcFontSetAdd(fset, pattern);
+	if (!res) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FunctionCallFailed, "FcFontSetAdd");
+		FT_Done_Face(face);
+		return;
+	}
+
+	FT_Done_Face(face);
+#endif
+}
+
+/**
+ * \brief Init fontconfig.
+ * \param library libass library object
+ * \param ftlibrary freetype library object
+ * \param family default font family
+ * \param path default font path
+ * \return pointer to fontconfig private data
+*/ 
+fc_instance_t* fontconfig_init(ass_library_t* library, FT_Library ftlibrary, const char* family, const char* path)
+{
+	int rc;
+	fc_instance_t* priv = calloc(1, sizeof(fc_instance_t));
+	const char* dir = library->fonts_dir;
+	int i;
+	
+	rc = FcInit();
+	assert(rc);
+
+	priv->config = FcConfigGetCurrent();
+	if (!priv->config) {
+		mp_msg(MSGT_ASS, MSGL_FATAL, MSGTR_LIBASS_FcInitLoadConfigAndFontsFailed);
+		return 0;
+	}
+
+	for (i = 0; i < library->num_fontdata; ++i)
+		process_fontdata(priv, library, ftlibrary, i);
+
+	if (FcDirCacheValid((const FcChar8 *)dir) == FcFalse)
+	{
+		mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_UpdatingFontCache);
+		if (FcGetVersion() >= 20390 && FcGetVersion() < 20400)
+			mp_msg(MSGT_ASS, MSGL_WARN,
+			       MSGTR_LIBASS_BetaVersionsOfFontconfigAreNotSupported);
+		// FontConfig >= 2.4.0 updates cache automatically in FcConfigAppFontAddDir()
+		if (FcGetVersion() < 20390) {
+			FcFontSet* fcs;
+			FcStrSet* fss;
+			fcs = FcFontSetCreate();
+			fss = FcStrSetCreate();
+			rc = FcStrSetAdd(fss, (const FcChar8*)dir);
+			if (!rc) {
+				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FcStrSetAddFailed);
+				goto ErrorFontCache;
+			}
+
+			rc = FcDirScan(fcs, fss, NULL, FcConfigGetBlanks(priv->config), (const FcChar8 *)dir, FcFalse);
+			if (!rc) {
+				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FcDirScanFailed);
+				goto ErrorFontCache;
+			}
+
+			rc = FcDirSave(fcs, fss, (const FcChar8 *)dir);
+			if (!rc) {
+				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FcDirSave);
+				goto ErrorFontCache;
+			}
+		ErrorFontCache:
+			;
+		}
+	}
+
+	rc = FcConfigAppFontAddDir(priv->config, (const FcChar8*)dir);
+	if (!rc) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FcConfigAppFontAddDirFailed);
+	}
+
+	priv->family_default = family ? strdup(family) : 0;
+	priv->path_default = path ? strdup(path) : 0;
+	priv->index_default = 0;
+
+	return priv;
+}
+
+#else // HAVE_FONTCONFIG
+
+char* fontconfig_select(fc_instance_t* priv, const char* family, unsigned bold, unsigned italic, int* index,
+			uint32_t code)
+{
+	*index = priv->index_default;
+	return priv->path_default;
+}
+
+fc_instance_t* fontconfig_init(ass_library_t* library, FT_Library ftlibrary, const char* family, const char* path)
+{
+	fc_instance_t* priv;
+
+	mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FontconfigDisabledDefaultFontWillBeUsed);
+	
+	priv = calloc(1, sizeof(fc_instance_t));
+	
+	priv->path_default = strdup(path);
+	priv->index_default = 0;
+	return priv;
+}
+
+#endif
+
+void fontconfig_done(fc_instance_t* priv)
+{
+	// don't call FcFini() here, library can still be used by some code
+	if (priv && priv->path_default) free(priv->path_default);
+	if (priv && priv->family_default) free(priv->family_default);
+	if (priv) free(priv);
+}
+
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.h	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,35 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+#ifndef ASS_FONTCONFIG_H
+#define ASS_FONTCONFIG_H
+
+#ifdef HAVE_FONTCONFIG
+#include <fontconfig/fontconfig.h>
+#endif
+
+typedef struct fc_instance_s fc_instance_t;
+
+fc_instance_t* fontconfig_init(ass_library_t* library, FT_Library ftlibrary, const char* family, const char* path);
+char* fontconfig_select(fc_instance_t* priv, const char* family, unsigned bold, unsigned italic, int* index, uint32_t code);
+void fontconfig_done(fc_instance_t* priv);
+
+#endif
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.c	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,93 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+#include <inttypes.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+
+#include "ass.h"
+#include "ass_library.h"
+
+
+ass_library_t* ass_library_init(void)
+{
+	return calloc(1, sizeof(ass_library_t));
+}
+
+void ass_library_done(ass_library_t* priv)
+{
+	if (priv) {
+		ass_set_fonts_dir(priv, NULL);
+		ass_set_style_overrides(priv, NULL);
+		free(priv);
+	}
+}
+
+void ass_set_fonts_dir(ass_library_t* priv, const char* fonts_dir)
+{
+	if (priv->fonts_dir)
+		free(priv->fonts_dir);
+
+	priv->fonts_dir = fonts_dir ? strdup(fonts_dir) : 0;
+}
+
+void ass_set_extract_fonts(ass_library_t* priv, int extract)
+{
+	priv->extract_fonts = !!extract;
+}
+
+void ass_set_style_overrides(ass_library_t* priv, char** list)
+{
+	char** p;
+	char** q;
+	int cnt;
+	
+	if (priv->style_overrides) {
+		for (p = priv->style_overrides; *p; ++p)
+			free(*p);
+		free(priv->style_overrides);
+	}
+	
+	if (!list) return;
+
+	for (p = list, cnt = 0; *p; ++p, ++cnt) {}
+
+	priv->style_overrides = malloc((cnt + 1) * sizeof(char*));
+	for (p = list, q = priv->style_overrides; *p; ++p, ++q)
+		*q = strdup(*p);
+	priv->style_overrides[cnt] = NULL;
+}
+
+static void grow_array(void **array, int nelem, size_t elsize)
+{
+	if (!(nelem & 31))
+		*array = realloc(*array, (nelem + 32) * elsize);
+}
+
+void ass_add_font(ass_library_t* priv, char* name, char* data, int size)
+{
+	grow_array((void**)&priv->fontdata, priv->num_fontdata, sizeof(*priv->fontdata));
+	priv->fontdata[priv->num_fontdata].name = name;
+	priv->fontdata[priv->num_fontdata].data = data;
+	priv->fontdata[priv->num_fontdata].size = size;
+	priv->num_fontdata ++;
+}
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.h	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,40 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+#ifndef ASS_LIBRARY_H
+#define ASS_LIBRARY_H
+
+typedef struct ass_fontdata_s {
+	char* name;
+	char* data;
+	int size;
+} ass_fontdata_t;
+
+struct ass_library_s {
+	char* fonts_dir;
+	int extract_fonts;
+	char** style_overrides;
+
+	ass_fontdata_t* fontdata;
+	int num_fontdata;
+};
+
+#endif
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render.c	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,2399 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+//#include "config.h"
+
+#include <assert.h>
+#include <math.h>
+#include <inttypes.h>
+#include <ft2build.h>
+#include FT_FREETYPE_H
+#include FT_STROKER_H
+#include FT_GLYPH_H
+#include FT_SYNTHESIS_H
+
+#include "mputils.h"
+
+#include "ass.h"
+#include "ass_font.h"
+#include "ass_bitmap.h"
+#include "ass_cache.h"
+#include "ass_utils.h"
+#include "ass_fontconfig.h"
+#include "ass_library.h"
+
+#define MAX_GLYPHS 1000
+#define MAX_LINES 100
+
+static int last_render_id = 0;
+
+typedef struct ass_settings_s {
+	int frame_width;
+	int frame_height;
+	double font_size_coeff; // font size multiplier
+	double line_spacing; // additional line spacing (in frame pixels)
+	int top_margin; // height of top margin. Everything except toptitles is shifted down by top_margin.
+	int bottom_margin; // height of bottom margin. (frame_height - top_margin - bottom_margin) is original video height.
+	int left_margin;
+	int right_margin;
+	int use_margins; // 0 - place all subtitles inside original frame
+	                 // 1 - use margins for placing toptitles and subtitles
+	double aspect; // frame aspect ratio, d_width / d_height.
+	ass_hinting_t hinting;
+
+	char* default_font;
+	char* default_family;
+} ass_settings_t;
+
+// a rendered event
+typedef struct event_images_s {
+	ass_image_t* imgs;
+	int top, height;
+	int detect_collisions;
+	int shift_direction;
+	ass_event_t* event;
+} event_images_t;
+
+struct ass_renderer_s {
+	ass_library_t* library;
+	FT_Library ftlibrary;
+	fc_instance_t* fontconfig_priv;
+	ass_settings_t settings;
+	int render_id;
+	ass_synth_priv_t* synth_priv;
+
+	ass_image_t* images_root; // rendering result is stored here
+	ass_image_t* prev_images_root;
+
+	event_images_t* eimg; // temporary buffer for sorting rendered events
+	int eimg_size; // allocated buffer size
+};
+
+typedef enum {EF_NONE = 0, EF_KARAOKE, EF_KARAOKE_KF, EF_KARAOKE_KO} effect_t;
+
+// describes a glyph
+// glyph_info_t and text_info_t are used for text centering and word-wrapping operations
+typedef struct glyph_info_s {
+	unsigned symbol;
+	FT_Glyph glyph;
+	FT_Glyph outline_glyph;
+	bitmap_t* bm; // glyph bitmap
+	bitmap_t* bm_o; // outline bitmap
+	bitmap_t* bm_s; // shadow bitmap
+	FT_BBox bbox;
+	FT_Vector pos;
+	char linebreak; // the first (leading) glyph of some line ?
+	uint32_t c[4]; // colors
+	FT_Vector advance; // 26.6
+	effect_t effect_type;
+	int effect_timing; // time duration of current karaoke word
+	                   // after process_karaoke_effects: distance in pixels from the glyph origin.
+	                   // part of the glyph to the left of it is displayed in a different color.
+	int effect_skip_timing; // delay after the end of last karaoke word
+	int asc, desc; // font max ascender and descender
+//	int height;
+	int be; // blur edges
+	int shadow;
+	double frx, fry, frz; // rotation
+	
+	bitmap_hash_key_t hash_key;
+} glyph_info_t;
+
+typedef struct line_info_s {
+	int asc, desc;
+} line_info_t;
+
+typedef struct text_info_s {
+	glyph_info_t* glyphs;
+	int length;
+	line_info_t lines[MAX_LINES];
+	int n_lines;
+	int height;
+} text_info_t;
+
+
+// Renderer state.
+// Values like current font face, color, screen position, clipping and so on are stored here.
+typedef struct render_context_s {
+	ass_event_t* event;
+	ass_style_t* style;
+	
+	ass_font_t* font;
+	char* font_path;
+	double font_size;
+	
+	FT_Stroker stroker;
+	int alignment; // alignment overrides go here; if zero, style value will be used
+	double frx, fry, frz;
+	enum {	EVENT_NORMAL, // "normal" top-, sub- or mid- title
+		EVENT_POSITIONED, // happens after pos(,), margins are ignored
+		EVENT_HSCROLL, // "Banner" transition effect, text_width is unlimited
+		EVENT_VSCROLL // "Scroll up", "Scroll down" transition effects
+		} evt_type;
+	int pos_x, pos_y; // position
+	int org_x, org_y; // origin
+	char have_origin; // origin is explicitly defined; if 0, get_base_point() is used
+	double scale_x, scale_y;
+	double hspacing; // distance between letters, in pixels
+	double border; // outline width
+	uint32_t c[4]; // colors(Primary, Secondary, so on) in RGBA
+	int clip_x0, clip_y0, clip_x1, clip_y1;
+	char detect_collisions;
+	uint32_t fade; // alpha from \fad
+	char be; // blur edges
+	int shadow;
+
+	effect_t effect_type;
+	int effect_timing;
+	int effect_skip_timing;
+
+	enum { SCROLL_LR, // left-to-right
+	       SCROLL_RL,
+	       SCROLL_TB, // top-to-bottom
+	       SCROLL_BT
+	       } scroll_direction; // for EVENT_HSCROLL, EVENT_VSCROLL
+	int scroll_shift;
+
+	// face properties
+	char* family;
+	unsigned bold;
+	unsigned italic;
+	
+} render_context_t;
+
+// frame-global data
+typedef struct frame_context_s {
+	ass_renderer_t* ass_priv;
+	int width, height; // screen dimensions
+	int orig_height; // frame height ( = screen height - margins )
+	int orig_width; // frame width ( = screen width - margins )
+	ass_track_t* track;
+	long long time; // frame's timestamp, ms
+	double font_scale;
+	double font_scale_x; // x scale applied to all glyphs to preserve text aspect ratio
+	double border_scale;
+} frame_context_t;
+
+static ass_renderer_t* ass_renderer;
+static ass_settings_t* global_settings;
+static text_info_t text_info;
+static render_context_t render_context;
+static frame_context_t frame_context;
+
+struct render_priv_s {
+	int top, height;
+	int render_id;
+};
+
+static void ass_lazy_track_init(void)
+{
+	ass_track_t* track = frame_context.track;
+	if (track->PlayResX && track->PlayResY)
+		return;
+	if (!track->PlayResX && !track->PlayResY) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NeitherPlayResXNorPlayResYDefined);
+		track->PlayResX = 384;
+		track->PlayResY = 288;
+	} else {
+		double orig_aspect = (global_settings->aspect * frame_context.height * frame_context.orig_width) /
+			frame_context.orig_height / frame_context.width;
+		if (!track->PlayResY) {
+			track->PlayResY = track->PlayResX / orig_aspect + .5;
+			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_PlayResYUndefinedSettingY, track->PlayResY);
+		} else if (!track->PlayResX) {
+			track->PlayResX = track->PlayResY * orig_aspect + .5;
+			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_PlayResXUndefinedSettingX, track->PlayResX);
+		}
+	}
+}
+
+ass_renderer_t* ass_renderer_init(ass_library_t* library)
+{
+	int error;
+	FT_Library ft;
+	ass_renderer_t* priv = 0;
+	
+	memset(&render_context, 0, sizeof(render_context));
+	memset(&frame_context, 0, sizeof(frame_context));
+	memset(&text_info, 0, sizeof(text_info));
+
+	error = FT_Init_FreeType( &ft );
+	if ( error ) { 
+		mp_msg(MSGT_ASS, MSGL_FATAL, MSGTR_LIBASS_FT_Init_FreeTypeFailed);
+		goto ass_init_exit;
+	}
+
+	priv = calloc(1, sizeof(ass_renderer_t));
+	if (!priv) {
+		FT_Done_FreeType(ft);
+		goto ass_init_exit;
+	}
+
+	priv->synth_priv = ass_synth_init();
+
+	priv->library = library;
+	priv->ftlibrary = ft;
+	// images_root and related stuff is zero-filled in calloc
+	
+	ass_font_cache_init();
+	ass_bitmap_cache_init();
+	ass_glyph_cache_init();
+
+	text_info.glyphs = calloc(MAX_GLYPHS, sizeof(glyph_info_t));
+	
+ass_init_exit:
+	if (priv) mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_Init);
+	else mp_msg(MSGT_ASS, MSGL_ERR, MSGTR_LIBASS_InitFailed);
+
+	return priv;
+}
+
+void ass_renderer_done(ass_renderer_t* priv)
+{
+	ass_font_cache_done();
+	ass_bitmap_cache_done();
+	ass_glyph_cache_done();
+	if (render_context.stroker) {
+		FT_Stroker_Done(render_context.stroker);
+		render_context.stroker = 0;
+	}
+	if (priv && priv->ftlibrary) FT_Done_FreeType(priv->ftlibrary);
+	if (priv && priv->fontconfig_priv) fontconfig_done(priv->fontconfig_priv);
+	if (priv && priv->synth_priv) ass_synth_done(priv->synth_priv);
+	if (priv && priv->eimg) free(priv->eimg);
+	if (priv) free(priv);
+	if (text_info.glyphs) free(text_info.glyphs);
+}
+
+/**
+ * \brief Create a new ass_image_t
+ * Parameters are the same as ass_image_t fields.
+ */
+static ass_image_t* my_draw_bitmap(unsigned char* bitmap, int bitmap_w, int bitmap_h, int stride, int dst_x, int dst_y, uint32_t color)
+{
+	ass_image_t* img = calloc(1, sizeof(ass_image_t));
+	
+	img->w = bitmap_w;
+	img->h = bitmap_h;
+	img->stride = stride;
+	img->bitmap = bitmap;
+	img->color = color;
+	img->dst_x = dst_x;
+	img->dst_y = dst_y;
+
+	return img;
+}
+
+/**
+ * \brief convert bitmap glyph into ass_image_t struct(s)
+ * \param bit freetype bitmap glyph, FT_PIXEL_MODE_GRAY
+ * \param dst_x bitmap x coordinate in video frame
+ * \param dst_y bitmap y coordinate in video frame
+ * \param color first color, RGBA
+ * \param color2 second color, RGBA
+ * \param brk x coordinate relative to glyph origin, color is used to the left of brk, color2 - to the right
+ * \param tail pointer to the last image's next field, head of the generated list should be stored here
+ * \return pointer to the new list tail
+ * Performs clipping. Uses my_draw_bitmap for actual bitmap convertion.
+ */
+static ass_image_t** render_glyph(bitmap_t* bm, int dst_x, int dst_y, uint32_t color, uint32_t color2, int brk, ass_image_t** tail)
+{
+	// brk is relative to dst_x
+	// color = color left of brk
+	// color2 = color right of brk
+	int b_x0, b_y0, b_x1, b_y1; // visible part of the bitmap
+	int clip_x0, clip_y0, clip_x1, clip_y1;
+	int tmp;
+	ass_image_t* img;
+
+	dst_x += bm->left;
+	dst_y += bm->top;
+	brk -= bm->left;
+	
+	// clipping
+	clip_x0 = render_context.clip_x0;
+	clip_y0 = render_context.clip_y0;
+	clip_x1 = render_context.clip_x1;
+	clip_y1 = render_context.clip_y1;
+	b_x0 = 0;
+	b_y0 = 0;
+	b_x1 = bm->w;
+	b_y1 = bm->h;
+	
+	tmp = dst_x - clip_x0;
+	if (tmp < 0) {
+		mp_msg(MSGT_ASS, MSGL_DBG2, "clip left\n");
+		b_x0 = - tmp;
+	}
+	tmp = dst_y - clip_y0;
+	if (tmp < 0) {
+		mp_msg(MSGT_ASS, MSGL_DBG2, "clip top\n");
+		b_y0 = - tmp;
+	}
+	tmp = clip_x1 - dst_x - bm->w;
+	if (tmp < 0) {
+		mp_msg(MSGT_ASS, MSGL_DBG2, "clip right\n");
+		b_x1 = bm->w + tmp;
+	}
+	tmp = clip_y1 - dst_y - bm->h;
+	if (tmp < 0) {
+		mp_msg(MSGT_ASS, MSGL_DBG2, "clip bottom\n");
+		b_y1 = bm->h + tmp;
+	}
+	
+	if ((b_y0 >= b_y1) || (b_x0 >= b_x1))
+		return tail;
+
+	if (brk > b_x0) { // draw left part
+		if (brk > b_x1) brk = b_x1;
+		img = my_draw_bitmap(bm->buffer + bm->w * b_y0 + b_x0, 
+			brk - b_x0, b_y1 - b_y0, bm->w,
+			dst_x + b_x0, dst_y + b_y0, color);
+		*tail = img;
+		tail = &img->next;
+	}
+	if (brk < b_x1) { // draw right part
+		if (brk < b_x0) brk = b_x0;
+		img = my_draw_bitmap(bm->buffer + bm->w * b_y0 + brk, 
+			b_x1 - brk, b_y1 - b_y0, bm->w,
+			dst_x + brk, dst_y + b_y0, color2);
+		*tail = img;
+		tail = &img->next;
+	}
+	return tail;
+}
+
+/**
+ * \brief Convert text_info_t struct to ass_image_t list
+ * Splits glyphs in halves when needed (for \kf karaoke).
+ */
+static ass_image_t* render_text(text_info_t* text_info, int dst_x, int dst_y)
+{
+	int pen_x, pen_y;
+	int i;
+	bitmap_t* bm;
+	ass_image_t* head;
+	ass_image_t** tail = &head;
+
+	for (i = 0; i < text_info->length; ++i) {
+		glyph_info_t* info = text_info->glyphs + i;
+		if ((info->symbol == 0) || (info->symbol == '\n') || !info->bm_s || (info->shadow == 0))
+			continue;
+
+		pen_x = dst_x + info->pos.x + info->shadow;
+		pen_y = dst_y + info->pos.y + info->shadow;
+		bm = info->bm_s;
+
+		tail = render_glyph(bm, pen_x, pen_y, info->c[3], 0, 1000000, tail);
+	}
+
+	for (i = 0; i < text_info->length; ++i) {
+		glyph_info_t* info = text_info->glyphs + i;
+		if ((info->symbol == 0) || (info->symbol == '\n') || !info->bm_o)
+			continue;
+
+		pen_x = dst_x + info->pos.x;
+		pen_y = dst_y + info->pos.y;
+		bm = info->bm_o;
+		
+		if ((info->effect_type == EF_KARAOKE_KO) && (info->effect_timing <= info->bbox.xMax)) {
+			// do nothing
+		} else
+			tail = render_glyph(bm, pen_x, pen_y, info->c[2], 0, 1000000, tail);
+	}
+	for (i = 0; i < text_info->length; ++i) {
+		glyph_info_t* info = text_info->glyphs + i;
+		if ((info->symbol == 0) || (info->symbol == '\n') || !info->bm)
+			continue;
+
+		pen_x = dst_x + info->pos.x;
+		pen_y = dst_y + info->pos.y;
+		bm = info->bm;
+
+		if ((info->effect_type == EF_KARAOKE) || (info->effect_type == EF_KARAOKE_KO)) {
+			if (info->effect_timing > info->bbox.xMax)
+				tail = render_glyph(bm, pen_x, pen_y, info->c[0], 0, 1000000, tail);
+			else
+				tail = render_glyph(bm, pen_x, pen_y, info->c[1], 0, 1000000, tail);
+		} else if (info->effect_type == EF_KARAOKE_KF) {
+			tail = render_glyph(bm, pen_x, pen_y, info->c[0], info->c[1], info->effect_timing, tail);
+		} else
+			tail = render_glyph(bm, pen_x, pen_y, info->c[0], 0, 1000000, tail);
+	}
+
+	*tail = 0;
+	return head;
+}
+
+/**
+ * \brief Mapping between script and screen coordinates
+ */
+static int x2scr(int x) {
+	return x*frame_context.orig_width / frame_context.track->PlayResX + global_settings->left_margin;
+}
+/**
+ * \brief Mapping between script and screen coordinates
+ */
+static int y2scr(int y) {
+	return y * frame_context.orig_height / frame_context.track->PlayResY + global_settings->top_margin;
+}
+// the same for toptitles
+static int y2scr_top(int y) {
+	if (global_settings->use_margins)
+		return y * frame_context.orig_height / frame_context.track->PlayResY;
+	else
+		return y * frame_context.orig_height / frame_context.track->PlayResY + global_settings->top_margin;
+}
+// the same for subtitles
+static int y2scr_sub(int y) {
+	if (global_settings->use_margins)
+		return y * frame_context.orig_height / frame_context.track->PlayResY +
+		       global_settings->top_margin + global_settings->bottom_margin;
+	else
+		return y * frame_context.orig_height / frame_context.track->PlayResY + global_settings->top_margin;
+}
+
+static void compute_string_bbox( text_info_t* info, FT_BBox *abbox ) {
+	FT_BBox bbox;
+	int i;
+	
+	if (text_info.length > 0) {
+		bbox.xMin = 32000;
+		bbox.xMax = -32000;
+		bbox.yMin = - d6_to_int(text_info.lines[0].asc) + text_info.glyphs[0].pos.y;
+		bbox.yMax = d6_to_int(text_info.height - text_info.lines[0].asc) + text_info.glyphs[0].pos.y;
+
+		for (i = 0; i < text_info.length; ++i) {
+			int s = text_info.glyphs[i].pos.x;
+			int e = s + d6_to_int(text_info.glyphs[i].advance.x);
+			bbox.xMin = FFMIN(bbox.xMin, s);
+			bbox.xMax = FFMAX(bbox.xMax, e);
+		}
+	} else
+		bbox.xMin = bbox.xMax = bbox.yMin = bbox.yMax = 0;
+
+	/* return string bbox */
+	*abbox = bbox;
+}
+
+
+/**
+ * \brief Check if starting part of (*p) matches sample. If true, shift p to the first symbol after the matching part.
+ */
+static inline int mystrcmp(char** p, const char* sample) {
+	int len = strlen(sample);
+	if (strncmp(*p, sample, len) == 0) {
+		(*p) += len;
+		return 1;
+	} else
+		return 0;
+}
+
+static void change_font_size(double sz)
+{
+	double size = sz * frame_context.font_scale;
+
+	if (size < 1)
+		size = 1;
+	else if (size > frame_context.height * 2)
+		size = frame_context.height * 2;
+
+	ass_font_set_size(render_context.font, size);
+
+	render_context.font_size = sz;
+}
+
+/**
+ * \brief Change current font, using setting from render_context.
+ */
+static void update_font(void)
+{
+	unsigned val;
+	ass_renderer_t* priv = frame_context.ass_priv;
+	ass_font_desc_t desc;
+	desc.family = strdup(render_context.family);
+
+	val = render_context.bold;
+	// 0 = normal, 1 = bold, >1 = exact weight
+	if (val == 0) val = 80; // normal
+	else if (val == 1) val = 200; // bold
+	desc.bold = val;
+
+	val = render_context.italic;
+	if (val == 0) val = 0; // normal
+	else if (val == 1) val = 110; //italic
+	desc.italic = val;
+
+	render_context.font = ass_font_new(priv->library, priv->ftlibrary, priv->fontconfig_priv, &desc);
+	free(desc.family);
+	
+	if (render_context.font)
+		change_font_size(render_context.font_size);
+}
+
+/**
+ * \brief Change border width
+ * negative value resets border to style value
+ */
+static void change_border(double border)
+{
+	int b;
+	if (!render_context.font) return;
+
+	if (border < 0) {
+		if (render_context.style->BorderStyle == 1) {
+			if (render_context.style->Outline == 0 && render_context.style->Shadow > 0)
+				border = 1.;
+			else
+				border = render_context.style->Outline;
+		} else
+			border = 1.;
+	}
+	render_context.border = border;
+
+	b = 64 * border * frame_context.border_scale;
+	if (b > 0) {
+		if (!render_context.stroker) {
+			int error;
+#if (FREETYPE_MAJOR > 2) || ((FREETYPE_MAJOR == 2) && (FREETYPE_MINOR > 1))
+			error = FT_Stroker_New( ass_renderer->ftlibrary, &render_context.stroker );
+#else // < 2.2
+			error = FT_Stroker_New( render_context.font->faces[0]->memory, &render_context.stroker );
+#endif
+			if (error) {
+				mp_msg(MSGT_ASS, MSGL_V, "failed to get stroker\n");
+				render_context.stroker = 0;
+			}
+		}
+		if (render_context.stroker)
+			FT_Stroker_Set( render_context.stroker, b,
+					FT_STROKER_LINECAP_ROUND,
+					FT_STROKER_LINEJOIN_ROUND,
+					0 );
+	} else {
+		FT_Stroker_Done(render_context.stroker);
+		render_context.stroker = 0;
+	}
+}
+
+#define _r(c)  ((c)>>24)
+#define _g(c)  (((c)>>16)&0xFF)
+#define _b(c)  (((c)>>8)&0xFF)
+#define _a(c)  ((c)&0xFF)
+
+/**
+ * \brief Calculate a weighted average of two colors
+ * calculates c1*(1-a) + c2*a, but separately for each component except alpha
+ */
+static void change_color(uint32_t* var, uint32_t new, double pwr)
+{
+	(*var)= ((uint32_t)(_r(*var) * (1 - pwr) + _r(new) * pwr) << 24) +
+		((uint32_t)(_g(*var) * (1 - pwr) + _g(new) * pwr) << 16) +
+		((uint32_t)(_b(*var) * (1 - pwr) + _b(new) * pwr) << 8) +
+		_a(*var);
+}
+
+// like change_color, but for alpha component only
+static void change_alpha(uint32_t* var, uint32_t new, double pwr)
+{
+	*var = (_r(*var) << 24) + (_g(*var) << 16) + (_b(*var) << 8) + (_a(*var) * (1 - pwr) + _a(new) * pwr);
+}
+
+/**
+ * \brief Multiply two alpha values
+ * \param a first value
+ * \param b second value
+ * \return result of multiplication
+ * Parameters and result are limited by 0xFF.
+ */
+static uint32_t mult_alpha(uint32_t a, uint32_t b)
+{
+	return 0xFF - (0xFF - a) * (0xFF - b) / 0xFF;
+}
+
+/**
+ * \brief Calculate alpha value by piecewise linear function
+ * Used for \fad, \fade implementation.
+ */
+static unsigned interpolate_alpha(long long now, 
+		long long t1, long long t2, long long t3, long long t4,
+		unsigned a1, unsigned a2, unsigned a3)
+{
+	unsigned a;
+	double cf;
+	if (now <= t1) {
+		a = a1;
+	} else if (now >= t4) {
+		a = a3;
+	} else if (now < t2) { // and > t1
+		cf = ((double)(now - t1)) / (t2 - t1);
+		a = a1 * (1 - cf) + a2 * cf;
+	} else if (now > t3) {
+		cf = ((double)(now - t3)) / (t4 - t3);
+		a = a2 * (1 - cf) + a3 * cf;
+	} else { // t2 <= now <= t3
+		a = a2;
+	}
+
+	return a;
+}
+
+static void reset_render_context(void);
+
+/**
+ * \brief Parse style override tag.
+ * \param p string to parse
+ * \param pwr multiplier for some tag effects (comes from \t tags)
+ */
+static char* parse_tag(char* p, double pwr) {
+#define skip_all(x) if (*p == (x)) ++p; else { \
+	while ((*p != (x)) && (*p != '}') && (*p != 0)) {++p;} }
+#define skip(x) if (*p == (x)) ++p; else { return p; }
+	
+	skip_all('\\');
+	if ((*p == '}') || (*p == 0))
+		return p;
+
+	if (mystrcmp(&p, "fsc")) {
+		char tp = *p++;
+		double val;
+		if (tp == 'x') {
+			if (mystrtod(&p, &val)) {
+				val /= 100;
+				render_context.scale_x = render_context.scale_x * ( 1 - pwr) + val * pwr;
+			} else
+				render_context.scale_x = render_context.style->ScaleX;
+		} else if (tp == 'y') {
+			if (mystrtod(&p, &val)) {
+				val /= 100;
+				render_context.scale_y = render_context.scale_y * ( 1 - pwr) + val * pwr;
+			} else
+				render_context.scale_y = render_context.style->ScaleY;
+		}
+	} else if (mystrcmp(&p, "fsp")) {
+		double val;
+		if (mystrtod(&p, &val))
+			render_context.hspacing = render_context.hspacing * ( 1 - pwr ) + val * pwr;
+		else
+			render_context.hspacing = render_context.style->Spacing;
+	} else if (mystrcmp(&p, "fs")) {
+		double val;
+		if (mystrtod(&p, &val))
+			val = render_context.font_size * ( 1 - pwr ) + val * pwr;
+		else
+			val = render_context.style->FontSize;
+		if (render_context.font)
+			change_font_size(val);
+	} else if (mystrcmp(&p, "bord")) {
+		double val;
+		if (mystrtod(&p, &val))
+			val = render_context.border * ( 1 - pwr ) + val * pwr;
+		else
+			val = -1.; // reset to default
+		change_border(val);
+	} else if (mystrcmp(&p, "move")) {
+		int x1, x2, y1, y2;
+		long long t1, t2, delta_t, t;
+		int x, y;
+		double k;
+		skip('(');
+		x1 = strtol(p, &p, 10);
+		skip(',');
+		y1 = strtol(p, &p, 10);
+		skip(',');
+		x2 = strtol(p, &p, 10);
+		skip(',');
+		y2 = strtol(p, &p, 10);
+		if (*p == ',') {
+			skip(',');
+			t1 = strtoll(p, &p, 10);
+			skip(',');
+			t2 = strtoll(p, &p, 10);
+			mp_msg(MSGT_ASS, MSGL_DBG2, "movement6: (%d, %d) -> (%d, %d), (%" PRId64 " .. %" PRId64 ")\n", 
+				x1, y1, x2, y2, (int64_t)t1, (int64_t)t2);
+		} else {
+			t1 = 0;
+			t2 = render_context.event->Duration;
+			mp_msg(MSGT_ASS, MSGL_DBG2, "movement: (%d, %d) -> (%d, %d)\n", x1, y1, x2, y2);
+		}
+		skip(')');
+		delta_t = t2 - t1;
+		t = frame_context.time - render_context.event->Start;
+		if (t < t1)
+			k = 0.;
+		else if (t > t2)
+			k = 1.;
+		else k = ((double)(t - t1)) / delta_t;
+		x = k * (x2 - x1) + x1;
+		y = k * (y2 - y1) + y1;
+		render_context.pos_x = x;
+		render_context.pos_y = y;
+		render_context.detect_collisions = 0;
+		render_context.evt_type = EVENT_POSITIONED;
+	} else if (mystrcmp(&p, "frx")) {
+		double val;
+		if (mystrtod(&p, &val)) {
+			val *= M_PI / 180;
+			render_context.frx = val * pwr + render_context.frx * (1-pwr);
+		} else
+			render_context.frx = 0.;
+	} else if (mystrcmp(&p, "fry")) {
+		double val;
+		if (mystrtod(&p, &val)) {
+			val *= M_PI / 180;
+			render_context.fry = val * pwr + render_context.fry * (1-pwr);
+		} else
+			render_context.fry = 0.;
+	} else if (mystrcmp(&p, "frz") || mystrcmp(&p, "fr")) {
+		double val;
+		if (mystrtod(&p, &val)) {
+			val *= M_PI / 180;
+			render_context.frz = val * pwr + render_context.frz * (1-pwr);
+		} else
+			render_context.frz = M_PI * render_context.style->Angle / 180.;
+	} else if (mystrcmp(&p, "fn")) {
+		char* start = p;
+		char* family;
+		skip_all('\\');
+		if (p > start) {
+			family = malloc(p - start + 1);
+			strncpy(family, start, p - start);
+			family[p - start] = '\0';
+		} else
+			family = strdup(render_context.style->FontName);
+		if (render_context.family)
+			free(render_context.family);
+		render_context.family = family;
+		update_font();
+	} else if (mystrcmp(&p, "alpha")) {
+		uint32_t val;
+		int i;
+		if (strtocolor(&p, &val)) {
+			unsigned char a = val >> 24;
+			for (i = 0; i < 4; ++i)
+				change_alpha(&render_context.c[i], a, pwr);
+		} else {
+			change_alpha(&render_context.c[0], render_context.style->PrimaryColour, pwr);
+			change_alpha(&render_context.c[1], render_context.style->SecondaryColour, pwr);
+			change_alpha(&render_context.c[2], render_context.style->OutlineColour, pwr);
+			change_alpha(&render_context.c[3], render_context.style->BackColour, pwr);
+		}
+		// FIXME: simplify
+	} else if (mystrcmp(&p, "an")) {
+		int val;
+		if (mystrtoi(&p, 10, &val) && val) {
+			int v = (val - 1) / 3; // 0, 1 or 2 for vertical alignment
+			mp_msg(MSGT_ASS, MSGL_DBG2, "an %d\n", val);
+			if (v != 0) v = 3 - v;
+			val = ((val - 1) % 3) + 1; // horizontal alignment
+			val += v*4;
+			mp_msg(MSGT_ASS, MSGL_DBG2, "align %d\n", val);
+			render_context.alignment = val;
+		} else
+			render_context.alignment = render_context.style->Alignment;
+	} else if (mystrcmp(&p, "a")) {
+		int val;
+		if (mystrtoi(&p, 10, &val) && val)
+			render_context.alignment = val;
+		else
+			render_context.alignment = render_context.style->Alignment;
+	} else if (mystrcmp(&p, "pos")) {
+		int v1, v2;
+		skip('(');
+		v1 = strtol(p, &p, 10);
+		skip(',');
+		v2 = strtol(p, &p, 10);
+		skip(')');
+		mp_msg(MSGT_ASS, MSGL_DBG2, "pos(%d, %d)\n", v1, v2);
+		render_context.evt_type = EVENT_POSITIONED;
+		render_context.detect_collisions = 0;
+		render_context.pos_x = v1;
+		render_context.pos_y = v2;
+	} else if (mystrcmp(&p, "fad")) {
+		int a1, a2, a3;
+		long long t1, t2, t3, t4;
+		if (*p == 'e') ++p; // either \fad or \fade
+		skip('(');
+		a1 = strtol(p, &p, 10);
+		skip(',');
+		a2 = strtol(p, &p, 10);
+		if (*p == ')') {
+			// 2-argument version (\fad, according to specs)
+			// a1 and a2 are fade-in and fade-out durations
+			t1 = 0;
+			t4 = render_context.event->Duration;
+			t2 = a1;
+			t3 = t4 - a2;
+			a1 = 0xFF;
+			a2 = 0;
+			a3 = 0xFF;
+		} else {
+			// 6-argument version (\fade)
+			// a1 and a2 (and a3) are opacity values
+			skip(',');
+			a3 = strtol(p, &p, 10);
+			skip(',');
+			t1 = strtoll(p, &p, 10);
+			skip(',');
+			t2 = strtoll(p, &p, 10);
+			skip(',');
+			t3 = strtoll(p, &p, 10);
+			skip(',');
+			t4 = strtoll(p, &p, 10);
+		}
+		skip(')');
+		render_context.fade = interpolate_alpha(frame_context.time - render_context.event->Start, t1, t2, t3, t4, a1, a2, a3);
+	} else if (mystrcmp(&p, "org")) {
+		int v1, v2;
+		skip('(');
+		v1 = strtol(p, &p, 10);
+		skip(',');
+		v2 = strtol(p, &p, 10);
+		skip(')');
+		mp_msg(MSGT_ASS, MSGL_DBG2, "org(%d, %d)\n", v1, v2);
+		//				render_context.evt_type = EVENT_POSITIONED;
+		render_context.org_x = v1;
+		render_context.org_y = v2;
+		render_context.have_origin = 1;
+	} else if (mystrcmp(&p, "t")) {
+		double v[3];
+		int v1, v2;
+		double v3;
+		int cnt;
+		long long t1, t2, t, delta_t;
+		double k;
+		skip('(');
+		for (cnt = 0; cnt < 3; ++cnt) {
+			if (*p == '\\')
+				break;
+			v[cnt] = strtod(p, &p);
+			skip(',');
+		}
+		if (cnt == 3) {
+			v1 = v[0]; v2 = v[1]; v3 = v[2];
+		} else if (cnt == 2) {
+			v1 = v[0]; v2 = v[1]; v3 = 1.;
+		} else if (cnt == 1) {
+			v1 = 0; v2 = render_context.event->Duration; v3 = v[0];
+		} else { // cnt == 0
+			v1 = 0; v2 = render_context.event->Duration; v3 = 1.;
+		}
+		render_context.detect_collisions = 0;
+		t1 = v1;
+		t2 = v2;
+		delta_t = v2 - v1;
+		if (v3 < 0.)
+			v3 = 0.;
+		t = frame_context.time - render_context.event->Start; // FIXME: move to render_context
+		if (t <= t1)
+			k = 0.;
+		else if (t >= t2)
+			k = 1.;
+		else {
+			assert(delta_t != 0.);
+			k = pow(((double)(t - t1)) / delta_t, v3);
+		}
+		while (*p == '\\')
+			p = parse_tag(p, k); // maybe k*pwr ? no, specs forbid nested \t's 
+		skip_all(')'); // FIXME: better skip(')'), but much more tags support required
+	} else if (mystrcmp(&p, "clip")) {
+		int x0, y0, x1, y1;
+		int res = 1;
+		skip('(');
+		res &= mystrtoi(&p, 10, &x0);
+		skip(',');
+		res &= mystrtoi(&p, 10, &y0);
+		skip(',');
+		res &= mystrtoi(&p, 10, &x1);
+		skip(',');
+		res &= mystrtoi(&p, 10, &y1);
+		skip(')');
+		if (res) {
+			render_context.clip_x0 = render_context.clip_x0 * (1-pwr) + x0 * pwr;
+			render_context.clip_x1 = render_context.clip_x1 * (1-pwr) + x1 * pwr;
+			render_context.clip_y0 = render_context.clip_y0 * (1-pwr) + y0 * pwr;
+			render_context.clip_y1 = render_context.clip_y1 * (1-pwr) + y1 * pwr;
+		} else {
+			render_context.clip_x0 = 0;
+			render_context.clip_y0 = 0;
+			render_context.clip_x1 = frame_context.track->PlayResX;
+			render_context.clip_y1 = frame_context.track->PlayResY;
+		}
+	} else if (mystrcmp(&p, "c")) {
+		uint32_t val;
+		if (!strtocolor(&p, &val))
+			val = render_context.style->PrimaryColour;
+		mp_msg(MSGT_ASS, MSGL_DBG2, "color: %X\n", val);
+		change_color(&render_context.c[0], val, pwr);
+	} else if ((*p >= '1') && (*p <= '4') && (++p) && (mystrcmp(&p, "c") || mystrcmp(&p, "a"))) {
+		char n = *(p-2);
+		int cidx = n - '1';
+		char cmd = *(p-1);
+		uint32_t val;
+		assert((n >= '1') && (n <= '4'));
+		if (!strtocolor(&p, &val))
+			switch(n) {
+				case '1': val = render_context.style->PrimaryColour; break;
+				case '2': val = render_context.style->SecondaryColour; break;
+				case '3': val = render_context.style->OutlineColour; break;
+				case '4': val = render_context.style->BackColour; break;
+				default : val = 0; break; // impossible due to assert; avoid compilation warning
+			}
+		switch (cmd) {
+			case 'c': change_color(render_context.c + cidx, val, pwr); break;
+			case 'a': change_alpha(render_context.c + cidx, val >> 24, pwr); break;
+			default: mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_BadCommand, n, cmd); break;
+		}
+		mp_msg(MSGT_ASS, MSGL_DBG2, "single c/a at %f: %c%c = %X   \n", pwr, n, cmd, render_context.c[cidx]);
+	} else if (mystrcmp(&p, "r")) {
+		reset_render_context();
+	} else if (mystrcmp(&p, "be")) {
+		int val;
+		if (mystrtoi(&p, 10, &val))
+			render_context.be = val ? 1 : 0;
+		else
+			render_context.be = 0;
+	} else if (mystrcmp(&p, "b")) {
+		int b;
+		if (mystrtoi(&p, 10, &b)) {
+			if (pwr >= .5)
+				render_context.bold = b;
+		} else
+			render_context.bold = render_context.style->Bold;
+		update_font();
+	} else if (mystrcmp(&p, "i")) {
+		int i;
+		if (mystrtoi(&p, 10, &i)) {
+			if (pwr >= .5)
+				render_context.italic = i;
+		} else
+			render_context.italic = render_context.style->Italic;
+		update_font();
+	} else if (mystrcmp(&p, "kf") || mystrcmp(&p, "K")) {
+		int val = strtol(p, &p, 10);
+		render_context.effect_type = EF_KARAOKE_KF;
+		if (render_context.effect_timing)
+			render_context.effect_skip_timing += render_context.effect_timing;
+		render_context.effect_timing = val * 10;
+	} else if (mystrcmp(&p, "ko")) {
+		int val = strtol(p, &p, 10);
+		render_context.effect_type = EF_KARAOKE_KO;
+		if (render_context.effect_timing)
+			render_context.effect_skip_timing += render_context.effect_timing;
+		render_context.effect_timing = val * 10;
+	} else if (mystrcmp(&p, "k")) {
+		int val = strtol(p, &p, 10);
+		render_context.effect_type = EF_KARAOKE;
+		if (render_context.effect_timing)
+			render_context.effect_skip_timing += render_context.effect_timing;
+		render_context.effect_timing = val * 10;
+	} else if (mystrcmp(&p, "shad")) {
+		int val;
+		if (mystrtoi(&p, 10, &val))
+			render_context.shadow = val;
+		else
+			render_context.shadow = render_context.style->Shadow;
+	}
+
+	return p;
+
+#undef skip
+#undef skip_all
+}
+
+/**
+ * \brief Get next ucs4 char from string, parsing and executing style overrides
+ * \param str string pointer
+ * \return ucs4 code of the next char
+ * On return str points to the unparsed part of the string
+ */
+static unsigned get_next_char(char** str)
+{
+	char* p = *str;
+	unsigned chr;
+	if (*p == '{') { // '\0' goes here
+		p++;
+		while (1) {
+			p = parse_tag(p, 1.);
+			if (*p == '}') { // end of tag
+				p++;
+				if (*p == '{') {
+					p++;
+					continue;
+				} else
+					break;
+			} else if (*p != '\\')
+				mp_msg(MSGT_ASS, MSGL_V, "Unable to parse: \"%s\" \n", p);
+			if (*p == 0)
+				break;
+		}
+	}
+	if (*p == '\t') {
+		++p;
+		*str = p;
+		return ' ';
+	}
+	if (*p == '\\') {
+		if ((*(p+1) == 'N') || ((*(p+1) == 'n') && (frame_context.track->WrapStyle == 2))) {
+			p += 2;
+			*str = p;
+			return '\n';
+		} else if (*(p+1) == 'n') {
+			p += 2;
+			*str = p;
+			return ' ';
+		}
+	}
+	chr = utf8_get_char(&p);
+	*str = p;
+	return chr;
+}
+
+static void apply_transition_effects(ass_event_t* event)
+{
+	int v[4];
+	int cnt;
+	char* p = event->Effect;
+
+	if (!p || !*p) return;
+
+	cnt = 0;
+	while (cnt < 4 && (p = strchr(p, ';'))) {
+		v[cnt++] = atoi(++p);
+	}
+	
+	if (strncmp(event->Effect, "Banner;", 7) == 0) {
+		int delay;
+		if (cnt < 1) {
+			mp_msg(MSGT_ASS, MSGL_V, "Error parsing effect: %s \n", event->Effect);
+			return;
+		}
+		if (cnt >= 2 && v[1] == 0) // right-to-left
+			render_context.scroll_direction = SCROLL_RL;
+		else // left-to-right
+			render_context.scroll_direction = SCROLL_LR;
+
+		delay = v[0];
+		if (delay == 0) delay = 1; // ?
+		render_context.scroll_shift = (frame_context.time - render_context.event->Start) / delay;
+		render_context.evt_type = EVENT_HSCROLL;
+		return;
+	}
+
+	if (strncmp(event->Effect, "Scroll up;", 10) == 0) {
+		render_context.scroll_direction = SCROLL_BT;
+	} else if (strncmp(event->Effect, "Scroll down;", 12) == 0) {
+		render_context.scroll_direction = SCROLL_TB;
+	} else {
+		mp_msg(MSGT_ASS, MSGL_V, "Unknown transition effect: %s \n", event->Effect);
+		return;
+	}
+	// parse scroll up/down parameters
+	{
+		int delay;
+		int y0, y1;
+		if (cnt < 3) {
+			mp_msg(MSGT_ASS, MSGL_V, "Error parsing effect: %s \n", event->Effect);
+			return;
+		}
+		delay = v[2];
+		if (delay == 0) delay = 1; // ?
+		render_context.scroll_shift = (frame_context.time - render_context.event->Start) / delay;
+		if (v[0] < v[1]) {
+			y0 = v[0]; y1 = v[1];
+		} else {
+			y0 = v[1]; y1 = v[0];
+		}
+		if (y1 == 0)
+			y1 = frame_context.track->PlayResY; // y0=y1=0 means fullscreen scrolling
+		render_context.clip_y0 = y0;
+		render_context.clip_y1 = y1;
+		render_context.evt_type = EVENT_VSCROLL;
+		render_context.detect_collisions = 0;
+	}
+
+}
+
+/**
+ * \brief partially reset render_context to style values
+ * Works like {\r}: resets some style overrides
+ */
+static void reset_render_context(void)
+{
+	render_context.c[0] = render_context.style->PrimaryColour;
+	render_context.c[1] = render_context.style->SecondaryColour;
+	render_context.c[2] = render_context.style->OutlineColour;
+	render_context.c[3] = render_context.style->BackColour;
+	render_context.font_size = render_context.style->FontSize;
+
+	if (render_context.family)
+		free(render_context.family);
+	render_context.family = strdup(render_context.style->FontName);
+	render_context.bold = render_context.style->Bold;
+	render_context.italic = render_context.style->Italic;
+	update_font();
+
+	change_border(-1.);
+	render_context.scale_x = render_context.style->ScaleX;
+	render_context.scale_y = render_context.style->ScaleY;
+	render_context.hspacing = render_context.style->Spacing;
+	render_context.be = 0;
+	render_context.shadow = render_context.style->Shadow;
+	render_context.frx = render_context.fry = 0.;
+	render_context.frz = M_PI * render_context.style->Angle / 180.;
+
+	// FIXME: does not reset unsupported attributes.
+}
+
+/**
+ * \brief Start new event. Reset render_context.
+ */
+static void init_render_context(ass_event_t* event)
+{
+	render_context.event = event;
+	render_context.style = frame_context.track->styles + event->Style;
+
+	reset_render_context();
+
+	render_context.evt_type = EVENT_NORMAL;
+	render_context.alignment = render_context.style->Alignment;
+	render_context.pos_x = 0;
+	render_context.pos_y = 0;
+	render_context.org_x = 0;
+	render_context.org_y = 0;
+	render_context.have_origin = 0;
+	render_context.clip_x0 = 0;
+	render_context.clip_y0 = 0;
+	render_context.clip_x1 = frame_context.track->PlayResX;
+	render_context.clip_y1 = frame_context.track->PlayResY;
+	render_context.detect_collisions = 1;
+	render_context.fade = 0;
+	render_context.effect_type = EF_NONE;
+	render_context.effect_timing = 0;
+	render_context.effect_skip_timing = 0;
+	
+	apply_transition_effects(event);
+}
+
+static void free_render_context(void)
+{
+}
+
+/**
+ * \brief Get normal and outline (border) glyphs
+ * \param symbol ucs4 char
+ * \param info out: struct filled with extracted data
+ * \param advance subpixel shift vector used for cache lookup
+ * Tries to get both glyphs from cache.
+ * If they can't be found, gets a glyph from font face, generates outline with FT_Stroker,
+ * and add them to cache.
+ * The glyphs are returned in info->glyph and info->outline_glyph
+ */
+static void get_outline_glyph(int symbol, glyph_info_t* info, FT_Vector* advance)
+{
+	int error;
+	glyph_hash_val_t* val;
+	glyph_hash_key_t key;
+	key.font = render_context.font;
+	key.size = render_context.font_size;
+	key.ch = symbol;
+	key.scale_x = (render_context.scale_x * 0xFFFF);
+	key.scale_y = (render_context.scale_y * 0xFFFF);
+	key.advance = *advance;
+	key.bold = render_context.bold;
+	key.italic = render_context.italic;
+	key.outline = render_context.border * 0xFFFF;
+
+	info->glyph = info->outline_glyph = 0;
+
+	val = cache_find_glyph(&key);
+	if (val) {
+		FT_Glyph_Copy(val->glyph, &info->glyph);
+		if (val->outline_glyph)
+			FT_Glyph_Copy(val->outline_glyph, &info->outline_glyph);
+		info->bbox = val->bbox_scaled;
+		info->advance.x = val->advance.x;
+		info->advance.y = val->advance.y;
+	} else {
+		glyph_hash_val_t v;
+		info->glyph = ass_font_get_glyph(frame_context.ass_priv->fontconfig_priv, render_context.font, symbol, global_settings->hinting);
+		if (!info->glyph)
+			return;
+		info->advance.x = d16_to_d6(info->glyph->advance.x);
+		info->advance.y = d16_to_d6(info->glyph->advance.y);
+		FT_Glyph_Get_CBox( info->glyph, FT_GLYPH_BBOX_PIXELS, &info->bbox);
+
+		if (render_context.stroker) {
+			info->outline_glyph = info->glyph;
+			error = FT_Glyph_StrokeBorder( &(info->outline_glyph), render_context.stroker, 0 , 0 ); // don't destroy original
+			if (error) {
+				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FT_Glyph_Stroke_Error, error);
+			}
+		}
+
+		memset(&v, 0, sizeof(v));
+		FT_Glyph_Copy(info->glyph, &v.glyph);
+		if (info->outline_glyph)
+			FT_Glyph_Copy(info->outline_glyph, &v.outline_glyph);
+		v.advance = info->advance;
+		v.bbox_scaled = info->bbox;
+		cache_add_glyph(&key, &v);
+	}
+}
+
+static void transform_3d(FT_Vector shift, FT_Glyph* glyph, FT_Glyph* glyph2, double frx, double fry, double frz);
+
+/**
+ * \brief Get bitmaps for a glyph
+ * \param info glyph info
+ * Tries to get glyph bitmaps from bitmap cache.
+ * If they can't be found, they are generated by rotating and rendering the glyph.
+ * After that, bitmaps are added to the cache.
+ * They are returned in info->bm (glyph), info->bm_o (outline) and info->bm_s (shadow).
+ */
+static void get_bitmap_glyph(glyph_info_t* info)
+{
+	bitmap_hash_val_t* val;
+	bitmap_hash_key_t* key = &info->hash_key;
+	
+	val = cache_find_bitmap(key);
+/* 	val = 0; */
+	
+	if (val) {
+		info->bm = val->bm;
+		info->bm_o = val->bm_o;
+		info->bm_s = val->bm_s;
+	} else {
+		FT_Vector shift;
+		bitmap_hash_val_t hash_val;
+		int error;
+		info->bm = info->bm_o = info->bm_s = 0;
+		if (info->glyph && info->symbol != '\n' && info->symbol != 0) {
+			// calculating rotation shift vector (from rotation origin to the glyph basepoint)
+			shift.x = int_to_d6(info->hash_key.shift_x);
+			shift.y = int_to_d6(info->hash_key.shift_y);
+			// apply rotation
+			transform_3d(shift, &info->glyph, &info->outline_glyph, info->frx, info->fry, info->frz);
+
+			// render glyph
+			error = glyph_to_bitmap(ass_renderer->synth_priv,
+					info->glyph, info->outline_glyph,
+					&info->bm, &info->bm_o,
+					&info->bm_s, info->be);
+			if (error)
+				info->symbol = 0;
+
+			// add bitmaps to cache
+			hash_val.bm_o = info->bm_o;
+			hash_val.bm = info->bm;
+			hash_val.bm_s = info->bm_s;
+			cache_add_bitmap(&(info->hash_key), &hash_val);
+		}
+	}
+	// deallocate glyphs
+	if (info->glyph)
+		FT_Done_Glyph(info->glyph);
+	if (info->outline_glyph)
+		FT_Done_Glyph(info->outline_glyph);
+}
+
+/**
+ * This function goes through text_info and calculates text parameters.
+ * The following text_info fields are filled:
+ *   height
+ *   lines[].height
+ *   lines[].asc
+ *   lines[].desc
+ */
+static void measure_text(void)
+{
+	int cur_line = 0, max_asc = 0, max_desc = 0;
+	int i;
+	text_info.height = 0;
+	for (i = 0; i < text_info.length + 1; ++i) {
+		if ((i == text_info.length) || text_info.glyphs[i].linebreak) {
+			text_info.lines[cur_line].asc = max_asc;
+			text_info.lines[cur_line].desc = max_desc;
+			text_info.height += max_asc + max_desc;
+			cur_line ++;
+			max_asc = max_desc = 0;
+		}
+		if (i < text_info.length) {
+			glyph_info_t* cur = text_info.glyphs + i;
+			if (cur->asc > max_asc)
+				max_asc = cur->asc;
+			if (cur->desc > max_desc)
+				max_desc = cur->desc;
+		}
+	}
+	text_info.height += (text_info.n_lines - 1) * double_to_d6(global_settings->line_spacing);
+}
+
+/**
+ * \brief rearrange text between lines
+ * \param max_text_width maximal text line width in pixels
+ * The algo is similar to the one in libvo/sub.c:
+ * 1. Place text, wrapping it when current line is full
+ * 2. Try moving words from the end of a line to the beginning of the next one while it reduces
+ * the difference in lengths between this two lines.
+ * The result may not be optimal, but usually is good enough.
+ */
+static void wrap_lines_smart(int max_text_width)
+{
+	int i, j;
+	glyph_info_t *cur, *s1, *e1, *s2, *s3, *w;
+	int last_space;
+	int break_type;
+	int exit;
+	int pen_shift_x;
+	int pen_shift_y;
+	int cur_line;
+
+	last_space = -1;
+	text_info.n_lines = 1;
+	break_type = 0;
+	s1 = text_info.glyphs; // current line start
+	for (i = 0; i < text_info.length; ++i) {
+		int break_at, s_offset, len;
+		cur = text_info.glyphs + i;
+		break_at = -1;
+		s_offset = s1->bbox.xMin + s1->pos.x;
+		len = (cur->bbox.xMax + cur->pos.x) - s_offset;
+
+		if (cur->symbol == '\n') {
+			break_type = 2;
+			break_at = i;
+			mp_msg(MSGT_ASS, MSGL_DBG2, "forced line break at %d\n", break_at);
+		}
+		
+		if (len >= max_text_width) {
+			break_type = 1;
+			break_at = last_space;
+			if (break_at == -1)
+				break_at = i - 1;
+			if (break_at == -1)
+				break_at = 0;
+			mp_msg(MSGT_ASS, MSGL_DBG2, "overfill at %d\n", i);
+			mp_msg(MSGT_ASS, MSGL_DBG2, "line break at %d\n", break_at);
+		}
+
+		if (break_at != -1) {
+			// need to use one more line
+			// marking break_at+1 as start of a new line
+			int lead = break_at + 1; // the first symbol of the new line
+			if (text_info.n_lines >= MAX_LINES) {
+				// to many lines ! 
+				// no more linebreaks
+				for (j = lead; j < text_info.length; ++j)
+					text_info.glyphs[j].linebreak = 0;
+				break;
+			}
+			if (lead < text_info.length)
+				text_info.glyphs[lead].linebreak = break_type;
+			last_space = -1;
+			s1 = text_info.glyphs + lead;
+			s_offset = s1->bbox.xMin + s1->pos.x;
+			text_info.n_lines ++;
+		}
+		
+		if (cur->symbol == ' ')
+			last_space = i;
+
+		// make sure the hard linebreak is not forgotten when
+		// there was a new soft linebreak just inserted
+		if (cur->symbol == '\n' && break_type == 1)
+			i--;
+	}
+#define DIFF(x,y) (((x) < (y)) ? (y - x) : (x - y))
+	exit = 0;
+	while (!exit) {
+		exit = 1;
+		w = s3 = text_info.glyphs;
+		s1 = s2 = 0;
+		for (i = 0; i <= text_info.length; ++i) {
+			cur = text_info.glyphs + i;
+			if ((i == text_info.length) || cur->linebreak) {
+				s1 = s2;
+				s2 = s3;
+				s3 = cur;
+				if (s1 && (s2->linebreak == 1)) { // have at least 2 lines, and linebreak is 'soft'
+					int l1, l2, l1_new, l2_new;
+
+					w = s2;
+					do { --w; } while ((w > s1) && (w->symbol == ' '));
+					while ((w > s1) && (w->symbol != ' ')) { --w; }
+					e1 = w;
+					while ((e1 > s1) && (e1->symbol == ' ')) { --e1; }
+					if (w->symbol == ' ') ++w;
+
+					l1 = ((s2-1)->bbox.xMax + (s2-1)->pos.x) - (s1->bbox.xMin + s1->pos.x);
+					l2 = ((s3-1)->bbox.xMax + (s3-1)->pos.x) - (s2->bbox.xMin + s2->pos.x);
+					l1_new = (e1->bbox.xMax + e1->pos.x) - (s1->bbox.xMin + s1->pos.x);
+					l2_new = ((s3-1)->bbox.xMax + (s3-1)->pos.x) - (w->bbox.xMin + w->pos.x);
+
+					if (DIFF(l1_new, l2_new) < DIFF(l1, l2)) {
+						w->linebreak = 1;
+						s2->linebreak = 0;
+						exit = 0;
+					}
+				}
+			}
+			if (i == text_info.length)
+				break;
+		}
+		
+	}
+	assert(text_info.n_lines >= 1);
+#undef DIFF
+	
+	measure_text();
+
+	pen_shift_x = 0;
+	pen_shift_y = 0;
+	cur_line = 1;
+	for (i = 0; i < text_info.length; ++i) {
+		cur = text_info.glyphs + i;
+		if (cur->linebreak) {
+			int height = text_info.lines[cur_line - 1].desc + text_info.lines[cur_line].asc;
+			cur_line ++;
+			pen_shift_x = - cur->pos.x;
+			pen_shift_y += d6_to_int(height + double_to_d6(global_settings->line_spacing));
+			mp_msg(MSGT_ASS, MSGL_DBG2, "shifting from %d to %d by (%d, %d)\n", i, text_info.length - 1, pen_shift_x, pen_shift_y);
+		}
+		cur->pos.x += pen_shift_x;
+		cur->pos.y += pen_shift_y;
+	}
+}
+
+/**
+ * \brief determine karaoke effects
+ * Karaoke effects cannot be calculated during parse stage (get_next_char()),
+ * so they are done in a separate step.
+ * Parse stage: when karaoke style override is found, its parameters are stored in the next glyph's 
+ * (the first glyph of the karaoke word)'s effect_type and effect_timing.
+ * This function:
+ * 1. sets effect_type for all glyphs in the word (_karaoke_ word)
+ * 2. sets effect_timing for all glyphs to x coordinate of the border line between the left and right karaoke parts
+ * (left part is filled with PrimaryColour, right one - with SecondaryColour).
+ */
+static void process_karaoke_effects(void)
+{
+	glyph_info_t *cur, *cur2;
+	glyph_info_t *s1, *e1; // start and end of the current word
+	glyph_info_t *s2; // start of the next word
+	int i;
+	int timing; // current timing
+	int tm_start, tm_end; // timings at start and end of the current word
+	int tm_current;
+	double dt;
+	int x;
+	int x_start, x_end;
+
+	tm_current = frame_context.time - render_context.event->Start;
+	timing = 0;
+	s1 = s2 = 0;
+	for (i = 0; i <= text_info.length; ++i) {
+		cur = text_info.glyphs + i;
+		if ((i == text_info.length) || (cur->effect_type != EF_NONE)) {
+			s1 = s2;
+			s2 = cur;
+			if (s1) {
+				e1 = s2 - 1;
+				tm_start = timing + s1->effect_skip_timing;
+				tm_end = tm_start + s1->effect_timing;
+				timing = tm_end;
+				x_start = 1000000;
+				x_end = -1000000;
+				for (cur2 = s1; cur2 <= e1; ++cur2) {
+					x_start = FFMIN(x_start, cur2->bbox.xMin + cur2->pos.x);
+					x_end = FFMAX(x_end, cur2->bbox.xMax + cur2->pos.x);
+				}
+
+				dt = (tm_current - tm_start);
+				if ((s1->effect_type == EF_KARAOKE) || (s1->effect_type == EF_KARAOKE_KO)) {
+					if (dt > 0)
+						x = x_end + 1;
+					else
+						x = x_start;
+				} else if (s1->effect_type == EF_KARAOKE_KF) {
+					dt /= (tm_end - tm_start);
+					x = x_start + (x_end - x_start) * dt;
+				} else {
+					mp_msg(MSGT_ASS, MSGL_ERR, MSGTR_LIBASS_UnknownEffectType_InternalError);
+					continue;
+				}
+
+				for (cur2 = s1; cur2 <= e1; ++cur2) {
+					cur2->effect_type = s1->effect_type;
+					cur2->effect_timing = x - cur2->pos.x;
+				}
+			}
+		}
+	}
+}
+
+/**
+ * \brief Calculate base point for positioning and rotation
+ * \param bbox text bbox
+ * \param alignment alignment
+ * \param bx, by out: base point coordinates
+ */
+static void get_base_point(FT_BBox bbox, int alignment, int* bx, int* by)
+{
+	const int halign = alignment & 3;
+	const int valign = alignment & 12;
+	if (bx)
+		switch(halign) {
+		case HALIGN_LEFT:
+			*bx = bbox.xMin;
+			break;
+		case HALIGN_CENTER:
+			*bx = (bbox.xMax + bbox.xMin) / 2;
+			break;
+		case HALIGN_RIGHT:
+			*bx = bbox.xMax;
+			break;
+		}
+	if (by)
+		switch(valign) {
+		case VALIGN_TOP:
+			*by = bbox.yMin;
+			break;
+		case VALIGN_CENTER:
+			*by = (bbox.yMax + bbox.yMin) / 2;
+			break;
+		case VALIGN_SUB:
+			*by = bbox.yMax;
+			break;
+		}
+}
+
+/**
+ * \brief Multiply 4-vector by 4-matrix
+ * \param a 4-vector
+ * \param m 4-matrix]
+ * \param b out: 4-vector
+ * Calculates a * m and stores result in b
+ */
+static inline void transform_point_3d(double *a, double *m, double *b)
+{
+	b[0] = a[0] * m[0] + a[1] * m[4] + a[2] * m[8] +  a[3] * m[12];
+	b[1] = a[0] * m[1] + a[1] * m[5] + a[2] * m[9] +  a[3] * m[13];
+	b[2] = a[0] * m[2] + a[1] * m[6] + a[2] * m[10] + a[3] * m[14];
+	b[3] = a[0] * m[3] + a[1] * m[7] + a[2] * m[11] + a[3] * m[15];
+}
+
+/**
+ * \brief Apply 3d transformation to a vector
+ * \param v FreeType vector (2d)
+ * \param m 4-matrix
+ * Transforms v by m, projects the result back to the screen plane
+ * Result is returned in v.
+ */
+static inline void transform_vector_3d(FT_Vector* v, double *m) {
+	const double camera = 2500 * frame_context.border_scale; // camera distance
+	double a[4], b[4];
+	a[0] = d6_to_double(v->x);
+	a[1] = d6_to_double(v->y);
+	a[2] = 0.;
+	a[3] = 1.;
+	transform_point_3d(a, m, b);
+	/* Apply perspective projection with the following matrix:
+	   2500     0     0     0
+	      0  2500     0     0
+	      0     0     0     0
+	      0     0     8     2500
+	   where 2500 is camera distance, 8 - z-axis scale.
+	   Camera is always located in (org_x, org_y, -2500). This means
+	   that different subtitle events can be displayed at the same time
+	   using different cameras. */
+	b[0] *= camera;
+	b[1] *= camera;
+	b[3] = 8 * b[2] + camera;
+	if (b[3] < 0.001 && b[3] > -0.001)
+		b[3] = b[3] < 0. ? -0.001 : 0.001;
+	v->x = double_to_d6(b[0] / b[3]);
+	v->y = double_to_d6(b[1] / b[3]);
+}
+
+/**
+ * \brief Apply 3d transformation to a glyph
+ * \param glyph FreeType glyph
+ * \param m 4-matrix
+ * Transforms glyph by m, projects the result back to the screen plane
+ * Result is returned in glyph.
+ */
+static inline void transform_glyph_3d(FT_Glyph glyph, double *m, FT_Vector shift) {
+	int i;
+	FT_Outline* outline = &((FT_OutlineGlyph)glyph)->outline;
+	FT_Vector* p = outline->points;
+
+	for (i=0; i<outline->n_points; i++) {
+		p[i].x += shift.x;
+		p[i].y += shift.y;
+		transform_vector_3d(p + i, m);
+		p[i].x -= shift.x;
+		p[i].y -= shift.y;
+	}
+
+	//transform_vector_3d(&glyph->advance, m);
+}
+
+/**
+ * \brief Apply 3d transformation to several objects
+ * \param shift FreeType vector
+ * \param glyph FreeType glyph
+ * \param glyph2 FreeType glyph
+ * \param frx x-axis rotation angle
+ * \param fry y-axis rotation angle
+ * \param frz z-axis rotation angle
+ * Rotates both glyphs by frx, fry and frz. Shift vector is added before rotation and subtracted after it.
+ */
+static void transform_3d(FT_Vector shift, FT_Glyph* glyph, FT_Glyph* glyph2, double frx, double fry, double frz)
+{
+	fry = - fry; // FreeType's y axis goes in the opposite direction
+	if (frx != 0. || fry != 0. || frz != 0.) {
+		double m[16];
+		double sx = sin(frx);
+		double sy = sin(fry);
+ 		double sz = sin(frz);
+		double cx = cos(frx);
+		double cy = cos(fry);
+		double cz = cos(frz);
+		m[0] = cy * cz;            m[1] = cy*sz;              m[2]  = -sy;    m[3] = 0.0;
+		m[4] = -cx*sz + sx*sy*cz;  m[5] = cx*cz + sx*sy*sz;   m[6]  = sx*cy;  m[7] = 0.0;
+		m[8] = sx*sz + cx*sy*cz;   m[9] = -sx*cz + cx*sy*sz;  m[10] = cx*cy;  m[11] = 0.0;
+		m[12] = 0.0;               m[13] = 0.0;               m[14] = 0.0;    m[15] = 1.0;
+
+		if (glyph && *glyph)
+			transform_glyph_3d(*glyph, m, shift);
+
+		if (glyph2 && *glyph2)
+			transform_glyph_3d(*glyph2, m, shift);
+	}
+}
+
+/**
+ * \brief Main ass rendering function, glues everything together
+ * \param event event to render
+ * Process event, appending resulting ass_image_t's to images_root.
+ */
+static int ass_render_event(ass_event_t* event, event_images_t* event_images)
+{
+	char* p;
+	FT_UInt previous; 
+	FT_UInt num_glyphs;
+	FT_Vector pen;
+	unsigned code;
+	FT_BBox bbox;
+	int i, j;
+	FT_Vector shift;
+	int MarginL, MarginR, MarginV;
+	int last_break;
+	int alignment, halign, valign;
+	int device_x = 0, device_y = 0;
+
+	if (event->Style >= frame_context.track->n_styles) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NoStyleFound);
+		return 1;
+	}
+	if (!event->Text) {
+		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_EmptyEvent);
+		return 1;
+	}
+
+	init_render_context(event);
+
+	text_info.length = 0;
+	pen.x = 0;
+	pen.y = 0;
+	previous = 0;
+	num_glyphs = 0;
+	p = event->Text;
+	// Event parsing.
+	while (1) {
+		// get next char, executing style override
+		// this affects render_context
+		code = get_next_char(&p);
+		
+		// face could have been changed in get_next_char
+		if (!render_context.font) {
+			free_render_context();
+			return 1;
+		}
+
+		if (code == 0)
+			break;
+
+		if (text_info.length >= MAX_GLYPHS) {
+			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_MAX_GLYPHS_Reached, 
+					(int)(event - frame_context.track->events), event->Start, event->Duration, event->Text);
+			break;
+		}
+
+		if ( previous && code ) {
+			FT_Vector delta;
+			delta = ass_font_get_kerning(render_context.font, previous, code);
+			pen.x += delta.x * render_context.scale_x;
+			pen.y += delta.y * render_context.scale_y;
+		}
+
+		shift.x = pen.x & 63;
+		shift.y = pen.y & 63;
+
+		ass_font_set_transform(render_context.font,
+				       render_context.scale_x * frame_context.font_scale_x,
+				       render_context.scale_y,
+				       &shift );
+
+		get_outline_glyph(code, text_info.glyphs + text_info.length, &shift);
+		
+		text_info.glyphs[text_info.length].pos.x = pen.x >> 6;
+		text_info.glyphs[text_info.length].pos.y = pen.y >> 6;
+		
+		pen.x += text_info.glyphs[text_info.length].advance.x;
+		pen.x += double_to_d6(render_context.hspacing);
+		pen.y += text_info.glyphs[text_info.length].advance.y;
+		
+		previous = code;
+
+		text_info.glyphs[text_info.length].symbol = code;
+		text_info.glyphs[text_info.length].linebreak = 0;
+		for (i = 0; i < 4; ++i) {
+			uint32_t clr = render_context.c[i];
+			change_alpha(&clr, mult_alpha(_a(clr), render_context.fade), 1.);
+			text_info.glyphs[text_info.length].c[i] = clr;
+		}
+		text_info.glyphs[text_info.length].effect_type = render_context.effect_type;
+		text_info.glyphs[text_info.length].effect_timing = render_context.effect_timing;
+		text_info.glyphs[text_info.length].effect_skip_timing = render_context.effect_skip_timing;
+		text_info.glyphs[text_info.length].be = render_context.be;
+		text_info.glyphs[text_info.length].shadow = render_context.shadow;
+		text_info.glyphs[text_info.length].frx = render_context.frx;
+		text_info.glyphs[text_info.length].fry = render_context.fry;
+		text_info.glyphs[text_info.length].frz = render_context.frz;
+		ass_font_get_asc_desc(render_context.font, code,
+				      &text_info.glyphs[text_info.length].asc,
+				      &text_info.glyphs[text_info.length].desc);
+		text_info.glyphs[text_info.length].asc *= render_context.scale_y;
+		text_info.glyphs[text_info.length].desc *= render_context.scale_y;
+
+		// fill bitmap_hash_key
+		text_info.glyphs[text_info.length].hash_key.font = render_context.font;
+		text_info.glyphs[text_info.length].hash_key.size = render_context.font_size;
+		text_info.glyphs[text_info.length].hash_key.outline = render_context.border * 0xFFFF;
+		text_info.glyphs[text_info.length].hash_key.scale_x = render_context.scale_x * 0xFFFF;
+		text_info.glyphs[text_info.length].hash_key.scale_y = render_context.scale_y * 0xFFFF;
+		text_info.glyphs[text_info.length].hash_key.frx = render_context.frx * 0xFFFF;
+		text_info.glyphs[text_info.length].hash_key.fry = render_context.fry * 0xFFFF;
+		text_info.glyphs[text_info.length].hash_key.frz = render_context.frz * 0xFFFF;
+		text_info.glyphs[text_info.length].hash_key.bold = render_context.bold;
+		text_info.glyphs[text_info.length].hash_key.italic = render_context.italic;
+		text_info.glyphs[text_info.length].hash_key.ch = code;
+		text_info.glyphs[text_info.length].hash_key.advance = shift;
+		text_info.glyphs[text_info.length].hash_key.be = render_context.be;
+
+		text_info.length++;
+
+		render_context.effect_type = EF_NONE;
+		render_context.effect_timing = 0;
+		render_context.effect_skip_timing = 0;
+	}
+	
+	if (text_info.length == 0) {
+		// no valid symbols in the event; this can be smth like {comment}
+		free_render_context();
+		return 1;
+	}
+	
+	// depends on glyph x coordinates being monotonous, so it should be done before line wrap
+	process_karaoke_effects();
+	
+	// alignments
+	alignment = render_context.alignment;
+	halign = alignment & 3;
+	valign = alignment & 12;
+
+	MarginL = (event->MarginL) ? event->MarginL : render_context.style->MarginL; 
+	MarginR = (event->MarginR) ? event->MarginR : render_context.style->MarginR; 
+	MarginV = (event->MarginV) ? event->MarginV : render_context.style->MarginV;
+
+	if (render_context.evt_type != EVENT_HSCROLL) {
+		int max_text_width;
+
+		// calculate max length of a line
+		max_text_width = x2scr(frame_context.track->PlayResX - MarginR) - x2scr(MarginL);
+
+		// rearrange text in several lines
+		wrap_lines_smart(max_text_width);
+
+		// align text
+		last_break = -1;
+		for (i = 1; i < text_info.length + 1; ++i) { // (text_info.length + 1) is the end of the last line
+			if ((i == text_info.length) || text_info.glyphs[i].linebreak) {
+				int width, shift = 0;
+				glyph_info_t* first_glyph = text_info.glyphs + last_break + 1;
+				glyph_info_t* last_glyph = text_info.glyphs + i - 1;
+
+				while ((last_glyph > first_glyph) && ((last_glyph->symbol == '\n') || (last_glyph->symbol == 0)))
+					last_glyph --;
+
+				width = last_glyph->pos.x + d6_to_int(last_glyph->advance.x) - first_glyph->pos.x;
+				if (halign == HALIGN_LEFT) { // left aligned, no action
+					shift = 0;
+				} else if (halign == HALIGN_RIGHT) { // right aligned
+					shift = max_text_width - width;
+				} else if (halign == HALIGN_CENTER) { // centered
+					shift = (max_text_width - width) / 2;
+				}
+				for (j = last_break + 1; j < i; ++j) {
+					text_info.glyphs[j].pos.x += shift;
+				}
+				last_break = i - 1;
+			}
+		}
+	} else { // render_context.evt_type == EVENT_HSCROLL
+		measure_text();
+	}
+	
+	// determing text bounding box
+	compute_string_bbox(&text_info, &bbox);
+	
+	// determine device coordinates for text
+	
+	// x coordinate for everything except positioned events
+	if (render_context.evt_type == EVENT_NORMAL ||
+	    render_context.evt_type == EVENT_VSCROLL) {
+		device_x = x2scr(MarginL);
+	} else if (render_context.evt_type == EVENT_HSCROLL) {
+		if (render_context.scroll_direction == SCROLL_RL)
+			device_x = x2scr(frame_context.track->PlayResX - render_context.scroll_shift);
+		else if (render_context.scroll_direction == SCROLL_LR)
+			device_x = x2scr(render_context.scroll_shift) - (bbox.xMax - bbox.xMin);
+	}
+
+	// y coordinate for everything except positioned events
+	if (render_context.evt_type == EVENT_NORMAL ||
+	    render_context.evt_type == EVENT_HSCROLL) {
+		if (valign == VALIGN_TOP) { // toptitle
+			device_y = y2scr_top(MarginV) + d6_to_int(text_info.lines[0].asc);
+		} else if (valign == VALIGN_CENTER) { // midtitle
+			int scr_y = y2scr(frame_context.track->PlayResY / 2);
+			device_y = scr_y - (bbox.yMax - bbox.yMin) / 2;
+		} else { // subtitle
+			int scr_y;
+			if (valign != VALIGN_SUB)
+				mp_msg(MSGT_ASS, MSGL_V, "Invalid valign, supposing 0 (subtitle)\n");
+			scr_y = y2scr_sub(frame_context.track->PlayResY - MarginV);
+			device_y = scr_y;
+			device_y -= d6_to_int(text_info.height);
+			device_y += d6_to_int(text_info.lines[0].asc);
+		}
+	} else if (render_context.evt_type == EVENT_VSCROLL) {
+		if (render_context.scroll_direction == SCROLL_TB)
+			device_y = y2scr(render_context.clip_y0 + render_context.scroll_shift) - (bbox.yMax - bbox.yMin);
+		else if (render_context.scroll_direction == SCROLL_BT)
+			device_y = y2scr(render_context.clip_y1 - render_context.scroll_shift);
+	}
+
+	// positioned events are totally different
+	if (render_context.evt_type == EVENT_POSITIONED) {
+		int base_x = 0;
+		int base_y = 0;
+		mp_msg(MSGT_ASS, MSGL_DBG2, "positioned event at %d, %d\n", render_context.pos_x, render_context.pos_y);
+		get_base_point(bbox, alignment, &base_x, &base_y);
+		device_x = x2scr(render_context.pos_x) - base_x;
+		device_y = y2scr(render_context.pos_y) - base_y;
+	}
+	
+	// fix clip coordinates (they depend on alignment)
+	render_context.clip_x0 = x2scr(render_context.clip_x0);
+	render_context.clip_x1 = x2scr(render_context.clip_x1);
+	if (render_context.evt_type == EVENT_NORMAL ||
+	    render_context.evt_type == EVENT_HSCROLL ||
+	    render_context.evt_type == EVENT_VSCROLL) {
+		if (valign == VALIGN_TOP) {
+			render_context.clip_y0 = y2scr_top(render_context.clip_y0);
+			render_context.clip_y1 = y2scr_top(render_context.clip_y1);
+		} else if (valign == VALIGN_CENTER) {
+			render_context.clip_y0 = y2scr(render_context.clip_y0);
+			render_context.clip_y1 = y2scr(render_context.clip_y1);
+		} else if (valign == VALIGN_SUB) {
+			render_context.clip_y0 = y2scr_sub(render_context.clip_y0);
+			render_context.clip_y1 = y2scr_sub(render_context.clip_y1);
+		}
+	} else if (render_context.evt_type == EVENT_POSITIONED) {
+		render_context.clip_y0 = y2scr(render_context.clip_y0);
+		render_context.clip_y1 = y2scr(render_context.clip_y1);
+	}
+
+	// calculate rotation parameters
+	{
+		FT_Vector center;
+		
+		if (render_context.have_origin) {
+			center.x = x2scr(render_context.org_x);
+			center.y = y2scr(render_context.org_y);
+		} else {
+			int bx, by;
+			get_base_point(bbox, alignment, &bx, &by);
+			center.x = device_x + bx;
+			center.y = device_y + by;
+		}
+
+		for (i = 0; i < text_info.length; ++i) {
+			glyph_info_t* info = text_info.glyphs + i;
+
+			if (info->hash_key.frx || info->hash_key.fry || info->hash_key.frz) {
+				info->hash_key.shift_x = info->pos.x + device_x - center.x;
+				info->hash_key.shift_y = - (info->pos.y + device_y - center.y);
+			} else {
+				info->hash_key.shift_x = 0;
+				info->hash_key.shift_y = 0;
+			}
+		}
+	}
+
+	// convert glyphs to bitmaps
+	for (i = 0; i < text_info.length; ++i)
+		get_bitmap_glyph(text_info.glyphs + i);
+
+	event_images->top = device_y - d6_to_int(text_info.lines[0].asc);
+	event_images->height = d6_to_int(text_info.height);
+	event_images->detect_collisions = render_context.detect_collisions;
+	event_images->shift_direction = (valign == VALIGN_TOP) ? 1 : -1;
+	event_images->event = event;
+	event_images->imgs = render_text(&text_info, device_x, device_y);
+
+	free_render_context();
+	
+	return 0;
+}
+
+/**
+ * \brief deallocate image list
+ * \param img list pointer
+ */
+void ass_free_images(ass_image_t* img)
+{
+	while (img) {
+		ass_image_t* next = img->next;
+		free(img);
+		img = next;
+	}
+}
+
+static void ass_reconfigure(ass_renderer_t* priv)
+{
+	priv->render_id = ++last_render_id;
+	ass_glyph_cache_reset();
+	ass_bitmap_cache_reset();
+	ass_free_images(priv->prev_images_root);
+	priv->prev_images_root = 0;
+}
+
+void ass_set_frame_size(ass_renderer_t* priv, int w, int h)
+{
+	if (priv->settings.frame_width != w || priv->settings.frame_height != h) {
+		priv->settings.frame_width = w;
+		priv->settings.frame_height = h;
+		if (priv->settings.aspect == 0.)
+			priv->settings.aspect = ((double)w) / h;
+		ass_reconfigure(priv);
+	}
+}
+
+void ass_set_margins(ass_renderer_t* priv, int t, int b, int l, int r)
+{
+	if (priv->settings.left_margin != l ||
+	    priv->settings.right_margin != r ||
+	    priv->settings.top_margin != t ||
+	    priv->settings.bottom_margin != b) {
+		priv->settings.left_margin = l;
+		priv->settings.right_margin = r;
+		priv->settings.top_margin = t;
+		priv->settings.bottom_margin = b;
+		ass_reconfigure(priv);
+	}
+}
+
+void ass_set_use_margins(ass_renderer_t* priv, int use)
+{
+	priv->settings.use_margins = use;
+}
+
+void ass_set_aspect_ratio(ass_renderer_t* priv, double ar)
+{
+	if (priv->settings.aspect != ar) {
+		priv->settings.aspect = ar;
+		ass_reconfigure(priv);
+	}
+}
+
+void ass_set_font_scale(ass_renderer_t* priv, double font_scale)
+{
+	if (priv->settings.font_size_coeff != font_scale) {
+		priv->settings.font_size_coeff = font_scale;
+		ass_reconfigure(priv);
+	}
+}
+
+void ass_set_hinting(ass_renderer_t* priv, ass_hinting_t ht)
+{
+	if (priv->settings.hinting != ht) {
+		priv->settings.hinting = ht;
+		ass_reconfigure(priv);
+	}
+}
+
+void ass_set_line_spacing(ass_renderer_t* priv, double line_spacing)
+{
+	priv->settings.line_spacing = line_spacing;
+}
+
+int ass_set_fonts(ass_renderer_t* priv, const char* default_font, const char* default_family)
+{
+	if (priv->settings.default_font)
+		free(priv->settings.default_font);
+	if (priv->settings.default_family)
+		free(priv->settings.default_family);
+
+	priv->settings.default_font = default_font ? strdup(default_font) : 0;
+	priv->settings.default_family = default_family ? strdup(default_family) : 0;
+
+	if (priv->fontconfig_priv)
+		fontconfig_done(priv->fontconfig_priv);
+	priv->fontconfig_priv = fontconfig_init(priv->library, priv->ftlibrary, default_family, default_font);
+
+	return !!priv->fontconfig_priv;
+}
+
+/**
+ * \brief Start a new frame
+ */
+static int ass_start_frame(ass_renderer_t *priv, ass_track_t* track, long long now)
+{
+	ass_renderer = priv;
+	global_settings = &priv->settings;
+
+	if (!priv->settings.frame_width && !priv->settings.frame_height)
+		return 1; // library not initialized
+	
+	frame_context.ass_priv = priv;
+	frame_context.width = global_settings->frame_width;
+	frame_context.height = global_settings->frame_height;
+	frame_context.orig_width = global_settings->frame_width - global_settings->left_margin - global_settings->right_margin;
+	frame_context.orig_height = global_settings->frame_height - global_settings->top_margin - global_settings->bottom_margin;
+	frame_context.track = track;
+	frame_context.time = now;
+
+	ass_lazy_track_init();
+	
+	frame_context.font_scale = global_settings->font_size_coeff *
+	                           frame_context.orig_height / frame_context.track->PlayResY;
+	frame_context.border_scale = ((double)frame_context.orig_height) / frame_context.track->PlayResY;
+
+	if (frame_context.orig_width * track->PlayResY == frame_context.orig_height * track->PlayResX)
+		frame_context.font_scale_x = 1.;
+	else
+		frame_context.font_scale_x = ((double)(frame_context.orig_width * track->PlayResY)) / (frame_context.orig_height * track->PlayResX);
+
+	priv->prev_images_root = priv->images_root;
+	priv->images_root = 0;
+
+	return 0;
+}
+
+static int cmp_event_layer(const void* p1, const void* p2)
+{
+	ass_event_t* e1 = ((event_images_t*)p1)->event;
+	ass_event_t* e2 = ((event_images_t*)p2)->event;
+	if (e1->Layer < e2->Layer)
+		return -1;
+	if (e1->Layer > e2->Layer)
+		return 1;
+	if (e1->ReadOrder < e2->ReadOrder)
+		return -1;
+	if (e1->ReadOrder > e2->ReadOrder)
+		return 1;
+	return 0;
+}
+
+#define MAX_EVENTS 100
+
+static render_priv_t* get_render_priv(ass_event_t* event)
+{
+	if (!event->render_priv)
+		event->render_priv = calloc(1, sizeof(render_priv_t));
+	// FIXME: check render_id
+	if (ass_renderer->render_id != event->render_priv->render_id) {
+		memset(event->render_priv, 0, sizeof(render_priv_t));
+		event->render_priv->render_id = ass_renderer->render_id;
+	}
+	return event->render_priv;
+}
+
+typedef struct segment_s {
+	int a, b; // top and height
+} segment_t;
+
+static int overlap(segment_t* s1, segment_t* s2)
+{
+	if (s1->a >= s2->b || s2->a >= s1->b)
+		return 0;
+	return 1;
+}
+
+static int cmp_segment(const void* p1, const void* p2)
+{
+	return ((segment_t*)p1)->a - ((segment_t*)p2)->a;
+}
+
+static void shift_event(event_images_t* ei, int shift)
+{
+	ass_image_t* cur = ei->imgs;
+	while (cur) {
+		cur->dst_y += shift;
+		// clip top and bottom
+		if (cur->dst_y < 0) {
+			int clip = - cur->dst_y;
+			cur->h -= clip;
+			cur->bitmap += clip * cur->stride;
+			cur->dst_y = 0;
+		}
+		if (cur->dst_y + cur->h >= frame_context.height) {
+			int clip = cur->dst_y + cur->h - frame_context.height;
+			cur->h -= clip;
+		}
+		if (cur->h <= 0) {
+			cur->h = 0;
+			cur->dst_y = 0;
+		}
+		cur = cur->next;
+	}
+	ei->top += shift;
+}
+
+// dir: 1 - move down
+//      -1 - move up
+static int fit_segment(segment_t* s, segment_t* fixed, int* cnt, int dir)
+{
+	int i;
+	int shift = 0;
+
+	if (dir == 1) // move down
+		for (i = 0; i < *cnt; ++i) {
+			if (s->b + shift <= fixed[i].a || s->a + shift >= fixed[i].b)
+				continue;
+			shift = fixed[i].b - s->a;
+		}
+	else // dir == -1, move up
+		for (i = *cnt-1; i >= 0; --i) {
+			if (s->b + shift <= fixed[i].a || s->a + shift >= fixed[i].b)
+				continue;
+			shift = fixed[i].a - s->b;
+		}
+
+	fixed[*cnt].a = s->a + shift;
+	fixed[*cnt].b = s->b + shift;
+	(*cnt)++;
+	qsort(fixed, *cnt, sizeof(segment_t), cmp_segment);
+	
+	return shift;
+}
+
+static void fix_collisions(event_images_t* imgs, int cnt)
+{
+	segment_t used[MAX_EVENTS];
+	int cnt_used = 0;
+	int i, j;
+
+	// fill used[] with fixed events
+	for (i = 0; i < cnt; ++i) {
+		render_priv_t* priv;
+		if (!imgs[i].detect_collisions) continue;
+		priv = get_render_priv(imgs[i].event);
+		if (priv->height > 0) { // it's a fixed event
+			segment_t s;
+			s.a = priv->top;
+			s.b = priv->top + priv->height;
+			if (priv->height != imgs[i].height) { // no, it's not
+				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_EventHeightHasChanged);
+				priv->top = 0;
+				priv->height = 0;
+			}
+			for (j = 0; j < cnt_used; ++j)
+				if (overlap(&s, used + j)) { // no, it's not
+					priv->top = 0;
+					priv->height = 0;
+				}
+			if (priv->height > 0) { // still a fixed event
+				used[cnt_used].a = priv->top;
+				used[cnt_used].b = priv->top + priv->height;
+				cnt_used ++;
+				shift_event(imgs + i, priv->top - imgs[i].top);
+			}
+		}
+	}
+	qsort(used, cnt_used, sizeof(segment_t), cmp_segment);
+
+	// try to fit other events in free spaces
+	for (i = 0; i < cnt; ++i) {
+		render_priv_t* priv;
+		if (!imgs[i].detect_collisions) continue;
+		priv = get_render_priv(imgs[i].event);
+		if (priv->height == 0) { // not a fixed event
+			int shift;
+			segment_t s;
+			s.a = imgs[i].top;
+			s.b = imgs[i].top + imgs[i].height;
+			shift = fit_segment(&s, used, &cnt_used, imgs[i].shift_direction);
+			if (shift) shift_event(imgs + i, shift);
+			// make it fixed
+			priv->top = imgs[i].top;
+			priv->height = imgs[i].height;
+		}
+		
+	}
+}
+
+/**
+ * \brief compare two images
+ * \param i1 first image
+ * \param i2 second image
+ * \return 0 if identical, 1 if different positions, 2 if different content
+ */
+int ass_image_compare(ass_image_t *i1, ass_image_t *i2)
+{
+	if (i1->w != i2->w) return 2;
+	if (i1->h != i2->h) return 2;
+	if (i1->stride != i2->stride) return 2;
+	if (i1->color != i2->color) return 2;
+	if (i1->bitmap != i2->bitmap)
+		return 2;
+	if (i1->dst_x != i2->dst_x) return 1;
+	if (i1->dst_y != i2->dst_y) return 1;
+	return 0;
+}
+
+/**
+ * \brief compare current and previous image list
+ * \param priv library handle
+ * \return 0 if identical, 1 if different positions, 2 if different content
+ */
+int ass_detect_change(ass_renderer_t *priv)
+{
+	ass_image_t* img, *img2;
+	int diff;
+
+	img = priv->prev_images_root;
+	img2 = priv->images_root;
+	diff = 0;
+	while (img && diff < 2) {
+		ass_image_t* next, *next2;
+		next = img->next;
+		if (img2) {
+			int d = ass_image_compare(img, img2);
+			if (d > diff) diff = d;
+			next2 = img2->next;
+		} else {
+			// previous list is shorter
+			diff = 2;
+			break;
+		}
+		img = next;
+		img2 = next2;
+	}
+
+	// is the previous list longer?
+	if (img2)
+		diff = 2;
+
+	return diff;
+}
+
+/**
+ * \brief render a frame
+ * \param priv library handle
+ * \param track track
+ * \param now current video timestamp (ms)
+ * \param detect_change a value describing how the new images differ from the previous ones will be written here:
+ *        0 if identical, 1 if different positions, 2 if different content.
+ *        Can be NULL, in that case no detection is performed.
+ */
+ass_image_t* ass_render_frame(ass_renderer_t *priv, ass_track_t* track, long long now, int* detect_change)
+{
+	int i, cnt, rc;
+	event_images_t* last;
+	ass_image_t** tail;
+	
+	// init frame
+	rc = ass_start_frame(priv, track, now);
+	if (rc != 0)
+		return 0;
+
+	// render events separately
+	cnt = 0;
+	for (i = 0; i < track->n_events; ++i) {
+		ass_event_t* event = track->events + i;
+		if ( (event->Start <= now) && (now < (event->Start + event->Duration)) ) {
+			if (cnt >= priv->eimg_size) {
+				priv->eimg_size += 100;
+				priv->eimg = realloc(priv->eimg, priv->eimg_size * sizeof(event_images_t));
+			}
+			rc = ass_render_event(event, priv->eimg + cnt);
+			if (!rc) ++cnt;
+		}
+	}
+
+	// sort by layer
+	qsort(priv->eimg, cnt, sizeof(event_images_t), cmp_event_layer);
+
+	// call fix_collisions for each group of events with the same layer
+	last = priv->eimg;
+	for (i = 1; i < cnt; ++i)
+		if (last->event->Layer != priv->eimg[i].event->Layer) {
+			fix_collisions(last, priv->eimg + i - last);
+			last = priv->eimg + i;
+		}
+	if (cnt > 0)
+		fix_collisions(last, priv->eimg + cnt - last);
+
+	// concat lists
+	tail = &ass_renderer->images_root;
+	for (i = 0; i < cnt; ++i) {
+		ass_image_t* cur = priv->eimg[i].imgs;
+		while (cur) {
+			*tail = cur;
+			tail = &cur->next;
+			cur = cur->next;
+		}
+	}
+
+	if (detect_change)
+		*detect_change = ass_detect_change(priv);
+	
+	// free the previous image list
+	ass_free_images(priv->prev_images_root);
+	priv->prev_images_root = 0;
+
+	return ass_renderer->images_root;
+}
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_types.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_types.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_types.h	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,114 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+#ifndef ASS_TYPES_H
+#define ASS_TYPES_H
+
+#define VALIGN_SUB 0
+#define VALIGN_CENTER 8
+#define VALIGN_TOP 4
+#define HALIGN_LEFT 1
+#define HALIGN_CENTER 2
+#define HALIGN_RIGHT 3
+
+/// ass Style: line
+typedef struct ass_style_s {
+	char* Name;
+	char* FontName;
+	double FontSize;
+	uint32_t PrimaryColour;
+	uint32_t SecondaryColour;
+	uint32_t OutlineColour;
+	uint32_t BackColour;
+	int Bold;
+	int Italic;
+	int Underline;
+	int StrikeOut;
+	double ScaleX;
+	double ScaleY;
+	double Spacing;
+	int Angle;
+	int BorderStyle;
+	double Outline;
+	double Shadow;
+	int Alignment;
+	int MarginL;
+	int MarginR;
+	int MarginV;
+//        int AlphaLevel;
+	int Encoding;
+} ass_style_t;
+
+typedef struct render_priv_s render_priv_t;
+
+/// ass_event_t corresponds to a single Dialogue line
+/// Text is stored as-is, style overrides will be parsed later
+typedef struct ass_event_s {
+	long long Start; // ms
+	long long Duration; // ms
+
+	int ReadOrder;
+	int Layer;
+	int Style;
+	char* Name;
+	int MarginL;
+	int MarginR;
+	int MarginV;
+	char* Effect;
+	char* Text;
+
+	render_priv_t* render_priv;
+} ass_event_t;
+
+typedef struct parser_priv_s parser_priv_t;
+
+typedef struct ass_library_s ass_library_t;
+
+/// ass track represent either an external script or a matroska subtitle stream (no real difference between them)
+/// it can be used in rendering after the headers are parsed (i.e. events format line read)
+typedef struct ass_track_s {
+	int n_styles; // amount used
+	int max_styles; // amount allocated
+	int n_events;
+	int max_events;
+	ass_style_t* styles; // array of styles, max_styles length, n_styles used
+	ass_event_t* events; // the same as styles
+
+	char* style_format; // style format line (everything after "Format: ")
+	char* event_format; // event format line
+
+	enum {TRACK_TYPE_UNKNOWN = 0, TRACK_TYPE_ASS, TRACK_TYPE_SSA} track_type;
+	
+	// script header fields
+	int PlayResX;
+	int PlayResY;
+	double Timer;
+	int WrapStyle;
+
+	
+	int default_style; // index of default style
+	char* name; // file name in case of external subs, 0 for streams
+
+	ass_library_t* library;
+	parser_priv_t* parser_priv;
+} ass_track_t;
+
+#endif
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.c	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,81 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+//#include "config.h"
+
+#include <stdlib.h>
+#include <inttypes.h>
+
+#include "mputils.h"
+#include "ass_utils.h"
+
+int mystrtoi(char** p, int base, int* res)
+{
+	char* start = *p;
+	*res = strtol(*p, p, base);
+	if (*p != start) return 1;
+	else return 0;
+}
+
+int mystrtou32(char** p, int base, uint32_t* res)
+{
+	char* start = *p;
+	*res = strtoll(*p, p, base);
+	if (*p != start) return 1;
+	else return 0;
+}
+
+int mystrtod(char** p, double* res)
+{
+	char* start = *p;
+	*res = strtod(*p, p);
+	if (*p != start) return 1;
+	else return 0;
+}
+
+int strtocolor(char** q, uint32_t* res)
+{
+	uint32_t color = 0;
+	int result;
+	char* p = *q;
+	
+	if (*p == '&') ++p; 
+	else mp_msg(MSGT_ASS, MSGL_DBG2, "suspicious color format: \"%s\"\n", p);
+	
+	if (*p == 'H' || *p == 'h') { 
+		++p;
+		result = mystrtou32(&p, 16, &color);
+	} else {
+		result = mystrtou32(&p, 0, &color);
+	}
+	
+	{
+		unsigned char* tmp = (unsigned char*)(&color);
+		unsigned char b;
+		b = tmp[0]; tmp[0] = tmp[3]; tmp[3] = b;
+		b = tmp[1]; tmp[1] = tmp[2]; tmp[2] = b;
+	}
+	if (*p == '&') ++p;
+	*q = p;
+
+	*res = color;
+	return result;
+}
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.h	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,61 @@
+// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
+// vim:ts=8:sw=8:noet:ai:
+/*
+  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
+*/
+
+#ifndef ASS_UTILS_H
+#define ASS_UTILS_H
+
+int mystrtoi(char** p, int base, int* res);
+int mystrtou32(char** p, int base, uint32_t* res);
+int mystrtod(char** p, double* res);
+int strtocolor(char** q, uint32_t* res);
+
+static inline int d6_to_int(int x) {
+	return (x + 32) >> 6;
+}
+static inline int d16_to_int(int x) {
+	return (x + 32768) >> 16;
+}
+static inline int int_to_d6(int x) {
+	return x << 6;
+}
+static inline int int_to_d16(int x) {
+	return x << 16;
+}
+static inline int d16_to_d6(int x) {
+	return (x + 512) >> 10;
+}
+static inline int d6_to_d16(int x) {
+	return x << 10;
+}
+static inline double d6_to_double(int x) {
+	return x / 64.;
+}
+static inline int double_to_d6(double x) {
+	return (int)(x * 64);
+}
+static inline double d16_to_double(int x) {
+	return ((double)x) / 0x10000;
+}
+static inline int double_to_d16(double x) {
+	return (int)(x * 0x10000);
+}
+
+#endif
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/help_mp.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/help_mp.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/help_mp.h	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,55 @@
+#ifndef __LIBASS_HELP_MP_H__
+#define __LIBASS_HELP_MP_H__
+#define MSGTR_LIBASS_FT_Glyph_To_BitmapError "[ass] FT_Glyph_To_Bitmap error %d \n"
+#define MSGTR_LIBASS_UnsupportedPixelMode "[ass] Unsupported pixel mode: %d\n"
+#define MSGTR_LIBASS_NoStyleNamedXFoundUsingY "[ass] [%p] Warning: no style named '%s' found, using '%s'\n"
+#define MSGTR_LIBASS_BadTimestamp "[ass] bad timestamp\n"
+#define MSGTR_LIBASS_BadEncodedDataSize "[ass] bad encoded data size\n"
+#define MSGTR_LIBASS_FontLineTooLong "[ass] Font line too long: %d, %s\n"
+#define MSGTR_LIBASS_EventFormatHeaderMissing "[ass] Event format header missing\n"
+#define MSGTR_LIBASS_ErrorOpeningIconvDescriptor "[ass] error opening iconv descriptor.\n"
+#define MSGTR_LIBASS_ErrorRecodingFile "[ass] error recoding file.\n"
+#define MSGTR_LIBASS_FopenFailed "[ass] ass_read_file(%s): fopen failed\n"
+#define MSGTR_LIBASS_FseekFailed "[ass] ass_read_file(%s): fseek failed\n"
+#define MSGTR_LIBASS_RefusingToLoadSubtitlesLargerThan10M "[ass] ass_read_file(%s): Refusing to load subtitles larger than 10M\n"
+#define MSGTR_LIBASS_ReadFailed "Read failed, %d: %s\n"
+#define MSGTR_LIBASS_AddedSubtitleFileMemory "[ass] Added subtitle file: <memory> (%d styles, %d events)\n"
+#define MSGTR_LIBASS_AddedSubtitleFileFname "[ass] Added subtitle file: %s (%d styles, %d events)\n"
+#define MSGTR_LIBASS_FailedToCreateDirectory "[ass] Failed to create directory %s\n"
+#define MSGTR_LIBASS_NotADirectory "[ass] Not a directory: %s\n"
+#define MSGTR_LIBASS_TooManyFonts "[ass] Too many fonts\n"
+#define MSGTR_LIBASS_ErrorOpeningFont "[ass] Error opening font: %s, %d\n"
+#define MSGTR_LIBASS_SelectedFontFamilyIsNotTheRequestedOne "[ass] fontconfig: Selected font family is not the requested one: '%s' != '%s'\n"
+#define MSGTR_LIBASS_UsingDefaultFontFamily "[ass] fontconfig_select: Using default font family: (%s, %d, %d) -> %s, %d\n"
+#define MSGTR_LIBASS_UsingDefaultFont "[ass] fontconfig_select: Using default font: (%s, %d, %d) -> %s, %d\n"
+#define MSGTR_LIBASS_UsingArialFontFamily "[ass] fontconfig_select: Using 'Arial' font family: (%s, %d, %d) -> %s, %d\n"
+#define MSGTR_LIBASS_FcInitLoadConfigAndFontsFailed "[ass] FcInitLoadConfigAndFonts failed.\n"
+#define MSGTR_LIBASS_UpdatingFontCache "[ass] Updating font cache.\n"
+#define MSGTR_LIBASS_BetaVersionsOfFontconfigAreNotSupported "[ass] Beta versions of fontconfig are not supported.\n[ass] Update before reporting any bugs.\n"
+#define MSGTR_LIBASS_FcStrSetAddFailed "[ass] FcStrSetAdd failed.\n"
+#define MSGTR_LIBASS_FcDirScanFailed "[ass] FcDirScan failed.\n"
+#define MSGTR_LIBASS_FcDirSave "[ass] FcDirSave failed.\n"
+#define MSGTR_LIBASS_FcConfigAppFontAddDirFailed "[ass] FcConfigAppFontAddDir failed\n"
+#define MSGTR_LIBASS_FontconfigDisabledDefaultFontWillBeUsed "[ass] Fontconfig disabled, only default font will be used.\n"
+#define MSGTR_LIBASS_FunctionCallFailed "[ass] %s failed\n"
+#define MSGTR_LIBASS_NeitherPlayResXNorPlayResYDefined "[ass] Neither PlayResX nor PlayResY defined. Assuming 384x288.\n"
+#define MSGTR_LIBASS_PlayResYUndefinedSettingY "[ass] PlayResY undefined, setting %d.\n"
+#define MSGTR_LIBASS_PlayResXUndefinedSettingX "[ass] PlayResX undefined, setting %d.\n"
+#define MSGTR_LIBASS_FT_Init_FreeTypeFailed "[ass] FT_Init_FreeType failed.\n"
+#define MSGTR_LIBASS_Init "[ass] Init\n"
+#define MSGTR_LIBASS_InitFailed "[ass] Init failed.\n"
+#define MSGTR_LIBASS_BadCommand "[ass] Bad command: %c%c\n"
+#define MSGTR_LIBASS_ErrorLoadingGlyph  "[ass] Error loading glyph.\n"
+#define MSGTR_LIBASS_FT_Glyph_Stroke_Error "[ass] FT_Glyph_Stroke error %d \n"
+#define MSGTR_LIBASS_UnknownEffectType_InternalError "[ass] Unknown effect type (internal error)\n"
+#define MSGTR_LIBASS_NoStyleFound "[ass] No style found!\n"
+#define MSGTR_LIBASS_EmptyEvent "[ass] Empty event!\n"
+#define MSGTR_LIBASS_MAX_GLYPHS_Reached "[ass] MAX_GLYPHS reached: event %d, start = %llu, duration = %llu\n Text = %s\n"
+#define MSGTR_LIBASS_EventHeightHasChanged "[ass] Warning! Event height has changed!  \n"
+#define MSGTR_LIBASS_GlyphNotFoundReselectingFont "[ass] Glyph 0x%X not found, reselecting font for (%s, %d, %d)\n"
+#define MSGTR_LIBASS_GlyphNotFound "[ass] Glyph 0x%X not found in font for (%s, %d, %d)\n"
+#define MSGTR_LIBASS_ErrorOpeningMemoryFont "[ass] Error opening memory font: %s\n"
+#define MSGTR_LIBASS_NoCharmaps "[ass] font face with no charmaps\n"
+#define MSGTR_LIBASS_NoCharmapAutodetected "[ass] no charmap autodetected, trying the first one\n"
+#endif
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.c	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,218 @@
+//#include "config.h"
+
+#include "mputils.h"
+
+#include <stdio.h>
+#include <stdarg.h>
+#include <stdint.h>
+#include <stdlib.h>
+#include <string.h>
+#include <assert.h>
+
+#ifdef HAVE_ENCA
+#include <enca.h>
+#endif
+
+void my_mp_msg(int lvl, char *lvl_str, char *fmt, ...) {
+	va_list va;
+	if(lvl > MSGL_V) return;
+	printf("[ass] **%s**: ", lvl_str);
+	va_start(va, fmt);
+	vprintf(fmt, va);
+	va_end(va);
+}
+
+unsigned utf8_get_char(char **str) {
+  uint8_t *strp = (uint8_t *)*str;
+  unsigned c = *strp++;
+  unsigned mask = 0x80;
+  int len = -1;
+  while (c & mask) {
+    mask >>= 1;
+    len++;
+  }
+  if (len <= 0 || len > 4)
+    goto no_utf8;
+  c &= mask - 1;
+  while ((*strp & 0xc0) == 0x80) {
+    if (len-- <= 0)
+      goto no_utf8;
+    c = (c << 6) | (*strp++ & 0x3f);
+  }
+  if (len)
+    goto no_utf8;
+  *str = (char *)strp;
+  return c;
+
+no_utf8:
+  strp = (uint8_t *)*str;
+  c = *strp++;
+  *str = (char *)strp;
+  return c;
+}
+
+// gaussian blur
+void blur(
+	unsigned char *buffer,
+	unsigned short *tmp2,
+	int width,
+	int height,
+	int stride,
+	int *m2,
+	int r,
+	int mwidth) {
+
+    int x, y;
+
+    unsigned char  *s = buffer;
+    unsigned short *t = tmp2+1;
+    for(y=0; y<height; y++){
+	memset(t-1, 0, (width+1)*sizeof(short));
+
+	for(x=0; x<r; x++){
+	    const int src= s[x];
+	    if(src){
+		register unsigned short *dstp= t + x-r;
+		int mx;
+		unsigned *m3= m2 + src*mwidth;
+		for(mx=r-x; mx<mwidth; mx++){
+		    dstp[mx]+= m3[mx];
+		}
+	    }
+	}
+
+	for(; x<width-r; x++){
+	    const int src= s[x];
+	    if(src){
+		register unsigned short *dstp= t + x-r;
+		int mx;
+		unsigned *m3= m2 + src*mwidth;
+		for(mx=0; mx<mwidth; mx++){
+		    dstp[mx]+= m3[mx];
+		}
+	    }
+	}
+
+	for(; x<width; x++){
+	    const int src= s[x];
+	    if(src){
+		register unsigned short *dstp= t + x-r;
+		int mx;
+		const int x2= r+width -x;
+		unsigned *m3= m2 + src*mwidth;
+		for(mx=0; mx<x2; mx++){
+		    dstp[mx]+= m3[mx];
+		}
+	    }
+	}
+
+	s+= stride;
+	t+= width + 1;
+    }
+
+    t = tmp2;
+    for(x=0; x<width; x++){
+	for(y=0; y<r; y++){
+	    unsigned short *srcp= t + y*(width+1) + 1;
+	    int src= *srcp;
+	    if(src){
+		register unsigned short *dstp= srcp - 1 + width+1;
+		const int src2= (src + 128)>>8;
+		unsigned *m3= m2 + src2*mwidth;
+
+		int mx;
+		*srcp= 128;
+		for(mx=r-1; mx<mwidth; mx++){
+		    *dstp += m3[mx];
+		    dstp+= width+1;
+		}
+	    }
+	}
+	for(; y<height-r; y++){
+	    unsigned short *srcp= t + y*(width+1) + 1;
+	    int src= *srcp;
+	    if(src){
+		register unsigned short *dstp= srcp - 1 - r*(width+1);
+		const int src2= (src + 128)>>8;
+		unsigned *m3= m2 + src2*mwidth;
+
+		int mx;
+		*srcp= 128;
+		for(mx=0; mx<mwidth; mx++){
+		    *dstp += m3[mx];
+		    dstp+= width+1;
+		}
+	    }
+	}
+	for(; y<height; y++){
+	    unsigned short *srcp= t + y*(width+1) + 1;
+	    int src= *srcp;
+	    if(src){
+		const int y2=r+height-y;
+		register unsigned short *dstp= srcp - 1 - r*(width+1);
+		const int src2= (src + 128)>>8;
+		unsigned *m3= m2 + src2*mwidth;
+
+		int mx;
+		*srcp= 128;
+		for(mx=0; mx<y2; mx++){
+		    *dstp += m3[mx];
+		    dstp+= width+1;
+		}
+	    }
+	}
+	t++;
+    }
+
+    t = tmp2;
+    s = buffer;
+    for(y=0; y<height; y++){
+	for(x=0; x<width; x++){
+	    s[x]= t[x]>>8;
+	}
+	s+= stride;
+	t+= width + 1;
+    }
+}
+
+#ifdef HAVE_ENCA
+void* guess_buffer_cp(unsigned char* buffer, int buflen, char *preferred_language, char *fallback)
+{
+    const char **languages;
+    size_t langcnt;
+    EncaAnalyser analyser;
+    EncaEncoding encoding;
+    char *detected_sub_cp = NULL;
+    int i;
+
+    languages = enca_get_languages(&langcnt);
+    mp_msg(MSGT_ASS, MSGL_V, "ENCA supported languages: ");
+    for (i = 0; i < langcnt; i++) {
+	mp_msg(MSGT_ASS, MSGL_V, "%s ", languages[i]);
+    }
+    mp_msg(MSGT_ASS, MSGL_V, "\n");
+    
+    for (i = 0; i < langcnt; i++) {
+	const char *tmp;
+	
+	if (strcasecmp(languages[i], preferred_language) != 0) continue;
+	analyser = enca_analyser_alloc(languages[i]);
+	encoding = enca_analyse_const(analyser, buffer, buflen);
+	tmp = enca_charset_name(encoding.charset, ENCA_NAME_STYLE_ICONV);
+	if (tmp && encoding.charset != ENCA_CS_UNKNOWN) {
+	    detected_sub_cp = strdup(tmp);
+	    mp_msg(MSGT_ASS, MSGL_INFO, "ENCA detected charset: %s\n", tmp);
+	}
+	enca_analyser_free(analyser);
+    }
+    
+    free(languages);
+
+    if (!detected_sub_cp) {
+	detected_sub_cp = strdup(fallback);
+	mp_msg(MSGT_ASS, MSGL_INFO, "ENCA detection failed: fallback to %s\n", fallback);
+    }
+
+    return detected_sub_cp;
+}
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.h	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,35 @@
+#ifndef __MPUTILS_H__
+#define __MPUTILS_H__
+
+#include "help_mp.h"
+
+unsigned utf8_get_char(char **str);
+
+void my_mp_msg(int lvl, char *lvl_str, char *fmt, ...);
+
+#ifdef __VISUALC__
+static void mp_msg(int mod, int level, const char *fmt, ...) {
+	// MSVC doesn't like the # used all around for mp_msg, so it breaks va_arg
+}
+#else
+#define mp_msg(mod, level, args...) my_mp_msg(level, #level, args)
+#endif
+
+#define MSGT_ASS 43
+
+#define MSGL_FATAL 0
+#define MSGL_ERR 1
+#define MSGL_WARN 2
+#define MSGL_INFO 4
+#define MSGL_V 6
+#define MSGL_DBG2 7
+
+void blur(unsigned char *buffer, unsigned short *tmp2, int width, int height,
+          int stride, int *m2, int r, int mwidth);
+
+void* guess_buffer_cp(unsigned char* buffer, int buflen, char *preferred_language, char *fallback);
+
+#define FFMAX(a,b) ((a) > (b) ? (a) : (b))
+#define FFMIN(a,b) ((a) > (b) ? (b) : (a))
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_vidASS.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_vidASS.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_vidASS.cpp	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,397 @@
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+/*
+  Initial port from MPlayer by Moonz
+  Mplayer version is Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+
+*/
+
+
+#include "ADM_default.h"
+#include "ADM_coreVideoFilterInternal.h"
+#include "DIA_coreToolkit.h"
+#include "DIA_factory.h"
+
+#include "ass_ssa.h"
+#include "ass_ssa_desc.cpp"
+
+extern "C"
+{
+#include "ADM_libass/ass.h"
+}
+
+/**
+    \class subAss
+*/
+class subAss : public  ADM_coreVideoFilter
+{
+protected:
+        ass_ssa         param;
+        ass_library_t   *_ass_lib;
+        ass_renderer_t  *_ass_rend;
+        ass_track_t     *_ass_track;
+        bool            init(void);
+        ADMImage        *src;
+public:
+                    subAss(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                    ~subAss();
+
+        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
+	 //  virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) ;           /// Start graphical user interface
+};
+
+// Add the hook to make it valid plugin
+DECLARE_VIDEO_FILTER(   subAss,   // Class
+                        1,0,0,              // Version
+                        ADM_UI_ALL,         // UI
+                        VF_SUBTITLE,            // Category
+                        "ssa",            // internal name (must be uniq!)
+                        "SSA.",            // Display name
+                        "Hardcode ass/ssa subtitles using libass." // Description
+                    );
+
+
+
+#ifndef DIR_SEP
+# ifdef WIN32
+#   define DIR_SEP '\\'
+#   define DEFAULT_FONT_DIR "c:"
+# else
+#   define DIR_SEP '/'
+#   define DEFAULT_FONT_DIR "/tmp/"
+# endif
+#endif
+//*****************
+
+/**
+    \fn getConfiguration
+    \brief Return current setting as a string
+*/
+const char *subAss::getConfiguration(void)
+{
+    static char buf[500];
+    buf[0]=0;
+ 
+      sprintf((char *)buf," ASS/SSA Subtitles: ");
+      
+      char *filename = (char*)param.subtitleFile;
+      if(filename)
+      {
+          if(strrchr(filename, DIR_SEP) != NULL && *(strrchr(filename, DIR_SEP) + 1) != 0)
+              filename = strrchr(filename, DIR_SEP) + 1;
+          strncat(buf, filename, 49-strlen(buf));
+          buf[49] = 0;
+      }else
+      {
+        strcat(buf," (no sub)");       
+      }
+      return buf;
+}
+/**
+    \fn ctor
+*/
+subAss::subAss( ADM_coreVideoFilter *in,CONFcouple *setup) : ADM_coreVideoFilter(in,setup)
+{	
+	 if(!setup || !ADM_paramLoad(setup,ass_ssa_param,&param))
+    {
+            param.font_scale = 1.;
+            param.line_spacing = param.topMargin = param.bottomMargin = 0;
+            param.subtitleFile = NULL;
+            param.fontDirectory = ADM_strdup(DEFAULT_FONT_DIR);
+            param.extractEmbeddedFonts = 1;
+    }  	  	
+        src=new ADMImageDefault(in->getInfo()->width,in->getInfo()->height);
+
+        /* ASS initialization */
+        _ass_lib = ass_library_init();
+        _ass_track = NULL;
+        _ass_rend = NULL;
+        ADM_assert(_ass_lib);
+        if(param.subtitleFile)
+        {
+              if(!init())
+              {
+                GUI_Error_HIG("Format ?","Are you sure this is an ass file ?"); 
+              }
+        }
+}
+/**
+    \fn dtor
+*/
+#define DELETE(x) if(x) {ADM_dealloc(x);x=NULL;}
+subAss::~subAss()
+{
+      if(src) delete src;
+      src=NULL;
+      
+        
+        DELETE(param.subtitleFile);
+        DELETE(param.fontDirectory);
+
+#if ASS_HAS_GLOBAL
+        if(_ass_rend) 
+        {
+              ass_renderer_done(_ass_rend);
+              _ass_rend = NULL;
+         }
+
+        if(_ass_track) 
+        {
+              ass_free_track(_ass_track);
+              _ass_track = NULL;
+        }
+        if(_ass_lib) 
+        {
+              ass_library_done(_ass_lib);
+              _ass_lib = NULL;
+        }
+#endif
+}
+
+/**
+    \fn getCoupledConf
+    \brief Return our current configuration as couple name=value
+*/
+bool         subAss::getCoupledConf(CONFcouple **couples)
+{
+    return ADM_paramSave(couples, ass_ssa_param,&param);
+}
+
+/**
+    \fn configure
+*/
+bool subAss::configure(void)
+{
+ 
+#define PX(x) &(param.x)
+#define MKME(x,y) x=(ELEM_TYPE_FLOAT)param.y
+  ELEM_TYPE_FLOAT scale,spacing;
+  
+    MKME(scale,font_scale);
+    MKME(spacing,line_spacing);
+    
+    diaElemFile       file(0,(char **)PX(subtitleFile),QT_TR_NOOP("_Subtitle file (ASS/SSA):"), NULL, QT_TR_NOOP("Select Subtitle file"));
+    diaElemFloat      dSpacing(&spacing,QT_TR_NOOP("_Line spacing:"),0.10,10.0);
+    diaElemFloat      dScale(&scale,QT_TR_NOOP("_Font scale:"),0.10,10.0);
+    diaElemUInteger   dTop(PX(topMargin),QT_TR_NOOP("_Top margin:"),0,200);
+    diaElemUInteger   dBottom(PX(bottomMargin),QT_TR_NOOP("Botto_m margin"),0,200);
+    
+       diaElem *elems[5]={&file,&dSpacing,&dScale,&dTop,&dBottom};
+  
+   if( diaFactoryRun(QT_TR_NOOP("ASS"),5,elems))
+   {
+#undef MKME
+#define MKME(x,y) param.y=(float)x
+    MKME(scale,font_scale);
+    MKME(spacing,line_spacing);
+
+     return true;
+   }
+   return false;
+}
+
+/**
+    \fn init
+*/
+bool subAss::init(void)
+{
+bool use_margins = ( param.topMargin | param.bottomMargin ) != 0;
+
+        memcpy(&info,previousFilter->getInfo(),sizeof(info));
+        info.height += param.topMargin + param.bottomMargin;
+
+        ass_set_fonts_dir(_ass_lib, (const char*)param.fontDirectory);
+        ass_set_extract_fonts(_ass_lib, param.extractEmbeddedFonts);
+        ass_set_style_overrides(_ass_lib, NULL);
+#if ASS_HAS_GLOBAL
+         if(_ass_rend) 
+        {
+              ass_renderer_done(_ass_rend);
+              _ass_rend = NULL;
+         }
+#endif
+        _ass_rend = ass_renderer_init(_ass_lib);
+
+        ADM_assert(_ass_rend);
+ 
+        ass_set_frame_size(_ass_rend, info.width, info.height);
+        ass_set_margins(_ass_rend, param.topMargin, param.bottomMargin, 0, 0);
+        ass_set_use_margins(_ass_rend, use_margins);
+        ass_set_font_scale(_ass_rend, param.font_scale);
+        ass_set_fonts(_ass_rend, NULL, "Sans");
+        //~ ass_set_aspect_ratio(_ass_rend, ((double)_info.width) / ((double)_info.height));
+#if ASS_HAS_GLOBAL
+        if(_ass_track) 
+        {
+              ass_free_track(_ass_track);
+              _ass_track = NULL;
+        }
+#endif
+       _ass_track = ass_read_file(_ass_lib, (char*)param.subtitleFile, NULL);
+
+//        ADM_assert(_ass_track);
+        if(!_ass_track)
+          GUI_Error_HIG("SSA Error","Cannot read_file for *%s*",(char*)param.subtitleFile);
+        return 1;
+} 
+
+//*******************************************
+#define _r(c)  ((c)>>24)
+#define _g(c)  (((c)>>16)&0xFF)
+#define _b(c)  (((c)>>8)&0xFF)
+#define _a(c)  ((c)&0xFF)
+#define rgba2y(c)  ( (( 263*_r(c)  + 516*_g(c) + 100*_b(c)) >> 10) + 16  )
+#define rgba2u(c)  ( (( 450*_r(c) - 376*_g(c) -  73*_b(c)) >> 10) + 128 )
+#define rgba2v(c)  ( ((-152*_r(c) - 298*_g(c) + 450*_b(c)) >> 10) + 128 )
+/**
+    \fn nextFrame
+*/
+static bool blacken(ADMImage *src, uint32_t lineStart, uint32_t howto)
+{
+        for(int i=0;i<3;i++)
+            {
+                uint32_t w=src->_width;
+                uint32_t h=src->_height;
+                uint8_t filler=16;
+                uint32_t count=howto;
+                uint32_t lineOffset=lineStart;
+                if(i) {w>>=1;h>>=1;filler=128;count>>=1;lineOffset>>=1;}
+                ADM_PLANE plane=(ADM_PLANE)i;
+
+                uint8_t *dy=src->GetWritePtr(plane);
+                uint32_t dpitch=src->GetPitch(plane);
+                
+                dy+=dpitch*lineOffset;
+
+                for(int y=0;y<count;y++)
+                {
+                    memset(dy,filler,w);
+                    dy+=dpitch;
+                 }
+            }
+            return true;
+}
+/**
+    \fn getNextFrame
+*/
+bool subAss::getNextFrame(uint32_t *fn,ADMImage *image)
+{
+    if(!previousFilter->getNextFrame(fn,src))
+    {
+        ADM_info("[blackenBorder] Cannot get previous image\n");
+        return false;
+    }
+ 
+        uint32_t  i, j, k, l, val;
+        uint8_t y, u, v, opacity;
+        int32_t orig_u, orig_v,klong,newu,newv;
+        uint8_t orig_y;
+        uint8_t *bitmap, *ydata, *udata, *vdata;
+
+       
+       /* copy source to image */
+
+        src->copyTo(image,0,param.topMargin);
+
+        /* Add black border if needed */
+        if(param.topMargin)
+            blacken(image, 0, param.topMargin);
+        if(param.bottomMargin)
+            blacken(image, src->_height+param.topMargin, param.bottomMargin);
+
+        image->copyInfo(src); // pts etc..
+        // Do we have something to render ?
+        if(!_ass_rend || !_ass_track)
+        {
+          printf("[Ass] No sub to render\n");
+          return true; 
+        }
+        
+        int changed=0;
+        int64_t now=previousFilter->getAbsoluteStartTime()+src->Pts;
+        now/=1000; // Ass works in ms
+        ass_image_t *img = ass_render_frame(_ass_rend, _ass_track, now,&changed);
+        
+
+        while(img) {
+                  y = rgba2y(img->color);
+                  u = rgba2u(img->color);
+                  v = rgba2v(img->color);
+
+                  opacity = 255 - _a(img->color);
+
+                  
+
+                  uint8_t *planes[3];
+                  uint32_t pitches[3];
+            
+                  image->GetPitches(pitches);
+                  image->GetWritePlanes(planes);
+
+                  ydata = planes[0]+pitches[0]*img->dst_y;
+                  udata = planes[1]+pitches[1]*(img->dst_y/2);
+                  vdata = planes[2]+pitches[2]*(img->dst_y/2);
+
+                  // do y
+                  bitmap = img->bitmap;
+                  for(i = 0; i < img->h; ++i) 
+                  {
+                          for(j = 0; j < img->w; ++j) 
+                          {
+                                  k = *(bitmap+j) * opacity / 255;
+                                  orig_y = *(ydata+j);
+                                  *(ydata+j) = (k*y + (255-k)*orig_y) / 255;
+                          }
+
+                          bitmap += img->stride;
+                          ydata += pitches[0];
+                  }
+                  // Now do u & v
+                  bitmap = img->bitmap;
+                  
+                  newu=u-128;
+                  newv=v-128;
+
+                  for(i = 0; i < img->h; i += 2) 
+                  {
+                          for(j = 0, l = 0; j < img->w; j += 2, ++l) 
+                          {
+                                  val = 0;
+                                  val += *(bitmap + j);
+                                  val += *(bitmap + j + 1);
+                                  val += *(bitmap + img->stride + j);
+                                  val += *(bitmap + img->stride + j + 1);
+                                  val >>= 2;
+
+                                  k = val * opacity / 255;
+                                  orig_u = *(udata+l);
+                                  orig_v = *(vdata+l);
+
+                                  orig_u=( k*u+(255-k)*orig_u)/255;
+                                  orig_v=( k*v+(255-k)*orig_v)/255;
+                                  *(udata+l) = orig_u;
+                                  *(vdata+l) = orig_v;
+                          }
+
+                          bitmap += img->stride << 1;
+                          udata += pitches[1];
+                          vdata += pitches[2];
+                  }
+
+                  img = img->next;
+        }
+        return true;
+}
+
+/************************************************/
+
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/CMakeLists.txt	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,20 @@
+INCLUDE(admCheckFreeType)
+checkFreeType()
+
+IF (USE_FREETYPE)
+	ADD_SUBDIRECTORY(ADM_libass)
+
+	INCLUDE(vf_plugin)
+	SET(ADM_vf_ssa_SRCS ADM_vidASS.cpp)
+
+        ADD_VIDEO_FILTER(ADM_vf_ssa ${ADM_vf_ssa_SRCS})
+        IF(DO_COMMON)
+         TARGET_LINK_LIBRARIES(ADM_vf_ssa ADM_libass )
+	 ADD_TARGET_LDFLAGS(ADM_vf_ssa "${FREETYPE2_LDFLAGS}")
+	 IF (FONTCONFIG_FOUND)
+		ADD_TARGET_LDFLAGS(ADM_vf_ssa "${FONTCONFIG_LDFLAGS}")
+	 ENDIF (FONTCONFIG_FOUND)
+        ENDIF(DO_COMMON)
+        INIT_VIDEO_FILTER(ADM_vf_ssa)
+        INSTALL_VIDEO_FILTER(ADM_vf_ssa)
+ENDIF (USE_FREETYPE)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ass_ssa.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ass_ssa.conf	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ass_ssa.conf	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,7 @@
+float:font_scale
+float:line_spacing
+string:subtitleFile
+string:fontDirectory
+uint32_t:extractEmbeddedFonts
+uint32_t:topMargin
+uint32_t:bottomMargin

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ass_ssa.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ass_ssa.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ass_ssa.h	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,14 @@
+// Automatically generated, do not edit!
+#ifndef ADM_ass_ssa_CONF_H
+#define ADM_ass_ssa_CONF_H
+typedef struct {
+   float font_scale;
+   float line_spacing;
+   char * subtitleFile;
+   char * fontDirectory;
+   uint32_t extractEmbeddedFonts;
+   uint32_t topMargin;
+   uint32_t bottomMargin;
+}ass_ssa;
+#endif //ass_ssa
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ass_ssa_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ass_ssa_desc.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ass_ssa_desc.cpp	2010-09-04 16:33:33 UTC (rev 6583)
@@ -0,0 +1,11 @@
+// Automatically generated, do not edit!
+const ADM_paramList ass_ssa_param[]={
+ {"font_scale",offsetof( ass_ssa,font_scale),"float",ADM_param_float},
+ {"line_spacing",offsetof( ass_ssa,line_spacing),"float",ADM_param_float},
+ {"subtitleFile",offsetof( ass_ssa,subtitleFile),"char *",ADM_param_string},
+ {"fontDirectory",offsetof( ass_ssa,fontDirectory),"char *",ADM_param_string},
+ {"extractEmbeddedFonts",offsetof( ass_ssa,extractEmbeddedFonts),"uint32_t",ADM_param_uint32_t},
+ {"topMargin",offsetof( ass_ssa,topMargin),"uint32_t",ADM_param_uint32_t},
+ {"bottomMargin",offsetof( ass_ssa,bottomMargin),"uint32_t",ADM_param_uint32_t},
+{NULL,0,NULL}
+};



From mean at mail.berlios.de  Sat Sep  4 18:33:35 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  4 Sep 2010 18:33:35 +0200
Subject: [Avidemux-svn-commit] r6584 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass
Message-ID: <20100904163335.826CD48102A@sheep.berlios.de>

Author: mean
Date: 2010-09-04 18:33:35 +0200 (Sat, 04 Sep 2010)
New Revision: 6584

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_vidASS.cpp
Log:
[filter] Fix ass x offset

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_vidASS.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_vidASS.cpp	2010-09-04 16:33:33 UTC (rev 6583)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_vidASS.cpp	2010-09-04 16:33:35 UTC (rev 6584)
@@ -67,7 +67,7 @@
 #   define DEFAULT_FONT_DIR "c:"
 # else
 #   define DIR_SEP '/'
-#   define DEFAULT_FONT_DIR "/tmp/"
+#   define DEFAULT_FONT_DIR "/usr/share/fonts/truetype/"
 # endif
 #endif
 //*****************
@@ -320,9 +320,10 @@
         int64_t now=previousFilter->getAbsoluteStartTime()+src->Pts;
         now/=1000; // Ass works in ms
         ass_image_t *img = ass_render_frame(_ass_rend, _ass_track, now,&changed);
-        
+        //printf("Time is now %d ms\n",now);
 
         while(img) {
+                  //  printf("Image is %d x %d \n",img->w, img->h);
                   y = rgba2y(img->color);
                   u = rgba2u(img->color);
                   v = rgba2v(img->color);
@@ -337,10 +338,13 @@
                   image->GetPitches(pitches);
                   image->GetWritePlanes(planes);
 
-                  ydata = planes[0]+pitches[0]*img->dst_y;
-                  udata = planes[1]+pitches[1]*(img->dst_y/2);
-                  vdata = planes[2]+pitches[2]*(img->dst_y/2);
+                  uint32_t x=img->dst_x;
+                  ydata = planes[0]+pitches[0]*( param.topMargin+img->dst_y)+x;
 
+                  x>>=1;
+                  udata = planes[1]+pitches[1]*((param.topMargin+img->dst_y)/2)+x;
+                  vdata = planes[2]+pitches[2]*((param.topMargin+img->dst_y)/2)+x;
+
                   // do y
                   bitmap = img->bitmap;
                   for(i = 0; i < img->h; ++i) 



From gruntster at mail.berlios.de  Sun Sep  5 13:42:43 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun,  5 Sep 2010 13:42:43 +0200
Subject: [Avidemux-svn-commit] r6585 - in
	branches/avidemux_2.5_branch_gruntster/cmake: . patches
Message-ID: <20100905114243.ED7DD480F39@sheep.berlios.de>

Author: gruntster
Date: 2010-09-05 13:42:43 +0200 (Sun, 05 Sep 2010)
New Revision: 6585

Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
Log:
[ffmpeg] update FFmpeg to r25041 & libswscale to r32049

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2010-09-04 16:33:35 UTC (rev 6584)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2010-09-05 11:42:43 UTC (rev 6585)
@@ -1,7 +1,7 @@
 include(admFFmpegUtil)
 
-set(FFMPEG_VERSION 24666)	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=64c439749fac9240ca3e267b84b1d83f588a9c06;sf=tgz
-set(SWSCALE_VERSION 31906)	# http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=233bcae1499042c80d2111bc76086302793029a9;sf=tgz
+set(FFMPEG_VERSION 25041)	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=10ef19af69162ac8bbdb697af33228fefb8006e1;sf=tgz
+set(SWSCALE_VERSION 32049)	# http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=12463fadc6566a4a6ebe01aa98dade211e5955fc;sf=tgz
 
 set(LIBRARY_SOURCE_DIR "${CMAKE_SOURCE_DIR}/avidemux/ADM_libraries")
 set(FFMPEG_SOURCE_DIR "${LIBRARY_SOURCE_DIR}/ffmpeg")

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2010-09-04 16:33:35 UTC (rev 6584)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2010-09-05 11:42:43 UTC (rev 6585)
@@ -1,8 +1,8 @@
-*** libavcodec/avcodec.h.old	Mon Aug  2 20:19:48 2010
---- libavcodec/avcodec.h	Mon Aug  2 20:19:48 2010
+*** libavcodec/avcodec.h.old	Sun Sep  5 02:05:26 2010
+--- libavcodec/avcodec.h	Sun Sep  5 02:05:26 2010
 ***************
-*** 614,619 ****
---- 614,621 ----
+*** 626,631 ****
+--- 626,633 ----
   #define CODEC_FLAG2_PSY           0x00080000 ///< Use psycho visual optimizations.
   #define CODEC_FLAG2_SSIM          0x00100000 ///< Compute SSIM during encoding, error[] values are undefined.
   #define CODEC_FLAG2_INTRA_REFRESH 0x00200000 ///< Use periodic insertion of intra blocks instead of keyframes.
@@ -12,8 +12,8 @@
   /* Unsupported options :
    *              Syntax Arithmetic coding (SAC)
 ***************
-*** 1496,1501 ****
---- 1498,1504 ----
+*** 1508,1513 ****
+--- 1510,1516 ----
        * - decoding: unused
        */
       int rc_max_rate;
@@ -22,8 +22,8 @@
       /**
        * minimum bitrate
 ***************
-*** 1510,1515 ****
---- 1513,1520 ----
+*** 1522,1527 ****
+--- 1525,1532 ----
        * - decoding: unused
        */
       int rc_buffer_size;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo.c.patch	2010-09-04 16:33:35 UTC (rev 6584)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo.c.patch	2010-09-05 11:42:43 UTC (rev 6585)
@@ -1,7 +1,7 @@
-*** libavcodec/mpegvideo.c.old	Tue Jul  6 19:51:24 2010
---- libavcodec/mpegvideo.c	Tue Jul  6 19:51:24 2010
+*** libavcodec/mpegvideo.c.old	Sun Sep  5 02:05:37 2010
+--- libavcodec/mpegvideo.c	Sun Sep  5 02:05:37 2010
 ***************
-*** 652,658 ****
+*** 653,659 ****
       FF_ALLOCZ_OR_GOTO(s->avctx, s->prev_pict_types, PREV_PICT_TYPES_BUFFER_SIZE, fail);
   
       s->parse_context.state= -1;
@@ -9,7 +9,7 @@
          s->visualization_buffer[0] = av_malloc((s->mb_width*16 + 2*EDGE_WIDTH) * s->mb_height*16 + 2*EDGE_WIDTH);
          s->visualization_buffer[1] = av_malloc((s->mb_width*16 + 2*EDGE_WIDTH) * s->mb_height*16 + 2*EDGE_WIDTH);
          s->visualization_buffer[2] = av_malloc((s->mb_width*16 + 2*EDGE_WIDTH) * s->mb_height*16 + 2*EDGE_WIDTH);
---- 652,662 ----
+--- 653,663 ----
       FF_ALLOCZ_OR_GOTO(s->avctx, s->prev_pict_types, PREV_PICT_TYPES_BUFFER_SIZE, fail);
   
       s->parse_context.state= -1;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2010-09-04 16:33:35 UTC (rev 6584)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2010-09-05 11:42:43 UTC (rev 6585)
@@ -1,8 +1,8 @@
-*** libavcodec/utils.c.old	Mon Aug  2 20:19:56 2010
---- libavcodec/utils.c	Mon Aug  2 20:19:56 2010
+*** libavcodec/utils.c.old	Sun Sep  5 02:05:45 2010
+--- libavcodec/utils.c	Sun Sep  5 02:05:45 2010
 ***************
-*** 644,653 ****
---- 644,655 ----
+*** 642,651 ****
+--- 642,653 ----
   
       if((avctx->codec->capabilities & CODEC_CAP_DELAY) || avpkt->size){
           //FIXME remove the check below _after_ ensuring that all audio check that the available space is enough



From gruntster at mail.berlios.de  Sun Sep  5 13:48:05 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun,  5 Sep 2010 13:48:05 +0200
Subject: [Avidemux-svn-commit] r6586 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src
Message-ID: <20100905114805.2C259480F39@sheep.berlios.de>

Author: gruntster
Date: 2010-09-05 13:48:04 +0200 (Sun, 05 Sep 2010)
New Revision: 6586

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_interlaceUtil.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_vidFieldASM.cpp
Log:
[coreimage] gcc 4.5 patch

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_interlaceUtil.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_interlaceUtil.cpp	2010-09-05 11:42:43 UTC (rev 6585)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_interlaceUtil.cpp	2010-09-05 11:48:04 UTC (rev 6586)
@@ -30,20 +30,9 @@
  ***************************************************************************/
 
 #include "ADM_default.h"
-
-//#include "ADM_editor/ADM_edit.hxx"
 #include "ADM_videoFilter.h"
 
-//#define MMX_TRACE
-#warning remove mmxmacro and debug asm
-//#define ASM_ILACING
 
-
-#include "ADM_mmxMacros.h"
-
-
-
-
 #define SKIP_FACTOR 2   // 2^SKIPFACTOR=SKIP_LINEAR+1
 #define SKIP_LINEAR   3
 
@@ -62,7 +51,7 @@
 */
 
 #if defined(ADM_CPU_X86) && defined(ASM_ILACING)
-
+#warning REWRITE IN PLAIN ASM
 static uint32_t      ADMVideo_interlaceCount_MMX( uint8_t *src ,uint32_t w, uint32_t h);
 static uint8_t * FUNNY_MANGLE(_l_p)  =NULL;
 static uint8_t * FUNNY_MANGLE(_l_c) =NULL;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_vidFieldASM.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_vidFieldASM.cpp	2010-09-05 11:42:43 UTC (rev 6585)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_vidFieldASM.cpp	2010-09-05 11:48:04 UTC (rev 6586)
@@ -20,15 +20,13 @@
  ***************************************************************************/
 
 #include "ADM_default.h"
-
 #include "ADM_videoFilter.h"
-
 #include"ADM_vidField.h"
 
 #ifdef ADM_CPU_X86
 //	#define DEBUG_DEINT 1
 //	#define MMX_TRACE 1
-	#include "ADM_mmxMacros.h"
+//	#include "ADM_mmxMacros.h"
 
  void myDeintASM(void);
 
@@ -36,25 +34,27 @@
  static uint8_t * FUNNY_MANGLE(_l_p) , * FUNNY_MANGLE(_l_c) ,* FUNNY_MANGLE(_l_n);
  static uint8_t * FUNNY_MANGLE(_l_e) , * FUNNY_MANGLE(_l_e2);
 #define EXPAND(x) (x)+((x)<<16)+((x)<<32) +((x)<<48)
-static mmx_t _mmTHRESH1;
-static mmx_t _mmTHRESH2;
+static uint64_t  __attribute__((used)) __attribute__ ((__aligned__ (8)))  FUNNY_MANGLE(_mmTHRESH1) ;
+static uint64_t  __attribute__((used)) __attribute__ ((__aligned__ (8)))  FUNNY_MANGLE(_mmTHRESH2) ;
 
+
 #define COMPUTE_MMX \
-punpcklbw_r2r(mm5,mm0);  /*c  expand 4 bytes -> 4 word */ \
-punpcklbw_r2r(mm5,mm1);  /*p*/ \
-punpcklbw_r2r(mm5,mm2); /* n*/ \
-movq_r2r(mm0,mm3);		/* mm3 also c*/ \
-psubw_r2r(mm1,mm0) ; /* mm0=mm0-mm1 =  c-p*/ \
-psubw_r2r(mm2,mm3) ; /* mm3=mm3-mm2 =  c-n*/ \
-psraw_i2r(1,mm0); /* to protect from overflow*/ \
-psraw_i2r(1,mm3);\
-pmullw_r2r(mm0,mm3); /* mm3=(c-p)*(c-n) / 4;*/ \
-movq_r2r(mm3,mm0) ; /* mm0 also c-p*c-n */ \
-pcmpgtw_r2r(mm4,mm3); /* keep only > size*/ \
-pcmpgtw_r2r(mm6,mm0); /* keep only > size*/ \
-packsswb_r2r(mm5,mm0); \
-packsswb_r2r(mm5,mm3);
-
+__asm__ __volatile__(\
+"punpcklbw %%mm5,%%mm0\n\t" \
+"punpcklbw %%mm5,%%mm1\n\t" \
+"punpcklbw %%mm5,%%mm2\n\t" \
+"movq      %%mm0,%%mm3\n\t" \
+"psubw     %%mm1,%%mm0\n\t" \
+"psubw     %%mm2,%%mm3\n\t" \
+"psraw     $1,%%mm0\n\t" \
+"psraw     $1,%%mm3\n\t" \
+"pmullw    %%mm0,%%mm3\n\t" \
+"movq      %%mm3,%%mm0\n\t" \
+"pcmpgtw   %%mm4,%%mm3\n\t" \
+"pcmpgtw   %%mm6,%%mm0\n\t" \
+"packsswb  %%mm5,%%mm0\n\t" \
+"packsswb  %%mm5,%%mm3\n\t" \
+::)
 #endif
 
 void ADMVideoFields::hasMotion_C(uint8_t *p,uint8_t *c,
@@ -90,8 +90,8 @@
 {
 
 
-			 	_mmTHRESH1.uq=EXPAND((uint64_t ) ((_param->motion_trigger*_param->motion_trigger)>>2) );
-				_mmTHRESH2.uq=EXPAND((uint64_t ) ((_param->blend_trigger*_param->blend_trigger)>>2) );
+            _mmTHRESH1=EXPAND((uint64_t ) ((_param->motion_trigger*_param->motion_trigger)>>2) );
+            _mmTHRESH2=EXPAND((uint64_t ) ((_param->blend_trigger*_param->blend_trigger)>>2) );
 
 			_l_h=_info.height-2;
 			_l_w=_info.width>>2;
@@ -102,10 +102,11 @@
 			_l_e=e;
 			_l_e2=e2;
 //			printf("\n MMX \n");
-
-			pxor_r2r(mm5,mm5);
-			movq_m2r(_mmTHRESH1,mm4);
-			movq_m2r(_mmTHRESH2,mm6);
+             __asm__ __volatile__ (
+			"pxor %%mm5,%%mm5\n\t"
+			"movq "Mangle(_mmTHRESH1)",%%mm4\n\t"
+            "movq "Mangle(_mmTHRESH2)",%%mm6\n\t"
+            ::);
 			myDeintASM();
 }
 #if !defined(DEBUG_DEINT)
@@ -149,7 +150,7 @@
                             :
                             : "eax", "ecx","edx","esi"
                             );
-	   emms();
+            __asm__ __volatile__ ("emms");
 
 }
 #else



From gruntster at mail.berlios.de  Sun Sep  5 13:57:01 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun,  5 Sep 2010 13:57:01 +0200
Subject: [Avidemux-svn-commit] r6587 - in
	branches/avidemux_2.5_branch_gruntster: avidemux
	platforms/windows/build_scripts
	platforms/windows/build_scripts/avidemux platforms/windows/installer
Message-ID: <20100905115701.539C0480F39@sheep.berlios.de>

Author: gruntster
Date: 2010-09-05 13:57:01 +0200 (Sun, 05 Sep 2010)
New Revision: 6587

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1b. Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
Log:
[win32] update build scripts

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt	2010-09-05 11:48:04 UTC (rev 6586)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt	2010-09-05 11:57:01 UTC (rev 6587)
@@ -136,15 +136,21 @@
 	STRING(REPLACE "." "," PRODUCTVERSION ${PRODUCTVERSION_STRING})
 	SET(PRODUCTVERSION "${PRODUCTVERSION},0")
 
+	IF (ADM_CPU_X86_64)
+		SET(WIN_RES_TARGET "pe-x86-64")
+	ELSE (ADM_CPU_X86_64)
+		SET(WIN_RES_TARGET "pe-i386")
+	ENDIF (ADM_CPU_X86_64)
+
 	SET(AVIDEMUX_ICON "adm.ico")
 	SET(WIN_RES_GTK "admWinGtk.obj")
 	CONFIGURE_FILE("${CMAKE_SOURCE_DIR}/cmake/admWin32.rc.in" ${CMAKE_CURRENT_BINARY_DIR}/admWinGtk.rc IMMEDIATE)
-	ADD_CUSTOM_COMMAND(OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/${WIN_RES_GTK} COMMAND windres.exe -i ${CMAKE_CURRENT_BINARY_DIR}/admWinGtk.rc -o ${CMAKE_CURRENT_BINARY_DIR}/${WIN_RES_GTK} -O coff --define VS_VERSION_INFO=1)
+	ADD_CUSTOM_COMMAND(OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/${WIN_RES_GTK} COMMAND windres.exe -F ${WIN_RES_TARGET} -i ${CMAKE_CURRENT_BINARY_DIR}/admWinGtk.rc -o ${CMAKE_CURRENT_BINARY_DIR}/${WIN_RES_GTK} -O coff --define VS_VERSION_INFO=1)
 
 	SET(AVIDEMUX_ICON "avidemux.ico")
 	SET(WIN_RES_QT "admWinQt.obj")
 	CONFIGURE_FILE("${CMAKE_SOURCE_DIR}/cmake/admWin32.rc.in" ${CMAKE_CURRENT_BINARY_DIR}/admWinQt.rc IMMEDIATE)
-	ADD_CUSTOM_COMMAND(OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/${WIN_RES_QT} COMMAND windres.exe -i ${CMAKE_CURRENT_BINARY_DIR}/admWinQt.rc -o ${CMAKE_CURRENT_BINARY_DIR}/${WIN_RES_QT} -O coff --define VS_VERSION_INFO=1)
+	ADD_CUSTOM_COMMAND(OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/${WIN_RES_QT} COMMAND windres.exe -F ${WIN_RES_TARGET} -i ${CMAKE_CURRENT_BINARY_DIR}/admWinQt.rc -o ${CMAKE_CURRENT_BINARY_DIR}/${WIN_RES_QT} -O coff --define VS_VERSION_INFO=1)
 ENDIF (WIN32)
 
 ########################################

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat	2010-09-05 11:48:04 UTC (rev 6586)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat	2010-09-05 11:57:01 UTC (rev 6587)
@@ -5,13 +5,14 @@
 set devDir=E:\Dev
 
 if "%BuildBits%" == "32" (
-	set mingwDir=%devDir%\MinGW32
 	set msysDir=E:/Dev/MSYS
 	set qtDir=%devDir%\Qt
+	set CFLAGS=-m32 
+	set CXXFLAGS=-m32
+	set LDFLAGS=-m32
 	goto :setVars )
 
 if "%BuildBits%" == "64" (
-	set mingwDir=%devDir%\MinGW-w64
 	set msysDir=E:/Dev/MSYS-64
 	set qtDir=%devDir%\Qt-64
 	goto :setVars )
@@ -20,21 +21,16 @@
 goto error
 
 :setVars
+set mingwDir=%devDir%\MinGW64
 set usrLocalDir=%msysDir%/local
 set CMAKE_INCLUDE_PATH=%usrLocalDir%/include
 set CMAKE_LIBRARY_PATH=%usrLocalDir%/lib
 set PKG_CONFIG_PATH=%usrLocalDir%\lib\pkgconfig
 set SDLDIR=%usrLocalDir%
-set CFLAGS=-I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
-set CXXFLAGS=-I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
-set LDFLAGS=-L%CMAKE_LIBRARY_PATH%
+set CFLAGS=%CFLAGS% -I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
+set CXXFLAGS=%CXXFLAGS% -I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
+set LDFLAGS=%LDFLAGS% -shared-libgcc -shared-libstdc++ -L%CMAKE_LIBRARY_PATH%
 
-if "%BuildBits%" == "32" (
-	set CFLAGS=%CFLAGS% -I%mingwDir:\=/%/i686-w64-mingw32/include/directx )
-
-if "%BuildBits%" == "64" (
-	set CFLAGS=%CFLAGS% -I%mingwDir:\=/%/x86_64-w64-mingw32/include/directx )
-
 if exist "%qtDir%" (
 	for /f %%d in ('dir /b /ad /on %qtDir%') do set qtVer=%%d
 ) else (

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1b. Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1b. Perform Build.bat	2010-09-05 11:48:04 UTC (rev 6586)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1b. Perform Build.bat	2010-09-05 11:57:01 UTC (rev 6587)
@@ -1,12 +1,12 @@
 cd "%sourceDir%\%buildFolder%"
-cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DCMAKE_EXE_LINKER_FLAGS="-shared-libgcc" -DCMAKE_SHARED_LINKER_FLAGS="-shared-libgcc %LDFLAGS%" -DUSE_SYSTEM_SPIDERMONKEY=ON -DCMAKE_INCLUDE_PATH="%SpiderMonkeySourceDir%" -DCMAKE_LIBRARY_PATH="%SpiderMonkeyLibDir%" %DebugFlags% ..
+cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DUSE_SYSTEM_SPIDERMONKEY=ON -DCMAKE_INCLUDE_PATH="%SpiderMonkeySourceDir%" -DCMAKE_LIBRARY_PATH="%SpiderMonkeyLibDir%" %DebugFlags% ..
 
 if errorlevel 1 goto error
 pause
 
 set msysSourceDir=%sourceDir:\=/%
 cd "%sourceDir%\%buildPluginFolder%"
-cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_CORECONFIG_DIR="%msysSourceDir%/%buildFolder%/config" -DAVIDEMUX_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_SOURCE_DIR="%msysSourceDir%" -DCMAKE_EXE_LINKER_FLAGS="-shared-libgcc" -DCMAKE_SHARED_LINKER_FLAGS="-shared-libgcc %LDFLAGS%" %DebugFlags% ../plugins
+cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_CORECONFIG_DIR="%msysSourceDir%/%buildFolder%/config" -DAVIDEMUX_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_SOURCE_DIR="%msysSourceDir%" %DebugFlags% ../plugins
 
 if errorlevel 1 goto error
 pause

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2010-09-05 11:48:04 UTC (rev 6586)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2010-09-05 11:57:01 UTC (rev 6587)
@@ -270,20 +270,19 @@
     ${File} "Build Info.txt"
     ${File} "Change Log.html"
     ${File} zlib1.dll
+    ${File} libstdc++*.dll
     
 !if ${BUILD_BITS} == 32
     ${File} freetype6.dll
     ${File} libnspr4.dll
-    ${File} libstdc++.dll
 !endif
 
 !if ${BUILD_BITS} == 64
-	${File} libfreetype-6.dll
-	${File} libstdc++-6.dll
+    ${File} libfreetype-6.dll
 !endif
 
-	${File} libgcc_s_sjlj-1.dll
-	${File} libogg-0.dll
+    ${File} libgcc_s_sjlj-1.dll
+    ${File} libogg-0.dll
     ${File} libjs.dll
     ${File} libADM_core.dll
     ${File} libADM_coreAudio.dll



From mean at mail.berlios.de  Mon Sep  6 12:23:18 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:18 +0200
Subject: [Avidemux-svn-commit] r6588 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass
Message-ID: <20100906102319.15D90481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:18 +0200 (Mon, 06 Sep 2010)
New Revision: 6588

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache_template.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_drawing.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_drawing.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_parse.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_parse.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render_api.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_strtod.c
Removed:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_types.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.h
Log:
[filter/ass] update libass

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/CMakeLists.txt	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/CMakeLists.txt	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,19 +1,30 @@
 INCLUDE(admCheckFontConfig)
 checkFontConfig()
 
+#CONFIG_FONTCONFIG
+#CONFIG_ENCA
+#CONFIG_ICONV
+#
+#
+#
+
 SET(ADM_LIB ADM_libass)
 
 SET(${ADM_LIB}_SRCS 
-ass_bitmap.c  ass.c  ass_cache.c  ass_fontconfig.c  ass_library.c   ass_render.c  ass_utils.c  mputils.c
-ass_font.c)
+ass_bitmap.c  ass.c  ass_cache.c  ass_fontconfig.c  ass_library.c   ass_render.c  ass_utils.c
+ass_font.c ass_parse.c ass_drawing.c ass_render_api.c ass_strtod.c)
+#  mputils.c
 
 ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})
 ADD_DEFINITIONS(${FREETYPE2_CFLAGS} "-I${LIBICONV_INCLUDE_DIR}")
 
 IF (FONTCONFIG_FOUND)
-	ADD_DEFINITIONS(${FONTCONFIG_CFLAGS} "-DHAVE_FONTCONFIG=1")
+	ADD_DEFINITIONS(${FONTCONFIG_CFLAGS} "-DCONFIG_FONTCONFIG=1")
 ENDIF (FONTCONFIG_FOUND)
 
+# ?
+ADD_DEFINITIONS(${FONTCONFIG_CFLAGS} "-DCONFIG_ICONV=1")
+
 IF (UNIX)
 	ADD_TARGET_CFLAGS(${ADM_LIB} -fPIC)
-ENDIF (UNIX)
\ No newline at end of file
+ENDIF (UNIX)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.c	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,28 +1,29 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#include "ADM_coreConfig.h"
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-//#include "config.h"
-
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
+#include <strings.h>
 #include <assert.h>
 #include <errno.h>
 #include <sys/types.h>
@@ -30,124 +31,138 @@
 #include <unistd.h>
 #include <inttypes.h>
 
-#ifdef USE_ICONV
+#ifdef CONFIG_ICONV
 #include <iconv.h>
 #endif
 
 #include "ass.h"
 #include "ass_utils.h"
 #include "ass_library.h"
-#include "mputils.h"
 
-typedef enum {PST_UNKNOWN = 0, PST_INFO, PST_STYLES, PST_EVENTS, PST_FONTS} parser_state_t;
+#define ass_atof(STR) (ass_strtod((STR),NULL))
 
-struct parser_priv_s {
-	parser_state_t state;
-	char* fontname;
-	char* fontdata;
-	int fontdata_size;
-	int fontdata_used;
+typedef enum {
+    PST_UNKNOWN = 0,
+    PST_INFO,
+    PST_STYLES,
+    PST_EVENTS,
+    PST_FONTS
+} ParserState;
+
+struct parser_priv {
+    ParserState state;
+    char *fontname;
+    char *fontdata;
+    int fontdata_size;
+    int fontdata_used;
 };
 
 #define ASS_STYLES_ALLOC 20
 #define ASS_EVENTS_ALLOC 200
 
-void ass_free_track(ass_track_t* track) {
-	int i;
-	
-	if (track->parser_priv) {
-		if (track->parser_priv->fontname)
-			free(track->parser_priv->fontname);
-		if (track->parser_priv->fontdata)
-			free(track->parser_priv->fontdata);
-		free(track->parser_priv);
-	}
-	if (track->style_format)
-		free(track->style_format);
-	if (track->event_format)
-		free(track->event_format);
-	if (track->styles) {
-		for (i = 0; i < track->n_styles; ++i)
-			ass_free_style(track, i);
-		free(track->styles);
-	}
-	if (track->events) {
-		for (i = 0; i < track->n_events; ++i)
-			ass_free_event(track, i);
-		free(track->events);
-	}
+void ass_free_track(ASS_Track *track)
+{
+    int i;
+
+    if (track->parser_priv) {
+        free(track->parser_priv->fontname);
+        free(track->parser_priv->fontdata);
+        free(track->parser_priv);
+    }
+    free(track->style_format);
+    free(track->event_format);
+    if (track->styles) {
+        for (i = 0; i < track->n_styles; ++i)
+            ass_free_style(track, i);
+    }
+    free(track->styles);
+    if (track->events) {
+        for (i = 0; i < track->n_events; ++i)
+            ass_free_event(track, i);
+    }
+    free(track->events);
+    free(track->name);
+    free(track);
 }
 
 /// \brief Allocate a new style struct
 /// \param track track
 /// \return style id
-int ass_alloc_style(ass_track_t* track) {
-	int sid;
-	
-	assert(track->n_styles <= track->max_styles);
+int ass_alloc_style(ASS_Track *track)
+{
+    int sid;
 
-	if (track->n_styles == track->max_styles) {
-		track->max_styles += ASS_STYLES_ALLOC;
-		track->styles = (ass_style_t*)realloc(track->styles, sizeof(ass_style_t)*track->max_styles);
-	}
-	
-	sid = track->n_styles++;
-	memset(track->styles + sid, 0, sizeof(ass_style_t));
-	return sid;
+    assert(track->n_styles <= track->max_styles);
+
+    if (track->n_styles == track->max_styles) {
+        track->max_styles += ASS_STYLES_ALLOC;
+        track->styles =
+            (ASS_Style *) realloc(track->styles,
+                                  sizeof(ASS_Style) *
+                                  track->max_styles);
+    }
+
+    sid = track->n_styles++;
+    memset(track->styles + sid, 0, sizeof(ASS_Style));
+    return sid;
 }
 
 /// \brief Allocate a new event struct
 /// \param track track
 /// \return event id
-int ass_alloc_event(ass_track_t* track) {
-	int eid;
-	
-	assert(track->n_events <= track->max_events);
+int ass_alloc_event(ASS_Track *track)
+{
+    int eid;
 
-	if (track->n_events == track->max_events) {
-		track->max_events += ASS_EVENTS_ALLOC;
-		track->events = (ass_event_t*)realloc(track->events, sizeof(ass_event_t)*track->max_events);
-	}
-	
-	eid = track->n_events++;
-	memset(track->events + eid, 0, sizeof(ass_event_t));
-	return eid;
+    assert(track->n_events <= track->max_events);
+
+    if (track->n_events == track->max_events) {
+        track->max_events += ASS_EVENTS_ALLOC;
+        track->events =
+            (ASS_Event *) realloc(track->events,
+                                  sizeof(ASS_Event) *
+                                  track->max_events);
+    }
+
+    eid = track->n_events++;
+    memset(track->events + eid, 0, sizeof(ASS_Event));
+    return eid;
 }
 
-void ass_free_event(ass_track_t* track, int eid) {
-	ass_event_t* event = track->events + eid;
-	if (event->Name)
-		free(event->Name);
-	if (event->Effect)
-		free(event->Effect);
-	if (event->Text)
-		free(event->Text);
-	if (event->render_priv)
-		free(event->render_priv);
+void ass_free_event(ASS_Track *track, int eid)
+{
+    ASS_Event *event = track->events + eid;
+
+    free(event->Name);
+    free(event->Effect);
+    free(event->Text);
+    free(event->render_priv);
 }
 
-void ass_free_style(ass_track_t* track, int sid) {
-	ass_style_t* style = track->styles + sid;
-	if (style->Name)
-		free(style->Name);
-	if (style->FontName)
-		free(style->FontName);
+void ass_free_style(ASS_Track *track, int sid)
+{
+    ASS_Style *style = track->styles + sid;
+
+    free(style->Name);
+    free(style->FontName);
 }
 
 // ==============================================================================================
 
-static void skip_spaces(char** str) {
-	char* p = *str;
-	while ((*p==' ') || (*p=='\t'))
-		++p;
-	*str = p;
+static void skip_spaces(char **str)
+{
+    char *p = *str;
+    while ((*p == ' ') || (*p == '\t'))
+        ++p;
+    *str = p;
 }
 
-static void rskip_spaces(char** str, char* limit) {
-	char* p = *str;
-	while ((p >= limit) && ((*p==' ') || (*p=='\t')))
-		--p;
-	*str = p;
+static void rskip_spaces(char **str, char *limit)
+{
+    char *p = *str;
+    while ((p >= limit) && ((*p == ' ') || (*p == '\t')))
+        --p;
+    *str = p;
 }
 
 /**
@@ -158,47 +173,55 @@
  * Returnes 0 if no styles found => expects at least 1 style.
  * Parsing code always adds "Default" style in the end.
  */
-static int lookup_style(ass_track_t* track, char* name) {
-	int i;
-	if (*name == '*') ++name; // FIXME: what does '*' really mean ?
-	for (i=0; i<track->n_styles; ++i) {
-		// FIXME: mb strcasecmp ?
-		if (strcmp(track->styles[i].Name, name) == 0)
-			return i;
-	}
-	i = track->default_style;
-	mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NoStyleNamedXFoundUsingY, track, name, track->styles[i].Name);
-	return i; // use the first style
+static int lookup_style(ASS_Track *track, char *name)
+{
+    int i;
+    if (*name == '*')
+        ++name;                 // FIXME: what does '*' really mean ?
+    for (i = track->n_styles - 1; i >= 0; --i) {
+        // FIXME: mb strcasecmp ?
+        if (strcmp(track->styles[i].Name, name) == 0)
+            return i;
+    }
+    i = track->default_style;
+    ass_msg(track->library, MSGL_WARN,
+            "[%p]: Warning: no style named '%s' found, using '%s'",
+            track, name, track->styles[i].Name);
+    return i;                   // use the first style
 }
 
-static uint32_t string2color(char* p) {
-	uint32_t tmp;
-	(void)strtocolor(&p, &tmp);
-	return tmp;
+static uint32_t string2color(ASS_Library *library, char *p)
+{
+    uint32_t tmp;
+    (void) strtocolor(library, &p, &tmp, 0);
+    return tmp;
 }
 
-static long long string2timecode(char* p) {
-	unsigned h, m, s, ms;
-	long long tm;
-	int res = sscanf(p, "%1d:%2d:%2d.%2d", &h, &m, &s, &ms);
-	if (res < 4) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_BadTimestamp);
-		return 0;
-	}
-	tm = ((h * 60 + m) * 60 + s) * 1000 + ms * 10;
-	return tm;
+static long long string2timecode(ASS_Library *library, char *p)
+{
+    unsigned h, m, s, ms;
+    long long tm;
+    int res = sscanf(p, "%1d:%2d:%2d.%2d", &h, &m, &s, &ms);
+    if (res < 4) {
+        ass_msg(library, MSGL_WARN, "Bad timestamp");
+        return 0;
+    }
+    tm = ((h * 60 + m) * 60 + s) * 1000 + ms * 10;
+    return tm;
 }
 
 /**
  * \brief converts numpad-style align to align.
  */
-static int numpad2align(int val) {
-	int res, v;
-	v = (val - 1) / 3; // 0, 1 or 2 for vertical alignment
-	if (v != 0) v = 3 - v;
-	res = ((val - 1) % 3) + 1; // horizontal alignment
-	res += v*4;
-	return res;
+static int numpad2align(int val)
+{
+    int res, v;
+    v = (val - 1) / 3;          // 0, 1 or 2 for vertical alignment
+    if (v != 0)
+        v = 3 - v;
+    res = ((val - 1) % 3) + 1;  // horizontal alignment
+    res += v * 4;
+    return res;
 }
 
 #define NEXT(str,token) \
@@ -208,113 +231,125 @@
 #define ANYVAL(name,func) \
 	} else if (strcasecmp(tname, #name) == 0) { \
 		target->name = func(token); \
-		mp_msg(MSGT_ASS, MSGL_DBG2, "%s = %s\n", #name, token);
+		ass_msg(track->library, MSGL_DBG2, "%s = %s", #name, token);
 
 #define STRVAL(name) \
 	} else if (strcasecmp(tname, #name) == 0) { \
 		if (target->name != NULL) free(target->name); \
 		target->name = strdup(token); \
-		mp_msg(MSGT_ASS, MSGL_DBG2, "%s = %s\n", #name, token);
-		
-#define COLORVAL(name) ANYVAL(name,string2color)
+		ass_msg(track->library, MSGL_DBG2, "%s = %s", #name, token);
+
+#define COLORVAL(name) \
+	} else if (strcasecmp(tname, #name) == 0) { \
+		target->name = string2color(track->library, token); \
+		ass_msg(track->library, MSGL_DBG2, "%s = %s", #name, token);
+
 #define INTVAL(name) ANYVAL(name,atoi)
-#define FPVAL(name) ANYVAL(name,atof)
-#define TIMEVAL(name) ANYVAL(name,string2timecode)
+#define FPVAL(name) ANYVAL(name,ass_atof)
+#define TIMEVAL(name) \
+	} else if (strcasecmp(tname, #name) == 0) { \
+		target->name = string2timecode(track->library, token); \
+		ass_msg(track->library, MSGL_DBG2, "%s = %s", #name, token);
+
 #define STYLEVAL(name) \
 	} else if (strcasecmp(tname, #name) == 0) { \
 		target->name = lookup_style(track, token); \
-		mp_msg(MSGT_ASS, MSGL_DBG2, "%s = %s\n", #name, token);
+		ass_msg(track->library, MSGL_DBG2, "%s = %s", #name, token);
 
 #define ALIAS(alias,name) \
 	if (strcasecmp(tname, #alias) == 0) {tname = #name;}
 
-static char* next_token(char** str) {
-	char* p = *str;
-	char* start;
-	skip_spaces(&p);
-	if (*p == '\0') {
-		*str = p;
-		return 0;
-	}
-	start = p; // start of the token
-	for (; (*p != '\0') && (*p != ','); ++p) {}
-	if (*p == '\0') {
-		*str = p; // eos found, str will point to '\0' at exit
-	} else {
-		*p = '\0';
-		*str = p + 1; // ',' found, str will point to the next char (beginning of the next token)
-	}
-	--p; // end of current token
-	rskip_spaces(&p, start);
-	if (p < start)
-		p = start; // empty token
-	else
-		++p; // the first space character, or '\0'
-	*p = '\0';
-	return start;
+static char *next_token(char **str)
+{
+    char *p = *str;
+    char *start;
+    skip_spaces(&p);
+    if (*p == '\0') {
+        *str = p;
+        return 0;
+    }
+    start = p;                  // start of the token
+    for (; (*p != '\0') && (*p != ','); ++p) {
+    }
+    if (*p == '\0') {
+        *str = p;               // eos found, str will point to '\0' at exit
+    } else {
+        *p = '\0';
+        *str = p + 1;           // ',' found, str will point to the next char (beginning of the next token)
+    }
+    --p;                        // end of current token
+    rskip_spaces(&p, start);
+    if (p < start)
+        p = start;              // empty token
+    else
+        ++p;                    // the first space character, or '\0'
+    *p = '\0';
+    return start;
 }
+
 /**
  * \brief Parse the tail of Dialogue line
  * \param track track
  * \param event parsed data goes here
  * \param str string to parse, zero-terminated
  * \param n_ignored number of format options to skip at the beginning
-*/ 
-static int process_event_tail(ass_track_t* track, ass_event_t* event, char* str, int n_ignored)
+*/
+static int process_event_tail(ASS_Track *track, ASS_Event *event,
+                              char *str, int n_ignored)
 {
-	char* token;
-	char* tname;
-	char* p = str;
-	int i;
-	ass_event_t* target = event;
+    char *token;
+    char *tname;
+    char *p = str;
+    int i;
+    ASS_Event *target = event;
 
-	char* format = strdup(track->event_format);
-	char* q = format; // format scanning pointer
+    char *format = strdup(track->event_format);
+    char *q = format;           // format scanning pointer
 
-	if (track->n_styles == 0) {
-		// add "Default" style to the end
-		// will be used if track does not contain a default style (or even does not contain styles at all)
-		int sid = ass_alloc_style(track);
-		track->styles[sid].Name = strdup("Default");
-		track->styles[sid].FontName = strdup("Arial");
-	}
+    if (track->n_styles == 0) {
+        // add "Default" style to the end
+        // will be used if track does not contain a default style (or even does not contain styles at all)
+        int sid = ass_alloc_style(track);
+        track->styles[sid].Name = strdup("Default");
+        track->styles[sid].FontName = strdup("Arial");
+    }
 
-	for (i = 0; i < n_ignored; ++i) {
-		NEXT(q, tname);
-	}
+    for (i = 0; i < n_ignored; ++i) {
+        NEXT(q, tname);
+    }
 
-	while (1) {
-		NEXT(q, tname);
-		if (strcasecmp(tname, "Text") == 0) {
-			char* last;
-			event->Text = strdup(p);
-			if (*event->Text != 0) {
-				last = event->Text + strlen(event->Text) - 1;
-				if (last >= event->Text && *last == '\r')
-					*last = 0;
-			}
-			mp_msg(MSGT_ASS, MSGL_DBG2, "Text = %s\n", event->Text);
-			event->Duration -= event->Start;
-			free(format);
-			return 0; // "Text" is always the last
-		}
-		NEXT(p, token);
+    while (1) {
+        NEXT(q, tname);
+        if (strcasecmp(tname, "Text") == 0) {
+            char *last;
+            event->Text = strdup(p);
+            if (*event->Text != 0) {
+                last = event->Text + strlen(event->Text) - 1;
+                if (last >= event->Text && *last == '\r')
+                    *last = 0;
+            }
+            ass_msg(track->library, MSGL_DBG2, "Text = %s", event->Text);
+            event->Duration -= event->Start;
+            free(format);
+            return 0;           // "Text" is always the last
+        }
+        NEXT(p, token);
 
-		ALIAS(End,Duration) // temporarily store end timecode in event->Duration
-		if (0) { // cool ;)
-			INTVAL(Layer)
-			STYLEVAL(Style)
-			STRVAL(Name)
-			STRVAL(Effect)
-			INTVAL(MarginL)
-			INTVAL(MarginR)
-			INTVAL(MarginV)
-			TIMEVAL(Start)
-			TIMEVAL(Duration)
-		}
-	}
-	free(format);
-	return 1;
+        ALIAS(End, Duration)    // temporarily store end timecode in event->Duration
+        if (0) {            // cool ;)
+            INTVAL(Layer)
+            STYLEVAL(Style)
+            STRVAL(Name)
+            STRVAL(Effect)
+            INTVAL(MarginL)
+            INTVAL(MarginR)
+            INTVAL(MarginV)
+            TIMEVAL(Start)
+            TIMEVAL(Duration)
+        }
+    }
+    free(format);
+    return 1;
 }
 
 /**
@@ -322,62 +357,79 @@
  * \param track track to apply overrides to
  * The format for overrides is [StyleName.]Field=Value
  */
-void process_force_style(ass_track_t* track) {
-	char **fs, *eq, *dt, *style, *tname, *token;
-	ass_style_t* target;
-	int sid;
-	char** list = track->library->style_overrides;
-	
-	if (!list) return;
-	
-	for (fs = list; *fs; ++fs) {
-		eq = strrchr(*fs, '=');
-		if (!eq)
-			continue;
-		*eq = '\0';
-		token = eq + 1;
+void ass_process_force_style(ASS_Track *track)
+{
+    char **fs, *eq, *dt, *style, *tname, *token;
+    ASS_Style *target;
+    int sid;
+    char **list = track->library->style_overrides;
 
-		dt = strrchr(*fs, '.');
-		if (dt) {
-			*dt = '\0';
-			style = *fs;
-			tname = dt + 1;
-		} else {
-			style = NULL;
-			tname = *fs;
-		}
-		for (sid = 0; sid < track->n_styles; ++sid) {
-			if (style == NULL || strcasecmp(track->styles[sid].Name, style) == 0) {
-				target = track->styles + sid;
-				if (0) {
-					STRVAL(FontName)
-					COLORVAL(PrimaryColour)
-					COLORVAL(SecondaryColour)
-					COLORVAL(OutlineColour)
-					COLORVAL(BackColour)
-					FPVAL(FontSize)
-					INTVAL(Bold)
-					INTVAL(Italic)
-					INTVAL(Underline)
-					INTVAL(StrikeOut)
-					FPVAL(Spacing)
-					INTVAL(Angle)
-					INTVAL(BorderStyle)
-					INTVAL(Alignment)
-					INTVAL(MarginL)
-					INTVAL(MarginR)
-					INTVAL(MarginV)
-					INTVAL(Encoding)
-					FPVAL(ScaleX)
-					FPVAL(ScaleY)
-					FPVAL(Outline)
-					FPVAL(Shadow)
-				}
-			}
-		}
-		*eq = '=';
-		if (dt) *dt = '.';
-	}
+    if (!list)
+        return;
+
+    for (fs = list; *fs; ++fs) {
+        eq = strrchr(*fs, '=');
+        if (!eq)
+            continue;
+        *eq = '\0';
+        token = eq + 1;
+
+        if (!strcasecmp(*fs, "PlayResX"))
+            track->PlayResX = atoi(token);
+        else if (!strcasecmp(*fs, "PlayResY"))
+            track->PlayResY = atoi(token);
+        else if (!strcasecmp(*fs, "Timer"))
+            track->Timer = ass_atof(token);
+        else if (!strcasecmp(*fs, "WrapStyle"))
+            track->WrapStyle = atoi(token);
+        else if (!strcasecmp(*fs, "ScaledBorderAndShadow"))
+            track->ScaledBorderAndShadow = parse_bool(token);
+        else if (!strcasecmp(*fs, "Kerning"))
+            track->Kerning = parse_bool(token);
+
+        dt = strrchr(*fs, '.');
+        if (dt) {
+            *dt = '\0';
+            style = *fs;
+            tname = dt + 1;
+        } else {
+            style = NULL;
+            tname = *fs;
+        }
+        for (sid = 0; sid < track->n_styles; ++sid) {
+            if (style == NULL
+                || strcasecmp(track->styles[sid].Name, style) == 0) {
+                target = track->styles + sid;
+                if (0) {
+                    STRVAL(FontName)
+                    COLORVAL(PrimaryColour)
+                    COLORVAL(SecondaryColour)
+                    COLORVAL(OutlineColour)
+                    COLORVAL(BackColour)
+                    FPVAL(FontSize)
+                    INTVAL(Bold)
+                    INTVAL(Italic)
+                    INTVAL(Underline)
+                    INTVAL(StrikeOut)
+                    FPVAL(Spacing)
+                    INTVAL(Angle)
+                    INTVAL(BorderStyle)
+                    INTVAL(Alignment)
+                    INTVAL(MarginL)
+                    INTVAL(MarginR)
+                    INTVAL(MarginV)
+                    INTVAL(Encoding)
+                    FPVAL(ScaleX)
+                    FPVAL(ScaleY)
+                    FPVAL(Outline)
+                    FPVAL(Shadow)
+                }
+            }
+        }
+        *eq = '=';
+        if (dt)
+            *dt = '.';
+    }
 }
 
 /**
@@ -385,481 +437,559 @@
  * \param track track
  * \param str string to parse, zero-terminated
  * Allocates a new style struct.
-*/ 
-static int process_style(ass_track_t* track, char *str)
+*/
+static int process_style(ASS_Track *track, char *str)
 {
 
-	char* token;
-	char* tname;
-	char* p = str;
-	char* format;
-	char* q; // format scanning pointer
-	int sid;
-	ass_style_t* style;
-	ass_style_t* target;
+    char *token;
+    char *tname;
+    char *p = str;
+    char *format;
+    char *q;                    // format scanning pointer
+    int sid;
+    ASS_Style *style;
+    ASS_Style *target;
 
-	if (!track->style_format) {
-		// no style format header
-		// probably an ancient script version
-		if (track->track_type == TRACK_TYPE_SSA)
-			track->style_format = strdup("Name, Fontname, Fontsize, PrimaryColour, SecondaryColour,"
-					"TertiaryColour, BackColour, Bold, Italic, BorderStyle, Outline,"
-					"Shadow, Alignment, MarginL, MarginR, MarginV, AlphaLevel, Encoding");
-		else
-			track->style_format = strdup("Name, Fontname, Fontsize, PrimaryColour, SecondaryColour,"
-					"OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut,"
-					"ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow,"
-					"Alignment, MarginL, MarginR, MarginV, Encoding");
-	}
+    if (!track->style_format) {
+        // no style format header
+        // probably an ancient script version
+        if (track->track_type == TRACK_TYPE_SSA)
+            track->style_format =
+                strdup
+                ("Name, Fontname, Fontsize, PrimaryColour, SecondaryColour,"
+                 "TertiaryColour, BackColour, Bold, Italic, BorderStyle, Outline,"
+                 "Shadow, Alignment, MarginL, MarginR, MarginV, AlphaLevel, Encoding");
+        else
+            track->style_format =
+                strdup
+                ("Name, Fontname, Fontsize, PrimaryColour, SecondaryColour,"
+                 "OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut,"
+                 "ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow,"
+                 "Alignment, MarginL, MarginR, MarginV, Encoding");
+    }
 
-	q = format = strdup(track->style_format);
-	
-	mp_msg(MSGT_ASS, MSGL_V, "[%p] Style: %s\n", track, str);
-	
-	sid = ass_alloc_style(track);
+    q = format = strdup(track->style_format);
 
-	style = track->styles + sid;
-	target = style;
-// fill style with some default values
-	style->ScaleX = 100.;
-	style->ScaleY = 100.;
-	
-	while (1) {
-		NEXT(q, tname);
-		NEXT(p, token);
-		
-//		ALIAS(TertiaryColour,OutlineColour) // ignore TertiaryColour; it appears only in SSA, and is overridden by BackColour
-			
-		if (0) { // cool ;)
-			STRVAL(Name)
-				if ((strcmp(target->Name, "Default")==0) || (strcmp(target->Name, "*Default")==0))
-					track->default_style = sid;
-			STRVAL(FontName)
-			COLORVAL(PrimaryColour)
-			COLORVAL(SecondaryColour)
-			COLORVAL(OutlineColour) // TertiaryColor
-			COLORVAL(BackColour)
-				// SSA uses BackColour for both outline and shadow
-				// this will destroy SSA's TertiaryColour, but i'm not going to use it anyway
-				if (track->track_type == TRACK_TYPE_SSA)
-					target->OutlineColour = target->BackColour;
-			FPVAL(FontSize)
-			INTVAL(Bold)
-			INTVAL(Italic)
-			INTVAL(Underline)
-			INTVAL(StrikeOut)
-			FPVAL(Spacing)
-			INTVAL(Angle)
-			INTVAL(BorderStyle)
-			INTVAL(Alignment)
-				if (track->track_type == TRACK_TYPE_ASS)
-					target->Alignment = numpad2align(target->Alignment);
-			INTVAL(MarginL)
-			INTVAL(MarginR)
-			INTVAL(MarginV)
-			INTVAL(Encoding)
-			FPVAL(ScaleX)
-			FPVAL(ScaleY)
-			FPVAL(Outline)
-			FPVAL(Shadow)
-		}
-	}
-	style->ScaleX /= 100.;
-	style->ScaleY /= 100.;
-	style->Bold = !!style->Bold;
-	style->Italic = !!style->Italic;
-	style->Underline = !!style->Underline;
-	if (!style->Name)
-		style->Name = strdup("Default");
-	if (!style->FontName)
-		style->FontName = strdup("Arial");
-	free(format);
-	return 0;
-	
+    ass_msg(track->library, MSGL_V, "[%p] Style: %s", track, str);
+
+    sid = ass_alloc_style(track);
+
+    style = track->styles + sid;
+    target = style;
+
+    // fill style with some default values
+    style->ScaleX = 100.;
+    style->ScaleY = 100.;
+
+    while (1) {
+        NEXT(q, tname);
+        NEXT(p, token);
+
+        if (0) {                // cool ;)
+            STRVAL(Name)
+            if ((strcmp(target->Name, "Default") == 0)
+                || (strcmp(target->Name, "*Default") == 0))
+            track->default_style = sid;
+            STRVAL(FontName)
+            COLORVAL(PrimaryColour)
+            COLORVAL(SecondaryColour)
+            COLORVAL(OutlineColour) // TertiaryColor
+            COLORVAL(BackColour)
+            // SSA uses BackColour for both outline and shadow
+            // this will destroy SSA's TertiaryColour, but i'm not going to use it anyway
+            if (track->track_type == TRACK_TYPE_SSA)
+                target->OutlineColour = target->BackColour;
+            FPVAL(FontSize)
+            INTVAL(Bold)
+            INTVAL(Italic)
+            INTVAL(Underline)
+            INTVAL(StrikeOut)
+            FPVAL(Spacing)
+            INTVAL(Angle)
+            INTVAL(BorderStyle)
+            INTVAL(Alignment)
+            if (track->track_type == TRACK_TYPE_ASS)
+                target->Alignment = numpad2align(target->Alignment);
+            INTVAL(MarginL)
+            INTVAL(MarginR)
+            INTVAL(MarginV)
+            INTVAL(Encoding)
+            FPVAL(ScaleX)
+            FPVAL(ScaleY)
+            FPVAL(Outline)
+            FPVAL(Shadow)
+        }
+    }
+    style->ScaleX /= 100.;
+    style->ScaleY /= 100.;
+    style->Bold = !!style->Bold;
+    style->Italic = !!style->Italic;
+    style->Underline = !!style->Underline;
+    if (!style->Name)
+        style->Name = strdup("Default");
+    if (!style->FontName)
+        style->FontName = strdup("Arial");
+    free(format);
+    return 0;
+
 }
 
-static int process_styles_line(ass_track_t* track, char *str)
+static int process_styles_line(ASS_Track *track, char *str)
 {
-	if (!strncmp(str,"Format:", 7)) {
-		char* p = str + 7;
-		skip_spaces(&p);
-		track->style_format = strdup(p);
-		mp_msg(MSGT_ASS, MSGL_DBG2, "Style format: %s\n", track->style_format);
-	} else if (!strncmp(str,"Style:", 6)) {
-		char* p = str + 6;
-		skip_spaces(&p);
-		process_style(track, p);
-	}
-	return 0;
+    if (!strncmp(str, "Format:", 7)) {
+        char *p = str + 7;
+        skip_spaces(&p);
+        track->style_format = strdup(p);
+        ass_msg(track->library, MSGL_DBG2, "Style format: %s",
+               track->style_format);
+    } else if (!strncmp(str, "Style:", 6)) {
+        char *p = str + 6;
+        skip_spaces(&p);
+        process_style(track, p);
+    }
+    return 0;
 }
 
-static int process_info_line(ass_track_t* track, char *str)
+static int process_info_line(ASS_Track *track, char *str)
 {
-	if (!strncmp(str, "PlayResX:", 9)) {
-		track->PlayResX = atoi(str + 9);
-	} else if (!strncmp(str,"PlayResY:", 9)) {
-		track->PlayResY = atoi(str + 9);
-	} else if (!strncmp(str,"Timer:", 6)) {
-		track->Timer = atof(str + 6);
-	} else if (!strncmp(str,"WrapStyle:", 10)) {
-		track->WrapStyle = atoi(str + 10);
-	}
-	return 0;
+    if (!strncmp(str, "PlayResX:", 9)) {
+        track->PlayResX = atoi(str + 9);
+    } else if (!strncmp(str, "PlayResY:", 9)) {
+        track->PlayResY = atoi(str + 9);
+    } else if (!strncmp(str, "Timer:", 6)) {
+        track->Timer = ass_atof(str + 6);
+    } else if (!strncmp(str, "WrapStyle:", 10)) {
+        track->WrapStyle = atoi(str + 10);
+    } else if (!strncmp(str, "ScaledBorderAndShadow:", 22)) {
+        track->ScaledBorderAndShadow = parse_bool(str + 22);
+    } else if (!strncmp(str, "Kerning:", 8)) {
+        track->Kerning = parse_bool(str + 8);
+    }
+    return 0;
 }
 
-static int process_events_line(ass_track_t* track, char *str)
+static void event_format_fallback(ASS_Track *track)
 {
-	if (!strncmp(str, "Format:", 7)) {
-		char* p = str + 7;
-		skip_spaces(&p);
-		track->event_format = strdup(p);
-		mp_msg(MSGT_ASS, MSGL_DBG2, "Event format: %s\n", track->event_format);
-	} else if (!strncmp(str, "Dialogue:", 9)) {
-		// This should never be reached for embedded subtitles.
-		// They have slightly different format and are parsed in ass_process_chunk,
-		// called directly from demuxer
-		int eid;
-		ass_event_t* event;
-		
-		str += 9;
-		skip_spaces(&str);
+    track->parser_priv->state = PST_EVENTS;
+    if (track->track_type == TRACK_TYPE_SSA)
+        track->event_format = strdup("Format: Marked, Start, End, Style, "
+            "Name, MarginL, MarginR, MarginV, Effect, Text");
+    else
+        track->event_format = strdup("Format: Layer, Start, End, Style, "
+            "Actor, MarginL, MarginR, MarginV, Effect, Text");
+    ass_msg(track->library, MSGL_V,
+            "No event format found, using fallback");
+}
 
-		eid = ass_alloc_event(track);
-		event = track->events + eid;
+static int process_events_line(ASS_Track *track, char *str)
+{
+    if (!strncmp(str, "Format:", 7)) {
+        char *p = str + 7;
+        skip_spaces(&p);
+        free(track->event_format);
+        track->event_format = strdup(p);
+        ass_msg(track->library, MSGL_DBG2, "Event format: %s", track->event_format);
+    } else if (!strncmp(str, "Dialogue:", 9)) {
+        // This should never be reached for embedded subtitles.
+        // They have slightly different format and are parsed in ass_process_chunk,
+        // called directly from demuxer
+        int eid;
+        ASS_Event *event;
 
-		process_event_tail(track, event, str, 0);
-	} else {
-		mp_msg(MSGT_ASS, MSGL_V, "Not understood: %s  \n", str);
-	}
-	return 0;
+        str += 9;
+        skip_spaces(&str);
+
+        eid = ass_alloc_event(track);
+        event = track->events + eid;
+
+        // We can't parse events with event_format
+        if (!track->event_format)
+            event_format_fallback(track);
+
+        process_event_tail(track, event, str, 0);
+    } else {
+        ass_msg(track->library, MSGL_V, "Not understood: '%.30s'", str);
+    }
+    return 0;
 }
 
 // Copied from mkvtoolnix
-static unsigned char* decode_chars(unsigned char c1, unsigned char c2,
-		unsigned char c3, unsigned char c4, unsigned char* dst, int cnt)
+static unsigned char *decode_chars(unsigned char c1, unsigned char c2,
+                                   unsigned char c3, unsigned char c4,
+                                   unsigned char *dst, int cnt)
 {
-	uint32_t value;
-	unsigned char bytes[3];
-	int i;
+    uint32_t value;
+    unsigned char bytes[3];
+    int i;
 
-	value = ((c1 - 33) << 18) + ((c2 - 33) << 12) + ((c3 - 33) << 6) + (c4 - 33);
-	bytes[2] = value & 0xff;
-	bytes[1] = (value & 0xff00) >> 8;
-	bytes[0] = (value & 0xff0000) >> 16;
+    value =
+        ((c1 - 33) << 18) + ((c2 - 33) << 12) + ((c3 - 33) << 6) + (c4 -
+                                                                    33);
+    bytes[2] = value & 0xff;
+    bytes[1] = (value & 0xff00) >> 8;
+    bytes[0] = (value & 0xff0000) >> 16;
 
-	for (i = 0; i < cnt; ++i)
-		*dst++ = bytes[i];
-	return dst;
+    for (i = 0; i < cnt; ++i)
+        *dst++ = bytes[i];
+    return dst;
 }
 
-static int decode_font(ass_track_t* track)
+static int decode_font(ASS_Track *track)
 {
-	unsigned char* p;
-	unsigned char* q;
-	int i;
-	int size; // original size
-	int dsize; // decoded size
-	unsigned char* buf = 0;
+    unsigned char *p;
+    unsigned char *q;
+    int i;
+    int size;                   // original size
+    int dsize;                  // decoded size
+    unsigned char *buf = 0;
 
-	mp_msg(MSGT_ASS, MSGL_V, "font: %d bytes encoded data \n", track->parser_priv->fontdata_used);
-	size = track->parser_priv->fontdata_used;
-	if (size % 4 == 1) {
-		mp_msg(MSGT_ASS, MSGL_ERR, MSGTR_LIBASS_BadEncodedDataSize);
-		goto error_decode_font;
-	}
-	buf = malloc(size / 4 * 3 + 2);
-	q = buf;
-	for (i = 0, p = (unsigned char*)track->parser_priv->fontdata; i < size / 4; i++, p+=4) {
-		q = decode_chars(p[0], p[1], p[2], p[3], q, 3);
-	}
-	if (size % 4 == 2) {
-		q = decode_chars(p[0], p[1], 0, 0, q, 1);
-	} else if (size % 4 == 3) {
-		q = decode_chars(p[0], p[1], p[2], 0, q, 2);
-	}
-	dsize = q - buf;
-	assert(dsize <= size / 4 * 3 + 2);
-	
-	if (track->library->extract_fonts) {
-		ass_add_font(track->library, track->parser_priv->fontname, (char*)buf, dsize);
-		buf = 0;
-	}
+    ass_msg(track->library, MSGL_V, "Font: %d bytes encoded data",
+            track->parser_priv->fontdata_used);
+    size = track->parser_priv->fontdata_used;
+    if (size % 4 == 1) {
+        ass_msg(track->library, MSGL_ERR, "Bad encoded data size");
+        goto error_decode_font;
+    }
+    buf = malloc(size / 4 * 3 + 2);
+    q = buf;
+    for (i = 0, p = (unsigned char *) track->parser_priv->fontdata;
+         i < size / 4; i++, p += 4) {
+        q = decode_chars(p[0], p[1], p[2], p[3], q, 3);
+    }
+    if (size % 4 == 2) {
+        q = decode_chars(p[0], p[1], 0, 0, q, 1);
+    } else if (size % 4 == 3) {
+        q = decode_chars(p[0], p[1], p[2], 0, q, 2);
+    }
+    dsize = q - buf;
+    assert(dsize <= size / 4 * 3 + 2);
 
+    if (track->library->extract_fonts) {
+        ass_add_font(track->library, track->parser_priv->fontname,
+                     (char *) buf, dsize);
+    }
+
 error_decode_font:
-	if (buf) free(buf);
-	free(track->parser_priv->fontname);
-	free(track->parser_priv->fontdata);
-	track->parser_priv->fontname = 0;
-	track->parser_priv->fontdata = 0;
-	track->parser_priv->fontdata_size = 0;
-	track->parser_priv->fontdata_used = 0;
-	return 0;
+    free(buf);
+    free(track->parser_priv->fontname);
+    free(track->parser_priv->fontdata);
+    track->parser_priv->fontname = 0;
+    track->parser_priv->fontdata = 0;
+    track->parser_priv->fontdata_size = 0;
+    track->parser_priv->fontdata_used = 0;
+    return 0;
 }
 
-static int process_fonts_line(ass_track_t* track, char *str)
+static int process_fonts_line(ASS_Track *track, char *str)
 {
-	int len;
+    int len;
 
-	if (!strncmp(str, "fontname:", 9)) {
-		char* p = str + 9;
-		skip_spaces(&p);
-		if (track->parser_priv->fontname) {
-			decode_font(track);
-		}
-		track->parser_priv->fontname = strdup(p);
-		mp_msg(MSGT_ASS, MSGL_V, "fontname: %s\n", track->parser_priv->fontname);
-		return 0;
-	}
-	
-	if (!track->parser_priv->fontname) {
-		mp_msg(MSGT_ASS, MSGL_V, "Not understood: %s  \n", str);
-		return 0;
-	}
+    if (!strncmp(str, "fontname:", 9)) {
+        char *p = str + 9;
+        skip_spaces(&p);
+        if (track->parser_priv->fontname) {
+            decode_font(track);
+        }
+        track->parser_priv->fontname = strdup(p);
+        ass_msg(track->library, MSGL_V, "Fontname: %s",
+               track->parser_priv->fontname);
+        return 0;
+    }
 
-	len = strlen(str);
-	if (len > 80) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FontLineTooLong, len, str);
-		return 0;
-	}
-	if (track->parser_priv->fontdata_used + len > track->parser_priv->fontdata_size) {
-		track->parser_priv->fontdata_size += 100 * 1024;
-		track->parser_priv->fontdata = realloc(track->parser_priv->fontdata, track->parser_priv->fontdata_size);
-	}
-	memcpy(track->parser_priv->fontdata + track->parser_priv->fontdata_used, str, len);
-	track->parser_priv->fontdata_used += len;
-	
-	return 0;
+    if (!track->parser_priv->fontname) {
+        ass_msg(track->library, MSGL_V, "Not understood: '%s'", str);
+        return 0;
+    }
+
+    len = strlen(str);
+    if (len > 80) {
+        ass_msg(track->library, MSGL_WARN, "Font line too long: %d, %s",
+                len, str);
+        return 0;
+    }
+    if (track->parser_priv->fontdata_used + len >
+        track->parser_priv->fontdata_size) {
+        track->parser_priv->fontdata_size += 100 * 1024;
+        track->parser_priv->fontdata =
+            realloc(track->parser_priv->fontdata,
+                    track->parser_priv->fontdata_size);
+    }
+    memcpy(track->parser_priv->fontdata + track->parser_priv->fontdata_used,
+           str, len);
+    track->parser_priv->fontdata_used += len;
+
+    return 0;
 }
 
 /**
  * \brief Parse a header line
  * \param track track
  * \param str string to parse, zero-terminated
-*/ 
-static int process_line(ass_track_t* track, char *str)
+*/
+static int process_line(ASS_Track *track, char *str)
 {
-	if (strstr(str, "[Script Info]")) { // FIXME: strstr to skip possible BOM at the beginning of the script
-		track->parser_priv->state = PST_INFO;
-	} else if (!strncmp(str, "[V4 Styles]", 11)) {
-		track->parser_priv->state = PST_STYLES;
-		track->track_type = TRACK_TYPE_SSA;
-	} else if (!strncmp(str, "[V4+ Styles]", 12)) {
-		track->parser_priv->state = PST_STYLES;
-		track->track_type = TRACK_TYPE_ASS;
-	} else if (!strncmp(str, "[Events]", 8)) {
-		track->parser_priv->state = PST_EVENTS;
-	} else if (!strncmp(str, "[Fonts]", 7)) {
-		track->parser_priv->state = PST_FONTS;
-	} else {
-		switch (track->parser_priv->state) {
-		case PST_INFO:
-			process_info_line(track, str);
-			break;
-		case PST_STYLES:
-			process_styles_line(track, str);
-			break;
-		case PST_EVENTS:
-			process_events_line(track, str);
-			break;
-		case PST_FONTS:
-			process_fonts_line(track, str);
-			break;
-		default:
-			break;
-		}
-	}
+    if (!strncasecmp(str, "[Script Info]", 13)) {
+        track->parser_priv->state = PST_INFO;
+    } else if (!strncasecmp(str, "[V4 Styles]", 11)) {
+        track->parser_priv->state = PST_STYLES;
+        track->track_type = TRACK_TYPE_SSA;
+    } else if (!strncasecmp(str, "[V4+ Styles]", 12)) {
+        track->parser_priv->state = PST_STYLES;
+        track->track_type = TRACK_TYPE_ASS;
+    } else if (!strncasecmp(str, "[Events]", 8)) {
+        track->parser_priv->state = PST_EVENTS;
+    } else if (!strncasecmp(str, "[Fonts]", 7)) {
+        track->parser_priv->state = PST_FONTS;
+    } else {
+        switch (track->parser_priv->state) {
+        case PST_INFO:
+            process_info_line(track, str);
+            break;
+        case PST_STYLES:
+            process_styles_line(track, str);
+            break;
+        case PST_EVENTS:
+            process_events_line(track, str);
+            break;
+        case PST_FONTS:
+            process_fonts_line(track, str);
+            break;
+        default:
+            break;
+        }
+    }
 
-	// there is no explicit end-of-font marker in ssa/ass
-	if ((track->parser_priv->state != PST_FONTS) && (track->parser_priv->fontname))
-		decode_font(track);
+    // there is no explicit end-of-font marker in ssa/ass
+    if ((track->parser_priv->state != PST_FONTS)
+        && (track->parser_priv->fontname))
+        decode_font(track);
 
-	return 0;
+    return 0;
 }
 
-static int process_text(ass_track_t* track, char* str)
+static int process_text(ASS_Track *track, char *str)
 {
-	char* p = str;
-	while(1) {
-		char* q;
-		for (;((*p=='\r')||(*p=='\n'));++p) {}
-		for (q=p; ((*q!='\0')&&(*q!='\r')&&(*q!='\n')); ++q) {};
-		if (q==p)
-			break;
-		if (*q != '\0')
-			*(q++) = '\0';
-		process_line(track, p);
-		if (*q == '\0')
-			break;
-		p = q;
-	}
-	return 0;
+    char *p = str;
+    while (1) {
+        char *q;
+        while (1) {
+            if ((*p == '\r') || (*p == '\n'))
+                ++p;
+            else if (p[0] == '\xef' && p[1] == '\xbb' && p[2] == '\xbf')
+                p += 3;         // U+FFFE (BOM)
+            else
+                break;
+        }
+        for (q = p; ((*q != '\0') && (*q != '\r') && (*q != '\n')); ++q) {
+        };
+        if (q == p)
+            break;
+        if (*q != '\0')
+            *(q++) = '\0';
+        process_line(track, p);
+        if (*q == '\0')
+            break;
+        p = q;
+    }
+    return 0;
 }
 
 /**
+ * \brief Process a chunk of subtitle stream data.
+ * \param track track
+ * \param data string to parse
+ * \param size length of data
+*/
+void ass_process_data(ASS_Track *track, char *data, int size)
+{
+    char *str = malloc(size + 1);
+
+    memcpy(str, data, size);
+    str[size] = '\0';
+
+    ass_msg(track->library, MSGL_V, "Event: %s", str);
+    process_text(track, str);
+    free(str);
+}
+
+/**
  * \brief Process CodecPrivate section of subtitle stream
  * \param track track
  * \param data string to parse
  * \param size length of data
  CodecPrivate section contains [Stream Info] and [V4+ Styles] ([V4 Styles] for SSA) sections
-*/ 
-void ass_process_codec_private(ass_track_t* track, char *data, int size)
+*/
+void ass_process_codec_private(ASS_Track *track, char *data, int size)
 {
-	char* str = malloc(size + 1);
+    ass_process_data(track, data, size);
 
-	memcpy(str, data, size);
-	str[size] = '\0';
+    // probably an mkv produced by ancient mkvtoolnix
+    // such files don't have [Events] and Format: headers
+    if (!track->event_format)
+        event_format_fallback(track);
 
-	process_text(track, str);
-	free(str);
-
-	if (!track->event_format) {
-		// probably an mkv produced by ancient mkvtoolnix
-		// such files don't have [Events] and Format: headers
-		track->parser_priv->state = PST_EVENTS;
-		if (track->track_type == TRACK_TYPE_SSA)
-			track->event_format = strdup("Format: Marked, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text");
-		else
-			track->event_format = strdup("Format: Layer, Start, End, Style, Actor, MarginL, MarginR, MarginV, Effect, Text");
-	}
-
-	process_force_style(track);
+    ass_process_force_style(track);
 }
 
-static int check_duplicate_event(ass_track_t* track, int ReadOrder)
+static int check_duplicate_event(ASS_Track *track, int ReadOrder)
 {
-	int i;
-	for (i = 0; i<track->n_events - 1; ++i) // ignoring last event, it is the one we are comparing with
-		if (track->events[i].ReadOrder == ReadOrder)
-			return 1;
-	return 0;
+    int i;
+    for (i = 0; i < track->n_events - 1; ++i)   // ignoring last event, it is the one we are comparing with
+        if (track->events[i].ReadOrder == ReadOrder)
+            return 1;
+    return 0;
 }
 
 /**
- * \brief Process a chunk of subtitle stream data. In matroska, this containes exactly 1 event (or a commentary)
+ * \brief Process a chunk of subtitle stream data. In Matroska, this contains exactly 1 event (or a commentary).
  * \param track track
  * \param data string to parse
  * \param size length of data
  * \param timecode starting time of the event (milliseconds)
  * \param duration duration of the event (milliseconds)
-*/ 
-void ass_process_chunk(ass_track_t* track, char *data, int size, long long timecode, long long duration)
+*/
+void ass_process_chunk(ASS_Track *track, char *data, int size,
+                       long long timecode, long long duration)
 {
-	char* str;
-	int eid;
-	char* p;
-	char* token;
-	ass_event_t* event;
+    char *str;
+    int eid;
+    char *p;
+    char *token;
+    ASS_Event *event;
 
-	if (!track->event_format) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_EventFormatHeaderMissing);
-		return;
-	}
-	
-	str = malloc(size + 1);
-	memcpy(str, data, size);
-	str[size] = '\0';
-	mp_msg(MSGT_ASS, MSGL_V, "event at %" PRId64 ", +%" PRId64 ": %s  \n", (int64_t)timecode, (int64_t)duration, str);
+    if (!track->event_format) {
+        ass_msg(track->library, MSGL_WARN, "Event format header missing");
+        return;
+    }
 
-	eid = ass_alloc_event(track);
-	event = track->events + eid;
+    str = malloc(size + 1);
+    memcpy(str, data, size);
+    str[size] = '\0';
+    ass_msg(track->library, MSGL_V, "Event at %" PRId64 ", +%" PRId64 ": %s",
+           (int64_t) timecode, (int64_t) duration, str);
 
-	p = str;
-	
-	do { 
-		NEXT(p, token);
-		event->ReadOrder = atoi(token);
-		if (check_duplicate_event(track, event->ReadOrder))
-			break;
+    eid = ass_alloc_event(track);
+    event = track->events + eid;
 
-		NEXT(p, token);
-		event->Layer = atoi(token);
+    p = str;
 
-		process_event_tail(track, event, p, 3);
+    do {
+        NEXT(p, token);
+        event->ReadOrder = atoi(token);
+        if (check_duplicate_event(track, event->ReadOrder))
+            break;
 
-		event->Start = timecode;
-		event->Duration = duration;
-		
-		free(str);
-		return;
-//		dump_events(tid);
-	} while (0);
-	// some error
-	ass_free_event(track, eid);
-	track->n_events--;
-	free(str);
+        NEXT(p, token);
+        event->Layer = atoi(token);
+
+        process_event_tail(track, event, p, 3);
+
+        event->Start = timecode;
+        event->Duration = duration;
+
+        free(str);
+        return;
+//              dump_events(tid);
+    } while (0);
+    // some error
+    ass_free_event(track, eid);
+    track->n_events--;
+    free(str);
 }
 
-#ifdef USE_ICONV
+/**
+ * \brief Flush buffered events.
+ * \param track track
+*/
+void ass_flush_events(ASS_Track *track)
+{
+    if (track->events) {
+        int eid;
+        for (eid = 0; eid < track->n_events; eid++)
+            ass_free_event(track, eid);
+        track->n_events = 0;
+    }
+}
+
+#ifdef CONFIG_ICONV
 /** \brief recode buffer to utf-8
  * constraint: codepage != 0
  * \param data pointer to text buffer
  * \param size buffer size
  * \return a pointer to recoded buffer, caller is responsible for freeing it
 **/
-static char* sub_recode(char* data, size_t size, char* codepage)
+static char *sub_recode(ASS_Library *library, char *data, size_t size,
+                        char *codepage)
 {
-	static iconv_t icdsc = (iconv_t)(-1);
-	char* tocp = "UTF-8";
-	char* outbuf;
-	assert(codepage);
+    iconv_t icdsc;
+    char *tocp = "UTF-8";
+    char *outbuf;
+    assert(codepage);
 
-	{
-		char* cp_tmp = codepage ? strdup(codepage) : 0;
-#ifdef HAVE_ENCA
-		char enca_lang[3], enca_fallback[100];
-		if (sscanf(codepage, "enca:%2s:%99s", enca_lang, enca_fallback) == 2
-				|| sscanf(codepage, "ENCA:%2s:%99s", enca_lang, enca_fallback) == 2) {
-			cp_tmp = guess_buffer_cp((unsigned char*)data, size, enca_lang, enca_fallback);
-		}
+    {
+        const char *cp_tmp = codepage;
+#ifdef CONFIG_ENCA
+        char enca_lang[3], enca_fallback[100];
+        if (sscanf(codepage, "enca:%2s:%99s", enca_lang, enca_fallback) == 2
+            || sscanf(codepage, "ENCA:%2s:%99s", enca_lang,
+                      enca_fallback) == 2) {
+            cp_tmp =
+                ass_guess_buffer_cp(library, (unsigned char *) data, size,
+                                    enca_lang, enca_fallback);
+        }
 #endif
-		if ((icdsc = iconv_open (tocp, cp_tmp)) != (iconv_t)(-1)){
-			mp_msg(MSGT_ASS,MSGL_V,"LIBSUB: opened iconv descriptor.\n");
-		} else
-			mp_msg(MSGT_ASS,MSGL_ERR,MSGTR_LIBASS_ErrorOpeningIconvDescriptor);
-#ifdef HAVE_ENCA
-		if (cp_tmp) free(cp_tmp);
-#endif
-	}
+        if ((icdsc = iconv_open(tocp, cp_tmp)) != (iconv_t) (-1)) {
+            ass_msg(library, MSGL_V, "Opened iconv descriptor");
+        } else
+            ass_msg(library, MSGL_ERR, "Error opening iconv descriptor");
+    }
 
-	{
-		size_t osize = size;
-		size_t ileft = size;
-		size_t oleft = size - 1;
-		char* ip;
-		char* op;
-		size_t rc;
-		
-		outbuf = malloc(size);
-		ip = data;
-		op = outbuf;
-		
-		while (ileft) {
-			rc = iconv(icdsc, &ip, &ileft, &op, &oleft);
-			if (rc == (size_t)(-1)) {
-				if (errno == E2BIG) {
-					int offset = op - outbuf;
-					outbuf = (char*)realloc(outbuf, osize + size);
-					op = outbuf + offset;
-					osize += size;
-					oleft += size;
-				} else {
-					mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorRecodingFile);
-					return NULL;
-				}
-			}
-		}
-		outbuf[osize - oleft - 1] = 0;
-	}
+    {
+        size_t osize = size;
+        size_t ileft = size;
+        size_t oleft = size - 1;
+        char *ip;
+        char *op;
+        size_t rc;
+        int clear = 0;
 
-	if (icdsc != (iconv_t)(-1)) {
-		(void)iconv_close(icdsc);
-		icdsc = (iconv_t)(-1);
-		mp_msg(MSGT_ASS,MSGL_V,"LIBSUB: closed iconv descriptor.\n");
-	}
-	
-	return outbuf;
+        outbuf = malloc(osize);
+        ip = data;
+        op = outbuf;
+
+        while (1) {
+            if (ileft)
+                rc = iconv(icdsc, &ip, &ileft, &op, &oleft);
+            else {              // clear the conversion state and leave
+                clear = 1;
+                rc = iconv(icdsc, NULL, NULL, &op, &oleft);
+            }
+            if (rc == (size_t) (-1)) {
+                if (errno == E2BIG) {
+                    size_t offset = op - outbuf;
+                    outbuf = (char *) realloc(outbuf, osize + size);
+                    op = outbuf + offset;
+                    osize += size;
+                    oleft += size;
+                } else {
+                    ass_msg(library, MSGL_WARN, "Error recoding file");
+                    return NULL;
+                }
+            } else if (clear)
+                break;
+        }
+        outbuf[osize - oleft - 1] = 0;
+    }
+
+    if (icdsc != (iconv_t) (-1)) {
+        (void) iconv_close(icdsc);
+        icdsc = (iconv_t) (-1);
+        ass_msg(library, MSGL_V, "Closed iconv descriptor");
+    }
+
+    return outbuf;
 }
-#endif // ICONV
+#endif                          // ICONV
 
 /**
  * \brief read file contents into newly allocated buffer
@@ -867,86 +997,83 @@
  * \param bufsize out: file size
  * \return pointer to file contents. Caller is responsible for its deallocation.
  */
-static char* read_file(char* fname, size_t *bufsize)
+static char *read_file(ASS_Library *library, char *fname, size_t *bufsize)
 {
-	int res;
-	long sz;
-	long bytes_read;
-	char* buf;
+    int res;
+    long sz;
+    long bytes_read;
+    char *buf;
 
-	FILE* fp = fopen(fname, "rb");
-	if (!fp) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FopenFailed, fname);
-		return 0;
-	}
-	res = fseek(fp, 0, SEEK_END);
-	if (res == -1) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FseekFailed, fname);
-		fclose(fp);
-		return 0;
-	}
-	
-	sz = ftell(fp);
-	rewind(fp);
+    FILE *fp = fopen(fname, "rb");
+    if (!fp) {
+        ass_msg(library, MSGL_WARN,
+                "ass_read_file(%s): fopen failed", fname);
+        return 0;
+    }
+    res = fseek(fp, 0, SEEK_END);
+    if (res == -1) {
+        ass_msg(library, MSGL_WARN,
+                "ass_read_file(%s): fseek failed", fname);
+        fclose(fp);
+        return 0;
+    }
 
-	if (sz > 10*1024*1024) {
-		mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_RefusingToLoadSubtitlesLargerThan10M, fname);
-		fclose(fp);
-		return 0;
-	}
-	
-	mp_msg(MSGT_ASS, MSGL_V, "file size: %ld\n", sz);
-	
-	buf = malloc(sz + 1);
-	assert(buf);
-	bytes_read = 0;
-	do {
-		res = fread(buf + bytes_read, 1, sz - bytes_read, fp);
-		if (res <= 0) {
-			mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_ReadFailed, errno, strerror(errno));
-			fclose(fp);
-			free(buf);
-			return 0;
-		}
-		bytes_read += res;
-	} while (sz - bytes_read > 0);
-	buf[sz] = '\0';
-	fclose(fp);
-	
-	if (bufsize)
-		*bufsize = sz;
-	return buf;
+    sz = ftell(fp);
+    rewind(fp);
+
+    ass_msg(library, MSGL_V, "File size: %ld", sz);
+
+    buf = malloc(sz + 1);
+    assert(buf);
+    bytes_read = 0;
+    do {
+        res = fread(buf + bytes_read, 1, sz - bytes_read, fp);
+        if (res <= 0) {
+            ass_msg(library, MSGL_INFO, "Read failed, %d: %s", errno,
+                    strerror(errno));
+            fclose(fp);
+            free(buf);
+            return 0;
+        }
+        bytes_read += res;
+    } while (sz - bytes_read > 0);
+    buf[sz] = '\0';
+    fclose(fp);
+
+    if (bufsize)
+        *bufsize = sz;
+    return buf;
 }
 
 /*
  * \param buf pointer to subtitle text in utf-8
  */
-static ass_track_t* parse_memory(ass_library_t* library, char* buf)
+static ASS_Track *parse_memory(ASS_Library *library, char *buf)
 {
-	ass_track_t* track;
-	int i;
-	
-	track = ass_new_track(library);
-	
-	// process header
-	process_text(track, buf);
+    ASS_Track *track;
+    int i;
 
-	// external SSA/ASS subs does not have ReadOrder field
-	for (i = 0; i < track->n_events; ++i)
-		track->events[i].ReadOrder = i;
+    track = ass_new_track(library);
 
-	// there is no explicit end-of-font marker in ssa/ass
-	if (track->parser_priv->fontname)
-		decode_font(track);
+    // process header
+    process_text(track, buf);
 
-	if (track->track_type == TRACK_TYPE_UNKNOWN) {
-		ass_free_track(track);
-		return 0;
-	}
+    // external SSA/ASS subs does not have ReadOrder field
+    for (i = 0; i < track->n_events; ++i)
+        track->events[i].ReadOrder = i;
 
-	process_force_style(track);
+    // there is no explicit end-of-font marker in ssa/ass
+    if (track->parser_priv->fontname)
+        decode_font(track);
 
-	return track;
+    if (track->track_type == TRACK_TYPE_UNKNOWN) {
+        ass_free_track(track);
+        return 0;
+    }
+
+    ass_process_force_style(track);
+
+    return track;
 }
 
 /**
@@ -956,52 +1083,57 @@
  * \param bufsize size of buffer
  * \param codepage recode buffer contents from given codepage
  * \return newly allocated track
-*/ 
-ass_track_t* ass_read_memory(ass_library_t* library, char* buf, size_t bufsize, char* codepage)
+*/
+ASS_Track *ass_read_memory(ASS_Library *library, char *buf,
+                           size_t bufsize, char *codepage)
 {
-	ass_track_t* track;
-	int need_free = 0;
-	
-	if (!buf)
-		return 0;
-	
-#ifdef USE_ICONV
-	if (codepage)
-		buf = sub_recode(buf, bufsize, codepage);
-	if (!buf)
-		return 0;
-	else
-		need_free = 1;
+    ASS_Track *track;
+    int need_free = 0;
+
+    if (!buf)
+        return 0;
+
+#ifdef CONFIG_ICONV
+    if (codepage) {
+        buf = sub_recode(library, buf, bufsize, codepage);
+        if (!buf)
+            return 0;
+        else
+            need_free = 1;
+    }
 #endif
-	track = parse_memory(library, buf);
-	if (need_free)
-		free(buf);
-	if (!track)
-		return 0;
+    track = parse_memory(library, buf);
+    if (need_free)
+        free(buf);
+    if (!track)
+        return 0;
 
-	mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_AddedSubtitleFileMemory, track->n_styles, track->n_events);
-	return track;
+    ass_msg(library, MSGL_INFO, "Added subtitle file: "
+            "<memory> (%d styles, %d events)",
+            track->n_styles, track->n_events);
+    return track;
 }
 
-char* read_file_recode(char* fname, char* codepage, int* size)
+static char *read_file_recode(ASS_Library *library, char *fname,
+                              char *codepage, size_t *size)
 {
-	char* buf;
-	size_t bufsize;
-	
-	buf = read_file(fname, &bufsize);
-	if (!buf)
-		return 0;
-#ifdef USE_ICONV
-	if (codepage) {
-		 char* tmpbuf = sub_recode(buf, bufsize, codepage);
-		 free(buf);
-		 buf = tmpbuf;
-	}
-	if (!buf)
-		return 0;
+    char *buf;
+    size_t bufsize;
+
+    buf = read_file(library, fname, &bufsize);
+    if (!buf)
+        return 0;
+#ifdef CONFIG_ICONV
+    if (codepage) {
+        char *tmpbuf = sub_recode(library, buf, bufsize, codepage);
+        free(buf);
+        buf = tmpbuf;
+    }
+    if (!buf)
+        return 0;
 #endif
-	*size = bufsize;
-	return buf;
+    *size = bufsize;
+    return buf;
 }
 
 /**
@@ -1010,83 +1142,99 @@
  * \param fname file name
  * \param codepage recode buffer contents from given codepage
  * \return newly allocated track
-*/ 
-ass_track_t* ass_read_file(ass_library_t* library, char* fname, char* codepage)
+*/
+ASS_Track *ass_read_file(ASS_Library *library, char *fname,
+                         char *codepage)
 {
-	char* buf;
-	ass_track_t* track;
-	size_t bufsize;
+    char *buf;
+    ASS_Track *track;
+    size_t bufsize;
 
-	buf = read_file_recode(fname, codepage, &bufsize);
-	if (!buf)
-		return 0;
-	track = parse_memory(library, buf);
-	free(buf);
-	if (!track)
-		return 0;
-	
-	track->name = strdup(fname);
+    buf = read_file_recode(library, fname, codepage, &bufsize);
+    if (!buf)
+        return 0;
+    track = parse_memory(library, buf);
+    free(buf);
+    if (!track)
+        return 0;
 
-	mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_AddedSubtitleFileFname, fname, track->n_styles, track->n_events);
-	
-//	dump_events(forced_tid);
-	return track;
+    track->name = strdup(fname);
+
+    ass_msg(library, MSGL_INFO,
+            "Added subtitle file: '%s' (%d styles, %d events)",
+            fname, track->n_styles, track->n_events);
+
+    return track;
 }
 
 /**
  * \brief read styles from file into already initialized track
  */
-int ass_read_styles(ass_track_t* track, char* fname, char* codepage)
+int ass_read_styles(ASS_Track *track, char *fname, char *codepage)
 {
-	char* buf;
-	parser_state_t old_state;
-	size_t sz;
+    char *buf;
+    ParserState old_state;
+    size_t sz;
 
-	buf = read_file(fname, &sz);
-	if (!buf)
-		return 1;
-#ifdef USE_ICONV
-	if (codepage) {
-		char* tmpbuf;
-		tmpbuf = sub_recode(buf, sz, codepage);
-		free(buf);
-		buf = tmpbuf;
-	}
-	if (!buf)
-		return 0;
+    buf = read_file(track->library, fname, &sz);
+    if (!buf)
+        return 1;
+#ifdef CONFIG_ICONV
+    if (codepage) {
+        char *tmpbuf;
+        tmpbuf = sub_recode(track->library, buf, sz, codepage);
+        free(buf);
+        buf = tmpbuf;
+    }
+    if (!buf)
+        return 0;
 #endif
 
-	old_state = track->parser_priv->state;
-	track->parser_priv->state = PST_STYLES;
-	process_text(track, buf);
-	track->parser_priv->state = old_state;
+    old_state = track->parser_priv->state;
+    track->parser_priv->state = PST_STYLES;
+    process_text(track, buf);
+    track->parser_priv->state = old_state;
 
-	return 0;
+    return 0;
 }
 
-long long ass_step_sub(ass_track_t* track, long long now, int movement) {
-	int i;
+long long ass_step_sub(ASS_Track *track, long long now, int movement)
+{
+    int i;
 
-	if (movement == 0) return 0;
-	if (track->n_events == 0) return 0;
-	
-	if (movement < 0)
-		for (i = 0; (i < track->n_events) && ((long long)(track->events[i].Start + track->events[i].Duration) <= now); ++i) {}
-	else
-		for (i = track->n_events - 1; (i >= 0) && ((long long)(track->events[i].Start) > now); --i) {}
-	
-	// -1 and n_events are ok
-	assert(i >= -1); assert(i <= track->n_events);
-	i += movement;
-	if (i < 0) i = 0;
-	if (i >= track->n_events) i = track->n_events - 1;
-	return ((long long)track->events[i].Start) - now;
+    if (movement == 0)
+        return 0;
+    if (track->n_events == 0)
+        return 0;
+
+    if (movement < 0)
+        for (i = 0;
+             (i < track->n_events)
+             &&
+             ((long long) (track->events[i].Start +
+                           track->events[i].Duration) <= now); ++i) {
+    } else
+        for (i = track->n_events - 1;
+             (i >= 0) && ((long long) (track->events[i].Start) > now);
+             --i) {
+        }
+
+    // -1 and n_events are ok
+    assert(i >= -1);
+    assert(i <= track->n_events);
+    i += movement;
+    if (i < 0)
+        i = 0;
+    if (i >= track->n_events)
+        i = track->n_events - 1;
+    return ((long long) track->events[i].Start) - now;
 }
 
-ass_track_t* ass_new_track(ass_library_t* library) {
-	ass_track_t* track = calloc(1, sizeof(ass_track_t));
-	track->library = library;
-	track->parser_priv = calloc(1, sizeof(parser_priv_t));
-	return track;
+ASS_Track *ass_new_track(ASS_Library *library)
+{
+    ASS_Track *track = calloc(1, sizeof(ASS_Track));
+    track->library = library;
+    track->ScaledBorderAndShadow = 1;
+    track->parser_priv = calloc(1, sizeof(ASS_ParserPriv));
+    return track;
 }
-

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.h	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,209 +1,385 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#ifndef LIBASS_ASS_H
+#define LIBASS_ASS_H
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#ifndef ASS_H
-#define ASS_H
-
+#include <stdio.h>
+#include <stdarg.h>
 #include "ass_types.h"
 
-/// Libass renderer object. Contents are private.
-typedef struct ass_renderer_s ass_renderer_t;
+#define LIBASS_VERSION 0x00911000
 
-/// a linked list of images produced by ass renderer
-typedef struct ass_image_s {
-	int w, h; // bitmap width/height
-	int stride; // bitmap stride
-	unsigned char* bitmap; // 1bpp stride*h alpha buffer
-	uint32_t color; // RGBA
-	int dst_x, dst_y; // bitmap placement inside the video frame
+/*
+ * A linked list of images produced by an ass renderer.
+ *
+ * These images have to be rendered in-order for the correct screen
+ * composition.  The libass renderer clips these bitmaps to the frame size.
+ * w/h can be zero, in this case the bitmap should not be rendered at all.
+ * The last bitmap row is not guaranteed to be padded up to stride size,
+ * e.g. in the worst case a bitmap has the size stride * (h - 1) + w.
+ */
+typedef struct ass_image {
+    int w, h;                   // Bitmap width/height
+    int stride;                 // Bitmap stride
+    unsigned char *bitmap;      // 1bpp stride*h alpha buffer
+                                // Note: the last row may not be padded to
+                                // bitmap stride!
+    uint32_t color;             // Bitmap color and alpha, RGBA
+    int dst_x, dst_y;           // Bitmap placement inside the video frame
 
-	struct ass_image_s* next; // linked list
-} ass_image_t;
+    struct ass_image *next;   // Next image, or NULL
+} ASS_Image;
 
-/// Hinting type
-typedef enum {ASS_HINTING_NONE = 0,
-	      ASS_HINTING_LIGHT,
-	      ASS_HINTING_NORMAL,
-	      ASS_HINTING_NATIVE
-} ass_hinting_t;
+/*
+ * Hinting type. (see ass_set_hinting below)
+ *
+ * FreeType's native hinter is still buggy sometimes and it is recommended
+ * to use the light autohinter, ASS_HINTING_LIGHT, instead.  For best
+ * compatibility with problematic fonts, disable hinting.
+ */
+typedef enum {
+    ASS_HINTING_NONE = 0,
+    ASS_HINTING_LIGHT,
+    ASS_HINTING_NORMAL,
+    ASS_HINTING_NATIVE
+} ASS_Hinting;
 
 /**
- * \brief initialize the library
+ * \brief Initialize the library.
  * \return library handle or NULL if failed
  */
-ass_library_t* ass_library_init(void);
+ASS_Library *ass_library_init(void);
 
 /**
- * \brief finalize the library
+ * \brief Finalize the library
  * \param priv library handle
  */
-void ass_library_done(ass_library_t*);
+void ass_library_done(ASS_Library *priv);
 
 /**
- * \brief set private font directory
- * It is used for saving embedded fonts and also in font lookup.
+ * \brief Set additional fonts directory.
+ * Optional directory that will be scanned for fonts recursively.  The fonts
+ * found are used for font lookup.
+ * NOTE: A valid font directory is not needed to support embedded fonts.
+ *
+ * \param priv library handle
+ * \param fonts_dir directory with additional fonts
  */
-void ass_set_fonts_dir(ass_library_t* priv, const char* fonts_dir);
+void ass_set_fonts_dir(ASS_Library *priv, const char *fonts_dir);
 
-void ass_set_extract_fonts(ass_library_t* priv, int extract);
+/**
+ * \brief Whether fonts should be extracted from track data.
+ * \param priv library handle
+ * \param extract whether to extract fonts
+ */
+void ass_set_extract_fonts(ASS_Library *priv, int extract);
 
-void ass_set_style_overrides(ass_library_t* priv, char** list);
+/**
+ * \brief Register style overrides with a library instance.
+ * The overrides should have the form [Style.]Param=Value, e.g.
+ *   SomeStyle.Font=Arial
+ *   ScaledBorderAndShadow=yes
+ *
+ * \param priv library handle
+ * \param list NULL-terminated list of strings
+ */
+void ass_set_style_overrides(ASS_Library *priv, char **list);
 
 /**
- * \brief initialize the renderer
+ * \brief Explicitly process style overrides for a track.
+ * \param track track handle
+ */
+void ass_process_force_style(ASS_Track *track);
+
+/**
+ * \brief Register a callback for debug/info messages.
+ * If a callback is registered, it is called for every message emitted by
+ * libass.  The callback receives a format string and a list of arguments,
+ * to be used for the printf family of functions. Additionally, a log level
+ * from 0 (FATAL errors) to 7 (verbose DEBUG) is passed.  Usually, level 5
+ * should be used by applications.
+ * If no callback is set, all messages level < 5 are printed to stderr,
+ * prefixed with [ass].
+ *
  * \param priv library handle
+ * \param msg_cb pointer to callback function
+ * \param data additional data, will be passed to callback
+ */
+void ass_set_message_cb(ASS_Library *priv, void (*msg_cb)
+                        (int level, const char *fmt, va_list args, void *data),
+                        void *data);
+
+/**
+ * \brief Initialize the renderer.
+ * \param priv library handle
  * \return renderer handle or NULL if failed
  */
-ass_renderer_t* ass_renderer_init(ass_library_t*);
+ASS_Renderer *ass_renderer_init(ASS_Library *);
 
 /**
- * \brief finalize the renderer
+ * \brief Finalize the renderer.
  * \param priv renderer handle
  */
-void ass_renderer_done(ass_renderer_t* priv);
+void ass_renderer_done(ASS_Renderer *priv);
 
-void ass_set_frame_size(ass_renderer_t* priv, int w, int h);
-void ass_set_margins(ass_renderer_t* priv, int t, int b, int l, int r);
-void ass_set_use_margins(ass_renderer_t* priv, int use);
-void ass_set_aspect_ratio(ass_renderer_t* priv, double ar);
-void ass_set_font_scale(ass_renderer_t* priv, double font_scale);
-void ass_set_hinting(ass_renderer_t* priv, ass_hinting_t ht);
-void ass_set_line_spacing(ass_renderer_t* priv, double line_spacing);
+/**
+ * \brief Set the frame size in pixels, including margins.
+ * \param priv renderer handle
+ * \param w width
+ * \param h height
+ */
+void ass_set_frame_size(ASS_Renderer *priv, int w, int h);
 
 /**
- * \brief set font lookup defaults
+ * \brief Set frame margins.  These values may be negative if pan-and-scan
+ * is used.
+ * \param priv renderer handle
+ * \param t top margin
+ * \param b bottom margin
+ * \param l left margin
+ * \param r right margin
  */
-int  ass_set_fonts(ass_renderer_t* priv, const char* default_font, const char* default_family);
+void ass_set_margins(ASS_Renderer *priv, int t, int b, int l, int r);
 
 /**
- * \brief render a frame, producing a list of ass_image_t
- * \param priv library
+ * \brief Whether margins should be used for placing regular events.
+ * \param priv renderer handle
+ * \param use whether to use the margins
+ */
+void ass_set_use_margins(ASS_Renderer *priv, int use);
+
+/**
+ * \brief Set aspect ratio parameters.
+ * \param priv renderer handle
+ * \param dar display aspect ratio (DAR), prescaled for output PAR
+ * \param sar storage aspect ratio (SAR)
+ */
+void ass_set_aspect_ratio(ASS_Renderer *priv, double dar, double sar);
+
+/**
+ * \brief Set a fixed font scaling factor.
+ * \param priv renderer handle
+ * \param font_scale scaling factor, default is 1.0
+ */
+void ass_set_font_scale(ASS_Renderer *priv, double font_scale);
+
+/**
+ * \brief Set font hinting method.
+ * \param priv renderer handle
+ * \param ht hinting method
+ */
+void ass_set_hinting(ASS_Renderer *priv, ASS_Hinting ht);
+
+/**
+ * \brief Set line spacing. Will not be scaled with frame size.
+ * \param priv renderer handle
+ * \param line_spacing line spacing in pixels
+ */
+void ass_set_line_spacing(ASS_Renderer *priv, double line_spacing);
+
+/**
+ * \brief Set font lookup defaults.
+ * \param default_font path to default font to use. Must be supplied if
+ * fontconfig is disabled or unavailable.
+ * \param default_family fallback font family for fontconfig, or NULL
+ * \param fc whether to use fontconfig
+ * \param config path to fontconfig configuration file, or NULL.  Only relevant
+ * if fontconfig is used.
+ * \param update whether fontconfig cache should be built/updated now.  Only
+ * relevant if fontconfig is used.
+ *
+ * NOTE: font lookup must be configured before an ASS_Renderer can be used.
+ */
+void ass_set_fonts(ASS_Renderer *priv, const char *default_font,
+                   const char *default_family, int fc, const char *config,
+                   int update);
+
+/**
+ * \brief Update/build font cache.  This needs to be called if it was
+ * disabled when ass_set_fonts was set.
+ *
+ * \param priv renderer handle
+ * \return success
+ */
+int ass_fonts_update(ASS_Renderer *priv);
+
+/**
+ * \brief Set hard cache limits.  Do not set, or set to zero, for reasonable
+ * defaults.
+ *
+ * \param priv renderer handle
+ * \param glyph_max maximum number of cached glyphs
+ * \param bitmap_max_size maximum bitmap cache size (in MB)
+ */
+void ass_set_cache_limits(ASS_Renderer *priv, int glyph_max,
+                          int bitmap_max_size);
+
+/**
+ * \brief Render a frame, producing a list of ASS_Image.
+ * \param priv renderer handle
  * \param track subtitle track
  * \param now video timestamp in milliseconds
+ * \param detect_change will be set to 1 if a change occured compared
+ * to the last invocation
  */
-ass_image_t* ass_render_frame(ass_renderer_t *priv, ass_track_t* track, long long now, int* detect_change);
+ASS_Image *ass_render_frame(ASS_Renderer *priv, ASS_Track *track,
+                            long long now, int *detect_change);
 
 
-// The following functions operate on track objects and do not need an ass_renderer //
+/*
+ * The following functions operate on track objects and do not need
+ * an ass_renderer
+ */
 
 /**
- * \brief allocate a new empty track object
+ * \brief Allocate a new empty track object.
+ * \param library handle
  * \return pointer to empty track
  */
-ass_track_t* ass_new_track(ass_library_t*);
+ASS_Track *ass_new_track(ASS_Library *);
 
 /**
- * \brief deallocate track and all its child objects (styles and events)
+ * \brief Deallocate track and all its child objects (styles and events).
  * \param track track to deallocate
  */
-void ass_free_track(ass_track_t* track);
+void ass_free_track(ASS_Track *track);
 
 /**
- * \brief allocate new style
+ * \brief Allocate new style.
  * \param track track
  * \return newly allocated style id
  */
-int ass_alloc_style(ass_track_t* track);
+int ass_alloc_style(ASS_Track *track);
 
 /**
- * \brief allocate new event
+ * \brief Allocate new event.
  * \param track track
  * \return newly allocated event id
  */
-int ass_alloc_event(ass_track_t* track);
+int ass_alloc_event(ASS_Track *track);
 
 /**
- * \brief delete a style
+ * \brief Delete a style.
  * \param track track
  * \param sid style id
  * Deallocates style data. Does not modify track->n_styles.
  */
-void ass_free_style(ass_track_t* track, int sid);
+void ass_free_style(ASS_Track *track, int sid);
 
 /**
- * \brief delete an event
+ * \brief Delete an event.
  * \param track track
  * \param eid event id
  * Deallocates event data. Does not modify track->n_events.
  */
-void ass_free_event(ass_track_t* track, int eid);
+void ass_free_event(ASS_Track *track, int eid);
 
 /**
- * \brief Process Codec Private section of subtitle stream
+ * \brief Parse a chunk of subtitle stream data.
+ * \param track track
+ * \param data string to parse
+ * \param size length of data
+ */
+void ass_process_data(ASS_Track *track, char *data, int size);
+
+/**
+ * \brief Parse Codec Private section of the subtitle stream, in Matroska
+ * format.  See the Matroska specification for details.
  * \param track target track
  * \param data string to parse
  * \param size length of data
  */
-void ass_process_codec_private(ass_track_t* track, char *data, int size);
+void ass_process_codec_private(ASS_Track *track, char *data, int size);
 
 /**
- * \brief Process a chunk of subtitle stream data. In matroska, this containes exactly 1 event (or a commentary)
+ * \brief Parse a chunk of subtitle stream data. A chunk contains exactly one
+ * event in Matroska format.  See the Matroska specification for details.
  * \param track track
  * \param data string to parse
  * \param size length of data
  * \param timecode starting time of the event (milliseconds)
  * \param duration duration of the event (milliseconds)
+ */
+void ass_process_chunk(ASS_Track *track, char *data, int size,
+                       long long timecode, long long duration);
+
+/**
+ * \brief Flush buffered events.
+ * \param track track
 */
-void ass_process_chunk(ass_track_t* track, char *data, int size, long long timecode, long long duration);
+void ass_flush_events(ASS_Track *track);
 
-char* read_file_recode(char* fname, char* codepage, int* size);
-
 /**
  * \brief Read subtitles from file.
+ * \param library library handle
  * \param fname file name
+ * \param codepage encoding (iconv format)
  * \return newly allocated track
 */
-ass_track_t* ass_read_file(ass_library_t* library, char* fname, char* codepage);
+ASS_Track *ass_read_file(ASS_Library *library, char *fname,
+                         char *codepage);
 
 /**
  * \brief Read subtitles from memory.
- * \param library libass library object
+ * \param library library handle
  * \param buf pointer to subtitles text
  * \param bufsize size of buffer
- * \param codepage recode buffer contents from given codepage
+ * \param codepage encoding (iconv format)
  * \return newly allocated track
-*/ 
-ass_track_t* ass_read_memory(ass_library_t* library, char* buf, size_t bufsize, char* codepage);
+*/
+ASS_Track *ass_read_memory(ASS_Library *library, char *buf,
+                           size_t bufsize, char *codepage);
 /**
- * \brief read styles from file into already initialized track
+ * \brief Read styles from file into already initialized track.
+ * \param fname file name
+ * \param codepage encoding (iconv format)
  * \return 0 on success
  */
-int ass_read_styles(ass_track_t* track, char* fname, char* codepage);
+int ass_read_styles(ASS_Track *track, char *fname, char *codepage);
 
 /**
  * \brief Add a memory font.
+ * \param library library handle
  * \param name attachment name
  * \param data binary font data
  * \param data_size data size
 */
-void ass_add_font(ass_library_t* library, char* name, char* data, int data_size);
+void ass_add_font(ASS_Library *library, char *name, char *data,
+                  int data_size);
 
 /**
- * \brief Calculates timeshift from now to the start of some other subtitle event, depending on movement parameter
+ * \brief Remove all fonts stored in an ass_library object.
+ * \param library library handle
+ */
+void ass_clear_fonts(ASS_Library *library);
+
+/**
+ * \brief Calculates timeshift from now to the start of some other subtitle
+ * event, depending on movement parameter.
  * \param track subtitle track
- * \param now current time, ms
+ * \param now current time in milliseconds
  * \param movement how many events to skip from the one currently displayed
  * +2 means "the one after the next", -1 means "previous"
- * \return timeshift, ms
+ * \return timeshift in milliseconds
  */
-long long ass_step_sub(ass_track_t* track, long long now, int movement);
+long long ass_step_sub(ASS_Track *track, long long now, int movement);
 
-#endif
-
+#endif /* LIBASS_ASS_H */

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.c	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,23 +1,23 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
 #include <stdlib.h>
 #include <string.h>
 #include <math.h>
@@ -25,248 +25,506 @@
 #include <ft2build.h>
 #include FT_GLYPH_H
 
-#include "mputils.h"
+#include "ass_utils.h"
 #include "ass_bitmap.h"
 
-struct ass_synth_priv_s {
-	int tmp_w, tmp_h;
-	unsigned short* tmp;
+struct ass_synth_priv {
+    int tmp_w, tmp_h;
+    unsigned short *tmp;
 
-	int g_r;
-	int g_w;
+    int g_r;
+    int g_w;
 
-	unsigned *g;
-	unsigned *gt2;
+    unsigned *g;
+    unsigned *gt2;
+
+    double radius;
 };
 
 static const unsigned int maxcolor = 255;
 static const unsigned base = 256;
-static const double blur_radius = 1.5;
 
-static int generate_tables(ass_synth_priv_t* priv, double radius)
+static int generate_tables(ASS_SynthPriv *priv, double radius)
 {
-	double A = log(1.0/base)/(radius*radius*2);
-	int mx, i;
-	double volume_diff, volume_factor = 0;
-	unsigned volume;
+    double A = log(1.0 / base) / (radius * radius * 2);
+    int mx, i;
+    double volume_diff, volume_factor = 0;
+    unsigned volume;
 
-	priv->g_r = ceil(radius);
-	priv->g_w = 2*priv->g_r+1;
+    if (priv->radius == radius)
+        return 0;
+    else
+        priv->radius = radius;
 
-	if (priv->g_r) {
-		priv->g = malloc(priv->g_w * sizeof(unsigned));
-		priv->gt2 = malloc(256 * priv->g_w * sizeof(unsigned));
-		if (priv->g==NULL || priv->gt2==NULL) {
-			return -1;
-		}
-	}
+    priv->g_r = ceil(radius);
+    priv->g_w = 2 * priv->g_r + 1;
 
-	if (priv->g_r) {
-		// gaussian curve with volume = 256
-		for (volume_diff=10000000; volume_diff>0.0000001; volume_diff*=0.5){
-			volume_factor+= volume_diff;
-			volume=0;
-			for (i = 0; i<priv->g_w; ++i) {
-				priv->g[i] = (unsigned)(exp(A * (i-priv->g_r)*(i-priv->g_r)) * volume_factor + .5);
-				volume+= priv->g[i];
-			}
-			if(volume>256) volume_factor-= volume_diff;
-		}
-		volume=0;
-		for (i = 0; i<priv->g_w; ++i) {
-			priv->g[i] = (unsigned)(exp(A * (i-priv->g_r)*(i-priv->g_r)) * volume_factor + .5);
-			volume+= priv->g[i];
-		}
+    if (priv->g_r) {
+        priv->g = realloc(priv->g, priv->g_w * sizeof(unsigned));
+        priv->gt2 = realloc(priv->gt2, 256 * priv->g_w * sizeof(unsigned));
+        if (priv->g == NULL || priv->gt2 == NULL) {
+            return -1;
+        }
+    }
 
-		// gauss table:
-		for(mx=0;mx<priv->g_w;mx++){
-			for(i=0;i<256;i++){
-				priv->gt2[mx+i*priv->g_w] = i*priv->g[mx];
-			}
-		}
-	}
+    if (priv->g_r) {
+        // gaussian curve with volume = 256
+        for (volume_diff = 10000000; volume_diff > 0.0000001;
+             volume_diff *= 0.5) {
+            volume_factor += volume_diff;
+            volume = 0;
+            for (i = 0; i < priv->g_w; ++i) {
+                priv->g[i] =
+                    (unsigned) (exp(A * (i - priv->g_r) * (i - priv->g_r)) *
+                                volume_factor + .5);
+                volume += priv->g[i];
+            }
+            if (volume > 256)
+                volume_factor -= volume_diff;
+        }
+        volume = 0;
+        for (i = 0; i < priv->g_w; ++i) {
+            priv->g[i] =
+                (unsigned) (exp(A * (i - priv->g_r) * (i - priv->g_r)) *
+                            volume_factor + .5);
+            volume += priv->g[i];
+        }
 
-	return 0;
+        // gauss table:
+        for (mx = 0; mx < priv->g_w; mx++) {
+            for (i = 0; i < 256; i++) {
+                priv->gt2[mx + i * priv->g_w] = i * priv->g[mx];
+            }
+        }
+    }
+
+    return 0;
 }
 
-static void resize_tmp(ass_synth_priv_t* priv, int w, int h)
+static void resize_tmp(ASS_SynthPriv *priv, int w, int h)
 {
-	if (priv->tmp_w >= w && priv->tmp_h >= h)
-		return;
-	if (priv->tmp_w == 0)
-		priv->tmp_w = 64;
-	if (priv->tmp_h == 0)
-		priv->tmp_h = 64;
-	while (priv->tmp_w < w) priv->tmp_w *= 2;
-	while (priv->tmp_h < h) priv->tmp_h *= 2;
-	if (priv->tmp)
-		free(priv->tmp);
-	priv->tmp = malloc((priv->tmp_w + 1) * priv->tmp_h * sizeof(short));
+    if (priv->tmp_w >= w && priv->tmp_h >= h)
+        return;
+    if (priv->tmp_w == 0)
+        priv->tmp_w = 64;
+    if (priv->tmp_h == 0)
+        priv->tmp_h = 64;
+    while (priv->tmp_w < w)
+        priv->tmp_w *= 2;
+    while (priv->tmp_h < h)
+        priv->tmp_h *= 2;
+    free(priv->tmp);
+    priv->tmp = malloc((priv->tmp_w + 1) * priv->tmp_h * sizeof(short));
 }
 
-ass_synth_priv_t* ass_synth_init(void)
+ASS_SynthPriv *ass_synth_init(double radius)
 {
-	ass_synth_priv_t* priv = calloc(1, sizeof(ass_synth_priv_t));
-	generate_tables(priv, blur_radius);
-	return priv;
+    ASS_SynthPriv *priv = calloc(1, sizeof(ASS_SynthPriv));
+    generate_tables(priv, radius);
+    return priv;
 }
 
-void ass_synth_done(ass_synth_priv_t* priv)
+void ass_synth_done(ASS_SynthPriv *priv)
 {
-	if (priv->tmp)
-		free(priv->tmp);
-	if (priv->g)
-		free(priv->g);
-	if (priv->gt2)
-		free(priv->gt2);
-	free(priv);
+    free(priv->tmp);
+    free(priv->g);
+    free(priv->gt2);
+    free(priv);
 }
 
-static bitmap_t* alloc_bitmap(int w, int h)
+static Bitmap *alloc_bitmap(int w, int h)
 {
-	bitmap_t* bm;
-	bm = calloc(1, sizeof(bitmap_t));
-	bm->buffer = malloc(w*h);
-	bm->w = w;
-	bm->h = h;
-	bm->left = bm->top = 0;
-	return bm;
+    Bitmap *bm;
+    bm = malloc(sizeof(Bitmap));
+    bm->buffer = calloc(w, h);
+    bm->w = w;
+    bm->h = h;
+    bm->left = bm->top = 0;
+    return bm;
 }
 
-void ass_free_bitmap(bitmap_t* bm)
+void ass_free_bitmap(Bitmap *bm)
 {
-	if (bm) {
-		if (bm->buffer) free(bm->buffer);
-		free(bm);
-	}
+    if (bm)
+        free(bm->buffer);
+    free(bm);
 }
 
-static bitmap_t* copy_bitmap(const bitmap_t* src)
+static Bitmap *copy_bitmap(const Bitmap *src)
 {
-	bitmap_t* dst = alloc_bitmap(src->w, src->h);
-	dst->left = src->left;
-	dst->top = src->top;
-	memcpy(dst->buffer, src->buffer, src->w * src->h);
-	return dst;
+    Bitmap *dst = alloc_bitmap(src->w, src->h);
+    dst->left = src->left;
+    dst->top = src->top;
+    memcpy(dst->buffer, src->buffer, src->w * src->h);
+    return dst;
 }
 
-static bitmap_t* glyph_to_bitmap_internal(FT_Glyph glyph, int bord)
+int check_glyph_area(ASS_Library *library, FT_Glyph glyph)
 {
-	FT_BitmapGlyph bg;
-	FT_Bitmap* bit;
-	bitmap_t* bm;
-	int w, h;
-	unsigned char* src;
-	unsigned char* dst;
-	int i;
-	int error;
+    FT_BBox bbox;
+    long long dx, dy;
+    FT_Glyph_Get_CBox(glyph, FT_GLYPH_BBOX_TRUNCATE, &bbox);
+    dx = bbox.xMax - bbox.xMin;
+    dy = bbox.yMax - bbox.yMin;
+    if (dx * dy > 8000000) {
+        ass_msg(library, MSGL_WARN, "Glyph bounding box too large: %dx%dpx",
+               (int) dx, (int) dy);
+        return 1;
+    } else
+        return 0;
+}
 
-	error = FT_Glyph_To_Bitmap(&glyph, FT_RENDER_MODE_NORMAL, 0, 0);
-	if (error) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FT_Glyph_To_BitmapError, error);
-		return 0;
-	}
+static Bitmap *glyph_to_bitmap_internal(ASS_Library *library,
+                                          FT_Glyph glyph, int bord)
+{
+    FT_BitmapGlyph bg;
+    FT_Bitmap *bit;
+    Bitmap *bm;
+    int w, h;
+    unsigned char *src;
+    unsigned char *dst;
+    int i;
+    int error;
 
-	bg = (FT_BitmapGlyph)glyph;
-	bit = &(bg->bitmap);
-	if (bit->pixel_mode != FT_PIXEL_MODE_GRAY) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_UnsupportedPixelMode, (int)(bit->pixel_mode));
-		FT_Done_Glyph(glyph);
-		return 0;
-	}
+    if (check_glyph_area(library, glyph))
+        return 0;
+    error = FT_Glyph_To_Bitmap(&glyph, FT_RENDER_MODE_NORMAL, 0, 0);
+    if (error) {
+        ass_msg(library, MSGL_WARN, "FT_Glyph_To_Bitmap error %d",
+               error);
+        return 0;
+    }
 
-	w = bit->width;
-	h = bit->rows;
-	bm = alloc_bitmap(w + 2*bord, h + 2*bord);
-	memset(bm->buffer, 0, bm->w * bm->h);
-	bm->left = bg->left - bord;
-	bm->top = - bg->top - bord;
+    bg = (FT_BitmapGlyph) glyph;
+    bit = &(bg->bitmap);
+    if (bit->pixel_mode != FT_PIXEL_MODE_GRAY) {
+        ass_msg(library, MSGL_WARN, "Unsupported pixel mode: %d",
+               (int) (bit->pixel_mode));
+        FT_Done_Glyph(glyph);
+        return 0;
+    }
 
-	src = bit->buffer;
-	dst = bm->buffer + bord + bm->w * bord;
-	for (i = 0; i < h; ++i) {
-		memcpy(dst, src, w);
-		src += bit->pitch;
-		dst += bm->w;
-	}
+    w = bit->width;
+    h = bit->rows;
+    bm = alloc_bitmap(w + 2 * bord, h + 2 * bord);
+    bm->left = bg->left - bord;
+    bm->top = -bg->top - bord;
 
-	return bm;
+    src = bit->buffer;
+    dst = bm->buffer + bord + bm->w * bord;
+    for (i = 0; i < h; ++i) {
+        memcpy(dst, src, w);
+        src += bit->pitch;
+        dst += bm->w;
+    }
+
+    FT_Done_Glyph(glyph);
+    return bm;
 }
 
 /**
- * \brief fix outline bitmap and generate shadow bitmap
- * Two things are done here:
- * 1. Glyph bitmap is subtracted from outline bitmap. This way looks much better in some cases.
- * 2. Shadow bitmap is created as a sum of glyph and outline bitmaps.
+ * \brief fix outline bitmap
+ *
+ * The glyph bitmap is subtracted from outline bitmap. This way looks much
+ * better in some cases.
  */
-static bitmap_t* fix_outline_and_shadow(bitmap_t* bm_g, bitmap_t* bm_o)
+static void fix_outline(Bitmap *bm_g, Bitmap *bm_o)
 {
-	int x, y;
-	const int l = bm_o->left > bm_g->left ? bm_o->left : bm_g->left;
-	const int t = bm_o->top > bm_g->top ? bm_o->top : bm_g->top;
-	const int r = bm_o->left + bm_o->w < bm_g->left + bm_g->w ? bm_o->left + bm_o->w : bm_g->left + bm_g->w;
-	const int b = bm_o->top + bm_o->h < bm_g->top + bm_g->h ? bm_o->top + bm_o->h : bm_g->top + bm_g->h;
+    int x, y;
+    const int l = bm_o->left > bm_g->left ? bm_o->left : bm_g->left;
+    const int t = bm_o->top > bm_g->top ? bm_o->top : bm_g->top;
+    const int r =
+        bm_o->left + bm_o->w <
+        bm_g->left + bm_g->w ? bm_o->left + bm_o->w : bm_g->left + bm_g->w;
+    const int b =
+        bm_o->top + bm_o->h <
+        bm_g->top + bm_g->h ? bm_o->top + bm_o->h : bm_g->top + bm_g->h;
 
-	bitmap_t* bm_s = copy_bitmap(bm_o);
+    unsigned char *g =
+        bm_g->buffer + (t - bm_g->top) * bm_g->w + (l - bm_g->left);
+    unsigned char *o =
+        bm_o->buffer + (t - bm_o->top) * bm_o->w + (l - bm_o->left);
 
-	unsigned char* g = bm_g->buffer + (t - bm_g->top) * bm_g->w + (l - bm_g->left);
-	unsigned char* o = bm_o->buffer + (t - bm_o->top) * bm_o->w + (l - bm_o->left);
-	unsigned char* s = bm_s->buffer + (t - bm_s->top) * bm_s->w + (l - bm_s->left);
-	
-	for (y = 0; y < b - t; ++y) {
-		for (x = 0; x < r - l; ++x) {
-			unsigned char c_g, c_o;
-			c_g = g[x];
-			c_o = o[x];
-			o[x] = (c_o > c_g) ? c_o : 0;
-			s[x] = (c_o < 0xFF - c_g) ? c_o + c_g : 0xFF;
-		}
-		g += bm_g->w;
-		o += bm_o->w;
-		s += bm_s->w;
-	}
+    for (y = 0; y < b - t; ++y) {
+        for (x = 0; x < r - l; ++x) {
+            unsigned char c_g, c_o;
+            c_g = g[x];
+            c_o = o[x];
+            o[x] = (c_o > c_g) ? c_o - (c_g / 2) : 0;
+        }
+        g += bm_g->w;
+        o += bm_o->w;
+    }
+}
 
-	assert(bm_s);
-	return bm_s;
+/**
+ * \brief Shift a bitmap by the fraction of a pixel in x and y direction
+ * expressed in 26.6 fixed point
+ */
+static void shift_bitmap(unsigned char *buf, int w, int h, int shift_x,
+                         int shift_y)
+{
+    int x, y, b;
+
+    // Shift in x direction
+    if (shift_x > 0) {
+        for (y = 0; y < h; y++) {
+            for (x = w - 1; x > 0; x--) {
+                b = (buf[x + y * w - 1] * shift_x) >> 6;
+                buf[x + y * w - 1] -= b;
+                buf[x + y * w] += b;
+            }
+        }
+    } else if (shift_x < 0) {
+        shift_x = -shift_x;
+        for (y = 0; y < h; y++) {
+            for (x = 0; x < w - 1; x++) {
+                b = (buf[x + y * w + 1] * shift_x) >> 6;
+                buf[x + y * w + 1] -= b;
+                buf[x + y * w] += b;
+            }
+        }
+    }
+
+    // Shift in y direction
+    if (shift_y > 0) {
+        for (x = 0; x < w; x++) {
+            for (y = h - 1; y > 0; y--) {
+                b = (buf[x + (y - 1) * w] * shift_y) >> 6;
+                buf[x + (y - 1) * w] -= b;
+                buf[x + y * w] += b;
+            }
+        }
+    } else if (shift_y < 0) {
+        shift_y = -shift_y;
+        for (x = 0; x < w; x++) {
+            for (y = 0; y < h - 1; y++) {
+                b = (buf[x + (y + 1) * w] * shift_y) >> 6;
+                buf[x + (y + 1) * w] -= b;
+                buf[x + y * w] += b;
+            }
+        }
+    }
 }
 
-int glyph_to_bitmap(ass_synth_priv_t* priv, FT_Glyph glyph, FT_Glyph outline_glyph,
-		bitmap_t** bm_g, bitmap_t** bm_o, bitmap_t** bm_s, int be)
+/*
+ * Gaussian blur.  An fast pure C implementation from MPlayer.
+ */
+static void ass_gauss_blur(unsigned char *buffer, unsigned short *tmp2,
+                           int width, int height, int stride, int *m2,
+                           int r, int mwidth)
 {
-	const int bord = be ? ceil(blur_radius) : 0;
 
-	assert(bm_g && bm_o && bm_s);
+    int x, y;
 
-	*bm_g = *bm_o = *bm_s = 0;
+    unsigned char *s = buffer;
+    unsigned short *t = tmp2 + 1;
+    for (y = 0; y < height; y++) {
+        memset(t - 1, 0, (width + 1) * sizeof(short));
 
-	if (glyph)
-		*bm_g = glyph_to_bitmap_internal(glyph, bord);
-	if (!*bm_g)
-		return 1;
+        for (x = 0; x < r; x++) {
+            const int src = s[x];
+            if (src) {
+                register unsigned short *dstp = t + x - r;
+                int mx;
+                unsigned *m3 = (unsigned *) (m2 + src * mwidth);
+                for (mx = r - x; mx < mwidth; mx++) {
+                    dstp[mx] += m3[mx];
+                }
+            }
+        }
 
-	if (outline_glyph) {
-		*bm_o = glyph_to_bitmap_internal(outline_glyph, bord);
-		if (!*bm_o) {
-			ass_free_bitmap(*bm_g);
-			return 1;
-		}
-	}
-	if (*bm_o)
-		resize_tmp(priv, (*bm_o)->w, (*bm_o)->h);
-	resize_tmp(priv, (*bm_g)->w, (*bm_g)->h);
-	
-	if (be) {
-		blur((*bm_g)->buffer, priv->tmp, (*bm_g)->w, (*bm_g)->h, (*bm_g)->w, (int*)priv->gt2, priv->g_r, priv->g_w);
-		if (*bm_o)
-			blur((*bm_o)->buffer, priv->tmp, (*bm_o)->w, (*bm_o)->h, (*bm_o)->w, (int*)priv->gt2, priv->g_r, priv->g_w);
-	}
+        for (; x < width - r; x++) {
+            const int src = s[x];
+            if (src) {
+                register unsigned short *dstp = t + x - r;
+                int mx;
+                unsigned *m3 = (unsigned *) (m2 + src * mwidth);
+                for (mx = 0; mx < mwidth; mx++) {
+                    dstp[mx] += m3[mx];
+                }
+            }
+        }
 
-	if (*bm_o)
-		*bm_s = fix_outline_and_shadow(*bm_g, *bm_o);
-	else
-		*bm_s = copy_bitmap(*bm_g);
+        for (; x < width; x++) {
+            const int src = s[x];
+            if (src) {
+                register unsigned short *dstp = t + x - r;
+                int mx;
+                const int x2 = r + width - x;
+                unsigned *m3 = (unsigned *) (m2 + src * mwidth);
+                for (mx = 0; mx < x2; mx++) {
+                    dstp[mx] += m3[mx];
+                }
+            }
+        }
 
-	assert(bm_s);
-	return 0;
+        s += stride;
+        t += width + 1;
+    }
+
+    t = tmp2;
+    for (x = 0; x < width; x++) {
+        for (y = 0; y < r; y++) {
+            unsigned short *srcp = t + y * (width + 1) + 1;
+            int src = *srcp;
+            if (src) {
+                register unsigned short *dstp = srcp - 1 + width + 1;
+                const int src2 = (src + 128) >> 8;
+                unsigned *m3 = (unsigned *) (m2 + src2 * mwidth);
+
+                int mx;
+                *srcp = 128;
+                for (mx = r - 1; mx < mwidth; mx++) {
+                    *dstp += m3[mx];
+                    dstp += width + 1;
+                }
+            }
+        }
+        for (; y < height - r; y++) {
+            unsigned short *srcp = t + y * (width + 1) + 1;
+            int src = *srcp;
+            if (src) {
+                register unsigned short *dstp = srcp - 1 - r * (width + 1);
+                const int src2 = (src + 128) >> 8;
+                unsigned *m3 = (unsigned *) (m2 + src2 * mwidth);
+
+                int mx;
+                *srcp = 128;
+                for (mx = 0; mx < mwidth; mx++) {
+                    *dstp += m3[mx];
+                    dstp += width + 1;
+                }
+            }
+        }
+        for (; y < height; y++) {
+            unsigned short *srcp = t + y * (width + 1) + 1;
+            int src = *srcp;
+            if (src) {
+                const int y2 = r + height - y;
+                register unsigned short *dstp = srcp - 1 - r * (width + 1);
+                const int src2 = (src + 128) >> 8;
+                unsigned *m3 = (unsigned *) (m2 + src2 * mwidth);
+
+                int mx;
+                *srcp = 128;
+                for (mx = 0; mx < y2; mx++) {
+                    *dstp += m3[mx];
+                    dstp += width + 1;
+                }
+            }
+        }
+        t++;
+    }
+
+    t = tmp2;
+    s = buffer;
+    for (y = 0; y < height; y++) {
+        for (x = 0; x < width; x++) {
+            s[x] = t[x] >> 8;
+        }
+        s += stride;
+        t += width + 1;
+    }
 }
 
+/**
+ * \brief Blur with [[1,2,1]. [2,4,2], [1,2,1]] kernel
+ * This blur is the same as the one employed by vsfilter.
+ */
+static void be_blur(unsigned char *buf, int w, int h)
+{
+    unsigned int x, y;
+    unsigned int old_sum, new_sum;
+
+    for (y = 0; y < h; y++) {
+        old_sum = 2 * buf[y * w];
+        for (x = 0; x < w - 1; x++) {
+            new_sum = buf[y * w + x] + buf[y * w + x + 1];
+            buf[y * w + x] = (old_sum + new_sum) >> 2;
+            old_sum = new_sum;
+        }
+    }
+
+    for (x = 0; x < w; x++) {
+        old_sum = 2 * buf[x];
+        for (y = 0; y < h - 1; y++) {
+            new_sum = buf[y * w + x] + buf[(y + 1) * w + x];
+            buf[y * w + x] = (old_sum + new_sum) >> 2;
+            old_sum = new_sum;
+        }
+    }
+}
+
+int glyph_to_bitmap(ASS_Library *library, ASS_SynthPriv *priv_blur,
+                    FT_Glyph glyph, FT_Glyph outline_glyph,
+                    Bitmap **bm_g, Bitmap **bm_o, Bitmap **bm_s,
+                    int be, double blur_radius, FT_Vector shadow_offset,
+                    int border_style)
+{
+    blur_radius *= 2;
+    int bbord = be > 0 ? sqrt(2 * be) : 0;
+    int gbord = blur_radius > 0.0 ? blur_radius + 1 : 0;
+    int bord = FFMAX(bbord, gbord);
+    if (bord == 0 && (shadow_offset.x || shadow_offset.y))
+        bord = 1;
+
+    assert(bm_g && bm_o && bm_s);
+
+    *bm_g = *bm_o = *bm_s = 0;
+
+    if (glyph)
+        *bm_g = glyph_to_bitmap_internal(library, glyph, bord);
+    if (!*bm_g)
+        return 1;
+
+    if (outline_glyph) {
+        *bm_o = glyph_to_bitmap_internal(library, outline_glyph, bord);
+        if (!*bm_o) {
+            return 1;
+        }
+    }
+
+    // Apply box blur (multiple passes, if requested)
+    while (be--) {
+        if (*bm_o)
+            be_blur((*bm_o)->buffer, (*bm_o)->w, (*bm_o)->h);
+        else
+            be_blur((*bm_g)->buffer, (*bm_g)->w, (*bm_g)->h);
+    }
+
+    // Apply gaussian blur
+    if (blur_radius > 0.0) {
+        if (*bm_o)
+            resize_tmp(priv_blur, (*bm_o)->w, (*bm_o)->h);
+        else
+            resize_tmp(priv_blur, (*bm_g)->w, (*bm_g)->h);
+        generate_tables(priv_blur, blur_radius);
+        if (*bm_o)
+            ass_gauss_blur((*bm_o)->buffer, priv_blur->tmp,
+                           (*bm_o)->w, (*bm_o)->h, (*bm_o)->w,
+                           (int *) priv_blur->gt2, priv_blur->g_r,
+                           priv_blur->g_w);
+        else
+            ass_gauss_blur((*bm_g)->buffer, priv_blur->tmp,
+                           (*bm_g)->w, (*bm_g)->h, (*bm_g)->w,
+                           (int *) priv_blur->gt2, priv_blur->g_r,
+                           priv_blur->g_w);
+    }
+
+    // Create shadow and fix outline as needed
+    if (*bm_o && border_style != 3) {
+        *bm_s = copy_bitmap(*bm_o);
+        fix_outline(*bm_g, *bm_o);
+    } else if (*bm_o) {
+        *bm_s = copy_bitmap(*bm_o);
+    } else
+        *bm_s = copy_bitmap(*bm_g);
+
+    assert(bm_s);
+
+    shift_bitmap((*bm_s)->buffer, (*bm_s)->w,(*bm_s)->h,
+                 shadow_offset.x, shadow_offset.y);
+
+    return 0;
+}

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.h	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_bitmap.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,37 +1,42 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#ifndef LIBASS_BITMAP_H
+#define LIBASS_BITMAP_H
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
+#include <ft2build.h>
+#include FT_GLYPH_H
 
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
+#include "ass.h"
 
-#ifndef ASS_BITMAP_H
-#define ASS_BITMAP_H
+typedef struct ass_synth_priv ASS_SynthPriv;
 
-typedef struct ass_synth_priv_s ass_synth_priv_t;
+ASS_SynthPriv *ass_synth_init(double);
+void ass_synth_done(ASS_SynthPriv *priv);
 
-ass_synth_priv_t* ass_synth_init(void);
-void ass_synth_done(ass_synth_priv_t* priv);
+typedef struct {
+    int left, top;
+    int w, h;                   // width, height
+    unsigned char *buffer;      // w x h buffer
+} Bitmap;
 
-typedef struct bitmap_s {
-	int left, top;
-	int w, h; // width, height
-	unsigned char* buffer; // w x h buffer
-} bitmap_t;
-
 /**
  * \brief perform glyph rendering
  * \param glyph original glyph
@@ -41,9 +46,13 @@
  * \param bm_g out: pointer to the bitmap of glyph shadow is returned here
  * \param be 1 = produces blurred bitmaps, 0 = normal bitmaps
  */
-int glyph_to_bitmap(ass_synth_priv_t* priv, FT_Glyph glyph, FT_Glyph outline_glyph, bitmap_t** bm_g, bitmap_t** bm_o, bitmap_t** bm_s, int be);
+int glyph_to_bitmap(ASS_Library *library, ASS_SynthPriv *priv_blur,
+                    FT_Glyph glyph, FT_Glyph outline_glyph,
+                    Bitmap **bm_g, Bitmap **bm_o, Bitmap **bm_s,
+                    int be, double blur_radius, FT_Vector shadow_offset,
+                    int border_style);
 
-void ass_free_bitmap(bitmap_t* bm);
+void ass_free_bitmap(Bitmap *bm);
+int check_glyph_area(ASS_Library *library, FT_Glyph glyph);
 
-#endif
-
+#endif                          /* LIBASS_BITMAP_H */

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.c	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,25 +1,25 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#include "ADM_coreConfig.h"
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-//#include "config.h"
-
 #include <inttypes.h>
 #include <ft2build.h>
 #include FT_FREETYPE_H
@@ -27,298 +27,361 @@
 
 #include <assert.h>
 
-#include "mputils.h"
+#include "ass_utils.h"
 #include "ass.h"
 #include "ass_fontconfig.h"
 #include "ass_font.h"
 #include "ass_bitmap.h"
 #include "ass_cache.h"
 
-
-typedef struct hashmap_item_s {
-	void* key;
-	void* value;
-	struct hashmap_item_s* next;
-} hashmap_item_t;
-typedef hashmap_item_t* hashmap_item_p;
-
-struct hashmap_s {
-	int nbuckets;
-	size_t key_size, value_size;
-	hashmap_item_p* root;
-	hashmap_item_dtor_t item_dtor; // a destructor for hashmap key/value pairs
-	hashmap_key_compare_t key_compare;
-	hashmap_hash_t hash;
-	// stats
-	int hit_count;
-	int miss_count;
-	int count;
-};
-
-#define FNV1_32A_INIT (unsigned)0x811c9dc5
-
-static inline unsigned fnv_32a_buf(void* buf, size_t len, unsigned hval)
+static unsigned hashmap_hash(void *buf, size_t len)
 {
-	unsigned char *bp = buf;
-	unsigned char *be = bp + len;
-	while (bp < be) {
-		hval ^= (unsigned)*bp++;
-		hval += (hval<<1) + (hval<<4) + (hval<<7) + (hval<<8) + (hval<<24);
-	}
-	return hval;
+    return fnv_32a_buf(buf, len, FNV1_32A_INIT);
 }
-static inline unsigned fnv_32a_str(char* str, unsigned hval)
-{
-	unsigned char* s = (unsigned char*)str;
-	while (*s) {
-		hval ^= (unsigned)*s++;
-		hval += (hval<<1) + (hval<<4) + (hval<<7) + (hval<<8) + (hval<<24);
-	}
-	return hval;
-}
 
-static unsigned hashmap_hash(void* buf, size_t len)
+static int hashmap_key_compare(void *a, void *b, size_t size)
 {
-	return fnv_32a_buf(buf, len, FNV1_32A_INIT);
+    return memcmp(a, b, size) == 0;
 }
 
-static int hashmap_key_compare(void* a, void* b, size_t size)
+static void hashmap_item_dtor(void *key, size_t key_size, void *value,
+                              size_t value_size)
 {
-	return (memcmp(a, b, size) == 0);
+    free(key);
+    free(value);
 }
 
-static void hashmap_item_dtor(void* key, size_t key_size, void* value, size_t value_size)
+Hashmap *hashmap_init(ASS_Library *library, size_t key_size,
+                      size_t value_size, int nbuckets,
+                      HashmapItemDtor item_dtor,
+                      HashmapKeyCompare key_compare,
+                      HashmapHash hash)
 {
-	free(key);
-	free(value);
+    Hashmap *map = calloc(1, sizeof(Hashmap));
+    map->library = library;
+    map->nbuckets = nbuckets;
+    map->key_size = key_size;
+    map->value_size = value_size;
+    map->root = calloc(nbuckets, sizeof(hashmap_item_p));
+    map->item_dtor = item_dtor ? item_dtor : hashmap_item_dtor;
+    map->key_compare = key_compare ? key_compare : hashmap_key_compare;
+    map->hash = hash ? hash : hashmap_hash;
+    return map;
 }
 
-hashmap_t* hashmap_init(size_t key_size, size_t value_size, int nbuckets,
-			hashmap_item_dtor_t item_dtor, hashmap_key_compare_t key_compare,
-			hashmap_hash_t hash)
+void hashmap_done(Hashmap *map)
 {
-	hashmap_t* map = calloc(1, sizeof(hashmap_t));
-	map->nbuckets = nbuckets;
-	map->key_size = key_size;
-	map->value_size = value_size;
-	map->root = calloc(nbuckets, sizeof(hashmap_item_p));
-	map->item_dtor = item_dtor ? item_dtor : hashmap_item_dtor;
-	map->key_compare = key_compare ? key_compare : hashmap_key_compare;
-	map->hash = hash ? hash : hashmap_hash;
-	return map;
-}
+    int i;
+    // print stats
+    if (map->count > 0 || map->hit_count + map->miss_count > 0)
+        ass_msg(map->library, MSGL_V,
+               "cache statistics: \n  total accesses: %d\n  hits: %d\n  "
+               "misses: %d\n  object count: %d",
+               map->hit_count + map->miss_count, map->hit_count,
+               map->miss_count, map->count);
 
-void hashmap_done(hashmap_t* map)
-{
-	int i;
-	// print stats
-	if (map->count > 0 || map->hit_count + map->miss_count > 0)
-		mp_msg(MSGT_ASS, MSGL_V, "cache statistics: \n  total accesses: %d\n  hits: %d\n  misses: %d\n  object count: %d\n",
-		       map->hit_count + map->miss_count, map->hit_count, map->miss_count, map->count);
-	
-	for (i = 0; i < map->nbuckets; ++i) {
-		hashmap_item_t* item = map->root[i];
-		while (item) {
-			hashmap_item_t* next = item->next;
-			map->item_dtor(item->key, map->key_size, item->value, map->value_size);
-			free(item);
-			item = next;
-		}
-	}
-	free(map->root);
-	free(map);
+    for (i = 0; i < map->nbuckets; ++i) {
+        HashmapItem *item = map->root[i];
+        while (item) {
+            HashmapItem *next = item->next;
+            map->item_dtor(item->key, map->key_size, item->value,
+                           map->value_size);
+            free(item);
+            item = next;
+        }
+    }
+    free(map->root);
+    free(map);
 }
 
 // does nothing if key already exists
-void* hashmap_insert(hashmap_t* map, void* key, void* value)
+void *hashmap_insert(Hashmap *map, void *key, void *value)
 {
-	unsigned hash = map->hash(key, map->key_size);
-	hashmap_item_t** next = map->root + (hash % map->nbuckets);
-	while (*next) {
-		if (map->key_compare(key, (*next)->key, map->key_size))
-			return (*next)->value;
-		next = &((*next)->next);
-		assert(next);
-	}
-	(*next) = malloc(sizeof(hashmap_item_t));
-	(*next)->key = malloc(map->key_size);
-	(*next)->value = malloc(map->value_size);
-	memcpy((*next)->key, key, map->key_size);
-	memcpy((*next)->value, value, map->value_size);
-	(*next)->next = 0;
+    unsigned hash = map->hash(key, map->key_size);
+    HashmapItem **next = map->root + (hash % map->nbuckets);
+    while (*next) {
+        if (map->key_compare(key, (*next)->key, map->key_size))
+            return (*next)->value;
+        next = &((*next)->next);
+        assert(next);
+    }
+    (*next) = malloc(sizeof(HashmapItem));
+    (*next)->key = malloc(map->key_size);
+    (*next)->value = malloc(map->value_size);
+    memcpy((*next)->key, key, map->key_size);
+    memcpy((*next)->value, value, map->value_size);
+    (*next)->next = 0;
 
-	map->count ++;
-	return (*next)->value;
+    map->count++;
+    return (*next)->value;
 }
 
-void* hashmap_find(hashmap_t* map, void* key)
+void *hashmap_find(Hashmap *map, void *key)
 {
-	unsigned hash = map->hash(key, map->key_size);
-	hashmap_item_t* item = map->root[hash % map->nbuckets];
-	while (item) {
-		if (map->key_compare(key, item->key, map->key_size)) {
-			map->hit_count++;
-			return item->value;
-		}
-		item = item->next;
-	}
-	map->miss_count++;
-	return 0;
+    unsigned hash = map->hash(key, map->key_size);
+    HashmapItem *item = map->root[hash % map->nbuckets];
+    while (item) {
+        if (map->key_compare(key, item->key, map->key_size)) {
+            map->hit_count++;
+            return item->value;
+        }
+        item = item->next;
+    }
+    map->miss_count++;
+    return 0;
 }
 
 //---------------------------------
 // font cache
 
-hashmap_t* font_cache;
-
-static unsigned font_desc_hash(void* buf, size_t len)
+static unsigned font_desc_hash(void *buf, size_t len)
 {
-	ass_font_desc_t* desc = buf;
-	unsigned hval;
-	hval = fnv_32a_str(desc->family, FNV1_32A_INIT);
-	hval = fnv_32a_buf(&desc->bold, sizeof(desc->bold), hval);
-	hval = fnv_32a_buf(&desc->italic, sizeof(desc->italic), hval);
-	return hval;
+    ASS_FontDesc *desc = buf;
+    unsigned hval;
+    hval = fnv_32a_str(desc->family, FNV1_32A_INIT);
+    hval = fnv_32a_buf(&desc->bold, sizeof(desc->bold), hval);
+    hval = fnv_32a_buf(&desc->italic, sizeof(desc->italic), hval);
+    return hval;
 }
 
-static int font_compare(void* key1, void* key2, size_t key_size) {
-	ass_font_desc_t* a = key1;
-	ass_font_desc_t* b = key2;
-	if (strcmp(a->family, b->family) != 0)
-		return 0;
-	if (a->bold != b->bold)
-		return 0;
-	if (a->italic != b->italic)
-		return 0;
-	return 1;
+static int font_compare(void *key1, void *key2, size_t key_size)
+{
+    ASS_FontDesc *a = key1;
+    ASS_FontDesc *b = key2;
+    if (strcmp(a->family, b->family) != 0)
+        return 0;
+    if (a->bold != b->bold)
+        return 0;
+    if (a->italic != b->italic)
+        return 0;
+    if (a->treat_family_as_pattern != b->treat_family_as_pattern)
+        return 0;
+    if (a->vertical != b->vertical)
+        return 0;
+    return 1;
 }
 
-static void font_hash_dtor(void* key, size_t key_size, void* value, size_t value_size)
+static void font_hash_dtor(void *key, size_t key_size, void *value,
+                           size_t value_size)
 {
-	ass_font_free(value);
-	free(key);
+    ass_font_free(value);
+    free(key);
 }
 
-ass_font_t* ass_font_cache_find(ass_font_desc_t* desc)
+ASS_Font *ass_font_cache_find(Hashmap *font_cache,
+                              ASS_FontDesc *desc)
 {
-	return hashmap_find(font_cache, desc);
+    return hashmap_find(font_cache, desc);
 }
 
 /**
  * \brief Add a face struct to cache.
  * \param font font struct
 */
-void* ass_font_cache_add(ass_font_t* font)
+void *ass_font_cache_add(Hashmap *font_cache, ASS_Font *font)
 {
-	return hashmap_insert(font_cache, &(font->desc), font);
+    return hashmap_insert(font_cache, &(font->desc), font);
 }
 
-void ass_font_cache_init(void)
+Hashmap *ass_font_cache_init(ASS_Library *library)
 {
-	font_cache = hashmap_init(sizeof(ass_font_desc_t),
-				  sizeof(ass_font_t),
-				  1000,
-				  font_hash_dtor, font_compare, font_desc_hash);
+    Hashmap *font_cache;
+    font_cache = hashmap_init(library, sizeof(ASS_FontDesc),
+                              sizeof(ASS_Font),
+                              1000,
+                              font_hash_dtor, font_compare, font_desc_hash);
+    return font_cache;
 }
 
-void ass_font_cache_done(void)
+void ass_font_cache_done(Hashmap *font_cache)
 {
-	hashmap_done(font_cache);
+    hashmap_done(font_cache);
 }
 
+
+// Create hash/compare functions for bitmap and glyph
+#define CREATE_HASH_FUNCTIONS
+#include "ass_cache_template.h"
+#define CREATE_COMPARISON_FUNCTIONS
+#include "ass_cache_template.h"
+
 //---------------------------------
 // bitmap cache
 
-hashmap_t* bitmap_cache;
-
-static void bitmap_hash_dtor(void* key, size_t key_size, void* value, size_t value_size)
+static void bitmap_hash_dtor(void *key, size_t key_size, void *value,
+                             size_t value_size)
 {
-	bitmap_hash_val_t* v = value;
-	if (v->bm) ass_free_bitmap(v->bm);
-	if (v->bm_o) ass_free_bitmap(v->bm_o);
-	if (v->bm_s) ass_free_bitmap(v->bm_s);
-	free(key);
-	free(value);
+    BitmapHashValue *v = value;
+    if (v->bm)
+        ass_free_bitmap(v->bm);
+    if (v->bm_o)
+        ass_free_bitmap(v->bm_o);
+    if (v->bm_s)
+        ass_free_bitmap(v->bm_s);
+    free(key);
+    free(value);
 }
 
-void* cache_add_bitmap(bitmap_hash_key_t* key, bitmap_hash_val_t* val)
+void *cache_add_bitmap(Hashmap *bitmap_cache, BitmapHashKey *key,
+                       BitmapHashValue *val)
 {
-	return hashmap_insert(bitmap_cache, key, val);
+    // Note: this is only an approximation
+    if (val->bm_o)
+        bitmap_cache->cache_size += val->bm_o->w * val->bm_o->h * 3;
+    else if (val->bm)
+        bitmap_cache->cache_size += val->bm->w * val->bm->h * 3;
+
+    return hashmap_insert(bitmap_cache, key, val);
 }
 
 /**
  * \brief Get a bitmap from bitmap cache.
  * \param key hash key
  * \return requested hash val or 0 if not found
-*/ 
-bitmap_hash_val_t* cache_find_bitmap(bitmap_hash_key_t* key)
+*/
+BitmapHashValue *cache_find_bitmap(Hashmap *bitmap_cache,
+                                   BitmapHashKey *key)
 {
-	return hashmap_find(bitmap_cache, key);
+    return hashmap_find(bitmap_cache, key);
 }
 
-void ass_bitmap_cache_init(void)
+Hashmap *ass_bitmap_cache_init(ASS_Library *library)
 {
-	bitmap_cache = hashmap_init(sizeof(bitmap_hash_key_t),
-				   sizeof(bitmap_hash_val_t),
-				   0xFFFF + 13,
-				   bitmap_hash_dtor, NULL, NULL);
+    Hashmap *bitmap_cache;
+    bitmap_cache = hashmap_init(library,
+                                sizeof(BitmapHashKey),
+                                sizeof(BitmapHashValue),
+                                0xFFFF + 13,
+                                bitmap_hash_dtor, bitmap_compare,
+                                bitmap_hash);
+    return bitmap_cache;
 }
 
-void ass_bitmap_cache_done(void)
+void ass_bitmap_cache_done(Hashmap *bitmap_cache)
 {
-	hashmap_done(bitmap_cache);
+    hashmap_done(bitmap_cache);
 }
 
-void ass_bitmap_cache_reset(void)
+Hashmap *ass_bitmap_cache_reset(Hashmap *bitmap_cache)
 {
-	ass_bitmap_cache_done();
-	ass_bitmap_cache_init();
+    ASS_Library *lib = bitmap_cache->library;
+
+    ass_bitmap_cache_done(bitmap_cache);
+    return ass_bitmap_cache_init(lib);
 }
 
 //---------------------------------
 // glyph cache
 
-hashmap_t* glyph_cache;
-
-static void glyph_hash_dtor(void* key, size_t key_size, void* value, size_t value_size)
+static void glyph_hash_dtor(void *key, size_t key_size, void *value,
+                            size_t value_size)
 {
-	glyph_hash_val_t* v = value;
-	if (v->glyph) FT_Done_Glyph(v->glyph);
-	if (v->outline_glyph) FT_Done_Glyph(v->outline_glyph);
-	free(key);
-	free(value);
+    GlyphHashValue *v = value;
+    if (v->glyph)
+        FT_Done_Glyph(v->glyph);
+    if (v->outline_glyph)
+        FT_Done_Glyph(v->outline_glyph);
+    free(key);
+    free(value);
 }
 
-void* cache_add_glyph(glyph_hash_key_t* key, glyph_hash_val_t* val)
+void *cache_add_glyph(Hashmap *glyph_cache, GlyphHashKey *key,
+                      GlyphHashValue *val)
 {
-	return hashmap_insert(glyph_cache, key, val);
+	if (val->glyph && val->glyph->format == FT_GLYPH_FORMAT_BITMAP) {
+		FT_Bitmap *bitmap = &((FT_BitmapGlyph) val->glyph)->bitmap;
+		glyph_cache->cache_size += bitmap->rows * bitmap->pitch;
+	}
+
+    return hashmap_insert(glyph_cache, key, val);
 }
 
 /**
  * \brief Get a glyph from glyph cache.
  * \param key hash key
  * \return requested hash val or 0 if not found
-*/ 
-glyph_hash_val_t* cache_find_glyph(glyph_hash_key_t* key)
+*/
+GlyphHashValue *cache_find_glyph(Hashmap *glyph_cache,
+                                 GlyphHashKey *key)
 {
-	return hashmap_find(glyph_cache, key);
+    return hashmap_find(glyph_cache, key);
 }
 
-void ass_glyph_cache_init(void)
+Hashmap *ass_glyph_cache_init(ASS_Library *library)
 {
-	glyph_cache = hashmap_init(sizeof(glyph_hash_key_t),
-				   sizeof(glyph_hash_val_t),
-				   0xFFFF + 13,
-				   glyph_hash_dtor, NULL, NULL);
+    Hashmap *glyph_cache;
+    glyph_cache = hashmap_init(library, sizeof(GlyphHashKey),
+                               sizeof(GlyphHashValue),
+                               0xFFFF + 13,
+                               glyph_hash_dtor, glyph_compare, glyph_hash);
+    return glyph_cache;
 }
 
-void ass_glyph_cache_done(void)
+void ass_glyph_cache_done(Hashmap *glyph_cache)
 {
-	hashmap_done(glyph_cache);
+    hashmap_done(glyph_cache);
 }
 
-void ass_glyph_cache_reset(void)
+Hashmap *ass_glyph_cache_reset(Hashmap *glyph_cache)
 {
-	ass_glyph_cache_done();
-	ass_glyph_cache_init();
+    ASS_Library *lib = glyph_cache->library;
+
+    ass_glyph_cache_done(glyph_cache);
+    return ass_glyph_cache_init(lib);
 }
+
+
+//---------------------------------
+// composite cache
+
+static void composite_hash_dtor(void *key, size_t key_size, void *value,
+                                size_t value_size)
+{
+    CompositeHashValue *v = value;
+    free(v->a);
+    free(v->b);
+    free(key);
+    free(value);
+}
+
+void *cache_add_composite(Hashmap *composite_cache,
+                          CompositeHashKey *key,
+                          CompositeHashValue *val)
+{
+    return hashmap_insert(composite_cache, key, val);
+}
+
+/**
+ * \brief Get a composite bitmap from composite cache.
+ * \param key hash key
+ * \return requested hash val or 0 if not found
+*/
+CompositeHashValue *cache_find_composite(Hashmap *composite_cache,
+                                         CompositeHashKey *key)
+{
+    return hashmap_find(composite_cache, key);
+}
+
+Hashmap *ass_composite_cache_init(ASS_Library *library)
+{
+    Hashmap *composite_cache;
+    composite_cache = hashmap_init(library, sizeof(CompositeHashKey),
+                                   sizeof(CompositeHashValue),
+                                   0xFFFF + 13,
+                                   composite_hash_dtor, composite_compare,
+                                   composite_hash);
+    return composite_cache;
+}
+
+void ass_composite_cache_done(Hashmap *composite_cache)
+{
+    hashmap_done(composite_cache);
+}
+
+Hashmap *ass_composite_cache_reset(Hashmap *composite_cache)
+{
+    ASS_Library *lib = composite_cache->library;
+
+    ass_composite_cache_done(composite_cache);
+    return ass_composite_cache_init(lib);
+}

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.h	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,98 +1,119 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#ifndef LIBASS_CACHE_H
+#define LIBASS_CACHE_H
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
+#include "ass.h"
+#include "ass_font.h"
+#include "ass_bitmap.h"
 
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
+typedef void (*HashmapItemDtor) (void *key, size_t key_size,
+                                 void *value, size_t value_size);
+typedef int (*HashmapKeyCompare) (void *key1, void *key2,
+                                  size_t key_size);
+typedef unsigned (*HashmapHash) (void *key, size_t key_size);
 
-#ifndef ASS_CACHE_H
-#define ASS_CACHE_H
+typedef struct hashmap_item {
+    void *key;
+    void *value;
+    struct hashmap_item *next;
+} HashmapItem;
+typedef HashmapItem *hashmap_item_p;
 
-void ass_font_cache_init(void);
-ass_font_t* ass_font_cache_find(ass_font_desc_t* desc);
-void* ass_font_cache_add(ass_font_t* font);
-void ass_font_cache_done(void);
+typedef struct {
+    int nbuckets;
+    size_t key_size, value_size;
+    hashmap_item_p *root;
+    HashmapItemDtor item_dtor;      // a destructor for hashmap key/value pairs
+    HashmapKeyCompare key_compare;
+    HashmapHash hash;
+    size_t cache_size;
+    // stats
+    int hit_count;
+    int miss_count;
+    int count;
+    ASS_Library *library;
+} Hashmap;
 
+Hashmap *hashmap_init(ASS_Library *library, size_t key_size,
+                      size_t value_size, int nbuckets,
+                      HashmapItemDtor item_dtor,
+                      HashmapKeyCompare key_compare,
+                      HashmapHash hash);
+void hashmap_done(Hashmap *map);
+void *hashmap_insert(Hashmap *map, void *key, void *value);
+void *hashmap_find(Hashmap *map, void *key);
 
-// describes a bitmap; bitmaps with equivalents structs are considered identical
-typedef struct bitmap_hash_key_s {
-	char bitmap; // bool : true = bitmap, false = outline
-	ass_font_t* font;
-	double size; // font size
-	uint32_t ch; // character code
-	unsigned outline; // border width, 16.16 fixed point value
-	int bold, italic;
-	char be; // blur edges
+Hashmap *ass_font_cache_init(ASS_Library *library);
+ASS_Font *ass_font_cache_find(Hashmap *, ASS_FontDesc *desc);
+void *ass_font_cache_add(Hashmap *, ASS_Font *font);
+void ass_font_cache_done(Hashmap *);
 
-	unsigned scale_x, scale_y; // 16.16
-	int frx, fry, frz; // signed 16.16
-	int shift_x, shift_y; // shift vector that was added to glyph before applying rotation
-	                      // = 0, if frx = fry = frx = 0
-	                      // = (glyph base point) - (rotation origin), otherwise
-	
-	FT_Vector advance; // subpixel shift vector
-} bitmap_hash_key_t;
+// Create definitions for bitmap_hash_key and glyph_hash_key
+#define CREATE_STRUCT_DEFINITIONS
+#include "ass_cache_template.h"
 
-typedef struct bitmap_hash_val_s {
-	bitmap_t* bm; // the actual bitmaps
-	bitmap_t* bm_o;
-	bitmap_t* bm_s;
-} bitmap_hash_val_t;
+typedef struct {
+    Bitmap *bm;               // the actual bitmaps
+    Bitmap *bm_o;
+    Bitmap *bm_s;
+} BitmapHashValue;
 
-void ass_bitmap_cache_init(void);
-void* cache_add_bitmap(bitmap_hash_key_t* key, bitmap_hash_val_t* val);
-bitmap_hash_val_t* cache_find_bitmap(bitmap_hash_key_t* key);
-void ass_bitmap_cache_reset(void);
-void ass_bitmap_cache_done(void);
+Hashmap *ass_bitmap_cache_init(ASS_Library *library);
+void *cache_add_bitmap(Hashmap *, BitmapHashKey *key,
+                       BitmapHashValue *val);
+BitmapHashValue *cache_find_bitmap(Hashmap *bitmap_cache,
+                                   BitmapHashKey *key);
+Hashmap *ass_bitmap_cache_reset(Hashmap *bitmap_cache);
+void ass_bitmap_cache_done(Hashmap *bitmap_cache);
 
-// describes an outline glyph
-typedef struct glyph_hash_key_s {
-	ass_font_t* font;
-	double size; // font size
-	uint32_t ch; // character code
-	int bold, italic;
-	unsigned scale_x, scale_y; // 16.16
-	FT_Vector advance; // subpixel shift vector
-	unsigned outline; // border width, 16.16
-} glyph_hash_key_t;
 
-typedef struct glyph_hash_val_s {
-	FT_Glyph glyph;
-	FT_Glyph outline_glyph;
-	FT_BBox bbox_scaled; // bbox after scaling, but before rotation
-	FT_Vector advance; // 26.6, advance distance to the next bitmap in line
-} glyph_hash_val_t;
+typedef struct {
+    unsigned char *a;
+    unsigned char *b;
+} CompositeHashValue;
 
-void ass_glyph_cache_init(void);
-void* cache_add_glyph(glyph_hash_key_t* key, glyph_hash_val_t* val);
-glyph_hash_val_t* cache_find_glyph(glyph_hash_key_t* key);
-void ass_glyph_cache_reset(void);
-void ass_glyph_cache_done(void);
+Hashmap *ass_composite_cache_init(ASS_Library *library);
+void *cache_add_composite(Hashmap *, CompositeHashKey *key,
+                          CompositeHashValue *val);
+CompositeHashValue *cache_find_composite(Hashmap *composite_cache,
+                                         CompositeHashKey *key);
+Hashmap *ass_composite_cache_reset(Hashmap *composite_cache);
+void ass_composite_cache_done(Hashmap *composite_cache);
 
-typedef struct hashmap_s hashmap_t; 
-typedef void (*hashmap_item_dtor_t)(void* key, size_t key_size, void* value, size_t value_size);
-typedef int (*hashmap_key_compare_t)(void* key1, void* key2, size_t key_size);
-typedef unsigned (*hashmap_hash_t)(void* key, size_t key_size);
 
-hashmap_t* hashmap_init(size_t key_size, size_t value_size, int nbuckets,
-			hashmap_item_dtor_t item_dtor, hashmap_key_compare_t key_compare,
-			hashmap_hash_t hash);
-void hashmap_done(hashmap_t* map);
-void* hashmap_insert(hashmap_t* map, void* key, void* value);
-void* hashmap_find(hashmap_t* map, void* key);
+typedef struct {
+    FT_Glyph glyph;
+    FT_Glyph outline_glyph;
+    FT_BBox bbox_scaled;        // bbox after scaling, but before rotation
+    FT_Vector advance;          // 26.6, advance distance to the next bitmap in line
+    int asc, desc;              // ascender/descender of a drawing
+} GlyphHashValue;
 
-#endif
+Hashmap *ass_glyph_cache_init(ASS_Library *library);
+void *cache_add_glyph(Hashmap *, GlyphHashKey *key,
+                      GlyphHashValue *val);
+GlyphHashValue *cache_find_glyph(Hashmap *glyph_cache,
+                                 GlyphHashKey *key);
+Hashmap *ass_glyph_cache_reset(Hashmap *glyph_cache);
+void ass_glyph_cache_done(Hashmap *glyph_cache);
 
+#endif                          /* LIBASS_CACHE_H */

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache_template.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache_template.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_cache_template.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -0,0 +1,122 @@
+#ifdef CREATE_STRUCT_DEFINITIONS
+#undef CREATE_STRUCT_DEFINITIONS
+#define START(funcname, structname) \
+    typedef struct structname {
+#define GENERIC(type, member) \
+        type member;
+#define FTVECTOR(member) \
+        FT_Vector member;
+#define BITMAPHASHKEY(member) \
+        BitmapHashKey member;
+#define END(typedefnamename) \
+    } typedefnamename;
+
+#elif defined(CREATE_COMPARISON_FUNCTIONS)
+#undef CREATE_COMPARISON_FUNCTIONS
+#define START(funcname, structname) \
+    static int funcname##_compare(void *key1, void *key2, size_t key_size) \
+    { \
+        struct structname *a = key1; \
+        struct structname *b = key2; \
+        return // conditions follow
+#define GENERIC(type, member) \
+            a->member == b->member &&
+#define FTVECTOR(member) \
+            a->member.x == b->member.x && a->member.y == b->member.y &&
+#define BITMAPHASHKEY(member) \
+            bitmap_compare(&a->member, &b->member, sizeof(a->member)) &&
+#define END(typedefname) \
+            1; \
+    }
+
+#elif defined(CREATE_HASH_FUNCTIONS)
+#undef CREATE_HASH_FUNCTIONS
+#define START(funcname, structname) \
+    static unsigned funcname##_hash(void *buf, size_t len) \
+    { \
+        struct structname *p = buf; \
+        unsigned hval = FNV1_32A_INIT;
+#define GENERIC(type, member) \
+        hval = fnv_32a_buf(&p->member, sizeof(p->member), hval);
+#define FTVECTOR(member) GENERIC(, member.x); GENERIC(, member.y);
+#define BITMAPHASHKEY(member) { \
+        unsigned temp = bitmap_hash(&p->member, sizeof(p->member)); \
+        hval = fnv_32a_buf(&temp, sizeof(temp), hval); \
+        }
+#define END(typedefname) \
+        return hval; \
+    }
+
+#else
+#error missing defines
+#endif
+
+
+
+// describes a bitmap; bitmaps with equivalents structs are considered identical
+START(bitmap, bitmap_hash_key)
+    GENERIC(char, bitmap) // bool : true = bitmap, false = outline
+    GENERIC(ASS_Font *, font)
+    GENERIC(double, size) // font size
+    GENERIC(uint32_t, ch) // character code
+    FTVECTOR(outline) // border width, 16.16 fixed point value
+    GENERIC(int, bold)
+    GENERIC(int, italic)
+    GENERIC(char, be) // blur edges
+    GENERIC(double, blur) // gaussian blur
+    GENERIC(unsigned, scale_x) // 16.16
+    GENERIC(unsigned, scale_y) // 16.16
+    GENERIC(int, frx) // signed 16.16
+    GENERIC(int, fry) // signed 16.16
+    GENERIC(int, frz) // signed 16.16
+    GENERIC(int, fax) // signed 16.16
+    GENERIC(int, fay) // signed 16.16
+    // shift vector that was added to glyph before applying rotation
+    // = 0, if frx = fry = frx = 0
+    // = (glyph base point) - (rotation origin), otherwise
+    GENERIC(int, shift_x)
+    GENERIC(int, shift_y)
+    FTVECTOR(advance) // subpixel shift vector
+    FTVECTOR(shadow_offset) // shadow subpixel shift
+    GENERIC(unsigned, drawing_hash) // hashcode of a drawing
+    GENERIC(unsigned, flags)    // glyph decoration
+    GENERIC(unsigned, border_style)
+END(BitmapHashKey)
+
+// describes an outline glyph
+START(glyph, glyph_hash_key)
+    GENERIC(ASS_Font *, font)
+    GENERIC(double, size) // font size
+    GENERIC(uint32_t, ch) // character code
+    GENERIC(int, bold)
+    GENERIC(int, italic)
+    GENERIC(unsigned, scale_x) // 16.16
+    GENERIC(unsigned, scale_y) // 16.16
+    FTVECTOR(outline) // border width, 16.16
+    GENERIC(unsigned, drawing_hash) // hashcode of a drawing
+    GENERIC(unsigned, flags)    // glyph decoration flags
+    GENERIC(unsigned, border_style)
+END(GlyphHashKey)
+
+// Cache for composited bitmaps
+START(composite, composite_hash_key)
+    GENERIC(int, aw)
+    GENERIC(int, ah)
+    GENERIC(int, bw)
+    GENERIC(int, bh)
+    GENERIC(int, ax)
+    GENERIC(int, ay)
+    GENERIC(int, bx)
+    GENERIC(int, by)
+    GENERIC(int, as)
+    GENERIC(int, bs)
+    GENERIC(unsigned char *, a)
+    GENERIC(unsigned char *, b)
+END(CompositeHashKey)
+
+
+#undef START
+#undef GENERIC
+#undef FTVECTOR
+#undef BITMAPHASHKEY
+#undef END

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_drawing.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_drawing.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_drawing.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -0,0 +1,488 @@
+/*
+ * Copyright (C) 2009 Grigori Goronzy <greg at geekmind.org>
+ *
+ * This file is part of libass.
+ *
+ * Permission to use, copy, modify, and distribute this software for any
+ * purpose with or without fee is hereby granted, provided that the above
+ * copyright notice and this permission notice appear in all copies.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
+ * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
+ * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
+ * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+ * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
+ * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
+ * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
+ */
+
+#include <ft2build.h>
+#include FT_GLYPH_H
+#include FT_OUTLINE_H
+#include FT_BBOX_H
+#include <math.h>
+
+#include "ass_utils.h"
+#include "ass_font.h"
+#include "ass_drawing.h"
+
+#define CURVE_ACCURACY 64.0
+#define GLYPH_INITIAL_POINTS 100
+#define GLYPH_INITIAL_CONTOURS 5
+
+/*
+ * \brief Get and prepare a FreeType glyph
+ */
+static void drawing_make_glyph(ASS_Drawing *drawing, void *fontconfig_priv,
+                               ASS_Font *font)
+{
+    FT_OutlineGlyph glyph;
+
+    // This is hacky...
+    glyph = (FT_OutlineGlyph) ass_font_get_glyph(fontconfig_priv, font,
+                                                 (uint32_t) ' ', 0, 0);
+    if (glyph) {
+        FT_Outline_Done(drawing->ftlibrary, &glyph->outline);
+        FT_Outline_New(drawing->ftlibrary, GLYPH_INITIAL_POINTS,
+                       GLYPH_INITIAL_CONTOURS, &glyph->outline);
+
+        glyph->outline.n_contours = 0;
+        glyph->outline.n_points = 0;
+        glyph->root.advance.x = glyph->root.advance.y = 0;
+    }
+    drawing->glyph = glyph;
+}
+
+/*
+ * \brief Add a single point to a contour.
+ */
+static inline void drawing_add_point(ASS_Drawing *drawing,
+                                     FT_Vector *point)
+{
+    FT_Outline *ol = &drawing->glyph->outline;
+
+    if (ol->n_points >= drawing->max_points) {
+        drawing->max_points *= 2;
+        ol->points = realloc(ol->points, sizeof(FT_Vector) *
+                             drawing->max_points);
+        ol->tags = realloc(ol->tags, drawing->max_points);
+    }
+
+    ol->points[ol->n_points].x = point->x;
+    ol->points[ol->n_points].y = point->y;
+    ol->tags[ol->n_points] = 1;
+    ol->n_points++;
+}
+
+/*
+ * \brief Close a contour and check glyph size overflow.
+ */
+static inline void drawing_close_shape(ASS_Drawing *drawing)
+{
+    FT_Outline *ol = &drawing->glyph->outline;
+
+    if (ol->n_contours >= drawing->max_contours) {
+        drawing->max_contours *= 2;
+        ol->contours = realloc(ol->contours, sizeof(short) *
+                               drawing->max_contours);
+    }
+
+    if (ol->n_points) {
+        ol->contours[ol->n_contours] = ol->n_points - 1;
+        ol->n_contours++;
+    }
+}
+
+/*
+ * \brief Prepare drawing for parsing.  This just sets a few parameters.
+ */
+static void drawing_prepare(ASS_Drawing *drawing)
+{
+    // Scaling parameters
+    drawing->point_scale_x = drawing->scale_x *
+                             64.0 / (1 << (drawing->scale - 1));
+    drawing->point_scale_y = drawing->scale_y *
+                             64.0 / (1 << (drawing->scale - 1));
+}
+
+/*
+ * \brief Finish a drawing.  This only sets the horizontal advance according
+ * to the glyph's bbox at the moment.
+ */
+static void drawing_finish(ASS_Drawing *drawing, int raw_mode)
+{
+    int i, offset;
+    FT_BBox bbox = drawing->cbox;
+    FT_Outline *ol = &drawing->glyph->outline;
+
+    // Close the last contour
+    drawing_close_shape(drawing);
+
+    ass_msg(drawing->library, MSGL_V,
+            "Parsed drawing with %d points and %d contours", ol->n_points,
+            ol->n_contours);
+
+    if (raw_mode)
+        return;
+
+    drawing->glyph->root.advance.x = d6_to_d16(bbox.xMax - bbox.xMin);
+
+    drawing->desc = double_to_d6(-drawing->pbo * drawing->scale_y);
+    drawing->asc = bbox.yMax - bbox.yMin + drawing->desc;
+
+    // Place it onto the baseline
+    offset = (bbox.yMax - bbox.yMin) + double_to_d6(-drawing->pbo *
+                                                    drawing->scale_y);
+    for (i = 0; i < ol->n_points; i++)
+        ol->points[i].y += offset;
+}
+
+/*
+ * \brief Check whether a number of items on the list is available
+ */
+static int token_check_values(ASS_DrawingToken *token, int i, int type)
+{
+    int j;
+    for (j = 0; j < i; j++) {
+        if (!token || token->type != type) return 0;
+        token = token->next;
+    }
+
+    return 1;
+}
+
+/*
+ * \brief Tokenize a drawing string into a list of ASS_DrawingToken
+ * This also expands points for closing b-splines
+ */
+static ASS_DrawingToken *drawing_tokenize(char *str)
+{
+    char *p = str;
+    int i, val, type = -1, is_set = 0;
+    FT_Vector point = {0, 0};
+
+    ASS_DrawingToken *root = NULL, *tail = NULL, *spline_start = NULL;
+
+    while (*p) {
+        if (*p == 'c' && spline_start) {
+            // Close b-splines: add the first three points of the b-spline
+            // back to the end
+            if (token_check_values(spline_start->next, 2, TOKEN_B_SPLINE)) {
+                for (i = 0; i < 3; i++) {
+                    tail->next = calloc(1, sizeof(ASS_DrawingToken));
+                    tail->next->prev = tail;
+                    tail = tail->next;
+                    tail->type = TOKEN_B_SPLINE;
+                    tail->point = spline_start->point;
+                    spline_start = spline_start->next;
+                }
+                spline_start = NULL;
+            }
+        } else if (!is_set && mystrtoi(&p, &val)) {
+            point.x = val;
+            is_set = 1;
+            p--;
+        } else if (is_set == 1 && mystrtoi(&p, &val)) {
+            point.y = val;
+            is_set = 2;
+            p--;
+        } else if (*p == 'm')
+            type = TOKEN_MOVE;
+        else if (*p == 'n')
+            type = TOKEN_MOVE_NC;
+        else if (*p == 'l')
+            type = TOKEN_LINE;
+        else if (*p == 'b')
+            type = TOKEN_CUBIC_BEZIER;
+        else if (*p == 'q')
+            type = TOKEN_CONIC_BEZIER;
+        else if (*p == 's')
+            type = TOKEN_B_SPLINE;
+        // We're simply ignoring TOKEN_EXTEND_B_SPLINE here.
+        // This is not harmful at all, since it can be ommitted with
+        // similar result (the spline is extended anyway).
+
+        if (type != -1 && is_set == 2) {
+            if (root) {
+                tail->next = calloc(1, sizeof(ASS_DrawingToken));
+                tail->next->prev = tail;
+                tail = tail->next;
+            } else
+                root = tail = calloc(1, sizeof(ASS_DrawingToken));
+            tail->type = type;
+            tail->point = point;
+            is_set = 0;
+            if (type == TOKEN_B_SPLINE && !spline_start)
+                spline_start = tail->prev;
+        }
+        p++;
+    }
+
+    return root;
+}
+
+/*
+ * \brief Free a list of tokens
+ */
+static void drawing_free_tokens(ASS_DrawingToken *token)
+{
+    while (token) {
+        ASS_DrawingToken *at = token;
+        token = token->next;
+        free(at);
+    }
+}
+
+/*
+ * \brief Update drawing cbox
+ */
+static inline void update_cbox(ASS_Drawing *drawing, FT_Vector *point)
+{
+    FT_BBox *box = &drawing->cbox;
+
+    box->xMin = FFMIN(box->xMin, point->x);
+    box->xMax = FFMAX(box->xMax, point->x);
+    box->yMin = FFMIN(box->yMin, point->y);
+    box->yMax = FFMAX(box->yMax, point->y);
+}
+
+/*
+ * \brief Translate and scale a point coordinate according to baseline
+ * offset and scale.
+ */
+static inline void translate_point(ASS_Drawing *drawing, FT_Vector *point)
+{
+    point->x = drawing->point_scale_x * point->x;
+    point->y = drawing->point_scale_y * -point->y;
+
+    update_cbox(drawing, point);
+}
+
+/*
+ * \brief Evaluate a curve into lines
+ * This curve evaluator is also used in VSFilter (RTS.cpp); it's a simple
+ * implementation of the De Casteljau algorithm.
+ */
+static void drawing_evaluate_curve(ASS_Drawing *drawing,
+                                   ASS_DrawingToken *token, char spline,
+                                   int started)
+{
+    double cx3, cx2, cx1, cx0, cy3, cy2, cy1, cy0;
+    double t, h, max_accel, max_accel1, max_accel2;
+    FT_Vector cur = {0, 0};
+
+    cur = token->point;
+    translate_point(drawing, &cur);
+    int x0 = cur.x;
+    int y0 = cur.y;
+    token = token->next;
+    cur = token->point;
+    translate_point(drawing, &cur);
+    int x1 = cur.x;
+    int y1 = cur.y;
+    token = token->next;
+    cur = token->point;
+    translate_point(drawing, &cur);
+    int x2 = cur.x;
+    int y2 = cur.y;
+    token = token->next;
+    cur = token->point;
+    translate_point(drawing, &cur);
+    int x3 = cur.x;
+    int y3 = cur.y;
+
+    if (spline) {
+        // 1   [-1 +3 -3 +1]
+        // - * [+3 -6 +3  0]
+        // 6   [-3  0 +3  0]
+        //	   [+1 +4 +1  0]
+
+        double div6 = 1.0/6.0;
+
+        cx3 = div6*(-  x0+3*x1-3*x2+x3);
+        cx2 = div6*( 3*x0-6*x1+3*x2);
+        cx1 = div6*(-3*x0	   +3*x2);
+        cx0 = div6*(   x0+4*x1+1*x2);
+
+        cy3 = div6*(-  y0+3*y1-3*y2+y3);
+        cy2 = div6*( 3*y0-6*y1+3*y2);
+        cy1 = div6*(-3*y0     +3*y2);
+        cy0 = div6*(   y0+4*y1+1*y2);
+    } else {
+        // [-1 +3 -3 +1]
+        // [+3 -6 +3  0]
+        // [-3 +3  0  0]
+        // [+1  0  0  0]
+
+        cx3 = -  x0+3*x1-3*x2+x3;
+        cx2 =  3*x0-6*x1+3*x2;
+        cx1 = -3*x0+3*x1;
+        cx0 =    x0;
+
+        cy3 = -  y0+3*y1-3*y2+y3;
+        cy2 =  3*y0-6*y1+3*y2;
+        cy1 = -3*y0+3*y1;
+        cy0 =    y0;
+    }
+
+    max_accel1 = fabs(2 * cy2) + fabs(6 * cy3);
+    max_accel2 = fabs(2 * cx2) + fabs(6 * cx3);
+
+    max_accel = FFMAX(max_accel1, max_accel2);
+    h = 1.0;
+
+    if (max_accel > CURVE_ACCURACY)
+        h = sqrt(CURVE_ACCURACY / max_accel);
+
+    if (!started) {
+        cur.x = cx0;
+        cur.y = cy0;
+        drawing_add_point(drawing, &cur);
+    }
+
+    for (t = 0; t < 1.0; t += h) {
+        cur.x = cx0 + t * (cx1 + t * (cx2 + t * cx3));
+        cur.y = cy0 + t * (cy1 + t * (cy2 + t * cy3));
+        drawing_add_point(drawing, &cur);
+    }
+
+    cur.x = cx0 + cx1 + cx2 + cx3;
+    cur.y = cy0 + cy1 + cy2 + cy3;
+    drawing_add_point(drawing, &cur);
+}
+
+/*
+ * \brief Create and initialize a new drawing and return it
+ */
+ASS_Drawing *ass_drawing_new(void *fontconfig_priv, ASS_Font *font,
+                             FT_Library lib)
+{
+    ASS_Drawing *drawing;
+
+    drawing = calloc(1, sizeof(*drawing));
+    drawing->text = calloc(1, DRAWING_INITIAL_SIZE);
+    drawing->size = DRAWING_INITIAL_SIZE;
+    drawing->cbox.xMin = drawing->cbox.yMin = INT_MAX;
+    drawing->cbox.xMax = drawing->cbox.yMax = INT_MIN;
+    drawing->fontconfig_priv = fontconfig_priv;
+    drawing->font = font;
+    drawing->ftlibrary = lib;
+    drawing->library = font->library;
+
+    drawing->scale_x = 1.;
+    drawing->scale_y = 1.;
+    drawing->max_contours = GLYPH_INITIAL_CONTOURS;
+    drawing->max_points = GLYPH_INITIAL_POINTS;
+
+    return drawing;
+}
+
+/*
+ * \brief Free a drawing
+ */
+void ass_drawing_free(ASS_Drawing* drawing)
+{
+    if (drawing) {
+        free(drawing->text);
+    }
+    free(drawing);
+}
+
+/*
+ * \brief Add one ASCII character to the drawing text buffer
+ */
+void ass_drawing_add_char(ASS_Drawing* drawing, char symbol)
+{
+    drawing->text[drawing->i++] = symbol;
+    drawing->text[drawing->i] = 0;
+
+    if (drawing->i + 1 >= drawing->size) {
+        drawing->size *= 2;
+        drawing->text = realloc(drawing->text, drawing->size);
+    }
+}
+
+/*
+ * \brief Create a hashcode for the drawing
+ * XXX: To avoid collisions a better hash algorithm might be useful.
+ */
+void ass_drawing_hash(ASS_Drawing* drawing)
+{
+    drawing->hash = fnv_32a_str(drawing->text, FNV1_32A_INIT);
+}
+
+/*
+ * \brief Convert token list to outline.  Calls the line and curve evaluators.
+ */
+FT_OutlineGlyph *ass_drawing_parse(ASS_Drawing *drawing, int raw_mode)
+{
+    int started = 0;
+    ASS_DrawingToken *token;
+    FT_Vector pen = {0, 0};
+
+    if (drawing->font)
+        drawing_make_glyph(drawing, drawing->fontconfig_priv, drawing->font);
+    if (!drawing->glyph)
+        return NULL;
+
+    drawing->tokens = drawing_tokenize(drawing->text);
+    drawing_prepare(drawing);
+
+    token = drawing->tokens;
+    while (token) {
+        // Draw something according to current command
+        switch (token->type) {
+        case TOKEN_MOVE_NC:
+            pen = token->point;
+            translate_point(drawing, &pen);
+            token = token->next;
+            break;
+        case TOKEN_MOVE:
+            pen = token->point;
+            translate_point(drawing, &pen);
+            if (started) {
+                drawing_close_shape(drawing);
+                started = 0;
+            }
+            token = token->next;
+            break;
+        case TOKEN_LINE: {
+            FT_Vector to;
+            to = token->point;
+            translate_point(drawing, &to);
+            if (!started) drawing_add_point(drawing, &pen);
+            drawing_add_point(drawing, &to);
+            started = 1;
+            token = token->next;
+            break;
+        }
+        case TOKEN_CUBIC_BEZIER:
+            if (token_check_values(token, 3, TOKEN_CUBIC_BEZIER) &&
+                token->prev) {
+                drawing_evaluate_curve(drawing, token->prev, 0, started);
+                token = token->next;
+                token = token->next;
+                token = token->next;
+                started = 1;
+            } else
+                token = token->next;
+            break;
+        case TOKEN_B_SPLINE:
+            if (token_check_values(token, 3, TOKEN_B_SPLINE) &&
+                token->prev) {
+                drawing_evaluate_curve(drawing, token->prev, 1, started);
+                token = token->next;
+                started = 1;
+            } else
+                token = token->next;
+            break;
+        default:
+            token = token->next;
+            break;
+        }
+    }
+
+    drawing_finish(drawing, raw_mode);
+    drawing_free_tokens(drawing->tokens);
+    return &drawing->glyph;
+}

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_drawing.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_drawing.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_drawing.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -0,0 +1,80 @@
+/*
+ * Copyright (C) 2009 Grigori Goronzy <greg at geekmind.org>
+ *
+ * This file is part of libass.
+ *
+ * Permission to use, copy, modify, and distribute this software for any
+ * purpose with or without fee is hereby granted, provided that the above
+ * copyright notice and this permission notice appear in all copies.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
+ * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
+ * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
+ * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+ * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
+ * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
+ * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
+ */
+
+#ifndef LIBASS_DRAWING_H
+#define LIBASS_DRAWING_H
+
+#include <ft2build.h>
+#include FT_GLYPH_H
+
+#include "ass.h"
+
+#define DRAWING_INITIAL_SIZE 256
+
+typedef enum {
+    TOKEN_MOVE,
+    TOKEN_MOVE_NC,
+    TOKEN_LINE,
+    TOKEN_CUBIC_BEZIER,
+    TOKEN_CONIC_BEZIER,
+    TOKEN_B_SPLINE,
+    TOKEN_EXTEND_SPLINE,
+    TOKEN_CLOSE
+} ASS_TokenType;
+
+typedef struct ass_drawing_token {
+    ASS_TokenType type;
+    FT_Vector point;
+    struct ass_drawing_token *next;
+    struct ass_drawing_token *prev;
+} ASS_DrawingToken;
+
+typedef struct {
+    char *text; // drawing string
+    int i;      // text index
+    int scale;  // scale (1-64) for subpixel accuracy
+    double pbo; // drawing will be shifted in y direction by this amount
+    double scale_x;     // FontScaleX
+    double scale_y;     // FontScaleY
+    int asc;            // ascender
+    int desc;           // descender
+    FT_OutlineGlyph glyph;  // the "fake" glyph created for later rendering
+    int hash;           // hash value (for caching)
+
+    // private
+    FT_Library ftlibrary;   // needed for font ops
+    ASS_Font *font;         // dito
+    void *fontconfig_priv;  // dito
+    ASS_Library *library;
+    int size;           // current buffer size
+    ASS_DrawingToken *tokens;    // tokenized drawing
+    int max_points;     // current maximum size
+    int max_contours;
+    double point_scale_x;
+    double point_scale_y;
+    FT_BBox cbox;   // bounding box, or let's say... VSFilter's idea of it
+} ASS_Drawing;
+
+ASS_Drawing *ass_drawing_new(void *fontconfig_priv, ASS_Font *font,
+                             FT_Library lib);
+void ass_drawing_free(ASS_Drawing* drawing);
+void ass_drawing_add_char(ASS_Drawing* drawing, char symbol);
+void ass_drawing_hash(ASS_Drawing* drawing);
+FT_OutlineGlyph *ass_drawing_parse(ASS_Drawing *drawing, int raw_mode);
+
+#endif /* LIBASS_DRAWING_H */

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.c	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,31 +1,33 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#include "ADM_coreConfig.h"
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-//#include "config.h"
-
 #include <inttypes.h>
 #include <ft2build.h>
 #include FT_FREETYPE_H
 #include FT_SYNTHESIS_H
 #include FT_GLYPH_H
 #include FT_TRUETYPE_TABLES_H
+#include FT_OUTLINE_H
+#include <strings.h>
 
 #include "ass.h"
 #include "ass_library.h"
@@ -34,207 +36,225 @@
 #include "ass_cache.h"
 #include "ass_fontconfig.h"
 #include "ass_utils.h"
-#include "mputils.h"
 
+#define VERTICAL_LOWER_BOUND 0x02f1
+
 /**
- * Select Microfost Unicode CharMap, if the font has one.
+ * Select a good charmap, prefer Microsoft Unicode charmaps.
  * Otherwise, let FreeType decide.
  */
-static void charmap_magic(FT_Face face)
+static void charmap_magic(ASS_Library *library, FT_Face face)
 {
-	int i;
-	for (i = 0; i < face->num_charmaps; ++i) {
-		FT_CharMap cmap = face->charmaps[i];
-		unsigned pid = cmap->platform_id;
-		unsigned eid = cmap->encoding_id;
-		if (pid == 3 /*microsoft*/ && (eid == 1 /*unicode bmp*/ || eid == 10 /*full unicode*/)) {
-			FT_Set_Charmap(face, cmap);
-			return;
-		}
-	}
+    int i;
+    int ms_cmap = -1;
 
-	if (!face->charmap) {
-		if (face->num_charmaps == 0) {
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NoCharmaps);
-			return;
-		}
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NoCharmapAutodetected);
-		FT_Set_Charmap(face, face->charmaps[0]);
-		return;
-	}
-}
+    // Search for a Microsoft Unicode cmap
+    for (i = 0; i < face->num_charmaps; ++i) {
+        FT_CharMap cmap = face->charmaps[i];
+        unsigned pid = cmap->platform_id;
+        unsigned eid = cmap->encoding_id;
+        if (pid == 3 /*microsoft */
+            && (eid == 1 /*unicode bmp */
+                || eid == 10 /*full unicode */ )) {
+            FT_Set_Charmap(face, cmap);
+            return;
+        } else if (pid == 3 && ms_cmap < 0)
+            ms_cmap = i;
+    }
 
-static void update_transform(ass_font_t* font)
-{
-	int i;
-	FT_Matrix m;
-	m.xx = double_to_d16(font->scale_x);
-	m.yy = double_to_d16(font->scale_y);
-	m.xy = m.yx = 0;
-	for (i = 0; i < font->n_faces; ++i)
-		FT_Set_Transform(font->faces[i], &m, &font->v);
+    // Try the first Microsoft cmap if no Microsoft Unicode cmap was found
+    if (ms_cmap >= 0) {
+        FT_CharMap cmap = face->charmaps[ms_cmap];
+        FT_Set_Charmap(face, cmap);
+        return;
+    }
+
+    if (!face->charmap) {
+        if (face->num_charmaps == 0) {
+            ass_msg(library, MSGL_WARN, "Font face with no charmaps");
+            return;
+        }
+        ass_msg(library, MSGL_WARN,
+                "No charmap autodetected, trying the first one");
+        FT_Set_Charmap(face, face->charmaps[0]);
+        return;
+    }
 }
 
 /**
  * \brief find a memory font by name
  */
-static int find_font(ass_library_t* library, char* name)
+static int find_font(ASS_Library *library, char *name)
 {
-	int i;
-	for (i = 0; i < library->num_fontdata; ++i)
-		if (strcasecmp(name, library->fontdata[i].name) == 0)
-			return i;
-	return -1;
+    int i;
+    for (i = 0; i < library->num_fontdata; ++i)
+        if (strcasecmp(name, library->fontdata[i].name) == 0)
+            return i;
+    return -1;
 }
 
 static void face_set_size(FT_Face face, double size);
 
 static void buggy_font_workaround(FT_Face face)
 {
-	// Some fonts have zero Ascender/Descender fields in 'hhea' table.
-	// In this case, get the information from 'os2' table or, as
-	// a last resort, from face.bbox.
-	if (face->ascender + face->descender == 0 || face->height == 0) {
-		TT_OS2 *os2 = FT_Get_Sfnt_Table(face, ft_sfnt_os2);
-		if (os2) {
-			face->ascender = os2->sTypoAscender;
-			face->descender = os2->sTypoDescender;
-			face->height = face->ascender - face->descender;
-		} else {
-			face->ascender = face->bbox.yMax;
-			face->descender = face->bbox.yMin;
-			face->height = face->ascender - face->descender;
-		}
-	}
+    // Some fonts have zero Ascender/Descender fields in 'hhea' table.
+    // In this case, get the information from 'os2' table or, as
+    // a last resort, from face.bbox.
+    if (face->ascender + face->descender == 0 || face->height == 0) {
+        TT_OS2 *os2 = FT_Get_Sfnt_Table(face, ft_sfnt_os2);
+        if (os2) {
+            face->ascender = os2->sTypoAscender;
+            face->descender = os2->sTypoDescender;
+            face->height = face->ascender - face->descender;
+        } else {
+            face->ascender = face->bbox.yMax;
+            face->descender = face->bbox.yMin;
+            face->height = face->ascender - face->descender;
+        }
+    }
 }
 
 /**
- * \brief Select a face with the given charcode and add it to ass_font_t
+ * \brief Select a face with the given charcode and add it to ASS_Font
  * \return index of the new face in font->faces, -1 if failed
  */
-static int add_face(void* fc_priv, ass_font_t* font, uint32_t ch)
+static int add_face(void *fc_priv, ASS_Font *font, uint32_t ch)
 {
-	char* path;
-	int index;
-	FT_Face face;
-	int error;
-	int mem_idx;
-	
-	if (font->n_faces == ASS_FONT_MAX_FACES)
-		return -1;
-	
-	path = fontconfig_select(fc_priv, font->desc.family, font->desc.bold,
-					      font->desc.italic, &index, ch);
+    char *path;
+    int index;
+    FT_Face face;
+    int error;
+    int mem_idx;
 
-	mem_idx = find_font(font->library, path);
-	if (mem_idx >= 0) {
-		error = FT_New_Memory_Face(font->ftlibrary, (unsigned char*)font->library->fontdata[mem_idx].data,
-					   font->library->fontdata[mem_idx].size, 0, &face);
-		if (error) {
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorOpeningMemoryFont, path);
-			return -1;
-		}
-	} else {
-		error = FT_New_Face(font->ftlibrary, path, index, &face);
-		if (error) {
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorOpeningFont, path, index);
-			return -1;
-		}
-	}
-	charmap_magic(face);
-	buggy_font_workaround(face);
-	
-	font->faces[font->n_faces++] = face;
-	update_transform(font);
-	face_set_size(face, font->size);
-	return font->n_faces - 1;
+    if (font->n_faces == ASS_FONT_MAX_FACES)
+        return -1;
+
+    path =
+        fontconfig_select(font->library, fc_priv, font->desc.family,
+                          font->desc.treat_family_as_pattern,
+                          font->desc.bold, font->desc.italic, &index, ch);
+    if (!path)
+        return -1;
+
+    mem_idx = find_font(font->library, path);
+    if (mem_idx >= 0) {
+        error =
+            FT_New_Memory_Face(font->ftlibrary,
+                               (unsigned char *) font->library->
+                               fontdata[mem_idx].data,
+                               font->library->fontdata[mem_idx].size, index,
+                               &face);
+        if (error) {
+            ass_msg(font->library, MSGL_WARN,
+                    "Error opening memory font: '%s'", path);
+            free(path);
+            return -1;
+        }
+    } else {
+        error = FT_New_Face(font->ftlibrary, path, index, &face);
+        if (error) {
+            ass_msg(font->library, MSGL_WARN,
+                    "Error opening font: '%s', %d", path, index);
+            free(path);
+            return -1;
+        }
+    }
+    charmap_magic(font->library, face);
+    buggy_font_workaround(face);
+
+    font->faces[font->n_faces++] = face;
+    face_set_size(face, font->size);
+    free(path);
+    return font->n_faces - 1;
 }
 
 /**
- * \brief Create a new ass_font_t according to "desc" argument
+ * \brief Create a new ASS_Font according to "desc" argument
  */
-ass_font_t* ass_font_new(ass_library_t* library, FT_Library ftlibrary, void* fc_priv, ass_font_desc_t* desc)
+ASS_Font *ass_font_new(void *font_cache, ASS_Library *library,
+                       FT_Library ftlibrary, void *fc_priv,
+                       ASS_FontDesc *desc)
 {
-	int error;
-	ass_font_t* fontp;
-	ass_font_t font;
+    int error;
+    ASS_Font *fontp;
+    ASS_Font font;
 
-	fontp = ass_font_cache_find(desc);
-	if (fontp)
-		return fontp;
-	
-	font.library = library;
-	font.ftlibrary = ftlibrary;
-	font.n_faces = 0;
-	font.desc.family = strdup(desc->family);
-	font.desc.bold = desc->bold;
-	font.desc.italic = desc->italic;
+    fontp = ass_font_cache_find((Hashmap *) font_cache, desc);
+    if (fontp)
+        return fontp;
 
-	font.scale_x = font.scale_y = 1.;
-	font.v.x = font.v.y = 0;
-	font.size = 0.;
+    font.library = library;
+    font.ftlibrary = ftlibrary;
+    font.n_faces = 0;
+    font.desc.family = strdup(desc->family);
+    font.desc.treat_family_as_pattern = desc->treat_family_as_pattern;
+    font.desc.bold = desc->bold;
+    font.desc.italic = desc->italic;
+    font.desc.vertical = desc->vertical;
 
-	error = add_face(fc_priv, &font, 0);
-	if (error == -1) {
-		free(font.desc.family);
-		return 0;
-	} else
-		return ass_font_cache_add(&font);
+    font.scale_x = font.scale_y = 1.;
+    font.v.x = font.v.y = 0;
+    font.size = 0.;
+
+    error = add_face(fc_priv, &font, 0);
+    if (error == -1) {
+        free(font.desc.family);
+        return 0;
+    } else
+        return ass_font_cache_add((Hashmap *) font_cache, &font);
 }
 
 /**
  * \brief Set font transformation matrix and shift vector
  **/
-void ass_font_set_transform(ass_font_t* font, double scale_x, double scale_y, FT_Vector* v)
+void ass_font_set_transform(ASS_Font *font, double scale_x,
+                            double scale_y, FT_Vector *v)
 {
-	font->scale_x = scale_x;
-	font->scale_y = scale_y;
-	font->v.x = v->x;
-	font->v.y = v->y;
-	update_transform(font);
+    font->scale_x = scale_x;
+    font->scale_y = scale_y;
+    if (v) {
+        font->v.x = v->x;
+        font->v.y = v->y;
+    }
 }
 
 static void face_set_size(FT_Face face, double size)
 {
-#if (FREETYPE_MAJOR > 2) || ((FREETYPE_MAJOR == 2) && (FREETYPE_MINOR > 1))
-	TT_HoriHeader *hori = FT_Get_Sfnt_Table(face, ft_sfnt_hhea);
-	TT_OS2 *os2 = FT_Get_Sfnt_Table(face, ft_sfnt_os2);
-	double mscale = 1.;
-	FT_Size_RequestRec rq;
-	FT_Size_Metrics *m = &face->size->metrics;
-	// VSFilter uses metrics from TrueType OS/2 table
-	// The idea was borrowed from asa (http://asa.diac24.net)
-	if (hori && os2) {
-		int hori_height = hori->Ascender - hori->Descender;
-		int os2_height = os2->usWinAscent + os2->usWinDescent;
-		if (hori_height && os2_height)
-			mscale = (double)hori_height / os2_height;
-	}
-	memset(&rq, 0, sizeof(rq));
-	rq.type = FT_SIZE_REQUEST_TYPE_REAL_DIM;
-	rq.width = 0;
-	rq.height = double_to_d6(size * mscale);
-	rq.horiResolution = rq.vertResolution = 0;
-	FT_Request_Size(face, &rq);
-	m->ascender /= mscale;
-	m->descender /= mscale;
-	m->height /= mscale;
-#else
-	FT_Set_Char_Size(face, 0, double_to_d6(size), 0, 0);
-#endif
+    TT_HoriHeader *hori = FT_Get_Sfnt_Table(face, ft_sfnt_hhea);
+    TT_OS2 *os2 = FT_Get_Sfnt_Table(face, ft_sfnt_os2);
+    double mscale = 1.;
+    FT_Size_RequestRec rq;
+    FT_Size_Metrics *m = &face->size->metrics;
+    // VSFilter uses metrics from TrueType OS/2 table
+    // The idea was borrowed from asa (http://asa.diac24.net)
+    if (hori && os2) {
+        int hori_height = hori->Ascender - hori->Descender;
+        int os2_height = os2->usWinAscent + os2->usWinDescent;
+        if (hori_height && os2_height)
+            mscale = (double) hori_height / os2_height;
+    }
+    memset(&rq, 0, sizeof(rq));
+    rq.type = FT_SIZE_REQUEST_TYPE_REAL_DIM;
+    rq.width = 0;
+    rq.height = double_to_d6(size * mscale);
+    rq.horiResolution = rq.vertResolution = 0;
+    FT_Request_Size(face, &rq);
+    m->ascender /= mscale;
+    m->descender /= mscale;
+    m->height /= mscale;
 }
 
 /**
  * \brief Set font size
  **/
-void ass_font_set_size(ass_font_t* font, double size)
+void ass_font_set_size(ASS_Font *font, double size)
 {
-	int i;
-	if (font->size != size) {
-		font->size = size;
-		for (i = 0; i < font->n_faces; ++i)
-			face_set_size(font->faces[i], size);
-	}
+    int i;
+    if (font->size != size) {
+        font->size = size;
+        for (i = 0; i < font->n_faces; ++i)
+            face_set_size(font->faces[i], size);
+    }
 }
 
 /**
@@ -242,129 +262,433 @@
  * \param ch character code
  * The values are extracted from the font face that provides glyphs for the given character
  **/
-void ass_font_get_asc_desc(ass_font_t* font, uint32_t ch, int* asc, int* desc)
+void ass_font_get_asc_desc(ASS_Font *font, uint32_t ch, int *asc,
+                           int *desc)
 {
-	int i;
-	for (i = 0; i < font->n_faces; ++i) {
-		FT_Face face = font->faces[i];
-		if (FT_Get_Char_Index(face, ch)) {
-			int v, v2;
-			v = face->size->metrics.ascender;
-			v2 = FT_MulFix(face->bbox.yMax, face->size->metrics.y_scale);
-			*asc = (v > v2 * 0.9) ? v : v2;
-				
-			v = - face->size->metrics.descender;
-			v2 = - FT_MulFix(face->bbox.yMin, face->size->metrics.y_scale);
-			*desc = (v > v2 * 0.9) ? v : v2;
-			return;
-		}
-	}
-	
-	*asc = *desc = 0;
+    int i;
+    for (i = 0; i < font->n_faces; ++i) {
+        FT_Face face = font->faces[i];
+        TT_OS2 *os2 = FT_Get_Sfnt_Table(face, ft_sfnt_os2);
+        if (FT_Get_Char_Index(face, ch)) {
+            int y_scale = face->size->metrics.y_scale;
+            if (os2) {
+                *asc = FT_MulFix(os2->usWinAscent, y_scale);
+                *desc = FT_MulFix(os2->usWinDescent, y_scale);
+            } else {
+                *asc = FT_MulFix(face->ascender, y_scale);
+                *desc = FT_MulFix(-face->descender, y_scale);
+            }
+            if (font->desc.vertical && ch >= VERTICAL_LOWER_BOUND) {
+                *asc = FT_MulFix(face->max_advance_width, y_scale);
+            }
+            return;
+        }
+    }
+
+    *asc = *desc = 0;
 }
 
+/*
+ * Strike a glyph with a horizontal line; it's possible to underline it
+ * and/or strike through it.  For the line's position and size, truetype
+ * tables are consulted.  Obviously this relies on the data in the tables
+ * being accurate.
+ *
+ */
+static int ass_strike_outline_glyph(FT_Face face, ASS_Font *font,
+                                    FT_Glyph glyph, int under, int through)
+{
+    TT_OS2 *os2 = FT_Get_Sfnt_Table(face, ft_sfnt_os2);
+    TT_Postscript *ps = FT_Get_Sfnt_Table(face, ft_sfnt_post);
+    FT_Outline *ol = &((FT_OutlineGlyph) glyph)->outline;
+    int bear, advance, y_scale, i, dir;
+
+    if (!under && !through)
+        return 0;
+
+    // Grow outline
+    i = (under ? 4 : 0) + (through ? 4 : 0);
+    ol->points = realloc(ol->points, sizeof(FT_Vector) *
+                         (ol->n_points + i));
+    ol->tags = realloc(ol->tags, ol->n_points + i);
+    i = !!under + !!through;
+    ol->contours = realloc(ol->contours, sizeof(short) *
+                           (ol->n_contours + i));
+
+    // If the bearing is negative, the glyph starts left of the current
+    // pen position
+    bear = FFMIN(face->glyph->metrics.horiBearingX, 0);
+    // We're adding half a pixel to avoid small gaps
+    advance = d16_to_d6(glyph->advance.x) + 32;
+    y_scale = face->size->metrics.y_scale;
+
+    // Reverse drawing direction for non-truetype fonts
+    dir = FT_Outline_Get_Orientation(ol);
+
+    // Add points to the outline
+    if (under && ps) {
+        int pos, size;
+        pos = FT_MulFix(ps->underlinePosition, y_scale * font->scale_y);
+        size = FT_MulFix(ps->underlineThickness,
+                         y_scale * font->scale_y / 2);
+
+        if (pos > 0 || size <= 0)
+            return 1;
+
+        FT_Vector points[4] = {
+            {.x = bear,      .y = pos + size},
+            {.x = advance,   .y = pos + size},
+            {.x = advance,   .y = pos - size},
+            {.x = bear,      .y = pos - size},
+        };
+
+        if (dir == FT_ORIENTATION_TRUETYPE) {
+            for (i = 0; i < 4; i++) {
+                ol->points[ol->n_points] = points[i];
+                ol->tags[ol->n_points++] = 1;
+            }
+        } else {
+            for (i = 3; i >= 0; i--) {
+                ol->points[ol->n_points] = points[i];
+                ol->tags[ol->n_points++] = 1;
+            }
+        }
+
+        ol->contours[ol->n_contours++] = ol->n_points - 1;
+    }
+
+    if (through && os2) {
+        int pos, size;
+        pos = FT_MulFix(os2->yStrikeoutPosition, y_scale * font->scale_y);
+        size = FT_MulFix(os2->yStrikeoutSize, y_scale * font->scale_y / 2);
+
+        if (pos < 0 || size <= 0)
+            return 1;
+
+        FT_Vector points[4] = {
+            {.x = bear,      .y = pos + size},
+            {.x = advance,   .y = pos + size},
+            {.x = advance,   .y = pos - size},
+            {.x = bear,      .y = pos - size},
+        };
+
+        if (dir == FT_ORIENTATION_TRUETYPE) {
+            for (i = 0; i < 4; i++) {
+                ol->points[ol->n_points] = points[i];
+                ol->tags[ol->n_points++] = 1;
+            }
+        } else {
+            for (i = 3; i >= 0; i--) {
+                ol->points[ol->n_points] = points[i];
+                ol->tags[ol->n_points++] = 1;
+            }
+        }
+
+        ol->contours[ol->n_contours++] = ol->n_points - 1;
+    }
+
+    return 0;
+}
+
 /**
+ * Slightly embold a glyph without touching its metrics
+ */
+static void ass_glyph_embolden(FT_GlyphSlot slot)
+{
+    int str;
+
+    if (slot->format != FT_GLYPH_FORMAT_OUTLINE)
+        return;
+
+    str = FT_MulFix(slot->face->units_per_EM,
+                    slot->face->size->metrics.y_scale) / 64;
+
+    FT_Outline_Embolden(&slot->outline, str);
+}
+
+/**
  * \brief Get a glyph
  * \param ch character code
  **/
-FT_Glyph ass_font_get_glyph(void* fontconfig_priv, ass_font_t* font, uint32_t ch, ass_hinting_t hinting)
+FT_Glyph ass_font_get_glyph(void *fontconfig_priv, ASS_Font *font,
+                            uint32_t ch, ASS_Hinting hinting, int deco)
 {
-	int error;
-	int index = 0;
-	int i;
-	FT_Glyph glyph;
-	FT_Face face = 0;
-	int flags = 0;
+    int error;
+    int index = 0;
+    int i;
+    FT_Glyph glyph;
+    FT_Face face = 0;
+    int flags = 0;
+    int vertical = font->desc.vertical;
 
-	if (ch < 0x20)
-		return 0;
-	if (font->n_faces == 0)
-		return 0;
+    if (ch < 0x20)
+        return 0;
+    // Handle NBSP like a regular space when rendering the glyph
+    if (ch == 0xa0)
+        ch = ' ';
+    if (font->n_faces == 0)
+        return 0;
 
-	for (i = 0; i < font->n_faces; ++i) {
-		face = font->faces[i];
-		index = FT_Get_Char_Index(face, ch);
-		if (index)
-			break;
-	}
+    for (i = 0; i < font->n_faces; ++i) {
+        face = font->faces[i];
+        index = FT_Get_Char_Index(face, ch);
+        if (index)
+            break;
+    }
 
-#ifdef HAVE_FONTCONFIG
-	if (index == 0) {
-		int face_idx;
-		mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_GlyphNotFoundReselectingFont,
-		       ch, font->desc.family, font->desc.bold, font->desc.italic);
-		face_idx = add_face(fontconfig_priv, font, ch);
-		face = font->faces[face_idx];
-		index = FT_Get_Char_Index(face, ch);
-		if (index == 0) {
-			mp_msg(MSGT_ASS, MSGL_ERR, MSGTR_LIBASS_GlyphNotFound,
-			       ch, font->desc.family, font->desc.bold, font->desc.italic);
-		}
-	}
+#ifdef CONFIG_FONTCONFIG
+    if (index == 0) {
+        int face_idx;
+        ass_msg(font->library, MSGL_INFO,
+                "Glyph 0x%X not found, selecting one more "
+                "font for (%s, %d, %d)", ch, font->desc.family,
+                font->desc.bold, font->desc.italic);
+        face_idx = add_face(fontconfig_priv, font, ch);
+        if (face_idx >= 0) {
+            face = font->faces[face_idx];
+            index = FT_Get_Char_Index(face, ch);
+            if (index == 0 && face->num_charmaps > 0) {
+                ass_msg(font->library, MSGL_WARN,
+                    "Glyph 0x%X not found, falling back to first charmap", ch);
+                FT_CharMap cur = face->charmap;
+                FT_Set_Charmap(face, face->charmaps[0]);
+                index = FT_Get_Char_Index(face, ch);
+                FT_Set_Charmap(face, cur);
+            }
+            if (index == 0) {
+                ass_msg(font->library, MSGL_ERR,
+                        "Glyph 0x%X not found in font for (%s, %d, %d)",
+                        ch, font->desc.family, font->desc.bold,
+                        font->desc.italic);
+            }
+        }
+    }
 #endif
 
-	switch (hinting) {
-	case ASS_HINTING_NONE: flags = FT_LOAD_NO_HINTING; break;
-	case ASS_HINTING_LIGHT: flags = FT_LOAD_FORCE_AUTOHINT | FT_LOAD_TARGET_LIGHT; break;
-	case ASS_HINTING_NORMAL: flags = FT_LOAD_FORCE_AUTOHINT; break;
-	case ASS_HINTING_NATIVE: flags = 0; break;
-	}
-	
-	error = FT_Load_Glyph(face, index, FT_LOAD_NO_BITMAP | flags);
-	if (error) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorLoadingGlyph);
-		return 0;
-	}
-	
-#if (FREETYPE_MAJOR > 2) || \
-    ((FREETYPE_MAJOR == 2) && (FREETYPE_MINOR >= 2)) || \
-    ((FREETYPE_MAJOR == 2) && (FREETYPE_MINOR == 1) && (FREETYPE_PATCH >= 10))
-// FreeType >= 2.1.10 required
-	if (!(face->style_flags & FT_STYLE_FLAG_ITALIC) && 
-			(font->desc.italic > 55)) {
-		FT_GlyphSlot_Oblique(face->glyph);
-	}
-#endif
-	error = FT_Get_Glyph(face->glyph, &glyph);
-	if (error) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorLoadingGlyph);
-		return 0;
-	}
-	
-	return glyph;
+    flags = FT_LOAD_NO_BITMAP | FT_LOAD_IGNORE_GLOBAL_ADVANCE_WIDTH
+            | FT_LOAD_IGNORE_TRANSFORM;
+    switch (hinting) {
+    case ASS_HINTING_NONE:
+        flags |= FT_LOAD_NO_HINTING;
+        break;
+    case ASS_HINTING_LIGHT:
+        flags |= FT_LOAD_FORCE_AUTOHINT | FT_LOAD_TARGET_LIGHT;
+        break;
+    case ASS_HINTING_NORMAL:
+        flags |= FT_LOAD_FORCE_AUTOHINT;
+        break;
+    case ASS_HINTING_NATIVE:
+        break;
+    }
+
+    error = FT_Load_Glyph(face, index, flags);
+    if (error) {
+        ass_msg(font->library, MSGL_WARN, "Error loading glyph, index %d",
+                index);
+        return 0;
+    }
+    if (!(face->style_flags & FT_STYLE_FLAG_ITALIC) &&
+        (font->desc.italic > 55)) {
+        FT_GlyphSlot_Oblique(face->glyph);
+    }
+
+    if (!(face->style_flags & FT_STYLE_FLAG_BOLD) &&
+        (font->desc.bold > 80)) {
+        ass_glyph_embolden(face->glyph);
+    }
+    error = FT_Get_Glyph(face->glyph, &glyph);
+    if (error) {
+        ass_msg(font->library, MSGL_WARN, "Error loading glyph, index %d",
+                index);
+        return 0;
+    }
+
+    // Rotate glyph, if needed
+    if (vertical && ch >= VERTICAL_LOWER_BOUND) {
+        FT_Matrix m = { 0, double_to_d16(-1.0), double_to_d16(1.0), 0 };
+        FT_Outline_Transform(&((FT_OutlineGlyph) glyph)->outline, &m);
+        FT_Outline_Translate(&((FT_OutlineGlyph) glyph)->outline,
+                             face->glyph->metrics.vertAdvance,
+                             0);
+        glyph->advance.x = face->glyph->linearVertAdvance;
+    }
+
+    // Apply scaling and shift
+    FT_Matrix scale = { double_to_d16(font->scale_x), 0, 0,
+                        double_to_d16(font->scale_y) };
+    FT_Outline *outl = &((FT_OutlineGlyph) glyph)->outline;
+    FT_Outline_Transform(outl, &scale);
+    FT_Outline_Translate(outl, font->v.x, font->v.y);
+    glyph->advance.x *= font->scale_x;
+
+    ass_strike_outline_glyph(face, font, glyph, deco & DECO_UNDERLINE,
+                             deco & DECO_STRIKETHROUGH);
+
+    return glyph;
 }
 
 /**
  * \brief Get kerning for the pair of glyphs.
  **/
-FT_Vector ass_font_get_kerning(ass_font_t* font, uint32_t c1, uint32_t c2)
+FT_Vector ass_font_get_kerning(ASS_Font *font, uint32_t c1, uint32_t c2)
 {
-	FT_Vector v = {0, 0};
-	int i;
+    FT_Vector v = { 0, 0 };
+    int i;
 
-	for (i = 0; i < font->n_faces; ++i) {
-		FT_Face face = font->faces[i];
-		int i1 = FT_Get_Char_Index(face, c1);
-		int i2 = FT_Get_Char_Index(face, c2);
-		if (i1 && i2) {
-			if (FT_HAS_KERNING(face))
-				FT_Get_Kerning(face, i1, i2, FT_KERNING_DEFAULT, &v);
-			return v;
-		}
-		if (i1 || i2) // these glyphs are from different font faces, no kerning information
-			return v;
-	}
-	return v;
+    if (font->desc.vertical)
+        return v;
+
+    for (i = 0; i < font->n_faces; ++i) {
+        FT_Face face = font->faces[i];
+        int i1 = FT_Get_Char_Index(face, c1);
+        int i2 = FT_Get_Char_Index(face, c2);
+        if (i1 && i2) {
+            if (FT_HAS_KERNING(face))
+                FT_Get_Kerning(face, i1, i2, FT_KERNING_DEFAULT, &v);
+            return v;
+        }
+        if (i1 || i2)           // these glyphs are from different font faces, no kerning information
+            return v;
+    }
+    return v;
 }
 
 /**
- * \brief Deallocate ass_font_t
+ * \brief Deallocate ASS_Font
  **/
-void ass_font_free(ass_font_t* font)
+void ass_font_free(ASS_Font *font)
 {
-	int i;
-	for (i = 0; i < font->n_faces; ++i)
-		if (font->faces[i]) FT_Done_Face(font->faces[i]);
-	if (font->desc.family) free(font->desc.family);
-	free(font);
+    int i;
+    for (i = 0; i < font->n_faces; ++i)
+        if (font->faces[i])
+            FT_Done_Face(font->faces[i]);
+    free(font->desc.family);
+    free(font);
 }
+
+/**
+ * \brief Calculate the cbox of a series of points
+ */
+static void
+get_contour_cbox(FT_BBox *box, FT_Vector *points, int start, int end)
+{
+    box->xMin = box->yMin = INT_MAX;
+    box->xMax = box->yMax = INT_MIN;
+    int i;
+
+    for (i = start; i <= end; i++) {
+        box->xMin = (points[i].x < box->xMin) ? points[i].x : box->xMin;
+        box->xMax = (points[i].x > box->xMax) ? points[i].x : box->xMax;
+        box->yMin = (points[i].y < box->yMin) ? points[i].y : box->yMin;
+        box->yMax = (points[i].y > box->yMax) ? points[i].y : box->yMax;
+    }
+}
+
+/**
+ * \brief Determine winding direction of a contour
+ * \return direction; 0 = clockwise
+ */
+static int get_contour_direction(FT_Vector *points, int start, int end)
+{
+    int i;
+    long long sum = 0;
+    int x = points[start].x;
+    int y = points[start].y;
+    for (i = start + 1; i <= end; i++) {
+        sum += x * (points[i].y - y) - y * (points[i].x - x);
+        x = points[i].x;
+        y = points[i].y;
+    }
+    sum += x * (points[start].y - y) - y * (points[start].x - x);
+    return sum > 0;
+}
+
+/**
+ * \brief Fix-up stroker result for huge borders by removing inside contours
+ * that would reverse in size
+ */
+void fix_freetype_stroker(FT_OutlineGlyph glyph, int border_x, int border_y)
+{
+    int nc = glyph->outline.n_contours;
+    int begin, stop;
+    char modified = 0;
+    char *valid_cont = malloc(nc);
+    int start = 0;
+    int end = -1;
+    FT_BBox *boxes = malloc(nc * sizeof(FT_BBox));
+    int i, j;
+    int inside_direction;
+
+    inside_direction = FT_Outline_Get_Orientation(&glyph->outline) ==
+        FT_ORIENTATION_TRUETYPE;
+
+    // create a list of cboxes of the contours
+    for (i = 0; i < nc; i++) {
+        start = end + 1;
+        end = glyph->outline.contours[i];
+        get_contour_cbox(&boxes[i], glyph->outline.points, start, end);
+    }
+
+    // for each contour, check direction and whether it's "outside"
+    // or contained in another contour
+    end = -1;
+    for (i = 0; i < nc; i++) {
+        start = end + 1;
+        end = glyph->outline.contours[i];
+        int dir = get_contour_direction(glyph->outline.points, start, end);
+        valid_cont[i] = 1;
+        if (dir == inside_direction) {
+            for (j = 0; j < nc; j++) {
+                if (i == j)
+                    continue;
+                if (boxes[i].xMin >= boxes[j].xMin &&
+                    boxes[i].xMax <= boxes[j].xMax &&
+                    boxes[i].yMin >= boxes[j].yMin &&
+                    boxes[i].yMax <= boxes[j].yMax)
+                    goto check_inside;
+            }
+            /* "inside" contour but we can't find anything it could be
+             * inside of - assume the font is buggy and it should be
+             * an "outside" contour, and reverse it */
+            for (j = 0; j < (end + 1 - start) / 2; j++) {
+                FT_Vector temp = glyph->outline.points[start + j];
+                char temp2 = glyph->outline.tags[start + j];
+                glyph->outline.points[start + j] = glyph->outline.points[end - j];
+                glyph->outline.points[end - j] = temp;
+                glyph->outline.tags[start + j] = glyph->outline.tags[end - j];
+                glyph->outline.tags[end - j] = temp2;
+            }
+            dir ^= 1;
+        }
+        check_inside:
+        if (dir == inside_direction) {
+            FT_BBox box;
+            get_contour_cbox(&box, glyph->outline.points, start, end);
+            int width = box.xMax - box.xMin;
+            int height = box.yMax - box.yMin;
+            if (width < border_x * 2 || height < border_y * 2) {
+                valid_cont[i] = 0;
+                modified = 1;
+            }
+        }
+    }
+
+    // zero-out contours that can be removed; much simpler than copying
+    if (modified) {
+        for (i = 0; i < nc; i++) {
+            if (valid_cont[i])
+                continue;
+            begin = (i == 0) ? 0 : glyph->outline.contours[i - 1] + 1;
+            stop = glyph->outline.contours[i];
+            for (j = begin; j <= stop; j++) {
+                glyph->outline.points[j].x = 0;
+                glyph->outline.points[j].y = 0;
+                glyph->outline.tags[j] = 0;
+            }
+        }
+    }
+
+    free(boxes);
+    free(valid_cont);
+}
+

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.h	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_font.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,51 +1,68 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#ifndef LIBASS_FONT_H
+#define LIBASS_FONT_H
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
+#include <stdint.h>
+#include <ft2build.h>
+#include FT_GLYPH_H
+#include "ass.h"
+#include "ass_types.h"
 
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
+#define ASS_FONT_MAX_FACES 10
+#define DECO_UNDERLINE 1
+#define DECO_STRIKETHROUGH 2
 
-#ifndef ASS_FONT_H
-#define ASS_FONT_H
+typedef struct {
+    char *family;
+    unsigned bold;
+    unsigned italic;
+    int treat_family_as_pattern;
+    int vertical;               // @font vertical layout
+} ASS_FontDesc;
 
-typedef struct ass_font_desc_s {
-	char* family;
-	unsigned bold;
-	unsigned italic;
-} ass_font_desc_t;
+typedef struct {
+    ASS_FontDesc desc;
+    ASS_Library *library;
+    FT_Library ftlibrary;
+    FT_Face faces[ASS_FONT_MAX_FACES];
+    int n_faces;
+    double scale_x, scale_y;    // current transform
+    FT_Vector v;                // current shift
+    double size;
+} ASS_Font;
 
-#define ASS_FONT_MAX_FACES 10
+// FIXME: passing the hashmap via a void pointer is very ugly.
+ASS_Font *ass_font_new(void *font_cache, ASS_Library *library,
+                       FT_Library ftlibrary, void *fc_priv,
+                       ASS_FontDesc *desc);
+void ass_font_set_transform(ASS_Font *font, double scale_x,
+                            double scale_y, FT_Vector *v);
+void ass_font_set_size(ASS_Font *font, double size);
+void ass_font_get_asc_desc(ASS_Font *font, uint32_t ch, int *asc,
+                           int *desc);
+FT_Glyph ass_font_get_glyph(void *fontconfig_priv, ASS_Font *font,
+                            uint32_t ch, ASS_Hinting hinting, int flags);
+FT_Vector ass_font_get_kerning(ASS_Font *font, uint32_t c1, uint32_t c2);
+void ass_font_free(ASS_Font *font);
+void fix_freetype_stroker(FT_OutlineGlyph glyph, int border_x, int border_y);
 
-typedef struct ass_font_s {
-	ass_font_desc_t desc;
-	ass_library_t* library;
-	FT_Library ftlibrary;
-	FT_Face faces[ASS_FONT_MAX_FACES];
-	int n_faces;
-	double scale_x, scale_y; // current transform
-	FT_Vector v; // current shift
-	double size;
-} ass_font_t;
-
-ass_font_t* ass_font_new(ass_library_t* library, FT_Library ftlibrary, void* fc_priv, ass_font_desc_t* desc);
-void ass_font_set_transform(ass_font_t* font, double scale_x, double scale_y, FT_Vector* v);
-void ass_font_set_size(ass_font_t* font, double size);
-void ass_font_get_asc_desc(ass_font_t* font, uint32_t ch, int* asc, int* desc);
-FT_Glyph ass_font_get_glyph(void* fontconfig_priv, ass_font_t* font, uint32_t ch, ass_hinting_t hinting);
-FT_Vector ass_font_get_kerning(ass_font_t* font, uint32_t c1, uint32_t c2);
-void ass_font_free(ass_font_t* font);
-
-#endif
+#endif                          /* LIBASS_FONT_H */

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.c	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,308 +1,413 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#include "ADM_coreConfig.h"
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-//#include "config.h"
-
 #include <stdlib.h>
 #include <stdio.h>
 #include <assert.h>
 #include <string.h>
+#include <strings.h>
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <inttypes.h>
 #include <ft2build.h>
 #include FT_FREETYPE_H
 
-#include "mputils.h"
+#include "ass_utils.h"
 #include "ass.h"
 #include "ass_library.h"
 #include "ass_fontconfig.h"
 
-#ifdef HAVE_FONTCONFIG
+#ifdef CONFIG_FONTCONFIG
 #include <fontconfig/fontconfig.h>
 #include <fontconfig/fcfreetype.h>
 #endif
 
-struct fc_instance_s {
-#ifdef HAVE_FONTCONFIG
-	FcConfig* config;
+struct fc_instance {
+#ifdef CONFIG_FONTCONFIG
+    FcConfig *config;
 #endif
-	char* family_default;
-	char* path_default;
-	int index_default;
+    char *family_default;
+    char *path_default;
+    int index_default;
 };
 
-#ifdef HAVE_FONTCONFIG
+#ifdef CONFIG_FONTCONFIG
+
 /**
+ * \brief Case-insensitive match ASS/SSA font family against full name. (also
+ * known as "name for humans")
+ *
+ * \param lib library instance
+ * \param priv fontconfig instance
+ * \param family font fullname
+ * \param bold weight attribute
+ * \param italic italic attribute
+ * \return font set
+ */
+static FcFontSet *
+match_fullname(ASS_Library *lib, FCInstance *priv, const char *family,
+               unsigned bold, unsigned italic)
+{
+    FcFontSet *sets[2];
+    FcFontSet *result = FcFontSetCreate();
+    int nsets = 0;
+    int i, fi;
+
+    if ((sets[nsets] = FcConfigGetFonts(priv->config, FcSetSystem)))
+        nsets++;
+    if ((sets[nsets] = FcConfigGetFonts(priv->config, FcSetApplication)))
+        nsets++;
+
+    // Run over font sets and patterns and try to match against full name
+    for (i = 0; i < nsets; i++) {
+        FcFontSet *set = sets[i];
+        for (fi = 0; fi < set->nfont; fi++) {
+            FcPattern *pat = set->fonts[fi];
+            char *fullname;
+            int pi = 0, at;
+            FcBool ol;
+            while (FcPatternGetString(pat, FC_FULLNAME, pi++,
+                   (FcChar8 **) &fullname) == FcResultMatch) {
+                if (FcPatternGetBool(pat, FC_OUTLINE, 0, &ol) != FcResultMatch
+                    || ol != FcTrue)
+                    continue;
+                if (FcPatternGetInteger(pat, FC_SLANT, 0, &at) != FcResultMatch
+                    || at < italic)
+                    continue;
+                if (FcPatternGetInteger(pat, FC_WEIGHT, 0, &at) != FcResultMatch
+                    || at < bold)
+                    continue;
+                if (strcasecmp(fullname, family) == 0) {
+                    FcFontSetAdd(result, FcPatternDuplicate(pat));
+                    break;
+                }
+            }
+        }
+    }
+
+    return result;
+}
+
+/**
  * \brief Low-level font selection.
  * \param priv private data
  * \param family font family
+ * \param treat_family_as_pattern treat family as fontconfig pattern
  * \param bold font weight value
  * \param italic font slant value
  * \param index out: font index inside a file
  * \param code: the character that should be present in the font, can be 0
  * \return font file path
-*/ 
-static char* _select_font(fc_instance_t* priv, const char* family, unsigned bold, unsigned italic, int* index,
-			  uint32_t code)
+*/
+static char *select_font(ASS_Library *library, FCInstance *priv,
+                          const char *family, int treat_family_as_pattern,
+                          unsigned bold, unsigned italic, int *index,
+                          uint32_t code)
 {
-	FcBool rc;
-	FcResult result;
-	FcPattern *pat = 0, *rpat;
-	int val_i;
-	FcChar8* val_s;
-	FcBool val_b;
-	FcCharSet* val_cs;
-	FcFontSet* fset = 0;
-	int curf;
-	char* retval = 0;
-	
-	*index = 0;
+    FcBool rc;
+    FcResult result;
+    FcPattern *pat = NULL, *rpat = NULL;
+    int r_index, r_slant, r_weight;
+    FcChar8 *r_family, *r_style, *r_file, *r_fullname;
+    FcBool r_outline, r_embolden;
+    FcCharSet *r_charset;
+    FcFontSet *ffullname = NULL, *fsorted = NULL, *fset = NULL;
+    int curf;
+    char *retval = NULL;
+    int family_cnt = 0;
 
-	pat = FcPatternCreate();
-	if (!pat)
-		goto error;
-	
-	FcPatternAddString(pat, FC_FAMILY, (const FcChar8*)family);
-	FcPatternAddBool(pat, FC_OUTLINE, FcTrue);
-	FcPatternAddInteger(pat, FC_SLANT, italic);
-	FcPatternAddInteger(pat, FC_WEIGHT, bold);
+    *index = 0;
 
-	FcDefaultSubstitute(pat);
-	
-	rc = FcConfigSubstitute(priv->config, pat, FcMatchPattern);
-	if (!rc)
-		goto error;
+    if (treat_family_as_pattern)
+        pat = FcNameParse((const FcChar8 *) family);
+    else
+        pat = FcPatternCreate();
 
-	fset = FcFontSort(priv->config, pat, FcTrue, NULL, &result);
+    if (!pat)
+        goto error;
 
-	for (curf = 0; curf < fset->nfont; ++curf) {
-		rpat = fset->fonts[curf];
-		
-		result = FcPatternGetBool(rpat, FC_OUTLINE, 0, &val_b);
-		if (result != FcResultMatch)
-			continue;
-		if (val_b != FcTrue)
-			continue;
-		if (!code)
-			break;
-		result = FcPatternGetCharSet(rpat, FC_CHARSET, 0, &val_cs);
-		if (result != FcResultMatch)
-			continue;
-		if (FcCharSetHasChar(val_cs, code))
-			break;
-	}
+    if (!treat_family_as_pattern) {
+        FcPatternAddString(pat, FC_FAMILY, (const FcChar8 *) family);
 
-	if (curf >= fset->nfont)
-		goto error;
+        // In SSA/ASS fonts are sometimes referenced by their "full name",
+        // which is usually a concatenation of family name and font
+        // style (ex. Ottawa Bold). Full name is available from
+        // FontConfig pattern element FC_FULLNAME, but it is never
+        // used for font matching.
+        // Therefore, I'm removing words from the end of the name one
+        // by one, and adding shortened names to the pattern. It seems
+        // that the first value (full name in this case) has
+        // precedence in matching.
+        // An alternative approach could be to reimplement FcFontSort
+        // using FC_FULLNAME instead of FC_FAMILY.
+        family_cnt = 1;
+        {
+            char *s = strdup(family);
+            char *p = s + strlen(s);
+            while (--p > s)
+                if (*p == ' ' || *p == '-') {
+                    *p = '\0';
+                    FcPatternAddString(pat, FC_FAMILY, (const FcChar8 *) s);
+                    ++family_cnt;
+                }
+            free(s);
+        }
+    }
+    FcPatternAddBool(pat, FC_OUTLINE, FcTrue);
+    FcPatternAddInteger(pat, FC_SLANT, italic);
+    FcPatternAddInteger(pat, FC_WEIGHT, bold);
 
-	rpat = fset->fonts[curf];
-	
-	result = FcPatternGetInteger(rpat, FC_INDEX, 0, &val_i);
-	if (result != FcResultMatch)
-		goto error;
-	*index = val_i;
+    FcDefaultSubstitute(pat);
 
-	result = FcPatternGetString(rpat, FC_FAMILY, 0, &val_s);
-	if (result != FcResultMatch)
-		goto error;
+    rc = FcConfigSubstitute(priv->config, pat, FcMatchPattern);
+    if (!rc)
+        goto error;
 
-	if (strcasecmp((const char*)val_s, family) != 0)
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_SelectedFontFamilyIsNotTheRequestedOne,
-				(const char*)val_s, family);
+    fsorted = FcFontSort(priv->config, pat, FcTrue, NULL, &result);
+    ffullname = match_fullname(library, priv, family, bold, italic);
+    if (!fsorted || !ffullname)
+        goto error;
 
-	result = FcPatternGetString(rpat, FC_FILE, 0, &val_s);
-	if (result != FcResultMatch)
-		goto error;
-	
-	retval = strdup((const char*)val_s);
- error:
-	if (pat) FcPatternDestroy(pat);
-	if (fset) FcFontSetDestroy(fset);
-	return retval;
+    fset = FcFontSetCreate();
+    for (curf = 0; curf < ffullname->nfont; ++curf) {
+        FcPattern *curp = ffullname->fonts[curf];
+        FcPatternReference(curp);
+        FcFontSetAdd(fset, curp);
+    }
+    for (curf = 0; curf < fsorted->nfont; ++curf) {
+        FcPattern *curp = fsorted->fonts[curf];
+        FcPatternReference(curp);
+        FcFontSetAdd(fset, curp);
+    }
+
+    for (curf = 0; curf < fset->nfont; ++curf) {
+        FcPattern *curp = fset->fonts[curf];
+
+        result = FcPatternGetBool(curp, FC_OUTLINE, 0, &r_outline);
+        if (result != FcResultMatch)
+            continue;
+        if (r_outline != FcTrue)
+            continue;
+        if (!code)
+            break;
+        result = FcPatternGetCharSet(curp, FC_CHARSET, 0, &r_charset);
+        if (result != FcResultMatch)
+            continue;
+        if (FcCharSetHasChar(r_charset, code))
+            break;
+    }
+
+    if (curf >= fset->nfont)
+        goto error;
+
+    if (!treat_family_as_pattern) {
+        // Remove all extra family names from original pattern.
+        // After this, FcFontRenderPrepare will select the most relevant family
+        // name in case there are more than one of them.
+        for (; family_cnt > 1; --family_cnt)
+            FcPatternRemove(pat, FC_FAMILY, family_cnt - 1);
+    }
+
+    rpat = FcFontRenderPrepare(priv->config, pat, fset->fonts[curf]);
+    if (!rpat)
+        goto error;
+
+    result = FcPatternGetInteger(rpat, FC_INDEX, 0, &r_index);
+    if (result != FcResultMatch)
+        goto error;
+    *index = r_index;
+
+    result = FcPatternGetString(rpat, FC_FILE, 0, &r_file);
+    if (result != FcResultMatch)
+        goto error;
+    retval = strdup((const char *) r_file);
+
+    result = FcPatternGetString(rpat, FC_FAMILY, 0, &r_family);
+    if (result != FcResultMatch)
+        r_family = NULL;
+
+    result = FcPatternGetString(rpat, FC_FULLNAME, 0, &r_fullname);
+    if (result != FcResultMatch)
+        r_fullname = NULL;
+
+    if (!treat_family_as_pattern &&
+        !(r_family && strcasecmp((const char *) r_family, family) == 0) &&
+        !(r_fullname && strcasecmp((const char *) r_fullname, family) == 0))
+        ass_msg(library, MSGL_WARN,
+               "fontconfig: Selected font is not the requested one: "
+               "'%s' != '%s'",
+               (const char *) (r_fullname ? r_fullname : r_family), family);
+
+    result = FcPatternGetString(rpat, FC_STYLE, 0, &r_style);
+    if (result != FcResultMatch)
+        r_style = NULL;
+
+    result = FcPatternGetInteger(rpat, FC_SLANT, 0, &r_slant);
+    if (result != FcResultMatch)
+        r_slant = 0;
+
+    result = FcPatternGetInteger(rpat, FC_WEIGHT, 0, &r_weight);
+    if (result != FcResultMatch)
+        r_weight = 0;
+
+    result = FcPatternGetBool(rpat, FC_EMBOLDEN, 0, &r_embolden);
+    if (result != FcResultMatch)
+        r_embolden = 0;
+
+    ass_msg(library, MSGL_V,
+           "Font info: family '%s', style '%s', fullname '%s',"
+           " slant %d, weight %d%s", (const char *) r_family,
+           (const char *) r_style, (const char *) r_fullname, r_slant,
+           r_weight, r_embolden ? ", embolden" : "");
+
+  error:
+    if (pat)
+        FcPatternDestroy(pat);
+    if (rpat)
+        FcPatternDestroy(rpat);
+    if (fsorted)
+        FcFontSetDestroy(fsorted);
+    if (ffullname)
+        FcFontSetDestroy(ffullname);
+    if (fset)
+        FcFontSetDestroy(fset);
+    return retval;
 }
 
 /**
  * \brief Find a font. Use default family or path if necessary.
  * \param priv_ private data
  * \param family font family
+ * \param treat_family_as_pattern treat family as fontconfig pattern
  * \param bold font weight value
  * \param italic font slant value
  * \param index out: font index inside a file
  * \param code: the character that should be present in the font, can be 0
  * \return font file path
-*/ 
-char* fontconfig_select(fc_instance_t* priv, const char* family, unsigned bold, unsigned italic, int* index,
-			uint32_t code)
+*/
+char *fontconfig_select(ASS_Library *library, FCInstance *priv,
+                        const char *family, int treat_family_as_pattern,
+                        unsigned bold, unsigned italic, int *index,
+                        uint32_t code)
 {
-	char* res = 0;
-	if (family && *family)
-		res = _select_font(priv, family, bold, italic, index, code);
-	if (!res && priv->family_default) {
-		res = _select_font(priv, priv->family_default, bold, italic, index, code);
-		if (res)
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_UsingDefaultFontFamily, 
-					family, bold, italic, res, *index);
-	}
-	if (!res && priv->path_default) {
-		res = priv->path_default;
-		*index = priv->index_default;
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_UsingDefaultFont, 
-		       family, bold, italic, res, *index);
-	}
-	if (!res) {
-		res = _select_font(priv, "Arial", bold, italic, index, code);
-		if (res)
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_UsingArialFontFamily, 
-					family, bold, italic, res, *index);
-	}
-	if (res)
-		mp_msg(MSGT_ASS, MSGL_V, "fontconfig_select: (%s, %d, %d) -> %s, %d\n", 
-				family, bold, italic, res, *index);
-	return res;
+    char *res = 0;
+    if (!priv->config) {
+        *index = priv->index_default;
+        res = priv->path_default ? strdup(priv->path_default) : 0;
+        return res;
+    }
+    if (family && *family)
+        res =
+            select_font(library, priv, family, treat_family_as_pattern,
+                         bold, italic, index, code);
+    if (!res && priv->family_default) {
+        res =
+            select_font(library, priv, priv->family_default, 0, bold,
+                         italic, index, code);
+        if (res)
+            ass_msg(library, MSGL_WARN, "fontconfig_select: Using default "
+                    "font family: (%s, %d, %d) -> %s, %d",
+                    family, bold, italic, res, *index);
+    }
+    if (!res && priv->path_default) {
+        res = strdup(priv->path_default);
+        *index = priv->index_default;
+        ass_msg(library, MSGL_WARN, "fontconfig_select: Using default font: "
+                "(%s, %d, %d) -> %s, %d", family, bold, italic,
+                res, *index);
+    }
+    if (!res) {
+        res = select_font(library, priv, "Arial", 0, bold, italic,
+                           index, code);
+        if (res)
+            ass_msg(library, MSGL_WARN, "fontconfig_select: Using 'Arial' "
+                    "font family: (%s, %d, %d) -> %s, %d", family, bold,
+                    italic, res, *index);
+    }
+    if (res)
+        ass_msg(library, MSGL_V,
+                "fontconfig_select: (%s, %d, %d) -> %s, %d", family, bold,
+                italic, res, *index);
+    return res;
 }
 
-#if (FC_VERSION < 20402)
-static char* validate_fname(char* name)
-{
-	char* fname;
-	char* p;
-	char* q;
-	unsigned code;
-	int sz = strlen(name);
-
-	q = fname = malloc(sz + 1);
-	p = name;
-	while (*p) {
-		code = utf8_get_char(&p);
-		if (code == 0)
-			break;
-		if (	(code > 0x7F) ||
-			(code == '\\') ||
-			(code == '/') ||
-			(code == ':') ||
-			(code == '*') ||
-			(code == '?') ||
-			(code == '<') ||
-			(code == '>') ||
-			(code == '|') ||
-			(code == 0))
-		{
-			*q++ = '_';
-		} else {
-			*q++ = code;
-		}
-		if (p - name > sz)
-			break;
-	}
-	*q = 0;
-	return fname;
-}
-#endif
-
 /**
  * \brief Process memory font.
  * \param priv private data
  * \param library library object
  * \param ftlibrary freetype library object
  * \param idx index of the processed font in library->fontdata
- * With FontConfig >= 2.4.2, builds a font pattern in memory via FT_New_Memory_Face/FcFreeTypeQueryFace.
- * With older FontConfig versions, save the font to ~/.mplayer/fonts.
-*/ 
-static void process_fontdata(fc_instance_t* priv, ass_library_t* library, FT_Library ftlibrary, int idx)
+ *
+ * Builds a font pattern in memory via FT_New_Memory_Face/FcFreeTypeQueryFace.
+*/
+static void process_fontdata(FCInstance *priv, ASS_Library *library,
+                             FT_Library ftlibrary, int idx)
 {
-	int rc;
-	const char* name = library->fontdata[idx].name;
-	const char* data = library->fontdata[idx].data;
-	int data_size = library->fontdata[idx].size;
+    int rc;
+    const char *name = library->fontdata[idx].name;
+    const char *data = library->fontdata[idx].data;
+    int data_size = library->fontdata[idx].size;
 
-#if (FC_VERSION < 20402)
-	struct stat st;
-	char* fname;
-	const char* fonts_dir = library->fonts_dir;
-	char buf[1000];
-	FILE* fp = 0;
+    FT_Face face;
+    FcPattern *pattern;
+    FcFontSet *fset;
+    FcBool res;
+    int face_index, num_faces = 1;
 
-	if (!fonts_dir)
-		return;
-	rc = stat(fonts_dir, &st);
-	if (rc) {
-		int res;
-#ifndef __MINGW32__
-		res = mkdir(fonts_dir, 0700);
-#else
-		res = mkdir(fonts_dir);
-#endif
-		if (res) {
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FailedToCreateDirectory, fonts_dir);
-		}
-	} else if (!S_ISDIR(st.st_mode)) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NotADirectory, fonts_dir);
-	}
-	
-	fname = validate_fname((char*)name);
+    for (face_index = 0; face_index < num_faces; ++face_index) {
+        rc = FT_New_Memory_Face(ftlibrary, (unsigned char *) data,
+                                data_size, face_index, &face);
+        if (rc) {
+            ass_msg(library, MSGL_WARN, "Error opening memory font: %s",
+                   name);
+            return;
+        }
+        num_faces = face->num_faces;
 
-	snprintf(buf, 1000, "%s/%s", fonts_dir, fname);
-	free(fname);
+        pattern =
+            FcFreeTypeQueryFace(face, (unsigned char *) name, face_index,
+                                FcConfigGetBlanks(priv->config));
+        if (!pattern) {
+            ass_msg(library, MSGL_WARN, "%s failed", "FcFreeTypeQueryFace");
+            FT_Done_Face(face);
+            return;
+        }
 
-	fp = fopen(buf, "wb");
-	if (!fp) return;
+        fset = FcConfigGetFonts(priv->config, FcSetSystem);     // somehow it failes when asked for FcSetApplication
+        if (!fset) {
+            ass_msg(library, MSGL_WARN, "%s failed", "FcConfigGetFonts");
+            FT_Done_Face(face);
+            return;
+        }
 
-	fwrite(data, data_size, 1, fp);
-	fclose(fp);
+        res = FcFontSetAdd(fset, pattern);
+        if (!res) {
+            ass_msg(library, MSGL_WARN, "%s failed", "FcFontSetAdd");
+            FT_Done_Face(face);
+            return;
+        }
 
-#else // (FC_VERSION >= 20402)
-	FT_Face face;
-	FcPattern* pattern;
-	FcFontSet* fset;
-	FcBool res;
-
-	rc = FT_New_Memory_Face(ftlibrary, (unsigned char*)data, data_size, 0, &face);
-	if (rc) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorOpeningMemoryFont, name);
-		return;
-	}
-
-	pattern = FcFreeTypeQueryFace(face, (unsigned char*)name, 0, FcConfigGetBlanks(priv->config));
-	if (!pattern) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FunctionCallFailed, "FcFreeTypeQueryFace");
-		FT_Done_Face(face);
-		return;
-	}
-
-	fset = FcConfigGetFonts(priv->config, FcSetSystem); // somehow it failes when asked for FcSetApplication
-	if (!fset) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FunctionCallFailed, "FcConfigGetFonts");
-		FT_Done_Face(face);
-		return;
-	}
-
-	res = FcFontSetAdd(fset, pattern);
-	if (!res) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FunctionCallFailed, "FcFontSetAdd");
-		FT_Done_Face(face);
-		return;
-	}
-
-	FT_Done_Face(face);
-#endif
+        FT_Done_Face(face);
+    }
 }
 
 /**
@@ -311,103 +416,118 @@
  * \param ftlibrary freetype library object
  * \param family default font family
  * \param path default font path
+ * \param fc whether fontconfig should be used
+ * \param config path to a fontconfig configuration file, or NULL
+ * \param update whether the fontconfig cache should be built/updated
  * \return pointer to fontconfig private data
-*/ 
-fc_instance_t* fontconfig_init(ass_library_t* library, FT_Library ftlibrary, const char* family, const char* path)
+*/
+FCInstance *fontconfig_init(ASS_Library *library,
+                            FT_Library ftlibrary, const char *family,
+                            const char *path, int fc, const char *config,
+                            int update)
 {
-	int rc;
-	fc_instance_t* priv = calloc(1, sizeof(fc_instance_t));
-	const char* dir = library->fonts_dir;
-	int i;
-	
-	rc = FcInit();
-	assert(rc);
+    int rc;
+    FCInstance *priv = calloc(1, sizeof(FCInstance));
+    const char *dir = library->fonts_dir;
+    int i;
 
-	priv->config = FcConfigGetCurrent();
-	if (!priv->config) {
-		mp_msg(MSGT_ASS, MSGL_FATAL, MSGTR_LIBASS_FcInitLoadConfigAndFontsFailed);
-		return 0;
-	}
+    if (!fc) {
+        ass_msg(library, MSGL_WARN,
+               "Fontconfig disabled, only default font will be used.");
+        goto exit;
+    }
 
-	for (i = 0; i < library->num_fontdata; ++i)
-		process_fontdata(priv, library, ftlibrary, i);
+    priv->config = FcConfigCreate();
+    rc = FcConfigParseAndLoad(priv->config, (unsigned char *) config, FcTrue);
+    if (!rc) {
+        ass_msg(library, MSGL_WARN, "No usable fontconfig configuration "
+                "file found, using fallback.");
+        FcConfigDestroy(priv->config);
+        priv->config = FcInitLoadConfig();
+        rc++;
+    }
+    if (rc && update) {
+        FcConfigBuildFonts(priv->config);
+    }
 
-	if (FcDirCacheValid((const FcChar8 *)dir) == FcFalse)
-	{
-		mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_UpdatingFontCache);
-		if (FcGetVersion() >= 20390 && FcGetVersion() < 20400)
-			mp_msg(MSGT_ASS, MSGL_WARN,
-			       MSGTR_LIBASS_BetaVersionsOfFontconfigAreNotSupported);
-		// FontConfig >= 2.4.0 updates cache automatically in FcConfigAppFontAddDir()
-		if (FcGetVersion() < 20390) {
-			FcFontSet* fcs;
-			FcStrSet* fss;
-			fcs = FcFontSetCreate();
-			fss = FcStrSetCreate();
-			rc = FcStrSetAdd(fss, (const FcChar8*)dir);
-			if (!rc) {
-				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FcStrSetAddFailed);
-				goto ErrorFontCache;
-			}
+    if (!rc || !priv->config) {
+        ass_msg(library, MSGL_FATAL,
+                "No valid fontconfig configuration found!");
+        FcConfigDestroy(priv->config);
+        goto exit;
+    }
 
-			rc = FcDirScan(fcs, fss, NULL, FcConfigGetBlanks(priv->config), (const FcChar8 *)dir, FcFalse);
-			if (!rc) {
-				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FcDirScanFailed);
-				goto ErrorFontCache;
-			}
+    for (i = 0; i < library->num_fontdata; ++i)
+        process_fontdata(priv, library, ftlibrary, i);
 
-			rc = FcDirSave(fcs, fss, (const FcChar8 *)dir);
-			if (!rc) {
-				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FcDirSave);
-				goto ErrorFontCache;
-			}
-		ErrorFontCache:
-			;
-		}
-	}
+    if (dir) {
+        ass_msg(library, MSGL_V, "Updating font cache");
 
-	rc = FcConfigAppFontAddDir(priv->config, (const FcChar8*)dir);
-	if (!rc) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FcConfigAppFontAddDirFailed);
-	}
+        rc = FcConfigAppFontAddDir(priv->config, (const FcChar8 *) dir);
+        if (!rc) {
+            ass_msg(library, MSGL_WARN, "%s failed", "FcConfigAppFontAddDir");
+        }
+    }
 
-	priv->family_default = family ? strdup(family) : 0;
-	priv->path_default = path ? strdup(path) : 0;
-	priv->index_default = 0;
+    priv->family_default = family ? strdup(family) : NULL;
+exit:
+    priv->path_default = path ? strdup(path) : NULL;
+    priv->index_default = 0;
 
-	return priv;
+    return priv;
 }
 
-#else // HAVE_FONTCONFIG
+int fontconfig_update(FCInstance *priv)
+{
+        return FcConfigBuildFonts(priv->config);
+}
 
-char* fontconfig_select(fc_instance_t* priv, const char* family, unsigned bold, unsigned italic, int* index,
-			uint32_t code)
+#else                           /* CONFIG_FONTCONFIG */
+
+char *fontconfig_select(ASS_Library *library, FCInstance *priv,
+                        const char *family, int treat_family_as_pattern,
+                        unsigned bold, unsigned italic, int *index,
+                        uint32_t code)
 {
-	*index = priv->index_default;
-	return priv->path_default;
+    *index = priv->index_default;
+    char* res = priv->path_default ? strdup(priv->path_default) : 0;
+    return res;
 }
 
-fc_instance_t* fontconfig_init(ass_library_t* library, FT_Library ftlibrary, const char* family, const char* path)
+FCInstance *fontconfig_init(ASS_Library *library,
+                            FT_Library ftlibrary, const char *family,
+                            const char *path, int fc, const char *config,
+                            int update)
 {
-	fc_instance_t* priv;
+    FCInstance *priv;
 
-	mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FontconfigDisabledDefaultFontWillBeUsed);
-	
-	priv = calloc(1, sizeof(fc_instance_t));
-	
-	priv->path_default = strdup(path);
-	priv->index_default = 0;
-	return priv;
+    ass_msg(library, MSGL_WARN,
+        "Fontconfig disabled, only default font will be used.");
+
+    priv = calloc(1, sizeof(FCInstance));
+
+    priv->path_default = path ? strdup(path) : 0;
+    priv->index_default = 0;
+    return priv;
 }
 
+int fontconfig_update(FCInstance *priv)
+{
+    // Do nothing
+    return 1;
+}
+
 #endif
 
-void fontconfig_done(fc_instance_t* priv)
+void fontconfig_done(FCInstance *priv)
 {
-	// don't call FcFini() here, library can still be used by some code
-	if (priv && priv->path_default) free(priv->path_default);
-	if (priv && priv->family_default) free(priv->family_default);
-	if (priv) free(priv);
+
+    if (priv) {
+#ifdef CONFIG_FONTCONFIG
+        FcConfigDestroy(priv->config);
+#endif
+        free(priv->path_default);
+        free(priv->family_default);
+    }
+    free(priv);
 }
-
-

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.h	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_fontconfig.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,35 +1,47 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#ifndef LIBASS_FONTCONFIG_H
+#define LIBASS_FONTCONFIG_H
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
+#include <stdint.h>
+#include "ass_types.h"
+#include "ass.h"
+#include <ft2build.h>
+#include FT_FREETYPE_H
 
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#ifndef ASS_FONTCONFIG_H
-#define ASS_FONTCONFIG_H
-
-#ifdef HAVE_FONTCONFIG
+#ifdef CONFIG_FONTCONFIG
 #include <fontconfig/fontconfig.h>
 #endif
 
-typedef struct fc_instance_s fc_instance_t;
+typedef struct fc_instance FCInstance;
 
-fc_instance_t* fontconfig_init(ass_library_t* library, FT_Library ftlibrary, const char* family, const char* path);
-char* fontconfig_select(fc_instance_t* priv, const char* family, unsigned bold, unsigned italic, int* index, uint32_t code);
-void fontconfig_done(fc_instance_t* priv);
+FCInstance *fontconfig_init(ASS_Library *library,
+                            FT_Library ftlibrary, const char *family,
+                            const char *path, int fc, const char *config,
+                            int update);
+char *fontconfig_select(ASS_Library *library, FCInstance *priv,
+                        const char *family, int treat_family_as_pattern,
+                        unsigned bold, unsigned italic, int *index,
+                        uint32_t code);
+void fontconfig_done(FCInstance *priv);
+int fontconfig_update(FCInstance *priv);
 
-#endif
-
+#endif                          /* LIBASS_FONTCONFIG_H */

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.c	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,93 +1,148 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#include "ADM_coreConfig.h"
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
 #include <inttypes.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
+#include <stdarg.h>
 
 #include "ass.h"
 #include "ass_library.h"
+#include "ass_utils.h"
 
+static void ass_msg_handler(int level, const char *fmt, va_list va, void *data)
+{
+    if (level > MSGL_INFO)
+        return;
+    fprintf(stderr, "[ass] ");
+    vfprintf(stderr, fmt, va);
+    fprintf(stderr, "\n");
+}
 
-ass_library_t* ass_library_init(void)
+ASS_Library *ass_library_init(void)
 {
-	return calloc(1, sizeof(ass_library_t));
+    ASS_Library* lib = calloc(1, sizeof(*lib));
+    lib->msg_callback = ass_msg_handler;
+
+    return lib;
 }
 
-void ass_library_done(ass_library_t* priv)
+void ass_library_done(ASS_Library *priv)
 {
-	if (priv) {
-		ass_set_fonts_dir(priv, NULL);
-		ass_set_style_overrides(priv, NULL);
-		free(priv);
-	}
+    if (priv) {
+        ass_set_fonts_dir(priv, NULL);
+        ass_set_style_overrides(priv, NULL);
+        ass_clear_fonts(priv);
+        free(priv);
+    }
 }
 
-void ass_set_fonts_dir(ass_library_t* priv, const char* fonts_dir)
+void ass_set_fonts_dir(ASS_Library *priv, const char *fonts_dir)
 {
-	if (priv->fonts_dir)
-		free(priv->fonts_dir);
+    free(priv->fonts_dir);
 
-	priv->fonts_dir = fonts_dir ? strdup(fonts_dir) : 0;
+    priv->fonts_dir = fonts_dir ? strdup(fonts_dir) : 0;
 }
 
-void ass_set_extract_fonts(ass_library_t* priv, int extract)
+void ass_set_extract_fonts(ASS_Library *priv, int extract)
 {
-	priv->extract_fonts = !!extract;
+    priv->extract_fonts = !!extract;
 }
 
-void ass_set_style_overrides(ass_library_t* priv, char** list)
+void ass_set_style_overrides(ASS_Library *priv, char **list)
 {
-	char** p;
-	char** q;
-	int cnt;
-	
-	if (priv->style_overrides) {
-		for (p = priv->style_overrides; *p; ++p)
-			free(*p);
-		free(priv->style_overrides);
-	}
-	
-	if (!list) return;
+    char **p;
+    char **q;
+    int cnt;
 
-	for (p = list, cnt = 0; *p; ++p, ++cnt) {}
+    if (priv->style_overrides) {
+        for (p = priv->style_overrides; *p; ++p)
+            free(*p);
+    }
+    free(priv->style_overrides);
 
-	priv->style_overrides = malloc((cnt + 1) * sizeof(char*));
-	for (p = list, q = priv->style_overrides; *p; ++p, ++q)
-		*q = strdup(*p);
-	priv->style_overrides[cnt] = NULL;
+    if (!list)
+        return;
+
+    for (p = list, cnt = 0; *p; ++p, ++cnt) {
+    }
+
+    priv->style_overrides = malloc((cnt + 1) * sizeof(char *));
+    for (p = list, q = priv->style_overrides; *p; ++p, ++q)
+        *q = strdup(*p);
+    priv->style_overrides[cnt] = NULL;
 }
 
 static void grow_array(void **array, int nelem, size_t elsize)
 {
-	if (!(nelem & 31))
-		*array = realloc(*array, (nelem + 32) * elsize);
+    if (!(nelem & 31))
+        *array = realloc(*array, (nelem + 32) * elsize);
 }
 
-void ass_add_font(ass_library_t* priv, char* name, char* data, int size)
+void ass_add_font(ASS_Library *priv, char *name, char *data, int size)
 {
-	grow_array((void**)&priv->fontdata, priv->num_fontdata, sizeof(*priv->fontdata));
-	priv->fontdata[priv->num_fontdata].name = name;
-	priv->fontdata[priv->num_fontdata].data = data;
-	priv->fontdata[priv->num_fontdata].size = size;
-	priv->num_fontdata ++;
+    int idx = priv->num_fontdata;
+    if (!name || !data || !size)
+        return;
+    grow_array((void **) &priv->fontdata, priv->num_fontdata,
+               sizeof(*priv->fontdata));
+
+    priv->fontdata[idx].name = strdup(name);
+
+    priv->fontdata[idx].data = malloc(size);
+    memcpy(priv->fontdata[idx].data, data, size);
+
+    priv->fontdata[idx].size = size;
+
+    priv->num_fontdata++;
 }
 
+void ass_clear_fonts(ASS_Library *priv)
+{
+    int i;
+    for (i = 0; i < priv->num_fontdata; ++i) {
+        free(priv->fontdata[i].name);
+        free(priv->fontdata[i].data);
+    }
+    free(priv->fontdata);
+    priv->fontdata = NULL;
+    priv->num_fontdata = 0;
+}
+
+/*
+ * Register a message callback function with libass.  Without setting one,
+ * a default handler is used which prints everything with MSGL_INFO or
+ * higher to the standard output.
+ *
+ * \param msg_cb the callback function
+ * \param data additional data that will be passed to the callback
+ */
+void ass_set_message_cb(ASS_Library *priv,
+                        void (*msg_cb)(int, const char *, va_list, void *),
+                        void *data)
+{
+    if (msg_cb) {
+        priv->msg_callback = msg_cb;
+        priv->msg_callback_data = data;
+    }
+}

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.h	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_library.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,40 +1,43 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#ifndef LIBASS_LIBRARY_H
+#define LIBASS_LIBRARY_H
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
+#include <stdarg.h>
 
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
+typedef struct {
+    char *name;
+    char *data;
+    int size;
+} ASS_Fontdata;
 
-#ifndef ASS_LIBRARY_H
-#define ASS_LIBRARY_H
+struct ass_library {
+    char *fonts_dir;
+    int extract_fonts;
+    char **style_overrides;
 
-typedef struct ass_fontdata_s {
-	char* name;
-	char* data;
-	int size;
-} ass_fontdata_t;
-
-struct ass_library_s {
-	char* fonts_dir;
-	int extract_fonts;
-	char** style_overrides;
-
-	ass_fontdata_t* fontdata;
-	int num_fontdata;
+    ASS_Fontdata *fontdata;
+    int num_fontdata;
+    void (*msg_callback)(int, const char *, va_list, void *);
+    void *msg_callback_data;
 };
 
-#endif
-
+#endif                          /* LIBASS_LIBRARY_H */

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_parse.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_parse.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_parse.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -0,0 +1,927 @@
+/*
+ * Copyright (C) 2009 Grigori Goronzy <greg at geekmind.org>
+ *
+ * This file is part of libass.
+ *
+ * Permission to use, copy, modify, and distribute this software for any
+ * purpose with or without fee is hereby granted, provided that the above
+ * copyright notice and this permission notice appear in all copies.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
+ * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
+ * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
+ * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+ * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
+ * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
+ * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
+ */
+
+#include "ADM_coreConfig.h"
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include <math.h>
+
+#include "ass_render.h"
+#include "ass_parse.h"
+
+#define MAX_BE 127
+#define NBSP 0xa0   // unicode non-breaking space character
+
+#define skip_to(x) while ((*p != (x)) && (*p != '}') && (*p != 0)) { ++p;}
+#define skip(x) if (*p == (x)) ++p; else { return p; }
+#define skipopt(x) if (*p == (x)) { ++p; }
+
+/**
+ * \brief Check if starting part of (*p) matches sample.
+ * If true, shift p to the first symbol after the matching part.
+ */
+static inline int mystrcmp(char **p, const char *sample)
+{
+    int len = strlen(sample);
+    if (strncmp(*p, sample, len) == 0) {
+        (*p) += len;
+        return 1;
+    } else
+        return 0;
+}
+
+static void change_font_size(ASS_Renderer *render_priv, double sz)
+{
+    double size = sz * render_priv->font_scale;
+
+    if (size < 1)
+        size = 1;
+    else if (size > render_priv->height * 2)
+        size = render_priv->height * 2;
+
+    ass_font_set_size(render_priv->state.font, size);
+
+    render_priv->state.font_size = sz;
+}
+
+/**
+ * \brief Change current font, using setting from render_priv->state.
+ */
+void update_font(ASS_Renderer *render_priv)
+{
+    unsigned val;
+    ASS_FontDesc desc;
+    desc.treat_family_as_pattern = render_priv->state.treat_family_as_pattern;
+
+    if (render_priv->state.family[0] == '@') {
+        desc.vertical = 1;
+        desc.family = strdup(render_priv->state.family + 1);
+    } else {
+        desc.vertical = 0;
+        desc.family = strdup(render_priv->state.family);
+    }
+
+    val = render_priv->state.bold;
+    // 0 = normal, 1 = bold, >1 = exact weight
+    if (val == 1 || val == -1)
+        val = 200;              // bold
+    else if (val <= 0)
+        val = 80;               // normal
+    desc.bold = val;
+
+    val = render_priv->state.italic;
+    if (val == 1 || val == -1)
+        val = 110;              // italic
+    else if (val <= 0)
+        val = 0;                // normal
+    desc.italic = val;
+
+    render_priv->state.font =
+        ass_font_new(render_priv->cache.font_cache, render_priv->library,
+                     render_priv->ftlibrary, render_priv->fontconfig_priv,
+                     &desc);
+    free(desc.family);
+
+    if (render_priv->state.font)
+        change_font_size(render_priv, render_priv->state.font_size);
+}
+
+/**
+ * \brief Change border width
+ * negative value resets border to style value
+ */
+void change_border(ASS_Renderer *render_priv, double border_x,
+                   double border_y)
+{
+    int bord;
+    if (!render_priv->state.font)
+        return;
+
+    if (border_x < 0 && border_y < 0) {
+        if (render_priv->state.style->BorderStyle == 1 ||
+            render_priv->state.style->BorderStyle == 3)
+            border_x = border_y = render_priv->state.style->Outline;
+        else
+            border_x = border_y = 1.;
+    }
+
+    render_priv->state.border_x = border_x;
+    render_priv->state.border_y = border_y;
+
+    bord = 64 * border_x * render_priv->border_scale;
+    if (bord > 0 && border_x == border_y) {
+        if (!render_priv->state.stroker) {
+            int error;
+            error =
+                FT_Stroker_New(render_priv->ftlibrary,
+                               &render_priv->state.stroker);
+            if (error) {
+                ass_msg(render_priv->library, MSGL_V,
+                        "failed to get stroker");
+                render_priv->state.stroker = 0;
+            }
+        }
+        if (render_priv->state.stroker)
+            FT_Stroker_Set(render_priv->state.stroker, bord,
+                           FT_STROKER_LINECAP_ROUND,
+                           FT_STROKER_LINEJOIN_ROUND, 0);
+    } else {
+        FT_Stroker_Done(render_priv->state.stroker);
+        render_priv->state.stroker = 0;
+    }
+}
+
+/**
+ * \brief Calculate a weighted average of two colors
+ * calculates c1*(1-a) + c2*a, but separately for each component except alpha
+ */
+static void change_color(uint32_t *var, uint32_t new, double pwr)
+{
+    (*var) = ((uint32_t) (_r(*var) * (1 - pwr) + _r(new) * pwr) << 24) +
+        ((uint32_t) (_g(*var) * (1 - pwr) + _g(new) * pwr) << 16) +
+        ((uint32_t) (_b(*var) * (1 - pwr) + _b(new) * pwr) << 8) + _a(*var);
+}
+
+// like change_color, but for alpha component only
+inline void change_alpha(uint32_t *var, uint32_t new, double pwr)
+{
+    *var =
+        (_r(*var) << 24) + (_g(*var) << 16) + (_b(*var) << 8) +
+        (uint32_t) (_a(*var) * (1 - pwr) + _a(new) * pwr);
+}
+
+/**
+ * \brief Multiply two alpha values
+ * \param a first value
+ * \param b second value
+ * \return result of multiplication
+ * Parameters and result are limited by 0xFF.
+ */
+inline uint32_t mult_alpha(uint32_t a, uint32_t b)
+{
+    return 0xFF - (0xFF - a) * (0xFF - b) / 0xFF;
+}
+
+/**
+ * \brief Calculate alpha value by piecewise linear function
+ * Used for \fad, \fade implementation.
+ */
+static unsigned
+interpolate_alpha(long long now, long long t1, long long t2, long long t3,
+                  long long t4, unsigned a1, unsigned a2, unsigned a3)
+{
+    unsigned a;
+    double cf;
+    if (now <= t1) {
+        a = a1;
+    } else if (now >= t4) {
+        a = a3;
+    } else if (now < t2) {      // and > t1
+        cf = ((double) (now - t1)) / (t2 - t1);
+        a = a1 * (1 - cf) + a2 * cf;
+    } else if (now > t3) {
+        cf = ((double) (now - t3)) / (t4 - t3);
+        a = a2 * (1 - cf) + a3 * cf;
+    } else {                    // t2 <= now <= t3
+        a = a2;
+    }
+
+    return a;
+}
+
+/**
+ * Parse a vector clip into an outline, using the proper scaling
+ * parameters.  Translate it to correct for screen borders, if needed.
+ */
+static char *parse_vector_clip(ASS_Renderer *render_priv, char *p)
+{
+    int scale = 1;
+    int res = 0;
+    ASS_Drawing *drawing = render_priv->state.clip_drawing;
+
+    if (drawing && drawing->glyph)
+        FT_Done_Glyph((FT_Glyph) drawing->glyph);
+    ass_drawing_free(drawing);
+    render_priv->state.clip_drawing = ass_drawing_new(
+        render_priv->fontconfig_priv,
+        render_priv->state.font,
+        render_priv->ftlibrary);
+    drawing = render_priv->state.clip_drawing;
+    skipopt('(');
+    res = mystrtoi(&p, &scale);
+    skipopt(',')
+    if (!res)
+        scale = 1;
+    drawing->scale = scale;
+    drawing->scale_x = render_priv->font_scale_x * render_priv->font_scale;
+    drawing->scale_y = render_priv->font_scale;
+    while (*p != ')' && *p != '}' && p != 0)
+        ass_drawing_add_char(drawing, *p++);
+    skipopt(')');
+
+    return p;
+}
+
+/**
+ * \brief Parse style override tag.
+ * \param p string to parse
+ * \param pwr multiplier for some tag effects (comes from \t tags)
+ */
+static char *parse_tag(ASS_Renderer *render_priv, char *p, double pwr)
+{
+    skip_to('\\');
+    skip('\\');
+    if ((*p == '}') || (*p == 0))
+        return p;
+
+    // New tags introduced in vsfilter 2.39
+    if (mystrcmp(&p, "xbord")) {
+        double val;
+        if (mystrtod(&p, &val))
+            val = render_priv->state.border_x * (1 - pwr) + val * pwr;
+        else
+            val = -1.;
+        change_border(render_priv, val, render_priv->state.border_y);
+    } else if (mystrcmp(&p, "ybord")) {
+        double val;
+        if (mystrtod(&p, &val))
+            val = render_priv->state.border_y * (1 - pwr) + val * pwr;
+        else
+            val = -1.;
+        change_border(render_priv, render_priv->state.border_x, val);
+    } else if (mystrcmp(&p, "xshad")) {
+        double val;
+        if (mystrtod(&p, &val))
+            val = render_priv->state.shadow_x * (1 - pwr) + val * pwr;
+        else
+            val = 0.;
+        render_priv->state.shadow_x = val;
+    } else if (mystrcmp(&p, "yshad")) {
+        double val;
+        if (mystrtod(&p, &val))
+            val = render_priv->state.shadow_y * (1 - pwr) + val * pwr;
+        else
+            val = 0.;
+        render_priv->state.shadow_y = val;
+    } else if (mystrcmp(&p, "fax")) {
+        double val;
+        if (mystrtod(&p, &val))
+            render_priv->state.fax =
+                val * pwr + render_priv->state.fax * (1 - pwr);
+        else
+            render_priv->state.fax = 0.;
+    } else if (mystrcmp(&p, "fay")) {
+        double val;
+        if (mystrtod(&p, &val))
+            render_priv->state.fay =
+                val * pwr + render_priv->state.fay * (1 - pwr);
+        else
+            render_priv->state.fay = 0.;
+    } else if (mystrcmp(&p, "iclip")) {
+        int x0, y0, x1, y1;
+        int res = 1;
+        char *start = p;
+        skipopt('(');
+        res &= mystrtoi(&p, &x0);
+        skipopt(',');
+        res &= mystrtoi(&p, &y0);
+        skipopt(',');
+        res &= mystrtoi(&p, &x1);
+        skipopt(',');
+        res &= mystrtoi(&p, &y1);
+        skipopt(')');
+        if (res) {
+            render_priv->state.clip_x0 =
+                render_priv->state.clip_x0 * (1 - pwr) + x0 * pwr;
+            render_priv->state.clip_x1 =
+                render_priv->state.clip_x1 * (1 - pwr) + x1 * pwr;
+            render_priv->state.clip_y0 =
+                render_priv->state.clip_y0 * (1 - pwr) + y0 * pwr;
+            render_priv->state.clip_y1 =
+                render_priv->state.clip_y1 * (1 - pwr) + y1 * pwr;
+            render_priv->state.clip_mode = 1;
+        } else if (!render_priv->state.clip_drawing) {
+            p = parse_vector_clip(render_priv, start);
+            render_priv->state.clip_drawing_mode = 1;
+        } else
+            render_priv->state.clip_mode = 0;
+    } else if (mystrcmp(&p, "blur")) {
+        double val;
+        if (mystrtod(&p, &val)) {
+            val = render_priv->state.blur * (1 - pwr) + val * pwr;
+            val = (val < 0) ? 0 : val;
+            val = (val > BLUR_MAX_RADIUS) ? BLUR_MAX_RADIUS : val;
+            render_priv->state.blur = val;
+        } else
+            render_priv->state.blur = 0.0;
+        // ASS standard tags
+    } else if (mystrcmp(&p, "fsc")) {
+        char tp = *p++;
+        double val;
+        if (tp == 'x') {
+            if (mystrtod(&p, &val)) {
+                val /= 100;
+                render_priv->state.scale_x =
+                    render_priv->state.scale_x * (1 - pwr) + val * pwr;
+            } else
+                render_priv->state.scale_x =
+                    render_priv->state.style->ScaleX;
+        } else if (tp == 'y') {
+            if (mystrtod(&p, &val)) {
+                val /= 100;
+                render_priv->state.scale_y =
+                    render_priv->state.scale_y * (1 - pwr) + val * pwr;
+            } else
+                render_priv->state.scale_y =
+                    render_priv->state.style->ScaleY;
+        }
+    } else if (mystrcmp(&p, "fsp")) {
+        double val;
+        if (mystrtod(&p, &val))
+            render_priv->state.hspacing =
+                render_priv->state.hspacing * (1 - pwr) + val * pwr;
+        else
+            render_priv->state.hspacing = render_priv->state.style->Spacing;
+    } else if (mystrcmp(&p, "fs")) {
+        double val;
+        if (mystrtod(&p, &val))
+            val = render_priv->state.font_size * (1 - pwr) + val * pwr;
+        else
+            val = render_priv->state.style->FontSize;
+        if (render_priv->state.font)
+            change_font_size(render_priv, val);
+    } else if (mystrcmp(&p, "bord")) {
+        double val;
+        if (mystrtod(&p, &val)) {
+            if (render_priv->state.border_x == render_priv->state.border_y)
+                val = render_priv->state.border_x * (1 - pwr) + val * pwr;
+        } else
+            val = -1.;          // reset to default
+        change_border(render_priv, val, val);
+    } else if (mystrcmp(&p, "move")) {
+        double x1, x2, y1, y2;
+        long long t1, t2, delta_t, t;
+        double x, y;
+        double k;
+        skip('(');
+        mystrtod(&p, &x1);
+        skip(',');
+        mystrtod(&p, &y1);
+        skip(',');
+        mystrtod(&p, &x2);
+        skip(',');
+        mystrtod(&p, &y2);
+        if (*p == ',') {
+            skip(',');
+            mystrtoll(&p, &t1);
+            skip(',');
+            mystrtoll(&p, &t2);
+            ass_msg(render_priv->library, MSGL_DBG2,
+                   "movement6: (%f, %f) -> (%f, %f), (%" PRId64 " .. %"
+                   PRId64 ")\n", x1, y1, x2, y2, (int64_t) t1,
+                   (int64_t) t2);
+        } else {
+            t1 = 0;
+            t2 = render_priv->state.event->Duration;
+            ass_msg(render_priv->library, MSGL_DBG2,
+                   "movement: (%f, %f) -> (%f, %f)", x1, y1, x2, y2);
+        }
+        skip(')');
+        delta_t = t2 - t1;
+        t = render_priv->time - render_priv->state.event->Start;
+        if (t < t1)
+            k = 0.;
+        else if (t > t2)
+            k = 1.;
+        else
+            k = ((double) (t - t1)) / delta_t;
+        x = k * (x2 - x1) + x1;
+        y = k * (y2 - y1) + y1;
+        if (render_priv->state.evt_type != EVENT_POSITIONED) {
+            render_priv->state.pos_x = x;
+            render_priv->state.pos_y = y;
+            render_priv->state.detect_collisions = 0;
+            render_priv->state.evt_type = EVENT_POSITIONED;
+        }
+    } else if (mystrcmp(&p, "frx")) {
+        double val;
+        if (mystrtod(&p, &val)) {
+            val *= M_PI / 180;
+            render_priv->state.frx =
+                val * pwr + render_priv->state.frx * (1 - pwr);
+        } else
+            render_priv->state.frx = 0.;
+    } else if (mystrcmp(&p, "fry")) {
+        double val;
+        if (mystrtod(&p, &val)) {
+            val *= M_PI / 180;
+            render_priv->state.fry =
+                val * pwr + render_priv->state.fry * (1 - pwr);
+        } else
+            render_priv->state.fry = 0.;
+    } else if (mystrcmp(&p, "frz") || mystrcmp(&p, "fr")) {
+        double val;
+        if (mystrtod(&p, &val)) {
+            val *= M_PI / 180;
+            render_priv->state.frz =
+                val * pwr + render_priv->state.frz * (1 - pwr);
+        } else
+            render_priv->state.frz =
+                M_PI * render_priv->state.style->Angle / 180.;
+    } else if (mystrcmp(&p, "fn")) {
+        char *start = p;
+        char *family;
+        skip_to('\\');
+        if (p > start) {
+            family = malloc(p - start + 1);
+            strncpy(family, start, p - start);
+            family[p - start] = '\0';
+        } else
+            family = strdup(render_priv->state.style->FontName);
+        free(render_priv->state.family);
+        render_priv->state.family = family;
+        update_font(render_priv);
+    } else if (mystrcmp(&p, "alpha")) {
+        uint32_t val;
+        int i;
+        int hex = render_priv->track->track_type == TRACK_TYPE_ASS;
+        if (strtocolor(render_priv->library, &p, &val, hex)) {
+            unsigned char a = val >> 24;
+            for (i = 0; i < 4; ++i)
+                change_alpha(&render_priv->state.c[i], a, pwr);
+        } else {
+            change_alpha(&render_priv->state.c[0],
+                         render_priv->state.style->PrimaryColour, pwr);
+            change_alpha(&render_priv->state.c[1],
+                         render_priv->state.style->SecondaryColour, pwr);
+            change_alpha(&render_priv->state.c[2],
+                         render_priv->state.style->OutlineColour, pwr);
+            change_alpha(&render_priv->state.c[3],
+                         render_priv->state.style->BackColour, pwr);
+        }
+        // FIXME: simplify
+    } else if (mystrcmp(&p, "an")) {
+        int val;
+        if (mystrtoi(&p, &val) && val) {
+            int v = (val - 1) / 3;      // 0, 1 or 2 for vertical alignment
+            ass_msg(render_priv->library, MSGL_DBG2, "an %d", val);
+            if (v != 0)
+                v = 3 - v;
+            val = ((val - 1) % 3) + 1;  // horizontal alignment
+            val += v * 4;
+            ass_msg(render_priv->library, MSGL_DBG2, "align %d", val);
+            render_priv->state.alignment = val;
+        } else
+            render_priv->state.alignment =
+                render_priv->state.style->Alignment;
+    } else if (mystrcmp(&p, "a")) {
+        int val;
+        if (mystrtoi(&p, &val) && val)
+            // take care of a vsfilter quirk: handle illegal \a8 like \a5
+            render_priv->state.alignment = (val == 8) ? 5 : val;
+        else
+            render_priv->state.alignment =
+                render_priv->state.style->Alignment;
+    } else if (mystrcmp(&p, "pos")) {
+        double v1, v2;
+        skip('(');
+        mystrtod(&p, &v1);
+        skip(',');
+        mystrtod(&p, &v2);
+        skip(')');
+        ass_msg(render_priv->library, MSGL_DBG2, "pos(%f, %f)", v1, v2);
+        if (render_priv->state.evt_type == EVENT_POSITIONED) {
+            ass_msg(render_priv->library, MSGL_V, "Subtitle has a new \\pos "
+                   "after \\move or \\pos, ignoring");
+        } else {
+            render_priv->state.evt_type = EVENT_POSITIONED;
+            render_priv->state.detect_collisions = 0;
+            render_priv->state.pos_x = v1;
+            render_priv->state.pos_y = v2;
+        }
+    } else if (mystrcmp(&p, "fad")) {
+        int a1, a2, a3;
+        long long t1, t2, t3, t4;
+        if (*p == 'e')
+            ++p;                // either \fad or \fade
+        skip('(');
+        mystrtoi(&p, &a1);
+        skip(',');
+        mystrtoi(&p, &a2);
+        if (*p == ')') {
+            // 2-argument version (\fad, according to specs)
+            // a1 and a2 are fade-in and fade-out durations
+            t1 = 0;
+            t4 = render_priv->state.event->Duration;
+            t2 = a1;
+            t3 = t4 - a2;
+            a1 = 0xFF;
+            a2 = 0;
+            a3 = 0xFF;
+        } else {
+            // 6-argument version (\fade)
+            // a1 and a2 (and a3) are opacity values
+            skip(',');
+            mystrtoi(&p, &a3);
+            skip(',');
+            mystrtoll(&p, &t1);
+            skip(',');
+            mystrtoll(&p, &t2);
+            skip(',');
+            mystrtoll(&p, &t3);
+            skip(',');
+            mystrtoll(&p, &t4);
+        }
+        skip(')');
+        render_priv->state.fade =
+            interpolate_alpha(render_priv->time -
+                              render_priv->state.event->Start, t1, t2,
+                              t3, t4, a1, a2, a3);
+    } else if (mystrcmp(&p, "org")) {
+        int v1, v2;
+        skip('(');
+        mystrtoi(&p, &v1);
+        skip(',');
+        mystrtoi(&p, &v2);
+        skip(')');
+        ass_msg(render_priv->library, MSGL_DBG2, "org(%d, %d)", v1, v2);
+        if (!render_priv->state.have_origin) {
+            render_priv->state.org_x = v1;
+            render_priv->state.org_y = v2;
+            render_priv->state.have_origin = 1;
+            render_priv->state.detect_collisions = 0;
+        }
+    } else if (mystrcmp(&p, "t")) {
+        double v[3];
+        int v1, v2;
+        double v3;
+        int cnt;
+        long long t1, t2, t, delta_t;
+        double k;
+        skip('(');
+        for (cnt = 0; cnt < 3; ++cnt) {
+            if (*p == '\\')
+                break;
+            mystrtod(&p, &v[cnt]);
+            skip(',');
+        }
+        if (cnt == 3) {
+            v1 = v[0];
+            v2 = (v[1] < v1) ? render_priv->state.event->Duration : v[1];
+            v3 = v[2];
+        } else if (cnt == 2) {
+            v1 = v[0];
+            v2 = (v[1] < v1) ? render_priv->state.event->Duration : v[1];
+            v3 = 1.;
+        } else if (cnt == 1) {
+            v1 = 0;
+            v2 = render_priv->state.event->Duration;
+            v3 = v[0];
+        } else {                // cnt == 0
+            v1 = 0;
+            v2 = render_priv->state.event->Duration;
+            v3 = 1.;
+        }
+        render_priv->state.detect_collisions = 0;
+        t1 = v1;
+        t2 = v2;
+        delta_t = v2 - v1;
+        if (v3 < 0.)
+            v3 = 0.;
+        t = render_priv->time - render_priv->state.event->Start;        // FIXME: move to render_context
+        if (t <= t1)
+            k = 0.;
+        else if (t >= t2)
+            k = 1.;
+        else {
+            assert(delta_t != 0.);
+            k = pow(((double) (t - t1)) / delta_t, v3);
+        }
+        while (*p == '\\')
+            p = parse_tag(render_priv, p, k);   // maybe k*pwr ? no, specs forbid nested \t's
+        skip_to(')');           // in case there is some unknown tag or a comment
+        skip(')');
+    } else if (mystrcmp(&p, "clip")) {
+        char *start = p;
+        int x0, y0, x1, y1;
+        int res = 1;
+        skipopt('(');
+        res &= mystrtoi(&p, &x0);
+        skipopt(',');
+        res &= mystrtoi(&p, &y0);
+        skipopt(',');
+        res &= mystrtoi(&p, &x1);
+        skipopt(',');
+        res &= mystrtoi(&p, &y1);
+        skipopt(')');
+        if (res) {
+            render_priv->state.clip_x0 =
+                render_priv->state.clip_x0 * (1 - pwr) + x0 * pwr;
+            render_priv->state.clip_x1 =
+                render_priv->state.clip_x1 * (1 - pwr) + x1 * pwr;
+            render_priv->state.clip_y0 =
+                render_priv->state.clip_y0 * (1 - pwr) + y0 * pwr;
+            render_priv->state.clip_y1 =
+                render_priv->state.clip_y1 * (1 - pwr) + y1 * pwr;
+        // Might be a vector clip
+        } else if (!render_priv->state.clip_drawing) {
+            p = parse_vector_clip(render_priv, start);
+            render_priv->state.clip_drawing_mode = 0;
+        } else {
+            render_priv->state.clip_x0 = 0;
+            render_priv->state.clip_y0 = 0;
+            render_priv->state.clip_x1 = render_priv->track->PlayResX;
+            render_priv->state.clip_y1 = render_priv->track->PlayResY;
+        }
+    } else if (mystrcmp(&p, "c")) {
+        uint32_t val;
+        int hex = render_priv->track->track_type == TRACK_TYPE_ASS;
+        if (!strtocolor(render_priv->library, &p, &val, hex))
+            val = render_priv->state.style->PrimaryColour;
+        ass_msg(render_priv->library, MSGL_DBG2, "color: %X", val);
+        change_color(&render_priv->state.c[0], val, pwr);
+    } else if ((*p >= '1') && (*p <= '4') && (++p)
+               && (mystrcmp(&p, "c") || mystrcmp(&p, "a"))) {
+        char n = *(p - 2);
+        int cidx = n - '1';
+        char cmd = *(p - 1);
+        uint32_t val;
+        int hex = render_priv->track->track_type == TRACK_TYPE_ASS;
+        assert((n >= '1') && (n <= '4'));
+        if (!strtocolor(render_priv->library, &p, &val, hex))
+            switch (n) {
+            case '1':
+                val = render_priv->state.style->PrimaryColour;
+                break;
+            case '2':
+                val = render_priv->state.style->SecondaryColour;
+                break;
+            case '3':
+                val = render_priv->state.style->OutlineColour;
+                break;
+            case '4':
+                val = render_priv->state.style->BackColour;
+                break;
+            default:
+                val = 0;
+                break;          // impossible due to assert; avoid compilation warning
+            }
+        switch (cmd) {
+        case 'c':
+            change_color(render_priv->state.c + cidx, val, pwr);
+            break;
+        case 'a':
+            change_alpha(render_priv->state.c + cidx, val >> 24, pwr);
+            break;
+        default:
+            ass_msg(render_priv->library, MSGL_WARN, "Bad command: %c%c",
+                    n, cmd);
+            break;
+        }
+        ass_msg(render_priv->library, MSGL_DBG2, "single c/a at %f: %c%c = %X",
+               pwr, n, cmd, render_priv->state.c[cidx]);
+    } else if (mystrcmp(&p, "r")) {
+        reset_render_context(render_priv);
+    } else if (mystrcmp(&p, "be")) {
+        int val;
+        if (mystrtoi(&p, &val)) {
+            // Clamp to a safe upper limit, since high values need excessive CPU
+            val = (val < 0) ? 0 : val;
+            val = (val > MAX_BE) ? MAX_BE : val;
+            render_priv->state.be = val;
+        } else
+            render_priv->state.be = 0;
+    } else if (mystrcmp(&p, "b")) {
+        int b;
+        if (mystrtoi(&p, &b)) {
+            if (pwr >= .5)
+                render_priv->state.bold = b;
+        } else
+            render_priv->state.bold = render_priv->state.style->Bold;
+        update_font(render_priv);
+    } else if (mystrcmp(&p, "i")) {
+        int i;
+        if (mystrtoi(&p, &i)) {
+            if (pwr >= .5)
+                render_priv->state.italic = i;
+        } else
+            render_priv->state.italic = render_priv->state.style->Italic;
+        update_font(render_priv);
+    } else if (mystrcmp(&p, "kf") || mystrcmp(&p, "K")) {
+        int val = 0;
+        mystrtoi(&p, &val);
+        render_priv->state.effect_type = EF_KARAOKE_KF;
+        if (render_priv->state.effect_timing)
+            render_priv->state.effect_skip_timing +=
+                render_priv->state.effect_timing;
+        render_priv->state.effect_timing = val * 10;
+    } else if (mystrcmp(&p, "ko")) {
+        int val = 0;
+        mystrtoi(&p, &val);
+        render_priv->state.effect_type = EF_KARAOKE_KO;
+        if (render_priv->state.effect_timing)
+            render_priv->state.effect_skip_timing +=
+                render_priv->state.effect_timing;
+        render_priv->state.effect_timing = val * 10;
+    } else if (mystrcmp(&p, "k")) {
+        int val = 0;
+        mystrtoi(&p, &val);
+        render_priv->state.effect_type = EF_KARAOKE;
+        if (render_priv->state.effect_timing)
+            render_priv->state.effect_skip_timing +=
+                render_priv->state.effect_timing;
+        render_priv->state.effect_timing = val * 10;
+    } else if (mystrcmp(&p, "shad")) {
+        double val;
+        if (mystrtod(&p, &val)) {
+            if (render_priv->state.shadow_x == render_priv->state.shadow_y)
+                val = render_priv->state.shadow_x * (1 - pwr) + val * pwr;
+        } else
+            val = 0.;
+        render_priv->state.shadow_x = render_priv->state.shadow_y = val;
+    } else if (mystrcmp(&p, "s")) {
+        int val;
+        if (mystrtoi(&p, &val) && val)
+            render_priv->state.flags |= DECO_STRIKETHROUGH;
+        else
+            render_priv->state.flags &= ~DECO_STRIKETHROUGH;
+    } else if (mystrcmp(&p, "u")) {
+        int val;
+        if (mystrtoi(&p, &val) && val)
+            render_priv->state.flags |= DECO_UNDERLINE;
+        else
+            render_priv->state.flags &= ~DECO_UNDERLINE;
+    } else if (mystrcmp(&p, "pbo")) {
+        double val = 0;
+        if (mystrtod(&p, &val))
+            render_priv->state.drawing->pbo = val;
+    } else if (mystrcmp(&p, "p")) {
+        int val;
+        if (!mystrtoi(&p, &val))
+            val = 0;
+        if (val)
+            render_priv->state.drawing->scale = val;
+        render_priv->state.drawing_mode = !!val;
+    } else if (mystrcmp(&p, "q")) {
+        int val;
+        if (!mystrtoi(&p, &val))
+            val = render_priv->track->WrapStyle;
+        render_priv->state.wrap_style = val;
+    }
+
+    return p;
+}
+
+void apply_transition_effects(ASS_Renderer *render_priv, ASS_Event *event)
+{
+    int v[4];
+    int cnt;
+    char *p = event->Effect;
+
+    if (!p || !*p)
+        return;
+
+    cnt = 0;
+    while (cnt < 4 && (p = strchr(p, ';'))) {
+        v[cnt++] = atoi(++p);
+    }
+
+    if (strncmp(event->Effect, "Banner;", 7) == 0) {
+        int delay;
+        if (cnt < 1) {
+            ass_msg(render_priv->library, MSGL_V,
+                    "Error parsing effect: '%s'", event->Effect);
+            return;
+        }
+        if (cnt >= 2 && v[1] == 0)      // right-to-left
+            render_priv->state.scroll_direction = SCROLL_RL;
+        else                    // left-to-right
+            render_priv->state.scroll_direction = SCROLL_LR;
+
+        delay = v[0];
+        if (delay == 0)
+            delay = 1;          // ?
+        render_priv->state.scroll_shift =
+            (render_priv->time - render_priv->state.event->Start) / delay;
+        render_priv->state.evt_type = EVENT_HSCROLL;
+        return;
+    }
+
+    if (strncmp(event->Effect, "Scroll up;", 10) == 0) {
+        render_priv->state.scroll_direction = SCROLL_BT;
+    } else if (strncmp(event->Effect, "Scroll down;", 12) == 0) {
+        render_priv->state.scroll_direction = SCROLL_TB;
+    } else {
+        ass_msg(render_priv->library, MSGL_DBG2,
+                "Unknown transition effect: '%s'", event->Effect);
+        return;
+    }
+    // parse scroll up/down parameters
+    {
+        int delay;
+        int y0, y1;
+        if (cnt < 3) {
+            ass_msg(render_priv->library, MSGL_V,
+                    "Error parsing effect: '%s'", event->Effect);
+            return;
+        }
+        delay = v[2];
+        if (delay == 0)
+            delay = 1;          // ?
+        render_priv->state.scroll_shift =
+            (render_priv->time - render_priv->state.event->Start) / delay;
+        if (v[0] < v[1]) {
+            y0 = v[0];
+            y1 = v[1];
+        } else {
+            y0 = v[1];
+            y1 = v[0];
+        }
+        if (y1 == 0)
+            y1 = render_priv->track->PlayResY;  // y0=y1=0 means fullscreen scrolling
+        render_priv->state.clip_y0 = y0;
+        render_priv->state.clip_y1 = y1;
+        render_priv->state.evt_type = EVENT_VSCROLL;
+        render_priv->state.detect_collisions = 0;
+    }
+
+}
+
+/**
+ * \brief Get next ucs4 char from string, parsing and executing style overrides
+ * \param str string pointer
+ * \return ucs4 code of the next char
+ * On return str points to the unparsed part of the string
+ */
+unsigned get_next_char(ASS_Renderer *render_priv, char **str)
+{
+    char *p = *str;
+    unsigned chr;
+    if (*p == '{') {            // '\0' goes here
+        p++;
+        while (1) {
+            p = parse_tag(render_priv, p, 1.);
+            if (*p == '}') {    // end of tag
+                p++;
+                if (*p == '{') {
+                    p++;
+                    continue;
+                } else
+                    break;
+            } else if (*p != '\\')
+                ass_msg(render_priv->library, MSGL_V,
+                        "Unable to parse: '%.30s'", p);
+            if (*p == 0)
+                break;
+        }
+    }
+    if (*p == '\t') {
+        ++p;
+        *str = p;
+        return ' ';
+    }
+    if (*p == '\\') {
+        if ((p[1] == 'N') || ((p[1] == 'n') &&
+                              (render_priv->state.wrap_style == 2))) {
+            p += 2;
+            *str = p;
+            return '\n';
+        } else if (p[1] == 'n') {
+            p += 2;
+            *str = p;
+            return ' ';
+        } else if (p[1] == 'h') {
+            p += 2;
+            *str = p;
+            return NBSP;
+        } else if (p[1] == '{') {
+            p += 2;
+            *str = p;
+            return '{';
+        } else if (p[1] == '}') {
+            p += 2;
+            *str = p;
+            return '}';
+        }
+    }
+    chr = ass_utf8_get_char((char **) &p);
+    *str = p;
+    return chr;
+}

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_parse.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_parse.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_parse.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -0,0 +1,38 @@
+/*
+ * Copyright (C) 2009 Grigori Goronzy <greg at geekmind.org>
+ *
+ * This file is part of libass.
+ *
+ * Permission to use, copy, modify, and distribute this software for any
+ * purpose with or without fee is hereby granted, provided that the above
+ * copyright notice and this permission notice appear in all copies.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
+ * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
+ * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
+ * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+ * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
+ * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
+ * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
+ */
+
+#ifndef LIBASS_PARSE_H
+#define LIBASS_PARSE_H
+
+#define BLUR_MAX_RADIUS 100.0
+
+#define _r(c)   ((c) >> 24)
+#define _g(c)   (((c) >> 16) & 0xFF)
+#define _b(c)   (((c) >> 8) & 0xFF)
+#define _a(c)   ((c) & 0xFF)
+
+void update_font(ASS_Renderer *render_priv);
+void change_border(ASS_Renderer *render_priv, double border_x,
+                   double border_y);
+void apply_transition_effects(ASS_Renderer *render_priv, ASS_Event *event);
+unsigned get_next_char(ASS_Renderer *render_priv, char **str);
+extern void change_alpha(uint32_t *var, uint32_t new, double pwr);
+extern uint32_t mult_alpha(uint32_t a, uint32_t b);
+
+
+#endif /* LIBASS_PARSE_H */

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render.c	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,308 +1,358 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#include "ADM_coreConfig.h"
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
+#include <assert.h>
+#include <math.h>
 
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
+#include "ass_render.h"
+#include "ass_parse.h"
 
-//#include "config.h"
+#define MAX_GLYPHS_INITIAL 1024
+#define MAX_LINES_INITIAL 64
+#define SUBPIXEL_MASK 63
+#define SUBPIXEL_ACCURACY 7
 
-#include <assert.h>
-#include <math.h>
-#include <inttypes.h>
-#include <ft2build.h>
-#include FT_FREETYPE_H
-#include FT_STROKER_H
-#include FT_GLYPH_H
-#include FT_SYNTHESIS_H
+static void ass_lazy_track_init(ASS_Renderer *render_priv)
+{
+    ASS_Track *track = render_priv->track;
 
-#include "mputils.h"
+    if (track->PlayResX && track->PlayResY)
+        return;
+    if (!track->PlayResX && !track->PlayResY) {
+        ass_msg(render_priv->library, MSGL_WARN,
+               "Neither PlayResX nor PlayResY defined. Assuming 384x288");
+        track->PlayResX = 384;
+        track->PlayResY = 288;
+    } else {
+        if (!track->PlayResY && track->PlayResX == 1280) {
+            track->PlayResY = 1024;
+            ass_msg(render_priv->library, MSGL_WARN,
+                   "PlayResY undefined, setting to %d", track->PlayResY);
+        } else if (!track->PlayResY) {
+            track->PlayResY = track->PlayResX * 3 / 4;
+            ass_msg(render_priv->library, MSGL_WARN,
+                   "PlayResY undefined, setting to %d", track->PlayResY);
+        } else if (!track->PlayResX && track->PlayResY == 1024) {
+            track->PlayResX = 1280;
+            ass_msg(render_priv->library, MSGL_WARN,
+                   "PlayResX undefined, setting to %d", track->PlayResX);
+        } else if (!track->PlayResX) {
+            track->PlayResX = track->PlayResY * 4 / 3;
+            ass_msg(render_priv->library, MSGL_WARN,
+                   "PlayResX undefined, setting to %d", track->PlayResX);
+        }
+    }
+}
 
-#include "ass.h"
-#include "ass_font.h"
-#include "ass_bitmap.h"
-#include "ass_cache.h"
-#include "ass_utils.h"
-#include "ass_fontconfig.h"
-#include "ass_library.h"
+ASS_Renderer *ass_renderer_init(ASS_Library *library)
+{
+    int error;
+    FT_Library ft;
+    ASS_Renderer *priv = 0;
+    int vmajor, vminor, vpatch;
 
-#define MAX_GLYPHS 1000
-#define MAX_LINES 100
+    error = FT_Init_FreeType(&ft);
+    if (error) {
+        ass_msg(library, MSGL_FATAL, "%s failed", "FT_Init_FreeType");
+        goto ass_init_exit;
+    }
 
-static int last_render_id = 0;
+    FT_Library_Version(ft, &vmajor, &vminor, &vpatch);
+    ass_msg(library, MSGL_V, "FreeType library version: %d.%d.%d",
+           vmajor, vminor, vpatch);
+    ass_msg(library, MSGL_V, "FreeType headers version: %d.%d.%d",
+           FREETYPE_MAJOR, FREETYPE_MINOR, FREETYPE_PATCH);
 
-typedef struct ass_settings_s {
-	int frame_width;
-	int frame_height;
-	double font_size_coeff; // font size multiplier
-	double line_spacing; // additional line spacing (in frame pixels)
-	int top_margin; // height of top margin. Everything except toptitles is shifted down by top_margin.
-	int bottom_margin; // height of bottom margin. (frame_height - top_margin - bottom_margin) is original video height.
-	int left_margin;
-	int right_margin;
-	int use_margins; // 0 - place all subtitles inside original frame
-	                 // 1 - use margins for placing toptitles and subtitles
-	double aspect; // frame aspect ratio, d_width / d_height.
-	ass_hinting_t hinting;
+    priv = calloc(1, sizeof(ASS_Renderer));
+    if (!priv) {
+        FT_Done_FreeType(ft);
+        goto ass_init_exit;
+    }
 
-	char* default_font;
-	char* default_family;
-} ass_settings_t;
+    priv->synth_priv = ass_synth_init(BLUR_MAX_RADIUS);
 
-// a rendered event
-typedef struct event_images_s {
-	ass_image_t* imgs;
-	int top, height;
-	int detect_collisions;
-	int shift_direction;
-	ass_event_t* event;
-} event_images_t;
+    priv->library = library;
+    priv->ftlibrary = ft;
+    // images_root and related stuff is zero-filled in calloc
 
-struct ass_renderer_s {
-	ass_library_t* library;
-	FT_Library ftlibrary;
-	fc_instance_t* fontconfig_priv;
-	ass_settings_t settings;
-	int render_id;
-	ass_synth_priv_t* synth_priv;
+    priv->cache.font_cache = ass_font_cache_init(library);
+    priv->cache.bitmap_cache = ass_bitmap_cache_init(library);
+    priv->cache.composite_cache = ass_composite_cache_init(library);
+    priv->cache.glyph_cache = ass_glyph_cache_init(library);
+    priv->cache.glyph_max = GLYPH_CACHE_MAX;
+    priv->cache.bitmap_max_size = BITMAP_CACHE_MAX_SIZE;
 
-	ass_image_t* images_root; // rendering result is stored here
-	ass_image_t* prev_images_root;
+    priv->text_info.max_glyphs = MAX_GLYPHS_INITIAL;
+    priv->text_info.max_lines = MAX_LINES_INITIAL;
+    priv->text_info.glyphs = calloc(MAX_GLYPHS_INITIAL, sizeof(GlyphInfo));
+    priv->text_info.lines = calloc(MAX_LINES_INITIAL, sizeof(LineInfo));
 
-	event_images_t* eimg; // temporary buffer for sorting rendered events
-	int eimg_size; // allocated buffer size
-};
+    priv->settings.font_size_coeff = 1.;
 
-typedef enum {EF_NONE = 0, EF_KARAOKE, EF_KARAOKE_KF, EF_KARAOKE_KO} effect_t;
+  ass_init_exit:
+    if (priv)
+        ass_msg(library, MSGL_V, "Init");
+    else
+        ass_msg(library, MSGL_ERR, "Init failed");
 
-// describes a glyph
-// glyph_info_t and text_info_t are used for text centering and word-wrapping operations
-typedef struct glyph_info_s {
-	unsigned symbol;
-	FT_Glyph glyph;
-	FT_Glyph outline_glyph;
-	bitmap_t* bm; // glyph bitmap
-	bitmap_t* bm_o; // outline bitmap
-	bitmap_t* bm_s; // shadow bitmap
-	FT_BBox bbox;
-	FT_Vector pos;
-	char linebreak; // the first (leading) glyph of some line ?
-	uint32_t c[4]; // colors
-	FT_Vector advance; // 26.6
-	effect_t effect_type;
-	int effect_timing; // time duration of current karaoke word
-	                   // after process_karaoke_effects: distance in pixels from the glyph origin.
-	                   // part of the glyph to the left of it is displayed in a different color.
-	int effect_skip_timing; // delay after the end of last karaoke word
-	int asc, desc; // font max ascender and descender
-//	int height;
-	int be; // blur edges
-	int shadow;
-	double frx, fry, frz; // rotation
-	
-	bitmap_hash_key_t hash_key;
-} glyph_info_t;
+    return priv;
+}
 
-typedef struct line_info_s {
-	int asc, desc;
-} line_info_t;
+static void free_list_clear(ASS_Renderer *render_priv)
+{
+    if (render_priv->free_head) {
+        FreeList *item = render_priv->free_head;
+        while(item) {
+            FreeList *oi = item;
+            free(item->object);
+            item = item->next;
+            free(oi);
+        }
+        render_priv->free_head = NULL;
+    }
+}
 
-typedef struct text_info_s {
-	glyph_info_t* glyphs;
-	int length;
-	line_info_t lines[MAX_LINES];
-	int n_lines;
-	int height;
-} text_info_t;
+void ass_renderer_done(ASS_Renderer *render_priv)
+{
+    ass_font_cache_done(render_priv->cache.font_cache);
+    ass_bitmap_cache_done(render_priv->cache.bitmap_cache);
+    ass_composite_cache_done(render_priv->cache.composite_cache);
+    ass_glyph_cache_done(render_priv->cache.glyph_cache);
 
+    ass_free_images(render_priv->images_root);
+    ass_free_images(render_priv->prev_images_root);
 
-// Renderer state.
-// Values like current font face, color, screen position, clipping and so on are stored here.
-typedef struct render_context_s {
-	ass_event_t* event;
-	ass_style_t* style;
-	
-	ass_font_t* font;
-	char* font_path;
-	double font_size;
-	
-	FT_Stroker stroker;
-	int alignment; // alignment overrides go here; if zero, style value will be used
-	double frx, fry, frz;
-	enum {	EVENT_NORMAL, // "normal" top-, sub- or mid- title
-		EVENT_POSITIONED, // happens after pos(,), margins are ignored
-		EVENT_HSCROLL, // "Banner" transition effect, text_width is unlimited
-		EVENT_VSCROLL // "Scroll up", "Scroll down" transition effects
-		} evt_type;
-	int pos_x, pos_y; // position
-	int org_x, org_y; // origin
-	char have_origin; // origin is explicitly defined; if 0, get_base_point() is used
-	double scale_x, scale_y;
-	double hspacing; // distance between letters, in pixels
-	double border; // outline width
-	uint32_t c[4]; // colors(Primary, Secondary, so on) in RGBA
-	int clip_x0, clip_y0, clip_x1, clip_y1;
-	char detect_collisions;
-	uint32_t fade; // alpha from \fad
-	char be; // blur edges
-	int shadow;
+    if (render_priv->state.stroker) {
+        FT_Stroker_Done(render_priv->state.stroker);
+        render_priv->state.stroker = 0;
+    }
+    if (render_priv->ftlibrary)
+        FT_Done_FreeType(render_priv->ftlibrary);
+    if (render_priv->fontconfig_priv)
+        fontconfig_done(render_priv->fontconfig_priv);
+    if (render_priv->synth_priv)
+        ass_synth_done(render_priv->synth_priv);
+    free(render_priv->eimg);
+    free(render_priv->text_info.glyphs);
+    free(render_priv->text_info.lines);
 
-	effect_t effect_type;
-	int effect_timing;
-	int effect_skip_timing;
+    free(render_priv->settings.default_font);
+    free(render_priv->settings.default_family);
 
-	enum { SCROLL_LR, // left-to-right
-	       SCROLL_RL,
-	       SCROLL_TB, // top-to-bottom
-	       SCROLL_BT
-	       } scroll_direction; // for EVENT_HSCROLL, EVENT_VSCROLL
-	int scroll_shift;
+    free_list_clear(render_priv);
+    free(render_priv);
+}
 
-	// face properties
-	char* family;
-	unsigned bold;
-	unsigned italic;
-	
-} render_context_t;
+/**
+ * \brief Create a new ASS_Image
+ * Parameters are the same as ASS_Image fields.
+ */
+static ASS_Image *my_draw_bitmap(unsigned char *bitmap, int bitmap_w,
+                                 int bitmap_h, int stride, int dst_x,
+                                 int dst_y, uint32_t color)
+{
+    ASS_Image *img = malloc(sizeof(ASS_Image));
 
-// frame-global data
-typedef struct frame_context_s {
-	ass_renderer_t* ass_priv;
-	int width, height; // screen dimensions
-	int orig_height; // frame height ( = screen height - margins )
-	int orig_width; // frame width ( = screen width - margins )
-	ass_track_t* track;
-	long long time; // frame's timestamp, ms
-	double font_scale;
-	double font_scale_x; // x scale applied to all glyphs to preserve text aspect ratio
-	double border_scale;
-} frame_context_t;
+    if (img) {
+        img->w = bitmap_w;
+        img->h = bitmap_h;
+        img->stride = stride;
+        img->bitmap = bitmap;
+        img->color = color;
+        img->dst_x = dst_x;
+        img->dst_y = dst_y;
+    }
 
-static ass_renderer_t* ass_renderer;
-static ass_settings_t* global_settings;
-static text_info_t text_info;
-static render_context_t render_context;
-static frame_context_t frame_context;
+    return img;
+}
 
-struct render_priv_s {
-	int top, height;
-	int render_id;
-};
+/**
+ * \brief Mapping between script and screen coordinates
+ */
+static double x2scr(ASS_Renderer *render_priv, double x)
+{
+    return x * render_priv->orig_width_nocrop / render_priv->font_scale_x /
+        render_priv->track->PlayResX +
+        FFMAX(render_priv->settings.left_margin, 0);
+}
+static double x2scr_pos(ASS_Renderer *render_priv, double x)
+{
+    return x * render_priv->orig_width / render_priv->font_scale_x / render_priv->track->PlayResX +
+        render_priv->settings.left_margin;
+}
+static double x2scr_scaled(ASS_Renderer *render_priv, double x)
+{
+    return x * render_priv->orig_width_nocrop /
+        render_priv->track->PlayResX +
+        FFMAX(render_priv->settings.left_margin, 0);
+}
+static double x2scr_pos_scaled(ASS_Renderer *render_priv, double x)
+{
+    return x * render_priv->orig_width / render_priv->track->PlayResX +
+        render_priv->settings.left_margin;
+}
+/**
+ * \brief Mapping between script and screen coordinates
+ */
+static double y2scr(ASS_Renderer *render_priv, double y)
+{
+    return y * render_priv->orig_height_nocrop /
+        render_priv->track->PlayResY +
+        FFMAX(render_priv->settings.top_margin, 0);
+}
+static double y2scr_pos(ASS_Renderer *render_priv, double y)
+{
+    return y * render_priv->orig_height / render_priv->track->PlayResY +
+        render_priv->settings.top_margin;
+}
 
-static void ass_lazy_track_init(void)
+// the same for toptitles
+static double y2scr_top(ASS_Renderer *render_priv, double y)
 {
-	ass_track_t* track = frame_context.track;
-	if (track->PlayResX && track->PlayResY)
-		return;
-	if (!track->PlayResX && !track->PlayResY) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NeitherPlayResXNorPlayResYDefined);
-		track->PlayResX = 384;
-		track->PlayResY = 288;
-	} else {
-		double orig_aspect = (global_settings->aspect * frame_context.height * frame_context.orig_width) /
-			frame_context.orig_height / frame_context.width;
-		if (!track->PlayResY) {
-			track->PlayResY = track->PlayResX / orig_aspect + .5;
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_PlayResYUndefinedSettingY, track->PlayResY);
-		} else if (!track->PlayResX) {
-			track->PlayResX = track->PlayResY * orig_aspect + .5;
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_PlayResXUndefinedSettingX, track->PlayResX);
-		}
-	}
+    if (render_priv->settings.use_margins)
+        return y * render_priv->orig_height_nocrop /
+            render_priv->track->PlayResY;
+    else
+        return y * render_priv->orig_height_nocrop /
+            render_priv->track->PlayResY +
+            FFMAX(render_priv->settings.top_margin, 0);
 }
+// the same for subtitles
+static double y2scr_sub(ASS_Renderer *render_priv, double y)
+{
+    if (render_priv->settings.use_margins)
+        return y * render_priv->orig_height_nocrop /
+            render_priv->track->PlayResY +
+            FFMAX(render_priv->settings.top_margin, 0)
+            + FFMAX(render_priv->settings.bottom_margin, 0);
+    else
+        return y * render_priv->orig_height_nocrop /
+            render_priv->track->PlayResY +
+            FFMAX(render_priv->settings.top_margin, 0);
+}
 
-ass_renderer_t* ass_renderer_init(ass_library_t* library)
+/*
+ * \brief Convert bitmap glyphs into ASS_Image list with inverse clipping
+ *
+ * Inverse clipping with the following strategy:
+ * - find rectangle from (x0, y0) to (cx0, y1)
+ * - find rectangle from (cx0, y0) to (cx1, cy0)
+ * - find rectangle from (cx0, cy1) to (cx1, y1)
+ * - find rectangle from (cx1, y0) to (x1, y1)
+ * These rectangles can be invalid and in this case are discarded.
+ * Afterwards, they are clipped against the screen coordinates.
+ * In an additional pass, the rectangles need to be split up left/right for
+ * karaoke effects.  This can result in a lot of bitmaps (6 to be exact).
+ */
+static ASS_Image **render_glyph_i(ASS_Renderer *render_priv,
+                                  Bitmap *bm, int dst_x, int dst_y,
+                                  uint32_t color, uint32_t color2, int brk,
+                                  ASS_Image **tail)
 {
-	int error;
-	FT_Library ft;
-	ass_renderer_t* priv = 0;
-	
-	memset(&render_context, 0, sizeof(render_context));
-	memset(&frame_context, 0, sizeof(frame_context));
-	memset(&text_info, 0, sizeof(text_info));
+    int i, j, x0, y0, x1, y1, cx0, cy0, cx1, cy1, sx, sy, zx, zy;
+    Rect r[4];
+    ASS_Image *img;
 
-	error = FT_Init_FreeType( &ft );
-	if ( error ) { 
-		mp_msg(MSGT_ASS, MSGL_FATAL, MSGTR_LIBASS_FT_Init_FreeTypeFailed);
-		goto ass_init_exit;
-	}
+    dst_x += bm->left;
+    dst_y += bm->top;
 
-	priv = calloc(1, sizeof(ass_renderer_t));
-	if (!priv) {
-		FT_Done_FreeType(ft);
-		goto ass_init_exit;
-	}
+    // we still need to clip against screen boundaries
+    zx = x2scr_pos_scaled(render_priv, 0);
+    zy = y2scr_pos(render_priv, 0);
+    sx = x2scr_pos_scaled(render_priv, render_priv->track->PlayResX);
+    sy = y2scr_pos(render_priv, render_priv->track->PlayResY);
 
-	priv->synth_priv = ass_synth_init();
+    x0 = 0;
+    y0 = 0;
+    x1 = bm->w;
+    y1 = bm->h;
+    cx0 = render_priv->state.clip_x0 - dst_x;
+    cy0 = render_priv->state.clip_y0 - dst_y;
+    cx1 = render_priv->state.clip_x1 - dst_x;
+    cy1 = render_priv->state.clip_y1 - dst_y;
 
-	priv->library = library;
-	priv->ftlibrary = ft;
-	// images_root and related stuff is zero-filled in calloc
-	
-	ass_font_cache_init();
-	ass_bitmap_cache_init();
-	ass_glyph_cache_init();
+    // calculate rectangles and discard invalid ones while we're at it.
+    i = 0;
+    r[i].x0 = x0;
+    r[i].y0 = y0;
+    r[i].x1 = (cx0 > x1) ? x1 : cx0;
+    r[i].y1 = y1;
+    if (r[i].x1 > r[i].x0 && r[i].y1 > r[i].y0) i++;
+    r[i].x0 = (cx0 < 0) ? x0 : cx0;
+    r[i].y0 = y0;
+    r[i].x1 = (cx1 > x1) ? x1 : cx1;
+    r[i].y1 = (cy0 > y1) ? y1 : cy0;
+    if (r[i].x1 > r[i].x0 && r[i].y1 > r[i].y0) i++;
+    r[i].x0 = (cx0 < 0) ? x0 : cx0;
+    r[i].y0 = (cy1 < 0) ? y0 : cy1;
+    r[i].x1 = (cx1 > x1) ? x1 : cx1;
+    r[i].y1 = y1;
+    if (r[i].x1 > r[i].x0 && r[i].y1 > r[i].y0) i++;
+    r[i].x0 = (cx1 < 0) ? x0 : cx1;
+    r[i].y0 = y0;
+    r[i].x1 = x1;
+    r[i].y1 = y1;
+    if (r[i].x1 > r[i].x0 && r[i].y1 > r[i].y0) i++;
 
-	text_info.glyphs = calloc(MAX_GLYPHS, sizeof(glyph_info_t));
-	
-ass_init_exit:
-	if (priv) mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_Init);
-	else mp_msg(MSGT_ASS, MSGL_ERR, MSGTR_LIBASS_InitFailed);
+    // clip each rectangle to screen coordinates
+    for (j = 0; j < i; j++) {
+        r[j].x0 = (r[j].x0 + dst_x < zx) ? zx - dst_x : r[j].x0;
+        r[j].y0 = (r[j].y0 + dst_y < zy) ? zy - dst_y : r[j].y0;
+        r[j].x1 = (r[j].x1 + dst_x > sx) ? sx - dst_x : r[j].x1;
+        r[j].y1 = (r[j].y1 + dst_y > sy) ? sy - dst_y : r[j].y1;
+    }
 
-	return priv;
-}
+    // draw the rectangles
+    for (j = 0; j < i; j++) {
+        int lbrk = brk;
+        // kick out rectangles that are invalid now
+        if (r[j].x1 <= r[j].x0 || r[j].y1 <= r[j].y0)
+            continue;
+        // split up into left and right for karaoke, if needed
+        if (lbrk > r[j].x0) {
+            if (lbrk > r[j].x1) lbrk = r[j].x1;
+            img = my_draw_bitmap(bm->buffer + r[j].y0 * bm->w + r[j].x0,
+                lbrk - r[j].x0, r[j].y1 - r[j].y0,
+                bm->w, dst_x + r[j].x0, dst_y + r[j].y0, color);
+            if (!img) break;
+            *tail = img;
+            tail = &img->next;
+        }
+        if (lbrk < r[j].x1) {
+            if (lbrk < r[j].x0) lbrk = r[j].x0;
+            img = my_draw_bitmap(bm->buffer + r[j].y0 * bm->w + lbrk,
+                r[j].x1 - lbrk, r[j].y1 - r[j].y0,
+                bm->w, dst_x + lbrk, dst_y + r[j].y0, color2);
+            if (!img) break;
+            *tail = img;
+            tail = &img->next;
+        }
+    }
 
-void ass_renderer_done(ass_renderer_t* priv)
-{
-	ass_font_cache_done();
-	ass_bitmap_cache_done();
-	ass_glyph_cache_done();
-	if (render_context.stroker) {
-		FT_Stroker_Done(render_context.stroker);
-		render_context.stroker = 0;
-	}
-	if (priv && priv->ftlibrary) FT_Done_FreeType(priv->ftlibrary);
-	if (priv && priv->fontconfig_priv) fontconfig_done(priv->fontconfig_priv);
-	if (priv && priv->synth_priv) ass_synth_done(priv->synth_priv);
-	if (priv && priv->eimg) free(priv->eimg);
-	if (priv) free(priv);
-	if (text_info.glyphs) free(text_info.glyphs);
+    return tail;
 }
 
 /**
- * \brief Create a new ass_image_t
- * Parameters are the same as ass_image_t fields.
- */
-static ass_image_t* my_draw_bitmap(unsigned char* bitmap, int bitmap_w, int bitmap_h, int stride, int dst_x, int dst_y, uint32_t color)
-{
-	ass_image_t* img = calloc(1, sizeof(ass_image_t));
-	
-	img->w = bitmap_w;
-	img->h = bitmap_h;
-	img->stride = stride;
-	img->bitmap = bitmap;
-	img->color = color;
-	img->dst_x = dst_x;
-	img->dst_y = dst_y;
-
-	return img;
-}
-
-/**
- * \brief convert bitmap glyph into ass_image_t struct(s)
+ * \brief convert bitmap glyph into ASS_Image struct(s)
  * \param bit freetype bitmap glyph, FT_PIXEL_MODE_GRAY
  * \param dst_x bitmap x coordinate in video frame
  * \param dst_y bitmap y coordinate in video frame
@@ -313,954 +363,865 @@
  * \return pointer to the new list tail
  * Performs clipping. Uses my_draw_bitmap for actual bitmap convertion.
  */
-static ass_image_t** render_glyph(bitmap_t* bm, int dst_x, int dst_y, uint32_t color, uint32_t color2, int brk, ass_image_t** tail)
+static ASS_Image **
+render_glyph(ASS_Renderer *render_priv, Bitmap *bm, int dst_x, int dst_y,
+             uint32_t color, uint32_t color2, int brk, ASS_Image **tail)
 {
-	// brk is relative to dst_x
-	// color = color left of brk
-	// color2 = color right of brk
-	int b_x0, b_y0, b_x1, b_y1; // visible part of the bitmap
-	int clip_x0, clip_y0, clip_x1, clip_y1;
-	int tmp;
-	ass_image_t* img;
+    // Inverse clipping in use?
+    if (render_priv->state.clip_mode)
+        return render_glyph_i(render_priv, bm, dst_x, dst_y, color, color2,
+                              brk, tail);
 
-	dst_x += bm->left;
-	dst_y += bm->top;
-	brk -= bm->left;
-	
-	// clipping
-	clip_x0 = render_context.clip_x0;
-	clip_y0 = render_context.clip_y0;
-	clip_x1 = render_context.clip_x1;
-	clip_y1 = render_context.clip_y1;
-	b_x0 = 0;
-	b_y0 = 0;
-	b_x1 = bm->w;
-	b_y1 = bm->h;
-	
-	tmp = dst_x - clip_x0;
-	if (tmp < 0) {
-		mp_msg(MSGT_ASS, MSGL_DBG2, "clip left\n");
-		b_x0 = - tmp;
-	}
-	tmp = dst_y - clip_y0;
-	if (tmp < 0) {
-		mp_msg(MSGT_ASS, MSGL_DBG2, "clip top\n");
-		b_y0 = - tmp;
-	}
-	tmp = clip_x1 - dst_x - bm->w;
-	if (tmp < 0) {
-		mp_msg(MSGT_ASS, MSGL_DBG2, "clip right\n");
-		b_x1 = bm->w + tmp;
-	}
-	tmp = clip_y1 - dst_y - bm->h;
-	if (tmp < 0) {
-		mp_msg(MSGT_ASS, MSGL_DBG2, "clip bottom\n");
-		b_y1 = bm->h + tmp;
-	}
-	
-	if ((b_y0 >= b_y1) || (b_x0 >= b_x1))
-		return tail;
+    // brk is relative to dst_x
+    // color = color left of brk
+    // color2 = color right of brk
+    int b_x0, b_y0, b_x1, b_y1; // visible part of the bitmap
+    int clip_x0, clip_y0, clip_x1, clip_y1;
+    int tmp;
+    ASS_Image *img;
 
-	if (brk > b_x0) { // draw left part
-		if (brk > b_x1) brk = b_x1;
-		img = my_draw_bitmap(bm->buffer + bm->w * b_y0 + b_x0, 
-			brk - b_x0, b_y1 - b_y0, bm->w,
-			dst_x + b_x0, dst_y + b_y0, color);
-		*tail = img;
-		tail = &img->next;
-	}
-	if (brk < b_x1) { // draw right part
-		if (brk < b_x0) brk = b_x0;
-		img = my_draw_bitmap(bm->buffer + bm->w * b_y0 + brk, 
-			b_x1 - brk, b_y1 - b_y0, bm->w,
-			dst_x + brk, dst_y + b_y0, color2);
-		*tail = img;
-		tail = &img->next;
-	}
-	return tail;
+    dst_x += bm->left;
+    dst_y += bm->top;
+    brk -= bm->left;
+
+    // clipping
+    clip_x0 = FFMINMAX(render_priv->state.clip_x0, 0, render_priv->width);
+    clip_y0 = FFMINMAX(render_priv->state.clip_y0, 0, render_priv->height);
+    clip_x1 = FFMINMAX(render_priv->state.clip_x1, 0, render_priv->width);
+    clip_y1 = FFMINMAX(render_priv->state.clip_y1, 0, render_priv->height);
+    b_x0 = 0;
+    b_y0 = 0;
+    b_x1 = bm->w;
+    b_y1 = bm->h;
+
+    tmp = dst_x - clip_x0;
+    if (tmp < 0) {
+        ass_msg(render_priv->library, MSGL_DBG2, "clip left");
+        b_x0 = -tmp;
+    }
+    tmp = dst_y - clip_y0;
+    if (tmp < 0) {
+        ass_msg(render_priv->library, MSGL_DBG2, "clip top");
+        b_y0 = -tmp;
+    }
+    tmp = clip_x1 - dst_x - bm->w;
+    if (tmp < 0) {
+        ass_msg(render_priv->library, MSGL_DBG2, "clip right");
+        b_x1 = bm->w + tmp;
+    }
+    tmp = clip_y1 - dst_y - bm->h;
+    if (tmp < 0) {
+        ass_msg(render_priv->library, MSGL_DBG2, "clip bottom");
+        b_y1 = bm->h + tmp;
+    }
+
+    if ((b_y0 >= b_y1) || (b_x0 >= b_x1))
+        return tail;
+
+    if (brk > b_x0) {           // draw left part
+        if (brk > b_x1)
+            brk = b_x1;
+        img = my_draw_bitmap(bm->buffer + bm->w * b_y0 + b_x0,
+                             brk - b_x0, b_y1 - b_y0, bm->w,
+                             dst_x + b_x0, dst_y + b_y0, color);
+        if (!img) return tail;
+        *tail = img;
+        tail = &img->next;
+    }
+    if (brk < b_x1) {           // draw right part
+        if (brk < b_x0)
+            brk = b_x0;
+        img = my_draw_bitmap(bm->buffer + bm->w * b_y0 + brk,
+                             b_x1 - brk, b_y1 - b_y0, bm->w,
+                             dst_x + brk, dst_y + b_y0, color2);
+        if (!img) return tail;
+        *tail = img;
+        tail = &img->next;
+    }
+    return tail;
 }
 
 /**
- * \brief Convert text_info_t struct to ass_image_t list
- * Splits glyphs in halves when needed (for \kf karaoke).
+ * \brief Replace the bitmap buffer in ASS_Image with a copy
+ * \param img ASS_Image to operate on
+ * \return pointer to old bitmap buffer
  */
-static ass_image_t* render_text(text_info_t* text_info, int dst_x, int dst_y)
+static unsigned char *clone_bitmap_buffer(ASS_Image *img)
 {
-	int pen_x, pen_y;
-	int i;
-	bitmap_t* bm;
-	ass_image_t* head;
-	ass_image_t** tail = &head;
+    unsigned char *old_bitmap = img->bitmap;
+    int size = img->stride * (img->h - 1) + img->w;
+    img->bitmap = malloc(size);
+    memcpy(img->bitmap, old_bitmap, size);
+    return old_bitmap;
+}
 
-	for (i = 0; i < text_info->length; ++i) {
-		glyph_info_t* info = text_info->glyphs + i;
-		if ((info->symbol == 0) || (info->symbol == '\n') || !info->bm_s || (info->shadow == 0))
-			continue;
+/**
+ * \brief Calculate overlapping area of two consecutive bitmaps and in case they
+ * overlap, blend them together
+ * Mainly useful for translucent glyphs and especially borders, to avoid the
+ * luminance adding up where they overlap (which looks ugly)
+ */
+static void
+render_overlap(ASS_Renderer *render_priv, ASS_Image **last_tail,
+               ASS_Image **tail)
+{
+    int left, top, bottom, right;
+    int old_left, old_top, w, h, cur_left, cur_top;
+    int x, y, opos, cpos;
+    char m;
+    CompositeHashKey hk;
+    CompositeHashValue *hv;
+    CompositeHashValue chv;
+    int ax = (*last_tail)->dst_x;
+    int ay = (*last_tail)->dst_y;
+    int aw = (*last_tail)->w;
+    int as = (*last_tail)->stride;
+    int ah = (*last_tail)->h;
+    int bx = (*tail)->dst_x;
+    int by = (*tail)->dst_y;
+    int bw = (*tail)->w;
+    int bs = (*tail)->stride;
+    int bh = (*tail)->h;
+    unsigned char *a;
+    unsigned char *b;
 
-		pen_x = dst_x + info->pos.x + info->shadow;
-		pen_y = dst_y + info->pos.y + info->shadow;
-		bm = info->bm_s;
+    if ((*last_tail)->bitmap == (*tail)->bitmap)
+        return;
 
-		tail = render_glyph(bm, pen_x, pen_y, info->c[3], 0, 1000000, tail);
-	}
+    if ((*last_tail)->color != (*tail)->color)
+        return;
 
-	for (i = 0; i < text_info->length; ++i) {
-		glyph_info_t* info = text_info->glyphs + i;
-		if ((info->symbol == 0) || (info->symbol == '\n') || !info->bm_o)
-			continue;
+    // Calculate overlap coordinates
+    left = (ax > bx) ? ax : bx;
+    top = (ay > by) ? ay : by;
+    right = ((ax + aw) < (bx + bw)) ? (ax + aw) : (bx + bw);
+    bottom = ((ay + ah) < (by + bh)) ? (ay + ah) : (by + bh);
+    if ((right <= left) || (bottom <= top))
+        return;
+    old_left = left - ax;
+    old_top = top - ay;
+    w = right - left;
+    h = bottom - top;
+    cur_left = left - bx;
+    cur_top = top - by;
 
-		pen_x = dst_x + info->pos.x;
-		pen_y = dst_y + info->pos.y;
-		bm = info->bm_o;
-		
-		if ((info->effect_type == EF_KARAOKE_KO) && (info->effect_timing <= info->bbox.xMax)) {
-			// do nothing
-		} else
-			tail = render_glyph(bm, pen_x, pen_y, info->c[2], 0, 1000000, tail);
-	}
-	for (i = 0; i < text_info->length; ++i) {
-		glyph_info_t* info = text_info->glyphs + i;
-		if ((info->symbol == 0) || (info->symbol == '\n') || !info->bm)
-			continue;
+    // Query cache
+    hk.a = (*last_tail)->bitmap;
+    hk.b = (*tail)->bitmap;
+    hk.aw = aw;
+    hk.ah = ah;
+    hk.bw = bw;
+    hk.bh = bh;
+    hk.ax = ax;
+    hk.ay = ay;
+    hk.bx = bx;
+    hk.by = by;
+    hk.as = as;
+    hk.bs = bs;
+    hv = cache_find_composite(render_priv->cache.composite_cache, &hk);
+    if (hv) {
+        (*last_tail)->bitmap = hv->a;
+        (*tail)->bitmap = hv->b;
+        return;
+    }
+    // Allocate new bitmaps and copy over data
+    a = clone_bitmap_buffer(*last_tail);
+    b = clone_bitmap_buffer(*tail);
 
-		pen_x = dst_x + info->pos.x;
-		pen_y = dst_y + info->pos.y;
-		bm = info->bm;
+    // Blend overlapping area
+    for (y = 0; y < h; y++)
+        for (x = 0; x < w; x++) {
+            opos = (old_top + y) * (as) + (old_left + x);
+            cpos = (cur_top + y) * (bs) + (cur_left + x);
+            m = FFMIN(a[opos] + b[cpos], 0xff);
+            (*last_tail)->bitmap[opos] = 0;
+            (*tail)->bitmap[cpos] = m;
+        }
 
-		if ((info->effect_type == EF_KARAOKE) || (info->effect_type == EF_KARAOKE_KO)) {
-			if (info->effect_timing > info->bbox.xMax)
-				tail = render_glyph(bm, pen_x, pen_y, info->c[0], 0, 1000000, tail);
-			else
-				tail = render_glyph(bm, pen_x, pen_y, info->c[1], 0, 1000000, tail);
-		} else if (info->effect_type == EF_KARAOKE_KF) {
-			tail = render_glyph(bm, pen_x, pen_y, info->c[0], info->c[1], info->effect_timing, tail);
-		} else
-			tail = render_glyph(bm, pen_x, pen_y, info->c[0], 0, 1000000, tail);
-	}
+    // Insert bitmaps into the cache
+    chv.a = (*last_tail)->bitmap;
+    chv.b = (*tail)->bitmap;
+    cache_add_composite(render_priv->cache.composite_cache, &hk, &chv);
+}
 
-	*tail = 0;
-	return head;
+static void free_list_add(ASS_Renderer *render_priv, void *object)
+{
+    if (!render_priv->free_head) {
+        render_priv->free_head = calloc(1, sizeof(FreeList));
+        render_priv->free_head->object = object;
+        render_priv->free_tail = render_priv->free_head;
+    } else {
+        FreeList *l = calloc(1, sizeof(FreeList));
+        l->object = object;
+        render_priv->free_tail->next = l;
+        render_priv->free_tail = render_priv->free_tail->next;
+    }
 }
 
 /**
- * \brief Mapping between script and screen coordinates
+ * Iterate through a list of bitmaps and blend with clip vector, if
+ * applicable. The blended bitmaps are added to a free list which is freed
+ * at the start of a new frame.
  */
-static int x2scr(int x) {
-	return x*frame_context.orig_width / frame_context.track->PlayResX + global_settings->left_margin;
-}
-/**
- * \brief Mapping between script and screen coordinates
- */
-static int y2scr(int y) {
-	return y * frame_context.orig_height / frame_context.track->PlayResY + global_settings->top_margin;
-}
-// the same for toptitles
-static int y2scr_top(int y) {
-	if (global_settings->use_margins)
-		return y * frame_context.orig_height / frame_context.track->PlayResY;
-	else
-		return y * frame_context.orig_height / frame_context.track->PlayResY + global_settings->top_margin;
-}
-// the same for subtitles
-static int y2scr_sub(int y) {
-	if (global_settings->use_margins)
-		return y * frame_context.orig_height / frame_context.track->PlayResY +
-		       global_settings->top_margin + global_settings->bottom_margin;
-	else
-		return y * frame_context.orig_height / frame_context.track->PlayResY + global_settings->top_margin;
-}
+static void blend_vector_clip(ASS_Renderer *render_priv,
+                              ASS_Image *head)
+{
+    FT_Glyph glyph;
+    FT_BitmapGlyph clip_bm;
+    ASS_Image *cur;
+    ASS_Drawing *drawing = render_priv->state.clip_drawing;
+    GlyphHashKey key;
+    GlyphHashValue *val;
+    int error;
 
-static void compute_string_bbox( text_info_t* info, FT_BBox *abbox ) {
-	FT_BBox bbox;
-	int i;
-	
-	if (text_info.length > 0) {
-		bbox.xMin = 32000;
-		bbox.xMax = -32000;
-		bbox.yMin = - d6_to_int(text_info.lines[0].asc) + text_info.glyphs[0].pos.y;
-		bbox.yMax = d6_to_int(text_info.height - text_info.lines[0].asc) + text_info.glyphs[0].pos.y;
+    if (!drawing)
+        return;
 
-		for (i = 0; i < text_info.length; ++i) {
-			int s = text_info.glyphs[i].pos.x;
-			int e = s + d6_to_int(text_info.glyphs[i].advance.x);
-			bbox.xMin = FFMIN(bbox.xMin, s);
-			bbox.xMax = FFMAX(bbox.xMax, e);
-		}
-	} else
-		bbox.xMin = bbox.xMax = bbox.yMin = bbox.yMax = 0;
+    // Try to get mask from cache
+    ass_drawing_hash(drawing);
+    memset(&key, 0, sizeof(key));
+    key.ch = -2;
+    key.drawing_hash = drawing->hash;
+    val = cache_find_glyph(render_priv->cache.glyph_cache, &key);
 
-	/* return string bbox */
-	*abbox = bbox;
-}
+    if (val) {
+        clip_bm = (FT_BitmapGlyph) val->glyph;
+    } else {
+        GlyphHashValue v;
 
+        // Not found in cache, parse and rasterize it
+        glyph = (FT_Glyph) *ass_drawing_parse(drawing, 1);
+        if (!glyph) {
+            ass_msg(render_priv->library, MSGL_WARN,
+                    "Clip vector parsing failed. Skipping.");
+            goto blend_vector_error;
+        }
 
-/**
- * \brief Check if starting part of (*p) matches sample. If true, shift p to the first symbol after the matching part.
- */
-static inline int mystrcmp(char** p, const char* sample) {
-	int len = strlen(sample);
-	if (strncmp(*p, sample, len) == 0) {
-		(*p) += len;
-		return 1;
-	} else
-		return 0;
-}
+        // We need to translate the clip according to screen borders
+        if (render_priv->settings.left_margin != 0 ||
+            render_priv->settings.top_margin != 0) {
+            FT_Vector trans = {
+                .x = int_to_d6(render_priv->settings.left_margin),
+                .y = -int_to_d6(render_priv->settings.top_margin),
+            };
+            FT_Outline_Translate(&drawing->glyph->outline,
+                                 trans.x, trans.y);
+        }
 
-static void change_font_size(double sz)
-{
-	double size = sz * frame_context.font_scale;
+        // Check glyph bounding box size
+        if (check_glyph_area(render_priv->library, glyph)) {
+            FT_Done_Glyph(glyph);
+            glyph = 0;
+            goto blend_vector_error;
+        }
 
-	if (size < 1)
-		size = 1;
-	else if (size > frame_context.height * 2)
-		size = frame_context.height * 2;
+        ass_msg(render_priv->library, MSGL_DBG2,
+                "Parsed vector clip: scales (%f, %f) string [%s]\n",
+                drawing->scale_x, drawing->scale_y, drawing->text);
 
-	ass_font_set_size(render_context.font, size);
+        error = FT_Glyph_To_Bitmap(&glyph, FT_RENDER_MODE_NORMAL, 0, 1);
+        if (error) {
+            ass_msg(render_priv->library, MSGL_WARN,
+                "Clip vector rasterization failed: %d. Skipping.", error);
+            FT_Done_Glyph(glyph);
+            glyph = 0;
+        }
 
-	render_context.font_size = sz;
-}
+blend_vector_error:
+        clip_bm = (FT_BitmapGlyph) glyph;
 
-/**
- * \brief Change current font, using setting from render_context.
- */
-static void update_font(void)
-{
-	unsigned val;
-	ass_renderer_t* priv = frame_context.ass_priv;
-	ass_font_desc_t desc;
-	desc.family = strdup(render_context.family);
+        // Add to cache
+        memset(&v, 0, sizeof(v));
+        v.glyph = glyph;
+        cache_add_glyph(render_priv->cache.glyph_cache, &key, &v);
+    }
 
-	val = render_context.bold;
-	// 0 = normal, 1 = bold, >1 = exact weight
-	if (val == 0) val = 80; // normal
-	else if (val == 1) val = 200; // bold
-	desc.bold = val;
+    if (!clip_bm) goto blend_vector_exit;
 
-	val = render_context.italic;
-	if (val == 0) val = 0; // normal
-	else if (val == 1) val = 110; //italic
-	desc.italic = val;
+    // Iterate through bitmaps and blend/clip them
+    for (cur = head; cur; cur = cur->next) {
+        int left, top, right, bottom, apos, bpos, y, x, w, h;
+        int ax, ay, aw, ah, as;
+        int bx, by, bw, bh, bs;
+        int aleft, atop, bleft, btop;
+        unsigned char *abuffer, *bbuffer, *nbuffer;
 
-	render_context.font = ass_font_new(priv->library, priv->ftlibrary, priv->fontconfig_priv, &desc);
-	free(desc.family);
-	
-	if (render_context.font)
-		change_font_size(render_context.font_size);
+        abuffer = cur->bitmap;
+        bbuffer = clip_bm->bitmap.buffer;
+        ax = cur->dst_x;
+        ay = cur->dst_y;
+        aw = cur->w;
+        ah = cur->h;
+        as = cur->stride;
+        bx = clip_bm->left;
+        by = -clip_bm->top;
+        bw = clip_bm->bitmap.width;
+        bh = clip_bm->bitmap.rows;
+        bs = clip_bm->bitmap.pitch;
+
+        // Calculate overlap coordinates
+        left = (ax > bx) ? ax : bx;
+        top = (ay > by) ? ay : by;
+        right = ((ax + aw) < (bx + bw)) ? (ax + aw) : (bx + bw);
+        bottom = ((ay + ah) < (by + bh)) ? (ay + ah) : (by + bh);
+        aleft = left - ax;
+        atop = top - ay;
+        w = right - left;
+        h = bottom - top;
+        bleft = left - bx;
+        btop = top - by;
+
+        if (render_priv->state.clip_drawing_mode) {
+            // Inverse clip
+            if (ax + aw < bx || ay + ah < by || ax > bx + bw ||
+                ay > by + bh) {
+                continue;
+            }
+
+            // Allocate new buffer and add to free list
+            nbuffer = malloc(as * ah);
+            if (!nbuffer) goto blend_vector_exit;
+            free_list_add(render_priv, nbuffer);
+
+            // Blend together
+            memcpy(nbuffer, abuffer, as * (ah - 1) + aw);
+            for (y = 0; y < h; y++)
+                for (x = 0; x < w; x++) {
+                    apos = (atop + y) * as + aleft + x;
+                    bpos = (btop + y) * bs + bleft + x;
+                    nbuffer[apos] = FFMAX(0, abuffer[apos] - bbuffer[bpos]);
+                }
+        } else {
+            // Regular clip
+            if (ax + aw < bx || ay + ah < by || ax > bx + bw ||
+                ay > by + bh) {
+                cur->w = cur->h = 0;
+                continue;
+            }
+
+            // Allocate new buffer and add to free list
+            nbuffer = calloc(as, ah);
+            if (!nbuffer) goto blend_vector_exit;
+            free_list_add(render_priv, nbuffer);
+
+            // Blend together
+            for (y = 0; y < h; y++)
+                for (x = 0; x < w; x++) {
+                    apos = (atop + y) * as + aleft + x;
+                    bpos = (btop + y) * bs + bleft + x;
+                    nbuffer[apos] = (abuffer[apos] * bbuffer[bpos] + 255) >> 8;
+                }
+        }
+        cur->bitmap = nbuffer;
+    }
+
+blend_vector_exit:
+    ass_drawing_free(render_priv->state.clip_drawing);
+    render_priv->state.clip_drawing = 0;
 }
 
 /**
- * \brief Change border width
- * negative value resets border to style value
+ * \brief Convert TextInfo struct to ASS_Image list
+ * Splits glyphs in halves when needed (for \kf karaoke).
  */
-static void change_border(double border)
+static ASS_Image *render_text(ASS_Renderer *render_priv, int dst_x, int dst_y)
 {
-	int b;
-	if (!render_context.font) return;
+    int pen_x, pen_y;
+    int i;
+    Bitmap *bm;
+    ASS_Image *head;
+    ASS_Image **tail = &head;
+    ASS_Image **last_tail = 0;
+    ASS_Image **here_tail = 0;
+    TextInfo *text_info = &render_priv->text_info;
 
-	if (border < 0) {
-		if (render_context.style->BorderStyle == 1) {
-			if (render_context.style->Outline == 0 && render_context.style->Shadow > 0)
-				border = 1.;
-			else
-				border = render_context.style->Outline;
-		} else
-			border = 1.;
-	}
-	render_context.border = border;
+    for (i = 0; i < text_info->length; ++i) {
+        GlyphInfo *info = text_info->glyphs + i;
+        if ((info->symbol == 0) || (info->symbol == '\n') || !info->bm_s
+            || (info->shadow_x == 0 && info->shadow_y == 0) || info->skip)
+            continue;
 
-	b = 64 * border * frame_context.border_scale;
-	if (b > 0) {
-		if (!render_context.stroker) {
-			int error;
-#if (FREETYPE_MAJOR > 2) || ((FREETYPE_MAJOR == 2) && (FREETYPE_MINOR > 1))
-			error = FT_Stroker_New( ass_renderer->ftlibrary, &render_context.stroker );
-#else // < 2.2
-			error = FT_Stroker_New( render_context.font->faces[0]->memory, &render_context.stroker );
-#endif
-			if (error) {
-				mp_msg(MSGT_ASS, MSGL_V, "failed to get stroker\n");
-				render_context.stroker = 0;
-			}
-		}
-		if (render_context.stroker)
-			FT_Stroker_Set( render_context.stroker, b,
-					FT_STROKER_LINECAP_ROUND,
-					FT_STROKER_LINEJOIN_ROUND,
-					0 );
-	} else {
-		FT_Stroker_Done(render_context.stroker);
-		render_context.stroker = 0;
-	}
-}
+        pen_x =
+            dst_x + (info->pos.x >> 6) +
+            (int) (info->shadow_x * render_priv->border_scale);
+        pen_y =
+            dst_y + (info->pos.y >> 6) +
+            (int) (info->shadow_y * render_priv->border_scale);
+        bm = info->bm_s;
 
-#define _r(c)  ((c)>>24)
-#define _g(c)  (((c)>>16)&0xFF)
-#define _b(c)  (((c)>>8)&0xFF)
-#define _a(c)  ((c)&0xFF)
+        here_tail = tail;
+        tail =
+            render_glyph(render_priv, bm, pen_x, pen_y, info->c[3], 0,
+                         1000000, tail);
+        if (last_tail && tail != here_tail && ((info->c[3] & 0xff) > 0))
+            render_overlap(render_priv, last_tail, here_tail);
 
-/**
- * \brief Calculate a weighted average of two colors
- * calculates c1*(1-a) + c2*a, but separately for each component except alpha
- */
-static void change_color(uint32_t* var, uint32_t new, double pwr)
-{
-	(*var)= ((uint32_t)(_r(*var) * (1 - pwr) + _r(new) * pwr) << 24) +
-		((uint32_t)(_g(*var) * (1 - pwr) + _g(new) * pwr) << 16) +
-		((uint32_t)(_b(*var) * (1 - pwr) + _b(new) * pwr) << 8) +
-		_a(*var);
+        last_tail = here_tail;
+    }
+
+    last_tail = 0;
+    for (i = 0; i < text_info->length; ++i) {
+        GlyphInfo *info = text_info->glyphs + i;
+        if ((info->symbol == 0) || (info->symbol == '\n') || !info->bm_o
+            || info->skip)
+            continue;
+
+        pen_x = dst_x + (info->pos.x >> 6);
+        pen_y = dst_y + (info->pos.y >> 6);
+        bm = info->bm_o;
+
+        if ((info->effect_type == EF_KARAOKE_KO)
+            && (info->effect_timing <= (info->bbox.xMax >> 6))) {
+            // do nothing
+        } else {
+            here_tail = tail;
+            tail =
+                render_glyph(render_priv, bm, pen_x, pen_y, info->c[2],
+                             0, 1000000, tail);
+            if (last_tail && tail != here_tail && ((info->c[2] & 0xff) > 0))
+                render_overlap(render_priv, last_tail, here_tail);
+
+            last_tail = here_tail;
+        }
+    }
+
+    for (i = 0; i < text_info->length; ++i) {
+        GlyphInfo *info = text_info->glyphs + i;
+        if ((info->symbol == 0) || (info->symbol == '\n') || !info->bm
+            || info->skip)
+            continue;
+
+        pen_x = dst_x + (info->pos.x >> 6);
+        pen_y = dst_y + (info->pos.y >> 6);
+        bm = info->bm;
+
+        if ((info->effect_type == EF_KARAOKE)
+            || (info->effect_type == EF_KARAOKE_KO)) {
+            if (info->effect_timing > (info->bbox.xMax >> 6))
+                tail =
+                    render_glyph(render_priv, bm, pen_x, pen_y,
+                                 info->c[0], 0, 1000000, tail);
+            else
+                tail =
+                    render_glyph(render_priv, bm, pen_x, pen_y,
+                                 info->c[1], 0, 1000000, tail);
+        } else if (info->effect_type == EF_KARAOKE_KF) {
+            tail =
+                render_glyph(render_priv, bm, pen_x, pen_y, info->c[0],
+                             info->c[1], info->effect_timing, tail);
+        } else
+            tail =
+                render_glyph(render_priv, bm, pen_x, pen_y, info->c[0],
+                             0, 1000000, tail);
+    }
+
+    *tail = 0;
+    blend_vector_clip(render_priv, head);
+
+    return head;
 }
 
-// like change_color, but for alpha component only
-static void change_alpha(uint32_t* var, uint32_t new, double pwr)
+static void compute_string_bbox(TextInfo *info, DBBox *bbox)
 {
-	*var = (_r(*var) << 24) + (_g(*var) << 16) + (_b(*var) << 8) + (_a(*var) * (1 - pwr) + _a(new) * pwr);
-}
+    int i;
 
-/**
- * \brief Multiply two alpha values
- * \param a first value
- * \param b second value
- * \return result of multiplication
- * Parameters and result are limited by 0xFF.
- */
-static uint32_t mult_alpha(uint32_t a, uint32_t b)
-{
-	return 0xFF - (0xFF - a) * (0xFF - b) / 0xFF;
+    if (info->length > 0) {
+        bbox->xMin = 32000;
+        bbox->xMax = -32000;
+        bbox->yMin = -1 * info->lines[0].asc + d6_to_double(info->glyphs[0].pos.y);
+        bbox->yMax = info->height - info->lines[0].asc +
+                     d6_to_double(info->glyphs[0].pos.y);
+
+        for (i = 0; i < info->length; ++i) {
+            if (info->glyphs[i].skip) continue;
+            double s = d6_to_double(info->glyphs[i].pos.x);
+            double e = s + d6_to_double(info->glyphs[i].advance.x);
+            bbox->xMin = FFMIN(bbox->xMin, s);
+            bbox->xMax = FFMAX(bbox->xMax, e);
+        }
+    } else
+        bbox->xMin = bbox->xMax = bbox->yMin = bbox->yMax = 0.;
 }
 
 /**
- * \brief Calculate alpha value by piecewise linear function
- * Used for \fad, \fade implementation.
+ * \brief partially reset render_context to style values
+ * Works like {\r}: resets some style overrides
  */
-static unsigned interpolate_alpha(long long now, 
-		long long t1, long long t2, long long t3, long long t4,
-		unsigned a1, unsigned a2, unsigned a3)
+void reset_render_context(ASS_Renderer *render_priv)
 {
-	unsigned a;
-	double cf;
-	if (now <= t1) {
-		a = a1;
-	} else if (now >= t4) {
-		a = a3;
-	} else if (now < t2) { // and > t1
-		cf = ((double)(now - t1)) / (t2 - t1);
-		a = a1 * (1 - cf) + a2 * cf;
-	} else if (now > t3) {
-		cf = ((double)(now - t3)) / (t4 - t3);
-		a = a2 * (1 - cf) + a3 * cf;
-	} else { // t2 <= now <= t3
-		a = a2;
-	}
+    render_priv->state.c[0] = render_priv->state.style->PrimaryColour;
+    render_priv->state.c[1] = render_priv->state.style->SecondaryColour;
+    render_priv->state.c[2] = render_priv->state.style->OutlineColour;
+    render_priv->state.c[3] = render_priv->state.style->BackColour;
+    render_priv->state.flags =
+        (render_priv->state.style->Underline ? DECO_UNDERLINE : 0) |
+        (render_priv->state.style->StrikeOut ? DECO_STRIKETHROUGH : 0);
+    render_priv->state.font_size = render_priv->state.style->FontSize;
 
-	return a;
+    free(render_priv->state.family);
+    render_priv->state.family = NULL;
+    render_priv->state.family = strdup(render_priv->state.style->FontName);
+    render_priv->state.treat_family_as_pattern =
+        render_priv->state.style->treat_fontname_as_pattern;
+    render_priv->state.bold = render_priv->state.style->Bold;
+    render_priv->state.italic = render_priv->state.style->Italic;
+    update_font(render_priv);
+
+    change_border(render_priv, -1., -1.);
+    render_priv->state.scale_x = render_priv->state.style->ScaleX;
+    render_priv->state.scale_y = render_priv->state.style->ScaleY;
+    render_priv->state.hspacing = render_priv->state.style->Spacing;
+    render_priv->state.be = 0;
+    render_priv->state.blur = 0.0;
+    render_priv->state.shadow_x = render_priv->state.style->Shadow;
+    render_priv->state.shadow_y = render_priv->state.style->Shadow;
+    render_priv->state.frx = render_priv->state.fry = 0.;
+    render_priv->state.frz = M_PI * render_priv->state.style->Angle / 180.;
+    render_priv->state.fax = render_priv->state.fay = 0.;
+    render_priv->state.wrap_style = render_priv->track->WrapStyle;
 }
 
-static void reset_render_context(void);
-
 /**
- * \brief Parse style override tag.
- * \param p string to parse
- * \param pwr multiplier for some tag effects (comes from \t tags)
+ * \brief Start new event. Reset render_priv->state.
  */
-static char* parse_tag(char* p, double pwr) {
-#define skip_all(x) if (*p == (x)) ++p; else { \
-	while ((*p != (x)) && (*p != '}') && (*p != 0)) {++p;} }
-#define skip(x) if (*p == (x)) ++p; else { return p; }
-	
-	skip_all('\\');
-	if ((*p == '}') || (*p == 0))
-		return p;
+static void
+init_render_context(ASS_Renderer *render_priv, ASS_Event *event)
+{
+    render_priv->state.event = event;
+    render_priv->state.style = render_priv->track->styles + event->Style;
 
-	if (mystrcmp(&p, "fsc")) {
-		char tp = *p++;
-		double val;
-		if (tp == 'x') {
-			if (mystrtod(&p, &val)) {
-				val /= 100;
-				render_context.scale_x = render_context.scale_x * ( 1 - pwr) + val * pwr;
-			} else
-				render_context.scale_x = render_context.style->ScaleX;
-		} else if (tp == 'y') {
-			if (mystrtod(&p, &val)) {
-				val /= 100;
-				render_context.scale_y = render_context.scale_y * ( 1 - pwr) + val * pwr;
-			} else
-				render_context.scale_y = render_context.style->ScaleY;
-		}
-	} else if (mystrcmp(&p, "fsp")) {
-		double val;
-		if (mystrtod(&p, &val))
-			render_context.hspacing = render_context.hspacing * ( 1 - pwr ) + val * pwr;
-		else
-			render_context.hspacing = render_context.style->Spacing;
-	} else if (mystrcmp(&p, "fs")) {
-		double val;
-		if (mystrtod(&p, &val))
-			val = render_context.font_size * ( 1 - pwr ) + val * pwr;
-		else
-			val = render_context.style->FontSize;
-		if (render_context.font)
-			change_font_size(val);
-	} else if (mystrcmp(&p, "bord")) {
-		double val;
-		if (mystrtod(&p, &val))
-			val = render_context.border * ( 1 - pwr ) + val * pwr;
-		else
-			val = -1.; // reset to default
-		change_border(val);
-	} else if (mystrcmp(&p, "move")) {
-		int x1, x2, y1, y2;
-		long long t1, t2, delta_t, t;
-		int x, y;
-		double k;
-		skip('(');
-		x1 = strtol(p, &p, 10);
-		skip(',');
-		y1 = strtol(p, &p, 10);
-		skip(',');
-		x2 = strtol(p, &p, 10);
-		skip(',');
-		y2 = strtol(p, &p, 10);
-		if (*p == ',') {
-			skip(',');
-			t1 = strtoll(p, &p, 10);
-			skip(',');
-			t2 = strtoll(p, &p, 10);
-			mp_msg(MSGT_ASS, MSGL_DBG2, "movement6: (%d, %d) -> (%d, %d), (%" PRId64 " .. %" PRId64 ")\n", 
-				x1, y1, x2, y2, (int64_t)t1, (int64_t)t2);
-		} else {
-			t1 = 0;
-			t2 = render_context.event->Duration;
-			mp_msg(MSGT_ASS, MSGL_DBG2, "movement: (%d, %d) -> (%d, %d)\n", x1, y1, x2, y2);
-		}
-		skip(')');
-		delta_t = t2 - t1;
-		t = frame_context.time - render_context.event->Start;
-		if (t < t1)
-			k = 0.;
-		else if (t > t2)
-			k = 1.;
-		else k = ((double)(t - t1)) / delta_t;
-		x = k * (x2 - x1) + x1;
-		y = k * (y2 - y1) + y1;
-		render_context.pos_x = x;
-		render_context.pos_y = y;
-		render_context.detect_collisions = 0;
-		render_context.evt_type = EVENT_POSITIONED;
-	} else if (mystrcmp(&p, "frx")) {
-		double val;
-		if (mystrtod(&p, &val)) {
-			val *= M_PI / 180;
-			render_context.frx = val * pwr + render_context.frx * (1-pwr);
-		} else
-			render_context.frx = 0.;
-	} else if (mystrcmp(&p, "fry")) {
-		double val;
-		if (mystrtod(&p, &val)) {
-			val *= M_PI / 180;
-			render_context.fry = val * pwr + render_context.fry * (1-pwr);
-		} else
-			render_context.fry = 0.;
-	} else if (mystrcmp(&p, "frz") || mystrcmp(&p, "fr")) {
-		double val;
-		if (mystrtod(&p, &val)) {
-			val *= M_PI / 180;
-			render_context.frz = val * pwr + render_context.frz * (1-pwr);
-		} else
-			render_context.frz = M_PI * render_context.style->Angle / 180.;
-	} else if (mystrcmp(&p, "fn")) {
-		char* start = p;
-		char* family;
-		skip_all('\\');
-		if (p > start) {
-			family = malloc(p - start + 1);
-			strncpy(family, start, p - start);
-			family[p - start] = '\0';
-		} else
-			family = strdup(render_context.style->FontName);
-		if (render_context.family)
-			free(render_context.family);
-		render_context.family = family;
-		update_font();
-	} else if (mystrcmp(&p, "alpha")) {
-		uint32_t val;
-		int i;
-		if (strtocolor(&p, &val)) {
-			unsigned char a = val >> 24;
-			for (i = 0; i < 4; ++i)
-				change_alpha(&render_context.c[i], a, pwr);
-		} else {
-			change_alpha(&render_context.c[0], render_context.style->PrimaryColour, pwr);
-			change_alpha(&render_context.c[1], render_context.style->SecondaryColour, pwr);
-			change_alpha(&render_context.c[2], render_context.style->OutlineColour, pwr);
-			change_alpha(&render_context.c[3], render_context.style->BackColour, pwr);
-		}
-		// FIXME: simplify
-	} else if (mystrcmp(&p, "an")) {
-		int val;
-		if (mystrtoi(&p, 10, &val) && val) {
-			int v = (val - 1) / 3; // 0, 1 or 2 for vertical alignment
-			mp_msg(MSGT_ASS, MSGL_DBG2, "an %d\n", val);
-			if (v != 0) v = 3 - v;
-			val = ((val - 1) % 3) + 1; // horizontal alignment
-			val += v*4;
-			mp_msg(MSGT_ASS, MSGL_DBG2, "align %d\n", val);
-			render_context.alignment = val;
-		} else
-			render_context.alignment = render_context.style->Alignment;
-	} else if (mystrcmp(&p, "a")) {
-		int val;
-		if (mystrtoi(&p, 10, &val) && val)
-			render_context.alignment = val;
-		else
-			render_context.alignment = render_context.style->Alignment;
-	} else if (mystrcmp(&p, "pos")) {
-		int v1, v2;
-		skip('(');
-		v1 = strtol(p, &p, 10);
-		skip(',');
-		v2 = strtol(p, &p, 10);
-		skip(')');
-		mp_msg(MSGT_ASS, MSGL_DBG2, "pos(%d, %d)\n", v1, v2);
-		render_context.evt_type = EVENT_POSITIONED;
-		render_context.detect_collisions = 0;
-		render_context.pos_x = v1;
-		render_context.pos_y = v2;
-	} else if (mystrcmp(&p, "fad")) {
-		int a1, a2, a3;
-		long long t1, t2, t3, t4;
-		if (*p == 'e') ++p; // either \fad or \fade
-		skip('(');
-		a1 = strtol(p, &p, 10);
-		skip(',');
-		a2 = strtol(p, &p, 10);
-		if (*p == ')') {
-			// 2-argument version (\fad, according to specs)
-			// a1 and a2 are fade-in and fade-out durations
-			t1 = 0;
-			t4 = render_context.event->Duration;
-			t2 = a1;
-			t3 = t4 - a2;
-			a1 = 0xFF;
-			a2 = 0;
-			a3 = 0xFF;
-		} else {
-			// 6-argument version (\fade)
-			// a1 and a2 (and a3) are opacity values
-			skip(',');
-			a3 = strtol(p, &p, 10);
-			skip(',');
-			t1 = strtoll(p, &p, 10);
-			skip(',');
-			t2 = strtoll(p, &p, 10);
-			skip(',');
-			t3 = strtoll(p, &p, 10);
-			skip(',');
-			t4 = strtoll(p, &p, 10);
-		}
-		skip(')');
-		render_context.fade = interpolate_alpha(frame_context.time - render_context.event->Start, t1, t2, t3, t4, a1, a2, a3);
-	} else if (mystrcmp(&p, "org")) {
-		int v1, v2;
-		skip('(');
-		v1 = strtol(p, &p, 10);
-		skip(',');
-		v2 = strtol(p, &p, 10);
-		skip(')');
-		mp_msg(MSGT_ASS, MSGL_DBG2, "org(%d, %d)\n", v1, v2);
-		//				render_context.evt_type = EVENT_POSITIONED;
-		render_context.org_x = v1;
-		render_context.org_y = v2;
-		render_context.have_origin = 1;
-	} else if (mystrcmp(&p, "t")) {
-		double v[3];
-		int v1, v2;
-		double v3;
-		int cnt;
-		long long t1, t2, t, delta_t;
-		double k;
-		skip('(');
-		for (cnt = 0; cnt < 3; ++cnt) {
-			if (*p == '\\')
-				break;
-			v[cnt] = strtod(p, &p);
-			skip(',');
-		}
-		if (cnt == 3) {
-			v1 = v[0]; v2 = v[1]; v3 = v[2];
-		} else if (cnt == 2) {
-			v1 = v[0]; v2 = v[1]; v3 = 1.;
-		} else if (cnt == 1) {
-			v1 = 0; v2 = render_context.event->Duration; v3 = v[0];
-		} else { // cnt == 0
-			v1 = 0; v2 = render_context.event->Duration; v3 = 1.;
-		}
-		render_context.detect_collisions = 0;
-		t1 = v1;
-		t2 = v2;
-		delta_t = v2 - v1;
-		if (v3 < 0.)
-			v3 = 0.;
-		t = frame_context.time - render_context.event->Start; // FIXME: move to render_context
-		if (t <= t1)
-			k = 0.;
-		else if (t >= t2)
-			k = 1.;
-		else {
-			assert(delta_t != 0.);
-			k = pow(((double)(t - t1)) / delta_t, v3);
-		}
-		while (*p == '\\')
-			p = parse_tag(p, k); // maybe k*pwr ? no, specs forbid nested \t's 
-		skip_all(')'); // FIXME: better skip(')'), but much more tags support required
-	} else if (mystrcmp(&p, "clip")) {
-		int x0, y0, x1, y1;
-		int res = 1;
-		skip('(');
-		res &= mystrtoi(&p, 10, &x0);
-		skip(',');
-		res &= mystrtoi(&p, 10, &y0);
-		skip(',');
-		res &= mystrtoi(&p, 10, &x1);
-		skip(',');
-		res &= mystrtoi(&p, 10, &y1);
-		skip(')');
-		if (res) {
-			render_context.clip_x0 = render_context.clip_x0 * (1-pwr) + x0 * pwr;
-			render_context.clip_x1 = render_context.clip_x1 * (1-pwr) + x1 * pwr;
-			render_context.clip_y0 = render_context.clip_y0 * (1-pwr) + y0 * pwr;
-			render_context.clip_y1 = render_context.clip_y1 * (1-pwr) + y1 * pwr;
-		} else {
-			render_context.clip_x0 = 0;
-			render_context.clip_y0 = 0;
-			render_context.clip_x1 = frame_context.track->PlayResX;
-			render_context.clip_y1 = frame_context.track->PlayResY;
-		}
-	} else if (mystrcmp(&p, "c")) {
-		uint32_t val;
-		if (!strtocolor(&p, &val))
-			val = render_context.style->PrimaryColour;
-		mp_msg(MSGT_ASS, MSGL_DBG2, "color: %X\n", val);
-		change_color(&render_context.c[0], val, pwr);
-	} else if ((*p >= '1') && (*p <= '4') && (++p) && (mystrcmp(&p, "c") || mystrcmp(&p, "a"))) {
-		char n = *(p-2);
-		int cidx = n - '1';
-		char cmd = *(p-1);
-		uint32_t val;
-		assert((n >= '1') && (n <= '4'));
-		if (!strtocolor(&p, &val))
-			switch(n) {
-				case '1': val = render_context.style->PrimaryColour; break;
-				case '2': val = render_context.style->SecondaryColour; break;
-				case '3': val = render_context.style->OutlineColour; break;
-				case '4': val = render_context.style->BackColour; break;
-				default : val = 0; break; // impossible due to assert; avoid compilation warning
-			}
-		switch (cmd) {
-			case 'c': change_color(render_context.c + cidx, val, pwr); break;
-			case 'a': change_alpha(render_context.c + cidx, val >> 24, pwr); break;
-			default: mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_BadCommand, n, cmd); break;
-		}
-		mp_msg(MSGT_ASS, MSGL_DBG2, "single c/a at %f: %c%c = %X   \n", pwr, n, cmd, render_context.c[cidx]);
-	} else if (mystrcmp(&p, "r")) {
-		reset_render_context();
-	} else if (mystrcmp(&p, "be")) {
-		int val;
-		if (mystrtoi(&p, 10, &val))
-			render_context.be = val ? 1 : 0;
-		else
-			render_context.be = 0;
-	} else if (mystrcmp(&p, "b")) {
-		int b;
-		if (mystrtoi(&p, 10, &b)) {
-			if (pwr >= .5)
-				render_context.bold = b;
-		} else
-			render_context.bold = render_context.style->Bold;
-		update_font();
-	} else if (mystrcmp(&p, "i")) {
-		int i;
-		if (mystrtoi(&p, 10, &i)) {
-			if (pwr >= .5)
-				render_context.italic = i;
-		} else
-			render_context.italic = render_context.style->Italic;
-		update_font();
-	} else if (mystrcmp(&p, "kf") || mystrcmp(&p, "K")) {
-		int val = strtol(p, &p, 10);
-		render_context.effect_type = EF_KARAOKE_KF;
-		if (render_context.effect_timing)
-			render_context.effect_skip_timing += render_context.effect_timing;
-		render_context.effect_timing = val * 10;
-	} else if (mystrcmp(&p, "ko")) {
-		int val = strtol(p, &p, 10);
-		render_context.effect_type = EF_KARAOKE_KO;
-		if (render_context.effect_timing)
-			render_context.effect_skip_timing += render_context.effect_timing;
-		render_context.effect_timing = val * 10;
-	} else if (mystrcmp(&p, "k")) {
-		int val = strtol(p, &p, 10);
-		render_context.effect_type = EF_KARAOKE;
-		if (render_context.effect_timing)
-			render_context.effect_skip_timing += render_context.effect_timing;
-		render_context.effect_timing = val * 10;
-	} else if (mystrcmp(&p, "shad")) {
-		int val;
-		if (mystrtoi(&p, 10, &val))
-			render_context.shadow = val;
-		else
-			render_context.shadow = render_context.style->Shadow;
-	}
+    reset_render_context(render_priv);
 
-	return p;
+    render_priv->state.evt_type = EVENT_NORMAL;
+    render_priv->state.alignment = render_priv->state.style->Alignment;
+    render_priv->state.pos_x = 0;
+    render_priv->state.pos_y = 0;
+    render_priv->state.org_x = 0;
+    render_priv->state.org_y = 0;
+    render_priv->state.have_origin = 0;
+    render_priv->state.clip_x0 = 0;
+    render_priv->state.clip_y0 = 0;
+    render_priv->state.clip_x1 = render_priv->track->PlayResX;
+    render_priv->state.clip_y1 = render_priv->track->PlayResY;
+    render_priv->state.clip_mode = 0;
+    render_priv->state.detect_collisions = 1;
+    render_priv->state.fade = 0;
+    render_priv->state.drawing_mode = 0;
+    render_priv->state.effect_type = EF_NONE;
+    render_priv->state.effect_timing = 0;
+    render_priv->state.effect_skip_timing = 0;
+    ass_drawing_free(render_priv->state.drawing);
+    render_priv->state.drawing = ass_drawing_new(render_priv->fontconfig_priv,
+                                                 render_priv->state.font,
+                                                 render_priv->ftlibrary);
 
-#undef skip
-#undef skip_all
+    apply_transition_effects(render_priv, event);
 }
 
-/**
- * \brief Get next ucs4 char from string, parsing and executing style overrides
- * \param str string pointer
- * \return ucs4 code of the next char
- * On return str points to the unparsed part of the string
- */
-static unsigned get_next_char(char** str)
+static void free_render_context(ASS_Renderer *render_priv)
 {
-	char* p = *str;
-	unsigned chr;
-	if (*p == '{') { // '\0' goes here
-		p++;
-		while (1) {
-			p = parse_tag(p, 1.);
-			if (*p == '}') { // end of tag
-				p++;
-				if (*p == '{') {
-					p++;
-					continue;
-				} else
-					break;
-			} else if (*p != '\\')
-				mp_msg(MSGT_ASS, MSGL_V, "Unable to parse: \"%s\" \n", p);
-			if (*p == 0)
-				break;
-		}
-	}
-	if (*p == '\t') {
-		++p;
-		*str = p;
-		return ' ';
-	}
-	if (*p == '\\') {
-		if ((*(p+1) == 'N') || ((*(p+1) == 'n') && (frame_context.track->WrapStyle == 2))) {
-			p += 2;
-			*str = p;
-			return '\n';
-		} else if (*(p+1) == 'n') {
-			p += 2;
-			*str = p;
-			return ' ';
-		}
-	}
-	chr = utf8_get_char(&p);
-	*str = p;
-	return chr;
+    free(render_priv->state.family);
+    ass_drawing_free(render_priv->state.drawing);
+
+    render_priv->state.family = NULL;
+    render_priv->state.drawing = NULL;
 }
 
-static void apply_transition_effects(ass_event_t* event)
+/*
+ * Replace the outline of a glyph by a contour which makes up a simple
+ * opaque rectangle.
+ */
+static void draw_opaque_box(ASS_Renderer *render_priv, uint32_t ch,
+                            FT_Glyph glyph, int sx, int sy)
 {
-	int v[4];
-	int cnt;
-	char* p = event->Effect;
+    int asc = 0, desc = 0;
+    int i;
+    int adv = d16_to_d6(glyph->advance.x);
+    double scale_y = render_priv->state.scale_y;
+    double scale_x = render_priv->state.scale_x;
+    FT_OutlineGlyph og = (FT_OutlineGlyph) glyph;
+    FT_Outline *ol;
 
-	if (!p || !*p) return;
+    // to avoid gaps
+    sx = FFMAX(64, sx);
+    sy = FFMAX(64, sy);
 
-	cnt = 0;
-	while (cnt < 4 && (p = strchr(p, ';'))) {
-		v[cnt++] = atoi(++p);
-	}
-	
-	if (strncmp(event->Effect, "Banner;", 7) == 0) {
-		int delay;
-		if (cnt < 1) {
-			mp_msg(MSGT_ASS, MSGL_V, "Error parsing effect: %s \n", event->Effect);
-			return;
-		}
-		if (cnt >= 2 && v[1] == 0) // right-to-left
-			render_context.scroll_direction = SCROLL_RL;
-		else // left-to-right
-			render_context.scroll_direction = SCROLL_LR;
+    if (ch == -1) {
+        asc = render_priv->state.drawing->asc;
+        desc = render_priv->state.drawing->desc;
+    } else {
+        ass_font_get_asc_desc(render_priv->state.font, ch, &asc, &desc);
+        asc  *= scale_y;
+        desc *= scale_y;
+    }
 
-		delay = v[0];
-		if (delay == 0) delay = 1; // ?
-		render_context.scroll_shift = (frame_context.time - render_context.event->Start) / delay;
-		render_context.evt_type = EVENT_HSCROLL;
-		return;
-	}
+    // Emulate the WTFish behavior of VSFilter, i.e. double-scale
+    // the sizes of the opaque box.
+    adv += double_to_d6(render_priv->state.hspacing * render_priv->font_scale
+                        * scale_x);
+    adv *= scale_x;
+    sx *= scale_x;
+    sy *= scale_y;
+    desc *= scale_y;
+    desc += asc * (scale_y - 1.0);
 
-	if (strncmp(event->Effect, "Scroll up;", 10) == 0) {
-		render_context.scroll_direction = SCROLL_BT;
-	} else if (strncmp(event->Effect, "Scroll down;", 12) == 0) {
-		render_context.scroll_direction = SCROLL_TB;
-	} else {
-		mp_msg(MSGT_ASS, MSGL_V, "Unknown transition effect: %s \n", event->Effect);
-		return;
-	}
-	// parse scroll up/down parameters
-	{
-		int delay;
-		int y0, y1;
-		if (cnt < 3) {
-			mp_msg(MSGT_ASS, MSGL_V, "Error parsing effect: %s \n", event->Effect);
-			return;
-		}
-		delay = v[2];
-		if (delay == 0) delay = 1; // ?
-		render_context.scroll_shift = (frame_context.time - render_context.event->Start) / delay;
-		if (v[0] < v[1]) {
-			y0 = v[0]; y1 = v[1];
-		} else {
-			y0 = v[1]; y1 = v[0];
-		}
-		if (y1 == 0)
-			y1 = frame_context.track->PlayResY; // y0=y1=0 means fullscreen scrolling
-		render_context.clip_y0 = y0;
-		render_context.clip_y1 = y1;
-		render_context.evt_type = EVENT_VSCROLL;
-		render_context.detect_collisions = 0;
-	}
+    FT_Vector points[4] = {
+        { .x = -sx,         .y = asc + sy },
+        { .x = adv + sx,    .y = asc + sy },
+        { .x = adv + sx,    .y = -desc - sy },
+        { .x = -sx,         .y = -desc - sy },
+    };
 
+    FT_Outline_Done(render_priv->ftlibrary, &og->outline);
+    FT_Outline_New(render_priv->ftlibrary, 4, 1, &og->outline);
+
+    ol = &og->outline;
+    ol->n_points = ol->n_contours = 0;
+    for (i = 0; i < 4; i++) {
+        ol->points[ol->n_points] = points[i];
+        ol->tags[ol->n_points++] = 1;
+    }
+    ol->contours[ol->n_contours++] = ol->n_points - 1;
 }
 
-/**
- * \brief partially reset render_context to style values
- * Works like {\r}: resets some style overrides
+/*
+ * Stroke an outline glyph in x/y direction.  Applies various fixups to get
+ * around limitations of the FreeType stroker.
  */
-static void reset_render_context(void)
+static void stroke_outline_glyph(ASS_Renderer *render_priv,
+                                 FT_OutlineGlyph *glyph, int sx, int sy)
 {
-	render_context.c[0] = render_context.style->PrimaryColour;
-	render_context.c[1] = render_context.style->SecondaryColour;
-	render_context.c[2] = render_context.style->OutlineColour;
-	render_context.c[3] = render_context.style->BackColour;
-	render_context.font_size = render_context.style->FontSize;
+    if (sx <= 0 && sy <= 0)
+        return;
 
-	if (render_context.family)
-		free(render_context.family);
-	render_context.family = strdup(render_context.style->FontName);
-	render_context.bold = render_context.style->Bold;
-	render_context.italic = render_context.style->Italic;
-	update_font();
+    fix_freetype_stroker(*glyph, sx, sy);
 
-	change_border(-1.);
-	render_context.scale_x = render_context.style->ScaleX;
-	render_context.scale_y = render_context.style->ScaleY;
-	render_context.hspacing = render_context.style->Spacing;
-	render_context.be = 0;
-	render_context.shadow = render_context.style->Shadow;
-	render_context.frx = render_context.fry = 0.;
-	render_context.frz = M_PI * render_context.style->Angle / 180.;
+    // Borders are equal; use the regular stroker
+    if (sx == sy && render_priv->state.stroker) {
+        int error;
+        error = FT_Glyph_StrokeBorder((FT_Glyph *) glyph,
+                                      render_priv->state.stroker, 0, 1);
+        if (error)
+            ass_msg(render_priv->library, MSGL_WARN,
+                    "FT_Glyph_Stroke error: %d", error);
 
-	// FIXME: does not reset unsupported attributes.
-}
+    // "Stroke" with the outline emboldener in two passes.
+    // The outlines look uglier, but the emboldening never adds any points
+    } else {
+        int i;
+        FT_Outline *ol = &(*glyph)->outline;
+        FT_Outline nol;
+        FT_Outline_New(render_priv->ftlibrary, ol->n_points,
+                       ol->n_contours, &nol);
+        FT_Outline_Copy(ol, &nol);
 
-/**
- * \brief Start new event. Reset render_context.
- */
-static void init_render_context(ass_event_t* event)
-{
-	render_context.event = event;
-	render_context.style = frame_context.track->styles + event->Style;
+        FT_Outline_Embolden(ol, sx * 2);
+        FT_Outline_Translate(ol, -sx, -sx);
+        FT_Outline_Embolden(&nol, sy * 2);
+        FT_Outline_Translate(&nol, -sy, -sy);
 
-	reset_render_context();
+        for (i = 0; i < ol->n_points; i++)
+            ol->points[i].y = nol.points[i].y;
 
-	render_context.evt_type = EVENT_NORMAL;
-	render_context.alignment = render_context.style->Alignment;
-	render_context.pos_x = 0;
-	render_context.pos_y = 0;
-	render_context.org_x = 0;
-	render_context.org_y = 0;
-	render_context.have_origin = 0;
-	render_context.clip_x0 = 0;
-	render_context.clip_y0 = 0;
-	render_context.clip_x1 = frame_context.track->PlayResX;
-	render_context.clip_y1 = frame_context.track->PlayResY;
-	render_context.detect_collisions = 1;
-	render_context.fade = 0;
-	render_context.effect_type = EF_NONE;
-	render_context.effect_timing = 0;
-	render_context.effect_skip_timing = 0;
-	
-	apply_transition_effects(event);
+        FT_Outline_Done(render_priv->ftlibrary, &nol);
+    }
 }
 
-static void free_render_context(void)
+/**
+ * \brief Prepare glyph hash
+ */
+static void
+fill_glyph_hash(ASS_Renderer *priv, GlyphHashKey *key,
+                ASS_Drawing *drawing, uint32_t ch)
 {
+    if (drawing->hash) {
+        key->scale_x = double_to_d16(priv->state.scale_x);
+        key->scale_y = double_to_d16(priv->state.scale_y);
+        key->outline.x = priv->state.border_x * 0xFFFF;
+        key->outline.y = priv->state.border_y * 0xFFFF;
+        key->border_style = priv->state.style->BorderStyle;
+        key->drawing_hash = drawing->hash;
+        // not very clean, but works
+        key->size = drawing->scale;
+        key->ch = -1;
+    } else {
+        key->font = priv->state.font;
+        key->size = priv->state.font_size;
+        key->ch = ch;
+        key->bold = priv->state.bold;
+        key->italic = priv->state.italic;
+        key->scale_x = double_to_d16(priv->state.scale_x);
+        key->scale_y = double_to_d16(priv->state.scale_y);
+        key->outline.x = priv->state.border_x * 0xFFFF;
+        key->outline.y = priv->state.border_y * 0xFFFF;
+        key->flags = priv->state.flags;
+        key->border_style = priv->state.style->BorderStyle;
+    }
 }
 
 /**
  * \brief Get normal and outline (border) glyphs
  * \param symbol ucs4 char
  * \param info out: struct filled with extracted data
- * \param advance subpixel shift vector used for cache lookup
  * Tries to get both glyphs from cache.
  * If they can't be found, gets a glyph from font face, generates outline with FT_Stroker,
  * and add them to cache.
  * The glyphs are returned in info->glyph and info->outline_glyph
  */
-static void get_outline_glyph(int symbol, glyph_info_t* info, FT_Vector* advance)
+static void
+get_outline_glyph(ASS_Renderer *render_priv, int symbol, GlyphInfo *info,
+                  ASS_Drawing *drawing)
 {
-	int error;
-	glyph_hash_val_t* val;
-	glyph_hash_key_t key;
-	key.font = render_context.font;
-	key.size = render_context.font_size;
-	key.ch = symbol;
-	key.scale_x = (render_context.scale_x * 0xFFFF);
-	key.scale_y = (render_context.scale_y * 0xFFFF);
-	key.advance = *advance;
-	key.bold = render_context.bold;
-	key.italic = render_context.italic;
-	key.outline = render_context.border * 0xFFFF;
+    GlyphHashValue *val;
+    GlyphHashKey key;
 
-	info->glyph = info->outline_glyph = 0;
+    memset(&key, 0, sizeof(key));
+    memset(info, 0, sizeof(GlyphInfo));
 
-	val = cache_find_glyph(&key);
-	if (val) {
-		FT_Glyph_Copy(val->glyph, &info->glyph);
-		if (val->outline_glyph)
-			FT_Glyph_Copy(val->outline_glyph, &info->outline_glyph);
-		info->bbox = val->bbox_scaled;
-		info->advance.x = val->advance.x;
-		info->advance.y = val->advance.y;
-	} else {
-		glyph_hash_val_t v;
-		info->glyph = ass_font_get_glyph(frame_context.ass_priv->fontconfig_priv, render_context.font, symbol, global_settings->hinting);
-		if (!info->glyph)
-			return;
-		info->advance.x = d16_to_d6(info->glyph->advance.x);
-		info->advance.y = d16_to_d6(info->glyph->advance.y);
-		FT_Glyph_Get_CBox( info->glyph, FT_GLYPH_BBOX_PIXELS, &info->bbox);
+    fill_glyph_hash(render_priv, &key, drawing, symbol);
+    val = cache_find_glyph(render_priv->cache.glyph_cache, &key);
+    if (val) {
+        info->glyph = val->glyph;
+        info->outline_glyph = val->outline_glyph;
+        info->bbox = val->bbox_scaled;
+        info->advance.x = val->advance.x;
+        info->advance.y = val->advance.y;
+        if (drawing->hash) {
+            drawing->asc = val->asc;
+            drawing->desc = val->desc;
+        }
+    } else {
+        GlyphHashValue v;
+        if (drawing->hash) {
+            if(!ass_drawing_parse(drawing, 0))
+                return;
+            info->glyph = (FT_Glyph) drawing->glyph;
+        } else {
+            info->glyph =
+                ass_font_get_glyph(render_priv->fontconfig_priv,
+                                   render_priv->state.font, symbol,
+                                   render_priv->settings.hinting,
+                                   render_priv->state.flags);
+        }
+        if (!info->glyph)
+            return;
 
-		if (render_context.stroker) {
-			info->outline_glyph = info->glyph;
-			error = FT_Glyph_StrokeBorder( &(info->outline_glyph), render_context.stroker, 0 , 0 ); // don't destroy original
-			if (error) {
-				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FT_Glyph_Stroke_Error, error);
-			}
-		}
+        info->advance.x = d16_to_d6(info->glyph->advance.x);
+        info->advance.y = d16_to_d6(info->glyph->advance.y);
+        FT_Glyph_Get_CBox(info->glyph, FT_GLYPH_BBOX_SUBPIXELS, &info->bbox);
 
-		memset(&v, 0, sizeof(v));
-		FT_Glyph_Copy(info->glyph, &v.glyph);
-		if (info->outline_glyph)
-			FT_Glyph_Copy(info->outline_glyph, &v.outline_glyph);
-		v.advance = info->advance;
-		v.bbox_scaled = info->bbox;
-		cache_add_glyph(&key, &v);
-	}
+        if (render_priv->state.style->BorderStyle == 3 &&
+            (render_priv->state.border_x > 0||
+             render_priv->state.border_y > 0)) {
+            FT_Glyph_Copy(info->glyph, &info->outline_glyph);
+            draw_opaque_box(render_priv, symbol, info->outline_glyph,
+                            double_to_d6(render_priv->state.border_x *
+                                         render_priv->border_scale),
+                            double_to_d6(render_priv->state.border_y *
+                                         render_priv->border_scale));
+        } else if ((render_priv->state.border_x > 0
+                    || render_priv->state.border_y > 0)
+                   && key.scale_x && key.scale_y) {
+
+            FT_Glyph_Copy(info->glyph, &info->outline_glyph);
+            stroke_outline_glyph(render_priv,
+                                 (FT_OutlineGlyph *) &info->outline_glyph,
+                                 double_to_d6(render_priv->state.border_x *
+                                              render_priv->border_scale),
+                                 double_to_d6(render_priv->state.border_y *
+                                              render_priv->border_scale));
+        }
+
+        memset(&v, 0, sizeof(v));
+        v.glyph = info->glyph;
+        v.outline_glyph = info->outline_glyph;
+        v.advance = info->advance;
+        v.bbox_scaled = info->bbox;
+        if (drawing->hash) {
+            v.asc = drawing->asc;
+            v.desc = drawing->desc;
+        }
+        cache_add_glyph(render_priv->cache.glyph_cache, &key, &v);
+    }
 }
 
-static void transform_3d(FT_Vector shift, FT_Glyph* glyph, FT_Glyph* glyph2, double frx, double fry, double frz);
+/**
+ * \brief Apply transformation to outline points of a glyph
+ * Applies rotations given by frx, fry and frz and projects the points back
+ * onto the screen plane.
+ */
+static void
+transform_3d_points(FT_Vector shift, FT_Glyph glyph, double frx, double fry,
+                    double frz, double fax, double fay, double scale,
+                    int yshift)
+{
+    double sx = sin(frx);
+    double sy = sin(fry);
+    double sz = sin(frz);
+    double cx = cos(frx);
+    double cy = cos(fry);
+    double cz = cos(frz);
+    FT_Outline *outline = &((FT_OutlineGlyph) glyph)->outline;
+    FT_Vector *p = outline->points;
+    double x, y, z, xx, yy, zz;
+    int i, dist;
 
+    dist = 20000 * scale;
+    for (i = 0; i < outline->n_points; i++) {
+        x = (double) p[i].x + shift.x + (fax * (yshift - p[i].y));
+        y = (double) p[i].y + shift.y + (-fay * p[i].x);
+        z = 0.;
+
+        xx = x * cz + y * sz;
+        yy = -(x * sz - y * cz);
+        zz = z;
+
+        x = xx;
+        y = yy * cx + zz * sx;
+        z = yy * sx - zz * cx;
+
+        xx = x * cy + z * sy;
+        yy = y;
+        zz = x * sy - z * cy;
+
+        zz = FFMAX(zz, 1000 - dist);
+
+        x = (xx * dist) / (zz + dist);
+        y = (yy * dist) / (zz + dist);
+        p[i].x = x - shift.x + 0.5;
+        p[i].y = y - shift.y + 0.5;
+    }
+}
+
 /**
+ * \brief Apply 3d transformation to several objects
+ * \param shift FreeType vector
+ * \param glyph FreeType glyph
+ * \param glyph2 FreeType glyph
+ * \param frx x-axis rotation angle
+ * \param fry y-axis rotation angle
+ * \param frz z-axis rotation angle
+ * Rotates both glyphs by frx, fry and frz. Shift vector is added before rotation and subtracted after it.
+ */
+static void
+transform_3d(FT_Vector shift, FT_Glyph *glyph, FT_Glyph *glyph2,
+             double frx, double fry, double frz, double fax, double fay,
+             double scale, int yshift)
+{
+    frx = -frx;
+    frz = -frz;
+    if (frx != 0. || fry != 0. || frz != 0. || fax != 0. || fay != 0.) {
+        if (glyph && *glyph)
+            transform_3d_points(shift, *glyph, frx, fry, frz,
+                                fax, fay, scale, yshift);
+
+        if (glyph2 && *glyph2)
+            transform_3d_points(shift, *glyph2, frx, fry, frz,
+                                fax, fay, scale, yshift);
+    }
+}
+
+/**
  * \brief Get bitmaps for a glyph
  * \param info glyph info
  * Tries to get glyph bitmaps from bitmap cache.
@@ -1268,50 +1229,81 @@
  * After that, bitmaps are added to the cache.
  * They are returned in info->bm (glyph), info->bm_o (outline) and info->bm_s (shadow).
  */
-static void get_bitmap_glyph(glyph_info_t* info)
+static void
+get_bitmap_glyph(ASS_Renderer *render_priv, GlyphInfo *info)
 {
-	bitmap_hash_val_t* val;
-	bitmap_hash_key_t* key = &info->hash_key;
-	
-	val = cache_find_bitmap(key);
-/* 	val = 0; */
-	
-	if (val) {
-		info->bm = val->bm;
-		info->bm_o = val->bm_o;
-		info->bm_s = val->bm_s;
-	} else {
-		FT_Vector shift;
-		bitmap_hash_val_t hash_val;
-		int error;
-		info->bm = info->bm_o = info->bm_s = 0;
-		if (info->glyph && info->symbol != '\n' && info->symbol != 0) {
-			// calculating rotation shift vector (from rotation origin to the glyph basepoint)
-			shift.x = int_to_d6(info->hash_key.shift_x);
-			shift.y = int_to_d6(info->hash_key.shift_y);
-			// apply rotation
-			transform_3d(shift, &info->glyph, &info->outline_glyph, info->frx, info->fry, info->frz);
+    BitmapHashValue *val;
+    BitmapHashKey *key = &info->hash_key;
 
-			// render glyph
-			error = glyph_to_bitmap(ass_renderer->synth_priv,
-					info->glyph, info->outline_glyph,
-					&info->bm, &info->bm_o,
-					&info->bm_s, info->be);
-			if (error)
-				info->symbol = 0;
+    val = cache_find_bitmap(render_priv->cache.bitmap_cache, key);
 
-			// add bitmaps to cache
-			hash_val.bm_o = info->bm_o;
-			hash_val.bm = info->bm;
-			hash_val.bm_s = info->bm_s;
-			cache_add_bitmap(&(info->hash_key), &hash_val);
-		}
-	}
-	// deallocate glyphs
-	if (info->glyph)
-		FT_Done_Glyph(info->glyph);
-	if (info->outline_glyph)
-		FT_Done_Glyph(info->outline_glyph);
+    if (val) {
+        info->bm = val->bm;
+        info->bm_o = val->bm_o;
+        info->bm_s = val->bm_s;
+    } else {
+        FT_Vector shift;
+        BitmapHashValue hash_val;
+        int error;
+        double fax_scaled, fay_scaled;
+        info->bm = info->bm_o = info->bm_s = 0;
+        if (info->glyph && info->symbol != '\n' && info->symbol != 0
+            && !info->skip) {
+            FT_Glyph glyph;
+            FT_Glyph outline;
+            double scale_x = render_priv->font_scale_x;
+
+            FT_Glyph_Copy(info->glyph, &glyph);
+            FT_Glyph_Copy(info->outline_glyph, &outline);
+            // calculating rotation shift vector (from rotation origin to the glyph basepoint)
+            shift.x = key->shift_x;
+            shift.y = key->shift_y;
+            fax_scaled = info->fax *
+                         render_priv->state.scale_x;
+            fay_scaled = info->fay * render_priv->state.scale_y;
+            // apply rotation
+            transform_3d(shift, &glyph, &outline,
+                         info->frx, info->fry, info->frz, fax_scaled,
+                         fay_scaled, render_priv->font_scale, info->asc);
+
+            // PAR correction scaling
+            FT_Matrix m = { double_to_d16(scale_x), 0,
+                            0, double_to_d16(1.0) };
+
+            // subpixel shift
+            if (glyph) {
+                FT_Outline *outl = &((FT_OutlineGlyph) glyph)->outline;
+                if (scale_x != 1.0)
+                    FT_Outline_Transform(outl, &m);
+                FT_Outline_Translate(outl, key->advance.x, -key->advance.y);
+            }
+            if (outline) {
+                FT_Outline *outl = &((FT_OutlineGlyph) outline)->outline;
+                if (scale_x != 1.0)
+                    FT_Outline_Transform(outl, &m);
+                FT_Outline_Translate(outl, key->advance.x, -key->advance.y);
+            }
+            // render glyph
+            error = glyph_to_bitmap(render_priv->library,
+                                    render_priv->synth_priv,
+                                    glyph, outline,
+                                    &info->bm, &info->bm_o,
+                                    &info->bm_s, info->be,
+                                    info->blur * render_priv->border_scale,
+                                    key->shadow_offset, key->border_style);
+            if (error)
+                info->symbol = 0;
+
+            // add bitmaps to cache
+            hash_val.bm_o = info->bm_o;
+            hash_val.bm = info->bm;
+            hash_val.bm_s = info->bm_s;
+            cache_add_bitmap(render_priv->cache.bitmap_cache, key, &hash_val);
+
+            FT_Done_Glyph(glyph);
+            FT_Done_Glyph(outline);
+        }
+    }
 }
 
 /**
@@ -1322,31 +1314,100 @@
  *   lines[].asc
  *   lines[].desc
  */
-static void measure_text(void)
+static void measure_text(ASS_Renderer *render_priv)
 {
-	int cur_line = 0, max_asc = 0, max_desc = 0;
-	int i;
-	text_info.height = 0;
-	for (i = 0; i < text_info.length + 1; ++i) {
-		if ((i == text_info.length) || text_info.glyphs[i].linebreak) {
-			text_info.lines[cur_line].asc = max_asc;
-			text_info.lines[cur_line].desc = max_desc;
-			text_info.height += max_asc + max_desc;
-			cur_line ++;
-			max_asc = max_desc = 0;
-		}
-		if (i < text_info.length) {
-			glyph_info_t* cur = text_info.glyphs + i;
-			if (cur->asc > max_asc)
-				max_asc = cur->asc;
-			if (cur->desc > max_desc)
-				max_desc = cur->desc;
-		}
-	}
-	text_info.height += (text_info.n_lines - 1) * double_to_d6(global_settings->line_spacing);
+    TextInfo *text_info = &render_priv->text_info;
+    int cur_line = 0;
+    double max_asc = 0., max_desc = 0.;
+    GlyphInfo *last = NULL;
+    int i;
+    int empty_line = 1;
+    text_info->height = 0.;
+    for (i = 0; i < text_info->length + 1; ++i) {
+        if ((i == text_info->length) || text_info->glyphs[i].linebreak) {
+            if (empty_line && cur_line > 0 && last && i < text_info->length) {
+                max_asc = d6_to_double(last->asc) / 2.0;
+                max_desc = d6_to_double(last->desc) / 2.0;
+            }
+            text_info->lines[cur_line].asc = max_asc;
+            text_info->lines[cur_line].desc = max_desc;
+            text_info->height += max_asc + max_desc;
+            cur_line++;
+            max_asc = max_desc = 0.;
+            empty_line = 1;
+        } else
+            empty_line = 0;
+        if (i < text_info->length) {
+            GlyphInfo *cur = text_info->glyphs + i;
+            if (d6_to_double(cur->asc) > max_asc)
+                max_asc = d6_to_double(cur->asc);
+            if (d6_to_double(cur->desc) > max_desc)
+                max_desc = d6_to_double(cur->desc);
+            if (cur->symbol != '\n' && cur->symbol != 0)
+                last = cur;
+        }
+    }
+    text_info->height +=
+        (text_info->n_lines -
+         1) * render_priv->settings.line_spacing;
 }
 
 /**
+ * Mark extra whitespace for later removal.
+ */
+#define IS_WHITESPACE(x) ((x->symbol == ' ' || x->symbol == '\n') \
+                          && !x->linebreak)
+static void trim_whitespace(ASS_Renderer *render_priv)
+{
+    int i, j;
+    GlyphInfo *cur;
+    TextInfo *ti = &render_priv->text_info;
+
+    // Mark trailing spaces
+    i = ti->length - 1;
+    cur = ti->glyphs + i;
+    while (i && IS_WHITESPACE(cur)) {
+        cur->skip++;
+        cur = ti->glyphs + --i;
+    }
+
+    // Mark leading whitespace
+    i = 0;
+    cur = ti->glyphs;
+    while (i < ti->length && IS_WHITESPACE(cur)) {
+        cur->skip++;
+        cur = ti->glyphs + ++i;
+    }
+
+    // Mark all extraneous whitespace inbetween
+    for (i = 0; i < ti->length; ++i) {
+        cur = ti->glyphs + i;
+        if (cur->linebreak) {
+            // Mark whitespace before
+            j = i - 1;
+            cur = ti->glyphs + j;
+            while (j && IS_WHITESPACE(cur)) {
+                cur->skip++;
+                cur = ti->glyphs + --j;
+            }
+            // A break itself can contain a whitespace, too
+            cur = ti->glyphs + i;
+            if (cur->symbol == ' ')
+                cur->skip++;
+            // Mark whitespace after
+            j = i + 1;
+            cur = ti->glyphs + j;
+            while (j < ti->length && IS_WHITESPACE(cur)) {
+                cur->skip++;
+                cur = ti->glyphs + ++j;
+            }
+            i = j - 1;
+        }
+    }
+}
+#undef IS_WHITESPACE
+
+/**
  * \brief rearrange text between lines
  * \param max_text_width maximal text line width in pixels
  * The algo is similar to the one in libvo/sub.c:
@@ -1354,199 +1415,237 @@
  * 2. Try moving words from the end of a line to the beginning of the next one while it reduces
  * the difference in lengths between this two lines.
  * The result may not be optimal, but usually is good enough.
+ *
+ * FIXME: implement style 0 and 3 correctly
  */
-static void wrap_lines_smart(int max_text_width)
+static void
+wrap_lines_smart(ASS_Renderer *render_priv, double max_text_width)
 {
-	int i, j;
-	glyph_info_t *cur, *s1, *e1, *s2, *s3, *w;
-	int last_space;
-	int break_type;
-	int exit;
-	int pen_shift_x;
-	int pen_shift_y;
-	int cur_line;
+    int i;
+    GlyphInfo *cur, *s1, *e1, *s2, *s3, *w;
+    int last_space;
+    int break_type;
+    int exit;
+    double pen_shift_x;
+    double pen_shift_y;
+    int cur_line;
+    TextInfo *text_info = &render_priv->text_info;
 
-	last_space = -1;
-	text_info.n_lines = 1;
-	break_type = 0;
-	s1 = text_info.glyphs; // current line start
-	for (i = 0; i < text_info.length; ++i) {
-		int break_at, s_offset, len;
-		cur = text_info.glyphs + i;
-		break_at = -1;
-		s_offset = s1->bbox.xMin + s1->pos.x;
-		len = (cur->bbox.xMax + cur->pos.x) - s_offset;
+    last_space = -1;
+    text_info->n_lines = 1;
+    break_type = 0;
+    s1 = text_info->glyphs;     // current line start
+    for (i = 0; i < text_info->length; ++i) {
+        int break_at;
+        double s_offset, len;
+        cur = text_info->glyphs + i;
+        break_at = -1;
+        s_offset = d6_to_double(s1->bbox.xMin + s1->pos.x);
+        len = d6_to_double(cur->bbox.xMax + cur->pos.x) - s_offset;
 
-		if (cur->symbol == '\n') {
-			break_type = 2;
-			break_at = i;
-			mp_msg(MSGT_ASS, MSGL_DBG2, "forced line break at %d\n", break_at);
-		}
-		
-		if (len >= max_text_width) {
-			break_type = 1;
-			break_at = last_space;
-			if (break_at == -1)
-				break_at = i - 1;
-			if (break_at == -1)
-				break_at = 0;
-			mp_msg(MSGT_ASS, MSGL_DBG2, "overfill at %d\n", i);
-			mp_msg(MSGT_ASS, MSGL_DBG2, "line break at %d\n", break_at);
-		}
+        if (cur->symbol == '\n') {
+            break_type = 2;
+            break_at = i;
+            ass_msg(render_priv->library, MSGL_DBG2,
+                    "forced line break at %d", break_at);
+        }
 
-		if (break_at != -1) {
-			// need to use one more line
-			// marking break_at+1 as start of a new line
-			int lead = break_at + 1; // the first symbol of the new line
-			if (text_info.n_lines >= MAX_LINES) {
-				// to many lines ! 
-				// no more linebreaks
-				for (j = lead; j < text_info.length; ++j)
-					text_info.glyphs[j].linebreak = 0;
-				break;
-			}
-			if (lead < text_info.length)
-				text_info.glyphs[lead].linebreak = break_type;
-			last_space = -1;
-			s1 = text_info.glyphs + lead;
-			s_offset = s1->bbox.xMin + s1->pos.x;
-			text_info.n_lines ++;
-		}
-		
-		if (cur->symbol == ' ')
-			last_space = i;
+        if ((len >= max_text_width)
+            && (render_priv->state.wrap_style != 2)) {
+            break_type = 1;
+            break_at = last_space;
+            if (break_at == -1)
+                break_at = i - 1;
+            if (break_at == -1)
+                break_at = 0;
+            ass_msg(render_priv->library, MSGL_DBG2, "overfill at %d", i);
+            ass_msg(render_priv->library, MSGL_DBG2, "line break at %d",
+                    break_at);
+        }
 
-		// make sure the hard linebreak is not forgotten when
-		// there was a new soft linebreak just inserted
-		if (cur->symbol == '\n' && break_type == 1)
-			i--;
-	}
+        if (break_at != -1) {
+            // need to use one more line
+            // marking break_at+1 as start of a new line
+            int lead = break_at + 1;    // the first symbol of the new line
+            if (text_info->n_lines >= text_info->max_lines) {
+                // Raise maximum number of lines
+                text_info->max_lines *= 2;
+                text_info->lines = realloc(text_info->lines,
+                                           sizeof(LineInfo) *
+                                           text_info->max_lines);
+            }
+            if (lead < text_info->length)
+                text_info->glyphs[lead].linebreak = break_type;
+            last_space = -1;
+            s1 = text_info->glyphs + lead;
+            s_offset = d6_to_double(s1->bbox.xMin + s1->pos.x);
+            text_info->n_lines++;
+        }
+
+        if (cur->symbol == ' ')
+            last_space = i;
+
+        // make sure the hard linebreak is not forgotten when
+        // there was a new soft linebreak just inserted
+        if (cur->symbol == '\n' && break_type == 1)
+            i--;
+    }
 #define DIFF(x,y) (((x) < (y)) ? (y - x) : (x - y))
-	exit = 0;
-	while (!exit) {
-		exit = 1;
-		w = s3 = text_info.glyphs;
-		s1 = s2 = 0;
-		for (i = 0; i <= text_info.length; ++i) {
-			cur = text_info.glyphs + i;
-			if ((i == text_info.length) || cur->linebreak) {
-				s1 = s2;
-				s2 = s3;
-				s3 = cur;
-				if (s1 && (s2->linebreak == 1)) { // have at least 2 lines, and linebreak is 'soft'
-					int l1, l2, l1_new, l2_new;
+    exit = 0;
+    while (!exit && render_priv->state.wrap_style != 1) {
+        exit = 1;
+        w = s3 = text_info->glyphs;
+        s1 = s2 = 0;
+        for (i = 0; i <= text_info->length; ++i) {
+            cur = text_info->glyphs + i;
+            if ((i == text_info->length) || cur->linebreak) {
+                s1 = s2;
+                s2 = s3;
+                s3 = cur;
+                if (s1 && (s2->linebreak == 1)) {       // have at least 2 lines, and linebreak is 'soft'
+                    double l1, l2, l1_new, l2_new;
 
-					w = s2;
-					do { --w; } while ((w > s1) && (w->symbol == ' '));
-					while ((w > s1) && (w->symbol != ' ')) { --w; }
-					e1 = w;
-					while ((e1 > s1) && (e1->symbol == ' ')) { --e1; }
-					if (w->symbol == ' ') ++w;
+                    w = s2;
+                    do {
+                        --w;
+                    } while ((w > s1) && (w->symbol == ' '));
+                    while ((w > s1) && (w->symbol != ' ')) {
+                        --w;
+                    }
+                    e1 = w;
+                    while ((e1 > s1) && (e1->symbol == ' ')) {
+                        --e1;
+                    }
+                    if (w->symbol == ' ')
+                        ++w;
 
-					l1 = ((s2-1)->bbox.xMax + (s2-1)->pos.x) - (s1->bbox.xMin + s1->pos.x);
-					l2 = ((s3-1)->bbox.xMax + (s3-1)->pos.x) - (s2->bbox.xMin + s2->pos.x);
-					l1_new = (e1->bbox.xMax + e1->pos.x) - (s1->bbox.xMin + s1->pos.x);
-					l2_new = ((s3-1)->bbox.xMax + (s3-1)->pos.x) - (w->bbox.xMin + w->pos.x);
+                    l1 = d6_to_double(((s2 - 1)->bbox.xMax + (s2 - 1)->pos.x) -
+                        (s1->bbox.xMin + s1->pos.x));
+                    l2 = d6_to_double(((s3 - 1)->bbox.xMax + (s3 - 1)->pos.x) -
+                        (s2->bbox.xMin + s2->pos.x));
+                    l1_new = d6_to_double(
+                        (e1->bbox.xMax + e1->pos.x) -
+                        (s1->bbox.xMin + s1->pos.x));
+                    l2_new = d6_to_double(
+                        ((s3 - 1)->bbox.xMax + (s3 - 1)->pos.x) -
+                        (w->bbox.xMin + w->pos.x));
 
-					if (DIFF(l1_new, l2_new) < DIFF(l1, l2)) {
-						w->linebreak = 1;
-						s2->linebreak = 0;
-						exit = 0;
-					}
-				}
-			}
-			if (i == text_info.length)
-				break;
-		}
-		
-	}
-	assert(text_info.n_lines >= 1);
+                    if (DIFF(l1_new, l2_new) < DIFF(l1, l2)) {
+                        w->linebreak = 1;
+                        s2->linebreak = 0;
+                        exit = 0;
+                    }
+                }
+            }
+            if (i == text_info->length)
+                break;
+        }
+
+    }
+    assert(text_info->n_lines >= 1);
 #undef DIFF
-	
-	measure_text();
 
-	pen_shift_x = 0;
-	pen_shift_y = 0;
-	cur_line = 1;
-	for (i = 0; i < text_info.length; ++i) {
-		cur = text_info.glyphs + i;
-		if (cur->linebreak) {
-			int height = text_info.lines[cur_line - 1].desc + text_info.lines[cur_line].asc;
-			cur_line ++;
-			pen_shift_x = - cur->pos.x;
-			pen_shift_y += d6_to_int(height + double_to_d6(global_settings->line_spacing));
-			mp_msg(MSGT_ASS, MSGL_DBG2, "shifting from %d to %d by (%d, %d)\n", i, text_info.length - 1, pen_shift_x, pen_shift_y);
-		}
-		cur->pos.x += pen_shift_x;
-		cur->pos.y += pen_shift_y;
-	}
+    measure_text(render_priv);
+    trim_whitespace(render_priv);
+
+    pen_shift_x = 0.;
+    pen_shift_y = 0.;
+    cur_line = 1;
+
+    i = 0;
+    cur = text_info->glyphs + i;
+    while (i < text_info->length && cur->skip)
+        cur = text_info->glyphs + ++i;
+    pen_shift_x = d6_to_double(-cur->pos.x);
+
+    for (i = 0; i < text_info->length; ++i) {
+        cur = text_info->glyphs + i;
+        if (cur->linebreak) {
+            while (i < text_info->length && cur->skip && cur->symbol != '\n')
+                cur = text_info->glyphs + ++i;
+            double height =
+                text_info->lines[cur_line - 1].desc +
+                text_info->lines[cur_line].asc;
+            cur_line++;
+            pen_shift_x = d6_to_double(-cur->pos.x);
+            pen_shift_y += height + render_priv->settings.line_spacing;
+            ass_msg(render_priv->library, MSGL_DBG2,
+                   "shifting from %d to %d by (%f, %f)", i,
+                   text_info->length - 1, pen_shift_x, pen_shift_y);
+        }
+        cur->pos.x += double_to_d6(pen_shift_x);
+        cur->pos.y += double_to_d6(pen_shift_y);
+    }
 }
 
 /**
  * \brief determine karaoke effects
  * Karaoke effects cannot be calculated during parse stage (get_next_char()),
  * so they are done in a separate step.
- * Parse stage: when karaoke style override is found, its parameters are stored in the next glyph's 
+ * Parse stage: when karaoke style override is found, its parameters are stored in the next glyph's
  * (the first glyph of the karaoke word)'s effect_type and effect_timing.
  * This function:
  * 1. sets effect_type for all glyphs in the word (_karaoke_ word)
  * 2. sets effect_timing for all glyphs to x coordinate of the border line between the left and right karaoke parts
  * (left part is filled with PrimaryColour, right one - with SecondaryColour).
  */
-static void process_karaoke_effects(void)
+static void process_karaoke_effects(ASS_Renderer *render_priv)
 {
-	glyph_info_t *cur, *cur2;
-	glyph_info_t *s1, *e1; // start and end of the current word
-	glyph_info_t *s2; // start of the next word
-	int i;
-	int timing; // current timing
-	int tm_start, tm_end; // timings at start and end of the current word
-	int tm_current;
-	double dt;
-	int x;
-	int x_start, x_end;
+    GlyphInfo *cur, *cur2;
+    GlyphInfo *s1, *e1;      // start and end of the current word
+    GlyphInfo *s2;           // start of the next word
+    int i;
+    int timing;                 // current timing
+    int tm_start, tm_end;       // timings at start and end of the current word
+    int tm_current;
+    double dt;
+    int x;
+    int x_start, x_end;
 
-	tm_current = frame_context.time - render_context.event->Start;
-	timing = 0;
-	s1 = s2 = 0;
-	for (i = 0; i <= text_info.length; ++i) {
-		cur = text_info.glyphs + i;
-		if ((i == text_info.length) || (cur->effect_type != EF_NONE)) {
-			s1 = s2;
-			s2 = cur;
-			if (s1) {
-				e1 = s2 - 1;
-				tm_start = timing + s1->effect_skip_timing;
-				tm_end = tm_start + s1->effect_timing;
-				timing = tm_end;
-				x_start = 1000000;
-				x_end = -1000000;
-				for (cur2 = s1; cur2 <= e1; ++cur2) {
-					x_start = FFMIN(x_start, cur2->bbox.xMin + cur2->pos.x);
-					x_end = FFMAX(x_end, cur2->bbox.xMax + cur2->pos.x);
-				}
+    tm_current = render_priv->time - render_priv->state.event->Start;
+    timing = 0;
+    s1 = s2 = 0;
+    for (i = 0; i <= render_priv->text_info.length; ++i) {
+        cur = render_priv->text_info.glyphs + i;
+        if ((i == render_priv->text_info.length)
+            || (cur->effect_type != EF_NONE)) {
+            s1 = s2;
+            s2 = cur;
+            if (s1) {
+                e1 = s2 - 1;
+                tm_start = timing + s1->effect_skip_timing;
+                tm_end = tm_start + s1->effect_timing;
+                timing = tm_end;
+                x_start = 1000000;
+                x_end = -1000000;
+                for (cur2 = s1; cur2 <= e1; ++cur2) {
+                    x_start = FFMIN(x_start, d6_to_int(cur2->bbox.xMin + cur2->pos.x));
+                    x_end = FFMAX(x_end, d6_to_int(cur2->bbox.xMax + cur2->pos.x));
+                }
 
-				dt = (tm_current - tm_start);
-				if ((s1->effect_type == EF_KARAOKE) || (s1->effect_type == EF_KARAOKE_KO)) {
-					if (dt > 0)
-						x = x_end + 1;
-					else
-						x = x_start;
-				} else if (s1->effect_type == EF_KARAOKE_KF) {
-					dt /= (tm_end - tm_start);
-					x = x_start + (x_end - x_start) * dt;
-				} else {
-					mp_msg(MSGT_ASS, MSGL_ERR, MSGTR_LIBASS_UnknownEffectType_InternalError);
-					continue;
-				}
+                dt = (tm_current - tm_start);
+                if ((s1->effect_type == EF_KARAOKE)
+                    || (s1->effect_type == EF_KARAOKE_KO)) {
+                    if (dt > 0)
+                        x = x_end + 1;
+                    else
+                        x = x_start;
+                } else if (s1->effect_type == EF_KARAOKE_KF) {
+                    dt /= (tm_end - tm_start);
+                    x = x_start + (x_end - x_start) * dt;
+                } else {
+                    ass_msg(render_priv->library, MSGL_ERR,
+                            "Unknown effect type");
+                    continue;
+                }
 
-				for (cur2 = s1; cur2 <= e1; ++cur2) {
-					cur2->effect_type = s1->effect_type;
-					cur2->effect_timing = x - cur2->pos.x;
-				}
-			}
-		}
-	}
+                for (cur2 = s1; cur2 <= e1; ++cur2) {
+                    cur2->effect_type = s1->effect_type;
+                    cur2->effect_timing = x - d6_to_int(cur2->pos.x);
+                }
+            }
+        }
+    }
 }
 
 /**
@@ -1555,723 +1654,755 @@
  * \param alignment alignment
  * \param bx, by out: base point coordinates
  */
-static void get_base_point(FT_BBox bbox, int alignment, int* bx, int* by)
+static void get_base_point(DBBox *bbox, int alignment, double *bx, double *by)
 {
-	const int halign = alignment & 3;
-	const int valign = alignment & 12;
-	if (bx)
-		switch(halign) {
-		case HALIGN_LEFT:
-			*bx = bbox.xMin;
-			break;
-		case HALIGN_CENTER:
-			*bx = (bbox.xMax + bbox.xMin) / 2;
-			break;
-		case HALIGN_RIGHT:
-			*bx = bbox.xMax;
-			break;
-		}
-	if (by)
-		switch(valign) {
-		case VALIGN_TOP:
-			*by = bbox.yMin;
-			break;
-		case VALIGN_CENTER:
-			*by = (bbox.yMax + bbox.yMin) / 2;
-			break;
-		case VALIGN_SUB:
-			*by = bbox.yMax;
-			break;
-		}
+    const int halign = alignment & 3;
+    const int valign = alignment & 12;
+    if (bx)
+        switch (halign) {
+        case HALIGN_LEFT:
+            *bx = bbox->xMin;
+            break;
+        case HALIGN_CENTER:
+            *bx = (bbox->xMax + bbox->xMin) / 2.0;
+            break;
+        case HALIGN_RIGHT:
+            *bx = bbox->xMax;
+            break;
+        }
+    if (by)
+        switch (valign) {
+        case VALIGN_TOP:
+            *by = bbox->yMin;
+            break;
+        case VALIGN_CENTER:
+            *by = (bbox->yMax + bbox->yMin) / 2.0;
+            break;
+        case VALIGN_SUB:
+            *by = bbox->yMax;
+            break;
+        }
 }
 
 /**
- * \brief Multiply 4-vector by 4-matrix
- * \param a 4-vector
- * \param m 4-matrix]
- * \param b out: 4-vector
- * Calculates a * m and stores result in b
+ * Prepare bitmap hash key of a glyph
  */
-static inline void transform_point_3d(double *a, double *m, double *b)
+static void
+fill_bitmap_hash(ASS_Renderer *priv, BitmapHashKey *hash_key,
+                 ASS_Drawing *drawing, FT_Vector pen, uint32_t code)
 {
-	b[0] = a[0] * m[0] + a[1] * m[4] + a[2] * m[8] +  a[3] * m[12];
-	b[1] = a[0] * m[1] + a[1] * m[5] + a[2] * m[9] +  a[3] * m[13];
-	b[2] = a[0] * m[2] + a[1] * m[6] + a[2] * m[10] + a[3] * m[14];
-	b[3] = a[0] * m[3] + a[1] * m[7] + a[2] * m[11] + a[3] * m[15];
+    if (!drawing->hash) {
+        hash_key->font = priv->state.font;
+        hash_key->size = priv->state.font_size;
+        hash_key->bold = priv->state.bold;
+        hash_key->italic = priv->state.italic;
+    } else {
+        hash_key->drawing_hash = drawing->hash;
+        hash_key->size = drawing->scale;
+    }
+    hash_key->ch = code;
+    hash_key->outline.x = double_to_d16(priv->state.border_x);
+    hash_key->outline.y = double_to_d16(priv->state.border_y);
+    hash_key->scale_x = double_to_d16(priv->state.scale_x);
+    hash_key->scale_y = double_to_d16(priv->state.scale_y);
+    hash_key->frx = rot_key(priv->state.frx);
+    hash_key->fry = rot_key(priv->state.fry);
+    hash_key->frz = rot_key(priv->state.frz);
+    hash_key->fax = double_to_d16(priv->state.fax);
+    hash_key->fay = double_to_d16(priv->state.fay);
+    hash_key->be = priv->state.be;
+    hash_key->blur = priv->state.blur;
+    hash_key->border_style = priv->state.style->BorderStyle;
+    hash_key->shadow_offset.x = double_to_d6(
+            priv->state.shadow_x * priv->border_scale -
+            (int) (priv->state.shadow_x * priv->border_scale));
+    hash_key->shadow_offset.y = double_to_d6(
+            priv->state.shadow_y * priv->border_scale -
+            (int) (priv->state.shadow_y * priv->border_scale));
+    hash_key->flags = priv->state.flags;
 }
 
 /**
- * \brief Apply 3d transformation to a vector
- * \param v FreeType vector (2d)
- * \param m 4-matrix
- * Transforms v by m, projects the result back to the screen plane
- * Result is returned in v.
+ * \brief Main ass rendering function, glues everything together
+ * \param event event to render
+ * \param event_images struct containing resulting images, will also be initialized
+ * Process event, appending resulting ASS_Image's to images_root.
  */
-static inline void transform_vector_3d(FT_Vector* v, double *m) {
-	const double camera = 2500 * frame_context.border_scale; // camera distance
-	double a[4], b[4];
-	a[0] = d6_to_double(v->x);
-	a[1] = d6_to_double(v->y);
-	a[2] = 0.;
-	a[3] = 1.;
-	transform_point_3d(a, m, b);
-	/* Apply perspective projection with the following matrix:
-	   2500     0     0     0
-	      0  2500     0     0
-	      0     0     0     0
-	      0     0     8     2500
-	   where 2500 is camera distance, 8 - z-axis scale.
-	   Camera is always located in (org_x, org_y, -2500). This means
-	   that different subtitle events can be displayed at the same time
-	   using different cameras. */
-	b[0] *= camera;
-	b[1] *= camera;
-	b[3] = 8 * b[2] + camera;
-	if (b[3] < 0.001 && b[3] > -0.001)
-		b[3] = b[3] < 0. ? -0.001 : 0.001;
-	v->x = double_to_d6(b[0] / b[3]);
-	v->y = double_to_d6(b[1] / b[3]);
-}
+static int
+ass_render_event(ASS_Renderer *render_priv, ASS_Event *event,
+                 EventImages *event_images)
+{
+    char *p;
+    FT_UInt previous;
+    FT_UInt num_glyphs;
+    FT_Vector pen;
+    unsigned code;
+    DBBox bbox;
+    int i, j;
+    int MarginL, MarginR, MarginV;
+    int last_break;
+    int alignment, halign, valign;
+    int kern = render_priv->track->Kerning;
+    double device_x = 0;
+    double device_y = 0;
+    TextInfo *text_info = &render_priv->text_info;
+    GlyphInfo *glyphs = render_priv->text_info.glyphs;
+    ASS_Drawing *drawing;
 
-/**
- * \brief Apply 3d transformation to a glyph
- * \param glyph FreeType glyph
- * \param m 4-matrix
- * Transforms glyph by m, projects the result back to the screen plane
- * Result is returned in glyph.
- */
-static inline void transform_glyph_3d(FT_Glyph glyph, double *m, FT_Vector shift) {
-	int i;
-	FT_Outline* outline = &((FT_OutlineGlyph)glyph)->outline;
-	FT_Vector* p = outline->points;
+    if (event->Style >= render_priv->track->n_styles) {
+        ass_msg(render_priv->library, MSGL_WARN, "No style found");
+        return 1;
+    }
+    if (!event->Text) {
+        ass_msg(render_priv->library, MSGL_WARN, "Empty event");
+        return 1;
+    }
 
-	for (i=0; i<outline->n_points; i++) {
-		p[i].x += shift.x;
-		p[i].y += shift.y;
-		transform_vector_3d(p + i, m);
-		p[i].x -= shift.x;
-		p[i].y -= shift.y;
-	}
+    init_render_context(render_priv, event);
 
-	//transform_vector_3d(&glyph->advance, m);
-}
+    drawing = render_priv->state.drawing;
+    text_info->length = 0;
+    pen.x = 0;
+    pen.y = 0;
+    previous = 0;
+    num_glyphs = 0;
+    p = event->Text;
+    // Event parsing.
+    while (1) {
+        // get next char, executing style override
+        // this affects render_context
+        do {
+            code = get_next_char(render_priv, &p);
+            if (render_priv->state.drawing_mode && code)
+                ass_drawing_add_char(drawing, (char) code);
+        } while (code && render_priv->state.drawing_mode);      // skip everything in drawing mode
 
-/**
- * \brief Apply 3d transformation to several objects
- * \param shift FreeType vector
- * \param glyph FreeType glyph
- * \param glyph2 FreeType glyph
- * \param frx x-axis rotation angle
- * \param fry y-axis rotation angle
- * \param frz z-axis rotation angle
- * Rotates both glyphs by frx, fry and frz. Shift vector is added before rotation and subtracted after it.
- */
-static void transform_3d(FT_Vector shift, FT_Glyph* glyph, FT_Glyph* glyph2, double frx, double fry, double frz)
-{
-	fry = - fry; // FreeType's y axis goes in the opposite direction
-	if (frx != 0. || fry != 0. || frz != 0.) {
-		double m[16];
-		double sx = sin(frx);
-		double sy = sin(fry);
- 		double sz = sin(frz);
-		double cx = cos(frx);
-		double cy = cos(fry);
-		double cz = cos(frz);
-		m[0] = cy * cz;            m[1] = cy*sz;              m[2]  = -sy;    m[3] = 0.0;
-		m[4] = -cx*sz + sx*sy*cz;  m[5] = cx*cz + sx*sy*sz;   m[6]  = sx*cy;  m[7] = 0.0;
-		m[8] = sx*sz + cx*sy*cz;   m[9] = -sx*cz + cx*sy*sz;  m[10] = cx*cy;  m[11] = 0.0;
-		m[12] = 0.0;               m[13] = 0.0;               m[14] = 0.0;    m[15] = 1.0;
+        // Parse drawing
+        if (drawing->i) {
+            drawing->scale_x = render_priv->state.scale_x *
+                                     render_priv->font_scale;
+            drawing->scale_y = render_priv->state.scale_y *
+                                     render_priv->font_scale;
+            ass_drawing_hash(drawing);
+            p--;
+            code = -1;
+        }
 
-		if (glyph && *glyph)
-			transform_glyph_3d(*glyph, m, shift);
+        // face could have been changed in get_next_char
+        if (!render_priv->state.font) {
+            free_render_context(render_priv);
+            return 1;
+        }
 
-		if (glyph2 && *glyph2)
-			transform_glyph_3d(*glyph2, m, shift);
-	}
-}
+        if (code == 0)
+            break;
 
-/**
- * \brief Main ass rendering function, glues everything together
- * \param event event to render
- * Process event, appending resulting ass_image_t's to images_root.
- */
-static int ass_render_event(ass_event_t* event, event_images_t* event_images)
-{
-	char* p;
-	FT_UInt previous; 
-	FT_UInt num_glyphs;
-	FT_Vector pen;
-	unsigned code;
-	FT_BBox bbox;
-	int i, j;
-	FT_Vector shift;
-	int MarginL, MarginR, MarginV;
-	int last_break;
-	int alignment, halign, valign;
-	int device_x = 0, device_y = 0;
+        if (text_info->length >= text_info->max_glyphs) {
+            // Raise maximum number of glyphs
+            text_info->max_glyphs *= 2;
+            text_info->glyphs = glyphs =
+                realloc(text_info->glyphs,
+                        sizeof(GlyphInfo) * text_info->max_glyphs);
+        }
 
-	if (event->Style >= frame_context.track->n_styles) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NoStyleFound);
-		return 1;
-	}
-	if (!event->Text) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_EmptyEvent);
-		return 1;
-	}
+        // Add kerning to pen
+        if (kern && previous && code && !drawing->hash) {
+            FT_Vector delta;
+            delta =
+                ass_font_get_kerning(render_priv->state.font, previous,
+                                     code);
+            pen.x += delta.x * render_priv->state.scale_x;
+            pen.y += delta.y * render_priv->state.scale_y;
+        }
 
-	init_render_context(event);
+        ass_font_set_transform(render_priv->state.font,
+                               render_priv->state.scale_x,
+                               render_priv->state.scale_y, NULL);
 
-	text_info.length = 0;
-	pen.x = 0;
-	pen.y = 0;
-	previous = 0;
-	num_glyphs = 0;
-	p = event->Text;
-	// Event parsing.
-	while (1) {
-		// get next char, executing style override
-		// this affects render_context
-		code = get_next_char(&p);
-		
-		// face could have been changed in get_next_char
-		if (!render_context.font) {
-			free_render_context();
-			return 1;
-		}
+        get_outline_glyph(render_priv, code,
+                          glyphs + text_info->length, drawing);
 
-		if (code == 0)
-			break;
+        // Add additional space after italic to non-italic style changes
+        if (text_info->length &&
+            glyphs[text_info->length - 1].hash_key.italic &&
+            !render_priv->state.italic) {
+            int back = text_info->length - 1;
+            GlyphInfo *og = &glyphs[back];
+            while (back && og->bbox.xMax - og->bbox.xMin == 0
+                   && og->hash_key.italic)
+                og = &glyphs[--back];
+            if (og->bbox.xMax > og->advance.x) {
+                // The FreeType oblique slants by 6/16
+                pen.x += og->bbox.yMax * 0.375;
+            }
+        }
 
-		if (text_info.length >= MAX_GLYPHS) {
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_MAX_GLYPHS_Reached, 
-					(int)(event - frame_context.track->events), event->Start, event->Duration, event->Text);
-			break;
-		}
+        glyphs[text_info->length].pos.x = pen.x;
+        glyphs[text_info->length].pos.y = pen.y;
 
-		if ( previous && code ) {
-			FT_Vector delta;
-			delta = ass_font_get_kerning(render_context.font, previous, code);
-			pen.x += delta.x * render_context.scale_x;
-			pen.y += delta.y * render_context.scale_y;
-		}
+        pen.x += glyphs[text_info->length].advance.x;
+        pen.x += double_to_d6(render_priv->state.hspacing *
+                              render_priv->font_scale
+                              * render_priv->state.scale_x);
+        pen.y += glyphs[text_info->length].advance.y;
+        pen.y += (render_priv->state.fay * render_priv->state.scale_y) *
+                 glyphs[text_info->length].advance.x;
 
-		shift.x = pen.x & 63;
-		shift.y = pen.y & 63;
+        previous = code;
 
-		ass_font_set_transform(render_context.font,
-				       render_context.scale_x * frame_context.font_scale_x,
-				       render_context.scale_y,
-				       &shift );
+        glyphs[text_info->length].symbol = code;
+        glyphs[text_info->length].linebreak = 0;
+        for (i = 0; i < 4; ++i) {
+            uint32_t clr = render_priv->state.c[i];
+            change_alpha(&clr,
+                         mult_alpha(_a(clr), render_priv->state.fade), 1.);
+            glyphs[text_info->length].c[i] = clr;
+        }
+        glyphs[text_info->length].effect_type = render_priv->state.effect_type;
+        glyphs[text_info->length].effect_timing =
+            render_priv->state.effect_timing;
+        glyphs[text_info->length].effect_skip_timing =
+            render_priv->state.effect_skip_timing;
+        glyphs[text_info->length].be = render_priv->state.be;
+        glyphs[text_info->length].blur = render_priv->state.blur;
+        glyphs[text_info->length].shadow_x = render_priv->state.shadow_x;
+        glyphs[text_info->length].shadow_y = render_priv->state.shadow_y;
+        glyphs[text_info->length].frx = render_priv->state.frx;
+        glyphs[text_info->length].fry = render_priv->state.fry;
+        glyphs[text_info->length].frz = render_priv->state.frz;
+        glyphs[text_info->length].fax = render_priv->state.fax;
+        glyphs[text_info->length].fay = render_priv->state.fay;
+        if (drawing->hash) {
+            glyphs[text_info->length].asc = drawing->asc;
+            glyphs[text_info->length].desc = drawing->desc;
+        } else {
+            ass_font_get_asc_desc(render_priv->state.font, code,
+                                  &glyphs[text_info->length].asc,
+                                  &glyphs[text_info->length].desc);
 
-		get_outline_glyph(code, text_info.glyphs + text_info.length, &shift);
-		
-		text_info.glyphs[text_info.length].pos.x = pen.x >> 6;
-		text_info.glyphs[text_info.length].pos.y = pen.y >> 6;
-		
-		pen.x += text_info.glyphs[text_info.length].advance.x;
-		pen.x += double_to_d6(render_context.hspacing);
-		pen.y += text_info.glyphs[text_info.length].advance.y;
-		
-		previous = code;
+            glyphs[text_info->length].asc *= render_priv->state.scale_y;
+            glyphs[text_info->length].desc *= render_priv->state.scale_y;
+        }
 
-		text_info.glyphs[text_info.length].symbol = code;
-		text_info.glyphs[text_info.length].linebreak = 0;
-		for (i = 0; i < 4; ++i) {
-			uint32_t clr = render_context.c[i];
-			change_alpha(&clr, mult_alpha(_a(clr), render_context.fade), 1.);
-			text_info.glyphs[text_info.length].c[i] = clr;
-		}
-		text_info.glyphs[text_info.length].effect_type = render_context.effect_type;
-		text_info.glyphs[text_info.length].effect_timing = render_context.effect_timing;
-		text_info.glyphs[text_info.length].effect_skip_timing = render_context.effect_skip_timing;
-		text_info.glyphs[text_info.length].be = render_context.be;
-		text_info.glyphs[text_info.length].shadow = render_context.shadow;
-		text_info.glyphs[text_info.length].frx = render_context.frx;
-		text_info.glyphs[text_info.length].fry = render_context.fry;
-		text_info.glyphs[text_info.length].frz = render_context.frz;
-		ass_font_get_asc_desc(render_context.font, code,
-				      &text_info.glyphs[text_info.length].asc,
-				      &text_info.glyphs[text_info.length].desc);
-		text_info.glyphs[text_info.length].asc *= render_context.scale_y;
-		text_info.glyphs[text_info.length].desc *= render_context.scale_y;
+        // fill bitmap hash
+        fill_bitmap_hash(render_priv, &glyphs[text_info->length].hash_key,
+                         drawing, pen, code);
 
-		// fill bitmap_hash_key
-		text_info.glyphs[text_info.length].hash_key.font = render_context.font;
-		text_info.glyphs[text_info.length].hash_key.size = render_context.font_size;
-		text_info.glyphs[text_info.length].hash_key.outline = render_context.border * 0xFFFF;
-		text_info.glyphs[text_info.length].hash_key.scale_x = render_context.scale_x * 0xFFFF;
-		text_info.glyphs[text_info.length].hash_key.scale_y = render_context.scale_y * 0xFFFF;
-		text_info.glyphs[text_info.length].hash_key.frx = render_context.frx * 0xFFFF;
-		text_info.glyphs[text_info.length].hash_key.fry = render_context.fry * 0xFFFF;
-		text_info.glyphs[text_info.length].hash_key.frz = render_context.frz * 0xFFFF;
-		text_info.glyphs[text_info.length].hash_key.bold = render_context.bold;
-		text_info.glyphs[text_info.length].hash_key.italic = render_context.italic;
-		text_info.glyphs[text_info.length].hash_key.ch = code;
-		text_info.glyphs[text_info.length].hash_key.advance = shift;
-		text_info.glyphs[text_info.length].hash_key.be = render_context.be;
+        text_info->length++;
 
-		text_info.length++;
+        render_priv->state.effect_type = EF_NONE;
+        render_priv->state.effect_timing = 0;
+        render_priv->state.effect_skip_timing = 0;
 
-		render_context.effect_type = EF_NONE;
-		render_context.effect_timing = 0;
-		render_context.effect_skip_timing = 0;
-	}
-	
-	if (text_info.length == 0) {
-		// no valid symbols in the event; this can be smth like {comment}
-		free_render_context();
-		return 1;
-	}
-	
-	// depends on glyph x coordinates being monotonous, so it should be done before line wrap
-	process_karaoke_effects();
-	
-	// alignments
-	alignment = render_context.alignment;
-	halign = alignment & 3;
-	valign = alignment & 12;
+        if (drawing->hash) {
+            ass_drawing_free(drawing);
+            drawing = render_priv->state.drawing =
+                ass_drawing_new(render_priv->fontconfig_priv,
+                    render_priv->state.font,
+                    render_priv->ftlibrary);
+        }
+    }
 
-	MarginL = (event->MarginL) ? event->MarginL : render_context.style->MarginL; 
-	MarginR = (event->MarginR) ? event->MarginR : render_context.style->MarginR; 
-	MarginV = (event->MarginV) ? event->MarginV : render_context.style->MarginV;
 
-	if (render_context.evt_type != EVENT_HSCROLL) {
-		int max_text_width;
+    if (text_info->length == 0) {
+        // no valid symbols in the event; this can be smth like {comment}
+        free_render_context(render_priv);
+        return 1;
+    }
 
-		// calculate max length of a line
-		max_text_width = x2scr(frame_context.track->PlayResX - MarginR) - x2scr(MarginL);
+    // depends on glyph x coordinates being monotonous, so it should be done before line wrap
+    process_karaoke_effects(render_priv);
 
-		// rearrange text in several lines
-		wrap_lines_smart(max_text_width);
+    // alignments
+    alignment = render_priv->state.alignment;
+    halign = alignment & 3;
+    valign = alignment & 12;
 
-		// align text
-		last_break = -1;
-		for (i = 1; i < text_info.length + 1; ++i) { // (text_info.length + 1) is the end of the last line
-			if ((i == text_info.length) || text_info.glyphs[i].linebreak) {
-				int width, shift = 0;
-				glyph_info_t* first_glyph = text_info.glyphs + last_break + 1;
-				glyph_info_t* last_glyph = text_info.glyphs + i - 1;
+    MarginL =
+        (event->MarginL) ? event->MarginL : render_priv->state.style->MarginL;
+    MarginR =
+        (event->MarginR) ? event->MarginR : render_priv->state.style->MarginR;
+    MarginV =
+        (event->MarginV) ? event->MarginV : render_priv->state.style->MarginV;
 
-				while ((last_glyph > first_glyph) && ((last_glyph->symbol == '\n') || (last_glyph->symbol == 0)))
-					last_glyph --;
+    if (render_priv->state.evt_type != EVENT_HSCROLL) {
+        double max_text_width;
 
-				width = last_glyph->pos.x + d6_to_int(last_glyph->advance.x) - first_glyph->pos.x;
-				if (halign == HALIGN_LEFT) { // left aligned, no action
-					shift = 0;
-				} else if (halign == HALIGN_RIGHT) { // right aligned
-					shift = max_text_width - width;
-				} else if (halign == HALIGN_CENTER) { // centered
-					shift = (max_text_width - width) / 2;
-				}
-				for (j = last_break + 1; j < i; ++j) {
-					text_info.glyphs[j].pos.x += shift;
-				}
-				last_break = i - 1;
-			}
-		}
-	} else { // render_context.evt_type == EVENT_HSCROLL
-		measure_text();
-	}
-	
-	// determing text bounding box
-	compute_string_bbox(&text_info, &bbox);
-	
-	// determine device coordinates for text
-	
-	// x coordinate for everything except positioned events
-	if (render_context.evt_type == EVENT_NORMAL ||
-	    render_context.evt_type == EVENT_VSCROLL) {
-		device_x = x2scr(MarginL);
-	} else if (render_context.evt_type == EVENT_HSCROLL) {
-		if (render_context.scroll_direction == SCROLL_RL)
-			device_x = x2scr(frame_context.track->PlayResX - render_context.scroll_shift);
-		else if (render_context.scroll_direction == SCROLL_LR)
-			device_x = x2scr(render_context.scroll_shift) - (bbox.xMax - bbox.xMin);
-	}
+        // calculate max length of a line
+        max_text_width =
+            x2scr(render_priv,
+                  render_priv->track->PlayResX - MarginR) -
+            x2scr(render_priv, MarginL);
 
-	// y coordinate for everything except positioned events
-	if (render_context.evt_type == EVENT_NORMAL ||
-	    render_context.evt_type == EVENT_HSCROLL) {
-		if (valign == VALIGN_TOP) { // toptitle
-			device_y = y2scr_top(MarginV) + d6_to_int(text_info.lines[0].asc);
-		} else if (valign == VALIGN_CENTER) { // midtitle
-			int scr_y = y2scr(frame_context.track->PlayResY / 2);
-			device_y = scr_y - (bbox.yMax - bbox.yMin) / 2;
-		} else { // subtitle
-			int scr_y;
-			if (valign != VALIGN_SUB)
-				mp_msg(MSGT_ASS, MSGL_V, "Invalid valign, supposing 0 (subtitle)\n");
-			scr_y = y2scr_sub(frame_context.track->PlayResY - MarginV);
-			device_y = scr_y;
-			device_y -= d6_to_int(text_info.height);
-			device_y += d6_to_int(text_info.lines[0].asc);
-		}
-	} else if (render_context.evt_type == EVENT_VSCROLL) {
-		if (render_context.scroll_direction == SCROLL_TB)
-			device_y = y2scr(render_context.clip_y0 + render_context.scroll_shift) - (bbox.yMax - bbox.yMin);
-		else if (render_context.scroll_direction == SCROLL_BT)
-			device_y = y2scr(render_context.clip_y1 - render_context.scroll_shift);
-	}
+        // rearrange text in several lines
+        wrap_lines_smart(render_priv, max_text_width);
 
-	// positioned events are totally different
-	if (render_context.evt_type == EVENT_POSITIONED) {
-		int base_x = 0;
-		int base_y = 0;
-		mp_msg(MSGT_ASS, MSGL_DBG2, "positioned event at %d, %d\n", render_context.pos_x, render_context.pos_y);
-		get_base_point(bbox, alignment, &base_x, &base_y);
-		device_x = x2scr(render_context.pos_x) - base_x;
-		device_y = y2scr(render_context.pos_y) - base_y;
-	}
-	
-	// fix clip coordinates (they depend on alignment)
-	render_context.clip_x0 = x2scr(render_context.clip_x0);
-	render_context.clip_x1 = x2scr(render_context.clip_x1);
-	if (render_context.evt_type == EVENT_NORMAL ||
-	    render_context.evt_type == EVENT_HSCROLL ||
-	    render_context.evt_type == EVENT_VSCROLL) {
-		if (valign == VALIGN_TOP) {
-			render_context.clip_y0 = y2scr_top(render_context.clip_y0);
-			render_context.clip_y1 = y2scr_top(render_context.clip_y1);
-		} else if (valign == VALIGN_CENTER) {
-			render_context.clip_y0 = y2scr(render_context.clip_y0);
-			render_context.clip_y1 = y2scr(render_context.clip_y1);
-		} else if (valign == VALIGN_SUB) {
-			render_context.clip_y0 = y2scr_sub(render_context.clip_y0);
-			render_context.clip_y1 = y2scr_sub(render_context.clip_y1);
-		}
-	} else if (render_context.evt_type == EVENT_POSITIONED) {
-		render_context.clip_y0 = y2scr(render_context.clip_y0);
-		render_context.clip_y1 = y2scr(render_context.clip_y1);
-	}
+        // align text
+        last_break = -1;
+        for (i = 1; i < text_info->length + 1; ++i) {   // (text_info->length + 1) is the end of the last line
+            if ((i == text_info->length)
+                || glyphs[i].linebreak) {
+                double width, shift = 0;
+                GlyphInfo *first_glyph =
+                    glyphs + last_break + 1;
+                GlyphInfo *last_glyph = glyphs + i - 1;
 
-	// calculate rotation parameters
-	{
-		FT_Vector center;
-		
-		if (render_context.have_origin) {
-			center.x = x2scr(render_context.org_x);
-			center.y = y2scr(render_context.org_y);
-		} else {
-			int bx, by;
-			get_base_point(bbox, alignment, &bx, &by);
-			center.x = device_x + bx;
-			center.y = device_y + by;
-		}
+                while (first_glyph < last_glyph && first_glyph->skip)
+                    first_glyph++;
 
-		for (i = 0; i < text_info.length; ++i) {
-			glyph_info_t* info = text_info.glyphs + i;
+                while ((last_glyph > first_glyph)
+                       && ((last_glyph->symbol == '\n')
+                           || (last_glyph->symbol == 0)
+                           || (last_glyph->skip)))
+                    last_glyph--;
 
-			if (info->hash_key.frx || info->hash_key.fry || info->hash_key.frz) {
-				info->hash_key.shift_x = info->pos.x + device_x - center.x;
-				info->hash_key.shift_y = - (info->pos.y + device_y - center.y);
-			} else {
-				info->hash_key.shift_x = 0;
-				info->hash_key.shift_y = 0;
-			}
-		}
-	}
+                width = d6_to_double(
+                    last_glyph->pos.x + last_glyph->advance.x -
+                    first_glyph->pos.x);
+                if (halign == HALIGN_LEFT) {    // left aligned, no action
+                    shift = 0;
+                } else if (halign == HALIGN_RIGHT) {    // right aligned
+                    shift = max_text_width - width;
+                } else if (halign == HALIGN_CENTER) {   // centered
+                    shift = (max_text_width - width) / 2.0;
+                }
+                for (j = last_break + 1; j < i; ++j) {
+                    glyphs[j].pos.x += double_to_d6(shift);
+                }
+                last_break = i - 1;
+            }
+        }
+    } else {                    // render_priv->state.evt_type == EVENT_HSCROLL
+        measure_text(render_priv);
+    }
 
-	// convert glyphs to bitmaps
-	for (i = 0; i < text_info.length; ++i)
-		get_bitmap_glyph(text_info.glyphs + i);
+    // determing text bounding box
+    compute_string_bbox(text_info, &bbox);
 
-	event_images->top = device_y - d6_to_int(text_info.lines[0].asc);
-	event_images->height = d6_to_int(text_info.height);
-	event_images->detect_collisions = render_context.detect_collisions;
-	event_images->shift_direction = (valign == VALIGN_TOP) ? 1 : -1;
-	event_images->event = event;
-	event_images->imgs = render_text(&text_info, device_x, device_y);
+    // determine device coordinates for text
 
-	free_render_context();
-	
-	return 0;
+    // x coordinate for everything except positioned events
+    if (render_priv->state.evt_type == EVENT_NORMAL ||
+        render_priv->state.evt_type == EVENT_VSCROLL) {
+        device_x = x2scr(render_priv, MarginL);
+    } else if (render_priv->state.evt_type == EVENT_HSCROLL) {
+        if (render_priv->state.scroll_direction == SCROLL_RL)
+            device_x =
+                x2scr(render_priv,
+                      render_priv->track->PlayResX -
+                      render_priv->state.scroll_shift);
+        else if (render_priv->state.scroll_direction == SCROLL_LR)
+            device_x =
+                x2scr(render_priv,
+                      render_priv->state.scroll_shift) - (bbox.xMax -
+                                                          bbox.xMin);
+    }
+
+    // y coordinate for everything except positioned events
+    if (render_priv->state.evt_type == EVENT_NORMAL ||
+        render_priv->state.evt_type == EVENT_HSCROLL) {
+        if (valign == VALIGN_TOP) {     // toptitle
+            device_y =
+                y2scr_top(render_priv,
+                          MarginV) + text_info->lines[0].asc;
+        } else if (valign == VALIGN_CENTER) {   // midtitle
+            double scr_y =
+                y2scr(render_priv, render_priv->track->PlayResY / 2.0);
+            device_y = scr_y - (bbox.yMax + bbox.yMin) / 2.0;
+        } else {                // subtitle
+            double scr_y;
+            if (valign != VALIGN_SUB)
+                ass_msg(render_priv->library, MSGL_V,
+                       "Invalid valign, assuming 0 (subtitle)");
+            scr_y =
+                y2scr_sub(render_priv,
+                          render_priv->track->PlayResY - MarginV);
+            device_y = scr_y;
+            device_y -= text_info->height;
+            device_y += text_info->lines[0].asc;
+        }
+    } else if (render_priv->state.evt_type == EVENT_VSCROLL) {
+        if (render_priv->state.scroll_direction == SCROLL_TB)
+            device_y =
+                y2scr(render_priv,
+                      render_priv->state.clip_y0 +
+                      render_priv->state.scroll_shift) - (bbox.yMax -
+                                                          bbox.yMin);
+        else if (render_priv->state.scroll_direction == SCROLL_BT)
+            device_y =
+                y2scr(render_priv,
+                      render_priv->state.clip_y1 -
+                      render_priv->state.scroll_shift);
+    }
+
+    // positioned events are totally different
+    if (render_priv->state.evt_type == EVENT_POSITIONED) {
+        double base_x = 0;
+        double base_y = 0;
+        ass_msg(render_priv->library, MSGL_DBG2, "positioned event at %f, %f",
+               render_priv->state.pos_x, render_priv->state.pos_y);
+        get_base_point(&bbox, alignment, &base_x, &base_y);
+        device_x =
+            x2scr_pos(render_priv, render_priv->state.pos_x) - base_x;
+        device_y =
+            y2scr_pos(render_priv, render_priv->state.pos_y) - base_y;
+    }
+
+    // fix clip coordinates (they depend on alignment)
+    if (render_priv->state.evt_type == EVENT_NORMAL ||
+        render_priv->state.evt_type == EVENT_HSCROLL ||
+        render_priv->state.evt_type == EVENT_VSCROLL) {
+        render_priv->state.clip_x0 =
+            x2scr_scaled(render_priv, render_priv->state.clip_x0);
+        render_priv->state.clip_x1 =
+            x2scr_scaled(render_priv, render_priv->state.clip_x1);
+        if (valign == VALIGN_TOP) {
+            render_priv->state.clip_y0 =
+                y2scr_top(render_priv, render_priv->state.clip_y0);
+            render_priv->state.clip_y1 =
+                y2scr_top(render_priv, render_priv->state.clip_y1);
+        } else if (valign == VALIGN_CENTER) {
+            render_priv->state.clip_y0 =
+                y2scr(render_priv, render_priv->state.clip_y0);
+            render_priv->state.clip_y1 =
+                y2scr(render_priv, render_priv->state.clip_y1);
+        } else if (valign == VALIGN_SUB) {
+            render_priv->state.clip_y0 =
+                y2scr_sub(render_priv, render_priv->state.clip_y0);
+            render_priv->state.clip_y1 =
+                y2scr_sub(render_priv, render_priv->state.clip_y1);
+        }
+    } else if (render_priv->state.evt_type == EVENT_POSITIONED) {
+        render_priv->state.clip_x0 =
+            x2scr_pos_scaled(render_priv, render_priv->state.clip_x0);
+        render_priv->state.clip_x1 =
+            x2scr_pos_scaled(render_priv, render_priv->state.clip_x1);
+        render_priv->state.clip_y0 =
+            y2scr_pos(render_priv, render_priv->state.clip_y0);
+        render_priv->state.clip_y1 =
+            y2scr_pos(render_priv, render_priv->state.clip_y1);
+    }
+
+    // calculate rotation parameters
+    {
+        DVector center;
+
+        if (render_priv->state.have_origin) {
+            center.x = x2scr(render_priv, render_priv->state.org_x);
+            center.y = y2scr(render_priv, render_priv->state.org_y);
+        } else {
+            double bx = 0., by = 0.;
+            get_base_point(&bbox, alignment, &bx, &by);
+            center.x = device_x + bx;
+            center.y = device_y + by;
+        }
+
+        for (i = 0; i < text_info->length; ++i) {
+            GlyphInfo *info = glyphs + i;
+
+            if (info->hash_key.frx || info->hash_key.fry
+                || info->hash_key.frz || info->hash_key.fax
+                || info->hash_key.fay) {
+                info->hash_key.shift_x = info->pos.x + double_to_d6(device_x - center.x);
+                info->hash_key.shift_y =
+                    -(info->pos.y + double_to_d6(device_y - center.y));
+            } else {
+                info->hash_key.shift_x = 0;
+                info->hash_key.shift_y = 0;
+            }
+        }
+    }
+
+    // convert glyphs to bitmaps
+    device_x *= render_priv->font_scale_x;
+    for (i = 0; i < text_info->length; ++i) {
+        GlyphInfo *g = glyphs + i;
+        g->pos.x *= render_priv->font_scale_x;
+        g->hash_key.advance.x =
+            double_to_d6(device_x - (int) device_x +
+            d6_to_double(g->pos.x & SUBPIXEL_MASK)) & ~SUBPIXEL_ACCURACY;
+        g->hash_key.advance.y =
+            double_to_d6(device_y - (int) device_y +
+            d6_to_double(g->pos.y & SUBPIXEL_MASK)) & ~SUBPIXEL_ACCURACY;
+        get_bitmap_glyph(render_priv, glyphs + i);
+    }
+
+    memset(event_images, 0, sizeof(*event_images));
+    event_images->top = device_y - text_info->lines[0].asc;
+    event_images->height = text_info->height;
+    event_images->left =
+        (device_x + bbox.xMin * render_priv->font_scale_x) + 0.5;
+    event_images->width =
+        (bbox.xMax - bbox.xMin) * render_priv->font_scale_x + 0.5;
+    event_images->detect_collisions = render_priv->state.detect_collisions;
+    event_images->shift_direction = (valign == VALIGN_TOP) ? 1 : -1;
+    event_images->event = event;
+    event_images->imgs = render_text(render_priv, (int) device_x, (int) device_y);
+
+    free_render_context(render_priv);
+
+    return 0;
 }
 
 /**
  * \brief deallocate image list
  * \param img list pointer
  */
-void ass_free_images(ass_image_t* img)
+void ass_free_images(ASS_Image *img)
 {
-	while (img) {
-		ass_image_t* next = img->next;
-		free(img);
-		img = next;
-	}
+    while (img) {
+        ASS_Image *next = img->next;
+        free(img);
+        img = next;
+    }
 }
 
-static void ass_reconfigure(ass_renderer_t* priv)
+/**
+ * \brief Check cache limits and reset cache if they are exceeded
+ */
+static void check_cache_limits(ASS_Renderer *priv, CacheStore *cache)
 {
-	priv->render_id = ++last_render_id;
-	ass_glyph_cache_reset();
-	ass_bitmap_cache_reset();
-	ass_free_images(priv->prev_images_root);
-	priv->prev_images_root = 0;
-}
+    if (cache->bitmap_cache->cache_size > cache->bitmap_max_size) {
+        ass_msg(priv->library, MSGL_V,
+                "Hitting hard bitmap cache limit (was: %ld bytes), "
+                "resetting.", (long) cache->bitmap_cache->cache_size);
+        cache->bitmap_cache = ass_bitmap_cache_reset(cache->bitmap_cache);
+        cache->composite_cache = ass_composite_cache_reset(
+            cache->composite_cache);
+        ass_free_images(priv->prev_images_root);
+        priv->prev_images_root = 0;
+    }
 
-void ass_set_frame_size(ass_renderer_t* priv, int w, int h)
-{
-	if (priv->settings.frame_width != w || priv->settings.frame_height != h) {
-		priv->settings.frame_width = w;
-		priv->settings.frame_height = h;
-		if (priv->settings.aspect == 0.)
-			priv->settings.aspect = ((double)w) / h;
-		ass_reconfigure(priv);
-	}
+    if (cache->glyph_cache->count > cache->glyph_max
+        || cache->glyph_cache->cache_size > cache->bitmap_max_size) {
+        ass_msg(priv->library, MSGL_V,
+            "Hitting hard glyph cache limit (was: %d glyphs, %ld bytes), "
+            "resetting.",
+            cache->glyph_cache->count, (long) cache->glyph_cache->cache_size);
+        cache->glyph_cache = ass_glyph_cache_reset(cache->glyph_cache);
+    }
 }
 
-void ass_set_margins(ass_renderer_t* priv, int t, int b, int l, int r)
+/**
+ * \brief Start a new frame
+ */
+static int
+ass_start_frame(ASS_Renderer *render_priv, ASS_Track *track,
+                long long now)
 {
-	if (priv->settings.left_margin != l ||
-	    priv->settings.right_margin != r ||
-	    priv->settings.top_margin != t ||
-	    priv->settings.bottom_margin != b) {
-		priv->settings.left_margin = l;
-		priv->settings.right_margin = r;
-		priv->settings.top_margin = t;
-		priv->settings.bottom_margin = b;
-		ass_reconfigure(priv);
-	}
-}
+    ASS_Settings *settings_priv = &render_priv->settings;
 
-void ass_set_use_margins(ass_renderer_t* priv, int use)
-{
-	priv->settings.use_margins = use;
-}
+    if (!render_priv->settings.frame_width
+        && !render_priv->settings.frame_height)
+        return 1;               // library not initialized
 
-void ass_set_aspect_ratio(ass_renderer_t* priv, double ar)
-{
-	if (priv->settings.aspect != ar) {
-		priv->settings.aspect = ar;
-		ass_reconfigure(priv);
-	}
-}
+    if (render_priv->library != track->library)
+        return 1;
 
-void ass_set_font_scale(ass_renderer_t* priv, double font_scale)
-{
-	if (priv->settings.font_size_coeff != font_scale) {
-		priv->settings.font_size_coeff = font_scale;
-		ass_reconfigure(priv);
-	}
-}
+    if (!render_priv->fontconfig_priv)
+        return 1;
 
-void ass_set_hinting(ass_renderer_t* priv, ass_hinting_t ht)
-{
-	if (priv->settings.hinting != ht) {
-		priv->settings.hinting = ht;
-		ass_reconfigure(priv);
-	}
-}
+    free_list_clear(render_priv);
 
-void ass_set_line_spacing(ass_renderer_t* priv, double line_spacing)
-{
-	priv->settings.line_spacing = line_spacing;
-}
+    if (track->n_events == 0)
+        return 1;               // nothing to do
 
-int ass_set_fonts(ass_renderer_t* priv, const char* default_font, const char* default_family)
-{
-	if (priv->settings.default_font)
-		free(priv->settings.default_font);
-	if (priv->settings.default_family)
-		free(priv->settings.default_family);
+    render_priv->track = track;
+    render_priv->time = now;
 
-	priv->settings.default_font = default_font ? strdup(default_font) : 0;
-	priv->settings.default_family = default_family ? strdup(default_family) : 0;
+    ass_lazy_track_init(render_priv);
 
-	if (priv->fontconfig_priv)
-		fontconfig_done(priv->fontconfig_priv);
-	priv->fontconfig_priv = fontconfig_init(priv->library, priv->ftlibrary, default_family, default_font);
+    render_priv->font_scale = settings_priv->font_size_coeff *
+        render_priv->orig_height / render_priv->track->PlayResY;
+    if (render_priv->track->ScaledBorderAndShadow)
+        render_priv->border_scale =
+            ((double) render_priv->orig_height) /
+            render_priv->track->PlayResY;
+    else
+        render_priv->border_scale = 1.;
 
-	return !!priv->fontconfig_priv;
-}
+    // PAR correction
+    render_priv->font_scale_x = render_priv->settings.aspect /
+                                render_priv->settings.storage_aspect;
 
-/**
- * \brief Start a new frame
- */
-static int ass_start_frame(ass_renderer_t *priv, ass_track_t* track, long long now)
-{
-	ass_renderer = priv;
-	global_settings = &priv->settings;
+    render_priv->prev_images_root = render_priv->images_root;
+    render_priv->images_root = 0;
 
-	if (!priv->settings.frame_width && !priv->settings.frame_height)
-		return 1; // library not initialized
-	
-	frame_context.ass_priv = priv;
-	frame_context.width = global_settings->frame_width;
-	frame_context.height = global_settings->frame_height;
-	frame_context.orig_width = global_settings->frame_width - global_settings->left_margin - global_settings->right_margin;
-	frame_context.orig_height = global_settings->frame_height - global_settings->top_margin - global_settings->bottom_margin;
-	frame_context.track = track;
-	frame_context.time = now;
+    check_cache_limits(render_priv, &render_priv->cache);
 
-	ass_lazy_track_init();
-	
-	frame_context.font_scale = global_settings->font_size_coeff *
-	                           frame_context.orig_height / frame_context.track->PlayResY;
-	frame_context.border_scale = ((double)frame_context.orig_height) / frame_context.track->PlayResY;
-
-	if (frame_context.orig_width * track->PlayResY == frame_context.orig_height * track->PlayResX)
-		frame_context.font_scale_x = 1.;
-	else
-		frame_context.font_scale_x = ((double)(frame_context.orig_width * track->PlayResY)) / (frame_context.orig_height * track->PlayResX);
-
-	priv->prev_images_root = priv->images_root;
-	priv->images_root = 0;
-
-	return 0;
+    return 0;
 }
 
-static int cmp_event_layer(const void* p1, const void* p2)
+static int cmp_event_layer(const void *p1, const void *p2)
 {
-	ass_event_t* e1 = ((event_images_t*)p1)->event;
-	ass_event_t* e2 = ((event_images_t*)p2)->event;
-	if (e1->Layer < e2->Layer)
-		return -1;
-	if (e1->Layer > e2->Layer)
-		return 1;
-	if (e1->ReadOrder < e2->ReadOrder)
-		return -1;
-	if (e1->ReadOrder > e2->ReadOrder)
-		return 1;
-	return 0;
+    ASS_Event *e1 = ((EventImages *) p1)->event;
+    ASS_Event *e2 = ((EventImages *) p2)->event;
+    if (e1->Layer < e2->Layer)
+        return -1;
+    if (e1->Layer > e2->Layer)
+        return 1;
+    if (e1->ReadOrder < e2->ReadOrder)
+        return -1;
+    if (e1->ReadOrder > e2->ReadOrder)
+        return 1;
+    return 0;
 }
 
-#define MAX_EVENTS 100
+static ASS_RenderPriv *get_render_priv(ASS_Renderer *render_priv,
+                                       ASS_Event *event)
+{
+    if (!event->render_priv)
+        event->render_priv = calloc(1, sizeof(ASS_RenderPriv));
+    if (render_priv->render_id != event->render_priv->render_id) {
+        memset(event->render_priv, 0, sizeof(ASS_RenderPriv));
+        event->render_priv->render_id = render_priv->render_id;
+    }
 
-static render_priv_t* get_render_priv(ass_event_t* event)
-{
-	if (!event->render_priv)
-		event->render_priv = calloc(1, sizeof(render_priv_t));
-	// FIXME: check render_id
-	if (ass_renderer->render_id != event->render_priv->render_id) {
-		memset(event->render_priv, 0, sizeof(render_priv_t));
-		event->render_priv->render_id = ass_renderer->render_id;
-	}
-	return event->render_priv;
+    return event->render_priv;
 }
 
-typedef struct segment_s {
-	int a, b; // top and height
-} segment_t;
-
-static int overlap(segment_t* s1, segment_t* s2)
+static int overlap(Segment *s1, Segment *s2)
 {
-	if (s1->a >= s2->b || s2->a >= s1->b)
-		return 0;
-	return 1;
+    if (s1->a >= s2->b || s2->a >= s1->b ||
+        s1->ha >= s2->hb || s2->ha >= s1->hb)
+        return 0;
+    return 1;
 }
 
-static int cmp_segment(const void* p1, const void* p2)
+static int cmp_segment(const void *p1, const void *p2)
 {
-	return ((segment_t*)p1)->a - ((segment_t*)p2)->a;
+    return ((Segment *) p1)->a - ((Segment *) p2)->a;
 }
 
-static void shift_event(event_images_t* ei, int shift)
+static void
+shift_event(ASS_Renderer *render_priv, EventImages *ei, int shift)
 {
-	ass_image_t* cur = ei->imgs;
-	while (cur) {
-		cur->dst_y += shift;
-		// clip top and bottom
-		if (cur->dst_y < 0) {
-			int clip = - cur->dst_y;
-			cur->h -= clip;
-			cur->bitmap += clip * cur->stride;
-			cur->dst_y = 0;
-		}
-		if (cur->dst_y + cur->h >= frame_context.height) {
-			int clip = cur->dst_y + cur->h - frame_context.height;
-			cur->h -= clip;
-		}
-		if (cur->h <= 0) {
-			cur->h = 0;
-			cur->dst_y = 0;
-		}
-		cur = cur->next;
-	}
-	ei->top += shift;
+    ASS_Image *cur = ei->imgs;
+    while (cur) {
+        cur->dst_y += shift;
+        // clip top and bottom
+        if (cur->dst_y < 0) {
+            int clip = -cur->dst_y;
+            cur->h -= clip;
+            cur->bitmap += clip * cur->stride;
+            cur->dst_y = 0;
+        }
+        if (cur->dst_y + cur->h >= render_priv->height) {
+            int clip = cur->dst_y + cur->h - render_priv->height;
+            cur->h -= clip;
+        }
+        if (cur->h <= 0) {
+            cur->h = 0;
+            cur->dst_y = 0;
+        }
+        cur = cur->next;
+    }
+    ei->top += shift;
 }
 
 // dir: 1 - move down
 //      -1 - move up
-static int fit_segment(segment_t* s, segment_t* fixed, int* cnt, int dir)
+static int fit_segment(Segment *s, Segment *fixed, int *cnt, int dir)
 {
-	int i;
-	int shift = 0;
+    int i;
+    int shift = 0;
 
-	if (dir == 1) // move down
-		for (i = 0; i < *cnt; ++i) {
-			if (s->b + shift <= fixed[i].a || s->a + shift >= fixed[i].b)
-				continue;
-			shift = fixed[i].b - s->a;
-		}
-	else // dir == -1, move up
-		for (i = *cnt-1; i >= 0; --i) {
-			if (s->b + shift <= fixed[i].a || s->a + shift >= fixed[i].b)
-				continue;
-			shift = fixed[i].a - s->b;
-		}
+    if (dir == 1)               // move down
+        for (i = 0; i < *cnt; ++i) {
+            if (s->b + shift <= fixed[i].a || s->a + shift >= fixed[i].b ||
+                s->hb <= fixed[i].ha || s->ha >= fixed[i].hb)
+                continue;
+            shift = fixed[i].b - s->a;
+    } else                      // dir == -1, move up
+        for (i = *cnt - 1; i >= 0; --i) {
+            if (s->b + shift <= fixed[i].a || s->a + shift >= fixed[i].b ||
+                s->hb <= fixed[i].ha || s->ha >= fixed[i].hb)
+                continue;
+            shift = fixed[i].a - s->b;
+        }
 
-	fixed[*cnt].a = s->a + shift;
-	fixed[*cnt].b = s->b + shift;
-	(*cnt)++;
-	qsort(fixed, *cnt, sizeof(segment_t), cmp_segment);
-	
-	return shift;
+    fixed[*cnt].a = s->a + shift;
+    fixed[*cnt].b = s->b + shift;
+    fixed[*cnt].ha = s->ha;
+    fixed[*cnt].hb = s->hb;
+    (*cnt)++;
+    qsort(fixed, *cnt, sizeof(Segment), cmp_segment);
+
+    return shift;
 }
 
-static void fix_collisions(event_images_t* imgs, int cnt)
+static void
+fix_collisions(ASS_Renderer *render_priv, EventImages *imgs, int cnt)
 {
-	segment_t used[MAX_EVENTS];
-	int cnt_used = 0;
-	int i, j;
+    Segment *used = malloc(cnt * sizeof(*used));
+    int cnt_used = 0;
+    int i, j;
 
-	// fill used[] with fixed events
-	for (i = 0; i < cnt; ++i) {
-		render_priv_t* priv;
-		if (!imgs[i].detect_collisions) continue;
-		priv = get_render_priv(imgs[i].event);
-		if (priv->height > 0) { // it's a fixed event
-			segment_t s;
-			s.a = priv->top;
-			s.b = priv->top + priv->height;
-			if (priv->height != imgs[i].height) { // no, it's not
-				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_EventHeightHasChanged);
-				priv->top = 0;
-				priv->height = 0;
-			}
-			for (j = 0; j < cnt_used; ++j)
-				if (overlap(&s, used + j)) { // no, it's not
-					priv->top = 0;
-					priv->height = 0;
-				}
-			if (priv->height > 0) { // still a fixed event
-				used[cnt_used].a = priv->top;
-				used[cnt_used].b = priv->top + priv->height;
-				cnt_used ++;
-				shift_event(imgs + i, priv->top - imgs[i].top);
-			}
-		}
-	}
-	qsort(used, cnt_used, sizeof(segment_t), cmp_segment);
+    // fill used[] with fixed events
+    for (i = 0; i < cnt; ++i) {
+        ASS_RenderPriv *priv;
+        if (!imgs[i].detect_collisions)
+            continue;
+        priv = get_render_priv(render_priv, imgs[i].event);
+        if (priv->height > 0) { // it's a fixed event
+            Segment s;
+            s.a = priv->top;
+            s.b = priv->top + priv->height;
+            s.ha = priv->left;
+            s.hb = priv->left + priv->width;
+            if (priv->height != imgs[i].height) {       // no, it's not
+                ass_msg(render_priv->library, MSGL_WARN,
+                        "Event height has changed");
+                priv->top = 0;
+                priv->height = 0;
+                priv->left = 0;
+                priv->width = 0;
+            }
+            for (j = 0; j < cnt_used; ++j)
+                if (overlap(&s, used + j)) {    // no, it's not
+                    priv->top = 0;
+                    priv->height = 0;
+                    priv->left = 0;
+                    priv->width = 0;
+                }
+            if (priv->height > 0) {     // still a fixed event
+                used[cnt_used].a = priv->top;
+                used[cnt_used].b = priv->top + priv->height;
+                used[cnt_used].ha = priv->left;
+                used[cnt_used].hb = priv->left + priv->width;
+                cnt_used++;
+                shift_event(render_priv, imgs + i, priv->top - imgs[i].top);
+            }
+        }
+    }
+    qsort(used, cnt_used, sizeof(Segment), cmp_segment);
 
-	// try to fit other events in free spaces
-	for (i = 0; i < cnt; ++i) {
-		render_priv_t* priv;
-		if (!imgs[i].detect_collisions) continue;
-		priv = get_render_priv(imgs[i].event);
-		if (priv->height == 0) { // not a fixed event
-			int shift;
-			segment_t s;
-			s.a = imgs[i].top;
-			s.b = imgs[i].top + imgs[i].height;
-			shift = fit_segment(&s, used, &cnt_used, imgs[i].shift_direction);
-			if (shift) shift_event(imgs + i, shift);
-			// make it fixed
-			priv->top = imgs[i].top;
-			priv->height = imgs[i].height;
-		}
-		
-	}
+    // try to fit other events in free spaces
+    for (i = 0; i < cnt; ++i) {
+        ASS_RenderPriv *priv;
+        if (!imgs[i].detect_collisions)
+            continue;
+        priv = get_render_priv(render_priv, imgs[i].event);
+        if (priv->height == 0) {        // not a fixed event
+            int shift;
+            Segment s;
+            s.a = imgs[i].top;
+            s.b = imgs[i].top + imgs[i].height;
+            s.ha = imgs[i].left;
+            s.hb = imgs[i].left + imgs[i].width;
+            shift = fit_segment(&s, used, &cnt_used, imgs[i].shift_direction);
+            if (shift)
+                shift_event(render_priv, imgs + i, shift);
+            // make it fixed
+            priv->top = imgs[i].top;
+            priv->height = imgs[i].height;
+            priv->left = imgs[i].left;
+            priv->width = imgs[i].width;
+        }
+
+    }
+
+    free(used);
 }
 
 /**
@@ -2280,17 +2411,23 @@
  * \param i2 second image
  * \return 0 if identical, 1 if different positions, 2 if different content
  */
-int ass_image_compare(ass_image_t *i1, ass_image_t *i2)
+static int ass_image_compare(ASS_Image *i1, ASS_Image *i2)
 {
-	if (i1->w != i2->w) return 2;
-	if (i1->h != i2->h) return 2;
-	if (i1->stride != i2->stride) return 2;
-	if (i1->color != i2->color) return 2;
-	if (i1->bitmap != i2->bitmap)
-		return 2;
-	if (i1->dst_x != i2->dst_x) return 1;
-	if (i1->dst_y != i2->dst_y) return 1;
-	return 0;
+    if (i1->w != i2->w)
+        return 2;
+    if (i1->h != i2->h)
+        return 2;
+    if (i1->stride != i2->stride)
+        return 2;
+    if (i1->color != i2->color)
+        return 2;
+    if (i1->bitmap != i2->bitmap)
+        return 2;
+    if (i1->dst_x != i2->dst_x)
+        return 1;
+    if (i1->dst_y != i2->dst_y)
+        return 1;
+    return 0;
 }
 
 /**
@@ -2298,35 +2435,36 @@
  * \param priv library handle
  * \return 0 if identical, 1 if different positions, 2 if different content
  */
-int ass_detect_change(ass_renderer_t *priv)
+static int ass_detect_change(ASS_Renderer *priv)
 {
-	ass_image_t* img, *img2;
-	int diff;
+    ASS_Image *img, *img2;
+    int diff;
 
-	img = priv->prev_images_root;
-	img2 = priv->images_root;
-	diff = 0;
-	while (img && diff < 2) {
-		ass_image_t* next, *next2;
-		next = img->next;
-		if (img2) {
-			int d = ass_image_compare(img, img2);
-			if (d > diff) diff = d;
-			next2 = img2->next;
-		} else {
-			// previous list is shorter
-			diff = 2;
-			break;
-		}
-		img = next;
-		img2 = next2;
-	}
+    img = priv->prev_images_root;
+    img2 = priv->images_root;
+    diff = 0;
+    while (img && diff < 2) {
+        ASS_Image *next, *next2;
+        next = img->next;
+        if (img2) {
+            int d = ass_image_compare(img, img2);
+            if (d > diff)
+                diff = d;
+            next2 = img2->next;
+        } else {
+            // previous list is shorter
+            diff = 2;
+            break;
+        }
+        img = next;
+        img2 = next2;
+    }
 
-	// is the previous list longer?
-	if (img2)
-		diff = 2;
+    // is the previous list longer?
+    if (img2)
+        diff = 2;
 
-	return diff;
+    return diff;
 }
 
 /**
@@ -2338,62 +2476,66 @@
  *        0 if identical, 1 if different positions, 2 if different content.
  *        Can be NULL, in that case no detection is performed.
  */
-ass_image_t* ass_render_frame(ass_renderer_t *priv, ass_track_t* track, long long now, int* detect_change)
+ASS_Image *ass_render_frame(ASS_Renderer *priv, ASS_Track *track,
+                            long long now, int *detect_change)
 {
-	int i, cnt, rc;
-	event_images_t* last;
-	ass_image_t** tail;
-	
-	// init frame
-	rc = ass_start_frame(priv, track, now);
-	if (rc != 0)
-		return 0;
+    int i, cnt, rc;
+    EventImages *last;
+    ASS_Image **tail;
 
-	// render events separately
-	cnt = 0;
-	for (i = 0; i < track->n_events; ++i) {
-		ass_event_t* event = track->events + i;
-		if ( (event->Start <= now) && (now < (event->Start + event->Duration)) ) {
-			if (cnt >= priv->eimg_size) {
-				priv->eimg_size += 100;
-				priv->eimg = realloc(priv->eimg, priv->eimg_size * sizeof(event_images_t));
-			}
-			rc = ass_render_event(event, priv->eimg + cnt);
-			if (!rc) ++cnt;
-		}
-	}
+    // init frame
+    rc = ass_start_frame(priv, track, now);
+    if (rc != 0)
+        return 0;
 
-	// sort by layer
-	qsort(priv->eimg, cnt, sizeof(event_images_t), cmp_event_layer);
+    // render events separately
+    cnt = 0;
+    for (i = 0; i < track->n_events; ++i) {
+        ASS_Event *event = track->events + i;
+        if ((event->Start <= now)
+            && (now < (event->Start + event->Duration))) {
+            if (cnt >= priv->eimg_size) {
+                priv->eimg_size += 100;
+                priv->eimg =
+                    realloc(priv->eimg,
+                            priv->eimg_size * sizeof(EventImages));
+            }
+            rc = ass_render_event(priv, event, priv->eimg + cnt);
+            if (!rc)
+                ++cnt;
+        }
+    }
 
-	// call fix_collisions for each group of events with the same layer
-	last = priv->eimg;
-	for (i = 1; i < cnt; ++i)
-		if (last->event->Layer != priv->eimg[i].event->Layer) {
-			fix_collisions(last, priv->eimg + i - last);
-			last = priv->eimg + i;
-		}
-	if (cnt > 0)
-		fix_collisions(last, priv->eimg + cnt - last);
+    // sort by layer
+    qsort(priv->eimg, cnt, sizeof(EventImages), cmp_event_layer);
 
-	// concat lists
-	tail = &ass_renderer->images_root;
-	for (i = 0; i < cnt; ++i) {
-		ass_image_t* cur = priv->eimg[i].imgs;
-		while (cur) {
-			*tail = cur;
-			tail = &cur->next;
-			cur = cur->next;
-		}
-	}
+    // call fix_collisions for each group of events with the same layer
+    last = priv->eimg;
+    for (i = 1; i < cnt; ++i)
+        if (last->event->Layer != priv->eimg[i].event->Layer) {
+            fix_collisions(priv, last, priv->eimg + i - last);
+            last = priv->eimg + i;
+        }
+    if (cnt > 0)
+        fix_collisions(priv, last, priv->eimg + cnt - last);
 
-	if (detect_change)
-		*detect_change = ass_detect_change(priv);
-	
-	// free the previous image list
-	ass_free_images(priv->prev_images_root);
-	priv->prev_images_root = 0;
+    // concat lists
+    tail = &priv->images_root;
+    for (i = 0; i < cnt; ++i) {
+        ASS_Image *cur = priv->eimg[i].imgs;
+        while (cur) {
+            *tail = cur;
+            tail = &cur->next;
+            cur = cur->next;
+        }
+    }
 
-	return ass_renderer->images_root;
+    if (detect_change)
+        *detect_change = ass_detect_change(priv);
+
+    // free the previous image list
+    ass_free_images(priv->prev_images_root);
+    priv->prev_images_root = 0;
+
+    return priv->images_root;
 }
-

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -0,0 +1,266 @@
+/*
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2009 Grigori Goronzy <greg at geekmind.org>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
+
+#ifndef LIBASS_RENDER_H
+#define LIBASS_RENDER_H
+
+#include <inttypes.h>
+#include <ft2build.h>
+#include FT_FREETYPE_H
+#include FT_STROKER_H
+#include FT_GLYPH_H
+#include FT_SYNTHESIS_H
+
+#include "ass.h"
+#include "ass_font.h"
+#include "ass_bitmap.h"
+#include "ass_cache.h"
+#include "ass_utils.h"
+#include "ass_fontconfig.h"
+#include "ass_library.h"
+#include "ass_drawing.h"
+
+#define GLYPH_CACHE_MAX 1000
+#define BITMAP_CACHE_MAX_SIZE 30 * 1048576
+
+typedef struct {
+    double xMin;
+    double xMax;
+    double yMin;
+    double yMax;
+} DBBox;
+
+typedef struct {
+    double x;
+    double y;
+} DVector;
+
+typedef struct free_list {
+    void *object;
+    struct free_list *next;
+} FreeList;
+
+typedef struct {
+    int frame_width;
+    int frame_height;
+    double font_size_coeff;     // font size multiplier
+    double line_spacing;        // additional line spacing (in frame pixels)
+    int top_margin;             // height of top margin. Everything except toptitles is shifted down by top_margin.
+    int bottom_margin;          // height of bottom margin. (frame_height - top_margin - bottom_margin) is original video height.
+    int left_margin;
+    int right_margin;
+    int use_margins;            // 0 - place all subtitles inside original frame
+    // 1 - use margins for placing toptitles and subtitles
+    double aspect;              // frame aspect ratio, d_width / d_height.
+    double storage_aspect;      // pixel ratio of the source image
+    ASS_Hinting hinting;
+
+    char *default_font;
+    char *default_family;
+} ASS_Settings;
+
+// a rendered event
+typedef struct {
+    ASS_Image *imgs;
+    int top, height, left, width;
+    int detect_collisions;
+    int shift_direction;
+    ASS_Event *event;
+} EventImages;
+
+typedef enum {
+    EF_NONE = 0,
+    EF_KARAOKE,
+    EF_KARAOKE_KF,
+    EF_KARAOKE_KO
+} Effect;
+
+// describes a glyph
+// GlyphInfo and TextInfo are used for text centering and word-wrapping operations
+typedef struct {
+    unsigned symbol;
+    unsigned skip;              // skip glyph when layouting text
+    FT_Glyph glyph;
+    FT_Glyph outline_glyph;
+    Bitmap *bm;                 // glyph bitmap
+    Bitmap *bm_o;               // outline bitmap
+    Bitmap *bm_s;               // shadow bitmap
+    FT_BBox bbox;
+    FT_Vector pos;
+    char linebreak;             // the first (leading) glyph of some line ?
+    uint32_t c[4];              // colors
+    FT_Vector advance;          // 26.6
+    Effect effect_type;
+    int effect_timing;          // time duration of current karaoke word
+    // after process_karaoke_effects: distance in pixels from the glyph origin.
+    // part of the glyph to the left of it is displayed in a different color.
+    int effect_skip_timing;     // delay after the end of last karaoke word
+    int asc, desc;              // font max ascender and descender
+    int be;                     // blur edges
+    double blur;                // gaussian blur
+    double shadow_x;
+    double shadow_y;
+    double frx, fry, frz;       // rotation
+    double fax, fay;            // text shearing
+
+    BitmapHashKey hash_key;
+} GlyphInfo;
+
+typedef struct {
+    double asc, desc;
+} LineInfo;
+
+typedef struct {
+    GlyphInfo *glyphs;
+    int length;
+    LineInfo *lines;
+    int n_lines;
+    double height;
+    int max_glyphs;
+    int max_lines;
+} TextInfo;
+
+// Renderer state.
+// Values like current font face, color, screen position, clipping and so on are stored here.
+typedef struct {
+    ASS_Event *event;
+    ASS_Style *style;
+
+    ASS_Font *font;
+    char *font_path;
+    double font_size;
+    int flags;                  // decoration flags (underline/strike-through)
+
+    FT_Stroker stroker;
+    int alignment;              // alignment overrides go here; if zero, style value will be used
+    double frx, fry, frz;
+    double fax, fay;            // text shearing
+    enum {
+        EVENT_NORMAL,           // "normal" top-, sub- or mid- title
+        EVENT_POSITIONED,       // happens after pos(,), margins are ignored
+        EVENT_HSCROLL,          // "Banner" transition effect, text_width is unlimited
+        EVENT_VSCROLL           // "Scroll up", "Scroll down" transition effects
+    } evt_type;
+    double pos_x, pos_y;        // position
+    double org_x, org_y;        // origin
+    char have_origin;           // origin is explicitly defined; if 0, get_base_point() is used
+    double scale_x, scale_y;
+    double hspacing;            // distance between letters, in pixels
+    double border_x;            // outline width
+    double border_y;
+    uint32_t c[4];              // colors(Primary, Secondary, so on) in RGBA
+    int clip_x0, clip_y0, clip_x1, clip_y1;
+    char clip_mode;             // 1 = iclip
+    char detect_collisions;
+    uint32_t fade;              // alpha from \fad
+    char be;                    // blur edges
+    double blur;                // gaussian blur
+    double shadow_x;
+    double shadow_y;
+    int drawing_mode;           // not implemented; when != 0 text is discarded, except for style override tags
+    ASS_Drawing *drawing;       // current drawing
+    ASS_Drawing *clip_drawing;  // clip vector
+    int clip_drawing_mode;      // 0 = regular clip, 1 = inverse clip
+
+    Effect effect_type;
+    int effect_timing;
+    int effect_skip_timing;
+
+    enum {
+        SCROLL_LR,              // left-to-right
+        SCROLL_RL,
+        SCROLL_TB,              // top-to-bottom
+        SCROLL_BT
+    } scroll_direction;         // for EVENT_HSCROLL, EVENT_VSCROLL
+    int scroll_shift;
+
+    // face properties
+    char *family;
+    unsigned bold;
+    unsigned italic;
+    int treat_family_as_pattern;
+    int wrap_style;
+} RenderContext;
+
+typedef struct {
+    Hashmap *font_cache;
+    Hashmap *glyph_cache;
+    Hashmap *bitmap_cache;
+    Hashmap *composite_cache;
+    size_t glyph_max;
+    size_t bitmap_max_size;
+} CacheStore;
+
+struct ass_renderer {
+    ASS_Library *library;
+    FT_Library ftlibrary;
+    FCInstance *fontconfig_priv;
+    ASS_Settings settings;
+    int render_id;
+    ASS_SynthPriv *synth_priv;
+
+    ASS_Image *images_root;     // rendering result is stored here
+    ASS_Image *prev_images_root;
+
+    EventImages *eimg;          // temporary buffer for sorting rendered events
+    int eimg_size;              // allocated buffer size
+
+    // frame-global data
+    int width, height;          // screen dimensions
+    int orig_height;            // frame height ( = screen height - margins )
+    int orig_width;             // frame width ( = screen width - margins )
+    int orig_height_nocrop;     // frame height ( = screen height - margins + cropheight)
+    int orig_width_nocrop;      // frame width ( = screen width - margins + cropwidth)
+    ASS_Track *track;
+    long long time;             // frame's timestamp, ms
+    double font_scale;
+    double font_scale_x;        // x scale applied to all glyphs to preserve text aspect ratio
+    double border_scale;
+
+    RenderContext state;
+    TextInfo text_info;
+    CacheStore cache;
+
+    FreeList *free_head;
+    FreeList *free_tail;
+};
+
+typedef struct render_priv {
+    int top, height, left, width;
+    int render_id;
+} RenderPriv;
+
+typedef struct {
+    int x0;
+    int y0;
+    int x1;
+    int y1;
+} Rect;
+
+typedef struct {
+    int a, b;                   // top and height
+    int ha, hb;                 // left and width
+} Segment;
+
+void reset_render_context(ASS_Renderer *render_priv);
+void ass_free_images(ASS_Image *img);
+
+#endif /* LIBASS_RENDER_H */

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render_api.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render_api.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_render_api.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -0,0 +1,141 @@
+/*
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2010 Grigori Goronzy <greg at geekmind.org>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
+
+#include "ADM_coreConfig.h"
+#include "ass_render.h"
+
+static void ass_reconfigure(ASS_Renderer *priv)
+{
+    ASS_Settings *settings = &priv->settings;
+
+    priv->render_id++;
+    priv->cache.glyph_cache =
+        ass_glyph_cache_reset(priv->cache.glyph_cache);
+    priv->cache.bitmap_cache =
+        ass_bitmap_cache_reset(priv->cache.bitmap_cache);
+    priv->cache.composite_cache =
+        ass_composite_cache_reset(priv->cache.composite_cache);
+    ass_free_images(priv->prev_images_root);
+    priv->prev_images_root = 0;
+
+    priv->width = settings->frame_width;
+    priv->height = settings->frame_height;
+    priv->orig_width = settings->frame_width - settings->left_margin -
+        settings->right_margin;
+    priv->orig_height = settings->frame_height - settings->top_margin -
+        settings->bottom_margin;
+    priv->orig_width_nocrop =
+        settings->frame_width - FFMAX(settings->left_margin, 0) -
+        FFMAX(settings->right_margin, 0);
+    priv->orig_height_nocrop =
+        settings->frame_height - FFMAX(settings->top_margin, 0) -
+        FFMAX(settings->bottom_margin, 0);
+}
+
+void ass_set_frame_size(ASS_Renderer *priv, int w, int h)
+{
+    if (priv->settings.frame_width != w || priv->settings.frame_height != h) {
+        priv->settings.frame_width = w;
+        priv->settings.frame_height = h;
+        if (priv->settings.aspect == 0.) {
+            priv->settings.aspect = ((double) w) / h;
+            priv->settings.storage_aspect = ((double) w) / h;
+        }
+        ass_reconfigure(priv);
+    }
+}
+
+void ass_set_margins(ASS_Renderer *priv, int t, int b, int l, int r)
+{
+    if (priv->settings.left_margin != l || priv->settings.right_margin != r ||
+        priv->settings.top_margin != t || priv->settings.bottom_margin != b) {
+        priv->settings.left_margin = l;
+        priv->settings.right_margin = r;
+        priv->settings.top_margin = t;
+        priv->settings.bottom_margin = b;
+        ass_reconfigure(priv);
+    }
+}
+
+void ass_set_use_margins(ASS_Renderer *priv, int use)
+{
+    priv->settings.use_margins = use;
+}
+
+void ass_set_aspect_ratio(ASS_Renderer *priv, double dar, double sar)
+{
+    if (priv->settings.aspect != dar || priv->settings.storage_aspect != sar) {
+        priv->settings.aspect = dar;
+        priv->settings.storage_aspect = sar;
+        ass_reconfigure(priv);
+    }
+}
+
+void ass_set_font_scale(ASS_Renderer *priv, double font_scale)
+{
+    if (priv->settings.font_size_coeff != font_scale) {
+        priv->settings.font_size_coeff = font_scale;
+        ass_reconfigure(priv);
+    }
+}
+
+void ass_set_hinting(ASS_Renderer *priv, ASS_Hinting ht)
+{
+    if (priv->settings.hinting != ht) {
+        priv->settings.hinting = ht;
+        ass_reconfigure(priv);
+    }
+}
+
+void ass_set_line_spacing(ASS_Renderer *priv, double line_spacing)
+{
+    priv->settings.line_spacing = line_spacing;
+}
+
+void ass_set_fonts(ASS_Renderer *priv, const char *default_font,
+                   const char *default_family, int fc, const char *config,
+                   int update)
+{
+    free(priv->settings.default_font);
+    free(priv->settings.default_family);
+    priv->settings.default_font = default_font ? strdup(default_font) : 0;
+    priv->settings.default_family =
+        default_family ? strdup(default_family) : 0;
+
+    if (priv->fontconfig_priv)
+        fontconfig_done(priv->fontconfig_priv);
+    priv->fontconfig_priv =
+        fontconfig_init(priv->library, priv->ftlibrary, default_family,
+                        default_font, fc, config, update);
+}
+
+int ass_fonts_update(ASS_Renderer *render_priv)
+{
+    return fontconfig_update(render_priv->fontconfig_priv);
+}
+
+void ass_set_cache_limits(ASS_Renderer *render_priv, int glyph_max,
+                          int bitmap_max)
+{
+    render_priv->cache.glyph_max = glyph_max ? glyph_max : GLYPH_CACHE_MAX;
+    render_priv->cache.bitmap_max_size = bitmap_max ? 1048576 * bitmap_max :
+                                         BITMAP_CACHE_MAX_SIZE;
+}

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_strtod.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_strtod.c	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_strtod.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -0,0 +1,249 @@
+/*
+ * Copyright (c) 1988-1993 The Regents of the University of California.
+ * Copyright (c) 1994 Sun Microsystems, Inc.
+ *
+ * Permission to use, copy, modify, and distribute this
+ * software and its documentation for any purpose and without
+ * fee is hereby granted, provided that the above copyright
+ * notice appear in all copies.  The University of California
+ * makes no representations about the suitability of this
+ * software for any purpose.  It is provided "as is" without
+ * express or implied warranty.
+ *
+ */
+
+#include <stdlib.h>
+#include <ctype.h>
+#include <errno.h>
+
+const
+static int maxExponent = 511;   /* Largest possible base 10 exponent.  Any
+                                 * exponent larger than this will already
+                                 * produce underflow or overflow, so there's
+                                 * no need to worry about additional digits.
+                                 */
+
+const
+static double powersOf10[] = {  /* Table giving binary powers of 10.  Entry */
+    10.,                        /* is 10^2^i.  Used to convert decimal */
+    100.,                       /* exponents into floating-point numbers. */
+    1.0e4,
+    1.0e8,
+    1.0e16,
+    1.0e32,
+    1.0e64,
+    1.0e128,
+    1.0e256
+};
+
+/*
+ *----------------------------------------------------------------------
+ *
+ * strtod --
+ *
+ * This procedure converts a floating-point number from an ASCII
+ * decimal representation to internal double-precision format.
+ *
+ * Results:
+ * The return value is the double-precision floating-point
+ * representation of the characters in string.  If endPtr isn't
+ * NULL, then *endPtr is filled in with the address of the
+ * next character after the last one that was part of the
+ * floating-point number.
+ *
+ * Side effects:
+ * None.
+ *
+ *----------------------------------------------------------------------
+ */
+
+double
+ass_strtod(string, endPtr)
+    const char *string;     /* A decimal ASCII floating-point number,
+                             * optionally preceded by white space.
+                             * Must have form "-I.FE-X", where I is the
+                             * integer part of the mantissa, F is the
+                             * fractional part of the mantissa, and X
+                             * is the exponent.  Either of the signs
+                             * may be "+", "-", or omitted.  Either I
+                             * or F may be omitted, or both.  The decimal
+                             * point isn't necessary unless F is present.
+                             * The "E" may actually be an "e".  E and X
+                             * may both be omitted (but not just one).
+                             */
+    char **endPtr;          /* If non-NULL, store terminating character's
+                             * address here. */
+{
+    int sign, expSign = 0;
+    double fraction, dblExp, *d;
+    register const char *p;
+    register int c;
+    int exp = 0;            /* Exponent read from "EX" field. */
+    int fracExp = 0;        /* Exponent that derives from the fractional
+                             * part.  Under normal circumstatnces, it is
+                             * the negative of the number of digits in F.
+                             * However, if I is very long, the last digits
+                             * of I get dropped (otherwise a long I with a
+                             * large negative exponent could cause an
+                             * unnecessary overflow on I alone).  In this
+                             * case, fracExp is incremented one for each
+                             * dropped digit. */
+    int mantSize;       /* Number of digits in mantissa. */
+    int decPt;          /* Number of mantissa digits BEFORE decimal
+                         * point. */
+    const char *pExp;       /* Temporarily holds location of exponent
+                             * in string. */
+
+    /*
+     * Strip off leading blanks and check for a sign.
+     */
+
+    p = string;
+    while (isspace(*p)) {
+        p += 1;
+    }
+    if (*p == '-') {
+        sign = 1;
+        p += 1;
+    } else {
+        if (*p == '+') {
+            p += 1;
+        }
+        sign = 0;
+    }
+
+    /*
+     * Count the number of digits in the mantissa (including the decimal
+     * point), and also locate the decimal point.
+     */
+
+    decPt = -1;
+    for (mantSize = 0; ; mantSize += 1)
+    {
+        c = *p;
+        if (!isdigit(c)) {
+            if ((c != '.') || (decPt >= 0)) {
+                break;
+            }
+            decPt = mantSize;
+        }
+        p += 1;
+    }
+
+    /*
+     * Now suck up the digits in the mantissa.  Use two integers to
+     * collect 9 digits each (this is faster than using floating-point).
+     * If the mantissa has more than 18 digits, ignore the extras, since
+     * they can't affect the value anyway.
+     */
+
+    pExp  = p;
+    p -= mantSize;
+    if (decPt < 0) {
+        decPt = mantSize;
+    } else {
+        mantSize -= 1;      /* One of the digits was the point. */
+    }
+    if (mantSize > 18) {
+        fracExp = decPt - 18;
+        mantSize = 18;
+    } else {
+        fracExp = decPt - mantSize;
+    }
+    if (mantSize == 0) {
+        fraction = 0.0;
+        p = string;
+        goto done;
+    } else {
+        int frac1, frac2;
+        frac1 = 0;
+        for ( ; mantSize > 9; mantSize -= 1)
+        {
+            c = *p;
+            p += 1;
+            if (c == '.') {
+                c = *p;
+                p += 1;
+            }
+            frac1 = 10*frac1 + (c - '0');
+        }
+        frac2 = 0;
+        for (; mantSize > 0; mantSize -= 1)
+        {
+            c = *p;
+            p += 1;
+            if (c == '.') {
+                c = *p;
+                p += 1;
+            }
+            frac2 = 10*frac2 + (c - '0');
+        }
+        fraction = (1.0e9 * frac1) + frac2;
+    }
+
+    /*
+     * Skim off the exponent.
+     */
+
+    p = pExp;
+    if ((*p == 'E') || (*p == 'e')) {
+        p += 1;
+        if (*p == '-') {
+            expSign = 1;
+            p += 1;
+        } else {
+            if (*p == '+') {
+                p += 1;
+            }
+            expSign = 0;
+        }
+        while (isdigit(*p)) {
+            exp = exp * 10 + (*p - '0');
+            p += 1;
+        }
+    }
+    if (expSign) {
+        exp = fracExp - exp;
+    } else {
+        exp = fracExp + exp;
+    }
+
+    /*
+     * Generate a floating-point number that represents the exponent.
+     * Do this by processing the exponent one bit at a time to combine
+     * many powers of 2 of 10. Then combine the exponent with the
+     * fraction.
+     */
+
+    if (exp < 0) {
+        expSign = 1;
+        exp = -exp;
+    } else {
+        expSign = 0;
+    }
+    if (exp > maxExponent) {
+        exp = maxExponent;
+        errno = ERANGE;
+    }
+    dblExp = 1.0;
+    for (d = (double *) powersOf10; exp != 0; exp >>= 1, d += 1) {
+        if (exp & 01) {
+            dblExp *= *d;
+        }
+    }
+    if (expSign) {
+        fraction /= dblExp;
+    } else {
+        fraction *= dblExp;
+    }
+
+done:
+    if (endPtr != NULL) {
+        *endPtr = (char *) p;
+    }
+
+    if (sign) {
+        return -fraction;
+    }
+    return fraction;
+}

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_types.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_types.h	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_types.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,26 +1,28 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#ifndef LIBASS_TYPES_H
+#define LIBASS_TYPES_H
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
+#include <stdint.h>
 
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#ifndef ASS_TYPES_H
-#define ASS_TYPES_H
-
 #define VALIGN_SUB 0
 #define VALIGN_CENTER 8
 #define VALIGN_TOP 4
@@ -28,87 +30,96 @@
 #define HALIGN_CENTER 2
 #define HALIGN_RIGHT 3
 
-/// ass Style: line
-typedef struct ass_style_s {
-	char* Name;
-	char* FontName;
-	double FontSize;
-	uint32_t PrimaryColour;
-	uint32_t SecondaryColour;
-	uint32_t OutlineColour;
-	uint32_t BackColour;
-	int Bold;
-	int Italic;
-	int Underline;
-	int StrikeOut;
-	double ScaleX;
-	double ScaleY;
-	double Spacing;
-	int Angle;
-	int BorderStyle;
-	double Outline;
-	double Shadow;
-	int Alignment;
-	int MarginL;
-	int MarginR;
-	int MarginV;
-//        int AlphaLevel;
-	int Encoding;
-} ass_style_t;
+/* Opaque objects internally used by libass.  Contents are private. */
+typedef struct ass_renderer ASS_Renderer;
+typedef struct render_priv ASS_RenderPriv;
+typedef struct parser_priv ASS_ParserPriv;
+typedef struct ass_library ASS_Library;
 
-typedef struct render_priv_s render_priv_t;
+/* ASS Style: line */
+typedef struct ass_style {
+    char *Name;
+    char *FontName;
+    double FontSize;
+    uint32_t PrimaryColour;
+    uint32_t SecondaryColour;
+    uint32_t OutlineColour;
+    uint32_t BackColour;
+    int Bold;
+    int Italic;
+    int Underline;
+    int StrikeOut;
+    double ScaleX;
+    double ScaleY;
+    double Spacing;
+    int Angle;
+    int BorderStyle;
+    double Outline;
+    double Shadow;
+    int Alignment;
+    int MarginL;
+    int MarginR;
+    int MarginV;
+    int Encoding;
+    int treat_fontname_as_pattern;
+} ASS_Style;
 
-/// ass_event_t corresponds to a single Dialogue line
-/// Text is stored as-is, style overrides will be parsed later
-typedef struct ass_event_s {
-	long long Start; // ms
-	long long Duration; // ms
+/*
+ * ASS_Event corresponds to a single Dialogue line;
+ * text is stored as-is, style overrides will be parsed later.
+ */
+typedef struct ass_event {
+    long long Start;            // ms
+    long long Duration;         // ms
 
-	int ReadOrder;
-	int Layer;
-	int Style;
-	char* Name;
-	int MarginL;
-	int MarginR;
-	int MarginV;
-	char* Effect;
-	char* Text;
+    int ReadOrder;
+    int Layer;
+    int Style;
+    char *Name;
+    int MarginL;
+    int MarginR;
+    int MarginV;
+    char *Effect;
+    char *Text;
 
-	render_priv_t* render_priv;
-} ass_event_t;
+    ASS_RenderPriv *render_priv;
+} ASS_Event;
 
-typedef struct parser_priv_s parser_priv_t;
+/*
+ * ass track represent either an external script or a matroska subtitle stream
+ * (no real difference between them); it can be used in rendering after the
+ * headers are parsed (i.e. events format line read).
+ */
+typedef struct ass_track {
+    int n_styles;           // amount used
+    int max_styles;         // amount allocated
+    int n_events;
+    int max_events;
+    ASS_Style *styles;    // array of styles, max_styles length, n_styles used
+    ASS_Event *events;    // the same as styles
 
-typedef struct ass_library_s ass_library_t;
+    char *style_format;     // style format line (everything after "Format: ")
+    char *event_format;     // event format line
 
-/// ass track represent either an external script or a matroska subtitle stream (no real difference between them)
-/// it can be used in rendering after the headers are parsed (i.e. events format line read)
-typedef struct ass_track_s {
-	int n_styles; // amount used
-	int max_styles; // amount allocated
-	int n_events;
-	int max_events;
-	ass_style_t* styles; // array of styles, max_styles length, n_styles used
-	ass_event_t* events; // the same as styles
+    enum {
+        TRACK_TYPE_UNKNOWN = 0,
+        TRACK_TYPE_ASS,
+        TRACK_TYPE_SSA
+    } track_type;
 
-	char* style_format; // style format line (everything after "Format: ")
-	char* event_format; // event format line
+    // Script header fields
+    int PlayResX;
+    int PlayResY;
+    double Timer;
+    int WrapStyle;
+    int ScaledBorderAndShadow;
+    int Kerning;
 
-	enum {TRACK_TYPE_UNKNOWN = 0, TRACK_TYPE_ASS, TRACK_TYPE_SSA} track_type;
-	
-	// script header fields
-	int PlayResX;
-	int PlayResY;
-	double Timer;
-	int WrapStyle;
+    int default_style;      // index of default style
+    char *name;             // file name in case of external subs, 0 for streams
 
-	
-	int default_style; // index of default style
-	char* name; // file name in case of external subs, 0 for streams
+    ASS_Library *library;
+    ASS_ParserPriv *parser_priv;
+} ASS_Track;
 
-	ass_library_t* library;
-	parser_priv_t* parser_priv;
-} ass_track_t;
-
-#endif
-
+#endif /* LIBASS_TYPES_H */

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.c	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,81 +1,208 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#include "ADM_coreConfig.h"
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-//#include "config.h"
-
 #include <stdlib.h>
+#include <stdio.h>
 #include <inttypes.h>
+#include <ft2build.h>
+#include FT_GLYPH_H
+#include <strings.h>
 
-#include "mputils.h"
+#include "ass_library.h"
+#include "ass.h"
 #include "ass_utils.h"
 
-int mystrtoi(char** p, int base, int* res)
+int mystrtoi(char **p, int *res)
 {
-	char* start = *p;
-	*res = strtol(*p, p, base);
-	if (*p != start) return 1;
-	else return 0;
+    double temp_res;
+    char *start = *p;
+    temp_res = ass_strtod(*p, p);
+    *res = (int) (temp_res + (temp_res > 0 ? 0.5 : -0.5));
+    if (*p != start)
+        return 1;
+    else
+        return 0;
 }
 
-int mystrtou32(char** p, int base, uint32_t* res)
+int mystrtoll(char **p, long long *res)
 {
-	char* start = *p;
-	*res = strtoll(*p, p, base);
-	if (*p != start) return 1;
-	else return 0;
+    double temp_res;
+    char *start = *p;
+    temp_res = ass_strtod(*p, p);
+    *res = (int) (temp_res + (temp_res > 0 ? 0.5 : -0.5));
+    if (*p != start)
+        return 1;
+    else
+        return 0;
 }
 
-int mystrtod(char** p, double* res)
+int mystrtou32(char **p, int base, uint32_t *res)
 {
-	char* start = *p;
-	*res = strtod(*p, p);
-	if (*p != start) return 1;
-	else return 0;
+    char *start = *p;
+    *res = strtoll(*p, p, base);
+    if (*p != start)
+        return 1;
+    else
+        return 0;
 }
 
-int strtocolor(char** q, uint32_t* res)
+int mystrtod(char **p, double *res)
 {
-	uint32_t color = 0;
-	int result;
-	char* p = *q;
-	
-	if (*p == '&') ++p; 
-	else mp_msg(MSGT_ASS, MSGL_DBG2, "suspicious color format: \"%s\"\n", p);
-	
-	if (*p == 'H' || *p == 'h') { 
-		++p;
-		result = mystrtou32(&p, 16, &color);
-	} else {
-		result = mystrtou32(&p, 0, &color);
-	}
-	
-	{
-		unsigned char* tmp = (unsigned char*)(&color);
-		unsigned char b;
-		b = tmp[0]; tmp[0] = tmp[3]; tmp[3] = b;
-		b = tmp[1]; tmp[1] = tmp[2]; tmp[2] = b;
-	}
-	if (*p == '&') ++p;
-	*q = p;
+    char *start = *p;
+    *res = ass_strtod(*p, p);
+    if (*p != start)
+        return 1;
+    else
+        return 0;
+}
 
-	*res = color;
-	return result;
+int strtocolor(ASS_Library *library, char **q, uint32_t *res, int hex)
+{
+    uint32_t color = 0;
+    int result;
+    char *p = *q;
+    int base = hex ? 16 : 10;
+
+    if (*p == '&')
+        ++p;
+    else
+        ass_msg(library, MSGL_DBG2, "suspicious color format: \"%s\"\n", p);
+
+    if (*p == 'H' || *p == 'h') {
+        ++p;
+        result = mystrtou32(&p, 16, &color);
+    } else {
+        result = mystrtou32(&p, base, &color);
+    }
+
+    {
+        unsigned char *tmp = (unsigned char *) (&color);
+        unsigned char b;
+        b = tmp[0];
+        tmp[0] = tmp[3];
+        tmp[3] = b;
+        b = tmp[1];
+        tmp[1] = tmp[2];
+        tmp[2] = b;
+    }
+    if (*p == '&')
+        ++p;
+    *q = p;
+
+    *res = color;
+    return result;
 }
 
+// Return a boolean value for a string
+char parse_bool(char *str)
+{
+    while (*str == ' ' || *str == '\t')
+        str++;
+    if (!strncasecmp(str, "yes", 3))
+        return 1;
+    else if (strtol(str, NULL, 10) > 0)
+        return 1;
+    return 0;
+}
+
+void ass_msg(ASS_Library *priv, int lvl, char *fmt, ...)
+{
+    va_list va;
+    va_start(va, fmt);
+    priv->msg_callback(lvl, fmt, va, priv->msg_callback_data);
+    va_end(va);
+}
+
+unsigned ass_utf8_get_char(char **str)
+{
+    uint8_t *strp = (uint8_t *) * str;
+    unsigned c = *strp++;
+    unsigned mask = 0x80;
+    int len = -1;
+    while (c & mask) {
+        mask >>= 1;
+        len++;
+    }
+    if (len <= 0 || len > 4)
+        goto no_utf8;
+    c &= mask - 1;
+    while ((*strp & 0xc0) == 0x80) {
+        if (len-- <= 0)
+            goto no_utf8;
+        c = (c << 6) | (*strp++ & 0x3f);
+    }
+    if (len)
+        goto no_utf8;
+    *str = (char *) strp;
+    return c;
+
+  no_utf8:
+    strp = (uint8_t *) * str;
+    c = *strp++;
+    *str = (char *) strp;
+    return c;
+}
+
+#ifdef CONFIG_ENCA
+void *ass_guess_buffer_cp(ASS_Library *library, unsigned char *buffer,
+                          int buflen, char *preferred_language,
+                          char *fallback)
+{
+    const char **languages;
+    size_t langcnt;
+    EncaAnalyser analyser;
+    EncaEncoding encoding;
+    char *detected_sub_cp = NULL;
+    int i;
+
+    languages = enca_get_languages(&langcnt);
+    ass_msg(library, MSGL_V, "ENCA supported languages");
+    for (i = 0; i < langcnt; i++) {
+        ass_msg(library, MSGL_V, "lang %s", languages[i]);
+    }
+
+    for (i = 0; i < langcnt; i++) {
+        const char *tmp;
+
+        if (strcasecmp(languages[i], preferred_language) != 0)
+            continue;
+        analyser = enca_analyser_alloc(languages[i]);
+        encoding = enca_analyse_const(analyser, buffer, buflen);
+        tmp = enca_charset_name(encoding.charset, ENCA_NAME_STYLE_ICONV);
+        if (tmp && encoding.charset != ENCA_CS_UNKNOWN) {
+            detected_sub_cp = strdup(tmp);
+            ass_msg(library, MSGL_INFO, "ENCA detected charset: %s", tmp);
+        }
+        enca_analyser_free(analyser);
+    }
+
+    free(languages);
+
+    if (!detected_sub_cp) {
+        detected_sub_cp = strdup(fallback);
+        ass_msg(library, MSGL_INFO,
+               "ENCA detection failed: fallback to %s", fallback);
+    }
+
+    return detected_sub_cp;
+}
+#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.h	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/ass_utils.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,61 +1,147 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
 /*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ * Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
+ *
+ * This file is part of libass.
+ *
+ * libass is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * libass is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with libass; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
 
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
+#ifndef LIBASS_UTILS_H
+#define LIBASS_UTILS_H
 
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
+#include <stdio.h>
+#include <stdarg.h>
+#include <stdint.h>
+#include <stdlib.h>
+#include <string.h>
+#include <assert.h>
 
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
+#ifdef CONFIG_ENCA
+#include <enca.h>
+#endif
 
-#ifndef ASS_UTILS_H
-#define ASS_UTILS_H
+#include "ass.h"
 
-int mystrtoi(char** p, int base, int* res);
-int mystrtou32(char** p, int base, uint32_t* res);
-int mystrtod(char** p, double* res);
-int strtocolor(char** q, uint32_t* res);
+#define MSGL_FATAL 0
+#define MSGL_ERR 1
+#define MSGL_WARN 2
+#define MSGL_INFO 4
+#define MSGL_V 6
+#define MSGL_DBG2 7
 
-static inline int d6_to_int(int x) {
-	return (x + 32) >> 6;
+#define FFMAX(a,b) ((a) > (b) ? (a) : (b))
+#define FFMIN(a,b) ((a) > (b) ? (b) : (a))
+#define FFMINMAX(c,a,b) FFMIN(FFMAX(c, a), b)
+
+int mystrtoi(char **p, int *res);
+int mystrtoll(char **p, long long *res);
+int mystrtou32(char **p, int base, uint32_t *res);
+int mystrtod(char **p, double *res);
+int strtocolor(ASS_Library *library, char **q, uint32_t *res, int hex);
+char parse_bool(char *str);
+unsigned ass_utf8_get_char(char **str);
+void ass_msg(ASS_Library *priv, int lvl, char *fmt, ...);
+#ifdef CONFIG_ENCA
+void *ass_guess_buffer_cp(ASS_Library *library, unsigned char *buffer,
+                          int buflen, char *preferred_language,
+                          char *fallback);
+#endif
+
+/* defined in ass_strtod.c */
+double ass_strtod(const char *string, char **endPtr);
+
+static inline int d6_to_int(int x)
+{
+    return (x + 32) >> 6;
 }
-static inline int d16_to_int(int x) {
-	return (x + 32768) >> 16;
+static inline int d16_to_int(int x)
+{
+    return (x + 32768) >> 16;
 }
-static inline int int_to_d6(int x) {
-	return x << 6;
+static inline int int_to_d6(int x)
+{
+    return x << 6;
 }
-static inline int int_to_d16(int x) {
-	return x << 16;
+static inline int int_to_d16(int x)
+{
+    return x << 16;
 }
-static inline int d16_to_d6(int x) {
-	return (x + 512) >> 10;
+static inline int d16_to_d6(int x)
+{
+    return (x + 512) >> 10;
 }
-static inline int d6_to_d16(int x) {
-	return x << 10;
+static inline int d6_to_d16(int x)
+{
+    return x << 10;
 }
-static inline double d6_to_double(int x) {
-	return x / 64.;
+static inline double d6_to_double(int x)
+{
+    return x / 64.;
 }
-static inline int double_to_d6(double x) {
-	return (int)(x * 64);
+static inline int double_to_d6(double x)
+{
+    return (int) (x * 64);
 }
-static inline double d16_to_double(int x) {
-	return ((double)x) / 0x10000;
+static inline double d16_to_double(int x)
+{
+    return ((double) x) / 0x10000;
 }
-static inline int double_to_d16(double x) {
-	return (int)(x * 0x10000);
+static inline int double_to_d16(double x)
+{
+    return (int) (x * 0x10000);
 }
+static inline double d22_to_double(int x)
+{
+    return ((double) x) / 0x400000;
+}
+static inline int double_to_d22(double x)
+{
+    return (int) (x * 0x400000);
+}
 
-#endif
+// Calculate cache key for a rotational angle in degrees
+static inline int rot_key(double a)
+{
+    const int m = double_to_d22(360.0);
+    return double_to_d22(a) % m;
+}
 
+#define FNV1_32A_INIT (unsigned)0x811c9dc5
+
+static inline unsigned fnv_32a_buf(void *buf, size_t len, unsigned hval)
+{
+    unsigned char *bp = buf;
+    unsigned char *be = bp + len;
+    while (bp < be) {
+        hval ^= (unsigned) *bp++;
+        hval +=
+            (hval << 1) + (hval << 4) + (hval << 7) + (hval << 8) +
+            (hval << 24);
+    }
+    return hval;
+}
+static inline unsigned fnv_32a_str(char *str, unsigned hval)
+{
+    unsigned char *s = (unsigned char *) str;
+    while (*s) {
+        hval ^= (unsigned) *s++;
+        hval +=
+            (hval << 1) + (hval << 4) + (hval << 7) + (hval << 8) +
+            (hval << 24);
+    }
+    return hval;
+}
+
+#endif                          /* LIBASS_UTILS_H */

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.c	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.c	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,218 +0,0 @@
-//#include "config.h"
-
-#include "mputils.h"
-
-#include <stdio.h>
-#include <stdarg.h>
-#include <stdint.h>
-#include <stdlib.h>
-#include <string.h>
-#include <assert.h>
-
-#ifdef HAVE_ENCA
-#include <enca.h>
-#endif
-
-void my_mp_msg(int lvl, char *lvl_str, char *fmt, ...) {
-	va_list va;
-	if(lvl > MSGL_V) return;
-	printf("[ass] **%s**: ", lvl_str);
-	va_start(va, fmt);
-	vprintf(fmt, va);
-	va_end(va);
-}
-
-unsigned utf8_get_char(char **str) {
-  uint8_t *strp = (uint8_t *)*str;
-  unsigned c = *strp++;
-  unsigned mask = 0x80;
-  int len = -1;
-  while (c & mask) {
-    mask >>= 1;
-    len++;
-  }
-  if (len <= 0 || len > 4)
-    goto no_utf8;
-  c &= mask - 1;
-  while ((*strp & 0xc0) == 0x80) {
-    if (len-- <= 0)
-      goto no_utf8;
-    c = (c << 6) | (*strp++ & 0x3f);
-  }
-  if (len)
-    goto no_utf8;
-  *str = (char *)strp;
-  return c;
-
-no_utf8:
-  strp = (uint8_t *)*str;
-  c = *strp++;
-  *str = (char *)strp;
-  return c;
-}
-
-// gaussian blur
-void blur(
-	unsigned char *buffer,
-	unsigned short *tmp2,
-	int width,
-	int height,
-	int stride,
-	int *m2,
-	int r,
-	int mwidth) {
-
-    int x, y;
-
-    unsigned char  *s = buffer;
-    unsigned short *t = tmp2+1;
-    for(y=0; y<height; y++){
-	memset(t-1, 0, (width+1)*sizeof(short));
-
-	for(x=0; x<r; x++){
-	    const int src= s[x];
-	    if(src){
-		register unsigned short *dstp= t + x-r;
-		int mx;
-		unsigned *m3= m2 + src*mwidth;
-		for(mx=r-x; mx<mwidth; mx++){
-		    dstp[mx]+= m3[mx];
-		}
-	    }
-	}
-
-	for(; x<width-r; x++){
-	    const int src= s[x];
-	    if(src){
-		register unsigned short *dstp= t + x-r;
-		int mx;
-		unsigned *m3= m2 + src*mwidth;
-		for(mx=0; mx<mwidth; mx++){
-		    dstp[mx]+= m3[mx];
-		}
-	    }
-	}
-
-	for(; x<width; x++){
-	    const int src= s[x];
-	    if(src){
-		register unsigned short *dstp= t + x-r;
-		int mx;
-		const int x2= r+width -x;
-		unsigned *m3= m2 + src*mwidth;
-		for(mx=0; mx<x2; mx++){
-		    dstp[mx]+= m3[mx];
-		}
-	    }
-	}
-
-	s+= stride;
-	t+= width + 1;
-    }
-
-    t = tmp2;
-    for(x=0; x<width; x++){
-	for(y=0; y<r; y++){
-	    unsigned short *srcp= t + y*(width+1) + 1;
-	    int src= *srcp;
-	    if(src){
-		register unsigned short *dstp= srcp - 1 + width+1;
-		const int src2= (src + 128)>>8;
-		unsigned *m3= m2 + src2*mwidth;
-
-		int mx;
-		*srcp= 128;
-		for(mx=r-1; mx<mwidth; mx++){
-		    *dstp += m3[mx];
-		    dstp+= width+1;
-		}
-	    }
-	}
-	for(; y<height-r; y++){
-	    unsigned short *srcp= t + y*(width+1) + 1;
-	    int src= *srcp;
-	    if(src){
-		register unsigned short *dstp= srcp - 1 - r*(width+1);
-		const int src2= (src + 128)>>8;
-		unsigned *m3= m2 + src2*mwidth;
-
-		int mx;
-		*srcp= 128;
-		for(mx=0; mx<mwidth; mx++){
-		    *dstp += m3[mx];
-		    dstp+= width+1;
-		}
-	    }
-	}
-	for(; y<height; y++){
-	    unsigned short *srcp= t + y*(width+1) + 1;
-	    int src= *srcp;
-	    if(src){
-		const int y2=r+height-y;
-		register unsigned short *dstp= srcp - 1 - r*(width+1);
-		const int src2= (src + 128)>>8;
-		unsigned *m3= m2 + src2*mwidth;
-
-		int mx;
-		*srcp= 128;
-		for(mx=0; mx<y2; mx++){
-		    *dstp += m3[mx];
-		    dstp+= width+1;
-		}
-	    }
-	}
-	t++;
-    }
-
-    t = tmp2;
-    s = buffer;
-    for(y=0; y<height; y++){
-	for(x=0; x<width; x++){
-	    s[x]= t[x]>>8;
-	}
-	s+= stride;
-	t+= width + 1;
-    }
-}
-
-#ifdef HAVE_ENCA
-void* guess_buffer_cp(unsigned char* buffer, int buflen, char *preferred_language, char *fallback)
-{
-    const char **languages;
-    size_t langcnt;
-    EncaAnalyser analyser;
-    EncaEncoding encoding;
-    char *detected_sub_cp = NULL;
-    int i;
-
-    languages = enca_get_languages(&langcnt);
-    mp_msg(MSGT_ASS, MSGL_V, "ENCA supported languages: ");
-    for (i = 0; i < langcnt; i++) {
-	mp_msg(MSGT_ASS, MSGL_V, "%s ", languages[i]);
-    }
-    mp_msg(MSGT_ASS, MSGL_V, "\n");
-    
-    for (i = 0; i < langcnt; i++) {
-	const char *tmp;
-	
-	if (strcasecmp(languages[i], preferred_language) != 0) continue;
-	analyser = enca_analyser_alloc(languages[i]);
-	encoding = enca_analyse_const(analyser, buffer, buflen);
-	tmp = enca_charset_name(encoding.charset, ENCA_NAME_STYLE_ICONV);
-	if (tmp && encoding.charset != ENCA_CS_UNKNOWN) {
-	    detected_sub_cp = strdup(tmp);
-	    mp_msg(MSGT_ASS, MSGL_INFO, "ENCA detected charset: %s\n", tmp);
-	}
-	enca_analyser_free(analyser);
-    }
-    
-    free(languages);
-
-    if (!detected_sub_cp) {
-	detected_sub_cp = strdup(fallback);
-	mp_msg(MSGT_ASS, MSGL_INFO, "ENCA detection failed: fallback to %s\n", fallback);
-    }
-
-    return detected_sub_cp;
-}
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.h	2010-09-05 11:57:01 UTC (rev 6587)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/mputils.h	2010-09-06 10:23:18 UTC (rev 6588)
@@ -1,35 +0,0 @@
-#ifndef __MPUTILS_H__
-#define __MPUTILS_H__
-
-#include "help_mp.h"
-
-unsigned utf8_get_char(char **str);
-
-void my_mp_msg(int lvl, char *lvl_str, char *fmt, ...);
-
-#ifdef __VISUALC__
-static void mp_msg(int mod, int level, const char *fmt, ...) {
-	// MSVC doesn't like the # used all around for mp_msg, so it breaks va_arg
-}
-#else
-#define mp_msg(mod, level, args...) my_mp_msg(level, #level, args)
-#endif
-
-#define MSGT_ASS 43
-
-#define MSGL_FATAL 0
-#define MSGL_ERR 1
-#define MSGL_WARN 2
-#define MSGL_INFO 4
-#define MSGL_V 6
-#define MSGL_DBG2 7
-
-void blur(unsigned char *buffer, unsigned short *tmp2, int width, int height,
-          int stride, int *m2, int r, int mwidth);
-
-void* guess_buffer_cp(unsigned char* buffer, int buflen, char *preferred_language, char *fallback);
-
-#define FFMAX(a,b) ((a) > (b) ? (a) : (b))
-#define FFMIN(a,b) ((a) > (b) ? (b) : (a))
-
-#endif



From mean at mail.berlios.de  Mon Sep  6 12:23:21 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:21 +0200
Subject: [Avidemux-svn-commit] r6589 - in
	branches/avidemux_2.6_branch_mean/avidemux: common
	common/ADM_toolkit qt4/ADM_userInterfaces/ADM_gui
Message-ID: <20100906102321.AE512481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:21 +0200 (Mon, 06 Sep 2010)
New Revision: 6589

Added:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h
Log:
[UI] Dynamically create the menu

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp	2010-09-06 10:23:18 UTC (rev 6588)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp	2010-09-06 10:23:21 UTC (rev 6589)
@@ -341,7 +341,7 @@
 
 
 
-void call_buildtimemap(char *p) { UNUSED_ARG(p); aprintf("timemap\n");HandleAction(ACT_AudioMap);         }
+void call_buildtimemap(char *p) { UNUSED_ARG(p); aprintf("timemap\n");      }
 
 void call_setPP(char *v,char *s)
 {

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-09-06 10:23:18 UTC (rev 6588)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-09-06 10:23:21 UTC (rev 6589)
@@ -128,10 +128,8 @@
   switch (action)
     {
         case ACT_TimeShift:
-        case ACT_JumpToFrame:
         case ACT_JumpToTime:
         case ACT_Goto:
-        case ACT_AudioMap:
                                 brokenAct();
                                 return;
         case ACT_PY_SHELL:
@@ -146,9 +144,6 @@
         case ACT_BUILT_IN:
                                 DIA_builtin();
                                 return;
-        case ACT_HANDLE_JOB:
-                                GUI_jobs();
-                                return;
         case ACT_RECENT0:
         case ACT_RECENT1:
         case ACT_RECENT2:
@@ -169,6 +164,12 @@
 	case ACT_VideoConfigure:
     		videoEncoder6Configure();
             return;
+    case ACT_ContainerConfigure:    
+            {
+            int index=UI_GetCurrentFormat();
+            ADM_mux_configure(index);
+            return;
+            }
     case ACT_VideoCodecChanged:
     		nw=UI_getCurrentVCodec();
     		videoEncoder6_SetCurrentEncoder(nw);
@@ -216,13 +217,6 @@
     case ACT_SavePref:
         prefs->save ();
         return;
-    case ACT_SetMuxParam:
-        {
-        int index=UI_GetCurrentFormat();
-        ADM_mux_configure(index);
-        return;
-        }
-      break;
     case ACT_Exit:
       { uint32_t saveprefsonexit;
          prefs->get(FEATURE_SAVEPREFSONEXIT,&saveprefsonexit);
@@ -304,17 +298,6 @@
                 A_audioTrack();
                 break;
 
-        case ACT_Bitrate:
-    			{
-				uint32_t a,b;
-//				DIA_Calculator(&a,&b );
-			}
-    			break;
-
-        case ACT_ADD_JOB:
-            A_addJob();
-            break;
-
     case ACT_OpenAvi:
         GUI_FileSelRead (QT_TR_NOOP("Select AVI File..."),(SELFILE_CB *) A_openAvi);
         break;
@@ -324,9 +307,6 @@
     case ACT_AviInfo:
         DIA_properties ();
         break;
-	case ACT_BitRate:
-		 GUI_displayBitrate(  );
-        break;
     case ACT_PlayAvi:
       GUI_PlayAvi ();
       break;
@@ -354,9 +334,6 @@
     case ACT_SetPostProcessing:
       A_setPostproc();
       break;
-    case ACT_AllBlackFrames:
-      GUI_FileSelWrite (QT_TR_NOOP("Select File to Save"), (SELFILE_CB *)A_ListAllBlackFrames);
-        break;
     case ACT_MarkA:
     case ACT_MarkB:
     {
@@ -407,9 +384,6 @@
 		break;
       break;
 
-    case ACT_VideoCheck:
-    		A_videoCheck();
-		break;
     case ACT_ResetSegments:
        if(avifileinfo)
          if(GUI_Question(QT_TR_NOOP("Are you sure?")))
@@ -447,52 +421,6 @@
         }
         
       break;
-
-    case ACT_ChangeFPS:
-    	{
-         float  fps;
-         aviInfo info;
-         uint32_t useDefined=1;
-         uint32_t defaultFps[3]={25000,23976,29970};
-         uint32_t index=0;
-         video_body->getVideoInfo (&info);
-         fps=info.fps1000;
-         fps/=1000.;
-
-
-
-        diaElemToggle togUsePredefined(&useDefined,QT_TR_NOOP("Use custom value"));
-        diaElemFloat  fpsFloatValue(&fps,QT_TR_NOOP("Frame Rate"),1.,200.,QT_TR_NOOP("_Frames per second"));
-
-        diaMenuEntry menuFps[]={
-              {0,QT_TR_NOOP("PAL - 25 FPS")},
-              {1,QT_TR_NOOP("FILM- 24 FPS")},
-              {2,QT_TR_NOOP("NTSC- 30 FPS")}};
-
-         diaElemMenu      stdFps(&index,QT_TR_NOOP("Standard FrameRate:"),3,menuFps);
-
-        togUsePredefined.link(1,&fpsFloatValue);
-        togUsePredefined.link(0,&stdFps);
-
-        diaElem *elems[3]={&togUsePredefined,&fpsFloatValue,&stdFps};
-        if(diaFactoryRun(QT_TR_NOOP("Change FrameRate"),3,elems))
-        {
-          if(useDefined)
-          {
-            info.fps1000 = (uint32_t) (floor (fps * 1000.+0.49));
-          }else
-          {
-            info.fps1000=defaultFps[index];
-          }
-          video_body->updateVideoInfo (&info);
-          printf("[MainUI] New framerate :%u\n",info.fps1000);
-          // update display
-          video_body->getVideoInfo (avifileinfo);
-          GUI_setAllFrameAndTime();
-
-        }
-	}
-      break;
       // set decoder option (post processing ...)
     case ACT_DecoderOption:
       video_body->setDecodeParam ( admPreview::getCurrentPts());
@@ -501,32 +429,7 @@
     case ACT_VideoParameter:
         GUI_handleVFilter();
         break;
-#if 0
-      // first remove current viewer
-      if (getPreviewMode()!=ADM_PREVIEW_NONE)
-        {
-	         admPreview::stop();
-        }
-      if( getLastVideoFilter()->getInfo()->width % 8 ){
-        GUI_Error_HIG(QT_TR_NOOP("Width is not a multiple of 8"),
-                      QT_TR_NOOP("This will make trouble for AVI files."));
-      }
-      if (getPreviewMode()!=ADM_PREVIEW_NONE)
-      {
-         admPreview::start();
-//         admPreview::update (curframe);
-      }
-#endif
-      break;
 
-    case ACT_RebuildKF:
-      if (GUI_Question (QT_TR_NOOP("Rebuild all Keyframes?")))
-	{
-	  A_rebuildKeyFrame ();
-	  //GUI_Info_HIG ("Done", "Save your file and restart Avidemux.");
-	}
-      break;
-
    case ACT_HEX_DUMP:
       GUI_showCurrentFrameHex();
       break;

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names	2010-09-06 10:23:18 UTC (rev 6588)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names	2010-09-06 10:23:21 UTC (rev 6589)
@@ -1,7 +1,7 @@
-// 
+// load/sabe
 ACT(OpenAvi)
 ACT(AppendAvi)
-ACT(BrokenAvi)
+ACT(SaveAvi)
 ACT(AviInfo)
 ACT(CLOSE)
 ACT(Exit)
@@ -15,13 +15,10 @@
 ACT(SaveImg)
 ACT(SaveJPG)
 ACT(SaveBunchJPG)
-ACT(SaveAvi)
-ACT(SaveWave)
-ACT(SaveRaw)
-ACT(SaveWork)
-ACT(SavePyWork)
-ACT(SaveCurrentWork)
-
+ACT(SaveVideo)
+ACT(SaveAudio)
+ACT(SaveJsProject)
+ACT(SavePyProject)
 ACT(SAVE_END)
 // /SAVE
 
@@ -48,98 +45,53 @@
 ACT(Scale)
 ACT(NAVIGATE_END)
 //--- /NAVIGATE----
-ACT(AllBlackFrames)
-ACT(AudioSourceAvi)
-ACT(AudioSourceMP3)
-ACT(AudioSourceWAV)
-ACT(AudioSourceAC3)
-ACT(AudioSourceNone)
-
+ACT(SavePref)
 ACT(MarkA)
 ACT(MarkB)
-
-ACT(AudioModeProcess)
-ACT(AudioModeCopy)
-ACT(AudioModeToggle)
 ACT(AudioFilters)
-
-ACT(AudioMap)
-
-ACT(VideoModeCopy)
-ACT(VideoModeProcess)
 ACT(VideoParameter)
-ACT(VideoModeToggle)
 
 ACT(Copy)
 ACT(Cut)
 ACT(Paste)
 ACT(Delete)
 ACT(PreviewToggle)
-
-ACT(RebuildKF)
-ACT(BitRate)
-ACT(ChangeFPS)
-ACT(SetMuxParam)
 ACT(DecoderOption)
 
 ACT(SelectEncoder)
 ACT(Fast)
-
-ACT(SecondAudioTrack)
-
-ACT(CutWizard)
-
-ACT(MpegIndex)
-ACT(VideoCheck)
-
 ACT(AudioConfigure)
 
 ACT(OutputToggle)
 
 ACT(VideoConfigure)
+ACT(ContainerConfigure)
 
 ACT(ResetSegments)
 
-ACT(SetLogFile)
-ACT(SavePref)
-
 ACT(VideoCodec)
 ACT(AudioCodec)
 ACT(About)
 
 ACT(Pref)
 
-ACT(Requant)
-ACT(JumpToFrame)
 ACT(JumpToTime)
 ACT(RunScript)
 ACT(RunPyScript)
 ACT(AudioCodecChanged)
 ACT(VideoCodecChanged)
 ACT(PreviewChanged)
-ACT(Bitrate)
-ACT(Ocr)
-ACT(DVB_Ocr)
 ACT(SelectTrack1)
 ACT(ViewMain)
 ACT(ViewSide)
 ACT(TimeShift)
+
 ACT(RECENT0)
 ACT(RECENT1)
 ACT(RECENT2)
 ACT(RECENT3)
 
-ACT(AUTO_VCD)
-ACT(AUTO_SVCD)
-ACT(AUTO_DVD)
-ACT(AUTO_PSP)
-ACT(AUTO_PSP_H264)
-ACT(AUTO_IPOD)
-ACT(AUTO_FLV)
 
-ACT(ADD_JOB)
-ACT(HANDLE_JOB)
-ACT(V2V)
 
 ACT(ZOOM_1_4)
 ACT(ZOOM_1_2)
@@ -151,7 +103,6 @@
 ACT(SIZE_DUMP)
 ACT(AVS_PROXY)
 ACT(JOG)
-ACT(GLYPHEDIT)
 ACT(PLUGIN_INFO)
 ACT(JS_SHELL)
 ACT(PY_SHELL)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp	2010-09-06 10:23:18 UTC (rev 6588)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp	2010-09-06 10:23:21 UTC (rev 6589)
@@ -45,14 +45,15 @@
 {
     switch(action)
     {
-    case ACT_SavePyWork:
+    case ACT_SavePyProject:
             GUI_FileSelWrite (QT_TR_NOOP("Select pyProject to Save"), A_savePyProject);
             UI_refreshCustomMenu();
             break;
-    case ACT_SaveWork:
-      GUI_FileSelWrite (QT_TR_NOOP("Select Project to Save"), A_saveJsProject);
+    case ACT_SaveJsProject:
+      GUI_FileSelWrite (QT_TR_NOOP("Select jsProject to Save"), A_saveJsProject);
 	  UI_refreshCustomMenu();
       break;
+#if 0
    case ACT_SaveCurrentWork:
         {
           const std::string pj=video_body->getProjectName();
@@ -64,11 +65,8 @@
           }
         }
       break;
-      
-    case ACT_SaveRaw:
-        GUI_Error_HIG (QT_TR_NOOP("File error"), QT_TR_NOOP("Deprecated function."));        
-      break;
-    case ACT_SaveWave:
+#endif      
+    case ACT_SaveAudio:
       	{
           GUI_FileSelWrite (QT_TR_NOOP("Select File to Save Audio"),(SELFILE_CB *)A_audioSave);
         }

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-06 10:23:18 UTC (rev 6588)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-06 10:23:21 UTC (rev 6589)
@@ -21,9 +21,6 @@
 #include "Q_gui2.h"
 #include "ADM_default.h"
 
-//#include "ADM_codecs/ADM_codec.h"
-#include "gui_action.hxx"
-//#include "ADM_editor/ADM_outputfmt.h"
 #include "DIA_fileSel.h"
 #include "ADM_vidMisc.h"
 #include "prefs.h"
@@ -79,7 +76,10 @@
 #define CONNECT_TB(object,zzz) connect( (ui.object),SIGNAL(clicked(bool)),this,SLOT(toolButtonPressed(bool)));
 #define DECLARE_VAR(object,signal_name) {#object,signal_name},
 
-#include "translation_table.h"    
+#include "translation_table.h"   
+
+#define MKICON(x) ":/new/prefix1/pics/"#x".png"
+#include "myOwnMenu.h"
 /*
     Declare the table converting widget name to our internal signal           
 */
@@ -187,7 +187,7 @@
 
 void MainWindow::currentFrameChanged(void)
 {
-	HandleAction(ACT_JumpToFrame);
+//	HandleAction(ACT_JumpToFrame);
 
 	this->setFocus(Qt::OtherFocusReason);
 }
@@ -279,6 +279,9 @@
 
 	//connect(ui.currentTime, SIGNAL(editingFinished()), this, SLOT(currentTimeChanged()));
 
+    // Build file,... menu
+    buildMyMenu();
+
 	/* Build the custom menu */
     jsMenu=new QMenu("javaScript");
     pyMenu=new QMenu("tinyPython");
@@ -298,6 +301,67 @@
     
 }
 /**
+    buildFileMenu
+*/
+bool MainWindow::buildMenu(QMenu *root,MenuEntry *menu, int nb)
+{
+    for(int i=0;i<nb;i++)
+    {
+        MenuEntry *m=menu+i;
+        switch(m->type)
+        {
+            case MENU_SEPARATOR:
+                root->addSeparator();
+                break;
+            case MENU_ACTION:
+                {   
+                        
+                        QAction *a=NULL;
+                        if(m->icon) 
+                        {
+                            QIcon icon(m->icon);
+                            a=root->addAction(icon,m->text);
+                        }else
+                            a=root->addAction(m->text);
+                        m->action=a;
+                        break;
+                }
+            default:
+                break;
+        }
+    }
+    return true;
+}
+/**
+    buildFileMenu
+*/
+bool MainWindow::buildMyMenu(void)
+{
+    connect( ui.menuFile,SIGNAL(triggered(QAction*)),this,SLOT(searchFileMenu(QAction*)));
+    buildMenu(ui.menuFile,myMenuFile, sizeof(myMenuFile)/sizeof(MenuEntry));
+
+    connect( ui.menuEdit,SIGNAL(triggered(QAction*)),this,SLOT(searchEditMenu(QAction*)));
+    buildMenu(ui.menuEdit,myMenuEdit, sizeof(myMenuEdit)/sizeof(MenuEntry));
+
+    connect( ui.menuVideo,SIGNAL(triggered(QAction*)),this,SLOT(searchVideoMenu(QAction*)));
+    buildMenu(ui.menuVideo,myMenuVideo, sizeof(myMenuVideo)/sizeof(MenuEntry));
+
+    connect( ui.menuAudio,SIGNAL(triggered(QAction*)),this,SLOT(searchAudioMenu(QAction*)));
+    buildMenu(ui.menuAudio,myMenuAudio, sizeof(myMenuAudio)/sizeof(MenuEntry));
+
+    connect( ui.menuHelp,SIGNAL(triggered(QAction*)),this,SLOT(searchHelpMenu(QAction*)));
+    buildMenu(ui.menuHelp,myMenuHelp, sizeof(myMenuHelp)/sizeof(MenuEntry));
+
+    connect( ui.menuTools,SIGNAL(triggered(QAction*)),this,SLOT(searchToolMenu(QAction*)));
+    buildMenu(ui.menuTools,myMenuTool, sizeof(myMenuTool)/sizeof(MenuEntry));
+
+    connect( ui.menuGo,SIGNAL(triggered(QAction*)),this,SLOT(searchGoMenu(QAction*)));
+    buildMenu(ui.menuGo,myMenuGo, sizeof(myMenuGo)/sizeof(MenuEntry));
+
+    return true;
+}
+
+/**
     \fn timeChanged
     \brief Called whenever timeshift is on/off'ed or value changes
 */
@@ -305,6 +369,54 @@
 {
 	HandleAction (ACT_TimeShift) ;
 }
+/**
+    \fn searchMenu
+*/
+void MainWindow::searchMenu(QAction * action,MenuEntry *menu, int nb)
+{
+    for(int i=0;i<nb;i++)
+    {
+        MenuEntry *m=menu+i;
+        if(m->action==action)
+        {
+            HandleAction (m->event);
+        }
+    }
+}
+
+/**
+    \fn searchFileMenu
+*/
+void MainWindow::searchFileMenu(QAction * action)
+{
+    searchMenu(action,myMenuFile,sizeof(myMenuFile)/sizeof(MenuEntry));
+}
+void MainWindow::searchEditMenu(QAction * action)
+{
+    searchMenu(action,myMenuEdit,sizeof(myMenuEdit)/sizeof(MenuEntry));
+}
+void MainWindow::searchAudioMenu(QAction * action)
+{
+    searchMenu(action,myMenuAudio,sizeof(myMenuAudio)/sizeof(MenuEntry));
+}
+void MainWindow::searchVideoMenu(QAction * action)
+{
+    searchMenu(action,myMenuVideo,sizeof(myMenuVideo)/sizeof(MenuEntry));
+}
+void MainWindow::searchHelpMenu(QAction * action)
+{
+    searchMenu(action,myMenuHelp,sizeof(myMenuHelp)/sizeof(MenuEntry));
+}
+void MainWindow::searchToolMenu(QAction * action)
+{
+    searchMenu(action,myMenuTool,sizeof(myMenuTool)/sizeof(MenuEntry));
+}
+void MainWindow::searchGoMenu(QAction * action)
+{
+    searchMenu(action,myMenuGo,sizeof(myMenuGo)/sizeof(MenuEntry));
+}
+
+
 /*
       We receive a button press event
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h	2010-09-06 10:23:18 UTC (rev 6588)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h	2010-09-06 10:23:21 UTC (rev 6589)
@@ -5,8 +5,31 @@
 #include <QtGui/QWidget>
 
 #include "ADM_qslider.h"
-#include "ui_gui2.h"
-
+#include "ui_gui2.h"
+#include "gui_action.hxx"
+/**
+    \enum MenuType
+*/
+enum MenuType
+{
+    MENU_ACTION,
+    MENU_SEPARATOR
+
+};
+/**
+    \struct MenuEntry
+*/
+typedef struct
+{
+    MenuType   type;
+    const char *text;
+    QAction    *action;
+    Action     event;
+    const char *icon; 
+}MenuEntry;
+/**
+    \class MainWindow
+*/
 class MainWindow : public QMainWindow
 {
 	Q_OBJECT
@@ -14,8 +37,11 @@
 public:
 	MainWindow();
 	virtual ~MainWindow();	
-	void buildCustomMenu(void);
-	
+	void buildCustomMenu(void);
+    bool buildMyMenu(void);
+    bool buildMenu(QMenu *root,MenuEntry *menu, int nb);
+    void searchMenu(QAction * action,MenuEntry *menu, int nb);
+    
 	Ui_MainWindow ui;
 protected:
     QMenu *jsMenu;
@@ -39,6 +65,13 @@
 	void timeChangeFinished(void);
 	void currentFrameChanged(void);
 	void currentTimeChanged(void);
+    void searchFileMenu(QAction * action);
+    void searchEditMenu(QAction * action);
+    void searchVideoMenu(QAction * action);
+    void searchAudioMenu(QAction * action);
+    void searchHelpMenu(QAction * action);
+    void searchToolMenu(QAction * action);
+    void searchGoMenu(QAction * action);
 
 protected:
 	void clearCustomMenu(void);

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui	2010-09-06 10:23:18 UTC (rev 6588)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui	2010-09-06 10:23:21 UTC (rev 6589)
@@ -1279,35 +1279,16 @@
     <property name="title">
      <string>&amp;Help</string>
     </property>
-    <addaction name="actionShow_built_in_support"/>
-    <addaction name="actionPlugins"/>
-    <addaction name="actionAbout_avidemux"/>
    </widget>
    <widget class="QMenu" name="menuVideo">
     <property name="title">
      <string>Vi&amp;deo</string>
     </property>
-    <addaction name="actionDecoder_options"/>
-    <addaction name="actionPostprocessing"/>
-    <addaction name="separator"/>
-    <addaction name="actionFilters"/>
-    <addaction name="actionFrame_rate"/>
    </widget>
    <widget class="QMenu" name="menuEdit">
     <property name="title">
      <string>&amp;Edit</string>
     </property>
-    <addaction name="actionReset_Edits"/>
-    <addaction name="separator"/>
-    <addaction name="actionCut"/>
-    <addaction name="actionCopy"/>
-    <addaction name="actionPaste"/>
-    <addaction name="actionDelete"/>
-    <addaction name="separator"/>
-    <addaction name="actionSet_marker_A"/>
-    <addaction name="actionSet_marker_B"/>
-    <addaction name="separator"/>
-    <addaction name="actionPreferences"/>
    </widget>
    <widget class="QMenu" name="menuView">
     <property name="title">
@@ -1350,87 +1331,22 @@
     <property name="title">
      <string>&amp;Go</string>
     </property>
-    <addaction name="actionPlay"/>
-    <addaction name="actionPrevious_Frame"/>
-    <addaction name="actionNext_Frame"/>
-    <addaction name="actionPrevious_intra_frame"/>
-    <addaction name="actionNext_intra_frame"/>
-    <addaction name="actionPrevious_black_frame"/>
-    <addaction name="actionNext_blak_frame"/>
-    <addaction name="actionFirst_Frame"/>
-    <addaction name="actionLast_Frame"/>
-    <addaction name="separator"/>
-    <addaction name="actionGo_to_Marker_A"/>
-    <addaction name="actionGo_to_Marker_B"/>
-    <addaction name="separator"/>
-    <addaction name="actionJump_to_Time"/>
    </widget>
    <widget class="QMenu" name="menuTools">
     <property name="title">
      <string>&amp;Tools</string>
     </property>
-    <addaction name="actionCalculator"/>
-    <addaction name="separator"/>
-    <addaction name="actionRebuild_I_B_Frames"/>
-    <addaction name="actionBitrate_histogram"/>
-    <addaction name="actionScan_for_black_frames"/>
-    <addaction name="separator"/>
-    <addaction name="actionJavaScript_shell"/>
-    <addaction name="actionPython_Shell"/>
    </widget>
    <widget class="QMenu" name="menuAudio">
     <property name="title">
      <string>&amp;Audio</string>
     </property>
-    <addaction name="actionMain_Track"/>
-    <addaction name="actionSecondary_Track"/>
-    <addaction name="actionBuild_VBR_time_map"/>
-    <addaction name="separator"/>
-    <addaction name="actionSave_2"/>
-    <addaction name="actionFilters_2"/>
    </widget>
    <widget class="QMenu" name="menuFile">
     <property name="title">
      <string>&amp;File</string>
     </property>
-    <widget class="QMenu" name="menuRecent_Files">
-     <property name="title">
-      <string>&amp;Recent Files</string>
-     </property>
-     <addaction name="actionRecent0"/>
-     <addaction name="actionRecent1"/>
-     <addaction name="actionRecent2"/>
-     <addaction name="actionRecent3"/>
-    </widget>
-    <widget class="QMenu" name="menuSave">
-     <property name="title">
-      <string>&amp;Save</string>
-     </property>
-     <addaction name="actionSave_video"/>
-     <addaction name="separator"/>
-     <addaction name="actionSave_BMP"/>
-     <addaction name="actionSave_jpeg"/>
-    </widget>
-    <addaction name="actionOpen"/>
-    <addaction name="menuRecent_Files"/>
-    <addaction name="actionAppend"/>
-    <addaction name="menuSave"/>
-    <addaction name="actionClose"/>
     <addaction name="separator"/>
-    <addaction name="actionProperties"/>
-    <addaction name="separator"/>
-    <addaction name="actionLoad_run_project"/>
-    <addaction name="actionLoad_run_pyProject"/>
-    <addaction name="actionSave_project"/>
-    <addaction name="actionSave_project_as"/>
-    <addaction name="actionSave_pyScript"/>
-    <addaction name="separator"/>
-    <addaction name="actionAdd_to_joblist"/>
-    <addaction name="actionShow_Joblist"/>
-    <addaction name="separator"/>
-    <addaction name="actionConnect_to_AvsProxy"/>
-    <addaction name="separator"/>
-    <addaction name="actionQuit"/>
    </widget>
    <addaction name="menuFile"/>
    <addaction name="menuEdit"/>

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h	2010-09-06 10:23:21 UTC (rev 6589)
@@ -0,0 +1,65 @@
+
+MenuEntry myMenuFile[]= {
+            {MENU_ACTION,"Open",    NULL,ACT_OpenAvi,       MKICON(fileopen)},
+            {MENU_ACTION,"Append",  NULL,ACT_AppendAvi      ,NULL},
+            {MENU_ACTION,"Save",    NULL,ACT_SaveAvi        ,MKICON(filesaveas)},
+            {MENU_ACTION,"Close",   NULL,ACT_CLOSE          ,NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_ACTION,"Information",NULL,ACT_AviInfo     ,MKICON(info)},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_ACTION,"Connect to avsproxy",NULL,ACT_AVS_PROXY,NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_ACTION,"Quit",    NULL,ACT_Exit           ,NULL}
+        };
+
+MenuEntry myMenuEdit[]= {
+            {MENU_ACTION,"Reset Edit",  NULL,ACT_ResetSegments,NULL},
+            {MENU_ACTION,"Cut",         NULL,ACT_Cut        ,NULL},
+            {MENU_ACTION,"Copy",        NULL,ACT_Copy       ,NULL},
+            {MENU_ACTION,"Paste",       NULL,ACT_Paste      ,NULL},
+            {MENU_ACTION,"Delete",      NULL,ACT_Delete     ,NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_ACTION,"Set Marker A",NULL,ACT_MarkA      ,NULL},
+            {MENU_ACTION,"Set Marker B",NULL,ACT_MarkB      ,NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_ACTION,"Preferences", NULL,ACT_Pref       ,NULL},
+        };
+
+MenuEntry myMenuVideo[]= {
+            {MENU_ACTION,"Decoder Option",  NULL,ACT_DecoderOption      ,NULL},
+            {MENU_ACTION,"PostProcessing",  NULL,ACT_SetPostProcessing  ,NULL},
+            {MENU_ACTION,"Filters ",        NULL,ACT_VideoConfigure     ,NULL},
+        };
+
+MenuEntry myMenuAudio[]= {
+            {MENU_ACTION,"Select Track",    NULL,ACT_SelectTrack1       ,NULL},
+            {MENU_ACTION,"Save audio",      NULL,ACT_SaveAudio          ,NULL},
+            {MENU_ACTION,"Filters ",        NULL,ACT_AudioFilters       ,NULL},
+        };
+
+MenuEntry myMenuHelp[]= {
+            {MENU_ACTION,"Build Option",    NULL,ACT_BUILT_IN           ,NULL},
+            {MENU_ACTION,"Plugins",         NULL,ACT_PLUGIN_INFO        ,NULL},
+            {MENU_ACTION,"About ",          NULL,ACT_About              ,NULL},
+        };
+
+MenuEntry myMenuTool[]= {
+            {MENU_ACTION,"JavaScript Shell",NULL,ACT_JS_SHELL           ,NULL},
+            {MENU_ACTION,"TinyPy Shell",    NULL,ACT_PY_SHELL           ,NULL},
+        };
+MenuEntry myMenuGo[]= {
+            {MENU_ACTION,"Play/Stop",           NULL,ACT_JS_SHELL,       MKICON(player_play)},
+            {MENU_ACTION,"Previous Frame",      NULL,ACT_PY_SHELL       ,MKICON(previous)},
+            {MENU_ACTION,"Next Frame",          NULL,ACT_PY_SHELL       ,MKICON(next)},
+            {MENU_ACTION,"Previous Intra Frame",NULL,ACT_PY_SHELL       ,MKICON(player_rew)},
+            {MENU_ACTION,"Next Intra Frame",    NULL,ACT_PY_SHELL       ,MKICON(player_fwd)},
+            {MENU_ACTION,"Previous Black Frame",NULL,ACT_PY_SHELL       ,MKICON(prev_black)},
+            {MENU_ACTION,"Next Black Frame",    NULL,ACT_PY_SHELL       ,MKICON(next_black)},
+            {MENU_ACTION,"First Frame",          NULL,ACT_PY_SHELL      ,MKICON(player_start)},
+            {MENU_ACTION,"Last Frame",          NULL,ACT_PY_SHELL       ,MKICON(player_end)},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY,NULL},
+            {MENU_ACTION,"Go To Marker A",      NULL,ACT_PY_SHELL       ,MKICON(markA)},
+            {MENU_ACTION,"Go To Marker B",      NULL,ACT_PY_SHELL       ,MKICON(markB)},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY,NULL},
+            {MENU_ACTION,"Go To Time",          NULL,ACT_PY_SHELL       ,NULL},
+        };

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h	2010-09-06 10:23:18 UTC (rev 6588)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h	2010-09-06 10:23:21 UTC (rev 6589)
@@ -1,88 +1,15 @@
 #define LIST_OF_OBJECTS     \
-PROCESS(actionOpen,ACT_OpenAvi) \
-PROCESS(actionClose,ACT_CLOSE) \
-PROCESS(actionAppend,ACT_AppendAvi) \
-PROCESS(actionQuit,ACT_Exit) \
-PROCESS(actionCut,ACT_Cut) \
-PROCESS(actionCopy,ACT_Copy) \
-PROCESS(actionPaste,ACT_Paste) \
-PROCESS(actionDelete,ACT_Delete) \
-PROCESS(actionSet_marker_A,ACT_MarkA) \
-PROCESS(actionSet_marker_B,ACT_MarkB) \
-PROCESS(actionPreferences,ACT_Pref) \
-PROCESS(actionProperties,ACT_AviInfo) \
-PROCESS(actionSave_video,ACT_SaveAvi) \
-PROCESS(actionSave_BMP,ACT_SaveImg) \
-PROCESS(actionSave_jpeg,ACT_SaveJPG) \
-PROCESS(actionLoad_run_project,ACT_RunScript) \
-PROCESS(actionSave_project,ACT_SaveCurrentWork) \
-PROCESS(actionSave_project_as,ACT_SaveWork) \
-PROCESS(actionConnect_to_AvsProxy,ACT_AVS_PROXY) \
-PROCESS(actionReset_Edits,ACT_ResetSegments) \
 PROCESS(actionZoom_1_4,ACT_ZOOM_1_4) \
 PROCESS(actionZoom_1_2,ACT_ZOOM_1_2) \
 PROCESS(actionZoom_1_1,ACT_ZOOM_1_1) \
 PROCESS(actionZoom_2_1,ACT_ZOOM_2_1) \
-PROCESS(actionDecoder_options,ACT_DecoderOption) \
-PROCESS(actionPostprocessing,ACT_SetPostProcessing) \
-PROCESS(actionFrame_rate,ACT_ChangeFPS) \
-PROCESS(actionEncoder,ACT_SelectEncoder) \
-PROCESS(actionFilters,ACT_VideoParameter) \
-PROCESS(actionMain_Track,ACT_SelectTrack1) \
-PROCESS(actionSecondary_Track,ACT_SecondAudioTrack) \
-PROCESS(actionBuild_VBR_time_map,ACT_AudioMap) \
-PROCESS(actionSave_2,ACT_SaveWave) \
-PROCESS(actionEncoder_2,ACT_SelectEncoder) \
-PROCESS(actionFilters_2,ACT_AudioFilters) \
-PROCESS(actionCalculator,ACT_Bitrate) \
-PROCESS(actionRebuild_I_B_Frames,ACT_RebuildKF) \
-PROCESS(actionBitrate_histogram,ACT_BitRate) \
-PROCESS(actionScan_for_black_frames,ACT_AllBlackFrames) \
-PROCESS(actionPlay_Stop,ACT_StopAvi) \
-PROCESS(actionPrevious_Frame,ACT_PreviousFrame) \
-PROCESS(actionNext_Frame,ACT_NextFrame) \
-PROCESS(actionPrevious_black_frame,ACT_PrevBlackFrame) \
-PROCESS(actionNext_blak_frame,ACT_NextBlackFrame) \
-PROCESS(actionFirst_Frame,ACT_Begin) \
-PROCESS(actionLast_Frame,ACT_End) \
-PROCESS(actionGo_to_Marker_A,ACT_GotoMarkA) \
-PROCESS(actionGo_to_Marker_B,ACT_GotoMarkB) \
-PROCESS(actionJump_to_Time,ACT_GotoTime) \
-PROCESS(actionShow_built_in_support,ACT_BUILT_IN) \
-PROCESS(actionAbout_avidemux,ACT_About) \
-PROCESS(actionPlay,ACT_PlayAvi) \
-PROCESS(actionRecent0,ACT_RECENT0) \
-PROCESS(actionRecent1,ACT_RECENT1) \
-PROCESS(actionRecent2,ACT_RECENT2) \
-PROCESS(actionRecent3,ACT_RECENT3) \
-PROCESS(actionVCD,ACT_AUTO_VCD) \
-PROCESS(actionSVCD,ACT_AUTO_SVCD) \
-PROCESS(actionDVD,ACT_AUTO_DVD) \
-PROCESS(actionPSP,ACT_AUTO_PSP) \
-PROCESS(actionFLV,ACT_AUTO_FLV) \
-PROCESS(actionPSP_H264,ACT_AUTO_PSP_H264)\
-PROCESS(actionIPOD,ACT_AUTO_IPOD) \
-PROCESS(actionAdd_to_joblist,ACT_ADD_JOB) \
-PROCESS(actionShow_Joblist,ACT_HANDLE_JOB)  \
-PROCESS(actionPlugins,ACT_PLUGIN_INFO) \
-PROCESS(actionJavaScript_shell,ACT_JS_SHELL) \
-PROCESS(actionLoad_run_pyProject,ACT_RunPyScript) \
-PROCESS(actionPython_Shell,ACT_PY_SHELL) \
-PROCESS(actionSave_pyScript,ACT_SavePyWork) \
 
-#if 0
-PROCESS(actionPrevious_intra_frame,ACT_PreviousKFrame) \
-PROCESS(actionNext_intra_frame,ACT_NextKFrame) \
-PROCESS(actionZoom_4_1,ACT_ZOOM_4_1) \
-PROCESS(actionA_V_toolbar,ACT_DUMMY)
-#endif
-
 #define LIST_OF_BUTTONS     PROCESS(pushButtonVideoConf, ACT_VideoCodec)  \
 PROCESS(pushButtonVideoFilter, ACT_VideoParameter) \
 PROCESS(pushButtonAudioConf, ACT_AudioCodec) \
-PROCESS(pushButtonFormatConfigure, ACT_SetMuxParam) \
 PROCESS(pushButtonAudioFilter, ACT_AudioFilters) \
 PROCESS(pushButtonDecoderConf, ACT_DecoderOption) \
+PROCESS(pushButtonFormatConfigure, ACT_ContainerConfigure) \
 PROCESS(toolButtonPlay, ACT_PlayAvi) \
 PROCESS(toolButtonStop, ACT_StopAvi) \
 PROCESS(toolButtonPreviousFrame, ACT_PreviousFrame) \
@@ -98,13 +25,3 @@
 PROCESS(pushButtonJumpToMarkerA, ACT_GotoMarkA) \
 PROCESS(pushButtonJumpToMarkerB, ACT_GotoMarkB) \
 PROCESS(pushButtonTime, ACT_GotoTime)
-
-
-/*
-PROCESS(actionVob_to_vobsub,ACT_V2V) \
-PROCESS(actionOCR,ACT_Ocr) \
-PROCESS(actionOCR_DVB_T_TS_files,ACT_DVB_Ocr) \
-PROCESS(actionGlyphs_Edit,ACT_GLYPHEDIT) \
-
-
-*/



From mean at mail.berlios.de  Mon Sep  6 12:23:22 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:22 +0200
Subject: [Avidemux-svn-commit] r6590 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass
Message-ID: <20100906102323.0D108481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:22 +0200 (Mon, 06 Sep 2010)
New Revision: 6590

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_vidASS.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/CMakeLists.txt
Log:
[Ass] Update

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_vidASS.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_vidASS.cpp	2010-09-06 10:23:21 UTC (rev 6589)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_vidASS.cpp	2010-09-06 10:23:22 UTC (rev 6590)
@@ -33,10 +33,11 @@
 {
 protected:
         ass_ssa         param;
-        ass_library_t   *_ass_lib;
-        ass_renderer_t  *_ass_rend;
-        ass_track_t     *_ass_track;
-        bool            init(void);
+        ASS_Library     *_ass_lib;
+        ASS_Renderer    *_ass_rend;
+        ASS_Track       *_ass_track;
+        bool            setup(void);
+        bool            cleanup(void);
         ADMImage        *src;
 public:
                     subAss(ADM_coreVideoFilter *previous,CONFcouple *conf);
@@ -112,13 +113,13 @@
         src=new ADMImageDefault(in->getInfo()->width,in->getInfo()->height);
 
         /* ASS initialization */
-        _ass_lib = ass_library_init();
+        _ass_lib = NULL;
         _ass_track = NULL;
         _ass_rend = NULL;
-        ADM_assert(_ass_lib);
+        
         if(param.subtitleFile)
         {
-              if(!init())
+              if(!this->setup())
               {
                 GUI_Error_HIG("Format ?","Are you sure this is an ass file ?"); 
               }
@@ -136,27 +137,8 @@
         
         DELETE(param.subtitleFile);
         DELETE(param.fontDirectory);
-
-#if ASS_HAS_GLOBAL
-        if(_ass_rend) 
-        {
-              ass_renderer_done(_ass_rend);
-              _ass_rend = NULL;
-         }
-
-        if(_ass_track) 
-        {
-              ass_free_track(_ass_track);
-              _ass_track = NULL;
-        }
-        if(_ass_lib) 
-        {
-              ass_library_done(_ass_lib);
-              _ass_lib = NULL;
-        }
-#endif
+        cleanup();
 }
-
 /**
     \fn getCoupledConf
     \brief Return our current configuration as couple name=value
@@ -193,32 +175,54 @@
 #define MKME(x,y) param.y=(float)x
     MKME(scale,font_scale);
     MKME(spacing,line_spacing);
-
+     cleanup();
+     setup();
      return true;
    }
    return false;
 }
 
 /**
-    \fn init
+    \fn cleanup
 */
-bool subAss::init(void)
+bool subAss::cleanup(void)
 {
+        if(_ass_rend) 
+        {
+              ass_renderer_done(_ass_rend);
+              _ass_rend = NULL;
+         }
+
+        if(_ass_track) 
+        {
+              ass_free_track(_ass_track);
+              _ass_track = NULL;
+        }
+        if(_ass_lib) 
+        {
+              ass_library_done(_ass_lib);
+              _ass_lib = NULL;
+        }
+        return true;
+}
+/**
+    \fn setup
+*/
+bool subAss::setup(void)
+{
 bool use_margins = ( param.topMargin | param.bottomMargin ) != 0;
 
+        // update outpur image size
         memcpy(&info,previousFilter->getInfo(),sizeof(info));
         info.height += param.topMargin + param.bottomMargin;
+        
+        
+        _ass_lib=ass_library_init();
+        ADM_assert(_ass_lib);
 
-        ass_set_fonts_dir(_ass_lib, (const char*)param.fontDirectory);
-        ass_set_extract_fonts(_ass_lib, param.extractEmbeddedFonts);
+/*        ass_set_fonts_dir(_ass_lib, (const char*)param.fontDirectory);*/
+/*        ass_set_extract_fonts(_ass_lib, param.extractEmbeddedFonts);*/
         ass_set_style_overrides(_ass_lib, NULL);
-#if ASS_HAS_GLOBAL
-         if(_ass_rend) 
-        {
-              ass_renderer_done(_ass_rend);
-              _ass_rend = NULL;
-         }
-#endif
         _ass_rend = ass_renderer_init(_ass_lib);
 
         ADM_assert(_ass_rend);
@@ -227,18 +231,14 @@
         ass_set_margins(_ass_rend, param.topMargin, param.bottomMargin, 0, 0);
         ass_set_use_margins(_ass_rend, use_margins);
         ass_set_font_scale(_ass_rend, param.font_scale);
-        ass_set_fonts(_ass_rend, NULL, "Sans");
+//ASS_Renderer *priv, const char *default_font, const char *default_family, int fc, const char *config,                   int update);
+        int fc=0;
+#ifdef USE_FONTCONFIG
+        fc=1;
+#endif
+        ass_set_fonts(_ass_rend, NULL, "Sans",fc,NULL,true);
         //~ ass_set_aspect_ratio(_ass_rend, ((double)_info.width) / ((double)_info.height));
-#if ASS_HAS_GLOBAL
-        if(_ass_track) 
-        {
-              ass_free_track(_ass_track);
-              _ass_track = NULL;
-        }
-#endif
        _ass_track = ass_read_file(_ass_lib, (char*)param.subtitleFile, NULL);
-
-//        ADM_assert(_ass_track);
         if(!_ass_track)
           GUI_Error_HIG("SSA Error","Cannot read_file for *%s*",(char*)param.subtitleFile);
         return 1;
@@ -310,7 +310,7 @@
 
         image->copyInfo(src); // pts etc..
         // Do we have something to render ?
-        if(!_ass_rend || !_ass_track)
+        if(!_ass_rend || !_ass_track || !_ass_lib)
         {
           printf("[Ass] No sub to render\n");
           return true; 
@@ -319,7 +319,7 @@
         int changed=0;
         int64_t now=previousFilter->getAbsoluteStartTime()+src->Pts;
         now/=1000; // Ass works in ms
-        ass_image_t *img = ass_render_frame(_ass_rend, _ass_track, now,&changed);
+        ASS_Image *img = ass_render_frame(_ass_rend, _ass_track, now,&changed);
         //printf("Time is now %d ms\n",now);
 
         while(img) {

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/CMakeLists.txt	2010-09-06 10:23:21 UTC (rev 6589)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/CMakeLists.txt	2010-09-06 10:23:22 UTC (rev 6590)
@@ -12,6 +12,7 @@
          TARGET_LINK_LIBRARIES(ADM_vf_ssa ADM_libass )
 	 ADD_TARGET_LDFLAGS(ADM_vf_ssa "${FREETYPE2_LDFLAGS}")
 	 IF (FONTCONFIG_FOUND)
+                ADD_DEFINITIONS("-DUSE_FONTCONFIG")
 		ADD_TARGET_LDFLAGS(ADM_vf_ssa "${FONTCONFIG_LDFLAGS}")
 	 ENDIF (FONTCONFIG_FOUND)
         ENDIF(DO_COMMON)



From mean at mail.berlios.de  Mon Sep  6 12:23:24 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:24 +0200
Subject: [Avidemux-svn-commit] r6591 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegPS
Message-ID: <20100906102324.32883481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:24 +0200 (Mon, 06 Sep 2010)
New Revision: 6591

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegPS/ADM_psIndex.cpp
Log:
[Ps/Demux] Extract additionnal info : display w, display h for display only (unused)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegPS/ADM_psIndex.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegPS/ADM_psIndex.cpp	2010-09-06 10:23:22 UTC (rev 6590)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegPS/ADM_psIndex.cpp	2010-09-06 10:23:24 UTC (rev 6591)
@@ -260,13 +260,25 @@
                           break;
                   case 0xB5: //  extension
                                 { 
-                                    uint8_t id=pkt->readi8()>>4;
+                                    uint8_t firstByte=pkt->readi8();
+                                    uint8_t id=firstByte>>4;
                                     uint8_t two;
                                     switch(id)
                                     {
                                         case 1: // Sequence extension
-                                            val=(val>>3)&1; // gop type progressive, unreliable, not used
                                             break;
+                                        case 2: // Sequence display extension
+                                            if(firstByte&1)
+                                            {
+                                               for(int i=0;i<3;i++) pkt->readi8();
+                                            }
+                                            {
+                                                uint32_t extSize=pkt->readi32();
+                                                uint32_t eh=(extSize<<15)>>18;
+                                                uint32_t ew=(extSize)>>18;
+                                                printf("**** %x ->%d x %d\n",extSize,ew,eh);
+                                            }
+                                            break;
                                         case 8: // picture coding extension (mpeg2)
                                         {
                                             // skip motion vector



From mean at mail.berlios.de  Mon Sep  6 12:23:25 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:25 +0200
Subject: [Avidemux-svn-commit] r6592 - in
	branches/avidemux_2.6_branch_mean/avidemux: common
	qt4/ADM_userInterfaces/ADM_gui
Message-ID: <20100906102325.725A4481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:25 +0200 (Mon, 06 Sep 2010)
New Revision: 6592

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h
Log:
[UI/Qt4] Remove the translation table, hook manually the toolbar

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-09-06 10:23:24 UTC (rev 6591)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-09-06 10:23:25 UTC (rev 6592)
@@ -181,10 +181,10 @@
     case ACT_PLUGIN_INFO:
             DIA_pluginsInfo();
             return;
-    case ACT_RunPyScript:
+    case ACT_RunPyProject:
             GUI_FileSelRead (QT_TR_NOOP("Select python script to Run"),(SELFILE_CB *) A_parseTinyPyScript);
     		return;
-    case ACT_RunScript:
+    case ACT_RunJSProject:
             GUI_FileSelRead (QT_TR_NOOP("Select ECMAScript to Run"),(SELFILE_CB *) A_parseECMAScript);
     		return;
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names	2010-09-06 10:23:24 UTC (rev 6591)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names	2010-09-06 10:23:25 UTC (rev 6592)
@@ -1,14 +1,12 @@
 // load/sabe
 ACT(OpenAvi)
 ACT(AppendAvi)
-ACT(SaveAvi)
 ACT(AviInfo)
 ACT(CLOSE)
 ACT(Exit)
 ACT(PlayAvi)
 ACT(StopAvi)
 ACT(RecentFiles)
-
 ACT(SetPostProcessing)
 //----- SAVE -----
 ACT(SAVE_BEGIN)
@@ -21,6 +19,8 @@
 ACT(SavePyProject)
 ACT(SAVE_END)
 // /SAVE
+ACT(RunJSProject)
+ACT(RunPyProject)
 
 //--- NAVIGATE----
 ACT(NAVIGATE_BEGIN)
@@ -76,8 +76,6 @@
 ACT(Pref)
 
 ACT(JumpToTime)
-ACT(RunScript)
-ACT(RunPyScript)
 ACT(AudioCodecChanged)
 ACT(VideoCodecChanged)
 ACT(PreviewChanged)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp	2010-09-06 10:23:24 UTC (rev 6591)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp	2010-09-06 10:23:25 UTC (rev 6592)
@@ -84,7 +84,7 @@
       	//GUI_FileSelWrite ("Select Jpg to save ", A_saveJpg);
       	break;
 //----------------------test-----------------------
-    case ACT_SaveAvi:
+    case ACT_SaveVideo:
       GUI_FileSelWrite (QT_TR_NOOP("Select File to Save"),(SELFILE_CB *)A_SaveWrapper); // A_SaveAudioNVideo);
       break;
 //---------------------------------------------------

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-06 10:23:24 UTC (rev 6591)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-06 10:23:25 UTC (rev 6592)
@@ -92,7 +92,6 @@
 const adm_qt4_translation myTranslationTable[]=
 {
 #define PROCESS DECLARE_VAR
-	LIST_OF_OBJECTS
 	LIST_OF_BUTTONS
 #undef PROCESS
 };
@@ -199,7 +198,9 @@
 	this->setFocus(Qt::OtherFocusReason);
 }
 
-
+/**
+    \fn ctor
+*/
 MainWindow::MainWindow() : QMainWindow()
 {
 	ui.setupUi(this);
@@ -231,9 +232,6 @@
 	/*
 	Connect our button to buttonPressed
 	*/
-#define PROCESS CONNECT
-	LIST_OF_OBJECTS
-#undef PROCESS
 #define PROCESS CONNECT_TB
 	LIST_OF_BUTTONS
 #undef PROCESS
@@ -289,22 +287,71 @@
     ui.menuCustom->addMenu(pyMenu);
 	buildCustomMenu();
 
+    recentFiles=new QMenu("Recent Files");
+    recentProjects=new QMenu("Recent Projects");
+    ui.menuRecent->addMenu(recentFiles);
+    ui.menuRecent->addMenu(recentProjects);
+    connect( ui.menuRecent,SIGNAL(triggered(QAction*)),this,SLOT(searchRecentFiles(QAction*)));
+
 	this->installEventFilter(this);
 	slider->installEventFilter(this);
-	
+    
 	//ui.currentTime->installEventFilter(this);
 
 	this->setFocus(Qt::OtherFocusReason);
 
 	setAcceptDrops(true);
     setWindowIcon(QIcon(":/new/prefix1/pics/avidemux_icon_small.png"));
+
+    // Hook also the toolbar
+    connect(ui.toolBar,  SIGNAL(actionTriggered ( QAction *)),this,SLOT(searchToolBar(QAction *)));
+    connect(ui.toolBar_2,SIGNAL(actionTriggered ( QAction *)),this,SLOT(searchToolBar(QAction *)));
+
     
 }
 /**
-    buildFileMenu
+    \fn searchToolBar
 */
+typedef struct 
+{
+    const char *name;
+    Action event;
+}toolBarTranslate;
+
+toolBarTranslate toolbar[]=
+{
+{"actionOpen",              ACT_OpenAvi},
+{"actionSave_video",        ACT_SaveVideo},
+{"actionProperties",        ACT_AviInfo},
+{"actionLoad_run_project",  ACT_RunPyProject},
+{"actionSave_project",      ACT_SavePyProject},
+//{"actionPreviewInput",ACT_PreviewToggle},
+//{"actionPreviewOutput",ACT_PreviewToggle},
+
+{NULL,ACT_DUMMY}
+};
+void MainWindow::searchToolBar(QAction *action)
+{
+        toolBarTranslate *t=toolbar;
+        QString me(action->objectName());
+        const char *name=me.toUtf8().constData();
+        while(t->name)
+        {
+            if(!strcmp(name,t->name))
+            {
+                HandleAction(t->event);
+                return;
+            }
+            t++;
+        }
+        ADM_warning("Toolbar:Cannot handle %s\n",name);
+}
+/**
+    \fn buildFileMenu
+*/
 bool MainWindow::buildMenu(QMenu *root,MenuEntry *menu, int nb)
 {
+    QMenu *subMenu=NULL;
     for(int i=0;i<nb;i++)
     {
         MenuEntry *m=menu+i;
@@ -313,16 +360,23 @@
             case MENU_SEPARATOR:
                 root->addSeparator();
                 break;
+            case MENU_SUBMENU:
+                {
+                    subMenu=root->addMenu(m->text);
+                }
+                break;
+            case MENU_SUBACTION:
             case MENU_ACTION:
                 {   
-                        
+                        QMenu *insert=root;
+                        if(m->type==MENU_SUBACTION) insert=subMenu;
                         QAction *a=NULL;
                         if(m->icon) 
                         {
                             QIcon icon(m->icon);
-                            a=root->addAction(icon,m->text);
+                            a=insert->addAction(icon,m->text);
                         }else
-                            a=root->addAction(m->text);
+                            a=insert->addAction(m->text);
                         m->action=a;
                         break;
                 }
@@ -358,6 +412,9 @@
     connect( ui.menuGo,SIGNAL(triggered(QAction*)),this,SLOT(searchGoMenu(QAction*)));
     buildMenu(ui.menuGo,myMenuGo, sizeof(myMenuGo)/sizeof(MenuEntry));
 
+    connect( ui.menuView,SIGNAL(triggered(QAction*)),this,SLOT(searchViewMenu(QAction*)));
+    buildMenu(ui.menuView,myMenuView, sizeof(myMenuView)/sizeof(MenuEntry));
+
     return true;
 }
 
@@ -387,36 +444,22 @@
 /**
     \fn searchFileMenu
 */
-void MainWindow::searchFileMenu(QAction * action)
-{
-    searchMenu(action,myMenuFile,sizeof(myMenuFile)/sizeof(MenuEntry));
-}
-void MainWindow::searchEditMenu(QAction * action)
-{
-    searchMenu(action,myMenuEdit,sizeof(myMenuEdit)/sizeof(MenuEntry));
-}
-void MainWindow::searchAudioMenu(QAction * action)
-{
-    searchMenu(action,myMenuAudio,sizeof(myMenuAudio)/sizeof(MenuEntry));
-}
-void MainWindow::searchVideoMenu(QAction * action)
-{
-    searchMenu(action,myMenuVideo,sizeof(myMenuVideo)/sizeof(MenuEntry));
-}
-void MainWindow::searchHelpMenu(QAction * action)
-{
-    searchMenu(action,myMenuHelp,sizeof(myMenuHelp)/sizeof(MenuEntry));
-}
-void MainWindow::searchToolMenu(QAction * action)
-{
-    searchMenu(action,myMenuTool,sizeof(myMenuTool)/sizeof(MenuEntry));
-}
-void MainWindow::searchGoMenu(QAction * action)
-{
-    searchMenu(action,myMenuGo,sizeof(myMenuGo)/sizeof(MenuEntry));
-}
+#define MKMENU(name) void MainWindow::search##name##Menu(QAction * action) \
+    {searchMenu(action,myMenu##name,sizeof(myMenu##name)/sizeof(MenuEntry));}
 
+MKMENU(File)
+MKMENU(Edit)
+//MKMENU(Recent)
+MKMENU(View)
+MKMENU(Tool)
+MKMENU(Go)
+//MKMENU(Custom)
+MKMENU(Audio)
+MKMENU(Video)
+MKMENU(Help)
 
+
+
 /*
       We receive a button press event
 */
@@ -510,7 +553,33 @@
 
 	return QObject::eventFilter(watched, event);
 }
-
+/**
+    \fn buildRecentMenu
+*/
+bool MainWindow::buildRecentMenu(void)
+{
+    const char **names;
+	names=prefs->get_lastfiles();
+    // Purge entries...
+    recentFiles->clear();
+    for(int i=0;i<4;i++)
+    {
+        if(names[i])
+        {
+            recentFileAction[i]=recentFiles->addAction(QString::fromUtf8(names[i]));
+        }else
+            recentFileAction[i]=NULL;
+    }
+	return true;
+}
+/**
+    \fn searchRecentFiles
+*/
+void MainWindow::searchRecentFiles(QAction * action)
+{
+    for(int i=0;i<4;i++)
+            if(recentFileAction[i]==action) HandleAction((Action)(ACT_RECENT0+i));
+}
 void MainWindow::mousePressEvent(QMouseEvent* event)
 {
 	this->setFocus(Qt::OtherFocusReason);
@@ -632,6 +701,7 @@
 
 	UI_QT4VideoWidget(mw->ui.frame_video);  // Add the widget that will handle video display
 	UI_updateRecentMenu();
+
     // Init vumeter
     UI_InitVUMeter(mw->ui.frameVU);
 	return 0;
@@ -739,30 +809,7 @@
 */
 uint8_t UI_updateRecentMenu( void )
 {
-	const char **names;
-	uint32_t nb_item=0;
-	QAction *actions[4]={WIDGET(actionRecent0),WIDGET(actionRecent1),WIDGET(actionRecent2),WIDGET(actionRecent3)};
-	names=prefs->get_lastfiles();
-
-	// hide them all
-	for(int i=0;i<4;i++) actions[i]->setVisible(0);
-	// Redraw..
-	for( nb_item=0;nb_item<4;nb_item++)
-	{
-		if(!names[nb_item]) 
-		{
-			return 1;
-		}
-		else
-		{
-			//actions[nb_item]->setVisible(1);
-			// Replace widget ?
-			actions[nb_item]->setText(QString::fromUtf8(names[nb_item]));
-			actions[nb_item]->setVisible(1);
-		}
-		// Update name
-	}
-	return 1;
+    return  ((MainWindow *)QuiMainWindows)->buildRecentMenu();
 }
 /** 
   \fn    setupMenus(void)

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h	2010-09-06 10:23:24 UTC (rev 6591)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h	2010-09-06 10:23:25 UTC (rev 6592)
@@ -13,8 +13,9 @@
 enum MenuType
 {
     MENU_ACTION,
-    MENU_SEPARATOR
-
+    MENU_SEPARATOR,
+    MENU_SUBACTION,
+    MENU_SUBMENU
 };
 /**
     \struct MenuEntry
@@ -36,7 +37,8 @@
 
 public:
 	MainWindow();
-	virtual ~MainWindow();	
+	virtual ~MainWindow();	
+    bool buildRecentMenu(void);
 	void buildCustomMenu(void);
     bool buildMyMenu(void);
     bool buildMenu(QMenu *root,MenuEntry *menu, int nb);
@@ -45,7 +47,10 @@
 	Ui_MainWindow ui;
 protected:
     QMenu *jsMenu;
-    QMenu *pyMenu;
+    QMenu *pyMenu;
+    QMenu *recentFiles;
+    QMenu *recentProjects;
+    QAction *recentFileAction[4];
 public slots:
 	void timeChanged(int);
 	void buttonPressed(void);
@@ -71,8 +76,10 @@
     void searchAudioMenu(QAction * action);
     void searchHelpMenu(QAction * action);
     void searchToolMenu(QAction * action);
+    void searchViewMenu(QAction * action);
     void searchGoMenu(QAction * action);
-
+    void searchRecentFiles(QAction * action);
+    void searchToolBar(QAction *);
 protected:
 	void clearCustomMenu(void);
 	bool eventFilter(QObject* watched, QEvent* event);

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui	2010-09-06 10:23:24 UTC (rev 6591)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui	2010-09-06 10:23:25 UTC (rev 6592)
@@ -1294,33 +1294,6 @@
     <property name="title">
      <string>&amp;View</string>
     </property>
-    <widget class="QMenu" name="menu_Preview">
-     <property name="title">
-      <string>&amp;Preview Mode</string>
-     </property>
-     <addaction name="actionPreviewInput"/>
-     <addaction name="actionPreviewOutput"/>
-     <addaction name="actionPreviewSide"/>
-     <addaction name="actionPreviewTop"/>
-     <addaction name="actionPreviewSeparate"/>
-    </widget>
-    <widget class="QMenu" name="menuPlayback_Aspect_Ratio">
-     <property name="title">
-      <string>Playback Aspect Ratio</string>
-     </property>
-     <addaction name="actionAR_Auto"/>
-     <addaction name="actionAR_1_1"/>
-     <addaction name="actionAR_4_3"/>
-     <addaction name="actionAR_16_9"/>
-    </widget>
-    <addaction name="actionZoom_1_4"/>
-    <addaction name="actionZoom_1_2"/>
-    <addaction name="actionZoom_1_1"/>
-    <addaction name="actionZoom_2_1"/>
-    <addaction name="separator"/>
-    <addaction name="menu_Preview"/>
-    <addaction name="separator"/>
-    <addaction name="menuPlayback_Aspect_Ratio"/>
    </widget>
    <widget class="QMenu" name="menuCustom">
     <property name="title">
@@ -1346,9 +1319,14 @@
     <property name="title">
      <string>&amp;File</string>
     </property>
-    <addaction name="separator"/>
    </widget>
+   <widget class="QMenu" name="menuRecent">
+    <property name="title">
+     <string>&amp;Recent</string>
+    </property>
+   </widget>
    <addaction name="menuFile"/>
+   <addaction name="menuRecent"/>
    <addaction name="menuEdit"/>
    <addaction name="menuView"/>
    <addaction name="menuVideo"/>

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h	2010-09-06 10:23:24 UTC (rev 6591)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h	2010-09-06 10:23:25 UTC (rev 6592)
@@ -2,9 +2,18 @@
 MenuEntry myMenuFile[]= {
             {MENU_ACTION,"Open",    NULL,ACT_OpenAvi,       MKICON(fileopen)},
             {MENU_ACTION,"Append",  NULL,ACT_AppendAvi      ,NULL},
-            {MENU_ACTION,"Save",    NULL,ACT_SaveAvi        ,MKICON(filesaveas)},
+            {MENU_ACTION,"Save",    NULL,ACT_SaveVideo      ,MKICON(filesaveas)},
             {MENU_ACTION,"Close",   NULL,ACT_CLOSE          ,NULL},
             {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_SUBMENU,"Js Project",NULL,ACT_DUMMY       ,NULL},
+
+            {MENU_SUBACTION,"Run jsProject",       NULL,ACT_RunJSProject         ,NULL},
+            {MENU_SUBACTION,"Save as jsProject",   NULL,ACT_SaveJsProject         ,NULL},
+
+            {MENU_SUBMENU,"tinyPy Project",NULL,ACT_DUMMY       ,NULL},
+            {MENU_SUBACTION,"Run pyProject",       NULL,ACT_RunPyProject         ,NULL},
+            {MENU_SUBACTION,"Save as pyProject",   NULL,ACT_SavePyProject         ,NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
             {MENU_ACTION,"Information",NULL,ACT_AviInfo     ,MKICON(info)},
             {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
             {MENU_ACTION,"Connect to avsproxy",NULL,ACT_AVS_PROXY,NULL},
@@ -47,6 +56,7 @@
             {MENU_ACTION,"JavaScript Shell",NULL,ACT_JS_SHELL           ,NULL},
             {MENU_ACTION,"TinyPy Shell",    NULL,ACT_PY_SHELL           ,NULL},
         };
+
 MenuEntry myMenuGo[]= {
             {MENU_ACTION,"Play/Stop",           NULL,ACT_JS_SHELL,       MKICON(player_play)},
             {MENU_ACTION,"Previous Frame",      NULL,ACT_PY_SHELL       ,MKICON(previous)},
@@ -63,3 +73,10 @@
             {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY,NULL},
             {MENU_ACTION,"Go To Time",          NULL,ACT_PY_SHELL       ,NULL},
         };
+
+MenuEntry myMenuView[]= {
+            {MENU_ACTION,"Zoom 1:4",      NULL,ACT_ZOOM_1_4 ,NULL},
+            {MENU_ACTION,"Zoom 1:2",      NULL,ACT_ZOOM_1_2 ,NULL},
+            {MENU_ACTION,"Zoom 1:1",      NULL,ACT_ZOOM_1_1 ,NULL},
+            {MENU_ACTION,"Zoom 2:1",      NULL,ACT_ZOOM_2_1 ,NULL},
+        };

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h	2010-09-06 10:23:24 UTC (rev 6591)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h	2010-09-06 10:23:25 UTC (rev 6592)
@@ -1,9 +1,3 @@
-#define LIST_OF_OBJECTS     \
-PROCESS(actionZoom_1_4,ACT_ZOOM_1_4) \
-PROCESS(actionZoom_1_2,ACT_ZOOM_1_2) \
-PROCESS(actionZoom_1_1,ACT_ZOOM_1_1) \
-PROCESS(actionZoom_2_1,ACT_ZOOM_2_1) \
-
 #define LIST_OF_BUTTONS     PROCESS(pushButtonVideoConf, ACT_VideoCodec)  \
 PROCESS(pushButtonVideoFilter, ACT_VideoParameter) \
 PROCESS(pushButtonAudioConf, ACT_AudioCodec) \



From mean at mail.berlios.de  Mon Sep  6 12:23:26 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:26 +0200
Subject: [Avidemux-svn-commit] r6593 - in
	branches/avidemux_2.6_branch_mean/avidemux: common
	qt4/ADM_userInterfaces/ADM_gui
Message-ID: <20100906102326.E13C0481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:26 +0200 (Mon, 06 Sep 2010)
New Revision: 6593

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h
Log:
[action] Rename + simplify

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-09-06 10:23:25 UTC (rev 6592)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-09-06 10:23:26 UTC (rev 6593)
@@ -156,12 +156,8 @@
                 ADM_assert(name[rank]);
                 A_openAvi (name[rank]);
                 return;
-        case ACT_ViewMain: UI_toogleMain();return;
-        case ACT_ViewSide: UI_toogleSide();return;
-      case ACT_AudioConfigure:
-//    		audioCodecSelect();
 		return;
-	case ACT_VideoConfigure:
+	case ACT_VIDEO_CODEC_CONFIGURE:
     		videoEncoder6Configure();
             return;
     case ACT_ContainerConfigure:    
@@ -170,21 +166,21 @@
             ADM_mux_configure(index);
             return;
             }
-    case ACT_VideoCodecChanged:
+    case ACT_VIDEO_CODEC_CHANGED:
     		nw=UI_getCurrentVCodec();
     		videoEncoder6_SetCurrentEncoder(nw);
             return;
-   case ACT_AudioCodecChanged:
+   case ACT_AUDIO_CODEC_CHANGED:
             nw=UI_getCurrentACodec();
             audioCodecSetByIndex(nw);
             return;
     case ACT_PLUGIN_INFO:
             DIA_pluginsInfo();
             return;
-    case ACT_RunPyProject:
+    case ACT_RUN_PY_PROJECT:
             GUI_FileSelRead (QT_TR_NOOP("Select python script to Run"),(SELFILE_CB *) A_parseTinyPyScript);
     		return;
-    case ACT_RunJSProject:
+    case ACT_RUN_JS_PROJECT:
             GUI_FileSelRead (QT_TR_NOOP("Select ECMAScript to Run"),(SELFILE_CB *) A_parseECMAScript);
     		return;
 
@@ -195,19 +191,16 @@
 			A_openAvi (file);
 		}
 		return;
-    case ACT_About :
+    case ACT_ABOUT :
     		 DIA_about( );
 		 return;
-    case ACT_VideoCodec:
-      videoEncoder6Configure();
-      return;
-    case ACT_AudioCodec:
+    case ACT_AUDIO_CODEC_CONFIGURE:
       audioCodecConfigure();
       return;
-    case ACT_AudioFilters:
+    case ACT_AUDIO_FILTERS:
       audioFilterConfigure();
       return;
-    case ACT_Pref:
+    case ACT_PREFERENCES:
         if(playing) return;
     	if(DIA_Preferences())
         {
@@ -217,7 +210,7 @@
     case ACT_SavePref:
         prefs->save ();
         return;
-    case ACT_Exit:
+    case ACT_EXIT:
       { uint32_t saveprefsonexit;
          prefs->get(FEATURE_SAVEPREFSONEXIT,&saveprefsonexit);
          if( saveprefsonexit )
@@ -256,7 +249,7 @@
         {
           case ACT_JOG:
                 break;
-          case ACT_OpenAvi:
+          case ACT_OPEN_VIDEO:
                 GUI_FileSelRead (QT_TR_NOOP("Select AVI File..."), (SELFILE_CB *)A_openAvi);
                 break;
           default:
@@ -294,17 +287,17 @@
                 changePreviewZoom(currentZoom);
                 admPreview::samePicture();
                 break;
-        case ACT_SelectTrack1:
+        case ACT_AUDIO_SELECT_TRACK:
                 A_audioTrack();
                 break;
 
-    case ACT_OpenAvi:
+    case ACT_OPEN_VIDEO:
         GUI_FileSelRead (QT_TR_NOOP("Select AVI File..."),(SELFILE_CB *) A_openAvi);
         break;
-    case ACT_AppendAvi:
+    case ACT_APPEND_VIDEO:
         GUI_FileSelRead (QT_TR_NOOP("Select AVI File to Append..."),(SELFILE_CB *) A_appendAvi);
         break;
-    case ACT_AviInfo:
+    case ACT_VIDEO_PROPERTIES:
         DIA_properties ();
         break;
     case ACT_PlayAvi:
@@ -426,7 +419,7 @@
       video_body->setDecodeParam ( admPreview::getCurrentPts());
 
       break;
-    case ACT_VideoParameter:
+    case ACT_VIDEO_FILTERS:
         GUI_handleVFilter();
         break;
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names	2010-09-06 10:23:25 UTC (rev 6592)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names	2010-09-06 10:23:26 UTC (rev 6593)
@@ -1,27 +1,29 @@
-// load/sabe
-ACT(OpenAvi)
-ACT(AppendAvi)
-ACT(AviInfo)
+// load/save
+ACT(OPEN_VIDEO)
+ACT(APPEND_VIDEO)
 ACT(CLOSE)
-ACT(Exit)
+ACT(EXIT)
+
+// Misc
 ACT(PlayAvi)
 ACT(StopAvi)
-ACT(RecentFiles)
 ACT(SetPostProcessing)
+
 //----- SAVE -----
 ACT(SAVE_BEGIN)
-ACT(SaveImg)
-ACT(SaveJPG)
-ACT(SaveBunchJPG)
-ACT(SaveVideo)
-ACT(SaveAudio)
-ACT(SaveJsProject)
-ACT(SavePyProject)
+ACT(SAVE_BMP)
+ACT(SAVE_JPG)
+ACT(SAVE_BUNCH_OF_JPG)
+ACT(SAVE_VIDEO)
+ACT(SAVE_AUDIO)
+ACT(SAVE_JS_PROJECT)
+ACT(SAVE_PY_PROJECT)
 ACT(SAVE_END)
-// /SAVE
-ACT(RunJSProject)
-ACT(RunPyProject)
 
+// Project
+ACT(RUN_JS_PROJECT)
+ACT(RUN_PY_PROJECT)
+
 //--- NAVIGATE----
 ACT(NAVIGATE_BEGIN)
 ACT(NextFrame)
@@ -44,44 +46,48 @@
 ACT(GotoMarkB)
 ACT(Scale)
 ACT(NAVIGATE_END)
-//--- /NAVIGATE----
-ACT(SavePref)
+ACT(JumpToTime)
+
+// Info
+ACT(VIDEO_PROPERTIES)
+ACT(ABOUT)
+ACT(PREFERENCES)
+ACT(BUILT_IN)
+ACT(PLUGIN_INFO)
+// /info
+
+// Audio
+ACT(AUDIO_FILTERS)
+ACT(AUDIO_CODEC_CONFIGURE)
+ACT(AUDIO_CODEC_CHANGED)
+ACT(AUDIO_SELECT_TRACK)
+// /Audio
+
+// Video
+ACT(VIDEO_FILTERS)
+ACT(VIDEO_CODEC_CONFIGURE)
+ACT(VIDEO_CODEC_CHANGED)
+
+// Editor
 ACT(MarkA)
 ACT(MarkB)
-ACT(AudioFilters)
-ACT(VideoParameter)
-
 ACT(Copy)
 ACT(Cut)
 ACT(Paste)
 ACT(Delete)
-ACT(PreviewToggle)
+ACT(ResetSegments)
+
+// Misc conf
 ACT(DecoderOption)
-
 ACT(SelectEncoder)
-ACT(Fast)
-ACT(AudioConfigure)
+ACT(ContainerConfigure)
 
+ACT(RecentFiles)
+ACT(SavePref)
+ACT(PreviewToggle)
 ACT(OutputToggle)
+ACT(PreviewChanged)
 
-ACT(VideoConfigure)
-ACT(ContainerConfigure)
-
-ACT(ResetSegments)
-
-ACT(VideoCodec)
-ACT(AudioCodec)
-ACT(About)
-
-ACT(Pref)
-
-ACT(JumpToTime)
-ACT(AudioCodecChanged)
-ACT(VideoCodecChanged)
-ACT(PreviewChanged)
-ACT(SelectTrack1)
-ACT(ViewMain)
-ACT(ViewSide)
 ACT(TimeShift)
 
 ACT(RECENT0)
@@ -89,18 +95,15 @@
 ACT(RECENT2)
 ACT(RECENT3)
 
-
-
 ACT(ZOOM_1_4)
 ACT(ZOOM_1_2)
 ACT(ZOOM_1_1)
 ACT(ZOOM_2_1)
 ACT(ZOOM_4_1)
-ACT(BUILT_IN)
+
 ACT(HEX_DUMP)
 ACT(SIZE_DUMP)
 ACT(AVS_PROXY)
 ACT(JOG)
-ACT(PLUGIN_INFO)
 ACT(JS_SHELL)
 ACT(PY_SHELL)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp	2010-09-06 10:23:25 UTC (rev 6592)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp	2010-09-06 10:23:26 UTC (rev 6593)
@@ -45,11 +45,11 @@
 {
     switch(action)
     {
-    case ACT_SavePyProject:
+    case ACT_SAVE_PY_PROJECT:
             GUI_FileSelWrite (QT_TR_NOOP("Select pyProject to Save"), A_savePyProject);
             UI_refreshCustomMenu();
             break;
-    case ACT_SaveJsProject:
+    case ACT_SAVE_JS_PROJECT:
       GUI_FileSelWrite (QT_TR_NOOP("Select jsProject to Save"), A_saveJsProject);
 	  UI_refreshCustomMenu();
       break;
@@ -66,25 +66,25 @@
         }
       break;
 #endif      
-    case ACT_SaveAudio:
+    case ACT_SAVE_AUDIO:
       	{
           GUI_FileSelWrite (QT_TR_NOOP("Select File to Save Audio"),(SELFILE_CB *)A_audioSave);
         }
       break;
 
-    case ACT_SaveBunchJPG:
+    case ACT_SAVE_BUNCH_OF_JPG:
       GUI_FileSelWrite (QT_TR_NOOP("Select JPEG Sequence to Save"), (SELFILE_CB *)A_saveBunchJpg);
     	break;
-    case ACT_SaveImg:
+    case ACT_SAVE_BMP:
       GUI_FileSelWrite (QT_TR_NOOP("Select BMP to Save"), (SELFILE_CB *)A_saveImg);
       //GUI_FileSelWrite ("Select Jpg to save ", A_saveJpg);
       break;
-    case ACT_SaveJPG :
+    case ACT_SAVE_JPG :
       GUI_FileSelWrite (QT_TR_NOOP("Select JPEG to Save"), (SELFILE_CB *)A_saveJpg);
       	//GUI_FileSelWrite ("Select Jpg to save ", A_saveJpg);
       	break;
 //----------------------test-----------------------
-    case ACT_SaveVideo:
+    case ACT_SAVE_VIDEO:
       GUI_FileSelWrite (QT_TR_NOOP("Select File to Save"),(SELFILE_CB *)A_SaveWrapper); // A_SaveAudioNVideo);
       break;
 //---------------------------------------------------

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-06 10:23:25 UTC (rev 6592)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-06 10:23:26 UTC (rev 6593)
@@ -120,7 +120,7 @@
 		}
 		ui.pushButtonVideoConf->setEnabled(b);
 		ui.pushButtonVideoFilter->setEnabled(b);
-		HandleAction (ACT_VideoCodecChanged) ;
+		HandleAction (ACT_VIDEO_CODEC_CHANGED) ;
 	}
 	else if(!strcmp(source,"comboBoxAudio"))  
 	{
@@ -131,7 +131,7 @@
 		}
 		ui.pushButtonAudioConf->setEnabled(b);
 		ui.pushButtonAudioFilter->setEnabled(b);
-		HandleAction (ACT_AudioCodecChanged) ;
+		HandleAction (ACT_AUDIO_CODEC_CHANGED) ;
 	}
 	else
 		printf("From +: %s\n",source);
@@ -320,11 +320,11 @@
 
 toolBarTranslate toolbar[]=
 {
-{"actionOpen",              ACT_OpenAvi},
-{"actionSave_video",        ACT_SaveVideo},
-{"actionProperties",        ACT_AviInfo},
-{"actionLoad_run_project",  ACT_RunPyProject},
-{"actionSave_project",      ACT_SavePyProject},
+{"actionOpen",              ACT_OPEN_VIDEO},
+{"actionSave_video",        ACT_SAVE_VIDEO},
+{"actionProperties",        ACT_VIDEO_PROPERTIES},
+{"actionLoad_run_project",  ACT_RUN_PY_PROJECT},
+{"actionSave_project",      ACT_SAVE_PY_PROJECT},
 //{"actionPreviewInput",ACT_PreviewToggle},
 //{"actionPreviewOutput",ACT_PreviewToggle},
 
@@ -649,7 +649,7 @@
     if(first)
     {
         first=false;
-        HandleAction(ACT_Exit);
+        HandleAction(ACT_EXIT);
     }
     event->accept();
 //         event->ignore();

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h	2010-09-06 10:23:25 UTC (rev 6592)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h	2010-09-06 10:23:26 UTC (rev 6593)
@@ -1,24 +1,24 @@
 
 MenuEntry myMenuFile[]= {
-            {MENU_ACTION,"Open",    NULL,ACT_OpenAvi,       MKICON(fileopen)},
-            {MENU_ACTION,"Append",  NULL,ACT_AppendAvi      ,NULL},
-            {MENU_ACTION,"Save",    NULL,ACT_SaveVideo      ,MKICON(filesaveas)},
+            {MENU_ACTION,"Open",    NULL,ACT_OPEN_VIDEO,       MKICON(fileopen)},
+            {MENU_ACTION,"Append",  NULL,ACT_APPEND_VIDEO     ,NULL},
+            {MENU_ACTION,"Save",    NULL,ACT_SAVE_VIDEO       ,MKICON(filesaveas)},
             {MENU_ACTION,"Close",   NULL,ACT_CLOSE          ,NULL},
             {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
             {MENU_SUBMENU,"Js Project",NULL,ACT_DUMMY       ,NULL},
 
-            {MENU_SUBACTION,"Run jsProject",       NULL,ACT_RunJSProject         ,NULL},
-            {MENU_SUBACTION,"Save as jsProject",   NULL,ACT_SaveJsProject         ,NULL},
+            {MENU_SUBACTION,"Run jsProject",       NULL,ACT_RUN_JS_PROJECT         ,NULL},
+            {MENU_SUBACTION,"Save as jsProject",   NULL,ACT_SAVE_JS_PROJECT         ,NULL},
 
             {MENU_SUBMENU,"tinyPy Project",NULL,ACT_DUMMY       ,NULL},
-            {MENU_SUBACTION,"Run pyProject",       NULL,ACT_RunPyProject         ,NULL},
-            {MENU_SUBACTION,"Save as pyProject",   NULL,ACT_SavePyProject         ,NULL},
+            {MENU_SUBACTION,"Run pyProject",       NULL,ACT_RUN_PY_PROJECT         ,NULL},
+            {MENU_SUBACTION,"Save as pyProject",   NULL,ACT_SAVE_PY_PROJECT         ,NULL},
             {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_ACTION,"Information",NULL,ACT_AviInfo     ,MKICON(info)},
+            {MENU_ACTION,"Information",NULL,ACT_VIDEO_PROPERTIES,MKICON(info)},
             {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
             {MENU_ACTION,"Connect to avsproxy",NULL,ACT_AVS_PROXY,NULL},
             {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_ACTION,"Quit",    NULL,ACT_Exit           ,NULL}
+            {MENU_ACTION,"Quit",    NULL,ACT_EXIT           ,NULL}
         };
 
 MenuEntry myMenuEdit[]= {
@@ -31,25 +31,25 @@
             {MENU_ACTION,"Set Marker A",NULL,ACT_MarkA      ,NULL},
             {MENU_ACTION,"Set Marker B",NULL,ACT_MarkB      ,NULL},
             {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_ACTION,"Preferences", NULL,ACT_Pref       ,NULL},
+            {MENU_ACTION,"Preferences", NULL,ACT_PREFERENCES,NULL},
         };
 
 MenuEntry myMenuVideo[]= {
             {MENU_ACTION,"Decoder Option",  NULL,ACT_DecoderOption      ,NULL},
             {MENU_ACTION,"PostProcessing",  NULL,ACT_SetPostProcessing  ,NULL},
-            {MENU_ACTION,"Filters ",        NULL,ACT_VideoConfigure     ,NULL},
+            {MENU_ACTION,"Filters ",        NULL,ACT_VIDEO_FILTERS      ,NULL},
         };
 
 MenuEntry myMenuAudio[]= {
-            {MENU_ACTION,"Select Track",    NULL,ACT_SelectTrack1       ,NULL},
-            {MENU_ACTION,"Save audio",      NULL,ACT_SaveAudio          ,NULL},
-            {MENU_ACTION,"Filters ",        NULL,ACT_AudioFilters       ,NULL},
+            {MENU_ACTION,"Select Track",    NULL,ACT_AUDIO_SELECT_TRACK ,NULL},
+            {MENU_ACTION,"Save audio",      NULL,ACT_SAVE_AUDIO         ,NULL},
+            {MENU_ACTION,"Filters ",        NULL,ACT_AUDIO_FILTERS      ,NULL},
         };
 
 MenuEntry myMenuHelp[]= {
             {MENU_ACTION,"Build Option",    NULL,ACT_BUILT_IN           ,NULL},
             {MENU_ACTION,"Plugins",         NULL,ACT_PLUGIN_INFO        ,NULL},
-            {MENU_ACTION,"About ",          NULL,ACT_About              ,NULL},
+            {MENU_ACTION,"About ",          NULL,ACT_ABOUT              ,NULL},
         };
 
 MenuEntry myMenuTool[]= {

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h	2010-09-06 10:23:25 UTC (rev 6592)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h	2010-09-06 10:23:26 UTC (rev 6593)
@@ -1,7 +1,7 @@
-#define LIST_OF_BUTTONS     PROCESS(pushButtonVideoConf, ACT_VideoCodec)  \
-PROCESS(pushButtonVideoFilter, ACT_VideoParameter) \
-PROCESS(pushButtonAudioConf, ACT_AudioCodec) \
-PROCESS(pushButtonAudioFilter, ACT_AudioFilters) \
+#define LIST_OF_BUTTONS     PROCESS(pushButtonVideoConf, ACT_VIDEO_CODEC_CONFIGURE)  \
+PROCESS(pushButtonVideoFilter, ACT_VIDEO_FILTERS) \
+PROCESS(pushButtonAudioConf, ACT_AUDIO_CODEC_CONFIGURE) \
+PROCESS(pushButtonAudioFilter, ACT_AUDIO_FILTERS) \
 PROCESS(pushButtonDecoderConf, ACT_DecoderOption) \
 PROCESS(pushButtonFormatConfigure, ACT_ContainerConfigure) \
 PROCESS(toolButtonPlay, ACT_PlayAvi) \



From mean at mail.berlios.de  Mon Sep  6 12:23:28 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:28 +0200
Subject: [Avidemux-svn-commit] r6594 -
	branches/avidemux_2.6_branch_mean/cmake
Message-ID: <20100906102328.0CABD481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:27 +0200 (Mon, 06 Sep 2010)
New Revision: 6594

Modified:
   branches/avidemux_2.6_branch_mean/cmake/admCheckGtk.cmake
Log:
[gtk] We need gdk pixbuf

Modified: branches/avidemux_2.6_branch_mean/cmake/admCheckGtk.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admCheckGtk.cmake	2010-09-06 10:23:26 UTC (rev 6593)
+++ branches/avidemux_2.6_branch_mean/cmake/admCheckGtk.cmake	2010-09-06 10:23:27 UTC (rev 6594)
@@ -10,6 +10,14 @@
 		MESSAGE(STATUS "*****************")
 
 		IF (GTK)
+			PKG_CHECK_MODULES(PIXBUF gdk-pixbuf-2.0)
+			PRINT_LIBRARY_INFO("GdkPixBuf" PIXBUF_FOUND "${PIXBUF_CFLAGS}" "${PIXBUF_LDFLAGS}")
+                        if  (PIXBUF_FOUND)
+                        else(PIXBUF_FOUND)
+                                MESSAGE(STATUS "gdk-pixbuf not found")
+                                set(GTK_FOUND false)
+                        endif(PIXBUF_FOUND)
+        
 			PKG_CHECK_MODULES(GTK gtk+-2.0)
 			PRINT_LIBRARY_INFO("GTK+" GTK_FOUND "${GTK_CFLAGS}" "${GTK_LDFLAGS}")
                         checkGlade()
@@ -33,8 +41,8 @@
 					ENDIF (VERBOSE)
 				ENDIF (GTK_X11_SUPPORTED)
                                # Merge glade flags into gtk flags
-                                SET(  GTK_CFLAGS "${GTK_CFLAGS} ${GLADE_CFLAGS}")
-                                SET(  GTK_LDFLAGS "${GTK_LDFLAGS} ${GLADE_LDFLAGS}")
+                                SET(  GTK_CFLAGS "${GTK_CFLAGS} ${GLADE_CFLAGS} ${PIXBUF_CFLAGS}")
+                                SET(  GTK_LDFLAGS "${GTK_LDFLAGS} ${GLADE_LDFLAGS} ${PIXBUF_LDFLAGS}")
                                # /Merge glade flags into gtk flags
 			ENDIF (GTK_FOUND)
 		ELSE (GTK)



From mean at mail.berlios.de  Mon Sep  6 12:23:29 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:29 +0200
Subject: [Avidemux-svn-commit] r6595 -
	branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2
Message-ID: <20100906102329.3809B481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:29 +0200 (Mon, 06 Sep 2010)
New Revision: 6595

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_menumap.h
Log:
[gtk] Update new action names

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-06 10:23:27 UTC (rev 6594)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-06 10:23:29 UTC (rev 6595)
@@ -179,21 +179,21 @@
 	{"buttonMarkB"			,"clicked"		,ACT_MarkB},
 	{"buttonBegin"			,"clicked"		,ACT_Begin},
 	{"buttonEnd"			,"clicked"		,ACT_End},
-	{"menutoolbuttonOpen"	,"clicked"		,ACT_OpenAvi},
-	{"toolbuttonInfo"		,"clicked"		,ACT_AviInfo},
-	{"toolbuttonSave"		,"clicked"		,ACT_SaveAvi},
+	{"menutoolbuttonOpen"	,"clicked"		,ACT_OPEN_VIDEO},
+	{"toolbuttonInfo"		,"clicked"		,ACT_VIDEO_PROPERTIES},
+	{"toolbuttonSave"		,"clicked"		,ACT_SAVE_VIDEO},
 
-	{"buttonFilters"		,"clicked"		,ACT_VideoParameter},
-	{"buttonAudioFilter"	,"clicked"		,ACT_AudioFilters},
-	{"buttonConfV"			,"clicked"		,ACT_VideoConfigure},
-	{"buttonConfA"			,"clicked"		,ACT_AudioCodec},
-	{"buttonConfF"			,"clicked"		,ACT_SetMuxParam},
+	{"buttonFilters"		,"clicked"		,ACT_VIDEO_FILTERS},
+	{"buttonAudioFilter"	,"clicked"		,ACT_AUDIO_FILTERS},
+	{"buttonConfV"			,"clicked"		,ACT_VIDEO_CODEC_CONFIGURE},
+	{"buttonConfA"			,"clicked"		,ACT_AUDIO_CODEC_CONFIGURE},
+	{"buttonConfF"			,"clicked"		,ACT_ContainerConfigure},
 
 	{"buttonPrevBlack"		,"clicked"		,ACT_PrevBlackFrame},
 	{"buttonNextBlack"		,"clicked"		,ACT_NextBlackFrame},
 	{"buttonGotoA"			,"clicked"		,ACT_GotoMarkA},
 	{"buttonGotoB"			,"clicked"		,ACT_GotoMarkB},
-	{"toolbuttonCalc"		,"clicked"		,ACT_Bitrate},
+//	{"toolbuttonCalc"		,"clicked"		,ACT_Bitrate},
 
 	//{"boxCurFrame"			,"activate"		,ACT_JumpToFrame},
 	//{"boxCurTime"			,"editing_done"		,ACT_TimeChanged},
@@ -437,7 +437,7 @@
 	// Current Frame
 	gtk_signal_connect(GTK_OBJECT(guiCurFrame), "focus_in_event", GTK_SIGNAL_FUNC(UI_grabFocus), (void *) NULL);
 	gtk_signal_connect(GTK_OBJECT(guiCurFrame), "focus_out_event", GTK_SIGNAL_FUNC(UI_loseFocus), (void *) NULL);
-	gtk_signal_connect(GTK_OBJECT(guiCurFrame), "activate", GTK_SIGNAL_FUNC(UI_focusAfterActivate), (void *) ACT_JumpToFrame);
+//	gtk_signal_connect(GTK_OBJECT(guiCurFrame), "activate", GTK_SIGNAL_FUNC(UI_focusAfterActivate), (void *) ACT_JumpToFrame);
 
     // Volume
     gtk_signal_connect(GTK_OBJECT(glade.getWidget("hscalVolume")), "value_changed", GTK_SIGNAL_FUNC(volumeChange), (void *) NULL);
@@ -832,7 +832,7 @@
     UNUSED_ARG(widget);
     UNUSED_ARG(event);
     UNUSED_ARG(user_data);
-    HandleAction(ACT_Exit);
+    HandleAction(ACT_EXIT);
     return 1;
 }
 /**
@@ -1083,7 +1083,7 @@
         else enable=1;
         gtk_widget_set_sensitive(glade.getWidget("buttonConfV"),enable);
         gtk_widget_set_sensitive(glade.getWidget("buttonFilters"),enable);
-        HandleAction(ACT_VideoCodecChanged);
+        HandleAction(ACT_VIDEO_CODEC_CHANGED);
 }
 /**
     \fn on_audio_change
@@ -1100,7 +1100,7 @@
         else enable=1;
         gtk_widget_set_sensitive(glade.getWidget("buttonConfA"),enable);
         gtk_widget_set_sensitive(glade.getWidget("buttonAudioFilter"),enable);
-        HandleAction(ACT_AudioCodecChanged);
+        HandleAction(ACT_AUDIO_CODEC_CHANGED);
 
 }
 /**

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_menumap.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_menumap.h	2010-09-06 10:23:27 UTC (rev 6594)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_menumap.h	2010-09-06 10:23:29 UTC (rev 6595)
@@ -15,26 +15,26 @@
 
 
 CALLBACK( show_builtin_support1                 ,ACT_BUILT_IN);
-CALLBACK( open_video1         			,ACT_OpenAvi); 
-CALLBACK( append_video1     			,ACT_AppendAvi);
-CALLBACK( save_audio1         			,ACT_SaveWave);
-CALLBACK( save_as_avi1       			,ACT_SaveAvi);
-CALLBACK(avi_muxer_options1 			,ACT_SetMuxParam);
+CALLBACK( open_video1         			,ACT_OPEN_VIDEO); 
+CALLBACK( append_video1     			,ACT_APPEND_VIDEO);
+CALLBACK( save_audio1         			,ACT_SAVE_AUDIO);
+CALLBACK( save_as_avi1       			,ACT_SAVE_VIDEO);
+CALLBACK(avi_muxer_options1 			,ACT_ContainerConfigure);
 
 //CALLBACK(load_project         			,ACT_OpenAvi); 
-CALLBACK(save_project_as1              		,ACT_SaveWork);
-CALLBACK(save_project1                          ,ACT_SaveCurrentWork);
+CALLBACK(save_project_as1              		    ,ACT_SAVE_PY_PROJECT);
+//CALLBACK(save_project1                          ,ACT_SaveCurrentWork);
 //CALLBACK(save_current_project                	,ACT_SaveCurrentWork);
  
- CALLBACK(video_informations1	                 ,ACT_AviInfo);
- CALLBACK(save_image1               		 ,ACT_SaveImg);
- CALLBACK(save_jpg_image1              		 ,ACT_SaveJPG);
- CALLBACK(save_selection_as_jpegs1		  ,ACT_SaveBunchJPG);
+ CALLBACK(video_informations1	             ,ACT_VIDEO_PROPERTIES);
+ CALLBACK(save_image1               		 ,ACT_SAVE_BMP);
+ CALLBACK(save_jpg_image1              		 ,ACT_SAVE_JPG);
+ CALLBACK(save_selection_as_jpegs1		     ,ACT_SAVE_BUNCH_OF_JPG);
 
- CALLBACK( play_video1         			,ACT_PlayAvi);
+ CALLBACK( play_video1         			    ,ACT_PlayAvi);
  CALLBACK( decoder_options1         		,ACT_DecoderOption);
- CALLBACK( set_postprocessing1			,ACT_SetPostProcessing);
- CALLBACK( next_frame1            		,ACT_NextFrame);
+ CALLBACK( set_postprocessing1			    ,ACT_SetPostProcessing);
+ CALLBACK( next_frame1            		    ,ACT_NextFrame);
  CALLBACK( previous_frame1            		,ACT_PreviousFrame);
  CALLBACK( next_intra_frame1            	,ACT_NextKFrame);
  CALLBACK( previous_intra_frame1         	,ACT_PreviousKFrame);
@@ -44,53 +44,53 @@
  CALLBACK( copy1      				,ACT_Copy);
  CALLBACK( paste1      				,ACT_Paste);
  CALLBACK( delete1      			,ACT_Delete);
- CALLBACK( cut1					,ACT_Cut);
- CALLBACK( set_marker_a1      			,ACT_MarkA);
- CALLBACK( set_marker_b1      			,ACT_MarkB);
- CALLBACK( go_to_marker_a1  			,ACT_GotoMarkA);
+ CALLBACK( cut1					    ,ACT_Cut);
+ CALLBACK( set_marker_a1      		,ACT_MarkA);
+ CALLBACK( set_marker_b1      		,ACT_MarkB);
+ CALLBACK( go_to_marker_a1  		,ACT_GotoMarkA);
  CALLBACK( go_to_marker_b1 			,ACT_GotoMarkB);
 
- CALLBACK( search_previous_black_frame1  	,ACT_PrevBlackFrame);
+ CALLBACK( search_previous_black_frame1 ,ACT_PrevBlackFrame);
  CALLBACK( search_next_black_frame1		,ACT_NextBlackFrame);
  
 CALLBACK(reset_edits1                		,ACT_ResetSegments);
 
-CALLBACK(main_audio                                 ,ACT_SelectTrack1);
-CALLBACK(filters2                                 ,ACT_AudioFilters);
+CALLBACK(main_audio                                 ,ACT_AUDIO_SELECT_TRACK);
+CALLBACK(filters2                                 ,ACT_AUDIO_FILTERS);
 
-CALLBACK(build_vbr_time_map1      		,ACT_AudioMap);
+//CALLBACK(build_vbr_time_map1      		,ACT_AudioMap);
 
-CALLBACK(videoencoder				,ACT_VideoConfigure);
-CALLBACK(audio_encoder1           		,ACT_AudioConfigure);
+CALLBACK(videoencoder				    ,ACT_VIDEO_CODEC_CONFIGURE);
+CALLBACK(audio_encoder1           		,ACT_AUDIO_CODEC_CONFIGURE);
 
-CALLBACK(bitrate_histogram1		      	,ACT_BitRate);
+//CALLBACK(bitrate_histogram1		      	,ACT_BitRate);
 
- CALLBACK(rebuild_frames           		,ACT_RebuildKF);
- CALLBACK(change_fps           			,ACT_ChangeFPS);
- CALLBACK(about1	           			,ACT_About);
-CALLBACK(calculator1                            ,ACT_Bitrate);
- CALLBACK(preferences1   			,ACT_Pref);
- CALLBACK(	check_frames			,ACT_VideoCheck);
- CALLBACK(quit1		   			,ACT_Exit);
+// CALLBACK(rebuild_frames           		,ACT_RebuildKF);
+// CALLBACK(change_fps           			,ACT_ChangeFPS);
+ CALLBACK(about1	           			,ACT_ABOUT);
+//CALLBACK(calculator1                            ,ACT_Bitrate);
+ CALLBACK(preferences1   			,ACT_PREFERENCES);
+// CALLBACK(	check_frames			,ACT_VideoCheck);
+ CALLBACK(quit1		   			,ACT_EXIT);
  
  
- CALLBACK(run_script1		   	        ,ACT_RunScript);
- CALLBACK( ocr_vobsub_2_srt                     ,ACT_Ocr);
+ CALLBACK(run_script1		   	        ,ACT_RUN_PY_PROJECT);
+// CALLBACK( ocr_vobsub_2_srt                     ,ACT_Ocr);
  
- CALLBACK( ocr_dvb                     ,ACT_DVB_Ocr);
+// CALLBACK( ocr_dvb                     ,ACT_DVB_Ocr);
  
  
-CALLBACK(item1                                 ,ACT_AllBlackFrames);
+//CALLBACK(item1                                 ,ACT_AllBlackFrames);
 
 CALLBACK(first_frame1                          ,ACT_Begin);
 CALLBACK(last_frame1                           ,ACT_End);
-CALLBACK(filters1                              ,ACT_VideoParameter);
-CALLBACK(toolbar1                              ,ACT_ViewMain);
-CALLBACK(sidebar1                              ,ACT_ViewSide);
+CALLBACK(filters1                              ,ACT_VIDEO_FILTERS);
+//CALLBACK(toolbar1                              ,ACT_ViewMain);
+//CALLBACK(sidebar1                              ,ACT_ViewSide);
 //CALLBACK(preview1                              ,ACT_PreviewToggle);
 //CALLBACK(display_output1                       ,ACT_OutputToggle);
-CALLBACK(second_audio_track1                   ,ACT_SecondAudioTrack);
-
+//CALLBACK(second_audio_track1                   ,ACT_SecondAudioTrack);
+#if 0
 CALLBACK(vcd1                                   ,ACT_AUTO_VCD);
 CALLBACK(svcd1                                  ,ACT_AUTO_SVCD);
 CALLBACK(dvd1                                   ,ACT_AUTO_DVD);
@@ -102,13 +102,13 @@
 CALLBACK(add_to_joblist1                       ,ACT_ADD_JOB);
 CALLBACK(joblist1                              ,ACT_HANDLE_JOB);
 CALLBACK(v2v                                   ,ACT_V2V);
-
+#endif
 CALLBACK(zoom_1_4                                   ,ACT_ZOOM_1_4);
 CALLBACK(zoom_1_2                                   ,ACT_ZOOM_1_2);
 CALLBACK(zoom_1_1                                   ,ACT_ZOOM_1_1);
 CALLBACK(zoom_2_1                                   ,ACT_ZOOM_2_1);
 //CALLBACK(zoom_4_1                                   ,ACT_ZOOM_4_1);
-CALLBACK(edit_glyph1                                ,ACT_GLYPHEDIT);
+//CALLBACK(edit_glyph1                                ,ACT_GLYPHEDIT);
 //CALLBACK(hscalVolume                                ,ACT_VOLUME);
 CALLBACK(plugins1                                   ,ACT_PLUGIN_INFO);
 



From mean at mail.berlios.de  Mon Sep  6 12:23:30 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:30 +0200
Subject: [Avidemux-svn-commit] r6596 -
	branches/avidemux_2.6_branch_mean/avidemux
Message-ID: <20100906102330.4C03D481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:30 +0200 (Mon, 06 Sep 2010)
New Revision: 6596

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
Log:
[build] Check that ADM_coreConfig is where it is supposed to be

Modified: branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-09-06 10:23:29 UTC (rev 6595)
+++ branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-09-06 10:23:30 UTC (rev 6596)
@@ -22,6 +22,11 @@
 # Add include dirs
 ########################################
 include(admCoreIncludes)
+# Verify ADM_coreConfig is there
+if(NOT EXISTS "${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/ADM_coreConfig.h")
+        MESSAGE(FATAL_ERROR "CMAKE_INSTALL_PREFIX does not contain include/avidemux/2.6/ADM_coreConfig.h (${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/ADM_coreConfig.h)")
+endif(NOT EXISTS "${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/ADM_coreConfig.h")
+
 LINK_DIRECTORIES("${AVIDEMUX_LIB_DIR}")
 #
 INCLUDE_DIRECTORIES("${CMAKE_CURRENT_SOURCE_DIR}/ADM_muxerGate/include/")



From mean at mail.berlios.de  Mon Sep  6 12:23:31 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:31 +0200
Subject: [Avidemux-svn-commit] r6597 - in
	branches/avidemux_2.6_branch_mean/avidemux:
	common/ADM_commonUI gtk/ADM_userInterfaces/ADM_gui2
	gtk/ADM_userInterfaces/glade/main qt4/ADM_userInterfaces/ADM_gui
Message-ID: <20100906102331.E5C01481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:31 +0200 (Mon, 06 Sep 2010)
New Revision: 6597

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h
Removed:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.glade
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.gtkBuilder
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h
Log:
[gtk] Use the same dynamically generated menus as Qt

Copied: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h (from rev 6596, branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h	2010-09-06 10:23:31 UTC (rev 6597)
@@ -0,0 +1,109 @@
+/**
+    \file myOwnMenus
+    
+*/
+#ifndef MY_OWN_MENUS
+#define MY_OWN_MENUS
+/**
+    \enum MenuType
+*/
+enum MenuType
+{
+    MENU_ACTION,
+    MENU_SEPARATOR,
+    MENU_SUBACTION,
+    MENU_SUBMENU
+};
+/**
+    \struct MenuEntry
+*/
+typedef struct
+{
+    MenuType   type;
+    const char *text;
+    void       *cookie;
+    Action     event;
+    const char *icon; 
+}MenuEntry;
+MenuEntry myMenuFile[]= {
+            {MENU_ACTION,"Open",    NULL,ACT_OPEN_VIDEO,       MKICON(fileopen)},
+            {MENU_ACTION,"Append",  NULL,ACT_APPEND_VIDEO     ,NULL},
+            {MENU_ACTION,"Save",    NULL,ACT_SAVE_VIDEO       ,MKICON(filesaveas)},
+            {MENU_ACTION,"Close",   NULL,ACT_CLOSE          ,NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_SUBMENU,"Js Project",NULL,ACT_DUMMY       ,NULL},
+
+            {MENU_SUBACTION,"Run jsProject",       NULL,ACT_RUN_JS_PROJECT         ,NULL},
+            {MENU_SUBACTION,"Save as jsProject",   NULL,ACT_SAVE_JS_PROJECT         ,NULL},
+
+            {MENU_SUBMENU,"tinyPy Project",NULL,ACT_DUMMY       ,NULL},
+            {MENU_SUBACTION,"Run pyProject",       NULL,ACT_RUN_PY_PROJECT         ,NULL},
+            {MENU_SUBACTION,"Save as pyProject",   NULL,ACT_SAVE_PY_PROJECT         ,NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_ACTION,"Information",NULL,ACT_VIDEO_PROPERTIES,MKICON(info)},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_ACTION,"Connect to avsproxy",NULL,ACT_AVS_PROXY,NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_ACTION,"Quit",    NULL,ACT_EXIT           ,NULL}
+        };
+
+MenuEntry myMenuEdit[]= {
+            {MENU_ACTION,"Reset Edit",  NULL,ACT_ResetSegments,NULL},
+            {MENU_ACTION,"Cut",         NULL,ACT_Cut        ,NULL},
+            {MENU_ACTION,"Copy",        NULL,ACT_Copy       ,NULL},
+            {MENU_ACTION,"Paste",       NULL,ACT_Paste      ,NULL},
+            {MENU_ACTION,"Delete",      NULL,ACT_Delete     ,NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_ACTION,"Set Marker A",NULL,ACT_MarkA      ,NULL},
+            {MENU_ACTION,"Set Marker B",NULL,ACT_MarkB      ,NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_ACTION,"Preferences", NULL,ACT_PREFERENCES,NULL},
+        };
+
+MenuEntry myMenuVideo[]= {
+            {MENU_ACTION,"Decoder Option",  NULL,ACT_DecoderOption      ,NULL},
+            {MENU_ACTION,"PostProcessing",  NULL,ACT_SetPostProcessing  ,NULL},
+            {MENU_ACTION,"Filters ",        NULL,ACT_VIDEO_FILTERS      ,NULL},
+        };
+
+MenuEntry myMenuAudio[]= {
+            {MENU_ACTION,"Select Track",    NULL,ACT_AUDIO_SELECT_TRACK ,NULL},
+            {MENU_ACTION,"Save audio",      NULL,ACT_SAVE_AUDIO         ,NULL},
+            {MENU_ACTION,"Filters ",        NULL,ACT_AUDIO_FILTERS      ,NULL},
+        };
+
+MenuEntry myMenuHelp[]= {
+            {MENU_ACTION,"Build Option",    NULL,ACT_BUILT_IN           ,NULL},
+            {MENU_ACTION,"Plugins",         NULL,ACT_PLUGIN_INFO        ,NULL},
+            {MENU_ACTION,"About ",          NULL,ACT_ABOUT              ,NULL},
+        };
+
+MenuEntry myMenuTool[]= {
+            {MENU_ACTION,"JavaScript Shell",NULL,ACT_JS_SHELL           ,NULL},
+            {MENU_ACTION,"TinyPy Shell",    NULL,ACT_PY_SHELL           ,NULL},
+        };
+
+MenuEntry myMenuGo[]= {
+            {MENU_ACTION,"Play/Stop",           NULL,ACT_JS_SHELL,       MKICON(player_play)},
+            {MENU_ACTION,"Previous Frame",      NULL,ACT_PY_SHELL       ,MKICON(previous)},
+            {MENU_ACTION,"Next Frame",          NULL,ACT_PY_SHELL       ,MKICON(next)},
+            {MENU_ACTION,"Previous Intra Frame",NULL,ACT_PY_SHELL       ,MKICON(player_rew)},
+            {MENU_ACTION,"Next Intra Frame",    NULL,ACT_PY_SHELL       ,MKICON(player_fwd)},
+            {MENU_ACTION,"Previous Black Frame",NULL,ACT_PY_SHELL       ,MKICON(prev_black)},
+            {MENU_ACTION,"Next Black Frame",    NULL,ACT_PY_SHELL       ,MKICON(next_black)},
+            {MENU_ACTION,"First Frame",          NULL,ACT_PY_SHELL      ,MKICON(player_start)},
+            {MENU_ACTION,"Last Frame",          NULL,ACT_PY_SHELL       ,MKICON(player_end)},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY,NULL},
+            {MENU_ACTION,"Go To Marker A",      NULL,ACT_PY_SHELL       ,MKICON(markA)},
+            {MENU_ACTION,"Go To Marker B",      NULL,ACT_PY_SHELL       ,MKICON(markB)},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY,NULL},
+            {MENU_ACTION,"Go To Time",          NULL,ACT_PY_SHELL       ,NULL},
+        };
+
+MenuEntry myMenuView[]= {
+            {MENU_ACTION,"Zoom 1:4",      NULL,ACT_ZOOM_1_4 ,NULL},
+            {MENU_ACTION,"Zoom 1:2",      NULL,ACT_ZOOM_1_2 ,NULL},
+            {MENU_ACTION,"Zoom 1:1",      NULL,ACT_ZOOM_1_1 ,NULL},
+            {MENU_ACTION,"Zoom 2:1",      NULL,ACT_ZOOM_2_1 ,NULL},
+        };
+#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-06 10:23:30 UTC (rev 6596)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-06 10:23:31 UTC (rev 6597)
@@ -41,6 +41,9 @@
 #include "GUI_glade.h"
 #include "A_functions.h"
 
+#define MKICON(x) NULL
+#include "myOwnMenu.h"
+static void ui_setMenus(void);
 extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h);
 extern void ADM_initUIGtk(GtkWidget *guiRootWindow);
 extern  ADM_RENDER_TYPE UI_getPreferredRender(void);;
@@ -347,8 +350,8 @@
                 physical_jog_shuttle->registerCBs (NULL, jogButton, jogDial, jogRing);
 #endif
 
+    ui_setMenus();
 
-
 	return ret;
 }
 /**
@@ -459,7 +462,7 @@
 		uint32_t nb=sizeof(buttonCallback)/sizeof(buttonCallBack_S);
 		GtkWidget *bt;
 
-
+#if 0
 		for(uint32_t i=0;i<nb;i++)
 		{
 			bt= glade.getWidget(buttonCallback[i].name);
@@ -471,7 +474,7 @@
 			ADD_SIGNAL(bt,buttonCallback[i].signal,buttonCallback[i].action);
 			GTK_WIDGET_UNSET_FLAGS (bt, GTK_CAN_FOCUS);
 		}
-
+#endif
 	GTK_WIDGET_SET_FLAGS (glade.getWidget("boxCurFrame"), GTK_CAN_FOCUS);
 
 // set some tuning
@@ -985,6 +988,92 @@
 }
 
 /**
+    \fn ui_setMenus
+*/
+void ui_setOneMenu(const char *menuName, MenuEntry *desc, int nb)
+{
+    GtkWidget *window;
+    GtkWidget *menu;
+    GtkWidget *menu_bar;
+    GtkWidget *root_menu;
+    GtkWidget *menu_items;
+    GtkWidget *submenu=NULL;
+
+    menu = gtk_menu_new ();
+
+    for(int i=0;i<nb;i++)
+    {
+        MenuEntry *m=desc+i;
+        switch(m->type)
+        {
+            case MENU_SUBMENU:
+                {
+                    menu_items=gtk_menu_item_new_with_label(m->text);
+                    gtk_menu_shell_append (GTK_MENU_SHELL (menu), menu_items);
+                    gtk_widget_show (menu_items);
+                    submenu= gtk_menu_new ();
+                    gtk_menu_item_set_submenu(GTK_MENU_ITEM(menu_items),submenu);
+                }
+                break;
+            case MENU_SEPARATOR:
+                {
+                    menu_items=gtk_separator_menu_item_new();
+                    gtk_menu_shell_append (GTK_MENU_SHELL (menu), menu_items);
+                    gtk_widget_show (menu_items);
+                    break;
+                }
+            case MENU_SUBACTION:
+            case MENU_ACTION:
+                    {
+                     GtkWidget *target=menu;
+                     if(m->type==MENU_SUBACTION) target=submenu;
+                     menu_items = gtk_menu_item_new_with_label (m->text);
+                     gtk_menu_shell_append (GTK_MENU_SHELL (target), menu_items);
+                     gtk_widget_show (menu_items);
+                     gtk_signal_connect(GTK_OBJECT(menu_items), "activate", 
+                        GTK_SIGNAL_FUNC(guiCallback),                   (void *) m->event);
+                     break;
+                    }
+            default: break;
+        }
+    }
+
+    /* This is the root menu, and will be the label
+     * displayed on the menu bar.  There won't be a signal handler attached,
+     * as it only pops up the rest of the menu when pressed. */
+    root_menu = gtk_menu_item_new_with_label (menuName);
+
+    gtk_widget_show (root_menu);
+
+    /* Now we specify that we want our newly created "menu" to be the menu
+     * for the "root menu" */
+    gtk_menu_item_set_submenu (GTK_MENU_ITEM (root_menu), menu);
+    /* Create a menu-bar to hold the menus and add it to our main window */
+    menu_bar=(glade.getWidget("menuBar"));
+    /* Create a button to which to attach menu as a popup */
+    /* And finally we append the menu-item to the menu-bar -- this is the
+     * "root" menu-item I have been raving about =) */
+    gtk_menu_shell_append (GTK_MENU_SHELL (menu_bar), root_menu);
+}
+/**
+    \fn ui_setMenus
+*/
+void ui_setMenus(void)
+{
+#define SZ(x) x,sizeof(x)/sizeof(MenuEntry)
+    ui_setOneMenu("File", SZ(myMenuFile));
+    ui_setOneMenu("Recent", NULL,0);
+    ui_setOneMenu("Edit", SZ(myMenuEdit));
+    ui_setOneMenu("View", SZ(myMenuView));
+    ui_setOneMenu("Video", SZ(myMenuVideo));
+    ui_setOneMenu("Audio", SZ(myMenuAudio));
+    ui_setOneMenu("Tools", SZ(myMenuTool));
+    ui_setOneMenu("Custom", NULL,0);
+    ui_setOneMenu("Go", SZ(myMenuGo));
+    ui_setOneMenu("Help", SZ(myMenuHelp));
+}
+
+/**
             \fn guiCallback
             \brief This is a relay function to do UI events -> gtk_gui.cpp
 */
@@ -1141,14 +1230,18 @@
  int 	UI_getCurrentACodec(void)
  {
         //return getRangeInMenu(lookup_widget(guiRootWindow,AUDIO_WIDGET));
-        return gtk_combo_box_get_active(GTK_COMBO_BOX(glade.getWidget(AUDIO_WIDGET)));
+#warning broken
+        //return gtk_combo_box_get_active(GTK_COMBO_BOX(glade.getWidget(AUDIO_WIDGET)));
+        return 0;
 
  }
  int 	UI_getCurrentVCodec(void)
  {
 
  	//return getRangeInMenu(lookup_widget(guiRootWindow,VIDEO_WIDGET));
-        return gtk_combo_box_get_active(GTK_COMBO_BOX(glade.getWidget(VIDEO_WIDGET)));
+#warning broken
+        //return gtk_combo_box_get_active(GTK_COMBO_BOX(glade.getWidget(VIDEO_WIDGET)));
+    return 0;
 
  }
 /**
@@ -1592,3 +1685,4 @@
         return true;
 }
 // EOF
+

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.glade
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.glade	2010-09-06 10:23:30 UTC (rev 6596)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.glade	2010-09-06 10:23:31 UTC (rev 6597)
@@ -1,4 +1,4 @@
-<?xml version="1.0"?>
+<?xml version="1.0" encoding="UTF-8"?>
 <glade-interface>
   <!-- interface-requires gtk+ 2.16 -->
   <!-- interface-naming-policy toplevel-contextual -->
@@ -14,270 +14,22 @@
             <property name="visible">True</property>
             <property name="can_focus">True</property>
             <child>
-              <widget class="GtkMenuItem" id="menuitem1">
+              <widget class="GtkMenuItem" id="menuFile">
                 <property name="visible">True</property>
                 <property name="label" translatable="yes">_File</property>
                 <property name="use_underline">True</property>
                 <child>
-                  <widget class="GtkMenu" id="menuitem1_menu">
-                    <child>
-                      <widget class="GtkImageMenuItem" id="open_video1">
-                        <property name="label">_Open...</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="O" signal="activate" modifiers="GDK_CONTROL_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="append_video1">
-                        <property name="label">_Append...</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="A" signal="activate" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="save_stuff">
-                        <property name="label">_Save</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <child>
-                          <widget class="GtkMenu" id="save_stuff_menu">
-                            <child>
-                              <widget class="GtkMenuItem" id="save_as_avi1">
-                                <property name="visible">True</property>
-                                <property name="label" translatable="yes">Save _Video...</property>
-                                <property name="use_underline">True</property>
-                                <accelerator key="S" signal="activate" modifiers="GDK_CONTROL_MASK"/>
-                              </widget>
-                            </child>
-                            <child>
-                              <widget class="GtkSeparatorMenuItem" id="separator1">
-                                <property name="visible">True</property>
-                              </widget>
-                            </child>
-                            <child>
-                              <widget class="GtkMenuItem" id="save_image1">
-                                <property name="visible">True</property>
-                                <property name="label" translatable="yes">Save _BMP Image...</property>
-                                <property name="use_underline">True</property>
-                              </widget>
-                            </child>
-                            <child>
-                              <widget class="GtkMenuItem" id="save_jpg_image1">
-                                <property name="visible">True</property>
-                                <property name="label" translatable="yes">Save _JPEG Image...</property>
-                                <property name="use_underline">True</property>
-                              </widget>
-                            </child>
-                            <child>
-                              <widget class="GtkMenuItem" id="save_selection_as_jpegs1">
-                                <property name="visible">True</property>
-                                <property name="label" translatable="yes">Save _Selection as JPEG Images...</property>
-                                <property name="use_underline">True</property>
-                              </widget>
-                            </child>
-                          </widget>
-                        </child>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="close1">
-                        <property name="label">gtk-close</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator3">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="save_project1">
-                        <property name="label">Save _Project</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="save_project_as1">
-                        <property name="label">Save P_roject As...</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="run_script1">
-                        <property name="label">_Load/Run Project...</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="add_to_joblist1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">A_dd to Joblist...</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="joblist1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Show _Joblist</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="J" signal="activate" modifiers="GDK_CONTROL_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator16">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="connect_to_avsproxy1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Co_nnect to avsproxy</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator18">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="video_informations1">
-                        <property name="label">Proper_ties</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="Return" signal="activate" modifiers="GDK_MOD1_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="avi_muxer_options1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">AVI _Muxer Options</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator4">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="quit1">
-                        <property name="label">_Quit</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="Q" signal="activate" modifiers="GDK_CONTROL_MASK"/>
-                      </widget>
-                    </child>
-                  </widget>
+                  <widget class="GtkMenu" id="menuitem1_menu"/>
                 </child>
               </widget>
             </child>
             <child>
-              <widget class="GtkMenuItem" id="menuitem2">
+              <widget class="GtkMenuItem" id="menuEdit">
                 <property name="visible">True</property>
                 <property name="label" translatable="yes">_Edit</property>
                 <property name="use_underline">True</property>
                 <child>
-                  <widget class="GtkMenu" id="menuitem2_menu">
-                    <child>
-                      <widget class="GtkImageMenuItem" id="reset_edits1">
-                        <property name="label">_Reset Edits</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator5">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="cut1">
-                        <property name="label">Cu_t</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="X" signal="activate" modifiers="GDK_CONTROL_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="copy1">
-                        <property name="label">_Copy</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="C" signal="activate" modifiers="GDK_CONTROL_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="paste1">
-                        <property name="label">_Paste</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="V" signal="activate" modifiers="GDK_CONTROL_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="delete1">
-                        <property name="label">_Delete</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="Delete" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator6">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="set_marker_a1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Set Marker _A</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="bracketleft" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="set_marker_b1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Set Marker _B</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="bracketright" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator7">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="preferences1">
-                        <property name="label">Pre_ferences</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                      </widget>
-                    </child>
-                  </widget>
+                  <widget class="GtkMenu" id="menuitem2_menu"/>
                 </child>
               </widget>
             </child>
@@ -287,61 +39,7 @@
                 <property name="label" translatable="yes">_View</property>
                 <property name="use_underline">True</property>
                 <child>
-                  <widget class="GtkMenu" id="view1_menu">
-                    <child>
-                      <widget class="GtkCheckMenuItem" id="toolbar1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Main Toolbar</property>
-                        <property name="use_underline">True</property>
-                        <property name="active">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkCheckMenuItem" id="sidebar1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_A/V Sidebar</property>
-                        <property name="use_underline">True</property>
-                        <property name="active">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator8">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="zoom_1_4">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Zoom 1:4</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="4" signal="activate" modifiers="GDK_SHIFT_MASK | GDK_CONTROL_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="zoom_1_2">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Z_oom 1:2</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="2" signal="activate" modifiers="GDK_SHIFT_MASK | GDK_CONTROL_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="zoom_1_1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Zoom _1:1</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="1" signal="activate" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="zoom_2_1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Zoom _2:1</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="2" signal="activate" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-                      </widget>
-                    </child>
-                  </widget>
+                  <widget class="GtkMenu" id="menuView"/>
                 </child>
               </widget>
             </child>
@@ -351,74 +49,7 @@
                 <property name="label" translatable="yes">Vi_deo</property>
                 <property name="use_underline">True</property>
                 <child>
-                  <widget class="GtkMenu" id="video_1_menu">
-                    <child>
-                      <widget class="GtkMenuItem" id="decoder_options1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Decoder Options</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="F3" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="set_postprocessing1">
-                        <property name="visible">True</property>
-                        <property name="tooltip" translatable="yes">Select postprocessing level</property>
-                        <property name="label" translatable="yes">_Postprocessing</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="F4" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator9">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkCheckMenuItem" id="preview1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">P_review</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="F5" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkCheckMenuItem" id="display_output1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Display _Output</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="F6" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator10">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="change_fps">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Frame Rate</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="videoencoder">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Encoder</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="V" signal="activate" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="filters1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Fil_ters</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="F" signal="activate" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-                      </widget>
-                    </child>
-                  </widget>
+                  <widget class="GtkMenu" id="menuVideo"/>
                 </child>
               </widget>
             </child>
@@ -428,58 +59,7 @@
                 <property name="label" translatable="yes">_Audio</property>
                 <property name="use_underline">True</property>
                 <child>
-                  <widget class="GtkMenu" id="audio1_menu">
-                    <child>
-                      <widget class="GtkMenuItem" id="main_audio">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Main Track</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="second_audio_track1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Second Track</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="build_vbr_time_map1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Build VBR Time Map</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator11">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="save_audio1">
-                        <property name="label">S_ave...</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="S" signal="activate" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="audio_encoder1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Encoder</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="A" signal="activate" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="filters2">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Filters</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                  </widget>
+                  <widget class="GtkMenu" id="menuAudio"/>
                 </child>
               </widget>
             </child>
@@ -489,294 +69,17 @@
                 <property name="label" translatable="yes">_Tools</property>
                 <property name="use_underline">True</property>
                 <child>
-                  <widget class="GtkMenu" id="tools1_menu">
-                    <child>
-                      <widget class="GtkImageMenuItem" id="calculator1">
-                        <property name="label">_Calculator</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="F7" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator12">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="rebuild_frames">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Rebuild Frames (I &amp; B)</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="check_frames">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">C_heck Frames (slow)</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="bitrate_histogram1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Bitrate Histogram</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="item1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Scan for Black Frames...</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator13">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="v2v">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_VOB -&gt; VobSub</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="ocr_vobsub_2_srt">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_OCR (VobSub -&gt; srt)</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="ocr_dvb">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">OCR (TS-&gt;srt)</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="edit_glyph1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Edit Glyph</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator17">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="see_hex1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Frame Hex Dump</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="see_size">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Frame Size Dump</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                  </widget>
+                  <widget class="GtkMenu" id="menuTools"/>
                 </child>
               </widget>
             </child>
             <child>
-              <widget class="GtkMenuItem" id="help1">
-                <property name="visible">True</property>
-                <property name="label" translatable="yes">A_uto</property>
-                <property name="use_underline">True</property>
-                <child>
-                  <widget class="GtkMenu" id="help1_menu">
-                    <child>
-                      <widget class="GtkMenuItem" id="vcd1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_VCD</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="svcd1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_SVCD</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="dvd1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_DVD</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="psp1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_PSP</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="psp_(h264)1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">PSP (_H.264)</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="flv1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">F_LV</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="Ipod">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">IPOD (mpeg4)</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                  </widget>
-                </child>
-              </widget>
-            </child>
-            <child>
               <widget class="GtkMenuItem" id="go1">
                 <property name="visible">True</property>
                 <property name="label" translatable="yes">_Go</property>
                 <property name="use_underline">True</property>
                 <child>
-                  <widget class="GtkMenu" id="go1_menu">
-                    <child>
-                      <widget class="GtkImageMenuItem" id="play_video1">
-                        <property name="label">_Play/Stop</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="P" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="previous_frame1">
-                        <property name="label">P_revious Frame</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="KP_4" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="next_frame1">
-                        <property name="label">_Next Frame</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="KP_6" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="previous_intra_frame1">
-                        <property name="label">Pr_evious Intra Frame</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="KP_2" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="next_intra_frame1">
-                        <property name="label">Next _Intra Frame</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="KP_8" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="search_previous_black_frame1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Previou_s Black Frame</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="search_next_black_frame1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Ne_xt Black Frame</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="first_frame1">
-                        <property name="label">_First Frame</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="Home" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="last_frame1">
-                        <property name="label">_Last Frame</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="End" signal="activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator14">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="go_to_marker_a1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Go to Marker _A</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="bracketleft" signal="activate" modifiers="GDK_CONTROL_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="go_to_marker_b1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Go to Marker _B</property>
-                        <property name="use_underline">True</property>
-                        <accelerator key="bracketright" signal="activate" modifiers="GDK_CONTROL_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkSeparatorMenuItem" id="separator15">
-                        <property name="visible">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="jum_to_frame1">
-                        <property name="label">Go to Fra_me...</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="F" signal="activate" modifiers="GDK_CONTROL_MASK"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="jump_to_time1">
-                        <property name="label">Go to _Time...</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                        <accelerator key="T" signal="activate" modifiers="GDK_CONTROL_MASK"/>
-                      </widget>
-                    </child>
-                  </widget>
+                  <widget class="GtkMenu" id="menuGo"/>
                 </child>
               </widget>
             </child>
@@ -793,31 +96,7 @@
                 <property name="label" translatable="yes">_Help</property>
                 <property name="use_underline">True</property>
                 <child>
-                  <widget class="GtkMenu" id="help2_menu">
-                    <child>
-                      <widget class="GtkMenuItem" id="plugins1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Plugins</property>
-                        <property name="use_underline">True</property>
-                        <signal name="activate" handler="on_plugins1_activate"/>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkMenuItem" id="show_builtin_support1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">_Built-in Support</property>
-                        <property name="use_underline">True</property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkImageMenuItem" id="about1">
-                        <property name="label">_About</property>
-                        <property name="visible">True</property>
-                        <property name="use_underline">True</property>
-                        <property name="use_stock">True</property>
-                      </widget>
-                    </child>
-                  </widget>
+                  <widget class="GtkMenu" id="menuHelp"/>
                 </child>
               </widget>
             </child>
@@ -889,7 +168,7 @@
                 <property name="is_important">True</property>
                 <property name="label" translatable="yes">Calculator</property>
                 <property name="use_underline">True</property>
-                <property name="icon">gnome-calculator.png</property>
+                <property name="icon">gnome-calculator.xpm</property>
               </widget>
               <packing>
                 <property name="expand">False</property>
@@ -1225,41 +504,13 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkAlignment" id="alignment1">
+                              <widget class="GtkAlignment" id="alignment14">
                                 <property name="visible">True</property>
                                 <property name="top_padding">3</property>
                                 <property name="left_padding">12</property>
                                 <child>
-                                  <widget class="GtkVBox" id="vbox2">
+                                  <widget class="GtkComboBox" id="comboboxFormat">
                                     <property name="visible">True</property>
-                                    <property name="spacing">3</property>
-                                    <child>
-                                      <widget class="GtkComboBox" id="comboboxFormat">
-                                        <property name="visible">True</property>
-                                        <property name="items" translatable="yes">Copy</property>
-                                      </widget>
-                                      <packing>
-                                        <property name="expand">False</property>
-                                        <property name="fill">False</property>
-                                        <property name="position">0</property>
-                                      </packing>
-                                    </child>
-                                    <child>
-                                      <widget class="GtkButton" id="buttonConfF">
-                                        <property name="label" translatable="yes">Configure</property>
-                                        <property name="visible">True</property>
-                                        <property name="can_focus">True</property>
-                                        <property name="receives_default">False</property>
-                                        <property name="tooltip" translatable="yes">Configure video encoder</property>
-                                        <property name="use_underline">True</property>
-                                        <accelerator key="F3" signal="clicked"/>
-                                      </widget>
-                                      <packing>
-                                        <property name="expand">False</property>
-                                        <property name="fill">False</property>
-                                        <property name="position">1</property>
-                                      </packing>
-                                    </child>
                                   </widget>
                                 </child>
                               </widget>
@@ -1307,18 +558,6 @@
                 <property name="n_columns">2</property>
                 <property name="column_spacing">6</property>
                 <child>
-                  <widget class="Custom" id="jogg">
-                    <property name="visible">True</property>
-                    <property name="creation_function">jog_shuttle_new</property>
-                  </widget>
-                  <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_EXPAND</property>
-                  </packing>
-                </child>
-                <child>
                   <widget class="GtkVBox" id="vbox14">
                     <property name="visible">True</property>
                     <child>
@@ -1356,7 +595,7 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="x_options"></property>
+                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
@@ -1372,7 +611,7 @@
                                 <property name="right_attach">2</property>
                                 <property name="top_attach">1</property>
                                 <property name="bottom_attach">2</property>
-                                <property name="x_options"></property>
+                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
@@ -1387,8 +626,8 @@
                                 <property name="use_underline">True</property>
                               </widget>
                               <packing>
-                                <property name="x_options"></property>
-                                <property name="y_options"></property>
+                                <property name="x_options">GTK_FILL</property>
+                                <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                             <child>
@@ -1404,8 +643,8 @@
                               <packing>
                                 <property name="top_attach">1</property>
                                 <property name="bottom_attach">2</property>
-                                <property name="x_options"></property>
-                                <property name="y_options"></property>
+                                <property name="x_options">GTK_FILL</property>
+                                <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                           </widget>
@@ -1421,8 +660,8 @@
                     <property name="right_attach">2</property>
                     <property name="top_attach">1</property>
                     <property name="bottom_attach">3</property>
-                    <property name="x_options"></property>
-                    <property name="y_options"></property>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
@@ -1440,7 +679,7 @@
                         <child>
                           <widget class="GtkImage" id="image591">
                             <property name="visible">True</property>
-                            <property name="pixbuf">play.png</property>
+                            <property name="pixbuf">play.xpm</property>
                           </widget>
                         </child>
                       </widget>
@@ -1461,7 +700,7 @@
                         <child>
                           <widget class="GtkImage" id="image5056">
                             <property name="visible">True</property>
-                            <property name="pixbuf">stop.png</property>
+                            <property name="pixbuf">stop.xpm</property>
                           </widget>
                         </child>
                       </widget>
@@ -1483,7 +722,7 @@
                         <child>
                           <widget class="GtkImage" id="image593">
                             <property name="visible">True</property>
-                            <property name="pixbuf">previous-frame.png</property>
+                            <property name="pixbuf">backward.xpm</property>
                           </widget>
                         </child>
                       </widget>
@@ -1505,7 +744,7 @@
                         <child>
                           <widget class="GtkImage" id="image594">
                             <property name="visible">True</property>
-                            <property name="pixbuf">next-frame.png</property>
+                            <property name="pixbuf">forward.xpm</property>
                           </widget>
                         </child>
                       </widget>
@@ -1527,7 +766,7 @@
                         <child>
                           <widget class="GtkImage" id="image595">
                             <property name="visible">True</property>
-                            <property name="pixbuf">previous-key-frame.png</property>
+                            <property name="pixbuf">Kbackward.xpm</property>
                           </widget>
                         </child>
                       </widget>
@@ -1549,7 +788,7 @@
                         <child>
                           <widget class="GtkImage" id="image596">
                             <property name="visible">True</property>
-                            <property name="pixbuf">next-key-frame.png</property>
+                            <property name="pixbuf">Kforward.xpm</property>
                           </widget>
                         </child>
                       </widget>
@@ -1570,7 +809,7 @@
                         <child>
                           <widget class="GtkImage" id="image2306">
                             <property name="visible">True</property>
-                            <property name="pixbuf">markA.png</property>
+                            <property name="pixbuf">markA.xpm</property>
                           </widget>
                         </child>
                       </widget>
@@ -1591,7 +830,7 @@
                         <child>
                           <widget class="GtkImage" id="image2307">
                             <property name="visible">True</property>
-                            <property name="pixbuf">markB.png</property>
+                            <property name="pixbuf">markB.xpm</property>
                           </widget>
                         </child>
                       </widget>
@@ -1612,7 +851,7 @@
                         <child>
                           <widget class="GtkImage" id="image2308">
                             <property name="visible">True</property>
-                            <property name="pixbuf">previous-black-frame.png</property>
+                            <property name="pixbuf">xpm_prevblack.xpm</property>
                           </widget>
                         </child>
                       </widget>
@@ -1633,7 +872,7 @@
                         <child>
                           <widget class="GtkImage" id="image2309">
                             <property name="visible">True</property>
-                            <property name="pixbuf">next-black-frame.png</property>
+                            <property name="pixbuf">xpm_nextblack.xpm</property>
                           </widget>
                         </child>
                       </widget>
@@ -1654,7 +893,7 @@
                         <child>
                           <widget class="GtkImage" id="image5057">
                             <property name="visible">True</property>
-                            <property name="pixbuf">first-frame.png</property>
+                            <property name="pixbuf">begin.xpm</property>
                           </widget>
                         </child>
                       </widget>
@@ -1675,7 +914,7 @@
                         <child>
                           <widget class="GtkImage" id="image2245">
                             <property name="visible">True</property>
-                            <property name="pixbuf">last-frame.png</property>
+                            <property name="pixbuf">end.xpm</property>
                           </widget>
                         </child>
                       </widget>
@@ -1801,6 +1040,18 @@
                     <property name="y_options"></property>
                   </packing>
                 </child>
+                <child>
+                  <widget class="Custom" id="jogg">
+                    <property name="visible">True</property>
+                    <property name="creation_function">jog_shuttle_new</property>
+                  </widget>
+                  <packing>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options">GTK_EXPAND</property>
+                  </packing>
+                </child>
               </widget>
               <packing>
                 <property name="expand">False</property>

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.gtkBuilder
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.gtkBuilder	2010-09-06 10:23:30 UTC (rev 6596)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.gtkBuilder	2010-09-06 10:23:31 UTC (rev 6597)
@@ -1,747 +1,6 @@
-<?xml version="1.0"?>
+<?xml version="1.0" encoding="UTF-8"?>
 <interface>
-  <object class="GtkAdjustment" id="adjustment1">
-    <property name="upper">100</property>
-    <property name="lower">0</property>
-    <property name="page_increment">1</property>
-    <property name="step_increment">1</property>
-    <property name="page_size">1</property>
-    <property name="value">99</property>
-  </object>
-  <object class="GtkAdjustment" id="adjustment2">
-    <property name="upper">99999</property>
-    <property name="lower">-99999</property>
-    <property name="page_increment">10</property>
-    <property name="step_increment">1</property>
-    <property name="page_size">10</property>
-    <property name="value">0</property>
-  </object>
-  <object class="GtkAdjustment" id="adjustment3">
-    <property name="upper">99.989997863799999</property>
-    <property name="lower">0</property>
-    <property name="page_increment">1</property>
-    <property name="step_increment">0.0099999997764800008</property>
-    <property name="page_size">0</property>
-    <property name="value">0</property>
-  </object>
-  <object class="GtkListStore" id="model1">
-    <columns>
-      <column type="gchararray"/>
-    </columns>
-    <data>
-      <row>
-        <col id="0" translatable="yes">Copy</col>
-      </row>
-    </data>
-  </object>
-  <object class="GtkListStore" id="model2">
-    <columns>
-      <column type="gchararray"/>
-    </columns>
-    <data>
-      <row>
-        <col id="0" translatable="yes">Copy</col>
-      </row>
-    </data>
-  </object>
-  <object class="GtkListStore" id="model3">
-    <columns>
-      <column type="gchararray"/>
-    </columns>
-    <data>
-      <row>
-        <col id="0" translatable="yes">Copy</col>
-      </row>
-    </data>
-  </object>
-  <object class="GtkUIManager" id="uimanager1">
-    <child>
-      <object class="GtkActionGroup" id="actiongroup1">
-        <child>
-          <object class="GtkAction" id="menuitem1">
-            <property name="name">menuitem1</property>
-            <property name="label" translatable="yes">_File</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="open_video1">
-            <property name="stock_id">_Open...</property>
-            <property name="name">open_video1</property>
-          </object>
-          <accelerator key="O" modifiers="GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="append_video1">
-            <property name="stock_id">_Append...</property>
-            <property name="name">append_video1</property>
-          </object>
-          <accelerator key="A" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="save_stuff">
-            <property name="stock_id">_Save</property>
-            <property name="name">save_stuff</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="save_as_avi1">
-            <property name="name">save_as_avi1</property>
-            <property name="label" translatable="yes">Save _Video...</property>
-          </object>
-          <accelerator key="S" modifiers="GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="save_image1">
-            <property name="name">save_image1</property>
-            <property name="label" translatable="yes">Save _BMP Image...</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="save_jpg_image1">
-            <property name="name">save_jpg_image1</property>
-            <property name="label" translatable="yes">Save _JPEG Image...</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="save_selection_as_jpegs1">
-            <property name="name">save_selection_as_jpegs1</property>
-            <property name="label" translatable="yes">Save _Selection as JPEG Images...</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="close1">
-            <property name="stock_id">gtk-close</property>
-            <property name="name">close1</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="save_project1">
-            <property name="stock_id">Save _Project</property>
-            <property name="name">save_project1</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="save_project_as1">
-            <property name="stock_id">Save P_roject As...</property>
-            <property name="name">save_project_as1</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="run_script1">
-            <property name="stock_id">_Load/Run Project...</property>
-            <property name="name">run_script1</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="add_to_joblist1">
-            <property name="name">add_to_joblist1</property>
-            <property name="label" translatable="yes">A_dd to Joblist...</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="joblist1">
-            <property name="name">joblist1</property>
-            <property name="label" translatable="yes">Show _Joblist</property>
-          </object>
-          <accelerator key="J" modifiers="GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="connect_to_avsproxy1">
-            <property name="name">connect_to_avsproxy1</property>
-            <property name="label" translatable="yes">Co_nnect to avsproxy</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="video_informations1">
-            <property name="stock_id">Proper_ties</property>
-            <property name="name">video_informations1</property>
-          </object>
-          <accelerator key="Return" modifiers="GDK_MOD1_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="avi_muxer_options1">
-            <property name="name">avi_muxer_options1</property>
-            <property name="label" translatable="yes">AVI _Muxer Options</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="quit1">
-            <property name="stock_id">_Quit</property>
-            <property name="name">quit1</property>
-          </object>
-          <accelerator key="Q" modifiers="GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="menuitem2">
-            <property name="name">menuitem2</property>
-            <property name="label" translatable="yes">_Edit</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="reset_edits1">
-            <property name="stock_id">_Reset Edits</property>
-            <property name="name">reset_edits1</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="cut1">
-            <property name="stock_id">Cu_t</property>
-            <property name="name">cut1</property>
-          </object>
-          <accelerator key="X" modifiers="GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="copy1">
-            <property name="stock_id">_Copy</property>
-            <property name="name">copy1</property>
-          </object>
-          <accelerator key="C" modifiers="GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="paste1">
-            <property name="stock_id">_Paste</property>
-            <property name="name">paste1</property>
-          </object>
-          <accelerator key="V" modifiers="GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="delete1">
-            <property name="stock_id">_Delete</property>
-            <property name="name">delete1</property>
-          </object>
-          <accelerator key="Delete"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="set_marker_a1">
-            <property name="name">set_marker_a1</property>
-            <property name="label" translatable="yes">Set Marker _A</property>
-          </object>
-          <accelerator key="bracketleft"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="set_marker_b1">
-            <property name="name">set_marker_b1</property>
-            <property name="label" translatable="yes">Set Marker _B</property>
-          </object>
-          <accelerator key="bracketright"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="preferences1">
-            <property name="stock_id">Pre_ferences</property>
-            <property name="name">preferences1</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="view1">
-            <property name="name">view1</property>
-            <property name="label" translatable="yes">_View</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkToggleAction" id="toolbar1">
-            <property name="active">True</property>
-            <property name="name">toolbar1</property>
-            <property name="label" translatable="yes">_Main Toolbar</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkToggleAction" id="sidebar1">
-            <property name="active">True</property>
-            <property name="name">sidebar1</property>
-            <property name="label" translatable="yes">_A/V Sidebar</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="zoom_1_4">
-            <property name="name">zoom_1_4</property>
-            <property name="label" translatable="yes">_Zoom 1:4</property>
-          </object>
-          <accelerator key="4" modifiers="GDK_SHIFT_MASK | GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="zoom_1_2">
-            <property name="name">zoom_1_2</property>
-            <property name="label" translatable="yes">Z_oom 1:2</property>
-          </object>
-          <accelerator key="2" modifiers="GDK_SHIFT_MASK | GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="zoom_1_1">
-            <property name="name">zoom_1_1</property>
-            <property name="label" translatable="yes">Zoom _1:1</property>
-          </object>
-          <accelerator key="1" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="zoom_2_1">
-            <property name="name">zoom_2_1</property>
-            <property name="label" translatable="yes">Zoom _2:1</property>
-          </object>
-          <accelerator key="2" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="video_1">
-            <property name="name">video_1</property>
-            <property name="label" translatable="yes">Vi_deo</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="decoder_options1">
-            <property name="name">decoder_options1</property>
-            <property name="label" translatable="yes">_Decoder Options</property>
-          </object>
-          <accelerator key="F3"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="set_postprocessing1">
-            <property name="name">set_postprocessing1</property>
-            <property name="tooltip" translatable="yes">Select postprocessing level</property>
-            <property name="label" translatable="yes">_Postprocessing</property>
-          </object>
-          <accelerator key="F4"/>
-        </child>
-        <child>
-          <object class="GtkToggleAction" id="preview1">
-            <property name="name">preview1</property>
-            <property name="label" translatable="yes">P_review</property>
-          </object>
-          <accelerator key="F5"/>
-        </child>
-        <child>
-          <object class="GtkToggleAction" id="display_output1">
-            <property name="name">display_output1</property>
-            <property name="label" translatable="yes">Display _Output</property>
-          </object>
-          <accelerator key="F6"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="change_fps">
-            <property name="name">change_fps</property>
-            <property name="label" translatable="yes">_Frame Rate</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="videoencoder">
-            <property name="name">videoencoder</property>
-            <property name="label" translatable="yes">_Encoder</property>
-          </object>
-          <accelerator key="V" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="filters1">
-            <property name="name">filters1</property>
-            <property name="label" translatable="yes">Fil_ters</property>
-          </object>
-          <accelerator key="F" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="audio1">
-            <property name="name">audio1</property>
-            <property name="label" translatable="yes">_Audio</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="main_audio">
-            <property name="name">main_audio</property>
-            <property name="label" translatable="yes">_Main Track</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="second_audio_track1">
-            <property name="name">second_audio_track1</property>
-            <property name="label" translatable="yes">_Second Track</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="build_vbr_time_map1">
-            <property name="name">build_vbr_time_map1</property>
-            <property name="label" translatable="yes">_Build VBR Time Map</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="save_audio1">
-            <property name="stock_id">S_ave...</property>
-            <property name="name">save_audio1</property>
-          </object>
-          <accelerator key="S" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="audio_encoder1">
-            <property name="name">audio_encoder1</property>
-            <property name="label" translatable="yes">_Encoder</property>
-          </object>
-          <accelerator key="A" modifiers="GDK_CONTROL_MASK | GDK_MOD1_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="filters2">
-            <property name="name">filters2</property>
-            <property name="label" translatable="yes">_Filters</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="tools1">
-            <property name="name">tools1</property>
-            <property name="label" translatable="yes">_Tools</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="calculator1">
-            <property name="stock_id">_Calculator</property>
-            <property name="name">calculator1</property>
-          </object>
-          <accelerator key="F7"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="rebuild_frames">
-            <property name="name">rebuild_frames</property>
-            <property name="label" translatable="yes">_Rebuild Frames (I &amp; B)</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="check_frames">
-            <property name="name">check_frames</property>
-            <property name="label" translatable="yes">C_heck Frames (slow)</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="bitrate_histogram1">
-            <property name="name">bitrate_histogram1</property>
-            <property name="label" translatable="yes">_Bitrate Histogram</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="item1">
-            <property name="name">item1</property>
-            <property name="label" translatable="yes">_Scan for Black Frames...</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="v2v">
-            <property name="name">v2v</property>
-            <property name="label" translatable="yes">_VOB -&gt; VobSub</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="ocr_vobsub_2_srt">
-            <property name="name">ocr_vobsub_2_srt</property>
-            <property name="label" translatable="yes">_OCR (VobSub -&gt; srt)</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="ocr_dvb">
-            <property name="name">ocr_dvb</property>
-            <property name="label" translatable="yes">OCR (TS-&gt;srt)</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="edit_glyph1">
-            <property name="name">edit_glyph1</property>
-            <property name="label" translatable="yes">_Edit Glyph</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="see_hex1">
-            <property name="name">see_hex1</property>
-            <property name="label" translatable="yes">_Frame Hex Dump</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="see_size">
-            <property name="name">see_size</property>
-            <property name="label" translatable="yes">Frame Size Dump</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="help1">
-            <property name="name">help1</property>
-            <property name="label" translatable="yes">A_uto</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="vcd1">
-            <property name="name">vcd1</property>
-            <property name="label" translatable="yes">_VCD</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="svcd1">
-            <property name="name">svcd1</property>
-            <property name="label" translatable="yes">_SVCD</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="dvd1">
-            <property name="name">dvd1</property>
-            <property name="label" translatable="yes">_DVD</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="psp1">
-            <property name="name">psp1</property>
-            <property name="label" translatable="yes">_PSP</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="psp_(h264)1">
-            <property name="name">psp_(h264)1</property>
-            <property name="label" translatable="yes">PSP (_H.264)</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="flv1">
-            <property name="name">flv1</property>
-            <property name="label" translatable="yes">F_LV</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="Ipod">
-            <property name="name">Ipod</property>
-            <property name="label" translatable="yes">IPOD (mpeg4)</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="go1">
-            <property name="name">go1</property>
-            <property name="label" translatable="yes">_Go</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="play_video1">
-            <property name="stock_id">_Play/Stop</property>
-            <property name="name">play_video1</property>
-          </object>
-          <accelerator key="P"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="previous_frame1">
-            <property name="stock_id">P_revious Frame</property>
-            <property name="name">previous_frame1</property>
-          </object>
-          <accelerator key="KP_4"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="next_frame1">
-            <property name="stock_id">_Next Frame</property>
-            <property name="name">next_frame1</property>
-          </object>
-          <accelerator key="KP_6"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="previous_intra_frame1">
-            <property name="stock_id">Pr_evious Intra Frame</property>
-            <property name="name">previous_intra_frame1</property>
-          </object>
-          <accelerator key="KP_2"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="next_intra_frame1">
-            <property name="stock_id">Next _Intra Frame</property>
-            <property name="name">next_intra_frame1</property>
-          </object>
-          <accelerator key="KP_8"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="search_previous_black_frame1">
-            <property name="name">search_previous_black_frame1</property>
-            <property name="label" translatable="yes">Previou_s Black Frame</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="search_next_black_frame1">
-            <property name="name">search_next_black_frame1</property>
-            <property name="label" translatable="yes">Ne_xt Black Frame</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="first_frame1">
-            <property name="stock_id">_First Frame</property>
-            <property name="name">first_frame1</property>
-          </object>
-          <accelerator key="Home"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="last_frame1">
-            <property name="stock_id">_Last Frame</property>
-            <property name="name">last_frame1</property>
-          </object>
-          <accelerator key="End"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="go_to_marker_a1">
-            <property name="name">go_to_marker_a1</property>
-            <property name="label" translatable="yes">Go to Marker _A</property>
-          </object>
-          <accelerator key="bracketleft" modifiers="GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="go_to_marker_b1">
-            <property name="name">go_to_marker_b1</property>
-            <property name="label" translatable="yes">Go to Marker _B</property>
-          </object>
-          <accelerator key="bracketright" modifiers="GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="jum_to_frame1">
-            <property name="stock_id">Go to Fra_me...</property>
-            <property name="name">jum_to_frame1</property>
-          </object>
-          <accelerator key="F" modifiers="GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="jump_to_time1">
-            <property name="stock_id">Go to _Time...</property>
-            <property name="name">jump_to_time1</property>
-          </object>
-          <accelerator key="T" modifiers="GDK_CONTROL_MASK"/>
-        </child>
-        <child>
-          <object class="GtkAction" id="help2">
-            <property name="name">help2</property>
-            <property name="label" translatable="yes">_Help</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="plugins1">
-            <property name="name">plugins1</property>
-            <property name="label" translatable="yes">_Plugins</property>
-            <signal handler="on_plugins1_activate" name="activate"/>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="show_builtin_support1">
-            <property name="name">show_builtin_support1</property>
-            <property name="label" translatable="yes">_Built-in Support</property>
-          </object>
-        </child>
-        <child>
-          <object class="GtkAction" id="about1">
-            <property name="stock_id">_About</property>
-            <property name="name">about1</property>
-          </object>
-        </child>
-      </object>
-    </child>
-    <ui>
-      <menubar name="menuBar">
-        <menu action="menuitem1">
-          <menuitem action="open_video1"/>
-          <menuitem action="append_video1"/>
-          <menu action="save_stuff">
-            <menuitem action="save_as_avi1"/>
-            <separator/>
-            <menuitem action="save_image1"/>
-            <menuitem action="save_jpg_image1"/>
-            <menuitem action="save_selection_as_jpegs1"/>
-          </menu>
-          <menuitem action="close1"/>
-          <separator/>
-          <menuitem action="save_project1"/>
-          <menuitem action="save_project_as1"/>
-          <menuitem action="run_script1"/>
-          <menuitem action="add_to_joblist1"/>
-          <menuitem action="joblist1"/>
-          <separator/>
-          <menuitem action="connect_to_avsproxy1"/>
-          <separator/>
-          <menuitem action="video_informations1"/>
-          <menuitem action="avi_muxer_options1"/>
-          <separator/>
-          <menuitem action="quit1"/>
-        </menu>
-        <menu action="menuitem2">
-          <menuitem action="reset_edits1"/>
-          <separator/>
-          <menuitem action="cut1"/>
-          <menuitem action="copy1"/>
-          <menuitem action="paste1"/>
-          <menuitem action="delete1"/>
-          <separator/>
-          <menuitem action="set_marker_a1"/>
-          <menuitem action="set_marker_b1"/>
-          <separator/>
-          <menuitem action="preferences1"/>
-        </menu>
-        <menu action="view1">
-          <menuitem action="toolbar1"/>
-          <menuitem action="sidebar1"/>
-          <separator/>
-          <menuitem action="zoom_1_4"/>
-          <menuitem action="zoom_1_2"/>
-          <menuitem action="zoom_1_1"/>
-          <menuitem action="zoom_2_1"/>
-        </menu>
-        <menu action="video_1">
-          <menuitem action="decoder_options1"/>
-          <menuitem action="set_postprocessing1"/>
-          <separator/>
-          <menuitem action="preview1"/>
-          <menuitem action="display_output1"/>
-          <separator/>
-          <menuitem action="change_fps"/>
-          <menuitem action="videoencoder"/>
-          <menuitem action="filters1"/>
-        </menu>
-        <menu action="audio1">
-          <menuitem action="main_audio"/>
-          <menuitem action="second_audio_track1"/>
-          <menuitem action="build_vbr_time_map1"/>
-          <separator/>
-          <menuitem action="save_audio1"/>
-          <menuitem action="audio_encoder1"/>
-          <menuitem action="filters2"/>
-        </menu>
-        <menu action="tools1">
-          <menuitem action="calculator1"/>
-          <separator/>
-          <menuitem action="rebuild_frames"/>
-          <menuitem action="check_frames"/>
-          <menuitem action="bitrate_histogram1"/>
-          <menuitem action="item1"/>
-          <separator/>
-          <menuitem action="v2v"/>
-          <menuitem action="ocr_vobsub_2_srt"/>
-          <menuitem action="ocr_dvb"/>
-          <menuitem action="edit_glyph1"/>
-          <separator/>
-          <menuitem action="see_hex1"/>
-          <menuitem action="see_size"/>
-        </menu>
-        <menu action="help1">
-          <menuitem action="vcd1"/>
-          <menuitem action="svcd1"/>
-          <menuitem action="dvd1"/>
-          <menuitem action="psp1"/>
-          <menuitem action="psp_(h264)1"/>
-          <menuitem action="flv1"/>
-          <menuitem action="Ipod"/>
-        </menu>
-        <menu action="go1">
-          <menuitem action="play_video1"/>
-          <menuitem action="previous_frame1"/>
-          <menuitem action="next_frame1"/>
-          <menuitem action="previous_intra_frame1"/>
-          <menuitem action="next_intra_frame1"/>
-          <menuitem action="search_previous_black_frame1"/>
-          <menuitem action="search_next_black_frame1"/>
-          <menuitem action="first_frame1"/>
-          <menuitem action="last_frame1"/>
-          <separator/>
-          <menuitem action="go_to_marker_a1"/>
-          <menuitem action="go_to_marker_b1"/>
-          <separator/>
-          <menuitem action="jum_to_frame1"/>
-          <menuitem action="jump_to_time1"/>
-        </menu>
-        <menuitem action="custom1"/>
-        <menu action="help2">
-          <menuitem action="plugins1"/>
-          <menuitem action="show_builtin_support1"/>
-          <menuitem action="about1"/>
-        </menu>
-      </menubar>
-    </ui>
-  </object>
-  <!-- interface-requires gtk+ 2.16 -->
+  <requires lib="gtk+" version="2.16"/>
   <!-- interface-naming-policy toplevel-contextual -->
   <object class="GtkWindow" id="mainWindow">
     <property name="visible">True</property>
@@ -751,7 +10,7 @@
       <object class="GtkVBox" id="vbox1">
         <property name="visible">True</property>
         <child>
-          <object class="GtkMenuBar" constructor="uimanager1" id="menuBar">
+          <object class="GtkMenuBar" id="menuBar">
             <property name="visible">True</property>
             <property name="can_focus">True</property>
           </object>
@@ -768,7 +27,6 @@
             <child>
               <object class="GtkMenuToolButton" id="menutoolbuttonOpen">
                 <property name="visible">True</property>
-                <property name="tooltip-text" translatable="yes">Open a file</property>
                 <property name="is_important">True</property>
                 <property name="stock_id">gtk-open</property>
               </object>
@@ -787,7 +45,6 @@
             <child>
               <object class="GtkToolButton" id="toolbuttonSave">
                 <property name="visible">True</property>
-                <property name="tooltip-text" translatable="yes">Save the file</property>
                 <property name="is_important">True</property>
                 <property name="stock_id">gtk-save</property>
               </object>
@@ -799,7 +56,6 @@
             <child>
               <object class="GtkToolButton" id="toolbuttonInfo">
                 <property name="visible">True</property>
-                <property name="tooltip-text" translatable="yes">Audio/video file information</property>
                 <property name="stock_id">gtk-properties</property>
               </object>
               <packing>
@@ -818,11 +74,9 @@
             <child>
               <object class="GtkToolButton" id="toolbuttonCalc">
                 <property name="visible">True</property>
-                <property name="tooltip-text" translatable="yes">Bitrate/size calculator</property>
                 <property name="is_important">True</property>
                 <property name="label" translatable="yes">Calculator</property>
                 <property name="use_underline">True</property>
-                <property name="icon">gnome-calculator.png</property>
               </object>
               <packing>
                 <property name="expand">False</property>
@@ -882,7 +136,6 @@
                     <property name="width_request">100</property>
                     <property name="visible">True</property>
                     <property name="can_focus">True</property>
-                    <property name="adjustment">adjustment1</property>
                     <property name="digits">0</property>
                     <property name="draw_value">False</property>
                   </object>
@@ -943,13 +196,6 @@
                                     <child>
                                       <object class="GtkComboBox" id="comboboxVideo">
                                         <property name="visible">True</property>
-                                        <property name="model">model1</property>
-                                        <child>
-                                          <object class="GtkCellRendererText" id="renderer1"/>
-                                          <attributes>
-                                            <attribute name="text">0</attribute>
-                                          </attributes>
-                                        </child>
                                       </object>
                                       <packing>
                                         <property name="expand">False</property>
@@ -963,7 +209,6 @@
                                         <property name="visible">True</property>
                                         <property name="can_focus">True</property>
                                         <property name="receives_default">False</property>
-                                        <property name="tooltip-text" translatable="yes">Configure video encoder</property>
                                         <property name="use_underline">True</property>
                                         <accelerator key="F3" signal="clicked"/>
                                       </object>
@@ -979,7 +224,6 @@
                                         <property name="visible">True</property>
                                         <property name="can_focus">True</property>
                                         <property name="receives_default">False</property>
-                                        <property name="tooltip-text" translatable="yes">Video filters</property>
                                         <property name="use_underline">True</property>
                                         <accelerator key="F1" signal="clicked"/>
                                       </object>
@@ -1031,13 +275,6 @@
                                     <child>
                                       <object class="GtkComboBox" id="comboboxAudio">
                                         <property name="visible">True</property>
-                                        <property name="model">model2</property>
-                                        <child>
-                                          <object class="GtkCellRendererText" id="renderer2"/>
-                                          <attributes>
-                                            <attribute name="text">0</attribute>
-                                          </attributes>
-                                        </child>
                                       </object>
                                       <packing>
                                         <property name="expand">False</property>
@@ -1051,7 +288,6 @@
                                         <property name="visible">True</property>
                                         <property name="can_focus">True</property>
                                         <property name="receives_default">False</property>
-                                        <property name="tooltip-text" translatable="yes">Configure audio encoder</property>
                                         <property name="use_underline">True</property>
                                         <accelerator key="F4" signal="clicked"/>
                                       </object>
@@ -1066,7 +302,6 @@
                                         <property name="visible">True</property>
                                         <property name="can_focus">True</property>
                                         <property name="receives_default">False</property>
-                                        <property name="tooltip-text" translatable="yes">Audio filters</property>
                                         <accelerator key="F2" signal="clicked"/>
                                         <child>
                                           <object class="GtkAlignment" id="alignment16">
@@ -1110,7 +345,6 @@
                                             <property name="visible">True</property>
                                             <property name="can_focus">True</property>
                                             <property name="receives_default">False</property>
-                                            <property name="tooltip-text" translatable="yes">Enable time shift</property>
                                             <property name="use_underline">True</property>
                                             <property name="draw_indicator">True</property>
                                           </object>
@@ -1124,8 +358,6 @@
                                           <object class="GtkSpinButton" id="spinbuttonTimeShift">
                                             <property name="visible">True</property>
                                             <property name="can_focus">True</property>
-                                            <property name="tooltip-text" translatable="yes">Audio/video time shift (ms)</property>
-                                            <property name="adjustment">adjustment2</property>
                                             <property name="climb_rate">1</property>
                                             <property name="numeric">True</property>
                                           </object>
@@ -1169,47 +401,13 @@
                               </packing>
                             </child>
                             <child>
-                              <object class="GtkAlignment" id="alignment1">
+                              <object class="GtkAlignment" id="alignment14">
                                 <property name="visible">True</property>
                                 <property name="top_padding">3</property>
                                 <property name="left_padding">12</property>
                                 <child>
-                                  <object class="GtkVBox" id="vbox2">
+                                  <object class="GtkComboBox" id="comboboxFormat">
                                     <property name="visible">True</property>
-                                    <property name="spacing">3</property>
-                                    <child>
-                                      <object class="GtkComboBox" id="comboboxFormat">
-                                        <property name="visible">True</property>
-                                        <property name="model">model3</property>
-                                        <child>
-                                          <object class="GtkCellRendererText" id="renderer3"/>
-                                          <attributes>
-                                            <attribute name="text">0</attribute>
-                                          </attributes>
-                                        </child>
-                                      </object>
-                                      <packing>
-                                        <property name="expand">False</property>
-                                        <property name="fill">False</property>
-                                        <property name="position">0</property>
-                                      </packing>
-                                    </child>
-                                    <child>
-                                      <object class="GtkButton" id="buttonConfF">
-                                        <property name="label" translatable="yes">Configure</property>
-                                        <property name="visible">True</property>
-                                        <property name="can_focus">True</property>
-                                        <property name="receives_default">False</property>
-                                        <property name="tooltip-text" translatable="yes">Configure video encoder</property>
-                                        <property name="use_underline">True</property>
-                                        <accelerator key="F3" signal="clicked"/>
-                                      </object>
-                                      <packing>
-                                        <property name="expand">False</property>
-                                        <property name="fill">False</property>
-                                        <property name="position">1</property>
-                                      </packing>
-                                    </child>
                                   </object>
                                 </child>
                               </object>
@@ -1294,8 +492,8 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="x_options"/>
-                                <property name="y_options"/>
+                                <property name="x_options">GTK_FILL</property>
+                                <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
@@ -1310,8 +508,8 @@
                                 <property name="right_attach">2</property>
                                 <property name="top_attach">1</property>
                                 <property name="bottom_attach">2</property>
-                                <property name="x_options"/>
-                                <property name="y_options"/>
+                                <property name="x_options">GTK_FILL</property>
+                                <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
@@ -1321,12 +519,11 @@
                                 <property name="visible">True</property>
                                 <property name="can_focus">False</property>
                                 <property name="receives_default">False</property>
-                                <property name="tooltip-text" translatable="yes">Go to marker A</property>
                                 <property name="use_underline">True</property>
                               </object>
                               <packing>
-                                <property name="x_options"/>
-                                <property name="y_options"/>
+                                <property name="x_options">GTK_FILL</property>
+                                <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                             <child>
@@ -1336,14 +533,13 @@
                                 <property name="visible">True</property>
                                 <property name="can_focus">False</property>
                                 <property name="receives_default">False</property>
-                                <property name="tooltip-text" translatable="yes">Go to marker B</property>
                                 <property name="use_underline">True</property>
                               </object>
                               <packing>
                                 <property name="top_attach">1</property>
                                 <property name="bottom_attach">2</property>
-                                <property name="x_options"/>
-                                <property name="y_options"/>
+                                <property name="x_options">GTK_FILL</property>
+                                <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                           </object>
@@ -1359,8 +555,8 @@
                     <property name="right_attach">2</property>
                     <property name="top_attach">1</property>
                     <property name="bottom_attach">3</property>
-                    <property name="x_options"/>
-                    <property name="y_options"/>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
@@ -1371,14 +567,13 @@
                         <property name="visible">True</property>
                         <property name="can_focus">False</property>
                         <property name="receives_default">False</property>
-                        <property name="tooltip-text" translatable="yes">Play</property>
                         <property name="relief">none</property>
                         <property name="focus_on_click">False</property>
                         <accelerator key="space" signal="clicked"/>
                         <child>
                           <object class="GtkImage" id="image591">
                             <property name="visible">True</property>
-                            <property name="pixbuf">play.png</property>
+                            <property name="pixbuf">play.xpm</property>
                           </object>
                         </child>
                       </object>
@@ -1393,13 +588,12 @@
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
                         <property name="receives_default">False</property>
-                        <property name="tooltip-text" translatable="yes">Stop</property>
                         <property name="relief">none</property>
                         <property name="focus_on_click">False</property>
                         <child>
                           <object class="GtkImage" id="image5056">
                             <property name="visible">True</property>
-                            <property name="pixbuf">stop.png</property>
+                            <property name="pixbuf">stop.xpm</property>
                           </object>
                         </child>
                       </object>
@@ -1414,14 +608,13 @@
                         <property name="visible">True</property>
                         <property name="can_focus">False</property>
                         <property name="receives_default">False</property>
-                        <property name="tooltip-text" translatable="yes">Previous frame</property>
                         <property name="relief">none</property>
                         <property name="focus_on_click">False</property>
                         <accelerator key="KP_4" signal="clicked"/>
                         <child>
                           <object class="GtkImage" id="image593">
                             <property name="visible">True</property>
-                            <property name="pixbuf">previous-frame.png</property>
+                            <property name="pixbuf">backward.xpm</property>
                           </object>
                         </child>
                       </object>
@@ -1436,14 +629,13 @@
                         <property name="visible">True</property>
                         <property name="can_focus">False</property>
                         <property name="receives_default">False</property>
-                        <property name="tooltip-text" translatable="yes">Next frame</property>
                         <property name="relief">none</property>
                         <property name="focus_on_click">False</property>
                         <accelerator key="KP_6" signal="clicked"/>
                         <child>
                           <object class="GtkImage" id="image594">
                             <property name="visible">True</property>
-                            <property name="pixbuf">next-frame.png</property>
+                            <property name="pixbuf">forward.xpm</property>
                           </object>
                         </child>
                       </object>
@@ -1458,14 +650,13 @@
                         <property name="visible">True</property>
                         <property name="can_focus">False</property>
                         <property name="receives_default">False</property>
-                        <property name="tooltip-text" translatable="yes">Previous keyframe</property>
                         <property name="relief">none</property>
                         <property name="focus_on_click">False</property>
                         <accelerator key="KP_2" signal="clicked"/>
                         <child>
                           <object class="GtkImage" id="image595">
                             <property name="visible">True</property>
-                            <property name="pixbuf">previous-key-frame.png</property>
+                            <property name="pixbuf">Kbackward.xpm</property>
                           </object>
                         </child>
                       </object>
@@ -1480,14 +671,13 @@
                         <property name="visible">True</property>
                         <property name="can_focus">False</property>
                         <property name="receives_default">False</property>
-                        <property name="tooltip-text" translatable="yes">Next keyframe</property>
                         <property name="relief">none</property>
                         <property name="focus_on_click">False</property>
                         <accelerator key="KP_8" signal="clicked"/>
                         <child>
                           <object class="GtkImage" id="image596">
                             <property name="visible">True</property>
-                            <property name="pixbuf">next-key-frame.png</property>
+                            <property name="pixbuf">Kforward.xpm</property>
                           </object>
                         </child>
                       </object>
@@ -1502,13 +692,12 @@
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
                         <property name="receives_default">False</property>
-                        <property name="tooltip-text" translatable="yes">Selection: start</property>
                         <property name="relief">none</property>
                         <property name="focus_on_click">False</property>
                         <child>
                           <object class="GtkImage" id="image2306">
                             <property name="visible">True</property>
-                            <property name="pixbuf">markA.png</property>
+                            <property name="pixbuf">markA.xpm</property>
                           </object>
                         </child>
                       </object>
@@ -1523,13 +712,12 @@
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
                         <property name="receives_default">False</property>
-                        <property name="tooltip-text" translatable="yes">Selection: end</property>
                         <property name="relief">none</property>
                         <property name="focus_on_click">False</property>
                         <child>
                           <object class="GtkImage" id="image2307">
                             <property name="visible">True</property>
-                            <property name="pixbuf">markB.png</property>
+                            <property name="pixbuf">markB.xpm</property>
                           </object>
                         </child>
                       </object>
@@ -1544,13 +732,12 @@
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
                         <property name="receives_default">False</property>
-                        <property name="tooltip-text" translatable="yes">Previous black frame</property>
                         <property name="relief">none</property>
                         <property name="focus_on_click">False</property>
                         <child>
                           <object class="GtkImage" id="image2308">
                             <property name="visible">True</property>
-                            <property name="pixbuf">previous-black-frame.png</property>
+                            <property name="pixbuf">xpm_prevblack.xpm</property>
                           </object>
                         </child>
                       </object>
@@ -1565,13 +752,12 @@
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
                         <property name="receives_default">False</property>
-                        <property name="tooltip-text" translatable="yes">Next black frame</property>
                         <property name="relief">none</property>
                         <property name="focus_on_click">False</property>
                         <child>
                           <object class="GtkImage" id="image2309">
                             <property name="visible">True</property>
-                            <property name="pixbuf">next-black-frame.png</property>
+                            <property name="pixbuf">xpm_nextblack.xpm</property>
                           </object>
                         </child>
                       </object>
@@ -1586,13 +772,12 @@
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
                         <property name="receives_default">False</property>
-                        <property name="tooltip-text" translatable="yes">First frame</property>
                         <property name="relief">none</property>
                         <property name="focus_on_click">False</property>
                         <child>
                           <object class="GtkImage" id="image5057">
                             <property name="visible">True</property>
-                            <property name="pixbuf">first-frame.png</property>
+                            <property name="pixbuf">begin.xpm</property>
                           </object>
                         </child>
                       </object>
@@ -1607,13 +792,12 @@
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
                         <property name="receives_default">False</property>
-                        <property name="tooltip-text" translatable="yes">Last frame</property>
                         <property name="relief">none</property>
                         <property name="focus_on_click">False</property>
                         <child>
                           <object class="GtkImage" id="image2245">
                             <property name="visible">True</property>
-                            <property name="pixbuf">last-frame.png</property>
+                            <property name="pixbuf">end.xpm</property>
                           </object>
                         </child>
                       </object>
@@ -1632,7 +816,6 @@
                 <child>
                   <object class="GtkHScale" id="sliderNavigate">
                     <property name="visible">True</property>
-                    <property name="adjustment">adjustment3</property>
                     <property name="value_pos">left</property>
                   </object>
                 </child>
@@ -1655,7 +838,6 @@
                       <object class="GtkEntry" id="boxCurFrame">
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
-                        <property name="tooltip-text" translatable="yes">Current frame</property>
                         <property name="max_length">8</property>
                         <property name="width_chars">8</property>
                         <property name="text" translatable="yes">0</property>
@@ -1695,7 +877,6 @@
                       <object class="GtkEntry" id="boxCurTime">
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
-                        <property name="tooltip-text" translatable="yes">Current time</property>
                         <property name="width_chars">13</property>
                         <property name="text" translatable="yes">00:00:00.000</property>
                       </object>
@@ -1736,9 +917,12 @@
                   <packing>
                     <property name="top_attach">2</property>
                     <property name="bottom_attach">3</property>
-                    <property name="y_options"/>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
+                <child>
+                  <placeholder/>
+                </child>
               </object>
               <packing>
                 <property name="expand">False</property>

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h	2010-09-06 10:23:30 UTC (rev 6596)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h	2010-09-06 10:23:31 UTC (rev 6597)
@@ -7,28 +7,8 @@
 #include "ADM_qslider.h"
 #include "ui_gui2.h"
 #include "gui_action.hxx"
+
 /**
-    \enum MenuType
-*/
-enum MenuType
-{
-    MENU_ACTION,
-    MENU_SEPARATOR,
-    MENU_SUBACTION,
-    MENU_SUBMENU
-};
-/**
-    \struct MenuEntry
-*/
-typedef struct
-{
-    MenuType   type;
-    const char *text;
-    QAction    *action;
-    Action     event;
-    const char *icon; 
-}MenuEntry;
-/**
     \class MainWindow
 */
 class MainWindow : public QMainWindow

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h	2010-09-06 10:23:30 UTC (rev 6596)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/myOwnMenu.h	2010-09-06 10:23:31 UTC (rev 6597)
@@ -1,82 +0,0 @@
-
-MenuEntry myMenuFile[]= {
-            {MENU_ACTION,"Open",    NULL,ACT_OPEN_VIDEO,       MKICON(fileopen)},
-            {MENU_ACTION,"Append",  NULL,ACT_APPEND_VIDEO     ,NULL},
-            {MENU_ACTION,"Save",    NULL,ACT_SAVE_VIDEO       ,MKICON(filesaveas)},
-            {MENU_ACTION,"Close",   NULL,ACT_CLOSE          ,NULL},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_SUBMENU,"Js Project",NULL,ACT_DUMMY       ,NULL},
-
-            {MENU_SUBACTION,"Run jsProject",       NULL,ACT_RUN_JS_PROJECT         ,NULL},
-            {MENU_SUBACTION,"Save as jsProject",   NULL,ACT_SAVE_JS_PROJECT         ,NULL},
-
-            {MENU_SUBMENU,"tinyPy Project",NULL,ACT_DUMMY       ,NULL},
-            {MENU_SUBACTION,"Run pyProject",       NULL,ACT_RUN_PY_PROJECT         ,NULL},
-            {MENU_SUBACTION,"Save as pyProject",   NULL,ACT_SAVE_PY_PROJECT         ,NULL},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_ACTION,"Information",NULL,ACT_VIDEO_PROPERTIES,MKICON(info)},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_ACTION,"Connect to avsproxy",NULL,ACT_AVS_PROXY,NULL},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_ACTION,"Quit",    NULL,ACT_EXIT           ,NULL}
-        };
-
-MenuEntry myMenuEdit[]= {
-            {MENU_ACTION,"Reset Edit",  NULL,ACT_ResetSegments,NULL},
-            {MENU_ACTION,"Cut",         NULL,ACT_Cut        ,NULL},
-            {MENU_ACTION,"Copy",        NULL,ACT_Copy       ,NULL},
-            {MENU_ACTION,"Paste",       NULL,ACT_Paste      ,NULL},
-            {MENU_ACTION,"Delete",      NULL,ACT_Delete     ,NULL},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_ACTION,"Set Marker A",NULL,ACT_MarkA      ,NULL},
-            {MENU_ACTION,"Set Marker B",NULL,ACT_MarkB      ,NULL},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_ACTION,"Preferences", NULL,ACT_PREFERENCES,NULL},
-        };
-
-MenuEntry myMenuVideo[]= {
-            {MENU_ACTION,"Decoder Option",  NULL,ACT_DecoderOption      ,NULL},
-            {MENU_ACTION,"PostProcessing",  NULL,ACT_SetPostProcessing  ,NULL},
-            {MENU_ACTION,"Filters ",        NULL,ACT_VIDEO_FILTERS      ,NULL},
-        };
-
-MenuEntry myMenuAudio[]= {
-            {MENU_ACTION,"Select Track",    NULL,ACT_AUDIO_SELECT_TRACK ,NULL},
-            {MENU_ACTION,"Save audio",      NULL,ACT_SAVE_AUDIO         ,NULL},
-            {MENU_ACTION,"Filters ",        NULL,ACT_AUDIO_FILTERS      ,NULL},
-        };
-
-MenuEntry myMenuHelp[]= {
-            {MENU_ACTION,"Build Option",    NULL,ACT_BUILT_IN           ,NULL},
-            {MENU_ACTION,"Plugins",         NULL,ACT_PLUGIN_INFO        ,NULL},
-            {MENU_ACTION,"About ",          NULL,ACT_ABOUT              ,NULL},
-        };
-
-MenuEntry myMenuTool[]= {
-            {MENU_ACTION,"JavaScript Shell",NULL,ACT_JS_SHELL           ,NULL},
-            {MENU_ACTION,"TinyPy Shell",    NULL,ACT_PY_SHELL           ,NULL},
-        };
-
-MenuEntry myMenuGo[]= {
-            {MENU_ACTION,"Play/Stop",           NULL,ACT_JS_SHELL,       MKICON(player_play)},
-            {MENU_ACTION,"Previous Frame",      NULL,ACT_PY_SHELL       ,MKICON(previous)},
-            {MENU_ACTION,"Next Frame",          NULL,ACT_PY_SHELL       ,MKICON(next)},
-            {MENU_ACTION,"Previous Intra Frame",NULL,ACT_PY_SHELL       ,MKICON(player_rew)},
-            {MENU_ACTION,"Next Intra Frame",    NULL,ACT_PY_SHELL       ,MKICON(player_fwd)},
-            {MENU_ACTION,"Previous Black Frame",NULL,ACT_PY_SHELL       ,MKICON(prev_black)},
-            {MENU_ACTION,"Next Black Frame",    NULL,ACT_PY_SHELL       ,MKICON(next_black)},
-            {MENU_ACTION,"First Frame",          NULL,ACT_PY_SHELL      ,MKICON(player_start)},
-            {MENU_ACTION,"Last Frame",          NULL,ACT_PY_SHELL       ,MKICON(player_end)},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY,NULL},
-            {MENU_ACTION,"Go To Marker A",      NULL,ACT_PY_SHELL       ,MKICON(markA)},
-            {MENU_ACTION,"Go To Marker B",      NULL,ACT_PY_SHELL       ,MKICON(markB)},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY,NULL},
-            {MENU_ACTION,"Go To Time",          NULL,ACT_PY_SHELL       ,NULL},
-        };
-
-MenuEntry myMenuView[]= {
-            {MENU_ACTION,"Zoom 1:4",      NULL,ACT_ZOOM_1_4 ,NULL},
-            {MENU_ACTION,"Zoom 1:2",      NULL,ACT_ZOOM_1_2 ,NULL},
-            {MENU_ACTION,"Zoom 1:1",      NULL,ACT_ZOOM_1_1 ,NULL},
-            {MENU_ACTION,"Zoom 2:1",      NULL,ACT_ZOOM_2_1 ,NULL},
-        };



From mean at mail.berlios.de  Mon Sep  6 12:23:33 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:33 +0200
Subject: [Avidemux-svn-commit] r6598 - in
	branches/avidemux_2.6_branch_mean/avidemux:
	common/ADM_commonUI qt4/ADM_userInterfaces/ADM_gui
Message-ID: <20100906102333.4EB7B481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:33 +0200 (Mon, 06 Sep 2010)
New Revision: 6598

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h
Log:
[Gtk/qt4] Use the same menus

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h	2010-09-06 10:23:31 UTC (rev 6597)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h	2010-09-06 10:23:33 UTC (rev 6598)
@@ -25,6 +25,7 @@
     Action     event;
     const char *icon; 
 }MenuEntry;
+#ifdef MENU_DECLARE
 MenuEntry myMenuFile[]= {
             {MENU_ACTION,"Open",    NULL,ACT_OPEN_VIDEO,       MKICON(fileopen)},
             {MENU_ACTION,"Append",  NULL,ACT_APPEND_VIDEO     ,NULL},
@@ -107,3 +108,4 @@
             {MENU_ACTION,"Zoom 2:1",      NULL,ACT_ZOOM_2_1 ,NULL},
         };
 #endif
+#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-06 10:23:31 UTC (rev 6597)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-06 10:23:33 UTC (rev 6598)
@@ -18,6 +18,7 @@
 #include <QtGui/QKeyEvent>
 #include <QtGui/QGraphicsView>
 
+#define MENU_DECLARE
 #include "Q_gui2.h"
 #include "ADM_default.h"
 
@@ -78,8 +79,6 @@
 
 #include "translation_table.h"   
 
-#define MKICON(x) ":/new/prefix1/pics/"#x".png"
-#include "myOwnMenu.h"
 /*
     Declare the table converting widget name to our internal signal           
 */
@@ -377,7 +376,7 @@
                             a=insert->addAction(icon,m->text);
                         }else
                             a=insert->addAction(m->text);
-                        m->action=a;
+                        m->cookie=(void *)a;
                         break;
                 }
             default:
@@ -434,7 +433,7 @@
     for(int i=0;i<nb;i++)
     {
         MenuEntry *m=menu+i;
-        if(m->action==action)
+        if(m->cookie==(void*)action)
         {
             HandleAction (m->event);
         }

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h	2010-09-06 10:23:31 UTC (rev 6597)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h	2010-09-06 10:23:33 UTC (rev 6598)
@@ -6,8 +6,10 @@
 
 #include "ADM_qslider.h"
 #include "ui_gui2.h"
-#include "gui_action.hxx"
+#include "gui_action.hxx"
 
+#define MKICON(x) ":/new/prefix1/pics/"#x".png"
+#include "myOwnMenu.h"
 /**
     \class MainWindow
 */



From mean at mail.berlios.de  Mon Sep  6 12:23:34 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:34 +0200
Subject: [Avidemux-svn-commit] r6599 - in
	branches/avidemux_2.6_branch_mean/avidemux: common
	common/ADM_commonUI qt4/ADM_userInterfaces/ADM_gui
Message-ID: <20100906102334.9D63A481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:34 +0200 (Mon, 06 Sep 2010)
New Revision: 6599

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h
   branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_navigate.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
Log:
[UI] remap *go* actions to the matching events

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h	2010-09-06 10:23:33 UTC (rev 6598)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h	2010-09-06 10:23:34 UTC (rev 6599)
@@ -24,88 +24,89 @@
     void       *cookie;
     Action     event;
     const char *icon; 
+    const char *shortCut;
 }MenuEntry;
 #ifdef MENU_DECLARE
 MenuEntry myMenuFile[]= {
-            {MENU_ACTION,"Open",    NULL,ACT_OPEN_VIDEO,       MKICON(fileopen)},
-            {MENU_ACTION,"Append",  NULL,ACT_APPEND_VIDEO     ,NULL},
-            {MENU_ACTION,"Save",    NULL,ACT_SAVE_VIDEO       ,MKICON(filesaveas)},
-            {MENU_ACTION,"Close",   NULL,ACT_CLOSE          ,NULL},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_SUBMENU,"Js Project",NULL,ACT_DUMMY       ,NULL},
+            {MENU_ACTION,"Open",    NULL,ACT_OPEN_VIDEO,       MKICON(fileopen), "Ctrl+O"},
+            {MENU_ACTION,"Append",  NULL,ACT_APPEND_VIDEO     ,NULL,             "Ctrl+A"},
+            {MENU_ACTION,"Save",    NULL,ACT_SAVE_VIDEO       ,MKICON(filesaveas),"Ctrl+S"},
+            {MENU_ACTION,"Close",   NULL,ACT_CLOSE          ,NULL,                "Ctrl+W"},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL,NULL},
+            {MENU_SUBMENU,"Js Project",NULL,ACT_DUMMY       ,NULL,NULL},
 
-            {MENU_SUBACTION,"Run jsProject",       NULL,ACT_RUN_JS_PROJECT         ,NULL},
-            {MENU_SUBACTION,"Save as jsProject",   NULL,ACT_SAVE_JS_PROJECT         ,NULL},
+            {MENU_SUBACTION,"Run jsProject",       NULL,ACT_RUN_JS_PROJECT       ,NULL,NULL},
+            {MENU_SUBACTION,"Save as jsProject",   NULL,ACT_SAVE_JS_PROJECT      ,NULL,NULL},
 
             {MENU_SUBMENU,"tinyPy Project",NULL,ACT_DUMMY       ,NULL},
-            {MENU_SUBACTION,"Run pyProject",       NULL,ACT_RUN_PY_PROJECT         ,NULL},
-            {MENU_SUBACTION,"Save as pyProject",   NULL,ACT_SAVE_PY_PROJECT         ,NULL},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_ACTION,"Information",NULL,ACT_VIDEO_PROPERTIES,MKICON(info)},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
+            {MENU_SUBACTION,"Run pyProject",       NULL,ACT_RUN_PY_PROJECT       ,NULL,NULL},
+            {MENU_SUBACTION,"Save as pyProject",   NULL,ACT_SAVE_PY_PROJECT      ,NULL,NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL,NULL},
+            {MENU_ACTION,"Information",NULL,ACT_VIDEO_PROPERTIES,                 MKICON(info),NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL,NULL},
             {MENU_ACTION,"Connect to avsproxy",NULL,ACT_AVS_PROXY,NULL},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_ACTION,"Quit",    NULL,ACT_EXIT           ,NULL}
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL,NULL},
+            {MENU_ACTION,"Quit",    NULL,ACT_EXIT           ,NULL,"Ctrl+Q"}
         };
 
 MenuEntry myMenuEdit[]= {
-            {MENU_ACTION,"Reset Edit",  NULL,ACT_ResetSegments,NULL},
-            {MENU_ACTION,"Cut",         NULL,ACT_Cut        ,NULL},
-            {MENU_ACTION,"Copy",        NULL,ACT_Copy       ,NULL},
-            {MENU_ACTION,"Paste",       NULL,ACT_Paste      ,NULL},
-            {MENU_ACTION,"Delete",      NULL,ACT_Delete     ,NULL},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_ACTION,"Set Marker A",NULL,ACT_MarkA      ,NULL},
-            {MENU_ACTION,"Set Marker B",NULL,ACT_MarkB      ,NULL},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL},
-            {MENU_ACTION,"Preferences", NULL,ACT_PREFERENCES,NULL},
+            {MENU_ACTION,"Reset Edit",  NULL,ACT_ResetSegments,NULL,NULL},
+            {MENU_ACTION,"Cut",         NULL,ACT_Cut        ,NULL,"Ctrl+X"},
+            {MENU_ACTION,"Copy",        NULL,ACT_Copy       ,NULL,"Ctrl+C"},
+            {MENU_ACTION,"Paste",       NULL,ACT_Paste      ,NULL,"Ctrl+V"},
+            {MENU_ACTION,"Delete",      NULL,ACT_Delete     ,NULL,"Delete"},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL,NULL},
+            {MENU_ACTION,"Set Marker A",NULL,ACT_MarkA      ,NULL,NULL},
+            {MENU_ACTION,"Set Marker B",NULL,ACT_MarkB      ,NULL,NULL},
+            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL,NULL},
+            {MENU_ACTION,"Preferences", NULL,ACT_PREFERENCES,NULL,NULL},
         };
 
 MenuEntry myMenuVideo[]= {
-            {MENU_ACTION,"Decoder Option",  NULL,ACT_DecoderOption      ,NULL},
-            {MENU_ACTION,"PostProcessing",  NULL,ACT_SetPostProcessing  ,NULL},
-            {MENU_ACTION,"Filters ",        NULL,ACT_VIDEO_FILTERS      ,NULL},
+            {MENU_ACTION,"Decoder Option",  NULL,ACT_DecoderOption      ,NULL,NULL},
+            {MENU_ACTION,"PostProcessing",  NULL,ACT_SetPostProcessing  ,NULL,NULL},
+            {MENU_ACTION,"Filters ",        NULL,ACT_VIDEO_FILTERS      ,NULL,"Ctrl+Alt+F"},
         };
 
 MenuEntry myMenuAudio[]= {
-            {MENU_ACTION,"Select Track",    NULL,ACT_AUDIO_SELECT_TRACK ,NULL},
-            {MENU_ACTION,"Save audio",      NULL,ACT_SAVE_AUDIO         ,NULL},
-            {MENU_ACTION,"Filters ",        NULL,ACT_AUDIO_FILTERS      ,NULL},
+            {MENU_ACTION,"Select Track",    NULL,ACT_AUDIO_SELECT_TRACK ,NULL,NULL},
+            {MENU_ACTION,"Save audio",      NULL,ACT_SAVE_AUDIO         ,NULL,NULL},
+            {MENU_ACTION,"Filters ",        NULL,ACT_AUDIO_FILTERS      ,NULL,NULL},
         };
 
 MenuEntry myMenuHelp[]= {
-            {MENU_ACTION,"Build Option",    NULL,ACT_BUILT_IN           ,NULL},
-            {MENU_ACTION,"Plugins",         NULL,ACT_PLUGIN_INFO        ,NULL},
-            {MENU_ACTION,"About ",          NULL,ACT_ABOUT              ,NULL},
+            {MENU_ACTION,"Build Option",    NULL,ACT_BUILT_IN           ,NULL,NULL},
+            {MENU_ACTION,"Plugins",         NULL,ACT_PLUGIN_INFO        ,NULL,NULL},
+            {MENU_ACTION,"About ",          NULL,ACT_ABOUT              ,NULL,NULL},
         };
 
 MenuEntry myMenuTool[]= {
-            {MENU_ACTION,"JavaScript Shell",NULL,ACT_JS_SHELL           ,NULL},
-            {MENU_ACTION,"TinyPy Shell",    NULL,ACT_PY_SHELL           ,NULL},
+            {MENU_ACTION,"JavaScript Shell",NULL,ACT_JS_SHELL           ,NULL,NULL},
+            {MENU_ACTION,"TinyPy Shell",    NULL,ACT_PY_SHELL           ,NULL,NULL},
         };
 
 MenuEntry myMenuGo[]= {
-            {MENU_ACTION,"Play/Stop",           NULL,ACT_JS_SHELL,       MKICON(player_play)},
-            {MENU_ACTION,"Previous Frame",      NULL,ACT_PY_SHELL       ,MKICON(previous)},
-            {MENU_ACTION,"Next Frame",          NULL,ACT_PY_SHELL       ,MKICON(next)},
-            {MENU_ACTION,"Previous Intra Frame",NULL,ACT_PY_SHELL       ,MKICON(player_rew)},
-            {MENU_ACTION,"Next Intra Frame",    NULL,ACT_PY_SHELL       ,MKICON(player_fwd)},
-            {MENU_ACTION,"Previous Black Frame",NULL,ACT_PY_SHELL       ,MKICON(prev_black)},
-            {MENU_ACTION,"Next Black Frame",    NULL,ACT_PY_SHELL       ,MKICON(next_black)},
-            {MENU_ACTION,"First Frame",          NULL,ACT_PY_SHELL      ,MKICON(player_start)},
-            {MENU_ACTION,"Last Frame",          NULL,ACT_PY_SHELL       ,MKICON(player_end)},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY,NULL},
-            {MENU_ACTION,"Go To Marker A",      NULL,ACT_PY_SHELL       ,MKICON(markA)},
-            {MENU_ACTION,"Go To Marker B",      NULL,ACT_PY_SHELL       ,MKICON(markB)},
-            {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY,NULL},
-            {MENU_ACTION,"Go To Time",          NULL,ACT_PY_SHELL       ,NULL},
+            {MENU_ACTION,"Play/Stop",           NULL,ACT_PlayAvi        ,MKICON(player_play),   "Space"},
+            {MENU_ACTION,"Previous Frame",      NULL,ACT_PreviousFrame  ,MKICON(previous),      NULL},
+            {MENU_ACTION,"Next Frame",          NULL,ACT_NextFrame      ,MKICON(next),          NULL},
+            {MENU_ACTION,"Previous Intra Frame",NULL,ACT_PreviousKFrame ,MKICON(player_rew),    NULL},
+            {MENU_ACTION,"Next Intra Frame",    NULL,ACT_NextKFrame     ,MKICON(player_fwd),    NULL},
+            {MENU_ACTION,"Previous Black Frame",NULL,ACT_PrevBlackFrame ,MKICON(prev_black),    NULL},
+            {MENU_ACTION,"Next Black Frame",    NULL,ACT_NextBlackFrame ,MKICON(next_black),    NULL},
+            {MENU_ACTION,"First Frame",         NULL,ACT_Begin          ,MKICON(player_start),  NULL},
+            {MENU_ACTION,"Last Frame",          NULL,ACT_End            ,MKICON(player_end),    NULL},
+            {MENU_SEPARATOR,NULL,               NULL,ACT_DUMMY          ,NULL,NULL},
+            {MENU_ACTION,"Go To Marker A",      NULL,ACT_GotoMarkA      ,MKICON(markA)         ,NULL},
+            {MENU_ACTION,"Go To Marker B",      NULL,ACT_GotoMarkB      ,MKICON(markB)         ,NULL},
+            {MENU_SEPARATOR,NULL,               NULL,ACT_DUMMY          ,NULL,NULL},
+            {MENU_ACTION,"Go To Time",          NULL,ACT_GotoTime       ,NULL,NULL},
         };
 
 MenuEntry myMenuView[]= {
-            {MENU_ACTION,"Zoom 1:4",      NULL,ACT_ZOOM_1_4 ,NULL},
-            {MENU_ACTION,"Zoom 1:2",      NULL,ACT_ZOOM_1_2 ,NULL},
-            {MENU_ACTION,"Zoom 1:1",      NULL,ACT_ZOOM_1_1 ,NULL},
-            {MENU_ACTION,"Zoom 2:1",      NULL,ACT_ZOOM_2_1 ,NULL},
+            {MENU_ACTION,"Zoom 1:4",      NULL,ACT_ZOOM_1_4 ,NULL,"4"},
+            {MENU_ACTION,"Zoom 1:2",      NULL,ACT_ZOOM_1_2 ,NULL,"3"},
+            {MENU_ACTION,"Zoom 1:1",      NULL,ACT_ZOOM_1_1 ,NULL,"2"},
+            {MENU_ACTION,"Zoom 2:1",      NULL,ACT_ZOOM_2_1 ,NULL,"1"},
         };
 #endif
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-09-06 10:23:33 UTC (rev 6598)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-09-06 10:23:34 UTC (rev 6599)
@@ -107,6 +107,9 @@
 {
   uint32_t nf = 0;
   uint32_t old;
+
+  ADM_warning("************ %s **************\n",getActionName(action));
+
   // handle out of band actions
   // independant load not loaded
 //------------------------------------------------
@@ -128,7 +131,6 @@
   switch (action)
     {
         case ACT_TimeShift:
-        case ACT_JumpToTime:
         case ACT_Goto:
                                 brokenAct();
                                 return;

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names	2010-09-06 10:23:33 UTC (rev 6598)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names	2010-09-06 10:23:34 UTC (rev 6599)
@@ -46,7 +46,7 @@
 ACT(GotoMarkB)
 ACT(Scale)
 ACT(NAVIGATE_END)
-ACT(JumpToTime)
+//ACT(JumpToTime)
 
 // Info
 ACT(VIDEO_PROPERTIES)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_navigate.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_navigate.cpp	2010-09-06 10:23:33 UTC (rev 6598)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_navigate.cpp	2010-09-06 10:23:34 UTC (rev 6599)
@@ -153,7 +153,8 @@
              GUI_setCurrentFrameAndTime();
             //GUI_GoToKFrameTime(0);
             break;
-      case ACT_JumpToTime:
+#if 0
+      case ACT_GotoTime:
 	  {
 	      uint16_t hh, mm, ss, ms;
 
@@ -161,6 +162,7 @@
 		  A_jumpToTime(hh, mm, ss, ms);
 	  }
 	  break;
+#endif
       case ACT_GotoTime:
 	  {
            // Get current time

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-06 10:23:33 UTC (rev 6598)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-06 10:23:34 UTC (rev 6599)
@@ -192,7 +192,7 @@
 
 void MainWindow::currentTimeChanged(void)
 {
-	HandleAction(ACT_JumpToTime);
+	HandleAction(ACT_GotoTime);
 
 	this->setFocus(Qt::OtherFocusReason);
 }
@@ -220,14 +220,6 @@
 	groupPreviewModes->addAction(ui.actionPreviewOutput);
 	connect(groupPreviewModes, SIGNAL(triggered(QAction*)), this, SLOT(previewModeChanged(QAction*)));
 
-	// Zoom modes
-	QActionGroup *groupZoomModes = new QActionGroup(this);
-
-	groupZoomModes->addAction(ui.actionZoom_1_4);
-	groupZoomModes->addAction(ui.actionZoom_1_2);
-	groupZoomModes->addAction(ui.actionZoom_1_1);
-	groupZoomModes->addAction(ui.actionZoom_2_1);
-
 	/*
 	Connect our button to buttonPressed
 	*/
@@ -377,6 +369,11 @@
                         }else
                             a=insert->addAction(m->text);
                         m->cookie=(void *)a;
+                        if(m->shortCut)
+                        {
+                            QKeySequence s(m->shortCut);
+                            a->setShortcut(s);
+                        }
                         break;
                 }
             default:
@@ -538,13 +535,6 @@
 
 			break;
 		case QEvent::FocusOut:
-			if (watched == ui.currentTime)
-			{
-				uint16_t hh, mm, ss, ms;
-
-				if (!UI_readCurTime(hh, mm, ss, ms))
-					UI_updateTimeCount(currentFrame, currentFps);
-			}
             break;
         default:
             break;



From mean at mail.berlios.de  Mon Sep  6 12:23:35 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:35 +0200
Subject: [Avidemux-svn-commit] r6600 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI
Message-ID: <20100906102335.BFF1E481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:35 +0200 (Mon, 06 Sep 2010)
New Revision: 6600

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h
Log:
[ui] Add shortcuts

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h	2010-09-06 10:23:34 UTC (rev 6599)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h	2010-09-06 10:23:35 UTC (rev 6600)
@@ -87,19 +87,19 @@
 
 MenuEntry myMenuGo[]= {
             {MENU_ACTION,"Play/Stop",           NULL,ACT_PlayAvi        ,MKICON(player_play),   "Space"},
-            {MENU_ACTION,"Previous Frame",      NULL,ACT_PreviousFrame  ,MKICON(previous),      NULL},
-            {MENU_ACTION,"Next Frame",          NULL,ACT_NextFrame      ,MKICON(next),          NULL},
-            {MENU_ACTION,"Previous Intra Frame",NULL,ACT_PreviousKFrame ,MKICON(player_rew),    NULL},
-            {MENU_ACTION,"Next Intra Frame",    NULL,ACT_NextKFrame     ,MKICON(player_fwd),    NULL},
+            {MENU_ACTION,"Previous Frame",      NULL,ACT_PreviousFrame  ,MKICON(previous),      "Left"},
+            {MENU_ACTION,"Next Frame",          NULL,ACT_NextFrame      ,MKICON(next),          "Right"},
+            {MENU_ACTION,"Previous Intra Frame",NULL,ACT_PreviousKFrame ,MKICON(player_rew),    "Down"},
+            {MENU_ACTION,"Next Intra Frame",    NULL,ACT_NextKFrame     ,MKICON(player_fwd),    "Up"},
             {MENU_ACTION,"Previous Black Frame",NULL,ACT_PrevBlackFrame ,MKICON(prev_black),    NULL},
             {MENU_ACTION,"Next Black Frame",    NULL,ACT_NextBlackFrame ,MKICON(next_black),    NULL},
-            {MENU_ACTION,"First Frame",         NULL,ACT_Begin          ,MKICON(player_start),  NULL},
-            {MENU_ACTION,"Last Frame",          NULL,ACT_End            ,MKICON(player_end),    NULL},
+            {MENU_ACTION,"First Frame",         NULL,ACT_Begin          ,MKICON(player_start),  "Home"},
+            {MENU_ACTION,"Last Frame",          NULL,ACT_End            ,MKICON(player_end),    "End"},
             {MENU_SEPARATOR,NULL,               NULL,ACT_DUMMY          ,NULL,NULL},
-            {MENU_ACTION,"Go To Marker A",      NULL,ACT_GotoMarkA      ,MKICON(markA)         ,NULL},
-            {MENU_ACTION,"Go To Marker B",      NULL,ACT_GotoMarkB      ,MKICON(markB)         ,NULL},
+            {MENU_ACTION,"Go To Marker A",      NULL,ACT_GotoMarkA      ,MKICON(markA)         ,"PgUp"},
+            {MENU_ACTION,"Go To Marker B",      NULL,ACT_GotoMarkB      ,MKICON(markB)         ,"PgDown"},
             {MENU_SEPARATOR,NULL,               NULL,ACT_DUMMY          ,NULL,NULL},
-            {MENU_ACTION,"Go To Time",          NULL,ACT_GotoTime       ,NULL,NULL},
+            {MENU_ACTION,"Go To Time",          NULL,ACT_GotoTime       ,NULL,                 "Ctrl+T" },
         };
 
 MenuEntry myMenuView[]= {



From mean at mail.berlios.de  Mon Sep  6 12:23:37 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:37 +0200
Subject: [Avidemux-svn-commit] r6601 - in
	branches/avidemux_2.6_branch_mean/avidemux/gtk:
	ADM_UIs/include ADM_UIs/src ADM_userInterfaces/ADM_gui2
	ADM_userInterfaces/ADM_toolkit_gtk ADM_userInterfaces/glade/main
Message-ID: <20100906102337.51ED1481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:37 +0200 (Mon, 06 Sep 2010)
New Revision: 6601

Removed:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/ADM_icons.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/include/ADM_gladeSupport.h
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/toolkit.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/ADM_tray_gtk.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.gtkBuilder
Log:
[Gtk] Fix icon loading

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/include/ADM_gladeSupport.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/include/ADM_gladeSupport.h	2010-09-06 10:23:35 UTC (rev 6600)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/include/ADM_gladeSupport.h	2010-09-06 10:23:37 UTC (rev 6601)
@@ -27,13 +27,6 @@
  * Private Functions.
  */
 
-/* This is used to create the pixmaps used in the interface. */
-GtkWidget*  create_pixmap              (GtkWidget       *widget,
-                                        const gchar     *filename);
-
-/* This is used to create the pixbufs used in the interface. */
-GdkPixbuf*  create_pixbuf              (const gchar     *filename);
-
 /* This is used to set ATK action descriptions. */
 void        glade_set_atk_action_description (AtkAction       *action,
                                               const gchar     *action_name,

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/toolkit.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/toolkit.cpp	2010-09-06 10:23:35 UTC (rev 6600)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/toolkit.cpp	2010-09-06 10:23:37 UTC (rev 6601)
@@ -52,41 +52,11 @@
 GtkWidget *GUI_PixmapButtonDefault(GdkWindow * window, const gchar ** xpm,
                                   const gchar * tooltip)
 {
-    return GUI_PixmapButton(window, xpm, tooltip, 2);
+    //return GUI_PixmapButton(window, xpm, tooltip, 2);
+#warning broken
+        return NULL;
 }
 
-//____________________________________________
-//  Used to pack an icon onto a button
-//  Adapted from GTK API tutorial
-//____________________________________________
-GtkWidget *GUI_PixmapButton(GdkWindow * window, const gchar ** xpmd,
-                            const gchar * tooltip, gint border)
-{
-
-    //
-    GtkWidget *button;
-    GtkWidget *pixmap;
-    GdkPixmap *xpm;
-    GdkBitmap *mask;
-
-    xpm = gdk_pixmap_create_from_xpm_d(window, &mask, NULL, (gchar **)xpmd);
-    pixmap = gtk_pixmap_new(xpm, mask);
-    button = gtk_button_new();
-
-    gtk_container_set_border_width(GTK_CONTAINER(button), border);
-    gtk_container_add(GTK_CONTAINER(button), pixmap);
-
-    if (tooltips == NULL)
-        tooltips = gtk_tooltips_new();
-    if (tooltip != NULL)
-        gtk_tooltips_set_tip(tooltips, button, tooltip, NULL);
-
-    gtk_widget_show_all(button);
-
-    return button;
-}
-
-
 void MenuAppend(GtkMenu * menu, const char *text)
 {
     GtkWidget *glade_menuitem;

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-06 10:23:35 UTC (rev 6600)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-06 10:23:37 UTC (rev 6601)
@@ -42,6 +42,7 @@
 #include "A_functions.h"
 
 #define MKICON(x) NULL
+#define MENU_DECLARE
 #include "myOwnMenu.h"
 static void ui_setMenus(void);
 extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h);
@@ -60,8 +61,6 @@
 static GtkWidget *guiDrawingArea=NULL;
 static GtkWidget *guiSlider=NULL;
 
-static GtkWidget *guiCurFrame=NULL;
-static GtkWidget *guiTotalFrame=NULL;
 static GtkWidget *guiCurTime=NULL;
 static GtkWidget *guiTotalTime=NULL;
 
@@ -408,9 +407,6 @@
 
 	sliderAdjustment=gtk_range_get_adjustment (GTK_RANGE(guiSlider));
 
-	ADM_LOOKUP(guiCurFrame,boxCurFrame);
-	ADM_LOOKUP(guiTotalFrame,labelTotalFrame);
-
 	ADM_LOOKUP(guiCurTime,boxCurTime);
 	ADM_LOOKUP(guiTotalTime,labelTotalTime);
 
@@ -438,8 +434,6 @@
 	gtk_signal_connect(GTK_OBJECT(guiSlider), "button_release_event", GTK_SIGNAL_FUNC(UI_SliderReleased), NULL);
 
 	// Current Frame
-	gtk_signal_connect(GTK_OBJECT(guiCurFrame), "focus_in_event", GTK_SIGNAL_FUNC(UI_grabFocus), (void *) NULL);
-	gtk_signal_connect(GTK_OBJECT(guiCurFrame), "focus_out_event", GTK_SIGNAL_FUNC(UI_loseFocus), (void *) NULL);
 //	gtk_signal_connect(GTK_OBJECT(guiCurFrame), "activate", GTK_SIGNAL_FUNC(UI_focusAfterActivate), (void *) ACT_JumpToFrame);
 
     // Volume
@@ -475,7 +469,7 @@
 			GTK_WIDGET_UNSET_FLAGS (bt, GTK_CAN_FOCUS);
 		}
 #endif
-	GTK_WIDGET_SET_FLAGS (glade.getWidget("boxCurFrame"), GTK_CAN_FOCUS);
+	
 
 // set some tuning
     gtk_widget_set_usize(guiDrawingArea, 512, 288);
@@ -777,7 +771,7 @@
     // frames
     //sprintf(text, "%"LU" ", curFrame);
 //    gtk_label_set_text((GtkLabel *) guiCurFrame, text);
-	gtk_write_entry(guiCurFrame,curFrame);
+//	gtk_write_entry(guiCurFrame,curFrame);
 
 }
 /**
@@ -812,17 +806,6 @@
 
 }
 
-void UI_updateTimeCount(uint32_t curFrame,uint32_t fps)
-{
-  char text[80];
- uint32_t mm,hh,ss,ms;
-
- 	frame2time(curFrame,fps, &hh, &mm, &ss, &ms);
-  	sprintf(text, "%02d:%02d:%02d.%03d", hh, mm, ss, ms);
-//     gtk_label_set_text((GtkLabel *) guiCurTime, text);
-	gtk_write_entry_string(guiCurTime,text);
-
-}
 ///
 /// Called upon destroy event
 /// just cleanly exit the application
@@ -1105,19 +1088,6 @@
 
 }
 /**
-    \fn UI_readCurFrame
-*/
-
-int UI_readCurFrame( void )
-{
-	int i = gtk_read_entry(guiCurFrame);
-
-	if(i < 0)
-		i = 0;
-
-	return i;
-}
-/**
     \fn UI_readCurTime
 */
 int UI_readCurTime(uint16_t &hh, uint16_t &mm, uint16_t &ss, uint16_t &ms)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/ADM_icons.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/ADM_icons.cpp	2010-09-06 10:23:35 UTC (rev 6600)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/ADM_icons.cpp	2010-09-06 10:23:37 UTC (rev 6601)
@@ -1,284 +0,0 @@
-/*
- * DO NOT EDIT THIS FILE - it is generated by Glade.
- */
-#include <string.h>
-#include <stdio.h>
-
-#include <gtk/gtk.h>
-
-#include "ADM_gladeSupport.h"
-#include "ADM_toolkitGtk.h"
-#include "ADM_default.h"
-
-GtkWidget	*create_pixmap                          (GtkWidget       *widget,
-                         					               const gchar     *filename)
-
-{
-    return NULL;
-}
-GdkPixbuf	*create_pixbuf                  (const gchar     *filename)
-{
-    return NULL;
-}
-#if 0
-
-#include <string.h>
-#include <stdio.h>
-
-#include <gtk/gtk.h>
-
-#include "ADM_gladeSupport.h"
-#include "ADM_toolkitGtk.h"
-#include "ADM_default.h"
-
-#include "ADM_assert.h"
-#include "xpm/play.xpm"
-#include "xpm/stop.xpm"
-#include "xpm/forward.xpm"
-#include "xpm/Kforward.xpm"
-#include "xpm/backward.xpm"
-#include "xpm/Kbackward.xpm"
-#include "xpm/avidemux_icon.xpm"
-#include "xpm/begin.xpm"
-#include "xpm/end.xpm"
-#include "xpm/markA.xpm"
-#include "xpm/markB.xpm"
-#include "xpm/about.xpm"
-#include "xpm/xpm_prevblack.xpm"
-#include "xpm/xpm_nextblack.xpm"
-#include "xpm/gnome-calculator.xpm"
-#include "xpm/gnome-calculator_small.xpm"
-#include "xpm/systray.xpm"
-#include "xpm/avidemux_icon_small.inc"
-#include "xpm/gnome_calc_small.inc"
-#include "xpm/gnome_calculator.inc"
-#include "xpm/1.inc"
-#include "xpm/2.inc"
-#include "xpm/4.inc"
-#include "xpm/3.inc"
-#include "xpm/6.inc"
-#include "xpm/5.inc"
-#include "xpm/7.inc"
-#include "xpm/systray.inc"
-#include "xpm/systray2.inc"
-#include "xpm/preview.inc"
-#include "xpm/output.inc"
-
-#include "xpm/film1.inc"
-#include "xpm/film3.inc"
-#include "xpm/film5.inc"
-#include "xpm/film7.inc"
-#include "xpm/film9.inc"
-#include "xpm/film11.inc"
-#include "xpm/film13.inc"
-#include "xpm/film15.inc"
-#include "xpm/film17.inc"
-#include "xpm/film19.inc"
-#include "xpm/film21.inc"
-#include "xpm/film23.inc"
-#include "xpm/audio-volume-medium.inc"
-#include "xpm/preview-button.inc"
-
-typedef enum 
-{
-        A_ICON_XPM,
-        A_ICON_PNG
-}ADM_Icon;
-
-typedef struct name2xpm
-{
-        const ADM_Icon icon;
-	const char *name;
-	const void *data;
-        
-}name2xpm;
-
-//static const char *xpm_Kbackward[] = {
-
-name2xpm iconTranslation[]=
-{
-	{A_ICON_XPM,"Kbackward.xpm",	(void *)	xpm_Kbackward},	
-	{A_ICON_XPM,"Kbackward.xpm",	(void *)	xpm_Kbackward},	
-	{A_ICON_XPM,"Kforward.xpm",	(void *)	xpm_Kforward},
-	{A_ICON_XPM,"backward.xpm",	(void *)	xpm_backward},	
-	{A_ICON_XPM,"forward.xpm",	(void *)	xpm_forward},
-	{A_ICON_XPM,"about.xpm",	(void *)	xpm_about},
-	{A_ICON_XPM,"begin.xpm",	(void *)	xpm_begin},
-	{A_ICON_XPM,"end.xpm",		(void *)	xpm_end},
-	{A_ICON_XPM,"play.xpm",		(void *)	xpm_play},
-	{A_ICON_XPM,"stop.xpm",		(void *)	xpm_stop},
-	{A_ICON_XPM,"markA.xpm",	(void *)	xpm_markA},
-	{A_ICON_XPM,"markB.xpm",	(void *)	xpm_markB},
-	{A_ICON_XPM,"xpm_nextblack.xpm",(void *)        xpm_nextblack},
-	{A_ICON_XPM,"xpm_prevblack.xpm",(void *)        xpm_prevblack},
-        {A_ICON_XPM,"avidemux_icon.xpm",(void *)        avidemux_icon_xpm},
-        {A_ICON_XPM,"xpm_prevblack.xpm",(void *)        xpm_prevblack},
-        {A_ICON_PNG,"gnome-calculator.png",(void *)     gnome_calculator},
-        {A_ICON_PNG,"gnome-calculator_small.xpm",(void *) gnome_calculator_small},
-        {A_ICON_PNG,"preview.png",(void *) preview},
-        {A_ICON_PNG,"output.png",(void *) output},
-        {A_ICON_PNG,"1.png",(void *) x1},
-        {A_ICON_PNG,"2.png",(void *) x2},
-        {A_ICON_PNG,"3.png",(void *) x3},
-        {A_ICON_PNG,"4.png",(void *) x4},
-        {A_ICON_PNG,"5.png",(void *) x5},
-        {A_ICON_PNG,"6.png",(void *) x6},
-        {A_ICON_PNG,"7.png",(void *) x7},
-        {A_ICON_PNG,"avidemux_icon_small.png",         (void *) avidemux_icon_small},
-        {A_ICON_PNG,"systray.png",                 (void *)systray},
-        {A_ICON_PNG,"audio-volume-medium.png",                 (void *)audio_volume_medium},
-        {A_ICON_PNG,"preview-button.png",                 (void *)preview_button},
-	// Jakub nice animation
-#define MKFILM(x) 	{A_ICON_PNG,"film"#x".png",                 (void *)film##x},
-	MKFILM(1)
-	MKFILM(3)
-	MKFILM(5)
-	MKFILM(7)
-	MKFILM(9)
-	MKFILM(11)
-	MKFILM(13)
-	MKFILM(15)
-	MKFILM(17)
-	MKFILM(19)
-	MKFILM(21)
-	MKFILM(23)
-	// DUMMY
-	{A_ICON_PNG,"systray.xpm",                 (void *)systray}
-};
-GdkPixbuf	*create_pixbuf                  (const gchar     *filename)
-{
- 	int nbIcon=sizeof(iconTranslation)/sizeof(name2xpm);
-	int found=-1;
-	
-	for(int i=nbIcon-1;i>=0;i--)
-	{
-		if(!strcmp(iconTranslation[i].name,filename)) found=i;
-	}
-	if(found==-1)
-	{
-		printf("\n Mmmm problem with pixmap button. Did you change the code ?(%s)\n",filename);
-		//ADM_assert(0);
-                return NULL;
-	
-	}
-
-   GdkPixbuf *pix=NULL;
-   guint8 *gpix;
-   switch(iconTranslation[found].icon)
-        {
-        case A_ICON_XPM:        
-                pix= gdk_pixbuf_new_from_xpm_data((const char **)iconTranslation[found].data);
-                break;
-        case A_ICON_PNG:
-                gpix=( guint8 *)iconTranslation[found].data;
-                pix=gdk_pixbuf_new_from_inline (-1, gpix, FALSE, NULL);
-                break;
-        default:
-                ADM_assert(0);
-        
-        }
-  
-  return pix;
-}
-
-GtkWidget	*create_pixmap                          (GtkWidget       *widget,
-                         					               const gchar     *filename)
-{
-GdkPixbuf *pix=NULL;
-GtkWidget *pixmap=NULL;
- 
-  UNUSED_ARG( widget );
-   
-  pix= create_pixbuf    (filename);
-  pixmap= gtk_image_new_from_pixbuf(pix);
-  return pixmap;
-}
-
-static GList *pixmaps_directories = NULL;
-
-/* Use this function to set the directory containing installed pixmaps. */
-void
-add_pixmap_directory                   (const gchar     *directory)
-{
-  pixmaps_directories = g_list_prepend (pixmaps_directories,
-                                        g_strdup (directory));
-}
-
-/* This is an internally used function to find pixmap files. */
-static gchar*
-find_pixmap_file                       (const gchar     *filename)
-{
-  GList *elem;
-
-  /* We step through each of the pixmaps directory to find it. */
-  elem = pixmaps_directories;
-  while (elem)
-    {
-      gchar *pathname = g_strdup_printf ("%s%s%s", (gchar*)elem->data,
-                                         G_DIR_SEPARATOR_S, filename);
-      if (g_file_test (pathname, G_FILE_TEST_EXISTS))
-        return pathname;
-      g_free (pathname);
-      elem = elem->next;
-    }
-  return NULL;
-}
-
-/* This is an internally used function to create pixmaps. */
-GtkWidget*
-create_pixmap_old                          (GtkWidget       *widget,
-                                        const gchar     *filename)
-{
-  gchar *pathname = NULL;
-  GtkWidget *pixmap;
-
-  UNUSED_ARG( widget );
-
-  if (!filename || !filename[0])
-      return gtk_image_new ();
-
-  pathname = find_pixmap_file (filename);
-
-  if (!pathname)
-    {
-      g_warning (QT_TR_NOOP("Couldn't find pixmap file: %s"), filename);
-      return gtk_image_new ();
-    }
-
-  pixmap = gtk_image_new_from_file (pathname);
-  g_free (pathname);
-  return pixmap;
-}
-
-/* This is an internally used function to create pixmaps. */
-GdkPixbuf*
-create_pixbuf_old                          (const gchar     *filename)
-{
-  gchar *pathname = NULL;
-  GdkPixbuf *pixbuf;
-  GError *error = NULL;
-
-  if (!filename || !filename[0])
-      return NULL;
-
-  pathname = find_pixmap_file (filename);
-
-  if (!pathname)
-    {
-      g_warning (QT_TR_NOOP("Couldn't find pixmap file: %s"), filename);
-      return NULL;
-    }
-
-  pixbuf = gdk_pixbuf_new_from_file (pathname, &error);
-  if (!pixbuf)
-    {
-      fprintf (stderr, "Failed to load pixbuf file: %s: %s\n",
-               pathname, error->message);
-      g_error_free (error);
-    }
-  g_free (pathname);
-  return pixbuf;
-}
-
-
-#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/ADM_tray_gtk.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/ADM_tray_gtk.cpp	2010-09-06 10:23:35 UTC (rev 6600)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/ADM_tray_gtk.cpp	2010-09-06 10:23:37 UTC (rev 6601)
@@ -71,12 +71,13 @@
 
 		for (int i = 0; i < nb; i++)
 		{
-			pixbuf[i] = create_pixbuf(animated[i]);
+#warning broken
+		//	pixbuf[i] = create_pixbuf(animated[i]);
 
 			if (!pixbuf[i])
 			{
 				printf("Failed to create <%s>\n", animated[i]);
-				ADM_assert(0);
+			//	ADM_assert(0);
 			}
 		}
 	}

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/CMakeLists.txt	2010-09-06 10:23:35 UTC (rev 6600)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/CMakeLists.txt	2010-09-06 10:23:37 UTC (rev 6601)
@@ -3,7 +3,6 @@
 SET(${ADM_LIB}_SRCS
 	ADM_tray_gtk.cpp  
         gtkmarkscale.c jogshuttle.c ADM_jogshuttle.cpp  mediactrl.c
-        ADM_icons.cpp
         GUI_glade.cpp
 
 )

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/CMakeLists.txt	2010-09-06 10:23:35 UTC (rev 6600)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/CMakeLists.txt	2010-09-06 10:23:37 UTC (rev 6601)
@@ -6,7 +6,7 @@
 audio-volume-medium.png
 )
 
-FILE(GLOB ADM_icons ${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/common/ADM_icons/*.png)
+FILE(GLOB ADM_icons ${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/qt4/ADM_userInterfaces/ADM_gui/pics/*.png)
 INSTALL(FILES ${ADM_glade} ${ADM_icons} DESTINATION "${AVIDEMUX_LIB_DIR}/ADM_glade/main")
 
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.gtkBuilder
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.gtkBuilder	2010-09-06 10:23:35 UTC (rev 6600)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.gtkBuilder	2010-09-06 10:23:37 UTC (rev 6601)
@@ -573,7 +573,9 @@
                         <child>
                           <object class="GtkImage" id="image591">
                             <property name="visible">True</property>
-                            <property name="pixbuf">play.xpm</property>
+                            <property name="xpad">1</property>
+                            <property name="ypad">2</property>
+                            <property name="pixbuf">player_play.png</property>
                           </object>
                         </child>
                       </object>
@@ -593,7 +595,7 @@
                         <child>
                           <object class="GtkImage" id="image5056">
                             <property name="visible">True</property>
-                            <property name="pixbuf">stop.xpm</property>
+                            <property name="pixbuf">player_stop.png</property>
                           </object>
                         </child>
                       </object>
@@ -614,7 +616,7 @@
                         <child>
                           <object class="GtkImage" id="image593">
                             <property name="visible">True</property>
-                            <property name="pixbuf">backward.xpm</property>
+                            <property name="pixbuf">previous.png</property>
                           </object>
                         </child>
                       </object>
@@ -635,7 +637,7 @@
                         <child>
                           <object class="GtkImage" id="image594">
                             <property name="visible">True</property>
-                            <property name="pixbuf">forward.xpm</property>
+                            <property name="pixbuf">next.png</property>
                           </object>
                         </child>
                       </object>
@@ -656,7 +658,7 @@
                         <child>
                           <object class="GtkImage" id="image595">
                             <property name="visible">True</property>
-                            <property name="pixbuf">Kbackward.xpm</property>
+                            <property name="pixbuf">player_rew.png</property>
                           </object>
                         </child>
                       </object>
@@ -677,7 +679,7 @@
                         <child>
                           <object class="GtkImage" id="image596">
                             <property name="visible">True</property>
-                            <property name="pixbuf">Kforward.xpm</property>
+                            <property name="pixbuf">player_fwd.png</property>
                           </object>
                         </child>
                       </object>
@@ -697,7 +699,7 @@
                         <child>
                           <object class="GtkImage" id="image2306">
                             <property name="visible">True</property>
-                            <property name="pixbuf">markA.xpm</property>
+                            <property name="pixbuf">markA.png</property>
                           </object>
                         </child>
                       </object>
@@ -717,7 +719,7 @@
                         <child>
                           <object class="GtkImage" id="image2307">
                             <property name="visible">True</property>
-                            <property name="pixbuf">markB.xpm</property>
+                            <property name="pixbuf">markB.png</property>
                           </object>
                         </child>
                       </object>
@@ -737,7 +739,7 @@
                         <child>
                           <object class="GtkImage" id="image2308">
                             <property name="visible">True</property>
-                            <property name="pixbuf">xpm_prevblack.xpm</property>
+                            <property name="pixbuf">prev_black.png</property>
                           </object>
                         </child>
                       </object>
@@ -757,7 +759,7 @@
                         <child>
                           <object class="GtkImage" id="image2309">
                             <property name="visible">True</property>
-                            <property name="pixbuf">xpm_nextblack.xpm</property>
+                            <property name="pixbuf">next_black.png</property>
                           </object>
                         </child>
                       </object>
@@ -777,7 +779,7 @@
                         <child>
                           <object class="GtkImage" id="image5057">
                             <property name="visible">True</property>
-                            <property name="pixbuf">begin.xpm</property>
+                            <property name="pixbuf">player_start.png</property>
                           </object>
                         </child>
                       </object>
@@ -797,7 +799,7 @@
                         <child>
                           <object class="GtkImage" id="image2245">
                             <property name="visible">True</property>
-                            <property name="pixbuf">end.xpm</property>
+                            <property name="pixbuf">player_end.png</property>
                           </object>
                         </child>
                       </object>
@@ -822,47 +824,8 @@
                 <child>
                   <object class="GtkHBox" id="hbox16">
                     <property name="visible">True</property>
-                    <property name="spacing">6</property>
+                    <property name="spacing">7</property>
                     <child>
-                      <object class="GtkLabel" id="label1">
-                        <property name="visible">True</property>
-                        <property name="label" translatable="yes">Frame: </property>
-                      </object>
-                      <packing>
-                        <property name="expand">False</property>
-                        <property name="fill">False</property>
-                        <property name="position">0</property>
-                      </packing>
-                    </child>
-                    <child>
-                      <object class="GtkEntry" id="boxCurFrame">
-                        <property name="visible">True</property>
-                        <property name="can_focus">True</property>
-                        <property name="max_length">8</property>
-                        <property name="width_chars">8</property>
-                        <property name="text" translatable="yes">0</property>
-                      </object>
-                      <packing>
-                        <property name="expand">False</property>
-                        <property name="fill">False</property>
-                        <property name="position">1</property>
-                      </packing>
-                    </child>
-                    <child>
-                      <object class="GtkLabel" id="labelTotalFrame">
-                        <property name="visible">True</property>
-                        <property name="can_focus">True</property>
-                        <property name="xpad">5</property>
-                        <property name="label" translatable="yes">/ 0000000</property>
-                        <property name="selectable">True</property>
-                      </object>
-                      <packing>
-                        <property name="expand">False</property>
-                        <property name="fill">False</property>
-                        <property name="position">2</property>
-                      </packing>
-                    </child>
-                    <child>
                       <object class="GtkLabel" id="label4">
                         <property name="visible">True</property>
                         <property name="label" translatable="yes">Time: </property>
@@ -870,20 +833,21 @@
                       <packing>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
-                        <property name="position">3</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkEntry" id="boxCurTime">
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
+                        <property name="invisible_char">?</property>
                         <property name="width_chars">13</property>
                         <property name="text" translatable="yes">00:00:00.000</property>
                       </object>
                       <packing>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
-                        <property name="position">4</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                     <child>
@@ -897,7 +861,7 @@
                       <packing>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
-                        <property name="position">5</property>
+                        <property name="position">2</property>
                       </packing>
                     </child>
                     <child>
@@ -910,7 +874,7 @@
                       <packing>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
-                        <property name="position">6</property>
+                        <property name="position">3</property>
                       </packing>
                     </child>
                   </object>



From mean at mail.berlios.de  Mon Sep  6 12:23:38 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 12:23:38 +0200
Subject: [Avidemux-svn-commit] r6602 -
	branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2
Message-ID: <20100906102338.A096A481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 12:23:38 +0200 (Mon, 06 Sep 2010)
New Revision: 6602

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
Log:
[Gtk] Rebind buttons

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-06 10:23:37 UTC (rev 6601)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-06 10:23:38 UTC (rev 6602)
@@ -456,7 +456,7 @@
 		uint32_t nb=sizeof(buttonCallback)/sizeof(buttonCallBack_S);
 		GtkWidget *bt;
 
-#if 0
+
 		for(uint32_t i=0;i<nb;i++)
 		{
 			bt= glade.getWidget(buttonCallback[i].name);
@@ -464,11 +464,13 @@
 			{
 				printf("Binding failed for %s\n",buttonCallback[i].name);
 				//ADM_assert(0);
-			}
-			ADD_SIGNAL(bt,buttonCallback[i].signal,buttonCallback[i].action);
-			GTK_WIDGET_UNSET_FLAGS (bt, GTK_CAN_FOCUS);
+			}else
+            {
+                ADD_SIGNAL(bt,buttonCallback[i].signal,buttonCallback[i].action);
+                GTK_WIDGET_UNSET_FLAGS (bt, GTK_CAN_FOCUS);
+            }
 		}
-#endif
+
 	
 
 // set some tuning



From mean at mail.berlios.de  Mon Sep  6 13:45:51 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 13:45:51 +0200
Subject: [Avidemux-svn-commit] r6603 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <20100906114551.4918F481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 13:45:51 +0200 (Mon, 06 Sep 2010)
New Revision: 6603

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
Log:
[editor] When changing track, also update fq & channels

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2010-09-06 10:23:38 UTC (rev 6602)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2010-09-06 11:45:51 UTC (rev 6603)
@@ -509,6 +509,10 @@
             return false;
         }
         v->currentAudioStream=newstream;
+        // Change our header also
+        wavHeader.frequency=trks[newstream]->wavheader.frequency;
+        wavHeader.channels=trks[newstream]->wavheader.channels;
+        //ADM_warning("New fq=%d\n",(int)wavHeader.frequency);
         return true;
 }
 



From mean at mail.berlios.de  Mon Sep  6 13:45:52 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  6 Sep 2010 13:45:52 +0200
Subject: [Avidemux-svn-commit] r6604 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml
Message-ID: <20100906114552.5E845481051@sheep.berlios.de>

Author: mean
Date: 2010-09-06 13:45:52 +0200 (Mon, 06 Sep 2010)
New Revision: 6604

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_openDML.cpp
Log:
[openDMl/demux] Return info about the correct audio track

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_openDML.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_openDML.cpp	2010-09-06 11:45:51 UTC (rev 6603)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_openDML.cpp	2010-09-06 11:45:52 UTC (rev 6604)
@@ -211,7 +211,7 @@
 WAVHeader              *OpenDMLHeader::getAudioInfo(uint32_t i ) 
 {
     if(_nbAudioTracks)
-		return _audioStreams[_currentAudioTrack]->getInfo();
+		return _audioStreams[i]->getInfo();
 	else
 		return NULL;
 }



From mean at mail.berlios.de  Tue Sep  7 09:41:21 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue,  7 Sep 2010 09:41:21 +0200
Subject: [Avidemux-svn-commit] r6606 - in
	branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces:
	ADM_dialog ADM_gui2 glade/main
Message-ID: <20100907074121.9F4CB480FE8@sheep.berlios.de>

Author: mean
Date: 2010-09-07 09:41:21 +0200 (Tue, 07 Sep 2010)
New Revision: 6606

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_properties.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.gtkBuilder
Log:
[Gtk] More UI fixes

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_properties.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_properties.cpp	2010-09-07 07:41:18 UTC (rev 6605)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_properties.cpp	2010-09-07 07:41:21 UTC (rev 6606)
@@ -61,9 +61,11 @@
         sprintf(text, QT_TR_NOOP("%02d:%02d:%02d.%03d"), hh, mm, ss, ms);
         FILL_ENTRY(label_duration);
         // Fill in vop, gmc & qpel
+#if 0
         SET_YES(labelPacked,vop);
         SET_YES(labelGMC,gmc);
         SET_YES(labelQP,qpel);
+#endif
         // Aspect ratio
         const char *s;
         war=video_body->getPARWidth();

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-07 07:41:18 UTC (rev 6605)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-07 07:41:21 UTC (rev 6606)
@@ -398,17 +398,28 @@
 {
         
         GtkComboBox     *combo_box;
+        GtkListStore *list_store;
+        GtkCellRenderer *renderer;
+        GtkTreeIter iter;
+
         combo_box=GTK_COMBO_BOX(glade.getWidget(widgetName));
-        GtkListStore *list_store;
         list_store = gtk_list_store_new (1, G_TYPE_STRING);
-        gtk_combo_box_set_model(combo_box,GTK_TREE_MODEL(list_store));
+        
         gtk_combo_box_remove_text(combo_box,0);
 
         for(uint32_t i=0;i<nb;i++)
         {
                 const char *name=listEntry(i);
-                gtk_combo_box_append_text      (combo_box,QT_TR_NOOP(name));
+            
+                gtk_list_store_append (list_store, &iter); 
+                gtk_list_store_set (list_store, &iter, 0, listEntry(i), -1);
+                
         }
+        gtk_combo_box_set_model(combo_box,GTK_TREE_MODEL(list_store));
+        renderer = gtk_cell_renderer_text_new();
+        gtk_cell_layout_pack_start(GTK_CELL_LAYOUT(combo_box), renderer, TRUE);
+        gtk_cell_layout_set_attributes(GTK_CELL_LAYOUT(combo_box), renderer,"text", 0, NULL);
+
         return true;
 }
 /**

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.gtkBuilder
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.gtkBuilder	2010-09-07 07:41:18 UTC (rev 6605)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/glade/main/gtk2_build.gtkBuilder	2010-09-07 07:41:21 UTC (rev 6606)
@@ -259,6 +259,7 @@
                                     <child>
                                       <object class="GtkComboBox" id="comboboxVideo1">
                                         <property name="visible">True</property>
+                                        <property name="editing_canceled">True</property>
                                       </object>
                                       <packing>
                                         <property name="expand">False</property>



From gruntster at mail.berlios.de  Tue Sep  7 23:48:24 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue,  7 Sep 2010 23:48:24 +0200
Subject: [Avidemux-svn-commit] r6607 - in
	branches/avidemux_2.5_branch_gruntster/avidemux:
	ADM_core/include ADM_outputs/oplug_avi
Message-ID: <20100907214824.432DD480FD4@sheep.berlios.de>

Author: gruntster
Date: 2010-09-07 23:48:24 +0200 (Tue, 07 Sep 2010)
New Revision: 6607

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_mangle.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp
Log:
[apple] build fix

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_mangle.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_mangle.h	2010-09-07 07:41:21 UTC (rev 6606)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_mangle.h	2010-09-07 21:48:24 UTC (rev 6607)
@@ -18,7 +18,7 @@
 // Use rip-relative addressing if compiling PIC code on x86-64.
 #if defined(__MINGW32__) || defined(__CYGWIN__) || defined(__DJGPP__) || \
     defined(__OS2__) || (defined (__OpenBSD__) && !defined(__ELF__)) || \
-	defined(__APPLE__)
+	(defined(__APPLE__) && defined(ADM_CPU_X86_32))
 #    if defined(ADM_CPU_X86_64) && defined(PIC) && !defined(__MINGW32__)
 #        define MANGLE(a) "_" #a"(%%rip)"
 #        define FUNNY_MANGLE(x) x asm(MANGLE(x))

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp	2010-09-07 07:41:21 UTC (rev 6606)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp	2010-09-07 21:48:24 UTC (rev 6607)
@@ -18,6 +18,7 @@
  ***************************************************************************/
 #include "config.h"
 #include "ADM_default.h"
+#include "ADM_encoder/ADM_vidEncode.hxx"
 
 extern "C"
 {
@@ -36,14 +37,9 @@
 #include "avi_vars.h"
 #include "DIA_coreToolkit.h"
 
-//#include "avilist.h"
-
 #include "ADM_videoFilter.h"
 #include "ADM_videoFilter_internal.h"
 
-#include "ADM_encoder/ADM_vidEncode.hxx"
-
-
 #include "ADM_audio/aviaudio.hxx"
 #include "ADM_audiofilter/audioprocess.hxx"
 #include "op_aviwrite.hxx"



From mean at mail.berlios.de  Wed Sep  8 19:41:59 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  8 Sep 2010 19:41:59 +0200
Subject: [Avidemux-svn-commit] r6608 -
	branches/avidemux_2.6_branch_mean/avidemux_core
Message-ID: <20100908174200.8699B481059@sheep.berlios.de>

Author: mean
Date: 2010-09-08 19:41:59 +0200 (Wed, 08 Sep 2010)
New Revision: 6608

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
Log:
[core] Add large file support, thanks wigglebit

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-09-07 21:48:24 UTC (rev 6607)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-09-08 17:41:59 UTC (rev 6608)
@@ -16,6 +16,7 @@
 
 SET(CMAKE_MODULE_PATH "${AVIDEMUX_TOP_SOURCE_DIR}/cmake" "${CMAKE_MODULE_PATH}")
 SET(ADM_PROJECT admCore)
+ADD_DEFINITIONS(-D_FILE_OFFSET_BITS=64 -D_LARGE_FILES)
 include(admMainChecks)
 ########################################
 # VDPAU



From gruntster at mail.berlios.de  Wed Sep  8 22:35:34 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed,  8 Sep 2010 22:35:34 +0200
Subject: [Avidemux-svn-commit] r6609 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters:
	. AvsFilter Yadif
Message-ID: <20100908203534.4A0E1481062@sheep.berlios.de>

Author: gruntster
Date: 2010-09-08 22:35:34 +0200 (Wed, 08 Sep 2010)
New Revision: 6609

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/AvsFilter/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif/CMakeLists.txt
Log:
[apple] build fixes for plugins

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/AvsFilter/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/AvsFilter/CMakeLists.txt	2010-09-08 17:41:59 UTC (rev 6608)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/AvsFilter/CMakeLists.txt	2010-09-08 20:35:34 UTC (rev 6609)
@@ -1,4 +1,3 @@
-IF (NOT WIN32)
 INCLUDE(vf_plugin)
 
 SET(ADM_vf_avsfilter_SRCS avsfilter.cpp avspipecomm.cpp cdebug.cpp strnew.cpp)
@@ -8,7 +7,4 @@
 
 INIT_VIDEOFILTER_PLUGIN(ADM_vf_avsfilter)
 INSTALL_VIDEOFILTER(ADM_vf_avsfilter)
-ADD_DEFINITIONS("-DVERSION_2_5 -DDEBUGMSG")
-
-ENDIF (NOT WIN32)
-
+ADD_DEFINITIONS("-DVERSION_2_5 -DDEBUGMSG")
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/CMakeLists.txt	2010-09-08 17:41:59 UTC (rev 6608)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/CMakeLists.txt	2010-09-08 20:35:34 UTC (rev 6609)
@@ -1,5 +1,9 @@
 ADD_SUBDIRECTORY(AddBorders)
-ADD_SUBDIRECTORY(AvsFilter)
+
+IF (NOT WIN32 AND NOT APPLE)
+	ADD_SUBDIRECTORY(AvsFilter)
+ENDIF (NOT WIN32 AND NOT APPLE)
+
 ADD_SUBDIRECTORY(BlendRemover)
 ADD_SUBDIRECTORY(Chroma)
 ADD_SUBDIRECTORY(Decimate)
@@ -39,10 +43,11 @@
 ADD_SUBDIRECTORY(MSmooth)
 ADD_SUBDIRECTORY(Soften)
 ADD_SUBDIRECTORY(lavDeinterlace)
-# Dependancy toward codecs 
-IF(NOT WIN32)
+
+IF (NOT WIN32 AND NOT APPLE)
   ADD_SUBDIRECTORY(Logo)
-ENDIF(NOT WIN32)
+ENDIF (NOT WIN32 AND NOT APPLE)
+
 ADD_SUBDIRECTORY(ChromaShift)
 ADD_SUBDIRECTORY(CNR2)
 ADD_SUBDIRECTORY(colorYUV)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif/CMakeLists.txt	2010-09-08 17:41:59 UTC (rev 6608)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif/CMakeLists.txt	2010-09-08 20:35:34 UTC (rev 6609)
@@ -1,9 +1,13 @@
 INCLUDE(vf_plugin)
 
-
 SET(ADM_vf_yadif_SRCS ADM_vidYadif_asm.c  ADM_vidYadif.cpp )
 
 ADD_LIBRARY(ADM_vf_yadif SHARED ${ADM_vf_yadif_SRCS})
 
+IF (APPLE)
+	ADD_SOURCE_CFLAGS(ADM_vidYadif_asm.c -mdynamic-no-pic)
+	TARGET_LINK_LIBRARIES(ADM_vf_yadif -Wl,-read_only_relocs,suppress)
+ENDIF (APPLE)
+
 INIT_VIDEOFILTER_PLUGIN(ADM_vf_yadif)
 INSTALL_VIDEOFILTER(ADM_vf_yadif)



From mean at mail.berlios.de  Thu Sep  9 07:14:35 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu,  9 Sep 2010 07:14:35 +0200
Subject: [Avidemux-svn-commit] r6610 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src
Message-ID: <20100909051435.349FB480190@sheep.berlios.de>

Author: mean
Date: 2010-09-09 07:14:34 +0200 (Thu, 09 Sep 2010)
New Revision: 6610

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
Log:
[h264] Take into account crop parameter in sps decoding , patch by wigglebit

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-08 20:35:34 UTC (rev 6609)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-09 05:14:34 UTC (rev 6610)
@@ -178,6 +178,10 @@
   *fps1000=0;
   uint32_t profile, constraint, level, pic_order_cnt_type, w, h, mbh,
     frame_mbs_only;
+  uint32_t frame_cropping_flag;
+  uint32_t chroma_format_idc = 1; // this defaults to 1 when it's missing
+  uint32_t separate_colour_plane_flag = 0;
+  uint32_t chroma_array_type = 0;
   uint8_t buf[len];
   uint32_t outlen;
   uint32_t id, dum;
@@ -194,8 +198,9 @@
   if (profile >= 100)		// ?? Borrowed from H264.C/FFMPEG
     {
       printf ("[H264]Warning : High profile\n");
-      if (bits.getUEG() == 3)	//chroma_format_idc
-        bits.get(1);		//residual_color_transform_flag
+      chroma_format_idc = bits.getUEG();
+      if (chroma_format_idc == 3)	//chroma_format_idc
+        separate_colour_plane_flag = bits.get(1);		//residual_color_transform_flag
       bits.getUEG();	//bit_depth_luma_minus8
       bits.getUEG();	//bit_depth_chroma_minus8
       bits.get(1);		// Transform bypass
@@ -206,6 +211,8 @@
 	  }
     }
 
+	if ( separate_colour_plane_flag == 0 )
+		chroma_array_type = chroma_format_idc;
 
   dum = bits.getUEG();	// log2_max_frame_num_minus4
   printf ("[H264]Log2maxFrame-4:%u\n", dum);
@@ -256,12 +263,38 @@
 
   bits.get(1);
 
-  if (bits.get(1))
-    {
-      bits.getUEG();
-      bits.getUEG();
-      bits.getUEG();
-      bits.getUEG();
+	frame_cropping_flag = bits.get(1);
+ 	if (frame_cropping_flag)
+	{
+		// The tests could probably be done more simply but the following is per the spec.
+		uint32_t cl, cr, ct, cb;
+		int cux = 1; // x units
+		int cuy = 2 - frame_mbs_only; // y units
+		if ( chroma_array_type > 0 ) {
+			switch( chroma_format_idc ) {
+			case 1:
+				cux = 2;
+				cuy = 2 * ( 2 - frame_mbs_only );
+				break;
+			case 2:
+				cux = 2;
+				cuy = 1 * ( 2 - frame_mbs_only );
+				break;
+			case 3:
+				cux = 1; 
+				cuy = 1 * ( 2 - frame_mbs_only );
+				break;
+			}
+		}
+		cl = bits.getUEG() * cux;
+		cr = bits.getUEG() * cux;
+		ct = bits.getUEG() * cuy;
+		cb = bits.getUEG() * cuy;
+		*wwidth -= cl; // reduce dims based on crop values
+		*wwidth -= cr;
+		*hheight -= ct;
+		*hheight -= cb;
+		printf ("[H264] Has cropping of l:%d  r:%d  t:%d  b:%d\n", cl, cr, ct, cb);
     }
 
   if (bits.get(1))



From mean at mail.berlios.de  Thu Sep  9 07:41:14 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu,  9 Sep 2010 07:41:14 +0200
Subject: [Avidemux-svn-commit] r6611 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins:
	ADM_videoFilters/Ass ADM_videoFilters/Ass/ADM_libass
	ADM_videoFilters/LumaOnly ADM_videoFilters6
	ADM_videoFilters6/lumaOnly
Message-ID: <20100909054114.79EA2480190@sheep.berlios.de>

Author: mean
Date: 2010-09-09 07:41:14 +0200 (Thu, 09 Sep 2010)
New Revision: 6611

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lumaOnly/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lumaOnly/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lumaOnly/lumaOnly.cpp
Removed:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_bitmap.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_bitmap.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_cache.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_cache.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_font.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_font.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_fontconfig.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_fontconfig.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_library.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_library.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_render.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_types.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_utils.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_utils.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/help_mp.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/mputils.c
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/mputils.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_vidASS.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_vidASS.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_vidAss_Params.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/LumaOnly/ADM_vidLuma.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/LumaOnly/ADM_vidLuma.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/LumaOnly/CMakeLists.txt
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
Log:
[Filter] Luma only

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/CMakeLists.txt	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/CMakeLists.txt	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,19 +0,0 @@
-INCLUDE(admCheckFontConfig)
-checkFontConfig()
-
-SET(ADM_LIB ADM_libass)
-
-SET(${ADM_LIB}_SRCS 
-ass_bitmap.c  ass.c  ass_cache.c  ass_fontconfig.c  ass_library.c   ass_render.c  ass_utils.c  mputils.c
-ass_font.c)
-
-ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})
-ADD_DEFINITIONS(${FREETYPE2_CFLAGS} "-I${LIBICONV_INCLUDE_DIR}")
-
-IF (FONTCONFIG_FOUND)
-	ADD_DEFINITIONS(${FONTCONFIG_CFLAGS} "-DHAVE_FONTCONFIG=1")
-ENDIF (FONTCONFIG_FOUND)
-
-IF (UNIX)
-	ADD_TARGET_CFLAGS(${ADM_LIB} -fPIC)
-ENDIF (UNIX)
\ No newline at end of file

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass.c	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass.c	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,1092 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-//#include "config.h"
-
-#include <stdio.h>
-#include <stdlib.h>
-#include <string.h>
-#include <assert.h>
-#include <errno.h>
-#include <sys/types.h>
-#include <sys/stat.h>
-#include <unistd.h>
-#include <inttypes.h>
-
-#ifdef USE_ICONV
-#include <iconv.h>
-#endif
-
-#include "ass.h"
-#include "ass_utils.h"
-#include "ass_library.h"
-#include "mputils.h"
-
-typedef enum {PST_UNKNOWN = 0, PST_INFO, PST_STYLES, PST_EVENTS, PST_FONTS} parser_state_t;
-
-struct parser_priv_s {
-	parser_state_t state;
-	char* fontname;
-	char* fontdata;
-	int fontdata_size;
-	int fontdata_used;
-};
-
-#define ASS_STYLES_ALLOC 20
-#define ASS_EVENTS_ALLOC 200
-
-void ass_free_track(ass_track_t* track) {
-	int i;
-	
-	if (track->parser_priv) {
-		if (track->parser_priv->fontname)
-			free(track->parser_priv->fontname);
-		if (track->parser_priv->fontdata)
-			free(track->parser_priv->fontdata);
-		free(track->parser_priv);
-	}
-	if (track->style_format)
-		free(track->style_format);
-	if (track->event_format)
-		free(track->event_format);
-	if (track->styles) {
-		for (i = 0; i < track->n_styles; ++i)
-			ass_free_style(track, i);
-		free(track->styles);
-	}
-	if (track->events) {
-		for (i = 0; i < track->n_events; ++i)
-			ass_free_event(track, i);
-		free(track->events);
-	}
-}
-
-/// \brief Allocate a new style struct
-/// \param track track
-/// \return style id
-int ass_alloc_style(ass_track_t* track) {
-	int sid;
-	
-	assert(track->n_styles <= track->max_styles);
-
-	if (track->n_styles == track->max_styles) {
-		track->max_styles += ASS_STYLES_ALLOC;
-		track->styles = (ass_style_t*)realloc(track->styles, sizeof(ass_style_t)*track->max_styles);
-	}
-	
-	sid = track->n_styles++;
-	memset(track->styles + sid, 0, sizeof(ass_style_t));
-	return sid;
-}
-
-/// \brief Allocate a new event struct
-/// \param track track
-/// \return event id
-int ass_alloc_event(ass_track_t* track) {
-	int eid;
-	
-	assert(track->n_events <= track->max_events);
-
-	if (track->n_events == track->max_events) {
-		track->max_events += ASS_EVENTS_ALLOC;
-		track->events = (ass_event_t*)realloc(track->events, sizeof(ass_event_t)*track->max_events);
-	}
-	
-	eid = track->n_events++;
-	memset(track->events + eid, 0, sizeof(ass_event_t));
-	return eid;
-}
-
-void ass_free_event(ass_track_t* track, int eid) {
-	ass_event_t* event = track->events + eid;
-	if (event->Name)
-		free(event->Name);
-	if (event->Effect)
-		free(event->Effect);
-	if (event->Text)
-		free(event->Text);
-	if (event->render_priv)
-		free(event->render_priv);
-}
-
-void ass_free_style(ass_track_t* track, int sid) {
-	ass_style_t* style = track->styles + sid;
-	if (style->Name)
-		free(style->Name);
-	if (style->FontName)
-		free(style->FontName);
-}
-
-// ==============================================================================================
-
-static void skip_spaces(char** str) {
-	char* p = *str;
-	while ((*p==' ') || (*p=='\t'))
-		++p;
-	*str = p;
-}
-
-static void rskip_spaces(char** str, char* limit) {
-	char* p = *str;
-	while ((p >= limit) && ((*p==' ') || (*p=='\t')))
-		--p;
-	*str = p;
-}
-
-/**
- * \brief find style by name
- * \param track track
- * \param name style name
- * \return index in track->styles
- * Returnes 0 if no styles found => expects at least 1 style.
- * Parsing code always adds "Default" style in the end.
- */
-static int lookup_style(ass_track_t* track, char* name) {
-	int i;
-	if (*name == '*') ++name; // FIXME: what does '*' really mean ?
-	for (i=0; i<track->n_styles; ++i) {
-		// FIXME: mb strcasecmp ?
-		if (strcmp(track->styles[i].Name, name) == 0)
-			return i;
-	}
-	i = track->default_style;
-	mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NoStyleNamedXFoundUsingY, track, name, track->styles[i].Name);
-	return i; // use the first style
-}
-
-static uint32_t string2color(char* p) {
-	uint32_t tmp;
-	(void)strtocolor(&p, &tmp);
-	return tmp;
-}
-
-static long long string2timecode(char* p) {
-	unsigned h, m, s, ms;
-	long long tm;
-	int res = sscanf(p, "%1d:%2d:%2d.%2d", &h, &m, &s, &ms);
-	if (res < 4) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_BadTimestamp);
-		return 0;
-	}
-	tm = ((h * 60 + m) * 60 + s) * 1000 + ms * 10;
-	return tm;
-}
-
-/**
- * \brief converts numpad-style align to align.
- */
-static int numpad2align(int val) {
-	int res, v;
-	v = (val - 1) / 3; // 0, 1 or 2 for vertical alignment
-	if (v != 0) v = 3 - v;
-	res = ((val - 1) % 3) + 1; // horizontal alignment
-	res += v*4;
-	return res;
-}
-
-#define NEXT(str,token) \
-	token = next_token(&str); \
-	if (!token) break;
-
-#define ANYVAL(name,func) \
-	} else if (strcasecmp(tname, #name) == 0) { \
-		target->name = func(token); \
-		mp_msg(MSGT_ASS, MSGL_DBG2, "%s = %s\n", #name, token);
-
-#define STRVAL(name) \
-	} else if (strcasecmp(tname, #name) == 0) { \
-		if (target->name != NULL) free(target->name); \
-		target->name = strdup(token); \
-		mp_msg(MSGT_ASS, MSGL_DBG2, "%s = %s\n", #name, token);
-		
-#define COLORVAL(name) ANYVAL(name,string2color)
-#define INTVAL(name) ANYVAL(name,atoi)
-#define FPVAL(name) ANYVAL(name,atof)
-#define TIMEVAL(name) ANYVAL(name,string2timecode)
-#define STYLEVAL(name) \
-	} else if (strcasecmp(tname, #name) == 0) { \
-		target->name = lookup_style(track, token); \
-		mp_msg(MSGT_ASS, MSGL_DBG2, "%s = %s\n", #name, token);
-
-#define ALIAS(alias,name) \
-	if (strcasecmp(tname, #alias) == 0) {tname = #name;}
-
-static char* next_token(char** str) {
-	char* p = *str;
-	char* start;
-	skip_spaces(&p);
-	if (*p == '\0') {
-		*str = p;
-		return 0;
-	}
-	start = p; // start of the token
-	for (; (*p != '\0') && (*p != ','); ++p) {}
-	if (*p == '\0') {
-		*str = p; // eos found, str will point to '\0' at exit
-	} else {
-		*p = '\0';
-		*str = p + 1; // ',' found, str will point to the next char (beginning of the next token)
-	}
-	--p; // end of current token
-	rskip_spaces(&p, start);
-	if (p < start)
-		p = start; // empty token
-	else
-		++p; // the first space character, or '\0'
-	*p = '\0';
-	return start;
-}
-/**
- * \brief Parse the tail of Dialogue line
- * \param track track
- * \param event parsed data goes here
- * \param str string to parse, zero-terminated
- * \param n_ignored number of format options to skip at the beginning
-*/ 
-static int process_event_tail(ass_track_t* track, ass_event_t* event, char* str, int n_ignored)
-{
-	char* token;
-	char* tname;
-	char* p = str;
-	int i;
-	ass_event_t* target = event;
-
-	char* format = strdup(track->event_format);
-	char* q = format; // format scanning pointer
-
-	if (track->n_styles == 0) {
-		// add "Default" style to the end
-		// will be used if track does not contain a default style (or even does not contain styles at all)
-		int sid = ass_alloc_style(track);
-		track->styles[sid].Name = strdup("Default");
-		track->styles[sid].FontName = strdup("Arial");
-	}
-
-	for (i = 0; i < n_ignored; ++i) {
-		NEXT(q, tname);
-	}
-
-	while (1) {
-		NEXT(q, tname);
-		if (strcasecmp(tname, "Text") == 0) {
-			char* last;
-			event->Text = strdup(p);
-			if (*event->Text != 0) {
-				last = event->Text + strlen(event->Text) - 1;
-				if (last >= event->Text && *last == '\r')
-					*last = 0;
-			}
-			mp_msg(MSGT_ASS, MSGL_DBG2, "Text = %s\n", event->Text);
-			event->Duration -= event->Start;
-			free(format);
-			return 0; // "Text" is always the last
-		}
-		NEXT(p, token);
-
-		ALIAS(End,Duration) // temporarily store end timecode in event->Duration
-		if (0) { // cool ;)
-			INTVAL(Layer)
-			STYLEVAL(Style)
-			STRVAL(Name)
-			STRVAL(Effect)
-			INTVAL(MarginL)
-			INTVAL(MarginR)
-			INTVAL(MarginV)
-			TIMEVAL(Start)
-			TIMEVAL(Duration)
-		}
-	}
-	free(format);
-	return 1;
-}
-
-/**
- * \brief Parse command line style overrides (--ass-force-style option)
- * \param track track to apply overrides to
- * The format for overrides is [StyleName.]Field=Value
- */
-void process_force_style(ass_track_t* track) {
-	char **fs, *eq, *dt, *style, *tname, *token;
-	ass_style_t* target;
-	int sid;
-	char** list = track->library->style_overrides;
-	
-	if (!list) return;
-	
-	for (fs = list; *fs; ++fs) {
-		eq = strrchr(*fs, '=');
-		if (!eq)
-			continue;
-		*eq = '\0';
-		token = eq + 1;
-
-		dt = strrchr(*fs, '.');
-		if (dt) {
-			*dt = '\0';
-			style = *fs;
-			tname = dt + 1;
-		} else {
-			style = NULL;
-			tname = *fs;
-		}
-		for (sid = 0; sid < track->n_styles; ++sid) {
-			if (style == NULL || strcasecmp(track->styles[sid].Name, style) == 0) {
-				target = track->styles + sid;
-				if (0) {
-					STRVAL(FontName)
-					COLORVAL(PrimaryColour)
-					COLORVAL(SecondaryColour)
-					COLORVAL(OutlineColour)
-					COLORVAL(BackColour)
-					FPVAL(FontSize)
-					INTVAL(Bold)
-					INTVAL(Italic)
-					INTVAL(Underline)
-					INTVAL(StrikeOut)
-					FPVAL(Spacing)
-					INTVAL(Angle)
-					INTVAL(BorderStyle)
-					INTVAL(Alignment)
-					INTVAL(MarginL)
-					INTVAL(MarginR)
-					INTVAL(MarginV)
-					INTVAL(Encoding)
-					FPVAL(ScaleX)
-					FPVAL(ScaleY)
-					FPVAL(Outline)
-					FPVAL(Shadow)
-				}
-			}
-		}
-		*eq = '=';
-		if (dt) *dt = '.';
-	}
-}
-
-/**
- * \brief Parse the Style line
- * \param track track
- * \param str string to parse, zero-terminated
- * Allocates a new style struct.
-*/ 
-static int process_style(ass_track_t* track, char *str)
-{
-
-	char* token;
-	char* tname;
-	char* p = str;
-	char* format;
-	char* q; // format scanning pointer
-	int sid;
-	ass_style_t* style;
-	ass_style_t* target;
-
-	if (!track->style_format) {
-		// no style format header
-		// probably an ancient script version
-		if (track->track_type == TRACK_TYPE_SSA)
-			track->style_format = strdup("Name, Fontname, Fontsize, PrimaryColour, SecondaryColour,"
-					"TertiaryColour, BackColour, Bold, Italic, BorderStyle, Outline,"
-					"Shadow, Alignment, MarginL, MarginR, MarginV, AlphaLevel, Encoding");
-		else
-			track->style_format = strdup("Name, Fontname, Fontsize, PrimaryColour, SecondaryColour,"
-					"OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut,"
-					"ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow,"
-					"Alignment, MarginL, MarginR, MarginV, Encoding");
-	}
-
-	q = format = strdup(track->style_format);
-	
-	mp_msg(MSGT_ASS, MSGL_V, "[%p] Style: %s\n", track, str);
-	
-	sid = ass_alloc_style(track);
-
-	style = track->styles + sid;
-	target = style;
-// fill style with some default values
-	style->ScaleX = 100.;
-	style->ScaleY = 100.;
-	
-	while (1) {
-		NEXT(q, tname);
-		NEXT(p, token);
-		
-//		ALIAS(TertiaryColour,OutlineColour) // ignore TertiaryColour; it appears only in SSA, and is overridden by BackColour
-			
-		if (0) { // cool ;)
-			STRVAL(Name)
-				if ((strcmp(target->Name, "Default")==0) || (strcmp(target->Name, "*Default")==0))
-					track->default_style = sid;
-			STRVAL(FontName)
-			COLORVAL(PrimaryColour)
-			COLORVAL(SecondaryColour)
-			COLORVAL(OutlineColour) // TertiaryColor
-			COLORVAL(BackColour)
-				// SSA uses BackColour for both outline and shadow
-				// this will destroy SSA's TertiaryColour, but i'm not going to use it anyway
-				if (track->track_type == TRACK_TYPE_SSA)
-					target->OutlineColour = target->BackColour;
-			FPVAL(FontSize)
-			INTVAL(Bold)
-			INTVAL(Italic)
-			INTVAL(Underline)
-			INTVAL(StrikeOut)
-			FPVAL(Spacing)
-			INTVAL(Angle)
-			INTVAL(BorderStyle)
-			INTVAL(Alignment)
-				if (track->track_type == TRACK_TYPE_ASS)
-					target->Alignment = numpad2align(target->Alignment);
-			INTVAL(MarginL)
-			INTVAL(MarginR)
-			INTVAL(MarginV)
-			INTVAL(Encoding)
-			FPVAL(ScaleX)
-			FPVAL(ScaleY)
-			FPVAL(Outline)
-			FPVAL(Shadow)
-		}
-	}
-	style->ScaleX /= 100.;
-	style->ScaleY /= 100.;
-	style->Bold = !!style->Bold;
-	style->Italic = !!style->Italic;
-	style->Underline = !!style->Underline;
-	if (!style->Name)
-		style->Name = strdup("Default");
-	if (!style->FontName)
-		style->FontName = strdup("Arial");
-	free(format);
-	return 0;
-	
-}
-
-static int process_styles_line(ass_track_t* track, char *str)
-{
-	if (!strncmp(str,"Format:", 7)) {
-		char* p = str + 7;
-		skip_spaces(&p);
-		track->style_format = strdup(p);
-		mp_msg(MSGT_ASS, MSGL_DBG2, "Style format: %s\n", track->style_format);
-	} else if (!strncmp(str,"Style:", 6)) {
-		char* p = str + 6;
-		skip_spaces(&p);
-		process_style(track, p);
-	}
-	return 0;
-}
-
-static int process_info_line(ass_track_t* track, char *str)
-{
-	if (!strncmp(str, "PlayResX:", 9)) {
-		track->PlayResX = atoi(str + 9);
-	} else if (!strncmp(str,"PlayResY:", 9)) {
-		track->PlayResY = atoi(str + 9);
-	} else if (!strncmp(str,"Timer:", 6)) {
-		track->Timer = atof(str + 6);
-	} else if (!strncmp(str,"WrapStyle:", 10)) {
-		track->WrapStyle = atoi(str + 10);
-	}
-	return 0;
-}
-
-static int process_events_line(ass_track_t* track, char *str)
-{
-	if (!strncmp(str, "Format:", 7)) {
-		char* p = str + 7;
-		skip_spaces(&p);
-		track->event_format = strdup(p);
-		mp_msg(MSGT_ASS, MSGL_DBG2, "Event format: %s\n", track->event_format);
-	} else if (!strncmp(str, "Dialogue:", 9)) {
-		// This should never be reached for embedded subtitles.
-		// They have slightly different format and are parsed in ass_process_chunk,
-		// called directly from demuxer
-		int eid;
-		ass_event_t* event;
-		
-		str += 9;
-		skip_spaces(&str);
-
-		eid = ass_alloc_event(track);
-		event = track->events + eid;
-
-		process_event_tail(track, event, str, 0);
-	} else {
-		mp_msg(MSGT_ASS, MSGL_V, "Not understood: %s  \n", str);
-	}
-	return 0;
-}
-
-// Copied from mkvtoolnix
-static unsigned char* decode_chars(unsigned char c1, unsigned char c2,
-		unsigned char c3, unsigned char c4, unsigned char* dst, int cnt)
-{
-	uint32_t value;
-	unsigned char bytes[3];
-	int i;
-
-	value = ((c1 - 33) << 18) + ((c2 - 33) << 12) + ((c3 - 33) << 6) + (c4 - 33);
-	bytes[2] = value & 0xff;
-	bytes[1] = (value & 0xff00) >> 8;
-	bytes[0] = (value & 0xff0000) >> 16;
-
-	for (i = 0; i < cnt; ++i)
-		*dst++ = bytes[i];
-	return dst;
-}
-
-static int decode_font(ass_track_t* track)
-{
-	unsigned char* p;
-	unsigned char* q;
-	int i;
-	int size; // original size
-	int dsize; // decoded size
-	unsigned char* buf = 0;
-
-	mp_msg(MSGT_ASS, MSGL_V, "font: %d bytes encoded data \n", track->parser_priv->fontdata_used);
-	size = track->parser_priv->fontdata_used;
-	if (size % 4 == 1) {
-		mp_msg(MSGT_ASS, MSGL_ERR, MSGTR_LIBASS_BadEncodedDataSize);
-		goto error_decode_font;
-	}
-	buf = malloc(size / 4 * 3 + 2);
-	q = buf;
-	for (i = 0, p = (unsigned char*)track->parser_priv->fontdata; i < size / 4; i++, p+=4) {
-		q = decode_chars(p[0], p[1], p[2], p[3], q, 3);
-	}
-	if (size % 4 == 2) {
-		q = decode_chars(p[0], p[1], 0, 0, q, 1);
-	} else if (size % 4 == 3) {
-		q = decode_chars(p[0], p[1], p[2], 0, q, 2);
-	}
-	dsize = q - buf;
-	assert(dsize <= size / 4 * 3 + 2);
-	
-	if (track->library->extract_fonts) {
-		ass_add_font(track->library, track->parser_priv->fontname, (char*)buf, dsize);
-		buf = 0;
-	}
-
-error_decode_font:
-	if (buf) free(buf);
-	free(track->parser_priv->fontname);
-	free(track->parser_priv->fontdata);
-	track->parser_priv->fontname = 0;
-	track->parser_priv->fontdata = 0;
-	track->parser_priv->fontdata_size = 0;
-	track->parser_priv->fontdata_used = 0;
-	return 0;
-}
-
-static int process_fonts_line(ass_track_t* track, char *str)
-{
-	int len;
-
-	if (!strncmp(str, "fontname:", 9)) {
-		char* p = str + 9;
-		skip_spaces(&p);
-		if (track->parser_priv->fontname) {
-			decode_font(track);
-		}
-		track->parser_priv->fontname = strdup(p);
-		mp_msg(MSGT_ASS, MSGL_V, "fontname: %s\n", track->parser_priv->fontname);
-		return 0;
-	}
-	
-	if (!track->parser_priv->fontname) {
-		mp_msg(MSGT_ASS, MSGL_V, "Not understood: %s  \n", str);
-		return 0;
-	}
-
-	len = strlen(str);
-	if (len > 80) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FontLineTooLong, len, str);
-		return 0;
-	}
-	if (track->parser_priv->fontdata_used + len > track->parser_priv->fontdata_size) {
-		track->parser_priv->fontdata_size += 100 * 1024;
-		track->parser_priv->fontdata = realloc(track->parser_priv->fontdata, track->parser_priv->fontdata_size);
-	}
-	memcpy(track->parser_priv->fontdata + track->parser_priv->fontdata_used, str, len);
-	track->parser_priv->fontdata_used += len;
-	
-	return 0;
-}
-
-/**
- * \brief Parse a header line
- * \param track track
- * \param str string to parse, zero-terminated
-*/ 
-static int process_line(ass_track_t* track, char *str)
-{
-	if (strstr(str, "[Script Info]")) { // FIXME: strstr to skip possible BOM at the beginning of the script
-		track->parser_priv->state = PST_INFO;
-	} else if (!strncmp(str, "[V4 Styles]", 11)) {
-		track->parser_priv->state = PST_STYLES;
-		track->track_type = TRACK_TYPE_SSA;
-	} else if (!strncmp(str, "[V4+ Styles]", 12)) {
-		track->parser_priv->state = PST_STYLES;
-		track->track_type = TRACK_TYPE_ASS;
-	} else if (!strncmp(str, "[Events]", 8)) {
-		track->parser_priv->state = PST_EVENTS;
-	} else if (!strncmp(str, "[Fonts]", 7)) {
-		track->parser_priv->state = PST_FONTS;
-	} else {
-		switch (track->parser_priv->state) {
-		case PST_INFO:
-			process_info_line(track, str);
-			break;
-		case PST_STYLES:
-			process_styles_line(track, str);
-			break;
-		case PST_EVENTS:
-			process_events_line(track, str);
-			break;
-		case PST_FONTS:
-			process_fonts_line(track, str);
-			break;
-		default:
-			break;
-		}
-	}
-
-	// there is no explicit end-of-font marker in ssa/ass
-	if ((track->parser_priv->state != PST_FONTS) && (track->parser_priv->fontname))
-		decode_font(track);
-
-	return 0;
-}
-
-static int process_text(ass_track_t* track, char* str)
-{
-	char* p = str;
-	while(1) {
-		char* q;
-		for (;((*p=='\r')||(*p=='\n'));++p) {}
-		for (q=p; ((*q!='\0')&&(*q!='\r')&&(*q!='\n')); ++q) {};
-		if (q==p)
-			break;
-		if (*q != '\0')
-			*(q++) = '\0';
-		process_line(track, p);
-		if (*q == '\0')
-			break;
-		p = q;
-	}
-	return 0;
-}
-
-/**
- * \brief Process CodecPrivate section of subtitle stream
- * \param track track
- * \param data string to parse
- * \param size length of data
- CodecPrivate section contains [Stream Info] and [V4+ Styles] ([V4 Styles] for SSA) sections
-*/ 
-void ass_process_codec_private(ass_track_t* track, char *data, int size)
-{
-	char* str = malloc(size + 1);
-
-	memcpy(str, data, size);
-	str[size] = '\0';
-
-	process_text(track, str);
-	free(str);
-
-	if (!track->event_format) {
-		// probably an mkv produced by ancient mkvtoolnix
-		// such files don't have [Events] and Format: headers
-		track->parser_priv->state = PST_EVENTS;
-		if (track->track_type == TRACK_TYPE_SSA)
-			track->event_format = strdup("Format: Marked, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text");
-		else
-			track->event_format = strdup("Format: Layer, Start, End, Style, Actor, MarginL, MarginR, MarginV, Effect, Text");
-	}
-
-	process_force_style(track);
-}
-
-static int check_duplicate_event(ass_track_t* track, int ReadOrder)
-{
-	int i;
-	for (i = 0; i<track->n_events - 1; ++i) // ignoring last event, it is the one we are comparing with
-		if (track->events[i].ReadOrder == ReadOrder)
-			return 1;
-	return 0;
-}
-
-/**
- * \brief Process a chunk of subtitle stream data. In matroska, this containes exactly 1 event (or a commentary)
- * \param track track
- * \param data string to parse
- * \param size length of data
- * \param timecode starting time of the event (milliseconds)
- * \param duration duration of the event (milliseconds)
-*/ 
-void ass_process_chunk(ass_track_t* track, char *data, int size, long long timecode, long long duration)
-{
-	char* str;
-	int eid;
-	char* p;
-	char* token;
-	ass_event_t* event;
-
-	if (!track->event_format) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_EventFormatHeaderMissing);
-		return;
-	}
-	
-	str = malloc(size + 1);
-	memcpy(str, data, size);
-	str[size] = '\0';
-	mp_msg(MSGT_ASS, MSGL_V, "event at %" PRId64 ", +%" PRId64 ": %s  \n", (int64_t)timecode, (int64_t)duration, str);
-
-	eid = ass_alloc_event(track);
-	event = track->events + eid;
-
-	p = str;
-	
-	do { 
-		NEXT(p, token);
-		event->ReadOrder = atoi(token);
-		if (check_duplicate_event(track, event->ReadOrder))
-			break;
-
-		NEXT(p, token);
-		event->Layer = atoi(token);
-
-		process_event_tail(track, event, p, 3);
-
-		event->Start = timecode;
-		event->Duration = duration;
-		
-		free(str);
-		return;
-//		dump_events(tid);
-	} while (0);
-	// some error
-	ass_free_event(track, eid);
-	track->n_events--;
-	free(str);
-}
-
-#ifdef USE_ICONV
-/** \brief recode buffer to utf-8
- * constraint: codepage != 0
- * \param data pointer to text buffer
- * \param size buffer size
- * \return a pointer to recoded buffer, caller is responsible for freeing it
-**/
-static char* sub_recode(char* data, size_t size, char* codepage)
-{
-	static iconv_t icdsc = (iconv_t)(-1);
-	char* tocp = "UTF-8";
-	char* outbuf;
-	assert(codepage);
-
-	{
-		char* cp_tmp = codepage ? strdup(codepage) : 0;
-#ifdef HAVE_ENCA
-		char enca_lang[3], enca_fallback[100];
-		if (sscanf(codepage, "enca:%2s:%99s", enca_lang, enca_fallback) == 2
-				|| sscanf(codepage, "ENCA:%2s:%99s", enca_lang, enca_fallback) == 2) {
-			cp_tmp = guess_buffer_cp((unsigned char*)data, size, enca_lang, enca_fallback);
-		}
-#endif
-		if ((icdsc = iconv_open (tocp, cp_tmp)) != (iconv_t)(-1)){
-			mp_msg(MSGT_ASS,MSGL_V,"LIBSUB: opened iconv descriptor.\n");
-		} else
-			mp_msg(MSGT_ASS,MSGL_ERR,MSGTR_LIBASS_ErrorOpeningIconvDescriptor);
-#ifdef HAVE_ENCA
-		if (cp_tmp) free(cp_tmp);
-#endif
-	}
-
-	{
-		size_t osize = size;
-		size_t ileft = size;
-		size_t oleft = size - 1;
-		char* ip;
-		char* op;
-		size_t rc;
-		
-		outbuf = malloc(size);
-		ip = data;
-		op = outbuf;
-		
-		while (ileft) {
-			rc = iconv(icdsc, &ip, &ileft, &op, &oleft);
-			if (rc == (size_t)(-1)) {
-				if (errno == E2BIG) {
-					int offset = op - outbuf;
-					outbuf = (char*)realloc(outbuf, osize + size);
-					op = outbuf + offset;
-					osize += size;
-					oleft += size;
-				} else {
-					mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorRecodingFile);
-					return NULL;
-				}
-			}
-		}
-		outbuf[osize - oleft - 1] = 0;
-	}
-
-	if (icdsc != (iconv_t)(-1)) {
-		(void)iconv_close(icdsc);
-		icdsc = (iconv_t)(-1);
-		mp_msg(MSGT_ASS,MSGL_V,"LIBSUB: closed iconv descriptor.\n");
-	}
-	
-	return outbuf;
-}
-#endif // ICONV
-
-/**
- * \brief read file contents into newly allocated buffer
- * \param fname file name
- * \param bufsize out: file size
- * \return pointer to file contents. Caller is responsible for its deallocation.
- */
-static char* read_file(char* fname, size_t *bufsize)
-{
-	int res;
-	long sz;
-	long bytes_read;
-	char* buf;
-
-	FILE* fp = fopen(fname, "rb");
-	if (!fp) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FopenFailed, fname);
-		return 0;
-	}
-	res = fseek(fp, 0, SEEK_END);
-	if (res == -1) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FseekFailed, fname);
-		fclose(fp);
-		return 0;
-	}
-	
-	sz = ftell(fp);
-	rewind(fp);
-
-	if (sz > 10*1024*1024) {
-		mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_RefusingToLoadSubtitlesLargerThan10M, fname);
-		fclose(fp);
-		return 0;
-	}
-	
-	mp_msg(MSGT_ASS, MSGL_V, "file size: %ld\n", sz);
-	
-	buf = malloc(sz + 1);
-	assert(buf);
-	bytes_read = 0;
-	do {
-		res = fread(buf + bytes_read, 1, sz - bytes_read, fp);
-		if (res <= 0) {
-			mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_ReadFailed, errno, strerror(errno));
-			fclose(fp);
-			free(buf);
-			return 0;
-		}
-		bytes_read += res;
-	} while (sz - bytes_read > 0);
-	buf[sz] = '\0';
-	fclose(fp);
-	
-	if (bufsize)
-		*bufsize = sz;
-	return buf;
-}
-
-/*
- * \param buf pointer to subtitle text in utf-8
- */
-static ass_track_t* parse_memory(ass_library_t* library, char* buf)
-{
-	ass_track_t* track;
-	int i;
-	
-	track = ass_new_track(library);
-	
-	// process header
-	process_text(track, buf);
-
-	// external SSA/ASS subs does not have ReadOrder field
-	for (i = 0; i < track->n_events; ++i)
-		track->events[i].ReadOrder = i;
-
-	// there is no explicit end-of-font marker in ssa/ass
-	if (track->parser_priv->fontname)
-		decode_font(track);
-
-	if (track->track_type == TRACK_TYPE_UNKNOWN) {
-		ass_free_track(track);
-		return 0;
-	}
-
-	process_force_style(track);
-
-	return track;
-}
-
-/**
- * \brief Read subtitles from memory.
- * \param library libass library object
- * \param buf pointer to subtitles text
- * \param bufsize size of buffer
- * \param codepage recode buffer contents from given codepage
- * \return newly allocated track
-*/ 
-ass_track_t* ass_read_memory(ass_library_t* library, char* buf, size_t bufsize, char* codepage)
-{
-	ass_track_t* track;
-	int need_free = 0;
-	
-	if (!buf)
-		return 0;
-	
-#ifdef USE_ICONV
-	if (codepage)
-		buf = sub_recode(buf, bufsize, codepage);
-	if (!buf)
-		return 0;
-	else
-		need_free = 1;
-#endif
-	track = parse_memory(library, buf);
-	if (need_free)
-		free(buf);
-	if (!track)
-		return 0;
-
-	mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_AddedSubtitleFileMemory, track->n_styles, track->n_events);
-	return track;
-}
-
-char* read_file_recode(char* fname, char* codepage, int* size)
-{
-	char* buf;
-	size_t bufsize;
-	
-	buf = read_file(fname, &bufsize);
-	if (!buf)
-		return 0;
-#ifdef USE_ICONV
-	if (codepage) {
-		 char* tmpbuf = sub_recode(buf, bufsize, codepage);
-		 free(buf);
-		 buf = tmpbuf;
-	}
-	if (!buf)
-		return 0;
-#endif
-	*size = bufsize;
-	return buf;
-}
-
-/**
- * \brief Read subtitles from file.
- * \param library libass library object
- * \param fname file name
- * \param codepage recode buffer contents from given codepage
- * \return newly allocated track
-*/ 
-ass_track_t* ass_read_file(ass_library_t* library, char* fname, char* codepage)
-{
-	char* buf;
-	ass_track_t* track;
-	size_t bufsize;
-
-	buf = read_file_recode(fname, codepage, &bufsize);
-	if (!buf)
-		return 0;
-	track = parse_memory(library, buf);
-	free(buf);
-	if (!track)
-		return 0;
-	
-	track->name = strdup(fname);
-
-	mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_AddedSubtitleFileFname, fname, track->n_styles, track->n_events);
-	
-//	dump_events(forced_tid);
-	return track;
-}
-
-/**
- * \brief read styles from file into already initialized track
- */
-int ass_read_styles(ass_track_t* track, char* fname, char* codepage)
-{
-	char* buf;
-	parser_state_t old_state;
-	size_t sz;
-
-	buf = read_file(fname, &sz);
-	if (!buf)
-		return 1;
-#ifdef USE_ICONV
-	if (codepage) {
-		char* tmpbuf;
-		tmpbuf = sub_recode(buf, sz, codepage);
-		free(buf);
-		buf = tmpbuf;
-	}
-	if (!buf)
-		return 0;
-#endif
-
-	old_state = track->parser_priv->state;
-	track->parser_priv->state = PST_STYLES;
-	process_text(track, buf);
-	track->parser_priv->state = old_state;
-
-	return 0;
-}
-
-long long ass_step_sub(ass_track_t* track, long long now, int movement) {
-	int i;
-
-	if (movement == 0) return 0;
-	if (track->n_events == 0) return 0;
-	
-	if (movement < 0)
-		for (i = 0; (i < track->n_events) && ((long long)(track->events[i].Start + track->events[i].Duration) <= now); ++i) {}
-	else
-		for (i = track->n_events - 1; (i >= 0) && ((long long)(track->events[i].Start) > now); --i) {}
-	
-	// -1 and n_events are ok
-	assert(i >= -1); assert(i <= track->n_events);
-	i += movement;
-	if (i < 0) i = 0;
-	if (i >= track->n_events) i = track->n_events - 1;
-	return ((long long)track->events[i].Start) - now;
-}
-
-ass_track_t* ass_new_track(ass_library_t* library) {
-	ass_track_t* track = calloc(1, sizeof(ass_track_t));
-	track->library = library;
-	track->parser_priv = calloc(1, sizeof(parser_priv_t));
-	return track;
-}
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,209 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#ifndef ASS_H
-#define ASS_H
-
-#include "ass_types.h"
-
-/// Libass renderer object. Contents are private.
-typedef struct ass_renderer_s ass_renderer_t;
-
-/// a linked list of images produced by ass renderer
-typedef struct ass_image_s {
-	int w, h; // bitmap width/height
-	int stride; // bitmap stride
-	unsigned char* bitmap; // 1bpp stride*h alpha buffer
-	uint32_t color; // RGBA
-	int dst_x, dst_y; // bitmap placement inside the video frame
-
-	struct ass_image_s* next; // linked list
-} ass_image_t;
-
-/// Hinting type
-typedef enum {ASS_HINTING_NONE = 0,
-	      ASS_HINTING_LIGHT,
-	      ASS_HINTING_NORMAL,
-	      ASS_HINTING_NATIVE
-} ass_hinting_t;
-
-/**
- * \brief initialize the library
- * \return library handle or NULL if failed
- */
-ass_library_t* ass_library_init(void);
-
-/**
- * \brief finalize the library
- * \param priv library handle
- */
-void ass_library_done(ass_library_t*);
-
-/**
- * \brief set private font directory
- * It is used for saving embedded fonts and also in font lookup.
- */
-void ass_set_fonts_dir(ass_library_t* priv, const char* fonts_dir);
-
-void ass_set_extract_fonts(ass_library_t* priv, int extract);
-
-void ass_set_style_overrides(ass_library_t* priv, char** list);
-
-/**
- * \brief initialize the renderer
- * \param priv library handle
- * \return renderer handle or NULL if failed
- */
-ass_renderer_t* ass_renderer_init(ass_library_t*);
-
-/**
- * \brief finalize the renderer
- * \param priv renderer handle
- */
-void ass_renderer_done(ass_renderer_t* priv);
-
-void ass_set_frame_size(ass_renderer_t* priv, int w, int h);
-void ass_set_margins(ass_renderer_t* priv, int t, int b, int l, int r);
-void ass_set_use_margins(ass_renderer_t* priv, int use);
-void ass_set_aspect_ratio(ass_renderer_t* priv, double ar);
-void ass_set_font_scale(ass_renderer_t* priv, double font_scale);
-void ass_set_hinting(ass_renderer_t* priv, ass_hinting_t ht);
-void ass_set_line_spacing(ass_renderer_t* priv, double line_spacing);
-
-/**
- * \brief set font lookup defaults
- */
-int  ass_set_fonts(ass_renderer_t* priv, const char* default_font, const char* default_family);
-
-/**
- * \brief render a frame, producing a list of ass_image_t
- * \param priv library
- * \param track subtitle track
- * \param now video timestamp in milliseconds
- */
-ass_image_t* ass_render_frame(ass_renderer_t *priv, ass_track_t* track, long long now, int* detect_change);
-
-
-// The following functions operate on track objects and do not need an ass_renderer //
-
-/**
- * \brief allocate a new empty track object
- * \return pointer to empty track
- */
-ass_track_t* ass_new_track(ass_library_t*);
-
-/**
- * \brief deallocate track and all its child objects (styles and events)
- * \param track track to deallocate
- */
-void ass_free_track(ass_track_t* track);
-
-/**
- * \brief allocate new style
- * \param track track
- * \return newly allocated style id
- */
-int ass_alloc_style(ass_track_t* track);
-
-/**
- * \brief allocate new event
- * \param track track
- * \return newly allocated event id
- */
-int ass_alloc_event(ass_track_t* track);
-
-/**
- * \brief delete a style
- * \param track track
- * \param sid style id
- * Deallocates style data. Does not modify track->n_styles.
- */
-void ass_free_style(ass_track_t* track, int sid);
-
-/**
- * \brief delete an event
- * \param track track
- * \param eid event id
- * Deallocates event data. Does not modify track->n_events.
- */
-void ass_free_event(ass_track_t* track, int eid);
-
-/**
- * \brief Process Codec Private section of subtitle stream
- * \param track target track
- * \param data string to parse
- * \param size length of data
- */
-void ass_process_codec_private(ass_track_t* track, char *data, int size);
-
-/**
- * \brief Process a chunk of subtitle stream data. In matroska, this containes exactly 1 event (or a commentary)
- * \param track track
- * \param data string to parse
- * \param size length of data
- * \param timecode starting time of the event (milliseconds)
- * \param duration duration of the event (milliseconds)
-*/
-void ass_process_chunk(ass_track_t* track, char *data, int size, long long timecode, long long duration);
-
-char* read_file_recode(char* fname, char* codepage, int* size);
-
-/**
- * \brief Read subtitles from file.
- * \param fname file name
- * \return newly allocated track
-*/
-ass_track_t* ass_read_file(ass_library_t* library, char* fname, char* codepage);
-
-/**
- * \brief Read subtitles from memory.
- * \param library libass library object
- * \param buf pointer to subtitles text
- * \param bufsize size of buffer
- * \param codepage recode buffer contents from given codepage
- * \return newly allocated track
-*/ 
-ass_track_t* ass_read_memory(ass_library_t* library, char* buf, size_t bufsize, char* codepage);
-/**
- * \brief read styles from file into already initialized track
- * \return 0 on success
- */
-int ass_read_styles(ass_track_t* track, char* fname, char* codepage);
-
-/**
- * \brief Add a memory font.
- * \param name attachment name
- * \param data binary font data
- * \param data_size data size
-*/
-void ass_add_font(ass_library_t* library, char* name, char* data, int data_size);
-
-/**
- * \brief Calculates timeshift from now to the start of some other subtitle event, depending on movement parameter
- * \param track subtitle track
- * \param now current time, ms
- * \param movement how many events to skip from the one currently displayed
- * +2 means "the one after the next", -1 means "previous"
- * \return timeshift, ms
- */
-long long ass_step_sub(ass_track_t* track, long long now, int movement);
-
-#endif
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_bitmap.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_bitmap.c	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_bitmap.c	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,272 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#include <stdlib.h>
-#include <string.h>
-#include <math.h>
-#include <assert.h>
-#include <ft2build.h>
-#include FT_GLYPH_H
-
-#include "mputils.h"
-#include "ass_bitmap.h"
-
-struct ass_synth_priv_s {
-	int tmp_w, tmp_h;
-	unsigned short* tmp;
-
-	int g_r;
-	int g_w;
-
-	unsigned *g;
-	unsigned *gt2;
-};
-
-static const unsigned int maxcolor = 255;
-static const unsigned base = 256;
-static const double blur_radius = 1.5;
-
-static int generate_tables(ass_synth_priv_t* priv, double radius)
-{
-	double A = log(1.0/base)/(radius*radius*2);
-	int mx, i;
-	double volume_diff, volume_factor = 0;
-	unsigned volume;
-
-	priv->g_r = ceil(radius);
-	priv->g_w = 2*priv->g_r+1;
-
-	if (priv->g_r) {
-		priv->g = malloc(priv->g_w * sizeof(unsigned));
-		priv->gt2 = malloc(256 * priv->g_w * sizeof(unsigned));
-		if (priv->g==NULL || priv->gt2==NULL) {
-			return -1;
-		}
-	}
-
-	if (priv->g_r) {
-		// gaussian curve with volume = 256
-		for (volume_diff=10000000; volume_diff>0.0000001; volume_diff*=0.5){
-			volume_factor+= volume_diff;
-			volume=0;
-			for (i = 0; i<priv->g_w; ++i) {
-				priv->g[i] = (unsigned)(exp(A * (i-priv->g_r)*(i-priv->g_r)) * volume_factor + .5);
-				volume+= priv->g[i];
-			}
-			if(volume>256) volume_factor-= volume_diff;
-		}
-		volume=0;
-		for (i = 0; i<priv->g_w; ++i) {
-			priv->g[i] = (unsigned)(exp(A * (i-priv->g_r)*(i-priv->g_r)) * volume_factor + .5);
-			volume+= priv->g[i];
-		}
-
-		// gauss table:
-		for(mx=0;mx<priv->g_w;mx++){
-			for(i=0;i<256;i++){
-				priv->gt2[mx+i*priv->g_w] = i*priv->g[mx];
-			}
-		}
-	}
-
-	return 0;
-}
-
-static void resize_tmp(ass_synth_priv_t* priv, int w, int h)
-{
-	if (priv->tmp_w >= w && priv->tmp_h >= h)
-		return;
-	if (priv->tmp_w == 0)
-		priv->tmp_w = 64;
-	if (priv->tmp_h == 0)
-		priv->tmp_h = 64;
-	while (priv->tmp_w < w) priv->tmp_w *= 2;
-	while (priv->tmp_h < h) priv->tmp_h *= 2;
-	if (priv->tmp)
-		free(priv->tmp);
-	priv->tmp = malloc((priv->tmp_w + 1) * priv->tmp_h * sizeof(short));
-}
-
-ass_synth_priv_t* ass_synth_init(void)
-{
-	ass_synth_priv_t* priv = calloc(1, sizeof(ass_synth_priv_t));
-	generate_tables(priv, blur_radius);
-	return priv;
-}
-
-void ass_synth_done(ass_synth_priv_t* priv)
-{
-	if (priv->tmp)
-		free(priv->tmp);
-	if (priv->g)
-		free(priv->g);
-	if (priv->gt2)
-		free(priv->gt2);
-	free(priv);
-}
-
-static bitmap_t* alloc_bitmap(int w, int h)
-{
-	bitmap_t* bm;
-	bm = calloc(1, sizeof(bitmap_t));
-	bm->buffer = malloc(w*h);
-	bm->w = w;
-	bm->h = h;
-	bm->left = bm->top = 0;
-	return bm;
-}
-
-void ass_free_bitmap(bitmap_t* bm)
-{
-	if (bm) {
-		if (bm->buffer) free(bm->buffer);
-		free(bm);
-	}
-}
-
-static bitmap_t* copy_bitmap(const bitmap_t* src)
-{
-	bitmap_t* dst = alloc_bitmap(src->w, src->h);
-	dst->left = src->left;
-	dst->top = src->top;
-	memcpy(dst->buffer, src->buffer, src->w * src->h);
-	return dst;
-}
-
-static bitmap_t* glyph_to_bitmap_internal(FT_Glyph glyph, int bord)
-{
-	FT_BitmapGlyph bg;
-	FT_Bitmap* bit;
-	bitmap_t* bm;
-	int w, h;
-	unsigned char* src;
-	unsigned char* dst;
-	int i;
-	int error;
-
-	error = FT_Glyph_To_Bitmap(&glyph, FT_RENDER_MODE_NORMAL, 0, 0);
-	if (error) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FT_Glyph_To_BitmapError, error);
-		return 0;
-	}
-
-	bg = (FT_BitmapGlyph)glyph;
-	bit = &(bg->bitmap);
-	if (bit->pixel_mode != FT_PIXEL_MODE_GRAY) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_UnsupportedPixelMode, (int)(bit->pixel_mode));
-		FT_Done_Glyph(glyph);
-		return 0;
-	}
-
-	w = bit->width;
-	h = bit->rows;
-	bm = alloc_bitmap(w + 2*bord, h + 2*bord);
-	memset(bm->buffer, 0, bm->w * bm->h);
-	bm->left = bg->left - bord;
-	bm->top = - bg->top - bord;
-
-	src = bit->buffer;
-	dst = bm->buffer + bord + bm->w * bord;
-	for (i = 0; i < h; ++i) {
-		memcpy(dst, src, w);
-		src += bit->pitch;
-		dst += bm->w;
-	}
-
-	return bm;
-}
-
-/**
- * \brief fix outline bitmap and generate shadow bitmap
- * Two things are done here:
- * 1. Glyph bitmap is subtracted from outline bitmap. This way looks much better in some cases.
- * 2. Shadow bitmap is created as a sum of glyph and outline bitmaps.
- */
-static bitmap_t* fix_outline_and_shadow(bitmap_t* bm_g, bitmap_t* bm_o)
-{
-	int x, y;
-	const int l = bm_o->left > bm_g->left ? bm_o->left : bm_g->left;
-	const int t = bm_o->top > bm_g->top ? bm_o->top : bm_g->top;
-	const int r = bm_o->left + bm_o->w < bm_g->left + bm_g->w ? bm_o->left + bm_o->w : bm_g->left + bm_g->w;
-	const int b = bm_o->top + bm_o->h < bm_g->top + bm_g->h ? bm_o->top + bm_o->h : bm_g->top + bm_g->h;
-
-	bitmap_t* bm_s = copy_bitmap(bm_o);
-
-	unsigned char* g = bm_g->buffer + (t - bm_g->top) * bm_g->w + (l - bm_g->left);
-	unsigned char* o = bm_o->buffer + (t - bm_o->top) * bm_o->w + (l - bm_o->left);
-	unsigned char* s = bm_s->buffer + (t - bm_s->top) * bm_s->w + (l - bm_s->left);
-	
-	for (y = 0; y < b - t; ++y) {
-		for (x = 0; x < r - l; ++x) {
-			unsigned char c_g, c_o;
-			c_g = g[x];
-			c_o = o[x];
-			o[x] = (c_o > c_g) ? c_o : 0;
-			s[x] = (c_o < 0xFF - c_g) ? c_o + c_g : 0xFF;
-		}
-		g += bm_g->w;
-		o += bm_o->w;
-		s += bm_s->w;
-	}
-
-	assert(bm_s);
-	return bm_s;
-}
-
-int glyph_to_bitmap(ass_synth_priv_t* priv, FT_Glyph glyph, FT_Glyph outline_glyph,
-		bitmap_t** bm_g, bitmap_t** bm_o, bitmap_t** bm_s, int be)
-{
-	const int bord = be ? ceil(blur_radius) : 0;
-
-	assert(bm_g && bm_o && bm_s);
-
-	*bm_g = *bm_o = *bm_s = 0;
-
-	if (glyph)
-		*bm_g = glyph_to_bitmap_internal(glyph, bord);
-	if (!*bm_g)
-		return 1;
-
-	if (outline_glyph) {
-		*bm_o = glyph_to_bitmap_internal(outline_glyph, bord);
-		if (!*bm_o) {
-			ass_free_bitmap(*bm_g);
-			return 1;
-		}
-	}
-	if (*bm_o)
-		resize_tmp(priv, (*bm_o)->w, (*bm_o)->h);
-	resize_tmp(priv, (*bm_g)->w, (*bm_g)->h);
-	
-	if (be) {
-		blur((*bm_g)->buffer, priv->tmp, (*bm_g)->w, (*bm_g)->h, (*bm_g)->w, (int*)priv->gt2, priv->g_r, priv->g_w);
-		if (*bm_o)
-			blur((*bm_o)->buffer, priv->tmp, (*bm_o)->w, (*bm_o)->h, (*bm_o)->w, (int*)priv->gt2, priv->g_r, priv->g_w);
-	}
-
-	if (*bm_o)
-		*bm_s = fix_outline_and_shadow(*bm_g, *bm_o);
-	else
-		*bm_s = copy_bitmap(*bm_g);
-
-	assert(bm_s);
-	return 0;
-}
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_bitmap.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_bitmap.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_bitmap.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,49 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#ifndef ASS_BITMAP_H
-#define ASS_BITMAP_H
-
-typedef struct ass_synth_priv_s ass_synth_priv_t;
-
-ass_synth_priv_t* ass_synth_init(void);
-void ass_synth_done(ass_synth_priv_t* priv);
-
-typedef struct bitmap_s {
-	int left, top;
-	int w, h; // width, height
-	unsigned char* buffer; // w x h buffer
-} bitmap_t;
-
-/**
- * \brief perform glyph rendering
- * \param glyph original glyph
- * \param outline_glyph "border" glyph, produced from original by FreeType's glyph stroker
- * \param bm_g out: pointer to the bitmap of original glyph is returned here
- * \param bm_o out: pointer to the bitmap of outline (border) glyph is returned here
- * \param bm_g out: pointer to the bitmap of glyph shadow is returned here
- * \param be 1 = produces blurred bitmaps, 0 = normal bitmaps
- */
-int glyph_to_bitmap(ass_synth_priv_t* priv, FT_Glyph glyph, FT_Glyph outline_glyph, bitmap_t** bm_g, bitmap_t** bm_o, bitmap_t** bm_s, int be);
-
-void ass_free_bitmap(bitmap_t* bm);
-
-#endif
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_cache.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_cache.c	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_cache.c	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,324 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-//#include "config.h"
-
-#include <inttypes.h>
-#include <ft2build.h>
-#include FT_FREETYPE_H
-#include FT_GLYPH_H
-
-#include <assert.h>
-
-#include "mputils.h"
-#include "ass.h"
-#include "ass_fontconfig.h"
-#include "ass_font.h"
-#include "ass_bitmap.h"
-#include "ass_cache.h"
-
-
-typedef struct hashmap_item_s {
-	void* key;
-	void* value;
-	struct hashmap_item_s* next;
-} hashmap_item_t;
-typedef hashmap_item_t* hashmap_item_p;
-
-struct hashmap_s {
-	int nbuckets;
-	size_t key_size, value_size;
-	hashmap_item_p* root;
-	hashmap_item_dtor_t item_dtor; // a destructor for hashmap key/value pairs
-	hashmap_key_compare_t key_compare;
-	hashmap_hash_t hash;
-	// stats
-	int hit_count;
-	int miss_count;
-	int count;
-};
-
-#define FNV1_32A_INIT (unsigned)0x811c9dc5
-
-static inline unsigned fnv_32a_buf(void* buf, size_t len, unsigned hval)
-{
-	unsigned char *bp = buf;
-	unsigned char *be = bp + len;
-	while (bp < be) {
-		hval ^= (unsigned)*bp++;
-		hval += (hval<<1) + (hval<<4) + (hval<<7) + (hval<<8) + (hval<<24);
-	}
-	return hval;
-}
-static inline unsigned fnv_32a_str(char* str, unsigned hval)
-{
-	unsigned char* s = (unsigned char*)str;
-	while (*s) {
-		hval ^= (unsigned)*s++;
-		hval += (hval<<1) + (hval<<4) + (hval<<7) + (hval<<8) + (hval<<24);
-	}
-	return hval;
-}
-
-static unsigned hashmap_hash(void* buf, size_t len)
-{
-	return fnv_32a_buf(buf, len, FNV1_32A_INIT);
-}
-
-static int hashmap_key_compare(void* a, void* b, size_t size)
-{
-	return (memcmp(a, b, size) == 0);
-}
-
-static void hashmap_item_dtor(void* key, size_t key_size, void* value, size_t value_size)
-{
-	free(key);
-	free(value);
-}
-
-hashmap_t* hashmap_init(size_t key_size, size_t value_size, int nbuckets,
-			hashmap_item_dtor_t item_dtor, hashmap_key_compare_t key_compare,
-			hashmap_hash_t hash)
-{
-	hashmap_t* map = calloc(1, sizeof(hashmap_t));
-	map->nbuckets = nbuckets;
-	map->key_size = key_size;
-	map->value_size = value_size;
-	map->root = calloc(nbuckets, sizeof(hashmap_item_p));
-	map->item_dtor = item_dtor ? item_dtor : hashmap_item_dtor;
-	map->key_compare = key_compare ? key_compare : hashmap_key_compare;
-	map->hash = hash ? hash : hashmap_hash;
-	return map;
-}
-
-void hashmap_done(hashmap_t* map)
-{
-	int i;
-	// print stats
-	if (map->count > 0 || map->hit_count + map->miss_count > 0)
-		mp_msg(MSGT_ASS, MSGL_V, "cache statistics: \n  total accesses: %d\n  hits: %d\n  misses: %d\n  object count: %d\n",
-		       map->hit_count + map->miss_count, map->hit_count, map->miss_count, map->count);
-	
-	for (i = 0; i < map->nbuckets; ++i) {
-		hashmap_item_t* item = map->root[i];
-		while (item) {
-			hashmap_item_t* next = item->next;
-			map->item_dtor(item->key, map->key_size, item->value, map->value_size);
-			free(item);
-			item = next;
-		}
-	}
-	free(map->root);
-	free(map);
-}
-
-// does nothing if key already exists
-void* hashmap_insert(hashmap_t* map, void* key, void* value)
-{
-	unsigned hash = map->hash(key, map->key_size);
-	hashmap_item_t** next = map->root + (hash % map->nbuckets);
-	while (*next) {
-		if (map->key_compare(key, (*next)->key, map->key_size))
-			return (*next)->value;
-		next = &((*next)->next);
-		assert(next);
-	}
-	(*next) = malloc(sizeof(hashmap_item_t));
-	(*next)->key = malloc(map->key_size);
-	(*next)->value = malloc(map->value_size);
-	memcpy((*next)->key, key, map->key_size);
-	memcpy((*next)->value, value, map->value_size);
-	(*next)->next = 0;
-
-	map->count ++;
-	return (*next)->value;
-}
-
-void* hashmap_find(hashmap_t* map, void* key)
-{
-	unsigned hash = map->hash(key, map->key_size);
-	hashmap_item_t* item = map->root[hash % map->nbuckets];
-	while (item) {
-		if (map->key_compare(key, item->key, map->key_size)) {
-			map->hit_count++;
-			return item->value;
-		}
-		item = item->next;
-	}
-	map->miss_count++;
-	return 0;
-}
-
-//---------------------------------
-// font cache
-
-hashmap_t* font_cache;
-
-static unsigned font_desc_hash(void* buf, size_t len)
-{
-	ass_font_desc_t* desc = buf;
-	unsigned hval;
-	hval = fnv_32a_str(desc->family, FNV1_32A_INIT);
-	hval = fnv_32a_buf(&desc->bold, sizeof(desc->bold), hval);
-	hval = fnv_32a_buf(&desc->italic, sizeof(desc->italic), hval);
-	return hval;
-}
-
-static int font_compare(void* key1, void* key2, size_t key_size) {
-	ass_font_desc_t* a = key1;
-	ass_font_desc_t* b = key2;
-	if (strcmp(a->family, b->family) != 0)
-		return 0;
-	if (a->bold != b->bold)
-		return 0;
-	if (a->italic != b->italic)
-		return 0;
-	return 1;
-}
-
-static void font_hash_dtor(void* key, size_t key_size, void* value, size_t value_size)
-{
-	ass_font_free(value);
-	free(key);
-}
-
-ass_font_t* ass_font_cache_find(ass_font_desc_t* desc)
-{
-	return hashmap_find(font_cache, desc);
-}
-
-/**
- * \brief Add a face struct to cache.
- * \param font font struct
-*/
-void* ass_font_cache_add(ass_font_t* font)
-{
-	return hashmap_insert(font_cache, &(font->desc), font);
-}
-
-void ass_font_cache_init(void)
-{
-	font_cache = hashmap_init(sizeof(ass_font_desc_t),
-				  sizeof(ass_font_t),
-				  1000,
-				  font_hash_dtor, font_compare, font_desc_hash);
-}
-
-void ass_font_cache_done(void)
-{
-	hashmap_done(font_cache);
-}
-
-//---------------------------------
-// bitmap cache
-
-hashmap_t* bitmap_cache;
-
-static void bitmap_hash_dtor(void* key, size_t key_size, void* value, size_t value_size)
-{
-	bitmap_hash_val_t* v = value;
-	if (v->bm) ass_free_bitmap(v->bm);
-	if (v->bm_o) ass_free_bitmap(v->bm_o);
-	if (v->bm_s) ass_free_bitmap(v->bm_s);
-	free(key);
-	free(value);
-}
-
-void* cache_add_bitmap(bitmap_hash_key_t* key, bitmap_hash_val_t* val)
-{
-	return hashmap_insert(bitmap_cache, key, val);
-}
-
-/**
- * \brief Get a bitmap from bitmap cache.
- * \param key hash key
- * \return requested hash val or 0 if not found
-*/ 
-bitmap_hash_val_t* cache_find_bitmap(bitmap_hash_key_t* key)
-{
-	return hashmap_find(bitmap_cache, key);
-}
-
-void ass_bitmap_cache_init(void)
-{
-	bitmap_cache = hashmap_init(sizeof(bitmap_hash_key_t),
-				   sizeof(bitmap_hash_val_t),
-				   0xFFFF + 13,
-				   bitmap_hash_dtor, NULL, NULL);
-}
-
-void ass_bitmap_cache_done(void)
-{
-	hashmap_done(bitmap_cache);
-}
-
-void ass_bitmap_cache_reset(void)
-{
-	ass_bitmap_cache_done();
-	ass_bitmap_cache_init();
-}
-
-//---------------------------------
-// glyph cache
-
-hashmap_t* glyph_cache;
-
-static void glyph_hash_dtor(void* key, size_t key_size, void* value, size_t value_size)
-{
-	glyph_hash_val_t* v = value;
-	if (v->glyph) FT_Done_Glyph(v->glyph);
-	if (v->outline_glyph) FT_Done_Glyph(v->outline_glyph);
-	free(key);
-	free(value);
-}
-
-void* cache_add_glyph(glyph_hash_key_t* key, glyph_hash_val_t* val)
-{
-	return hashmap_insert(glyph_cache, key, val);
-}
-
-/**
- * \brief Get a glyph from glyph cache.
- * \param key hash key
- * \return requested hash val or 0 if not found
-*/ 
-glyph_hash_val_t* cache_find_glyph(glyph_hash_key_t* key)
-{
-	return hashmap_find(glyph_cache, key);
-}
-
-void ass_glyph_cache_init(void)
-{
-	glyph_cache = hashmap_init(sizeof(glyph_hash_key_t),
-				   sizeof(glyph_hash_val_t),
-				   0xFFFF + 13,
-				   glyph_hash_dtor, NULL, NULL);
-}
-
-void ass_glyph_cache_done(void)
-{
-	hashmap_done(glyph_cache);
-}
-
-void ass_glyph_cache_reset(void)
-{
-	ass_glyph_cache_done();
-	ass_glyph_cache_init();
-}

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_cache.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_cache.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_cache.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,98 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#ifndef ASS_CACHE_H
-#define ASS_CACHE_H
-
-void ass_font_cache_init(void);
-ass_font_t* ass_font_cache_find(ass_font_desc_t* desc);
-void* ass_font_cache_add(ass_font_t* font);
-void ass_font_cache_done(void);
-
-
-// describes a bitmap; bitmaps with equivalents structs are considered identical
-typedef struct bitmap_hash_key_s {
-	char bitmap; // bool : true = bitmap, false = outline
-	ass_font_t* font;
-	double size; // font size
-	uint32_t ch; // character code
-	unsigned outline; // border width, 16.16 fixed point value
-	int bold, italic;
-	char be; // blur edges
-
-	unsigned scale_x, scale_y; // 16.16
-	int frx, fry, frz; // signed 16.16
-	int shift_x, shift_y; // shift vector that was added to glyph before applying rotation
-	                      // = 0, if frx = fry = frx = 0
-	                      // = (glyph base point) - (rotation origin), otherwise
-	
-	FT_Vector advance; // subpixel shift vector
-} bitmap_hash_key_t;
-
-typedef struct bitmap_hash_val_s {
-	bitmap_t* bm; // the actual bitmaps
-	bitmap_t* bm_o;
-	bitmap_t* bm_s;
-} bitmap_hash_val_t;
-
-void ass_bitmap_cache_init(void);
-void* cache_add_bitmap(bitmap_hash_key_t* key, bitmap_hash_val_t* val);
-bitmap_hash_val_t* cache_find_bitmap(bitmap_hash_key_t* key);
-void ass_bitmap_cache_reset(void);
-void ass_bitmap_cache_done(void);
-
-// describes an outline glyph
-typedef struct glyph_hash_key_s {
-	ass_font_t* font;
-	double size; // font size
-	uint32_t ch; // character code
-	int bold, italic;
-	unsigned scale_x, scale_y; // 16.16
-	FT_Vector advance; // subpixel shift vector
-	unsigned outline; // border width, 16.16
-} glyph_hash_key_t;
-
-typedef struct glyph_hash_val_s {
-	FT_Glyph glyph;
-	FT_Glyph outline_glyph;
-	FT_BBox bbox_scaled; // bbox after scaling, but before rotation
-	FT_Vector advance; // 26.6, advance distance to the next bitmap in line
-} glyph_hash_val_t;
-
-void ass_glyph_cache_init(void);
-void* cache_add_glyph(glyph_hash_key_t* key, glyph_hash_val_t* val);
-glyph_hash_val_t* cache_find_glyph(glyph_hash_key_t* key);
-void ass_glyph_cache_reset(void);
-void ass_glyph_cache_done(void);
-
-typedef struct hashmap_s hashmap_t; 
-typedef void (*hashmap_item_dtor_t)(void* key, size_t key_size, void* value, size_t value_size);
-typedef int (*hashmap_key_compare_t)(void* key1, void* key2, size_t key_size);
-typedef unsigned (*hashmap_hash_t)(void* key, size_t key_size);
-
-hashmap_t* hashmap_init(size_t key_size, size_t value_size, int nbuckets,
-			hashmap_item_dtor_t item_dtor, hashmap_key_compare_t key_compare,
-			hashmap_hash_t hash);
-void hashmap_done(hashmap_t* map);
-void* hashmap_insert(hashmap_t* map, void* key, void* value);
-void* hashmap_find(hashmap_t* map, void* key);
-
-#endif
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_font.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_font.c	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_font.c	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,370 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-//#include "config.h"
-
-#include <inttypes.h>
-#include <ft2build.h>
-#include FT_FREETYPE_H
-#include FT_SYNTHESIS_H
-#include FT_GLYPH_H
-#include FT_TRUETYPE_TABLES_H
-
-#include "ass.h"
-#include "ass_library.h"
-#include "ass_font.h"
-#include "ass_bitmap.h"
-#include "ass_cache.h"
-#include "ass_fontconfig.h"
-#include "ass_utils.h"
-#include "mputils.h"
-
-/**
- * Select Microfost Unicode CharMap, if the font has one.
- * Otherwise, let FreeType decide.
- */
-static void charmap_magic(FT_Face face)
-{
-	int i;
-	for (i = 0; i < face->num_charmaps; ++i) {
-		FT_CharMap cmap = face->charmaps[i];
-		unsigned pid = cmap->platform_id;
-		unsigned eid = cmap->encoding_id;
-		if (pid == 3 /*microsoft*/ && (eid == 1 /*unicode bmp*/ || eid == 10 /*full unicode*/)) {
-			FT_Set_Charmap(face, cmap);
-			return;
-		}
-	}
-
-	if (!face->charmap) {
-		if (face->num_charmaps == 0) {
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NoCharmaps);
-			return;
-		}
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NoCharmapAutodetected);
-		FT_Set_Charmap(face, face->charmaps[0]);
-		return;
-	}
-}
-
-static void update_transform(ass_font_t* font)
-{
-	int i;
-	FT_Matrix m;
-	m.xx = double_to_d16(font->scale_x);
-	m.yy = double_to_d16(font->scale_y);
-	m.xy = m.yx = 0;
-	for (i = 0; i < font->n_faces; ++i)
-		FT_Set_Transform(font->faces[i], &m, &font->v);
-}
-
-/**
- * \brief find a memory font by name
- */
-static int find_font(ass_library_t* library, char* name)
-{
-	int i;
-	for (i = 0; i < library->num_fontdata; ++i)
-		if (strcasecmp(name, library->fontdata[i].name) == 0)
-			return i;
-	return -1;
-}
-
-static void face_set_size(FT_Face face, double size);
-
-static void buggy_font_workaround(FT_Face face)
-{
-	// Some fonts have zero Ascender/Descender fields in 'hhea' table.
-	// In this case, get the information from 'os2' table or, as
-	// a last resort, from face.bbox.
-	if (face->ascender + face->descender == 0 || face->height == 0) {
-		TT_OS2 *os2 = FT_Get_Sfnt_Table(face, ft_sfnt_os2);
-		if (os2) {
-			face->ascender = os2->sTypoAscender;
-			face->descender = os2->sTypoDescender;
-			face->height = face->ascender - face->descender;
-		} else {
-			face->ascender = face->bbox.yMax;
-			face->descender = face->bbox.yMin;
-			face->height = face->ascender - face->descender;
-		}
-	}
-}
-
-/**
- * \brief Select a face with the given charcode and add it to ass_font_t
- * \return index of the new face in font->faces, -1 if failed
- */
-static int add_face(void* fc_priv, ass_font_t* font, uint32_t ch)
-{
-	char* path;
-	int index;
-	FT_Face face;
-	int error;
-	int mem_idx;
-	
-	if (font->n_faces == ASS_FONT_MAX_FACES)
-		return -1;
-	
-	path = fontconfig_select(fc_priv, font->desc.family, font->desc.bold,
-					      font->desc.italic, &index, ch);
-
-	mem_idx = find_font(font->library, path);
-	if (mem_idx >= 0) {
-		error = FT_New_Memory_Face(font->ftlibrary, (unsigned char*)font->library->fontdata[mem_idx].data,
-					   font->library->fontdata[mem_idx].size, 0, &face);
-		if (error) {
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorOpeningMemoryFont, path);
-			return -1;
-		}
-	} else {
-		error = FT_New_Face(font->ftlibrary, path, index, &face);
-		if (error) {
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorOpeningFont, path, index);
-			return -1;
-		}
-	}
-	charmap_magic(face);
-	buggy_font_workaround(face);
-	
-	font->faces[font->n_faces++] = face;
-	update_transform(font);
-	face_set_size(face, font->size);
-	return font->n_faces - 1;
-}
-
-/**
- * \brief Create a new ass_font_t according to "desc" argument
- */
-ass_font_t* ass_font_new(ass_library_t* library, FT_Library ftlibrary, void* fc_priv, ass_font_desc_t* desc)
-{
-	int error;
-	ass_font_t* fontp;
-	ass_font_t font;
-
-	fontp = ass_font_cache_find(desc);
-	if (fontp)
-		return fontp;
-	
-	font.library = library;
-	font.ftlibrary = ftlibrary;
-	font.n_faces = 0;
-	font.desc.family = strdup(desc->family);
-	font.desc.bold = desc->bold;
-	font.desc.italic = desc->italic;
-
-	font.scale_x = font.scale_y = 1.;
-	font.v.x = font.v.y = 0;
-	font.size = 0.;
-
-	error = add_face(fc_priv, &font, 0);
-	if (error == -1) {
-		free(font.desc.family);
-		return 0;
-	} else
-		return ass_font_cache_add(&font);
-}
-
-/**
- * \brief Set font transformation matrix and shift vector
- **/
-void ass_font_set_transform(ass_font_t* font, double scale_x, double scale_y, FT_Vector* v)
-{
-	font->scale_x = scale_x;
-	font->scale_y = scale_y;
-	font->v.x = v->x;
-	font->v.y = v->y;
-	update_transform(font);
-}
-
-static void face_set_size(FT_Face face, double size)
-{
-#if (FREETYPE_MAJOR > 2) || ((FREETYPE_MAJOR == 2) && (FREETYPE_MINOR > 1))
-	TT_HoriHeader *hori = FT_Get_Sfnt_Table(face, ft_sfnt_hhea);
-	TT_OS2 *os2 = FT_Get_Sfnt_Table(face, ft_sfnt_os2);
-	double mscale = 1.;
-	FT_Size_RequestRec rq;
-	FT_Size_Metrics *m = &face->size->metrics;
-	// VSFilter uses metrics from TrueType OS/2 table
-	// The idea was borrowed from asa (http://asa.diac24.net)
-	if (hori && os2) {
-		int hori_height = hori->Ascender - hori->Descender;
-		int os2_height = os2->usWinAscent + os2->usWinDescent;
-		if (hori_height && os2_height)
-			mscale = (double)hori_height / os2_height;
-	}
-	memset(&rq, 0, sizeof(rq));
-	rq.type = FT_SIZE_REQUEST_TYPE_REAL_DIM;
-	rq.width = 0;
-	rq.height = double_to_d6(size * mscale);
-	rq.horiResolution = rq.vertResolution = 0;
-	FT_Request_Size(face, &rq);
-	m->ascender /= mscale;
-	m->descender /= mscale;
-	m->height /= mscale;
-#else
-	FT_Set_Char_Size(face, 0, double_to_d6(size), 0, 0);
-#endif
-}
-
-/**
- * \brief Set font size
- **/
-void ass_font_set_size(ass_font_t* font, double size)
-{
-	int i;
-	if (font->size != size) {
-		font->size = size;
-		for (i = 0; i < font->n_faces; ++i)
-			face_set_size(font->faces[i], size);
-	}
-}
-
-/**
- * \brief Get maximal font ascender and descender.
- * \param ch character code
- * The values are extracted from the font face that provides glyphs for the given character
- **/
-void ass_font_get_asc_desc(ass_font_t* font, uint32_t ch, int* asc, int* desc)
-{
-	int i;
-	for (i = 0; i < font->n_faces; ++i) {
-		FT_Face face = font->faces[i];
-		if (FT_Get_Char_Index(face, ch)) {
-			int v, v2;
-			v = face->size->metrics.ascender;
-			v2 = FT_MulFix(face->bbox.yMax, face->size->metrics.y_scale);
-			*asc = (v > v2 * 0.9) ? v : v2;
-				
-			v = - face->size->metrics.descender;
-			v2 = - FT_MulFix(face->bbox.yMin, face->size->metrics.y_scale);
-			*desc = (v > v2 * 0.9) ? v : v2;
-			return;
-		}
-	}
-	
-	*asc = *desc = 0;
-}
-
-/**
- * \brief Get a glyph
- * \param ch character code
- **/
-FT_Glyph ass_font_get_glyph(void* fontconfig_priv, ass_font_t* font, uint32_t ch, ass_hinting_t hinting)
-{
-	int error;
-	int index = 0;
-	int i;
-	FT_Glyph glyph;
-	FT_Face face = 0;
-	int flags = 0;
-
-	if (ch < 0x20)
-		return 0;
-	if (font->n_faces == 0)
-		return 0;
-
-	for (i = 0; i < font->n_faces; ++i) {
-		face = font->faces[i];
-		index = FT_Get_Char_Index(face, ch);
-		if (index)
-			break;
-	}
-
-#ifdef HAVE_FONTCONFIG
-	if (index == 0) {
-		int face_idx;
-		mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_GlyphNotFoundReselectingFont,
-		       ch, font->desc.family, font->desc.bold, font->desc.italic);
-		face_idx = add_face(fontconfig_priv, font, ch);
-		face = font->faces[face_idx];
-		index = FT_Get_Char_Index(face, ch);
-		if (index == 0) {
-			mp_msg(MSGT_ASS, MSGL_ERR, MSGTR_LIBASS_GlyphNotFound,
-			       ch, font->desc.family, font->desc.bold, font->desc.italic);
-		}
-	}
-#endif
-
-	switch (hinting) {
-	case ASS_HINTING_NONE: flags = FT_LOAD_NO_HINTING; break;
-	case ASS_HINTING_LIGHT: flags = FT_LOAD_FORCE_AUTOHINT | FT_LOAD_TARGET_LIGHT; break;
-	case ASS_HINTING_NORMAL: flags = FT_LOAD_FORCE_AUTOHINT; break;
-	case ASS_HINTING_NATIVE: flags = 0; break;
-	}
-	
-	error = FT_Load_Glyph(face, index, FT_LOAD_NO_BITMAP | flags);
-	if (error) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorLoadingGlyph);
-		return 0;
-	}
-	
-#if (FREETYPE_MAJOR > 2) || \
-    ((FREETYPE_MAJOR == 2) && (FREETYPE_MINOR >= 2)) || \
-    ((FREETYPE_MAJOR == 2) && (FREETYPE_MINOR == 1) && (FREETYPE_PATCH >= 10))
-// FreeType >= 2.1.10 required
-	if (!(face->style_flags & FT_STYLE_FLAG_ITALIC) && 
-			(font->desc.italic > 55)) {
-		FT_GlyphSlot_Oblique(face->glyph);
-	}
-#endif
-	error = FT_Get_Glyph(face->glyph, &glyph);
-	if (error) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorLoadingGlyph);
-		return 0;
-	}
-	
-	return glyph;
-}
-
-/**
- * \brief Get kerning for the pair of glyphs.
- **/
-FT_Vector ass_font_get_kerning(ass_font_t* font, uint32_t c1, uint32_t c2)
-{
-	FT_Vector v = {0, 0};
-	int i;
-
-	for (i = 0; i < font->n_faces; ++i) {
-		FT_Face face = font->faces[i];
-		int i1 = FT_Get_Char_Index(face, c1);
-		int i2 = FT_Get_Char_Index(face, c2);
-		if (i1 && i2) {
-			if (FT_HAS_KERNING(face))
-				FT_Get_Kerning(face, i1, i2, FT_KERNING_DEFAULT, &v);
-			return v;
-		}
-		if (i1 || i2) // these glyphs are from different font faces, no kerning information
-			return v;
-	}
-	return v;
-}
-
-/**
- * \brief Deallocate ass_font_t
- **/
-void ass_font_free(ass_font_t* font)
-{
-	int i;
-	for (i = 0; i < font->n_faces; ++i)
-		if (font->faces[i]) FT_Done_Face(font->faces[i]);
-	if (font->desc.family) free(font->desc.family);
-	free(font);
-}

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_font.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_font.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_font.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,51 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#ifndef ASS_FONT_H
-#define ASS_FONT_H
-
-typedef struct ass_font_desc_s {
-	char* family;
-	unsigned bold;
-	unsigned italic;
-} ass_font_desc_t;
-
-#define ASS_FONT_MAX_FACES 10
-
-typedef struct ass_font_s {
-	ass_font_desc_t desc;
-	ass_library_t* library;
-	FT_Library ftlibrary;
-	FT_Face faces[ASS_FONT_MAX_FACES];
-	int n_faces;
-	double scale_x, scale_y; // current transform
-	FT_Vector v; // current shift
-	double size;
-} ass_font_t;
-
-ass_font_t* ass_font_new(ass_library_t* library, FT_Library ftlibrary, void* fc_priv, ass_font_desc_t* desc);
-void ass_font_set_transform(ass_font_t* font, double scale_x, double scale_y, FT_Vector* v);
-void ass_font_set_size(ass_font_t* font, double size);
-void ass_font_get_asc_desc(ass_font_t* font, uint32_t ch, int* asc, int* desc);
-FT_Glyph ass_font_get_glyph(void* fontconfig_priv, ass_font_t* font, uint32_t ch, ass_hinting_t hinting);
-FT_Vector ass_font_get_kerning(ass_font_t* font, uint32_t c1, uint32_t c2);
-void ass_font_free(ass_font_t* font);
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_fontconfig.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_fontconfig.c	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_fontconfig.c	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,413 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-//#include "config.h"
-
-#include <stdlib.h>
-#include <stdio.h>
-#include <assert.h>
-#include <string.h>
-#include <sys/types.h>
-#include <sys/stat.h>
-#include <inttypes.h>
-#include <ft2build.h>
-#include FT_FREETYPE_H
-
-#include "mputils.h"
-#include "ass.h"
-#include "ass_library.h"
-#include "ass_fontconfig.h"
-
-#ifdef HAVE_FONTCONFIG
-#include <fontconfig/fontconfig.h>
-#include <fontconfig/fcfreetype.h>
-#endif
-
-struct fc_instance_s {
-#ifdef HAVE_FONTCONFIG
-	FcConfig* config;
-#endif
-	char* family_default;
-	char* path_default;
-	int index_default;
-};
-
-#ifdef HAVE_FONTCONFIG
-/**
- * \brief Low-level font selection.
- * \param priv private data
- * \param family font family
- * \param bold font weight value
- * \param italic font slant value
- * \param index out: font index inside a file
- * \param code: the character that should be present in the font, can be 0
- * \return font file path
-*/ 
-static char* _select_font(fc_instance_t* priv, const char* family, unsigned bold, unsigned italic, int* index,
-			  uint32_t code)
-{
-	FcBool rc;
-	FcResult result;
-	FcPattern *pat = 0, *rpat;
-	int val_i;
-	FcChar8* val_s;
-	FcBool val_b;
-	FcCharSet* val_cs;
-	FcFontSet* fset = 0;
-	int curf;
-	char* retval = 0;
-	
-	*index = 0;
-
-	pat = FcPatternCreate();
-	if (!pat)
-		goto error;
-	
-	FcPatternAddString(pat, FC_FAMILY, (const FcChar8*)family);
-	FcPatternAddBool(pat, FC_OUTLINE, FcTrue);
-	FcPatternAddInteger(pat, FC_SLANT, italic);
-	FcPatternAddInteger(pat, FC_WEIGHT, bold);
-
-	FcDefaultSubstitute(pat);
-	
-	rc = FcConfigSubstitute(priv->config, pat, FcMatchPattern);
-	if (!rc)
-		goto error;
-
-	fset = FcFontSort(priv->config, pat, FcTrue, NULL, &result);
-
-	for (curf = 0; curf < fset->nfont; ++curf) {
-		rpat = fset->fonts[curf];
-		
-		result = FcPatternGetBool(rpat, FC_OUTLINE, 0, &val_b);
-		if (result != FcResultMatch)
-			continue;
-		if (val_b != FcTrue)
-			continue;
-		if (!code)
-			break;
-		result = FcPatternGetCharSet(rpat, FC_CHARSET, 0, &val_cs);
-		if (result != FcResultMatch)
-			continue;
-		if (FcCharSetHasChar(val_cs, code))
-			break;
-	}
-
-	if (curf >= fset->nfont)
-		goto error;
-
-	rpat = fset->fonts[curf];
-	
-	result = FcPatternGetInteger(rpat, FC_INDEX, 0, &val_i);
-	if (result != FcResultMatch)
-		goto error;
-	*index = val_i;
-
-	result = FcPatternGetString(rpat, FC_FAMILY, 0, &val_s);
-	if (result != FcResultMatch)
-		goto error;
-
-	if (strcasecmp((const char*)val_s, family) != 0)
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_SelectedFontFamilyIsNotTheRequestedOne,
-				(const char*)val_s, family);
-
-	result = FcPatternGetString(rpat, FC_FILE, 0, &val_s);
-	if (result != FcResultMatch)
-		goto error;
-	
-	retval = strdup((const char*)val_s);
- error:
-	if (pat) FcPatternDestroy(pat);
-	if (fset) FcFontSetDestroy(fset);
-	return retval;
-}
-
-/**
- * \brief Find a font. Use default family or path if necessary.
- * \param priv_ private data
- * \param family font family
- * \param bold font weight value
- * \param italic font slant value
- * \param index out: font index inside a file
- * \param code: the character that should be present in the font, can be 0
- * \return font file path
-*/ 
-char* fontconfig_select(fc_instance_t* priv, const char* family, unsigned bold, unsigned italic, int* index,
-			uint32_t code)
-{
-	char* res = 0;
-	if (family && *family)
-		res = _select_font(priv, family, bold, italic, index, code);
-	if (!res && priv->family_default) {
-		res = _select_font(priv, priv->family_default, bold, italic, index, code);
-		if (res)
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_UsingDefaultFontFamily, 
-					family, bold, italic, res, *index);
-	}
-	if (!res && priv->path_default) {
-		res = priv->path_default;
-		*index = priv->index_default;
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_UsingDefaultFont, 
-		       family, bold, italic, res, *index);
-	}
-	if (!res) {
-		res = _select_font(priv, "Arial", bold, italic, index, code);
-		if (res)
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_UsingArialFontFamily, 
-					family, bold, italic, res, *index);
-	}
-	if (res)
-		mp_msg(MSGT_ASS, MSGL_V, "fontconfig_select: (%s, %d, %d) -> %s, %d\n", 
-				family, bold, italic, res, *index);
-	return res;
-}
-
-#if (FC_VERSION < 20402)
-static char* validate_fname(char* name)
-{
-	char* fname;
-	char* p;
-	char* q;
-	unsigned code;
-	int sz = strlen(name);
-
-	q = fname = malloc(sz + 1);
-	p = name;
-	while (*p) {
-		code = utf8_get_char(&p);
-		if (code == 0)
-			break;
-		if (	(code > 0x7F) ||
-			(code == '\\') ||
-			(code == '/') ||
-			(code == ':') ||
-			(code == '*') ||
-			(code == '?') ||
-			(code == '<') ||
-			(code == '>') ||
-			(code == '|') ||
-			(code == 0))
-		{
-			*q++ = '_';
-		} else {
-			*q++ = code;
-		}
-		if (p - name > sz)
-			break;
-	}
-	*q = 0;
-	return fname;
-}
-#endif
-
-/**
- * \brief Process memory font.
- * \param priv private data
- * \param library library object
- * \param ftlibrary freetype library object
- * \param idx index of the processed font in library->fontdata
- * With FontConfig >= 2.4.2, builds a font pattern in memory via FT_New_Memory_Face/FcFreeTypeQueryFace.
- * With older FontConfig versions, save the font to ~/.mplayer/fonts.
-*/ 
-static void process_fontdata(fc_instance_t* priv, ass_library_t* library, FT_Library ftlibrary, int idx)
-{
-	int rc;
-	const char* name = library->fontdata[idx].name;
-	const char* data = library->fontdata[idx].data;
-	int data_size = library->fontdata[idx].size;
-
-#if (FC_VERSION < 20402)
-	struct stat st;
-	char* fname;
-	const char* fonts_dir = library->fonts_dir;
-	char buf[1000];
-	FILE* fp = 0;
-
-	if (!fonts_dir)
-		return;
-	rc = stat(fonts_dir, &st);
-	if (rc) {
-		int res;
-#ifndef __MINGW32__
-		res = mkdir(fonts_dir, 0700);
-#else
-		res = mkdir(fonts_dir);
-#endif
-		if (res) {
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FailedToCreateDirectory, fonts_dir);
-		}
-	} else if (!S_ISDIR(st.st_mode)) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NotADirectory, fonts_dir);
-	}
-	
-	fname = validate_fname((char*)name);
-
-	snprintf(buf, 1000, "%s/%s", fonts_dir, fname);
-	free(fname);
-
-	fp = fopen(buf, "wb");
-	if (!fp) return;
-
-	fwrite(data, data_size, 1, fp);
-	fclose(fp);
-
-#else // (FC_VERSION >= 20402)
-	FT_Face face;
-	FcPattern* pattern;
-	FcFontSet* fset;
-	FcBool res;
-
-	rc = FT_New_Memory_Face(ftlibrary, (unsigned char*)data, data_size, 0, &face);
-	if (rc) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_ErrorOpeningMemoryFont, name);
-		return;
-	}
-
-	pattern = FcFreeTypeQueryFace(face, (unsigned char*)name, 0, FcConfigGetBlanks(priv->config));
-	if (!pattern) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FunctionCallFailed, "FcFreeTypeQueryFace");
-		FT_Done_Face(face);
-		return;
-	}
-
-	fset = FcConfigGetFonts(priv->config, FcSetSystem); // somehow it failes when asked for FcSetApplication
-	if (!fset) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FunctionCallFailed, "FcConfigGetFonts");
-		FT_Done_Face(face);
-		return;
-	}
-
-	res = FcFontSetAdd(fset, pattern);
-	if (!res) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FunctionCallFailed, "FcFontSetAdd");
-		FT_Done_Face(face);
-		return;
-	}
-
-	FT_Done_Face(face);
-#endif
-}
-
-/**
- * \brief Init fontconfig.
- * \param library libass library object
- * \param ftlibrary freetype library object
- * \param family default font family
- * \param path default font path
- * \return pointer to fontconfig private data
-*/ 
-fc_instance_t* fontconfig_init(ass_library_t* library, FT_Library ftlibrary, const char* family, const char* path)
-{
-	int rc;
-	fc_instance_t* priv = calloc(1, sizeof(fc_instance_t));
-	const char* dir = library->fonts_dir;
-	int i;
-	
-	rc = FcInit();
-	assert(rc);
-
-	priv->config = FcConfigGetCurrent();
-	if (!priv->config) {
-		mp_msg(MSGT_ASS, MSGL_FATAL, MSGTR_LIBASS_FcInitLoadConfigAndFontsFailed);
-		return 0;
-	}
-
-	for (i = 0; i < library->num_fontdata; ++i)
-		process_fontdata(priv, library, ftlibrary, i);
-
-	if (FcDirCacheValid((const FcChar8 *)dir) == FcFalse)
-	{
-		mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_UpdatingFontCache);
-		if (FcGetVersion() >= 20390 && FcGetVersion() < 20400)
-			mp_msg(MSGT_ASS, MSGL_WARN,
-			       MSGTR_LIBASS_BetaVersionsOfFontconfigAreNotSupported);
-		// FontConfig >= 2.4.0 updates cache automatically in FcConfigAppFontAddDir()
-		if (FcGetVersion() < 20390) {
-			FcFontSet* fcs;
-			FcStrSet* fss;
-			fcs = FcFontSetCreate();
-			fss = FcStrSetCreate();
-			rc = FcStrSetAdd(fss, (const FcChar8*)dir);
-			if (!rc) {
-				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FcStrSetAddFailed);
-				goto ErrorFontCache;
-			}
-
-			rc = FcDirScan(fcs, fss, NULL, FcConfigGetBlanks(priv->config), (const FcChar8 *)dir, FcFalse);
-			if (!rc) {
-				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FcDirScanFailed);
-				goto ErrorFontCache;
-			}
-
-			rc = FcDirSave(fcs, fss, (const FcChar8 *)dir);
-			if (!rc) {
-				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FcDirSave);
-				goto ErrorFontCache;
-			}
-		ErrorFontCache:
-			;
-		}
-	}
-
-	rc = FcConfigAppFontAddDir(priv->config, (const FcChar8*)dir);
-	if (!rc) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FcConfigAppFontAddDirFailed);
-	}
-
-	priv->family_default = family ? strdup(family) : 0;
-	priv->path_default = path ? strdup(path) : 0;
-	priv->index_default = 0;
-
-	return priv;
-}
-
-#else // HAVE_FONTCONFIG
-
-char* fontconfig_select(fc_instance_t* priv, const char* family, unsigned bold, unsigned italic, int* index,
-			uint32_t code)
-{
-	*index = priv->index_default;
-	return priv->path_default;
-}
-
-fc_instance_t* fontconfig_init(ass_library_t* library, FT_Library ftlibrary, const char* family, const char* path)
-{
-	fc_instance_t* priv;
-
-	mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FontconfigDisabledDefaultFontWillBeUsed);
-	
-	priv = calloc(1, sizeof(fc_instance_t));
-	
-	priv->path_default = strdup(path);
-	priv->index_default = 0;
-	return priv;
-}
-
-#endif
-
-void fontconfig_done(fc_instance_t* priv)
-{
-	// don't call FcFini() here, library can still be used by some code
-	if (priv && priv->path_default) free(priv->path_default);
-	if (priv && priv->family_default) free(priv->family_default);
-	if (priv) free(priv);
-}
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_fontconfig.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_fontconfig.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_fontconfig.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,35 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#ifndef ASS_FONTCONFIG_H
-#define ASS_FONTCONFIG_H
-
-#ifdef HAVE_FONTCONFIG
-#include <fontconfig/fontconfig.h>
-#endif
-
-typedef struct fc_instance_s fc_instance_t;
-
-fc_instance_t* fontconfig_init(ass_library_t* library, FT_Library ftlibrary, const char* family, const char* path);
-char* fontconfig_select(fc_instance_t* priv, const char* family, unsigned bold, unsigned italic, int* index, uint32_t code);
-void fontconfig_done(fc_instance_t* priv);
-
-#endif
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_library.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_library.c	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_library.c	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,93 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#include <inttypes.h>
-#include <stdio.h>
-#include <stdlib.h>
-#include <string.h>
-
-#include "ass.h"
-#include "ass_library.h"
-
-
-ass_library_t* ass_library_init(void)
-{
-	return calloc(1, sizeof(ass_library_t));
-}
-
-void ass_library_done(ass_library_t* priv)
-{
-	if (priv) {
-		ass_set_fonts_dir(priv, NULL);
-		ass_set_style_overrides(priv, NULL);
-		free(priv);
-	}
-}
-
-void ass_set_fonts_dir(ass_library_t* priv, const char* fonts_dir)
-{
-	if (priv->fonts_dir)
-		free(priv->fonts_dir);
-
-	priv->fonts_dir = fonts_dir ? strdup(fonts_dir) : 0;
-}
-
-void ass_set_extract_fonts(ass_library_t* priv, int extract)
-{
-	priv->extract_fonts = !!extract;
-}
-
-void ass_set_style_overrides(ass_library_t* priv, char** list)
-{
-	char** p;
-	char** q;
-	int cnt;
-	
-	if (priv->style_overrides) {
-		for (p = priv->style_overrides; *p; ++p)
-			free(*p);
-		free(priv->style_overrides);
-	}
-	
-	if (!list) return;
-
-	for (p = list, cnt = 0; *p; ++p, ++cnt) {}
-
-	priv->style_overrides = malloc((cnt + 1) * sizeof(char*));
-	for (p = list, q = priv->style_overrides; *p; ++p, ++q)
-		*q = strdup(*p);
-	priv->style_overrides[cnt] = NULL;
-}
-
-static void grow_array(void **array, int nelem, size_t elsize)
-{
-	if (!(nelem & 31))
-		*array = realloc(*array, (nelem + 32) * elsize);
-}
-
-void ass_add_font(ass_library_t* priv, char* name, char* data, int size)
-{
-	grow_array((void**)&priv->fontdata, priv->num_fontdata, sizeof(*priv->fontdata));
-	priv->fontdata[priv->num_fontdata].name = name;
-	priv->fontdata[priv->num_fontdata].data = data;
-	priv->fontdata[priv->num_fontdata].size = size;
-	priv->num_fontdata ++;
-}
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_library.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_library.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_library.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,40 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#ifndef ASS_LIBRARY_H
-#define ASS_LIBRARY_H
-
-typedef struct ass_fontdata_s {
-	char* name;
-	char* data;
-	int size;
-} ass_fontdata_t;
-
-struct ass_library_s {
-	char* fonts_dir;
-	int extract_fonts;
-	char** style_overrides;
-
-	ass_fontdata_t* fontdata;
-	int num_fontdata;
-};
-
-#endif
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_render.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_render.c	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_render.c	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,2399 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-//#include "config.h"
-
-#include <assert.h>
-#include <math.h>
-#include <inttypes.h>
-#include <ft2build.h>
-#include FT_FREETYPE_H
-#include FT_STROKER_H
-#include FT_GLYPH_H
-#include FT_SYNTHESIS_H
-
-#include "mputils.h"
-
-#include "ass.h"
-#include "ass_font.h"
-#include "ass_bitmap.h"
-#include "ass_cache.h"
-#include "ass_utils.h"
-#include "ass_fontconfig.h"
-#include "ass_library.h"
-
-#define MAX_GLYPHS 1000
-#define MAX_LINES 100
-
-static int last_render_id = 0;
-
-typedef struct ass_settings_s {
-	int frame_width;
-	int frame_height;
-	double font_size_coeff; // font size multiplier
-	double line_spacing; // additional line spacing (in frame pixels)
-	int top_margin; // height of top margin. Everything except toptitles is shifted down by top_margin.
-	int bottom_margin; // height of bottom margin. (frame_height - top_margin - bottom_margin) is original video height.
-	int left_margin;
-	int right_margin;
-	int use_margins; // 0 - place all subtitles inside original frame
-	                 // 1 - use margins for placing toptitles and subtitles
-	double aspect; // frame aspect ratio, d_width / d_height.
-	ass_hinting_t hinting;
-
-	char* default_font;
-	char* default_family;
-} ass_settings_t;
-
-// a rendered event
-typedef struct event_images_s {
-	ass_image_t* imgs;
-	int top, height;
-	int detect_collisions;
-	int shift_direction;
-	ass_event_t* event;
-} event_images_t;
-
-struct ass_renderer_s {
-	ass_library_t* library;
-	FT_Library ftlibrary;
-	fc_instance_t* fontconfig_priv;
-	ass_settings_t settings;
-	int render_id;
-	ass_synth_priv_t* synth_priv;
-
-	ass_image_t* images_root; // rendering result is stored here
-	ass_image_t* prev_images_root;
-
-	event_images_t* eimg; // temporary buffer for sorting rendered events
-	int eimg_size; // allocated buffer size
-};
-
-typedef enum {EF_NONE = 0, EF_KARAOKE, EF_KARAOKE_KF, EF_KARAOKE_KO} effect_t;
-
-// describes a glyph
-// glyph_info_t and text_info_t are used for text centering and word-wrapping operations
-typedef struct glyph_info_s {
-	unsigned symbol;
-	FT_Glyph glyph;
-	FT_Glyph outline_glyph;
-	bitmap_t* bm; // glyph bitmap
-	bitmap_t* bm_o; // outline bitmap
-	bitmap_t* bm_s; // shadow bitmap
-	FT_BBox bbox;
-	FT_Vector pos;
-	char linebreak; // the first (leading) glyph of some line ?
-	uint32_t c[4]; // colors
-	FT_Vector advance; // 26.6
-	effect_t effect_type;
-	int effect_timing; // time duration of current karaoke word
-	                   // after process_karaoke_effects: distance in pixels from the glyph origin.
-	                   // part of the glyph to the left of it is displayed in a different color.
-	int effect_skip_timing; // delay after the end of last karaoke word
-	int asc, desc; // font max ascender and descender
-//	int height;
-	int be; // blur edges
-	int shadow;
-	double frx, fry, frz; // rotation
-	
-	bitmap_hash_key_t hash_key;
-} glyph_info_t;
-
-typedef struct line_info_s {
-	int asc, desc;
-} line_info_t;
-
-typedef struct text_info_s {
-	glyph_info_t* glyphs;
-	int length;
-	line_info_t lines[MAX_LINES];
-	int n_lines;
-	int height;
-} text_info_t;
-
-
-// Renderer state.
-// Values like current font face, color, screen position, clipping and so on are stored here.
-typedef struct render_context_s {
-	ass_event_t* event;
-	ass_style_t* style;
-	
-	ass_font_t* font;
-	char* font_path;
-	double font_size;
-	
-	FT_Stroker stroker;
-	int alignment; // alignment overrides go here; if zero, style value will be used
-	double frx, fry, frz;
-	enum {	EVENT_NORMAL, // "normal" top-, sub- or mid- title
-		EVENT_POSITIONED, // happens after pos(,), margins are ignored
-		EVENT_HSCROLL, // "Banner" transition effect, text_width is unlimited
-		EVENT_VSCROLL // "Scroll up", "Scroll down" transition effects
-		} evt_type;
-	int pos_x, pos_y; // position
-	int org_x, org_y; // origin
-	char have_origin; // origin is explicitly defined; if 0, get_base_point() is used
-	double scale_x, scale_y;
-	double hspacing; // distance between letters, in pixels
-	double border; // outline width
-	uint32_t c[4]; // colors(Primary, Secondary, so on) in RGBA
-	int clip_x0, clip_y0, clip_x1, clip_y1;
-	char detect_collisions;
-	uint32_t fade; // alpha from \fad
-	char be; // blur edges
-	int shadow;
-
-	effect_t effect_type;
-	int effect_timing;
-	int effect_skip_timing;
-
-	enum { SCROLL_LR, // left-to-right
-	       SCROLL_RL,
-	       SCROLL_TB, // top-to-bottom
-	       SCROLL_BT
-	       } scroll_direction; // for EVENT_HSCROLL, EVENT_VSCROLL
-	int scroll_shift;
-
-	// face properties
-	char* family;
-	unsigned bold;
-	unsigned italic;
-	
-} render_context_t;
-
-// frame-global data
-typedef struct frame_context_s {
-	ass_renderer_t* ass_priv;
-	int width, height; // screen dimensions
-	int orig_height; // frame height ( = screen height - margins )
-	int orig_width; // frame width ( = screen width - margins )
-	ass_track_t* track;
-	long long time; // frame's timestamp, ms
-	double font_scale;
-	double font_scale_x; // x scale applied to all glyphs to preserve text aspect ratio
-	double border_scale;
-} frame_context_t;
-
-static ass_renderer_t* ass_renderer;
-static ass_settings_t* global_settings;
-static text_info_t text_info;
-static render_context_t render_context;
-static frame_context_t frame_context;
-
-struct render_priv_s {
-	int top, height;
-	int render_id;
-};
-
-static void ass_lazy_track_init(void)
-{
-	ass_track_t* track = frame_context.track;
-	if (track->PlayResX && track->PlayResY)
-		return;
-	if (!track->PlayResX && !track->PlayResY) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NeitherPlayResXNorPlayResYDefined);
-		track->PlayResX = 384;
-		track->PlayResY = 288;
-	} else {
-		double orig_aspect = (global_settings->aspect * frame_context.height * frame_context.orig_width) /
-			frame_context.orig_height / frame_context.width;
-		if (!track->PlayResY) {
-			track->PlayResY = track->PlayResX / orig_aspect + .5;
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_PlayResYUndefinedSettingY, track->PlayResY);
-		} else if (!track->PlayResX) {
-			track->PlayResX = track->PlayResY * orig_aspect + .5;
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_PlayResXUndefinedSettingX, track->PlayResX);
-		}
-	}
-}
-
-ass_renderer_t* ass_renderer_init(ass_library_t* library)
-{
-	int error;
-	FT_Library ft;
-	ass_renderer_t* priv = 0;
-	
-	memset(&render_context, 0, sizeof(render_context));
-	memset(&frame_context, 0, sizeof(frame_context));
-	memset(&text_info, 0, sizeof(text_info));
-
-	error = FT_Init_FreeType( &ft );
-	if ( error ) { 
-		mp_msg(MSGT_ASS, MSGL_FATAL, MSGTR_LIBASS_FT_Init_FreeTypeFailed);
-		goto ass_init_exit;
-	}
-
-	priv = calloc(1, sizeof(ass_renderer_t));
-	if (!priv) {
-		FT_Done_FreeType(ft);
-		goto ass_init_exit;
-	}
-
-	priv->synth_priv = ass_synth_init();
-
-	priv->library = library;
-	priv->ftlibrary = ft;
-	// images_root and related stuff is zero-filled in calloc
-	
-	ass_font_cache_init();
-	ass_bitmap_cache_init();
-	ass_glyph_cache_init();
-
-	text_info.glyphs = calloc(MAX_GLYPHS, sizeof(glyph_info_t));
-	
-ass_init_exit:
-	if (priv) mp_msg(MSGT_ASS, MSGL_INFO, MSGTR_LIBASS_Init);
-	else mp_msg(MSGT_ASS, MSGL_ERR, MSGTR_LIBASS_InitFailed);
-
-	return priv;
-}
-
-void ass_renderer_done(ass_renderer_t* priv)
-{
-	ass_font_cache_done();
-	ass_bitmap_cache_done();
-	ass_glyph_cache_done();
-	if (render_context.stroker) {
-		FT_Stroker_Done(render_context.stroker);
-		render_context.stroker = 0;
-	}
-	if (priv && priv->ftlibrary) FT_Done_FreeType(priv->ftlibrary);
-	if (priv && priv->fontconfig_priv) fontconfig_done(priv->fontconfig_priv);
-	if (priv && priv->synth_priv) ass_synth_done(priv->synth_priv);
-	if (priv && priv->eimg) free(priv->eimg);
-	if (priv) free(priv);
-	if (text_info.glyphs) free(text_info.glyphs);
-}
-
-/**
- * \brief Create a new ass_image_t
- * Parameters are the same as ass_image_t fields.
- */
-static ass_image_t* my_draw_bitmap(unsigned char* bitmap, int bitmap_w, int bitmap_h, int stride, int dst_x, int dst_y, uint32_t color)
-{
-	ass_image_t* img = calloc(1, sizeof(ass_image_t));
-	
-	img->w = bitmap_w;
-	img->h = bitmap_h;
-	img->stride = stride;
-	img->bitmap = bitmap;
-	img->color = color;
-	img->dst_x = dst_x;
-	img->dst_y = dst_y;
-
-	return img;
-}
-
-/**
- * \brief convert bitmap glyph into ass_image_t struct(s)
- * \param bit freetype bitmap glyph, FT_PIXEL_MODE_GRAY
- * \param dst_x bitmap x coordinate in video frame
- * \param dst_y bitmap y coordinate in video frame
- * \param color first color, RGBA
- * \param color2 second color, RGBA
- * \param brk x coordinate relative to glyph origin, color is used to the left of brk, color2 - to the right
- * \param tail pointer to the last image's next field, head of the generated list should be stored here
- * \return pointer to the new list tail
- * Performs clipping. Uses my_draw_bitmap for actual bitmap convertion.
- */
-static ass_image_t** render_glyph(bitmap_t* bm, int dst_x, int dst_y, uint32_t color, uint32_t color2, int brk, ass_image_t** tail)
-{
-	// brk is relative to dst_x
-	// color = color left of brk
-	// color2 = color right of brk
-	int b_x0, b_y0, b_x1, b_y1; // visible part of the bitmap
-	int clip_x0, clip_y0, clip_x1, clip_y1;
-	int tmp;
-	ass_image_t* img;
-
-	dst_x += bm->left;
-	dst_y += bm->top;
-	brk -= bm->left;
-	
-	// clipping
-	clip_x0 = render_context.clip_x0;
-	clip_y0 = render_context.clip_y0;
-	clip_x1 = render_context.clip_x1;
-	clip_y1 = render_context.clip_y1;
-	b_x0 = 0;
-	b_y0 = 0;
-	b_x1 = bm->w;
-	b_y1 = bm->h;
-	
-	tmp = dst_x - clip_x0;
-	if (tmp < 0) {
-		mp_msg(MSGT_ASS, MSGL_DBG2, "clip left\n");
-		b_x0 = - tmp;
-	}
-	tmp = dst_y - clip_y0;
-	if (tmp < 0) {
-		mp_msg(MSGT_ASS, MSGL_DBG2, "clip top\n");
-		b_y0 = - tmp;
-	}
-	tmp = clip_x1 - dst_x - bm->w;
-	if (tmp < 0) {
-		mp_msg(MSGT_ASS, MSGL_DBG2, "clip right\n");
-		b_x1 = bm->w + tmp;
-	}
-	tmp = clip_y1 - dst_y - bm->h;
-	if (tmp < 0) {
-		mp_msg(MSGT_ASS, MSGL_DBG2, "clip bottom\n");
-		b_y1 = bm->h + tmp;
-	}
-	
-	if ((b_y0 >= b_y1) || (b_x0 >= b_x1))
-		return tail;
-
-	if (brk > b_x0) { // draw left part
-		if (brk > b_x1) brk = b_x1;
-		img = my_draw_bitmap(bm->buffer + bm->w * b_y0 + b_x0, 
-			brk - b_x0, b_y1 - b_y0, bm->w,
-			dst_x + b_x0, dst_y + b_y0, color);
-		*tail = img;
-		tail = &img->next;
-	}
-	if (brk < b_x1) { // draw right part
-		if (brk < b_x0) brk = b_x0;
-		img = my_draw_bitmap(bm->buffer + bm->w * b_y0 + brk, 
-			b_x1 - brk, b_y1 - b_y0, bm->w,
-			dst_x + brk, dst_y + b_y0, color2);
-		*tail = img;
-		tail = &img->next;
-	}
-	return tail;
-}
-
-/**
- * \brief Convert text_info_t struct to ass_image_t list
- * Splits glyphs in halves when needed (for \kf karaoke).
- */
-static ass_image_t* render_text(text_info_t* text_info, int dst_x, int dst_y)
-{
-	int pen_x, pen_y;
-	int i;
-	bitmap_t* bm;
-	ass_image_t* head;
-	ass_image_t** tail = &head;
-
-	for (i = 0; i < text_info->length; ++i) {
-		glyph_info_t* info = text_info->glyphs + i;
-		if ((info->symbol == 0) || (info->symbol == '\n') || !info->bm_s || (info->shadow == 0))
-			continue;
-
-		pen_x = dst_x + info->pos.x + info->shadow;
-		pen_y = dst_y + info->pos.y + info->shadow;
-		bm = info->bm_s;
-
-		tail = render_glyph(bm, pen_x, pen_y, info->c[3], 0, 1000000, tail);
-	}
-
-	for (i = 0; i < text_info->length; ++i) {
-		glyph_info_t* info = text_info->glyphs + i;
-		if ((info->symbol == 0) || (info->symbol == '\n') || !info->bm_o)
-			continue;
-
-		pen_x = dst_x + info->pos.x;
-		pen_y = dst_y + info->pos.y;
-		bm = info->bm_o;
-		
-		if ((info->effect_type == EF_KARAOKE_KO) && (info->effect_timing <= info->bbox.xMax)) {
-			// do nothing
-		} else
-			tail = render_glyph(bm, pen_x, pen_y, info->c[2], 0, 1000000, tail);
-	}
-	for (i = 0; i < text_info->length; ++i) {
-		glyph_info_t* info = text_info->glyphs + i;
-		if ((info->symbol == 0) || (info->symbol == '\n') || !info->bm)
-			continue;
-
-		pen_x = dst_x + info->pos.x;
-		pen_y = dst_y + info->pos.y;
-		bm = info->bm;
-
-		if ((info->effect_type == EF_KARAOKE) || (info->effect_type == EF_KARAOKE_KO)) {
-			if (info->effect_timing > info->bbox.xMax)
-				tail = render_glyph(bm, pen_x, pen_y, info->c[0], 0, 1000000, tail);
-			else
-				tail = render_glyph(bm, pen_x, pen_y, info->c[1], 0, 1000000, tail);
-		} else if (info->effect_type == EF_KARAOKE_KF) {
-			tail = render_glyph(bm, pen_x, pen_y, info->c[0], info->c[1], info->effect_timing, tail);
-		} else
-			tail = render_glyph(bm, pen_x, pen_y, info->c[0], 0, 1000000, tail);
-	}
-
-	*tail = 0;
-	return head;
-}
-
-/**
- * \brief Mapping between script and screen coordinates
- */
-static int x2scr(int x) {
-	return x*frame_context.orig_width / frame_context.track->PlayResX + global_settings->left_margin;
-}
-/**
- * \brief Mapping between script and screen coordinates
- */
-static int y2scr(int y) {
-	return y * frame_context.orig_height / frame_context.track->PlayResY + global_settings->top_margin;
-}
-// the same for toptitles
-static int y2scr_top(int y) {
-	if (global_settings->use_margins)
-		return y * frame_context.orig_height / frame_context.track->PlayResY;
-	else
-		return y * frame_context.orig_height / frame_context.track->PlayResY + global_settings->top_margin;
-}
-// the same for subtitles
-static int y2scr_sub(int y) {
-	if (global_settings->use_margins)
-		return y * frame_context.orig_height / frame_context.track->PlayResY +
-		       global_settings->top_margin + global_settings->bottom_margin;
-	else
-		return y * frame_context.orig_height / frame_context.track->PlayResY + global_settings->top_margin;
-}
-
-static void compute_string_bbox( text_info_t* info, FT_BBox *abbox ) {
-	FT_BBox bbox;
-	int i;
-	
-	if (text_info.length > 0) {
-		bbox.xMin = 32000;
-		bbox.xMax = -32000;
-		bbox.yMin = - d6_to_int(text_info.lines[0].asc) + text_info.glyphs[0].pos.y;
-		bbox.yMax = d6_to_int(text_info.height - text_info.lines[0].asc) + text_info.glyphs[0].pos.y;
-
-		for (i = 0; i < text_info.length; ++i) {
-			int s = text_info.glyphs[i].pos.x;
-			int e = s + d6_to_int(text_info.glyphs[i].advance.x);
-			bbox.xMin = FFMIN(bbox.xMin, s);
-			bbox.xMax = FFMAX(bbox.xMax, e);
-		}
-	} else
-		bbox.xMin = bbox.xMax = bbox.yMin = bbox.yMax = 0;
-
-	/* return string bbox */
-	*abbox = bbox;
-}
-
-
-/**
- * \brief Check if starting part of (*p) matches sample. If true, shift p to the first symbol after the matching part.
- */
-static inline int mystrcmp(char** p, const char* sample) {
-	int len = strlen(sample);
-	if (strncmp(*p, sample, len) == 0) {
-		(*p) += len;
-		return 1;
-	} else
-		return 0;
-}
-
-static void change_font_size(double sz)
-{
-	double size = sz * frame_context.font_scale;
-
-	if (size < 1)
-		size = 1;
-	else if (size > frame_context.height * 2)
-		size = frame_context.height * 2;
-
-	ass_font_set_size(render_context.font, size);
-
-	render_context.font_size = sz;
-}
-
-/**
- * \brief Change current font, using setting from render_context.
- */
-static void update_font(void)
-{
-	unsigned val;
-	ass_renderer_t* priv = frame_context.ass_priv;
-	ass_font_desc_t desc;
-	desc.family = strdup(render_context.family);
-
-	val = render_context.bold;
-	// 0 = normal, 1 = bold, >1 = exact weight
-	if (val == 0) val = 80; // normal
-	else if (val == 1) val = 200; // bold
-	desc.bold = val;
-
-	val = render_context.italic;
-	if (val == 0) val = 0; // normal
-	else if (val == 1) val = 110; //italic
-	desc.italic = val;
-
-	render_context.font = ass_font_new(priv->library, priv->ftlibrary, priv->fontconfig_priv, &desc);
-	free(desc.family);
-	
-	if (render_context.font)
-		change_font_size(render_context.font_size);
-}
-
-/**
- * \brief Change border width
- * negative value resets border to style value
- */
-static void change_border(double border)
-{
-	int b;
-	if (!render_context.font) return;
-
-	if (border < 0) {
-		if (render_context.style->BorderStyle == 1) {
-			if (render_context.style->Outline == 0 && render_context.style->Shadow > 0)
-				border = 1.;
-			else
-				border = render_context.style->Outline;
-		} else
-			border = 1.;
-	}
-	render_context.border = border;
-
-	b = 64 * border * frame_context.border_scale;
-	if (b > 0) {
-		if (!render_context.stroker) {
-			int error;
-#if (FREETYPE_MAJOR > 2) || ((FREETYPE_MAJOR == 2) && (FREETYPE_MINOR > 1))
-			error = FT_Stroker_New( ass_renderer->ftlibrary, &render_context.stroker );
-#else // < 2.2
-			error = FT_Stroker_New( render_context.font->faces[0]->memory, &render_context.stroker );
-#endif
-			if (error) {
-				mp_msg(MSGT_ASS, MSGL_V, "failed to get stroker\n");
-				render_context.stroker = 0;
-			}
-		}
-		if (render_context.stroker)
-			FT_Stroker_Set( render_context.stroker, b,
-					FT_STROKER_LINECAP_ROUND,
-					FT_STROKER_LINEJOIN_ROUND,
-					0 );
-	} else {
-		FT_Stroker_Done(render_context.stroker);
-		render_context.stroker = 0;
-	}
-}
-
-#define _r(c)  ((c)>>24)
-#define _g(c)  (((c)>>16)&0xFF)
-#define _b(c)  (((c)>>8)&0xFF)
-#define _a(c)  ((c)&0xFF)
-
-/**
- * \brief Calculate a weighted average of two colors
- * calculates c1*(1-a) + c2*a, but separately for each component except alpha
- */
-static void change_color(uint32_t* var, uint32_t new, double pwr)
-{
-	(*var)= ((uint32_t)(_r(*var) * (1 - pwr) + _r(new) * pwr) << 24) +
-		((uint32_t)(_g(*var) * (1 - pwr) + _g(new) * pwr) << 16) +
-		((uint32_t)(_b(*var) * (1 - pwr) + _b(new) * pwr) << 8) +
-		_a(*var);
-}
-
-// like change_color, but for alpha component only
-static void change_alpha(uint32_t* var, uint32_t new, double pwr)
-{
-	*var = (_r(*var) << 24) + (_g(*var) << 16) + (_b(*var) << 8) + (_a(*var) * (1 - pwr) + _a(new) * pwr);
-}
-
-/**
- * \brief Multiply two alpha values
- * \param a first value
- * \param b second value
- * \return result of multiplication
- * Parameters and result are limited by 0xFF.
- */
-static uint32_t mult_alpha(uint32_t a, uint32_t b)
-{
-	return 0xFF - (0xFF - a) * (0xFF - b) / 0xFF;
-}
-
-/**
- * \brief Calculate alpha value by piecewise linear function
- * Used for \fad, \fade implementation.
- */
-static unsigned interpolate_alpha(long long now, 
-		long long t1, long long t2, long long t3, long long t4,
-		unsigned a1, unsigned a2, unsigned a3)
-{
-	unsigned a;
-	double cf;
-	if (now <= t1) {
-		a = a1;
-	} else if (now >= t4) {
-		a = a3;
-	} else if (now < t2) { // and > t1
-		cf = ((double)(now - t1)) / (t2 - t1);
-		a = a1 * (1 - cf) + a2 * cf;
-	} else if (now > t3) {
-		cf = ((double)(now - t3)) / (t4 - t3);
-		a = a2 * (1 - cf) + a3 * cf;
-	} else { // t2 <= now <= t3
-		a = a2;
-	}
-
-	return a;
-}
-
-static void reset_render_context(void);
-
-/**
- * \brief Parse style override tag.
- * \param p string to parse
- * \param pwr multiplier for some tag effects (comes from \t tags)
- */
-static char* parse_tag(char* p, double pwr) {
-#define skip_all(x) if (*p == (x)) ++p; else { \
-	while ((*p != (x)) && (*p != '}') && (*p != 0)) {++p;} }
-#define skip(x) if (*p == (x)) ++p; else { return p; }
-	
-	skip_all('\\');
-	if ((*p == '}') || (*p == 0))
-		return p;
-
-	if (mystrcmp(&p, "fsc")) {
-		char tp = *p++;
-		double val;
-		if (tp == 'x') {
-			if (mystrtod(&p, &val)) {
-				val /= 100;
-				render_context.scale_x = render_context.scale_x * ( 1 - pwr) + val * pwr;
-			} else
-				render_context.scale_x = render_context.style->ScaleX;
-		} else if (tp == 'y') {
-			if (mystrtod(&p, &val)) {
-				val /= 100;
-				render_context.scale_y = render_context.scale_y * ( 1 - pwr) + val * pwr;
-			} else
-				render_context.scale_y = render_context.style->ScaleY;
-		}
-	} else if (mystrcmp(&p, "fsp")) {
-		double val;
-		if (mystrtod(&p, &val))
-			render_context.hspacing = render_context.hspacing * ( 1 - pwr ) + val * pwr;
-		else
-			render_context.hspacing = render_context.style->Spacing;
-	} else if (mystrcmp(&p, "fs")) {
-		double val;
-		if (mystrtod(&p, &val))
-			val = render_context.font_size * ( 1 - pwr ) + val * pwr;
-		else
-			val = render_context.style->FontSize;
-		if (render_context.font)
-			change_font_size(val);
-	} else if (mystrcmp(&p, "bord")) {
-		double val;
-		if (mystrtod(&p, &val))
-			val = render_context.border * ( 1 - pwr ) + val * pwr;
-		else
-			val = -1.; // reset to default
-		change_border(val);
-	} else if (mystrcmp(&p, "move")) {
-		int x1, x2, y1, y2;
-		long long t1, t2, delta_t, t;
-		int x, y;
-		double k;
-		skip('(');
-		x1 = strtol(p, &p, 10);
-		skip(',');
-		y1 = strtol(p, &p, 10);
-		skip(',');
-		x2 = strtol(p, &p, 10);
-		skip(',');
-		y2 = strtol(p, &p, 10);
-		if (*p == ',') {
-			skip(',');
-			t1 = strtoll(p, &p, 10);
-			skip(',');
-			t2 = strtoll(p, &p, 10);
-			mp_msg(MSGT_ASS, MSGL_DBG2, "movement6: (%d, %d) -> (%d, %d), (%" PRId64 " .. %" PRId64 ")\n", 
-				x1, y1, x2, y2, (int64_t)t1, (int64_t)t2);
-		} else {
-			t1 = 0;
-			t2 = render_context.event->Duration;
-			mp_msg(MSGT_ASS, MSGL_DBG2, "movement: (%d, %d) -> (%d, %d)\n", x1, y1, x2, y2);
-		}
-		skip(')');
-		delta_t = t2 - t1;
-		t = frame_context.time - render_context.event->Start;
-		if (t < t1)
-			k = 0.;
-		else if (t > t2)
-			k = 1.;
-		else k = ((double)(t - t1)) / delta_t;
-		x = k * (x2 - x1) + x1;
-		y = k * (y2 - y1) + y1;
-		render_context.pos_x = x;
-		render_context.pos_y = y;
-		render_context.detect_collisions = 0;
-		render_context.evt_type = EVENT_POSITIONED;
-	} else if (mystrcmp(&p, "frx")) {
-		double val;
-		if (mystrtod(&p, &val)) {
-			val *= M_PI / 180;
-			render_context.frx = val * pwr + render_context.frx * (1-pwr);
-		} else
-			render_context.frx = 0.;
-	} else if (mystrcmp(&p, "fry")) {
-		double val;
-		if (mystrtod(&p, &val)) {
-			val *= M_PI / 180;
-			render_context.fry = val * pwr + render_context.fry * (1-pwr);
-		} else
-			render_context.fry = 0.;
-	} else if (mystrcmp(&p, "frz") || mystrcmp(&p, "fr")) {
-		double val;
-		if (mystrtod(&p, &val)) {
-			val *= M_PI / 180;
-			render_context.frz = val * pwr + render_context.frz * (1-pwr);
-		} else
-			render_context.frz = M_PI * render_context.style->Angle / 180.;
-	} else if (mystrcmp(&p, "fn")) {
-		char* start = p;
-		char* family;
-		skip_all('\\');
-		if (p > start) {
-			family = malloc(p - start + 1);
-			strncpy(family, start, p - start);
-			family[p - start] = '\0';
-		} else
-			family = strdup(render_context.style->FontName);
-		if (render_context.family)
-			free(render_context.family);
-		render_context.family = family;
-		update_font();
-	} else if (mystrcmp(&p, "alpha")) {
-		uint32_t val;
-		int i;
-		if (strtocolor(&p, &val)) {
-			unsigned char a = val >> 24;
-			for (i = 0; i < 4; ++i)
-				change_alpha(&render_context.c[i], a, pwr);
-		} else {
-			change_alpha(&render_context.c[0], render_context.style->PrimaryColour, pwr);
-			change_alpha(&render_context.c[1], render_context.style->SecondaryColour, pwr);
-			change_alpha(&render_context.c[2], render_context.style->OutlineColour, pwr);
-			change_alpha(&render_context.c[3], render_context.style->BackColour, pwr);
-		}
-		// FIXME: simplify
-	} else if (mystrcmp(&p, "an")) {
-		int val;
-		if (mystrtoi(&p, 10, &val) && val) {
-			int v = (val - 1) / 3; // 0, 1 or 2 for vertical alignment
-			mp_msg(MSGT_ASS, MSGL_DBG2, "an %d\n", val);
-			if (v != 0) v = 3 - v;
-			val = ((val - 1) % 3) + 1; // horizontal alignment
-			val += v*4;
-			mp_msg(MSGT_ASS, MSGL_DBG2, "align %d\n", val);
-			render_context.alignment = val;
-		} else
-			render_context.alignment = render_context.style->Alignment;
-	} else if (mystrcmp(&p, "a")) {
-		int val;
-		if (mystrtoi(&p, 10, &val) && val)
-			render_context.alignment = val;
-		else
-			render_context.alignment = render_context.style->Alignment;
-	} else if (mystrcmp(&p, "pos")) {
-		int v1, v2;
-		skip('(');
-		v1 = strtol(p, &p, 10);
-		skip(',');
-		v2 = strtol(p, &p, 10);
-		skip(')');
-		mp_msg(MSGT_ASS, MSGL_DBG2, "pos(%d, %d)\n", v1, v2);
-		render_context.evt_type = EVENT_POSITIONED;
-		render_context.detect_collisions = 0;
-		render_context.pos_x = v1;
-		render_context.pos_y = v2;
-	} else if (mystrcmp(&p, "fad")) {
-		int a1, a2, a3;
-		long long t1, t2, t3, t4;
-		if (*p == 'e') ++p; // either \fad or \fade
-		skip('(');
-		a1 = strtol(p, &p, 10);
-		skip(',');
-		a2 = strtol(p, &p, 10);
-		if (*p == ')') {
-			// 2-argument version (\fad, according to specs)
-			// a1 and a2 are fade-in and fade-out durations
-			t1 = 0;
-			t4 = render_context.event->Duration;
-			t2 = a1;
-			t3 = t4 - a2;
-			a1 = 0xFF;
-			a2 = 0;
-			a3 = 0xFF;
-		} else {
-			// 6-argument version (\fade)
-			// a1 and a2 (and a3) are opacity values
-			skip(',');
-			a3 = strtol(p, &p, 10);
-			skip(',');
-			t1 = strtoll(p, &p, 10);
-			skip(',');
-			t2 = strtoll(p, &p, 10);
-			skip(',');
-			t3 = strtoll(p, &p, 10);
-			skip(',');
-			t4 = strtoll(p, &p, 10);
-		}
-		skip(')');
-		render_context.fade = interpolate_alpha(frame_context.time - render_context.event->Start, t1, t2, t3, t4, a1, a2, a3);
-	} else if (mystrcmp(&p, "org")) {
-		int v1, v2;
-		skip('(');
-		v1 = strtol(p, &p, 10);
-		skip(',');
-		v2 = strtol(p, &p, 10);
-		skip(')');
-		mp_msg(MSGT_ASS, MSGL_DBG2, "org(%d, %d)\n", v1, v2);
-		//				render_context.evt_type = EVENT_POSITIONED;
-		render_context.org_x = v1;
-		render_context.org_y = v2;
-		render_context.have_origin = 1;
-	} else if (mystrcmp(&p, "t")) {
-		double v[3];
-		int v1, v2;
-		double v3;
-		int cnt;
-		long long t1, t2, t, delta_t;
-		double k;
-		skip('(');
-		for (cnt = 0; cnt < 3; ++cnt) {
-			if (*p == '\\')
-				break;
-			v[cnt] = strtod(p, &p);
-			skip(',');
-		}
-		if (cnt == 3) {
-			v1 = v[0]; v2 = v[1]; v3 = v[2];
-		} else if (cnt == 2) {
-			v1 = v[0]; v2 = v[1]; v3 = 1.;
-		} else if (cnt == 1) {
-			v1 = 0; v2 = render_context.event->Duration; v3 = v[0];
-		} else { // cnt == 0
-			v1 = 0; v2 = render_context.event->Duration; v3 = 1.;
-		}
-		render_context.detect_collisions = 0;
-		t1 = v1;
-		t2 = v2;
-		delta_t = v2 - v1;
-		if (v3 < 0.)
-			v3 = 0.;
-		t = frame_context.time - render_context.event->Start; // FIXME: move to render_context
-		if (t <= t1)
-			k = 0.;
-		else if (t >= t2)
-			k = 1.;
-		else {
-			assert(delta_t != 0.);
-			k = pow(((double)(t - t1)) / delta_t, v3);
-		}
-		while (*p == '\\')
-			p = parse_tag(p, k); // maybe k*pwr ? no, specs forbid nested \t's 
-		skip_all(')'); // FIXME: better skip(')'), but much more tags support required
-	} else if (mystrcmp(&p, "clip")) {
-		int x0, y0, x1, y1;
-		int res = 1;
-		skip('(');
-		res &= mystrtoi(&p, 10, &x0);
-		skip(',');
-		res &= mystrtoi(&p, 10, &y0);
-		skip(',');
-		res &= mystrtoi(&p, 10, &x1);
-		skip(',');
-		res &= mystrtoi(&p, 10, &y1);
-		skip(')');
-		if (res) {
-			render_context.clip_x0 = render_context.clip_x0 * (1-pwr) + x0 * pwr;
-			render_context.clip_x1 = render_context.clip_x1 * (1-pwr) + x1 * pwr;
-			render_context.clip_y0 = render_context.clip_y0 * (1-pwr) + y0 * pwr;
-			render_context.clip_y1 = render_context.clip_y1 * (1-pwr) + y1 * pwr;
-		} else {
-			render_context.clip_x0 = 0;
-			render_context.clip_y0 = 0;
-			render_context.clip_x1 = frame_context.track->PlayResX;
-			render_context.clip_y1 = frame_context.track->PlayResY;
-		}
-	} else if (mystrcmp(&p, "c")) {
-		uint32_t val;
-		if (!strtocolor(&p, &val))
-			val = render_context.style->PrimaryColour;
-		mp_msg(MSGT_ASS, MSGL_DBG2, "color: %X\n", val);
-		change_color(&render_context.c[0], val, pwr);
-	} else if ((*p >= '1') && (*p <= '4') && (++p) && (mystrcmp(&p, "c") || mystrcmp(&p, "a"))) {
-		char n = *(p-2);
-		int cidx = n - '1';
-		char cmd = *(p-1);
-		uint32_t val;
-		assert((n >= '1') && (n <= '4'));
-		if (!strtocolor(&p, &val))
-			switch(n) {
-				case '1': val = render_context.style->PrimaryColour; break;
-				case '2': val = render_context.style->SecondaryColour; break;
-				case '3': val = render_context.style->OutlineColour; break;
-				case '4': val = render_context.style->BackColour; break;
-				default : val = 0; break; // impossible due to assert; avoid compilation warning
-			}
-		switch (cmd) {
-			case 'c': change_color(render_context.c + cidx, val, pwr); break;
-			case 'a': change_alpha(render_context.c + cidx, val >> 24, pwr); break;
-			default: mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_BadCommand, n, cmd); break;
-		}
-		mp_msg(MSGT_ASS, MSGL_DBG2, "single c/a at %f: %c%c = %X   \n", pwr, n, cmd, render_context.c[cidx]);
-	} else if (mystrcmp(&p, "r")) {
-		reset_render_context();
-	} else if (mystrcmp(&p, "be")) {
-		int val;
-		if (mystrtoi(&p, 10, &val))
-			render_context.be = val ? 1 : 0;
-		else
-			render_context.be = 0;
-	} else if (mystrcmp(&p, "b")) {
-		int b;
-		if (mystrtoi(&p, 10, &b)) {
-			if (pwr >= .5)
-				render_context.bold = b;
-		} else
-			render_context.bold = render_context.style->Bold;
-		update_font();
-	} else if (mystrcmp(&p, "i")) {
-		int i;
-		if (mystrtoi(&p, 10, &i)) {
-			if (pwr >= .5)
-				render_context.italic = i;
-		} else
-			render_context.italic = render_context.style->Italic;
-		update_font();
-	} else if (mystrcmp(&p, "kf") || mystrcmp(&p, "K")) {
-		int val = strtol(p, &p, 10);
-		render_context.effect_type = EF_KARAOKE_KF;
-		if (render_context.effect_timing)
-			render_context.effect_skip_timing += render_context.effect_timing;
-		render_context.effect_timing = val * 10;
-	} else if (mystrcmp(&p, "ko")) {
-		int val = strtol(p, &p, 10);
-		render_context.effect_type = EF_KARAOKE_KO;
-		if (render_context.effect_timing)
-			render_context.effect_skip_timing += render_context.effect_timing;
-		render_context.effect_timing = val * 10;
-	} else if (mystrcmp(&p, "k")) {
-		int val = strtol(p, &p, 10);
-		render_context.effect_type = EF_KARAOKE;
-		if (render_context.effect_timing)
-			render_context.effect_skip_timing += render_context.effect_timing;
-		render_context.effect_timing = val * 10;
-	} else if (mystrcmp(&p, "shad")) {
-		int val;
-		if (mystrtoi(&p, 10, &val))
-			render_context.shadow = val;
-		else
-			render_context.shadow = render_context.style->Shadow;
-	}
-
-	return p;
-
-#undef skip
-#undef skip_all
-}
-
-/**
- * \brief Get next ucs4 char from string, parsing and executing style overrides
- * \param str string pointer
- * \return ucs4 code of the next char
- * On return str points to the unparsed part of the string
- */
-static unsigned get_next_char(char** str)
-{
-	char* p = *str;
-	unsigned chr;
-	if (*p == '{') { // '\0' goes here
-		p++;
-		while (1) {
-			p = parse_tag(p, 1.);
-			if (*p == '}') { // end of tag
-				p++;
-				if (*p == '{') {
-					p++;
-					continue;
-				} else
-					break;
-			} else if (*p != '\\')
-				mp_msg(MSGT_ASS, MSGL_V, "Unable to parse: \"%s\" \n", p);
-			if (*p == 0)
-				break;
-		}
-	}
-	if (*p == '\t') {
-		++p;
-		*str = p;
-		return ' ';
-	}
-	if (*p == '\\') {
-		if ((*(p+1) == 'N') || ((*(p+1) == 'n') && (frame_context.track->WrapStyle == 2))) {
-			p += 2;
-			*str = p;
-			return '\n';
-		} else if (*(p+1) == 'n') {
-			p += 2;
-			*str = p;
-			return ' ';
-		}
-	}
-	chr = utf8_get_char(&p);
-	*str = p;
-	return chr;
-}
-
-static void apply_transition_effects(ass_event_t* event)
-{
-	int v[4];
-	int cnt;
-	char* p = event->Effect;
-
-	if (!p || !*p) return;
-
-	cnt = 0;
-	while (cnt < 4 && (p = strchr(p, ';'))) {
-		v[cnt++] = atoi(++p);
-	}
-	
-	if (strncmp(event->Effect, "Banner;", 7) == 0) {
-		int delay;
-		if (cnt < 1) {
-			mp_msg(MSGT_ASS, MSGL_V, "Error parsing effect: %s \n", event->Effect);
-			return;
-		}
-		if (cnt >= 2 && v[1] == 0) // right-to-left
-			render_context.scroll_direction = SCROLL_RL;
-		else // left-to-right
-			render_context.scroll_direction = SCROLL_LR;
-
-		delay = v[0];
-		if (delay == 0) delay = 1; // ?
-		render_context.scroll_shift = (frame_context.time - render_context.event->Start) / delay;
-		render_context.evt_type = EVENT_HSCROLL;
-		return;
-	}
-
-	if (strncmp(event->Effect, "Scroll up;", 10) == 0) {
-		render_context.scroll_direction = SCROLL_BT;
-	} else if (strncmp(event->Effect, "Scroll down;", 12) == 0) {
-		render_context.scroll_direction = SCROLL_TB;
-	} else {
-		mp_msg(MSGT_ASS, MSGL_V, "Unknown transition effect: %s \n", event->Effect);
-		return;
-	}
-	// parse scroll up/down parameters
-	{
-		int delay;
-		int y0, y1;
-		if (cnt < 3) {
-			mp_msg(MSGT_ASS, MSGL_V, "Error parsing effect: %s \n", event->Effect);
-			return;
-		}
-		delay = v[2];
-		if (delay == 0) delay = 1; // ?
-		render_context.scroll_shift = (frame_context.time - render_context.event->Start) / delay;
-		if (v[0] < v[1]) {
-			y0 = v[0]; y1 = v[1];
-		} else {
-			y0 = v[1]; y1 = v[0];
-		}
-		if (y1 == 0)
-			y1 = frame_context.track->PlayResY; // y0=y1=0 means fullscreen scrolling
-		render_context.clip_y0 = y0;
-		render_context.clip_y1 = y1;
-		render_context.evt_type = EVENT_VSCROLL;
-		render_context.detect_collisions = 0;
-	}
-
-}
-
-/**
- * \brief partially reset render_context to style values
- * Works like {\r}: resets some style overrides
- */
-static void reset_render_context(void)
-{
-	render_context.c[0] = render_context.style->PrimaryColour;
-	render_context.c[1] = render_context.style->SecondaryColour;
-	render_context.c[2] = render_context.style->OutlineColour;
-	render_context.c[3] = render_context.style->BackColour;
-	render_context.font_size = render_context.style->FontSize;
-
-	if (render_context.family)
-		free(render_context.family);
-	render_context.family = strdup(render_context.style->FontName);
-	render_context.bold = render_context.style->Bold;
-	render_context.italic = render_context.style->Italic;
-	update_font();
-
-	change_border(-1.);
-	render_context.scale_x = render_context.style->ScaleX;
-	render_context.scale_y = render_context.style->ScaleY;
-	render_context.hspacing = render_context.style->Spacing;
-	render_context.be = 0;
-	render_context.shadow = render_context.style->Shadow;
-	render_context.frx = render_context.fry = 0.;
-	render_context.frz = M_PI * render_context.style->Angle / 180.;
-
-	// FIXME: does not reset unsupported attributes.
-}
-
-/**
- * \brief Start new event. Reset render_context.
- */
-static void init_render_context(ass_event_t* event)
-{
-	render_context.event = event;
-	render_context.style = frame_context.track->styles + event->Style;
-
-	reset_render_context();
-
-	render_context.evt_type = EVENT_NORMAL;
-	render_context.alignment = render_context.style->Alignment;
-	render_context.pos_x = 0;
-	render_context.pos_y = 0;
-	render_context.org_x = 0;
-	render_context.org_y = 0;
-	render_context.have_origin = 0;
-	render_context.clip_x0 = 0;
-	render_context.clip_y0 = 0;
-	render_context.clip_x1 = frame_context.track->PlayResX;
-	render_context.clip_y1 = frame_context.track->PlayResY;
-	render_context.detect_collisions = 1;
-	render_context.fade = 0;
-	render_context.effect_type = EF_NONE;
-	render_context.effect_timing = 0;
-	render_context.effect_skip_timing = 0;
-	
-	apply_transition_effects(event);
-}
-
-static void free_render_context(void)
-{
-}
-
-/**
- * \brief Get normal and outline (border) glyphs
- * \param symbol ucs4 char
- * \param info out: struct filled with extracted data
- * \param advance subpixel shift vector used for cache lookup
- * Tries to get both glyphs from cache.
- * If they can't be found, gets a glyph from font face, generates outline with FT_Stroker,
- * and add them to cache.
- * The glyphs are returned in info->glyph and info->outline_glyph
- */
-static void get_outline_glyph(int symbol, glyph_info_t* info, FT_Vector* advance)
-{
-	int error;
-	glyph_hash_val_t* val;
-	glyph_hash_key_t key;
-	key.font = render_context.font;
-	key.size = render_context.font_size;
-	key.ch = symbol;
-	key.scale_x = (render_context.scale_x * 0xFFFF);
-	key.scale_y = (render_context.scale_y * 0xFFFF);
-	key.advance = *advance;
-	key.bold = render_context.bold;
-	key.italic = render_context.italic;
-	key.outline = render_context.border * 0xFFFF;
-
-	info->glyph = info->outline_glyph = 0;
-
-	val = cache_find_glyph(&key);
-	if (val) {
-		FT_Glyph_Copy(val->glyph, &info->glyph);
-		if (val->outline_glyph)
-			FT_Glyph_Copy(val->outline_glyph, &info->outline_glyph);
-		info->bbox = val->bbox_scaled;
-		info->advance.x = val->advance.x;
-		info->advance.y = val->advance.y;
-	} else {
-		glyph_hash_val_t v;
-		info->glyph = ass_font_get_glyph(frame_context.ass_priv->fontconfig_priv, render_context.font, symbol, global_settings->hinting);
-		if (!info->glyph)
-			return;
-		info->advance.x = d16_to_d6(info->glyph->advance.x);
-		info->advance.y = d16_to_d6(info->glyph->advance.y);
-		FT_Glyph_Get_CBox( info->glyph, FT_GLYPH_BBOX_PIXELS, &info->bbox);
-
-		if (render_context.stroker) {
-			info->outline_glyph = info->glyph;
-			error = FT_Glyph_StrokeBorder( &(info->outline_glyph), render_context.stroker, 0 , 0 ); // don't destroy original
-			if (error) {
-				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_FT_Glyph_Stroke_Error, error);
-			}
-		}
-
-		memset(&v, 0, sizeof(v));
-		FT_Glyph_Copy(info->glyph, &v.glyph);
-		if (info->outline_glyph)
-			FT_Glyph_Copy(info->outline_glyph, &v.outline_glyph);
-		v.advance = info->advance;
-		v.bbox_scaled = info->bbox;
-		cache_add_glyph(&key, &v);
-	}
-}
-
-static void transform_3d(FT_Vector shift, FT_Glyph* glyph, FT_Glyph* glyph2, double frx, double fry, double frz);
-
-/**
- * \brief Get bitmaps for a glyph
- * \param info glyph info
- * Tries to get glyph bitmaps from bitmap cache.
- * If they can't be found, they are generated by rotating and rendering the glyph.
- * After that, bitmaps are added to the cache.
- * They are returned in info->bm (glyph), info->bm_o (outline) and info->bm_s (shadow).
- */
-static void get_bitmap_glyph(glyph_info_t* info)
-{
-	bitmap_hash_val_t* val;
-	bitmap_hash_key_t* key = &info->hash_key;
-	
-	val = cache_find_bitmap(key);
-/* 	val = 0; */
-	
-	if (val) {
-		info->bm = val->bm;
-		info->bm_o = val->bm_o;
-		info->bm_s = val->bm_s;
-	} else {
-		FT_Vector shift;
-		bitmap_hash_val_t hash_val;
-		int error;
-		info->bm = info->bm_o = info->bm_s = 0;
-		if (info->glyph && info->symbol != '\n' && info->symbol != 0) {
-			// calculating rotation shift vector (from rotation origin to the glyph basepoint)
-			shift.x = int_to_d6(info->hash_key.shift_x);
-			shift.y = int_to_d6(info->hash_key.shift_y);
-			// apply rotation
-			transform_3d(shift, &info->glyph, &info->outline_glyph, info->frx, info->fry, info->frz);
-
-			// render glyph
-			error = glyph_to_bitmap(ass_renderer->synth_priv,
-					info->glyph, info->outline_glyph,
-					&info->bm, &info->bm_o,
-					&info->bm_s, info->be);
-			if (error)
-				info->symbol = 0;
-
-			// add bitmaps to cache
-			hash_val.bm_o = info->bm_o;
-			hash_val.bm = info->bm;
-			hash_val.bm_s = info->bm_s;
-			cache_add_bitmap(&(info->hash_key), &hash_val);
-		}
-	}
-	// deallocate glyphs
-	if (info->glyph)
-		FT_Done_Glyph(info->glyph);
-	if (info->outline_glyph)
-		FT_Done_Glyph(info->outline_glyph);
-}
-
-/**
- * This function goes through text_info and calculates text parameters.
- * The following text_info fields are filled:
- *   height
- *   lines[].height
- *   lines[].asc
- *   lines[].desc
- */
-static void measure_text(void)
-{
-	int cur_line = 0, max_asc = 0, max_desc = 0;
-	int i;
-	text_info.height = 0;
-	for (i = 0; i < text_info.length + 1; ++i) {
-		if ((i == text_info.length) || text_info.glyphs[i].linebreak) {
-			text_info.lines[cur_line].asc = max_asc;
-			text_info.lines[cur_line].desc = max_desc;
-			text_info.height += max_asc + max_desc;
-			cur_line ++;
-			max_asc = max_desc = 0;
-		}
-		if (i < text_info.length) {
-			glyph_info_t* cur = text_info.glyphs + i;
-			if (cur->asc > max_asc)
-				max_asc = cur->asc;
-			if (cur->desc > max_desc)
-				max_desc = cur->desc;
-		}
-	}
-	text_info.height += (text_info.n_lines - 1) * double_to_d6(global_settings->line_spacing);
-}
-
-/**
- * \brief rearrange text between lines
- * \param max_text_width maximal text line width in pixels
- * The algo is similar to the one in libvo/sub.c:
- * 1. Place text, wrapping it when current line is full
- * 2. Try moving words from the end of a line to the beginning of the next one while it reduces
- * the difference in lengths between this two lines.
- * The result may not be optimal, but usually is good enough.
- */
-static void wrap_lines_smart(int max_text_width)
-{
-	int i, j;
-	glyph_info_t *cur, *s1, *e1, *s2, *s3, *w;
-	int last_space;
-	int break_type;
-	int exit;
-	int pen_shift_x;
-	int pen_shift_y;
-	int cur_line;
-
-	last_space = -1;
-	text_info.n_lines = 1;
-	break_type = 0;
-	s1 = text_info.glyphs; // current line start
-	for (i = 0; i < text_info.length; ++i) {
-		int break_at, s_offset, len;
-		cur = text_info.glyphs + i;
-		break_at = -1;
-		s_offset = s1->bbox.xMin + s1->pos.x;
-		len = (cur->bbox.xMax + cur->pos.x) - s_offset;
-
-		if (cur->symbol == '\n') {
-			break_type = 2;
-			break_at = i;
-			mp_msg(MSGT_ASS, MSGL_DBG2, "forced line break at %d\n", break_at);
-		}
-		
-		if (len >= max_text_width) {
-			break_type = 1;
-			break_at = last_space;
-			if (break_at == -1)
-				break_at = i - 1;
-			if (break_at == -1)
-				break_at = 0;
-			mp_msg(MSGT_ASS, MSGL_DBG2, "overfill at %d\n", i);
-			mp_msg(MSGT_ASS, MSGL_DBG2, "line break at %d\n", break_at);
-		}
-
-		if (break_at != -1) {
-			// need to use one more line
-			// marking break_at+1 as start of a new line
-			int lead = break_at + 1; // the first symbol of the new line
-			if (text_info.n_lines >= MAX_LINES) {
-				// to many lines ! 
-				// no more linebreaks
-				for (j = lead; j < text_info.length; ++j)
-					text_info.glyphs[j].linebreak = 0;
-				break;
-			}
-			if (lead < text_info.length)
-				text_info.glyphs[lead].linebreak = break_type;
-			last_space = -1;
-			s1 = text_info.glyphs + lead;
-			s_offset = s1->bbox.xMin + s1->pos.x;
-			text_info.n_lines ++;
-		}
-		
-		if (cur->symbol == ' ')
-			last_space = i;
-
-		// make sure the hard linebreak is not forgotten when
-		// there was a new soft linebreak just inserted
-		if (cur->symbol == '\n' && break_type == 1)
-			i--;
-	}
-#define DIFF(x,y) (((x) < (y)) ? (y - x) : (x - y))
-	exit = 0;
-	while (!exit) {
-		exit = 1;
-		w = s3 = text_info.glyphs;
-		s1 = s2 = 0;
-		for (i = 0; i <= text_info.length; ++i) {
-			cur = text_info.glyphs + i;
-			if ((i == text_info.length) || cur->linebreak) {
-				s1 = s2;
-				s2 = s3;
-				s3 = cur;
-				if (s1 && (s2->linebreak == 1)) { // have at least 2 lines, and linebreak is 'soft'
-					int l1, l2, l1_new, l2_new;
-
-					w = s2;
-					do { --w; } while ((w > s1) && (w->symbol == ' '));
-					while ((w > s1) && (w->symbol != ' ')) { --w; }
-					e1 = w;
-					while ((e1 > s1) && (e1->symbol == ' ')) { --e1; }
-					if (w->symbol == ' ') ++w;
-
-					l1 = ((s2-1)->bbox.xMax + (s2-1)->pos.x) - (s1->bbox.xMin + s1->pos.x);
-					l2 = ((s3-1)->bbox.xMax + (s3-1)->pos.x) - (s2->bbox.xMin + s2->pos.x);
-					l1_new = (e1->bbox.xMax + e1->pos.x) - (s1->bbox.xMin + s1->pos.x);
-					l2_new = ((s3-1)->bbox.xMax + (s3-1)->pos.x) - (w->bbox.xMin + w->pos.x);
-
-					if (DIFF(l1_new, l2_new) < DIFF(l1, l2)) {
-						w->linebreak = 1;
-						s2->linebreak = 0;
-						exit = 0;
-					}
-				}
-			}
-			if (i == text_info.length)
-				break;
-		}
-		
-	}
-	assert(text_info.n_lines >= 1);
-#undef DIFF
-	
-	measure_text();
-
-	pen_shift_x = 0;
-	pen_shift_y = 0;
-	cur_line = 1;
-	for (i = 0; i < text_info.length; ++i) {
-		cur = text_info.glyphs + i;
-		if (cur->linebreak) {
-			int height = text_info.lines[cur_line - 1].desc + text_info.lines[cur_line].asc;
-			cur_line ++;
-			pen_shift_x = - cur->pos.x;
-			pen_shift_y += d6_to_int(height + double_to_d6(global_settings->line_spacing));
-			mp_msg(MSGT_ASS, MSGL_DBG2, "shifting from %d to %d by (%d, %d)\n", i, text_info.length - 1, pen_shift_x, pen_shift_y);
-		}
-		cur->pos.x += pen_shift_x;
-		cur->pos.y += pen_shift_y;
-	}
-}
-
-/**
- * \brief determine karaoke effects
- * Karaoke effects cannot be calculated during parse stage (get_next_char()),
- * so they are done in a separate step.
- * Parse stage: when karaoke style override is found, its parameters are stored in the next glyph's 
- * (the first glyph of the karaoke word)'s effect_type and effect_timing.
- * This function:
- * 1. sets effect_type for all glyphs in the word (_karaoke_ word)
- * 2. sets effect_timing for all glyphs to x coordinate of the border line between the left and right karaoke parts
- * (left part is filled with PrimaryColour, right one - with SecondaryColour).
- */
-static void process_karaoke_effects(void)
-{
-	glyph_info_t *cur, *cur2;
-	glyph_info_t *s1, *e1; // start and end of the current word
-	glyph_info_t *s2; // start of the next word
-	int i;
-	int timing; // current timing
-	int tm_start, tm_end; // timings at start and end of the current word
-	int tm_current;
-	double dt;
-	int x;
-	int x_start, x_end;
-
-	tm_current = frame_context.time - render_context.event->Start;
-	timing = 0;
-	s1 = s2 = 0;
-	for (i = 0; i <= text_info.length; ++i) {
-		cur = text_info.glyphs + i;
-		if ((i == text_info.length) || (cur->effect_type != EF_NONE)) {
-			s1 = s2;
-			s2 = cur;
-			if (s1) {
-				e1 = s2 - 1;
-				tm_start = timing + s1->effect_skip_timing;
-				tm_end = tm_start + s1->effect_timing;
-				timing = tm_end;
-				x_start = 1000000;
-				x_end = -1000000;
-				for (cur2 = s1; cur2 <= e1; ++cur2) {
-					x_start = FFMIN(x_start, cur2->bbox.xMin + cur2->pos.x);
-					x_end = FFMAX(x_end, cur2->bbox.xMax + cur2->pos.x);
-				}
-
-				dt = (tm_current - tm_start);
-				if ((s1->effect_type == EF_KARAOKE) || (s1->effect_type == EF_KARAOKE_KO)) {
-					if (dt > 0)
-						x = x_end + 1;
-					else
-						x = x_start;
-				} else if (s1->effect_type == EF_KARAOKE_KF) {
-					dt /= (tm_end - tm_start);
-					x = x_start + (x_end - x_start) * dt;
-				} else {
-					mp_msg(MSGT_ASS, MSGL_ERR, MSGTR_LIBASS_UnknownEffectType_InternalError);
-					continue;
-				}
-
-				for (cur2 = s1; cur2 <= e1; ++cur2) {
-					cur2->effect_type = s1->effect_type;
-					cur2->effect_timing = x - cur2->pos.x;
-				}
-			}
-		}
-	}
-}
-
-/**
- * \brief Calculate base point for positioning and rotation
- * \param bbox text bbox
- * \param alignment alignment
- * \param bx, by out: base point coordinates
- */
-static void get_base_point(FT_BBox bbox, int alignment, int* bx, int* by)
-{
-	const int halign = alignment & 3;
-	const int valign = alignment & 12;
-	if (bx)
-		switch(halign) {
-		case HALIGN_LEFT:
-			*bx = bbox.xMin;
-			break;
-		case HALIGN_CENTER:
-			*bx = (bbox.xMax + bbox.xMin) / 2;
-			break;
-		case HALIGN_RIGHT:
-			*bx = bbox.xMax;
-			break;
-		}
-	if (by)
-		switch(valign) {
-		case VALIGN_TOP:
-			*by = bbox.yMin;
-			break;
-		case VALIGN_CENTER:
-			*by = (bbox.yMax + bbox.yMin) / 2;
-			break;
-		case VALIGN_SUB:
-			*by = bbox.yMax;
-			break;
-		}
-}
-
-/**
- * \brief Multiply 4-vector by 4-matrix
- * \param a 4-vector
- * \param m 4-matrix]
- * \param b out: 4-vector
- * Calculates a * m and stores result in b
- */
-static inline void transform_point_3d(double *a, double *m, double *b)
-{
-	b[0] = a[0] * m[0] + a[1] * m[4] + a[2] * m[8] +  a[3] * m[12];
-	b[1] = a[0] * m[1] + a[1] * m[5] + a[2] * m[9] +  a[3] * m[13];
-	b[2] = a[0] * m[2] + a[1] * m[6] + a[2] * m[10] + a[3] * m[14];
-	b[3] = a[0] * m[3] + a[1] * m[7] + a[2] * m[11] + a[3] * m[15];
-}
-
-/**
- * \brief Apply 3d transformation to a vector
- * \param v FreeType vector (2d)
- * \param m 4-matrix
- * Transforms v by m, projects the result back to the screen plane
- * Result is returned in v.
- */
-static inline void transform_vector_3d(FT_Vector* v, double *m) {
-	const double camera = 2500 * frame_context.border_scale; // camera distance
-	double a[4], b[4];
-	a[0] = d6_to_double(v->x);
-	a[1] = d6_to_double(v->y);
-	a[2] = 0.;
-	a[3] = 1.;
-	transform_point_3d(a, m, b);
-	/* Apply perspective projection with the following matrix:
-	   2500     0     0     0
-	      0  2500     0     0
-	      0     0     0     0
-	      0     0     8     2500
-	   where 2500 is camera distance, 8 - z-axis scale.
-	   Camera is always located in (org_x, org_y, -2500). This means
-	   that different subtitle events can be displayed at the same time
-	   using different cameras. */
-	b[0] *= camera;
-	b[1] *= camera;
-	b[3] = 8 * b[2] + camera;
-	if (b[3] < 0.001 && b[3] > -0.001)
-		b[3] = b[3] < 0. ? -0.001 : 0.001;
-	v->x = double_to_d6(b[0] / b[3]);
-	v->y = double_to_d6(b[1] / b[3]);
-}
-
-/**
- * \brief Apply 3d transformation to a glyph
- * \param glyph FreeType glyph
- * \param m 4-matrix
- * Transforms glyph by m, projects the result back to the screen plane
- * Result is returned in glyph.
- */
-static inline void transform_glyph_3d(FT_Glyph glyph, double *m, FT_Vector shift) {
-	int i;
-	FT_Outline* outline = &((FT_OutlineGlyph)glyph)->outline;
-	FT_Vector* p = outline->points;
-
-	for (i=0; i<outline->n_points; i++) {
-		p[i].x += shift.x;
-		p[i].y += shift.y;
-		transform_vector_3d(p + i, m);
-		p[i].x -= shift.x;
-		p[i].y -= shift.y;
-	}
-
-	//transform_vector_3d(&glyph->advance, m);
-}
-
-/**
- * \brief Apply 3d transformation to several objects
- * \param shift FreeType vector
- * \param glyph FreeType glyph
- * \param glyph2 FreeType glyph
- * \param frx x-axis rotation angle
- * \param fry y-axis rotation angle
- * \param frz z-axis rotation angle
- * Rotates both glyphs by frx, fry and frz. Shift vector is added before rotation and subtracted after it.
- */
-static void transform_3d(FT_Vector shift, FT_Glyph* glyph, FT_Glyph* glyph2, double frx, double fry, double frz)
-{
-	fry = - fry; // FreeType's y axis goes in the opposite direction
-	if (frx != 0. || fry != 0. || frz != 0.) {
-		double m[16];
-		double sx = sin(frx);
-		double sy = sin(fry);
- 		double sz = sin(frz);
-		double cx = cos(frx);
-		double cy = cos(fry);
-		double cz = cos(frz);
-		m[0] = cy * cz;            m[1] = cy*sz;              m[2]  = -sy;    m[3] = 0.0;
-		m[4] = -cx*sz + sx*sy*cz;  m[5] = cx*cz + sx*sy*sz;   m[6]  = sx*cy;  m[7] = 0.0;
-		m[8] = sx*sz + cx*sy*cz;   m[9] = -sx*cz + cx*sy*sz;  m[10] = cx*cy;  m[11] = 0.0;
-		m[12] = 0.0;               m[13] = 0.0;               m[14] = 0.0;    m[15] = 1.0;
-
-		if (glyph && *glyph)
-			transform_glyph_3d(*glyph, m, shift);
-
-		if (glyph2 && *glyph2)
-			transform_glyph_3d(*glyph2, m, shift);
-	}
-}
-
-/**
- * \brief Main ass rendering function, glues everything together
- * \param event event to render
- * Process event, appending resulting ass_image_t's to images_root.
- */
-static int ass_render_event(ass_event_t* event, event_images_t* event_images)
-{
-	char* p;
-	FT_UInt previous; 
-	FT_UInt num_glyphs;
-	FT_Vector pen;
-	unsigned code;
-	FT_BBox bbox;
-	int i, j;
-	FT_Vector shift;
-	int MarginL, MarginR, MarginV;
-	int last_break;
-	int alignment, halign, valign;
-	int device_x = 0, device_y = 0;
-
-	if (event->Style >= frame_context.track->n_styles) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_NoStyleFound);
-		return 1;
-	}
-	if (!event->Text) {
-		mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_EmptyEvent);
-		return 1;
-	}
-
-	init_render_context(event);
-
-	text_info.length = 0;
-	pen.x = 0;
-	pen.y = 0;
-	previous = 0;
-	num_glyphs = 0;
-	p = event->Text;
-	// Event parsing.
-	while (1) {
-		// get next char, executing style override
-		// this affects render_context
-		code = get_next_char(&p);
-		
-		// face could have been changed in get_next_char
-		if (!render_context.font) {
-			free_render_context();
-			return 1;
-		}
-
-		if (code == 0)
-			break;
-
-		if (text_info.length >= MAX_GLYPHS) {
-			mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_MAX_GLYPHS_Reached, 
-					(int)(event - frame_context.track->events), event->Start, event->Duration, event->Text);
-			break;
-		}
-
-		if ( previous && code ) {
-			FT_Vector delta;
-			delta = ass_font_get_kerning(render_context.font, previous, code);
-			pen.x += delta.x * render_context.scale_x;
-			pen.y += delta.y * render_context.scale_y;
-		}
-
-		shift.x = pen.x & 63;
-		shift.y = pen.y & 63;
-
-		ass_font_set_transform(render_context.font,
-				       render_context.scale_x * frame_context.font_scale_x,
-				       render_context.scale_y,
-				       &shift );
-
-		get_outline_glyph(code, text_info.glyphs + text_info.length, &shift);
-		
-		text_info.glyphs[text_info.length].pos.x = pen.x >> 6;
-		text_info.glyphs[text_info.length].pos.y = pen.y >> 6;
-		
-		pen.x += text_info.glyphs[text_info.length].advance.x;
-		pen.x += double_to_d6(render_context.hspacing);
-		pen.y += text_info.glyphs[text_info.length].advance.y;
-		
-		previous = code;
-
-		text_info.glyphs[text_info.length].symbol = code;
-		text_info.glyphs[text_info.length].linebreak = 0;
-		for (i = 0; i < 4; ++i) {
-			uint32_t clr = render_context.c[i];
-			change_alpha(&clr, mult_alpha(_a(clr), render_context.fade), 1.);
-			text_info.glyphs[text_info.length].c[i] = clr;
-		}
-		text_info.glyphs[text_info.length].effect_type = render_context.effect_type;
-		text_info.glyphs[text_info.length].effect_timing = render_context.effect_timing;
-		text_info.glyphs[text_info.length].effect_skip_timing = render_context.effect_skip_timing;
-		text_info.glyphs[text_info.length].be = render_context.be;
-		text_info.glyphs[text_info.length].shadow = render_context.shadow;
-		text_info.glyphs[text_info.length].frx = render_context.frx;
-		text_info.glyphs[text_info.length].fry = render_context.fry;
-		text_info.glyphs[text_info.length].frz = render_context.frz;
-		ass_font_get_asc_desc(render_context.font, code,
-				      &text_info.glyphs[text_info.length].asc,
-				      &text_info.glyphs[text_info.length].desc);
-		text_info.glyphs[text_info.length].asc *= render_context.scale_y;
-		text_info.glyphs[text_info.length].desc *= render_context.scale_y;
-
-		// fill bitmap_hash_key
-		text_info.glyphs[text_info.length].hash_key.font = render_context.font;
-		text_info.glyphs[text_info.length].hash_key.size = render_context.font_size;
-		text_info.glyphs[text_info.length].hash_key.outline = render_context.border * 0xFFFF;
-		text_info.glyphs[text_info.length].hash_key.scale_x = render_context.scale_x * 0xFFFF;
-		text_info.glyphs[text_info.length].hash_key.scale_y = render_context.scale_y * 0xFFFF;
-		text_info.glyphs[text_info.length].hash_key.frx = render_context.frx * 0xFFFF;
-		text_info.glyphs[text_info.length].hash_key.fry = render_context.fry * 0xFFFF;
-		text_info.glyphs[text_info.length].hash_key.frz = render_context.frz * 0xFFFF;
-		text_info.glyphs[text_info.length].hash_key.bold = render_context.bold;
-		text_info.glyphs[text_info.length].hash_key.italic = render_context.italic;
-		text_info.glyphs[text_info.length].hash_key.ch = code;
-		text_info.glyphs[text_info.length].hash_key.advance = shift;
-		text_info.glyphs[text_info.length].hash_key.be = render_context.be;
-
-		text_info.length++;
-
-		render_context.effect_type = EF_NONE;
-		render_context.effect_timing = 0;
-		render_context.effect_skip_timing = 0;
-	}
-	
-	if (text_info.length == 0) {
-		// no valid symbols in the event; this can be smth like {comment}
-		free_render_context();
-		return 1;
-	}
-	
-	// depends on glyph x coordinates being monotonous, so it should be done before line wrap
-	process_karaoke_effects();
-	
-	// alignments
-	alignment = render_context.alignment;
-	halign = alignment & 3;
-	valign = alignment & 12;
-
-	MarginL = (event->MarginL) ? event->MarginL : render_context.style->MarginL; 
-	MarginR = (event->MarginR) ? event->MarginR : render_context.style->MarginR; 
-	MarginV = (event->MarginV) ? event->MarginV : render_context.style->MarginV;
-
-	if (render_context.evt_type != EVENT_HSCROLL) {
-		int max_text_width;
-
-		// calculate max length of a line
-		max_text_width = x2scr(frame_context.track->PlayResX - MarginR) - x2scr(MarginL);
-
-		// rearrange text in several lines
-		wrap_lines_smart(max_text_width);
-
-		// align text
-		last_break = -1;
-		for (i = 1; i < text_info.length + 1; ++i) { // (text_info.length + 1) is the end of the last line
-			if ((i == text_info.length) || text_info.glyphs[i].linebreak) {
-				int width, shift = 0;
-				glyph_info_t* first_glyph = text_info.glyphs + last_break + 1;
-				glyph_info_t* last_glyph = text_info.glyphs + i - 1;
-
-				while ((last_glyph > first_glyph) && ((last_glyph->symbol == '\n') || (last_glyph->symbol == 0)))
-					last_glyph --;
-
-				width = last_glyph->pos.x + d6_to_int(last_glyph->advance.x) - first_glyph->pos.x;
-				if (halign == HALIGN_LEFT) { // left aligned, no action
-					shift = 0;
-				} else if (halign == HALIGN_RIGHT) { // right aligned
-					shift = max_text_width - width;
-				} else if (halign == HALIGN_CENTER) { // centered
-					shift = (max_text_width - width) / 2;
-				}
-				for (j = last_break + 1; j < i; ++j) {
-					text_info.glyphs[j].pos.x += shift;
-				}
-				last_break = i - 1;
-			}
-		}
-	} else { // render_context.evt_type == EVENT_HSCROLL
-		measure_text();
-	}
-	
-	// determing text bounding box
-	compute_string_bbox(&text_info, &bbox);
-	
-	// determine device coordinates for text
-	
-	// x coordinate for everything except positioned events
-	if (render_context.evt_type == EVENT_NORMAL ||
-	    render_context.evt_type == EVENT_VSCROLL) {
-		device_x = x2scr(MarginL);
-	} else if (render_context.evt_type == EVENT_HSCROLL) {
-		if (render_context.scroll_direction == SCROLL_RL)
-			device_x = x2scr(frame_context.track->PlayResX - render_context.scroll_shift);
-		else if (render_context.scroll_direction == SCROLL_LR)
-			device_x = x2scr(render_context.scroll_shift) - (bbox.xMax - bbox.xMin);
-	}
-
-	// y coordinate for everything except positioned events
-	if (render_context.evt_type == EVENT_NORMAL ||
-	    render_context.evt_type == EVENT_HSCROLL) {
-		if (valign == VALIGN_TOP) { // toptitle
-			device_y = y2scr_top(MarginV) + d6_to_int(text_info.lines[0].asc);
-		} else if (valign == VALIGN_CENTER) { // midtitle
-			int scr_y = y2scr(frame_context.track->PlayResY / 2);
-			device_y = scr_y - (bbox.yMax - bbox.yMin) / 2;
-		} else { // subtitle
-			int scr_y;
-			if (valign != VALIGN_SUB)
-				mp_msg(MSGT_ASS, MSGL_V, "Invalid valign, supposing 0 (subtitle)\n");
-			scr_y = y2scr_sub(frame_context.track->PlayResY - MarginV);
-			device_y = scr_y;
-			device_y -= d6_to_int(text_info.height);
-			device_y += d6_to_int(text_info.lines[0].asc);
-		}
-	} else if (render_context.evt_type == EVENT_VSCROLL) {
-		if (render_context.scroll_direction == SCROLL_TB)
-			device_y = y2scr(render_context.clip_y0 + render_context.scroll_shift) - (bbox.yMax - bbox.yMin);
-		else if (render_context.scroll_direction == SCROLL_BT)
-			device_y = y2scr(render_context.clip_y1 - render_context.scroll_shift);
-	}
-
-	// positioned events are totally different
-	if (render_context.evt_type == EVENT_POSITIONED) {
-		int base_x = 0;
-		int base_y = 0;
-		mp_msg(MSGT_ASS, MSGL_DBG2, "positioned event at %d, %d\n", render_context.pos_x, render_context.pos_y);
-		get_base_point(bbox, alignment, &base_x, &base_y);
-		device_x = x2scr(render_context.pos_x) - base_x;
-		device_y = y2scr(render_context.pos_y) - base_y;
-	}
-	
-	// fix clip coordinates (they depend on alignment)
-	render_context.clip_x0 = x2scr(render_context.clip_x0);
-	render_context.clip_x1 = x2scr(render_context.clip_x1);
-	if (render_context.evt_type == EVENT_NORMAL ||
-	    render_context.evt_type == EVENT_HSCROLL ||
-	    render_context.evt_type == EVENT_VSCROLL) {
-		if (valign == VALIGN_TOP) {
-			render_context.clip_y0 = y2scr_top(render_context.clip_y0);
-			render_context.clip_y1 = y2scr_top(render_context.clip_y1);
-		} else if (valign == VALIGN_CENTER) {
-			render_context.clip_y0 = y2scr(render_context.clip_y0);
-			render_context.clip_y1 = y2scr(render_context.clip_y1);
-		} else if (valign == VALIGN_SUB) {
-			render_context.clip_y0 = y2scr_sub(render_context.clip_y0);
-			render_context.clip_y1 = y2scr_sub(render_context.clip_y1);
-		}
-	} else if (render_context.evt_type == EVENT_POSITIONED) {
-		render_context.clip_y0 = y2scr(render_context.clip_y0);
-		render_context.clip_y1 = y2scr(render_context.clip_y1);
-	}
-
-	// calculate rotation parameters
-	{
-		FT_Vector center;
-		
-		if (render_context.have_origin) {
-			center.x = x2scr(render_context.org_x);
-			center.y = y2scr(render_context.org_y);
-		} else {
-			int bx, by;
-			get_base_point(bbox, alignment, &bx, &by);
-			center.x = device_x + bx;
-			center.y = device_y + by;
-		}
-
-		for (i = 0; i < text_info.length; ++i) {
-			glyph_info_t* info = text_info.glyphs + i;
-
-			if (info->hash_key.frx || info->hash_key.fry || info->hash_key.frz) {
-				info->hash_key.shift_x = info->pos.x + device_x - center.x;
-				info->hash_key.shift_y = - (info->pos.y + device_y - center.y);
-			} else {
-				info->hash_key.shift_x = 0;
-				info->hash_key.shift_y = 0;
-			}
-		}
-	}
-
-	// convert glyphs to bitmaps
-	for (i = 0; i < text_info.length; ++i)
-		get_bitmap_glyph(text_info.glyphs + i);
-
-	event_images->top = device_y - d6_to_int(text_info.lines[0].asc);
-	event_images->height = d6_to_int(text_info.height);
-	event_images->detect_collisions = render_context.detect_collisions;
-	event_images->shift_direction = (valign == VALIGN_TOP) ? 1 : -1;
-	event_images->event = event;
-	event_images->imgs = render_text(&text_info, device_x, device_y);
-
-	free_render_context();
-	
-	return 0;
-}
-
-/**
- * \brief deallocate image list
- * \param img list pointer
- */
-void ass_free_images(ass_image_t* img)
-{
-	while (img) {
-		ass_image_t* next = img->next;
-		free(img);
-		img = next;
-	}
-}
-
-static void ass_reconfigure(ass_renderer_t* priv)
-{
-	priv->render_id = ++last_render_id;
-	ass_glyph_cache_reset();
-	ass_bitmap_cache_reset();
-	ass_free_images(priv->prev_images_root);
-	priv->prev_images_root = 0;
-}
-
-void ass_set_frame_size(ass_renderer_t* priv, int w, int h)
-{
-	if (priv->settings.frame_width != w || priv->settings.frame_height != h) {
-		priv->settings.frame_width = w;
-		priv->settings.frame_height = h;
-		if (priv->settings.aspect == 0.)
-			priv->settings.aspect = ((double)w) / h;
-		ass_reconfigure(priv);
-	}
-}
-
-void ass_set_margins(ass_renderer_t* priv, int t, int b, int l, int r)
-{
-	if (priv->settings.left_margin != l ||
-	    priv->settings.right_margin != r ||
-	    priv->settings.top_margin != t ||
-	    priv->settings.bottom_margin != b) {
-		priv->settings.left_margin = l;
-		priv->settings.right_margin = r;
-		priv->settings.top_margin = t;
-		priv->settings.bottom_margin = b;
-		ass_reconfigure(priv);
-	}
-}
-
-void ass_set_use_margins(ass_renderer_t* priv, int use)
-{
-	priv->settings.use_margins = use;
-}
-
-void ass_set_aspect_ratio(ass_renderer_t* priv, double ar)
-{
-	if (priv->settings.aspect != ar) {
-		priv->settings.aspect = ar;
-		ass_reconfigure(priv);
-	}
-}
-
-void ass_set_font_scale(ass_renderer_t* priv, double font_scale)
-{
-	if (priv->settings.font_size_coeff != font_scale) {
-		priv->settings.font_size_coeff = font_scale;
-		ass_reconfigure(priv);
-	}
-}
-
-void ass_set_hinting(ass_renderer_t* priv, ass_hinting_t ht)
-{
-	if (priv->settings.hinting != ht) {
-		priv->settings.hinting = ht;
-		ass_reconfigure(priv);
-	}
-}
-
-void ass_set_line_spacing(ass_renderer_t* priv, double line_spacing)
-{
-	priv->settings.line_spacing = line_spacing;
-}
-
-int ass_set_fonts(ass_renderer_t* priv, const char* default_font, const char* default_family)
-{
-	if (priv->settings.default_font)
-		free(priv->settings.default_font);
-	if (priv->settings.default_family)
-		free(priv->settings.default_family);
-
-	priv->settings.default_font = default_font ? strdup(default_font) : 0;
-	priv->settings.default_family = default_family ? strdup(default_family) : 0;
-
-	if (priv->fontconfig_priv)
-		fontconfig_done(priv->fontconfig_priv);
-	priv->fontconfig_priv = fontconfig_init(priv->library, priv->ftlibrary, default_family, default_font);
-
-	return !!priv->fontconfig_priv;
-}
-
-/**
- * \brief Start a new frame
- */
-static int ass_start_frame(ass_renderer_t *priv, ass_track_t* track, long long now)
-{
-	ass_renderer = priv;
-	global_settings = &priv->settings;
-
-	if (!priv->settings.frame_width && !priv->settings.frame_height)
-		return 1; // library not initialized
-	
-	frame_context.ass_priv = priv;
-	frame_context.width = global_settings->frame_width;
-	frame_context.height = global_settings->frame_height;
-	frame_context.orig_width = global_settings->frame_width - global_settings->left_margin - global_settings->right_margin;
-	frame_context.orig_height = global_settings->frame_height - global_settings->top_margin - global_settings->bottom_margin;
-	frame_context.track = track;
-	frame_context.time = now;
-
-	ass_lazy_track_init();
-	
-	frame_context.font_scale = global_settings->font_size_coeff *
-	                           frame_context.orig_height / frame_context.track->PlayResY;
-	frame_context.border_scale = ((double)frame_context.orig_height) / frame_context.track->PlayResY;
-
-	if (frame_context.orig_width * track->PlayResY == frame_context.orig_height * track->PlayResX)
-		frame_context.font_scale_x = 1.;
-	else
-		frame_context.font_scale_x = ((double)(frame_context.orig_width * track->PlayResY)) / (frame_context.orig_height * track->PlayResX);
-
-	priv->prev_images_root = priv->images_root;
-	priv->images_root = 0;
-
-	return 0;
-}
-
-static int cmp_event_layer(const void* p1, const void* p2)
-{
-	ass_event_t* e1 = ((event_images_t*)p1)->event;
-	ass_event_t* e2 = ((event_images_t*)p2)->event;
-	if (e1->Layer < e2->Layer)
-		return -1;
-	if (e1->Layer > e2->Layer)
-		return 1;
-	if (e1->ReadOrder < e2->ReadOrder)
-		return -1;
-	if (e1->ReadOrder > e2->ReadOrder)
-		return 1;
-	return 0;
-}
-
-#define MAX_EVENTS 100
-
-static render_priv_t* get_render_priv(ass_event_t* event)
-{
-	if (!event->render_priv)
-		event->render_priv = calloc(1, sizeof(render_priv_t));
-	// FIXME: check render_id
-	if (ass_renderer->render_id != event->render_priv->render_id) {
-		memset(event->render_priv, 0, sizeof(render_priv_t));
-		event->render_priv->render_id = ass_renderer->render_id;
-	}
-	return event->render_priv;
-}
-
-typedef struct segment_s {
-	int a, b; // top and height
-} segment_t;
-
-static int overlap(segment_t* s1, segment_t* s2)
-{
-	if (s1->a >= s2->b || s2->a >= s1->b)
-		return 0;
-	return 1;
-}
-
-static int cmp_segment(const void* p1, const void* p2)
-{
-	return ((segment_t*)p1)->a - ((segment_t*)p2)->a;
-}
-
-static void shift_event(event_images_t* ei, int shift)
-{
-	ass_image_t* cur = ei->imgs;
-	while (cur) {
-		cur->dst_y += shift;
-		// clip top and bottom
-		if (cur->dst_y < 0) {
-			int clip = - cur->dst_y;
-			cur->h -= clip;
-			cur->bitmap += clip * cur->stride;
-			cur->dst_y = 0;
-		}
-		if (cur->dst_y + cur->h >= frame_context.height) {
-			int clip = cur->dst_y + cur->h - frame_context.height;
-			cur->h -= clip;
-		}
-		if (cur->h <= 0) {
-			cur->h = 0;
-			cur->dst_y = 0;
-		}
-		cur = cur->next;
-	}
-	ei->top += shift;
-}
-
-// dir: 1 - move down
-//      -1 - move up
-static int fit_segment(segment_t* s, segment_t* fixed, int* cnt, int dir)
-{
-	int i;
-	int shift = 0;
-
-	if (dir == 1) // move down
-		for (i = 0; i < *cnt; ++i) {
-			if (s->b + shift <= fixed[i].a || s->a + shift >= fixed[i].b)
-				continue;
-			shift = fixed[i].b - s->a;
-		}
-	else // dir == -1, move up
-		for (i = *cnt-1; i >= 0; --i) {
-			if (s->b + shift <= fixed[i].a || s->a + shift >= fixed[i].b)
-				continue;
-			shift = fixed[i].a - s->b;
-		}
-
-	fixed[*cnt].a = s->a + shift;
-	fixed[*cnt].b = s->b + shift;
-	(*cnt)++;
-	qsort(fixed, *cnt, sizeof(segment_t), cmp_segment);
-	
-	return shift;
-}
-
-static void fix_collisions(event_images_t* imgs, int cnt)
-{
-	segment_t used[MAX_EVENTS];
-	int cnt_used = 0;
-	int i, j;
-
-	// fill used[] with fixed events
-	for (i = 0; i < cnt; ++i) {
-		render_priv_t* priv;
-		if (!imgs[i].detect_collisions) continue;
-		priv = get_render_priv(imgs[i].event);
-		if (priv->height > 0) { // it's a fixed event
-			segment_t s;
-			s.a = priv->top;
-			s.b = priv->top + priv->height;
-			if (priv->height != imgs[i].height) { // no, it's not
-				mp_msg(MSGT_ASS, MSGL_WARN, MSGTR_LIBASS_EventHeightHasChanged);
-				priv->top = 0;
-				priv->height = 0;
-			}
-			for (j = 0; j < cnt_used; ++j)
-				if (overlap(&s, used + j)) { // no, it's not
-					priv->top = 0;
-					priv->height = 0;
-				}
-			if (priv->height > 0) { // still a fixed event
-				used[cnt_used].a = priv->top;
-				used[cnt_used].b = priv->top + priv->height;
-				cnt_used ++;
-				shift_event(imgs + i, priv->top - imgs[i].top);
-			}
-		}
-	}
-	qsort(used, cnt_used, sizeof(segment_t), cmp_segment);
-
-	// try to fit other events in free spaces
-	for (i = 0; i < cnt; ++i) {
-		render_priv_t* priv;
-		if (!imgs[i].detect_collisions) continue;
-		priv = get_render_priv(imgs[i].event);
-		if (priv->height == 0) { // not a fixed event
-			int shift;
-			segment_t s;
-			s.a = imgs[i].top;
-			s.b = imgs[i].top + imgs[i].height;
-			shift = fit_segment(&s, used, &cnt_used, imgs[i].shift_direction);
-			if (shift) shift_event(imgs + i, shift);
-			// make it fixed
-			priv->top = imgs[i].top;
-			priv->height = imgs[i].height;
-		}
-		
-	}
-}
-
-/**
- * \brief compare two images
- * \param i1 first image
- * \param i2 second image
- * \return 0 if identical, 1 if different positions, 2 if different content
- */
-int ass_image_compare(ass_image_t *i1, ass_image_t *i2)
-{
-	if (i1->w != i2->w) return 2;
-	if (i1->h != i2->h) return 2;
-	if (i1->stride != i2->stride) return 2;
-	if (i1->color != i2->color) return 2;
-	if (i1->bitmap != i2->bitmap)
-		return 2;
-	if (i1->dst_x != i2->dst_x) return 1;
-	if (i1->dst_y != i2->dst_y) return 1;
-	return 0;
-}
-
-/**
- * \brief compare current and previous image list
- * \param priv library handle
- * \return 0 if identical, 1 if different positions, 2 if different content
- */
-int ass_detect_change(ass_renderer_t *priv)
-{
-	ass_image_t* img, *img2;
-	int diff;
-
-	img = priv->prev_images_root;
-	img2 = priv->images_root;
-	diff = 0;
-	while (img && diff < 2) {
-		ass_image_t* next, *next2;
-		next = img->next;
-		if (img2) {
-			int d = ass_image_compare(img, img2);
-			if (d > diff) diff = d;
-			next2 = img2->next;
-		} else {
-			// previous list is shorter
-			diff = 2;
-			break;
-		}
-		img = next;
-		img2 = next2;
-	}
-
-	// is the previous list longer?
-	if (img2)
-		diff = 2;
-
-	return diff;
-}
-
-/**
- * \brief render a frame
- * \param priv library handle
- * \param track track
- * \param now current video timestamp (ms)
- * \param detect_change a value describing how the new images differ from the previous ones will be written here:
- *        0 if identical, 1 if different positions, 2 if different content.
- *        Can be NULL, in that case no detection is performed.
- */
-ass_image_t* ass_render_frame(ass_renderer_t *priv, ass_track_t* track, long long now, int* detect_change)
-{
-	int i, cnt, rc;
-	event_images_t* last;
-	ass_image_t** tail;
-	
-	// init frame
-	rc = ass_start_frame(priv, track, now);
-	if (rc != 0)
-		return 0;
-
-	// render events separately
-	cnt = 0;
-	for (i = 0; i < track->n_events; ++i) {
-		ass_event_t* event = track->events + i;
-		if ( (event->Start <= now) && (now < (event->Start + event->Duration)) ) {
-			if (cnt >= priv->eimg_size) {
-				priv->eimg_size += 100;
-				priv->eimg = realloc(priv->eimg, priv->eimg_size * sizeof(event_images_t));
-			}
-			rc = ass_render_event(event, priv->eimg + cnt);
-			if (!rc) ++cnt;
-		}
-	}
-
-	// sort by layer
-	qsort(priv->eimg, cnt, sizeof(event_images_t), cmp_event_layer);
-
-	// call fix_collisions for each group of events with the same layer
-	last = priv->eimg;
-	for (i = 1; i < cnt; ++i)
-		if (last->event->Layer != priv->eimg[i].event->Layer) {
-			fix_collisions(last, priv->eimg + i - last);
-			last = priv->eimg + i;
-		}
-	if (cnt > 0)
-		fix_collisions(last, priv->eimg + cnt - last);
-
-	// concat lists
-	tail = &ass_renderer->images_root;
-	for (i = 0; i < cnt; ++i) {
-		ass_image_t* cur = priv->eimg[i].imgs;
-		while (cur) {
-			*tail = cur;
-			tail = &cur->next;
-			cur = cur->next;
-		}
-	}
-
-	if (detect_change)
-		*detect_change = ass_detect_change(priv);
-	
-	// free the previous image list
-	ass_free_images(priv->prev_images_root);
-	priv->prev_images_root = 0;
-
-	return ass_renderer->images_root;
-}
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_types.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_types.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_types.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,114 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#ifndef ASS_TYPES_H
-#define ASS_TYPES_H
-
-#define VALIGN_SUB 0
-#define VALIGN_CENTER 8
-#define VALIGN_TOP 4
-#define HALIGN_LEFT 1
-#define HALIGN_CENTER 2
-#define HALIGN_RIGHT 3
-
-/// ass Style: line
-typedef struct ass_style_s {
-	char* Name;
-	char* FontName;
-	double FontSize;
-	uint32_t PrimaryColour;
-	uint32_t SecondaryColour;
-	uint32_t OutlineColour;
-	uint32_t BackColour;
-	int Bold;
-	int Italic;
-	int Underline;
-	int StrikeOut;
-	double ScaleX;
-	double ScaleY;
-	double Spacing;
-	int Angle;
-	int BorderStyle;
-	double Outline;
-	double Shadow;
-	int Alignment;
-	int MarginL;
-	int MarginR;
-	int MarginV;
-//        int AlphaLevel;
-	int Encoding;
-} ass_style_t;
-
-typedef struct render_priv_s render_priv_t;
-
-/// ass_event_t corresponds to a single Dialogue line
-/// Text is stored as-is, style overrides will be parsed later
-typedef struct ass_event_s {
-	long long Start; // ms
-	long long Duration; // ms
-
-	int ReadOrder;
-	int Layer;
-	int Style;
-	char* Name;
-	int MarginL;
-	int MarginR;
-	int MarginV;
-	char* Effect;
-	char* Text;
-
-	render_priv_t* render_priv;
-} ass_event_t;
-
-typedef struct parser_priv_s parser_priv_t;
-
-typedef struct ass_library_s ass_library_t;
-
-/// ass track represent either an external script or a matroska subtitle stream (no real difference between them)
-/// it can be used in rendering after the headers are parsed (i.e. events format line read)
-typedef struct ass_track_s {
-	int n_styles; // amount used
-	int max_styles; // amount allocated
-	int n_events;
-	int max_events;
-	ass_style_t* styles; // array of styles, max_styles length, n_styles used
-	ass_event_t* events; // the same as styles
-
-	char* style_format; // style format line (everything after "Format: ")
-	char* event_format; // event format line
-
-	enum {TRACK_TYPE_UNKNOWN = 0, TRACK_TYPE_ASS, TRACK_TYPE_SSA} track_type;
-	
-	// script header fields
-	int PlayResX;
-	int PlayResY;
-	double Timer;
-	int WrapStyle;
-
-	
-	int default_style; // index of default style
-	char* name; // file name in case of external subs, 0 for streams
-
-	ass_library_t* library;
-	parser_priv_t* parser_priv;
-} ass_track_t;
-
-#endif
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_utils.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_utils.c	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_utils.c	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,81 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-//#include "config.h"
-
-#include <stdlib.h>
-#include <inttypes.h>
-
-#include "mputils.h"
-#include "ass_utils.h"
-
-int mystrtoi(char** p, int base, int* res)
-{
-	char* start = *p;
-	*res = strtol(*p, p, base);
-	if (*p != start) return 1;
-	else return 0;
-}
-
-int mystrtou32(char** p, int base, uint32_t* res)
-{
-	char* start = *p;
-	*res = strtoll(*p, p, base);
-	if (*p != start) return 1;
-	else return 0;
-}
-
-int mystrtod(char** p, double* res)
-{
-	char* start = *p;
-	*res = strtod(*p, p);
-	if (*p != start) return 1;
-	else return 0;
-}
-
-int strtocolor(char** q, uint32_t* res)
-{
-	uint32_t color = 0;
-	int result;
-	char* p = *q;
-	
-	if (*p == '&') ++p; 
-	else mp_msg(MSGT_ASS, MSGL_DBG2, "suspicious color format: \"%s\"\n", p);
-	
-	if (*p == 'H' || *p == 'h') { 
-		++p;
-		result = mystrtou32(&p, 16, &color);
-	} else {
-		result = mystrtou32(&p, 0, &color);
-	}
-	
-	{
-		unsigned char* tmp = (unsigned char*)(&color);
-		unsigned char b;
-		b = tmp[0]; tmp[0] = tmp[3]; tmp[3] = b;
-		b = tmp[1]; tmp[1] = tmp[2]; tmp[2] = b;
-	}
-	if (*p == '&') ++p;
-	*q = p;
-
-	*res = color;
-	return result;
-}
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_utils.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_utils.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/ass_utils.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,61 +0,0 @@
-// -*- c-basic-offset: 8; indent-tabs-mode: t -*-
-// vim:ts=8:sw=8:noet:ai:
-/*
-  Copyright (C) 2006 Evgeniy Stepanov <eugeni.stepanov at gmail.com>
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this program; if not, write to the Free Software
-  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-*/
-
-#ifndef ASS_UTILS_H
-#define ASS_UTILS_H
-
-int mystrtoi(char** p, int base, int* res);
-int mystrtou32(char** p, int base, uint32_t* res);
-int mystrtod(char** p, double* res);
-int strtocolor(char** q, uint32_t* res);
-
-static inline int d6_to_int(int x) {
-	return (x + 32) >> 6;
-}
-static inline int d16_to_int(int x) {
-	return (x + 32768) >> 16;
-}
-static inline int int_to_d6(int x) {
-	return x << 6;
-}
-static inline int int_to_d16(int x) {
-	return x << 16;
-}
-static inline int d16_to_d6(int x) {
-	return (x + 512) >> 10;
-}
-static inline int d6_to_d16(int x) {
-	return x << 10;
-}
-static inline double d6_to_double(int x) {
-	return x / 64.;
-}
-static inline int double_to_d6(double x) {
-	return (int)(x * 64);
-}
-static inline double d16_to_double(int x) {
-	return ((double)x) / 0x10000;
-}
-static inline int double_to_d16(double x) {
-	return (int)(x * 0x10000);
-}
-
-#endif
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/help_mp.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/help_mp.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/help_mp.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,55 +0,0 @@
-#ifndef __LIBASS_HELP_MP_H__
-#define __LIBASS_HELP_MP_H__
-#define MSGTR_LIBASS_FT_Glyph_To_BitmapError "[ass] FT_Glyph_To_Bitmap error %d \n"
-#define MSGTR_LIBASS_UnsupportedPixelMode "[ass] Unsupported pixel mode: %d\n"
-#define MSGTR_LIBASS_NoStyleNamedXFoundUsingY "[ass] [%p] Warning: no style named '%s' found, using '%s'\n"
-#define MSGTR_LIBASS_BadTimestamp "[ass] bad timestamp\n"
-#define MSGTR_LIBASS_BadEncodedDataSize "[ass] bad encoded data size\n"
-#define MSGTR_LIBASS_FontLineTooLong "[ass] Font line too long: %d, %s\n"
-#define MSGTR_LIBASS_EventFormatHeaderMissing "[ass] Event format header missing\n"
-#define MSGTR_LIBASS_ErrorOpeningIconvDescriptor "[ass] error opening iconv descriptor.\n"
-#define MSGTR_LIBASS_ErrorRecodingFile "[ass] error recoding file.\n"
-#define MSGTR_LIBASS_FopenFailed "[ass] ass_read_file(%s): fopen failed\n"
-#define MSGTR_LIBASS_FseekFailed "[ass] ass_read_file(%s): fseek failed\n"
-#define MSGTR_LIBASS_RefusingToLoadSubtitlesLargerThan10M "[ass] ass_read_file(%s): Refusing to load subtitles larger than 10M\n"
-#define MSGTR_LIBASS_ReadFailed "Read failed, %d: %s\n"
-#define MSGTR_LIBASS_AddedSubtitleFileMemory "[ass] Added subtitle file: <memory> (%d styles, %d events)\n"
-#define MSGTR_LIBASS_AddedSubtitleFileFname "[ass] Added subtitle file: %s (%d styles, %d events)\n"
-#define MSGTR_LIBASS_FailedToCreateDirectory "[ass] Failed to create directory %s\n"
-#define MSGTR_LIBASS_NotADirectory "[ass] Not a directory: %s\n"
-#define MSGTR_LIBASS_TooManyFonts "[ass] Too many fonts\n"
-#define MSGTR_LIBASS_ErrorOpeningFont "[ass] Error opening font: %s, %d\n"
-#define MSGTR_LIBASS_SelectedFontFamilyIsNotTheRequestedOne "[ass] fontconfig: Selected font family is not the requested one: '%s' != '%s'\n"
-#define MSGTR_LIBASS_UsingDefaultFontFamily "[ass] fontconfig_select: Using default font family: (%s, %d, %d) -> %s, %d\n"
-#define MSGTR_LIBASS_UsingDefaultFont "[ass] fontconfig_select: Using default font: (%s, %d, %d) -> %s, %d\n"
-#define MSGTR_LIBASS_UsingArialFontFamily "[ass] fontconfig_select: Using 'Arial' font family: (%s, %d, %d) -> %s, %d\n"
-#define MSGTR_LIBASS_FcInitLoadConfigAndFontsFailed "[ass] FcInitLoadConfigAndFonts failed.\n"
-#define MSGTR_LIBASS_UpdatingFontCache "[ass] Updating font cache.\n"
-#define MSGTR_LIBASS_BetaVersionsOfFontconfigAreNotSupported "[ass] Beta versions of fontconfig are not supported.\n[ass] Update before reporting any bugs.\n"
-#define MSGTR_LIBASS_FcStrSetAddFailed "[ass] FcStrSetAdd failed.\n"
-#define MSGTR_LIBASS_FcDirScanFailed "[ass] FcDirScan failed.\n"
-#define MSGTR_LIBASS_FcDirSave "[ass] FcDirSave failed.\n"
-#define MSGTR_LIBASS_FcConfigAppFontAddDirFailed "[ass] FcConfigAppFontAddDir failed\n"
-#define MSGTR_LIBASS_FontconfigDisabledDefaultFontWillBeUsed "[ass] Fontconfig disabled, only default font will be used.\n"
-#define MSGTR_LIBASS_FunctionCallFailed "[ass] %s failed\n"
-#define MSGTR_LIBASS_NeitherPlayResXNorPlayResYDefined "[ass] Neither PlayResX nor PlayResY defined. Assuming 384x288.\n"
-#define MSGTR_LIBASS_PlayResYUndefinedSettingY "[ass] PlayResY undefined, setting %d.\n"
-#define MSGTR_LIBASS_PlayResXUndefinedSettingX "[ass] PlayResX undefined, setting %d.\n"
-#define MSGTR_LIBASS_FT_Init_FreeTypeFailed "[ass] FT_Init_FreeType failed.\n"
-#define MSGTR_LIBASS_Init "[ass] Init\n"
-#define MSGTR_LIBASS_InitFailed "[ass] Init failed.\n"
-#define MSGTR_LIBASS_BadCommand "[ass] Bad command: %c%c\n"
-#define MSGTR_LIBASS_ErrorLoadingGlyph  "[ass] Error loading glyph.\n"
-#define MSGTR_LIBASS_FT_Glyph_Stroke_Error "[ass] FT_Glyph_Stroke error %d \n"
-#define MSGTR_LIBASS_UnknownEffectType_InternalError "[ass] Unknown effect type (internal error)\n"
-#define MSGTR_LIBASS_NoStyleFound "[ass] No style found!\n"
-#define MSGTR_LIBASS_EmptyEvent "[ass] Empty event!\n"
-#define MSGTR_LIBASS_MAX_GLYPHS_Reached "[ass] MAX_GLYPHS reached: event %d, start = %llu, duration = %llu\n Text = %s\n"
-#define MSGTR_LIBASS_EventHeightHasChanged "[ass] Warning! Event height has changed!  \n"
-#define MSGTR_LIBASS_GlyphNotFoundReselectingFont "[ass] Glyph 0x%X not found, reselecting font for (%s, %d, %d)\n"
-#define MSGTR_LIBASS_GlyphNotFound "[ass] Glyph 0x%X not found in font for (%s, %d, %d)\n"
-#define MSGTR_LIBASS_ErrorOpeningMemoryFont "[ass] Error opening memory font: %s\n"
-#define MSGTR_LIBASS_NoCharmaps "[ass] font face with no charmaps\n"
-#define MSGTR_LIBASS_NoCharmapAutodetected "[ass] no charmap autodetected, trying the first one\n"
-#endif
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/mputils.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/mputils.c	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/mputils.c	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,218 +0,0 @@
-//#include "config.h"
-
-#include "mputils.h"
-
-#include <stdio.h>
-#include <stdarg.h>
-#include <stdint.h>
-#include <stdlib.h>
-#include <string.h>
-#include <assert.h>
-
-#ifdef HAVE_ENCA
-#include <enca.h>
-#endif
-
-void my_mp_msg(int lvl, char *lvl_str, char *fmt, ...) {
-	va_list va;
-	if(lvl > MSGL_V) return;
-	printf("[ass] **%s**: ", lvl_str);
-	va_start(va, fmt);
-	vprintf(fmt, va);
-	va_end(va);
-}
-
-unsigned utf8_get_char(char **str) {
-  uint8_t *strp = (uint8_t *)*str;
-  unsigned c = *strp++;
-  unsigned mask = 0x80;
-  int len = -1;
-  while (c & mask) {
-    mask >>= 1;
-    len++;
-  }
-  if (len <= 0 || len > 4)
-    goto no_utf8;
-  c &= mask - 1;
-  while ((*strp & 0xc0) == 0x80) {
-    if (len-- <= 0)
-      goto no_utf8;
-    c = (c << 6) | (*strp++ & 0x3f);
-  }
-  if (len)
-    goto no_utf8;
-  *str = (char *)strp;
-  return c;
-
-no_utf8:
-  strp = (uint8_t *)*str;
-  c = *strp++;
-  *str = (char *)strp;
-  return c;
-}
-
-// gaussian blur
-void blur(
-	unsigned char *buffer,
-	unsigned short *tmp2,
-	int width,
-	int height,
-	int stride,
-	int *m2,
-	int r,
-	int mwidth) {
-
-    int x, y;
-
-    unsigned char  *s = buffer;
-    unsigned short *t = tmp2+1;
-    for(y=0; y<height; y++){
-	memset(t-1, 0, (width+1)*sizeof(short));
-
-	for(x=0; x<r; x++){
-	    const int src= s[x];
-	    if(src){
-		register unsigned short *dstp= t + x-r;
-		int mx;
-		unsigned *m3= m2 + src*mwidth;
-		for(mx=r-x; mx<mwidth; mx++){
-		    dstp[mx]+= m3[mx];
-		}
-	    }
-	}
-
-	for(; x<width-r; x++){
-	    const int src= s[x];
-	    if(src){
-		register unsigned short *dstp= t + x-r;
-		int mx;
-		unsigned *m3= m2 + src*mwidth;
-		for(mx=0; mx<mwidth; mx++){
-		    dstp[mx]+= m3[mx];
-		}
-	    }
-	}
-
-	for(; x<width; x++){
-	    const int src= s[x];
-	    if(src){
-		register unsigned short *dstp= t + x-r;
-		int mx;
-		const int x2= r+width -x;
-		unsigned *m3= m2 + src*mwidth;
-		for(mx=0; mx<x2; mx++){
-		    dstp[mx]+= m3[mx];
-		}
-	    }
-	}
-
-	s+= stride;
-	t+= width + 1;
-    }
-
-    t = tmp2;
-    for(x=0; x<width; x++){
-	for(y=0; y<r; y++){
-	    unsigned short *srcp= t + y*(width+1) + 1;
-	    int src= *srcp;
-	    if(src){
-		register unsigned short *dstp= srcp - 1 + width+1;
-		const int src2= (src + 128)>>8;
-		unsigned *m3= m2 + src2*mwidth;
-
-		int mx;
-		*srcp= 128;
-		for(mx=r-1; mx<mwidth; mx++){
-		    *dstp += m3[mx];
-		    dstp+= width+1;
-		}
-	    }
-	}
-	for(; y<height-r; y++){
-	    unsigned short *srcp= t + y*(width+1) + 1;
-	    int src= *srcp;
-	    if(src){
-		register unsigned short *dstp= srcp - 1 - r*(width+1);
-		const int src2= (src + 128)>>8;
-		unsigned *m3= m2 + src2*mwidth;
-
-		int mx;
-		*srcp= 128;
-		for(mx=0; mx<mwidth; mx++){
-		    *dstp += m3[mx];
-		    dstp+= width+1;
-		}
-	    }
-	}
-	for(; y<height; y++){
-	    unsigned short *srcp= t + y*(width+1) + 1;
-	    int src= *srcp;
-	    if(src){
-		const int y2=r+height-y;
-		register unsigned short *dstp= srcp - 1 - r*(width+1);
-		const int src2= (src + 128)>>8;
-		unsigned *m3= m2 + src2*mwidth;
-
-		int mx;
-		*srcp= 128;
-		for(mx=0; mx<y2; mx++){
-		    *dstp += m3[mx];
-		    dstp+= width+1;
-		}
-	    }
-	}
-	t++;
-    }
-
-    t = tmp2;
-    s = buffer;
-    for(y=0; y<height; y++){
-	for(x=0; x<width; x++){
-	    s[x]= t[x]>>8;
-	}
-	s+= stride;
-	t+= width + 1;
-    }
-}
-
-#ifdef HAVE_ENCA
-void* guess_buffer_cp(unsigned char* buffer, int buflen, char *preferred_language, char *fallback)
-{
-    const char **languages;
-    size_t langcnt;
-    EncaAnalyser analyser;
-    EncaEncoding encoding;
-    char *detected_sub_cp = NULL;
-    int i;
-
-    languages = enca_get_languages(&langcnt);
-    mp_msg(MSGT_ASS, MSGL_V, "ENCA supported languages: ");
-    for (i = 0; i < langcnt; i++) {
-	mp_msg(MSGT_ASS, MSGL_V, "%s ", languages[i]);
-    }
-    mp_msg(MSGT_ASS, MSGL_V, "\n");
-    
-    for (i = 0; i < langcnt; i++) {
-	const char *tmp;
-	
-	if (strcasecmp(languages[i], preferred_language) != 0) continue;
-	analyser = enca_analyser_alloc(languages[i]);
-	encoding = enca_analyse_const(analyser, buffer, buflen);
-	tmp = enca_charset_name(encoding.charset, ENCA_NAME_STYLE_ICONV);
-	if (tmp && encoding.charset != ENCA_CS_UNKNOWN) {
-	    detected_sub_cp = strdup(tmp);
-	    mp_msg(MSGT_ASS, MSGL_INFO, "ENCA detected charset: %s\n", tmp);
-	}
-	enca_analyser_free(analyser);
-    }
-    
-    free(languages);
-
-    if (!detected_sub_cp) {
-	detected_sub_cp = strdup(fallback);
-	mp_msg(MSGT_ASS, MSGL_INFO, "ENCA detection failed: fallback to %s\n", fallback);
-    }
-
-    return detected_sub_cp;
-}
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/mputils.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/mputils.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_libass/mputils.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,35 +0,0 @@
-#ifndef __MPUTILS_H__
-#define __MPUTILS_H__
-
-#include "help_mp.h"
-
-unsigned utf8_get_char(char **str);
-
-void my_mp_msg(int lvl, char *lvl_str, char *fmt, ...);
-
-#ifdef __VISUALC__
-static void mp_msg(int mod, int level, const char *fmt, ...) {
-	// MSVC doesn't like the # used all around for mp_msg, so it breaks va_arg
-}
-#else
-#define mp_msg(mod, level, args...) my_mp_msg(level, #level, args)
-#endif
-
-#define MSGT_ASS 43
-
-#define MSGL_FATAL 0
-#define MSGL_ERR 1
-#define MSGL_WARN 2
-#define MSGL_INFO 4
-#define MSGL_V 6
-#define MSGL_DBG2 7
-
-void blur(unsigned char *buffer, unsigned short *tmp2, int width, int height,
-          int stride, int *m2, int r, int mwidth);
-
-void* guess_buffer_cp(unsigned char* buffer, int buflen, char *preferred_language, char *fallback);
-
-#define FFMAX(a,b) ((a) > (b) ? (a) : (b))
-#define FFMIN(a,b) ((a) > (b) ? (b) : (a))
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_vidASS.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_vidASS.cpp	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_vidASS.cpp	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,373 +0,0 @@
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-/*
-  Initial port from MPlayer by Moonz
-
-*/
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-#include "DIA_coreToolkit.h"
-
-#include "ADM_vidASS.h"
-#include "ADM_colorspace.h"
-#include "DIA_factory.h"
-
-
-
-#ifndef DIR_SEP
-# ifdef WIN32
-#   define DIR_SEP '\\'
-# else
-#   define DIR_SEP '/'
-# endif
-#endif
-
-static FILTER_PARAM assParam={7,
-        { /* float */ "font_scale",
-          /*float*/ "line_spacing",
-          /* int */ "top_margin",
-          /* int */ "bottom_margin",
-          /* bool */ "extract_embedded_fonts",
-          /* ADM_filename */ "fonts_dir",
-          /* ADM_filename */ "subfile" }};
-
-//********** Register chunk ************
-//REGISTERX(VF_SUBTITLE, "ass",QT_TR_NOOP("ASS"),
-//    QT_TR_NOOP("Add ASS/SSA subtitles to the picture."),VF_ASS,1,ass_create,ass_script);
-
-
-VF_DEFINE_FILTER(ADMVideoSubASS,assParam,
-                                ass,
-                                QT_TR_NOOP("ASS"),
-                                1,
-                                VF_SUBTITLE,
-                                QT_TR_NOOP("Add ASS/SSA subtitles to the picture."));
-//************************************
-
-char *ADMVideoSubASS::printConf() 
-{
-      static char buf[500];
-      sprintf((char *)buf," ASS/SSA Subtitles: ");
-      
-      char *filename = (char*)_params->subfile;
-      if(filename)
-      {
-          if(strrchr(filename, DIR_SEP) != NULL && *(strrchr(filename, DIR_SEP) + 1) != 0)
-              filename = strrchr(filename, DIR_SEP) + 1;
-          strncat(buf, filename, 49-strlen(buf));
-          buf[49] = 0;
-      }else
-      {
-        strcat(buf," (no sub)");       
-      }
-      return buf;
-}
-
-
-uint8_t ADMVideoSubASS::configure(AVDMGenericVideoStream * instream)
-{
-  UNUSED_ARG(instream);
-  
-#define PX(x) &(_params->x)
-#define MKME(x,y) x=(ELEM_TYPE_FLOAT)_params->y
-  ELEM_TYPE_FLOAT scale,spacing;
-  
-    MKME(scale,font_scale);
-    MKME(spacing,line_spacing);
-    
-    diaElemFile       file(0,(char **)PX(subfile),QT_TR_NOOP("_Subtitle file (ASS/SSA):"), NULL, QT_TR_NOOP("Select Subtitle file"));
-    diaElemFloat      dSpacing(&spacing,QT_TR_NOOP("_Line spacing:"),0.10,10.0);
-    diaElemFloat      dScale(&scale,QT_TR_NOOP("_Font scale:"),0.10,10.0);
-    diaElemUInteger   dTop(PX(top_margin),QT_TR_NOOP("_Top margin:"),0,200);
-    diaElemUInteger   dBottom(PX(bottom_margin),QT_TR_NOOP("Botto_m margin"),0,200);
-    
-       diaElem *elems[5]={&file,&dSpacing,&dScale,&dTop,&dBottom};
-  
-   if( diaFactoryRun(QT_TR_NOOP("ASS"),5,elems))
-   {
-#undef MKME
-#define MKME(x,y) _params->y=(float)x
-    MKME(scale,font_scale);
-    MKME(spacing,line_spacing);
-
-     return 1;
-   }
-   return 0;
-}
-
-//_______________________________________________________________
-
-ADMVideoSubASS::ADMVideoSubASS(AVDMGenericVideoStream *in, CONFcouple *conf) 
-{
-        _in=in;		
-        memcpy(&_info,_in->getInfo(),sizeof(_info));
-        _params = new ASSParams;
-        ADM_assert(_params);
-        
-        
-        if(conf) {
-                #define _COUPLE_GET(x) conf->getCouple(#x, &(_params->x));
-                _COUPLE_GET(font_scale)
-                _COUPLE_GET(line_spacing)
-                _COUPLE_GET(top_margin)
-                _COUPLE_GET(bottom_margin)
-                _COUPLE_GET(subfile)
-                _COUPLE_GET(fonts_dir)
-                _COUPLE_GET(extract_embedded_fonts)
-        }	
-        else {
-                _params->font_scale = 1.;
-                _params->line_spacing = _params->top_margin = _params->bottom_margin = 0;
-                _params->subfile = NULL;
-                _params->fonts_dir = (ADM_filename*)ADM_alloc(6*sizeof(ADM_filename));
-                strcpy((char*)_params->fonts_dir, "/tmp/");
-                _params->extract_embedded_fonts = 1;
-        }
-
-        _uncompressed=new ADMImage(_in->getInfo()->width,_in->getInfo()->height);
-        ADM_assert(_uncompressed);
-        _info.encoding=1;
-
-        /* ASS initialization */
-        _ass_lib = ass_library_init();
-        _ass_track = NULL;
-        _ass_rend = NULL;
-        ADM_assert(_ass_lib);
-        if(_params->subfile)
-        {
-              if(!init())
-              {
-                GUI_Error_HIG("Format ?","Are you sure this is an ass file ?"); 
-              }
-        }
-
-}
-// **********************************
-uint8_t ADMVideoSubASS::init(void)
-{
-bool use_margins = ( _params->top_margin | _params->bottom_margin ) != 0;
-
-        memcpy(&_info,_in->getInfo(),sizeof(_info));
-        _info.height += _params->top_margin + _params->bottom_margin;
-
-        ass_set_fonts_dir(_ass_lib, (const char*)_params->fonts_dir);
-        ass_set_extract_fonts(_ass_lib, _params->extract_embedded_fonts);
-        ass_set_style_overrides(_ass_lib, NULL);
-#if ASS_HAS_GLOBAL
-         if(_ass_rend) 
-        {
-              ass_renderer_done(_ass_rend);
-              _ass_rend = NULL;
-         }
-#endif
-        _ass_rend = ass_renderer_init(_ass_lib);
-
-        ADM_assert(_ass_rend);
- 
-        ass_set_frame_size(_ass_rend, _info.width, _info.height);
-        ass_set_margins(_ass_rend, _params->top_margin, _params->bottom_margin, 0, 0);
-        ass_set_use_margins(_ass_rend, use_margins);
-        ass_set_font_scale(_ass_rend, _params->font_scale);
-        ass_set_fonts(_ass_rend, NULL, "Sans");
-        //~ ass_set_aspect_ratio(_ass_rend, ((double)_info.width) / ((double)_info.height));
-#if ASS_HAS_GLOBAL
-        if(_ass_track) 
-        {
-              ass_free_track(_ass_track);
-              _ass_track = NULL;
-        }
-#endif
-       _ass_track = ass_read_file(_ass_lib, (char*)_params->subfile, NULL);
-
-//        ADM_assert(_ass_track);
-        if(!_ass_track)
-          GUI_Error_HIG("SSA Error","Cannot read_file for *%s*",(char*)_params->subfile);
-        return 1;
-} 
-
-//*******************************************
-ADMVideoSubASS::~ADMVideoSubASS() 
-{
-      if(_uncompressed) DELETE(_uncompressed);
-      
-      if(_params) 
-      {
-        DELETE(_params->subfile);
-        DELETE( _params->fonts_dir);
-        DELETE(_params);
-      }
-#if ASS_HAS_GLOBAL
-        if(_ass_rend) 
-        {
-              ass_renderer_done(_ass_rend);
-              _ass_rend = NULL;
-         }
-
-        if(_ass_track) 
-        {
-              ass_free_track(_ass_track);
-              _ass_track = NULL;
-        }
-        if(_ass_lib) 
-        {
-              ass_library_done(_ass_lib);
-              _ass_lib = NULL;
-        }
-#endif
-}
-//*******************************************
-#define _r(c)  ((c)>>24)
-#define _g(c)  (((c)>>16)&0xFF)
-#define _b(c)  (((c)>>8)&0xFF)
-#define _a(c)  ((c)&0xFF)
-#define rgba2y(c)  ( (( 263*_r(c)  + 516*_g(c) + 100*_b(c)) >> 10) + 16  )
-#define rgba2u(c)  ( (( 450*_r(c) - 376*_g(c) -  73*_b(c)) >> 10) + 128 )
-#define rgba2v(c)  ( ((-152*_r(c) - 298*_g(c) + 450*_b(c)) >> 10) + 128 )
-
-uint8_t ADMVideoSubASS::getFrameNumberNoAlloc(uint32_t frame, uint32_t *len, ADMImage *data, uint32_t *flags) 
-{
-        uint32_t  i, j, k, l, val;
-        uint8_t y, u, v, opacity;
-        int32_t orig_u, orig_v,klong,newu,newv;
-        uint8_t orig_y;
-        uint8_t *bitmap, *ydata, *udata, *vdata;
-
-        if(frame>=_info.nb_frames)
-        {
-          printf("[SubAss] out of bound %u/%u\n",frame,_info.nb_frames); 
-          return 0;
-        }
-        ADM_assert(_params);
-
-        int64_t  where = (int64_t)(_info.orgFrame + frame) * 1000000LL /
-                          (int64_t)_info.fps1000;
-
-        if(!_in->getFrameNumberNoAlloc(frame, len, _uncompressed, flags))
-                return 0;
-
-        /* Add black borders top / bottom*/
-
-        uint32_t page=_info.width*_info.height;
-        uint32_t top, bottom;
-        top=_info.width * (_params->top_margin &0xfffe);
-        if(top>page) top=0;
-        
-        if(top)
-        {
-            memset(YPLANE(data),16,top);
-            memset(UPLANE(data),128,top>>2);
-            memset(VPLANE(data),128,top>>2);
-        }
-        memcpy(YPLANE(data) + top, YPLANE(_uncompressed),page-top);
-        memcpy(UPLANE(data) + (top>>2), UPLANE(_uncompressed), (page-top)>>2);
-        memcpy(VPLANE(data) + (top>>2), VPLANE(_uncompressed), (page-top)>>2);
-
-        // Now do bottom
-        top=_info.width * (_params->bottom_margin&0xfffe);
-        if(top>page) top=0;
-        if(top)
-        {
-            memset(YPLANE(data)+page-top,16,top);
-            memset(UPLANE(data)+((page-top)>>2),128,top>>2);
-            memset(VPLANE(data)+((page-top)>>2),128,top>>2);
-        }
-        // Do we have something to render ?
-        if(!_ass_rend || !_ass_track)
-        {
-          printf("[Ass] No sub to render\n");
-          return 1; 
-        }
-        int changed=0;
-        ass_image_t *img = ass_render_frame(_ass_rend, _ass_track, where,&changed);
-        
-
-        while(img) {
-                  y = rgba2y(img->color);
-                  u = rgba2u(img->color);
-                  v = rgba2v(img->color);
-
-                  opacity = 255 - _a(img->color);
-
-                  bitmap = img->bitmap;
-
-                  uint32_t offset=img->dst_y * _info.width +img->dst_x;
-                  uint32_t offset2=(img->dst_y>>1) * (_info.width>>1)+(img->dst_x >> 1); 
-
-                  ydata = YPLANE(data) + offset ;
-                  udata = UPLANE(data) + offset2 ;
-                  vdata = VPLANE(data) + offset2 ;
-
-                  for(i = 0; i < img->h; ++i) 
-                  {
-                          for(j = 0; j < img->w; ++j) 
-                          {
-                                  k = *(bitmap+j) * opacity / 255;
-                                  orig_y = *(ydata+j);
-                                  *(ydata+j) = (k*y + (255-k)*orig_y) / 255;
-                          }
-
-                          bitmap += img->stride;
-                          ydata += _info.width;
-                  }
-
-                  bitmap = img->bitmap;
-                  
-                  newu=u-128;
-                  newv=v-128;
-
-                  for(i = 0; i < img->h; i += 2) 
-                  {
-                          for(j = 0, l = 0; j < img->w; j += 2, ++l) 
-                          {
-                                  val = 0;
-                                  val += *(bitmap + j);
-                                  val += *(bitmap + j + 1);
-                                  val += *(bitmap + img->stride + j);
-                                  val += *(bitmap + img->stride + j + 1);
-                                  val >>= 2;
-
-                                  k = val * opacity / 255;
-                                  orig_u = *(udata+l);
-                                  orig_v = *(vdata+l);
-
-                                  orig_u=( k*u+(255-k)*orig_u)/255;
-                                  orig_v=( k*v+(255-k)*orig_v)/255;
-                                  *(udata+l) = orig_u;
-                                  *(vdata+l) = orig_v;
-                          }
-
-                          bitmap += img->stride << 1;
-                          udata += _info.width >> 1;
-                          vdata += _info.width >> 1;
-                  }
-
-                  img = img->next;
-        }
-
-        return 1;
-}
-
-uint8_t	ADMVideoSubASS::getCoupledConf(CONFcouple **conf) 
-{
-        *conf=new CONFcouple(7);
-
-#define _COUPLE_SET(x) (*conf)->setCouple(#x, _params->x);
-        _COUPLE_SET(font_scale)
-        _COUPLE_SET(line_spacing)
-        _COUPLE_SET(top_margin)
-        _COUPLE_SET(bottom_margin)
-        _COUPLE_SET(subfile)
-        _COUPLE_SET(fonts_dir)
-        _COUPLE_SET(extract_embedded_fonts)
-
-        return 1;
-}
-/************************************************/
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_vidASS.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_vidASS.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_vidASS.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,37 +0,0 @@
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef _ADM_ASS_H
-#define _ADM_ASS_H
-
-
-
-extern "C"
-{
-#include "ADM_libass/ass.h"
-}
-#include "ADM_vidAss_Params.h" 
-class ADMVideoSubASS : public AVDMGenericVideoStream 
-{
-protected:
-        virtual char* printConf(void);
-        ASSParams* _params;
-        ass_library_t *_ass_lib;
-        ass_renderer_t *_ass_rend;
-        ass_track_t *_ass_track;
-        uint8_t init(void);
-public:
-        ADMVideoSubASS(AVDMGenericVideoStream *in, CONFcouple *conf);
-        virtual ~ADMVideoSubASS();
-        virtual uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len, ADMImage *data,uint32_t *flags);
-        uint8_t configure(AVDMGenericVideoStream *instream);
-        uint8_t	getCoupledConf(CONFcouple **conf);
-};
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_vidAss_Params.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_vidAss_Params.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/ADM_vidAss_Params.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,12 +0,0 @@
-#ifndef ADM_VID_ASS_PARAM_H
-#define ADM_VID_ASS_PARAM_H
-
-typedef struct 
-{
-        float         font_scale, line_spacing;
-        uint32_t      top_margin, bottom_margin;
-        ADM_filename  *subfile, *fonts_dir;
-        uint32_t      extract_embedded_fonts;
-} ASSParams;
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/CMakeLists.txt	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/Ass/CMakeLists.txt	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,20 +0,0 @@
-INCLUDE(admCheckFreeType)
-checkFreeType()
-
-IF (USE_FREETYPE)
-	ADD_SUBDIRECTORY(ADM_libass)
-
-	INCLUDE(vf_plugin)
-	SET(ADM_vf_ssa_SRCS ADM_vidASS.cpp)
-
-	ADD_LIBRARY(ADM_vf_ssa SHARED ${ADM_vf_ssa_SRCS})
-	TARGET_LINK_LIBRARIES(ADM_vf_ssa ADM_libass)
-	ADD_TARGET_LDFLAGS(ADM_vf_ssa "${FREETYPE2_LDFLAGS}")
-
-	IF (FONTCONFIG_FOUND)
-		ADD_TARGET_LDFLAGS(ADM_vf_ssa "${FONTCONFIG_LDFLAGS}")
-	ENDIF (FONTCONFIG_FOUND)
-
-	INIT_VIDEOFILTER_PLUGIN(ADM_vf_ssa)
-	INSTALL_VIDEOFILTER(ADM_vf_ssa)
-ENDIF (USE_FREETYPE)

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/LumaOnly/ADM_vidLuma.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/LumaOnly/ADM_vidLuma.cpp	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/LumaOnly/ADM_vidLuma.cpp	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,83 +0,0 @@
-/***************************************************************************
-                          ADM_vidLuma.cpp  -  description
-                             -------------------
-    begin                : Sat Aug 24 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include "ADM_default.h"
-#include "ADM_videoFilterDynamic.h"
-#include "ADM_vidLuma.h"
-
-
-static FILTER_PARAM nullParam={0,{""}};
-
-//********** Register chunk ************
-VF_DEFINE_FILTER(ADMVideoLuma,nullParam,
-                lumaonly,
-                QT_TR_NOOP("Luma only"),
-                1,
-                VF_COLORS,
-                QT_TR_NOOP("Convert picture to greyscale (black and white)."));
-//****************************************
-char *ADMVideoLuma::printConf( void )
-{
- ADM_FILTER_DECLARE_CONF(" Luma only");
-        
-}
-
-ADMVideoLuma::ADMVideoLuma(  AVDMGenericVideoStream *in,CONFcouple *setup)
-{
-
- 	_in=in;		
-   	memcpy(&_info,_in->getInfo(),sizeof(_info));  		
-	
-		if(setup)
-		{
-			 _param=(void *)setup;
-		}	
-			else 			
-		{	// default parameter	
-				_param= NULL;
-		}				
-					 	
-  _info.encoding=1;
-
-  	  	
-}
-ADMVideoLuma::~ADMVideoLuma()
-{
- 	
-}
-uint8_t ADMVideoLuma::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-
-	if(frame>= _info.nb_frames) return 0;
-	// read uncompressed frame
-	if(!_in->getFrameNumberNoAlloc(frame, len,data,flags)) return 0;
-
-	uint32_t sz;
-			
-	sz=_info.width*_info.height;
-	memset(UPLANE(data),128,sz>>2);
-	memset(VPLANE(data),128,sz>>2);
-
-      return 1;
-}
-
-
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/LumaOnly/ADM_vidLuma.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/LumaOnly/ADM_vidLuma.h	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/LumaOnly/ADM_vidLuma.h	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,38 +0,0 @@
-/***************************************************************************
-                          ADM_vidLuma.h  -  description
-                             -------------------
-    begin                : Sat Aug 24 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef LUMA__
-#define LUMA__
-
- class  ADMVideoLuma:public AVDMGenericVideoStream
-{
-
-    protected:
-
-        virtual char                                    *printConf ( void );
-        void                                                    *_param;
-
-    public:
-
-        ADMVideoLuma ( AVDMGenericVideoStream *in,CONFcouple *setup );
-        virtual ~ADMVideoLuma();
-        virtual uint8_t getFrameNumberNoAlloc ( uint32_t frame, uint32_t *len,
-                                                ADMImage *data,uint32_t *flags );
-        virtual uint8_t configure ( AVDMGenericVideoStream *instream ) { UNUSED_ARG ( instream ); return 1;};
-
-}     ;
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/LumaOnly/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/LumaOnly/CMakeLists.txt	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters/LumaOnly/CMakeLists.txt	2010-09-09 05:41:14 UTC (rev 6611)
@@ -1,9 +0,0 @@
-INCLUDE(vf_plugin)
-
-
-SET(ADM_vf_lumaonly_SRCS ADM_vidLuma.cpp)
-
-ADD_LIBRARY(ADM_vf_lumaonly SHARED ${ADM_vf_lumaonly_SRCS})
-
-INIT_VIDEOFILTER_PLUGIN(ADM_vf_lumaonly)
-INSTALL_VIDEOFILTER(ADM_vf_lumaonly)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-09 05:14:34 UTC (rev 6610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2010-09-09 05:41:14 UTC (rev 6611)
@@ -6,6 +6,7 @@
 ADD_SUBDIRECTORY(kernelDeint)
 ADD_SUBDIRECTORY(lavDeint)
 ADD_SUBDIRECTORY(logo)
+ADD_SUBDIRECTORY(lumaOnly)
 ADD_SUBDIRECTORY(mplayerDenoise3D)
 ADD_SUBDIRECTORY(printInfo)
 ADD_SUBDIRECTORY(resampleFps)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lumaOnly/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lumaOnly/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lumaOnly/CMakeLists.txt	2010-09-09 05:41:14 UTC (rev 6611)
@@ -0,0 +1,9 @@
+INCLUDE(vf_plugin)
+
+
+SET(ADM_vf_lumaOnly_SRCS lumaOnly.cpp)
+
+ADD_VIDEO_FILTER(ADM_vf_lumaOnly ${ADM_vf_lumaOnly_SRCS})
+
+INIT_VIDEO_FILTER(ADM_vf_lumaOnly)
+INSTALL_VIDEO_FILTER(ADM_vf_lumaOnly)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lumaOnly/lumaOnly.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lumaOnly/lumaOnly.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/lumaOnly/lumaOnly.cpp	2010-09-09 05:41:14 UTC (rev 6611)
@@ -0,0 +1,120 @@
+/** *************************************************************************
+                    \fn       lumaOnlyFilter.cpp  
+                    \brief simplest of all video filters, it does nothing
+
+    copyright            : (C) 2009 by mean
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "ADM_default.h"
+#include "ADM_coreVideoFilterInternal.h"
+
+/**
+    \class lumaOnlyFilter
+*/
+class lumaOnlyFilter : public  ADM_coreVideoFilter
+{
+public:
+                    lumaOnlyFilter(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                    ~lumaOnlyFilter();
+
+        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
+	 //  virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) {return true;}             /// Start graphical user interface
+};
+
+// Add the hook to make it valid plugin
+DECLARE_VIDEO_FILTER(   lumaOnlyFilter,   // Class
+                        1,0,0,              // Version
+                        ADM_UI_ALL,         // UI
+                        VF_TRANSFORM,            // Category
+                        "lumaonly",            // internal name (must be uniq!)
+                        "GreyScale",            // Display name
+                        "Remove color, only key grey image." // Description
+                    );
+
+// Now implements the interesting parts
+/**
+    \fn lumaOnlyFilter
+    \brief constructor
+*/
+lumaOnlyFilter::lumaOnlyFilter(  ADM_coreVideoFilter *in,CONFcouple *setup) : ADM_coreVideoFilter(in,setup)
+{
+UNUSED_ARG(setup);
+
+    // By default the info field contains the output of previous filter
+    // Tweak it here if you change fps, duration, width,...
+}
+/**
+    \fn lumaOnlyFilter
+    \brief destructor
+*/
+lumaOnlyFilter::~lumaOnlyFilter()
+{
+		
+}
+
+/**
+    \fn getFrame
+    \brief Get a processed frame
+*/
+bool lumaOnlyFilter::getNextFrame(uint32_t *fn,ADMImage *image)
+{
+    // since we do nothing, just get the output of previous filter
+    if(false==previousFilter->getNextFrame(fn,image))
+    {
+        ADM_warning("lumaOnlyFilter : Cannot get frame\n");
+        return false;
+    }
+    // do in place flip
+    int w=info.width;
+    int h=info.height;
+    uint32_t pitches[3];
+    uint8_t *ptr[3];
+    image->GetPitches(pitches);
+    image->GetWritePlanes((uint8_t **)ptr);
+    w>>=1,
+    h>>=1;
+    for(int i=1;i<3;i++)
+    {
+        uint8_t *p=ptr[i];
+        uint32_t d=pitches[i];
+        for(int y=0;y<h;y++)
+        {
+                memset(p,128,w);
+                p+=d;
+        }
+    }
+    return true;
+}
+/**
+    \fn getCoupledConf
+    \brief Return our current configuration as couple name=value
+*/
+bool         lumaOnlyFilter::getCoupledConf(CONFcouple **couples)
+{
+    *couples=new CONFcouple(0); // Even if we dont have configuration we must allocate one 
+    return true;
+}
+/**
+    \fn getConfiguration
+    \brief Return current setting as a string
+*/
+const char *lumaOnlyFilter::getConfiguration(void)
+{
+    
+    return "Greyscale.";
+}
+// Normally not needed :virtual FilterInfo  *getInfo(void)
+//EOF



From gruntster at mail.berlios.de  Thu Sep  9 22:30:04 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu,  9 Sep 2010 22:30:04 +0200
Subject: [Avidemux-svn-commit] r6613 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include
Message-ID: <20100909203004.58582480020@sheep.berlios.de>

Author: gruntster
Date: 2010-09-09 22:30:04 +0200 (Thu, 09 Sep 2010)
New Revision: 6613

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_mangle.h
Log:
[apple] ppc build fix

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_mangle.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_mangle.h	2010-09-09 14:36:36 UTC (rev 6612)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_mangle.h	2010-09-09 20:30:04 UTC (rev 6613)
@@ -18,7 +18,7 @@
 // Use rip-relative addressing if compiling PIC code on x86-64.
 #if defined(__MINGW32__) || defined(__CYGWIN__) || defined(__DJGPP__) || \
     defined(__OS2__) || (defined (__OpenBSD__) && !defined(__ELF__)) || \
-	(defined(__APPLE__) && defined(ADM_CPU_X86_32))
+	(defined(__APPLE__) && !defined(ADM_CPU_X86_64))
 #    if defined(ADM_CPU_X86_64) && defined(PIC) && !defined(__MINGW32__)
 #        define MANGLE(a) "_" #a"(%%rip)"
 #        define FUNNY_MANGLE(x) x asm(MANGLE(x))
@@ -33,8 +33,6 @@
 #        define MANGLE(a) #a"(%%rip)"
 #        define FUNNY_MANGLE(x) x asm(#x)
 #        define FUNNY_MANGLE_ARRAY(x, y)  x[y] asm(#x)
-#    elif defined(__APPLE__)
-#        define MANGLE(a) "_" #a
 #    else
 #        define MANGLE(a) #a
 #        define FUNNY_MANGLE(x) x asm(MANGLE(x))



From mean at mail.berlios.de  Sun Sep 12 16:17:20 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 12 Sep 2010 16:17:20 +0200
Subject: [Avidemux-svn-commit] r6614 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui
Message-ID: <20100912141720.27AF9480FEB@sheep.berlios.de>

Author: mean
Date: 2010-09-12 16:17:19 +0200 (Sun, 12 Sep 2010)
New Revision: 6614

Added:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_thumbSlider.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_thumbSlider.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui
Log:
[Qt4] Put back thumbSlider widget

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/CMakeLists.txt	2010-09-09 20:30:04 UTC (rev 6613)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/CMakeLists.txt	2010-09-12 14:17:19 UTC (rev 6614)
@@ -1,7 +1,7 @@
 SET(ADM_LIB ADM_guiQt4)
 
 QT4_WRAP_UI(${ADM_LIB}_header  gui2.ui )
-QT4_WRAP_CPP(${ADM_LIB}_source  Q_gui2.h  T_preview.h T_vumeter.h)
+QT4_WRAP_CPP(${ADM_LIB}_source  Q_gui2.h  T_preview.h T_vumeter.h T_thumbSlider.h)
 QT4_ADD_RESOURCES(${ADM_LIB}_resource  avidemux.qrc)
 
 SET(${ADM_LIB}_SRCS
@@ -10,6 +10,7 @@
         T_preview.cpp  
         T_vumeter.cpp  
         #stubs.cpp
+        T_thumbSlider.cpp
         file_qt4.cpp  gui_none.cpp  ADM_qslider.cpp
 	${${ADM_LIB}_header}  ${${ADM_LIB}_source}  ${${ADM_LIB}_resource})
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-09 20:30:04 UTC (rev 6613)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-12 14:17:19 UTC (rev 6614)
@@ -152,6 +152,14 @@
 	SliderIsShifted = 0;
 }
 
+void MainWindow::thumbSlider_valueEmitted(int value)
+{
+        if (value > 0)
+                nextIntraFrame();
+        else
+                previousIntraFrame();
+}
+
 void MainWindow::volumeChange( int u )
 {
 	if (_upd_in_progres || !ui.toolButtonAudioToggle->isChecked())
@@ -242,6 +250,11 @@
 	connect( slider,SIGNAL(sliderMoved(int)),this,SLOT(sliderMoved(int)));
 	connect( slider,SIGNAL(sliderReleased()),this,SLOT(sliderReleased()));
 
+   // Thumb slider
+    ui.sliderPlaceHolder->installEventFilter(this);
+    thumbSlider = new ThumbSlider(ui.sliderPlaceHolder);
+    connect(thumbSlider, SIGNAL(valueEmitted(int)), this, SLOT(thumbSlider_valueEmitted(int)));
+
 	// Volume slider
 	QSlider *volSlider=ui.horizontalSlider_2;
 	volSlider->setMinimum(0);
@@ -527,6 +540,14 @@
 			}
 
 			break;
+        case QEvent::Resize:
+            if (watched == ui.sliderPlaceHolder)
+            {
+                    thumbSlider->resize(ui.sliderPlaceHolder->width(), 16);
+                    thumbSlider->move(0, (ui.sliderPlaceHolder->height() - thumbSlider->height()) / 2);
+            }
+            break;
+
 		case QEvent::KeyRelease:
 			keyEvent = (QKeyEvent*)event;
 
@@ -629,6 +650,8 @@
 MainWindow::~MainWindow()
 {
 	clearCustomMenu();
+    delete thumbSlider;
+    thumbSlider=NULL;
 }
 
 void MainWindow::closeEvent(QCloseEvent *event)

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h	2010-09-09 20:30:04 UTC (rev 6613)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.h	2010-09-12 14:17:19 UTC (rev 6614)
@@ -4,7 +4,8 @@
 #include <QtGui/QSlider>
 #include <QtGui/QWidget>
 
-#include "ADM_qslider.h"
+#include "ADM_qslider.h"
+#include "T_thumbSlider.h"
 #include "ui_gui2.h"
 #include "gui_action.hxx"
 
@@ -32,7 +33,9 @@
     QMenu *pyMenu;
     QMenu *recentFiles;
     QMenu *recentProjects;
-    QAction *recentFileAction[4];
+    QAction *recentFileAction[4];
+    ThumbSlider *thumbSlider;
+    
 public slots:
 	void timeChanged(int);
 	void buttonPressed(void);
@@ -51,7 +54,10 @@
 	void nextIntraFrame(void);
 	void timeChangeFinished(void);
 	void currentFrameChanged(void);
-	void currentTimeChanged(void);
+	void currentTimeChanged(void);
+
+    void thumbSlider_valueEmitted(int value);
+
     void searchFileMenu(QAction * action);
     void searchEditMenu(QAction * action);
     void searchVideoMenu(QAction * action);

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_thumbSlider.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_thumbSlider.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_thumbSlider.cpp	2010-09-12 14:17:19 UTC (rev 6614)
@@ -0,0 +1,223 @@
+#include "T_thumbSlider.h"
+
+#include <QtGui/QStyle>
+
+ThumbSlider::ThumbSlider(QWidget *parent) : QAbstractSlider(parent)
+{
+	setMaximum(100);
+	setMinimum(-100);
+	setValue(0);
+
+	count = lock = 0;
+}
+
+void ThumbSlider::timerEvent(QTimerEvent *event)
+{
+	static const int jogScale[10] = {20, 15, 11, 8, 6, 5, 4, 3, 2, 0};
+	int r = abs(value()) / 10;
+
+	if (!r)
+		return;
+
+	if (count)
+		count--;
+
+	if (count)
+		return;
+
+	count = (r > 9 ? jogScale[9] : jogScale[r]);
+
+	if (lock)
+		return;
+
+	lock++;
+
+	emit valueEmitted(value());
+
+	lock--;
+}
+
+void ThumbSlider::paintEvent(QPaintEvent *event)
+{
+	QPainter painter;
+
+	painter.begin(this);
+	painter.setClipRect(event->rect());
+	painter.setPen(Qt::NoPen);
+
+	drawBackground(&painter);
+	drawLines(&painter);
+	drawBorders(&painter);
+	drawEdges(&painter);
+}
+
+void ThumbSlider::mousePressEvent(QMouseEvent *event)
+{
+	if (event->buttons() && Qt::LeftButton)
+	{
+		int value = QStyle::sliderValueFromPosition(minimum(), maximum(), event->x(), width(), false);
+
+		setSliderPosition(value);
+		timerId = startTimer(20);
+		triggerAction(SliderMove);
+	}
+}
+
+void ThumbSlider::mouseMoveEvent(QMouseEvent *event)
+{
+	if (event->buttons() && Qt::LeftButton)
+	{
+		int value = QStyle::sliderValueFromPosition(minimum(), maximum(), event->x(), width(), false);
+
+		setSliderPosition(value);
+		triggerAction(SliderMove);
+	}
+}
+
+void ThumbSlider::mouseReleaseEvent(QMouseEvent *event)
+{
+	killTimer(timerId);
+	setValue(0);
+	count = 0;
+
+	triggerAction(SliderNoAction);
+}
+
+void ThumbSlider::drawBackground(QPainter *painter)
+{
+	int middle = width() / 2;
+	QLinearGradient base1 = QLinearGradient(0, 1, middle - 5, 1);
+	QLinearGradient base2 = QLinearGradient(width() - 1, 1, middle + 5, 1);
+	QColor color1, color2;
+
+	color1.setRgbF(0.33, 0.33, 0.33);
+	color2.setRgbF(0.88, 0.88, 0.88);
+
+	base1.setColorAt(0, color1);
+	base1.setColorAt(1, color2);
+	base2.setColorAt(0, color1);
+	base2.setColorAt(1, color2);
+
+	painter->setBrush(base1);
+	painter->drawRect(1, 0, middle - 1, height() - 1);
+
+	painter->setBrush(base2);
+	painter->drawRect(middle, 0, middle - 1, height() - 1);
+
+	painter->setBrush(Qt::NoBrush);
+}
+
+void ThumbSlider::drawLines(QPainter *painter)
+{
+	float offset = (float)width() / 6.0;
+	int pos = QStyle::sliderPositionFromValue(minimum(), maximum(), value(), width(), false);
+	int middle = width() / 2;
+	int start = pos - (width() / 2);
+	float colourF;
+	QPen pen;
+	QColor color;
+
+	pen.setCapStyle(Qt::FlatCap);
+
+	for (int i = 0; i < 6; i++)
+	{
+		if (start > width())
+			start -= width();
+		else if (start < 0)
+			start = width() + start;
+
+		if (start <= middle)
+			colourF = (float)start / (float)middle * 0.85;
+		else
+			colourF = ((float)(width() - start)) / (float)middle * 0.85;
+
+		if (i == 3)
+		{
+			color.setRgbF(colourF, 0, 0);
+			pen.setWidth(2);
+		}
+		else
+		{
+			color.setRgbF(colourF, colourF, colourF);
+			pen.setWidth(1);
+		}
+
+		pen.setColor(color);
+		painter->setPen(pen);
+		painter->drawLine(start, 2, start, height() - 2);
+
+		start += offset;
+	}
+
+	painter->setPen(Qt::NoPen);
+}
+
+void ThumbSlider::drawBorders(QPainter *painter)
+{
+	int middle = width() / 2;
+	QColor color;
+
+	color.setRgbF(0.53, 0.53, 0.53);
+
+	painter->setPen(QPen(QBrush(color), 1, Qt::SolidLine, Qt::FlatCap));
+	painter->drawLine(1, 0, width() - 1, 0);
+	painter->drawLine(1, height() - 1, width() - 1, height() - 1);
+	painter->drawLine(0, 1, 0, height() - 1);
+	painter->drawLine(width() - 1, 1, width() - 1, height() - 1);
+
+	QLinearGradient grad1 = QLinearGradient(0, 1, middle - 6, 1);
+	QLinearGradient grad2 = QLinearGradient(width() - 1, 1, middle + 6, 1);
+	QLinearGradient grad3 = QLinearGradient(0, height() - 2, middle - 6, height() - 2);
+	QLinearGradient grad4 = QLinearGradient(width() - 1, height() - 2, middle + 6, height() - 2);
+	QColor color1, color2;
+
+	color1.setRgbF(0.00, 0.00, 0.00);
+	color2.setRgbF(0.98, 0.98, 0.98);
+
+	grad1.setColorAt(0, color1);
+	grad1.setColorAt(1, color2);
+
+	grad2.setColorAt(0, color1);
+	grad2.setColorAt(1, color2);
+
+	grad3.setColorAt(1, color2);
+	grad3.setColorAt(0, color1);
+
+	grad4.setColorAt(1, color2);
+	grad4.setColorAt(0, color1);
+
+	painter->setPen(QPen(grad1, 1, Qt::SolidLine, Qt::FlatCap));
+	painter->drawLine(1, 1, middle, 1);
+	painter->setPen(QPen(grad3, 1, Qt::SolidLine, Qt::FlatCap));
+	painter->drawLine(1, height() - 2, middle, height() - 2);
+	painter->setPen(QPen(grad2, 1, Qt::SolidLine, Qt::FlatCap));
+	painter->drawLine(middle, 1, width() - 1, 1);
+	painter->setPen(QPen(grad4, 1, Qt::SolidLine, Qt::FlatCap));
+	painter->drawLine(middle, height() - 2, width() - 1, height() - 2);
+
+	painter->setPen(Qt::NoPen);
+}
+
+void ThumbSlider::drawEdges(QPainter *painter)
+{
+	QLinearGradient grad1 = QLinearGradient(0, 2, 6, 2);
+	QLinearGradient grad2 = QLinearGradient(width() - 1, 2, width() - 6, 2);
+	QColor color1, color2;
+
+	color1.setRgbF(0.00, 0.00, 0.00);
+	color2.setRgbF(0.23, 0.23, 0.23);
+
+	grad1.setColorAt(0, color1);
+	grad1.setColorAt(1, color2);
+
+	grad2.setColorAt(0, color1);
+	grad2.setColorAt(1, color2);
+
+	painter->setBrush(grad1);
+	painter->drawRect(1, 2, 6, height() - 4);
+
+	painter->setBrush(grad2);
+	painter->drawRect(width() - 7, 2, 6, height() - 4);
+
+	painter->setBrush(Qt::NoBrush);
+}

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_thumbSlider.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_thumbSlider.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_thumbSlider.h	2010-09-12 14:17:19 UTC (rev 6614)
@@ -0,0 +1,35 @@
+#ifndef T_THUMBSLIDER_H
+#define T_THUMBSLIDER_H
+
+#include <QtGui/QPainter>
+#include <QtGui/QPaintEvent>
+#include <QtGui/QMouseEvent>
+#include <QtGui/QSlider>
+
+class ThumbSlider : public QAbstractSlider
+{
+	Q_OBJECT
+
+private:
+	int timerId, count, lock;
+
+	void drawBackground(QPainter *painter);
+	void drawLines(QPainter *painter);
+	void drawBorders(QPainter *painter);
+	void drawEdges(QPainter *painter);
+
+public:
+	ThumbSlider(QWidget *parent = 0);
+
+protected:
+	void timerEvent(QTimerEvent *event);
+	void paintEvent(QPaintEvent *event);
+	void mousePressEvent(QMouseEvent *event);
+	void mouseMoveEvent(QMouseEvent *event);
+	void mouseReleaseEvent(QMouseEvent *event);
+
+signals:
+	void valueEmitted(int value);
+};
+
+#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui	2010-09-09 20:30:04 UTC (rev 6613)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui	2010-09-12 14:17:19 UTC (rev 6614)
@@ -1180,6 +1180,9 @@
           </item>
          </layout>
         </item>
+        <item row="0" column="1">
+         <widget class="QWidget" name="sliderPlaceHolder" native="true"/>
+        </item>
        </layout>
       </item>
       <item>



From mean at mail.berlios.de  Sun Sep 12 16:17:21 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 12 Sep 2010 16:17:21 +0200
Subject: [Avidemux-svn-commit] r6615 -
	branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2
Message-ID: <20100912141721.9DFF5480FEB@sheep.berlios.de>

Author: mean
Date: 2010-09-12 16:17:21 +0200 (Sun, 12 Sep 2010)
New Revision: 6615

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
Log:
[Gtk] Add recent file menu entry

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-12 14:17:19 UTC (rev 6614)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-12 14:17:21 UTC (rev 6615)
@@ -66,6 +66,7 @@
 
 
 static GtkWidget *guiVideoToggle=NULL;
+static GtkWidget *guiRecentMenu=NULL;
 static GdkCursor *guiCursorBusy=NULL;
 static GdkCursor *guiCursorNormal=NULL;
 
@@ -348,6 +349,8 @@
 #endif
 
     ui_setMenus();
+    UI_updateRecentMenu(  );
+    GUI_initCustom();
 
 	return ret;
 }
@@ -547,8 +550,8 @@
                        GTK_SIGNAL_FUNC(on_format_change),
                        NULL);
 
-        // Add initial recent files
-        UI_updateRecentMenu(  );
+        
+        
     //
     //CYB 2005.02.22: DND (START)
     // Set up avidemux as an available drag'n'drop target.
@@ -566,8 +569,6 @@
 
    // By default enable arrow keys
    UI_arrow_enabled();
-  // Add custom menu
- GUI_initCustom();
     return 1;
 
 }
@@ -942,12 +943,12 @@
 /**
     \fn ui_setMenus
 */
-void ui_setOneMenu(const char *menuName, MenuEntry *desc, int nb)
+GtkWidget *ui_fillOneMenu(GtkWidget *rootMenu, MenuEntry *desc, int nb)
 {
+    
     GtkWidget *window;
     GtkWidget *menu;
     GtkWidget *menu_bar;
-    GtkWidget *root_menu;
     GtkWidget *menu_items;
     GtkWidget *submenu=NULL;
 
@@ -990,22 +991,31 @@
         }
     }
 
-    /* This is the root menu, and will be the label
-     * displayed on the menu bar.  There won't be a signal handler attached,
-     * as it only pops up the rest of the menu when pressed. */
-    root_menu = gtk_menu_item_new_with_label (menuName);
+    /* Now we specify that we want our newly created "menu" to be the menu
+     * for the "root menu" */
+    gtk_menu_item_set_submenu (GTK_MENU_ITEM (rootMenu), menu);
+    return rootMenu;
+}
 
+/**
+    \fn ui_setOneMenu
+*/
+GtkWidget *ui_setOneMenu(const char *menuName, MenuEntry *desc, int nb)
+{
+    GtkWidget *root_menu = gtk_menu_item_new_with_label (menuName);
+
     gtk_widget_show (root_menu);
 
-    /* Now we specify that we want our newly created "menu" to be the menu
-     * for the "root menu" */
-    gtk_menu_item_set_submenu (GTK_MENU_ITEM (root_menu), menu);
     /* Create a menu-bar to hold the menus and add it to our main window */
-    menu_bar=(glade.getWidget("menuBar"));
+    GtkWidget *menu_bar=(glade.getWidget("menuBar"));
     /* Create a button to which to attach menu as a popup */
     /* And finally we append the menu-item to the menu-bar -- this is the
      * "root" menu-item I have been raving about =) */
     gtk_menu_shell_append (GTK_MENU_SHELL (menu_bar), root_menu);
+    if(nb)
+        ui_fillOneMenu(root_menu, desc,  nb);
+    return root_menu;
+
 }
 /**
     \fn ui_setMenus
@@ -1014,7 +1024,7 @@
 {
 #define SZ(x) x,sizeof(x)/sizeof(MenuEntry)
     ui_setOneMenu("File", SZ(myMenuFile));
-    ui_setOneMenu("Recent", NULL,0);
+    guiRecentMenu=ui_setOneMenu("Recent", NULL,0);
     ui_setOneMenu("Edit", SZ(myMenuEdit));
     ui_setOneMenu("View", SZ(myMenuView));
     ui_setOneMenu("Video", SZ(myMenuVideo));
@@ -1389,7 +1399,27 @@
                 gtk_widget_show (item[i]);
         }
         gtk_menu_tool_button_set_menu   (GTK_MENU_TOOL_BUTTON(button),menu);
-        return 1;
+/**/
+    {
+    GtkWidget *menu;
+    GtkWidget *menu_items;
+    menu = gtk_menu_new ();
+    gtk_menu_item_set_submenu (GTK_MENU_ITEM (guiRecentMenu), menu);
+    for(int i=0;i<4;i++)
+        {
+                     if(!names[i]) break;
+                     menu_items = gtk_menu_item_new_with_label (names[i]);
+                     gtk_menu_shell_append (GTK_MENU_SHELL (menu), menu_items);
+                     gtk_widget_show (menu_items);
+                     gtk_signal_connect(GTK_OBJECT(menu_items), "activate", 
+                        GTK_SIGNAL_FUNC(guiCallback),                   (void *) recent[i]);
+                     gtk_widget_show (menu_items);
+        }
+      
+    gtk_widget_show(menu);
+    gtk_widget_show(guiRecentMenu);
+    }  
+    return 1;
 }
 
 // Override arrow keys to quickly navigate



From mean at mail.berlios.de  Sun Sep 12 16:17:22 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 12 Sep 2010 16:17:22 +0200
Subject: [Avidemux-svn-commit] r6616 -
	branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog
Message-ID: <20100912141722.D6B23480FEB@sheep.berlios.de>

Author: mean
Date: 2010-09-12 16:17:22 +0200 (Sun, 12 Sep 2010)
New Revision: 6616

Added:
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_encoding_none.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_encoding.cpp
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_working.cpp
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/alert_none.cpp
Log:
[CLI] Add ui functions

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/CMakeLists.txt	2010-09-12 14:17:21 UTC (rev 6615)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/CMakeLists.txt	2010-09-12 14:17:22 UTC (rev 6616)
@@ -1,7 +1,12 @@
 SET(ADM_LIB ADM_dialogCli6)
 
 SET(${ADM_LIB}_SRCS 
-	alert_none.cpp  DIA_busy.cpp  
-        DIA_indexing.cpp  DIA_none.cpp  DIA_working.cpp  OCR_none.cpp)
+	alert_none.cpp  
+        DIA_busy.cpp  
+        DIA_encoding.cpp
+        DIA_indexing.cpp  
+        DIA_none.cpp  
+        DIA_working.cpp  
+        OCR_none.cpp)
 
 ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_encoding.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_encoding.cpp	2010-09-12 14:17:21 UTC (rev 6615)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_encoding.cpp	2010-09-12 14:17:22 UTC (rev 6616)
@@ -6,127 +6,75 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-
-# include "config.h"
-
-#include <sys/types.h>
-#include <sys/stat.h>
-#include <unistd.h>
-#include <string.h>
-#include <stdio.h>
 #include <math.h>
+#include "ADM_inttype.h"
+//#include "Q_encoding.h"
 
-#include "ADM_default.h"
-
 #include "prefs.h"
-
-
-
-#include "ADM_assert.h" 
-
+#include "DIA_working.h"
 #include "DIA_encoding.h"
-#include "ADM_video/ADM_vidMisc.h"
-DIA_encoding::DIA_encoding( uint32_t fps1000 )
+#include "DIA_coreToolkit.h"
+#include "avidemutils.h"
+#include "ADM_vidMisc.h"
+#include "DIA_encoding_none.h"
+
+DIA_encodingCli::DIA_encodingCli( uint64_t fps1000 ) : DIA_encodingBase(fps1000)
 {
-uint32_t useTray=0;
-        if(!prefs->get(FEATURE_USE_SYSTRAY,&useTray)) useTray=0;
 
-
-
-        _lastnb=0;
-        _totalSize=0;
-        _audioSize=0;
-        _videoSize=0;
-        _current=0;
-        setFps(fps1000);
-        _lastTime=0;
-        _lastFrame=0;
-        _fps_average=0;
-
-        _total=1000;
-
 }
-void DIA_encoding::setFps(uint32_t fps)
-{
-        _roundup=(uint32_t )floor( (fps+999)/1000);
-        _fps1000=fps;
-        ADM_assert(_roundup<MAX_BR_SLOT);
-        memset(_bitrate,0,sizeof(_bitrate));
-        _bitrate_sum=0;
-        _average_bitrate=0;
-        
-}
 
-void DIA_stop( void)
-{
-        printf("Stop request\n");
 
-}
-DIA_encoding::~DIA_encoding( )
+DIA_encodingCli::~DIA_encodingCli( )
 {
 
 }
-void DIA_encoding::setPhasis(const char *n)
+void DIA_encodingCli::setPhasis(const char *n)
 {
             fprintf(stderr,"Encoding Phase        : %s\n",n);
 
 }
-void DIA_encoding::setAudioCodec(const char *n)
+void DIA_encodingCli::setAudioCodec(const char *n)
 {
             fprintf(stderr,"Encoding Audio codec  : %s\n",n);
 
 }
 
-void DIA_encoding::setCodec(const char *n)
+void DIA_encodingCli::setContainer(const char *container)
 {
-            fprintf(stderr,"Encoding Video codec  : %s\n",n);
-
-}
-
-void DIA_encoding::reset(void)
-{
-          
-          _totalSize=0;
-          _videoSize=0;
-          _current=0;
-}
-void DIA_encoding::setContainer(const char *container)
-{
         fprintf(stderr,"Encoding Container        : %s\n",container);
 }
 #define  ETA_SAMPLE_PERIOD 60000 //Use last n millis to calculate ETA
 #define  GUI_UPDATE_RATE 500  
 
-void DIA_encoding::setFrame(uint32_t nb,uint32_t size, uint32_t quant,uint32_t total)
+         
+bool DIA_encodingCli::isAlive( void )
 {
-          _total=total;
-          _videoSize+=size;
-          if(nb < _lastnb || _lastnb == 0) // restart ?
-           {
-                _lastnb = nb;
-                clock.reset();
-                _lastTime=clock.getElapsedMS();
-                _lastFrame=0;
-                _fps_average=0;
-                _videoSize=size;
-    
-                _nextUpdate = _lastTime + GUI_UPDATE_RATE;
-                _nextSampleStartTime=_lastTime + ETA_SAMPLE_PERIOD;
-                _nextSampleStartFrame=0;
-          } 
-          _lastnb = nb;
-          _current=nb%_roundup;
-          _bitrate[_current].size=size;
-          _bitrate[_current].quant=quant;
-}
 
-
-void DIA_encoding::setAudioSize(uint32_t size)
+        return 1;
+}
+    void DIA_encodingCli::setTotalSize(uint64_t size){}
+    void DIA_encodingCli::setAudioSize(uint64_t size){}
+    void DIA_encodingCli::setVideoSize(uint64_t size){}
+    void DIA_encodingCli::setPercent(uint32_t percent){}
+    void DIA_encodingCli::setFps(uint32_t fps){}
+    void DIA_encodingCli::setFrameCount(uint32_t nb){}
+    void DIA_encodingCli::setElapsedTimeMs(uint32_t nb){}
+    void DIA_encodingCli::setRemainingTimeMS(uint32_t nb){}
+    void DIA_encodingCli::setAverageQz(uint32_t nb){}
+    void DIA_encodingCli::setAverageBitrateKbits(uint32_t kb){}
+void DIA_encodingCli::setVideoCodec(const char *n)
 {
-      
+
 }
-uint8_t DIA_encoding::isAlive( void )
+//**********************************
+namespace ADM_CliCoreUIToolkit
 {
+extern DIA_encodingBase *createEncoding(uint64_t duration)
+{
+        return new DIA_encodingCli(duration);
+}
 
-        return 1;
 }
+
+
+

Added: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_encoding_none.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_encoding_none.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_encoding_none.h	2010-09-12 14:17:22 UTC (rev 6616)
@@ -0,0 +1,59 @@
+/** *************************************************************************
+             
+    \fn Q_encoding.h
+    
+                      
+    copyright            : (C) 2008 by mean/gruntster/?
+    
+ ***************************************************************************/
+
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef DIA_encoding_none_h
+#define DIA_encoding_none_h
+
+
+#include "ADM_inttype.h"
+#include "DIA_encoding.h"
+/**
+    \class DIA_encodingQt4
+*/
+
+class DIA_encodingCli : public DIA_encodingBase
+{
+public:
+    DIA_encodingCli( uint64_t duration);
+    ~DIA_encodingCli( );
+    
+protected:
+    void setTotalSize(uint64_t size);
+    void setAudioSize(uint64_t size);
+    void setVideoSize(uint64_t size);
+    void setPercent(uint32_t percent);
+    void setFps(uint32_t fps);
+    void setFrameCount(uint32_t nb);
+    void setElapsedTimeMs(uint32_t nb);
+    void setRemainingTimeMS(uint32_t nb);
+    void setAverageQz(uint32_t nb);
+    void setAverageBitrateKbits(uint32_t kb);
+
+public:    
+
+    
+    void setPhasis(const char *n);
+    void setAudioCodec(const char *n);
+    void setVideoCodec(const char *n);
+    void setBitrate(uint32_t br,uint32_t globalbr);
+    void setContainer(const char *container);
+    void setQuantIn(int size);
+    bool isAlive( void );
+    
+};
+#endif	// DIA_encoding_none_h

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_none.cpp	2010-09-12 14:17:21 UTC (rev 6615)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_none.cpp	2010-09-12 14:17:22 UTC (rev 6616)
@@ -121,5 +121,6 @@
 	printf("*********************************\n");
 	printf("*********************************\n");
 }
-bool UI_setDecoderName(const char *name) {return true;}
+bool UI_setDecoderName(const char *name) {return true;}
+int32_t UI_readJog(void) {return 0;};
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_working.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_working.cpp	2010-09-12 14:17:21 UTC (rev 6615)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_working.cpp	2010-09-12 14:17:22 UTC (rev 6616)
@@ -139,4 +139,11 @@
 	
         
 }
+namespace ADM_CliCoreUIToolkit
+{
+DIA_workingBase *createWorking(const char *title)
+{
+        return new DIA_workingNone(title);
 
+}
+}

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/alert_none.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/alert_none.cpp	2010-09-12 14:17:21 UTC (rev 6615)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/alert_none.cpp	2010-09-12 14:17:22 UTC (rev 6616)
@@ -13,6 +13,7 @@
 #include "prefs.h"
 
 #include "DIA_coreToolkit.h"
+#include "DIA_coreUI_internal.h"
 
 #include "ADM_assert.h" 
 
@@ -41,8 +42,12 @@
 }
 
 
+namespace ADM_CliCoreUIToolkit
+{
+extern DIA_workingBase *createWorking(const char *title);
+extern DIA_encodingBase *createEncoding(uint64_t duration);
 
-void            GUI_Info_HIG(const ADM_LOG_LEVEL level,const char *primary, const char *secondary_format, ...)
+void            GUI_Info_HIG(const ADM_LOG_LEVEL level,const char *primary, const char *secondary_format)
 {
   uint32_t msglvl=2;
 
@@ -58,20 +63,12 @@
                 return;
         }
 
-        va_list ap;
-        va_start(ap, secondary_format);
-        
-        
-        char alertstring[1024];
-        
-        vsnprintf(alertstring,1023,secondary_format, ap);
-        va_end(ap);
-        boxAdd(alertstring);
+        boxAdd(secondary_format);
         boxEnd();
         
 }
 
-void            GUI_Error_HIG(const char *primary, const char *secondary_format, ...)
+void            GUI_Error_HIG(const char *primary, const char *secondary_format)
 {
         boxStart();
         boxAdd("Error");
@@ -82,18 +79,11 @@
                 return;
         }else
         {
-          va_list ap;
-          va_start(ap, secondary_format);
-
-          char alertstring[1024];
-          
-          vsnprintf(alertstring,1023,secondary_format, ap);
-          va_end(ap);
-          boxAdd(alertstring);
+          boxAdd(secondary_format);
           boxEnd();
         }
 }
-int             GUI_Confirmation_HIG(const char *button_confirm, const char *primary, const char *secondary_format, ...)
+int             GUI_Confirmation_HIG(const char *button_confirm, const char *primary, const char *secondary_format)
 {
    uint32_t msglvl=2;
 
@@ -110,15 +100,7 @@
         }
         else
         {
-            va_list ap;
-            va_start(ap, secondary_format);
-            
-            
-            char alertstring[1024];
-            
-            vsnprintf(alertstring,1023,secondary_format, ap);
-            va_end(ap);
-            boxAdd(alertstring);
+            boxAdd(secondary_format);
             boxEnd();
         }
         if (beQuiet)
@@ -140,7 +122,7 @@
         return 0; 
 }
 
-int             GUI_YesNo(const char *primary, const char *secondary_format, ...)
+int             GUI_YesNo(const char *primary, const char *secondary_format)
 {
    uint32_t msglvl=2;
 
@@ -157,15 +139,7 @@
         }
         else
         {
-            va_list ap;
-            va_start(ap, secondary_format);
-            
-            
-            char alertstring[1024];
-            
-            vsnprintf(alertstring,1023,secondary_format, ap);
-            va_end(ap);
-            boxAdd(alertstring);
+            boxAdd(secondary_format);
             boxEnd();
         }
         if (beQuiet)
@@ -204,7 +178,7 @@
           }
 }
 
-int      GUI_Alternate(char *title,char *choice1,char *choice2)
+int      GUI_Alternate(const char *title,const char *choice1,const char *choice2)
 {
   boxStart();
   boxAdd("Choice");
@@ -246,8 +220,37 @@
 {
  return 0; 
 }
+void getVersion(uint32_t *maj,uint32_t *minor)
+{
+    *maj=ADM_CORE_TOOLKIT_MAJOR;
+    *minor=ADM_CORE_TOOLKIT_MINOR;
+}
+
+void UI_purge( void )
+{
+}
+
+}; // namespace
+static CoreToolkitDescriptor CliCoreToolkitDescriptor=
+{
+		&ADM_CliCoreUIToolkit::getVersion,
+		&ADM_CliCoreUIToolkit::GUI_Info_HIG,
+		&ADM_CliCoreUIToolkit::GUI_Error_HIG,
+		&ADM_CliCoreUIToolkit::GUI_Confirmation_HIG,
+		&ADM_CliCoreUIToolkit::GUI_YesNo,
+		&ADM_CliCoreUIToolkit::GUI_Question,
+		&ADM_CliCoreUIToolkit::GUI_Alternate,
+		&ADM_CliCoreUIToolkit::GUI_Verbose,
+		&ADM_CliCoreUIToolkit::GUI_Quiet,
+		&ADM_CliCoreUIToolkit::GUI_isQuiet,
+                &ADM_CliCoreUIToolkit::createWorking,
+                &ADM_CliCoreUIToolkit::createEncoding,
+                &ADM_CliCoreUIToolkit::UI_purge
+};
+
+
 void InitCoreToolkit(void)
 {
-	
+	DIA_toolkitInit(&CliCoreToolkitDescriptor);
 }
 //EOF



From gruntster at mail.berlios.de  Sun Sep 12 21:22:15 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 12 Sep 2010 21:22:15 +0200
Subject: [Avidemux-svn-commit] r6617 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_toolkit
	ADM_userInterfaces/ADM_QT4 ADM_userInterfaces/ADM_QT4/ADM_gui
	ADM_userInterfaces/ADM_render
Message-ID: <20100912192215.B5822480FEB@sheep.berlios.de>

Author: gruntster
Date: 2010-09-12 21:22:15 +0200 (Sun, 12 Sep 2010)
New Revision: 6617

Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/filesel.cpp
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ui_support.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_sdlRender.cpp
Log:
[apple] at least get 64-bit with SDL to compile

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/CMakeLists.txt	2010-09-12 14:17:22 UTC (rev 6616)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/CMakeLists.txt	2010-09-12 19:22:15 UTC (rev 6617)
@@ -1,5 +1,5 @@
 SET(ADM_toolkit_SRCS 
-	ADM_audioQueue.cpp  ADM_packetQueue.cpp  automation.cpp  filesel.cpp)
+	ADM_audioQueue.cpp  ADM_packetQueue.cpp  automation.cpp)
 
 include_directories("${PTHREAD_INCLUDE_DIR}")
 ADD_ADM_LIB_ALL_TARGETS(ADM_toolkit ${ADM_toolkit_SRCS})

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/filesel.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/filesel.cpp	2010-09-12 14:17:22 UTC (rev 6616)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/filesel.cpp	2010-09-12 19:22:15 UTC (rev 6617)
@@ -1,2 +0,0 @@
-// rmed
-

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2010-09-12 14:17:22 UTC (rev 6616)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2010-09-12 19:22:15 UTC (rev 6617)
@@ -231,8 +231,13 @@
 #if defined(__WIN32)
 	xinfo->display=videoWindow->winId();
 #elif defined(__APPLE__)
-	xinfo->display = HIViewGetWindow(HIViewRef(widget->winId()));
-	xinfo->window = 0;
+	#if defined(ADM_CPU_X86_64)
+		xinfo->display = (void*)videoWindow->winId();
+		xinfo->window = 0;
+	#else
+		xinfo->display = HIViewGetWindow(HIViewRef(widget->winId()));
+		xinfo->window = 0;
+	#endif
 #else
     const QX11Info &info=videoWindow->x11Info();
     xinfo->display=info.display();

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ui_support.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ui_support.cpp	2010-09-12 14:17:22 UTC (rev 6616)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ui_support.cpp	2010-09-12 19:22:15 UTC (rev 6617)
@@ -140,7 +140,7 @@
 {
 	*handle = (intptr_t)QuiMainWindows;
 
-#if defined(__APPLE__)
+#if defined(__APPLE__) && !defined(ADM_CPU_X86_64)
 	*nativeHandle = (intptr_t)HIViewGetWindow(HIViewRef(QuiMainWindows->winId()));
 #else
 	*nativeHandle = (intptr_t)QuiMainWindows->winId();

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/CMakeLists.txt	2010-09-12 14:17:22 UTC (rev 6616)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/CMakeLists.txt	2010-09-12 19:22:15 UTC (rev 6617)
@@ -1,24 +1,22 @@
 SET(ADM_LIB ADM_render)
+SET(${ADM_LIB}_SRCS GUI_render.cpp GUI_sdlRender.cpp GUI_xvRender.cpp)
+SDLify(GUI_sdlRender.cpp)
 
-SET(${ADM_LIB}_SRCS
-GUI_render.cpp
-GUI_sdlRender.cpp
-GUI_xvRender.cpp
-)
+ADD_ADM_SHARED_LIB_CLI_TARGET(${ADM_LIB} ${${ADM_LIB}_SRCS})
 
-IF (APPLE)
-	SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS} GUI_sdlRenderHelper.m)
-ENDIF (APPLE)
+IF (GETTEXT_FOUND)
+	TARGET_LINK_LIBRARIES(${ADM_LIB}_cli ${GETTEXT_LIBRARY_DIR})
+ENDIF (GETTEXT_FOUND)
 
-ADD_ADM_SHARED_LIB_ALL_TARGETS(${ADM_LIB} ${${ADM_LIB}_SRCS})
-SDLify(GUI_sdlRender.cpp)
-ADM_TARGET_LINK_LIBARIES_ALL_TARGET(${ADM_LIB} ADM_core ADM_coreUI ADM_coreImage)
+INSTALL(TARGETS ${ADM_LIB}_cli RUNTIME DESTINATION ${BIN_DIR}  LIBRARY DESTINATION lib${LIB_SUFFIX}  ARCHIVE DESTINATION lib${LIB_SUFFIX})
 
-IF (APPLE)
-	ADM_TARGET_LINK_LIBARIES_ALL_TARGET(${ADM_LIB} "-framework Cocoa")
-ENDIF (APPLE)
+IF (ADM_UI_GTK)
+	IF (APPLE AND NOT ADM_CPU_X86_64)
+		ADD_ADM_SHARED_LIB_GTK_TARGET(${ADM_LIB} ${${ADM_LIB}_SRCS} GUI_sdlRenderHelper.m)
+	ELSE (APPLE AND NOT ADM_CPU_X86_64)
+		ADD_ADM_SHARED_LIB_GTK_TARGET(${ADM_LIB} ${${ADM_LIB}_SRCS})
+	ENDIF (APPLE AND NOT ADM_CPU_X86_64)
 
-IF (ADM_UI_GTK)
 	IF (GETTEXT_FOUND)
 		TARGET_LINK_LIBRARIES(${ADM_LIB}_gtk ${GETTEXT_LIBRARY_DIR})
 	ENDIF (GETTEXT_FOUND)
@@ -35,6 +33,12 @@
 ENDIF (ADM_UI_GTK)
 
 IF (ADM_UI_QT4)
+	IF (APPLE AND NOT ADM_CPU_X86_64)
+		ADD_ADM_SHARED_LIB_QT4_TARGET(${ADM_LIB} ${${ADM_LIB}_SRCS} GUI_sdlRenderHelper.m)
+	ELSE (APPLE AND NOT ADM_CPU_X86_64)
+		ADD_ADM_SHARED_LIB_QT4_TARGET(${ADM_LIB} ${${ADM_LIB}_SRCS})
+	ENDIF (APPLE AND NOT ADM_CPU_X86_64)
+
 	IF (USE_SDL)
 		TARGET_LINK_LIBRARIES(${ADM_LIB}_qt4 ${SDL_LIBRARY})
 	ENDIF (USE_SDL)
@@ -46,8 +50,8 @@
 	INSTALL(TARGETS ${ADM_LIB}_qt4 RUNTIME DESTINATION ${BIN_DIR}  LIBRARY DESTINATION lib${LIB_SUFFIX}  ARCHIVE DESTINATION lib${LIB_SUFFIX})
 ENDIF (ADM_UI_QT4)
 
-IF (GETTEXT_FOUND)
-	TARGET_LINK_LIBRARIES(${ADM_LIB}_cli ${GETTEXT_LIBRARY_DIR})
-ENDIF (GETTEXT_FOUND)
+ADM_TARGET_LINK_LIBARIES_ALL_TARGET(${ADM_LIB} ADM_core ADM_coreUI ADM_coreImage)
 
-INSTALL(TARGETS ${ADM_LIB}_cli RUNTIME DESTINATION ${BIN_DIR}  LIBRARY DESTINATION lib${LIB_SUFFIX}  ARCHIVE DESTINATION lib${LIB_SUFFIX})
+IF (APPLE)
+	ADM_TARGET_LINK_LIBARIES_ALL_TARGET(${ADM_LIB} "-framework Cocoa")
+ENDIF (APPLE)
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_sdlRender.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_sdlRender.cpp	2010-09-12 14:17:22 UTC (rev 6616)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_sdlRender.cpp	2010-09-12 19:22:15 UTC (rev 6617)
@@ -39,7 +39,7 @@
 #include "GUI_sdlRender.h"
 #include "ADM_assert.h"
 
-#ifdef __APPLE__
+#if defined(__APPLE__) && !defined(ADM_CPU_X86_64)
 extern "C"
 {
 	void initSdlCocoaView(void* parent, int x, int y, int width, int height, bool carbonParent);
@@ -77,7 +77,7 @@
         {
                 SDL_QuitSubSystem(SDL_INIT_VIDEO);
 
-#ifdef __APPLE__
+#if defined(__APPLE__) && !defined(ADM_CPU_X86_64)
 				destroyCocoaView();
 #endif
         }
@@ -163,7 +163,7 @@
 	putenv(origin);
 #endif
 
-#ifdef __APPLE__
+#if defined(__APPLE__) && !defined(ADM_CPU_X86_64)
 	void* parent;
 
 	if (window->display)



From mean at mail.berlios.de  Sun Sep 19 09:35:28 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 19 Sep 2010 09:35:28 +0200
Subject: [Avidemux-svn-commit] r6618 - in
	branches/avidemux_2.6_branch_mean/autononreg: js py/avidemux
Message-ID: <20100919073528.96750481091@sheep.berlios.de>

Author: mean
Date: 2010-09-19 09:35:28 +0200 (Sun, 19 Sep 2010)
New Revision: 6618

Added:
   branches/avidemux_2.6_branch_mean/autononreg/js/setContainer.js
   branches/avidemux_2.6_branch_mean/autononreg/py/avidemux/setContainer.py
Log:
[js/py] Add setContainer func

Added: branches/avidemux_2.6_branch_mean/autononreg/js/setContainer.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/js/setContainer.js	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/autononreg/js/setContainer.js	2010-09-19 07:35:28 UTC (rev 6618)
@@ -0,0 +1,27 @@
+//AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
+var app = new Avidemux();
+var file="/work/samples/avi/2mn.avi";
+var dir="/tmp/";
+/* Load file
+*/
+if(!app.load(file))
+{
+	displayError("Failed to load "+file);
+}
+/*
+	Save using all codec with their default settings
+*/
+app.setContainer("AVI");
+/*
+
+*/
+doit("x264","xvid4");
+/* End of test
+*/
+function doit(codec,out)
+{
+app.video.codec("copy","CQ=4","");
+app.save(dir+out+".avi");
+return true;
+
+}

Added: branches/avidemux_2.6_branch_mean/autononreg/py/avidemux/setContainer.py
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/py/avidemux/setContainer.py	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/autononreg/py/avidemux/setContainer.py	2010-09-19 07:35:28 UTC (rev 6618)
@@ -0,0 +1,12 @@
+#PY  <- Needed to identify#
+#--automatically built--
+#--Project: /tmp/foobar.py
+
+adm=Avidemux()
+#** Video **
+# 01 videos source 
+adm.loadVideo("/work/samples/avi/2mn.avi")
+#** Muxer **
+adm.setContainer("AVI")
+
+#End of script



From mean at mail.berlios.de  Sun Sep 19 09:35:29 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 19 Sep 2010 09:35:29 +0200
Subject: [Avidemux-svn-commit] r6619 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <20100919073530.0CBE2481091@sheep.berlios.de>

Author: mean
Date: 2010-09-19 09:35:29 +0200 (Sun, 19 Sep 2010)
New Revision: 6619

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.hxx
Log:
[action] Handle getName() for CUSTOM action

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.cpp	2010-09-19 07:35:28 UTC (rev 6618)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.cpp	2010-09-19 07:35:29 UTC (rev 6619)
@@ -110,7 +110,11 @@
 }
 
 const char * getActionName (Action act)
-{
+{
+    if(act>=ACT_CUSTOM_BASE_PY) return "ACT_PY_SCRIPT";
+    if(act>=ACT_CUSTOM_BASE_JS) return "ACT_JS_SCRIPT";
+    if(act==ACT_DUMMY) return "ACT_DUMMY";
+
     uint32_t index = act - action_names [0].num;
     return (action_names [index].name);
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.hxx
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.hxx	2010-09-19 07:35:28 UTC (rev 6618)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.hxx	2010-09-19 07:35:29 UTC (rev 6619)
@@ -17,7 +17,7 @@
 
 #ifndef __GUI_ACTION
 #define __GUI_ACTION
-#define ADM_MAC_CUSTOM_SCRIPT 10
+#define ADM_MAX_CUSTOM_SCRIPT 10
 enum Action
 {
     ACT_INVALID = 0,
@@ -27,9 +27,9 @@
 #undef ACT
 
 ACT_CUSTOM_BASE_JS,
-ACT_CUSTOM_END_JS=ACT_CUSTOM_BASE_JS+ADM_MAC_CUSTOM_SCRIPT,
+ACT_CUSTOM_END_JS=ACT_CUSTOM_BASE_JS+ADM_MAX_CUSTOM_SCRIPT,
 ACT_CUSTOM_BASE_PY,
-ACT_CUSTOM_END_PY=ACT_CUSTOM_BASE_PY+ADM_MAC_CUSTOM_SCRIPT,
+ACT_CUSTOM_END_PY=ACT_CUSTOM_BASE_PY+ADM_MAX_CUSTOM_SCRIPT,
 ACT_DUMMY
 };
 



From mean at mail.berlios.de  Sun Sep 19 09:35:31 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 19 Sep 2010 09:35:31 +0200
Subject: [Avidemux-svn-commit] r6620 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui
Message-ID: <20100919073531.3F65C481091@sheep.berlios.de>

Author: mean
Date: 2010-09-19 09:35:31 +0200 (Sun, 19 Sep 2010)
New Revision: 6620

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2_menu.cpp
Log:
[Custom] Load py custom script even if there is no js script (was aborting too early)

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2_menu.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2_menu.cpp	2010-09-19 07:35:29 UTC (rev 6619)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2_menu.cpp	2010-09-19 07:35:31 UTC (rev 6620)
@@ -39,8 +39,8 @@
 
 #define JS_CUSTOM 0
 #define PY_CUSTOM 1
-static char     *customNames[2][ADM_MAC_CUSTOM_SCRIPT];
-static QAction  *customActions[2][ADM_MAC_CUSTOM_SCRIPT];
+static char     *customNames[2][ADM_MAX_CUSTOM_SCRIPT];
+static QAction  *customActions[2][ADM_MAX_CUSTOM_SCRIPT];
 static uint32_t ADM_nbCustom[2]={0,0};
 /**
     \fn clearCustomMenu
@@ -95,19 +95,20 @@
             ext=string(".py");
         }
         myDir=customFolder+subDir;
-        if (! buildDirectoryContent(&(ADM_nbCustom[pool]), myDir.c_str(), customNames[pool], ADM_MAC_CUSTOM_SCRIPT,ext.c_str()))
+        if (! buildDirectoryContent(&(ADM_nbCustom[pool]), myDir.c_str(), customNames[pool], ADM_MAX_CUSTOM_SCRIPT,ext.c_str()))
         {
-            printf("Failed to build custom dir content");
-            return;
+            ADM_warning("Failed to build custom dir content (%s)\n",myDir.c_str());
+            continue;
         }
 
         if(ADM_nbCustom[pool])
         {
-            printf("Found %u custom script(s), adding them (%s)\n", ADM_nbCustom[pool],subDir.c_str());
+            ADM_info("Found %u custom script(s), adding them (%s)\n", ADM_nbCustom[pool],subDir.c_str());
 
             for(int i=0; i < ADM_nbCustom[pool]; i++)
             {
                 QAction *action= new QAction(QString::fromUtf8(ADM_GetFileName(customNames[pool][i])), NULL);
+                //ADM_info("\t%s\n",ADM_GetFileName(customNames[pool][i]));
                 customActions[pool][i] = action;
                 if(pool==JS_CUSTOM)
                 {
@@ -122,9 +123,9 @@
             }
         }
         else
-            printf("No custom scripts\n");
+            ADM_info("No custom scripts\n");
     }
-	printf("Custom menu built\n");
+	ADM_info("Custom menu built\n");
 }
 
 /**



From mean at mail.berlios.de  Sun Sep 19 09:35:32 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 19 Sep 2010 09:35:32 +0200
Subject: [Avidemux-svn-commit] r6621 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <20100919073532.67C31481091@sheep.berlios.de>

Author: mean
Date: 2010-09-19 09:35:32 +0200 (Sun, 19 Sep 2010)
New Revision: 6621

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp
Log:
[Editor] Handle video not starting at zero when no b frame, for example flv

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2010-09-19 07:35:31 UTC (rev 6620)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2010-09-19 07:35:32 UTC (rev 6621)
@@ -334,6 +334,7 @@
         {
                 printf("[Editor] No B frame with that codec, PTS=DTS\n");
                 setPtsEqualDts(video._aviheader,video.timeIncrementInUs);
+                _segments.updateRefVideo();
         }
      }
   

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp	2010-09-19 07:35:31 UTC (rev 6620)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp	2010-09-19 07:35:32 UTC (rev 6621)
@@ -51,6 +51,9 @@
         {
             ADM_warning("Updating firstFramePTS, The first frame has a PTS >0, adjusting to %"LLU" ms\n",pts/1000);
             ref->firstFramePts=pts;
+        }else
+        {
+            ADM_info("First PTS is %s\n",ADM_us2plain(pts));
         }
     
     updateStartTime();
@@ -110,6 +113,7 @@
         demuxer->getFlags(0,&flags);
         demuxer->getPtsDts(0,&pts,&dts);
         ref->firstFramePts=0;
+        if(pts==ADM_NO_PTS) ADM_warning("First frame has unknown PTS\n");
         if(pts!=ADM_NO_PTS &&pts)
         {
             ADM_warning("The first frame has a PTS >0, adjusting to %"LLU" ms\n",pts/1000);



From mean at mail.berlios.de  Sun Sep 19 09:35:33 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 19 Sep 2010 09:35:33 +0200
Subject: [Avidemux-svn-commit] r6622 - in branches/avidemux_2.6_branch_mean:
	avidemux/common/ADM_editor avidemux_core/ADM_coreImage/include
	avidemux_core/ADM_coreImage/src
Message-ID: <20100919073533.EC944481091@sheep.berlios.de>

Author: mean
Date: 2010-09-19 09:35:33 +0200 (Sun, 19 Sep 2010)
New Revision: 6622

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRenderInternal.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_pp.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_pp.cpp
Log:
[postprocess] Make it a class (dynamic)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp	2010-09-19 07:35:32 UTC (rev 6621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp	2010-09-19 07:35:33 UTC (rev 6622)
@@ -517,10 +517,11 @@
 uint8_t ADM_Composer::setPostProc( uint32_t type, uint32_t strength, uint32_t swapuv)
 {
 	if(!_segments.getNbRefVideos()) return 0;
-	_pp.postProcType=type;
-	_pp.postProcStrength=strength;
-        _pp.swapuv=swapuv;
-	updatePostProc(&_pp); // DeletePostproc/ini missing ?
+    if(!_pp) return false;
+	_pp->postProcType=type;
+	_pp->postProcStrength=strength;
+    _pp->swapuv=swapuv;
+	_pp->update(); // DeletePostproc/ini missing ?
 	return 1;
 }
 /**
@@ -530,9 +531,10 @@
 uint8_t ADM_Composer::getPostProc( uint32_t *type, uint32_t *strength, uint32_t *swapuv)
 {
 	if(!_segments.getNbRefVideos()) return 0;
-	*type=_pp.postProcType;
-	*strength=_pp.postProcStrength;
-	*swapuv=_pp.swapuv;
+    if(!_pp) return false;
+	*type=_pp->postProcType;
+	*strength=_pp->postProcStrength;
+	*swapuv=_pp->swapuv;
 	return 1;
 }
 /**

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRenderInternal.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRenderInternal.cpp	2010-09-19 07:35:32 UTC (rev 6621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRenderInternal.cpp	2010-09-19 07:35:33 UTC (rev 6622)
@@ -29,9 +29,6 @@
 #endif
 
 #include "ADM_pp.h"
-extern "C" {
-#include "ADM_ffmpeg/libpostproc/postprocess.h"
-}
 // FIXME BADLY !!!
 // This should be in a context somewhere
 static uint8_t compBuffer[MAXIMUM_SIZE * MAXIMUM_SIZE * 3];
@@ -277,8 +274,7 @@
 bool ADM_Composer::decompressImage(ADMImage *out,ADMCompressedImage *in,uint32_t ref)
 {
  ADMImage *tmpImage=NULL;
- uint32_t ww,hh,left,right;
- _VIDEOS *v=_segments.getRefVideo(ref);
+ _VIDEOS  *v=_segments.getRefVideo(ref);
  uint32_t refOnly=v->decoder->dontcopy(); // can we skip one memcpy ?
 // This is only an empty Shell
     if(refOnly)
@@ -298,15 +294,10 @@
                   _scratch=new ADMImageRef(_imageBuffer->_width,_imageBuffer->_height);
                 }
                 tmpImage=_scratch;
-                ww=_imageBuffer->_width & 0xfffff0;
-                left=_imageBuffer->_width & 0xf;
-
         }
         else
         {
                 tmpImage=_imageBuffer;
-                ww=_imageBuffer->_width;
-                left=0;
        }
     //
     tmpImage->_colorspace=ADM_COLOR_YV12;
@@ -341,7 +332,7 @@
     out->copyInfo(tmpImage);
 
 
-        // Do postprocessing if any
+    // Do postprocessing if any
 	for(uint32_t z=0;z<tmpImage->_qSize;z++)
 	{
             qz=(int)tmpImage->quant[z];
@@ -353,120 +344,18 @@
 	if(sum>31) sum=31;
 	if(sum<1) sum=1;
 
-        // update average Q
+    // update average Q
 	tmpImage->_Qp=out->_Qp=(uint32_t)floor(sum);
 
 	// Pp deactivated ?
-	if(!_pp.postProcType || !_pp.postProcStrength || tmpImage->_colorspace!=ADM_COLOR_YV12)
+	if(!_pp->postProcType || !_pp->postProcStrength || tmpImage->_colorspace!=ADM_COLOR_YV12)
     {
         dupe(tmpImage,out,v);
         aprintf("EdCache: Postproc disabled\n");
 		return 1;
 	}
-
-	int type;
-	#warning FIXME should be FF_I_TYPE/B/P
-	if(tmpImage->flags & AVI_KEY_FRAME) type=1;
-		else if(tmpImage->flags & AVI_B_FRAME) type=3;
-			else type=2;
-
-        ADM_assert(tmpImage->_colorspace==ADM_COLOR_YV12);
-
-	// we do postproc !
-	// keep
-	uint8_t *oBuff[3];
-    const uint8_t *xBuff[3];
-	uint8_t *iBuff[3];
-	uint32_t	strideTab[3];
-	uint32_t	strideTab2[3];
-	aviInfo _info;
-
-        getVideoInfo(&_info);
-        tmpImage->GetReadPlanes(iBuff);
-        tmpImage->GetPitches(strideTab);
-        out->GetPitches(strideTab2);
-        out->GetWritePlanes(oBuff);
-        if(_pp.swapuv)
-        {
-                uint8_t *s=oBuff[1];
-                oBuff[1]=oBuff[2];
-                oBuff[2]=s;
-        }
-        int iStrideTab2[3],iStrideTab[3];
-        for(int i=0;i<3;i++) 
-        {
-            iStrideTab[i]=strideTab[i];
-            iStrideTab2[i]=strideTab2[i];
-            xBuff[i]=iBuff[i];
-        }
-#warning FIXME
-#warning FIXME
-#warning FIXME
-#warning FIXME
-#warning FIXME
-        pp_postprocess(
-            xBuff,
-            iStrideTab,
-            oBuff,
-            iStrideTab2,
-            ww,
-            _info.height,
-            (int8_t *)(tmpImage->quant),
-            tmpImage->_qStride,
-            _pp.ppMode,
-            _pp.ppContext,
-            type);			// img type
-        /*
-                If there is a chroma block that needs padding
-                (width not multiple of 16) while postprocessing,
-                we process up to the nearest 16 multiple and
-                just copy luma & chroma info that was left over
-        */
-        if(refOnly && left)
-        {
-                uint8_t *src,*dst;
-                uint32_t stridein,strideout,right;
-                right=_info.width-left;
-                // Luma
-                dst=YPLANE(out)+right;
-                src=tmpImage->GetReadPtr(PLANAR_Y)+right;
-                stridein=tmpImage->GetPitch(PLANAR_Y);
-                strideout=_info.width;
-                for(uint32_t y=_info.height;y>0;y--)
-                {
-                        memcpy(dst,src,left);
-                        dst+=strideout;
-                        src+=stridein;
-                }
-                // Chroma
-                left>>=1;
-                right>>=1;
-                //
-                dst=UPLANE(out)+right;
-                src=tmpImage->GetReadPtr(PLANAR_U)+right;
-                stridein=tmpImage->GetPitch(PLANAR_U);
-
-                strideout=_info.width>>1;
-                for(uint32_t y=_info.height>>1;y>0;y--)
-                {
-                        memcpy(dst,src,left);
-                        dst+=strideout;
-                        src+=stridein;
-                }
-                //
-                dst=VPLANE(out)+right;
-                src=tmpImage->GetReadPtr(PLANAR_V)+right;
-                stridein=tmpImage->GetPitch(PLANAR_V);
-                strideout=_info.width>>1;
-                for(uint32_t y=_info.height>>1;y>0;y--)
-                {
-                        memcpy(dst,src,left);
-                        dst+=strideout;
-                        src+=stridein;
-                }
-
-
-        }
+    /* Do it!*/
+    _pp->process(tmpImage,out);
     return true;
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2010-09-19 07:35:32 UTC (rev 6621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2010-09-19 07:35:33 UTC (rev 6622)
@@ -57,16 +57,7 @@
   _audioSeg = 0;
   _audioSample=0;
 
-  // Initialize a default postprocessing (dummy)
-  initPostProc(&_pp,16,16);
-  if(!prefs->get(DEFAULT_POSTPROC_TYPE,&type)) type=3;
-  if(!prefs->get(DEFAULT_POSTPROC_VALUE,&value)) value=3;
-
-  _pp.postProcType=type;
-  _pp.postProcStrength=value;
-  _pp.swapuv=0;
-  _pp.forcedQuant=0;
-  updatePostProc(&_pp);
+  _pp=NULL;
   _imageBuffer=NULL;
   _internalFlags=0;
   _currentSegment=0;
@@ -110,7 +101,8 @@
 ADM_Composer::~ADM_Composer ()
 {
 	_segments.deleteAll();
-	deletePostProc(&_pp);
+    if(_pp) delete _pp;
+    _pp=NULL;
     if(_imageBuffer) delete  _imageBuffer;
     _imageBuffer=NULL;
 
@@ -230,14 +222,14 @@
 
         if(!prefs->get(DEFAULT_POSTPROC_TYPE,&type)) type=3;
         if(!prefs->get(DEFAULT_POSTPROC_VALUE,&value)) value=3;
+        
+        if(_pp) delete _pp;
+        _pp=new ADM_PP(info.width,info.height);
+        _pp->postProcType=type;
+        _pp->postProcStrength=value;
+        _pp->forcedQuant=0;
+        _pp->update();
 
-        deletePostProc(&_pp );
-        initPostProc(&_pp,info.width,info.height);
-        _pp.postProcType=type;
-        _pp.postProcStrength=value;
-        _pp.forcedQuant=0;
-        updatePostProc(&_pp);
-
         if(_imageBuffer) delete _imageBuffer;
         _imageBuffer=new ADMImageDefault(info.width,info.height);
         _imageBuffer->_qSize= ((info.width+15)>>4)*((info.height+15)>>4);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx	2010-09-19 07:35:32 UTC (rev 6621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx	2010-09-19 07:35:33 UTC (rev 6622)
@@ -103,7 +103,7 @@
                     ADM_EditorSegment _segments;
                     uint8_t     dupe(ADMImage *src,ADMImage *dst,_VIDEOS *vid); 
                     uint32_t	_internalFlags;  // Flags :
-                    ADM_PP      _pp;             // Postprocessing settings
+                    ADM_PP      *_pp;             // Postprocessing settings
                     ADMImage	*_imageBuffer;   // Temp buffer used for decoding
                     uint64_t    _currentPts;        // Current image PTS
                     uint32_t    _currentSegment;    // Current video segment

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_pp.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_pp.h	2010-09-19 07:35:32 UTC (rev 6621)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_pp.h	2010-09-19 07:35:33 UTC (rev 6622)
@@ -11,17 +11,31 @@
 //
 #ifndef ADMPP
 #define ADMPP
-typedef struct ADM_PP
+/**
+    \class ADM_PP
+    \brief wrapper around libavcodec postprocessing
+*/
+class ADM_PP
 {
-	void    			*ppContext; // pp_context_t
+protected:
+    void    			*ppContext; // pp_context_t
 	void    			*ppMode;    // pp_mode_t
+    bool                cleanup(void);
+public:
+	
  	uint32_t			postProcType;
 	uint32_t			postProcStrength;
-        uint32_t                        swapuv;
+    bool                swapuv;
 	uint32_t			forcedQuant;
-	uint32_t			w,h;
+	uint32_t			 w,h;
 
-}ADM_PP;
+public:
+                ADM_PP(uint32_t width, uint32_t h);
+                ~ADM_PP();
+    bool        update(void);
+    bool        process(class ADMImage *src, class ADMImage *dest);
+
+};
 #define FORCE_QUANT			0x200000
 //	PostProc : 1 Horiz deblock
 //             2 Verti deblock
@@ -29,7 +43,4 @@
 // strength between 0 and 5
  
 
-void updatePostProc(ADM_PP *pp );
-void deletePostProc(ADM_PP *pp );
-void initPostProc(ADM_PP *pp,uint32_t w, uint32_t h);
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_pp.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_pp.cpp	2010-09-19 07:35:32 UTC (rev 6621)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_pp.cpp	2010-09-19 07:35:33 UTC (rev 6622)
@@ -1,16 +1,18 @@
-//
-// C++ Implementation: ADM_pp
-//
-// Description: 
-//
-//
-// Author: mean <fixounet at free.fr>, (C) 2004
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-//________________________________________________
+/**
+    \file ADM_pp
+    \brief Wrapper around libavcodec libpostproc
+    \author mean fixounet at free.fr 2004/2010
+*/
 
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
 //	PostProc : 1 Horiz deblock
 //             2 Verti deblock
 //             4 Dering
@@ -22,33 +24,59 @@
 #include "ADM_ffmpeg/libpostproc/postprocess.h"
 }
 #include "ADM_default.h"
+#include "ADM_image.h"
+#include "ADM_imageFlags.h"
 #include "ADM_pp.h"
 
 
-#define aprintf printf
+#define aprintf ADM_info
+/**
+    \fn ctor
+*/
+ADM_PP::ADM_PP(uint32_t width, uint32_t height)
+{
+    memset(this,0,sizeof(*this));
+	this->w=width;
+	this->h=height;
+    swapuv=0;
+	aprintf("Initializing postproc\n");
+}
+/**
+    \fn cleanup
+*/
+bool ADM_PP::cleanup(void)
+{
+	 aprintf("Deleting post proc\n");
+	 if(ppMode) {pp_free_mode(ppMode);ppMode=NULL;}
+	 if(ppContext) {pp_free_context(ppContext);ppContext=NULL;}
+     return true;
+}
 
-void deletePostProc(ADM_PP *pp)
+/**
+    \fn dtor
+*/
+ADM_PP::~ADM_PP()
 {
-	aprintf("Deleting post proc\n");
-	 if(pp->ppMode) {pp_free_mode(pp->ppMode);pp->ppMode=NULL;}
-	 if(pp->ppContext) {pp_free_context(pp->ppContext);pp->ppContext=NULL;}
-
+	 cleanup();
 }
-void updatePostProc(ADM_PP *pp )		    
+/**
+    \fn updatePostProc
+*/
+bool ADM_PP::update(void)
 {
 char stringMode[60];
 char stringFQ[60];
 
 	stringMode[0]=0;
-	deletePostProc(pp);
+	cleanup();
 	aprintf("updating post proc\n");
 
-	if(pp->postProcType&1) strcat(stringMode,"ha:a:128:7,");
-	if(pp->postProcType&2) strcat(stringMode,"va:a:128:7,");
-	if(pp->postProcType&4) strcat(stringMode,"dr:a,");
-	if(pp->forcedQuant)  
+	if(postProcType&1) strcat(stringMode,"ha:a:128:7,");
+	if(postProcType&2) strcat(stringMode,"va:a:128:7,");
+	if(postProcType&4) strcat(stringMode,"dr:a,");
+	if(forcedQuant)  
 		{
-			sprintf(stringFQ,"fq:%d,",pp->forcedQuant);
+			sprintf(stringFQ,"fq:%d,",forcedQuant);
 			strcat(stringMode,stringFQ);
 		}
 			
@@ -67,29 +95,133 @@
 #ifdef ADM_CPU_ALTIVEC
 		ppCaps|=PP_CPU_CAPS_ALTIVEC;
 #endif	
-			pp->ppContext=pp_get_context(pp->w, pp->h, ppCaps
-			   );		
-			pp->ppMode=pp_get_mode_by_name_and_quality(
-			stringMode, pp->postProcStrength);;
-			ADM_assert(pp->ppMode);
-			aprintf("Enabled type:%d strength:%d\n",
-				pp->postProcType,pp->postProcStrength);
+			ppContext=pp_get_context(w, h, ppCaps  );		
+			ppMode=pp_get_mode_by_name_and_quality(
+			stringMode, postProcStrength);;
+			ADM_assert(ppMode);
+			aprintf("Enabled type:%d strength:%d\n",postProcType,postProcStrength);
 		}	   
 	else    // if nothing is selected we may as well set back every thing to 0
 		{
-			pp->postProcStrength=0;
+			postProcStrength=0;
 			aprintf("Disabled\n");
 		}
+    return false;
 }
-//______________________________________________________________________________
- 
-void initPostProc(ADM_PP *pp,uint32_t w, uint32_t h)
+/**
+    \fn process
+*/
+bool        ADM_PP::process(class ADMImage *src, class ADMImage *dest)
 {
-	memset(pp,0,sizeof(ADM_PP));
-	pp->w=w;
-	pp->h=h;
-        pp->swapuv=0;
-	aprintf("Initializing postproc\n");
-	
+int type;
 
+uint32_t ww,hh;
+uint32_t border;
+
+   // return dest->duplicate(src);
+
+    border=w&(7);
+    ww=w-border;
+    hh=h&(~1);
+    
+    ADM_assert(src);
+    ADM_assert(dest);
+
+    ADM_assert(ppMode);
+    ADM_assert(ppContext);
+
+	#warning FIXME should be FF_I_TYPE/B/P
+	if(src->flags & AVI_KEY_FRAME) type=1;
+		else if(src->flags & AVI_B_FRAME) type=3;
+			else type=2;
+
+    ADM_assert(src->_colorspace==ADM_COLOR_YV12);
+
+	// we do postproc !
+	// keep
+	uint8_t       *oBuff[3];
+    const uint8_t *xBuff[3];
+	uint8_t       *iBuff[3];
+	uint32_t	  strideTab[3];
+	uint32_t	  strideTab2[3];
+    int           iStrideTab2[3],iStrideTab[3];
+
+        src->GetReadPlanes(iBuff);
+        src->GetPitches(strideTab);
+        dest->GetPitches(strideTab2);
+        dest->GetWritePlanes(oBuff);
+        if(swapuv)
+        {
+                uint8_t *s=oBuff[1];
+                oBuff[1]=oBuff[2];
+                oBuff[2]=s;
+        }
+        
+        for(int i=0;i<3;i++) 
+        {
+            iStrideTab[i]=strideTab[i];
+            iStrideTab2[i]=strideTab2[i];
+            xBuff[i]=iBuff[i];
+        }
+        pp_postprocess(
+            xBuff,
+            iStrideTab,
+            oBuff,
+            iStrideTab2,
+            ww,
+            hh,
+            (int8_t *)(src->quant),
+            src->_qStride,
+            ppMode,
+            ppContext,
+            type);			// img type
+
+  /*
+                If there is a chroma block that needs padding
+                (width not multiple of 16) while postprocessing,
+                we process up to the nearest 16 multiple and
+                just copy luma & chroma info that was left over
+        */
+        if(border)
+        {
+              
+                uint8_t *src,*dst;
+                uint32_t stridein,strideout,right;
+
+                right=ww;
+                // Luma
+                dst=oBuff[0]+right;
+                src=(uint8_t *)(xBuff[0]+right);
+              
+                for(int y=h;y>0;y--)
+                {
+                        memcpy(dst,src,border);
+                        dst+=strideTab2[0];
+                        src+=strideTab[0];
+                }
+                // Chroma
+                border>>=1;
+                right>>=1;
+                dst=oBuff[1]+right;
+                src=(uint8_t *)(xBuff[1]+right);
+                //
+                for(int y=h>>1;y>0;y--)
+                {
+                        memcpy(dst,src,border);
+                        dst+=strideTab2[1];
+                        src+=strideTab[1];
+                }
+                //
+                dst=oBuff[2]+right;
+                src=(uint8_t *)(xBuff[2]+right);
+                //
+                for(int y=h>>1;y>0;y--)
+                {
+                        memcpy(dst,src,border);
+                        dst+=strideTab2[2];
+                        src+=strideTab[2];
+                }
+        }
+        return true;
 }
+//EOF



From mean at mail.berlios.de  Sun Sep 19 09:35:35 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 19 Sep 2010 09:35:35 +0200
Subject: [Avidemux-svn-commit] r6623 - in branches/avidemux_2.6_branch_mean:
	avidemux_core/ADM_coreUtils/include avidemux_core/ADM_coreUtils/src
	avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20100919073535.C1EFA481091@sheep.berlios.de>

Author: mean
Date: 2010-09-19 09:35:35 +0200 (Sun, 19 Sep 2010)
New Revision: 6623

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_videoInfoExtractor.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsReadIndex.cpp
Log:
[H264] Add info to SPS info extractor

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_videoInfoExtractor.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_videoInfoExtractor.h	2010-09-19 07:35:33 UTC (rev 6622)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_videoInfoExtractor.h	2010-09-19 07:35:35 UTC (rev 6623)
@@ -18,7 +18,21 @@
 uint8_t extractMpeg4Info(uint8_t *data,uint32_t dataSize,uint32_t *w,uint32_t *h,uint32_t *time_inc);
 uint8_t extractH263Info(uint8_t *data,uint32_t dataSize,uint32_t *w,uint32_t *h);
 uint8_t extractVopInfo(uint8_t *data, uint32_t len,uint32_t timeincbits,uint32_t *vopType,uint32_t *modulo, uint32_t *time_inc);
-uint8_t extractSPSInfo(uint8_t *data, uint32_t len,uint32_t *wwidth,uint32_t *hheight, uint32_t *fps1000, uint32_t *darNum, uint32_t *darDen);
+
+/**
+    \struct ADM_SPSinfo
+*/
+typedef struct
+{
+    uint32_t width;
+    uint32_t height;
+    uint32_t fps1000;
+    uint32_t darNum;
+    uint32_t darDen;
+    bool     hasStructInfo;
+}ADM_SPSInfo;
+
+uint8_t extractSPSInfo(uint8_t *data, uint32_t len,ADM_SPSInfo *info);
 uint8_t extractH264FrameType(uint32_t nalSize,uint8_t *buffer,uint32_t len,uint32_t *flags);
 uint8_t extractH264FrameType_startCode(uint32_t nalSize,uint8_t *buffer,uint32_t len,uint32_t *flags);
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-19 07:35:33 UTC (rev 6622)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-19 07:35:35 UTC (rev 6623)
@@ -64,10 +64,9 @@
 /**
         \fn extractVUIInfo
 */
-static uint8_t  extractVUIInfo (getBits &bits, uint32_t * fps1000, uint32_t * darNum,
-		uint32_t * darDen)
+static uint8_t  extractVUIInfo (getBits &bits, ADM_SPSInfo *spsinfo)
 {
-  *fps1000 = *darNum = *darDen = 0;
+  
 
   if (bits.get(1))
     {
@@ -75,14 +74,14 @@
 
       if (aspect_ratio_information == 255)
 	{
-	  *darNum = bits.get( 16);
-	  *darDen = bits.get( 16);
+	  spsinfo->darNum = bits.get( 16);
+	  spsinfo->darDen = bits.get( 16);
 	}
       else if (aspect_ratio_information <
 	       sizeof (pixel_aspect) / sizeof (*pixel_aspect))
 	{
-	  *darNum = pixel_aspect[aspect_ratio_information].num;
-	  *darDen = pixel_aspect[aspect_ratio_information].den;
+	  spsinfo->darNum = pixel_aspect[aspect_ratio_information].num;
+	  spsinfo->darDen = pixel_aspect[aspect_ratio_information].den;
 	}
     }
 
@@ -114,9 +113,7 @@
       uint32_t fixed_fps = bits.get(1);
       ADM_info("Time unit =%d/%d\n",(int)timeinc_unit,(int)timeinc_resolution);
       if (timeinc_unit > 0 && timeinc_resolution > 0)
-	*fps1000 =
-	  (uint32_t) (((float) timeinc_resolution / (float) timeinc_unit) *
-		      1000);
+        spsinfo->fps1000 =  (uint32_t) (((float) timeinc_resolution / (float) timeinc_unit) *    1000);
 /* No!
       if (fixed_fps)
 	*fps1000 /= 2;
@@ -171,11 +168,9 @@
     \brief Extract info from H264 SPS
     See 7.3.2.1 of 14496-10
 */
-uint8_t extractSPSInfo (uint8_t * data, uint32_t len, uint32_t * wwidth,
-		uint32_t * hheight, uint32_t * fps1000, uint32_t * darNum, uint32_t * darDen)
+uint8_t extractSPSInfo (uint8_t * data, uint32_t len, ADM_SPSInfo *spsinfo)
 {
-  
-  *fps1000=0;
+   
   uint32_t profile, constraint, level, pic_order_cnt_type, w, h, mbh,
     frame_mbs_only;
   uint32_t frame_cropping_flag;
@@ -186,6 +181,10 @@
   uint32_t outlen;
   uint32_t id, dum;
 
+    ADM_assert(spsinfo);
+    memset(spsinfo,0,sizeof(*spsinfo));
+
+
   outlen = unescapeH264 (len, data, buf);
   getBits bits(outlen,buf);
   
@@ -255,8 +254,8 @@
   printf ("[H264] Width in mb -1  :%d\n", w);
   printf ("[H264] Height in mb -1 :%d\n", h);
 
-  *wwidth = w * 16;
-  *hheight = h * 16;
+  spsinfo->width = w * 16;
+  spsinfo->height = h * 16;
 
   if (!frame_mbs_only)
     bits.get(1);
@@ -290,23 +289,23 @@
 		cr = bits.getUEG() * cux;
 		ct = bits.getUEG() * cuy;
 		cb = bits.getUEG() * cuy;
-		*wwidth -= cl; // reduce dims based on crop values
-		*wwidth -= cr;
-		*hheight -= ct;
-		*hheight -= cb;
+		spsinfo->width -= cl; // reduce dims based on crop values
+		spsinfo->width -= cr;
+		spsinfo->height -= ct;
+		spsinfo->height -= cb;
 		printf ("[H264] Has cropping of l:%d  r:%d  t:%d  b:%d\n", cl, cr, ct, cb);
     }
 
   if (bits.get(1))
     {
-      extractVUIInfo (bits, fps1000, darNum, darDen);
-      printf ("[H264] Fps %" LU ", a.r. %" LU ",%" LU "\n", *fps1000, *darNum,
-	      *darDen);
+      extractVUIInfo (bits, spsinfo);
+      printf ("[H264] Fps %" LU ", a.r. %" LU ",%" LU "\n", spsinfo->fps1000, spsinfo->darNum,
+	      spsinfo->darDen);
     }
   else
     {
       printf ("[H264] Unknown FPS, setting 25\n");
-      *fps1000 = 25000;
+      spsinfo->fps1000 = 25000;
     }
   return 1;
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-09-19 07:35:33 UTC (rev 6622)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-09-19 07:35:35 UTC (rev 6623)
@@ -148,6 +148,7 @@
         tsPacketLinearTracker   *pkt;
         listOfTsAudioTracks     *audioTracks;
         DIA_workingBase         *ui;
+        ADM_SPSInfo             spsInfo;
         void                    updateUI(void);
         bool                    decodeSEI(uint32_t nalSize, uint8_t *org,uint32_t *recoveryLength);
         bool                    decodeVC1Seq(tsGetBits &bits,TSVideo &video);
@@ -242,6 +243,7 @@
 */
 TsIndexer::TsIndexer(listOfTsAudioTracks *trk)
 {
+    memset(&spsInfo,0,sizeof(spsInfo));
     index=NULL;
     pkt=NULL;
     audioTracks=NULL;
@@ -398,11 +400,16 @@
           // Get info
           pkt->getInfo(&info);
           pkt->read(SPS_READ_AHEAD,buffer);
-          if (extractSPSInfo(buffer, SPS_READ_AHEAD, &video.w,&video.h,&video.fps,&xA,&xR))
+          if (extractSPSInfo(buffer, SPS_READ_AHEAD,&spsInfo))
           {
               
               printf("[TsIndexer] Found video %"LU"x%"LU", fps=%"LU"\n",video.w,video.h,video.fps);
               seq_found=1;
+              video.w=spsInfo.width;
+              video.h=spsInfo.height;
+              video.fps=spsInfo.fps1000;
+              xA=spsInfo.darNum;
+              xR=spsInfo.darDen;
               writeVideo(&video,ADM_TS_H264);
               writeAudio();
               qfprintf(index,"[Data]");

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsReadIndex.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsReadIndex.cpp	2010-09-19 07:35:33 UTC (rev 6622)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsReadIndex.cpp	2010-09-19 07:35:35 UTC (rev 6623)
@@ -255,7 +255,11 @@
         return false;
     }
     printf("[tsDemux] Video pid is 0x%x %d\n",videoPid,videoPid);
-    if(!w || !h || !fps) return false;
+    if(!w || !h || !fps) 
+    {
+        ADM_error("Width, height or fps1000 missing...\n");
+        return false;
+    }
 
     interlaced=index->getAsUint32("Interlaced");
     



From mean at mail.berlios.de  Sun Sep 19 09:35:37 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 19 Sep 2010 09:35:37 +0200
Subject: [Avidemux-svn-commit] r6624 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils:
	include src
Message-ID: <20100919073537.1202B481091@sheep.berlios.de>

Author: mean
Date: 2010-09-19 09:35:36 +0200 (Sun, 19 Sep 2010)
New Revision: 6624

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_videoInfoExtractor.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
Log:
[h264/core] Exctract more vui info to be able to decode SEI

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_videoInfoExtractor.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_videoInfoExtractor.h	2010-09-19 07:35:35 UTC (rev 6623)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_videoInfoExtractor.h	2010-09-19 07:35:36 UTC (rev 6624)
@@ -30,6 +30,7 @@
     uint32_t darNum;
     uint32_t darDen;
     bool     hasStructInfo;
+    uint32_t CpbDpbToSkip;
 }ADM_SPSInfo;
 
 uint8_t extractSPSInfo(uint8_t *data, uint32_t len,ADM_SPSInfo *info);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-19 07:35:35 UTC (rev 6623)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-19 07:35:36 UTC (rev 6624)
@@ -62,12 +62,33 @@
 
 }
 /**
+    \fn hrd
+    \brief decode hdr_parameters
+*/
+static int hrd(getBits &bits)
+{
+    //ADM_warning("hdr not implemented\n");
+    int count=bits.getUEG(); 
+    int bitRateScale=bits.get(4);
+    int scale=bits.get(4);
+    for(int i=0;i<=count;i++)
+    {
+        int bitrate=bits.getUEG(); 
+        int sizeMinus1=bits.getUEG(); 
+        int cbrFlag=bits.get(1);
+    }
+    int initialRemovalDelay=bits.get(5);
+    int removalDelay=bits.get(5);
+    int outputDelay=bits.get(5);
+    int timeOffset=bits.get(5);
+    return removalDelay+outputDelay+2 ;
+}
+/**
         \fn extractVUIInfo
 */
 static uint8_t  extractVUIInfo (getBits &bits, ADM_SPSInfo *spsinfo)
 {
-  
-
+ bool str=false;
   if (bits.get(1))
     {
       unsigned int aspect_ratio_information = bits.get( 8);
@@ -119,6 +140,22 @@
 	*fps1000 /= 2;
 */
     }
+    uint32_t f=0;
+    if(bits.get(1)) // nal_hrd_param
+    {
+        f++;
+        spsinfo->CpbDpbToSkip=hrd(bits);
+    }
+    if(bits.get(1)) // vcl_hrd_param
+    {
+        f++;
+        spsinfo->CpbDpbToSkip=hrd(bits);
+    }
+    if(f) bits.get(1); // low delay flag
+    
+    
+    spsinfo->hasStructInfo=bits.get(1) | spsinfo->CpbDpbToSkip; 
+    // Has struct info in SEI, see D2.2
 
   return 1;
 }



From mean at mail.berlios.de  Sun Sep 19 09:35:38 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 19 Sep 2010 09:35:38 +0200
Subject: [Avidemux-svn-commit] r6625 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20100919073538.2BBC7481091@sheep.berlios.de>

Author: mean
Date: 2010-09-19 09:35:38 +0200 (Sun, 19 Sep 2010)
New Revision: 6625

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
Log:
[TS/index] Try to get field info when indexing h264

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-09-19 07:35:36 UTC (rev 6624)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-09-19 07:35:38 UTC (rev 6625)
@@ -150,7 +150,7 @@
         DIA_workingBase         *ui;
         ADM_SPSInfo             spsInfo;
         void                    updateUI(void);
-        bool                    decodeSEI(uint32_t nalSize, uint8_t *org,uint32_t *recoveryLength);
+        bool                    decodeSEI(uint32_t nalSize, uint8_t *org,uint32_t *recoveryLength,pictureStructure *nextpicstruct);
         bool                    decodeVC1Seq(tsGetBits &bits,TSVideo &video);
         bool                    decodeVC1Pic(tsGetBits &bits,uint32_t &frameType,uint32_t &frameStructure);
 public:
@@ -312,28 +312,69 @@
         @param recoveryLength # of recovery frame
         \return true if recovery found
 */
-bool TsIndexer::decodeSEI(uint32_t nalSize, uint8_t *org,uint32_t *recoveryLength)
+bool TsIndexer::decodeSEI(uint32_t nalSize, uint8_t *org,uint32_t *recoveryLength,
+                pictureStructure *picStruct)
 {
     
     uint8_t *payload=(uint8_t *)alloca(nalSize+16);
+    bool r=false;
     nalSize=TS_unescapeH264(nalSize,org,payload);
-    getBits bits(nalSize,payload);
-    
-    while( bits.getConsumedBits()<(nalSize-4)*8)
+    uint8_t *tail=payload+nalSize;
+    *picStruct=pictureFrame; // frame
+    while( payload<tail-2)
     {
-        uint32_t sei_type=bits.get(8);
-        uint32_t sei_size=bits.get(8);
-                if(sei_size==0xff) sei_size=0xff00+bits.get(8);; // should be enough
+                uint32_t sei_type=0,sei_size=0;
+                while(payload[0]==0xff) {sei_type+=0xff;payload++;};
+                sei_type+=payload[0];payload++;
+                while(payload[0]==0xff) {sei_size+=0xff;payload++;};
+                sei_size+=payload[0];payload++;
                 zprintf("  [SEI] Type : 0x%x size:%d\n",sei_type,sei_size);
-                if(sei_type==6) // Recovery point
+                switch(sei_type) // Recovery point
                 {
-                        *recoveryLength=bits.getUEG();
-                        zprintf("[SEI] Recovery :%"LU"\n",*recoveryLength);
-                        return true;
+
+                       case 1:
+                            {
+                                if(spsInfo.hasStructInfo)
+                                {
+                                    getBits bits(sei_size,payload);
+                                    payload+=sei_size;
+                                    if(spsInfo.CpbDpbToSkip)
+                                    {
+                                            bits.get(spsInfo.CpbDpbToSkip);
+                                    }
+                                    //printf("Consumed: %d,\n",bits.getConsumedBits());
+                                    int pic=bits.get(4);
+                                    printf("Pic struct: %d,\n",pic);
+                                    switch(pic) 
+                                    {
+                                        case 0: *picStruct=pictureFrame; break;
+                                        case 3:
+                                        case 4: *picStruct=pictureFrame;
+                                        case 1: *picStruct=pictureTopField;break;
+                                        case 2: *picStruct=pictureBottomField;break;
+                                        default:*picStruct=pictureFrame;
+                                    }
+                                    
+                                }else
+                                        payload+=sei_size;
+                            }
+                            break;
+
+                       case 6:
+                        {
+                            getBits bits(sei_size,payload);
+                            payload+=sei_size;
+                            *recoveryLength=bits.getUEG();
+                            zprintf("[SEI] Recovery :%"LU"\n",*recoveryLength);
+                            r=true;
+                        }
+                        default:
+                            payload+=sei_size;
+                            break;
                 }
-                bits.skip(sei_size*8);
     }
-    return false;
+    if(payload!=tail) ADM_warning("Bytes left in SEI %d\n",(int)(tail-payload));
+    return r;
 }
 
 /**
@@ -363,7 +404,7 @@
 
     memset(&data,0,sizeof(data));
     data.picStructure=pictureFrame;
-
+    pictureStructure nextPicStruct=pictureFrame;
     string indexName=string(file);
     indexName=indexName+string(".idx2");
     index=qfopen(indexName,(const char*)"wt");
@@ -418,10 +459,12 @@
               break;              
           };
       }
+      
         if(!seq_found) goto the_end;
     //******************
     // 2 Index
     //******************
+
       while(1)
       {
         int startCode=pkt->findStartCode();
@@ -464,7 +507,7 @@
                             if(!pkt->stillOk()) goto resume;
                             zprintf("[SEI] Nal size :%d\n",SEI_nal.payloadSize);
                             if(SEI_nal.payloadSize>=7)
-                                decodeSEI(SEI_nal.payloadSize-4,SEI_nal.payload,&recoveryCount);
+                                decodeSEI(SEI_nal.payloadSize-4,SEI_nal.payload,&recoveryCount,&nextPicStruct);
                             else printf("[SEI] Too short size+4=%d\n",*(SEI_nal.payload));
                         
                             startCode=pkt->readi8();
@@ -473,6 +516,8 @@
                             break;
                   case NAL_AU_DELIMITER:
                           pic_started = false;
+                          nextPicStruct=pictureFrame;  
+                          printf("AU DELIMITER\n");
                           break;
 
                   case NAL_SPS:
@@ -491,7 +536,7 @@
                   case NAL_NON_IDR:
                     {
 #define NON_IDR_PRE_READ 8
-                      zprintf("Pic start last ref:%d cur ref:%d nb=%d\n",lastRefIdc,ref,data.nbPics);
+                      printf("Pic start last ref:%d cur ref:%d nb=%d\n",lastRefIdc,ref,data.nbPics);
                       lastRefIdc=ref;
                         
                       uint8_t bufr[NON_IDR_PRE_READ+4];
@@ -523,6 +568,7 @@
                       if(startCode==NAL_IDR) data.frameType=4; // IDR
                       zprintf("[>>>>>>>>] Pic Type %"LU" Recovery %"LU"\n",data.frameType,recoveryCount);
                       if(data.frameType==1 && !recoveryCount) data.frameType=4; //I  + Recovery=0 = IDR!
+                      data.picStructure=nextPicStruct;
                       if(data.state==idx_startAtGopOrSeq) 
                       {
                               currentFrameType=data.frameType;;



From mean at mail.berlios.de  Sun Sep 19 09:35:39 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 19 Sep 2010 09:35:39 +0200
Subject: [Avidemux-svn-commit] r6626 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4
Message-ID: <20100919073539.5D16A481091@sheep.berlios.de>

Author: mean
Date: 2010-09-19 09:35:39 +0200 (Sun, 19 Sep 2010)
New Revision: 6626

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Indexer.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Leaf.h
Log:
[MP4/Mov demuxer] Decode edts, just for information, we dont use it

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4.cpp	2010-09-19 07:35:38 UTC (rev 6625)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4.cpp	2010-09-19 07:35:39 UTC (rev 6626)
@@ -63,7 +63,7 @@
 #include "fourcc.h"
 #include "ADM_mp4.h"
 
-//#include "ADM_codecs/ADM_codec.h"
+#include "ADM_vidMisc.h"
 
 #include "ADM_videoInfoExtractor.h"
 
@@ -396,7 +396,13 @@
             audioStream[audio]=ADM_audioCreateStream(&(_tracks[1+audio]._rdWav), audioAccess[audio]);
         }
         fseeko(_fd,0,SEEK_SET);
-        printf("3gp/mov file successfully read..\n");
+        ADM_info("3gp/mov file successfully read..\n");
+        int nb=(int)_tracks[0].nbIndex;
+        ADM_info("Nb images      : %d\n",nb);
+        ADM_info("Movie duration : %s\n",ADM_us2plain(_movieDuration*1000LL));
+        ADM_info("Last video PTS : %s\n",ADM_us2plain(_tracks[0].index[nb-1].pts));
+        ADM_info("Last video DTS : %s\n",ADM_us2plain(_tracks[0].index[nb-1].dts));
+
         return 1;
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4.h	2010-09-19 07:35:38 UTC (rev 6625)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4.h	2010-09-19 07:35:39 UTC (rev 6626)
@@ -126,6 +126,7 @@
           uint8_t                       parseTrack(void *ztom);
           uint8_t                       decodeVideoAtom(void *ztom);
           uint8_t                       parseMdia(void *ztom,uint32_t *trackType,uint32_t w, uint32_t h);
+          uint8_t                       parseEdts(void *ztom);
           uint8_t                       parseStbl(void *ztom,uint32_t trackType,uint32_t w,uint32_t h,uint32_t trackScale);
           uint8_t                       decodeEsds(void *ztom,uint32_t trackType);
           uint8_t                       updateCtts(MPsampleinfo *info );

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp	2010-09-19 07:35:38 UTC (rev 6625)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp	2010-09-19 07:35:39 UTC (rev 6626)
@@ -188,8 +188,14 @@
             parseMdia(&son,&trackType,w,h);
             break;
         }
+        case ADM_MP4_EDTS:
+        {
+            ADM_info("EDTS atom found\n");
+            parseEdts(&son);
+            break;
+        }
        default:
-          adm_printf(ADM_PRINT_DEBUG,"Unprocessed atom\n");
+          ADM_info("Unprocessed atom :%s\n",fourCC::tostringBE(son.getFCC()));
      }
      son.skipAtom();
   }
@@ -322,6 +328,54 @@
 }
 
 /**
+        \fn parseEdts
+        \brief parse sample table. this is the most important function.
+*/
+uint8_t       MP4Header::parseEdts(void *ztom)
+{
+  adm_atom *tom=(adm_atom *)ztom;
+  ADMAtoms id;
+  uint32_t container;
+
+  ADM_info("Parsing Edts>>\n");
+  while(!tom->isDone())
+  {
+     adm_atom son(tom);
+     if(!ADM_mp4SearchAtomName(son.getFCC(), &id,&container))
+     {
+       adm_printf(ADM_PRINT_DEBUG,"[EDTS]Found atom %s unknown\n",fourCC::tostringBE(son.getFCC()));
+       son.skipAtom();
+       continue;
+     }
+    switch(id)
+    {
+       case ADM_MP4_ELST:
+       {
+              ADM_info("ELST atom found\n");
+              son.skipBytes(4);
+              uint32_t nb=son.read32();
+              ADM_info("Found %"LU" entries in list:\n",nb);
+              for(int i=0;i<nb;i++)
+                {
+                    uint32_t editDuration=son.read32();
+                    uint32_t mediaTime=son.read32();
+                    uint32_t playbackSpeed=son.read32();
+                    ADM_info("Duration : %"LU", mediaTime:%"LU" speed=%"LU"\n",editDuration,mediaTime,playbackSpeed);
+                }
+              son.skipAtom();
+              break;
+        
+       }
+       break;
+        default:
+            adm_printf(ADM_PRINT_DEBUG,"** atom  NOT HANDLED [%s] \n",fourCC::tostringBE(son.getFCC()));
+     }
+   }
+   
+   tom->skipAtom();
+   return true;
+}
+/**
         \fn parseStbl
         \brief parse sample table. this is the most important function.
 */
@@ -576,7 +630,8 @@
                                 //
 #define commonPart(x)             _videostream.fccHandler=_video_bih.biCompression=fourCC::get((uint8_t *)#x);
 
-
+                                 lw=(lw+7)&(~7);
+                                 lh=(lh+7)&(~7);
                                  _video_bih.biWidth=_mainaviheader.dwWidth=lw ;
                                   _video_bih.biHeight=_mainaviheader.dwHeight=lh;
                                   _video_bih.biCompression=_videostream.fccHandler;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Indexer.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Indexer.cpp	2010-09-19 07:35:38 UTC (rev 6625)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Indexer.cpp	2010-09-19 07:35:39 UTC (rev 6626)
@@ -47,7 +47,7 @@
 
 uint32_t i,j,cur;
 
-        printf("Build Track index\n");
+    ADM_info("Build Track index\n");
 	*outNbChunk=0;
 	aprintf("+_+_+_+_+_+\n");
 	aprintf("co : %lu sz: %lu sc: %lu co[0] %"LLU"\n",info->nbCo,info->nbSz,info->nbSc,info->Co[0]);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Leaf.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Leaf.h	2010-09-19 07:35:38 UTC (rev 6625)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Leaf.h	2010-09-19 07:35:39 UTC (rev 6626)
@@ -1,5 +1,5 @@
 /*
-http://developer.apple.com/documentation/QuickTime/QTFF/QTFFChap2/chapter_3_section_5.html#//apple_ref/doc/uid/DontLinkBookID_69-CH204-BBCJEIIA
+http://developer.apple.com/library/mac/#documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-33299
 */
 
 #if !defined(ADM_MPEGLEAF_H) || defined(ADMMP4_TAB_LEAF)
@@ -39,10 +39,11 @@
 MKMP4LEAF('co64',STCO64,0),
 MKMP4LEAF('stsh',STSH,0),
 MKMP4LEAF('stss',STSS,0),
+/* Edit list */
+MKMP4LEAF('elst',ELST,0), // http://wiki.multimedia.cx/index.php?title=QuickTime_container#elst
+MKMP4LEAF('edts',EDTS,1),
 
 
-
-
 MKMP4LEAF('ctts',CTTS,0),
 
 /* Data */



From mean at mail.berlios.de  Sun Sep 19 09:35:40 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 19 Sep 2010 09:35:40 +0200
Subject: [Avidemux-svn-commit] r6627 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js
Message-ID: <20100919073540.AB858481091@sheep.berlios.de>

Author: mean
Date: 2010-09-19 09:35:40 +0200 (Sun, 19 Sep 2010)
New Revision: 6627

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsEditor.cpp
Log:
[js] Print also field info

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsEditor.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsEditor.cpp	2010-09-19 07:35:39 UTC (rev 6626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsEditor.cpp	2010-09-19 07:35:40 UTC (rev 6627)
@@ -30,8 +30,12 @@
     if(true==video_body->getVideoPtsDts(framenumber, &flags,&pts,&dts))
     {
         int64_t delta=0;
+        char field='F';
+        if(flags & AVI_BOTTOM_FIELD) field='B';
+        if(flags & AVI_TOP_FIELD) field='T';
         if(pts!=ADM_NO_PTS && dts!=ADM_NO_PTS) delta=(int64_t)pts-(int64_t)dts;
-        jsLog("Frame %"LU" : Flags 0x%"LX" pts=%"LLD" dts=%"LLD" delta=%"LLD" ms\n",framenumber,flags,pts,dts,delta/1000LL);
+        jsLog("Frame %"LU" PIC:%c : Flags 0x%"LX" pts=%"LLD" dts=%"LLD" delta=%"LLD" ms\n",
+                framenumber,field,flags,pts,dts,delta/1000LL);
     }else
     {
         jsLog("Cannot get info for frame %"LU,framenumber);



From mean at mail.berlios.de  Sun Sep 19 16:27:35 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 19 Sep 2010 16:27:35 +0200
Subject: [Avidemux-svn-commit] r6628 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi
Message-ID: <20100919142735.12693481094@sheep.berlios.de>

Author: mean
Date: 2010-09-19 16:27:34 +0200 (Sun, 19 Sep 2010)
New Revision: 6628

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.h
Log:
[avi/muxer] Allow skipping audio frames, that can happen if the audio frames have a long duration compared to video frame

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp	2010-09-19 07:35:40 UTC (rev 6627)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp	2010-09-19 14:27:34 UTC (rev 6628)
@@ -22,9 +22,9 @@
 #include "muxerAvi.h"
 
 
-#define AUDIO_BUFFER_SIZE 48000*6*sizeof(float)
 
-#if 1
+
+#if 0
 #define aprintf(...) {}
 #else
 #define aprintf printf
@@ -42,7 +42,7 @@
 */
 muxerAvi::muxerAvi()
 {
-    audioBuffer=NULL;
+    audioPackets=NULL;
     videoBuffer=NULL;
     clocks=NULL;
 };
@@ -99,34 +99,52 @@
 // Now send audio until they all have DTS > lastVideoDts+increment
             for(int audioIndex=0;audioIndex<nbAStreams;audioIndex++)
             {
-                uint32_t audioSize,nbSample;
-                uint64_t audioDts;
                 ADM_audioStream*a=aStreams[audioIndex];
                 uint32_t fq=a->getInfo()->frequency;
                 int nb=0;
                 audioClock *clk=clocks[audioIndex];
-
-                while(a->getPacket(audioBuffer,&audioSize, AUDIO_BUFFER_SIZE,&nbSample,&audioDts))
+                aviAudioPacket *aPacket=audioPackets+audioIndex;
+                if(true==aPacket->eos) return true;
+                while(1)
                 {
-                    if(audioDts!=ADM_NO_PTS) audioDts+=audioDelay;
-                    aprintf("[Audio] Packet size %"LU" sample:%"LU" dts:%"LLU" target :%"LLU"\n",audioSize,nbSample,audioDts,targetDts);
-                    if(audioDts!=ADM_NO_PTS)
-                        if( abs(audioDts-clk->getTimeUs())>32000)
+                    if(false==aPacket->present)
+                    {
+                        if(!a->getPacket(aPacket->buffer,
+                                         &(aPacket->sizeInBytes),
+                                         AUDIO_BUFFER_SIZE,
+                                         &(aPacket->nbSamples),
+                                         &(aPacket->dts)))
                         {
-                            ADM_warning("[AviMuxer] Audio skew!\n");
-                            clk->setTimeUs(audioDts);
+                                ADM_warning("Cannot get audio packet for stream %d\n",audioIndex);
+                                aPacket->eos=true;
+                                break;
                         }
-                    nb=writter.saveAudioFrame(audioIndex,audioSize,audioBuffer) ;
-                    encoding->pushAudioFrame(audioSize);
-                    clk->advanceBySample(nbSample);
+                            if(aPacket->dts!=ADM_NO_PTS) 
+                            {
+                                aPacket->dts+=audioDelay;
+                            }
+                            aprintf("[Audio] Packet size %"LU" sample:%"LU" dts:%"LLU" target :%"LLU"\n",
+                                            aPacket->sizeInBytes,aPacket->nbSamples,aPacket->dts,targetDts);
+                            if(aPacket->dts!=ADM_NO_PTS)
+                                if( abs(aPacket->dts-clk->getTimeUs())>32000)
+                                {
+                                    ADM_warning("[AviMuxer] Audio skew!\n");
+                                    clk->setTimeUs(aPacket->dts);
+#warning FIXME add padding
+                                }
+                            aPacket->present=true;
+                    }
+                    // We now have a packet stored
+                    if(aPacket->dts!=ADM_NO_PTS)
+                        if(aPacket->dts>targetDts) break; // this one is in the future
+                    nb=writter.saveAudioFrame(audioIndex,aPacket->sizeInBytes,aPacket->buffer) ;
+                    encoding->pushAudioFrame(aPacket->sizeInBytes);
+                    clk->advanceBySample(aPacket->nbSamples);
+                    aPacket->present=false;
                     //printf("%u vs %u\n",audioDts/1000,(lastVideoDts+videoIncrement)/1000);
-                    if(audioDts!=ADM_NO_PTS)
-                    {
-                        if(audioDts>targetDts) break;
-                    }
                 }
-                if(!nb) aprintf("[AviMuxer] No audio for video frame %lu\n",targetDts);
             }
+
             return true;
 }
 /**
@@ -143,21 +161,24 @@
     int ret;
     int written=0;
    
-
-    audioBuffer=new uint8_t[AUDIO_BUFFER_SIZE];
+    audioPackets=new aviAudioPacket[nbAStreams];
     videoBuffer=new uint8_t[bufSize];
 
     ADM_info("[AviMuxer]avg fps=%u\n",vStream->getAvgFps1000());
     ADMBitstream in(bufSize);
     in.data=videoBuffer;
     uint64_t aviTime=0;
-    if(false==vStream->getPacket(&in)) goto abt;
+    
     if(in.dts==ADM_NO_PTS) in.dts=0;
     lastVideoDts=in.dts;
 
     initUI("Saving Avi");
     encoding->setContainer("AVI/OpenDML");
-
+    if(false==vStream->getPacket(&in)) 
+    {
+        ADM_error("Cannot get first video frame\n");
+        goto abt;
+    }
     while(1)
     {
             
@@ -198,8 +219,8 @@
     writter.setEnd();
     delete [] videoBuffer;
     videoBuffer=NULL;
-    delete [] audioBuffer;
-    audioBuffer=NULL;
+    delete [] audioPackets;
+    audioPackets=NULL;
     ADM_info("[AviMuxer] Wrote %d frames, nb audio streams %d\n",written,nbAStreams);
     return result;
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.h	2010-09-19 07:35:40 UTC (rev 6627)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.h	2010-09-19 14:27:34 UTC (rev 6628)
@@ -22,9 +22,23 @@
 #include "ADM_audioClock.h"
 #include "avi_muxer.h"
 
-
+#define AUDIO_BUFFER_SIZE 48000*6*sizeof(float)
 extern avi_muxer muxerConfig;
 
+class aviAudioPacket
+{
+    public:
+            uint8_t     *buffer;
+            uint64_t    dts;
+            uint32_t    nbSamples;
+            uint32_t    sizeInBytes;
+            bool        present;
+            bool        eos;
+
+            aviAudioPacket() {buffer=new uint8_t[AUDIO_BUFFER_SIZE];eos=false;present=false;}
+            ~aviAudioPacket() {delete [] buffer;buffer=NULL;}
+
+};
 /**
     \class muxerAvi
 */
@@ -35,10 +49,10 @@
         bool    setupVideo(ADM_videoStream *video);
         bool    fillAudio(uint64_t targetDts);
         aviWrite  writter;
-        uint8_t   *audioBuffer;
-        uint8_t   *videoBuffer;
-        audioClock **clocks;
-        uint64_t   audioDelay;
+        aviAudioPacket  *audioPackets;
+        uint8_t         *videoBuffer;
+        audioClock      **clocks;
+        uint64_t        audioDelay;
 public:
                 muxerAvi();
         virtual ~muxerAvi();



From mean at mail.berlios.de  Sun Sep 19 16:28:21 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 19 Sep 2010 16:28:21 +0200
Subject: [Avidemux-svn-commit] r6629 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi
Message-ID: <20100919142821.D040D481094@sheep.berlios.de>

Author: mean
Date: 2010-09-19 16:28:21 +0200 (Sun, 19 Sep 2010)
New Revision: 6629

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp
Log:
[avi/muxer] silence

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp	2010-09-19 14:27:34 UTC (rev 6628)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp	2010-09-19 14:28:21 UTC (rev 6629)
@@ -24,7 +24,7 @@
 
 
 
-#if 0
+#if 1
 #define aprintf(...) {}
 #else
 #define aprintf printf



From gruntster at mail.berlios.de  Mon Sep 20 01:32:24 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 20 Sep 2010 01:32:24 +0200
Subject: [Avidemux-svn-commit] r6630 - in
	branches/avidemux_2.5_branch_gruntster:
	avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui
	avidemux/ADM_userInterfaces/ADM_commonUI
	avidemux/ADM_userInterfaces/ADM_render cmake
Message-ID: <20100919233224.F0BCB481094@sheep.berlios.de>

Author: gruntster
Date: 2010-09-20 01:32:24 +0200 (Mon, 20 Sep 2010)
New Revision: 6630

Added:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.h
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.h
   branches/avidemux_2.5_branch_gruntster/cmake/admCheckMiscLibs.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/admConfigSummary.cmake
Log:
[render] OpenGL renderer for Qt

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2010-09-19 14:28:21 UTC (rev 6629)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2010-09-19 23:32:24 UTC (rev 6630)
@@ -230,13 +230,14 @@
 
 #if defined(__WIN32)
 	xinfo->display=videoWindow->winId();
+	xinfo->window = (int)videoWindow->winId();
 #elif defined(__APPLE__)
 	#if defined(ADM_CPU_X86_64)
 		xinfo->display = (void*)videoWindow->winId();
-		xinfo->window = 0;
+		xinfo->window = (int)videoWindow->winId();
 	#else
 		xinfo->display = HIViewGetWindow(HIViewRef(widget->winId()));
-		xinfo->window = 0;
+		xinfo->window = (int)videoWindow->winId();
 	#endif
 #else
     const QX11Info &info=videoWindow->x11Info();

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp	2010-09-19 14:28:21 UTC (rev 6629)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp	2010-09-19 23:32:24 UTC (rev 6630)
@@ -14,13 +14,11 @@
 
 #include "config.h"
 #include "ADM_default.h"
-# include "prefs.h"
+#include "prefs.h"
 
 #include "ADM_audiodevice/audio_out.h"
-#include "ADM_assert.h"
+#include "DIA_uiTypes.h"
 #include "ADM_userInterfaces/ADM_render/GUI_render.h"
-
-
 #include "DIA_factory.h"
 
 #ifdef __WIN32
@@ -229,6 +227,9 @@
         diaElemToggle   togTagMp3(&alternate_mp3_tag,QT_TR_NOOP("_Use alternative tag for MP3 in .mp4"));
         diaMenuEntry videoMode[]={
                              {RENDER_GTK, getNativeRendererDesc(), NULL}
+#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
+							 ,{RENDER_QT_OPENGL, QT_TR_NOOP("Qt (OpenGL)"), NULL}
+#endif
 #ifdef USE_XV
                              ,{RENDER_XV,   QT_TR_NOOP("XVideo (best)"),NULL}
 #endif
@@ -240,11 +241,10 @@
 							 ,{RENDER_SDL,      QT_TR_NOOP("SDL (good)"),NULL}
 #endif
 #endif
-        };        
+        };
+
         diaElemMenu menuVideoMode(&render,QT_TR_NOOP("Video _display:"), sizeof(videoMode)/sizeof(diaMenuEntry),videoMode,"");
         
-        
-        
         diaMenuEntry msgEntries[]={
                              {0,       QT_TR_NOOP("No alerts"),NULL}
                              ,{1,      QT_TR_NOOP("Display only error alerts"),NULL}

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/CMakeLists.txt	2010-09-19 14:28:21 UTC (rev 6629)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/CMakeLists.txt	2010-09-19 23:32:24 UTC (rev 6630)
@@ -33,12 +33,23 @@
 ENDIF (ADM_UI_GTK)
 
 IF (ADM_UI_QT4)
+	IF (USE_OPENGL)
+		SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS} GUI_qtGlRender.cpp)
+	ENDIF (USE_OPENGL)
+
 	IF (APPLE AND NOT ADM_CPU_X86_64)
-		ADD_ADM_SHARED_LIB_QT4_TARGET(${ADM_LIB} ${${ADM_LIB}_SRCS} GUI_sdlRenderHelper.m)
-	ELSE (APPLE AND NOT ADM_CPU_X86_64)
-		ADD_ADM_SHARED_LIB_QT4_TARGET(${ADM_LIB} ${${ADM_LIB}_SRCS})
+		SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS} GUI_sdlRenderHelper.m)
 	ENDIF (APPLE AND NOT ADM_CPU_X86_64)
 
+	ADD_ADM_SHARED_LIB_QT4_TARGET(${ADM_LIB} ${${ADM_LIB}_SRCS})
+
+	IF (USE_OPENGL)
+		ADD_SOURCE_CFLAGS(GUI_render.cpp " -I${QT_HEADERS_DIR}")
+		ADD_SOURCE_CFLAGS(GUI_qtGlRender.cpp " -I${QT_HEADERS_DIR} -I{OPENGL_INCLUDE_DIR}")
+
+		TARGET_LINK_LIBRARIES(${ADM_LIB}_qt4 ${OPENGL_LIBRARIES} ${QT_QTOPENGL_LIBRARY})
+	ENDIF (USE_OPENGL)
+
 	IF (USE_SDL)
 		TARGET_LINK_LIBRARIES(${ADM_LIB}_qt4 ${SDL_LIBRARY})
 	ENDIF (USE_SDL)
@@ -47,6 +58,7 @@
 		TARGET_LINK_LIBRARIES(${ADM_LIB}_qt4 ${XVIDEO_LIBRARY_DIR} X11 Xext)
 	ENDIF (USE_XV)
 
+	TARGET_LINK_LIBRARIES(${ADM_LIB}_qt4 ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY})
 	INSTALL(TARGETS ${ADM_LIB}_qt4 RUNTIME DESTINATION ${BIN_DIR}  LIBRARY DESTINATION lib${LIB_SUFFIX}  ARCHIVE DESTINATION lib${LIB_SUFFIX})
 ENDIF (ADM_UI_QT4)
 

Added: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.cpp	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.cpp	2010-09-19 23:32:24 UTC (rev 6630)
@@ -0,0 +1,232 @@
+/***************************************************************************
+    copyright            : (C) 2010 by gruntster
+***************************************************************************/
+
+/***************************************************************************
+*                                                                         *
+*   This program is free software; you can redistribute it and/or modify  *
+*   it under the terms of the GNU General Public License as published by  *
+*   the Free Software Foundation; either version 2 of the License, or     *
+*   (at your option) any later version.                                   *
+*                                                                         *
+***************************************************************************///
+#define GL_GLEXT_PROTOTYPES
+
+#include <QtGui/QPainter>
+#include <GL/gl.h>
+#include <GL/glext.h>
+
+#include "GUI_qtGlRender.h"
+
+static const char *yuvToRgb =
+	"#extension GL_ARB_texture_rectangle: enable\n"
+	"uniform sampler2DRect texY, texU, texV;\n"
+	"uniform float height;\n"
+
+	"void main(void) {\n"
+	"  float nx = gl_TexCoord[0].x;\n"
+	"  float ny = height - gl_TexCoord[0].y;\n"
+	"  float y = texture2DRect(texY, vec2(nx, ny)).r;\n"
+	"  float u = texture2DRect(texU, vec2(nx / 2.0, ny / 2.0)).r;\n"
+	"  float v = texture2DRect(texV, vec2(nx / 2.0, ny / 2.0)).r;\n"
+
+	"  y = 1.1643 * (y - 0.0625);\n"
+	"  u = u - 0.5;\n"
+	"  v = v - 0.5;\n"
+
+	"  float r = y + 1.5958 * v;\n"
+	"  float g = y - 0.39173 * u - 0.81290 * v;\n"
+	"  float b = y + 2.017 * u;\n"
+
+	"  gl_FragColor = vec4(r, g, b, 1.0);\n"
+	"}\n";
+
+
+QtGlAccelWidget::QtGlAccelWidget(QWidget *parent, int widgetWidth, int widgetHeight) : QGLWidget(parent)
+{
+	memset(textureWidths, 0, sizeof(textureWidths));
+	memset(textureHeights, 0, sizeof(textureHeights));
+	memset(textureOffsets, 0, sizeof(textureOffsets));
+
+	imageWidth = 0;
+	imageHeight = 0;
+	firstRun = true;
+	glProgram = NULL;
+
+	resize(widgetWidth, widgetHeight);
+}
+
+void QtGlAccelWidget::setBuffer(uint8_t *buffer, int imageWidth, int imageHeight)
+{
+	this->imageWidth = imageWidth;
+	this->imageHeight = imageHeight;
+
+	textureWidths[0] = imageWidth;
+	textureHeights[0] = imageHeight;
+	textureOffsets[0] = buffer;
+
+	textureWidths[1] = imageWidth / 2;
+	textureHeights[1] = imageHeight / 2;
+	textureOffsets[1] = buffer + (imageWidth * imageHeight * 5 / 4);
+	
+	textureWidths[2] = imageWidth / 2;
+	textureHeights[2] = imageHeight / 2;
+	textureOffsets[2] = buffer + (imageWidth * imageHeight);
+}
+
+void QtGlAccelWidget::initializeGL()
+{
+	int success = 1;
+
+#ifndef QT_OPENGL_ES
+	glActiveTexture = (_glActiveTexture)this->context()->getProcAddress(QLatin1String("glActiveTexture"));
+
+	if (!glActiveTexture)
+	{
+		success = 0;
+		printf("[GL Render] Active Texture function not found!\n");
+	}
+#endif
+
+	printf("[GL Render] OpenGL Vendor: %s\n", glGetString(GL_VENDOR));
+	printf("[GL Render] OpenGL Renderer: %s\n", glGetString(GL_RENDERER));
+	printf("[GL Render] OpenGL Version: %s\n", glGetString(GL_VERSION));
+	printf("[GL Render] OpenGL Extensions: %s\n", glGetString(GL_EXTENSIONS));
+
+	glProgram = new QGLShaderProgram(this);
+
+	if (success && !glProgram->addShaderFromSourceCode(QGLShader::Fragment, yuvToRgb))
+	{
+		success = 0;
+		printf("[GL Render] Fragment log: %s\n", glProgram->log().toUtf8().constData());
+	}
+
+	if (success && !glProgram->link())
+	{
+		success = 0;
+		printf("[GL Render] Link log: %s\n", glProgram->log().toUtf8().constData());
+	}
+
+	if (success && !glProgram->bind())
+	{
+		success = 0;
+		printf("[GL Render] Binding FAILED\n");
+	}
+
+	glProgram->setUniformValue("texY", 0);
+	glProgram->setUniformValue("texU", 1);
+	glProgram->setUniformValue("texV", 2);
+}
+
+void QtGlAccelWidget::paintGL()
+{
+	if (!textureOffsets[0])
+	{
+		printf("[Render] Buffer not set\n");
+		return;
+	}
+
+	if (firstRun)
+	{
+		glViewport(0, 0, width(), height());
+		glMatrixMode(GL_PROJECTION);
+		glLoadIdentity();
+		glOrtho(0, width(), 0, height(), -1, 1);
+		glProgram->setUniformValue("height", (float)imageHeight);
+	}
+
+	// U
+	glActiveTexture(GL_TEXTURE1);
+	glBindTexture(GL_TEXTURE_RECTANGLE_NV, 1);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
+	glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
+
+	if (firstRun)
+		glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, textureWidths[1], textureHeights[1], 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, textureOffsets[1]);
+	else
+		glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, textureWidths[1], textureHeights[1], GL_LUMINANCE, GL_UNSIGNED_BYTE, textureOffsets[1]);
+
+	// V
+	glActiveTexture(GL_TEXTURE2);
+	glBindTexture(GL_TEXTURE_RECTANGLE_NV, 2);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
+	glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
+
+	if (firstRun)
+		glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, textureWidths[2], textureHeights[2], 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, textureOffsets[2]);
+	else
+		glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, textureWidths[2], textureHeights[2], GL_LUMINANCE, GL_UNSIGNED_BYTE, textureOffsets[2]);
+
+	// Y
+	glActiveTexture(GL_TEXTURE0);
+	glBindTexture(GL_TEXTURE_RECTANGLE_NV, 3);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
+	glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
+
+	if (firstRun)
+	{
+		glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, textureWidths[0], textureHeights[0], 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, textureOffsets[0]);
+		firstRun = false;
+	}
+	else
+		glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, textureWidths[0], textureHeights[0], GL_LUMINANCE, GL_UNSIGNED_BYTE, textureOffsets[0]);
+
+	glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+	glBegin(GL_QUADS);
+	glTexCoord2i(0, 0);
+	glVertex2i(0, 0);
+	glTexCoord2i(imageWidth, 0);
+	glVertex2i(width(), 0);
+	glTexCoord2i(imageWidth, imageHeight);
+	glVertex2i(width(), height());
+	glTexCoord2i(0, imageHeight);
+	glVertex2i(0, height());
+	glEnd();
+}
+
+QtGlAccelRender::QtGlAccelRender(void)
+{
+	glWidget = NULL;
+}
+
+uint8_t QtGlAccelRender::end(void)
+{
+	printf("[GL Render] Renderer closed\n");
+
+	if (glWidget)
+		delete glWidget;
+}
+
+uint8_t QtGlAccelRender::init(GUI_WindowInfo *window, uint32_t w, uint32_t h)
+{
+	printf("[GL Render] Initialising renderer\n");
+
+	QWidget *widget = QWidget::find((WId)window->window);
+
+	glWidget = new QtGlAccelWidget(widget, w, h);
+	glWidget->show();
+
+	return QGLFormat::hasOpenGL() && QGLShaderProgram::hasOpenGLShaderPrograms();
+}
+
+uint8_t QtGlAccelRender::display(uint8_t *ptr, uint32_t w, uint32_t h, renderZoom zoom)
+{
+	glWidget->setBuffer(ptr, w, h);
+	glWidget->repaint();
+
+	return 1;
+}
+
+uint8_t QtGlAccelRender::hasHwZoom(void)
+{
+	return 1;
+}
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.h	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.h	2010-09-19 23:32:24 UTC (rev 6630)
@@ -0,0 +1,61 @@
+/***************************************************************************
+    copyright            : (C) 2010 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef GUI_QTGLRENDER_H
+#define GUI_QTGLRENDER_H
+
+#include <QtOpenGL/QGLWidget>
+#include <QtOpenGL/QGLShader>
+
+#include "GUI_render.h"
+#include "GUI_accelRender.h"
+#include "ADM_colorspace.h"
+
+class QtGlAccelWidget : public QGLWidget
+{
+private:
+	int imageWidth, imageHeight;
+	bool firstRun;
+
+	QGLShaderProgram *glProgram;
+	GLsizei textureWidths[3];
+	GLsizei textureHeights[3];
+	uint8_t *textureOffsets[3];
+
+#ifndef QT_OPENGL_ES
+	typedef void (APIENTRY *_glActiveTexture) (GLenum);
+	_glActiveTexture glActiveTexture;
+#endif
+
+protected:
+	void initializeGL();
+	void paintGL();
+
+public:
+	QtGlAccelWidget(QWidget *parent, int widgetWidth, int widgetHeight);
+	void setBuffer(uint8_t *buffer, int imageWidth, int imageHeight);
+};
+
+
+class QtGlAccelRender : public AccelRender
+{
+private:
+	QtGlAccelWidget *glWidget;
+
+public:
+	QtGlAccelRender(void);
+	virtual	uint8_t init(GUI_WindowInfo *window, uint32_t w, uint32_t h);
+	virtual	uint8_t end(void);
+	virtual uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h, renderZoom zoom);
+	uint8_t hasHwZoom(void);
+};
+#endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.cpp	2010-09-19 14:28:21 UTC (rev 6629)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.cpp	2010-09-19 23:32:24 UTC (rev 6630)
@@ -17,9 +17,14 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
+#include "config.h"
+#include "ADM_coreConfig.h"
+#include "DIA_uiTypes.h"
 
-#include "config.h"
-#include "ADM_assert.h"
+#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
+#	include "GUI_qtGlRender.h"
+#endif
+
 #include "GUI_render.h"
 #include "GUI_renderInternal.h"
 #include "GUI_accelRender.h"
@@ -32,14 +37,10 @@
 #include "GUI_sdlRender.h"
 #endif
 
-
 #include "ADM_colorspace.h"
 
-#include "DIA_uiTypes.h"
-
-
 static ColYuvRgb rgbConverter(640,480
-#if ADM_UI_TYPE_BUILD == ADM_UI_QT4 
+#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
     ,1
 #endif    
 );
@@ -289,7 +290,21 @@
 
                 break;
 #endif
+#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
+			case RENDER_QT_OPENGL:
+				accel_mode = new QtGlAccelRender();
 
+				r = accel_mode->init(&xinfo, renderW, renderH);
+
+				if (!r)
+				{
+					delete accel_mode;
+					accel_mode = NULL;
+				}
+
+				break;
+#endif
+
             default:break;
         }
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.h	2010-09-19 14:28:21 UTC (rev 6629)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.h	2010-09-19 23:32:24 UTC (rev 6630)
@@ -75,14 +75,13 @@
 #endif
 #ifdef USE_SDL
         RENDER_SDL=2,
-
-#ifdef __WIN32
+#	ifdef __WIN32
 		RENDER_DIRECTX=3,
+#	endif
 #endif
+#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
+		RENDER_QT_OPENGL = 4,
 #endif
-        RENDER_LAST       
-
-
-}ADM_RENDER_TYPE;
-
+        RENDER_LAST
+} ADM_RENDER_TYPE;
 #endif

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admCheckMiscLibs.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admCheckMiscLibs.cmake	2010-09-19 14:28:21 UTC (rev 6629)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admCheckMiscLibs.cmake	2010-09-19 23:32:24 UTC (rev 6630)
@@ -10,6 +10,36 @@
 ENDIF (NOT ADMLOCALE)
 
 ########################################
+# OpenGL
+########################################
+OPTION(OPENGL "" ON)
+
+MESSAGE(STATUS "Checking for OpenGL")
+MESSAGE(STATUS "*******************")
+
+IF (OPENGL)
+	IF (QT4_FOUND AND QT_VERSION_MINOR GREATER 5)
+		IF (QT_QTOPENGL_FOUND)
+			MESSAGE(STATUS "Found QtOpenGL")
+			FIND_PACKAGE(OpenGL)
+			PRINT_LIBRARY_INFO("OpenGL" OPENGL_FOUND "${OPENGL_INCLUDE_DIR}" "${OPENGL_LIBRARIES}")
+		ELSE (QT_QTOPENGL_FOUND)
+			MESSAGE(STATUS "QtOpenGL was not found")
+		ENDIF (QT_QTOPENGL_FOUND)
+	ELSE (QT4_FOUND AND QT_VERSION_MINOR GREATER 5)
+		MESSAGE(STATUS "OpenGL is only available for Qt 4.6 or later")
+	ENDIF (QT4_FOUND AND QT_VERSION_MINOR GREATER 5)
+
+	IF (OPENGL_FOUND)
+		SET(USE_OPENGL 1)
+	ENDIF (OPENGL_FOUND)
+ELSE (OPENGL)
+	MESSAGE("${MSG_DISABLE_OPTION}")
+ENDIF (OPENGL)
+
+MESSAGE("")
+
+########################################
 # SDL
 ########################################
 OPTION(SDL "" ON)

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admConfigSummary.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admConfigSummary.cmake	2010-09-19 14:28:21 UTC (rev 6629)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admConfigSummary.cmake	2010-09-19 23:32:24 UTC (rev 6630)
@@ -25,6 +25,7 @@
 
 MESSAGE("*** Miscellaneous ***")
 ADM_DISPLAY("gettext   " "${HAVE_GETTEXT}")
+ADM_DISPLAY("OpenGL    " "${USE_OPENGL}")
 ADM_DISPLAY("SDL       " "${USE_SDL}")
 ADM_DISPLAY("XVideo    " "${USE_XV}" "${XVIDEO_CAPABLE}")
 



From gruntster at mail.berlios.de  Mon Sep 20 11:32:11 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 20 Sep 2010 11:32:11 +0200
Subject: [Avidemux-svn-commit] r6631 - in
	branches/avidemux_2.5_branch_gruntster:
	avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui
	avidemux/ADM_userInterfaces/ADM_commonUI
	avidemux/ADM_userInterfaces/ADM_render cmake
Message-ID: <20100920093211.DD347480AC2@sheep.berlios.de>

Author: gruntster
Date: 2010-09-20 11:32:11 +0200 (Mon, 20 Sep 2010)
New Revision: 6631

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.h
   branches/avidemux_2.5_branch_gruntster/cmake/config.h.cmake
Log:
[render] make OpenGL renderer a little more cross-platform friendly

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2010-09-19 23:32:24 UTC (rev 6630)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2010-09-20 09:32:11 UTC (rev 6631)
@@ -228,16 +228,17 @@
 {
 	QWidget* widget = videoWindow->parentWidget();
 
+	xinfo->widget = videoWindow;
+
 #if defined(__WIN32)
 	xinfo->display=videoWindow->winId();
-	xinfo->window = (int)videoWindow->winId();
 #elif defined(__APPLE__)
 	#if defined(ADM_CPU_X86_64)
 		xinfo->display = (void*)videoWindow->winId();
-		xinfo->window = (int)videoWindow->winId();
+		xinfo->window = 0;
 	#else
 		xinfo->display = HIViewGetWindow(HIViewRef(widget->winId()));
-		xinfo->window = (int)videoWindow->winId();
+		xinfo->window = 0;
 	#endif
 #else
     const QX11Info &info=videoWindow->x11Info();

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp	2010-09-19 23:32:24 UTC (rev 6630)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp	2010-09-20 09:32:11 UTC (rev 6631)
@@ -227,7 +227,7 @@
         diaElemToggle   togTagMp3(&alternate_mp3_tag,QT_TR_NOOP("_Use alternative tag for MP3 in .mp4"));
         diaMenuEntry videoMode[]={
                              {RENDER_GTK, getNativeRendererDesc(), NULL}
-#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
+#if ADM_UI_TYPE_BUILD == ADM_UI_QT4 && defined(USE_OPENGL)
 							 ,{RENDER_QT_OPENGL, QT_TR_NOOP("Qt (OpenGL)"), NULL}
 #endif
 #ifdef USE_XV

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.cpp	2010-09-19 23:32:24 UTC (rev 6630)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.cpp	2010-09-20 09:32:11 UTC (rev 6631)
@@ -13,9 +13,16 @@
 #define GL_GLEXT_PROTOTYPES
 
 #include <QtGui/QPainter>
-#include <GL/gl.h>
-#include <GL/glext.h>
 
+#ifdef __APPLE__
+#	include <OpenGL/gl.h>
+#	include <OpenGL/glext.h>
+#	define GL_TEXTURE_RECTANGLE_NV GL_TEXTURE_RECTANGLE_EXT
+#else
+#	include <GL/gl.h>
+#	include <GL/glext.h>
+#endif
+
 #include "GUI_qtGlRender.h"
 
 static const char *yuvToRgb =
@@ -210,9 +217,7 @@
 {
 	printf("[GL Render] Initialising renderer\n");
 
-	QWidget *widget = QWidget::find((WId)window->window);
-
-	glWidget = new QtGlAccelWidget(widget, w, h);
+	glWidget = new QtGlAccelWidget((QWidget*)window->widget, w, h);
 	glWidget->show();
 
 	return QGLFormat::hasOpenGL() && QGLShaderProgram::hasOpenGLShaderPrograms();

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.h	2010-09-19 23:32:24 UTC (rev 6630)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_qtGlRender.h	2010-09-20 09:32:11 UTC (rev 6631)
@@ -32,7 +32,7 @@
 	uint8_t *textureOffsets[3];
 
 #ifndef QT_OPENGL_ES
-	typedef void (APIENTRY *_glActiveTexture) (GLenum);
+	typedef void (*_glActiveTexture) (GLenum);
 	_glActiveTexture glActiveTexture;
 #endif
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.cpp	2010-09-19 23:32:24 UTC (rev 6630)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.cpp	2010-09-20 09:32:11 UTC (rev 6631)
@@ -18,10 +18,9 @@
  *                                                                         *
  ***************************************************************************/
 #include "config.h"
-#include "ADM_coreConfig.h"
 #include "DIA_uiTypes.h"
 
-#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
+#if ADM_UI_TYPE_BUILD == ADM_UI_QT4 && defined(USE_OPENGL)
 #	include "GUI_qtGlRender.h"
 #endif
 
@@ -290,7 +289,7 @@
 
                 break;
 #endif
-#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
+#if ADM_UI_TYPE_BUILD == ADM_UI_QT4 && defined(USE_OPENGL)
 			case RENDER_QT_OPENGL:
 				accel_mode = new QtGlAccelRender();
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.h	2010-09-19 23:32:24 UTC (rev 6630)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_render/GUI_render.h	2010-09-20 09:32:11 UTC (rev 6631)
@@ -26,7 +26,8 @@
 typedef struct
 {
     void *display;
-    int  window;
+	void *widget;
+    int window;
 	int x;
 	int y;
 	int width;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/config.h.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/config.h.cmake	2010-09-19 23:32:24 UTC (rev 6630)
+++ branches/avidemux_2.5_branch_gruntster/cmake/config.h.cmake	2010-09-20 09:32:11 UTC (rev 6631)
@@ -54,6 +54,11 @@
 /* Libxml2 is available */
 #cmakedefine USE_LIBXML2
 
+#if ${CONFIG_HEADER_TYPE} == ADM_BUILD_QT4
+/* OpenGL detected */
+#cmakedefine USE_OPENGL
+#endif
+
 #if ${CONFIG_HEADER_TYPE} == ADM_BUILD_GTK || ${CONFIG_HEADER_TYPE} == ADM_BUILD_QT4
 /* SDL detected */
 #cmakedefine USE_SDL



From mean at mail.berlios.de  Mon Sep 20 19:54:13 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 20 Sep 2010 19:54:13 +0200
Subject: [Avidemux-svn-commit] r6632 - in branches/avidemux_2.6_branch_mean:
	avidemux/common avidemux/common/ADM_videoCodec/src
	avidemux/qt4/ADM_userInterfaces/ADM_gui
	avidemux_core/ADM_coreVdpau/include avidemux_core/ADM_coreVdpau/src
Message-ID: <20100920175413.77D64480F2D@sheep.berlios.de>

Author: mean
Date: 2010-09-20 19:54:13 +0200 (Mon, 20 Sep 2010)
New Revision: 6632

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_ffmpeg_vdpau.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_preview.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpauInternal.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp
Log:
[Vdpau] Cleanup + cleanup renderer

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_ffmpeg_vdpau.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_ffmpeg_vdpau.cpp	2010-09-20 09:32:11 UTC (rev 6631)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_ffmpeg_vdpau.cpp	2010-09-20 17:54:13 UTC (rev 6632)
@@ -81,6 +81,13 @@
     return true;
 }
 /**
+    \fn vdpauCleanup
+*/
+bool vdpauCleanup(void)
+{
+   return admVdpau::cleanup();
+}
+/**
     \fn ADM_VDPAUgetBuffer
     \brief trampoline to get a VDPAU surface
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-09-20 09:32:11 UTC (rev 6631)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-09-20 17:54:13 UTC (rev 6632)
@@ -83,6 +83,8 @@
 extern bool ADM_dm_cleanup(void);
 
 extern bool vdpauProbe(void);
+extern bool vdpauCleanup(void);
+
 extern void loadPlugins(void);
 extern void InitFactory(void);
 extern void InitCoreToolkit(void);
@@ -103,6 +105,7 @@
 
 extern int UI_Init(int nargc,char **nargv);
 extern int UI_RunApp(void);
+extern bool UI_End(void);
 extern void renderDestroy(void);
 
 // Spidermonkey/Scripting stuff  
@@ -331,6 +334,7 @@
     destroyPrefs();
     
     admPreview::destroy();
+    UI_End();
     renderDestroy();
 
     ADM_ad_cleanup();
@@ -338,6 +342,14 @@
     ADM_mx_cleanup();
     ADM_vf_cleanup();
     ADM_dm_cleanup();
+#if defined( USE_VDPAU) 
+  #if (ADM_UI_TYPE_BUILD!=ADM_UI_CLI)
+    printf("cleaning VDPAU...\n");
+    vdpauCleanup();
+  #else
+    printf("Cannot use VDPAU in cli mode %d,%d\n",ADM_UI_TYPE_BUILD,ADM_UI_CLI);
+  #endif
+#endif
 
     printf("--End of cleanup--\n");
     ADMImage_stat();

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-20 09:32:11 UTC (rev 6631)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-09-20 17:54:13 UTC (rev 6632)
@@ -70,7 +70,7 @@
 uint8_t UI_updateRecentMenu( void );
 extern void saveCrashProject(void);
 extern uint8_t AVDM_setVolume(int volume);
-
+extern bool ADM_QPreviewCleanup(void);
 #define WIDGET(x)  (((MainWindow *)QuiMainWindows)->ui.x)
 
 #define CONNECT(object,zzz) connect( (ui.object),SIGNAL(triggered()),this,SLOT(buttonPressed()));
@@ -718,7 +718,14 @@
     UI_InitVUMeter(mw->ui.frameVU);
 	return 0;
 }
+/**
 
+*/
+bool UI_End(void)
+{
+    ADM_QPreviewCleanup();
+    return true;
+}
 void UI_refreshCustomMenu(void)
 {
 	((MainWindow*)QuiMainWindows)->buildCustomMenu();

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_preview.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_preview.cpp	2010-09-20 09:32:11 UTC (rev 6631)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_preview.cpp	2010-09-20 17:54:13 UTC (rev 6632)
@@ -61,7 +61,12 @@
   It is a base QWidget where the image will be put by painter.
 
 */
-
+bool ADM_QPreviewCleanup(void)
+{
+    if(rgbDataBuffer) delete [] rgbDataBuffer;
+    rgbDataBuffer=NULL;
+    return true;
+}
 ADM_Qvideo::ADM_Qvideo(QWidget *z) : QWidget(z) {}
 ADM_Qvideo::~ADM_Qvideo() {}
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h	2010-09-20 09:32:11 UTC (rev 6631)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h	2010-09-20 17:54:13 UTC (rev 6632)
@@ -37,6 +37,7 @@
 public:
     static bool         init(GUI_WindowInfo *x);
     static bool         isOperationnal(void);
+    static bool         cleanup(void);
     /* Surface */
 #ifdef USE_VDPAU
     static  const char  *getErrorString(VdpStatus er);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpauInternal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpauInternal.h	2010-09-20 09:32:11 UTC (rev 6631)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpauInternal.h	2010-09-20 17:54:13 UTC (rev 6632)
@@ -23,6 +23,8 @@
     VdpGetApiVersion        *getApiVersion;
     VdpGetInformationString *getInformationString;
 
+    VdpDeviceDestroy        *deviceDestroy;
+
     VdpVideoSurfaceCreate   *createSurface;
     VdpVideoSurfaceDestroy  *destroySurface;
     VdpVideoSurfaceGetBitsYCbCr *getDataSurface;

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp	2010-09-20 09:32:11 UTC (rev 6631)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp	2010-09-20 17:54:13 UTC (rev 6632)
@@ -67,6 +67,7 @@
     // Now that we have the vdpProcAddress, time to get the functions....
 #define GetMe(fun,id)         ADM_coreVdpau::funcs.fun= (typeof(ADM_coreVdpau::funcs.fun))getFunc(id);ADM_assert(ADM_coreVdpau::funcs.fun); 
         
+    GetMe(deviceDestroy,VDP_FUNC_ID_DEVICE_DESTROY);
     GetMe(getErrorString,VDP_FUNC_ID_GET_ERROR_STRING);
     GetMe(getApiVersion,VDP_FUNC_ID_GET_API_VERSION);
     GetMe(getInformationString,VDP_FUNC_ID_GET_INFORMATION_STRING);
@@ -137,6 +138,20 @@
     return true;
 }
 /**
+    \fn cleanup
+*/
+bool admVdpau::cleanup(void)
+{
+    if(true==coreVdpWorking)
+    {
+            ADM_info("Destroying vdp device..\n");
+            ADM_coreVdpau::funcs.deviceDestroy(ADM_coreVdpau::vdpDevice);
+            ADM_coreVdpau::vdpDevice=VDP_INVALID_HANDLE;
+    }
+    coreVdpWorking=false;
+    return true;
+}
+/**
     \fn queryYUVPutBitSupport
 */
 bool admVdpau::queryYUVPutBitSupport(VdpRGBAFormat rgb,VdpYCbCrFormat yuv)
@@ -357,5 +372,10 @@
     ADM_warning("This binary has no VPDAU support\n");
     return coreVdpWorking;
 }
+bool admVdpau::cleanup(void)
+{
+    ADM_warning("This binary has no VPDAU support\n");
+    return true;
+}
 #endif
 // EOF



From mean at mail.berlios.de  Mon Sep 20 19:54:14 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 20 Sep 2010 19:54:14 +0200
Subject: [Avidemux-svn-commit] r6633 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <20100920175414.D51FE480F2D@sheep.berlios.de>

Author: mean
Date: 2010-09-20 19:54:14 +0200 (Mon, 20 Sep 2010)
New Revision: 6633

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
Log:
[main] Try to cleanup

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-09-20 17:54:13 UTC (rev 6632)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-09-20 17:54:14 UTC (rev 6633)
@@ -312,10 +312,11 @@
     printf("Normal exit\n");
     return 0;
 }
-
+extern uint8_t GUI_close(void);
 void onexit( void )
 {
 	printf("Cleaning up\n");
+    if(video_body) video_body->cleanup ();  
     delete video_body;	
     // wait for thread to finish executing
     SpidermonkeyExit();



From mean at mail.berlios.de  Mon Sep 20 19:54:15 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 20 Sep 2010 19:54:15 +0200
Subject: [Avidemux-svn-commit] r6634 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20100920175415.E6447480F2D@sheep.berlios.de>

Author: mean
Date: 2010-09-20 19:54:15 +0200 (Mon, 20 Sep 2010)
New Revision: 6634

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
Log:
[TsIndexer] Break missing, thanks wigglebit

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-09-20 17:54:14 UTC (rev 6633)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-09-20 17:54:15 UTC (rev 6634)
@@ -367,6 +367,7 @@
                             *recoveryLength=bits.getUEG();
                             zprintf("[SEI] Recovery :%"LU"\n",*recoveryLength);
                             r=true;
+                            break;
                         }
                         default:
                             payload+=sei_size;



From mean at mail.berlios.de  Mon Sep 20 19:54:17 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 20 Sep 2010 19:54:17 +0200
Subject: [Avidemux-svn-commit] r6635 - in
	branches/avidemux_2.6_branch_mean/avidemux:
	cli/ADM_userInterfaces/ADM_dialog gtk/ADM_userInterfaces/ADM_gui2
Message-ID: <20100920175417.6DF85480F2D@sheep.berlios.de>

Author: mean
Date: 2010-09-20 19:54:17 +0200 (Mon, 20 Sep 2010)
New Revision: 6635

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
Log:
[Gtk/cli] Build fix

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_none.cpp	2010-09-20 17:54:15 UTC (rev 6634)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_none.cpp	2010-09-20 17:54:17 UTC (rev 6635)
@@ -120,6 +120,10 @@
 	printf("End of program..\n");
 	printf("*********************************\n");
 	printf("*********************************\n");
+}
+bool UI_End(void)
+{
+    return true;
 }
 bool UI_setDecoderName(const char *name) {return true;}
 int32_t UI_readJog(void) {return 0;};

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-20 17:54:15 UTC (rev 6634)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2010-09-20 17:54:17 UTC (rev 6635)
@@ -76,7 +76,7 @@
 
 static gint       jogChange( void );
 static void volumeChange( void );
-static char     *customNames[ADM_MAC_CUSTOM_SCRIPT];
+static char     *customNames[ADM_MAX_CUSTOM_SCRIPT];
 static uint32_t ADM_nbCustom=0;
 // Needed for DND
 // extern int A_openAvi (char *name);
@@ -591,7 +591,7 @@
       return;
   }
   /* Collect the name */
-   if(! buildDirectoryContent(&ADM_nbCustom,customdir,   customNames,ADM_MAC_CUSTOM_SCRIPT,".js"))
+   if(! buildDirectoryContent(&ADM_nbCustom,customdir,   customNames,ADM_MAX_CUSTOM_SCRIPT,".js"))
     {
       printf("Failed to build custom dir content");
       delete [] customdir;
@@ -1512,8 +1512,12 @@
     gdk_threads_leave();
 
 }
+bool UI_End(void)
+{
+    // cleanup here
+    return true;
+}
 
-
 void trampoline(void)
 {
     ADM_usleep(100000); // let gtk start



From gruntster at mail.berlios.de  Tue Sep 21 12:03:16 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 21 Sep 2010 12:03:16 +0200
Subject: [Avidemux-svn-commit] r6636 - in
	branches/avidemux_2.5_branch_gruntster/platforms/windows:
	build_scripts build_scripts/avidemux installer
Message-ID: <20100921100317.0804B480FBC@sheep.berlios.de>

Author: gruntster
Date: 2010-09-21 12:03:16 +0200 (Tue, 21 Sep 2010)
New Revision: 6636

Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
Log:
[win32] update installer

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat	2010-09-20 17:54:17 UTC (rev 6635)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat	2010-09-21 10:03:16 UTC (rev 6636)
@@ -29,7 +29,7 @@
 set SDLDIR=%usrLocalDir%
 set CFLAGS=%CFLAGS% -I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
 set CXXFLAGS=%CXXFLAGS% -I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
-set LDFLAGS=%LDFLAGS% -shared-libgcc -shared-libstdc++ -L%CMAKE_LIBRARY_PATH%
+set LDFLAGS=%LDFLAGS% -shared-libgcc -lstdc++ -L%CMAKE_LIBRARY_PATH%
 
 if exist "%qtDir%" (
 	for /f %%d in ('dir /b /ad /on %qtDir%') do set qtVer=%%d

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml	2010-09-20 17:54:17 UTC (rev 6635)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml	2010-09-21 10:03:16 UTC (rev 6636)
@@ -1,234 +1,259 @@
 <?xml version="1.0"?>
 <log>
-  <buildentry revision="6303" date="2010-06-04">
-  </buildentry>
-  <buildentry revision="6288" date="2010-06-01">
-  </buildentry>
-  <buildentry revision="6261" date="2010-05-27">
-    <comment>Updated x264 to r1613.</comment>
-  </buildentry>
-  <buildentry revision="6195" date="2010-05-16">
-    <comment>Updated Freetype to version 2.3.12-1.</comment>
-    <comment>Updated GLib to version 2.24.1-1.</comment>
-    <comment>Updated GTK+ to version 2.20.1-1.</comment>
-    <comment>Updated x264 to r1583.</comment>
-  </buildentry>
-  <buildentry revision="6161 [2.5.3 Final]" date="2010-05-16">
-    <comment>Updated Avisynth Proxy GUI to version 2.12.</comment>
-  </buildentry>
-  <buildentry revision="6129" date="2010-04-15">
-    <comment>Updated x264 to r1542.</comment>
-  </buildentry>
-  <buildentry revision="6121" date="2010-04-11">
-    <comment>Updated ATK to version 1.30.0-1.</comment>
-    <comment>Updated Cairo to version 1.8.10-3.</comment>
-    <comment>Updated GLib to version 2.24.0-2.</comment>
-    <comment>Updated GTK+ to version 2.20.0-1.</comment>
-    <comment>Updated Libxml2 to version 2.7.7-1.</comment>
-    <comment>Updated Pango to version 1.28.0-1.</comment>
-    <comment>Updated x264 to r1523.</comment>
-    <comment>Updated zlib to version 1.2.4-2.</comment>
-  </buildentry>
-  <buildentry revision="6083" date="2010-04-06">
-  </buildentry>
-  <buildentry revision="6064" date="2010-04-05">
-    <comment>Updated x264 to r1510.</comment>
-  </buildentry>
-  <buildentry revision="6028" date="2010-03-27">
-    <comment>Updated Avisynth Proxy GUI to version 2.11.</comment>
-    <comment>Updated GLib to version 2.22.5-1.</comment>
-    <comment>Updated GTK+ to version 2.18.9-1.</comment>
-    <comment>Updated LAME to version 3.98.4.</comment>
-    <comment>Updated Ogg to version 1.2.0.</comment>
-    <comment>Updated NSPR to version 4.8.4.</comment>
-    <comment>Updated Vorbis to version 1.3.1.</comment>
-  </buildentry>
-  <buildentry revision="5955" date="2010-02-28">
-    <comment>Compiled with GCC 4.4.3.</comment>
-    <comment>Updated Cairo to version 1.8.10-1.</comment>
-    <comment>Updated Freetype to version 2.3.11-2.</comment>
-    <comment>Updated GTK+ to version 2.18.7-1.</comment>
-    <comment>Updated LAME to version 3.98.3.</comment>
-    <comment>Updated libpng to version 1.4.0-1.</comment>
-    <comment>Updated NSPR to version 4.8.3.</comment>
-    <comment>Updated Pango to version 1.26.2-1.</comment>
-    <comment>Updated Qt to version 4.6.2.</comment>
-    <comment>Updated x264 to r1471.</comment>
-  </buildentry>
-  <buildentry revision="5869" date="2010-01-23">
-    <comment>Updated GLib to version 2.22.4-1.</comment>
-    <comment>Updated Qt to version 4.6.1.</comment>
-    <comment>Updated x264 to r1400.</comment>
-  </buildentry>
-  <buildentry revision="5830" date="2010-01-07">
-    <comment>Compiled with GCC 4.4.3 pre-release (r155431).</comment>
-  </buildentry>
-  <buildentry revision="5810" date="2010-01-02">
-  </buildentry>
-  <buildentry revision="5801" date="2009-12-31">
-  </buildentry>
-  <buildentry revision="5775" date="2009-12-29">
-  </buildentry>
-  <buildentry revision="5747" date="2009-12-28">
-  </buildentry>
-  <buildentry revision="5676" date="2009-12-20">
-    <comment>Packaged using NSIS 2.46.</comment>
-    <comment>Updated GTK+ to version 2.18.5-1.</comment>
-    <comment>Updated libpng to version 1.2.40-1.</comment>
-    <comment>Updated Pango to version 1.26.1-1.</comment>
-    <comment>Updated Qt to version 4.6.0.</comment>
-    <comment>Updated x264 to r1376.</comment>
-  </buildentry>
-  <buildentry revision="5660 [2.5.2 Final]" date="2009-12-19">
-  </buildentry>
-  <buildentry revision="5636 [2.5.2 RC1]" date="2009-12-12">
-  </buildentry>
-  <buildentry revision="5602" date="2009-11-30">
-  </buildentry>
-  <buildentry revision="5590" date="2009-11-28">
-    <comment>Updated Cairo to version 1.8.8-3.</comment>
-    <comment>Updated Fontconfig to version 2.8.0-1.</comment>
-    <comment>Updated Freetype to version 2.3.11-1.</comment>
-    <comment>Updated GLib to version 2.22.2-1.</comment>
-    <comment>Updated GTK+ to version 2.18.3-1.</comment>
-    <comment>Updated Pango to version 1.26.0-1.</comment>
-    <comment>Updated x264 to r1352.</comment>
-  </buildentry>
-  <buildentry revision="5567" date="2009-11-26">
-  </buildentry>
-  <buildentry revision="5558" date="2009-11-24">
-  </buildentry>
-  <buildentry revision="5546" date="2009-11-23">
-    <comment>Updated x264 to r1347.</comment>
-  </buildentry>
-  <buildentry revision="5530" date="2009-11-19">
-    <comment>Updated x264 to r1342.</comment>
-  </buildentry>
-  <buildentry revision="5422" date="2009-10-27">
-    <comment>Updated SDL to version 1.2.14.</comment>
-    <comment>Updated x264 to r1310.</comment>
-  </buildentry>
-  <buildentry revision="5369" date="2009-10-05">
-    <comment>Updated ATK to version 1.28.0-1.</comment>
-    <comment>Updated Fontconfig to version 2.7.3-1.</comment>
-    <comment>Updated GLib to version 2.22.1-1.</comment>
-    <comment>Updated GTK+ to version 2.18.1-1.</comment>
-    <comment>Updated libpng to version 1.2.39-1.</comment>
-    <comment>Updated Libxml2 to version 2.7.4-1.</comment>
-    <comment>Updated NSPR to version 4.8.</comment>
-    <comment>Updated opencore-amr to version 0.1.2.</comment>
-    <comment>Updated Qt to version 4.5.3.</comment>
-    <comment>Updated x264 to r1271.</comment>
-  </buildentry>
-  <buildentry revision="5341" date="2009-09-17">
-    <comment>Updated x264 to r1259.</comment>
-  </buildentry>
-  <buildentry revision="5327" date="2009-09-09">
-    <comment>Updated x264 to r1251.</comment>
-  </buildentry>
-  <buildentry revision="5281" date="2009-08-29">
-    <comment>Updated x264 to r1240.</comment>
-  </buildentry>
-  <buildentry revision="5273" date="2009-08-27">
-    <comment>Updated x264 to r1235.</comment>
-    <comment>Updated Xvid to version 1.2.2.</comment>
-  </buildentry>
-  <buildentry revision="5268" date="2009-08-23">
-    <comment>Updated x264 to r1222.</comment>
-  </buildentry>
-  <buildentry revision="5249 [2.5.1 Final]" date="2009-08-16">
-    <comment>Updated Fontconfig to version 2.7.1-2.</comment>
-  </buildentry>
-  <buildentry revision="5234" date="2009-08-12">
-    <comment>Updated Cairo to version 1.8.8-1.</comment>
-    <comment>Updated Fontconfig to version 2.7.1-1.</comment>
-    <comment>Updated Freetype to version 2.3.9-1.</comment>
-    <comment>Updated GLib to version 2.20.4-1.</comment>
-    <comment>Updated GTK+ to version 2.16.5-1.</comment>
-    <comment>Updated libpng to version 1.2.38-1.</comment>
-    <comment>Updated Pango to version 1.24.5-1.</comment>
-    <comment>Updated x264 to r1206.</comment>
-  </buildentry>
-  <buildentry revision="5204" date="2009-08-03">
-  </buildentry>
-  <buildentry revision="5181" date="2009-07-30">
-    <comment>Updated x264 to r1195.</comment>
-  </buildentry>
-  <buildentry revision="5152" date="2009-07-25">
-    <comment>Updated Avisynth Proxy GUI to version 2.09d.</comment>
-    <comment>Updated x264 to r1185.</comment>
-  </buildentry>
-  <buildentry revision="5104" date="2009-07-17">
-    <comment>Added opencore-amr version 0.1.1.</comment>
-    <comment>Updated x264 to r1183.</comment>
-  </buildentry>
-  <buildentry revision="5087" date="2009-07-13">
-  </buildentry>
-  <buildentry revision="5065" date="2009-07-12">
-    <comment>Updated Vorbis to version 1.2.3.</comment>
-    <comment>Updated x264 to r1181.</comment>
-  </buildentry>
-  <buildentry revision="5031" date="2009-07-10">
-    <comment>Recompiled FAAC with MinGW's GCC 4.2.1-sjlj-2.</comment>
-    <comment>Updated x264 to r1179.</comment>
-  </buildentry>
-  <buildentry revision="5010" date="2009-07-06">
-  </buildentry>
-  <buildentry revision="4997" date="2009-07-05">
-  </buildentry>
-  <buildentry revision="4992" date="2009-07-04">
-    <comment>Updated FAAC to version 1.28.</comment>
-    <comment>Updated FAAD2 to version 2.7.</comment>
-  </buildentry>
-  <buildentry revision="4968" date="2009-06-27">
-    <comment>Updated ATK to version 1.26.0-1.</comment>
-    <comment>Updated GLib to version 2.20.3-1.</comment>
-    <comment>Updated GTK+ to version 2.16.2-1.</comment>
-    <comment>Updated libpng to version 1.2.37-1.</comment>
-    <comment>Updated Ogg to version 1.1.4.</comment>
-    <comment>Updated Pango to version 1.24.2-1.</comment>
-    <comment>Updated Qt to version 4.5.2.</comment>
-    <comment>Updated Vorbis to version 1.2.2.</comment>
-    <comment>Updated x264 to r1173.</comment>
-  </buildentry>
-  <buildentry revision="4944 [2.5.0 Final]" date="2009-06-23">
-    <comment>Updated x264 to r1170.</comment>
-  </buildentry>
-  <buildentry revision="4871" date="2009-05-25">
-    <comment>Updated x264 to r1159.</comment>
-  </buildentry>
-  <buildentry revision="4763" date="2009-04-26">
-    <comment>Added Netscape Portable Runtime version 4.7.4.</comment>
-    <comment>Updated Pango to version 1.24.1-1.</comment>
-    <comment>Updated Qt to version 4.5.1.</comment>
-    <comment>Updated SpiderMonkey to version 1.7.0.</comment>
-  </buildentry>
-  <buildentry revision="4758" date="2009-04-22">
-    <comment>Updated Avisynth Proxy GUI to version 2.08.</comment>
-    <comment>Updated x264 to r1145.</comment>
-  </buildentry>
-  <buildentry revision="4741" date="2009-04-20">
-    <comment>Updated GLib to version 2.20.1-1.</comment>
-    <comment>Updated GTK+ to version 2.16.1-1.</comment>
-    <comment>Updated Pango to version 1.24.0-1.</comment>
-  </buildentry>
-  <buildentry revision="4685" date="2009-03-14">
-  </buildentry>
-  <buildentry revision="4658" date="2009-03-05">
-    <comment>Updated Qt to version 4.5.0.</comment>
-  </buildentry>
-  <buildentry revision="4648" date="2009-03-02">
-    <comment>Updated x264 to r1115.</comment>
-  </buildentry>
-  <buildentry revision="4629" date="2009-02-24">
-  </buildentry>
-  <buildentry revision="4618" date="2009-02-21">
-    <comment>Updated x264 to r1114.</comment>
-  </buildentry>
-  <buildentry revision="4609" date="2009-02-16">
-    <comment>Packaged using NSIS 2.43.</comment>
-    <comment>Updated Avisynth Proxy GUI to version 2.07 (2nd release).</comment>
-    <comment>Updated Libxml2 to version 2.7.3.</comment>
-    <comment>Updated x264 to r1113.</comment>
-  </buildentry>
+	<buildentry revision="6587" date="2010-09-05">
+		<comment>Compiled with GCC 4.5.1.</comment>
+		<comment>Updated Cairo to version 1.8.10-4.</comment>
+		<comment>Updated Freetype to version 2.4.2-1.</comment>
+		<comment>Updated GLib to version 2.24.2-1.</comment>
+		<comment>Updated libvpx to version 0.9.2.</comment>
+		<comment>Updated NSPR to version 4.8.6.</comment>
+		<comment>Updated Pango to version 1.28.1-1.</comment>
+		<comment>Updated x264 to r1713.</comment>
+		<comment>Updated zlib to version 1.2.5-2.</comment>
+	</buildentry>
+	<buildentry revision="6502" date="2010-08-03">
+		<comment>Updated x264 to r1688.</comment>
+	</buildentry>
+	<buildentry revision="6442" date="2010-07-06">
+		<comment>Compiled with GCC 4.4.5 pre-release (r161668).</comment>
+		<comment>Updated libvpx to version 0.9.1.</comment>
+		<comment>Updated x264 to r1666.</comment>
+	</buildentry>
+	<buildentry revision="6370" date="2010-06-13">
+		<comment>Added libvpx, git version (commit: 5ef25a9728507d259c6ccd05064ce1208e7abd9f).</comment>
+		<comment>Updated x264 to r1624.</comment>
+	</buildentry>
+	<buildentry revision="6340" date="2010-06-07">
+	</buildentry>
+	<buildentry revision="6303" date="2010-06-04">
+	</buildentry>
+	<buildentry revision="6288" date="2010-06-01">
+	</buildentry>
+	<buildentry revision="6261" date="2010-05-27">
+		<comment>Updated x264 to r1613.</comment>
+	</buildentry>
+	<buildentry revision="6195" date="2010-05-16">
+		<comment>Updated Freetype to version 2.3.12-1.</comment>
+		<comment>Updated GLib to version 2.24.1-1.</comment>
+		<comment>Updated GTK+ to version 2.20.1-1.</comment>
+		<comment>Updated x264 to r1583.</comment>
+	</buildentry>
+	<buildentry revision="6161 [2.5.3 Final]" date="2010-05-16">
+		<comment>Updated Avisynth Proxy GUI to version 2.12.</comment>
+	</buildentry>
+	<buildentry revision="6129" date="2010-04-15">
+		<comment>Updated x264 to r1542.</comment>
+	</buildentry>
+	<buildentry revision="6121" date="2010-04-11">
+		<comment>Updated ATK to version 1.30.0-1.</comment>
+		<comment>Updated Cairo to version 1.8.10-3.</comment>
+		<comment>Updated GLib to version 2.24.0-2.</comment>
+		<comment>Updated GTK+ to version 2.20.0-1.</comment>
+		<comment>Updated Libxml2 to version 2.7.7-1.</comment>
+		<comment>Updated Pango to version 1.28.0-1.</comment>
+		<comment>Updated x264 to r1523.</comment>
+		<comment>Updated zlib to version 1.2.4-2.</comment>
+	</buildentry>
+	<buildentry revision="6083" date="2010-04-06">
+	</buildentry>
+	<buildentry revision="6064" date="2010-04-05">
+		<comment>Updated x264 to r1510.</comment>
+	</buildentry>
+	<buildentry revision="6028" date="2010-03-27">
+		<comment>Updated Avisynth Proxy GUI to version 2.11.</comment>
+		<comment>Updated GLib to version 2.22.5-1.</comment>
+		<comment>Updated GTK+ to version 2.18.9-1.</comment>
+		<comment>Updated LAME to version 3.98.4.</comment>
+		<comment>Updated Ogg to version 1.2.0.</comment>
+		<comment>Updated NSPR to version 4.8.4.</comment>
+		<comment>Updated Vorbis to version 1.3.1.</comment>
+	</buildentry>
+	<buildentry revision="5955" date="2010-02-28">
+		<comment>Compiled with GCC 4.4.3.</comment>
+		<comment>Updated Cairo to version 1.8.10-1.</comment>
+		<comment>Updated Freetype to version 2.3.11-2.</comment>
+		<comment>Updated GTK+ to version 2.18.7-1.</comment>
+		<comment>Updated LAME to version 3.98.3.</comment>
+		<comment>Updated libpng to version 1.4.0-1.</comment>
+		<comment>Updated NSPR to version 4.8.3.</comment>
+		<comment>Updated Pango to version 1.26.2-1.</comment>
+		<comment>Updated Qt to version 4.6.2.</comment>
+		<comment>Updated x264 to r1471.</comment>
+	</buildentry>
+	<buildentry revision="5869" date="2010-01-23">
+		<comment>Updated GLib to version 2.22.4-1.</comment>
+		<comment>Updated Qt to version 4.6.1.</comment>
+		<comment>Updated x264 to r1400.</comment>
+	</buildentry>
+	<buildentry revision="5830" date="2010-01-07">
+		<comment>Compiled with GCC 4.4.3 pre-release (r155431).</comment>
+	</buildentry>
+	<buildentry revision="5810" date="2010-01-02">
+	</buildentry>
+	<buildentry revision="5801" date="2009-12-31">
+	</buildentry>
+	<buildentry revision="5775" date="2009-12-29">
+	</buildentry>
+	<buildentry revision="5747" date="2009-12-28">
+	</buildentry>
+	<buildentry revision="5676" date="2009-12-20">
+		<comment>Packaged using NSIS 2.46.</comment>
+		<comment>Updated GTK+ to version 2.18.5-1.</comment>
+		<comment>Updated libpng to version 1.2.40-1.</comment>
+		<comment>Updated Pango to version 1.26.1-1.</comment>
+		<comment>Updated Qt to version 4.6.0.</comment>
+		<comment>Updated x264 to r1376.</comment>
+	</buildentry>
+	<buildentry revision="5660 [2.5.2 Final]" date="2009-12-19">
+	</buildentry>
+	<buildentry revision="5636 [2.5.2 RC1]" date="2009-12-12">
+	</buildentry>
+	<buildentry revision="5602" date="2009-11-30">
+	</buildentry>
+	<buildentry revision="5590" date="2009-11-28">
+		<comment>Updated Cairo to version 1.8.8-3.</comment>
+		<comment>Updated Fontconfig to version 2.8.0-1.</comment>
+		<comment>Updated Freetype to version 2.3.11-1.</comment>
+		<comment>Updated GLib to version 2.22.2-1.</comment>
+		<comment>Updated GTK+ to version 2.18.3-1.</comment>
+		<comment>Updated Pango to version 1.26.0-1.</comment>
+		<comment>Updated x264 to r1352.</comment>
+	</buildentry>
+	<buildentry revision="5567" date="2009-11-26">
+	</buildentry>
+	<buildentry revision="5558" date="2009-11-24">
+	</buildentry>
+	<buildentry revision="5546" date="2009-11-23">
+		<comment>Updated x264 to r1347.</comment>
+	</buildentry>
+	<buildentry revision="5530" date="2009-11-19">
+		<comment>Updated x264 to r1342.</comment>
+	</buildentry>
+	<buildentry revision="5422" date="2009-10-27">
+		<comment>Updated SDL to version 1.2.14.</comment>
+		<comment>Updated x264 to r1310.</comment>
+	</buildentry>
+	<buildentry revision="5369" date="2009-10-05">
+		<comment>Updated ATK to version 1.28.0-1.</comment>
+		<comment>Updated Fontconfig to version 2.7.3-1.</comment>
+		<comment>Updated GLib to version 2.22.1-1.</comment>
+		<comment>Updated GTK+ to version 2.18.1-1.</comment>
+		<comment>Updated libpng to version 1.2.39-1.</comment>
+		<comment>Updated Libxml2 to version 2.7.4-1.</comment>
+		<comment>Updated NSPR to version 4.8.</comment>
+		<comment>Updated opencore-amr to version 0.1.2.</comment>
+		<comment>Updated Qt to version 4.5.3.</comment>
+		<comment>Updated x264 to r1271.</comment>
+	</buildentry>
+	<buildentry revision="5341" date="2009-09-17">
+		<comment>Updated x264 to r1259.</comment>
+	</buildentry>
+	<buildentry revision="5327" date="2009-09-09">
+		<comment>Updated x264 to r1251.</comment>
+	</buildentry>
+	<buildentry revision="5281" date="2009-08-29">
+		<comment>Updated x264 to r1240.</comment>
+	</buildentry>
+	<buildentry revision="5273" date="2009-08-27">
+		<comment>Updated x264 to r1235.</comment>
+		<comment>Updated Xvid to version 1.2.2.</comment>
+	</buildentry>
+	<buildentry revision="5268" date="2009-08-23">
+		<comment>Updated x264 to r1222.</comment>
+	</buildentry>
+	<buildentry revision="5249 [2.5.1 Final]" date="2009-08-16">
+		<comment>Updated Fontconfig to version 2.7.1-2.</comment>
+	</buildentry>
+	<buildentry revision="5234" date="2009-08-12">
+		<comment>Updated Cairo to version 1.8.8-1.</comment>
+		<comment>Updated Fontconfig to version 2.7.1-1.</comment>
+		<comment>Updated Freetype to version 2.3.9-1.</comment>
+		<comment>Updated GLib to version 2.20.4-1.</comment>
+		<comment>Updated GTK+ to version 2.16.5-1.</comment>
+		<comment>Updated libpng to version 1.2.38-1.</comment>
+		<comment>Updated Pango to version 1.24.5-1.</comment>
+		<comment>Updated x264 to r1206.</comment>
+	</buildentry>
+	<buildentry revision="5204" date="2009-08-03">
+	</buildentry>
+	<buildentry revision="5181" date="2009-07-30">
+		<comment>Updated x264 to r1195.</comment>
+	</buildentry>
+	<buildentry revision="5152" date="2009-07-25">
+		<comment>Updated Avisynth Proxy GUI to version 2.09d.</comment>
+		<comment>Updated x264 to r1185.</comment>
+	</buildentry>
+	<buildentry revision="5104" date="2009-07-17">
+		<comment>Added opencore-amr version 0.1.1.</comment>
+		<comment>Updated x264 to r1183.</comment>
+	</buildentry>
+	<buildentry revision="5087" date="2009-07-13">
+	</buildentry>
+	<buildentry revision="5065" date="2009-07-12">
+		<comment>Updated Vorbis to version 1.2.3.</comment>
+		<comment>Updated x264 to r1181.</comment>
+	</buildentry>
+	<buildentry revision="5031" date="2009-07-10">
+		<comment>Recompiled FAAC with MinGW's GCC 4.2.1-sjlj-2.</comment>
+		<comment>Updated x264 to r1179.</comment>
+	</buildentry>
+	<buildentry revision="5010" date="2009-07-06">
+	</buildentry>
+	<buildentry revision="4997" date="2009-07-05">
+	</buildentry>
+	<buildentry revision="4992" date="2009-07-04">
+		<comment>Updated FAAC to version 1.28.</comment>
+		<comment>Updated FAAD2 to version 2.7.</comment>
+	</buildentry>
+	<buildentry revision="4968" date="2009-06-27">
+		<comment>Updated ATK to version 1.26.0-1.</comment>
+		<comment>Updated GLib to version 2.20.3-1.</comment>
+		<comment>Updated GTK+ to version 2.16.2-1.</comment>
+		<comment>Updated libpng to version 1.2.37-1.</comment>
+		<comment>Updated Ogg to version 1.1.4.</comment>
+		<comment>Updated Pango to version 1.24.2-1.</comment>
+		<comment>Updated Qt to version 4.5.2.</comment>
+		<comment>Updated Vorbis to version 1.2.2.</comment>
+		<comment>Updated x264 to r1173.</comment>
+	</buildentry>
+	<buildentry revision="4944 [2.5.0 Final]" date="2009-06-23">
+		<comment>Updated x264 to r1170.</comment>
+	</buildentry>
+	<buildentry revision="4871" date="2009-05-25">
+		<comment>Updated x264 to r1159.</comment>
+	</buildentry>
+	<buildentry revision="4763" date="2009-04-26">
+		<comment>Added Netscape Portable Runtime version 4.7.4.</comment>
+		<comment>Updated Pango to version 1.24.1-1.</comment>
+		<comment>Updated Qt to version 4.5.1.</comment>
+		<comment>Updated SpiderMonkey to version 1.7.0.</comment>
+	</buildentry>
+	<buildentry revision="4758" date="2009-04-22">
+		<comment>Updated Avisynth Proxy GUI to version 2.08.</comment>
+		<comment>Updated x264 to r1145.</comment>
+	</buildentry>
+	<buildentry revision="4741" date="2009-04-20">
+		<comment>Updated GLib to version 2.20.1-1.</comment>
+		<comment>Updated GTK+ to version 2.16.1-1.</comment>
+		<comment>Updated Pango to version 1.24.0-1.</comment>
+	</buildentry>
+	<buildentry revision="4685" date="2009-03-14">
+	</buildentry>
+	<buildentry revision="4658" date="2009-03-05">
+		<comment>Updated Qt to version 4.5.0.</comment>
+	</buildentry>
+	<buildentry revision="4648" date="2009-03-02">
+		<comment>Updated x264 to r1115.</comment>
+	</buildentry>
+	<buildentry revision="4629" date="2009-02-24">
+	</buildentry>
+	<buildentry revision="4618" date="2009-02-21">
+		<comment>Updated x264 to r1114.</comment>
+	</buildentry>
+	<buildentry revision="4609" date="2009-02-16">
+		<comment>Packaged using NSIS 2.43.</comment>
+		<comment>Updated Avisynth Proxy GUI to version 2.07 (2nd release).</comment>
+		<comment>Updated Libxml2 to version 2.7.3.</comment>
+		<comment>Updated x264 to r1113.</comment>
+	</buildentry>
 </log>

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2010-09-20 17:54:17 UTC (rev 6635)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2010-09-21 10:03:16 UTC (rev 6636)
@@ -364,11 +364,12 @@
 !endif
         SetOutPath $INSTDIR
         SetOverwrite on
-        ${File} QtGui4.dll
         ${File} avidemux2.exe
         ${File} libADM_render_qt4.dll
         ${File} libADM_UIQT4.dll
         ${File} QtCore4.dll
+		${File} QtGui4.dll
+		${File} QtOpenGL4.dll
     ${MementoSectionEnd}
 !endif
 SectionGroupEnd



From mean at mail.berlios.de  Wed Sep 22 07:49:22 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed, 22 Sep 2010 07:49:22 +0200
Subject: [Avidemux-svn-commit] r6637 - in branches/avidemux_2.6_branch_mean:
	avidemux/common/ADM_commonUI avidemux/common/ADM_render
	avidemux/qt4 avidemux/qt4/ADM_userInterfaces/ADM_gui
	avidemux_core/ADM_coreUI/include cmake
Message-ID: <20100922054922.87BCE480AF8@sheep.berlios.de>

Author: mean
Date: 2010-09-22 07:49:22 +0200 (Wed, 22 Sep 2010)
New Revision: 6637

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_sdlRender.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_vdpauRender.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_xvRender.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_preview.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/ADM_windowInfo.h
   branches/avidemux_2.6_branch_mean/cmake/config.h.cmake
Log:
[render] Merge gruntster openGl display from 2.5 (incomplete)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp	2010-09-21 10:03:16 UTC (rev 6636)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp	2010-09-22 05:49:22 UTC (rev 6637)
@@ -234,6 +234,9 @@
 #ifdef USE_VDPAU
                              ,{RENDER_VDPAU,   QT_TR_NOOP("VDPAU (best)"),NULL}
 #endif
+#ifdef USE_OPENGL
+                             ,{RENDER_QTOPENGL,   QT_TR_NOOP("Qt OpenGl (best)"),NULL}
+#endif
 
 #ifdef USE_SDL
 #ifdef __WIN32

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt	2010-09-21 10:03:16 UTC (rev 6636)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt	2010-09-22 05:49:22 UTC (rev 6637)
@@ -7,6 +7,9 @@
 GUI_xvRender.cpp
 GUI_vdpauRender.cpp
 )
+        IF (USE_OPENGL)
+                SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS} GUI_qtGlRender.cpp)
+        ENDIF (USE_OPENGL)
 
 IF (APPLE)
 	SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS} GUI_sdlRenderHelper.m)
@@ -14,6 +17,15 @@
 
 ADD_LIBRARY(${ADM_LIB} SHARED ${${ADM_LIB}_SRCS})
 TARGET_LINK_LIBRARIES( ${ADM_LIB} ADM_core6 ADM_coreUI6 ADM_coreImage6)
+
+ IF (USE_OPENGL)
+                ADD_SOURCE_CFLAGS(GUI_render.cpp " -I${QT_HEADERS_DIR}")
+                ADD_SOURCE_CFLAGS(GUI_qtGlRender.cpp " -I${QT_HEADERS_DIR} -I{OPENGL_INCLUDE_DIR}")
+                TARGET_LINK_LIBRARIES(${ADM_LIB} ${OPENGL_LIBRARIES} ${QT_QTOPENGL_LIBRARY})
+ ENDIF (USE_OPENGL)
+
+
+
 SDLify(GUI_sdlRender.cpp)
 IF (GETTEXT_FOUND)
         TARGET_LINK_LIBRARIES(${ADM_LIB}  ${GETTEXT_LIBRARY_DIR})
@@ -26,5 +38,4 @@
 IF (USE_VDPAU)
        TARGET_LINK_LIBRARIES(${ADM_LIB}  ADM_coreVDPAU6)
 ENDIF (USE_VDPAU)
-
 ADM_INSTALL_LIB(${ADM_LIB})

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.cpp	2010-09-21 10:03:16 UTC (rev 6636)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.cpp	2010-09-22 05:49:22 UTC (rev 6637)
@@ -38,6 +38,9 @@
 #include "GUI_vdpauRender.h"
 #endif
 
+#if defined (USE_OPENGL)
+extern VideoRenderBase *RenderSpawnQtGl(void);
+#endif
 #include "ADM_colorspace.h"
 #include "DIA_uiTypes.h"
 
@@ -243,6 +246,23 @@
         MUI_getWindowInfo(draw, &xinfo);
         switch(prefRenderer)
         {
+#if defined(USE_OPENGL)
+       case RENDER_QTOPENGL:
+                renderer=RenderSpawnQtGl();
+                r=renderer->init(&xinfo,phyW,phyH,lastZoom);
+                if(!r)
+                {
+                    delete renderer;
+                    renderer=NULL;
+                    ADM_warning("QtGl init failed\n");
+                }
+                else
+                {
+                    ADM_info("QtGl init ok\n");
+                }
+                break;
+#endif
+
 #if defined(USE_VDPAU)
        case RENDER_VDPAU:
                 renderer=new vdpauRender();
@@ -314,72 +334,7 @@
 */
 uint8_t renderStartPlaying( void )
 {
-#if 0
-char *displ;
-unsigned int renderI;
-ADM_RENDER_TYPE render;
-uint8_t r=0;
-	ADM_assert(!accel_mode);
-        
 
-        render=MUI_getPreferredRender();
-        GUI_WindowInfo xinfo;
-        MUI_getWindowInfo(draw, &xinfo);
-        switch(render)
-        {
-        
-#if defined(USE_XV)
-	       case RENDER_XV:
-		accel_mode=new XvAccelRender();
-                if(accel_mode->hasHwZoom()) r=accel_mode->init(&xinfo,phyW,phyH);
-                else r=accel_mode->init(&xinfo,renderW,renderH);
-                if(!r)
-		{
-			delete accel_mode;
-			accel_mode=NULL;
-			printf("Xv init failed\n");
-		}
-		else
-		{
-			printf("Xv init ok\n");
-		}
-                break;
-#endif
-
-#if defined(USE_SDL)
-			case RENDER_SDL:
-#ifdef __WIN32
-			case RENDER_DIRECTX:
-#endif
-				accel_mode=new sdlAccelRender();
-
-				if(accel_mode->hasHwZoom()) r=accel_mode->init(&xinfo,phyW,phyH);
-                else r=accel_mode->init(&xinfo,renderW,renderH);
-
-                if(!r)
-				{
-					delete accel_mode;
-					accel_mode=NULL;
-				}
-
-                break;
-#endif
-
-            default:break;
-        }
-
-        if(!accel_mode)
-        {
-                rgbConverter.changeWidthHeight(renderW,renderH);
-                printf("No accel used for rendering\n");
-        }
-        else
-        {
-           ADM_assert(!accelSurface);
-           accelSurface=new uint8_t[ (renderW*renderH*3)>>1];
-          
-        }
-#endif	
 	return 1;
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.h	2010-09-21 10:03:16 UTC (rev 6636)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.h	2010-09-22 05:49:22 UTC (rev 6637)
@@ -75,6 +75,9 @@
         RENDER_VDPAU=4,
 
 #endif
+#ifdef USE_OPENGL
+        RENDER_QTOPENGL=5,
+#endif
 
         RENDER_LAST       
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_sdlRender.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_sdlRender.h	2010-09-21 10:03:16 UTC (rev 6636)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_sdlRender.h	2010-09-22 05:49:22 UTC (rev 6637)
@@ -30,7 +30,7 @@
               virtual	bool stop(void);				
               virtual   bool displayImage(ADMImage *pic);
               virtual   bool changeZoom(renderZoom newZoom);
-              virtual   bool    usingUIRedraw(void) {return false;};
+              virtual   bool    usingUIRedraw(void) {return true;};
 };
 
 void initSdl(int videoDevice);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_vdpauRender.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_vdpauRender.h	2010-09-21 10:03:16 UTC (rev 6636)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_vdpauRender.h	2010-09-22 05:49:22 UTC (rev 6637)
@@ -34,7 +34,7 @@
               virtual   bool displayImage(ADMImage *pic);
               virtual   bool changeZoom(renderZoom newzoom);
               virtual   bool refresh(void);
-              virtual   bool usingUIRedraw(void) {return false;};
+              virtual   bool usingUIRedraw(void) {return false;}; // we can redraw by ourself
 };
 #endif
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_xvRender.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_xvRender.h	2010-09-21 10:03:16 UTC (rev 6636)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_xvRender.h	2010-09-22 05:49:22 UTC (rev 6637)
@@ -32,7 +32,7 @@
               virtual   bool displayImage(ADMImage *pic);
               virtual   bool changeZoom(renderZoom newzoom);
               virtual   bool refresh(void);
-              virtual   bool usingUIRedraw(void) {return false;};
+              virtual   bool usingUIRedraw(void) {return true;};
 };
 #endif
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_preview.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_preview.cpp	2010-09-21 10:03:16 UTC (rev 6636)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_preview.cpp	2010-09-22 05:49:22 UTC (rev 6637)
@@ -172,6 +172,7 @@
 {
     ADM_assert(videoWindow);
 	QWidget* widget = videoWindow->parentWidget();
+    xinfo->widget = videoWindow;
 
 #if defined(__WIN32)
 	xinfo->display=videoWindow->winId();

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-09-21 10:03:16 UTC (rev 6636)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-09-22 05:49:22 UTC (rev 6637)
@@ -17,6 +17,8 @@
 IF (NOT QT4_FOUND)
         MESSAGE(FATAL_ERROR "Qt4 NOT FOUND")
 ENDIF (NOT QT4_FOUND)
+# Qt4 openGL
+include(admCheckOpenGl)
 ##########################################
 # Config
 ##########################################

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/ADM_windowInfo.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/ADM_windowInfo.h	2010-09-21 10:03:16 UTC (rev 6636)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/ADM_windowInfo.h	2010-09-22 05:49:22 UTC (rev 6637)
@@ -1,3 +1,16 @@
+/**
+
+
+*/
+
+/***************************************************************************
+*                                                                         *
+*   This program is free software; you can redistribute it and/or modify  *
+*   it under the terms of the GNU General Public License as published by  *
+*   the Free Software Foundation; either version 2 of the License, or     *
+*   (at your option) any later version.                                   *
+*                                                                         *
+***************************************************************************/
 #ifndef ADM_WINDOW_INFO_H
 #define ADM_WINDOW_INFO_H
 typedef struct
@@ -3,4 +16,5 @@
 {
     void *display;
+    void *widget;
     int  window;
     int x;

Modified: branches/avidemux_2.6_branch_mean/cmake/config.h.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/config.h.cmake	2010-09-21 10:03:16 UTC (rev 6636)
+++ branches/avidemux_2.6_branch_mean/cmake/config.h.cmake	2010-09-22 05:49:22 UTC (rev 6637)
@@ -74,5 +74,10 @@
 
 #define QT_TR_NOOP(String) translate (PACKAGE, String)
 // FIXME - end
+#if ${CONFIG_HEADER_TYPE} == ADM_BUILD_QT4
+/* OpenGL detected */
+#cmakedefine USE_OPENGL
+#endif
 
+
 #endif



From mean at mail.berlios.de  Wed Sep 22 07:49:23 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed, 22 Sep 2010 07:49:23 +0200
Subject: [Avidemux-svn-commit] r6638 - in branches/avidemux_2.6_branch_mean:
	avidemux/common/ADM_render cmake
Message-ID: <20100922054923.F1567480AF8@sheep.berlios.de>

Author: mean
Date: 2010-09-22 07:49:23 +0200 (Wed, 22 Sep 2010)
New Revision: 6638

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.h
   branches/avidemux_2.6_branch_mean/cmake/admCheckOpenGl.cmake
Log:
[QtGl] Avoid duplicating image, add forgotten files

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.cpp	2010-09-22 05:49:23 UTC (rev 6638)
@@ -0,0 +1,314 @@
+/***************************************************************************
+    copyright            : (C) 2010 by gruntster
+***************************************************************************/
+
+/***************************************************************************
+*                                                                         *
+*   This program is free software; you can redistribute it and/or modify  *
+*   it under the terms of the GNU General Public License as published by  *
+*   the Free Software Foundation; either version 2 of the License, or     *
+*   (at your option) any later version.                                   *
+*                                                                         *
+***************************************************************************///
+#define GL_GLEXT_PROTOTYPES
+
+#include <QtGui/QPainter>
+
+#ifdef __APPLE__
+#	include <OpenGL/gl.h>
+#	include <OpenGL/glext.h>
+#	define GL_TEXTURE_RECTANGLE_NV GL_TEXTURE_RECTANGLE_EXT
+#else
+#	include <GL/gl.h>
+#	include <GL/glext.h>
+#endif
+#define ADM_LEGACY_PROGGY // Dont clash with free/malloc etc..
+#include "ADM_default.h"
+#include "GUI_render.h"
+
+#include "GUI_accelRender.h"
+#include "GUI_qtGlRender.h"
+
+static const char *yuvToRgb =
+	"#extension GL_ARB_texture_rectangle: enable\n"
+	"uniform sampler2DRect texY, texU, texV;\n"
+	"uniform float height;\n"
+
+	"void main(void) {\n"
+	"  float nx = gl_TexCoord[0].x;\n"
+	"  float ny = height - gl_TexCoord[0].y;\n"
+	"  float y = texture2DRect(texY, vec2(nx, ny)).r;\n"
+	"  float u = texture2DRect(texU, vec2(nx / 2.0, ny / 2.0)).r;\n"
+	"  float v = texture2DRect(texV, vec2(nx / 2.0, ny / 2.0)).r;\n"
+
+	"  y = 1.1643 * (y - 0.0625);\n"
+	"  u = u - 0.5;\n"
+	"  v = v - 0.5;\n"
+
+	"  float r = y + 1.5958 * v;\n"
+	"  float g = y - 0.39173 * u - 0.81290 * v;\n"
+	"  float b = y + 2.017 * u;\n"
+
+	"  gl_FragColor = vec4(r, g, b, 1.0);\n"
+	"}\n";
+
+/**
+
+*/
+
+QtGlAccelWidget::QtGlAccelWidget(QWidget *parent, int w, int h) : QGLWidget(parent)
+{
+	memset(textureRealWidths, 0, sizeof(textureRealWidths));
+    memset(textureStrides, 0, sizeof(textureStrides));
+	memset(textureHeights, 0, sizeof(textureHeights));
+	memset(textureOffsets, 0, sizeof(textureOffsets));
+
+	imageWidth = w;
+	imageHeight = h;
+	firstRun = true;
+	glProgram = NULL;
+}
+/**
+
+*/
+bool QtGlAccelWidget::setDisplaySize(int width,int height)
+{
+    displayWidth=width;
+    displayHeight=height;
+    resize(displayWidth,displayHeight);
+    return true;
+}
+/**
+
+*/
+QtGlAccelWidget::~QtGlAccelWidget()
+{
+}
+/**
+
+*/
+
+bool QtGlAccelWidget::setImage(ADMImage *pic)
+{
+    int imageWidth=pic->_width;
+    int imageHeight=pic->_height;
+
+    
+	this->imageWidth = imageWidth;
+	this->imageHeight = imageHeight;
+
+	textureRealWidths[0] = imageWidth;
+    textureStrides[0]=pic->GetPitch(PLANAR_Y);
+	textureHeights[0] = imageHeight;
+	textureOffsets[0] = pic->GetReadPtr(PLANAR_Y);
+
+	textureRealWidths[1] = imageWidth / 2;
+    textureStrides[1]=pic->GetPitch(PLANAR_V);
+	textureHeights[1] = imageHeight / 2;
+	textureOffsets[1] = pic->GetReadPtr(PLANAR_V);
+
+	
+	textureRealWidths[2] = imageWidth / 2;
+    textureStrides[2]=pic->GetPitch(PLANAR_U);
+	textureHeights[2] = imageHeight / 2;
+	textureOffsets[2] = pic->GetReadPtr(PLANAR_U);
+
+    updateTexture();
+
+    return true;
+}
+/**
+
+*/
+void QtGlAccelWidget::initializeGL()
+{
+	int success = 1;
+
+#ifndef QT_OPENGL_ES
+	glActiveTexture = (_glActiveTexture)this->context()->getProcAddress(QLatin1String("glActiveTexture"));
+
+	if (!glActiveTexture)
+	{
+		success = 0;
+		printf("[GL Render] Active Texture function not found!\n");
+	}
+#endif
+
+	printf("[GL Render] OpenGL Vendor: %s\n", glGetString(GL_VENDOR));
+	printf("[GL Render] OpenGL Renderer: %s\n", glGetString(GL_RENDERER));
+	printf("[GL Render] OpenGL Version: %s\n", glGetString(GL_VERSION));
+	printf("[GL Render] OpenGL Extensions: %s\n", glGetString(GL_EXTENSIONS));
+
+	glProgram = new QGLShaderProgram(this);
+
+	if (success && !glProgram->addShaderFromSourceCode(QGLShader::Fragment, yuvToRgb))
+	{
+		success = 0;
+		printf("[GL Render] Fragment log: %s\n", glProgram->log().toUtf8().constData());
+	}
+
+	if (success && !glProgram->link())
+	{
+		success = 0;
+		printf("[GL Render] Link log: %s\n", glProgram->log().toUtf8().constData());
+	}
+
+	if (success && !glProgram->bind())
+	{
+		success = 0;
+		printf("[GL Render] Binding FAILED\n");
+	}
+
+	glProgram->setUniformValue("texY", 0);
+	glProgram->setUniformValue("texU", 1);
+	glProgram->setUniformValue("texV", 2);
+}
+/**
+
+*/
+void QtGlAccelWidget::updateTexture()
+{
+	if (!textureOffsets[0])
+	{
+		printf("[Render] Buffer not set\n");
+		return;
+	}
+
+	if (firstRun)
+	{
+		glViewport(0, 0, width(), height());
+		glMatrixMode(GL_PROJECTION);
+		glLoadIdentity();
+		glOrtho(0, width(), 0, height(), -1, 1);
+		glProgram->setUniformValue("height", (float)imageHeight);
+	}
+
+	// U
+	glActiveTexture(GL_TEXTURE1);
+	glBindTexture(GL_TEXTURE_RECTANGLE_NV, 1);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
+	glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
+
+	if (firstRun)
+		glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, textureStrides[1], textureHeights[1], 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, textureOffsets[1]);
+	else
+		glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, textureStrides[1], textureHeights[1], GL_LUMINANCE, GL_UNSIGNED_BYTE, textureOffsets[1]);
+
+	// V
+	glActiveTexture(GL_TEXTURE2);
+	glBindTexture(GL_TEXTURE_RECTANGLE_NV, 2);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
+	glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
+
+	if (firstRun)
+		glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, textureStrides[2], textureHeights[2], 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, textureOffsets[2]);
+	else
+		glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, textureStrides[2], textureHeights[2], GL_LUMINANCE, GL_UNSIGNED_BYTE, textureOffsets[2]);
+
+	// Y
+	glActiveTexture(GL_TEXTURE0);
+	glBindTexture(GL_TEXTURE_RECTANGLE_NV, 3);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
+	glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
+
+	if (firstRun)
+	{
+		glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, textureStrides[0], textureHeights[0], 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, textureOffsets[0]);
+		firstRun = false;
+	}
+	else
+		glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, textureStrides[0], textureHeights[0], GL_LUMINANCE, GL_UNSIGNED_BYTE, textureOffsets[0]);
+}
+/**
+
+*/
+void QtGlAccelWidget::paintGL()
+{
+	glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+	glBegin(GL_QUADS);
+	glTexCoord2i(0, 0);
+	glVertex2i(0, 0);
+	glTexCoord2i(imageWidth, 0);
+	glVertex2i(width(), 0);
+	glTexCoord2i(imageWidth, imageHeight);
+	glVertex2i(width(), height());
+	glTexCoord2i(0, imageHeight);
+	glVertex2i(0, height());
+	glEnd();
+}
+/**
+    \fn ctor
+*/
+QtGlRender::QtGlRender(void)
+{
+	glWidget = NULL;
+
+}
+/**
+    \fn stop
+*/
+
+bool QtGlRender::stop(void)
+{
+	printf("[GL Render] Renderer closed\n");
+
+	if (glWidget)
+		delete glWidget;
+    glWidget=NULL;
+}
+/**
+    \fn init
+*/
+
+bool QtGlRender::init( GUI_WindowInfo *  window, uint32_t w, uint32_t h,renderZoom zoom)
+{
+	printf("[GL Render] Initialising renderer\n");
+    baseInit(w,h,zoom);
+	glWidget = new QtGlAccelWidget((QWidget*)window->widget, w, h);
+    glWidget->setDisplaySize(displayWidth,displayHeight);
+	glWidget->show();
+	return QGLFormat::hasOpenGL() && QGLShaderProgram::hasOpenGLShaderPrograms();
+}
+/**
+    \fn displayImage
+*/
+bool QtGlRender::displayImage(ADMImage *pic)
+{
+	glWidget->setImage(pic);
+	glWidget->repaint();
+	return true;
+}
+/**
+    \fn changeZoom
+*/
+bool QtGlRender::changeZoom(renderZoom newZoom)
+{
+    ADM_info("changing zoom, qtGl render.\n");
+    calcDisplayFromZoom(newZoom);
+    currentZoom=newZoom;
+    glWidget->setDisplaySize(displayWidth,displayHeight);
+    glWidget->repaint();
+    return true;
+}
+/**
+    \fn refresh
+*/      
+bool    QtGlRender::refresh(void)   
+{
+    glWidget->repaint();
+	return true;
+}
+VideoRenderBase *RenderSpawnQtGl(void)
+{
+    return new QtGlRender();
+}
+// EOF
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.h	2010-09-22 05:49:23 UTC (rev 6638)
@@ -0,0 +1,73 @@
+/***************************************************************************
+    copyright            : (C) 2010 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef GUI_QTGLRENDER_H
+#define GUI_QTGLRENDER_H
+
+#include <QtOpenGL/QGLWidget>
+#include <QtOpenGL/QGLShader>
+
+#include "GUI_render.h"
+#include "GUI_accelRender.h"
+#include "ADM_colorspace.h"
+
+class QtGlAccelWidget : public QGLWidget
+{
+private:
+	int             imageWidth, imageHeight;
+    int             displayWidth,displayHeight;
+	bool            firstRun;
+
+	QGLShaderProgram *glProgram;
+	GLsizei textureRealWidths[3];
+    GLsizei textureStrides[3];
+	GLsizei textureHeights[3];
+	uint8_t *textureOffsets[3];
+
+#ifndef QT_OPENGL_ES
+	typedef void (*_glActiveTexture) (GLenum);
+	_glActiveTexture glActiveTexture;
+#endif
+
+protected:
+	void initializeGL();
+	void paintGL();
+    void updateTexture(void);
+
+public:
+	QtGlAccelWidget(QWidget *parent, int imagew, int imageh);
+    ~QtGlAccelWidget();
+	bool setImage(ADMImage *pic);
+    bool setDisplaySize(int width,int height);
+};
+
+/**
+    \fn class XvRender
+*/
+class QtGlRender: public VideoRenderBase
+{
+      protected:
+                            
+                            GUI_WindowInfo  info;
+                            QtGlAccelWidget *glWidget;
+      public:
+                             QtGlRender( void ) ;
+                             ~QtGlRender();
+              virtual	bool init( GUI_WindowInfo *  window, uint32_t w, uint32_t h,renderZoom zoom);
+              virtual	bool stop(void);				
+              virtual   bool displayImage(ADMImage *pic);
+              virtual   bool changeZoom(renderZoom newzoom);
+              virtual   bool refresh(void);
+              virtual   bool usingUIRedraw(void) {return false;}; // We can! redraw by ourself
+};
+
+#endif

Added: branches/avidemux_2.6_branch_mean/cmake/admCheckOpenGl.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admCheckOpenGl.cmake	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/cmake/admCheckOpenGl.cmake	2010-09-22 05:49:23 UTC (rev 6638)
@@ -0,0 +1,31 @@
+########################################
+# OpenGL
+########################################
+OPTION(OPENGL "" ON)
+
+MESSAGE(STATUS "Checking for OpenGL")
+MESSAGE(STATUS "*******************")
+
+IF (OPENGL)
+       IF (QT4_FOUND AND QT_VERSION_MINOR GREATER 5)
+               IF (QT_QTOPENGL_FOUND)
+                       MESSAGE(STATUS "Found QtOpenGL")
+                       FIND_PACKAGE(OpenGL)
+                       PRINT_LIBRARY_INFO("OpenGL" OPENGL_FOUND "${OPENGL_INCLUDE_DIR}" "${OPENGL_LIBRARIES}")
+               ELSE (QT_QTOPENGL_FOUND)
+                       MESSAGE(STATUS "QtOpenGL was not found")
+               ENDIF (QT_QTOPENGL_FOUND)
+       ELSE (QT4_FOUND AND QT_VERSION_MINOR GREATER 5)
+               MESSAGE(STATUS "OpenGL is only available for Qt 4.6 or later ${QT_VERSION_MINOR}")
+       ENDIF (QT4_FOUND AND QT_VERSION_MINOR GREATER 5)
+
+       IF (OPENGL_FOUND)
+               SET(USE_OPENGL 1)
+       ENDIF (OPENGL_FOUND)
+ELSE (OPENGL)
+       MESSAGE("${MSG_DISABLE_OPTION}")
+ENDIF (OPENGL)
+
+MESSAGE("")
+
+



From gruntster at mail.berlios.de  Sat Sep 25 11:44:46 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 25 Sep 2010 11:44:46 +0200
Subject: [Avidemux-svn-commit] r6639 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec
Message-ID: <20100925094446.C376B480FCF@sheep.berlios.de>

Author: gruntster
Date: 2010-09-25 11:44:46 +0200 (Sat, 25 Sep 2010)
New Revision: 6639

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/png.h
Log:
[ffmpeg] add missing png header file (referenced by dsputil.c)

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/png.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/png.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/png.h	2010-09-25 09:44:46 UTC (rev 6639)
@@ -0,0 +1,78 @@
+/*
+ * PNG image format
+ * Copyright (c) 2003 Fabrice Bellard
+ *
+ * This file is part of FFmpeg.
+ *
+ * FFmpeg is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * FFmpeg is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with FFmpeg; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
+ */
+
+#ifndef AVCODEC_PNG_H
+#define AVCODEC_PNG_H
+
+#include <stdint.h>
+
+#define PNG_COLOR_MASK_PALETTE    1
+#define PNG_COLOR_MASK_COLOR      2
+#define PNG_COLOR_MASK_ALPHA      4
+
+#define PNG_COLOR_TYPE_GRAY 0
+#define PNG_COLOR_TYPE_PALETTE  (PNG_COLOR_MASK_COLOR | PNG_COLOR_MASK_PALETTE)
+#define PNG_COLOR_TYPE_RGB        (PNG_COLOR_MASK_COLOR)
+#define PNG_COLOR_TYPE_RGB_ALPHA  (PNG_COLOR_MASK_COLOR | PNG_COLOR_MASK_ALPHA)
+#define PNG_COLOR_TYPE_GRAY_ALPHA (PNG_COLOR_MASK_ALPHA)
+
+#define PNG_FILTER_TYPE_LOCO   64
+#define PNG_FILTER_VALUE_NONE  0
+#define PNG_FILTER_VALUE_SUB   1
+#define PNG_FILTER_VALUE_UP    2
+#define PNG_FILTER_VALUE_AVG   3
+#define PNG_FILTER_VALUE_PAETH 4
+#define PNG_FILTER_VALUE_MIXED 5
+
+#define PNG_IHDR      0x0001
+#define PNG_IDAT      0x0002
+#define PNG_ALLIMAGE  0x0004
+#define PNG_PLTE      0x0008
+
+#define NB_PASSES 7
+
+extern const uint8_t ff_pngsig[8];
+extern const uint8_t ff_mngsig[8];
+
+/* Mask to determine which y pixels are valid in a pass */
+extern const uint8_t ff_png_pass_ymask[NB_PASSES];
+
+/* minimum x value */
+extern const uint8_t ff_png_pass_xmin[NB_PASSES];
+
+/* x shift to get row width */
+extern const uint8_t ff_png_pass_xshift[NB_PASSES];
+
+/* Mask to determine which pixels are valid in a pass */
+extern const uint8_t ff_png_pass_mask[NB_PASSES];
+
+void *ff_png_zalloc(void *opaque, unsigned int items, unsigned int size);
+
+void ff_png_zfree(void *opaque, void *ptr);
+
+int ff_png_get_nb_channels(int color_type);
+
+/* compute the row size of an interleaved pass */
+int ff_png_pass_row_size(int pass, int bits_per_pixel, int width);
+
+void ff_add_png_paeth_prediction(uint8_t *dst, uint8_t *src, uint8_t *top, int w, int bpp);
+
+#endif /* AVCODEC_PNG_H */



From gruntster at mail.berlios.de  Sat Sep 25 12:02:51 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 25 Sep 2010 12:02:51 +0200
Subject: [Avidemux-svn-commit] r6640 - in branches/avidemux_2.6_branch_mean:
	avidemux/cli avidemux/gtk avidemux/qt4
	avidemux_core/ADM_coreVideoCodec/include
	avidemux_core/ADM_coreVideoCodec/src
	avidemux_core/ADM_ffmpeg/ffmpeg_config
	avidemux_core/ADM_ffmpeg/libavcodec cmake
Message-ID: <20100925100251.49A69480FCF@sheep.berlios.de>

Author: gruntster
Date: 2010-09-25 12:02:51 +0200 (Sat, 25 Sep 2010)
New Revision: 6640

Removed:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_png.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_png.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_ffmp43.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_codecSearch.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/cmake/admCheckRequiredLibs.cmake
   branches/avidemux_2.6_branch_mean/cmake/config.h.cmake
Log:
[png] use ffmpeg to decode png so libpng isn't needed (port from 2.4)

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt	2010-09-25 10:02:51 UTC (rev 6640)
@@ -77,13 +77,7 @@
 IF (GETTEXT_FOUND)
 	TARGET_LINK_LIBRARIES(avidemux3_cli ${GETTEXT_LIBRARY_DIR})
 ENDIF (GETTEXT_FOUND)
-# PNG
-IF (USE_PNG)
-        TARGET_LINK_LIBRARIES(avidemux3_cli ${PNG_LIBRARIES})
-	
-ENDIF (USE_PNG)
 
-
 # XVideo
 IF (USE_XV)
         TARGET_LINK_LIBRARIES(avidemux3_cli ${XVIDEO_LIBRARY_DIR})

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt	2010-09-25 10:02:51 UTC (rev 6640)
@@ -83,13 +83,7 @@
 IF (GETTEXT_FOUND)
 	TARGET_LINK_LIBRARIES(avidemux3_gtk ${GETTEXT_LIBRARY_DIR})
 ENDIF (GETTEXT_FOUND)
-# PNG
-IF (USE_PNG)
-        TARGET_LINK_LIBRARIES(avidemux3_gtk ${PNG_LIBRARIES})
-	
-ENDIF (USE_PNG)
 
-
 # XVideo
 IF (USE_XV)
         TARGET_LINK_LIBRARIES(avidemux3_gtk ${XVIDEO_LIBRARY_DIR})

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-09-25 10:02:51 UTC (rev 6640)
@@ -104,14 +104,6 @@
 	TARGET_LINK_LIBRARIES(avidemux3_qt4 ${GETTEXT_LIBRARY_DIR})
 ENDIF (GETTEXT_FOUND)
 
-
-# PNG
-IF (USE_PNG)
-        TARGET_LINK_LIBRARIES(avidemux3_qt4 ${PNG_LIBRARIES})
-	
-ENDIF (USE_PNG)
-
-
 # XVideo
 IF (USE_XV)
         TARGET_LINK_LIBRARIES(avidemux3_qt4 ${XVIDEO_LIBRARY_DIR})

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_ffmp43.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_ffmp43.h	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_ffmp43.h	2010-09-25 10:02:51 UTC (rev 6640)
@@ -132,8 +132,12 @@
   decoderFF_ffhuff (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp);
 };
 
+class decoderFFPng : public decoderFF
+{
+public:
+	decoderFFPng(uint32_t w, uint32_t h, uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData, uint32_t bpp);
+};
 
-
 #endif
 
 // EOF

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_png.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_png.h	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_png.h	2010-09-25 10:02:51 UTC (rev 6640)
@@ -1,65 +0,0 @@
-/***************************************************************************
-                          ADM_png  -  description
-                             -------------------
-    copyright            : (C) 2005 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
- 
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/ 
-#ifndef PNG_H_A
-#define PNG_H_A
-
-/**
-    \struct memAccess   
-    \brief png io wrapper
-*/
-typedef struct memAccess 
-{
-  
-int size;   
-int cur;
-uint8_t * data;
-} memAccess;
-
-/**
-    \class decoderPng
-*/
-class decoderPng:public decoders 
-{
-
-protected:
-    memAccess io;      
-    ADM_colorspace colorspace;
-    void *png_ptr;
-    void *info_ptr;
-    void *end_info;
-    uint8_t ** rows;      
-    uint8_t * decoded;
-    void Init (void);
-    void Cleanup (void);
-    void recalc (void);
-
-public:
-            decoderPng (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp);
-  
-    virtual ~ decoderPng ();
-  
-    virtual bool uncompress(ADMCompressedImage * in, ADMImage * out);
-  
-    bool dontcopy (void)
-            {
-                return true;
-            }
-    virtual const char *getDecoderName(void) {return "Png";}
-};
-
-#endif 
-//EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_codecSearch.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_codecSearch.cpp	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_codecSearch.cpp	2010-09-25 10:02:51 UTC (rev 6640)
@@ -32,7 +32,6 @@
 #include "ADM_codecNull.h"
 #include "ADM_rgb16.h"
 #include "ADM_uyvy.h"
-#include "ADM_png.h"
 #include "ADM_codecEmpty.h"
 #include "ADM_ffmp43.h"
 #include "ADM_codecFFsimple.h"
@@ -62,7 +61,7 @@
     }
   if (fourCC::check (fcc, (uint8_t *) "PNG "))
     {
-      return (decoders *) (new decoderPng (w,h,fcc,extraLen,extraData,bpp));
+      return (decoders *) (new decoderFFPng (w,h,fcc,extraLen,extraData,bpp));
     }
   if (fourCC::check (fcc, (uint8_t *) "FFVH"))
     {

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2010-09-25 10:02:51 UTC (rev 6640)
@@ -1,613 +1,618 @@
-/***************************************************************************
-    \file ADM_ffmp43
-    \brief Decoders using lavcodec
-    \author mean & all (c) 2002-2010
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-extern "C" {
-#include "ADM_lavcodec.h"
-}
-#include "ADM_default.h"
-
-#include "ADM_codec.h"
-#include "ADM_ffmp43.h"
-#include "DIA_coreToolkit.h"
-//#include "ADM_videoInfoExtractor.h"
-
-extern int ADM_cpu_num_processors(void);
-extern "C"
-{
-    static void ADM_releaseBuffer(struct AVCodecContext *avctx, AVFrame *pic);
-    static int  ADM_getBuffer(AVCodecContext *avctx, AVFrame *pic);
-}
-
-#define aprintf(...) {}
-
-#define WRAP_Open_Template(funcz,argz,display,codecid) \
-{\
-AVCodec *codec=funcz(argz);\
-if(!codec) {GUI_Error_HIG("Codec",QT_TR_NOOP("Internal error finding codec"display));ADM_assert(0);} \
-  codecId=codecid; \
-  _context->workaround_bugs=1*FF_BUG_AUTODETECT +0*FF_BUG_NO_PADDING; \
-  _context->error_concealment=3; \
-  if (avcodec_open(_context, codec) < 0)  \
-                      { \
-                                        printf("[lavc] Decoder init: "display" video decoder failed!\n"); \
-                                        GUI_Error_HIG("Codec","Internal error opening "display); \
-                                        ADM_assert(0); \
-                                } \
-                                else \
-                                { \
-                                        printf("[lavc] Decoder init: "display" video decoder initialized! (%s)\n",codec->long_name); \
-                                } \
-}
-
-#define WRAP_Open(x)            {WRAP_Open_Template(avcodec_find_decoder,x,#x,x);}
-#define WRAP_OpenByName(x,y)    {WRAP_Open_Template(avcodec_find_decoder_by_name,#x,#x,y);}
-
-
-//****************************
-extern uint8_t DIA_lavDecoder (uint32_t * swapUv, uint32_t * showU);
-extern "C"
-{
-  int av_is_voppacked (AVCodecContext * avctx, int *vop_packed, int *gmc,
-		       int *qpel);
-};
-/**
-    \fn clonePic
-    \brief Convert AvFrame to ADMImage
-*/
-uint8_t decoderFF::clonePic (AVFrame * src, ADMImage * out)
-{
-  uint32_t    u,v;
-  ADM_assert(out->isRef());
-  ADMImageRef *ref=out->castToRef();
-  ref->_planes[0] = (uint8_t *) src->data[0];
-  ref->_planeStride[0] = src->linesize[0];
-  if (_swapUV)
-    {
-      u = 1;
-      v = 2;
-    }
-  else
-    {
-      u = 2;
-      v = 1;
-    }
-  ref->_planes[1] = (uint8_t *) src->data[u];
-  ref->_planeStride[1] = src->linesize[u];
-
-  ref->_planes[2] = (uint8_t *) src->data[v];
-  ref->_planeStride[2] = src->linesize[v];
-
-  _lastQ = 0;			//_context->quality;
-  out->_Qp = (src->quality * 32) / FF_LAMBDA_MAX;
-  out->flags = frameType ();
-
-  // Quant ?
-  if (src->qstride && src->qscale_table && codecId != CODEC_ID_H264)
-    {
-      out->quant = (uint8_t *) src->qscale_table;
-      out->_qStride = src->qstride;
-      out->_qSize = (_w + 15) >> 4;
-      out->_qSize *= (_h + 15) >> 4;	// FixME?
-    }
-  else
-    {
-      out->_qSize = out->_qStride = 0;
-      out->quant = NULL;
-    }
-    //printf("[LAVC] Old pts :%"LLD" new pts :%"LLD"\n",out->Pts, (uint64_t)(src->reordered_opaque));
-    //printf("[LAVC] pts: %"LLU"\n",src->pts);
-    out->Pts= (uint64_t)(src->reordered_opaque);
- 
-    return 1;
-}
-/**
-        \fn decoderMultiThread
-        \brief Enabled multitheaded decoder if possible
-*/
-void decoderFF::decoderMultiThread (void)
-{
-  uint32_t threads = 0;
-
- // prefs->get(FEATURE_THREADING_LAVC, &threads);
-#warning Fixme
-    threads=1;
-  if (threads == 0)
-	  threads = ADM_cpu_num_processors();
-
-  if (threads == 1)
-	  threads = 0;
-
-  if (threads)
-  {
-      printf ("[lavc] Enabling MT decoder with %u threads\n", threads);
-
-      if (avcodec_thread_init (_context, threads) == -1)
-	      printf ("[lavc] Failed!!\n");
-	  else
-          _usingMT = 1;
-  }
-}
-uint8_t decoderFF::getPARWidth (void)
-{
-  if(!_context->sample_aspect_ratio.num) return 1;
-  return _context->sample_aspect_ratio.num;
-}
-uint8_t decoderFF::getPARHeight (void)
-{
-  if(!_context->sample_aspect_ratio.den) return 1;
-  return _context->sample_aspect_ratio.den;
-
-}
-
-//________________________________________________
-bool  decoderFF::setParam (void)
-{
-  DIA_lavDecoder (&_swapUV, &_showMv);
-  return true;			// no param for ffmpeg
-}
-
-//-------------------------------
-decoderFF::decoderFF (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp)
-            :decoders (w, h,fcc,extraDataLen,extraData,bpp)
-{
-  codecId = 0;
-//                              memset(&_context,0,sizeof(_context));
-  _allowNull = 0;
-  _gmc = 0;
-  _context = NULL;
-  _refCopy = 0;
-  _usingMT = 0;
-#if LIBAVCODEC_BUILD >= 4624
-  _context = avcodec_alloc_context ();
-#else
-  _context = new AVCodecContext;
-  memset (_context, 0, sizeof (AVCodecContext));
-#endif
-  ADM_assert (_context);
-  memset (&_frame, 0, sizeof (_frame));
-
-  _context->max_b_frames = 0;
-
-  _context->width = _w;
-  _context->height = _h;
-  _context->pix_fmt = PIX_FMT_YUV420P;	//PIX_FMT_RGBA32
-  //_context->debug=1;
-
-  _internalBuffer = new uint8_t[w * h * 3];
-
-  _swapUV = 0;
-  //_context->strict_std_compliance=-1;
-
-  _showMv = 0;
-#define FF_SHOW		(FF_DEBUG_VIS_MV_P_FOR+	FF_DEBUG_VIS_MV_B_FOR+FF_DEBUG_VIS_MV_B_BACK)
-//#define FF_SHOW               (FF_DEBUG_VIS_MV_P_FOR)
-  printf ("[lavc] Build: %d\n", LIBAVCODEC_BUILD);
-  _context->debug_mv |= FF_SHOW;
-  _context->debug |= FF_DEBUG_VIS_MB_TYPE + FF_DEBUG_VIS_QP;
-  
-}
-
-//_____________________________________________________
-
-decoderFF::~decoderFF ()
-{
-  if (_usingMT)
-    {
-      printf ("[lavc] Killing decoding threads\n");
-      avcodec_thread_free (_context);
-      _usingMT = 0;
-    }
-
-  avcodec_close (_context);
-  ADM_dealloc (_context);
-  delete[]_internalBuffer;
-  printf ("[lavc] Destroyed\n");
-}
-
-/**
-    \fn frameType
-    \return frametype of the last decoded frame
-*/
-uint32_t decoderFF::frameType (void)
-{
-  uint32_t
-    flag = 0;
-
-  AVFrame *
-    target;
-#define SET(x) {flag=x;aprintf("Frame is %s\n",#x);}
-
-
-  target = &_frame;
-  switch (target->pict_type)
-    {
-    case FF_B_TYPE:
-      SET (AVI_B_FRAME);
-      if (target->key_frame)
-	aprintf ("\n But keyframe is set\n");
-      break;
-
-    case FF_I_TYPE:
-      SET (AVI_KEY_FRAME);
-      if (!target->key_frame)
-	{
-	  if (codecId == CODEC_ID_H264)
-	    {
-	      SET (AVI_P_FRAME);
-	    }
-	  else
-	    printf ("\n But keyframe is not set\n");
-	}
-      break;
-    case FF_S_TYPE:
-      _gmc = 1;			// No break, just inform that gmc is there
-    case FF_P_TYPE:
-      SET (AVI_P_FRAME);
-      if (target->key_frame)
-	aprintf ("\n But keyframe is set\n");
-      break;
-    default:
-//                              printf("\n OOops XXX frame ?\n");
-      break;
-    }
-    flag&=~AVI_STRUCTURE_TYPE_MASK;
-    if(target->interlaced_frame)
-    {
-        flag|=AVI_FIELD_STRUCTURE;
-        if(target->top_field_first)
-            flag|=AVI_TOP_FIELD;
-        else
-            flag|=AVI_BOTTOM_FIELD;
-    }
-  return flag;
-}
-bool decoderFF::decodeHeaderOnly (void)
-{
-  if (codecId == CODEC_ID_H264)
-    _context->hurry_up = 4;
-  else
-    _context->hurry_up = 5;
-  printf ("\n[lavc] Hurry up\n");
-  return 1;
-}
-bool decoderFF::decodeFull (void)
-{
-  _context->hurry_up = 0;
-  printf ("\n[lavc] full decoding\n");
-  return 1;
-}
-
-/**
-    \fn flush
-    \brief empty internal buffer
-*/
-bool    decoderFF::flush(void)
-{
-    if(_context)
-        avcodec_flush_buffers(_context);
-    return true;
-}
-/**
-    \fn uncompress
-    \brief Actually decode an image
-*/
-bool   decoderFF::uncompress (ADMCompressedImage * in, ADMImage * out)
-{
-  int got_picture = 0;
-  uint8_t *oBuff[3];
-  int strideTab[3];
-  int strideTab2[3];
-  int ret = 0;
-  out->_noPicture = 0;
-  if (_showMv)
-    {
-      _context->debug_mv |= FF_SHOW;
-      _context->debug |= 0;	//FF_DEBUG_VIS_MB_TYPE;
-    }
-  else
-    {
-      _context->debug_mv &= ~FF_SHOW;
-      _context->debug &= ~(FF_DEBUG_VIS_MB_TYPE + FF_DEBUG_VIS_QP);
-    }
-
-   
-    
-  if (in->dataLength == 0 && !_allowNull)	// Null frame, silently skipped
-    {
-      
-      printf ("[Codec] null frame\n");
-        // search the last image
-        if (_context->coded_frame && 
-            _context->coded_frame->data &&
-            _context->coded_frame->data[0]
-            )
-          {
-            printf("[Codec] Cloning older pic\n");
-            clonePic (_context->coded_frame, out);
-            out->Pts=ADM_COMPRESSED_NO_PTS;
-          }
-        else
-            {
-                out->_noPicture = 1;
-                out->Pts=ADM_COMPRESSED_NO_PTS;
-                printf("[Codec] No Picture\n");
-            }
-          return 1;
-    }
-   // Put a safe value....
-   out->Pts=in->demuxerPts;
-    _context->reordered_opaque=in->demuxerPts;
-  //_frame.opaque=(void *)out->Pts;
-  //printf("Incoming Pts :%"LLD"\n",out->Pts);
-  AVPacket pkt;
-  av_init_packet(&pkt);
-  pkt.data=in->data;
-  pkt.size=in->dataLength;
-  if(in->flags&AVI_KEY_FRAME)
-    pkt.flags=AV_PKT_FLAG_KEY;
-  else
-    pkt.flags=0;
-  
-  ret = avcodec_decode_video2 (_context, &_frame, &got_picture, &pkt);
-  if(!bFramePossible())
-  {
-    // No delay, the value is sure, no need to hide it in opaque
-    _context->reordered_opaque=(int64_t)in->demuxerPts;
-  }
-  out->_qStride = 0;		//Default = no quant
-  if (0 > ret && !_context->hurry_up)
-    {
-      printf ("\n[lavc] error in lavcodec decoder!\n");
-      printf ("[lavc] Err: %d, size :%d\n", ret, in->dataLength);
-      return 0;
-    }
-  if (!got_picture && !_context->hurry_up)
-    {
-      // Some encoder code a vop header with the 
-      // vop flag set to 0
-      // it is meant to mean frame skipped but very dubious
-      if (in->dataLength <= 8 && codecId == CODEC_ID_MPEG4)
-	{
-	  printf ("[lavc] Probably pseudo black frame...\n");
-	  out->_Qp = 2;
-	  out->flags = 0;	// assume P ?
-
-	  clonePic (_context->coded_frame, out);
-	  return 1;
-	}
-      // allow null means we allow null frame in and so potentially
-      // have no frame out for a time
-      // in that case silently fill with black and returns it as KF
-      if (_allowNull)
-	{
-	  out->flags = AVI_KEY_FRAME;
-	  if (!_refCopy)
-	    {
-            out->blacken();
-	    }
-	  else
-	    {
-	      out->_noPicture = 1;
-	    }
-	  printf ("\n[lavc] ignoring got pict ==0\n");
-	  return 1;
-
-	}
-#if 0
-      printf ("[lavc] Err: %d, size: %d\n", ret, in->dataLength);
-      printf ("\n[lavc] error in FFMP43/mpeg4!: got picture\n");
-#endif
-      //GUI_Alert("Please retry with misc->Turbo off");
-      //return 1;
-      return 0;
-    }
-  if (_context->hurry_up)
-    {
-      out->flags = frameType ();
-      return 1;
-    }
-  // We have an image....
-  switch (_context->pix_fmt)
-    {
-    case PIX_FMT_YUV411P:
-      out->_colorspace = ADM_COLOR_YUV411;
-      break;
-    case PIX_FMT_YUYV422:
-      out->_colorspace = ADM_COLOR_YUV422;
-      break;
-    case PIX_FMT_YUV422P:
-    case PIX_FMT_YUVJ422P:
-      out->_colorspace = ADM_COLOR_YUV422P;
-      break;
-
-    case PIX_FMT_YUV444P:
-    case PIX_FMT_YUVJ444P:
-      out->_colorspace = ADM_COLOR_YUV444;
-      break;
-    case PIX_FMT_YUV420P:
-    case PIX_FMT_YUVJ420P:
-    case PIX_FMT_YUVA420P:
-      // Default is YV12 or I420
-      // In that case depending on swap u/v
-      // we do it or not
-      out->_colorspace = ADM_COLOR_YV12;
-      break;
-
-    case PIX_FMT_RGBA: // ???PIX_FMT_RGBA32:
-      out->_colorspace = ADM_COLOR_RGB32A;
-      break;
-    case PIX_FMT_RGB555:
-      out->_colorspace = ADM_COLOR_RGB555;
-      break;
-    case PIX_FMT_VDPAU_MPEG1:
-    case PIX_FMT_VDPAU_MPEG2:
-    case PIX_FMT_VDPAU_WMV3:
-    case PIX_FMT_VDPAU_VC1:
-    case PIX_FMT_VDPAU_H264:
-        out->_colorspace=ADM_COLOR_VDPAU;
-        break;
-    default:
-      printf ("[lavc] Unhandled colorspace: %d\n", _context->pix_fmt);
-      return 0;
-    }
-    clonePic (&_frame, out);
-    //printf("[AvCodec] Pts : %llu Out Pts:%llu \n",_frame.pts,out->Pts);
-
-  return 1;
-}
-// *******************************************************************
-// *******************************************************************
-// *******************************************************************
-
-decoderFFDiv3::decoderFFDiv3 (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp):
-decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
-{
-  _refCopy = 1;			// YUV420 only
-  WRAP_Open (CODEC_ID_MSMPEG4V3);
-}
-
-decoderFFMpeg4::decoderFFMpeg4 (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp):
-decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
-{
-// force low delay as avidemux don't handle B-frames
-  ADM_info ("[lavc] Using %d bytes of extradata for MPEG4 decoder\n", (int)extraDataLen);
-  
-  _refCopy = 1;			// YUV420 only
-  _context->extradata = (uint8_t *) extraData;
-  _context->extradata_size = (int)extraDataLen  ;
-  _context->codec_tag=fcc;
-  _context->stream_codec_tag=fcc;
-  decoderMultiThread ();
-  //  _context->flags|=FF_DEBUG_VIS_MV;
-  WRAP_Open (CODEC_ID_MPEG4);
-}
-bool decoderFFMpeg4::uncompress (ADMCompressedImage * in, ADMImage * out)
-{
-    // For pseudo startcode
-    if(in->dataLength)
-    {
-        in->data[in->dataLength]=0;
-        in->data[in->dataLength+1]=0;
-    }
-    return decoderFF::uncompress(in,out);
-
-}
-//************************************
-decoderFFDV::decoderFFDV (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp):
-decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
-{
-  _context->extradata = (uint8_t *) extraData;
-  _context->extradata_size = (int) extraDataLen;
-  WRAP_Open (CODEC_ID_DVVIDEO);
-
-}
-decoderFFMpeg12::decoderFFMpeg12 (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp):
-                decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
-{
-  _refCopy = 1;			// YUV420 only
-  decoderMultiThread ();
-  WRAP_Open (CODEC_ID_MPEG2VIDEO);
-}
-
-decoderFF_ffhuff::decoderFF_ffhuff (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp)
-:decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
-{
-  _context->extradata = (uint8_t *) extraData;
-  _context->extradata_size = (int) extraDataLen;
-  _context->bits_per_coded_sample=bpp;
-  ADM_info ("[lavc] FFhuff: We have %d bytes of extra data\n", (int)extraDataLen);
-  WRAP_Open (CODEC_ID_FFVHUFF);
-
-}
-decoderFFH264::decoderFFH264 (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp)
-        :decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
-{
-
-  _refCopy = 1;			// YUV420 only
-  _context->extradata = (uint8_t *) extraData;
-  _context->extradata_size = (int) extraDataLen;
-  decoderMultiThread ();
-  ADM_info ("[lavc] Initializing H264 decoder with %d extradata\n", (int)extraDataLen);
-  WRAP_Open(CODEC_ID_H264);
-}
-//*********************
-extern "C" {int av_getAVCStreamInfo(AVCodecContext *avctx, uint32_t  *nalSize, uint32_t *isAvc);}
-/**
-    \fn uncompress
-*/
-bool   decoderFFH264::uncompress (ADMCompressedImage * in, ADMImage * out)
-{
-  if(!_context->hurry_up) return decoderFF::uncompress (in, out);
-    ADM_assert(0);
-#if 0  
-  uint32_t nalSize, isAvc;
-  av_getAVCStreamInfo(_context,&nalSize,&isAvc);
-  if(isAvc)
-  {
-      return extractH264FrameType(nalSize, in->data,in->dataLength,&(out->flags));
-  }else
-  {
-    return extractH264FrameType_startCode(nalSize, in->data,in->dataLength,&(out->flags));
-  }
-#endif
-}
-//*********************
-decoderFFhuff::decoderFFhuff (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp):
-decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
-{
-  _context->extradata = (uint8_t *) extraData;
-  _context->extradata_size = (int) extraDataLen;
-  _context->bits_per_coded_sample = bpp;
-  WRAP_Open (CODEC_ID_HUFFYUV);
-}
-
-//***************
-extern uint8_t  lavformat_init(void);
-extern void     avcodec_init(void );
-extern  void    avcodec_register_all(void );
-extern "C"
-{
-  void adm_lavLogCallback(void  *instance, int level, const char* fmt, va_list list);
-}
-/**
-    \fn ADM_lavInit
-    \brief Init both lavcodec and lavformat
-*/
-void ADM_lavInit(void)
-{
-    avcodec_init();
-    avcodec_register_all();
-//BAZOOKA    lavformat_init();
-    av_log_set_callback(adm_lavLogCallback);
-#ifdef ADM_DEBUG
-  //  av_log_set_level(AV_LOG_DEBUG);
-#endif
-
-}
-void adm_lavLogCallback(void  *instance, int level, const char* fmt, va_list list)
-{
-   // if(level>1) return;
-    char buf[256];
-  
-    vsnprintf(buf, sizeof(buf), fmt, list);
-    printf("[lavc] %s",buf);
-}
-
-void ADM_lavDestroy(void)
-{
-	//av_free_static();
-}
-
-// EOF
+/***************************************************************************
+    \file ADM_ffmp43
+    \brief Decoders using lavcodec
+    \author mean & all (c) 2002-2010
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+extern "C" {
+#include "ADM_lavcodec.h"
+}
+#include "ADM_default.h"
+
+#include "ADM_codec.h"
+#include "ADM_ffmp43.h"
+#include "DIA_coreToolkit.h"
+//#include "ADM_videoInfoExtractor.h"
+
+extern int ADM_cpu_num_processors(void);
+extern "C"
+{
+    static void ADM_releaseBuffer(struct AVCodecContext *avctx, AVFrame *pic);
+    static int  ADM_getBuffer(AVCodecContext *avctx, AVFrame *pic);
+}
+
+#define aprintf(...) {}
+
+#define WRAP_Open_Template(funcz,argz,display,codecid) \
+{\
+AVCodec *codec=funcz(argz);\
+if(!codec) {GUI_Error_HIG("Codec",QT_TR_NOOP("Internal error finding codec"display));ADM_assert(0);} \
+  codecId=codecid; \
+  _context->workaround_bugs=1*FF_BUG_AUTODETECT +0*FF_BUG_NO_PADDING; \
+  _context->error_concealment=3; \
+  if (avcodec_open(_context, codec) < 0)  \
+                      { \
+                                        printf("[lavc] Decoder init: "display" video decoder failed!\n"); \
+                                        GUI_Error_HIG("Codec","Internal error opening "display); \
+                                        ADM_assert(0); \
+                                } \
+                                else \
+                                { \
+                                        printf("[lavc] Decoder init: "display" video decoder initialized! (%s)\n",codec->long_name); \
+                                } \
+}
+
+#define WRAP_Open(x)            {WRAP_Open_Template(avcodec_find_decoder,x,#x,x);}
+#define WRAP_OpenByName(x,y)    {WRAP_Open_Template(avcodec_find_decoder_by_name,#x,#x,y);}
+
+
+//****************************
+extern uint8_t DIA_lavDecoder (uint32_t * swapUv, uint32_t * showU);
+extern "C"
+{
+  int av_is_voppacked (AVCodecContext * avctx, int *vop_packed, int *gmc,
+		       int *qpel);
+};
+/**
+    \fn clonePic
+    \brief Convert AvFrame to ADMImage
+*/
+uint8_t decoderFF::clonePic (AVFrame * src, ADMImage * out)
+{
+  uint32_t    u,v;
+  ADM_assert(out->isRef());
+  ADMImageRef *ref=out->castToRef();
+  ref->_planes[0] = (uint8_t *) src->data[0];
+  ref->_planeStride[0] = src->linesize[0];
+  if (_swapUV)
+    {
+      u = 1;
+      v = 2;
+    }
+  else
+    {
+      u = 2;
+      v = 1;
+    }
+  ref->_planes[1] = (uint8_t *) src->data[u];
+  ref->_planeStride[1] = src->linesize[u];
+
+  ref->_planes[2] = (uint8_t *) src->data[v];
+  ref->_planeStride[2] = src->linesize[v];
+
+  _lastQ = 0;			//_context->quality;
+  out->_Qp = (src->quality * 32) / FF_LAMBDA_MAX;
+  out->flags = frameType ();
+
+  // Quant ?
+  if (src->qstride && src->qscale_table && codecId != CODEC_ID_H264)
+    {
+      out->quant = (uint8_t *) src->qscale_table;
+      out->_qStride = src->qstride;
+      out->_qSize = (_w + 15) >> 4;
+      out->_qSize *= (_h + 15) >> 4;	// FixME?
+    }
+  else
+    {
+      out->_qSize = out->_qStride = 0;
+      out->quant = NULL;
+    }
+    //printf("[LAVC] Old pts :%"LLD" new pts :%"LLD"\n",out->Pts, (uint64_t)(src->reordered_opaque));
+    //printf("[LAVC] pts: %"LLU"\n",src->pts);
+    out->Pts= (uint64_t)(src->reordered_opaque);
+ 
+    return 1;
+}
+/**
+        \fn decoderMultiThread
+        \brief Enabled multitheaded decoder if possible
+*/
+void decoderFF::decoderMultiThread (void)
+{
+  uint32_t threads = 0;
+
+ // prefs->get(FEATURE_THREADING_LAVC, &threads);
+#warning Fixme
+    threads=1;
+  if (threads == 0)
+	  threads = ADM_cpu_num_processors();
+
+  if (threads == 1)
+	  threads = 0;
+
+  if (threads)
+  {
+      printf ("[lavc] Enabling MT decoder with %u threads\n", threads);
+
+      if (avcodec_thread_init (_context, threads) == -1)
+	      printf ("[lavc] Failed!!\n");
+	  else
+          _usingMT = 1;
+  }
+}
+uint8_t decoderFF::getPARWidth (void)
+{
+  if(!_context->sample_aspect_ratio.num) return 1;
+  return _context->sample_aspect_ratio.num;
+}
+uint8_t decoderFF::getPARHeight (void)
+{
+  if(!_context->sample_aspect_ratio.den) return 1;
+  return _context->sample_aspect_ratio.den;
+
+}
+
+//________________________________________________
+bool  decoderFF::setParam (void)
+{
+  DIA_lavDecoder (&_swapUV, &_showMv);
+  return true;			// no param for ffmpeg
+}
+
+//-------------------------------
+decoderFF::decoderFF (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp)
+            :decoders (w, h,fcc,extraDataLen,extraData,bpp)
+{
+  codecId = 0;
+//                              memset(&_context,0,sizeof(_context));
+  _allowNull = 0;
+  _gmc = 0;
+  _context = NULL;
+  _refCopy = 0;
+  _usingMT = 0;
+#if LIBAVCODEC_BUILD >= 4624
+  _context = avcodec_alloc_context ();
+#else
+  _context = new AVCodecContext;
+  memset (_context, 0, sizeof (AVCodecContext));
+#endif
+  ADM_assert (_context);
+  memset (&_frame, 0, sizeof (_frame));
+
+  _context->max_b_frames = 0;
+
+  _context->width = _w;
+  _context->height = _h;
+  _context->pix_fmt = PIX_FMT_YUV420P;	//PIX_FMT_RGBA32
+  //_context->debug=1;
+
+  _internalBuffer = new uint8_t[w * h * 3];
+
+  _swapUV = 0;
+  //_context->strict_std_compliance=-1;
+
+  _showMv = 0;
+#define FF_SHOW		(FF_DEBUG_VIS_MV_P_FOR+	FF_DEBUG_VIS_MV_B_FOR+FF_DEBUG_VIS_MV_B_BACK)
+//#define FF_SHOW               (FF_DEBUG_VIS_MV_P_FOR)
+  printf ("[lavc] Build: %d\n", LIBAVCODEC_BUILD);
+  _context->debug_mv |= FF_SHOW;
+  _context->debug |= FF_DEBUG_VIS_MB_TYPE + FF_DEBUG_VIS_QP;
+  
+}
+
+//_____________________________________________________
+
+decoderFF::~decoderFF ()
+{
+  if (_usingMT)
+    {
+      printf ("[lavc] Killing decoding threads\n");
+      avcodec_thread_free (_context);
+      _usingMT = 0;
+    }
+
+  avcodec_close (_context);
+  ADM_dealloc (_context);
+  delete[]_internalBuffer;
+  printf ("[lavc] Destroyed\n");
+}
+
+/**
+    \fn frameType
+    \return frametype of the last decoded frame
+*/
+uint32_t decoderFF::frameType (void)
+{
+  uint32_t
+    flag = 0;
+
+  AVFrame *
+    target;
+#define SET(x) {flag=x;aprintf("Frame is %s\n",#x);}
+
+
+  target = &_frame;
+  switch (target->pict_type)
+    {
+    case FF_B_TYPE:
+      SET (AVI_B_FRAME);
+      if (target->key_frame)
+	aprintf ("\n But keyframe is set\n");
+      break;
+
+    case FF_I_TYPE:
+      SET (AVI_KEY_FRAME);
+      if (!target->key_frame)
+	{
+	  if (codecId == CODEC_ID_H264)
+	    {
+	      SET (AVI_P_FRAME);
+	    }
+	  else
+	    printf ("\n But keyframe is not set\n");
+	}
+      break;
+    case FF_S_TYPE:
+      _gmc = 1;			// No break, just inform that gmc is there
+    case FF_P_TYPE:
+      SET (AVI_P_FRAME);
+      if (target->key_frame)
+	aprintf ("\n But keyframe is set\n");
+      break;
+    default:
+//                              printf("\n OOops XXX frame ?\n");
+      break;
+    }
+    flag&=~AVI_STRUCTURE_TYPE_MASK;
+    if(target->interlaced_frame)
+    {
+        flag|=AVI_FIELD_STRUCTURE;
+        if(target->top_field_first)
+            flag|=AVI_TOP_FIELD;
+        else
+            flag|=AVI_BOTTOM_FIELD;
+    }
+  return flag;
+}
+bool decoderFF::decodeHeaderOnly (void)
+{
+  if (codecId == CODEC_ID_H264)
+    _context->hurry_up = 4;
+  else
+    _context->hurry_up = 5;
+  printf ("\n[lavc] Hurry up\n");
+  return 1;
+}
+bool decoderFF::decodeFull (void)
+{
+  _context->hurry_up = 0;
+  printf ("\n[lavc] full decoding\n");
+  return 1;
+}
+
+/**
+    \fn flush
+    \brief empty internal buffer
+*/
+bool    decoderFF::flush(void)
+{
+    if(_context)
+        avcodec_flush_buffers(_context);
+    return true;
+}
+/**
+    \fn uncompress
+    \brief Actually decode an image
+*/
+bool   decoderFF::uncompress (ADMCompressedImage * in, ADMImage * out)
+{
+  int got_picture = 0;
+  uint8_t *oBuff[3];
+  int strideTab[3];
+  int strideTab2[3];
+  int ret = 0;
+  out->_noPicture = 0;
+  if (_showMv)
+    {
+      _context->debug_mv |= FF_SHOW;
+      _context->debug |= 0;	//FF_DEBUG_VIS_MB_TYPE;
+    }
+  else
+    {
+      _context->debug_mv &= ~FF_SHOW;
+      _context->debug &= ~(FF_DEBUG_VIS_MB_TYPE + FF_DEBUG_VIS_QP);
+    }
+
+   
+    
+  if (in->dataLength == 0 && !_allowNull)	// Null frame, silently skipped
+    {
+      
+      printf ("[Codec] null frame\n");
+        // search the last image
+        if (_context->coded_frame && 
+            _context->coded_frame->data &&
+            _context->coded_frame->data[0]
+            )
+          {
+            printf("[Codec] Cloning older pic\n");
+            clonePic (_context->coded_frame, out);
+            out->Pts=ADM_COMPRESSED_NO_PTS;
+          }
+        else
+            {
+                out->_noPicture = 1;
+                out->Pts=ADM_COMPRESSED_NO_PTS;
+                printf("[Codec] No Picture\n");
+            }
+          return 1;
+    }
+   // Put a safe value....
+   out->Pts=in->demuxerPts;
+    _context->reordered_opaque=in->demuxerPts;
+  //_frame.opaque=(void *)out->Pts;
+  //printf("Incoming Pts :%"LLD"\n",out->Pts);
+  AVPacket pkt;
+  av_init_packet(&pkt);
+  pkt.data=in->data;
+  pkt.size=in->dataLength;
+  if(in->flags&AVI_KEY_FRAME)
+    pkt.flags=AV_PKT_FLAG_KEY;
+  else
+    pkt.flags=0;
+  
+  ret = avcodec_decode_video2 (_context, &_frame, &got_picture, &pkt);
+  if(!bFramePossible())
+  {
+    // No delay, the value is sure, no need to hide it in opaque
+    _context->reordered_opaque=(int64_t)in->demuxerPts;
+  }
+  out->_qStride = 0;		//Default = no quant
+  if (0 > ret && !_context->hurry_up)
+    {
+      printf ("\n[lavc] error in lavcodec decoder!\n");
+      printf ("[lavc] Err: %d, size :%d\n", ret, in->dataLength);
+      return 0;
+    }
+  if (!got_picture && !_context->hurry_up)
+    {
+      // Some encoder code a vop header with the 
+      // vop flag set to 0
+      // it is meant to mean frame skipped but very dubious
+      if (in->dataLength <= 8 && codecId == CODEC_ID_MPEG4)
+	{
+	  printf ("[lavc] Probably pseudo black frame...\n");
+	  out->_Qp = 2;
+	  out->flags = 0;	// assume P ?
+
+	  clonePic (_context->coded_frame, out);
+	  return 1;
+	}
+      // allow null means we allow null frame in and so potentially
+      // have no frame out for a time
+      // in that case silently fill with black and returns it as KF
+      if (_allowNull)
+	{
+	  out->flags = AVI_KEY_FRAME;
+	  if (!_refCopy)
+	    {
+            out->blacken();
+	    }
+	  else
+	    {
+	      out->_noPicture = 1;
+	    }
+	  printf ("\n[lavc] ignoring got pict ==0\n");
+	  return 1;
+
+	}
+#if 0
+      printf ("[lavc] Err: %d, size: %d\n", ret, in->dataLength);
+      printf ("\n[lavc] error in FFMP43/mpeg4!: got picture\n");
+#endif
+      //GUI_Alert("Please retry with misc->Turbo off");
+      //return 1;
+      return 0;
+    }
+  if (_context->hurry_up)
+    {
+      out->flags = frameType ();
+      return 1;
+    }
+  // We have an image....
+  switch (_context->pix_fmt)
+    {
+    case PIX_FMT_YUV411P:
+      out->_colorspace = ADM_COLOR_YUV411;
+      break;
+    case PIX_FMT_YUYV422:
+      out->_colorspace = ADM_COLOR_YUV422;
+      break;
+    case PIX_FMT_YUV422P:
+    case PIX_FMT_YUVJ422P:
+      out->_colorspace = ADM_COLOR_YUV422P;
+      break;
+
+    case PIX_FMT_YUV444P:
+    case PIX_FMT_YUVJ444P:
+      out->_colorspace = ADM_COLOR_YUV444;
+      break;
+    case PIX_FMT_YUV420P:
+    case PIX_FMT_YUVJ420P:
+    case PIX_FMT_YUVA420P:
+      // Default is YV12 or I420
+      // In that case depending on swap u/v
+      // we do it or not
+      out->_colorspace = ADM_COLOR_YV12;
+      break;
+
+    case PIX_FMT_RGBA: // ???PIX_FMT_RGBA32:
+      out->_colorspace = ADM_COLOR_RGB32A;
+      break;
+    case PIX_FMT_RGB555:
+      out->_colorspace = ADM_COLOR_RGB555;
+      break;
+    case PIX_FMT_VDPAU_MPEG1:
+    case PIX_FMT_VDPAU_MPEG2:
+    case PIX_FMT_VDPAU_WMV3:
+    case PIX_FMT_VDPAU_VC1:
+    case PIX_FMT_VDPAU_H264:
+        out->_colorspace=ADM_COLOR_VDPAU;
+        break;
+    default:
+      printf ("[lavc] Unhandled colorspace: %d\n", _context->pix_fmt);
+      return 0;
+    }
+    clonePic (&_frame, out);
+    //printf("[AvCodec] Pts : %llu Out Pts:%llu \n",_frame.pts,out->Pts);
+
+  return 1;
+}
+// *******************************************************************
+// *******************************************************************
+// *******************************************************************
+
+decoderFFDiv3::decoderFFDiv3 (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp):
+decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
+{
+  _refCopy = 1;			// YUV420 only
+  WRAP_Open (CODEC_ID_MSMPEG4V3);
+}
+
+decoderFFMpeg4::decoderFFMpeg4 (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp):
+decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
+{
+// force low delay as avidemux don't handle B-frames
+  ADM_info ("[lavc] Using %d bytes of extradata for MPEG4 decoder\n", (int)extraDataLen);
+  
+  _refCopy = 1;			// YUV420 only
+  _context->extradata = (uint8_t *) extraData;
+  _context->extradata_size = (int)extraDataLen  ;
+  _context->codec_tag=fcc;
+  _context->stream_codec_tag=fcc;
+  decoderMultiThread ();
+  //  _context->flags|=FF_DEBUG_VIS_MV;
+  WRAP_Open (CODEC_ID_MPEG4);
+}
+bool decoderFFMpeg4::uncompress (ADMCompressedImage * in, ADMImage * out)
+{
+    // For pseudo startcode
+    if(in->dataLength)
+    {
+        in->data[in->dataLength]=0;
+        in->data[in->dataLength+1]=0;
+    }
+    return decoderFF::uncompress(in,out);
+
+}
+//************************************
+decoderFFDV::decoderFFDV (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp):
+decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
+{
+  _context->extradata = (uint8_t *) extraData;
+  _context->extradata_size = (int) extraDataLen;
+  WRAP_Open (CODEC_ID_DVVIDEO);
+
+}
+decoderFFMpeg12::decoderFFMpeg12 (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp):
+                decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
+{
+  _refCopy = 1;			// YUV420 only
+  decoderMultiThread ();
+  WRAP_Open (CODEC_ID_MPEG2VIDEO);
+}
+
+decoderFFPng::decoderFFPng(uint32_t w, uint32_t h, uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData, uint32_t bpp) : decoderFF(w, h, fcc, extraDataLen, extraData, bpp)
+{
+	WRAP_Open (CODEC_ID_PNG);
+}
+
+decoderFF_ffhuff::decoderFF_ffhuff (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp)
+:decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
+{
+  _context->extradata = (uint8_t *) extraData;
+  _context->extradata_size = (int) extraDataLen;
+  _context->bits_per_coded_sample=bpp;
+  ADM_info ("[lavc] FFhuff: We have %d bytes of extra data\n", (int)extraDataLen);
+  WRAP_Open (CODEC_ID_FFVHUFF);
+
+}
+decoderFFH264::decoderFFH264 (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp)
+        :decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
+{
+
+  _refCopy = 1;			// YUV420 only
+  _context->extradata = (uint8_t *) extraData;
+  _context->extradata_size = (int) extraDataLen;
+  decoderMultiThread ();
+  ADM_info ("[lavc] Initializing H264 decoder with %d extradata\n", (int)extraDataLen);
+  WRAP_Open(CODEC_ID_H264);
+}
+//*********************
+extern "C" {int av_getAVCStreamInfo(AVCodecContext *avctx, uint32_t  *nalSize, uint32_t *isAvc);}
+/**
+    \fn uncompress
+*/
+bool   decoderFFH264::uncompress (ADMCompressedImage * in, ADMImage * out)
+{
+  if(!_context->hurry_up) return decoderFF::uncompress (in, out);
+    ADM_assert(0);
+#if 0  
+  uint32_t nalSize, isAvc;
+  av_getAVCStreamInfo(_context,&nalSize,&isAvc);
+  if(isAvc)
+  {
+      return extractH264FrameType(nalSize, in->data,in->dataLength,&(out->flags));
+  }else
+  {
+    return extractH264FrameType_startCode(nalSize, in->data,in->dataLength,&(out->flags));
+  }
+#endif
+}
+//*********************
+decoderFFhuff::decoderFFhuff (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp):
+decoderFF (w, h,fcc,extraDataLen,extraData,bpp)
+{
+  _context->extradata = (uint8_t *) extraData;
+  _context->extradata_size = (int) extraDataLen;
+  _context->bits_per_coded_sample = bpp;
+  WRAP_Open (CODEC_ID_HUFFYUV);
+}
+
+//***************
+extern uint8_t  lavformat_init(void);
+extern void     avcodec_init(void );
+extern  void    avcodec_register_all(void );
+extern "C"
+{
+  void adm_lavLogCallback(void  *instance, int level, const char* fmt, va_list list);
+}
+/**
+    \fn ADM_lavInit
+    \brief Init both lavcodec and lavformat
+*/
+void ADM_lavInit(void)
+{
+    avcodec_init();
+    avcodec_register_all();
+//BAZOOKA    lavformat_init();
+    av_log_set_callback(adm_lavLogCallback);
+#ifdef ADM_DEBUG
+  //  av_log_set_level(AV_LOG_DEBUG);
+#endif
+
+}
+void adm_lavLogCallback(void  *instance, int level, const char* fmt, va_list list)
+{
+   // if(level>1) return;
+    char buf[256];
+  
+    vsnprintf(buf, sizeof(buf), fmt, list);
+    printf("[lavc] %s",buf);
+}
+
+void ADM_lavDestroy(void)
+{
+	//av_free_static();
+}
+
+// EOF

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_png.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_png.cpp	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_png.cpp	2010-09-25 10:02:51 UTC (rev 6640)
@@ -1,184 +0,0 @@
-/***************************************************************************
-                          ADM_png.cpp  -  description
-                             -------------------
-    begin                : Sat Sep 28 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include "ADM_default.h"
-#include <math.h>
-#include "ADM_codec.h"
-#include "ADM_png.h"
-extern "C"
-{
-#include "png.h"
-}
-
-#define PNG_PTR ((png_structp)png_ptr)
-#define INFO_PTR ((png_infop)info_ptr)
-#define INFO_END ((png_infop)end_info)
-/*
-   	Initialize codec
-*/
-static void user_read_data (png_structp png_ptr, png_bytep data, png_size_t length);
-/**
-    \fn Recalc
-*/
-void decoderPng::recalc (void)
-{
-  int mul;
-  if (colorspace == ADM_COLOR_RGB24)
-    mul = 3;
-
-  else
-    mul = 4;
-  for (int i = 0; i < _h; i++)
-    rows[i] = decoded + mul * _w * i;
-}
-
-/**
-    \fn decoderPng
-*/
-decoderPng::decoderPng (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp):
-                    decoders (w, h,fcc,extraDataLen,extraData,bpp)
-{
-  rows = NULL;
-  decoded = NULL;
-  colorspace = ADM_COLOR_RGB24;
-
-  //****************************
-  // Prepare the decoded buffer*
-  //****************************
-  decoded = new uint8_t[4 * w * h];	// We take a bit more to be able to decode 32 bits png
-  // without causing a segfault
-  rows = new uint8_t *[h];
-  recalc ();
-}
-/**
-    \fn Init
-*/
- void decoderPng::Init (void)
-{
-  png_ptr =    (void *) png_create_read_struct (PNG_LIBPNG_VER_STRING, NULL, NULL, NULL);
-  ADM_assert (png_ptr);
-  info_ptr = (void *) png_create_info_struct (PNG_PTR);
-  ADM_assert (info_ptr);
-  end_info = (void *) png_create_info_struct (PNG_PTR);
-  ADM_assert (end_info);
-  memset (&io, 0, sizeof (io));
-  png_set_read_fn (PNG_PTR, &io, user_read_data);
-  png_set_rows (PNG_PTR, INFO_PTR, (png_byte **) rows);
-}
-/**
-    \fn Cleanup
-*/
-void decoderPng::Cleanup (void)
-{
-  png_destroy_read_struct ((png_structpp) & png_ptr, (png_infopp) & info_ptr,
-			   (png_infopp) & end_info);
-}
-/**
-    \fn dtor
-*/
-decoderPng::~decoderPng ()
-{
-  delete[]rows;
-  delete[]decoded;
-}
-/**
-    \fn uncompress
-   	\brief Uncompress frame, set flags if needed
-*/
-bool decoderPng::uncompress(ADMCompressedImage * in, ADMImage * out)
-{
-  int bpp;
-  int colortype;
-
-  // Check if it is png, and fill it
-  if (!!png_sig_cmp (in->data, 0, 8))
-
-    {
-      ADM_warning ("[PNG] wrong sig\n");
-      return false;
-    }
-
-  //
-  //
-gain2:
-  Init ();
-  io.data = in->data;
-  io.size = in->dataLength;
-  io.cur = 0;
-  png_read_png (PNG_PTR, INFO_PTR, PNG_TRANSFORM_IDENTITY, NULL);
-
-  // Check if it is 24 or 32 bits RGB 
-  bpp = png_get_bit_depth (PNG_PTR, INFO_PTR);
-//   printf("Bpp:%u\n",bpp);
-  // if needed we change colorspace 
-  colortype = png_get_color_type (PNG_PTR, INFO_PTR);
-  // 
-  if (colorspace == ADM_COLOR_RGB24 && colortype == PNG_COLOR_TYPE_RGB_ALPHA)	// RGB32
-    {
-
-      // Switch to 32 bits
-      colorspace = ADM_COLOR_RGB32A;
-      recalc ();
-      goto gain2;
-    }
-
-  else if (colorspace == ADM_COLOR_RGB32A && colortype == PNG_COLOR_TYPE_RGB)
-
-    {
-
-      // Switch to 24 bits
-      colorspace = ADM_COLOR_RGB24;
-      recalc ();
-      goto gain2;
-    }
-  ADM_assert (out->isRef());
-  ADMImageRef *ref=out->castToRef();
-  ref->_planes[0] = decoded;
-  ref->_planes[1] = NULL;
-  ref->_planes[2] = NULL;
-  if (colorspace == ADM_COLOR_RGB32A)
-    ref->_planeStride[0] = _w * 4;
-
-  else
-    ref->_planeStride[0] = _w * 3;
-  ref->_planeStride[1] = 0;
-  ref->_planeStride[2] = 0;
-  ref->_colorspace = colorspace;
-  Cleanup ();
-  return true;
-}
-
-// ******************************************************
-//    Memory based IO
-// ******************************************************
-void user_read_data (png_structp png_ptr, png_bytep data, png_size_t length)
-{
-  memAccess *ac;
-  ac = (memAccess *) png_get_io_ptr (png_ptr);
-  ADM_assert (length + ac->cur <= ac->size);	// or < ?
-  memcpy (data, ac->data + ac->cur, length);
-  ac->cur += length;
-} 
-
-void user_write_data (png_structp png_ptr, png_bytep data, png_size_t length)
-{
-} 
-
-void user_flush_data (png_structp png_ptr)
-{
-}
-//EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/CMakeLists.txt	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/CMakeLists.txt	2010-09-25 10:02:51 UTC (rev 6640)
@@ -1,17 +1,14 @@
 SET(ADM_codecs_SRCS 
 ADM_codecs.cpp
-ADM_png.cpp
 ADM_ffmp43.cpp
 ADM_codecFFsimple.cpp
 ADM_rgb16.cpp
 ADM_uyvy.cpp
-ADM_png.cpp
 ADM_codecSearch.cpp
 DIA_lavDecoder.cpp
 )
 
 ADD_LIBRARY(ADM_coreVideoCodec6 SHARED ${ADM_codecs_SRCS})
-ADD_SOURCE_CFLAGS(ADM_png.cpp ${PNG_CFLAGS})
 TARGET_LINK_LIBRARIES(ADM_coreVideoCodec6 
                                           ADM_core6
                                           ADM_coreImage6 
@@ -20,7 +17,6 @@
                                           ADM_libavcodec6
                                           ADM_libavformat6
                                           ADM_libavutil6)
-TARGET_LINK_LIBRARIES(ADM_coreVideoCodec6 ${PNG_LIBRARIES})
 ADM_INSTALL_LIB(ADM_coreVideoCodec6)
 
 REMOVE_DEFINITIONS(-DHAVE_CONFIG_H)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h	2010-09-25 10:02:51 UTC (rev 6640)
@@ -1,599 +1,599 @@
-#include "ADM_coreConfig.h"
-#define CONFIG_H263_VAAPI_HWACCEL 0
-#define CONFIG_MPEG2_VAAPI_HWACCEL 0
-#define CONFIG_MPEG4_VAAPI_HWACCEL 0
-#define CONFIG_VC1_VAAPI_HWACCEL 0
-#define CONFIG_WMV3_VAAPI_HWACCEL 0
-#define CONFIG_H264_DXVA2_HWACCEL 0
-#define CONFIG_H264_VAAPI_HWACCEL 0
-#define CONFIG_VC1_DXVA2_HWACCEL 0
-#define CONFIG_VC1_DXVA2_HWACCEL 0
-#define CONFIG_WMV3_DXVA2_HWACCEL 0
-#define CONFIG_MPEG2_DXVA2_HWACCEL 0
-#ifdef USE_VDPAU
-#define CONFIG_H264_VDPAU_DECODER 1
-#define CONFIG_MPEG_VDPAU_DECODER 1
-#define CONFIG_MPEG1_VDPAU_DECODER 1
-#define CONFIG_VC1_VDPAU_DECODER 1
-#define CONFIG_WMV3_VDPAU_DECODER 1
-#else // USE_VDPAU
-#define CONFIG_H264_VDPAU_DECODER 0
-#define CONFIG_MPEG_VDPAU_DECODER 0
-#define CONFIG_MPEG1_VDPAU_DECODER 0
-#define CONFIG_VC1_VDPAU_DECODER 0
-#define CONFIG_WMV3_VDPAU_DECODER 0
-#endif // 
-#define CONFIG_MPEG4_VDPAU_DECODER 0
-#ifdef HAVE_MALLOC_H
-#undef HAVE_MALLOC_H 
-#define HAVE_MALLOC_H 1
-#else // HAVE_MALLOC_H
-#define HAVE_MALLOC_H 0
-#endif// HAVE_MALLOC_H
-#define CONFIG_SVQ1_DECODER 1
-#define CONFIG_AAC_DECODER 1
-#define CONFIG_MPEG4AAC_DECODER 1
-#define CONFIG_DCA_DECODER 1
-#define CONFIG_MP3_DECODER 1
-#define CONFIG_MP2_DECODER 1
-#define CONFIG_AC3_DECODER 1
-#define CONFIG_EAC3_DECODER 1
-#define CONFIG_NELLYMOSER_DECODER 1
-#define CONFIG_ADPCM_IMA_AMV_DECODER 1
-#define CONFIG_CINEPAK_DECODER 1
-#define CONFIG_DNXHD_DECODER 1
-#define CONFIG_FOURXM_DECODER 1
-#define CONFIG_FRAPS_DECODER 1
-#define CONFIG_H263_DECODER 1
-#define CONFIG_H264_DECODER 1
-#define CONFIG_INDEO2_DECODER 1
-#define CONFIG_INDEO3_DECODER 1
-#define CONFIG_INTERPLAY_VIDEO_DECODER 1
-#define CONFIG_MPEGVIDEO_DECODER 1
-#define CONFIG_MSVIDEO1_DECODER 1
-#define CONFIG_VC1_DECODER 1
-#define CONFIG_VCR1_DECODER 1
-#define CONFIG_VP5_DECODER 1
-#define CONFIG_VP6_DECODER 1
-#define CONFIG_VP6A_DECODER 1
-#define CONFIG_VP6F_DECODER 1
-#define CONFIG_WMV3_DECODER 1
-#define CONFIG_WMV1_DECODER 1
-#define CONFIG_WMV2_DECODER 1
-#define CONFIG_VP3_DECODER 1
-#define CONFIG_MPEG4_DECODER 1
-#define CONFIG_MSMPEG4V1_DECODER 1
-#define CONFIG_MSMPEG4V2_DECODER 1
-#define CONFIG_MSMPEG4V3_DECODER 1
-#define CONFIG_MJPEGB_DECODER 1
-#define CONFIG_MJPEG_DECODER 1
-#define CONFIG_WMAV2_DECODER 1
-#define CONFIG_DVVIDEO_DECODER 1
-#define CONFIG_HUFFYUV_DECODER 1
-#define CONFIG_FFVHUFF_DECODER 1
-#define CONFIG_SVQ3_DECODER 1
-#define CONFIG_TSCC_DECODER 1
-#define CONFIG_QDM2_DECODER 1
-#define CONFIG_FFV1_DECODER 1
-#define CONFIG_MPEG1VIDEO_DECODER 1
-#define CONFIG_MPEG2VIDEO_DECODER 1
-#define CONFIG_RV10_DECODER 1
-#define CONFIG_RV20_DECODER 1
-#define CONFIG_DVBSUB_DECODER 1
-#define CONFIG_FLV_DECODER 1
-#define CONFIG_SNOW_DECODER 1
-#define CONFIG_AMV_DECODER 1
-#define CONFIG_INDEO5_DECODER 1
-#define CONFIG_MP1FLOAT_DECODER 1
-#define CONFIG_MP2FLOAT_DECODER 1
-#define CONFIG_MP3FLOAT_DECODER 1
-#define CONFIG_INDEO5_DECODER 1
-#define CONFIG_INDEO5_DECODER 1
-#define CONFIG_VP8_DECODER 1
-#define CONFIG_LIBVPX_DECODER 0
-#define CONFIG_GSM_MS_DECODER 0
-#define CONFIG_GSM_DECODER 0
-#define CONFIG_ANSI_DECODER 0
-#define CONFIG_PICTOR_DECODER 0
-#define CONFIG_MP3ADUFLOAT_DECODER 0
-#define CONFIG_MP3ON4FLOAT_DECODER 0
-#define CONFIG_CDGRAPHICS_DECODER 0
-#define CONFIG_ANM_DECODER 0
-#define CONFIG_AURA_DECODER 0
-#define CONFIG_AURA2_DECODER 0
-#define CONFIG_BINK_DECODER 0
-#define CONFIG_FRWU_DECODER 0
-#define CONFIG_IFF_BYTERUN1_DECODER 0
-#define CONFIG_IFF_ILBM_DECODER 0
-#define CONFIG_KGV1_DECODER 0
-#define CONFIG_R210_DECODER 0
-#define CONFIG_YOP_DECODER 0
-#define CONFIG_KGV1_DECODER 0
-#define CONFIG_ALS_DECODER 0
-#define CONFIG_AMRNB_DECODER 0
-#define CONFIG_ATRAC1_DECODER 0
-#define CONFIG_BINKAUDIO_DCT_DECODER 0
-#define CONFIG_BINKAUDIO_RDFT_DECODER 0
-#define CONFIG_ATRAC1_DECODER 0
-#define CONFIG_SIPR_DECODER 0
-#define CONFIG_TWINVQ_DECODER 0
-#define CONFIG_WMAPRO_DECODER 0
-#define CONFIG_WMAVOICE_DECODER 0
-#define CONFIG_PCM_BLURAY_DECODER 0
-#define CONFIG_PGSSUB_DECODER 0
-#define CONFIG_DPX_DECODER 0
-#define CONFIG_EAMAD_DECODER 0
-#define CONFIG_TMV_DECODER 0
-#define CONFIG_V210_DECODER 0
-#define CONFIG_LIBOPENCORE_AMRNB_DECODER 0
-#define CONFIG_LIBOPENCORE_AMRWB_DECODER 0
-#define CONFIG_LIBSPEEX_DECODER 0
-#define CONFIG_LIBSCHROEDINGER_DECODER 0
-#define CONFIG_LIBOPENJPEG_DECODER 0
-#define CONFIG_LIBDIRAC_DECODER 0
-#define CONFIG_ADPCM_IMA_ISS_DECODER 0
-#define CONFIG_ADPCM_EA_MAXIS_XA_DECODER 0
-#define CONFIG_PCM_F64LE_DECODER 0
-#define CONFIG_PCM_F64BE_DECODER 0
-#define CONFIG_PCM_F32LE_DECODER 0
-#define CONFIG_PCM_F32BE_DECODER 0
-#define CONFIG_PCM_DVD_DECODER 0
-#define CONFIG_TRUEHD_DECODER 0
-#define CONFIG_QCELP_DECODER 0
-#define CONFIG_MP1_DECODER 0
-#define CONFIG_MLP_DECODER 0
-#define CONFIG_ALAC_DECODER 0
-#define CONFIG_PGMYUV_DECODER 0
-#define CONFIG_PPM_DECODER 0
-#define CONFIG_EATGV_DECODER 0
-#define CONFIG_EATQI_DECODER 0
-#define CONFIG_EIGHTSVX_EXP_DECODER 0
-#define CONFIG_EIGHTSVX_FIB_DECODER 0
-#define CONFIG_ESCAPE124_DECODER 0
-#define CONFIG_MIMIC_DECODER 0
-#define CONFIG_MOTIONPIXELS_DECODER 0
-#define CONFIG_PAM_DECODER 0
-#define CONFIG_PBM_DECODER 0
-#define CONFIG_PGM_DECODER 0
-#define CONFIG_RL2_DECODER 0
-#define CONFIG_RV30_DECODER 0
-#define CONFIG_RV40_DECODER 0
-#define CONFIG_V210X_DECODER 0
-#define CONFIG_BFI_DECODER 0
-#define CONFIG_EACMV_DECODER 0
-#define CONFIG_EATGQ_DECODER 0
-#define CONFIG_PCX_DECODER 0
-#define CONFIG_SUNRAST_DECODER 0
-#define CONFIG_VB_DECODER 0
-#define CONFIG_XSUB_DECODER 0
-#define CONFIG_APE_DECODER 0
-#define CONFIG_MPC8_DECODER 0
-#define CONFIG_PCM_S16LE_PLANAR_DECODER 0
-#define CONFIG_PCM_ZORK_DECODER 0
-#define CONFIG_ADPCM_EA_R1_DECODER 0
-#define CONFIG_ADPCM_EA_R2_DECODER 0
-#define CONFIG_ADPCM_EA_R3_DECODER 0
-#define CONFIG_ADPCM_EA_XAS_DECODER 0
-#define CONFIG_ADPCM_IMA_EA_EACS_DECODER 0
-#define CONFIG_ADPCM_IMA_EA_SEAD_DECODER 0
-#define CONFIG_AASC_DECODER 0
-#define CONFIG_AVS_DECODER 0
-#define CONFIG_BETHSOFTVID_DECODER 0
-#define CONFIG_C93_DECODER 0
-#define CONFIG_CAVS_DECODER 0
-#define CONFIG_CLJR_DECODER 0
-#define CONFIG_CSCD_DECODER 0
-#define CONFIG_CYUV_DECODER 0
-#define CONFIG_DSICINVIDEO_DECODER 0
-#define CONFIG_DXA_DECODER 0
-#define CONFIG_EIGHTBPS_DECODER 0
-#define CONFIG_FLIC_DECODER 0
-#define CONFIG_IDCIN_DECODER 0
-#define CONFIG_KMVC_DECODER 0
-#define CONFIG_LOCO_DECODER 0
-#define CONFIG_MDEC_DECODER 0
-#define CONFIG_MMVIDEO_DECODER 0
-#define CONFIG_MPEG_XVMC_DECODER 0
-#define CONFIG_MSRLE_DECODER 0
-#define CONFIG_MSZH_DECODER 0
-#define CONFIG_NUV_DECODER 0
-#define CONFIG_PTX_DECODER 0
-#define CONFIG_QDRAW_DECODER 0
-#define CONFIG_QPEG_DECODER 0
-#define CONFIG_RPZA_DECODER 0
-#define CONFIG_SMACKER_DECODER 0
-#define CONFIG_SMC_DECODER 0
-#define CONFIG_SP5X_DECODER 0
-#define CONFIG_THEORA_DECODER 0
-#define CONFIG_THP_DECODER 0
-#define CONFIG_TIERTEXSEQVIDEO_DECODER 0
-#define CONFIG_TRUEMOTION1_DECODER 0
-#define CONFIG_TRUEMOTION2_DECODER 0
-#define CONFIG_TXD_DECODER 0
-#define CONFIG_ULTI_DECODER 0
-#define CONFIG_VMDVIDEO_DECODER 0
-#define CONFIG_VMNC_DECODER 0
-#define CONFIG_VQA_DECODER 0
-#define CONFIG_WNV1_DECODER 0
-#define CONFIG_XAN_WC3_DECODER 0
-#define CONFIG_XL_DECODER 0
-#define CONFIG_ALAC_DECODER 0
-#define CONFIG_ATRAC3_DECODER 0
-#define CONFIG_COOK_DECODER 0
-#define CONFIG_DSICINAUDIO_DECODER 0
-#define CONFIG_IMC_DECODER 0
-#define CONFIG_LIBA52_DECODER 0
-#define CONFIG_LIBFAAD_DECODER 0
-#define CONFIG_MACE3_DECODER 0
-#define CONFIG_MACE6_DECODER 0
-#define CONFIG_MP3ADU_DECODER 0
-#define CONFIG_MP3ON4_DECODER 0
-#define CONFIG_MPC7_DECODER 0
-#define CONFIG_RA_144_DECODER 0
-#define CONFIG_RA_288_DECODER 0
-#define CONFIG_SHORTEN_DECODER 0
-#define CONFIG_SMACKAUD_DECODER 0
-#define CONFIG_TRUESPEECH_DECODER 0
-#define CONFIG_TTA_DECODER 0
-#define CONFIG_VMDAUDIO_DECODER 0
-#define CONFIG_WAVPACK_DECODER 0
-#define CONFIG_WS_SND1_DECODER 0
-#define CONFIG_INTERPLAY_DPCM_DECODER 0
-#define CONFIG_SOL_DPCM_DECODER 0
-#define CONFIG_XAN_DPCM_DECODER 0
-#define CONFIG_ADPCM_THP_DECODER 0
-#define CONFIG_ASV1_DECODER 0
-#define CONFIG_ASV2_DECODER 0
-#define CONFIG_BMP_DECODER 0
-#define CONFIG_FLASHSV_DECODER 0
-#define CONFIG_GIF_DECODER 0
-#define CONFIG_H261_DECODER 0
-#define CONFIG_H263I_DECODER 0
-#define CONFIG_JPEGLS_DECODER 0
-#define CONFIG_PNG_DECODER 0
-#define CONFIG_QTRLE_DECODER 0
-#define CONFIG_RAWVIDEO_DECODER 0
-#define CONFIG_ROQ_DECODER 0
-#define CONFIG_SGI_DECODER 0
-#define CONFIG_TARGA_DECODER 0
-#define CONFIG_TIFF_DECODER 0
-#define CONFIG_ZLIB_DECODER 0
-#define CONFIG_ZMBV_DECODER 0
-#define CONFIG_FLAC_DECODER 0
-#define CONFIG_LIBAMR_NB_DECODER 0
-#define CONFIG_LIBAMR_WB_DECODER 0
-#define CONFIG_LIBGSM_DECODER 0
-#define CONFIG_LIBGSM_MS_DECODER 0
-#define CONFIG_SONIC_DECODER 0
-#define CONFIG_VORBIS_DECODER 0
-#define CONFIG_WMAV1_DECODER 0
-#define CONFIG_PCM_ALAW_DECODER 0
-#define CONFIG_PCM_MULAW_DECODER 0
-#define CONFIG_PCM_S8_DECODER 0
-#define CONFIG_PCM_S16BE_DECODER 0
-#define CONFIG_PCM_S16LE_DECODER 0
-#define CONFIG_PCM_S24BE_DECODER 0
-#define CONFIG_PCM_S24DAUD_DECODER 0
-#define CONFIG_PCM_S24LE_DECODER 0
-#define CONFIG_PCM_S32BE_DECODER 0
-#define CONFIG_PCM_S32LE_DECODER 0
-#define CONFIG_PCM_U8_DECODER 0
-#define CONFIG_PCM_U16BE_DECODER 0
-#define CONFIG_PCM_U16LE_DECODER 0
-#define CONFIG_PCM_U24BE_DECODER 0
-#define CONFIG_PCM_U24LE_DECODER 0
-#define CONFIG_PCM_U32BE_DECODER 0
-#define CONFIG_PCM_U32LE_DECODER 0
-#define CONFIG_ROQ_DPCM_DECODER 0
-#define CONFIG_ADPCM_4XM_DECODER 0
-#define CONFIG_ADPCM_ADX_DECODER 0
-#define CONFIG_ADPCM_CT_DECODER 0
-#define CONFIG_ADPCM_EA_DECODER 0
-#define CONFIG_ADPCM_G726_DECODER 0
-#define CONFIG_ADPCM_IMA_DK3_DECODER 0
-#define CONFIG_ADPCM_IMA_DK4_DECODER 0
-#define CONFIG_ADPCM_IMA_QT_DECODER 0
-#define CONFIG_ADPCM_IMA_SMJPEG_DECODER 0
-#define CONFIG_ADPCM_IMA_WAV_DECODER 0
-#define CONFIG_ADPCM_IMA_WS_DECODER 0
-#define CONFIG_ADPCM_MS_DECODER 0
-#define CONFIG_ADPCM_SBPRO_2_DECODER 0
-#define CONFIG_ADPCM_SBPRO_3_DECODER 0
-#define CONFIG_ADPCM_SBPRO_4_DECODER 0
-#define CONFIG_ADPCM_SWF_DECODER 0
-#define CONFIG_ADPCM_XA_DECODER 0
-#define CONFIG_ADPCM_YAMAHA_DECODER 0
-#define CONFIG_DVDSUB_DECODER 0
-#define CONFIG_LIBVORBIS_DECODER 0
-#define CONFIG_VP8_PARSER 1
-#define CONFIG_AAC_PARSER 1
-#define CONFIG_H263_PARSER 1
-#define CONFIG_H264_PARSER 1
-#define CONFIG_MPEG4VIDEO_PARSER 1
-#define CONFIG_AC3_PARSER 0
-#define CONFIG_CAVSVIDEO_PARSER 0
-#define CONFIG_DCA_PARSER 0
-#define CONFIG_DVBSUB_PARSER 0
-#define CONFIG_DVDSUB_PARSER 0
-#define CONFIG_H261_PARSER 0
-#define CONFIG_MJPEG_PARSER 0
-#define CONFIG_MPEGAUDIO_PARSER 0
-#define CONFIG_MPEGVIDEO_PARSER 0
-#define CONFIG_PNM_PARSER 0
-#define CONFIG_VC1_PARSER 0
-#define CONFIG_VP3_PARSER 0
-#define CONFIG_DNXHD_PARSER 0
-#define CONFIG_DIRAC_PARSER 0
-#define CONFIG_AAC_ENCODER 1
-#define CONFIG_MJPEG_ENCODER 1
-#define CONFIG_MSMPEG4V3_ENCODER 1
-#define CONFIG_H263P_ENCODER 1
-#define CONFIG_AC3_ENCODER 1
-#define CONFIG_FFV1_ENCODER 1
-#define CONFIG_FLV1_ENCODER 1
-#define CONFIG_FFVHUFF_ENCODER 1
-#define CONFIG_H263_ENCODER 1
-#define CONFIG_MPEG1VIDEO_ENCODER 1
-#define CONFIG_MPEG2VIDEO_ENCODER 1
-#define CONFIG_MPEG4_ENCODER 1
-#define CONFIG_FLV_ENCODER 1
-#define CONFIG_MP2_ENCODER 1
-#define CONFIG_DVVIDEO_ENCODER 1
-#define CONFIG_HUFFYUV_ENCODER 1
-#define CONFIG_DVBSUB_ENCODER 1
-#define CONFIG_SNOW_ENCODER 1
-#define CONFIG_LIBVPX_ENCODER 0
-#define CONFIG_RA_144_ENCODER 0
-#define CONFIG_XSUB_ENCODER 0
-#define CONFIG_V210_ENCODER 0
-#define CONFIG_LIBOPENCORE_AMRNB_ENCODER 0
-#define CONFIG_LIBSCHROEDINGER_ENCODER 0
-#define CONFIG_LIBDIRAC_ENCODER 0
-#define CONFIG_PCM_F64LE_ENCODER 0
-#define CONFIG_PCM_F64BE_ENCODER 0
-#define CONFIG_PCM_F32BE_ENCODER 0
-#define CONFIG_PCM_F32LE_ENCODER 0
-#define CONFIG_NELLYMOSER_ENCODER 0
-#define CONFIG_ALAC_ENCODER 0
-#define CONFIG_PCX_ENCODER 0
-#define CONFIG_DNXHD_ENCODER 0
-#define CONFIG_PCM_ZORK_ENCODER 0
-#define CONFIG_ADPCM_IMA_AMV_ENCODER 0
-#define CONFIG_LIBX264_ENCODER 0
-#define CONFIG_LIBXVID_ENCODER 0
-#define CONFIG_LJPEG_ENCODER 0
-#define CONFIG_PAM_ENCODER 0
-#define CONFIG_PBM_ENCODER 0
-#define CONFIG_PGM_ENCODER 0
-#define CONFIG_PGMYUV_ENCODER 0
-#define CONFIG_PPM_ENCODER 0
-#define CONFIG_LIBFAAC_ENCODER 0
-#define CONFIG_LIBMP3LAME_ENCODER 0
-#define CONFIG_LIBTHEORA_ENCODER 0
-#define CONFIG_SONIC_LS_ENCODER 0
-#define CONFIG_ASV1_ENCODER 0
-#define CONFIG_ASV2_ENCODER 0
-#define CONFIG_BMP_ENCODER 0
-#define CONFIG_FLASHSV_ENCODER 0
-#define CONFIG_GIF_ENCODER 0
-#define CONFIG_H261_ENCODER 0
-#define CONFIG_JPEGLS_ENCODER 0
-#define CONFIG_MSMPEG4V1_ENCODER 0
-#define CONFIG_MSMPEG4V2_ENCODER 0
-#define CONFIG_PNG_ENCODER 0
-#define CONFIG_QTRLE_ENCODER 0
-#define CONFIG_RAWVIDEO_ENCODER 0
-#define CONFIG_ROQ_ENCODER 0
-#define CONFIG_RV10_ENCODER 0
-#define CONFIG_RV20_ENCODER 0
-#define CONFIG_SGI_ENCODER 0
-#define CONFIG_SVQ1_ENCODER 0
-#define CONFIG_TARGA_ENCODER 0
-#define CONFIG_TIFF_ENCODER 0
-#define CONFIG_WMV1_ENCODER 0
-#define CONFIG_WMV2_ENCODER 0
-#define CONFIG_ZLIB_ENCODER 0
-#define CONFIG_ZMBV_ENCODER 0
-#define CONFIG_FLAC_ENCODER 0
-#define CONFIG_LIBAMR_NB_ENCODER 0
-#define CONFIG_LIBAMR_WB_ENCODER 0
-#define CONFIG_LIBGSM_ENCODER 0
-#define CONFIG_LIBGSM_MS_ENCODER 0
-#define CONFIG_SONIC_ENCODER 0
-#define CONFIG_VORBIS_ENCODER 0
-#define CONFIG_WMAV1_ENCODER 0
-#define CONFIG_WMAV2_ENCODER 0
-#define CONFIG_PCM_ALAW_ENCODER 0
-#define CONFIG_PCM_MULAW_ENCODER 0
-#define CONFIG_PCM_S8_ENCODER 0
-#define CONFIG_PCM_S16BE_ENCODER 0
-#define CONFIG_PCM_S16LE_ENCODER 0
-#define CONFIG_PCM_S24BE_ENCODER 0
-#define CONFIG_PCM_S24DAUD_ENCODER 0
-#define CONFIG_PCM_S24LE_ENCODER 0
-#define CONFIG_PCM_S32BE_ENCODER 0
-#define CONFIG_PCM_S32LE_ENCODER 0
-#define CONFIG_PCM_U8_ENCODER 0
-#define CONFIG_PCM_U16BE_ENCODER 0
-#define CONFIG_PCM_U16LE_ENCODER 0
-#define CONFIG_PCM_U24BE_ENCODER 0
-#define CONFIG_PCM_U24LE_ENCODER 0
-#define CONFIG_PCM_U32BE_ENCODER 0
-#define CONFIG_PCM_U32LE_ENCODER 0
-#define CONFIG_ROQ_DPCM_ENCODER 0
-#define CONFIG_ADPCM_4XM_ENCODER 0
-#define CONFIG_ADPCM_ADX_ENCODER 0
-#define CONFIG_ADPCM_CT_ENCODER 0
-#define CONFIG_ADPCM_EA_ENCODER 0
-#define CONFIG_ADPCM_G726_ENCODER 0
-#define CONFIG_ADPCM_IMA_DK3_ENCODER 0
-#define CONFIG_ADPCM_IMA_DK4_ENCODER 0
-#define CONFIG_ADPCM_IMA_QT_ENCODER 0
-#define CONFIG_ADPCM_IMA_SMJPEG_ENCODER 0
-#define CONFIG_ADPCM_IMA_WAV_ENCODER 0
-#define CONFIG_ADPCM_IMA_WS_ENCODER 0
-#define CONFIG_ADPCM_MS_ENCODER 0
-#define CONFIG_ADPCM_SBPRO_2_ENCODER 0
-#define CONFIG_ADPCM_SBPRO_3_ENCODER 0
-#define CONFIG_ADPCM_SBPRO_4_ENCODER 0
-#define CONFIG_ADPCM_SWF_ENCODER 0
-#define CONFIG_ADPCM_XA_ENCODER 0
-#define CONFIG_ADPCM_YAMAHA_ENCODER 0
-#define CONFIG_DVDSUB_ENCODER 0
-#define CONFIG_LIBVORBIS_ENCODER 0
-#define CONFIG_CHOMP_BSF 0
-#define CONFIG_AAC_ADTSTOASC_BSF 0
-#define CONFIG_MP3_HEADER_COMPRESS_BSF 0
-#define CONFIG_IMX_DUMP_HEADER_BSF 0
-#define CONFIG_DUMP_EXTRADATA_BSF 0
-#define CONFIG_REMOVE_EXTRADATA_BSF 0
-#define CONFIG_NOISE_BSF 0
-#define CONFIG_MP3_HEADER_DECOMPRESS_BSF 0
-#define CONFIG_MJPEGA_DUMP_HEADER_BSF 0
-#define CONFIG_H264_MP4TOANNEXB_BSF 0
-#define CONFIG_MOV2TEXTSUB_BSF 0
-#define CONFIG_TEXT2MOVSUB_BSF 0
-#define CONFIG_MUXERS 1
-#define CONFIG_MATROSKA_MUXER 1
-#define CONFIG_WEBM_MUXER 1
-#define CONFIG_MOV_MUXER 1
-#define CONFIG_IPOD_MUXER 1
-#define CONFIG_MP4_MUXER 1
-#define CONFIG_PSP_MUXER 1
-#define CONFIG_TG2_MUXER 1
-#define CONFIG_TGP_MUXER 1
-#define CONFIG_MPEG1VCD_MUXER 1
-#define CONFIG_MPEG2SVCD_MUXER 1
-#define CONFIG_MPEG2DVD_MUXER 1
-#define CONFIG_MPEG2VOB_MUXER 1
-#define CONFIG_W64_DEMUXER 0
-#define CONFIG_ENCODERS 1
-#define CONFIG_DVVIDEO_ENCODER 1
-#define CONFIG_SNOW_ENCODER 1
-#define CONFIG_DECODERS 1
-#define CONFIG_DVVIDEO_DECODER 1
-#define CONFIG_H263_DECODER 1
-#define CONFIG_MPEG4_DECODER 1
-#define CONFIG_SNOW_DECODER 1
-#define CONFIG_VC1_DECODER 1
-#define CONFIG_WMV2_DECODER 1
-#define CONFIG_WMV3_DECODER 1
-#define CONFIG_SWSCALE_ALPHA 0
-#define CONFIG_MPEGAUDIO_HP 1
-#define CONFIG_ZLIB 1
-#define CONFIG_GPL 1
-#define CONFIG_ARMV4L 0
-#define CONFIG_MLIB 0
-#define CONFIG_SPARC 0
-#define CONFIG_ALPHA 0
-#define CONFIG_MMI 0
-#define CONFIG_SH4 0
-#define CONFIG_BFIN 0
-#define CONFIG_SMALL 0
-#define CONFIG_MLP_PARSER 0
-//****************** SYSTEM *******************
-#	define ARCH_ARM 0
-#	define ARCH_ALPHA 0
-#	define ARCH_PPC 0
-#	define ARCH_SH4 0
-#	define ARCH_BFIN 0
-#	define HAVE_MMI 0
-#	define HAVE_VIS 0
-#	define CONFIG_GRAY 0
-#	define HAVE_TRUNCF 1
-#ifdef __APPLE__
-#	define CONFIG_DARWIN 1
-#endif
-#if defined(ADM_CPU_X86_32)
-#	define ARCH_X86 1
-#	define ARCH_X86_32 1
-#	define ARCH_X86_64 0
-#	define HAVE_ALTIVEC 0
-#elif defined(ADM_CPU_X86_64)
-#	define ARCH_X86 1
-#	define ARCH_X86_64 1
-#	define HAVE_ALTIVEC 0
-#elif defined(ADM_CPU_PPC)
-#	define ARCH_POWERPC 1
-#ifdef ADM_CPU_ALTIVEC
-#	define HAVE_ALTIVEC 1
-#ifndef __APPLE__
-#	define HAVE_ALTIVEC_H 1
-#endif	// __APPLE__
-#endif	// ADM_CPU_ALTIVEC
-#ifdef ADM_CPU_DCBZL
-#	define HAVE_DCBZL 1
-#endif	// ADM_CPU_DCBZL
-#endif	// ADM_CPU_X86_32
-#ifndef ADM_MINIMAL_INCLUDE
-#if defined(ADM_CPU_X86_32) && defined(ADM_CPU_MMX2)
-#	define HAVE_MMX2 1
-#endif
-#ifdef ADM_CPU_SSSE3
-#	define HAVE_SSSE3 1
-#endif
-#endif //ADM_MINIMAL_INCLUDE
-#ifdef ARCH_POWERPC
-#	define ENABLE_POWERPC 1
-#else
-#	define ENABLE_POWERPC 0
-#endif
-#ifdef ARCH_X86
-#	define ENABLE_BSWAP 1
-#ifndef ADM_MINIMAL_INCLUDE
-#	define HAVE_MMX 1
-#	define HAVE_SSE 1
-#	define HAVE_AMD3DNOW 1
-#	define HAVE_AMD3DNOWEXT 1
-#	define ENABLE_MMX 1
-#endif //ADM_MINIMAL_INCLUDE
-#	define HAVE_FAST_UNALIGNED 1
-#	define HAVE_EBP_AVAILABLE 1
-#	define HAVE_EBX_AVAILABLE 1
-#else
-#	define ENABLE_MMX 0
-#	define HAVE_SSE 0
-#	define HAVE_AMD3DNOW 0
-#	define HAVE_AMD3DNOWEXT 0
-#endif
-#ifdef ARCH_X86_64
-#	define HAVE_FAST_64BIT 1
-#endif
-#ifdef ADM_BIG_ENDIAN
-#	define WORDS_BIGENDIAN 1
-#endif
-#ifdef USE_YASM
-#define ENABLE_YASM      1
-#define HAVE_YASM        1
-#else // USE_YASM
-#define ENABLE_YASM      0
-#define HAVE_YASM        0
-#endif // USE_YASM
-#define CONFIG_FILE_PROTOCOL  1
-#define CONFIG_MDCT     1
-#define CONFIG_DCT      1
-#define CONFIG_LPC      1
-#define CONFIG_H264DSP  1
-#define ENABLE_ARM      0
-#define ENABLE_PPC      0
-#define ENABLE_THREADS 1
-#define ENABLE_ENCODERS 1
-#define CONFIG_MUXERS 1
-#define CONFIG_DEMUXERS 1
-#define ENABLE_VIS 0
-#define ENABLE_GRAY 0
-#define HAVE_LRINTF 1
-#define HAVE_LLRINT 1
-#define HAVE_LRINT 1
-#define HAVE_LOG2 1
-#define HAVE_ROUND 1
-#define HAVE_ROUNDF 1
-#define HAVE_THREADS 1
-#define RUNTIME_CPUDETECT 1
-#define CONFIG_RUNTIME_CPUDETECT 1
-#if defined( __MINGW32__) || defined(__APPLE__)
-#define EXTERN_PREFIX "_"
-#else // __MINGW32__
-#define EXTERN_PREFIX
-#endif // __MINGW32__
-#define restrict __restrict__
+#include "ADM_coreConfig.h"
+#define CONFIG_H263_VAAPI_HWACCEL 0
+#define CONFIG_MPEG2_VAAPI_HWACCEL 0
+#define CONFIG_MPEG4_VAAPI_HWACCEL 0
+#define CONFIG_VC1_VAAPI_HWACCEL 0
+#define CONFIG_WMV3_VAAPI_HWACCEL 0
+#define CONFIG_H264_DXVA2_HWACCEL 0
+#define CONFIG_H264_VAAPI_HWACCEL 0
+#define CONFIG_VC1_DXVA2_HWACCEL 0
+#define CONFIG_VC1_DXVA2_HWACCEL 0
+#define CONFIG_WMV3_DXVA2_HWACCEL 0
+#define CONFIG_MPEG2_DXVA2_HWACCEL 0
+#ifdef USE_VDPAU
+#define CONFIG_H264_VDPAU_DECODER 1
+#define CONFIG_MPEG_VDPAU_DECODER 1
+#define CONFIG_MPEG1_VDPAU_DECODER 1
+#define CONFIG_VC1_VDPAU_DECODER 1
+#define CONFIG_WMV3_VDPAU_DECODER 1
+#else // USE_VDPAU
+#define CONFIG_H264_VDPAU_DECODER 0
+#define CONFIG_MPEG_VDPAU_DECODER 0
+#define CONFIG_MPEG1_VDPAU_DECODER 0
+#define CONFIG_VC1_VDPAU_DECODER 0
+#define CONFIG_WMV3_VDPAU_DECODER 0
+#endif // 
+#define CONFIG_MPEG4_VDPAU_DECODER 0
+#ifdef HAVE_MALLOC_H
+#undef HAVE_MALLOC_H 
+#define HAVE_MALLOC_H 1
+#else // HAVE_MALLOC_H
+#define HAVE_MALLOC_H 0
+#endif// HAVE_MALLOC_H
+#define CONFIG_SVQ1_DECODER 1
+#define CONFIG_AAC_DECODER 1
+#define CONFIG_MPEG4AAC_DECODER 1
+#define CONFIG_DCA_DECODER 1
+#define CONFIG_MP3_DECODER 1
+#define CONFIG_MP2_DECODER 1
+#define CONFIG_AC3_DECODER 1
+#define CONFIG_EAC3_DECODER 1
+#define CONFIG_NELLYMOSER_DECODER 1
+#define CONFIG_ADPCM_IMA_AMV_DECODER 1
+#define CONFIG_CINEPAK_DECODER 1
+#define CONFIG_DNXHD_DECODER 1
+#define CONFIG_FOURXM_DECODER 1
+#define CONFIG_FRAPS_DECODER 1
+#define CONFIG_H263_DECODER 1
+#define CONFIG_H264_DECODER 1
+#define CONFIG_INDEO2_DECODER 1
+#define CONFIG_INDEO3_DECODER 1
+#define CONFIG_INTERPLAY_VIDEO_DECODER 1
+#define CONFIG_MPEGVIDEO_DECODER 1
+#define CONFIG_MSVIDEO1_DECODER 1
+#define CONFIG_VC1_DECODER 1
+#define CONFIG_VCR1_DECODER 1
+#define CONFIG_VP5_DECODER 1
+#define CONFIG_VP6_DECODER 1
+#define CONFIG_VP6A_DECODER 1
+#define CONFIG_VP6F_DECODER 1
+#define CONFIG_WMV3_DECODER 1
+#define CONFIG_WMV1_DECODER 1
+#define CONFIG_WMV2_DECODER 1
+#define CONFIG_VP3_DECODER 1
+#define CONFIG_MPEG4_DECODER 1
+#define CONFIG_MSMPEG4V1_DECODER 1
+#define CONFIG_MSMPEG4V2_DECODER 1
+#define CONFIG_MSMPEG4V3_DECODER 1
+#define CONFIG_MJPEGB_DECODER 1
+#define CONFIG_MJPEG_DECODER 1
+#define CONFIG_WMAV2_DECODER 1
+#define CONFIG_DVVIDEO_DECODER 1
+#define CONFIG_HUFFYUV_DECODER 1
+#define CONFIG_FFVHUFF_DECODER 1
+#define CONFIG_SVQ3_DECODER 1
+#define CONFIG_TSCC_DECODER 1
+#define CONFIG_QDM2_DECODER 1
+#define CONFIG_FFV1_DECODER 1
+#define CONFIG_MPEG1VIDEO_DECODER 1
+#define CONFIG_MPEG2VIDEO_DECODER 1
+#define CONFIG_RV10_DECODER 1
+#define CONFIG_RV20_DECODER 1
+#define CONFIG_DVBSUB_DECODER 1
+#define CONFIG_FLV_DECODER 1
+#define CONFIG_SNOW_DECODER 1
+#define CONFIG_AMV_DECODER 1
+#define CONFIG_INDEO5_DECODER 1
+#define CONFIG_MP1FLOAT_DECODER 1
+#define CONFIG_MP2FLOAT_DECODER 1
+#define CONFIG_MP3FLOAT_DECODER 1
+#define CONFIG_INDEO5_DECODER 1
+#define CONFIG_INDEO5_DECODER 1
+#define CONFIG_VP8_DECODER 1
+#define CONFIG_PNG_DECODER 1
+#define CONFIG_LIBVPX_DECODER 0
+#define CONFIG_GSM_MS_DECODER 0
+#define CONFIG_GSM_DECODER 0
+#define CONFIG_ANSI_DECODER 0
+#define CONFIG_PICTOR_DECODER 0
+#define CONFIG_MP3ADUFLOAT_DECODER 0
+#define CONFIG_MP3ON4FLOAT_DECODER 0
+#define CONFIG_CDGRAPHICS_DECODER 0
+#define CONFIG_ANM_DECODER 0
+#define CONFIG_AURA_DECODER 0
+#define CONFIG_AURA2_DECODER 0
+#define CONFIG_BINK_DECODER 0
+#define CONFIG_FRWU_DECODER 0
+#define CONFIG_IFF_BYTERUN1_DECODER 0
+#define CONFIG_IFF_ILBM_DECODER 0
+#define CONFIG_KGV1_DECODER 0
+#define CONFIG_R210_DECODER 0
+#define CONFIG_YOP_DECODER 0
+#define CONFIG_KGV1_DECODER 0
+#define CONFIG_ALS_DECODER 0
+#define CONFIG_AMRNB_DECODER 0
+#define CONFIG_ATRAC1_DECODER 0
+#define CONFIG_BINKAUDIO_DCT_DECODER 0
+#define CONFIG_BINKAUDIO_RDFT_DECODER 0
+#define CONFIG_ATRAC1_DECODER 0
+#define CONFIG_SIPR_DECODER 0
+#define CONFIG_TWINVQ_DECODER 0
+#define CONFIG_WMAPRO_DECODER 0
+#define CONFIG_WMAVOICE_DECODER 0
+#define CONFIG_PCM_BLURAY_DECODER 0
+#define CONFIG_PGSSUB_DECODER 0
+#define CONFIG_DPX_DECODER 0
+#define CONFIG_EAMAD_DECODER 0
+#define CONFIG_TMV_DECODER 0
+#define CONFIG_V210_DECODER 0
+#define CONFIG_LIBOPENCORE_AMRNB_DECODER 0
+#define CONFIG_LIBOPENCORE_AMRWB_DECODER 0
+#define CONFIG_LIBSPEEX_DECODER 0
+#define CONFIG_LIBSCHROEDINGER_DECODER 0
+#define CONFIG_LIBOPENJPEG_DECODER 0
+#define CONFIG_LIBDIRAC_DECODER 0
+#define CONFIG_ADPCM_IMA_ISS_DECODER 0
+#define CONFIG_ADPCM_EA_MAXIS_XA_DECODER 0
+#define CONFIG_PCM_F64LE_DECODER 0
+#define CONFIG_PCM_F64BE_DECODER 0
+#define CONFIG_PCM_F32LE_DECODER 0
+#define CONFIG_PCM_F32BE_DECODER 0
+#define CONFIG_PCM_DVD_DECODER 0
+#define CONFIG_TRUEHD_DECODER 0
+#define CONFIG_QCELP_DECODER 0
+#define CONFIG_MP1_DECODER 0
+#define CONFIG_MLP_DECODER 0
+#define CONFIG_ALAC_DECODER 0
+#define CONFIG_PGMYUV_DECODER 0
+#define CONFIG_PPM_DECODER 0
+#define CONFIG_EATGV_DECODER 0
+#define CONFIG_EATQI_DECODER 0
+#define CONFIG_EIGHTSVX_EXP_DECODER 0
+#define CONFIG_EIGHTSVX_FIB_DECODER 0
+#define CONFIG_ESCAPE124_DECODER 0
+#define CONFIG_MIMIC_DECODER 0
+#define CONFIG_MOTIONPIXELS_DECODER 0
+#define CONFIG_PAM_DECODER 0
+#define CONFIG_PBM_DECODER 0
+#define CONFIG_PGM_DECODER 0
+#define CONFIG_RL2_DECODER 0
+#define CONFIG_RV30_DECODER 0
+#define CONFIG_RV40_DECODER 0
+#define CONFIG_V210X_DECODER 0
+#define CONFIG_BFI_DECODER 0
+#define CONFIG_EACMV_DECODER 0
+#define CONFIG_EATGQ_DECODER 0
+#define CONFIG_PCX_DECODER 0
+#define CONFIG_SUNRAST_DECODER 0
+#define CONFIG_VB_DECODER 0
+#define CONFIG_XSUB_DECODER 0
+#define CONFIG_APE_DECODER 0
+#define CONFIG_MPC8_DECODER 0
+#define CONFIG_PCM_S16LE_PLANAR_DECODER 0
+#define CONFIG_PCM_ZORK_DECODER 0
+#define CONFIG_ADPCM_EA_R1_DECODER 0
+#define CONFIG_ADPCM_EA_R2_DECODER 0
+#define CONFIG_ADPCM_EA_R3_DECODER 0
+#define CONFIG_ADPCM_EA_XAS_DECODER 0
+#define CONFIG_ADPCM_IMA_EA_EACS_DECODER 0
+#define CONFIG_ADPCM_IMA_EA_SEAD_DECODER 0
+#define CONFIG_AASC_DECODER 0
+#define CONFIG_AVS_DECODER 0
+#define CONFIG_BETHSOFTVID_DECODER 0
+#define CONFIG_C93_DECODER 0
+#define CONFIG_CAVS_DECODER 0
+#define CONFIG_CLJR_DECODER 0
+#define CONFIG_CSCD_DECODER 0
+#define CONFIG_CYUV_DECODER 0
+#define CONFIG_DSICINVIDEO_DECODER 0
+#define CONFIG_DXA_DECODER 0
+#define CONFIG_EIGHTBPS_DECODER 0
+#define CONFIG_FLIC_DECODER 0
+#define CONFIG_IDCIN_DECODER 0
+#define CONFIG_KMVC_DECODER 0
+#define CONFIG_LOCO_DECODER 0
+#define CONFIG_MDEC_DECODER 0
+#define CONFIG_MMVIDEO_DECODER 0
+#define CONFIG_MPEG_XVMC_DECODER 0
+#define CONFIG_MSRLE_DECODER 0
+#define CONFIG_MSZH_DECODER 0
+#define CONFIG_NUV_DECODER 0
+#define CONFIG_PTX_DECODER 0
+#define CONFIG_QDRAW_DECODER 0
+#define CONFIG_QPEG_DECODER 0
+#define CONFIG_RPZA_DECODER 0
+#define CONFIG_SMACKER_DECODER 0
+#define CONFIG_SMC_DECODER 0
+#define CONFIG_SP5X_DECODER 0
+#define CONFIG_THEORA_DECODER 0
+#define CONFIG_THP_DECODER 0
+#define CONFIG_TIERTEXSEQVIDEO_DECODER 0
+#define CONFIG_TRUEMOTION1_DECODER 0
+#define CONFIG_TRUEMOTION2_DECODER 0
+#define CONFIG_TXD_DECODER 0
+#define CONFIG_ULTI_DECODER 0
+#define CONFIG_VMDVIDEO_DECODER 0
+#define CONFIG_VMNC_DECODER 0
+#define CONFIG_VQA_DECODER 0
+#define CONFIG_WNV1_DECODER 0
+#define CONFIG_XAN_WC3_DECODER 0
+#define CONFIG_XL_DECODER 0
+#define CONFIG_ALAC_DECODER 0
+#define CONFIG_ATRAC3_DECODER 0
+#define CONFIG_COOK_DECODER 0
+#define CONFIG_DSICINAUDIO_DECODER 0
+#define CONFIG_IMC_DECODER 0
+#define CONFIG_LIBA52_DECODER 0
+#define CONFIG_LIBFAAD_DECODER 0
+#define CONFIG_MACE3_DECODER 0
+#define CONFIG_MACE6_DECODER 0
+#define CONFIG_MP3ADU_DECODER 0
+#define CONFIG_MP3ON4_DECODER 0
+#define CONFIG_MPC7_DECODER 0
+#define CONFIG_RA_144_DECODER 0
+#define CONFIG_RA_288_DECODER 0
+#define CONFIG_SHORTEN_DECODER 0
+#define CONFIG_SMACKAUD_DECODER 0
+#define CONFIG_TRUESPEECH_DECODER 0
+#define CONFIG_TTA_DECODER 0
+#define CONFIG_VMDAUDIO_DECODER 0
+#define CONFIG_WAVPACK_DECODER 0
+#define CONFIG_WS_SND1_DECODER 0
+#define CONFIG_INTERPLAY_DPCM_DECODER 0
+#define CONFIG_SOL_DPCM_DECODER 0
+#define CONFIG_XAN_DPCM_DECODER 0
+#define CONFIG_ADPCM_THP_DECODER 0
+#define CONFIG_ASV1_DECODER 0
+#define CONFIG_ASV2_DECODER 0
+#define CONFIG_BMP_DECODER 0
+#define CONFIG_FLASHSV_DECODER 0
+#define CONFIG_GIF_DECODER 0
+#define CONFIG_H261_DECODER 0
+#define CONFIG_H263I_DECODER 0
+#define CONFIG_JPEGLS_DECODER 0
+#define CONFIG_QTRLE_DECODER 0
+#define CONFIG_RAWVIDEO_DECODER 0
+#define CONFIG_ROQ_DECODER 0
+#define CONFIG_SGI_DECODER 0
+#define CONFIG_TARGA_DECODER 0
+#define CONFIG_TIFF_DECODER 0
+#define CONFIG_ZLIB_DECODER 0
+#define CONFIG_ZMBV_DECODER 0
+#define CONFIG_FLAC_DECODER 0
+#define CONFIG_LIBAMR_NB_DECODER 0
+#define CONFIG_LIBAMR_WB_DECODER 0
+#define CONFIG_LIBGSM_DECODER 0
+#define CONFIG_LIBGSM_MS_DECODER 0
+#define CONFIG_SONIC_DECODER 0
+#define CONFIG_VORBIS_DECODER 0
+#define CONFIG_WMAV1_DECODER 0
+#define CONFIG_PCM_ALAW_DECODER 0
+#define CONFIG_PCM_MULAW_DECODER 0
+#define CONFIG_PCM_S8_DECODER 0
+#define CONFIG_PCM_S16BE_DECODER 0
+#define CONFIG_PCM_S16LE_DECODER 0
+#define CONFIG_PCM_S24BE_DECODER 0
+#define CONFIG_PCM_S24DAUD_DECODER 0
+#define CONFIG_PCM_S24LE_DECODER 0
+#define CONFIG_PCM_S32BE_DECODER 0
+#define CONFIG_PCM_S32LE_DECODER 0
+#define CONFIG_PCM_U8_DECODER 0
+#define CONFIG_PCM_U16BE_DECODER 0
+#define CONFIG_PCM_U16LE_DECODER 0
+#define CONFIG_PCM_U24BE_DECODER 0
+#define CONFIG_PCM_U24LE_DECODER 0
+#define CONFIG_PCM_U32BE_DECODER 0
+#define CONFIG_PCM_U32LE_DECODER 0
+#define CONFIG_ROQ_DPCM_DECODER 0
+#define CONFIG_ADPCM_4XM_DECODER 0
+#define CONFIG_ADPCM_ADX_DECODER 0
+#define CONFIG_ADPCM_CT_DECODER 0
+#define CONFIG_ADPCM_EA_DECODER 0
+#define CONFIG_ADPCM_G726_DECODER 0
+#define CONFIG_ADPCM_IMA_DK3_DECODER 0
+#define CONFIG_ADPCM_IMA_DK4_DECODER 0
+#define CONFIG_ADPCM_IMA_QT_DECODER 0
+#define CONFIG_ADPCM_IMA_SMJPEG_DECODER 0
+#define CONFIG_ADPCM_IMA_WAV_DECODER 0
+#define CONFIG_ADPCM_IMA_WS_DECODER 0
+#define CONFIG_ADPCM_MS_DECODER 0
+#define CONFIG_ADPCM_SBPRO_2_DECODER 0
+#define CONFIG_ADPCM_SBPRO_3_DECODER 0
+#define CONFIG_ADPCM_SBPRO_4_DECODER 0
+#define CONFIG_ADPCM_SWF_DECODER 0
+#define CONFIG_ADPCM_XA_DECODER 0
+#define CONFIG_ADPCM_YAMAHA_DECODER 0
+#define CONFIG_DVDSUB_DECODER 0
+#define CONFIG_LIBVORBIS_DECODER 0
+#define CONFIG_VP8_PARSER 1
+#define CONFIG_AAC_PARSER 1
+#define CONFIG_H263_PARSER 1
+#define CONFIG_H264_PARSER 1
+#define CONFIG_MPEG4VIDEO_PARSER 1
+#define CONFIG_AC3_PARSER 0
+#define CONFIG_CAVSVIDEO_PARSER 0
+#define CONFIG_DCA_PARSER 0
+#define CONFIG_DVBSUB_PARSER 0
+#define CONFIG_DVDSUB_PARSER 0
+#define CONFIG_H261_PARSER 0
+#define CONFIG_MJPEG_PARSER 0
+#define CONFIG_MPEGAUDIO_PARSER 0
+#define CONFIG_MPEGVIDEO_PARSER 0
+#define CONFIG_PNM_PARSER 0
+#define CONFIG_VC1_PARSER 0
+#define CONFIG_VP3_PARSER 0
+#define CONFIG_DNXHD_PARSER 0
+#define CONFIG_DIRAC_PARSER 0
+#define CONFIG_AAC_ENCODER 1
+#define CONFIG_MJPEG_ENCODER 1
+#define CONFIG_MSMPEG4V3_ENCODER 1
+#define CONFIG_H263P_ENCODER 1
+#define CONFIG_AC3_ENCODER 1
+#define CONFIG_FFV1_ENCODER 1
+#define CONFIG_FLV1_ENCODER 1
+#define CONFIG_FFVHUFF_ENCODER 1
+#define CONFIG_H263_ENCODER 1
+#define CONFIG_MPEG1VIDEO_ENCODER 1
+#define CONFIG_MPEG2VIDEO_ENCODER 1
+#define CONFIG_MPEG4_ENCODER 1
+#define CONFIG_FLV_ENCODER 1
+#define CONFIG_MP2_ENCODER 1
+#define CONFIG_DVVIDEO_ENCODER 1
+#define CONFIG_HUFFYUV_ENCODER 1
+#define CONFIG_DVBSUB_ENCODER 1
+#define CONFIG_SNOW_ENCODER 1
+#define CONFIG_LIBVPX_ENCODER 0
+#define CONFIG_RA_144_ENCODER 0
+#define CONFIG_XSUB_ENCODER 0
+#define CONFIG_V210_ENCODER 0
+#define CONFIG_LIBOPENCORE_AMRNB_ENCODER 0
+#define CONFIG_LIBSCHROEDINGER_ENCODER 0
+#define CONFIG_LIBDIRAC_ENCODER 0
+#define CONFIG_PCM_F64LE_ENCODER 0
+#define CONFIG_PCM_F64BE_ENCODER 0
+#define CONFIG_PCM_F32BE_ENCODER 0
+#define CONFIG_PCM_F32LE_ENCODER 0
+#define CONFIG_NELLYMOSER_ENCODER 0
+#define CONFIG_ALAC_ENCODER 0
+#define CONFIG_PCX_ENCODER 0
+#define CONFIG_DNXHD_ENCODER 0
+#define CONFIG_PCM_ZORK_ENCODER 0
+#define CONFIG_ADPCM_IMA_AMV_ENCODER 0
+#define CONFIG_LIBX264_ENCODER 0
+#define CONFIG_LIBXVID_ENCODER 0
+#define CONFIG_LJPEG_ENCODER 0
+#define CONFIG_PAM_ENCODER 0
+#define CONFIG_PBM_ENCODER 0
+#define CONFIG_PGM_ENCODER 0
+#define CONFIG_PGMYUV_ENCODER 0
+#define CONFIG_PPM_ENCODER 0
+#define CONFIG_LIBFAAC_ENCODER 0
+#define CONFIG_LIBMP3LAME_ENCODER 0
+#define CONFIG_LIBTHEORA_ENCODER 0
+#define CONFIG_SONIC_LS_ENCODER 0
+#define CONFIG_ASV1_ENCODER 0
+#define CONFIG_ASV2_ENCODER 0
+#define CONFIG_BMP_ENCODER 0
+#define CONFIG_FLASHSV_ENCODER 0
+#define CONFIG_GIF_ENCODER 0
+#define CONFIG_H261_ENCODER 0
+#define CONFIG_JPEGLS_ENCODER 0
+#define CONFIG_MSMPEG4V1_ENCODER 0
+#define CONFIG_MSMPEG4V2_ENCODER 0
+#define CONFIG_PNG_ENCODER 0
+#define CONFIG_QTRLE_ENCODER 0
+#define CONFIG_RAWVIDEO_ENCODER 0
+#define CONFIG_ROQ_ENCODER 0
+#define CONFIG_RV10_ENCODER 0
+#define CONFIG_RV20_ENCODER 0
+#define CONFIG_SGI_ENCODER 0
+#define CONFIG_SVQ1_ENCODER 0
+#define CONFIG_TARGA_ENCODER 0
+#define CONFIG_TIFF_ENCODER 0
+#define CONFIG_WMV1_ENCODER 0
+#define CONFIG_WMV2_ENCODER 0
+#define CONFIG_ZLIB_ENCODER 0
+#define CONFIG_ZMBV_ENCODER 0
+#define CONFIG_FLAC_ENCODER 0
+#define CONFIG_LIBAMR_NB_ENCODER 0
+#define CONFIG_LIBAMR_WB_ENCODER 0
+#define CONFIG_LIBGSM_ENCODER 0
+#define CONFIG_LIBGSM_MS_ENCODER 0
+#define CONFIG_SONIC_ENCODER 0
+#define CONFIG_VORBIS_ENCODER 0
+#define CONFIG_WMAV1_ENCODER 0
+#define CONFIG_WMAV2_ENCODER 0
+#define CONFIG_PCM_ALAW_ENCODER 0
+#define CONFIG_PCM_MULAW_ENCODER 0
+#define CONFIG_PCM_S8_ENCODER 0
+#define CONFIG_PCM_S16BE_ENCODER 0
+#define CONFIG_PCM_S16LE_ENCODER 0
+#define CONFIG_PCM_S24BE_ENCODER 0
+#define CONFIG_PCM_S24DAUD_ENCODER 0
+#define CONFIG_PCM_S24LE_ENCODER 0
+#define CONFIG_PCM_S32BE_ENCODER 0
+#define CONFIG_PCM_S32LE_ENCODER 0
+#define CONFIG_PCM_U8_ENCODER 0
+#define CONFIG_PCM_U16BE_ENCODER 0
+#define CONFIG_PCM_U16LE_ENCODER 0
+#define CONFIG_PCM_U24BE_ENCODER 0
+#define CONFIG_PCM_U24LE_ENCODER 0
+#define CONFIG_PCM_U32BE_ENCODER 0
+#define CONFIG_PCM_U32LE_ENCODER 0
+#define CONFIG_ROQ_DPCM_ENCODER 0
+#define CONFIG_ADPCM_4XM_ENCODER 0
+#define CONFIG_ADPCM_ADX_ENCODER 0
+#define CONFIG_ADPCM_CT_ENCODER 0
+#define CONFIG_ADPCM_EA_ENCODER 0
+#define CONFIG_ADPCM_G726_ENCODER 0
+#define CONFIG_ADPCM_IMA_DK3_ENCODER 0
+#define CONFIG_ADPCM_IMA_DK4_ENCODER 0
+#define CONFIG_ADPCM_IMA_QT_ENCODER 0
+#define CONFIG_ADPCM_IMA_SMJPEG_ENCODER 0
+#define CONFIG_ADPCM_IMA_WAV_ENCODER 0
+#define CONFIG_ADPCM_IMA_WS_ENCODER 0
+#define CONFIG_ADPCM_MS_ENCODER 0
+#define CONFIG_ADPCM_SBPRO_2_ENCODER 0
+#define CONFIG_ADPCM_SBPRO_3_ENCODER 0
+#define CONFIG_ADPCM_SBPRO_4_ENCODER 0
+#define CONFIG_ADPCM_SWF_ENCODER 0
+#define CONFIG_ADPCM_XA_ENCODER 0
+#define CONFIG_ADPCM_YAMAHA_ENCODER 0
+#define CONFIG_DVDSUB_ENCODER 0
+#define CONFIG_LIBVORBIS_ENCODER 0
+#define CONFIG_CHOMP_BSF 0
+#define CONFIG_AAC_ADTSTOASC_BSF 0
+#define CONFIG_MP3_HEADER_COMPRESS_BSF 0
+#define CONFIG_IMX_DUMP_HEADER_BSF 0
+#define CONFIG_DUMP_EXTRADATA_BSF 0
+#define CONFIG_REMOVE_EXTRADATA_BSF 0
+#define CONFIG_NOISE_BSF 0
+#define CONFIG_MP3_HEADER_DECOMPRESS_BSF 0
+#define CONFIG_MJPEGA_DUMP_HEADER_BSF 0
+#define CONFIG_H264_MP4TOANNEXB_BSF 0
+#define CONFIG_MOV2TEXTSUB_BSF 0
+#define CONFIG_TEXT2MOVSUB_BSF 0
+#define CONFIG_MUXERS 1
+#define CONFIG_MATROSKA_MUXER 1
+#define CONFIG_WEBM_MUXER 1
+#define CONFIG_MOV_MUXER 1
+#define CONFIG_IPOD_MUXER 1
+#define CONFIG_MP4_MUXER 1
+#define CONFIG_PSP_MUXER 1
+#define CONFIG_TG2_MUXER 1
+#define CONFIG_TGP_MUXER 1
+#define CONFIG_MPEG1VCD_MUXER 1
+#define CONFIG_MPEG2SVCD_MUXER 1
+#define CONFIG_MPEG2DVD_MUXER 1
+#define CONFIG_MPEG2VOB_MUXER 1
+#define CONFIG_W64_DEMUXER 0
+#define CONFIG_ENCODERS 1
+#define CONFIG_DVVIDEO_ENCODER 1
+#define CONFIG_SNOW_ENCODER 1
+#define CONFIG_DECODERS 1
+#define CONFIG_DVVIDEO_DECODER 1
+#define CONFIG_H263_DECODER 1
+#define CONFIG_MPEG4_DECODER 1
+#define CONFIG_SNOW_DECODER 1
+#define CONFIG_VC1_DECODER 1
+#define CONFIG_WMV2_DECODER 1
+#define CONFIG_WMV3_DECODER 1
+#define CONFIG_SWSCALE_ALPHA 0
+#define CONFIG_MPEGAUDIO_HP 1
+#define CONFIG_ZLIB 1
+#define CONFIG_GPL 1
+#define CONFIG_ARMV4L 0
+#define CONFIG_MLIB 0
+#define CONFIG_SPARC 0
+#define CONFIG_ALPHA 0
+#define CONFIG_MMI 0
+#define CONFIG_SH4 0
+#define CONFIG_BFIN 0
+#define CONFIG_SMALL 0
+#define CONFIG_MLP_PARSER 0
+//****************** SYSTEM *******************
+#	define ARCH_ARM 0
+#	define ARCH_ALPHA 0
+#	define ARCH_PPC 0
+#	define ARCH_SH4 0
+#	define ARCH_BFIN 0
+#	define HAVE_MMI 0
+#	define HAVE_VIS 0
+#	define CONFIG_GRAY 0
+#	define HAVE_TRUNCF 1
+#ifdef __APPLE__
+#	define CONFIG_DARWIN 1
+#endif
+#if defined(ADM_CPU_X86_32)
+#	define ARCH_X86 1
+#	define ARCH_X86_32 1
+#	define ARCH_X86_64 0
+#	define HAVE_ALTIVEC 0
+#elif defined(ADM_CPU_X86_64)
+#	define ARCH_X86 1
+#	define ARCH_X86_64 1
+#	define HAVE_ALTIVEC 0
+#elif defined(ADM_CPU_PPC)
+#	define ARCH_POWERPC 1
+#ifdef ADM_CPU_ALTIVEC
+#	define HAVE_ALTIVEC 1
+#ifndef __APPLE__
+#	define HAVE_ALTIVEC_H 1
+#endif	// __APPLE__
+#endif	// ADM_CPU_ALTIVEC
+#ifdef ADM_CPU_DCBZL
+#	define HAVE_DCBZL 1
+#endif	// ADM_CPU_DCBZL
+#endif	// ADM_CPU_X86_32
+#ifndef ADM_MINIMAL_INCLUDE
+#if defined(ADM_CPU_X86_32) && defined(ADM_CPU_MMX2)
+#	define HAVE_MMX2 1
+#endif
+#ifdef ADM_CPU_SSSE3
+#	define HAVE_SSSE3 1
+#endif
+#endif //ADM_MINIMAL_INCLUDE
+#ifdef ARCH_POWERPC
+#	define ENABLE_POWERPC 1
+#else
+#	define ENABLE_POWERPC 0
+#endif
+#ifdef ARCH_X86
+#	define ENABLE_BSWAP 1
+#ifndef ADM_MINIMAL_INCLUDE
+#	define HAVE_MMX 1
+#	define HAVE_SSE 1
+#	define HAVE_AMD3DNOW 1
+#	define HAVE_AMD3DNOWEXT 1
+#	define ENABLE_MMX 1
+#endif //ADM_MINIMAL_INCLUDE
+#	define HAVE_FAST_UNALIGNED 1
+#	define HAVE_EBP_AVAILABLE 1
+#	define HAVE_EBX_AVAILABLE 1
+#else
+#	define ENABLE_MMX 0
+#	define HAVE_SSE 0
+#	define HAVE_AMD3DNOW 0
+#	define HAVE_AMD3DNOWEXT 0
+#endif
+#ifdef ARCH_X86_64
+#	define HAVE_FAST_64BIT 1
+#endif
+#ifdef ADM_BIG_ENDIAN
+#	define WORDS_BIGENDIAN 1
+#endif
+#ifdef USE_YASM
+#define ENABLE_YASM      1
+#define HAVE_YASM        1
+#else // USE_YASM
+#define ENABLE_YASM      0
+#define HAVE_YASM        0
+#endif // USE_YASM
+#define CONFIG_FILE_PROTOCOL  1
+#define CONFIG_MDCT     1
+#define CONFIG_DCT      1
+#define CONFIG_LPC      1
+#define CONFIG_H264DSP  1
+#define ENABLE_ARM      0
+#define ENABLE_PPC      0
+#define ENABLE_THREADS 1
+#define ENABLE_ENCODERS 1
+#define CONFIG_MUXERS 1
+#define CONFIG_DEMUXERS 1
+#define ENABLE_VIS 0
+#define ENABLE_GRAY 0
+#define HAVE_LRINTF 1
+#define HAVE_LLRINT 1
+#define HAVE_LRINT 1
+#define HAVE_LOG2 1
+#define HAVE_ROUND 1
+#define HAVE_ROUNDF 1
+#define HAVE_THREADS 1
+#define RUNTIME_CPUDETECT 1
+#define CONFIG_RUNTIME_CPUDETECT 1
+#if defined( __MINGW32__) || defined(__APPLE__)
+#define EXTERN_PREFIX "_"
+#else // __MINGW32__
+#define EXTERN_PREFIX
+#endif // __MINGW32__
+#define restrict __restrict__

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c	2010-09-25 10:02:51 UTC (rev 6640)
@@ -8,49 +8,49 @@
 {
 	printf("#include \"ADM_coreConfig.h\"\n");
 
-
-// VDPAU
+
+// VDPAU
 #define DECLARE_HW(a,b); printf("#define CONFIG_"#a"_HWACCEL 0\n");
     DECLARE_HW(H263_VAAPI,nellymoser);
     DECLARE_HW(MPEG2_VAAPI,nellymoser);
     DECLARE_HW(MPEG4_VAAPI,nellymoser);
     DECLARE_HW(VC1_VAAPI,nellymoser);
     DECLARE_HW(WMV3_VAAPI,nellymoser);
-//
+//
     DECLARE_HW(H264_DXVA2,nellymoser);
     DECLARE_HW(H264_VAAPI,nellymoser);
     DECLARE_HW(VC1_DXVA2,nellymoser);
     DECLARE_HW(VC1_DXVA2,nellymoser);
     DECLARE_HW(WMV3_DXVA2,nellymoser);
-    DECLARE_HW(MPEG2_DXVA2,nellymoser);
-
+    DECLARE_HW(MPEG2_DXVA2,nellymoser);
+
 #define DECLARE_VDPAU(a,b); printf("#define CONFIG_"#a"_VDPAU_DECODER 1\n");
-        printf("#ifdef USE_VDPAU\n");
-        printf("#define CONFIG_H264_VDPAU_DECODER 1\n");
-        printf("#define CONFIG_MPEG_VDPAU_DECODER 1\n");
-        printf("#define CONFIG_MPEG1_VDPAU_DECODER 1\n");
-        printf("#define CONFIG_VC1_VDPAU_DECODER 1\n");
-        printf("#define CONFIG_WMV3_VDPAU_DECODER 1\n");
-        printf("#else // USE_VDPAU\n");
-        printf("#define CONFIG_H264_VDPAU_DECODER 0\n");
-        printf("#define CONFIG_MPEG_VDPAU_DECODER 0\n");
-        printf("#define CONFIG_MPEG1_VDPAU_DECODER 0\n");
-        printf("#define CONFIG_VC1_VDPAU_DECODER 0\n");
-        printf("#define CONFIG_WMV3_VDPAU_DECODER 0\n");
-        printf("#endif // \n");
-        printf("#define CONFIG_MPEG4_VDPAU_DECODER 0\n");
-        
-        printf("#ifdef HAVE_MALLOC_H\n");
-        printf("#undef HAVE_MALLOC_H \n");
-        printf("#define HAVE_MALLOC_H 1\n");
-        printf("#else // HAVE_MALLOC_H\n");
-        printf("#define HAVE_MALLOC_H 0\n");
-        printf("#endif// HAVE_MALLOC_H\n");
-
-#undef DECLARE_VDPAU
+        printf("#ifdef USE_VDPAU\n");
+        printf("#define CONFIG_H264_VDPAU_DECODER 1\n");
+        printf("#define CONFIG_MPEG_VDPAU_DECODER 1\n");
+        printf("#define CONFIG_MPEG1_VDPAU_DECODER 1\n");
+        printf("#define CONFIG_VC1_VDPAU_DECODER 1\n");
+        printf("#define CONFIG_WMV3_VDPAU_DECODER 1\n");
+        printf("#else // USE_VDPAU\n");
+        printf("#define CONFIG_H264_VDPAU_DECODER 0\n");
+        printf("#define CONFIG_MPEG_VDPAU_DECODER 0\n");
+        printf("#define CONFIG_MPEG1_VDPAU_DECODER 0\n");
+        printf("#define CONFIG_VC1_VDPAU_DECODER 0\n");
+        printf("#define CONFIG_WMV3_VDPAU_DECODER 0\n");
+        printf("#endif // \n");
+        printf("#define CONFIG_MPEG4_VDPAU_DECODER 0\n");
+        
+        printf("#ifdef HAVE_MALLOC_H\n");
+        printf("#undef HAVE_MALLOC_H \n");
+        printf("#define HAVE_MALLOC_H 1\n");
+        printf("#else // HAVE_MALLOC_H\n");
+        printf("#define HAVE_MALLOC_H 0\n");
+        printf("#endif// HAVE_MALLOC_H\n");
+
+#undef DECLARE_VDPAU
 #define DECLARE_VDPAU(a,b); printf("#define CONFIG_"#a"_VDPAU_DECODER 0\n");
-
-
+
+
 #define DECLARE_DECODER(a,b); printf("#define CONFIG_"#a"_DECODER 1\n");
   
     DECLARE_DECODER (SVQ1, svq1);
@@ -113,6 +113,8 @@
     DECLARE_DECODER (INDEO5, indeo5);
     DECLARE_DECODER (INDEO5, indeo5);
     DECLARE_DECODER (VP8, indeo5);
+	DECLARE_DECODER (PNG, png);
+
 #undef DECLARE_DECODER
 #define DECLARE_DECODER(a,b); printf("#define CONFIG_"#a"_DECODER 0\n"); 
 
@@ -147,22 +149,22 @@
     DECLARE_DECODER(WMAVOICE, eatgq);
     DECLARE_DECODER(PCM_BLURAY, eatgq);
     DECLARE_DECODER(PGSSUB, eatgq);
-//
+//
     DECLARE_DECODER(DPX, eatgq);
     DECLARE_DECODER(EAMAD, eatgq);
     DECLARE_DECODER(TMV, eatgq);
     DECLARE_DECODER(V210, eatgq);
     DECLARE_DECODER(LIBOPENCORE_AMRNB, eatgq);
     DECLARE_DECODER(LIBOPENCORE_AMRWB, eatgq);
-
-
+
+
     DECLARE_DECODER(LIBSPEEX, eatgq);
     DECLARE_DECODER(LIBSCHROEDINGER, eatgq);
     DECLARE_DECODER(LIBOPENJPEG, eatgq);
     DECLARE_DECODER(LIBDIRAC, eatgq);
     DECLARE_DECODER(ADPCM_IMA_ISS, eatgq);
     DECLARE_DECODER(ADPCM_EA_MAXIS_XA, eatgq);
-
+
     DECLARE_DECODER(PCM_F64LE, eatgq);
     DECLARE_DECODER(PCM_F64BE, eatgq);
     DECLARE_DECODER(PCM_F32LE, eatgq);
@@ -175,8 +177,8 @@
     DECLARE_DECODER(ALAC, eatgq);
     DECLARE_DECODER(PGMYUV, eatgq);
     DECLARE_DECODER(PPM, eatgq);
-
-
+
+
     DECLARE_DECODER(EATGV, eatgq);
     DECLARE_DECODER(EATQI, eatgq);
     DECLARE_DECODER(EIGHTSVX_EXP, eatgq);
@@ -191,7 +193,7 @@
     DECLARE_DECODER(RV30, eatgq);
     DECLARE_DECODER(RV40, eatgq);
     DECLARE_DECODER(V210X, eatgq);
-
+
     DECLARE_DECODER(BFI, eatgq);
     DECLARE_DECODER(EACMV, eatgq);
     DECLARE_DECODER(EATGQ, eatgq);
@@ -286,7 +288,6 @@
     DECLARE_DECODER (H261, h261);
 	DECLARE_DECODER (H263I, h263i);
     DECLARE_DECODER (JPEGLS, jpegls);
-    DECLARE_DECODER (PNG, png);
     DECLARE_DECODER (QTRLE, qtrle);
     DECLARE_DECODER (RAWVIDEO, rawvideo);
     DECLARE_DECODER (ROQ, roq);
@@ -396,14 +397,14 @@
     DECLARE_ENCODER(LIBOPENCORE_AMRNB, amv);
     DECLARE_ENCODER(LIBSCHROEDINGER, amv);
     DECLARE_ENCODER(LIBDIRAC, amv);
-
+
     DECLARE_ENCODER(PCM_F64LE, amv);
     DECLARE_ENCODER(PCM_F64BE, amv);
     DECLARE_ENCODER(PCM_F32BE, amv);
     DECLARE_ENCODER(PCM_F32LE, amv);
     DECLARE_ENCODER(NELLYMOSER, amv);
     DECLARE_ENCODER(ALAC, amv);
-
+
     DECLARE_ENCODER(PCX, amv);
     DECLARE_ENCODER(DNXHD, amv);
     DECLARE_ENCODER(PCM_ZORK, amv);
@@ -523,7 +524,7 @@
 	DECLARE_MUXER(MPEG2DVD, tgp)
 	DECLARE_MUXER(MPEG2VOB, tgp)
 #define DECLARE_DEMUXER(a,b); printf("#define CONFIG_"#a"_DEMUXER 0\n");
-        DECLARE_DEMUXER(W64,w64)
+        DECLARE_DEMUXER(W64,w64)
 
 	printf("#define CONFIG_ENCODERS 1\n");
 	printf("#define CONFIG_DVVIDEO_ENCODER 1\n");
@@ -539,9 +540,9 @@
 	DECLARE_CONFIG_DECODER(VC1, vc1);
 	DECLARE_CONFIG_DECODER(WMV2, wmv2);
 	DECLARE_CONFIG_DECODER(WMV3, wmv3);
-
-	printf("#define CONFIG_SWSCALE_ALPHA 0\n");
 
+	printf("#define CONFIG_SWSCALE_ALPHA 0\n");
+
 	printf("#define CONFIG_MPEGAUDIO_HP 1\n");
 	printf("#define CONFIG_ZLIB 1\n");
 	printf("#define CONFIG_GPL 1\n");
@@ -568,8 +569,8 @@
 	printf("#	define HAVE_VIS 0\n");
 	printf("#	define CONFIG_GRAY 0\n");
 	printf("#	define HAVE_TRUNCF 1\n");
-
-
+
+
 	printf("#ifdef __APPLE__\n");
 	printf("#	define CONFIG_DARWIN 1\n");
 	printf("#endif\n");
@@ -639,14 +640,14 @@
 	printf("#	define WORDS_BIGENDIAN 1\n");
 	printf("#endif\n");
 
-        printf("#ifdef USE_YASM\n");
+        printf("#ifdef USE_YASM\n");
         printf("#define ENABLE_YASM      1\n");
         printf("#define HAVE_YASM        1\n");
-        printf("#else // USE_YASM\n");
+        printf("#else // USE_YASM\n");
         printf("#define ENABLE_YASM      0\n");
         printf("#define HAVE_YASM        0\n");
-        printf("#endif // USE_YASM\n");
-
+        printf("#endif // USE_YASM\n");
+
 	printf("#define CONFIG_FILE_PROTOCOL  1\n");
 	printf("#define CONFIG_MDCT     1\n");
 	printf("#define CONFIG_DCT      1\n");
@@ -667,12 +668,12 @@
 	printf("#define HAVE_ROUND 1\n");
 	printf("#define HAVE_ROUNDF 1\n");
 	printf("#define HAVE_THREADS 1\n");
-	printf("#define RUNTIME_CPUDETECT 1\n");
-	printf("#define CONFIG_RUNTIME_CPUDETECT 1\n");
-    printf("#if defined( __MINGW32__) || defined(__APPLE__)\n");
-        printf("#define EXTERN_PREFIX \"_\"\n");
-    printf("#else // __MINGW32__\n");
-        printf("#define EXTERN_PREFIX\n");
+	printf("#define RUNTIME_CPUDETECT 1\n");
+	printf("#define CONFIG_RUNTIME_CPUDETECT 1\n");
+    printf("#if defined( __MINGW32__) || defined(__APPLE__)\n");
+        printf("#define EXTERN_PREFIX \"_\"\n");
+    printf("#else // __MINGW32__\n");
+        printf("#define EXTERN_PREFIX\n");
     printf("#endif // __MINGW32__\n");
 	printf("#define restrict __restrict__\n");
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt	2010-09-25 10:02:51 UTC (rev 6640)
@@ -36,7 +36,7 @@
         flvenc.c indeo5.c mpegaudiodec_float.c mpeg4video.c mpeg4videoenc.c dwt.c  h264_refs.c
         ivi_common.c dcadsp.c h264_direct.c ivi_dsp.c ituh263dec.c dvdata.c ituh263enc.c aacsbr.c
         synth_filter.c    mpeg4videodec.c h264_cabac.c h264_cavlc.c vp56dsp.c h264_loopfilter.c
-        h264_sei.c h264_ps.c svq3.c h264dsp.c flvdec.c
+        h264_sei.c h264_ps.c svq3.c h264dsp.c flvdec.c pngdec.c png.c
         aacps.c  aacpsy.c aacadtsdec.c lpc.c vp8_parser.c vp8.c vp8dsp.c inverse.c dct.c aacdec.c
         )
 

Modified: branches/avidemux_2.6_branch_mean/cmake/admCheckRequiredLibs.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admCheckRequiredLibs.cmake	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/cmake/admCheckRequiredLibs.cmake	2010-09-25 10:02:51 UTC (rev 6640)
@@ -32,29 +32,6 @@
 ENDIF (LIBXML2_FOUND)
 
 ########################################
-# libpng
-########################################
-MESSAGE(STATUS "Checking for libpng")
-MESSAGE(STATUS "*******************")
-
-FIND_PACKAGE(PNG)
-if(CROSS)
-                        MESSAGE(STATUS "Cross compile override")
-                          SET(ZLIB_LIBRARY "-lz -L${CROSS}/lib")
-                          SET(PNG_LIBRARIES " ${ZLIB_LIBRARY} -lpng12 -L${CROSS}/lib")
-endif(CROSS)
-
-PRINT_LIBRARY_INFO("libpng" PNG_FOUND "${PNG_INCLUDE_DIR} ${PNG_DEFINITIONS}" "${PNG_LIBRARIES}" FATAL_ERROR)
-
-FOREACH(_flag ${PNG_INCLUDE_DIR})
-	SET(PNG_CFLAGS ${PNG_CFLAGS} -I${_flag})
-ENDFOREACH(_flag)
-
-SET(PNG_CFLAGS ${PNG_CFLAGS} ${PNG_DEFINITIONS})
-SET(USE_PNG 1)
-MESSAGE("")
-
-########################################
 # pthreads
 ########################################
 MESSAGE(STATUS "Checking for pthreads")
@@ -69,3 +46,14 @@
 PRINT_LIBRARY_INFO("pthreads" PTHREAD_FOUND "${PTHREAD_INCLUDE_DIR}" "${PTHREAD_LIBRARIES}" FATAL_ERROR)
 
 MESSAGE("")
+
+########################################
+# zlib
+########################################
+MESSAGE(STATUS "Checking for zlib")
+MESSAGE(STATUS "*****************")
+
+FIND_PACKAGE(ZLIB)
+PRINT_LIBRARY_INFO("zlib" ZLIB_FOUND "${ZLIB_INCLUDE_DIR}" "${ZLIB_LIBRARY}" FATAL_ERROR)
+
+MESSAGE("")
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/cmake/config.h.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/config.h.cmake	2010-09-25 09:44:46 UTC (rev 6639)
+++ branches/avidemux_2.6_branch_mean/cmake/config.h.cmake	2010-09-25 10:02:51 UTC (rev 6640)
@@ -34,9 +34,6 @@
 /* Libxml2 is available */
 #cmakedefine USE_LIBXML2
 
-/* libpng is available */
-#cmakedefine USE_PNG
-
 /* libvpx is available */
 #cmakedefine USE_VPX
 



From gruntster at mail.berlios.de  Sat Sep 25 12:13:46 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 25 Sep 2010 12:13:46 +0200
Subject: [Avidemux-svn-commit] r6641 - in
	branches/avidemux_2.6_branch_mean/avidemux_core:
	ADM_coreImage/src ADM_coreVideoCodec/src
Message-ID: <20100925101347.0D956480FCF@sheep.berlios.de>

Author: gruntster
Date: 2010-09-25 12:13:46 +0200 (Sat, 25 Sep 2010)
New Revision: 6641

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
Log:
[colorspace] add rgb24 and bgr handling

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp	2010-09-25 10:02:51 UTC (rev 6640)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp	2010-09-25 10:13:46 UTC (rev 6641)
@@ -88,8 +88,8 @@
     case ADM_COLOR_YUV422: return PIX_FMT_YUYV422;
     case ADM_COLOR_YV12: return PIX_FMT_YUV420P;
     case ADM_COLOR_YUV422P: return PIX_FMT_YUV422P;
-    case ADM_COLOR_RGB32A: return PIX_FMT_RGB32;
-    case ADM_COLOR_BGR32A: return PIX_FMT_RGB32; // Faster that way...PIX_FMT_BGR32;
+    case ADM_COLOR_RGB32A: return PIX_FMT_RGBA;
+    case ADM_COLOR_BGR32A: return PIX_FMT_RGBA; // Faster that way...PIX_FMT_BGR32;
     case ADM_COLOR_RGB24: return PIX_FMT_RGB24;
     case ADM_COLOR_BGR24: return PIX_FMT_RGB24;
     default : ADM_assert(0); 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2010-09-25 10:02:51 UTC (rev 6640)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2010-09-25 10:13:46 UTC (rev 6641)
@@ -431,7 +431,6 @@
     case PIX_FMT_YUVJ422P:
       out->_colorspace = ADM_COLOR_YUV422P;
       break;
-
     case PIX_FMT_YUV444P:
     case PIX_FMT_YUVJ444P:
       out->_colorspace = ADM_COLOR_YUV444;
@@ -444,7 +443,12 @@
       // we do it or not
       out->_colorspace = ADM_COLOR_YV12;
       break;
-
+	case PIX_FMT_RGB24:
+	  out->_colorspace = ADM_COLOR_RGB24;
+	  break;
+    case PIX_FMT_BGRA:
+      out->_colorspace = ADM_COLOR_BGR32A;
+      break;
     case PIX_FMT_RGBA: // ???PIX_FMT_RGBA32:
       out->_colorspace = ADM_COLOR_RGB32A;
       break;



From gruntster at mail.berlios.de  Sat Sep 25 12:32:53 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 25 Sep 2010 12:32:53 +0200
Subject: [Avidemux-svn-commit] r6642 - in branches/avidemux_2.6_branch_mean:
	avidemux avidemux/common/ADM_script2/js
	avidemux/common/ADM_script2/js/src_dialogFactory avidemux_core cmake
Message-ID: <20100925103254.1521E480FD5@sheep.berlios.de>

Author: gruntster
Date: 2010-09-25 12:32:53 +0200 (Sat, 25 Sep 2010)
New Revision: 6642

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/src_dialogFactory/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
   branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/cmake/admCheckMiscLibs.cmake
Log:
[js] add option to use system version of SpiderMonkey (port from 2.5)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/CMakeLists.txt	2010-09-25 10:13:46 UTC (rev 6641)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/CMakeLists.txt	2010-09-25 10:32:53 UTC (rev 6642)
@@ -21,8 +21,22 @@
 )
 
 ADD_LIBRARY(ADM_jsScript6 STATIC ${ADM_script_SRCS})
-ADD_DEFINITIONS("-DJS_THREADSAFE -DXP_UNIX")
+
+IF (WIN32)
+	ADD_DEFINITIONS(-DXP_WIN)
+ELSE (WIN32)
+	ADD_DEFINITIONS(-DXP_UNIX)
+ENDIF (WIN32)
+
+ADD_DEFINITIONS(-DJS_THREADSAFE)
+
 include_directories(../include)
 include_directories(.)
-include_directories(${AVIDEMUX_TOP_SOURCE_DIR}/avidemux_core/ADM_smjs)
+
+if (USE_SYSTEM_SPIDERMONKEY)
+	include_directories(${SPIDERMONKEY_INCLUDE_DIR})
+else (USE_SYSTEM_SPIDERMONKEY)
+	include_directories(${AVIDEMUX_TOP_SOURCE_DIR}/avidemux_core/ADM_smjs)
+endif (USE_SYSTEM_SPIDERMONKEY)
+
 SUBDIRS(src_dialogFactory)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/src_dialogFactory/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/src_dialogFactory/CMakeLists.txt	2010-09-25 10:13:46 UTC (rev 6641)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/src_dialogFactory/CMakeLists.txt	2010-09-25 10:32:53 UTC (rev 6642)
@@ -7,7 +7,6 @@
         
 )
 
-ADD_DEFINITIONS("-DJS_THREADSAFE -DXP_UNIX")
 ADD_LIBRARY(ADM_scriptDF STATIC ${ADM_scriptDF_SRCS})
 include_directories(../../include/scriptDialogFactory)
 include_directories(../include)

Modified: branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-09-25 10:13:46 UTC (rev 6641)
+++ branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-09-25 10:32:53 UTC (rev 6642)
@@ -82,10 +82,15 @@
 ADM_libavutil6
 ADM_libswscale6
 ADM_libpostproc6
-ADM_smjs6
 ADM_coreTinyPy6
 )
 
+if (USE_SYSTEM_SPIDERMONKEY)
+	SET(coreLibs ${coreLibs} ${SPIDERMONKEY_LIBRARY_DIR})
+else (USE_SYSTEM_SPIDERMONKEY)
+	SET(coreLibs ${coreLibs} ADM_smjs6)
+endif (USE_SYSTEM_SPIDERMONKEY)
+
 #############################################
 # Add common libs
 #############################################

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-09-25 10:13:46 UTC (rev 6641)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-09-25 10:32:53 UTC (rev 6642)
@@ -69,7 +69,11 @@
 ADD_SUBDIRECTORY(ADM_coreVideoEncoder)
 ADD_SUBDIRECTORY(ADM_coreVideoFilter)
 ADD_SUBDIRECTORY(ADM_ffmpeg)
-ADD_SUBDIRECTORY(ADM_smjs)
+
+if (NOT USE_SYSTEM_SPIDERMONKEY)
+	ADD_SUBDIRECTORY(ADM_smjs)
+endif (NOT USE_SYSTEM_SPIDERMONKEY)
+
 ADD_SUBDIRECTORY(ADM_coreImageLoader)
 
 ADD_SUBDIRECTORY(ADM_coreVdpau)

Modified: branches/avidemux_2.6_branch_mean/cmake/admCheckMiscLibs.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admCheckMiscLibs.cmake	2010-09-25 10:13:46 UTC (rev 6641)
+++ branches/avidemux_2.6_branch_mean/cmake/admCheckMiscLibs.cmake	2010-09-25 10:32:53 UTC (rev 6642)
@@ -55,3 +55,20 @@
 ELSE (UNIX AND NOT APPLE)
 	SET(XVIDEO_CAPABLE FALSE)
 ENDIF (UNIX AND NOT APPLE)
+
+########################################
+# SpiderMonkey
+########################################
+OPTION(USE_SYSTEM_SPIDERMONKEY "" OFF)
+
+MESSAGE(STATUS "Checking for SpiderMonkey")
+MESSAGE(STATUS "*************************")
+
+IF (USE_SYSTEM_SPIDERMONKEY)
+	FIND_HEADER_AND_LIB(SPIDERMONKEY jsapi.h js JS_InitStandardClasses)
+	PRINT_LIBRARY_INFO("SpiderMonkey" SPIDERMONKEY_FOUND "${SPIDERMONKEY_INCLUDE_DIR}" "${SPIDERMONKEY_LIBRARY_DIR}" FATAL_ERROR)
+ELSE (USE_SYSTEM_SPIDERMONKEY)
+	MESSAGE("Skipping check and using bundled version.")
+ENDIF (USE_SYSTEM_SPIDERMONKEY)
+
+MESSAGE("")



From gruntster at mail.berlios.de  Sat Sep 25 12:39:48 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 25 Sep 2010 12:39:48 +0200
Subject: [Avidemux-svn-commit] r6643 - in branches/avidemux_2.6_branch_mean:
	avidemux avidemux_core
Message-ID: <20100925103948.892F4480FCF@sheep.berlios.de>

Author: gruntster
Date: 2010-09-25 12:39:48 +0200 (Sat, 25 Sep 2010)
New Revision: 6643

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
   branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
Log:
[vdpau] only compile vdpau module if libvdpau is present

Modified: branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-09-25 10:32:53 UTC (rev 6642)
+++ branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-09-25 10:39:48 UTC (rev 6643)
@@ -98,12 +98,16 @@
 ADM_muxerGate6
 ADM_audioFilter6
 ADM_editor6
-ADM_audiocodec6 
-ADM_videocodec6 
-ADM_coreVDPAU6 
-ADM_coreVideoCodec6 
+ADM_audiocodec6
+ADM_videocodec6
+ADM_coreVideoCodec6
 ADM_commonUI6
 )
+
+if (USE_VDPAU)
+	SET(commonLibs1 ${commonLibs1} ADM_coreVDPAU6)
+endif (USE_VDPAU)
+
 SET(commonLibs2
 #ADM_filter6 
 ADM_osSupport6 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-09-25 10:32:53 UTC (rev 6642)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-09-25 10:39:48 UTC (rev 6643)
@@ -22,7 +22,7 @@
 # VDPAU
 ########################################
 IF(NOT CROSS)
-checkVDPAU()
+	checkVDPAU()
 ENDIF(NOT CROSS)
 ########################################
 # YASM
@@ -76,7 +76,9 @@
 
 ADD_SUBDIRECTORY(ADM_coreImageLoader)
 
-ADD_SUBDIRECTORY(ADM_coreVdpau)
+if (USE_VDPAU)
+	ADD_SUBDIRECTORY(ADM_coreVdpau)
+endif (USE_VDPAU)
 
 ########################################
 # Config Summary



From gruntster at mail.berlios.de  Sat Sep 25 12:53:56 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 25 Sep 2010 12:53:56 +0200
Subject: [Avidemux-svn-commit] r6644 - in
	branches/avidemux_2.6_branch_mean/avidemux_core: .
	ADM_coreAudioParser/src
Message-ID: <20100925105356.CE584480FD5@sheep.berlios.de>

Author: gruntster
Date: 2010-09-25 12:53:56 +0200 (Sat, 25 Sep 2010)
New Revision: 6644

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioParser/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
Log:
[cmake] muzzle noise when configuring core

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioParser/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioParser/src/CMakeLists.txt	2010-09-25 10:39:48 UTC (rev 6643)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioParser/src/CMakeLists.txt	2010-09-25 10:53:56 UTC (rev 6644)
@@ -7,9 +7,9 @@
 ADM_eac3info.cpp
 )	
 #*************************************************
-ADD_DEFINITIONS( "-DADM_LEGACY_PROGGY")
-ADD_DEFINITIONS( "-DHAVE_LRINT -DHAVE_LRINTF ")
-ADD_DEFINITIONS( "-DCPU_CLIPS_POSITIVE=0 -DCPU_CLIPS_NEGATIVE=0")
+ADD_DEFINITIONS(-DADM_LEGACY_PROGGY)
+ADD_DEFINITIONS(-DHAVE_LRINT -DHAVE_LRINTF)
+ADD_DEFINITIONS(-DCPU_CLIPS_POSITIVE=0 -DCPU_CLIPS_NEGATIVE=0)
 #*************************************************
 ADD_LIBRARY(ADM_audioParser6 SHARED ${ADMaudioParser_SRCS})
 TARGET_LINK_LIBRARIES(ADM_audioParser6 ADM_core6 ADM_coreUtils6 ADM_coreUI6  ADM_libavcodec6 ADM_libavformat6 ADM_libavutil6)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-09-25 10:39:48 UTC (rev 6643)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-09-25 10:53:56 UTC (rev 6644)
@@ -1,3 +1,5 @@
+cmake_minimum_required(VERSION 2.6)
+
 MESSAGE("#########################################")
 MESSAGE("Configure for avidemux core libs Started")
 MESSAGE("#########################################")
@@ -2,8 +4,2 @@
 MESSAGE("")
-cmake_minimum_required(VERSION 2.6)
-if (COMMAND cmake_policy)
-	cmake_policy(VERSION 2.4)
-	cmake_policy(SET CMP0003 NEW)
-	#cmake_policy(SET CMP0011 OLD)
-endif (COMMAND cmake_policy)
 
@@ -16,19 +12,23 @@
 
 SET(CMAKE_MODULE_PATH "${AVIDEMUX_TOP_SOURCE_DIR}/cmake" "${CMAKE_MODULE_PATH}")
 SET(ADM_PROJECT admCore)
+
 ADD_DEFINITIONS(-D_FILE_OFFSET_BITS=64 -D_LARGE_FILES)
 include(admMainChecks)
+
 ########################################
 # VDPAU
 ########################################
 IF(NOT CROSS)
 	checkVDPAU()
 ENDIF(NOT CROSS)
+
 ########################################
 # YASM
 ########################################
 include(FindYasm)
 admFindYasm()
+
 #########################################
 # Debug Summary
 ########################################
@@ -37,7 +37,6 @@
 	MESSAGE("")
 ENDIF (VERBOSE)
 
-
 ########################################
 # Generate config.h
 ########################################
@@ -45,10 +44,12 @@
 include_directories( "${CMAKE_BINARY_DIR}/config")
 MESSAGE(STATUS "ADM_coreConfig.h generated")
 MESSAGE("")
+
 ########################################
 # Add include dirs
 ########################################
 include(admCoreIncludes)
+
 ########################################
 # Directories to build
 ########################################



From gruntster at mail.berlios.de  Sat Sep 25 13:09:04 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 25 Sep 2010 13:09:04 +0200
Subject: [Avidemux-svn-commit] r6645 - in
	branches/avidemux_2.6_branch_mean/avidemux/cli: .
	ADM_userInterfaces/ADM_gui2
Message-ID: <20100925110904.C380A480FCF@sheep.berlios.de>

Author: gruntster
Date: 2010-09-25 13:09:04 +0200 (Sat, 25 Sep 2010)
New Revision: 6645

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_gui2/gui_none.cpp
   branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt
Log:
[win32] tweak CLI build so it builds with MinGW

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_gui2/gui_none.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_gui2/gui_none.cpp	2010-09-25 10:53:56 UTC (rev 6644)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_gui2/gui_none.cpp	2010-09-25 11:09:04 UTC (rev 6645)
@@ -138,8 +138,7 @@
 {
   return 1;
 }
-void UI_purge( void )
-{}
+
 int UI_GetCurrentFormat( void )
 {
 	return cliFormat;

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt	2010-09-25 10:53:56 UTC (rev 6644)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt	2010-09-25 11:09:04 UTC (rev 6645)
@@ -1,125 +1,118 @@
-MESSAGE("#########################################")
-MESSAGE("Configure for avidemux Cli Started")
-MESSAGE("#########################################")
-MESSAGE("")
-SET(VERSION 2.6.0)
-CMAKE_MINIMUM_REQUIRED(VERSION 2.4.7 FATAL_ERROR)
-if (COMMAND cmake_policy)
-	cmake_policy(VERSION 2.4)
-	cmake_policy(SET CMP0003 NEW)
-	#cmake_policy(SET CMP0011 OLD)
-endif (COMMAND cmake_policy)
-SET( ADM_PROJECT Avidemux_cli)
-
-include(../commonCmakeApplication.cmake)
-##########################################
-# Config
-##########################################
-ADD_DEFINITIONS(-DADM_UI_TYPE_BUILD=ADM_UI_CLI)
-SET(CONFIG_HEADER_TYPE ADM_BUILD_CLI)
-SET(UI_SUFFIX cli)
-#
-CONFIGURE_FILE("${AVIDEMUX_TOP_SOURCE_DIR}/cmake/config.h.cmake" "${CMAKE_BINARY_DIR}/config/cli/config.h")
-MESSAGE(STATUS "CLI config.h generated")
-
-INCLUDE_DIRECTORIES("${CMAKE_BINARY_DIR}/config/cli/")
-###########################################
-# Executable
-###########################################
-ADD_EXECUTABLE(avidemux3_cli ${ADM_EXE_SRCS})
-ADD_TARGET_CFLAGS(avidemux3_cli "-I${CMAKE_BINARY_DIR}/config/cli")
-########################################
-# Add subdirectories 
-########################################
-ADD_SUBDIRECTORY(../common ./common)
-ADD_SUBDIRECTORY(ADM_UIs ./ADM_UIsCli)
-ADD_SUBDIRECTORY(ADM_userInterfaces ./ADM_userInterfacesCli)
-# Executable
-
-SDLify(../common/main.cpp)
-ADD_SOURCE_CFLAGS(../common/main.cpp "-DADM_SUBVERSION=${ADM_SUBVERSION}")
-###########################################
-# Construct common libraries
-###########################################
-
-IF (ADM_DEBUG AND FIND_LEAKS)
-	TARGET_LINK_LIBRARIES(avidemux3_cli ADM_nvwa)
-ENDIF (ADM_DEBUG AND FIND_LEAKS)
-
-FOREACH (_libName ${commonLibs1})
-        TARGET_LINK_LIBRARIES(avidemux3_cli ${_libName})
-ENDFOREACH (_libName ${commonLibs})
-
-TARGET_LINK_LIBRARIES(avidemux3_cli ADM_filtersCli6)
-
-FOREACH (_libName ${commonLibs2})
-        TARGET_LINK_LIBRARIES(avidemux3_cli ${_libName})
-ENDFOREACH (_libName ${commonLibs})
-FOREACH (_libName ${coreLibs})
-        TARGET_LINK_LIBRARIES(avidemux3_cli ${_libName})
-ENDFOREACH (_libName ${commonLibs})
-
-#############################################
-# Add gtk specific libs
-#############################################
-TARGET_LINK_LIBRARIES(avidemux3_cli ADM_UI_Cli6)
-TARGET_LINK_LIBRARIES(avidemux3_cli ADM_dialogCli6)
-TARGET_LINK_LIBRARIES(avidemux3_cli ADM_gui2Cli6)
-TARGET_LINK_LIBRARIES(avidemux3_cli ADM_toolkitCli6)
-TARGET_LINK_LIBRARIES(avidemux3_cli ADM_UI_Cli6)
-TARGET_LINK_LIBRARIES(avidemux3_cli ADM_UI_Cli6)
-TARGET_LINK_LIBRARIES(avidemux3_cli ADM_shellCli)
-TARGET_LINK_LIBRARIES(avidemux3_cli ADM_toolkit6)
-###########################################
-# External libs
-###########################################
-# gettext
-IF (GETTEXT_FOUND)
-	TARGET_LINK_LIBRARIES(avidemux3_cli ${GETTEXT_LIBRARY_DIR})
-ENDIF (GETTEXT_FOUND)
-
-# XVideo
-IF (USE_XV)
-        TARGET_LINK_LIBRARIES(avidemux3_cli ${XVIDEO_LIBRARY_DIR})
-ENDIF (USE_XV)
-
-# SDL
-IF (USE_SDL)
-        TARGET_LINK_LIBRARIES(avidemux3_cli ${SDL_LIBRARY})
-ENDIF (USE_SDL)
-
-###########################################
-# UI Specific
-###########################################
-ADD_TARGET_LDFLAGS(avidemux3_cli ${GTK_LDFLAGS} ${GTHREAD_LDFLAGS})
-
-
-###########################################
-# OS Specific
-###########################################
-IF (WIN32)
-	target_link_libraries(ADM_osSupport)
-
-	IF (MINGW)
-		target_link_libraries(avidemux3_cli -mno-cygwin)
-	ENDIF (MINGW)
-
-	target_link_libraries(avidemux3_cli winmm)
-        ADD_TARGET_LDFLAGS(avidemux3_cli "-mwindows")
-
-ENDIF (WIN32)
-#
-# libxml2
-#
-TARGET_LINK_LIBRARIES(avidemux3_cli ${LIBXML2_LIBRARIES})
-###########################################
-# Install
-###########################################
-ADM_LINK_THREAD(avidemux3_cli)
-ADM_INSTALL_BIN(avidemux3_cli)
-INSTALL(FILES ${CMAKE_BINARY_DIR}/config/cli/config.h DESTINATION "${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/cli") 
-#
-# Packaging
-#
-include(admPackager)
-admPackager(cliPackage)
+cmake_minimum_required(VERSION 2.6)
+
+SET(VERSION 2.6.0)
+SET(ADM_PROJECT Avidemux_cli)
+
+MESSAGE("#########################################")
+MESSAGE("Configure for avidemux Cli Started")
+MESSAGE("#########################################")
+MESSAGE("")
+
+include(../commonCmakeApplication.cmake)
+
+##########################################
+# Config
+##########################################
+ADD_DEFINITIONS(-DADM_UI_TYPE_BUILD=ADM_UI_CLI)
+SET(CONFIG_HEADER_TYPE ADM_BUILD_CLI)
+SET(UI_SUFFIX cli)
+
+CONFIGURE_FILE("${AVIDEMUX_TOP_SOURCE_DIR}/cmake/config.h.cmake" "${CMAKE_BINARY_DIR}/config/cli/config.h")
+MESSAGE(STATUS "CLI config.h generated")
+
+INCLUDE_DIRECTORIES("${CMAKE_BINARY_DIR}/config/cli/")
+
+###########################################
+# Executable
+###########################################
+ADD_EXECUTABLE(avidemux3_cli ${ADM_EXE_SRCS})
+
+########################################
+# Add subdirectories 
+########################################
+ADD_SUBDIRECTORY(../common ./common)
+ADD_SUBDIRECTORY(ADM_UIs ./ADM_UIsCli)
+ADD_SUBDIRECTORY(ADM_userInterfaces ./ADM_userInterfacesCli)
+
+SDLify(../common/main.cpp)
+ADD_SOURCE_CFLAGS(../common/main.cpp "-DADM_SUBVERSION=${ADM_SUBVERSION}")
+
+###########################################
+# Construct common libraries
+###########################################
+IF (ADM_DEBUG AND FIND_LEAKS)
+	TARGET_LINK_LIBRARIES(avidemux3_cli ADM_nvwa)
+ENDIF (ADM_DEBUG AND FIND_LEAKS)
+
+FOREACH (_libName ${commonLibs1})
+        TARGET_LINK_LIBRARIES(avidemux3_cli ${_libName})
+ENDFOREACH (_libName ${commonLibs1})
+
+TARGET_LINK_LIBRARIES(avidemux3_cli ADM_filtersCli6)
+
+FOREACH (_libName ${commonLibs2})
+        TARGET_LINK_LIBRARIES(avidemux3_cli ${_libName})
+ENDFOREACH (_libName ${commonLibs2})
+
+FOREACH (_libName ${coreLibs})
+        TARGET_LINK_LIBRARIES(avidemux3_cli ${_libName})
+ENDFOREACH (_libName ${coreLibs})
+
+#############################################
+# Add gtk specific libs
+#############################################
+TARGET_LINK_LIBRARIES(avidemux3_cli
+	ADM_UI_Cli6
+	ADM_dialogCli6
+	ADM_toolkit6
+	ADM_coreUtils6
+	ADM_gui2Cli6
+	ADM_toolkitCli6
+	ADM_shellCli
+)
+
+###########################################
+# External libs
+###########################################
+# gettext
+IF (GETTEXT_FOUND)
+	TARGET_LINK_LIBRARIES(avidemux3_cli ${GETTEXT_LIBRARY_DIR})
+ENDIF (GETTEXT_FOUND)
+
+# XVideo
+IF (USE_XV)
+        TARGET_LINK_LIBRARIES(avidemux3_cli ${XVIDEO_LIBRARY_DIR})
+ENDIF (USE_XV)
+
+# SDL
+IF (USE_SDL)
+        TARGET_LINK_LIBRARIES(avidemux3_cli ${SDL_LIBRARY})
+ENDIF (USE_SDL)
+
+# libxml2
+TARGET_LINK_LIBRARIES(avidemux3_cli ${LIBXML2_LIBRARIES})
+
+###########################################
+# OS Specific
+###########################################
+IF (WIN32)
+	target_link_libraries(ADM_osSupport)
+
+	IF (MINGW)
+		target_link_libraries(avidemux3_cli -mno-cygwin)
+	ENDIF (MINGW)
+
+	target_link_libraries(avidemux3_cli winmm -mwindows)
+ENDIF (WIN32)
+
+###########################################
+# Install
+###########################################
+ADM_LINK_THREAD(avidemux3_cli)
+ADM_INSTALL_BIN(avidemux3_cli)
+INSTALL(FILES ${CMAKE_BINARY_DIR}/config/cli/config.h DESTINATION "${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/cli") 
+#
+# Packaging
+#
+include(admPackager)
+admPackager(cliPackage)



From gruntster at mail.berlios.de  Sat Sep 25 13:11:12 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 25 Sep 2010 13:11:12 +0200
Subject: [Avidemux-svn-commit] r6646 -
	branches/avidemux_2.6_branch_mean/avidemux
Message-ID: <20100925111112.422A1480FCF@sheep.berlios.de>

Author: gruntster
Date: 2010-09-25 13:11:12 +0200 (Sat, 25 Sep 2010)
New Revision: 6646

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
Log:
[cmake] muzzle more noise

Modified: branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-09-25 11:09:04 UTC (rev 6645)
+++ branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-09-25 11:11:12 UTC (rev 6646)
@@ -1,11 +1,3 @@
-#
-#
-cmake_minimum_required(VERSION 2.6)
-if (COMMAND cmake_policy)
-	cmake_policy(VERSION 2.4)
-	cmake_policy(SET CMP0003 NEW)
-	#cmake_policy(SET CMP0011 OLD)
-endif (COMMAND cmake_policy)
 ########################################
 # Definitions and Includes
 ########################################
@@ -109,19 +101,15 @@
 endif (USE_VDPAU)
 
 SET(commonLibs2
-#ADM_filter6 
-ADM_osSupport6 
-ADM_requant6 
-ADM_pyScript6 
-ADM_jsScript6 
+ADM_osSupport6
+ADM_requant6
+ADM_pyScript6
+ADM_jsScript6
 ADM_scriptDF
-ADM_script6 
-ADM_videoEncoder6 
+ADM_script6
+ADM_videoEncoder6
 ADM_internalVideoFilter6
 ADM_toolkit6
-
-#ADM_video6 
-#ADM_videoFilter6 
 )
 
 # END



From gruntster at mail.berlios.de  Sat Sep 25 13:27:32 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 25 Sep 2010 13:27:32 +0200
Subject: [Avidemux-svn-commit] r6647 -
	branches/avidemux_2.6_branch_mean/cmake
Message-ID: <20100925112732.5615C480FCF@sheep.berlios.de>

Author: gruntster
Date: 2010-09-25 13:27:32 +0200 (Sat, 25 Sep 2010)
New Revision: 6647

Modified:
   branches/avidemux_2.6_branch_mean/cmake/admMainChecks.cmake
Log:
[vdpau] build fix for linux

Modified: branches/avidemux_2.6_branch_mean/cmake/admMainChecks.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admMainChecks.cmake	2010-09-25 11:11:12 UTC (rev 6646)
+++ branches/avidemux_2.6_branch_mean/cmake/admMainChecks.cmake	2010-09-25 11:27:32 UTC (rev 6647)
@@ -115,6 +115,7 @@
 INCLUDE(admCheckMiscLibs)
 INCLUDE(FindThreads)
 INCLUDE(admCheckVDPAU)
+checkVDPAU()
 ENDIF(NOT PLUGINS)
 
 ########################################



From gruntster at mail.berlios.de  Sat Sep 25 13:55:56 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 25 Sep 2010 13:55:56 +0200
Subject: [Avidemux-svn-commit] r6648 - in branches/avidemux_2.6_branch_mean:
	avidemux/gtk avidemux/gtk/ADM_UIs/src
	avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk cmake
Message-ID: <20100925115556.4A20B480FCF@sheep.berlios.de>

Author: gruntster
Date: 2010-09-25 13:55:56 +0200 (Sat, 25 Sep 2010)
New Revision: 6648

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/ADM_tray_gtk.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/cmake/admCheckGlade.cmake
   branches/avidemux_2.6_branch_mean/cmake/admCheckGtk.cmake
Log:
[win32] tweak GTK build so it builds with MinGW

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/CMakeLists.txt	2010-09-25 11:27:32 UTC (rev 6647)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/CMakeLists.txt	2010-09-25 11:55:56 UTC (rev 6648)
@@ -1,31 +1,31 @@
-SET(ADM_LIB ADM_UIGtk6)
-
-SET(${ADM_LIB}_SRCS
-	DIA_color.cpp
-	DIA_filesel.cpp
-	DIA_dialogFactory.cpp
-	FAC_bitrate.cpp
-	FAC_float.cpp
-	FAC_hex.cpp
-	FAC_menu.cpp
-	FAC_readOnlyText.cpp
-	FAC_bar.cpp
-	FAC_button.cpp
-	FAC_frame.cpp
-	FAC_integer.cpp
-	FAC_notch.cpp
-	FAC_toggle.cpp
-	FAC_threadCount.cpp
-	FAC_slider.cpp
-	FAC_matrix.cpp
-        ADM_gladeSupport.cpp  
-        choice.cpp       
-        toolkit_dialog.cpp
-        toolkit.cpp
-        DIA_flyDialogGtk.cpp
-)
-INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/../include)
-ADD_LIBRARY(${ADM_LIB} SHARED ${${ADM_LIB}_SRCS})
-TARGET_LINK_LIBRARIES(${ADM_LIB} ${GTK_LDFLAGS} ADM_core6 ADM_coreUI6 ADM_render6_gtk)
-ADD_TARGET_CFLAGS(${ADM_LIB} ${GTK_CFLAGS})
-ADM_INSTALL_LIB( ${ADM_LIB} )
+SET(ADM_LIB ADM_UIGtk6)
+
+SET(${ADM_LIB}_SRCS
+	DIA_color.cpp
+	DIA_filesel.cpp
+	DIA_dialogFactory.cpp
+	FAC_bitrate.cpp
+	FAC_float.cpp
+	FAC_hex.cpp
+	FAC_menu.cpp
+	FAC_readOnlyText.cpp
+	FAC_bar.cpp
+	FAC_button.cpp
+	FAC_frame.cpp
+	FAC_integer.cpp
+	FAC_notch.cpp
+	FAC_toggle.cpp
+	FAC_threadCount.cpp
+	FAC_slider.cpp
+	FAC_matrix.cpp
+        ADM_gladeSupport.cpp  
+        choice.cpp       
+        toolkit_dialog.cpp
+        toolkit.cpp
+        DIA_flyDialogGtk.cpp
+)
+INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/../include)
+ADD_LIBRARY(${ADM_LIB} SHARED ${${ADM_LIB}_SRCS})
+TARGET_LINK_LIBRARIES(${ADM_LIB} ${GTK_LDFLAGS} ADM_core6 ADM_coreUI6 ADM_render6_gtk ADM_coreVideoFilter6)
+ADD_TARGET_CFLAGS(${ADM_LIB} ${GTK_CFLAGS})
+ADM_INSTALL_LIB( ${ADM_LIB} )

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/ADM_tray_gtk.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/ADM_tray_gtk.cpp	2010-09-25 11:27:32 UTC (rev 6647)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/ADM_tray_gtk.cpp	2010-09-25 11:55:56 UTC (rev 6648)
@@ -25,7 +25,7 @@
 #include "ADM_toolkitGtk.h"
 #include "ADM_tray.h"
 
-extern void UI_deiconify(void);
+//extern void UI_deiconify(void);
 
 static GdkPixbuf **pixbuf = NULL;
 static int lastIcon;
@@ -38,13 +38,13 @@
 void tray_icon_on_click(GtkStatusIcon *status_icon, gpointer user_data)
 {
 	gtk_window_deiconify(GTK_WINDOW(user_data));
-	UI_deiconify();
+	//UI_deiconify();
 }
 
 static void tray_menu_open_avidemux(GtkStatusIcon *status_icon, gpointer user_data)
 {
 	gtk_window_deiconify(GTK_WINDOW(user_data));
-	UI_deiconify();
+	//UI_deiconify();
 }
 
 static void tray_icon_popup_menu(GtkStatusIcon *status_icon, guint button, guint activate_time, gpointer user_data)

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/CMakeLists.txt	2010-09-25 11:27:32 UTC (rev 6647)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/CMakeLists.txt	2010-09-25 11:55:56 UTC (rev 6648)
@@ -1,12 +1,13 @@
-SET(ADM_LIB ADM_toolkitGtk)
-
-SET(${ADM_LIB}_SRCS
-	ADM_tray_gtk.cpp  
-        gtkmarkscale.c jogshuttle.c ADM_jogshuttle.cpp  mediactrl.c
-        GUI_glade.cpp
-
-)
-
-ADD_DEFINITIONS("-DTARGET_DIR='\"${AVIDEMUX_LIB_DIR}/ADM_glade/\"' -DSOURCE_DIR='\"${CMAKE_CURRENT_SOURCE_DIR}\"'")
-ADD_LIBRARY(${ADM_LIB} SHARED ${${ADM_LIB}_SRCS})
-ADM_INSTALL_LIB(${ADM_LIB})
+SET(ADM_LIB ADM_toolkitGtk)
+
+SET(${ADM_LIB}_SRCS
+	ADM_tray_gtk.cpp
+	gtkmarkscale.c jogshuttle.c ADM_jogshuttle.cpp  mediactrl.c
+	GUI_glade.cpp
+)
+
+ADD_DEFINITIONS(-DTARGET_DIR="${AVIDEMUX_LIB_DIR}/ADM_glade/" -DSOURCE_DIR="${CMAKE_CURRENT_SOURCE_DIR}")
+ADD_LIBRARY(${ADM_LIB} SHARED ${${ADM_LIB}_SRCS})
+TARGET_LINK_LIBRARIES(${ADM_LIB} ${GTK_LDFLAGS} ADM_toolkitGtk)
+ADD_TARGET_CFLAGS(${ADM_LIB} ${GTK_CFLAGS})
+ADM_INSTALL_LIB(${ADM_LIB})
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt	2010-09-25 11:27:32 UTC (rev 6647)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt	2010-09-25 11:55:56 UTC (rev 6648)
@@ -1,131 +1,130 @@
-MESSAGE("#########################################")
-MESSAGE("Configure for avidemux Gtk Started")
-MESSAGE("#########################################")
-MESSAGE("")
-SET(VERSION 2.6.0)
-CMAKE_MINIMUM_REQUIRED(VERSION 2.4.7 FATAL_ERROR)
-if (COMMAND cmake_policy)
-	cmake_policy(VERSION 2.4)
-	cmake_policy(SET CMP0003 NEW)
-	#cmake_policy(SET CMP0011 OLD)
-endif (COMMAND cmake_policy)
-SET( ADM_PROJECT Avidemux_gtk)
-
-include(../commonCmakeApplication.cmake)
-include(admCheckGtk)
-#include(admCheckGlade)
-#
-checkGtk()
-#checkGlade()
-##########################################
-# Config
-##########################################
-ADD_DEFINITIONS(-DADM_UI_TYPE_BUILD=ADM_UI_GTK)
-SET(CONFIG_HEADER_TYPE ADM_BUILD_GTK)
-SET(UI_SUFFIX gtk)
-#
-CONFIGURE_FILE("${AVIDEMUX_TOP_SOURCE_DIR}/cmake/config.h.cmake" "${CMAKE_BINARY_DIR}/config/gtk/config.h")
-MESSAGE(STATUS "GTK config.h generated")
-
-INCLUDE_DIRECTORIES("${CMAKE_BINARY_DIR}/config/gtk/")
-###########################################
-# Executable
-###########################################
-ADD_EXECUTABLE(avidemux3_gtk ${ADM_EXE_SRCS})
-ADD_TARGET_CFLAGS(avidemux3_gtk "-I${CMAKE_BINARY_DIR}/config/gtk")
-########################################
-# Add subdirectories 
-########################################
-ADD_SUBDIRECTORY(../common ./common)
-ADD_SUBDIRECTORY(ADM_UIs ./ADM_UIsGtk)
-ADD_SUBDIRECTORY(ADM_userInterfaces ./ADM_userInterfacesGtk)
-# Executable
-
-SDLify(../common/main.cpp)
-ADD_SOURCE_CFLAGS(../common/main.cpp "-DADM_SUBVERSION=${ADM_SUBVERSION}")
-###########################################
-# Construct common libraries
-###########################################
-
-IF (ADM_DEBUG AND FIND_LEAKS)
-	TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_nvwa)
-ENDIF (ADM_DEBUG AND FIND_LEAKS)
-
-FOREACH (_libName ${commonLibs1})
-        TARGET_LINK_LIBRARIES(avidemux3_gtk ${_libName})
-ENDFOREACH (_libName ${commonLibs})
-
-TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_filtersGtk)
-
-FOREACH (_libName ${commonLibs2})
-        TARGET_LINK_LIBRARIES(avidemux3_gtk ${_libName})
-ENDFOREACH (_libName ${commonLibs})
-FOREACH (_libName ${coreLibs})
-        TARGET_LINK_LIBRARIES(avidemux3_gtk ${_libName})
-ENDFOREACH (_libName ${commonLibs})
-
-#############################################
-# Add gtk specific libs
-#############################################
-TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_UIGtk6)
-TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_dialogGtk)
-#TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_filtersGtk)
-TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_gui2Gtk)
-#TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_ocrGtk)
-TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_toolkitGtk)
-TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_UI_GTK)
-TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_shellGtk)
-TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_toolkit6)
-###########################################
-# External libs
-###########################################
-# gettext
-IF (GETTEXT_FOUND)
-	TARGET_LINK_LIBRARIES(avidemux3_gtk ${GETTEXT_LIBRARY_DIR})
-ENDIF (GETTEXT_FOUND)
-
-# XVideo
-IF (USE_XV)
-        TARGET_LINK_LIBRARIES(avidemux3_gtk ${XVIDEO_LIBRARY_DIR})
-ENDIF (USE_XV)
-
-# SDL
-IF (USE_SDL)
-        TARGET_LINK_LIBRARIES(avidemux3_gtk ${SDL_LIBRARY})
-ENDIF (USE_SDL)
-
-###########################################
-# UI Specific
-###########################################
-ADD_TARGET_LDFLAGS(avidemux3_gtk ${GTK_LDFLAGS} ${GTHREAD_LDFLAGS})
-
-
-###########################################
-# OS Specific
-###########################################
-IF (WIN32)
-	target_link_libraries(ADM_osSupport)
-
-	IF (MINGW)
-		target_link_libraries(avidemux3_gtk -mno-cygwin)
-	ENDIF (MINGW)
-
-	target_link_libraries(avidemux3_gtk winmm)
-        ADD_TARGET_LDFLAGS(avidemux3_gtk "-mwindows")
-
-ENDIF (WIN32)
-#
-# libxml2
-#
-TARGET_LINK_LIBRARIES(avidemux3_gtk ${LIBXML2_LIBRARIES})
-###########################################
-# Install
-###########################################
-ADM_LINK_THREAD(avidemux3_gtk)
-ADM_INSTALL_BIN(avidemux3_gtk)
-INSTALL(FILES ${CMAKE_BINARY_DIR}/config/gtk/config.h DESTINATION "${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/gtk") 
-#
-# Packaging
-#
-include(admPackager)
-admPackager(gtkPackage)
+cmake_minimum_required(VERSION 2.6)
+
+SET(VERSION 2.6.0)
+SET(ADM_PROJECT Avidemux_gtk)
+
+MESSAGE("#########################################")
+MESSAGE("Configure for avidemux Gtk Started")
+MESSAGE("#########################################")
+MESSAGE("")
+
+include(../commonCmakeApplication.cmake)
+include(admCheckGtk)
+
+checkGtk()
+
+##########################################
+# Config
+##########################################
+ADD_DEFINITIONS(-DADM_UI_TYPE_BUILD=ADM_UI_GTK)
+SET(CONFIG_HEADER_TYPE ADM_BUILD_GTK)
+SET(UI_SUFFIX gtk)
+
+CONFIGURE_FILE("${AVIDEMUX_TOP_SOURCE_DIR}/cmake/config.h.cmake" "${CMAKE_BINARY_DIR}/config/gtk/config.h")
+MESSAGE(STATUS "GTK config.h generated")
+
+INCLUDE_DIRECTORIES("${CMAKE_BINARY_DIR}/config/gtk/")
+
+###########################################
+# Executable
+###########################################
+ADD_EXECUTABLE(avidemux3_gtk ${ADM_EXE_SRCS})
+
+########################################
+# Add subdirectories 
+########################################
+ADD_SUBDIRECTORY(../common ./common)
+ADD_SUBDIRECTORY(ADM_UIs ./ADM_UIsGtk)
+ADD_SUBDIRECTORY(ADM_userInterfaces ./ADM_userInterfacesGtk)
+
+SDLify(../common/main.cpp)
+ADD_SOURCE_CFLAGS(../common/main.cpp "-DADM_SUBVERSION=${ADM_SUBVERSION}")
+
+###########################################
+# Construct common libraries
+###########################################
+IF (ADM_DEBUG AND FIND_LEAKS)
+	TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_nvwa)
+ENDIF (ADM_DEBUG AND FIND_LEAKS)
+
+FOREACH (_libName ${commonLibs1})
+        TARGET_LINK_LIBRARIES(avidemux3_gtk ${_libName})
+ENDFOREACH (_libName ${commonLibs1})
+
+TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_filtersGtk)
+
+FOREACH (_libName ${commonLibs2})
+        TARGET_LINK_LIBRARIES(avidemux3_gtk ${_libName})
+ENDFOREACH (_libName ${commonLibs2})
+
+FOREACH (_libName ${coreLibs})
+        TARGET_LINK_LIBRARIES(avidemux3_gtk ${_libName})
+ENDFOREACH (_libName ${coreLibs})
+
+#############################################
+# Add gtk specific libs
+#############################################
+TARGET_LINK_LIBRARIES(avidemux3_gtk
+	ADM_UI_GTK
+	ADM_dialogGtk
+	#ADM_filtersGtk
+	ADM_gui2Gtk
+	ADM_toolkit6
+	ADM_coreUtils6
+	#ADM_ocrGtk
+	ADM_toolkitGtk
+	ADM_shellGtk
+	ADM_UIGtk6
+	ADM_coreAudioDevice6
+)
+
+###########################################
+# External libs
+###########################################
+# gettext
+IF (GETTEXT_FOUND)
+	TARGET_LINK_LIBRARIES(avidemux3_gtk ${GETTEXT_LIBRARY_DIR})
+ENDIF (GETTEXT_FOUND)
+
+# XVideo
+IF (USE_XV)
+        TARGET_LINK_LIBRARIES(avidemux3_gtk ${XVIDEO_LIBRARY_DIR})
+ENDIF (USE_XV)
+
+# SDL
+IF (USE_SDL)
+        TARGET_LINK_LIBRARIES(avidemux3_gtk ${SDL_LIBRARY})
+ENDIF (USE_SDL)
+
+# libxml2
+TARGET_LINK_LIBRARIES(avidemux3_gtk ${LIBXML2_LIBRARIES})
+
+###########################################
+# UI Specific
+###########################################
+TARGET_LINK_LIBRARIES(avidemux3_gtk ${GTK_LDFLAGS} ${GTHREAD_LDFLAGS})
+
+###########################################
+# OS Specific
+###########################################
+IF (WIN32)
+	target_link_libraries(ADM_osSupport)
+
+	IF (MINGW)
+		target_link_libraries(avidemux3_gtk -mno-cygwin)
+	ENDIF (MINGW)
+
+	target_link_libraries(avidemux3_gtk winmm -mwindows)
+ENDIF (WIN32)
+
+###########################################
+# Install
+###########################################
+ADM_LINK_THREAD(avidemux3_gtk)
+ADM_INSTALL_BIN(avidemux3_gtk)
+INSTALL(FILES ${CMAKE_BINARY_DIR}/config/gtk/config.h DESTINATION "${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/gtk") 
+#
+# Packaging
+#
+include(admPackager)
+admPackager(gtkPackage)

Modified: branches/avidemux_2.6_branch_mean/cmake/admCheckGlade.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admCheckGlade.cmake	2010-09-25 11:27:32 UTC (rev 6647)
+++ branches/avidemux_2.6_branch_mean/cmake/admCheckGlade.cmake	2010-09-25 11:55:56 UTC (rev 6648)
@@ -8,14 +8,12 @@
 		IF (GLADE)
 			PKG_CHECK_MODULES(GLADE libglade-2.0)
 			PRINT_LIBRARY_INFO("LibGlade" GLADE_FOUND "${GLADE_CFLAGS}" "${GLADE_LDFLAGS}")
-
 		ELSE (GLADE)
 			MESSAGE("${MSG_DISABLE_OPTION}")
 		ENDIF (GLADE)
 
-		MESSAGE("")
 		SET(GLADE_CHECKED 1)
 
 		MESSAGE("")
 	ENDIF (NOT GLADE_CHECKED)
-ENDMACRO(checkGlade)
+ENDMACRO(checkGlade)
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/cmake/admCheckGtk.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admCheckGtk.cmake	2010-09-25 11:27:32 UTC (rev 6647)
+++ branches/avidemux_2.6_branch_mean/cmake/admCheckGtk.cmake	2010-09-25 11:55:56 UTC (rev 6648)
@@ -12,20 +12,22 @@
 		IF (GTK)
 			PKG_CHECK_MODULES(PIXBUF gdk-pixbuf-2.0)
 			PRINT_LIBRARY_INFO("GdkPixBuf" PIXBUF_FOUND "${PIXBUF_CFLAGS}" "${PIXBUF_LDFLAGS}")
-                        if  (PIXBUF_FOUND)
-                        else(PIXBUF_FOUND)
-                                MESSAGE(STATUS "gdk-pixbuf not found")
-                                set(GTK_FOUND false)
-                        endif(PIXBUF_FOUND)
-        
+
+			if (NOT PIXBUF_FOUND)
+				MESSAGE(STATUS "gdk-pixbuf not found")
+				set(GTK_FOUND false)
+			endif (NOT PIXBUF_FOUND)
+
 			PKG_CHECK_MODULES(GTK gtk+-2.0)
 			PRINT_LIBRARY_INFO("GTK+" GTK_FOUND "${GTK_CFLAGS}" "${GTK_LDFLAGS}")
-                        checkGlade()
-                        if  (GLADE_FOUND)
-                        else(GLADE_FOUND)
-                                set(GTK_FOUND false)
-                        endif(GLADE_FOUND)
-                        
+			MESSAGE("")
+
+			checkGlade()
+
+			if (NOT GLADE_FOUND)
+				set(GTK_FOUND false)
+			endif (NOT GLADE_FOUND)
+
 			IF (GTK_FOUND)
 				ADM_COMPILE(gtk_x11_check.cpp "${GTK_CFLAGS}" "" "${GTK_LDFLAGS}" GTK_X11_SUPPORTED outputGtkX11Test)
 
@@ -40,17 +42,17 @@
 						MESSAGE("Error Message: ${outputGtkX11Test}")
 					ENDIF (VERBOSE)
 				ENDIF (GTK_X11_SUPPORTED)
-                               # Merge glade flags into gtk flags
-                                SET(  GTK_CFLAGS "${GTK_CFLAGS} ${GLADE_CFLAGS} ${PIXBUF_CFLAGS}")
-                                SET(  GTK_LDFLAGS "${GTK_LDFLAGS} ${GLADE_LDFLAGS} ${PIXBUF_LDFLAGS}")
-                               # /Merge glade flags into gtk flags
+
+				# Merge glade flags into gtk flags
+				SET(GTK_CFLAGS ${GTK_CFLAGS} ${GLADE_CFLAGS} ${PIXBUF_CFLAGS})
+				SET(GTK_LDFLAGS ${GTK_LDFLAGS} ${GLADE_LDFLAGS} ${PIXBUF_LDFLAGS})
+				MESSAGE("")
 			ENDIF (GTK_FOUND)
 		ELSE (GTK)
 			MESSAGE("${MSG_DISABLE_OPTION}")
+			MESSAGE("")
 		ENDIF (GTK)
 
-		MESSAGE("")
-
 		MESSAGE(STATUS "Checking for GThread")
 		MESSAGE(STATUS "********************")
 
@@ -69,4 +71,4 @@
 
 		MESSAGE("")
 	ENDIF (NOT GTK_CHECKED)
-ENDMACRO(checkGtk)
+ENDMACRO(checkGtk)
\ No newline at end of file



From gruntster at mail.berlios.de  Sat Sep 25 14:11:59 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 25 Sep 2010 14:11:59 +0200
Subject: [Avidemux-svn-commit] r6649 - in
	branches/avidemux_2.6_branch_mean/avidemux: common/ADM_render qt4
Message-ID: <20100925121159.E3197480FCF@sheep.berlios.de>

Author: gruntster
Date: 2010-09-25 14:11:59 +0200 (Sat, 25 Sep 2010)
New Revision: 6649

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
Log:
[win32] tweak Qt build so it builds with MinGW

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt	2010-09-25 11:55:56 UTC (rev 6648)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt	2010-09-25 12:11:59 UTC (rev 6649)
@@ -7,10 +7,11 @@
 GUI_xvRender.cpp
 GUI_vdpauRender.cpp
 )
-        IF (USE_OPENGL)
-                SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS} GUI_qtGlRender.cpp)
-        ENDIF (USE_OPENGL)
 
+IF (USE_OPENGL)
+	SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS} GUI_qtGlRender.cpp)
+ENDIF (USE_OPENGL)
+
 IF (APPLE)
 	SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS} GUI_sdlRenderHelper.m)
 ENDIF (APPLE)
@@ -18,15 +19,14 @@
 ADD_LIBRARY(${ADM_LIB} SHARED ${${ADM_LIB}_SRCS})
 TARGET_LINK_LIBRARIES( ${ADM_LIB} ADM_core6 ADM_coreUI6 ADM_coreImage6)
 
- IF (USE_OPENGL)
-                ADD_SOURCE_CFLAGS(GUI_render.cpp " -I${QT_HEADERS_DIR}")
-                ADD_SOURCE_CFLAGS(GUI_qtGlRender.cpp " -I${QT_HEADERS_DIR} -I{OPENGL_INCLUDE_DIR}")
-                TARGET_LINK_LIBRARIES(${ADM_LIB} ${OPENGL_LIBRARIES} ${QT_QTOPENGL_LIBRARY})
- ENDIF (USE_OPENGL)
+IF (USE_OPENGL)
+	ADD_SOURCE_CFLAGS(GUI_render.cpp " -I${QT_HEADERS_DIR}")
+	ADD_SOURCE_CFLAGS(GUI_qtGlRender.cpp " -I${QT_HEADERS_DIR} -I{OPENGL_INCLUDE_DIR}")
+	TARGET_LINK_LIBRARIES(${ADM_LIB} ${OPENGL_LIBRARIES} ${QT_QTOPENGL_LIBRARY} ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY})
+ENDIF (USE_OPENGL)
 
+SDLify(GUI_sdlRender.cpp)
 
-
-SDLify(GUI_sdlRender.cpp)
 IF (GETTEXT_FOUND)
         TARGET_LINK_LIBRARIES(${ADM_LIB}  ${GETTEXT_LIBRARY_DIR})
 ENDIF (GETTEXT_FOUND)
@@ -38,4 +38,5 @@
 IF (USE_VDPAU)
        TARGET_LINK_LIBRARIES(${ADM_LIB}  ADM_coreVDPAU6)
 ENDIF (USE_VDPAU)
+
 ADM_INSTALL_LIB(${ADM_LIB})

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-09-25 11:55:56 UTC (rev 6648)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-09-25 12:11:59 UTC (rev 6649)
@@ -1,166 +1,164 @@
-MESSAGE("#########################################")
-MESSAGE("Configure for avidemux Qt4 Started")
-MESSAGE("#########################################")
-MESSAGE("")
-SET(VERSION 2.6.0)
-CMAKE_MINIMUM_REQUIRED(VERSION 2.4.7 FATAL_ERROR)
-if (COMMAND cmake_policy)
-	cmake_policy(VERSION 2.4)
-	cmake_policy(SET CMP0003 NEW)
-	#cmake_policy(SET CMP0011 OLD)
-endif (COMMAND cmake_policy)
-SET( ADM_PROJECT Avidemux_qt4)
-# Use old behaviour
-include(../commonCmakeApplication.cmake)
-INCLUDE(admCheckQt4)
-checkQt4()
-IF (NOT QT4_FOUND)
-        MESSAGE(FATAL_ERROR "Qt4 NOT FOUND")
-ENDIF (NOT QT4_FOUND)
-# Qt4 openGL
-include(admCheckOpenGl)
-##########################################
-# Config
-##########################################
-
-SET(CONFIG_HEADER_TYPE ADM_BUILD_QT4)
-SET(UI_SUFFIX qt4)
-#
-ADD_DEFINITIONS(-DADM_UI_TYPE_BUILD=ADM_UI_QT4)
-CONFIGURE_FILE("${AVIDEMUX_TOP_SOURCE_DIR}/cmake/config.h.cmake" "${CMAKE_BINARY_DIR}/config/qt4/config.h")
-MESSAGE(STATUS "QT4 config.h generated")
-
-INCLUDE_DIRECTORIES("${CMAKE_BINARY_DIR}/config/qt4/")
-###########################################
-# Executable
-###########################################
-ADD_EXECUTABLE(avidemux3_qt4 ${ADM_EXE_SRCS})
-########################################
-# Add subdirectories 
-########################################
-INCLUDE_DIRECTORIES(ADM_UIs/include/)
-if(WIN32)
-        ADD_SUBDIRECTORY(../common ./commonQt4)
-else(WIN32)
-        # Make symlink else eclipe and kdev4 are puzzled by the tree structure
-        # Not needed for plain build
-        MESSAGE(STATUS "Creating common symlink in ${CMAKE_CURRENT_SOURCE_DIR}") 
-	execute_process(COMMAND rm -f common 	
-                                WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR})
-	execute_process(COMMAND ln -s ../common .
-                                WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR})
-        ADD_SUBDIRECTORY(common ./commonQt4)
-endif(WIN32)
-ADD_SUBDIRECTORY(ADM_UIs ./ADM_UIsQt4)
-ADD_SUBDIRECTORY(ADM_userInterfaces ./ADM_userInterfacesQT4)
-# Executable
-
-SDLify(../common/main.cpp)
-ADD_SOURCE_CFLAGS(../common/main.cpp "-DADM_SUBVERSION=${ADM_SUBVERSION}")
-###########################################
-# Construct common libraries
-###########################################
-
-IF (ADM_DEBUG AND FIND_LEAKS)
-	TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_nvwa)
-ENDIF (ADM_DEBUG AND FIND_LEAKS)
-
-FOREACH (_libName ${commonLibs1})
-        TARGET_LINK_LIBRARIES(avidemux3_qt4 ${_libName})
-ENDFOREACH (_libName ${commonLibs})
-
-
-FOREACH (_libName ${commonLibs2})
-        TARGET_LINK_LIBRARIES(avidemux3_qt4 ${_libName})
-ENDFOREACH (_libName ${commonLibs})
-#TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_filter6)
-#############################################
-# Add qt specific libs
-#############################################
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_guiQt4)
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_filtersQt4)
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UIQT46)
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_dialogQt4)
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_internalVideoFilter6)
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UIQT46)
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_guiQt4)
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UI_QT46)
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_shellQt4)
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_toolkit6)
-###########################################
-# Construct Core libraries
-###########################################
-
-FOREACH (_libName ${coreLibs})
-        TARGET_LINK_LIBRARIES(avidemux3_qt4 ${_libName})
-ENDFOREACH (_libName ${commonLibs})
-        
-
-###########################################
-# External libs
-###########################################
-# gettext
-IF (GETTEXT_FOUND)
-	TARGET_LINK_LIBRARIES(avidemux3_qt4 ${GETTEXT_LIBRARY_DIR})
-ENDIF (GETTEXT_FOUND)
-
-# XVideo
-IF (USE_XV)
-        TARGET_LINK_LIBRARIES(avidemux3_qt4 ${XVIDEO_LIBRARY_DIR})
-ENDIF (USE_XV)
-
-# SDL
-IF (USE_SDL)
-        TARGET_LINK_LIBRARIES(avidemux3_qt4 ${SDL_LIBRARY})
-ENDIF (USE_SDL)
-
-
-
-###########################################
-# UI Specific
-###########################################
-ADD_TARGET_LDFLAGS(avidemux3_qt4  ${GTHREAD_LDFLAGS})
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY})
-
-###########################################
-# OS Specific
-###########################################
-IF (WIN32)
-	target_link_libraries(ADM_osSupport)
-
-	IF (MINGW)
-		target_link_libraries(avidemux3_qt4 -mno-cygwin)
-	ENDIF (MINGW)
-
-	target_link_libraries(avidemux3_qt4 winmm)
-        ADD_TARGET_LDFLAGS(avidemux3_qt4 "-mwindows")
-
-ENDIF (WIN32)
-
-IF (APPLE)
-        IF(USE_SDL)
-               TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_libsdl)
-        ENDIF(USE_SDL)
-        ADD_TARGET_LDFLAGS(avidemux3_qt4 "-framework CoreServices -framework CoreAudio -framework AudioUnit -framework Carbon")
-
-        # for Leopard but it doesn't hurt Tiger
-        ADD_TARGET_LDFLAGS(avidemux3_qt4 "-Wl,-dylib_file,/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib:/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib")
-ENDIF (APPLE)
-
-
-#
-# xml
-#
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ${LIBXML2_LIBRARIES})
-
-###########################################
-# Install
-###########################################
-ADM_LINK_THREAD(avidemux3_qt4)
-ADM_INSTALL_BIN(avidemux3_qt4)
-INSTALL(FILES ${CMAKE_BINARY_DIR}/config/qt4/config.h DESTINATION "${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/qt4") 
-#
-# Packaging
-#
-include(admPackager)
-admPackager(qt4Package)
+cmake_minimum_required(VERSION 2.6)
+
+SET(VERSION 2.6.0)
+SET(ADM_PROJECT Avidemux_qt4)
+
+MESSAGE("#########################################")
+MESSAGE("Configure for avidemux Qt4 Started")
+MESSAGE("#########################################")
+MESSAGE("")
+
+include(../commonCmakeApplication.cmake)
+INCLUDE(admCheckQt4)
+
+checkQt4()
+
+IF (NOT QT4_FOUND)
+	MESSAGE(FATAL_ERROR "Qt4 NOT FOUND")
+ENDIF (NOT QT4_FOUND)
+
+# Qt4 openGL
+include(admCheckOpenGl)
+
+##########################################
+# Config
+##########################################
+ADD_DEFINITIONS(-DADM_UI_TYPE_BUILD=ADM_UI_QT4)
+SET(CONFIG_HEADER_TYPE ADM_BUILD_QT4)
+SET(UI_SUFFIX qt4)
+
+CONFIGURE_FILE("${AVIDEMUX_TOP_SOURCE_DIR}/cmake/config.h.cmake" "${CMAKE_BINARY_DIR}/config/qt4/config.h")
+MESSAGE(STATUS "QT4 config.h generated")
+
+INCLUDE_DIRECTORIES("${CMAKE_BINARY_DIR}/config/qt4/")
+
+###########################################
+# Executable
+###########################################
+ADD_EXECUTABLE(avidemux3_qt4 ${ADM_EXE_SRCS})
+
+########################################
+# Add subdirectories 
+########################################
+INCLUDE_DIRECTORIES(ADM_UIs/include/)
+
+if (WIN32)
+	ADD_SUBDIRECTORY(../common ./commonQt4)
+else (WIN32)
+	# Make symlink else eclipe and kdev4 are puzzled by the tree structure
+	# Not needed for plain build
+	MESSAGE(STATUS "Creating common symlink in ${CMAKE_CURRENT_SOURCE_DIR}") 
+
+	execute_process(COMMAND rm -f common 	
+                                WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR})
+	execute_process(COMMAND ln -s ../common .
+                                WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR})
+
+	ADD_SUBDIRECTORY(common ./commonQt4)
+endif (WIN32)
+
+ADD_SUBDIRECTORY(ADM_UIs ./ADM_UIsQt4)
+ADD_SUBDIRECTORY(ADM_userInterfaces ./ADM_userInterfacesQT4)
+
+SDLify(../common/main.cpp)
+ADD_SOURCE_CFLAGS(../common/main.cpp "-DADM_SUBVERSION=${ADM_SUBVERSION}")
+
+###########################################
+# Construct common libraries
+###########################################
+IF (ADM_DEBUG AND FIND_LEAKS)
+	TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_nvwa)
+ENDIF (ADM_DEBUG AND FIND_LEAKS)
+
+FOREACH (_libName ${commonLibs1})
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ${_libName})
+ENDFOREACH (_libName ${commonLibs1})
+
+FOREACH (_libName ${commonLibs2})
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ${_libName})
+ENDFOREACH (_libName ${commonLibs2})
+
+FOREACH (_libName ${coreLibs})
+	TARGET_LINK_LIBRARIES(avidemux3_qt4 ${_libName})
+ENDFOREACH (_libName ${coreLibs})
+
+#TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_filter6)
+
+#############################################
+# Add qt specific libs
+#############################################
+TARGET_LINK_LIBRARIES(avidemux3_qt4
+	ADM_guiQt4
+	ADM_filtersQt4
+	ADM_UIQT46
+	ADM_dialogQt4
+	ADM_internalVideoFilter6
+	ADM_UIQT46
+	ADM_guiQt4
+	ADM_UI_QT46
+	ADM_shellQt4
+	ADM_toolkit6
+	ADM_coreAudioDevice6
+)
+
+###########################################
+# External libs
+###########################################
+# gettext
+IF (GETTEXT_FOUND)
+	TARGET_LINK_LIBRARIES(avidemux3_qt4 ${GETTEXT_LIBRARY_DIR})
+ENDIF (GETTEXT_FOUND)
+
+# XVideo
+IF (USE_XV)
+	TARGET_LINK_LIBRARIES(avidemux3_qt4 ${XVIDEO_LIBRARY_DIR})
+ENDIF (USE_XV)
+
+# SDL
+IF (USE_SDL)
+	TARGET_LINK_LIBRARIES(avidemux3_qt4 ${SDL_LIBRARY})
+ENDIF (USE_SDL)
+
+# libxml2
+TARGET_LINK_LIBRARIES(avidemux3_qt4 ${LIBXML2_LIBRARIES})
+
+###########################################
+# UI Specific
+###########################################
+TARGET_LINK_LIBRARIES(avidemux3_qt4 ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY})
+
+###########################################
+# OS Specific
+###########################################
+IF (WIN32)
+	target_link_libraries(ADM_osSupport)
+
+	IF (MINGW)
+		target_link_libraries(avidemux3_qt4 -mno-cygwin)
+	ENDIF (MINGW)
+
+	target_link_libraries(avidemux3_qt4 winmm -mwindows)
+ENDIF (WIN32)
+
+IF (APPLE)
+	IF (USE_SDL)
+		TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_libsdl)
+	ENDIF(USE_SDL)
+
+	ADD_TARGET_LDFLAGS(avidemux3_qt4 "-framework CoreServices -framework CoreAudio -framework AudioUnit -framework Carbon")
+
+	# for Leopard but it doesn't hurt Tiger
+	ADD_TARGET_LDFLAGS(avidemux3_qt4 "-Wl,-dylib_file,/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib:/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib")
+ENDIF (APPLE)
+
+###########################################
+# Install
+###########################################
+ADM_LINK_THREAD(avidemux3_qt4)
+ADM_INSTALL_BIN(avidemux3_qt4)
+INSTALL(FILES ${CMAKE_BINARY_DIR}/config/qt4/config.h DESTINATION "${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/qt4") 
+#
+# Packaging
+#
+include(admPackager)
+admPackager(qt4Package)



From gruntster at mail.berlios.de  Sat Sep 25 14:46:29 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 25 Sep 2010 14:46:29 +0200
Subject: [Avidemux-svn-commit] r6650 - in branches/avidemux_2.6_branch_mean:
	avidemux/cli/ADM_UIs/include avidemux/cli/ADM_UIs/src
	avidemux_plugins avidemux_plugins/ADM_videoFilters6/ass
	avidemux_plugins/ADM_videoFilters6/ass/ADM_libass
	avidemux_plugins/ADM_videoFilters6/crop/cli
Message-ID: <20100925124629.C39B3480FCF@sheep.berlios.de>

Author: gruntster
Date: 2010-09-25 14:46:29 +0200 (Sat, 25 Sep 2010)
New Revision: 6650

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/include/DIA_flyDialogCli.h
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/src/DIA_flyDialogCli.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/cli/DIA_crop.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/CMakeLists.txt
Log:
[win32] tweak plugin build so it builds with MinGW

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/include/DIA_flyDialogCli.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/include/DIA_flyDialogCli.h	2010-09-25 12:11:59 UTC (rev 6649)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/include/DIA_flyDialogCli.h	2010-09-25 12:46:29 UTC (rev 6650)
@@ -23,8 +23,7 @@
   ADM_flyDialogCli(uint32_t width, uint32_t height, ADM_coreVideoFilter *in,
                               void *canvas, void *slider, int yuv, ResizeMethod resizeMethod):
                                 ADM_flyDialog(width,height,in,canvas,slider,yuv,resizeMethod) {};
-
-  virtual uint8_t  cleanup2(void);
+  virtual           ~ADM_flyDialogCli(void);
   virtual bool     isRgbInverted(void);
   virtual uint8_t  display(void);
   virtual float   calcZoomFactor(void);

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/src/DIA_flyDialogCli.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/src/DIA_flyDialogCli.cpp	2010-09-25 12:11:59 UTC (rev 6649)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/src/DIA_flyDialogCli.cpp	2010-09-25 12:46:29 UTC (rev 6650)
@@ -21,6 +21,8 @@
 #include "DIA_flyDialogCli.h"
 #include "ADM_assert.h"
 
+ADM_flyDialogCli::~ADM_flyDialogCli(void) { }
+
 void ADM_flyDialogCli::postInit(uint8_t reInit)
 {
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/CMakeLists.txt	2010-09-25 12:11:59 UTC (rev 6649)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/ADM_libass/CMakeLists.txt	2010-09-25 12:46:29 UTC (rev 6650)
@@ -1,30 +1,31 @@
-INCLUDE(admCheckFontConfig)
-checkFontConfig()
-
-#CONFIG_FONTCONFIG
-#CONFIG_ENCA
-#CONFIG_ICONV
-#
-#
-#
-
-SET(ADM_LIB ADM_libass)
-
-SET(${ADM_LIB}_SRCS 
-ass_bitmap.c  ass.c  ass_cache.c  ass_fontconfig.c  ass_library.c   ass_render.c  ass_utils.c
-ass_font.c ass_parse.c ass_drawing.c ass_render_api.c ass_strtod.c)
-#  mputils.c
-
-ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})
-ADD_DEFINITIONS(${FREETYPE2_CFLAGS} "-I${LIBICONV_INCLUDE_DIR}")
-
-IF (FONTCONFIG_FOUND)
-	ADD_DEFINITIONS(${FONTCONFIG_CFLAGS} "-DCONFIG_FONTCONFIG=1")
-ENDIF (FONTCONFIG_FOUND)
-
-# ?
-ADD_DEFINITIONS(${FONTCONFIG_CFLAGS} "-DCONFIG_ICONV=1")
-
-IF (UNIX)
-	ADD_TARGET_CFLAGS(${ADM_LIB} -fPIC)
-ENDIF (UNIX)
+INCLUDE(admCheckFontConfig)
+checkFontConfig()
+
+#CONFIG_FONTCONFIG
+#CONFIG_ENCA
+#CONFIG_ICONV
+#
+#
+#
+
+SET(ADM_LIB ADM_libass)
+
+SET(${ADM_LIB}_SRCS 
+ass_bitmap.c  ass.c  ass_cache.c  ass_fontconfig.c  ass_library.c   ass_render.c  ass_utils.c
+ass_font.c ass_parse.c ass_drawing.c ass_render_api.c ass_strtod.c)
+#  mputils.c
+
+ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})
+ADD_DEFINITIONS(${FREETYPE2_CFLAGS} "-I${LIBICONV_INCLUDE_DIR}")
+
+IF (FONTCONFIG_FOUND)
+	ADD_DEFINITIONS(${FONTCONFIG_CFLAGS} "-DCONFIG_FONTCONFIG=1")
+ENDIF (FONTCONFIG_FOUND)
+
+# ?
+ADD_DEFINITIONS(${FONTCONFIG_CFLAGS} "-DCONFIG_ICONV=1")
+TARGET_LINK_LIBRARIES(${ADM_LIB} ${LIBICONV_LIBRARY_DIR})
+
+IF (UNIX)
+	ADD_TARGET_CFLAGS(${ADM_LIB} -fPIC)
+ENDIF (UNIX)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/CMakeLists.txt	2010-09-25 12:11:59 UTC (rev 6649)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/ass/CMakeLists.txt	2010-09-25 12:46:29 UTC (rev 6650)
@@ -1,21 +1,23 @@
-INCLUDE(admCheckFreeType)
-checkFreeType()
-
-IF (USE_FREETYPE)
-	ADD_SUBDIRECTORY(ADM_libass)
-
-	INCLUDE(vf_plugin)
-	SET(ADM_vf_ssa_SRCS ADM_vidASS.cpp)
-
-        ADD_VIDEO_FILTER(ADM_vf_ssa ${ADM_vf_ssa_SRCS})
-        IF(DO_COMMON)
-         TARGET_LINK_LIBRARIES(ADM_vf_ssa ADM_libass )
-	 ADD_TARGET_LDFLAGS(ADM_vf_ssa "${FREETYPE2_LDFLAGS}")
-	 IF (FONTCONFIG_FOUND)
-                ADD_DEFINITIONS("-DUSE_FONTCONFIG")
-		ADD_TARGET_LDFLAGS(ADM_vf_ssa "${FONTCONFIG_LDFLAGS}")
-	 ENDIF (FONTCONFIG_FOUND)
-        ENDIF(DO_COMMON)
-        INIT_VIDEO_FILTER(ADM_vf_ssa)
-        INSTALL_VIDEO_FILTER(ADM_vf_ssa)
-ENDIF (USE_FREETYPE)
+INCLUDE(admCheckFreeType)
+checkFreeType()
+
+IF (USE_FREETYPE)
+	ADD_SUBDIRECTORY(ADM_libass)
+
+	INCLUDE(vf_plugin)
+	SET(ADM_vf_ssa_SRCS ADM_vidASS.cpp)
+
+	ADD_VIDEO_FILTER(ADM_vf_ssa ${ADM_vf_ssa_SRCS})
+
+	IF(DO_COMMON)
+		TARGET_LINK_LIBRARIES(ADM_vf_ssa ADM_libass ${FREETYPE2_LDFLAGS})
+
+		IF (FONTCONFIG_FOUND)
+			ADD_DEFINITIONS("-DUSE_FONTCONFIG")
+			TARGET_LINK_LIBRARIES(ADM_vf_ssa ${FONTCONFIG_LDFLAGS})
+		ENDIF (FONTCONFIG_FOUND)
+	ENDIF(DO_COMMON)
+
+	INIT_VIDEO_FILTER(ADM_vf_ssa)
+	INSTALL_VIDEO_FILTER(ADM_vf_ssa)
+ENDIF (USE_FREETYPE)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/cli/DIA_crop.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/cli/DIA_crop.cpp	2010-09-25 12:11:59 UTC (rev 6649)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/cli/DIA_crop.cpp	2010-09-25 12:46:29 UTC (rev 6650)
@@ -0,0 +1,19 @@
+#include <stdint.h>
+#include "DIA_flyDialog.h"
+#include "DIA_flyCrop.h"
+#include "../crop.h"
+
+int DIA_getCropParams(const char *name, crop *param, ADM_coreVideoFilter *in)
+{
+	return 0;
+}
+
+uint8_t flyCrop::upload(void)
+{
+	return 1;
+}
+
+uint8_t flyCrop::download(void)
+{
+	return 1;
+}
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/CMakeLists.txt	2010-09-25 12:11:59 UTC (rev 6649)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/CMakeLists.txt	2010-09-25 12:46:29 UTC (rev 6650)
@@ -1,3 +1,7 @@
+cmake_minimum_required(VERSION 2.6)
+
+SET(ADM_PROJECT AdmPlugins)
+
 MESSAGE("#####################################")
 MESSAGE("Plugins Configure Started")
 MESSAGE("#####################################")
@@ -3,7 +7,6 @@
 MESSAGE("")
 
-SET(ADM_PROJECT AdmPlugins)
 SET(PLUGINS TRUE)
-CMAKE_MINIMUM_REQUIRED(VERSION 2.4.7 FATAL_ERROR)
+
 ########################################
 # Where is the top dir ?
@@ -12,7 +15,7 @@
 IF (NOT AVIDEMUX_SOURCE_DIR)
 	MESSAGE(FATAL_ERROR "Please add -DAVIDEMUX_SOURCE_DIR=path_to_avidemux_source")
 ELSE (NOT AVIDEMUX_TOP_SOURCE_DIR)
-        # We need TOP_SOURCE_DIR 
+	# We need TOP_SOURCE_DIR 
 	SET(AVIDEMUX_TOP_SOURCE_DIR "${AVIDEMUX_SOURCE_DIR}" CACHE STRING "")
 ENDIF (NOT AVIDEMUX_SOURCE_DIR)
 
@@ -26,6 +29,7 @@
 SET(AVIDEMUX_INSTALL_DIR "${CMAKE_INSTALL_PREFIX}")
 MARK_AS_ADVANCED(AVIDEMUX_INSTALL_DIR)
 include(admInstallDir)
+
 #########################################
 # Get regular stuff from main app
 #########################################
@@ -41,109 +45,120 @@
 # Global options
 ########################################
 OPTION(VERBOSE "" OFF)
-########################################
-# Select our UI
-########################################
-SET(DO_GTK    0)
-SET(DO_QT4    0)
-SET(DO_COMMON 0)
-SET(DO_CLI    0)
-
-IF (NOT PLUGIN_UI)
-	MESSAGE(FATAL_ERROR "Please add -DPLUGIN_UI=[ALL|QT4|GTK|CLI|COMMON]")
-ENDIF (NOT PLUGIN_UI)
-if(PLUGIN_UI MATCHES "ALL")
-    SET(DO_COMMON 1)
-    SET(DO_GTK    1)
-    SET(DO_QT4    1)
-    SET(DO_CLI    1)
-endif(PLUGIN_UI MATCHES "ALL")
-if(PLUGIN_UI MATCHES "QT4")
-    SET(DO_QT4    1)
-endif(PLUGIN_UI MATCHES "QT4")
-if(PLUGIN_UI MATCHES "GTK")
-    SET(DO_GTK    1)
-endif(PLUGIN_UI MATCHES "GTK")
-if(PLUGIN_UI MATCHES "COMMON")
-    SET(DO_COMMON    1)
-endif(PLUGIN_UI MATCHES "COMMON")
-if(PLUGIN_UI MATCHES "CLI")
-    SET(DO_CLI    1)
-endif(PLUGIN_UI MATCHES "CLI")
-MESSAGE(STATUS "Plugin UI : ${PLUGIN_UI}")
+
 ########################################
+# Select our UI
+########################################
+SET(DO_GTK    0)
+SET(DO_QT4    0)
+SET(DO_COMMON 0)
+SET(DO_CLI    0)
+
+IF (NOT PLUGIN_UI)
+	MESSAGE(FATAL_ERROR "Please add -DPLUGIN_UI=[ALL|QT4|GTK|CLI|COMMON]")
+ENDIF (NOT PLUGIN_UI)
+
+if(PLUGIN_UI MATCHES "ALL")
+    SET(DO_COMMON 1)
+    SET(DO_GTK    1)
+    SET(DO_QT4    1)
+    SET(DO_CLI    1)
+endif(PLUGIN_UI MATCHES "ALL")
+
+if(PLUGIN_UI MATCHES "QT4")
+    SET(DO_QT4    1)
+endif(PLUGIN_UI MATCHES "QT4")
+
+if(PLUGIN_UI MATCHES "GTK")
+    SET(DO_GTK    1)
+endif(PLUGIN_UI MATCHES "GTK")
+
+if(PLUGIN_UI MATCHES "COMMON")
+    SET(DO_COMMON    1)
+endif(PLUGIN_UI MATCHES "COMMON")
+
+if(PLUGIN_UI MATCHES "CLI")
+    SET(DO_CLI    1)
+endif(PLUGIN_UI MATCHES "CLI")
+
+MESSAGE(STATUS "Plugin UI : ${PLUGIN_UI}")
+
+########################################
 # Check for UI libraries
-########################################
-MACRO(CHECK_ADM_CONFIG_H flavor result)
-    MESSAGE(STATUS "Checking for avidemux/${flavor} includes and lib...")
-    MESSAGE(STATUS "It should be ${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/${flavor}/config.h")
-    set(ADM_INC "NOTFOUND")
-    FIND_PATH(ADM_INC config.h "${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/${flavor}")
-    #MESSAGE(STATUS "result : ${ADM_INC_NOT_FOUND},${ADM_INC}")
-    IF(${ADM_INC} MATCHES "NOTFOUND")
-        SET(${result} 0)
-        MESSAGE(STATUS "Include for ${flavor} not found")
-    ELSE(${ADM_INC} MATCHES "NOTFOUND")
-        SET(${result} 1)
-        MESSAGE(STATUS "Include for ${flavor} found")
-    ENDIF(${ADM_INC} MATCHES "NOTFOUND")
+########################################
+MACRO(CHECK_ADM_CONFIG_H flavor result)
+    MESSAGE(STATUS "Checking for avidemux/${flavor} includes and lib...")
+    MESSAGE(STATUS "It should be ${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/${flavor}/config.h")
+    set(ADM_INC "NOTFOUND")
+    FIND_PATH(ADM_INC config.h "${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/${flavor}")
+    #MESSAGE(STATUS "result : ${ADM_INC_NOT_FOUND},${ADM_INC}")
+    IF(${ADM_INC} MATCHES "NOTFOUND")
+        SET(${result} 0)
+        MESSAGE(STATUS "Include for ${flavor} not found")
+    ELSE(${ADM_INC} MATCHES "NOTFOUND")
+        SET(${result} 1)
+        MESSAGE(STATUS "Include for ${flavor} found")
+    ENDIF(${ADM_INC} MATCHES "NOTFOUND")
 ENDMACRO(CHECK_ADM_CONFIG_H flavor result)
-#*****
-# GTK
-#*****
-MESSAGE(STATUS "Checking flavors to build (gtk/qt4/...)")
-MESSAGE(STATUS "***************************************")
+
+#*****
+# GTK
+#*****
+MESSAGE(STATUS "Checking flavors to build (gtk/qt4/...)")
+MESSAGE(STATUS "***************************************")
 if(DO_GTK)
     INCLUDE(admCheckGtk)
-    INCLUDE(admCheckGlade)
+    INCLUDE(admCheckGlade)
     INCLUDE(admCheckGettext)
     checkGtk()
-    checkGlade()
-    checkGettext()
-    IF (GTK_FOUND AND GTHREAD_FOUND)
-        MESSAGE(STATUS "Gtk and gthread found, good")
-        CHECK_ADM_CONFIG_H(gtk ADM_INC)
-        IF(NOT ADM_INC)
-            MESSAGE(ERROR " GTK UI requested, but cannot find header file for avidemux/gtk...disabling it")
-            SET(DO_GTK 0)
-        ENDIF(NOT ADM_INC)
-    else (GTK_FOUND AND GTHREAD_FOUND)
-        MESSAGE(ERROR " GTK UI requested, but gtk/gthread libraties not found... disabling it")
-        SET(DO_GTK 0)
-    endif (GTK_FOUND AND GTHREAD_FOUND)
-endif(DO_GTK)
-#*****
-# QT4
-#*****
+    checkGlade()
+    checkGettext()
+    IF (GTK_FOUND AND GTHREAD_FOUND)
+        MESSAGE(STATUS "Gtk and gthread found, good")
+        CHECK_ADM_CONFIG_H(gtk ADM_INC)
+        IF(NOT ADM_INC)
+            MESSAGE(ERROR " GTK UI requested, but cannot find header file for avidemux/gtk...disabling it")
+            SET(DO_GTK 0)
+        ENDIF(NOT ADM_INC)
+    else (GTK_FOUND AND GTHREAD_FOUND)
+        MESSAGE(ERROR " GTK UI requested, but gtk/gthread libraties not found... disabling it")
+        SET(DO_GTK 0)
+    endif (GTK_FOUND AND GTHREAD_FOUND)
+endif(DO_GTK)
+
+#*****
+# QT4
+#*****
 if(DO_QT4)
     INCLUDE(admCheckQt4)
-    checkQt4()
-    IF (NOT QT4_FOUND)
-        SET(DO_QT4 0)
-        MESSAGE(ERROR " QT4 UI requested, but qt4 libraties not found... disabling it")
-    ELSE (NOT QT4_FOUND)
-        MESSAGE(STATUS " QT4 libraries found, good")
-        CHECK_ADM_CONFIG_H(qt4 ADM_INC)
-        IF(NOT ADM_INC)
-            MESSAGE(ERROR " QT4 UI requested, but cannot find header file for avidemux/qt4...disabling it")
-            SET(DO_QT4 0)
-        ENDIF(NOT ADM_INC)
-    ENDIF (NOT QT4_FOUND)
-endif(DO_QT4)
-#*****
-# CLI
-#*****
-if(DO_CLI)
-        CHECK_ADM_CONFIG_H(cli ADM_INC)
-        IF(NOT ADM_INC)
-            MESSAGE(ERROR " CLI UI requested, but cannot find header file for avidemux/cli...disabling it")
-            SET(DO_CLI 0)
-        ENDIF(NOT ADM_INC)
-endif(DO_CLI)
+    checkQt4()
+    IF (NOT QT4_FOUND)
+        SET(DO_QT4 0)
+        MESSAGE(ERROR " QT4 UI requested, but qt4 libraties not found... disabling it")
+    ELSE (NOT QT4_FOUND)
+        MESSAGE(STATUS " QT4 libraries found, good")
+        CHECK_ADM_CONFIG_H(qt4 ADM_INC)
+        IF(NOT ADM_INC)
+            MESSAGE(ERROR " QT4 UI requested, but cannot find header file for avidemux/qt4...disabling it")
+            SET(DO_QT4 0)
+        ENDIF(NOT ADM_INC)
+    ENDIF (NOT QT4_FOUND)
+endif(DO_QT4)
 
+#*****
+# CLI
+#*****
+if(DO_CLI)
+        CHECK_ADM_CONFIG_H(cli ADM_INC)
+        IF(NOT ADM_INC)
+            MESSAGE(ERROR " CLI UI requested, but cannot find header file for avidemux/cli...disabling it")
+            SET(DO_CLI 0)
+        ENDIF(NOT ADM_INC)
+endif(DO_CLI)
+
 ########################################
 # Actual work to do..
-########################################
+########################################
 IF(DO_COMMON)
     ADD_SUBDIRECTORY(ADM_audioDecoders)
     ADD_SUBDIRECTORY(ADM_audioDevices)
@@ -151,16 +166,18 @@
     ADD_SUBDIRECTORY(ADM_videoDecoder)
     ADD_SUBDIRECTORY(ADM_audioEncoders)
     ADD_SUBDIRECTORY(ADM_demuxers)
-    ADD_SUBDIRECTORY(ADM_muxers)
+    ADD_SUBDIRECTORY(ADM_muxers)
 ENDIF(DO_COMMON)
+
 ADD_SUBDIRECTORY(ADM_videoFilters6)
+
 ########################################
 # Config Summary
 ########################################
 INCLUDE(admPluginConfigSummary)
 MESSAGE("")
-#
-# Packaging
-#
-include(admPackager)
-admPackager(pluginsPackage)
+#
+# Packaging
+#
+include(admPackager)
+admPackager(pluginsPackage)
\ No newline at end of file



From mean at mail.berlios.de  Sat Sep 25 17:02:30 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 25 Sep 2010 17:02:30 +0200
Subject: [Avidemux-svn-commit] r6651 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src
Message-ID: <20100925150230.44B2E480FCF@sheep.berlios.de>

Author: mean
Date: 2010-09-25 17:02:30 +0200 (Sat, 25 Sep 2010)
New Revision: 6651

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
Log:
[Merge] avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2010-09-25 12:46:29 UTC (rev 6650)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2010-09-25 15:02:30 UTC (rev 6651)
@@ -611,7 +611,8 @@
     char buf[256];
   
     vsnprintf(buf, sizeof(buf), fmt, list);
-    printf("[lavc] %s",buf);
+    if(level<=AV_LOG_INFO)
+        ADM_info("[lavc] %s",buf);
 }
 
 void ADM_lavDestroy(void)



From mean at mail.berlios.de  Sat Sep 25 17:02:31 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 25 Sep 2010 17:02:31 +0200
Subject: [Avidemux-svn-commit] r6652 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio:
	include src
Message-ID: <20100925150231.6C5C2480FCF@sheep.berlios.de>

Author: mean
Date: 2010-09-25 17:02:31 +0200 (Sat, 25 Sep 2010)
New Revision: 6652

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStreamPCM.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamPCM.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStream.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/CMakeLists.txt
Log:
[coreAudio] Add PCM packetizer

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStreamPCM.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStreamPCM.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStreamPCM.h	2010-09-25 15:02:31 UTC (rev 6652)
@@ -0,0 +1,45 @@
+/***************************************************************************
+                          ADM_audioStreamPCM.h  -  description
+                             -------------------
+    copyright            : (C) 2008 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_audioStreamPCM_H
+#define ADM_audioStreamPCM_H
+
+#include "ADM_audioStreamBuffered.h"
+
+
+/**
+        \fn ADM_audioStreamAC3
+        \brief Class to handle AC3/AC3 streams
+
+*/
+class ADM_audioStreamPCM : public ADM_audioStream
+{
+        protected:
+        public:
+/// Default constructor
+                       ADM_audioStreamPCM(WAVHeader *header,ADM_audioAccess *access);  
+/// Destructor
+virtual                 ~ADM_audioStreamPCM();
+///  Get a packet
+virtual uint8_t         getPacket(uint8_t *buffer,uint32_t *size, uint32_t sizeMax,
+                                uint32_t *nbSample,uint64_t *dts);
+/// Go to a given time, in microseconds
+virtual bool            goToTime(uint64_t nbUs);
+/// Returns or compute duration. If the access cannot provide it, it will be computed here
+        uint64_t        getDurationInUs(void) {return durationInUs;}
+};
+#endif
+// EOF
+

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStream.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStream.cpp	2010-09-25 15:02:30 UTC (rev 6651)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStream.cpp	2010-09-25 15:02:31 UTC (rev 6652)
@@ -9,6 +9,7 @@
 #include "ADM_audioStreamAC3.h"
 #include "ADM_audioStreamEac3.h"
 #include "ADM_audioStreamDCA.h"
+#include "ADM_audioStreamPCM.h"
 #include "ADM_audioStreamConstantChunk.h"
 #include "ADM_audioCodecEnum.h"
 /**
@@ -144,6 +145,9 @@
         case WAV_MP2:
         case WAV_MP3:
             return new ADM_audioStreamMP3(wavheader,access);
+        case WAV_PCM:
+        case WAV_LPCM:
+            return new ADM_audioStreamPCM(wavheader,access);
         case WAV_DTS:
             return new ADM_audioStreamDCA(wavheader,access);
 #if 0

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamPCM.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamPCM.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamPCM.cpp	2010-09-25 15:02:31 UTC (rev 6652)
@@ -0,0 +1,73 @@
+/**
+    \file ADM_audioStreamPCM
+    \brief AC3 Handling class
+
+*/
+#include "ADM_default.h"
+#include "ADM_audioStreamPCM.h"
+
+/**
+    \fn ADM_audioStreamAC3
+    \brief constructor
+*/
+ADM_audioStreamPCM::ADM_audioStreamPCM(WAVHeader *header,ADM_audioAccess *access) : ADM_audioStream(header,access)
+{
+    if(access->canGetDuration()==false)
+    {
+        // We can compute the duration from the length
+        float size=access->getLength();
+              size/=header->byterate; // Result is in second
+              size*=1000;
+              size*=1000; // s->us
+              durationInUs=(uint64_t)size;
+    }
+}
+
+/**
+    \fn ADM_audioStream
+    \brief destructor
+*/
+ADM_audioStreamPCM::~ADM_audioStreamPCM()
+{
+   
+}
+/**
+    \fn goToTime
+    \brief goToTime
+*/
+bool         ADM_audioStreamPCM::goToTime(uint64_t nbUs)
+{
+    if(access->canSeekTime()==true)
+    {
+        if( access->goToTime(nbUs)==true)
+        {
+           setDts(nbUs);
+           return 1;
+        }
+        return 1;
+    }
+    // If CBR we can use the default way
+    return ADM_audioStream::goToTime(nbUs);
+    
+}
+/**
+        \fn getPacket
+*/
+uint8_t ADM_audioStreamPCM::getPacket(uint8_t *obuffer,uint32_t *osize, 
+                                      uint32_t sizeMax,uint32_t *nbSample,uint64_t *dts)
+{
+uint64_t thisDts=0;
+    if(!access->getPacket(obuffer,osize,sizeMax,&thisDts)) return 0;
+    uint32_t bytesPerSample=wavHeader.channels*2; 
+#warning fixme handle mono
+    *nbSample=(uint32_t)(*osize/bytesPerSample);
+    if(thisDts!=ADM_NO_PTS) 
+            setDts(thisDts);
+    *dts=lastDts;
+    advanceDtsBySample(*nbSample);
+    return 1;
+            
+    
+}
+
+// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/CMakeLists.txt	2010-09-25 15:02:30 UTC (rev 6651)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/CMakeLists.txt	2010-09-25 15:02:31 UTC (rev 6652)
@@ -7,6 +7,7 @@
 ADM_audioStreamAC3.cpp
 ADM_audioStreamEac3.cpp
 ADM_audioStreamDCA.cpp
+ADM_audioStreamPCM.cpp
 ADM_audioStreamConstantChunk.cpp
 )	
 #*************************************************



From mean at mail.berlios.de  Sat Sep 25 17:02:32 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 25 Sep 2010 17:02:32 +0200
Subject: [Avidemux-svn-commit] r6653 - in
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate:
	include src
Message-ID: <20100925150232.C0A63480FCF@sheep.berlios.de>

Author: mean
Date: 2010-09-25 17:02:32 +0200 (Sat, 25 Sep 2010)
New Revision: 6653

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoCopy.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopy.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/CMakeLists.txt
Log:
[H264] AnnexB->iso, incomplete

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoCopy.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoCopy.h	2010-09-25 15:02:31 UTC (rev 6652)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoCopy.h	2010-09-25 15:02:32 UTC (rev 6653)
@@ -19,6 +19,9 @@
             ADMCompressedImage image;
             bool eofMet;
             uint64_t  rescaleTs(uint64_t in);
+            uint64_t  rewindTime;
+
+            bool      rewind(void);
 public:
              ADM_videoStreamCopy(uint64_t startTime,uint64_t endTime);
     virtual ~ADM_videoStreamCopy();
@@ -29,5 +32,27 @@
 virtual     uint64_t getVideoDuration(void);
 virtual     uint64_t getStartTime(void);
 };
+/**
+        \fn ADM_videoStreamCopyFromAnnexB
+        \brief Same as copy but does annexB->mp4/iso on the fly
+*/
+class ADM_videoStreamCopyFromAnnexB : public ADM_videoStreamCopy
+{
+protected:
+#define ADM_COPY_FROM_ANNEX_B_SIZE (1920*1200*3)
+        uint8_t         buffer[ADM_COPY_FROM_ANNEX_B_SIZE];
+        ADMBitstream    *myBitstream;
+        uint8_t         *myExtra;
+        uint32_t        myExtraLen;
+        bool            findNalu(int nalu,uint8_t *start,uint8_t *end,uint8_t **outPtr,uint32_t *outLen);
+        int             convertFromAnnexB(uint8_t *inData,uint32_t inSize,
+                                                      uint8_t *outData,uint32_t outMaxSize);
 
+public:
+                        ADM_videoStreamCopyFromAnnexB(uint64_t startTime,uint64_t endTime);
+        virtual         ~ADM_videoStreamCopyFromAnnexB();
+        virtual bool    getPacket(ADMBitstream *out);
+        virtual bool    getExtraData(uint32_t *extraLen, uint8_t **extraData) ;
+};
+
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopy.cpp	2010-09-25 15:02:31 UTC (rev 6652)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopy.cpp	2010-09-25 15:02:32 UTC (rev 6653)
@@ -18,8 +18,16 @@
 #include "ADM_default.h"
 #include "ADM_videoCopy.h"
 #include "ADM_editor/ADM_edit.hxx"
+#include "ADM_coreUtils.h"
+extern ADM_Composer *video_body; // Fixme!
+extern bool ADM_findH264StartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset);
 
-extern ADM_Composer *video_body; // Fixme!
+#if 1
+#define aprintf ADM_info
+#else
+#define aprintf(...) {}
+#endif
+
 /**
     \fn ADM_videoStreamCopy
 */
@@ -62,12 +70,20 @@
     this->startTimeDts=dtsStart;
     this->startTimePts=ptsStart;
     this->endTimePts=endTime;
-
-    video_body->GoToIntraTime_noDecoding(ptsStart);
+    rewindTime=ptsStart;
+    rewind();
+    
     ADM_info(" Fixating start time by %d\n",abs((int)(startTime-startTimeDts)));
     ADM_info(" Starting DTS=%"LLU", PTS=%"LLU" ms\n",startTimeDts/1000,startTimePts/1000);
 }
 /**
+
+*/
+bool      ADM_videoStreamCopy::rewind(void)
+{
+    return video_body->GoToIntraTime_noDecoding(rewindTime);
+}
+/**
     \fn ADM_videoStreamCopy
 */
 ADM_videoStreamCopy::~ADM_videoStreamCopy()
@@ -163,3 +179,5 @@
 {
     return true;
 }
+
+// EOF

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-25 15:02:32 UTC (rev 6653)
@@ -0,0 +1,257 @@
+/**
+    \file ADM_videoCopyFromAnnexB
+    \brief Convert from annexB h264 to iso on the fly
+    (c) Mean 2010/GPLv2
+
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_cpp.h"
+using std::string;
+#include "ADM_default.h"
+#include "ADM_videoCopy.h"
+#include "ADM_editor/ADM_edit.hxx"
+#include "ADM_coreUtils.h"
+#include "ADM_h264_tag.h"
+extern bool ADM_findH264StartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset);
+extern void mixDump(uint8_t *ptr, uint32_t len);
+#if 1
+#define aprintf ADM_info
+#else
+#define aprintf(...) {}
+#endif
+
+static uint32_t readBE32(uint8_t *p)
+{
+    uint32_t v=(p[0]<<8)+p[1];
+    uint32_t u=(p[2]<<8)+p[3];
+    return (v<<16)+u;
+}
+static void writeBE32(uint8_t *p, uint32_t size)
+{
+    p[0]=size>>24;
+    p[1]=(size>>16)&0xff;
+    p[2]=(size>>8)&0xff;
+    p[3]=(size>>0)&0xff;
+}
+
+/**
+    \fn findNalu
+*/
+bool ADM_videoStreamCopyFromAnnexB::findNalu(int nalu,uint8_t *start,uint8_t *end,
+            uint8_t **outPtr,uint32_t *outLen)
+{
+    uint8_t *realstart=start;
+    while(start+5<end) // NALU starts with 4 bytes size + (1 bytes nalu id, size-1 other payload)
+    {
+        uint32_t len=readBE32(start);
+        uint8_t  n=start[4];
+        if(len+start+4>end)
+        {
+            ADM_warning("Nal size too big (%d)\n",len);
+            return false;
+        }
+        aprintf("Looking for %x found %x, size=%d at offset 0x%x\n",nalu,n,len,start-realstart);
+        if((n&0x1f)==nalu)
+        {
+            *outPtr=start+5;
+            *outLen=len-1;
+            return true;
+        }
+        start+=4+len;
+    }
+    return false;
+}
+
+/**
+    \fn ctor
+*/
+ADM_videoStreamCopyFromAnnexB::ADM_videoStreamCopyFromAnnexB(uint64_t startTime,uint64_t endTime):
+      ADM_videoStreamCopy(startTime,endTime)  
+{
+    ADM_info("AnnexB to iso filter\n");
+    myBitstream=new ADMBitstream(ADM_COPY_FROM_ANNEX_B_SIZE);
+    myBitstream->data=buffer;
+
+    myExtra=NULL;
+    myExtraLen=0;
+    // Read First frame, it contains PPS & SPS
+    // Built avc-like atom from it.
+    if(true==ADM_videoStreamCopy::getPacket(myBitstream))
+    {
+        uint8_t *tmp=new uint8_t[myBitstream->len*2];
+        
+        int size=convertFromAnnexB(myBitstream->data,myBitstream->len,tmp+10,myBitstream->len*2-10);
+        // search sps
+        uint8_t *spsStart,*ppsStart;
+        uint32_t spsLen=0, ppsLen=0;
+
+        if(false==findNalu(NAL_SPS,tmp+10,tmp+size-10,&spsStart,&spsLen))
+        {
+            ADM_error("Cannot find SPS");
+            
+        }
+        if(false==findNalu(NAL_PPS,tmp+10,tmp+size-10,&ppsStart,&ppsLen))
+        {
+            ADM_error("Cannot find PPS");
+            
+        }
+        if(spsLen && ppsLen)
+        {
+            ADM_info("Copy from annexB: Found sps=%d, pps=%d.\n",(int)spsLen,(int)ppsLen);
+            // Build extraData
+            myExtraLen=5+1+2+spsLen+1+2+ppsLen;
+            myExtra=new uint8_t[myExtraLen];
+            uint8_t *ptr=myExtra;
+            *ptr++=1;
+            *ptr++=0x64;
+            *ptr++=0x00;
+            *ptr++=0x33;
+            *ptr++=0xff;
+
+            *ptr++=0xe1;
+            *ptr++=spsLen>>8;
+            *ptr++=spsLen&0xff;
+
+            memcpy(ptr,spsStart,spsLen);
+            ptr+=spsLen;
+
+            *ptr++=0x1;
+            *ptr++=ppsLen>>8;
+            *ptr++=ppsLen&0xff;
+
+            memcpy(ptr,ppsStart,ppsLen);
+            ptr+=ppsLen;
+
+            ADM_info("generated %d bytes of extradata.\n",(int)myExtraLen);
+            mixDump(myExtra, myExtraLen);
+        }
+        delete [] tmp;
+
+    }else ADM_warning("Cannot read first frame to get PPS and SPS");
+    rewind();
+
+}
+/**
+
+    \fn dtor
+
+*/
+
+ADM_videoStreamCopyFromAnnexB::~ADM_videoStreamCopyFromAnnexB()
+{
+    ADM_info("Destroying AnnexB to iso filtet\n");
+    delete myBitstream;
+    myBitstream=NULL;
+}
+/**
+    \fn unescape
+    \brief should be moved to coreUtils
+*/
+static uint32_t unescape(uint8_t *in, uint32_t len,uint8_t *out)
+{
+  uint32_t outlen=0;
+  uint8_t *tail=in+len;
+    if(len<3) return 0;
+    while(in<tail-3)
+    {
+      if(!in[0]  && !in[1] && in[2]==3)
+      {
+        out[0]=0;
+        out[1]=0;
+        out+=2;
+        outlen+=2;
+        in+=3;
+        continue;
+      }
+      *out++=*in++;
+      outlen++;
+    }
+    // copy last bytes
+    uint32_t left=tail-in;
+    memcpy(out,in,left);
+    outlen+=left;
+    return outlen;
+ ;
+
+}
+/**
+    \fn convertFromAnnexB   
+    \brief convert annexB startcode (00 00 00 0 xx) to NALU
+*/
+int ADM_videoStreamCopyFromAnnexB::convertFromAnnexB(uint8_t *inData,uint32_t inSize,
+                                                      uint8_t *outData,uint32_t outMaxSize)
+{
+    uint8_t *tail=inData+inSize;
+    uint8_t *head=inData;
+    uint8_t *tgt=outData;
+    uint8_t startCode;
+    uint32_t offset;
+    bool first=true;
+    uint8_t oldStartCode;
+    while(head<tail)
+    {
+        if(false==ADM_findH264StartCode(head,tail,&startCode,&offset))
+            break;
+        if(true==first)
+        {
+            oldStartCode=startCode;
+            head+=offset; // First startcode
+            first=false;
+            continue;
+        }
+        uint32_t toEscape=offset-5; // ignore startcode
+        uint32_t nalHeaderSize=4;
+        uint32_t nalSize=unescape(head,toEscape,tgt+nalHeaderSize+1);
+        head+=offset;
+        writeBE32(tgt,1+nalSize);
+        aprintf("%x , %d -> %d at offset 0x%x\n",oldStartCode,toEscape,nalSize,tgt-outData);
+        tgt[nalHeaderSize]=oldStartCode;
+        tgt+=nalSize+1+nalHeaderSize;
+        
+
+        oldStartCode=startCode;
+    }
+    uint32_t toEscape=tail-head;
+    uint32_t nalHeaderSize=4;
+    uint32_t nalSize=unescape(head,toEscape,tgt+nalHeaderSize+1);
+    writeBE32(tgt,1+nalSize);
+    aprintf("%x , %d -> %d at offset 0x%x\n",oldStartCode,toEscape,nalSize,tgt-outData);
+    tgt[nalHeaderSize]=oldStartCode;
+    tgt+=1+nalSize+nalHeaderSize;
+    int outputSize=tgt-outData;
+    ADM_assert(outputSize<outMaxSize);
+    return outputSize;
+}
+/**
+    \fn getPacket
+*/
+
+bool    ADM_videoStreamCopyFromAnnexB::getPacket(ADMBitstream *out)
+{
+    if(false==ADM_videoStreamCopy::getPacket(myBitstream)) return false;
+    aprintf("---------------\n");
+    int size=convertFromAnnexB(myBitstream->data,myBitstream->len,out->data,out->bufferSize);
+    out->len=size;
+    out->dts=myBitstream->dts;
+    out->pts=myBitstream->pts;
+    out->flags=myBitstream->flags;
+    return true;
+}
+/**
+
+*/
+bool    ADM_videoStreamCopyFromAnnexB::getExtraData(uint32_t *extraLen, uint8_t **extraData) 
+{
+    *extraData=myExtra;
+    *extraLen=myExtraLen;
+    return 0;
+}
+// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/CMakeLists.txt	2010-09-25 15:02:31 UTC (rev 6652)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/CMakeLists.txt	2010-09-25 15:02:32 UTC (rev 6653)
@@ -2,6 +2,7 @@
 ADM_videoCopy.cpp
 ADM_videoProcess.cpp
 ADM_createStreams.cpp
+ADM_videoCopyFromAnnexB.cpp
 )
 include_directories(../include)
 ADD_LIBRARY(ADM_muxerGate6 STATIC ${ADM_muxerGate_SRCS})



From mean at mail.berlios.de  Sat Sep 25 17:02:33 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 25 Sep 2010 17:02:33 +0200
Subject: [Avidemux-svn-commit] r6654 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src
Message-ID: <20100925150233.F0BAE480FCF@sheep.berlios.de>

Author: mean
Date: 2010-09-25 17:02:33 +0200 (Sat, 25 Sep 2010)
New Revision: 6654

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/avidemutils.cpp
Log:
[coreUtils] Add findH264 startcode

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/avidemutils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/avidemutils.cpp	2010-09-25 15:02:32 UTC (rev 6653)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/avidemutils.cpp	2010-09-25 15:02:33 UTC (rev 6654)
@@ -222,6 +222,34 @@
 	}
 	return false; // startcode not found
 }
+/**
+    \file ADM_findH264StartCode
+    \brief    Find mpeg1/2/4 video startcode
+    00 00 00 01 xx yy
+    return xx + offset to yy
+
+*/
+
+bool ADM_findH264StartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset)
+{
+    uint32_t startcode=0xffffffff;
+    uint8_t  *ptr=start;
+    end--;
+
+    while(ptr<end)
+	{
+		startcode=(startcode<<8)+*ptr;
+		if(1==startcode)
+		{
+			*outstartcode=ptr[1];
+			*offset=ptr-start+2;
+			return true;
+		}
+		ptr++;
+	}
+	return false; // startcode not found
+}
+
 //**********************************************************
 // Convert \ to \\
 // Needed for win32 which uses \ to store filename+path



From mean at mail.berlios.de  Sat Sep 25 17:02:34 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 25 Sep 2010 17:02:34 +0200
Subject: [Avidemux-svn-commit] r6655 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml
Message-ID: <20100925150235.0D950480FCF@sheep.berlios.de>

Author: mean
Date: 2010-09-25 17:02:34 +0200 (Sat, 25 Sep 2010)
New Revision: 6655

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_openDMLDepack.cpp
Log:
[openDML/Demux] Use ADM_findH264StartCode

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_openDMLDepack.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_openDMLDepack.cpp	2010-09-25 15:02:33 UTC (rev 6654)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_openDMLDepack.cpp	2010-09-25 15:02:34 UTC (rev 6655)
@@ -43,7 +43,8 @@
 #define MAX_VOP 10
 
 /* Forward declaration */
-uint8_t ADM_findMpegStartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset);
+bool    ADM_findMpegStartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset);
+bool    ADM_findH264StartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset);
 uint8_t extractVopInfo(uint8_t *data, uint32_t len,uint32_t timeincbits,uint32_t *vopType,uint32_t *modulo, uint32_t *time_inc,uint32_t *vopcoded);
 uint8_t extractMpeg4Info(uint8_t *data,uint32_t dataSize,uint32_t *w,uint32_t *h,uint32_t *time_inc);
 



From mean at mail.berlios.de  Sat Sep 25 17:02:36 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 25 Sep 2010 17:02:36 +0200
Subject: [Avidemux-svn-commit] r6656 - in
	branches/avidemux_2.6_branch_mean/avidemux/common: .
	ADM_muxerGate/include ADM_muxerGate/src
Message-ID: <20100925150236.67C8A480FCF@sheep.berlios.de>

Author: mean
Date: 2010-09-25 17:02:36 +0200 (Sat, 25 Sep 2010)
New Revision: 6656

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoCopy.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
Log:
[annexb] Better but still incomplete annexb to iso copy

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoCopy.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoCopy.h	2010-09-25 15:02:34 UTC (rev 6655)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoCopy.h	2010-09-25 15:02:36 UTC (rev 6656)
@@ -45,6 +45,7 @@
         uint8_t         *myExtra;
         uint32_t        myExtraLen;
         bool            findNalu(int nalu,uint8_t *start,uint8_t *end,uint8_t **outPtr,uint32_t *outLen);
+        bool            compactNalus(ADMBitstream *out);
         int             convertFromAnnexB(uint8_t *inData,uint32_t inSize,
                                                       uint8_t *outData,uint32_t outMaxSize);
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-25 15:02:34 UTC (rev 6655)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-25 15:02:36 UTC (rev 6656)
@@ -24,8 +24,10 @@
 extern void mixDump(uint8_t *ptr, uint32_t len);
 #if 1
 #define aprintf ADM_info
+#define check isNalValid
 #else
 #define aprintf(...) {}
+#define check(...) {}
 #endif
 
 static uint32_t readBE32(uint8_t *p)
@@ -41,9 +43,27 @@
     p[2]=(size>>8)&0xff;
     p[3]=(size>>0)&0xff;
 }
-
+static const char *nalType[13]=
+{
+    "invalid","nonIdr","invalid","invalid","invalid",
+    "idr","sei","sps","pps","au delimiter","invalid","invalid","filler"
+};
+static bool isNalValid(int nal)
+{
+    nal&=0x1f;
+    switch(nal)
+    {
+        case 1:case 5:case 6: case 7: case 8: case 9:case 0xc:
+                break;
+        default:
+            ADM_warning("Invalid NAL 0x%x\n",nal);
+    }
+    if(nal<=12) ADM_info("Nal : %s",nalType[nal]);
+    return true;
+}
 /**
     \fn findNalu
+    \brief lookup for a specific NALU in the given buffer
 */
 bool ADM_videoStreamCopyFromAnnexB::findNalu(int nalu,uint8_t *start,uint8_t *end,
             uint8_t **outPtr,uint32_t *outLen)
@@ -53,11 +73,13 @@
     {
         uint32_t len=readBE32(start);
         uint8_t  n=start[4];
+        
         if(len+start+4>end)
         {
             ADM_warning("Nal size too big (%d)\n",len);
             return false;
         }
+        check(n);
         aprintf("Looking for %x found %x, size=%d at offset 0x%x\n",nalu,n,len,start-realstart);
         if((n&0x1f)==nalu)
         {
@@ -110,20 +132,20 @@
             myExtraLen=5+1+2+spsLen+1+2+ppsLen;
             myExtra=new uint8_t[myExtraLen];
             uint8_t *ptr=myExtra;
-            *ptr++=1;
-            *ptr++=0x64;
-            *ptr++=0x00;
-            *ptr++=0x33;
-            *ptr++=0xff;
+            *ptr++=1;           // AVC version
+            *ptr++=0x64;        // Profile
+            *ptr++=0x00;        // Profile
+            *ptr++=0x33;        // Level
+            *ptr++=0xff;        // Nal size minus 1
 
-            *ptr++=0xe1;
+            *ptr++=0xe1;        // SPS
             *ptr++=spsLen>>8;
             *ptr++=spsLen&0xff;
 
             memcpy(ptr,spsStart,spsLen);
             ptr+=spsLen;
 
-            *ptr++=0x1;
+            *ptr++=0x1;         // PPS
             *ptr++=ppsLen>>8;
             *ptr++=ppsLen&0xff;
 
@@ -152,32 +174,38 @@
     myBitstream=NULL;
 }
 /**
-    \fn unescape
+    \fn unescapeH264
     \brief should be moved to coreUtils
 */
-static uint32_t unescape(uint8_t *in, uint32_t len,uint8_t *out)
+static uint32_t unescapeH264(uint8_t *in, uint32_t len,uint8_t *out)
 {
   uint32_t outlen=0;
+  uint8_t *start=out;
   uint8_t *tail=in+len;
-    if(len<3) return 0;
-    while(in<tail-3)
+
+    if(len<3) 
     {
+        memcpy(out,in,len);
+        return len;
+    }
+    while(in+3<tail)
+    {
       if(!in[0]  && !in[1] && in[2]==3)
       {
         out[0]=0;
         out[1]=0;
         out+=2;
-        outlen+=2;
         in+=3;
         continue;
       }
       *out++=*in++;
-      outlen++;
     }
     // copy last bytes
     uint32_t left=tail-in;
     memcpy(out,in,left);
-    outlen+=left;
+    out+=left;
+    outlen=out-start;
+    ADM_assert(outlen<=len);
     return outlen;
  ;
 
@@ -200,6 +228,7 @@
     {
         if(false==ADM_findH264StartCode(head,tail,&startCode,&offset))
             break;
+        check(startCode);
         if(true==first)
         {
             oldStartCode=startCode;
@@ -209,7 +238,7 @@
         }
         uint32_t toEscape=offset-5; // ignore startcode
         uint32_t nalHeaderSize=4;
-        uint32_t nalSize=unescape(head,toEscape,tgt+nalHeaderSize+1);
+        uint32_t nalSize=unescapeH264(head,toEscape,tgt+nalHeaderSize+1);
         head+=offset;
         writeBE32(tgt,1+nalSize);
         aprintf("%x , %d -> %d at offset 0x%x\n",oldStartCode,toEscape,nalSize,tgt-outData);
@@ -221,7 +250,7 @@
     }
     uint32_t toEscape=tail-head;
     uint32_t nalHeaderSize=4;
-    uint32_t nalSize=unescape(head,toEscape,tgt+nalHeaderSize+1);
+    uint32_t nalSize=unescapeH264(head,toEscape,tgt+nalHeaderSize+1);
     writeBE32(tgt,1+nalSize);
     aprintf("%x , %d -> %d at offset 0x%x\n",oldStartCode,toEscape,nalSize,tgt-outData);
     tgt[nalHeaderSize]=oldStartCode;
@@ -231,18 +260,58 @@
     return outputSize;
 }
 /**
+    \fn compactNalus
+    \brief remove unwanted NALU, marge NALU of the same type
+*/
+bool ADM_videoStreamCopyFromAnnexB::compactNalus(ADMBitstream *out)
+{
+    uint8_t *start=out->data;
+    uint8_t *end=start+out->len;
+    uint8_t *realstart=start;
+    uint8_t *write=start;
+    uint8_t lastNalu=0xff;
+    uint32_t originalSize=out->len;
+    while(start+5<end) // NALU starts with 4 bytes size + (1 bytes nalu id, size-1 other payload)
+    {
+        uint32_t len=readBE32(start);
+        uint8_t  n=start[4];
+        if(len+start+4>end)
+        {
+            ADM_warning("Nal size too big (4+%d/%d)\n",len,end-start);
+            return false;
+        }
+        check(n);
+        aprintf("Compacting: Nal %d, size %d\n",n,len);
+        switch(n&0x1f)
+        {
+            case NAL_FILLER: break;
+            case NAL_AU_DELIMITER: break;
+            default: // keep it
+                memmove(write,start,len+4);
+                write+=4+len;
+                break;
+        }
+        start+=4+len;
+    }
+    out->len=write-realstart;
+    aprintf("compact %d -> %d\n",originalSize,out->len);
+    return true;
+}
+/**
     \fn getPacket
 */
 
 bool    ADM_videoStreamCopyFromAnnexB::getPacket(ADMBitstream *out)
 {
+    aprintf("-------%d--------\n",(int)currentFrame);
     if(false==ADM_videoStreamCopy::getPacket(myBitstream)) return false;
-    aprintf("---------------\n");
+    
     int size=convertFromAnnexB(myBitstream->data,myBitstream->len,out->data,out->bufferSize);
     out->len=size;
     out->dts=myBitstream->dts;
     out->pts=myBitstream->pts;
     out->flags=myBitstream->flags;
+    compactNalus(out);
     return true;
 }
 /**

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2010-09-25 15:02:34 UTC (rev 6655)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2010-09-25 15:02:36 UTC (rev 6656)
@@ -261,7 +261,21 @@
     // Video Stream
     if(!videoEncoderIndex) // Copy
     {
-        ADM_videoStreamCopy *copy=new ADM_videoStreamCopy(markerA,markerB);
+        aviInfo info;
+        video_body->getVideoInfo(&info);
+        uint8_t *extra;
+        uint32_t extraLen;
+        video_body->getExtraHeaderData(&extraLen,&extra);
+#warning do something better
+        ADM_videoStreamCopy *copy=NULL;
+        if(isH264Compatible(info.fcc) && !extraLen)
+        {
+            ADM_info("Probably AnnexB bitstream\n");
+            copy=new ADM_videoStreamCopyFromAnnexB(markerA,markerB);
+        }else   
+        {
+            copy=new ADM_videoStreamCopy(markerA,markerB);
+        }
         video=copy;
         // In that case, get the real time and update audio with it...
         // Because we might have go back in time to catch the first intra



From mean at mail.berlios.de  Sun Sep 26 11:17:46 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 26 Sep 2010 11:17:46 +0200
Subject: [Avidemux-svn-commit] r6657 - in branches/avidemux_2.6_branch_mean:
	avidemux/common/ADM_muxerGate/src
	avidemux_core/ADM_coreUtils/include avidemux_core/ADM_coreUtils/src
	avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20100926091746.45C4E481006@sheep.berlios.de>

Author: mean
Date: 2010-09-26 11:17:45 +0200 (Sun, 26 Sep 2010)
New Revision: 6657

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_coreUtils.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_ts.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
Log:
[unescapeH264] Factorize all H264 unescape code in core

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-25 15:02:36 UTC (rev 6656)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-26 09:17:45 UTC (rev 6657)
@@ -174,43 +174,6 @@
     myBitstream=NULL;
 }
 /**
-    \fn unescapeH264
-    \brief should be moved to coreUtils
-*/
-static uint32_t unescapeH264(uint8_t *in, uint32_t len,uint8_t *out)
-{
-  uint32_t outlen=0;
-  uint8_t *start=out;
-  uint8_t *tail=in+len;
-
-    if(len<3) 
-    {
-        memcpy(out,in,len);
-        return len;
-    }
-    while(in+3<tail)
-    {
-      if(!in[0]  && !in[1] && in[2]==3)
-      {
-        out[0]=0;
-        out[1]=0;
-        out+=2;
-        in+=3;
-        continue;
-      }
-      *out++=*in++;
-    }
-    // copy last bytes
-    uint32_t left=tail-in;
-    memcpy(out,in,left);
-    out+=left;
-    outlen=out-start;
-    ADM_assert(outlen<=len);
-    return outlen;
- ;
-
-}
-/**
     \fn convertFromAnnexB   
     \brief convert annexB startcode (00 00 00 0 xx) to NALU
 */
@@ -238,7 +201,7 @@
         }
         uint32_t toEscape=offset-5; // ignore startcode
         uint32_t nalHeaderSize=4;
-        uint32_t nalSize=unescapeH264(head,toEscape,tgt+nalHeaderSize+1);
+        uint32_t nalSize=ADM_unescapeH264(toEscape,head,tgt+nalHeaderSize+1);
         head+=offset;
         writeBE32(tgt,1+nalSize);
         aprintf("%x , %d -> %d at offset 0x%x\n",oldStartCode,toEscape,nalSize,tgt-outData);
@@ -250,7 +213,7 @@
     }
     uint32_t toEscape=tail-head;
     uint32_t nalHeaderSize=4;
-    uint32_t nalSize=unescapeH264(head,toEscape,tgt+nalHeaderSize+1);
+    uint32_t nalSize=ADM_unescapeH264(toEscape,head,tgt+nalHeaderSize+1);
     writeBE32(tgt,1+nalSize);
     aprintf("%x , %d -> %d at offset 0x%x\n",oldStartCode,toEscape,nalSize,tgt-outData);
     tgt[nalHeaderSize]=oldStartCode;

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_coreUtils.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_coreUtils.h	2010-09-25 15:02:36 UTC (rev 6656)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_coreUtils.h	2010-09-26 09:17:45 UTC (rev 6657)
@@ -10,9 +10,9 @@
 uint32_t    ADM_computeBitrate(uint32_t fps1000, uint32_t nbFrame, uint32_t sizeInMB);
 uint32_t    ADM_UsecFromFps1000(uint32_t fps1000);
 uint32_t    ADM_Fps1000FromUs(uint64_t us);
+uint32_t    ADM_unescapeH264 (uint32_t len, uint8_t * in, uint8_t * out);
 
 
 
 
-
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-25 15:02:36 UTC (rev 6656)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-26 09:17:45 UTC (rev 6657)
@@ -34,8 +34,7 @@
     \brief Remove escape stuff
 
 */
-static uint32_t
-unescapeH264 (uint32_t len, uint8_t * in, uint8_t * out)
+uint32_t ADM_unescapeH264 (uint32_t len, uint8_t * in, uint8_t * out)
 {
   uint32_t outlen = 0;
   uint8_t *tail = in + len;
@@ -222,7 +221,7 @@
     memset(spsinfo,0,sizeof(*spsinfo));
 
 
-  outlen = unescapeH264 (len, data, buf);
+  outlen = ADM_unescapeH264 (len, data, buf);
   getBits bits(outlen,buf);
   
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_ts.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_ts.cpp	2010-09-25 15:02:36 UTC (rev 6656)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_ts.cpp	2010-09-26 09:17:45 UTC (rev 6657)
@@ -20,13 +20,13 @@
 #include "DIA_coreToolkit.h"
 #include "ADM_indexFile.h"
 #include "ADM_ts.h"
+#include "ADM_coreUtils.h"
 
 #define MY_CLASS tsHeader
 #include "ADM_coreDemuxerMpegTemplate.cpp"
 
 
 
-extern uint32_t TS_unescapeH264(uint32_t len,uint8_t *in, uint8_t *out);
 uint32_t ADM_UsecFromFps1000(uint32_t fps1000);
 
 /**
@@ -239,7 +239,7 @@
 #define UNESCAPE() if(r==true && 0 && videoNeedEscaping)  \
                     {\
                         uint32_t l=img->dataLength;\
-                        uint32_t l2=TS_unescapeH264(l,img->data, img->data);\
+                        uint32_t l2=ADM_unescapeH264(l,img->data, img->data);\
                         if(l!=l2)\
                             memset(img->data+l2,0,l-l2);\
                     }

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-09-25 15:02:36 UTC (rev 6656)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-09-26 09:17:45 UTC (rev 6657)
@@ -35,6 +35,7 @@
 #include "ADM_indexFile.h"
 #include "ADM_getbits.h"
 #include "ADM_tsGetBits.h"
+#include "ADM_coreUtils.h"
 
 
 
@@ -277,36 +278,6 @@
         ui->update( (uint32_t)pos);
 }
 /**
-    \fn Unescape stream
-    \brief H264 and VC1 in TS escape
-*/
-uint32_t TS_unescapeH264(uint32_t len,uint8_t *in, uint8_t *out)
-{
-  uint32_t outlen=0;
-  uint8_t *tail=in+len;
-    if(len<3) return 0;
-    while(in<tail-3)
-    {
-      if(!in[0]  && !in[1] && in[2]==3)
-      {
-        out[0]=0;
-        out[1]=0;
-        out+=2;
-        outlen+=2;
-        in+=3; 
-        continue;
-      }
-      *out++=*in++;
-      outlen++;
-    }
-    // copy last bytes
-    uint32_t left=tail-in;
-    memcpy(out,in,left);
-    outlen+=left;
-    return outlen;
-    
-}
-/**
         \fn decodeSEI
         \brief decode SEI to get short ref I
         @param recoveryLength # of recovery frame
@@ -318,7 +289,7 @@
     
     uint8_t *payload=(uint8_t *)alloca(nalSize+16);
     bool r=false;
-    nalSize=TS_unescapeH264(nalSize,org,payload);
+    nalSize=ADM_unescapeH264(nalSize,org,payload);
     uint8_t *tail=payload+nalSize;
     *picStruct=pictureFrame; // frame
     while( payload<tail-2)
@@ -546,7 +517,7 @@
                    
                         pkt->read(NON_IDR_PRE_READ,bufr);
                         // unescape...
-                        TS_unescapeH264(NON_IDR_PRE_READ,bufr,header);
+                        ADM_unescapeH264(NON_IDR_PRE_READ,bufr,header);
                         //
                         getBits bits(NON_IDR_PRE_READ,header);
                         int first_mb_in_slice,slice_type;



From mean at mail.berlios.de  Sun Sep 26 11:17:47 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 26 Sep 2010 11:17:47 +0200
Subject: [Avidemux-svn-commit] r6658 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20100926091747.88AF5481006@sheep.berlios.de>

Author: mean
Date: 2010-09-26 11:17:47 +0200 (Sun, 26 Sep 2010)
New Revision: 6658

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
Log:
[indexer/h264] Pack SEI with the matching frame, not with the previous one

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-09-26 09:17:45 UTC (rev 6657)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-09-26 09:17:47 UTC (rev 6658)
@@ -37,11 +37,11 @@
 #include "ADM_tsGetBits.h"
 #include "ADM_coreUtils.h"
 
-
-
-
-
-#define zprintf(...) {}
+#if (1) || !defined(ADM_DEBUG)
+#define aprintf(...) {}
+#else
+#define aprintf printf
+#endif
 static const char Structure[4]={'X','T','B','F'}; // X Top Bottom Frame
 static const char Type[5]={'X','I','P','B','D'};
 
@@ -126,11 +126,6 @@
 };
 
 
-#if 0
-#define aprintf printf
-#else
-#define aprintf(...) {}
-#endif
 
 /**
     \class TsIndexer
@@ -299,7 +294,7 @@
                 sei_type+=payload[0];payload++;
                 while(payload[0]==0xff) {sei_size+=0xff;payload++;};
                 sei_size+=payload[0];payload++;
-                zprintf("  [SEI] Type : 0x%x size:%d\n",sei_type,sei_size);
+                aprintf("  [SEI] Type : 0x%x size:%d\n",sei_type,sei_size);
                 switch(sei_type) // Recovery point
                 {
 
@@ -315,7 +310,7 @@
                                     }
                                     //printf("Consumed: %d,\n",bits.getConsumedBits());
                                     int pic=bits.get(4);
-                                    printf("Pic struct: %d,\n",pic);
+                                    aprintf("Pic struct: %d,\n",pic);
                                     switch(pic) 
                                     {
                                         case 0: *picStruct=pictureFrame; break;
@@ -336,7 +331,7 @@
                             getBits bits(sei_size,payload);
                             payload+=sei_size;
                             *recoveryLength=bits.getUEG();
-                            zprintf("[SEI] Recovery :%"LU"\n",*recoveryLength);
+                            aprintf("[SEI] Recovery :%"LU"\n",*recoveryLength);
                             r=true;
                             break;
                         }
@@ -345,7 +340,7 @@
                             break;
                 }
     }
-    if(payload!=tail) ADM_warning("Bytes left in SEI %d\n",(int)(tail-payload));
+    if(payload+1<tail) ADM_warning("Bytes left in SEI %d\n",(int)(tail-payload));
     return r;
 }
 
@@ -433,6 +428,7 @@
       }
       
         if(!seq_found) goto the_end;
+        data.state=idx_startAtImage;
     //******************
     // 2 Index
     //******************
@@ -454,19 +450,28 @@
 
         startCode&=0x1f; // Ignore nal ref IDR
         
-        zprintf("[%02x] Nal :0x%x,ref=%d,lastRef=%d at : %d \n",fullStartCode,startCode,ref,lastRefIdc,pkt->getConsumed()-beginConsuming);
+        aprintf("[%02x] Nal :0x%x,ref=%d,lastRef=%d at : %d \n",fullStartCode,startCode,ref,lastRefIdc,pkt->getConsumed()-beginConsuming);
         
           // Ignore multiple chunk of the same pic
           if((startCode==NAL_NON_IDR || startCode==NAL_IDR)&&pic_started )  //&& ref==lastRefIdc) 
           {
-           // aprintf("Still capturing, ignore\n");
+            aprintf("Still capturing, ignore\n");
             continue;
           }
                 
           switch(startCode)
                   {
+                  case NAL_AU_DELIMITER:
+                        {
+                          aprintf("AU DELIMITER\n");
+                          pic_started = false;
+                        }
+                          break;
                   case NAL_SEI:
                     {
+#if 0
+                        printf(">>SEI\n");
+#else
                         // Load the whole NAL
                             SEI_nal.empty();
                             uint32_t code=0xffff+0xffff0000;
@@ -477,38 +482,43 @@
                                 SEI_nal.pushByte(r);
                             }
                             if(!pkt->stillOk()) goto resume;
-                            zprintf("[SEI] Nal size :%d\n",SEI_nal.payloadSize);
+                            aprintf("[SEI] Nal size :%d\n",SEI_nal.payloadSize);
                             if(SEI_nal.payloadSize>=7)
-                                decodeSEI(SEI_nal.payloadSize-4,SEI_nal.payload,&recoveryCount,&nextPicStruct);
+                                decodeSEI(SEI_nal.payloadSize-4,
+                                    SEI_nal.payload,&recoveryCount,&nextPicStruct);
                             else printf("[SEI] Too short size+4=%d\n",*(SEI_nal.payload));
-                        
                             startCode=pkt->readi8();
+
+                              if( data.state!=idx_startAtGopOrSeq)
+                              {
+                                  pic_started = false;
+                                  pkt->getInfo(&info);
+                                  data.frameType=2;
+                                  Mark(&data,&info,5+SEI_nal.payloadSize+1);
+                                  data.state=idx_startAtGopOrSeq;
+                                  recoveryCount=0xff;
+                               }
                             goto resume;
-                    }
+#endif
+                        }
                             break;
-                  case NAL_AU_DELIMITER:
-                          pic_started = false;
-                          nextPicStruct=pictureFrame;  
-                          printf("AU DELIMITER\n");
-                          break;
-
+                  
                   case NAL_SPS:
-                            
-                          pic_started = false;
-                          aprintf("Sps \n");
-                          pkt->getInfo(&info);
-                          data.frameType=1;
-                          Mark(&data,&info,5);
-                          data.state=idx_startAtGopOrSeq;
-                          recoveryCount=0xff;
+                              pic_started = false;
+                              aprintf("Sps \n");
+                              pkt->getInfo(&info);
+                              data.frameType=1;
+                              Mark(&data,&info,5);
+                              data.state=idx_startAtGopOrSeq;
+                              recoveryCount=0xff;
                           break;
 
                   case NAL_IDR:
-                    zprintf("KOWABOUNGA\n");
+                    //zprintf("KOWABOUNGA\n");
                   case NAL_NON_IDR:
                     {
 #define NON_IDR_PRE_READ 8
-                      printf("Pic start last ref:%d cur ref:%d nb=%d\n",lastRefIdc,ref,data.nbPics);
+                      aprintf("Pic start last ref:%d cur ref:%d nb=%d\n",lastRefIdc,ref,data.nbPics);
                       lastRefIdc=ref;
                         
                       uint8_t bufr[NON_IDR_PRE_READ+4];
@@ -538,7 +548,7 @@
                             default : data.frameType=2;break; // SP/SI
                         }
                       if(startCode==NAL_IDR) data.frameType=4; // IDR
-                      zprintf("[>>>>>>>>] Pic Type %"LU" Recovery %"LU"\n",data.frameType,recoveryCount);
+                      aprintf("[>>>>>>>>] Pic Type %"LU" Recovery %"LU"\n",data.frameType,recoveryCount);
                       if(data.frameType==1 && !recoveryCount) data.frameType=4; //I  + Recovery=0 = IDR!
                       data.picStructure=nextPicStruct;
                       if(data.state==idx_startAtGopOrSeq) 
@@ -900,7 +910,7 @@
 */
 bool  TsIndexer::Mark(indexerData *data,dmxPacketInfo *info,uint32_t overRead)
 {
-      
+        aprintf("********************** MARK ******************\n");
         uint32_t consumed=pkt->getConsumed()-overRead;
         if(data->nbPics)
         {



From mean at mail.berlios.de  Sun Sep 26 11:17:48 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 26 Sep 2010 11:17:48 +0200
Subject: [Avidemux-svn-commit] r6659 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src
Message-ID: <20100926091748.9FC92481006@sheep.berlios.de>

Author: mean
Date: 2010-09-26 11:17:48 +0200 (Sun, 26 Sep 2010)
New Revision: 6659

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
Log:
[annexb] Dont unescape h264 video bitstream

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-26 09:17:47 UTC (rev 6658)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-26 09:17:48 UTC (rev 6659)
@@ -201,7 +201,12 @@
         }
         uint32_t toEscape=offset-5; // ignore startcode
         uint32_t nalHeaderSize=4;
+#if ESCAPE
         uint32_t nalSize=ADM_unescapeH264(toEscape,head,tgt+nalHeaderSize+1);
+#else
+        uint32_t nalSize=toEscape;
+        memcpy(tgt+1+nalHeaderSize,head,nalSize);
+#endif
         head+=offset;
         writeBE32(tgt,1+nalSize);
         aprintf("%x , %d -> %d at offset 0x%x\n",oldStartCode,toEscape,nalSize,tgt-outData);
@@ -213,7 +218,12 @@
     }
     uint32_t toEscape=tail-head;
     uint32_t nalHeaderSize=4;
+#if ESCAPE
     uint32_t nalSize=ADM_unescapeH264(toEscape,head,tgt+nalHeaderSize+1);
+#else
+    uint32_t nalSize=toEscape;
+    memcpy(tgt+nalHeaderSize+1,head,toEscape);
+#endif
     writeBE32(tgt,1+nalSize);
     aprintf("%x , %d -> %d at offset 0x%x\n",oldStartCode,toEscape,nalSize,tgt-outData);
     tgt[nalHeaderSize]=oldStartCode;



From mean at mail.berlios.de  Sun Sep 26 11:17:49 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 26 Sep 2010 11:17:49 +0200
Subject: [Avidemux-svn-commit] r6660 - in
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate:
	include src
Message-ID: <20100926091749.DB7D3481006@sheep.berlios.de>

Author: mean
Date: 2010-09-26 11:17:49 +0200 (Sun, 26 Sep 2010)
New Revision: 6660

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoCopy.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
Log:
[annexb] Mostly working annexB to iso

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoCopy.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoCopy.h	2010-09-26 09:17:48 UTC (rev 6659)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoCopy.h	2010-09-26 09:17:49 UTC (rev 6660)
@@ -44,7 +44,6 @@
         ADMBitstream    *myBitstream;
         uint8_t         *myExtra;
         uint32_t        myExtraLen;
-        bool            findNalu(int nalu,uint8_t *start,uint8_t *end,uint8_t **outPtr,uint32_t *outLen);
         bool            compactNalus(ADMBitstream *out);
         int             convertFromAnnexB(uint8_t *inData,uint32_t inSize,
                                                       uint8_t *outData,uint32_t outMaxSize);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-26 09:17:48 UTC (rev 6659)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-26 09:17:49 UTC (rev 6660)
@@ -22,7 +22,11 @@
 #include "ADM_h264_tag.h"
 extern bool ADM_findH264StartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset);
 extern void mixDump(uint8_t *ptr, uint32_t len);
-#if 1
+
+
+//#define ANNEX_B_DEBUG
+
+#if defined(ANNEX_B_DEBUG)
 #define aprintf ADM_info
 #define check isNalValid
 #else
@@ -30,12 +34,23 @@
 #define check(...) {}
 #endif
 
+#define MAX_NALU_PER_CHUNK 20
+
+typedef struct
+{
+    uint8_t  *start;
+    uint32_t size;   // size of payload excluding nalu type
+    uint8_t  nalu;
+}NALU_descriptor;
+
 static uint32_t readBE32(uint8_t *p)
 {
     uint32_t v=(p[0]<<8)+p[1];
     uint32_t u=(p[2]<<8)+p[3];
     return (v<<16)+u;
 }
+
+
 static void writeBE32(uint8_t *p, uint32_t size)
 {
     p[0]=size>>24;
@@ -62,34 +77,52 @@
     return true;
 }
 /**
+    \fn splitNalu
+    \brief split a nalu annexb size into a list of nalu descriptor
+*/
+static int splitNalu(uint8_t *start, uint8_t *end, uint32_t maxNalu,NALU_descriptor *desc)
+{
+bool first=true;
+uint8_t *head=start;
+uint32_t offset;
+uint8_t startCode,oldStartCode=0xff;
+int index=0;
+      while(true==ADM_findH264StartCode(head,end,&startCode,&offset))
+      {
+            if(true==first)
+            {
+                head+=offset;
+                first=false;
+                oldStartCode=startCode;
+                continue;
+            }
+        ADM_assert(index<maxNalu);
+        desc[index].start=head;
+        desc[index].size=offset-5;
+        desc[index].nalu=oldStartCode;
+        index++;
+        head+=offset;
+        oldStartCode=startCode;
+      }
+    // leftover
+    desc[index].start=head;
+    desc[index].size=(uint32_t)(end-head);
+    desc[index].nalu=oldStartCode;
+    index++;
+    return index;
+}
+/**
     \fn findNalu
     \brief lookup for a specific NALU in the given buffer
 */
-bool ADM_videoStreamCopyFromAnnexB::findNalu(int nalu,uint8_t *start,uint8_t *end,
-            uint8_t **outPtr,uint32_t *outLen)
+static int findNalu(uint32_t nalu,uint32_t maxNalu,NALU_descriptor *desc)
 {
-    uint8_t *realstart=start;
-    while(start+5<end) // NALU starts with 4 bytes size + (1 bytes nalu id, size-1 other payload)
+    for(int i=0;i<maxNalu;i++)
     {
-        uint32_t len=readBE32(start);
-        uint8_t  n=start[4];
-        
-        if(len+start+4>end)
-        {
-            ADM_warning("Nal size too big (%d)\n",len);
-            return false;
-        }
-        check(n);
-        aprintf("Looking for %x found %x, size=%d at offset 0x%x\n",nalu,n,len,start-realstart);
-        if((n&0x1f)==nalu)
-        {
-            *outPtr=start+5;
-            *outLen=len-1;
-            return true;
-        }
-        start+=4+len;
+            if((desc[i].nalu&0x1f) == (nalu&0x1f))
+                return i;
     }
-    return false;
+    return -1;
 }
 
 /**
@@ -108,25 +141,31 @@
     // Built avc-like atom from it.
     if(true==ADM_videoStreamCopy::getPacket(myBitstream))
     {
-        uint8_t *tmp=new uint8_t[myBitstream->len*2];
         
-        int size=convertFromAnnexB(myBitstream->data,myBitstream->len,tmp+10,myBitstream->len*2-10);
+        NALU_descriptor desc[MAX_NALU_PER_CHUNK];
+        int nbNalu=splitNalu(myBitstream->data,myBitstream->data+myBitstream->len,
+                                MAX_NALU_PER_CHUNK,desc);
         // search sps
         uint8_t *spsStart,*ppsStart;
         uint32_t spsLen=0, ppsLen=0;
+        int indexSps,indexPps;
 
-        if(false==findNalu(NAL_SPS,tmp+10,tmp+size-10,&spsStart,&spsLen))
+        indexSps=findNalu(NAL_SPS,nbNalu,desc);
+        if(-1==indexSps)
         {
             ADM_error("Cannot find SPS");
-            
         }
-        if(false==findNalu(NAL_PPS,tmp+10,tmp+size-10,&ppsStart,&ppsLen))
+        indexPps=findNalu(NAL_PPS,nbNalu,desc);
+        if(-1==indexPps)
         {
-            ADM_error("Cannot find PPS");
-            
+            ADM_error("Cannot find SPS");
         }
-        if(spsLen && ppsLen)
+       
+        if(indexSps!=-1 && indexPps!=-1)
         {
+            spsLen=desc[indexSps].size;
+            ppsLen=desc[indexPps].size;
+            
             ADM_info("Copy from annexB: Found sps=%d, pps=%d.\n",(int)spsLen,(int)ppsLen);
             // Build extraData
             myExtraLen=5+1+2+spsLen+1+2+ppsLen;
@@ -139,23 +178,22 @@
             *ptr++=0xff;        // Nal size minus 1
 
             *ptr++=0xe1;        // SPS
-            *ptr++=spsLen>>8;
-            *ptr++=spsLen&0xff;
-
-            memcpy(ptr,spsStart,spsLen);
+            *ptr++=(1+spsLen)>>8;
+            *ptr++=(1+spsLen)&0xff;
+            *ptr++=desc[indexSps].nalu;
+            memcpy(ptr,desc[indexSps].start,spsLen);
             ptr+=spsLen;
 
             *ptr++=0x1;         // PPS
-            *ptr++=ppsLen>>8;
-            *ptr++=ppsLen&0xff;
-
-            memcpy(ptr,ppsStart,ppsLen);
+            *ptr++=(1+ppsLen)>>8;
+            *ptr++=(1+ppsLen)&0xff;
+            *ptr++=desc[indexPps].nalu;
+            memcpy(ptr,desc[indexPps].start,ppsLen);
             ptr+=ppsLen;
 
             ADM_info("generated %d bytes of extradata.\n",(int)myExtraLen);
             mixDump(myExtra, myExtraLen);
         }
-        delete [] tmp;
 
     }else ADM_warning("Cannot read first frame to get PPS and SPS");
     rewind();
@@ -180,95 +218,43 @@
 int ADM_videoStreamCopyFromAnnexB::convertFromAnnexB(uint8_t *inData,uint32_t inSize,
                                                       uint8_t *outData,uint32_t outMaxSize)
 {
-    uint8_t *tail=inData+inSize;
-    uint8_t *head=inData;
     uint8_t *tgt=outData;
-    uint8_t startCode;
-    uint32_t offset;
-    bool first=true;
-    uint8_t oldStartCode;
-    while(head<tail)
+    NALU_descriptor desc[MAX_NALU_PER_CHUNK];
+    int nbNalu=splitNalu(myBitstream->data,myBitstream->data+myBitstream->len,
+                        MAX_NALU_PER_CHUNK,desc);
+    int nalHeaderSize=4;
+    int outputSize=0;
+
+
+    for(int i=0;i<nbNalu;i++)
     {
-        if(false==ADM_findH264StartCode(head,tail,&startCode,&offset))
-            break;
-        check(startCode);
-        if(true==first)
+        NALU_descriptor *d=desc+i;
+        aprintf("%d/%d : Nalu :0x%x size=%d\n",i,nbNalu,d->nalu,d->size);
+        switch(d->nalu)
         {
-            oldStartCode=startCode;
-            head+=offset; // First startcode
-            first=false;
-            continue;
+            case NAL_FILLER: break;
+            case NAL_AU_DELIMITER: break; 
+            default:
+                  writeBE32(tgt,1+d->size);
+                  tgt[nalHeaderSize]=d->nalu;
+                  memcpy(tgt+1+nalHeaderSize,d->start,d->size);
+                  tgt+=d->size+1+nalHeaderSize;
+                  break;
         }
-        uint32_t toEscape=offset-5; // ignore startcode
-        uint32_t nalHeaderSize=4;
-#if ESCAPE
-        uint32_t nalSize=ADM_unescapeH264(toEscape,head,tgt+nalHeaderSize+1);
-#else
-        uint32_t nalSize=toEscape;
-        memcpy(tgt+1+nalHeaderSize,head,nalSize);
-#endif
-        head+=offset;
-        writeBE32(tgt,1+nalSize);
-        aprintf("%x , %d -> %d at offset 0x%x\n",oldStartCode,toEscape,nalSize,tgt-outData);
-        tgt[nalHeaderSize]=oldStartCode;
-        tgt+=nalSize+1+nalHeaderSize;
-        
-
-        oldStartCode=startCode;
+        outputSize=tgt-outData;
+        ADM_assert(outputSize<outMaxSize);
     }
-    uint32_t toEscape=tail-head;
-    uint32_t nalHeaderSize=4;
-#if ESCAPE
-    uint32_t nalSize=ADM_unescapeH264(toEscape,head,tgt+nalHeaderSize+1);
-#else
-    uint32_t nalSize=toEscape;
-    memcpy(tgt+nalHeaderSize+1,head,toEscape);
-#endif
-    writeBE32(tgt,1+nalSize);
-    aprintf("%x , %d -> %d at offset 0x%x\n",oldStartCode,toEscape,nalSize,tgt-outData);
-    tgt[nalHeaderSize]=oldStartCode;
-    tgt+=1+nalSize+nalHeaderSize;
-    int outputSize=tgt-outData;
-    ADM_assert(outputSize<outMaxSize);
     return outputSize;
 }
-/**
-    \fn compactNalus
-    \brief remove unwanted NALU, marge NALU of the same type
-*/
-bool ADM_videoStreamCopyFromAnnexB::compactNalus(ADMBitstream *out)
+static void parseNalu(uint8_t *head, uint8_t *tail)
 {
-    uint8_t *start=out->data;
-    uint8_t *end=start+out->len;
-    uint8_t *realstart=start;
-    uint8_t *write=start;
-    uint8_t lastNalu=0xff;
-    uint32_t originalSize=out->len;
-    while(start+5<end) // NALU starts with 4 bytes size + (1 bytes nalu id, size-1 other payload)
+    printf("**** Parsing NALU : %d****",(int)(tail-head));
+    while(head<tail)
     {
-        uint32_t len=readBE32(start);
-        uint8_t  n=start[4];
-        if(len+start+4>end)
-        {
-            ADM_warning("Nal size too big (4+%d/%d)\n",len,end-start);
-            return false;
-        }
-        check(n);
-        aprintf("Compacting: Nal %d, size %d\n",n,len);
-        switch(n&0x1f)
-        {
-            case NAL_FILLER: break;
-            case NAL_AU_DELIMITER: break;
-            default: // keep it
-                memmove(write,start,len+4);
-                write+=4+len;
-                break;
-        }
-        start+=4+len;
+        int32_t size=readBE32(head);
+            printf("[%02x] size=%d\n",head[5],size);
+        head+=size+4;
     }
-    out->len=write-realstart;
-    aprintf("compact %d -> %d\n",originalSize,out->len);
-    return true;
 }
 /**
     \fn getPacket
@@ -284,7 +270,10 @@
     out->dts=myBitstream->dts;
     out->pts=myBitstream->pts;
     out->flags=myBitstream->flags;
-    compactNalus(out);
+    //compactNalus(out);
+#ifdef ANNEX_B_DEBUG
+    parseNalu(out->data,out->data+out->len);
+#endif
     return true;
 }
 /**



From mean at mail.berlios.de  Sun Sep 26 11:35:35 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 26 Sep 2010 11:35:35 +0200
Subject: [Avidemux-svn-commit] r6661 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska
Message-ID: <20100926093535.85270481006@sheep.berlios.de>

Author: mean
Date: 2010-09-26 11:35:35 +0200 (Sun, 26 Sep 2010)
New Revision: 6661

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkvEntries.cpp
Log:
[mkv] Use extradata in vfw compatibility mode

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkvEntries.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkvEntries.cpp	2010-09-26 09:17:49 UTC (rev 6660)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkvEntries.cpp	2010-09-26 09:35:35 UTC (rev 6661)
@@ -136,8 +136,21 @@
         // if it is vfw...
         if(fourCC::check(entry.fcc,(uint8_t *)"VFWX") && entry.extraData && entry.extraDataLen>=sizeof(ADM_BITMAPINFOHEADER))
         {
+          printf("VFW compatibility mode\n");
           memcpy(& _video_bih,entry.extraData,sizeof(ADM_BITMAPINFOHEADER));
           delete [] _tracks[0].extraData;
+          if(entry.extraDataLen>sizeof(ADM_BITMAPINFOHEADER))
+          {
+                 int l=entry.extraDataLen-sizeof(ADM_BITMAPINFOHEADER);
+                _tracks[0].extraData=new uint8_t[l];
+                _tracks[0].extraDataLen=l;
+                memcpy(_tracks[0].extraData,entry.extraData +sizeof(ADM_BITMAPINFOHEADER),l);
+                printf("VFW Header+%d bytes of extradata\n",l);
+                mixDump(_tracks[0].extraData,l);
+                printf("\n");
+ 
+          }
+          delete [] entry.extraData;
           entry.extraData=NULL;
           entry.extraDataLen=0;
 
@@ -145,10 +158,12 @@
           _mainaviheader.dwWidth=  _video_bih.biWidth;
           _mainaviheader.dwHeight= _video_bih.biHeight;
 
-        } // FIXME there can be real extradata after bitmapinfoheader
-
-        _tracks[0].extraData=entry.extraData;
-        _tracks[0].extraDataLen=entry.extraDataLen;
+        } 
+        else // not VFWX
+        {
+            _tracks[0].extraData=entry.extraData;
+            _tracks[0].extraDataLen=entry.extraDataLen;
+        }
         _tracks[0].streamIndex=entry.trackNo;
          uint32_t hdr=entry.headerRepeatSize;
         if(hdr)



From mean at mail.berlios.de  Sun Sep 26 16:25:58 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 26 Sep 2010 16:25:58 +0200
Subject: [Avidemux-svn-commit] r6662 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src
Message-ID: <20100926142558.E05E6481006@sheep.berlios.de>

Author: mean
Date: 2010-09-26 16:25:58 +0200 (Sun, 26 Sep 2010)
New Revision: 6662

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
Log:
[annexb] Fetch absolute first frame of the stream to get SPS & PPS, hopefully they are valid at that point

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-26 09:35:35 UTC (rev 6661)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-26 14:25:58 UTC (rev 6662)
@@ -20,6 +20,8 @@
 #include "ADM_editor/ADM_edit.hxx"
 #include "ADM_coreUtils.h"
 #include "ADM_h264_tag.h"
+extern ADM_Composer *video_body; // Fixme!
+
 extern bool ADM_findH264StartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset);
 extern void mixDump(uint8_t *ptr, uint32_t len);
 
@@ -139,9 +141,16 @@
     myExtraLen=0;
     // Read First frame, it contains PPS & SPS
     // Built avc-like atom from it.
-    if(true==ADM_videoStreamCopy::getPacket(myBitstream))
+
+    // We need the absolute 1st frame to gety SPS PPS
+    // Hopefully it will be ok
+    ADMCompressedImage img;
+    img.data=buffer;
+    img.dataLength=0;
+
+    if(true==video_body->getDirectImageForDebug(0,&img))
     {
-        
+        myBitstream->len=img.dataLength;
         NALU_descriptor desc[MAX_NALU_PER_CHUNK];
         int nbNalu=splitNalu(myBitstream->data,myBitstream->data+myBitstream->len,
                                 MAX_NALU_PER_CHUNK,desc);



From mean at mail.berlios.de  Sun Sep 26 16:25:59 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 26 Sep 2010 16:25:59 +0200
Subject: [Avidemux-svn-commit] r6663 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src
Message-ID: <20100926142600.05730481006@sheep.berlios.de>

Author: mean
Date: 2010-09-26 16:25:59 +0200 (Sun, 26 Sep 2010)
New Revision: 6663

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
Log:
[annexb] Build avc atom from actual sps

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-26 14:25:58 UTC (rev 6662)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopyFromAnnexB.cpp	2010-09-26 14:25:59 UTC (rev 6663)
@@ -180,10 +180,11 @@
             myExtraLen=5+1+2+spsLen+1+2+ppsLen;
             myExtra=new uint8_t[myExtraLen];
             uint8_t *ptr=myExtra;
+            uint8_t *sps=desc[indexSps].start;
             *ptr++=1;           // AVC version
-            *ptr++=0x64;        // Profile
-            *ptr++=0x00;        // Profile
-            *ptr++=0x33;        // Level
+            *ptr++=sps[0];        // Profile
+            *ptr++=sps[1];        // Profile
+            *ptr++=sps[2];        // Level
             *ptr++=0xff;        // Nal size minus 1
 
             *ptr++=0xe1;        // SPS



From mean at mail.berlios.de  Sun Sep 26 16:26:00 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 26 Sep 2010 16:26:00 +0200
Subject: [Avidemux-svn-commit] r6664 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4
Message-ID: <20100926142601.00705481006@sheep.berlios.de>

Author: mean
Date: 2010-09-26 16:26:00 +0200 (Sun, 26 Sep 2010)
New Revision: 6664

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
Log:
[build] Try to repair cross-mingw build

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-09-26 14:25:59 UTC (rev 6663)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-09-26 14:26:00 UTC (rev 6664)
@@ -127,6 +127,14 @@
 ###########################################
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY})
 
+# Needed for cross compiling
+if(CROSS)
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UI_QT46)
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_render6_${UI_SUFFIX})
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_coreUtils6)
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_core6)
+endif(CROSS)
+
 ###########################################
 # OS Specific
 ###########################################



From mean at mail.berlios.de  Sun Sep 26 16:29:01 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 26 Sep 2010 16:29:01 +0200
Subject: [Avidemux-svn-commit] r6665 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/xml
Message-ID: <20100926142901.ABE59481006@sheep.berlios.de>

Author: mean
Date: 2010-09-26 16:29:01 +0200 (Sun, 26 Sep 2010)
New Revision: 6665

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/xml/Sony PlayStation Portable.xml
Log:
[profile] PSP fix by bastafidli

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/xml/Sony PlayStation Portable.xml
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/xml/Sony PlayStation Portable.xml	2010-09-26 14:26:00 UTC (rev 6664)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/xml/Sony PlayStation Portable.xml	2010-09-26 14:29:01 UTC (rev 6665)
@@ -9,6 +9,7 @@
     <referenceFrames>2</referenceFrames>
     <bFrames>3</bFrames>
     <adaptiveBframeDecision>2</adaptiveBframeDecision>
+    <bFrameReferences>none</bFrameReferences>
     <analyse>
       <partitionI4x4>true</partitionI4x4>
       <partitionI8x8>false</partitionI8x8>



From mean at mail.berlios.de  Sun Sep 26 16:54:03 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 26 Sep 2010 16:54:03 +0200
Subject: [Avidemux-svn-commit] r6666 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4
Message-ID: <20100926145403.80E5C481006@sheep.berlios.de>

Author: mean
Date: 2010-09-26 16:54:03 +0200 (Sun, 26 Sep 2010)
New Revision: 6666

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
Log:
[build] Fix cross mingw, try 2

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-09-26 14:29:01 UTC (rev 6665)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-09-26 14:54:03 UTC (rev 6666)
@@ -130,7 +130,7 @@
 # Needed for cross compiling
 if(CROSS)
         TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UI_QT46)
-        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_render6_${UI_SUFFIX})
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_render6_qt4)
         TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_coreUtils6)
         TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_core6)
 endif(CROSS)



From mean at mail.berlios.de  Sun Sep 26 17:01:39 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 26 Sep 2010 17:01:39 +0200
Subject: [Avidemux-svn-commit] r6667 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4
Message-ID: <20100926150139.379ED481006@sheep.berlios.de>

Author: mean
Date: 2010-09-26 17:01:39 +0200 (Sun, 26 Sep 2010)
New Revision: 6667

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
Log:
[Build] 3rd try

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-09-26 14:54:03 UTC (rev 6666)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-09-26 15:01:39 UTC (rev 6667)
@@ -127,14 +127,6 @@
 ###########################################
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY})
 
-# Needed for cross compiling
-if(CROSS)
-        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UI_QT46)
-        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_render6_qt4)
-        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_coreUtils6)
-        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_core6)
-endif(CROSS)
-
 ###########################################
 # OS Specific
 ###########################################
@@ -158,7 +150,19 @@
 	# for Leopard but it doesn't hurt Tiger
 	ADD_TARGET_LDFLAGS(avidemux3_qt4 "-Wl,-dylib_file,/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib:/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib")
 ENDIF (APPLE)
+#
+# Needed for cross compiling
+#
+if(CROSS)
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UI_QT46)
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UI_QT46)
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_render6_qt4)
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_coreUtils6)
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_core6)
+        TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_core6)
+endif(CROSS)
 
+
 ###########################################
 # Install
 ###########################################



From gruntster at mail.berlios.de  Sun Sep 26 21:32:08 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 26 Sep 2010 21:32:08 +0200
Subject: [Avidemux-svn-commit] r6668 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4
Message-ID: <20100926193208.BA5C4481006@sheep.berlios.de>

Author: gruntster
Date: 2010-09-26 21:32:08 +0200 (Sun, 26 Sep 2010)
New Revision: 6668

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
Log:
[x264] split output options to new tab

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-26 15:01:39 UTC (rev 6667)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-26 19:32:08 UTC (rev 6668)
@@ -1,59 +1,54 @@
-<ui version="4.0" >
+<?xml version="1.0" encoding="UTF-8"?>
+<ui version="4.0">
  <author>(C) 2008 by gruntster</author>
  <class>x264ConfigDialog</class>
- <widget class="QDialog" name="x264ConfigDialog" >
-  <property name="geometry" >
+ <widget class="QDialog" name="x264ConfigDialog">
+  <property name="geometry">
    <rect>
     <x>0</x>
     <y>0</y>
-    <width>523</width>
-    <height>580</height>
+    <width>503</width>
+    <height>598</height>
    </rect>
   </property>
-  <property name="windowTitle" >
+  <property name="windowTitle">
    <string>x264 Configuraton</string>
   </property>
-  <layout class="QVBoxLayout" >
-   <property name="margin" >
-    <number>9</number>
-   </property>
-   <property name="spacing" >
-    <number>6</number>
-   </property>
+  <layout class="QVBoxLayout" name="_11">
    <item>
-    <layout class="QHBoxLayout" >
-     <property name="margin" >
-      <number>0</number>
-     </property>
-     <property name="spacing" >
+    <layout class="QHBoxLayout">
+     <property name="spacing">
       <number>6</number>
      </property>
+     <property name="margin">
+      <number>0</number>
+     </property>
      <item>
-      <spacer>
-       <property name="orientation" >
+      <spacer name="spacer_8">
+       <property name="orientation">
         <enum>Qt::Horizontal</enum>
        </property>
-       <property name="sizeType" >
+       <property name="sizeType">
         <enum>QSizePolicy::Expanding</enum>
        </property>
-       <property name="sizeHint" >
+       <property name="sizeHint" stdset="0">
         <size>
-         <width>40</width>
-         <height>20</height>
+         <width>0</width>
+         <height>0</height>
         </size>
        </property>
       </spacer>
      </item>
      <item>
-      <widget class="QLabel" name="label_3" >
-       <property name="text" >
+      <widget class="QLabel" name="label_3">
+       <property name="text">
         <string>Configuration:</string>
        </property>
       </widget>
      </item>
      <item>
-      <widget class="QComboBox" name="configurationComboBox" >
-       <property name="minimumSize" >
+      <widget class="QComboBox" name="configurationComboBox">
+       <property name="minimumSize">
         <size>
          <width>200</width>
          <height>0</height>
@@ -62,28 +57,28 @@
       </widget>
      </item>
      <item>
-      <widget class="QPushButton" name="saveAsButton" >
-       <property name="text" >
+      <widget class="QPushButton" name="saveAsButton">
+       <property name="text">
         <string>Save As</string>
        </property>
       </widget>
      </item>
      <item>
-      <widget class="QPushButton" name="deleteButton" >
-       <property name="text" >
+      <widget class="QPushButton" name="deleteButton">
+       <property name="text">
         <string>Delete</string>
        </property>
       </widget>
      </item>
      <item>
-      <spacer>
-       <property name="orientation" >
+      <spacer name="spacer_9">
+       <property name="orientation">
         <enum>Qt::Horizontal</enum>
        </property>
-       <property name="sizeHint" >
+       <property name="sizeHint" stdset="0">
         <size>
-         <width>40</width>
-         <height>20</height>
+         <width>0</width>
+         <height>0</height>
         </size>
        </property>
       </spacer>
@@ -91,163 +86,163 @@
     </layout>
    </item>
    <item>
-    <spacer>
-     <property name="orientation" >
+    <spacer name="spacer_7">
+     <property name="orientation">
       <enum>Qt::Vertical</enum>
      </property>
-     <property name="sizeType" >
+     <property name="sizeType">
       <enum>QSizePolicy::Fixed</enum>
      </property>
-     <property name="sizeHint" >
+     <property name="sizeHint" stdset="0">
       <size>
-       <width>505</width>
+       <width>0</width>
        <height>10</height>
       </size>
      </property>
     </spacer>
    </item>
    <item>
-    <widget class="QTabWidget" name="tabWidget" >
-     <property name="currentIndex" >
+    <widget class="QTabWidget" name="tabWidget">
+     <property name="currentIndex">
       <number>0</number>
      </property>
-     <widget class="QWidget" name="tab_1" >
-      <attribute name="title" >
+     <widget class="QWidget" name="tab_1">
+      <attribute name="title">
        <string>General</string>
       </attribute>
-      <layout class="QVBoxLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
+      <layout class="QVBoxLayout">
+       <property name="spacing">
         <number>6</number>
        </property>
+       <property name="margin">
+        <number>9</number>
+       </property>
        <item>
-        <widget class="QGroupBox" name="groupBox_2" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_2">
+         <property name="title">
           <string>Rate Control</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QGridLayout" >
-            <property name="margin" >
+           <layout class="QGridLayout">
+            <property name="margin">
              <number>0</number>
             </property>
-            <property name="spacing" >
+            <property name="spacing">
              <number>6</number>
             </property>
-            <item row="1" column="0" >
-             <widget class="QLabel" name="targetRateControlLabel1" >
-              <property name="text" >
+            <item row="1" column="0">
+             <widget class="QLabel" name="targetRateControlLabel1">
+              <property name="text">
                <string>Target Video Size:</string>
               </property>
              </widget>
             </item>
-            <item row="0" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="0" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QComboBox" name="encodingModeComboBox" >
-                <property name="currentIndex" >
+               <widget class="QComboBox" name="encodingModeComboBox">
+                <property name="currentIndex">
                  <number>3</number>
                 </property>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Constant Bitrate (Single Pass)</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Constant Quantiser (Single Pass)</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Constant Rate Factor (Single Pass)</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Video Size (Two Pass)</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Average Bitrate (Two Pass)</string>
                  </property>
                 </item>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_6">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="0" column="0" >
-             <widget class="QLabel" name="label" >
-              <property name="text" >
+            <item row="0" column="0">
+             <widget class="QLabel" name="label">
+              <property name="text">
                <string>Encoding Mode:</string>
               </property>
              </widget>
             </item>
-            <item row="1" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="1" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="targetRateControlSpinBox" >
-                <property name="prefix" >
+               <widget class="QSpinBox" name="targetRateControlSpinBox">
+                <property name="prefix">
                  <string/>
                 </property>
-                <property name="maximum" >
+                <property name="maximum">
                  <number>999999999</number>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <number>700</number>
                 </property>
                </widget>
               </item>
               <item>
-               <widget class="QLabel" name="targetRateControlLabel2" >
-                <property name="text" >
+               <widget class="QLabel" name="targetRateControlLabel2">
+                <property name="text">
                  <string>MB</string>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_5">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>183</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
@@ -258,13 +253,13 @@
           </item>
           <item>
            <spacer>
-            <property name="orientation" >
+            <property name="orientation">
              <enum>Qt::Vertical</enum>
             </property>
-            <property name="sizeType" >
+            <property name="sizeType">
              <enum>QSizePolicy::Fixed</enum>
             </property>
-            <property name="sizeHint" >
+            <property name="sizeHint" stdset="0">
              <size>
               <width>20</width>
               <height>4</height>
@@ -273,53 +268,53 @@
            </spacer>
           </item>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>12</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <layout class="QVBoxLayout" >
-                <property name="margin" >
+               <layout class="QVBoxLayout">
+                <property name="spacing">
                  <number>0</number>
                 </property>
-                <property name="spacing" >
+                <property name="margin">
                  <number>0</number>
                 </property>
                 <item>
-                 <layout class="QHBoxLayout" >
-                  <property name="margin" >
+                 <layout class="QHBoxLayout">
+                  <property name="spacing">
                    <number>0</number>
                   </property>
-                  <property name="spacing" >
+                  <property name="margin">
                    <number>0</number>
                   </property>
                   <item>
-                   <widget class="QLabel" name="quantiserLabel1" >
-                    <property name="enabled" >
+                   <widget class="QLabel" name="quantiserLabel1">
+                    <property name="enabled">
                      <bool>false</bool>
                     </property>
-                    <property name="text" >
+                    <property name="text">
                      <string>0 (High Quality)</string>
                     </property>
                    </widget>
                   </item>
                   <item>
                    <spacer>
-                    <property name="orientation" >
+                    <property name="orientation">
                      <enum>Qt::Horizontal</enum>
                     </property>
-                    <property name="sizeHint" >
+                    <property name="sizeHint" stdset="0">
                      <size>
                       <width>40</width>
                       <height>20</height>
@@ -328,21 +323,21 @@
                    </spacer>
                   </item>
                   <item>
-                   <widget class="QLabel" name="quantiserLabel2" >
-                    <property name="enabled" >
+                   <widget class="QLabel" name="quantiserLabel2">
+                    <property name="enabled">
                      <bool>false</bool>
                     </property>
-                    <property name="text" >
+                    <property name="text">
                      <string>Quantiser</string>
                     </property>
                    </widget>
                   </item>
                   <item>
                    <spacer>
-                    <property name="orientation" >
+                    <property name="orientation">
                      <enum>Qt::Horizontal</enum>
                     </property>
-                    <property name="sizeHint" >
+                    <property name="sizeHint" stdset="0">
                      <size>
                       <width>40</width>
                       <height>20</height>
@@ -351,11 +346,11 @@
                    </spacer>
                   </item>
                   <item>
-                   <widget class="QLabel" name="quantiserLabel3" >
-                    <property name="enabled" >
+                   <widget class="QLabel" name="quantiserLabel3">
+                    <property name="enabled">
                      <bool>false</bool>
                     </property>
-                    <property name="text" >
+                    <property name="text">
                      <string>51 (Low Quality)</string>
                     </property>
                    </widget>
@@ -363,29 +358,29 @@
                  </layout>
                 </item>
                 <item>
-                 <widget class="QSlider" name="quantiserSlider" >
-                  <property name="enabled" >
+                 <widget class="QSlider" name="quantiserSlider">
+                  <property name="enabled">
                    <bool>false</bool>
                   </property>
-                  <property name="minimumSize" >
+                  <property name="minimumSize">
                    <size>
                     <width>375</width>
                     <height>0</height>
                    </size>
                   </property>
-                  <property name="maximum" >
+                  <property name="maximum">
                    <number>51</number>
                   </property>
-                  <property name="pageStep" >
+                  <property name="pageStep">
                    <number>5</number>
                   </property>
-                  <property name="value" >
+                  <property name="value">
                    <number>26</number>
                   </property>
-                  <property name="orientation" >
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="tickPosition" >
+                  <property name="tickPosition">
                    <enum>QSlider::TicksBelow</enum>
                   </property>
                  </widget>
@@ -393,14 +388,14 @@
                </layout>
               </item>
               <item>
-               <widget class="QSpinBox" name="quantiserSpinBox" >
-                <property name="enabled" >
+               <widget class="QSpinBox" name="quantiserSpinBox">
+                <property name="enabled">
                  <bool>false</bool>
                 </property>
-                <property name="maximum" >
+                <property name="maximum">
                  <number>51</number>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <number>26</number>
                 </property>
                </widget>
@@ -408,14 +403,14 @@
              </layout>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_4">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>40</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
@@ -423,57 +418,57 @@
            </layout>
           </item>
           <item>
-           <widget class="QCheckBox" name="fastFirstPassCheckBox" >
-            <property name="text" >
+           <widget class="QCheckBox" name="fastFirstPassCheckBox">
+            <property name="text">
              <string>Fast First Pass</string>
             </property>
            </widget>
           </item>
           <item>
-           <widget class="QCheckBox" name="mbTreeCheckBox" >
-            <property name="text" >
+           <widget class="QCheckBox" name="mbTreeCheckBox">
+            <property name="text">
              <string>Macroblock-tree Rate Control</string>
             </property>
            </widget>
           </item>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QLabel" name="lblLookahead" >
-              <property name="text" >
+             <widget class="QLabel" name="lblLookahead">
+              <property name="text">
                <string>Frametype Lookahead:</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QSpinBox" name="lookaheadSpinBox" >
-              <property name="maximum" >
+             <widget class="QSpinBox" name="lookaheadSpinBox">
+              <property name="maximum">
                <number>250</number>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QLabel" name="lblLookaheadFrames" >
-              <property name="text" >
+             <widget class="QLabel" name="lblLookaheadFrames">
+              <property name="text">
                <string>frames</string>
               </property>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_3">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>40</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
@@ -484,79 +479,79 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="groupBox_17" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_17">
+         <property name="title">
           <string>Multithreading</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QVBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QVBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QRadioButton" name="threadDisableRadioButton" >
-              <property name="text" >
+             <widget class="QRadioButton" name="threadDisableRadioButton">
+              <property name="text">
                <string>Disable</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QRadioButton" name="threadAutoDetectRadioButton" >
-              <property name="text" >
+             <widget class="QRadioButton" name="threadAutoDetectRadioButton">
+              <property name="text">
                <string>Auto-detect</string>
               </property>
-              <property name="checked" >
+              <property name="checked">
                <bool>true</bool>
               </property>
              </widget>
             </item>
             <item>
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QRadioButton" name="threadCustomRadioButton" >
-                <property name="text" >
-                 <string comment="multithreading" >Custom:</string>
+               <widget class="QRadioButton" name="threadCustomRadioButton">
+                <property name="text">
+                 <string comment="multithreading">Custom:</string>
                 </property>
                </widget>
               </item>
               <item>
-               <widget class="QSpinBox" name="threadCustomSpinBox" >
-                <property name="enabled" >
+               <widget class="QSpinBox" name="threadCustomSpinBox">
+                <property name="enabled">
                  <bool>false</bool>
                 </property>
-                <property name="maximum" >
-                 <number>32</number>
-                </property>
-                <property name="minimum" >
+                <property name="minimum">
                  <number>2</number>
                 </property>
+                <property name="maximum">
+                 <number>32</number>
+                </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_2">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
@@ -566,63 +561,63 @@
            </layout>
           </item>
           <item>
-           <widget class="QCheckBox" name="repeatabilityCheckBox" >
-            <property name="text" >
+           <widget class="QCheckBox" name="repeatabilityCheckBox">
+            <property name="text">
              <string>Enforce Repeatability</string>
             </property>
            </widget>
           </item>
           <item>
-           <widget class="QCheckBox" name="sliceThreadingCheckBox" >
-            <property name="text" >
+           <widget class="QCheckBox" name="sliceThreadingCheckBox">
+            <property name="text">
              <string>Slice-based Threading</string>
             </property>
            </widget>
           </item>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QCheckBox" name="threadedLookaheadCheckBox" >
-              <property name="text" >
+             <widget class="QCheckBox" name="threadedLookaheadCheckBox">
+              <property name="text">
                <string>Custom Threaded Lookahead Buffer:</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QSpinBox" name="threadedLookaheadSpinBox" >
-              <property name="enabled" >
+             <widget class="QSpinBox" name="threadedLookaheadSpinBox">
+              <property name="enabled">
                <bool>false</bool>
               </property>
-              <property name="maximum" >
+              <property name="maximum">
                <number>250</number>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QLabel" name="lblThreadedFrames" >
-              <property name="enabled" >
+             <widget class="QLabel" name="lblThreadedFrames">
+              <property name="enabled">
                <bool>false</bool>
               </property>
-              <property name="text" >
+              <property name="text">
                <string>frames</string>
               </property>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>461</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
@@ -634,106 +629,106 @@
        </item>
        <item>
         <spacer>
-         <property name="orientation" >
+         <property name="orientation">
           <enum>Qt::Vertical</enum>
          </property>
-         <property name="sizeHint" >
+         <property name="sizeHint" stdset="0">
           <size>
-           <width>436</width>
-           <height>111</height>
+           <width>0</width>
+           <height>0</height>
           </size>
          </property>
         </spacer>
        </item>
       </layout>
      </widget>
-     <widget class="QWidget" name="tab_2" >
-      <attribute name="title" >
+     <widget class="QWidget" name="tab_2">
+      <attribute name="title">
        <string>Motion</string>
       </attribute>
-      <layout class="QVBoxLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
+      <layout class="QVBoxLayout">
+       <property name="spacing">
         <number>6</number>
        </property>
+       <property name="margin">
+        <number>9</number>
+       </property>
        <item>
-        <widget class="QGroupBox" name="groupBox_11" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_11">
+         <property name="title">
           <string>Motion Estimation</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QLabel" name="label_38" >
-              <property name="text" >
+             <widget class="QLabel" name="label_38">
+              <property name="text">
                <string>Motion Estimation Method:</string>
               </property>
              </widget>
             </item>
             <item>
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QComboBox" name="meMethodComboBox" >
-                <property name="currentIndex" >
+               <widget class="QComboBox" name="meMethodComboBox">
+                <property name="currentIndex">
                  <number>1</number>
                 </property>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Diamond Search</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Hexagonal Search</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Uneven Multi-hexagonal Search</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Exhaustive Search</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Hadamard Exhaustive Search</string>
                  </property>
                 </item>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_10">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
@@ -743,80 +738,80 @@
            </layout>
           </item>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>12</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <layout class="QVBoxLayout" >
-                <property name="margin" >
+               <layout class="QVBoxLayout">
+                <property name="spacing">
                  <number>0</number>
                 </property>
-                <property name="spacing" >
+                <property name="margin">
                  <number>0</number>
                 </property>
                 <item>
-                 <layout class="QHBoxLayout" >
-                  <property name="margin" >
+                 <layout class="QHBoxLayout">
+                  <property name="spacing">
                    <number>0</number>
                   </property>
-                  <property name="spacing" >
+                  <property name="margin">
                    <number>0</number>
                   </property>
                   <item>
-                   <widget class="QLabel" name="label_35" >
-                    <property name="text" >
+                   <widget class="QLabel" name="label_35">
+                    <property name="text">
                      <string>1 (Fast)</string>
                     </property>
                    </widget>
                   </item>
                   <item>
-                   <spacer>
-                    <property name="orientation" >
+                   <spacer name="spacer_11">
+                    <property name="orientation">
                      <enum>Qt::Horizontal</enum>
                     </property>
-                    <property name="sizeHint" >
+                    <property name="sizeHint" stdset="0">
                      <size>
-                      <width>40</width>
-                      <height>20</height>
+                      <width>0</width>
+                      <height>0</height>
                      </size>
                     </property>
                    </spacer>
                   </item>
                   <item>
-                   <widget class="QLabel" name="label_36" >
-                    <property name="text" >
+                   <widget class="QLabel" name="label_36">
+                    <property name="text">
                      <string>Subpixel Refinement</string>
                     </property>
                    </widget>
                   </item>
                   <item>
-                   <spacer>
-                    <property name="orientation" >
+                   <spacer name="spacer_13">
+                    <property name="orientation">
                      <enum>Qt::Horizontal</enum>
                     </property>
-                    <property name="sizeHint" >
+                    <property name="sizeHint" stdset="0">
                      <size>
-                      <width>40</width>
-                      <height>20</height>
+                      <width>0</width>
+                      <height>0</height>
                      </size>
                     </property>
                    </spacer>
                   </item>
                   <item>
-                   <widget class="QLabel" name="label_37" >
-                    <property name="text" >
+                   <widget class="QLabel" name="label_37">
+                    <property name="text">
                      <string>9 (Best)</string>
                     </property>
                    </widget>
@@ -824,37 +819,35 @@
                  </layout>
                 </item>
                 <item>
-                 <widget class="QSlider" name="meSlider" >
-                  <property name="sizePolicy" >
-                   <sizepolicy>
-                    <hsizetype>5</hsizetype>
-                    <vsizetype>0</vsizetype>
+                 <widget class="QSlider" name="meSlider">
+                  <property name="sizePolicy">
+                   <sizepolicy hsizetype="Preferred" vsizetype="Fixed">
                     <horstretch>0</horstretch>
                     <verstretch>0</verstretch>
                    </sizepolicy>
                   </property>
-                  <property name="minimumSize" >
+                  <property name="minimumSize">
                    <size>
                     <width>375</width>
                     <height>0</height>
                    </size>
                   </property>
-                  <property name="minimum" >
+                  <property name="minimum">
                    <number>1</number>
                   </property>
-                  <property name="maximum" >
+                  <property name="maximum">
                    <number>9</number>
                   </property>
-                  <property name="pageStep" >
+                  <property name="pageStep">
                    <number>1</number>
                   </property>
-                  <property name="value" >
+                  <property name="value">
                    <number>5</number>
                   </property>
-                  <property name="orientation" >
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="tickPosition" >
+                  <property name="tickPosition">
                    <enum>QSlider::TicksBelow</enum>
                   </property>
                  </widget>
@@ -862,14 +855,14 @@
                </layout>
               </item>
               <item>
-               <widget class="QSpinBox" name="meSpinBox" >
-                <property name="maximum" >
-                 <number>9</number>
-                </property>
-                <property name="minimum" >
+               <widget class="QSpinBox" name="meSpinBox">
+                <property name="minimum">
                  <number>1</number>
                 </property>
-                <property name="value" >
+                <property name="maximum">
+                 <number>9</number>
+                </property>
+                <property name="value">
                  <number>5</number>
                 </property>
                </widget>
@@ -877,14 +870,14 @@
              </layout>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_12">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>40</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
@@ -895,153 +888,153 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="groupBox_19" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_19">
+         <property name="title">
           <string>Motion Vector</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QGridLayout" >
-            <property name="margin" >
+           <layout class="QGridLayout">
+            <property name="margin">
              <number>0</number>
             </property>
-            <property name="spacing" >
+            <property name="spacing">
              <number>6</number>
             </property>
-            <item row="1" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="1" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="mvLengthSpinBox" >
-                <property name="enabled" >
+               <widget class="QSpinBox" name="mvLengthSpinBox">
+                <property name="enabled">
                  <bool>false</bool>
                 </property>
-                <property name="maximum" >
-                 <number>512</number>
-                </property>
-                <property name="minimum" >
+                <property name="minimum">
                  <number>32</number>
                 </property>
+                <property name="maximum">
+                 <number>512</number>
+                </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_14">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="1" column="0" >
-             <widget class="QCheckBox" name="mvLengthCheckBox" >
-              <property name="text" >
+            <item row="1" column="0">
+             <widget class="QCheckBox" name="mvLengthCheckBox">
+              <property name="text">
                <string>Maximum Motion Vector Length:</string>
               </property>
              </widget>
             </item>
-            <item row="2" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="2" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="minThreadBufferSpinBox" >
-                <property name="enabled" >
+               <widget class="QSpinBox" name="minThreadBufferSpinBox">
+                <property name="enabled">
                  <bool>false</bool>
                 </property>
-                <property name="maximum" >
-                 <number>2147483647</number>
-                </property>
-                <property name="minimum" >
+                <property name="minimum">
                  <number>0</number>
                 </property>
-                <property name="singleStep" >
+                <property name="maximum">
+                 <number>2147483647</number>
+                </property>
+                <property name="singleStep">
                  <number>1</number>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <number>0</number>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_16">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="0" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="0" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="mvRangeSpinBox" >
-                <property name="maximum" >
+               <widget class="QSpinBox" name="mvRangeSpinBox">
+                <property name="maximum">
                  <number>64</number>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <number>16</number>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_15">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="2" column="0" >
-             <widget class="QCheckBox" name="minThreadBufferCheckBox" >
-              <property name="text" >
+            <item row="2" column="0">
+             <widget class="QCheckBox" name="minThreadBufferCheckBox">
+              <property name="text">
                <string>Minimum Buffer Between Threads:</string>
               </property>
              </widget>
             </item>
-            <item row="0" column="0" >
-             <widget class="QLabel" name="label_39" >
-              <property name="text" >
+            <item row="0" column="0">
+             <widget class="QLabel" name="label_39">
+              <property name="text">
                <string>Maximum Motion Vector Search Range:</string>
               </property>
              </widget>
@@ -1052,125 +1045,125 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="groupBox_18" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_18">
+         <property name="title">
           <string>Prediction</string>
          </property>
-         <layout class="QGridLayout" >
-          <property name="margin" >
+         <layout class="QGridLayout">
+          <property name="margin">
            <number>9</number>
           </property>
-          <property name="spacing" >
+          <property name="spacing">
            <number>6</number>
           </property>
-          <item row="0" column="0" >
-           <layout class="QGridLayout" >
-            <property name="margin" >
+          <item row="0" column="0">
+           <layout class="QGridLayout">
+            <property name="margin">
              <number>0</number>
             </property>
-            <property name="spacing" >
+            <property name="spacing">
              <number>6</number>
             </property>
-            <item row="1" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="1" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QComboBox" name="weightedPPredictComboBox" >
+               <widget class="QComboBox" name="weightedPPredictComboBox">
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Disabled</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Blind Offset</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Smart Analysis</string>
                  </property>
                 </item>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_18">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="0" column="0" >
-             <widget class="QLabel" name="label_40" >
-              <property name="text" >
+            <item row="0" column="0">
+             <widget class="QLabel" name="label_40">
+              <property name="text">
                <string>Direct Prediction Mode:</string>
               </property>
              </widget>
             </item>
-            <item row="1" column="0" >
-             <widget class="QLabel" name="lblWeightedPPredict" >
-              <property name="text" >
+            <item row="1" column="0">
+             <widget class="QLabel" name="lblWeightedPPredict">
+              <property name="text">
                <string>Weighted Prediction for P-frames:</string>
               </property>
              </widget>
             </item>
-            <item row="0" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="0" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QComboBox" name="predictModeComboBox" >
-                <property name="currentIndex" >
+               <widget class="QComboBox" name="predictModeComboBox">
+                <property name="currentIndex">
                  <number>1</number>
                 </property>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>None</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Spatial</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Temporal</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Auto</string>
                  </property>
                 </item>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_17">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
@@ -1179,16 +1172,16 @@
             </item>
            </layout>
           </item>
-          <item row="1" column="0" >
-           <widget class="QCheckBox" name="weightedPredictCheckBox" >
-            <property name="text" >
+          <item row="1" column="0">
+           <widget class="QCheckBox" name="weightedPredictCheckBox">
+            <property name="text">
              <string>Weighted Prediction for B-frames</string>
             </property>
            </widget>
           </item>
-          <item row="2" column="0" >
-           <widget class="QCheckBox" name="constrainedIntraCheckBox" >
-            <property name="text" >
+          <item row="2" column="0">
+           <widget class="QCheckBox" name="constrainedIntraCheckBox">
+            <property name="text">
              <string>Constrained Intra Prediction</string>
             </property>
            </widget>
@@ -1197,89 +1190,89 @@
         </widget>
        </item>
        <item>
-        <spacer>
-         <property name="orientation" >
+        <spacer name="spacer_19">
+         <property name="orientation">
           <enum>Qt::Vertical</enum>
          </property>
-         <property name="sizeHint" >
+         <property name="sizeHint" stdset="0">
           <size>
-           <width>436</width>
-           <height>2</height>
+           <width>0</width>
+           <height>0</height>
           </size>
          </property>
         </spacer>
        </item>
       </layout>
      </widget>
-     <widget class="QWidget" name="tab_3" >
-      <attribute name="title" >
+     <widget class="QWidget" name="tab_3">
+      <attribute name="title">
        <string>Partition</string>
       </attribute>
-      <layout class="QVBoxLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
+      <layout class="QVBoxLayout">
+       <property name="spacing">
         <number>6</number>
        </property>
+       <property name="margin">
+        <number>9</number>
+       </property>
        <item>
-        <widget class="QGroupBox" name="groupBox_10" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_10">
+         <property name="title">
           <string>Partition Search</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QVBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QVBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QCheckBox" name="dct8x8CheckBox" >
-              <property name="text" >
+             <widget class="QCheckBox" name="dct8x8CheckBox">
+              <property name="text">
                <string>8x8 DCT Spatial Transform</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QCheckBox" name="p8x8CheckBox" >
-              <property name="text" >
+             <widget class="QCheckBox" name="p8x8CheckBox">
+              <property name="text">
                <string>8x8, 8x16 and 16x8 P-frame Intra-predicted Blocks</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QCheckBox" name="b8x8CheckBox" >
-              <property name="text" >
+             <widget class="QCheckBox" name="b8x8CheckBox">
+              <property name="text">
                <string>8x8, 8x16 and 16x8 B-frame Intra-predicted Blocks</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QCheckBox" name="p4x4CheckBox" >
-              <property name="text" >
+             <widget class="QCheckBox" name="p4x4CheckBox">
+              <property name="text">
                <string>4x4, 4x8 and 8x4 P-frame Intra-predicted Blocks</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QCheckBox" name="i8x8CheckBox" >
-              <property name="text" >
+             <widget class="QCheckBox" name="i8x8CheckBox">
+              <property name="text">
                <string>8x8 Intra-predicted Blocks</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QCheckBox" name="i4x4CheckBox" >
-              <property name="text" >
+             <widget class="QCheckBox" name="i4x4CheckBox">
+              <property name="text">
                <string>4x4 Intra-predicted Blocks</string>
               </property>
              </widget>
@@ -1290,178 +1283,175 @@
         </widget>
        </item>
        <item>
-        <spacer>
-         <property name="orientation" >
+        <spacer name="spacer_20">
+         <property name="orientation">
           <enum>Qt::Vertical</enum>
          </property>
-         <property name="sizeHint" >
+         <property name="sizeHint" stdset="0">
           <size>
-           <width>20</width>
-           <height>61</height>
+           <width>0</width>
+           <height>0</height>
           </size>
          </property>
         </spacer>
        </item>
       </layout>
      </widget>
-     <widget class="QWidget" name="tab_4" >
-      <attribute name="title" >
+     <widget class="QWidget" name="tab_4">
+      <attribute name="title">
        <string>Frame</string>
       </attribute>
-      <layout class="QVBoxLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
+      <layout class="QVBoxLayout">
+       <property name="spacing">
         <number>6</number>
        </property>
+       <property name="margin">
+        <number>9</number>
+       </property>
        <item>
-        <widget class="QGroupBox" name="groupBox_6" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_6">
+         <property name="title">
           <string>Frame Encoding</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <widget class="QCheckBox" name="cabacCheckBox" >
-            <property name="text" >
+           <widget class="QCheckBox" name="cabacCheckBox">
+            <property name="text">
              <string>CABAC</string>
             </property>
            </widget>
           </item>
           <item>
-           <widget class="QCheckBox" name="interlacedCheckBox" >
-            <property name="text" >
+           <widget class="QCheckBox" name="interlacedCheckBox">
+            <property name="text">
              <string>Pure Interlaced Mode</string>
             </property>
            </widget>
           </item>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QCheckBox" name="loopFilterCheckBox" >
-              <property name="text" >
+             <widget class="QCheckBox" name="loopFilterCheckBox">
+              <property name="text">
                <string>Loop Filter</string>
               </property>
              </widget>
             </item>
             <item>
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_22">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeType" >
+                <property name="sizeType">
                  <enum>QSizePolicy::Fixed</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
                   <width>20</width>
-                  <height>20</height>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
               <item>
-               <layout class="QHBoxLayout" >
-                <property name="margin" >
-                 <number>0</number>
-                </property>
-                <property name="spacing" >
+               <layout class="QHBoxLayout">
+                <property name="spacing">
                  <number>6</number>
                 </property>
+                <property name="margin">
+                 <number>0</number>
+                </property>
                 <item>
-                 <widget class="QLabel" name="alphaC0Label" >
-                  <property name="enabled" >
+                 <widget class="QLabel" name="alphaC0Label">
+                  <property name="enabled">
                    <bool>false</bool>
                   </property>
-                  <property name="text" >
+                  <property name="text">
                    <string>Strength:</string>
                   </property>
                  </widget>
                 </item>
                 <item>
-                 <widget class="QSpinBox" name="alphaC0SpinBox" >
-                  <property name="enabled" >
+                 <widget class="QSpinBox" name="alphaC0SpinBox">
+                  <property name="enabled">
                    <bool>false</bool>
                   </property>
-                  <property name="maximum" >
-                   <number>6</number>
-                  </property>
-                  <property name="minimum" >
+                  <property name="minimum">
                    <number>-6</number>
                   </property>
+                  <property name="maximum">
+                   <number>6</number>
+                  </property>
                  </widget>
                 </item>
                 <item>
-                 <spacer>
-                  <property name="orientation" >
+                 <spacer name="spacer_23">
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="sizeType" >
+                  <property name="sizeType">
                    <enum>QSizePolicy::Fixed</enum>
                   </property>
-                  <property name="sizeHint" >
+                  <property name="sizeHint" stdset="0">
                    <size>
                     <width>10</width>
-                    <height>20</height>
+                    <height>0</height>
                    </size>
                   </property>
                  </spacer>
                 </item>
                 <item>
-                 <widget class="QLabel" name="betaLabel" >
-                  <property name="enabled" >
+                 <widget class="QLabel" name="betaLabel">
+                  <property name="enabled">
                    <bool>false</bool>
                   </property>
-                  <property name="text" >
+                  <property name="text">
                    <string>Threshold:</string>
                   </property>
                  </widget>
                 </item>
                 <item>
-                 <widget class="QSpinBox" name="betaSpinBox" >
-                  <property name="enabled" >
+                 <widget class="QSpinBox" name="betaSpinBox">
+                  <property name="enabled">
                    <bool>false</bool>
                   </property>
-                  <property name="maximum" >
-                   <number>6</number>
-                  </property>
-                  <property name="minimum" >
+                  <property name="minimum">
                    <number>-6</number>
                   </property>
+                  <property name="maximum">
+                   <number>6</number>
+                  </property>
                  </widget>
                 </item>
                 <item>
-                 <spacer>
-                  <property name="orientation" >
+                 <spacer name="spacer_21">
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="sizeType" >
-                   <enum>QSizePolicy::MinimumExpanding</enum>
-                  </property>
-                  <property name="sizeHint" >
+                  <property name="sizeHint" stdset="0">
                    <size>
-                    <width>10</width>
-                    <height>20</height>
+                    <width>0</width>
+                    <height>0</height>
                    </size>
                   </property>
                  </spacer>
@@ -1474,13 +1464,13 @@
           </item>
           <item>
            <spacer>
-            <property name="orientation" >
+            <property name="orientation">
              <enum>Qt::Vertical</enum>
             </property>
-            <property name="sizeType" >
+            <property name="sizeType">
              <enum>QSizePolicy::Fixed</enum>
             </property>
-            <property name="sizeHint" >
+            <property name="sizeHint" stdset="0">
              <size>
               <width>20</width>
               <height>2</height>
@@ -1489,50 +1479,47 @@
            </spacer>
           </item>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QLabel" name="label_30" >
-              <property name="text" >
+             <widget class="QLabel" name="label_30">
+              <property name="text">
                <string>Maximum Reference Frames:</string>
               </property>
              </widget>
             </item>
             <item>
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="refFramesSpinBox" >
-                <property name="maximum" >
-                 <number>16</number>
-                </property>
-                <property name="minimum" >
+               <widget class="QSpinBox" name="refFramesSpinBox">
+                <property name="minimum">
                  <number>1</number>
                 </property>
+                <property name="maximum">
+                 <number>16</number>
+                </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_24">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeType" >
-                 <enum>QSizePolicy::MinimumExpanding</enum>
-                </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>10</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
@@ -1545,194 +1532,188 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="groupBox_9" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_9">
+         <property name="title">
           <string>B-frames</string>
          </property>
-         <layout class="QGridLayout" >
-          <property name="margin" >
+         <layout class="QGridLayout">
+          <property name="margin">
            <number>9</number>
           </property>
-          <property name="spacing" >
+          <property name="spacing">
            <number>6</number>
           </property>
-          <item row="4" column="0" >
-           <widget class="QLabel" name="label_33" >
-            <property name="text" >
+          <item row="4" column="0">
+           <widget class="QLabel" name="label_33">
+            <property name="text">
              <string>B-frames as References:</string>
             </property>
            </widget>
           </item>
-          <item row="4" column="1" >
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+          <item row="4" column="1">
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QComboBox" name="bFrameRefComboBox" >
+             <widget class="QComboBox" name="bFrameRefComboBox">
               <item>
-               <property name="text" >
+               <property name="text">
                 <string>Disabled</string>
                </property>
               </item>
               <item>
-               <property name="text" >
+               <property name="text">
                 <string>Strictly Hierarchical Pyramid</string>
                </property>
               </item>
               <item>
-               <property name="text" >
+               <property name="text">
                 <string>Non-strict (Not Blu-ray Compatible)</string>
                </property>
               </item>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_28">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>40</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
             </item>
            </layout>
           </item>
-          <item row="3" column="1" >
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+          <item row="3" column="1">
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QComboBox" name="adaptiveBFrameComboBox" >
+             <widget class="QComboBox" name="adaptiveBFrameComboBox">
               <item>
-               <property name="text" >
+               <property name="text">
                 <string>Disabled</string>
                </property>
               </item>
               <item>
-               <property name="text" >
+               <property name="text">
                 <string>Fast</string>
                </property>
               </item>
               <item>
-               <property name="text" >
+               <property name="text">
                 <string>Optimal</string>
                </property>
               </item>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_27">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>40</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
             </item>
            </layout>
           </item>
-          <item rowspan="2" row="1" column="1" >
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+          <item row="1" column="1" rowspan="2">
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QSpinBox" name="BFrameBiasSpinBox" >
-              <property name="maximum" >
-               <number>100</number>
-              </property>
-              <property name="minimum" >
+             <widget class="QSpinBox" name="BFrameBiasSpinBox">
+              <property name="minimum">
                <number>-100</number>
               </property>
+              <property name="maximum">
+               <number>100</number>
+              </property>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_26">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeType" >
-               <enum>QSizePolicy::MinimumExpanding</enum>
-              </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>10</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
             </item>
            </layout>
           </item>
-          <item row="0" column="1" >
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+          <item row="0" column="1">
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QSpinBox" name="maxBFramesSpinBox" >
-              <property name="maximum" >
+             <widget class="QSpinBox" name="maxBFramesSpinBox">
+              <property name="maximum">
                <number>16</number>
               </property>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_25">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeType" >
-               <enum>QSizePolicy::MinimumExpanding</enum>
-              </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>10</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
             </item>
            </layout>
           </item>
-          <item row="1" column="0" >
-           <widget class="QLabel" name="label_29" >
-            <property name="text" >
+          <item row="1" column="0">
+           <widget class="QLabel" name="label_29">
+            <property name="text">
              <string>B-frame Bias:</string>
             </property>
            </widget>
           </item>
-          <item row="0" column="0" >
-           <widget class="QLabel" name="label_31" >
-            <property name="text" >
+          <item row="0" column="0">
+           <widget class="QLabel" name="label_31">
+            <property name="text">
              <string>Maximum Consecutive B-frames:</string>
             </property>
            </widget>
           </item>
-          <item rowspan="2" row="2" column="0" >
-           <widget class="QLabel" name="label_4" >
-            <property name="text" >
+          <item row="2" column="0" rowspan="2">
+           <widget class="QLabel" name="label_4">
+            <property name="text">
              <string>Adaptive B-frame Decision:</string>
             </property>
            </widget>
@@ -1741,159 +1722,150 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="groupBox_8" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_8">
+         <property name="title">
           <string>I-frames</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QVBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QVBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <layout class="QGridLayout" >
-              <property name="margin" >
+             <layout class="QGridLayout">
+              <property name="margin">
                <number>0</number>
               </property>
-              <property name="spacing" >
+              <property name="spacing">
                <number>6</number>
               </property>
-              <item row="0" column="1" >
-               <layout class="QHBoxLayout" >
-                <property name="margin" >
-                 <number>0</number>
-                </property>
-                <property name="spacing" >
+              <item row="0" column="1">
+               <layout class="QHBoxLayout">
+                <property name="spacing">
                  <number>6</number>
                 </property>
+                <property name="margin">
+                 <number>0</number>
+                </property>
                 <item>
-                 <widget class="QSpinBox" name="minGopSizeSpinBox" >
-                  <property name="maximum" >
+                 <widget class="QSpinBox" name="minGopSizeSpinBox">
+                  <property name="maximum">
                    <number>100</number>
                   </property>
-                  <property name="value" >
+                  <property name="value">
                    <number>25</number>
                   </property>
                  </widget>
                 </item>
                 <item>
-                 <spacer>
-                  <property name="orientation" >
+                 <spacer name="spacer_29">
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="sizeType" >
-                   <enum>QSizePolicy::MinimumExpanding</enum>
-                  </property>
-                  <property name="sizeHint" >
+                  <property name="sizeHint" stdset="0">
                    <size>
-                    <width>10</width>
-                    <height>20</height>
+                    <width>0</width>
+                    <height>0</height>
                    </size>
                   </property>
                  </spacer>
                 </item>
                </layout>
               </item>
-              <item row="1" column="0" >
-               <widget class="QLabel" name="label_26" >
-                <property name="text" >
+              <item row="1" column="0">
+               <widget class="QLabel" name="label_26">
+                <property name="text">
                  <string>Maximum GOP Size:</string>
                 </property>
                </widget>
               </item>
-              <item row="2" column="0" >
-               <widget class="QLabel" name="label_27" >
-                <property name="text" >
+              <item row="2" column="0">
+               <widget class="QLabel" name="label_27">
+                <property name="text">
                  <string>I-frame Threshold:</string>
                 </property>
                </widget>
               </item>
-              <item row="1" column="1" >
-               <layout class="QHBoxLayout" >
-                <property name="margin" >
-                 <number>0</number>
-                </property>
-                <property name="spacing" >
+              <item row="1" column="1">
+               <layout class="QHBoxLayout">
+                <property name="spacing">
                  <number>6</number>
                 </property>
+                <property name="margin">
+                 <number>0</number>
+                </property>
                 <item>
-                 <widget class="QSpinBox" name="maxGopSizeSpinBox" >
-                  <property name="maximum" >
-                   <number>1000</number>
-                  </property>
-                  <property name="minimum" >
+                 <widget class="QSpinBox" name="maxGopSizeSpinBox">
+                  <property name="minimum">
                    <number>1</number>
                   </property>
-                  <property name="value" >
+                  <property name="maximum">
+                   <number>1000</number>
+                  </property>
+                  <property name="value">
                    <number>250</number>
                   </property>
                  </widget>
                 </item>
                 <item>
-                 <spacer>
-                  <property name="orientation" >
+                 <spacer name="spacer_30">
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="sizeType" >
-                   <enum>QSizePolicy::MinimumExpanding</enum>
-                  </property>
-                  <property name="sizeHint" >
+                  <property name="sizeHint" stdset="0">
                    <size>
-                    <width>10</width>
-                    <height>20</height>
+                    <width>0</width>
+                    <height>0</height>
                    </size>
                   </property>
                  </spacer>
                 </item>
                </layout>
               </item>
-              <item row="0" column="0" >
-               <widget class="QLabel" name="label_28" >
-                <property name="text" >
+              <item row="0" column="0">
+               <widget class="QLabel" name="label_28">
+                <property name="text">
                  <string>Minimum GOP Size:</string>
                 </property>
                </widget>
               </item>
-              <item row="2" column="1" >
-               <layout class="QHBoxLayout" >
-                <property name="margin" >
-                 <number>0</number>
-                </property>
-                <property name="spacing" >
+              <item row="2" column="1">
+               <layout class="QHBoxLayout">
+                <property name="spacing">
                  <number>6</number>
                 </property>
+                <property name="margin">
+                 <number>0</number>
+                </property>
                 <item>
-                 <widget class="QSpinBox" name="IFrameThresholdSpinBox" >
-                  <property name="maximum" >
+                 <widget class="QSpinBox" name="IFrameThresholdSpinBox">
+                  <property name="maximum">
                    <number>100</number>
                   </property>
-                  <property name="value" >
+                  <property name="value">
                    <number>40</number>
                   </property>
                  </widget>
                 </item>
                 <item>
-                 <spacer>
-                  <property name="orientation" >
+                 <spacer name="spacer_31">
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="sizeType" >
-                   <enum>QSizePolicy::MinimumExpanding</enum>
-                  </property>
-                  <property name="sizeHint" >
+                  <property name="sizeHint" stdset="0">
                    <size>
-                    <width>10</width>
-                    <height>20</height>
+                    <width>0</width>
+                    <height>0</height>
                    </size>
                   </property>
                  </spacer>
@@ -1904,13 +1876,13 @@
             </item>
             <item>
              <spacer>
-              <property name="orientation" >
+              <property name="orientation">
                <enum>Qt::Vertical</enum>
               </property>
-              <property name="sizeType" >
+              <property name="sizeType">
                <enum>QSizePolicy::Fixed</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
                 <width>362</width>
                 <height>2</height>
@@ -1919,8 +1891,8 @@
              </spacer>
             </item>
             <item>
-             <widget class="QCheckBox" name="intraRefreshCheckBox" >
-              <property name="text" >
+             <widget class="QCheckBox" name="intraRefreshCheckBox">
+              <property name="text">
                <string>Periodic Intra Refresh</string>
               </property>
              </widget>
@@ -1931,98 +1903,98 @@
         </widget>
        </item>
        <item>
-        <spacer>
-         <property name="orientation" >
+        <spacer name="spacer_32">
+         <property name="orientation">
           <enum>Qt::Vertical</enum>
          </property>
-         <property name="sizeHint" >
+         <property name="sizeHint" stdset="0">
           <size>
-           <width>20</width>
-           <height>40</height>
+           <width>0</width>
+           <height>0</height>
           </size>
          </property>
         </spacer>
        </item>
       </layout>
      </widget>
-     <widget class="QWidget" name="tab_5" >
-      <attribute name="title" >
+     <widget class="QWidget" name="tab_5">
+      <attribute name="title">
        <string>Analysis</string>
       </attribute>
-      <layout class="QVBoxLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
+      <layout class="QVBoxLayout">
+       <property name="spacing">
         <number>6</number>
        </property>
+       <property name="margin">
+        <number>9</number>
+       </property>
        <item>
-        <widget class="QGroupBox" name="groupBox_12" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_12">
+         <property name="title">
           <string>Analysis</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <widget class="QCheckBox" name="mixedRefsCheckBox" >
-            <property name="text" >
+           <widget class="QCheckBox" name="mixedRefsCheckBox">
+            <property name="text">
              <string>Mixed References</string>
             </property>
            </widget>
           </item>
           <item>
-           <widget class="QCheckBox" name="chromaMotionEstCheckBox" >
-            <property name="text" >
+           <widget class="QCheckBox" name="chromaMotionEstCheckBox">
+            <property name="text">
              <string>Chroma Motion Estimation</string>
             </property>
            </widget>
           </item>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QCheckBox" name="trellisCheckBox" >
-              <property name="text" >
+             <widget class="QCheckBox" name="trellisCheckBox">
+              <property name="text">
                <string>Trellis Quantization:</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QComboBox" name="trellisComboBox" >
-              <property name="enabled" >
+             <widget class="QComboBox" name="trellisComboBox">
+              <property name="enabled">
                <bool>false</bool>
               </property>
               <item>
-               <property name="text" >
+               <property name="text">
                 <string>Final Macroblock Only</string>
                </property>
               </item>
               <item>
-               <property name="text" >
+               <property name="text">
                 <string>Always On</string>
                </property>
               </item>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_33">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>40</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
@@ -2030,53 +2002,53 @@
            </layout>
           </item>
           <item>
-           <widget class="QCheckBox" name="fastPSkipCheckBox" >
-            <property name="text" >
+           <widget class="QCheckBox" name="fastPSkipCheckBox">
+            <property name="text">
              <string>Fast Skip Detection on P-frames</string>
             </property>
            </widget>
           </item>
           <item>
-           <widget class="QCheckBox" name="dctDecimateCheckBox" >
-            <property name="text" >
+           <widget class="QCheckBox" name="dctDecimateCheckBox">
+            <property name="text">
              <string>DCT Decimation on P-frames</string>
             </property>
            </widget>
           </item>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QLabel" name="lblPsychoRDO" >
-              <property name="text" >
+             <widget class="QLabel" name="lblPsychoRDO">
+              <property name="text">
                <string>Psychovisual Rate Distortion Optimisation:</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QDoubleSpinBox" name="psychoRdoSpinBox" >
-              <property name="maximum" >
+             <widget class="QDoubleSpinBox" name="psychoRdoSpinBox">
+              <property name="maximum">
                <double>10.000000000000000</double>
               </property>
-              <property name="singleStep" >
+              <property name="singleStep">
                <double>0.100000000000000</double>
               </property>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_34">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>40</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
@@ -2084,36 +2056,36 @@
            </layout>
           </item>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QLabel" name="label_42" >
-              <property name="text" >
+             <widget class="QLabel" name="label_42">
+              <property name="text">
                <string>Noise Reduction:</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QSpinBox" name="noiseReductionSpinBox" >
-              <property name="maximum" >
+             <widget class="QSpinBox" name="noiseReductionSpinBox">
+              <property name="maximum">
                <number>65536</number>
               </property>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_35">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>40</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
@@ -2124,99 +2096,99 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="groupBox_13" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_13">
+         <property name="title">
           <string>Luma Quantisation Deadzone</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QGridLayout" >
-            <property name="margin" >
+           <layout class="QGridLayout">
+            <property name="margin">
              <number>0</number>
             </property>
-            <property name="spacing" >
+            <property name="spacing">
              <number>6</number>
             </property>
-            <item row="0" column="0" >
-             <widget class="QLabel" name="label_44" >
-              <property name="text" >
+            <item row="0" column="0">
+             <widget class="QLabel" name="label_44">
+              <property name="text">
                <string>Intra Luma Quantisation Deadzone:</string>
               </property>
              </widget>
             </item>
-            <item row="1" column="0" >
-             <widget class="QLabel" name="label_43" >
-              <property name="text" >
+            <item row="1" column="0">
+             <widget class="QLabel" name="label_43">
+              <property name="text">
                <string>Inter Luma Quantisation Deadzone:</string>
               </property>
              </widget>
             </item>
-            <item row="0" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="0" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="intraLumaSpinBox" >
-                <property name="maximum" >
+               <widget class="QSpinBox" name="intraLumaSpinBox">
+                <property name="maximum">
                  <number>32</number>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <number>21</number>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_36">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="1" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="1" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="interLumaSpinBox" >
-                <property name="maximum" >
+               <widget class="QSpinBox" name="interLumaSpinBox">
+                <property name="maximum">
                  <number>32</number>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <number>21</number>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_37">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
@@ -2229,76 +2201,76 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="groupBox_14" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_14">
+         <property name="title">
           <string>Quantisation Matrix</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QVBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QVBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QRadioButton" name="matrixFlatRadioButton" >
-              <property name="text" >
+             <widget class="QRadioButton" name="matrixFlatRadioButton">
+              <property name="text">
                <string>Flat Matrix</string>
               </property>
-              <property name="checked" >
+              <property name="checked">
                <bool>true</bool>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QRadioButton" name="matrixJvtRadioButton" >
-              <property name="text" >
+             <widget class="QRadioButton" name="matrixJvtRadioButton">
+              <property name="text">
                <string>JVT Matrix</string>
               </property>
              </widget>
             </item>
             <item>
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QRadioButton" name="matrixCustomRadioButton" >
-                <property name="text" >
+               <widget class="QRadioButton" name="matrixCustomRadioButton">
+                <property name="text">
                  <string>Custom Matrix</string>
                 </property>
                </widget>
               </item>
               <item>
-               <widget class="QPushButton" name="matrixCustomEditButton" >
-                <property name="enabled" >
+               <widget class="QPushButton" name="matrixCustomEditButton">
+                <property name="enabled">
                  <bool>false</bool>
                 </property>
-                <property name="text" >
+                <property name="text">
                  <string>Edit</string>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_38">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
@@ -2311,356 +2283,356 @@
         </widget>
        </item>
        <item>
-        <spacer>
-         <property name="orientation" >
+        <spacer name="spacer_39">
+         <property name="orientation">
           <enum>Qt::Vertical</enum>
          </property>
-         <property name="sizeHint" >
+         <property name="sizeHint" stdset="0">
           <size>
-           <width>20</width>
-           <height>40</height>
+           <width>0</width>
+           <height>0</height>
           </size>
          </property>
         </spacer>
        </item>
       </layout>
      </widget>
-     <widget class="QWidget" name="tab_6" >
-      <attribute name="title" >
+     <widget class="QWidget" name="tab_6">
+      <attribute name="title">
        <string>Quantiser</string>
       </attribute>
-      <layout class="QVBoxLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
+      <layout class="QVBoxLayout">
+       <property name="spacing">
         <number>6</number>
        </property>
+       <property name="margin">
+        <number>9</number>
+       </property>
        <item>
-        <widget class="QGroupBox" name="groupBox_4" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_4">
+         <property name="title">
           <string>Quantiser Control</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QGridLayout" >
-            <property name="margin" >
+           <layout class="QGridLayout">
+            <property name="margin">
              <number>0</number>
             </property>
-            <property name="spacing" >
+            <property name="spacing">
              <number>6</number>
             </property>
-            <item row="2" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="2" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="quantiserMaxStepSpinBox" >
-                <property name="maximum" >
+               <widget class="QSpinBox" name="quantiserMaxStepSpinBox">
+                <property name="maximum">
                  <number>10</number>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <number>4</number>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_42">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="1" column="0" >
-             <widget class="QLabel" name="label_16" >
-              <property name="text" >
+            <item row="1" column="0">
+             <widget class="QLabel" name="label_16">
+              <property name="text">
                <string>Maximum Quantiser:</string>
               </property>
              </widget>
             </item>
-            <item row="4" column="0" >
-             <widget class="QLabel" name="label_6" >
-              <property name="text" >
+            <item row="4" column="0">
+             <widget class="QLabel" name="label_6">
+              <property name="text">
                <string>I and P-frame Quantiser Ratio:</string>
               </property>
              </widget>
             </item>
-            <item row="0" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="0" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="quantiserMinSpinBox" >
-                <property name="maximum" >
+               <widget class="QSpinBox" name="quantiserMinSpinBox">
+                <property name="maximum">
                  <number>51</number>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <number>10</number>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_40">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>47</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="5" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="5" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QDoubleSpinBox" name="quantiserPbRatioSpinBox" >
-                <property name="decimals" >
+               <widget class="QDoubleSpinBox" name="quantiserPbRatioSpinBox">
+                <property name="decimals">
                  <number>1</number>
                 </property>
-                <property name="maximum" >
-                 <double>10.000000000000000</double>
-                </property>
-                <property name="minimum" >
+                <property name="minimum">
                  <double>1.000000000000000</double>
                 </property>
-                <property name="singleStep" >
+                <property name="maximum">
+                 <double>10.000000000000000</double>
+                </property>
+                <property name="singleStep">
                  <double>0.100000000000000</double>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <double>1.300000000000000</double>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_44">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="3" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="3" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="avgBitrateToleranceSpinBox" >
-                <property name="maximum" >
-                 <number>100</number>
-                </property>
-                <property name="minimum" >
+               <widget class="QSpinBox" name="avgBitrateToleranceSpinBox">
+                <property name="minimum">
                  <number>0</number>
                 </property>
-                <property name="value" >
+                <property name="maximum">
                  <number>100</number>
                 </property>
+                <property name="value">
+                 <number>100</number>
+                </property>
                </widget>
               </item>
               <item>
-               <widget class="QLabel" name="label_2" >
-                <property name="text" >
+               <widget class="QLabel" name="label_2">
+                <property name="text">
                  <string>%</string>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_45">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="2" column="0" >
-             <widget class="QLabel" name="label_17" >
-              <property name="text" >
+            <item row="2" column="0">
+             <widget class="QLabel" name="label_17">
+              <property name="text">
                <string>Maximum Quantiser Step:</string>
               </property>
              </widget>
             </item>
-            <item row="6" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="6" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="chromaLumaOffsetSpinBox" >
-                <property name="maximum" >
-                 <number>12</number>
-                </property>
-                <property name="minimum" >
+               <widget class="QSpinBox" name="chromaLumaOffsetSpinBox">
+                <property name="minimum">
                  <number>-12</number>
                 </property>
+                <property name="maximum">
+                 <number>12</number>
+                </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_41">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="5" column="0" >
-             <widget class="QLabel" name="label_7" >
-              <property name="text" >
+            <item row="5" column="0">
+             <widget class="QLabel" name="label_7">
+              <property name="text">
                <string>P and B-frame Quantiser Ratio:</string>
               </property>
              </widget>
             </item>
-            <item row="3" column="0" >
-             <widget class="QLabel" name="label_5" >
-              <property name="text" >
+            <item row="3" column="0">
+             <widget class="QLabel" name="label_5">
+              <property name="text">
                <string>Average Bitrate Tolerance:</string>
               </property>
              </widget>
             </item>
-            <item row="6" column="0" >
-             <widget class="QLabel" name="label_20" >
-              <property name="text" >
+            <item row="6" column="0">
+             <widget class="QLabel" name="label_20">
+              <property name="text">
                <string>Chroma to Luma Quantiser Offset:</string>
               </property>
              </widget>
             </item>
-            <item row="1" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="1" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="quantiserMaxSpinBox" >
-                <property name="maximum" >
-                 <number>51</number>
-                </property>
-                <property name="minimum" >
+               <widget class="QSpinBox" name="quantiserMaxSpinBox">
+                <property name="minimum">
                  <number>10</number>
                 </property>
-                <property name="value" >
+                <property name="maximum">
                  <number>51</number>
                 </property>
+                <property name="value">
+                 <number>51</number>
+                </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_46">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="0" column="0" >
-             <widget class="QLabel" name="label_15" >
-              <property name="text" >
+            <item row="0" column="0">
+             <widget class="QLabel" name="label_15">
+              <property name="text">
                <string>Minimum Quantiser:</string>
               </property>
              </widget>
             </item>
-            <item row="4" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="4" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QDoubleSpinBox" name="quantiserIpRatioSpinBox" >
-                <property name="decimals" >
+               <widget class="QDoubleSpinBox" name="quantiserIpRatioSpinBox">
+                <property name="decimals">
                  <number>1</number>
                 </property>
-                <property name="maximum" >
-                 <double>10.000000000000000</double>
-                </property>
-                <property name="minimum" >
+                <property name="minimum">
                  <double>1.000000000000000</double>
                 </property>
-                <property name="singleStep" >
+                <property name="maximum">
+                 <double>10.000000000000000</double>
+                </property>
+                <property name="singleStep">
                  <double>0.100000000000000</double>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <double>1.400000000000000</double>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_43">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
@@ -2673,66 +2645,66 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="groupBox_3" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_3">
+         <property name="title">
           <string>Quantiser Curve Compression</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QLabel" name="label_8" >
-              <property name="text" >
+             <widget class="QLabel" name="label_8">
+              <property name="text">
                <string>Quantiser Curve Compression:</string>
               </property>
              </widget>
             </item>
             <item>
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="quantiserCurveCompressSpinBox" >
-                <property name="maximum" >
+               <widget class="QSpinBox" name="quantiserCurveCompressSpinBox">
+                <property name="maximum">
                  <number>100</number>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <number>60</number>
                 </property>
                </widget>
               </item>
               <item>
-               <widget class="QLabel" name="label_18" >
-                <property name="text" >
+               <widget class="QLabel" name="label_18">
+                <property name="text">
                  <string>%</string>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_49">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
@@ -2742,98 +2714,98 @@
            </layout>
           </item>
           <item>
-           <layout class="QGridLayout" >
-            <property name="margin" >
+           <layout class="QGridLayout">
+            <property name="margin">
              <number>0</number>
             </property>
-            <property name="spacing" >
+            <property name="spacing">
              <number>6</number>
             </property>
-            <item row="0" column="0" >
-             <widget class="QLabel" name="label_21" >
-              <property name="text" >
+            <item row="0" column="0">
+             <widget class="QLabel" name="label_21">
+              <property name="text">
                <string>Reduce Fluctuation Before Curve Compression:</string>
               </property>
              </widget>
             </item>
-            <item row="0" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="0" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QDoubleSpinBox" name="quantiserBeforeCompressSpinBox" >
-                <property name="decimals" >
+               <widget class="QDoubleSpinBox" name="quantiserBeforeCompressSpinBox">
+                <property name="decimals">
                  <number>1</number>
                 </property>
-                <property name="maximum" >
+                <property name="maximum">
                  <double>999.000000000000000</double>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <double>20.000000000000000</double>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_50">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="1" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="1" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QDoubleSpinBox" name="quantiserAfterCompressSpinBox" >
-                <property name="decimals" >
+               <widget class="QDoubleSpinBox" name="quantiserAfterCompressSpinBox">
+                <property name="decimals">
                  <number>1</number>
                 </property>
-                <property name="maximum" >
+                <property name="maximum">
                  <double>1.000000000000000</double>
                 </property>
-                <property name="singleStep" >
+                <property name="singleStep">
                  <double>0.100000000000000</double>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <double>0.500000000000000</double>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_48">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="1" column="0" >
-             <widget class="QLabel" name="label_22" >
-              <property name="text" >
+            <item row="1" column="0">
+             <widget class="QLabel" name="label_22">
+              <property name="text">
                <string>Reduce Fluctuation After Curve Compression:</string>
               </property>
              </widget>
@@ -2844,86 +2816,86 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="aqGroupBox" >
-         <property name="title" >
+        <widget class="QGroupBox" name="aqGroupBox">
+         <property name="title">
           <string>Adaptive Quantisation</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QCheckBox" name="aqVarianceCheckBox" >
-              <property name="text" >
+             <widget class="QCheckBox" name="aqVarianceCheckBox">
+              <property name="text">
                <string>Variance AQ</string>
               </property>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_51">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeType" >
+              <property name="sizeType">
                <enum>QSizePolicy::Fixed</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
                 <width>20</width>
-                <height>20</height>
+                <height>0</height>
                </size>
               </property>
              </spacer>
             </item>
             <item>
-             <widget class="QLabel" name="aqStrengthLabel" >
-              <property name="enabled" >
+             <widget class="QLabel" name="aqStrengthLabel">
+              <property name="enabled">
                <bool>false</bool>
               </property>
-              <property name="text" >
+              <property name="text">
                <string>Strength:</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QDoubleSpinBox" name="aqStrengthSpinBox" >
-              <property name="enabled" >
+             <widget class="QDoubleSpinBox" name="aqStrengthSpinBox">
+              <property name="enabled">
                <bool>false</bool>
               </property>
-              <property name="decimals" >
+              <property name="decimals">
                <number>2</number>
               </property>
-              <property name="maximum" >
-               <double>1.500000000000000</double>
-              </property>
-              <property name="minimum" >
+              <property name="minimum">
                <double>0.500000000000000</double>
               </property>
-              <property name="singleStep" >
+              <property name="maximum">
+               <double>1.500000000000000</double>
+              </property>
+              <property name="singleStep">
                <double>0.100000000000000</double>
               </property>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_47">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>40</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
@@ -2934,190 +2906,188 @@
         </widget>
        </item>
        <item>
-        <spacer>
-         <property name="orientation" >
+        <spacer name="spacer_52">
+         <property name="orientation">
           <enum>Qt::Vertical</enum>
          </property>
-         <property name="sizeHint" >
+         <property name="sizeHint" stdset="0">
           <size>
-           <width>20</width>
-           <height>40</height>
+           <width>0</width>
+           <height>0</height>
           </size>
          </property>
         </spacer>
        </item>
       </layout>
      </widget>
-     <widget class="QWidget" name="tab_7" >
-      <attribute name="title" >
+     <widget class="QWidget" name="tab_7">
+      <attribute name="title">
        <string>Advanced</string>
       </attribute>
-      <layout class="QVBoxLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
+      <layout class="QVBoxLayout">
+       <property name="spacing">
         <number>6</number>
        </property>
+       <property name="margin">
+        <number>9</number>
+       </property>
        <item>
-        <widget class="QGroupBox" name="groupBox" >
-         <property name="sizePolicy" >
-          <sizepolicy>
-           <hsizetype>5</hsizetype>
-           <vsizetype>5</vsizetype>
+        <widget class="QGroupBox" name="groupBox">
+         <property name="sizePolicy">
+          <sizepolicy hsizetype="Preferred" vsizetype="Preferred">
            <horstretch>0</horstretch>
            <verstretch>0</verstretch>
           </sizepolicy>
          </property>
-         <property name="title" >
+         <property name="title">
           <string>Video Buffer Verifier</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QGridLayout" >
-            <property name="margin" >
+           <layout class="QGridLayout">
+            <property name="margin">
              <number>0</number>
             </property>
-            <property name="spacing" >
+            <property name="spacing">
              <number>6</number>
             </property>
-            <item row="0" column="0" >
-             <widget class="QLabel" name="label_9" >
-              <property name="text" >
+            <item row="0" column="0">
+             <widget class="QLabel" name="label_9">
+              <property name="text">
                <string>Maximum VBV Bitrate:</string>
               </property>
              </widget>
             </item>
-            <item row="2" column="0" >
-             <widget class="QLabel" name="label_14" >
-              <property name="text" >
+            <item row="2" column="0">
+             <widget class="QLabel" name="label_14">
+              <property name="text">
                <string>Initial VBV Buffer Occupancy:</string>
               </property>
              </widget>
             </item>
-            <item row="1" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="1" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="vbvBufferSizeSpinBox" >
-                <property name="maximum" >
+               <widget class="QSpinBox" name="vbvBufferSizeSpinBox">
+                <property name="maximum">
                  <number>99999</number>
                 </property>
                </widget>
               </item>
               <item>
-               <widget class="QLabel" name="label_12" >
-                <property name="text" >
+               <widget class="QLabel" name="label_12">
+                <property name="text">
                  <string>kbit</string>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_55">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="2" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="2" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="vbvBufferOccupancySpinBox" >
-                <property name="maximum" >
+               <widget class="QSpinBox" name="vbvBufferOccupancySpinBox">
+                <property name="maximum">
                  <number>100</number>
                 </property>
-                <property name="value" >
+                <property name="value">
                  <number>90</number>
                 </property>
                </widget>
               </item>
               <item>
-               <widget class="QLabel" name="label_13" >
-                <property name="text" >
+               <widget class="QLabel" name="label_13">
+                <property name="text">
                  <string>%</string>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_58">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="0" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="0" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="vbvMaxBitrateSpinBox" >
-                <property name="maximum" >
+               <widget class="QSpinBox" name="vbvMaxBitrateSpinBox">
+                <property name="maximum">
                  <number>99999</number>
                 </property>
                </widget>
               </item>
               <item>
-               <widget class="QLabel" name="label_10" >
-                <property name="text" >
+               <widget class="QLabel" name="label_10">
+                <property name="text">
                  <string>kbit/s</string>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_56">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="1" column="0" >
-             <widget class="QLabel" name="label_11" >
-              <property name="text" >
+            <item row="1" column="0">
+             <widget class="QLabel" name="label_11">
+              <property name="text">
                <string>VBV Buffer Size:</string>
               </property>
              </widget>
@@ -3128,129 +3098,129 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="slicingGroupBox" >
-         <property name="title" >
+        <widget class="QGroupBox" name="slicingGroupBox">
+         <property name="title">
           <string>Slicing</string>
          </property>
-         <layout class="QGridLayout" >
-          <property name="margin" >
+         <layout class="QGridLayout">
+          <property name="margin">
            <number>9</number>
           </property>
-          <property name="spacing" >
+          <property name="spacing">
            <number>6</number>
           </property>
-          <item row="2" column="0" >
-           <widget class="QLabel" name="label_25" >
-            <property name="text" >
+          <item row="2" column="0">
+           <widget class="QLabel" name="label_25">
+            <property name="text">
              <string>Slices per Frame:</string>
             </property>
            </widget>
           </item>
-          <item row="0" column="0" >
-           <widget class="QLabel" name="label_23" >
-            <property name="text" >
+          <item row="0" column="0">
+           <widget class="QLabel" name="label_23">
+            <property name="text">
              <string>Maximum Size per Slice:</string>
             </property>
            </widget>
           </item>
-          <item row="0" column="1" colspan="2" >
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+          <item row="0" column="1" colspan="2">
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QSpinBox" name="maxSliceSizeSpinBox" >
-              <property name="maximum" >
+             <widget class="QSpinBox" name="maxSliceSizeSpinBox">
+              <property name="maximum">
                <number>2147483647</number>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QLabel" name="label_32" >
-              <property name="text" >
+             <widget class="QLabel" name="label_32">
+              <property name="text">
                <string>bytes</string>
               </property>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_54">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>461</width>
-                <height>16</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
             </item>
            </layout>
           </item>
-          <item row="1" column="0" >
-           <widget class="QLabel" name="label_24" >
-            <property name="text" >
+          <item row="1" column="0">
+           <widget class="QLabel" name="label_24">
+            <property name="text">
              <string>Maximum Macroblocks per Slice:</string>
             </property>
            </widget>
           </item>
-          <item row="1" column="1" >
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+          <item row="1" column="1">
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QSpinBox" name="maxSliceMbSpinBox" >
-              <property name="maximum" >
+             <widget class="QSpinBox" name="maxSliceMbSpinBox">
+              <property name="maximum">
                <number>2147483647</number>
               </property>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_57">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>40</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
             </item>
            </layout>
           </item>
-          <item row="2" column="1" >
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+          <item row="2" column="1">
+           <layout class="QHBoxLayout">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <widget class="QSpinBox" name="slicesPerFrameSpinBox" >
-              <property name="maximum" >
+             <widget class="QSpinBox" name="slicesPerFrameSpinBox">
+              <property name="maximum">
                <number>2147483647</number>
               </property>
              </widget>
             </item>
             <item>
-             <spacer>
-              <property name="orientation" >
+             <spacer name="spacer_53">
+              <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
-              <property name="sizeHint" >
+              <property name="sizeHint" stdset="0">
                <size>
-                <width>40</width>
-                <height>20</height>
+                <width>0</width>
+                <height>0</height>
                </size>
               </property>
              </spacer>
@@ -3261,73 +3231,61 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="groupBox_21" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_21">
+         <property name="title">
           <string>Zones</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QHBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
-             <number>6</number>
-            </property>
+           <layout class="QHBoxLayout" name="_12">
             <item>
-             <widget class="QTableView" name="zoneTableView" >
-              <property name="selectionMode" >
+             <widget class="QTableView" name="zoneTableView">
+              <property name="selectionMode">
                <enum>QAbstractItemView::SingleSelection</enum>
               </property>
-              <property name="selectionBehavior" >
+              <property name="selectionBehavior">
                <enum>QAbstractItemView::SelectRows</enum>
               </property>
              </widget>
             </item>
             <item>
-             <layout class="QVBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
-               <number>6</number>
-              </property>
+             <layout class="QVBoxLayout" name="_13">
               <item>
-               <widget class="QPushButton" name="zoneAddButton" >
-                <property name="text" >
+               <widget class="QPushButton" name="zoneAddButton">
+                <property name="text">
                  <string>Add</string>
                 </property>
                </widget>
               </item>
               <item>
-               <widget class="QPushButton" name="zoneEditButton" >
-                <property name="text" >
+               <widget class="QPushButton" name="zoneEditButton">
+                <property name="text">
                  <string>Edit</string>
                 </property>
                </widget>
               </item>
               <item>
-               <widget class="QPushButton" name="zoneDeleteButton" >
-                <property name="text" >
+               <widget class="QPushButton" name="zoneDeleteButton">
+                <property name="text">
                  <string>Delete</string>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_59">
+                <property name="orientation">
                  <enum>Qt::Vertical</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>20</width>
-                  <height>40</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
@@ -3341,212 +3299,212 @@
        </item>
       </layout>
      </widget>
-     <widget class="QWidget" name="tab_8" >
-      <attribute name="title" >
-       <string>Output</string>
+     <widget class="QWidget" name="tab_8">
+      <attribute name="title">
+       <string>Output 1</string>
       </attribute>
-      <layout class="QVBoxLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
+      <layout class="QVBoxLayout">
+       <property name="spacing">
         <number>6</number>
        </property>
+       <property name="margin">
+        <number>9</number>
+       </property>
        <item>
-        <widget class="QGroupBox" name="groupBox_16" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_16">
+         <property name="title">
           <string>Output</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QGridLayout" >
-            <property name="margin" >
+           <layout class="QGridLayout">
+            <property name="margin">
              <number>0</number>
             </property>
-            <property name="spacing" >
+            <property name="spacing">
              <number>6</number>
             </property>
-            <item row="0" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="0" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QComboBox" name="idcLevelComboBox" >
-                <property name="currentIndex" >
+               <widget class="QComboBox" name="idcLevelComboBox">
+                <property name="currentIndex">
                  <number>0</number>
                 </property>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>Auto</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>1</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>1.1</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>1.2</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>1.3</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>2</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>2.1</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>2.2</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>3</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>3.1</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>3.2</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>4</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>4.1</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>4.2</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>5</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>5.1</string>
                  </property>
                 </item>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_61">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="1" column="0" >
-             <widget class="QLabel" name="label_55" >
-              <property name="text" >
+            <item row="1" column="0">
+             <widget class="QLabel" name="label_55">
+              <property name="text">
                <string>Sequence Parameter Set Identifer:</string>
               </property>
              </widget>
             </item>
-            <item row="0" column="0" >
-             <widget class="QLabel" name="label_56" >
-              <property name="text" >
+            <item row="0" column="0">
+             <widget class="QLabel" name="label_56">
+              <property name="text">
                <string>IDC Level:</string>
               </property>
              </widget>
             </item>
-            <item row="1" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="1" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QComboBox" name="spsiComboBox" >
+               <widget class="QComboBox" name="spsiComboBox">
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>0</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>1</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>3</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>7</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>15</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>31</string>
                  </property>
                 </item>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_63">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
@@ -3556,8 +3514,8 @@
            </layout>
           </item>
           <item>
-           <widget class="QCheckBox" name="accessUnitCheckBox" >
-            <property name="text" >
+           <widget class="QCheckBox" name="accessUnitCheckBox">
+            <property name="text">
              <string>Generate Access Unit Delimiters</string>
             </property>
            </widget>
@@ -3566,182 +3524,182 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="groupBox_15" >
-         <property name="title" >
+        <widget class="QGroupBox" name="groupBox_15">
+         <property name="title">
           <string>Pixel Aspect Ratio</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <layout class="QGridLayout" >
-            <property name="margin" >
+           <layout class="QGridLayout">
+            <property name="margin">
              <number>0</number>
             </property>
-            <property name="spacing" >
+            <property name="spacing">
              <number>6</number>
             </property>
-            <item row="0" column="0" >
-             <widget class="QRadioButton" name="sarCustomRadioButton" >
-              <property name="text" >
-               <string comment="PAR" >Custom:</string>
+            <item row="0" column="0">
+             <widget class="QRadioButton" name="sarCustomRadioButton">
+              <property name="text">
+               <string comment="PAR">Custom:</string>
               </property>
-              <property name="checked" >
+              <property name="checked">
                <bool>true</bool>
               </property>
              </widget>
             </item>
-            <item row="2" column="0" >
-             <widget class="QRadioButton" name="sarAsInputRadioButton" >
-              <property name="text" >
+            <item row="2" column="0">
+             <widget class="QRadioButton" name="sarAsInputRadioButton">
+              <property name="text">
                <string>As Input</string>
               </property>
              </widget>
             </item>
-            <item row="2" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="2" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QLabel" name="sarAsInputLabel" >
-                <property name="enabled" >
+               <widget class="QLabel" name="sarAsInputLabel">
+                <property name="enabled">
                  <bool>false</bool>
                 </property>
-                <property name="text" >
+                <property name="text">
                  <string/>
                 </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_65">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="0" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="0" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QSpinBox" name="sarCustomSpinBox1" >
-                <property name="maximum" >
+               <widget class="QSpinBox" name="sarCustomSpinBox1">
+                <property name="minimum">
+                 <number>1</number>
+                </property>
+                <property name="maximum">
                  <number>9999</number>
                 </property>
-                <property name="minimum" >
+                <property name="value">
                  <number>1</number>
                 </property>
-                <property name="value" >
-                 <number>1</number>
-                </property>
                </widget>
               </item>
               <item>
-               <widget class="QLabel" name="sarCustomLabel" >
-                <property name="text" >
+               <widget class="QLabel" name="sarCustomLabel">
+                <property name="text">
                  <string>:</string>
                 </property>
                </widget>
               </item>
               <item>
-               <widget class="QSpinBox" name="sarCustomSpinBox2" >
-                <property name="maximum" >
+               <widget class="QSpinBox" name="sarCustomSpinBox2">
+                <property name="minimum">
+                 <number>1</number>
+                </property>
+                <property name="maximum">
                  <number>9999</number>
                 </property>
-                <property name="minimum" >
+                <property name="value">
                  <number>1</number>
                 </property>
-                <property name="value" >
-                 <number>1</number>
-                </property>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_64">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
              </layout>
             </item>
-            <item row="1" column="0" >
-             <widget class="QRadioButton" name="sarPredefinedRadioButton" >
-              <property name="text" >
+            <item row="1" column="0">
+             <widget class="QRadioButton" name="sarPredefinedRadioButton">
+              <property name="text">
                <string>Predefined Aspect Ratio:</string>
               </property>
              </widget>
             </item>
-            <item row="1" column="1" >
-             <layout class="QHBoxLayout" >
-              <property name="margin" >
-               <number>0</number>
-              </property>
-              <property name="spacing" >
+            <item row="1" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
                <number>6</number>
               </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
               <item>
-               <widget class="QComboBox" name="sarPredefinedComboBox" >
-                <property name="enabled" >
+               <widget class="QComboBox" name="sarPredefinedComboBox">
+                <property name="enabled">
                  <bool>false</bool>
                 </property>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>16:15 (PAL 4:3)</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>64:45 (PAL 16:9)</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>8:9 (NTSC 4:3)</string>
                  </property>
                 </item>
                 <item>
-                 <property name="text" >
+                 <property name="text">
                   <string>32:27 (NTSC 16:9)</string>
                  </property>
                 </item>
                </widget>
               </item>
               <item>
-               <spacer>
-                <property name="orientation" >
+               <spacer name="spacer_62">
+                <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="sizeHint" >
+                <property name="sizeHint" stdset="0">
                  <size>
-                  <width>40</width>
-                  <height>20</height>
+                  <width>0</width>
+                  <height>0</height>
                  </size>
                 </property>
                </spacer>
@@ -3754,36 +3712,56 @@
         </widget>
        </item>
        <item>
-        <widget class="QGroupBox" name="groupBox_5" >
-         <property name="title" >
+        <spacer name="spacer_60">
+         <property name="orientation">
+          <enum>Qt::Vertical</enum>
+         </property>
+         <property name="sizeHint" stdset="0">
+          <size>
+           <width>0</width>
+           <height>0</height>
+          </size>
+         </property>
+        </spacer>
+       </item>
+      </layout>
+     </widget>
+     <widget class="QWidget" name="tab">
+      <attribute name="title">
+       <string>Output 2</string>
+      </attribute>
+      <layout class="QVBoxLayout" name="verticalLayout">
+       <item>
+        <widget class="QGroupBox" name="groupBox_5">
+         <property name="title">
           <string>Video Usability Information</string>
          </property>
-         <layout class="QVBoxLayout" >
-          <property name="margin" >
-           <number>9</number>
-          </property>
-          <property name="spacing" >
+         <layout class="QVBoxLayout" name="_2">
+          <property name="spacing">
            <number>6</number>
           </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
           <item>
-           <widget class="QLabel" name="label_52" >
-            <property name="text" >
+           <widget class="QLabel" name="label_52">
+            <property name="text">
              <string>These settings are only suggestions for the playback equipment.  Use at your own risk.</string>
             </property>
-            <property name="wordWrap" >
+            <property name="wordWrap">
              <bool>true</bool>
             </property>
            </widget>
           </item>
           <item>
            <spacer>
-            <property name="orientation" >
+            <property name="orientation">
              <enum>Qt::Vertical</enum>
             </property>
-            <property name="sizeType" >
+            <property name="sizeType">
              <enum>QSizePolicy::Fixed</enum>
             </property>
-            <property name="sizeHint" >
+            <property name="sizeHint" stdset="0">
              <size>
               <width>20</width>
               <height>4</height>
@@ -3792,392 +3770,392 @@
            </spacer>
           </item>
           <item>
-           <layout class="QVBoxLayout" >
-            <property name="margin" >
-             <number>0</number>
-            </property>
-            <property name="spacing" >
+           <layout class="QVBoxLayout" name="_3">
+            <property name="spacing">
              <number>6</number>
             </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
             <item>
-             <layout class="QGridLayout" >
-              <property name="margin" >
+             <layout class="QGridLayout" name="_4">
+              <property name="margin">
                <number>0</number>
               </property>
-              <property name="spacing" >
+              <property name="spacing">
                <number>6</number>
               </property>
-              <item row="3" column="1" >
-               <layout class="QHBoxLayout" >
-                <property name="margin" >
-                 <number>0</number>
-                </property>
-                <property name="spacing" >
+              <item row="3" column="1">
+               <layout class="QHBoxLayout" name="_5">
+                <property name="spacing">
                  <number>6</number>
                 </property>
+                <property name="margin">
+                 <number>0</number>
+                </property>
                 <item>
-                 <widget class="QComboBox" name="transferCharacteristicsComboBox" >
+                 <widget class="QComboBox" name="transferCharacteristicsComboBox">
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>Undefined</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>BT709</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>BT470M</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>BT470BG</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>Linear</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>LOG100</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>LOG316</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>SMPTEL170M</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>SMPTE240M</string>
                    </property>
                   </item>
                  </widget>
                 </item>
                 <item>
-                 <spacer>
-                  <property name="orientation" >
+                 <spacer name="spacer_67">
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="sizeHint" >
+                  <property name="sizeHint" stdset="0">
                    <size>
-                    <width>40</width>
-                    <height>20</height>
+                    <width>0</width>
+                    <height>0</height>
                    </size>
                   </property>
                  </spacer>
                 </item>
                </layout>
               </item>
-              <item row="2" column="0" >
-               <widget class="QLabel" name="label_19" >
-                <property name="text" >
+              <item row="2" column="0">
+               <widget class="QLabel" name="label_19">
+                <property name="text">
                  <string>Colour Primaries:</string>
                 </property>
                </widget>
               </item>
-              <item row="0" column="1" >
-               <layout class="QHBoxLayout" >
-                <property name="margin" >
-                 <number>0</number>
-                </property>
-                <property name="spacing" >
+              <item row="0" column="1">
+               <layout class="QHBoxLayout" name="_6">
+                <property name="spacing">
                  <number>6</number>
                 </property>
+                <property name="margin">
+                 <number>0</number>
+                </property>
                 <item>
-                 <widget class="QComboBox" name="overscanComboBox" >
+                 <widget class="QComboBox" name="overscanComboBox">
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>Undefined</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>Show</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>Crop</string>
                    </property>
                   </item>
                  </widget>
                 </item>
                 <item>
-                 <spacer>
-                  <property name="orientation" >
+                 <spacer name="spacer_70">
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="sizeHint" >
+                  <property name="sizeHint" stdset="0">
                    <size>
-                    <width>40</width>
-                    <height>20</height>
+                    <width>0</width>
+                    <height>0</height>
                    </size>
                   </property>
                  </spacer>
                 </item>
                </layout>
               </item>
-              <item row="4" column="1" >
-               <layout class="QHBoxLayout" >
-                <property name="margin" >
-                 <number>0</number>
-                </property>
-                <property name="spacing" >
+              <item row="4" column="1">
+               <layout class="QHBoxLayout" name="_7">
+                <property name="spacing">
                  <number>6</number>
                 </property>
+                <property name="margin">
+                 <number>0</number>
+                </property>
                 <item>
-                 <widget class="QComboBox" name="colourMatrixComboBox" >
+                 <widget class="QComboBox" name="colourMatrixComboBox">
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>Undefined</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>BT709</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>FCC</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>BT470BG</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>SMPTE170M</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>SMPTE240M</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>GBR</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>YCgCo</string>
                    </property>
                   </item>
                  </widget>
                 </item>
                 <item>
-                 <spacer>
-                  <property name="orientation" >
+                 <spacer name="spacer_71">
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="sizeHint" >
+                  <property name="sizeHint" stdset="0">
                    <size>
-                    <width>40</width>
-                    <height>20</height>
+                    <width>0</width>
+                    <height>0</height>
                    </size>
                   </property>
                  </spacer>
                 </item>
                </layout>
               </item>
-              <item row="4" column="0" >
-               <widget class="QLabel" name="label_47" >
-                <property name="text" >
+              <item row="4" column="0">
+               <widget class="QLabel" name="label_47">
+                <property name="text">
                  <string>Colour Matrix:</string>
                 </property>
                </widget>
               </item>
-              <item row="1" column="1" >
-               <layout class="QHBoxLayout" >
-                <property name="margin" >
-                 <number>0</number>
-                </property>
-                <property name="spacing" >
+              <item row="1" column="1">
+               <layout class="QHBoxLayout" name="_8">
+                <property name="spacing">
                  <number>6</number>
                 </property>
+                <property name="margin">
+                 <number>0</number>
+                </property>
                 <item>
-                 <widget class="QComboBox" name="videoFormatComboBox" >
-                  <property name="currentIndex" >
+                 <widget class="QComboBox" name="videoFormatComboBox">
+                  <property name="currentIndex">
                    <number>0</number>
                   </property>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>Undefined</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>Component</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>PAL</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>NTSC</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>SECAM</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>MAC</string>
                    </property>
                   </item>
                  </widget>
                 </item>
                 <item>
-                 <spacer>
-                  <property name="orientation" >
+                 <spacer name="spacer_68">
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="sizeHint" >
+                  <property name="sizeHint" stdset="0">
                    <size>
-                    <width>40</width>
-                    <height>20</height>
+                    <width>0</width>
+                    <height>0</height>
                    </size>
                   </property>
                  </spacer>
                 </item>
                </layout>
               </item>
-              <item row="2" column="1" >
-               <layout class="QHBoxLayout" >
-                <property name="margin" >
-                 <number>0</number>
-                </property>
-                <property name="spacing" >
+              <item row="2" column="1">
+               <layout class="QHBoxLayout" name="_9">
+                <property name="spacing">
                  <number>6</number>
                 </property>
+                <property name="margin">
+                 <number>0</number>
+                </property>
                 <item>
-                 <widget class="QComboBox" name="colourPrimariesComboBox" >
+                 <widget class="QComboBox" name="colourPrimariesComboBox">
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>Undefined</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>BT709</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>BT470M</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>BT470BG</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>SMPTE170M</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>SMPTE240M</string>
                    </property>
                   </item>
                   <item>
-                   <property name="text" >
+                   <property name="text">
                     <string>Film</string>
                    </property>
                   </item>
                  </widget>
                 </item>
                 <item>
-                 <spacer>
-                  <property name="orientation" >
+                 <spacer name="spacer_69">
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="sizeHint" >
+                  <property name="sizeHint" stdset="0">
                    <size>
-                    <width>40</width>
-                    <height>20</height>
+                    <width>0</width>
+                    <height>0</height>
                    </size>
                   </property>
                  </spacer>
                 </item>
                </layout>
               </item>
-              <item row="3" column="0" >
-               <widget class="QLabel" name="label_48" >
-                <property name="text" >
+              <item row="3" column="0">
+               <widget class="QLabel" name="label_48">
+                <property name="text">
                  <string>Transfer Characteristics:</string>
                 </property>
                </widget>
               </item>
-              <item row="5" column="0" >
-               <widget class="QLabel" name="label_49" >
-                <property name="text" >
+              <item row="5" column="0">
+               <widget class="QLabel" name="label_49">
+                <property name="text">
                  <string>Chroma Sample Location:</string>
                 </property>
                </widget>
               </item>
-              <item row="5" column="1" >
-               <layout class="QHBoxLayout" >
-                <property name="margin" >
-                 <number>0</number>
-                </property>
-                <property name="spacing" >
+              <item row="5" column="1">
+               <layout class="QHBoxLayout" name="_10">
+                <property name="spacing">
                  <number>6</number>
                 </property>
+                <property name="margin">
+                 <number>0</number>
+                </property>
                 <item>
-                 <widget class="QSpinBox" name="chromaSampleSpinBox" >
-                  <property name="maximum" >
+                 <widget class="QSpinBox" name="chromaSampleSpinBox">
+                  <property name="maximum">
                    <number>4</number>
                   </property>
                  </widget>
                 </item>
                 <item>
-                 <spacer>
-                  <property name="orientation" >
+                 <spacer name="spacer_66">
+                  <property name="orientation">
                    <enum>Qt::Horizontal</enum>
                   </property>
-                  <property name="sizeHint" >
+                  <property name="sizeHint" stdset="0">
                    <size>
-                    <width>40</width>
-                    <height>20</height>
+                    <width>0</width>
+                    <height>0</height>
                    </size>
                   </property>
                  </spacer>
                 </item>
                </layout>
               </item>
-              <item row="1" column="0" >
-               <widget class="QLabel" name="label_50" >
-                <property name="text" >
+              <item row="1" column="0">
+               <widget class="QLabel" name="label_50">
+                <property name="text">
                  <string>Video Format:</string>
                 </property>
                </widget>
               </item>
-              <item row="0" column="0" >
-               <widget class="QLabel" name="label_51" >
-                <property name="text" >
+              <item row="0" column="0">
+               <widget class="QLabel" name="label_51">
+                <property name="text">
                  <string>Overscan:</string>
                 </property>
                </widget>
@@ -4185,8 +4163,8 @@
              </layout>
             </item>
             <item>
-             <widget class="QCheckBox" name="fullRangeSamplesCheckBox" >
-              <property name="text" >
+             <widget class="QCheckBox" name="fullRangeSamplesCheckBox">
+              <property name="text">
                <string>Full Range Samples</string>
               </property>
              </widget>
@@ -4197,14 +4175,14 @@
         </widget>
        </item>
        <item>
-        <spacer>
-         <property name="orientation" >
+        <spacer name="spacer_72">
+         <property name="orientation">
           <enum>Qt::Vertical</enum>
          </property>
-         <property name="sizeHint" >
+         <property name="sizeHint" stdset="0">
           <size>
-           <width>20</width>
-           <height>61</height>
+           <width>0</width>
+           <height>0</height>
           </size>
          </property>
         </spacer>
@@ -4214,20 +4192,20 @@
     </widget>
    </item>
    <item>
-    <layout class="QHBoxLayout" >
-     <property name="margin" >
-      <number>0</number>
-     </property>
-     <property name="spacing" >
+    <layout class="QHBoxLayout">
+     <property name="spacing">
       <number>6</number>
      </property>
+     <property name="margin">
+      <number>0</number>
+     </property>
      <item>
-      <widget class="QDialogButtonBox" name="buttonBox" >
-       <property name="orientation" >
+      <widget class="QDialogButtonBox" name="buttonBox">
+       <property name="orientation">
         <enum>Qt::Horizontal</enum>
        </property>
-       <property name="standardButtons" >
-        <set>QDialogButtonBox::Cancel|QDialogButtonBox::NoButton|QDialogButtonBox::Ok</set>
+       <property name="standardButtons">
+        <set>QDialogButtonBox::Cancel|QDialogButtonBox::Ok</set>
        </property>
       </widget>
      </item>
@@ -4332,13 +4310,6 @@
   <tabstop>sarPredefinedRadioButton</tabstop>
   <tabstop>sarPredefinedComboBox</tabstop>
   <tabstop>sarAsInputRadioButton</tabstop>
-  <tabstop>overscanComboBox</tabstop>
-  <tabstop>videoFormatComboBox</tabstop>
-  <tabstop>colourPrimariesComboBox</tabstop>
-  <tabstop>transferCharacteristicsComboBox</tabstop>
-  <tabstop>colourMatrixComboBox</tabstop>
-  <tabstop>chromaSampleSpinBox</tabstop>
-  <tabstop>fullRangeSamplesCheckBox</tabstop>
   <tabstop>buttonBox</tabstop>
  </tabstops>
  <resources/>
@@ -4349,11 +4320,11 @@
    <receiver>sarPredefinedComboBox</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>108</x>
      <y>290</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>243</x>
      <y>290</y>
     </hint>
@@ -4365,11 +4336,11 @@
    <receiver>sarCustomSpinBox1</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>108</x>
      <y>262</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>209</x>
      <y>262</y>
     </hint>
@@ -4381,11 +4352,11 @@
    <receiver>sarCustomSpinBox2</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>108</x>
      <y>262</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>272</x>
      <y>262</y>
     </hint>
@@ -4397,11 +4368,11 @@
    <receiver>sarCustomLabel</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>108</x>
      <y>262</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>240</x>
      <y>262</y>
     </hint>
@@ -4413,11 +4384,11 @@
    <receiver>mvLengthSpinBox</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>133</x>
      <y>261</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>256</x>
      <y>261</y>
     </hint>
@@ -4429,11 +4400,11 @@
    <receiver>minThreadBufferSpinBox</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>133</x>
      <y>289</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>256</x>
      <y>289</y>
     </hint>
@@ -4445,11 +4416,11 @@
    <receiver>p4x4CheckBox</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>245</x>
      <y>476</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>245</x>
      <y>524</y>
     </hint>
@@ -4461,11 +4432,11 @@
    <receiver>i8x8CheckBox</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>245</x>
      <y>452</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>245</x>
      <y>548</y>
     </hint>
@@ -4477,11 +4448,11 @@
    <receiver>alphaC0Label</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>245</x>
      <y>185</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>87</x>
      <y>212</y>
     </hint>
@@ -4493,11 +4464,11 @@
    <receiver>alphaC0SpinBox</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>245</x>
      <y>185</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>137</x>
      <y>212</y>
     </hint>
@@ -4509,11 +4480,11 @@
    <receiver>betaLabel</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>245</x>
      <y>185</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>194</x>
      <y>212</y>
     </hint>
@@ -4525,11 +4496,11 @@
    <receiver>betaSpinBox</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>245</x>
      <y>185</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>235</x>
      <y>212</y>
     </hint>
@@ -4541,11 +4512,11 @@
    <receiver>trellisComboBox</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>98</x>
      <y>176</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>227</x>
      <y>176</y>
     </hint>
@@ -4557,11 +4528,11 @@
    <receiver>matrixCustomEditButton</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>88</x>
      <y>458</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>413</x>
      <y>459</y>
     </hint>
@@ -4573,11 +4544,11 @@
    <receiver>sarAsInputLabel</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>108</x>
      <y>318</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>184</x>
      <y>317</y>
     </hint>
@@ -4589,11 +4560,11 @@
    <receiver>threadCustomSpinBox</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>71</x>
      <y>479</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>131</x>
      <y>479</y>
     </hint>
@@ -4605,11 +4576,11 @@
    <receiver>aqStrengthLabel</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>79</x>
      <y>471</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>175</x>
      <y>471</y>
     </hint>
@@ -4621,11 +4592,11 @@
    <receiver>aqStrengthSpinBox</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>79</x>
      <y>471</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>226</x>
      <y>471</y>
     </hint>
@@ -4637,11 +4608,11 @@
    <receiver>x264ConfigDialog</receiver>
    <slot>accept()</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>262</x>
      <y>535</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>262</x>
      <y>292</y>
     </hint>
@@ -4653,11 +4624,11 @@
    <receiver>x264ConfigDialog</receiver>
    <slot>reject()</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>262</x>
      <y>535</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>262</x>
      <y>292</y>
     </hint>
@@ -4669,11 +4640,11 @@
    <receiver>threadedLookaheadSpinBox</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>142</x>
      <y>470</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>273</x>
      <y>470</y>
     </hint>
@@ -4685,11 +4656,11 @@
    <receiver>lblThreadedFrames</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
-    <hint type="sourcelabel" >
+    <hint type="sourcelabel">
      <x>142</x>
      <y>470</y>
     </hint>
-    <hint type="destinationlabel" >
+    <hint type="destinationlabel">
      <x>318</x>
      <y>470</y>
     </hint>



From gruntster at mail.berlios.de  Sun Sep 26 21:39:57 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 26 Sep 2010 21:39:57 +0200
Subject: [Avidemux-svn-commit] r6669 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4
Message-ID: <20100926193957.62F44481006@sheep.berlios.de>

Author: gruntster
Date: 2010-09-26 21:39:57 +0200 (Sun, 26 Sep 2010)
New Revision: 6669

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
Log:
[x264] resize window to make all tabs visible

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-09-26 19:32:08 UTC (rev 6668)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-09-26 19:39:57 UTC (rev 6669)
@@ -137,6 +137,11 @@
 
 	if (!loadPresetSettings(encodeOptions, options))
 		loadSettings(encodeOptions, options);
+
+	// Expand to see all tabs but still allow the window to be resized smaller
+	 ui.tabWidget->setUsesScrollButtons(false);
+	 this->adjustSize();
+	 ui.tabWidget->setUsesScrollButtons(true);
 }
 
 void x264ConfigDialog::fillConfigurationComboBox(void)



From gruntster at mail.berlios.de  Mon Sep 27 00:02:44 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 27 Sep 2010 00:02:44 +0200
Subject: [Avidemux-svn-commit] r6670 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script
Message-ID: <20100926220244.6848F481006@sheep.berlios.de>

Author: gruntster
Date: 2010-09-27 00:02:44 +0200 (Mon, 27 Sep 2010)
New Revision: 6670

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSDirectorySearch.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/DirectorySearch.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/DirectorySearch.h
Log:
[win32] unicode support for js directory search class

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSDirectorySearch.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSDirectorySearch.cpp	2010-09-26 19:39:57 UTC (rev 6669)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSDirectorySearch.cpp	2010-09-26 22:02:44 UTC (rev 6670)
@@ -151,7 +151,7 @@
 	*rval = BOOLEAN_TO_JSVAL(false);
 	if(argc != 0)
 		return JS_FALSE;
-	*rval = STRING_TO_JSVAL(JS_NewStringCopyZ(cx,p->getObject()->GetExtension()));
+	*rval = STRING_TO_JSVAL(JS_NewStringCopyZ(cx,p->getObject()->GetExtension().c_str()));
 	return JS_TRUE;
 }// end GetExtension
 
@@ -233,7 +233,7 @@
 	*rval = BOOLEAN_TO_JSVAL(false);
 	if(argc != 0)
 		return JS_FALSE;
-	*rval = STRING_TO_JSVAL(JS_NewStringCopyZ(cx,p->getObject()->GetFileName()));
+	*rval = STRING_TO_JSVAL(JS_NewStringCopyZ(cx,p->getObject()->GetFileName().c_str()));
 	return JS_TRUE;
 }// end GetFileName
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/DirectorySearch.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/DirectorySearch.cpp	2010-09-26 19:39:57 UTC (rev 6669)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/DirectorySearch.cpp	2010-09-26 22:02:44 UTC (rev 6670)
@@ -11,13 +11,18 @@
 #include "config.h"
 #include "DirectorySearch.h"
 
+#ifdef __WIN32
+extern int wideCharStringToUtf8(const wchar_t *wideCharString, int wideCharStringLength, char *utf8String);
+extern int utf8StringToWideChar(const char *utf8String, int utf8StringLength, wchar_t *wideCharString);
+#endif
+
 //////////////////////////////////////////////////////////////////////
 // Construction/Destruction
 //////////////////////////////////////////////////////////////////////
 
 #if defined(__unix__) || defined(__APPLE__)
-int CDirectorySearch::_findnext(unsigned long int hDir,_finddata_t *pfdData)
-{// begin _findnext
+int CDirectorySearch::_wfindnext(unsigned long int hDir,_wfinddata_t *pfdData)
+{// begin _wfindnext
 	if(!hDir || hDir == 0xFFFFFFFF)
 		return -1; // need to call opendir first
 	struct stat stInfo;
@@ -58,17 +63,17 @@
 	S_ISFIFO(stInfo.st_mode))
 		pfdData->attrib = _A_NONFILE;
 	return 0;
-}// end _findnext
+}// end _wfindnext
 
-int CDirectorySearch::_findfirst(const char *path,_finddata_t *pfdData)
-{// begin _findfirst
+int CDirectorySearch::_wfindfirst(const char *path,_wfinddata_t *pfdData)
+{// begin _wfindfirst
 	unsigned long int hDir = (unsigned long int)opendir(path);
 	if(!hDir)
 		return -1;
-	if(_findnext(hDir,pfdData) == -1)
+	if(_wfindnext(hDir,pfdData) == -1)
 		return -1;
 	return hDir;
-}// end _findfirst
+}// end _wfindfirst
 
 int CDirectorySearch::_findclose(unsigned long int hDir)
 {// begin _findclose
@@ -91,29 +96,39 @@
 
 bool CDirectorySearch::Init(std::string sDirectory)
 {// begin Init
-char *s;
 	// check for no search query
 	if(sDirectory[sDirectory.length()-1] == DIRECTORY_DELIMITOR)
 	{
 		printf("End with directory delimitor\n");
 		return false;
 	}
-	const char *old=sDirectory.c_str();
-	s=new char[strlen(old)+10];
-	strcpy(s,old);
-#ifdef __WIN32	
-	strcat(s,"\\*");
+
+#ifdef __WIN32
+	const char *old = sDirectory.c_str();
+
+	int len = utf8StringToWideChar(old, -1, NULL);
+	wchar_t s[len + 2];
+
+	utf8StringToWideChar(old, -1, s);
+	wcscat(s, L"\\*");
+
+	printf(">%ls<\n", s);
+#else
+	const char *s = sDirectory.c_str();
+
+	printf(">%s<\n",s);
 #endif
-	
-	printf(">%s<\n",s);
-	m_hSearch = _findfirst(s,&m_fdData);
-	delete [] s;	
+
+	m_hSearch = _wfindfirst(s,&m_fdData);
+
 	if(m_hSearch == -1)
 	{
 		printf("Find first failed\n");
 		return false;
 	}
+
 	m_sDirectory = sDirectory;
+
 	return true;
 }// end Init
 
@@ -130,13 +145,42 @@
 	return bRtn;
 }// end Close
 
+std::string CDirectorySearch::GetFileName()
+{
+	std::string sBuffer;
+
+#if defined(__WIN32)
+	int len = wideCharStringToUtf8(m_fdData.name, -1, NULL);
+	char fileName[len];
+
+	wideCharStringToUtf8(m_fdData.name, -1, fileName);
+
+	sBuffer = fileName;
+#else
+	sBuffer = m_fdData.name;
+#endif
+
+	return sBuffer;
+}
+
 std::string CDirectorySearch::GetFilePath()
 {// begin GetFilePath
-	std::string sBuffer = "";
-	sBuffer = m_sDirectory;
+	std::string sBuffer = m_sDirectory;
+
 	if(sBuffer[sBuffer.length()-1] != DIRECTORY_DELIMITOR && m_fdData.name[0] != DIRECTORY_DELIMITOR)
 		sBuffer += DIRECTORY_DELIMITOR;
+
+#if defined(__WIN32)
+	int len = wideCharStringToUtf8(m_fdData.name, -1, NULL);
+	char filePath[len];
+
+	wideCharStringToUtf8(m_fdData.name, -1, filePath);
+
+	sBuffer += filePath;
+#else
 	sBuffer += m_fdData.name;
+#endif
+
 	return sBuffer;
 }// end GetFilePath
 
@@ -166,26 +210,30 @@
 
 bool CDirectorySearch::IsSingleDot()
 {// begin IsSingleDot
-	if(IsDirectory())
-		if(strcmp(".",m_fdData.name) == 0)
-			return true;
-	return false;
+#if defined(__WIN32)
+	return (IsDirectory() && wcscmp(L".", m_fdData.name) == 0);
+#else
+	return (IsDirectory() && strcmp(".",m_fdData.name) == 0);
+#endif
 }// end IsSingleDot
 
 bool CDirectorySearch::IsDoubleDot()
 {// begin IsDoubleDot
-	if(IsDirectory())
-		if(strcmp("..",m_fdData.name) == 0)
-			return true;
-	return false;
+#if defined(__WIN32)
+	return (IsDirectory() && wcscmp(L"..", m_fdData.name) == 0);
+#else
+	return (IsDirectory() && strcmp("..",m_fdData.name) == 0);
+#endif
 }// end IsDoubleDot
 
 bool CDirectorySearch::IsExtension(const char *pExtension)
 {// begin IsExtension
 	int nExtLen = strlen(pExtension);
 	char *pTempBuffer = new char[nExtLen+1];
-	const char *pFileExt = GetExtension();
-	strcpy(pTempBuffer,pExtension);
+	std::string fileExt = GetExtension();
+
+	strcpy(pTempBuffer, fileExt.c_str());
+
 	for(int i = 0,nCurrExtLen = 0;i < nExtLen;i++,nCurrExtLen++)
 	{
 		if(pTempBuffer[i+1] == '\0')
@@ -198,7 +246,7 @@
 		{
 			pTempBuffer[i] = '\0';
 			if(pTempBuffer[i-nCurrExtLen] == '*' || pTempBuffer[i-nCurrExtLen] == '?' 
-				|| (pFileExt && strcmp(&pTempBuffer[i-nCurrExtLen],pFileExt) == 0))
+				|| strcmp(&pTempBuffer[i-nCurrExtLen], fileExt.c_str()) == 0)
 			{
 				// free the buffer
 				delete []pTempBuffer;
@@ -212,13 +260,25 @@
 	return false;
 }// end IsExtension
 
-const char * CDirectorySearch::GetExtension()
+std::string CDirectorySearch::GetExtension()
 {// begin GetExtension
-	for(int i = strlen(m_fdData.name)-1;i >= 0;i--)
-	{// begin search
-		if(m_fdData.name[i] == '.')
-			return &m_fdData.name[i+1];
-	}// end search
-	return NULL;
+#if defined(__WIN32)
+	int len = wideCharStringToUtf8(m_fdData.name, -1, NULL);
+	char filePath[len];
+
+	wideCharStringToUtf8(m_fdData.name, -1, filePath);
+#else
+	char *filePath = m_fdData.name;
+#endif
+
+	std::string sBuffer;
+
+	for (int i = strlen(filePath) - 1; i >= 0; i--)
+	{
+		if (filePath[i] == '.')
+			sBuffer = &filePath[i + 1];
+	}
+
+	return sBuffer;
 }// end GetExtension
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/DirectorySearch.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/DirectorySearch.h	2010-09-26 19:39:57 UTC (rev 6669)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/DirectorySearch.h	2010-09-26 22:02:44 UTC (rev 6670)
@@ -24,7 +24,7 @@
 #include <string.h>
 #endif
 #include <cstring>
-#include "StdFile.h"
+#include "StdFile.h"
 
 // create a non file bit for unix
 #define _A_NONFILE	0x03
@@ -38,14 +38,14 @@
 #define _A_SUBDIR	0x10
 
 // we need to emulate the windows style directory searching
-struct _finddata_t {
+struct _wfinddata_t {
 	unsigned    attrib;
 	time_t      time_create;    /* -1 for FAT file systems */
 	time_t      time_access;    /* -1 for FAT file systems */
 	time_t      time_write;
 	int64_t     size;
 	char        name[260];
-	_finddata_t() : attrib(0), time_create(0), time_access(0), time_write(0), size(0) {name[0] = 0;}
+	_wfinddata_t() : attrib(0), time_create(0), time_access(0), time_write(0), size(0) {name[0] = 0;}
 };
 
 #endif
@@ -54,11 +54,11 @@
 class CDirectorySearch
 {
 public:
-	const char * GetExtension();
+	std::string GetExtension();
 	bool IsExtension(const char *pExtension);
 	inline bool NextFile()
 	{// begin NextFile
-		if(_findnext(m_hSearch,&m_fdData) == -1)
+		if(_wfindnext(m_hSearch,&m_fdData) == -1)
 			return false;
 		return true;
 	}// end NextFile
@@ -87,14 +87,7 @@
 		return (bool)(m_fdData.attrib & _A_NONFILE);
 	}// end IsNotFile
 	std::string GetFileDirectory();
-	inline char * GetFileName(char *pBuffer)
-	{// begin GetFileName
-		return strcpy(pBuffer,m_fdData.name);
-	}// end GetFileName
-	inline const char * GetFileName()
-	{// begin GetFileName
-		return (const char *)m_fdData.name;
-	}// end GetFileName
+	std::string GetFileName();
 	std::string GetFilePath();
 	bool Close();
 	CDirectorySearch();
@@ -103,13 +96,13 @@
 protected:
 	std::string GetFileDirectory(std::string sFilePath) const;
 	long m_hSearch;
-	_finddata_t m_fdData;
+	_wfinddata_t m_fdData;
 	std::string m_sDirectory;
 private:
 #if defined(__unix__) || defined(__APPLE__)
 	// prototypes
-	int _findfirst(const char *path,_finddata_t *pfdData);
-	int _findnext(unsigned long int hDir,_finddata_t *pfdData);
+	int _wfindfirst(const char *path,_wfinddata_t *pfdData);
+	int _wfindnext(unsigned long int hDir,_wfinddata_t *pfdData);
 	int _findclose(unsigned long int hDir);
 #endif
 };



From mean at mail.berlios.de  Mon Sep 27 19:34:50 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 27 Sep 2010 19:34:50 +0200
Subject: [Avidemux-svn-commit] r6671 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska
Message-ID: <20100927173450.45A7A481073@sheep.berlios.de>

Author: mean
Date: 2010-09-27 19:34:50 +0200 (Mon, 27 Sep 2010)
New Revision: 6671

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvTrackType.cpp
Log:
[Mkv/demux] Add EAC3 id

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvTrackType.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvTrackType.cpp	2010-09-26 22:02:44 UTC (rev 6670)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvTrackType.cpp	2010-09-27 17:34:50 UTC (rev 6671)
@@ -38,6 +38,7 @@
 {
   {"A_MPEG/L3",0,WAV_MP3,""},
   {"A_AC3",0,WAV_AC3,""}, 
+  {"A_EAC3",0,WAV_EAC3,""}, 
   {"A_AAC/MPEG2/LC",0,WAV_AAC,""},
   {"A_AAC/MPEG4/LC/SBR",0,WAV_AAC,""},
   {"A_AAC/MPEG4/LC",0,WAV_AAC,""},



From mean at mail.berlios.de  Mon Sep 27 19:34:51 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 27 Sep 2010 19:34:51 +0200
Subject: [Avidemux-svn-commit] r6672 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska
Message-ID: <20100927173451.770C3481073@sheep.berlios.de>

Author: mean
Date: 2010-09-27 19:34:51 +0200 (Mon, 27 Sep 2010)
New Revision: 6672

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp
Log:
[mkv/demux] Dump display width/height

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp	2010-09-27 17:34:50 UTC (rev 6671)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp	2010-09-27 17:34:51 UTC (rev 6672)
@@ -235,6 +235,10 @@
         //case MKV_AUDIO_OUT_FREQUENCY:entry->fq=(uint32_t)floor(father.readFloat(len));break;
         case  MKV_VIDEO_WIDTH: entry->w=father.readUnsignedInt(len);break;
         case  MKV_VIDEO_HEIGHT: entry->h=father.readUnsignedInt(len);break;
+
+        case  MKV_DISPLAY_HEIGHT: ADM_info("Display Height:%d\n",(int)father.readUnsignedInt(len));break;
+        case  MKV_DISPLAY_WIDTH: ADM_info("Display Width:%d\n",(int)father.readUnsignedInt(len));break;
+
         case  MKV_AUDIO_CHANNELS: entry->chan=father.readUnsignedInt(len);break;
         case  MKV_TRACK_TIMECODESCALE:
                                 {



From mean at mail.berlios.de  Mon Sep 27 19:34:52 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 27 Sep 2010 19:34:52 +0200
Subject: [Avidemux-svn-commit] r6673 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv
Message-ID: <20100927173452.B8802481073@sheep.berlios.de>

Author: mean
Date: 2010-09-27 19:34:52 +0200 (Mon, 27 Sep 2010)
New Revision: 6673

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/mkv_muxer.conf
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/mkv_muxer.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/mkv_muxer_desc.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkvConfig.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkvPlugin.cpp
Log:
[mkv/muxer] Add force display width option

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/mkv_muxer.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/mkv_muxer.conf	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/mkv_muxer.conf	2010-09-27 17:34:52 UTC (rev 6673)
@@ -0,0 +1,2 @@
+bool:forceDisplayWidth
+uint32_t:displayWidth

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/mkv_muxer.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/mkv_muxer.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/mkv_muxer.h	2010-09-27 17:34:52 UTC (rev 6673)
@@ -0,0 +1,9 @@
+// Automatically generated, do not edit!
+#ifndef ADM_mkv_muxer_CONF_H
+#define ADM_mkv_muxer_CONF_H
+typedef struct {
+   bool     forceDisplayWidth;
+   uint32_t displayWidth;
+}mkv_muxer;
+#endif //mkv_muxer
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/mkv_muxer_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/mkv_muxer_desc.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/mkv_muxer_desc.cpp	2010-09-27 17:34:52 UTC (rev 6673)
@@ -0,0 +1,6 @@
+// Automatically generated, do not edit!
+const ADM_paramList mkv_muxer_param[]={
+ {"forceDisplayWidth",offsetof( mkv_muxer,forceDisplayWidth),"bool",ADM_param_bool},
+ {"displayWidth",offsetof( mkv_muxer,displayWidth),"uint32_t",ADM_param_uint32_t},
+{NULL,0,NULL}
+};

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.cpp	2010-09-27 17:34:51 UTC (rev 6672)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.cpp	2010-09-27 17:34:52 UTC (rev 6673)
@@ -29,6 +29,11 @@
 #define aprintf printf
 #endif
 
+mkv_muxer mkvMuxerConfig=
+{
+    false,  // Force
+    1280    // Display width
+};
 
 
 /**
@@ -73,6 +78,18 @@
         rescaleFps(s->getAvgFps1000(),&(c->time_base));
         c->gop_size=15;
         
+        if(true==mkvMuxerConfig.forceDisplayWidth && mkvMuxerConfig.displayWidth)
+        {
+            //sar=display/code  
+            int num=1,den=1;
+            av_reduce(&num, &den, mkvMuxerConfig.displayWidth, s->getWidth(),65535);
+            c->sample_aspect_ratio.num=num;
+            c->sample_aspect_ratio.den=den;
+            video_st->sample_aspect_ratio.num=num;
+            video_st->sample_aspect_ratio.den=den;
+            ADM_info("Forcing display width of %d\n",(int)mkvMuxerConfig.displayWidth);
+        }
+
         if(initAudio(nbAudioTrack,a)==false)
         {
             printf("[Mkv] Failed to init audio\n");

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.h	2010-09-27 17:34:51 UTC (rev 6672)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.h	2010-09-27 17:34:52 UTC (rev 6673)
@@ -19,6 +19,8 @@
 
 #include "ADM_muxer.h"
 #include "ADM_coreMuxerFfmpeg.h"
+#include "mkv_muxer.h"
+extern mkv_muxer mkvMuxerConfig;
 
 class muxerMkv : public muxerFFmpeg
 {

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkvConfig.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkvConfig.cpp	2010-09-27 17:34:51 UTC (rev 6672)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkvConfig.cpp	2010-09-27 17:34:52 UTC (rev 6673)
@@ -18,10 +18,24 @@
 #include "muxerMkv.h"
 #define ADM_MINIMAL_UI_INTERFACE
 #include "DIA_factory.h"
-#include "fourcc.h"
+#include "fourcc.h" 
 bool mkvConfigure(void)
 {
-        return true;
+        uint32_t force=(uint32_t)mkvMuxerConfig.forceDisplayWidth;
+        uint32_t displayWidth=(uint32_t)mkvMuxerConfig.displayWidth;
+
+        diaElemToggle   alternate(&force,"Force display width");
+        diaElemUInteger dWidth(&displayWidth,"Display width",16,65535);
+
+        diaElem *tabs[]={&alternate,&dWidth};
+        if( diaFactoryRun(("MKV Muxer"),2,tabs))
+        {
+            mkvMuxerConfig.forceDisplayWidth=(bool)force;
+            mkvMuxerConfig.displayWidth=displayWidth;
+            return true;
+        }
+        return false;
+
 }
 
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkvPlugin.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkvPlugin.cpp	2010-09-27 17:34:51 UTC (rev 6672)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkvPlugin.cpp	2010-09-27 17:34:52 UTC (rev 6673)
@@ -17,7 +17,7 @@
 #include "ADM_default.h"
 #include "ADM_muxerInternal.h"
 #include "muxerMkv.h"
-
+#include "mkv_muxer_desc.cpp"
 #include "fourcc.h"
  bool mkvConfigure(void);
 
@@ -27,7 +27,7 @@
                     "Matroska muxer plugin (c) Mean 2009",
                     "Mkv Muxer", // DIsplay name
                     mkvConfigure,
-                    NULL,
-                    NULL
+                    mkv_muxer_param, //template
+                    &mkvMuxerConfig //config
                 );
 



From gruntster at mail.berlios.de  Mon Sep 27 23:46:39 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 27 Sep 2010 23:46:39 +0200
Subject: [Avidemux-svn-commit] r6674 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264:
	. qt4
Message-ID: <20100927214639.55C9E481073@sheep.berlios.de>

Author: gruntster
Date: 2010-09-27 23:46:39 +0200 (Mon, 27 Sep 2010)
New Revision: 6674

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
Log:
[x264] hrd & tff support

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2010-09-27 17:34:52 UTC (rev 6673)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2010-09-27 21:46:39 UTC (rev 6674)
@@ -465,6 +465,9 @@
 
 	printf("\n[x264] i_width = %d, i_height = %d\n", x264Param->i_width, x264Param->i_height);
 	printf("[x264] i_csp = %d\n", x264Param->i_csp);	
+#if X264_BUILD > 88
+	printf("[x264] i_nal_hrd = %d\n", x264Param->i_nal_hrd);
+#endif
 	printf("[x264] i_fps_num = %d, i_fps_den = %d\n", x264Param->i_fps_num, x264Param->i_fps_den);
 	printf("[x264] rc.i_rc_method = %d\n", x264Param->rc.i_rc_method);
 	printf("[x264] rc.i_bitrate = %d\n", x264Param->rc.i_bitrate);
@@ -481,6 +484,9 @@
 	printf("[x264] analyse.inter = %d\n", x264Param->analyse.inter);
 	printf("[x264] b_cabac = %d\n", x264Param->b_cabac);
 	printf("[x264] b_interlaced = %d\n", x264Param->b_interlaced);
+#if X264_BUILD > 88
+	printf("[x264] b_tff = %d\n", x264Param->b_tff);
+#endif
 	printf("[x264] b_deblocking_filter = %d\n", x264Param->b_deblocking_filter);
 	printf("[x264] i_deblocking_filter_alphac0 = %d\n", x264Param->i_deblocking_filter_alphac0);
 	printf("[x264] i_deblocking_filter_beta = %d\n", x264Param->i_deblocking_filter_beta);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-09-27 17:34:52 UTC (rev 6673)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-09-27 21:46:39 UTC (rev 6674)
@@ -87,6 +87,10 @@
 	connect(ui.loopFilterCheckBox, SIGNAL(toggled(bool)), this, SLOT(loopFilterCheckBox_toggled(bool)));
 	connect(ui.cabacCheckBox, SIGNAL(toggled(bool)), this, SLOT(cabacCheckBox_toggled(bool)));
 
+#if X264_BUILD < 89
+	ui.interlacedComboBox->removeItem(1);
+#endif
+
 	// Analysis tab
 	connect(ui.trellisCheckBox, SIGNAL(toggled(bool)), this, SLOT(trellisCheckBox_toggled(bool)));
 	connect(ui.matrixCustomEditButton, SIGNAL(pressed()), this, SLOT(matrixCustomEditButton_pressed()));
@@ -133,14 +137,19 @@
 		}
 	}
 
+#if X264_BUILD < 89
+	ui.hrdLabel->setVisible(false);
+	ui.hrdComboBox->setVisible(false);
+#endif
+
 	fillConfigurationComboBox();
 
 	if (!loadPresetSettings(encodeOptions, options))
 		loadSettings(encodeOptions, options);
 
-	// Expand to see all tabs but still allow the window to be resized smaller
-	 ui.tabWidget->setUsesScrollButtons(false);
-	 this->adjustSize();
+	// Expand to see all tabs but still allow the window to be resized smaller
+	 ui.tabWidget->setUsesScrollButtons(false);
+	 this->adjustSize();
 	 ui.tabWidget->setUsesScrollButtons(true);
 }
 
@@ -695,7 +704,15 @@
 
 	// Frame tab
 	ui.cabacCheckBox->setChecked(options->getCabac());
-	ui.interlacedCheckBox->setChecked(options->getInterlaced());
+
+	if (options->getInterlaced() > 0)
+	{
+		ui.interlacedCheckBox->setChecked(true);
+		ui.interlacedComboBox->setCurrentIndex(options->getInterlaced() - 1);
+	}
+	else
+		ui.interlacedCheckBox->setChecked(false);
+
 	ui.constrainedIntraCheckBox->setChecked(options->getConstrainedIntraPrediction());
 
 	ui.loopFilterCheckBox->setChecked(options->getLoopFilter());
@@ -805,6 +822,9 @@
 	ui.colourMatrixComboBox->setCurrentIndex(getValueIndexInArray(options->getColorMatrix(), colourMatrix, colourMatrixCount));
 	ui.chromaSampleSpinBox->setValue(options->getChromaSampleLocation());
 	ui.fullRangeSamplesCheckBox->setChecked(options->getFullRangeSamples());
+#if X264_BUILD > 88
+	ui.hrdComboBox->setCurrentIndex(options->getHrdParameter());
+#endif
 
 	disableGenericSlots = origDisableGenericSlots;
 }
@@ -909,8 +929,12 @@
 
 	// Frame tab
 	options->setCabac(ui.cabacCheckBox->isChecked());
-	options->setInterlaced(ui.interlacedCheckBox->isChecked());
 
+	if (ui.interlacedCheckBox->isChecked())
+		options->setInterlaced(ui.interlacedComboBox->currentIndex() + 1);
+	else
+		options->setInterlaced(0);
+
 	options->setConstrainedIntraPrediction(ui.constrainedIntraCheckBox->isChecked());
 	options->setLoopFilter(ui.loopFilterCheckBox->isChecked());
 	options->setLoopFilterAlphaC0(ui.alphaC0SpinBox->value());
@@ -1002,6 +1026,9 @@
 	options->setColorMatrix(colourMatrix[ui.colourMatrixComboBox->currentIndex()]);
 	options->setChromaSampleLocation(ui.chromaSampleSpinBox->value());
 	options->setFullRangeSamples(ui.fullRangeSamplesCheckBox->isChecked());
+#if X264_BUILD > 88
+	options->setHrdParameter(ui.hrdComboBox->currentIndex());
+#endif
 }
 
 extern "C" int showX264ConfigDialog(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties, vidEncOptions *encodeOptions, x264Options *options)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-27 17:34:52 UTC (rev 6673)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-27 21:46:39 UTC (rev 6674)
@@ -1313,13 +1313,7 @@
          <property name="title">
           <string>Frame Encoding</string>
          </property>
-         <layout class="QVBoxLayout">
-          <property name="spacing">
-           <number>6</number>
-          </property>
-          <property name="margin">
-           <number>9</number>
-          </property>
+         <layout class="QVBoxLayout" name="verticalLayout_3">
           <item>
            <widget class="QCheckBox" name="cabacCheckBox">
             <property name="text">
@@ -1328,28 +1322,56 @@
            </widget>
           </item>
           <item>
-           <widget class="QCheckBox" name="interlacedCheckBox">
-            <property name="text">
-             <string>Pure Interlaced Mode</string>
-            </property>
-           </widget>
-          </item>
-          <item>
-           <layout class="QHBoxLayout">
-            <property name="spacing">
-             <number>6</number>
-            </property>
-            <property name="margin">
-             <number>0</number>
-            </property>
-            <item>
+           <layout class="QGridLayout" name="gridLayout_2">
+            <item row="0" column="0">
+             <widget class="QCheckBox" name="interlacedCheckBox">
+              <property name="text">
+               <string>Interlaced:</string>
+              </property>
+             </widget>
+            </item>
+            <item row="0" column="1">
+             <layout class="QHBoxLayout" name="horizontalLayout">
+              <item>
+               <widget class="QComboBox" name="interlacedComboBox">
+                <property name="enabled">
+                 <bool>false</bool>
+                </property>
+                <item>
+                 <property name="text">
+                  <string>Bottom Field First</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>Top Field First</string>
+                 </property>
+                </item>
+               </widget>
+              </item>
+              <item>
+               <spacer name="horizontalSpacer_2">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>40</width>
+                  <height>20</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
+             </layout>
+            </item>
+            <item row="1" column="0">
              <widget class="QCheckBox" name="loopFilterCheckBox">
               <property name="text">
-               <string>Loop Filter</string>
+               <string>Loop Filter:</string>
               </property>
              </widget>
             </item>
-            <item>
+            <item row="1" column="1">
              <layout class="QHBoxLayout">
               <property name="spacing">
                <number>6</number>
@@ -1358,7 +1380,30 @@
                <number>0</number>
               </property>
               <item>
-               <spacer name="spacer_22">
+               <widget class="QLabel" name="alphaC0Label">
+                <property name="enabled">
+                 <bool>false</bool>
+                </property>
+                <property name="text">
+                 <string>Strength:</string>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <widget class="QSpinBox" name="alphaC0SpinBox">
+                <property name="enabled">
+                 <bool>false</bool>
+                </property>
+                <property name="minimum">
+                 <number>-6</number>
+                </property>
+                <property name="maximum">
+                 <number>6</number>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <spacer name="spacer_23">
                 <property name="orientation">
                  <enum>Qt::Horizontal</enum>
                 </property>
@@ -1367,123 +1412,55 @@
                 </property>
                 <property name="sizeHint" stdset="0">
                  <size>
-                  <width>20</width>
+                  <width>10</width>
                   <height>0</height>
                  </size>
                 </property>
                </spacer>
               </item>
               <item>
-               <layout class="QHBoxLayout">
-                <property name="spacing">
+               <widget class="QLabel" name="betaLabel">
+                <property name="enabled">
+                 <bool>false</bool>
+                </property>
+                <property name="text">
+                 <string>Threshold:</string>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <widget class="QSpinBox" name="betaSpinBox">
+                <property name="enabled">
+                 <bool>false</bool>
+                </property>
+                <property name="minimum">
+                 <number>-6</number>
+                </property>
+                <property name="maximum">
                  <number>6</number>
                 </property>
-                <property name="margin">
-                 <number>0</number>
+               </widget>
+              </item>
+              <item>
+               <spacer name="spacer_21">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
                 </property>
-                <item>
-                 <widget class="QLabel" name="alphaC0Label">
-                  <property name="enabled">
-                   <bool>false</bool>
-                  </property>
-                  <property name="text">
-                   <string>Strength:</string>
-                  </property>
-                 </widget>
-                </item>
-                <item>
-                 <widget class="QSpinBox" name="alphaC0SpinBox">
-                  <property name="enabled">
-                   <bool>false</bool>
-                  </property>
-                  <property name="minimum">
-                   <number>-6</number>
-                  </property>
-                  <property name="maximum">
-                   <number>6</number>
-                  </property>
-                 </widget>
-                </item>
-                <item>
-                 <spacer name="spacer_23">
-                  <property name="orientation">
-                   <enum>Qt::Horizontal</enum>
-                  </property>
-                  <property name="sizeType">
-                   <enum>QSizePolicy::Fixed</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                   <size>
-                    <width>10</width>
-                    <height>0</height>
-                   </size>
-                  </property>
-                 </spacer>
-                </item>
-                <item>
-                 <widget class="QLabel" name="betaLabel">
-                  <property name="enabled">
-                   <bool>false</bool>
-                  </property>
-                  <property name="text">
-                   <string>Threshold:</string>
-                  </property>
-                 </widget>
-                </item>
-                <item>
-                 <widget class="QSpinBox" name="betaSpinBox">
-                  <property name="enabled">
-                   <bool>false</bool>
-                  </property>
-                  <property name="minimum">
-                   <number>-6</number>
-                  </property>
-                  <property name="maximum">
-                   <number>6</number>
-                  </property>
-                 </widget>
-                </item>
-                <item>
-                 <spacer name="spacer_21">
-                  <property name="orientation">
-                   <enum>Qt::Horizontal</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                   <size>
-                    <width>0</width>
-                    <height>0</height>
-                   </size>
-                  </property>
-                 </spacer>
-                </item>
-               </layout>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>0</width>
+                  <height>0</height>
+                 </size>
+                </property>
+               </spacer>
               </item>
              </layout>
             </item>
            </layout>
           </item>
           <item>
-           <spacer>
-            <property name="orientation">
-             <enum>Qt::Vertical</enum>
-            </property>
-            <property name="sizeType">
-             <enum>QSizePolicy::Fixed</enum>
-            </property>
-            <property name="sizeHint" stdset="0">
-             <size>
-              <width>20</width>
-              <height>2</height>
-             </size>
-            </property>
-           </spacer>
-          </item>
-          <item>
-           <layout class="QHBoxLayout">
-            <property name="spacing">
-             <number>6</number>
-            </property>
-            <property name="margin">
+           <layout class="QHBoxLayout" name="_3">
+            <property name="leftMargin">
              <number>0</number>
             </property>
             <item>
@@ -3736,13 +3713,7 @@
          <property name="title">
           <string>Video Usability Information</string>
          </property>
-         <layout class="QVBoxLayout" name="_2">
-          <property name="spacing">
-           <number>6</number>
-          </property>
-          <property name="margin">
-           <number>9</number>
-          </property>
+         <layout class="QVBoxLayout" name="verticalLayout_2">
           <item>
            <widget class="QLabel" name="label_52">
             <property name="text">
@@ -3770,407 +3741,434 @@
            </spacer>
           </item>
           <item>
-           <layout class="QVBoxLayout" name="_3">
-            <property name="spacing">
-             <number>6</number>
-            </property>
-            <property name="margin">
-             <number>0</number>
-            </property>
-            <item>
-             <layout class="QGridLayout" name="_4">
-              <property name="margin">
-               <number>0</number>
+           <layout class="QGridLayout" name="gridLayout">
+            <item row="0" column="0">
+             <widget class="QLabel" name="label_51">
+              <property name="text">
+               <string>Overscan:</string>
               </property>
+             </widget>
+            </item>
+            <item row="0" column="1">
+             <layout class="QHBoxLayout" name="_6">
               <property name="spacing">
                <number>6</number>
               </property>
-              <item row="3" column="1">
-               <layout class="QHBoxLayout" name="_5">
-                <property name="spacing">
-                 <number>6</number>
-                </property>
-                <property name="margin">
-                 <number>0</number>
-                </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
+              <item>
+               <widget class="QComboBox" name="overscanComboBox">
                 <item>
-                 <widget class="QComboBox" name="transferCharacteristicsComboBox">
-                  <item>
-                   <property name="text">
-                    <string>Undefined</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>BT709</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>BT470M</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>BT470BG</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>Linear</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>LOG100</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>LOG316</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>SMPTEL170M</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>SMPTE240M</string>
-                   </property>
-                  </item>
-                 </widget>
+                 <property name="text">
+                  <string>Undefined</string>
+                 </property>
                 </item>
                 <item>
-                 <spacer name="spacer_67">
-                  <property name="orientation">
-                   <enum>Qt::Horizontal</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                   <size>
-                    <width>0</width>
-                    <height>0</height>
-                   </size>
-                  </property>
-                 </spacer>
+                 <property name="text">
+                  <string>Show</string>
+                 </property>
                 </item>
-               </layout>
+                <item>
+                 <property name="text">
+                  <string>Crop</string>
+                 </property>
+                </item>
+               </widget>
               </item>
-              <item row="2" column="0">
-               <widget class="QLabel" name="label_19">
-                <property name="text">
-                 <string>Colour Primaries:</string>
+              <item>
+               <spacer name="spacer_70">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
                 </property>
-               </widget>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>0</width>
+                  <height>0</height>
+                 </size>
+                </property>
+               </spacer>
               </item>
-              <item row="0" column="1">
-               <layout class="QHBoxLayout" name="_6">
-                <property name="spacing">
-                 <number>6</number>
-                </property>
-                <property name="margin">
+             </layout>
+            </item>
+            <item row="1" column="0">
+             <widget class="QLabel" name="label_50">
+              <property name="text">
+               <string>Video Format:</string>
+              </property>
+             </widget>
+            </item>
+            <item row="1" column="1">
+             <layout class="QHBoxLayout" name="_8">
+              <property name="spacing">
+               <number>6</number>
+              </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
+              <item>
+               <widget class="QComboBox" name="videoFormatComboBox">
+                <property name="currentIndex">
                  <number>0</number>
                 </property>
                 <item>
-                 <widget class="QComboBox" name="overscanComboBox">
-                  <item>
-                   <property name="text">
-                    <string>Undefined</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>Show</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>Crop</string>
-                   </property>
-                  </item>
-                 </widget>
+                 <property name="text">
+                  <string>Undefined</string>
+                 </property>
                 </item>
                 <item>
-                 <spacer name="spacer_70">
-                  <property name="orientation">
-                   <enum>Qt::Horizontal</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                   <size>
-                    <width>0</width>
-                    <height>0</height>
-                   </size>
-                  </property>
-                 </spacer>
+                 <property name="text">
+                  <string>Component</string>
+                 </property>
                 </item>
-               </layout>
+                <item>
+                 <property name="text">
+                  <string>PAL</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>NTSC</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>SECAM</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>MAC</string>
+                 </property>
+                </item>
+               </widget>
               </item>
-              <item row="4" column="1">
-               <layout class="QHBoxLayout" name="_7">
-                <property name="spacing">
-                 <number>6</number>
+              <item>
+               <spacer name="spacer_68">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="margin">
-                 <number>0</number>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>0</width>
+                  <height>0</height>
+                 </size>
                 </property>
+               </spacer>
+              </item>
+             </layout>
+            </item>
+            <item row="2" column="0">
+             <widget class="QLabel" name="label_19">
+              <property name="text">
+               <string>Colour Primaries:</string>
+              </property>
+             </widget>
+            </item>
+            <item row="2" column="1">
+             <layout class="QHBoxLayout" name="_9">
+              <property name="spacing">
+               <number>6</number>
+              </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
+              <item>
+               <widget class="QComboBox" name="colourPrimariesComboBox">
                 <item>
-                 <widget class="QComboBox" name="colourMatrixComboBox">
-                  <item>
-                   <property name="text">
-                    <string>Undefined</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>BT709</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>FCC</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>BT470BG</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>SMPTE170M</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>SMPTE240M</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>GBR</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>YCgCo</string>
-                   </property>
-                  </item>
-                 </widget>
+                 <property name="text">
+                  <string>Undefined</string>
+                 </property>
                 </item>
                 <item>
-                 <spacer name="spacer_71">
-                  <property name="orientation">
-                   <enum>Qt::Horizontal</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                   <size>
-                    <width>0</width>
-                    <height>0</height>
-                   </size>
-                  </property>
-                 </spacer>
+                 <property name="text">
+                  <string>BT709</string>
+                 </property>
                 </item>
-               </layout>
-              </item>
-              <item row="4" column="0">
-               <widget class="QLabel" name="label_47">
-                <property name="text">
-                 <string>Colour Matrix:</string>
-                </property>
+                <item>
+                 <property name="text">
+                  <string>BT470M</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>BT470BG</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>SMPTE170M</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>SMPTE240M</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>Film</string>
+                 </property>
+                </item>
                </widget>
               </item>
-              <item row="1" column="1">
-               <layout class="QHBoxLayout" name="_8">
-                <property name="spacing">
-                 <number>6</number>
+              <item>
+               <spacer name="spacer_69">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="margin">
-                 <number>0</number>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>0</width>
+                  <height>0</height>
+                 </size>
                 </property>
+               </spacer>
+              </item>
+             </layout>
+            </item>
+            <item row="3" column="0">
+             <widget class="QLabel" name="label_48">
+              <property name="text">
+               <string>Transfer Characteristics:</string>
+              </property>
+             </widget>
+            </item>
+            <item row="3" column="1">
+             <layout class="QHBoxLayout" name="_5">
+              <property name="spacing">
+               <number>6</number>
+              </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
+              <item>
+               <widget class="QComboBox" name="transferCharacteristicsComboBox">
                 <item>
-                 <widget class="QComboBox" name="videoFormatComboBox">
-                  <property name="currentIndex">
-                   <number>0</number>
-                  </property>
-                  <item>
-                   <property name="text">
-                    <string>Undefined</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>Component</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>PAL</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>NTSC</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>SECAM</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>MAC</string>
-                   </property>
-                  </item>
-                 </widget>
+                 <property name="text">
+                  <string>Undefined</string>
+                 </property>
                 </item>
                 <item>
-                 <spacer name="spacer_68">
-                  <property name="orientation">
-                   <enum>Qt::Horizontal</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                   <size>
-                    <width>0</width>
-                    <height>0</height>
-                   </size>
-                  </property>
-                 </spacer>
+                 <property name="text">
+                  <string>BT709</string>
+                 </property>
                 </item>
-               </layout>
+                <item>
+                 <property name="text">
+                  <string>BT470M</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>BT470BG</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>Linear</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>LOG100</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>LOG316</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>SMPTEL170M</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>SMPTE240M</string>
+                 </property>
+                </item>
+               </widget>
               </item>
-              <item row="2" column="1">
-               <layout class="QHBoxLayout" name="_9">
-                <property name="spacing">
-                 <number>6</number>
+              <item>
+               <spacer name="spacer_67">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="margin">
-                 <number>0</number>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>0</width>
+                  <height>0</height>
+                 </size>
                 </property>
+               </spacer>
+              </item>
+             </layout>
+            </item>
+            <item row="4" column="0">
+             <widget class="QLabel" name="label_47">
+              <property name="text">
+               <string>Colour Matrix:</string>
+              </property>
+             </widget>
+            </item>
+            <item row="4" column="1">
+             <layout class="QHBoxLayout" name="_7">
+              <property name="spacing">
+               <number>6</number>
+              </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
+              <item>
+               <widget class="QComboBox" name="colourMatrixComboBox">
                 <item>
-                 <widget class="QComboBox" name="colourPrimariesComboBox">
-                  <item>
-                   <property name="text">
-                    <string>Undefined</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>BT709</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>BT470M</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>BT470BG</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>SMPTE170M</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>SMPTE240M</string>
-                   </property>
-                  </item>
-                  <item>
-                   <property name="text">
-                    <string>Film</string>
-                   </property>
-                  </item>
-                 </widget>
+                 <property name="text">
+                  <string>Undefined</string>
+                 </property>
                 </item>
                 <item>
-                 <spacer name="spacer_69">
-                  <property name="orientation">
-                   <enum>Qt::Horizontal</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                   <size>
-                    <width>0</width>
-                    <height>0</height>
-                   </size>
-                  </property>
-                 </spacer>
+                 <property name="text">
+                  <string>BT709</string>
+                 </property>
                 </item>
-               </layout>
-              </item>
-              <item row="3" column="0">
-               <widget class="QLabel" name="label_48">
-                <property name="text">
-                 <string>Transfer Characteristics:</string>
-                </property>
+                <item>
+                 <property name="text">
+                  <string>FCC</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>BT470BG</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>SMPTE170M</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>SMPTE240M</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>GBR</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>YCgCo</string>
+                 </property>
+                </item>
                </widget>
               </item>
-              <item row="5" column="0">
-               <widget class="QLabel" name="label_49">
-                <property name="text">
-                 <string>Chroma Sample Location:</string>
+              <item>
+               <spacer name="spacer_71">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
                 </property>
-               </widget>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>0</width>
+                  <height>0</height>
+                 </size>
+                </property>
+               </spacer>
               </item>
-              <item row="5" column="1">
-               <layout class="QHBoxLayout" name="_10">
-                <property name="spacing">
-                 <number>6</number>
-                </property>
-                <property name="margin">
-                 <number>0</number>
-                </property>
+             </layout>
+            </item>
+            <item row="5" column="0">
+             <widget class="QLabel" name="hrdLabel">
+              <property name="text">
+               <string>HRD Parameters:</string>
+              </property>
+             </widget>
+            </item>
+            <item row="5" column="1">
+             <layout class="QHBoxLayout" name="horizontalLayout_3">
+              <item>
+               <widget class="QComboBox" name="hrdComboBox">
                 <item>
-                 <widget class="QSpinBox" name="chromaSampleSpinBox">
-                  <property name="maximum">
-                   <number>4</number>
-                  </property>
-                 </widget>
+                 <property name="text">
+                  <string>None</string>
+                 </property>
                 </item>
                 <item>
-                 <spacer name="spacer_66">
-                  <property name="orientation">
-                   <enum>Qt::Horizontal</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                   <size>
-                    <width>0</width>
-                    <height>0</height>
-                   </size>
-                  </property>
-                 </spacer>
+                 <property name="text">
+                  <string>VBR</string>
+                 </property>
                 </item>
-               </layout>
-              </item>
-              <item row="1" column="0">
-               <widget class="QLabel" name="label_50">
-                <property name="text">
-                 <string>Video Format:</string>
-                </property>
+                <item>
+                 <property name="text">
+                  <string>CBR</string>
+                 </property>
+                </item>
                </widget>
               </item>
-              <item row="0" column="0">
-               <widget class="QLabel" name="label_51">
-                <property name="text">
-                 <string>Overscan:</string>
+              <item>
+               <spacer name="horizontalSpacer">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
                 </property>
-               </widget>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>40</width>
+                  <height>20</height>
+                 </size>
+                </property>
+               </spacer>
               </item>
              </layout>
             </item>
-            <item>
-             <widget class="QCheckBox" name="fullRangeSamplesCheckBox">
+            <item row="6" column="0">
+             <widget class="QLabel" name="label_49">
               <property name="text">
-               <string>Full Range Samples</string>
+               <string>Chroma Sample Location:</string>
               </property>
              </widget>
             </item>
+            <item row="6" column="1">
+             <layout class="QHBoxLayout" name="_10">
+              <property name="spacing">
+               <number>6</number>
+              </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
+              <item>
+               <widget class="QSpinBox" name="chromaSampleSpinBox">
+                <property name="maximum">
+                 <number>4</number>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <spacer name="spacer_66">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>0</width>
+                  <height>0</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
+             </layout>
+            </item>
            </layout>
           </item>
+          <item>
+           <widget class="QCheckBox" name="fullRangeSamplesCheckBox">
+            <property name="text">
+             <string>Full Range Samples</string>
+            </property>
+           </widget>
+          </item>
          </layout>
         </widget>
        </item>
@@ -4253,6 +4251,7 @@
   <tabstop>i4x4CheckBox</tabstop>
   <tabstop>cabacCheckBox</tabstop>
   <tabstop>interlacedCheckBox</tabstop>
+  <tabstop>interlacedComboBox</tabstop>
   <tabstop>loopFilterCheckBox</tabstop>
   <tabstop>alphaC0SpinBox</tabstop>
   <tabstop>betaSpinBox</tabstop>
@@ -4310,6 +4309,14 @@
   <tabstop>sarPredefinedRadioButton</tabstop>
   <tabstop>sarPredefinedComboBox</tabstop>
   <tabstop>sarAsInputRadioButton</tabstop>
+  <tabstop>overscanComboBox</tabstop>
+  <tabstop>videoFormatComboBox</tabstop>
+  <tabstop>colourPrimariesComboBox</tabstop>
+  <tabstop>transferCharacteristicsComboBox</tabstop>
+  <tabstop>colourMatrixComboBox</tabstop>
+  <tabstop>hrdComboBox</tabstop>
+  <tabstop>chromaSampleSpinBox</tabstop>
+  <tabstop>fullRangeSamplesCheckBox</tabstop>
   <tabstop>buttonBox</tabstop>
  </tabstops>
  <resources/>
@@ -4321,12 +4328,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>108</x>
-     <y>290</y>
+     <x>97</x>
+     <y>278</y>
     </hint>
     <hint type="destinationlabel">
-     <x>243</x>
-     <y>290</y>
+     <x>299</x>
+     <y>279</y>
     </hint>
    </hints>
   </connection>
@@ -4337,12 +4344,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>108</x>
-     <y>262</y>
+     <x>97</x>
+     <y>250</y>
     </hint>
     <hint type="destinationlabel">
-     <x>209</x>
-     <y>262</y>
+     <x>227</x>
+     <y>251</y>
     </hint>
    </hints>
   </connection>
@@ -4353,12 +4360,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>108</x>
-     <y>262</y>
+     <x>97</x>
+     <y>250</y>
     </hint>
     <hint type="destinationlabel">
-     <x>272</x>
-     <y>262</y>
+     <x>288</x>
+     <y>251</y>
     </hint>
    </hints>
   </connection>
@@ -4369,12 +4376,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>108</x>
-     <y>262</y>
+     <x>97</x>
+     <y>250</y>
     </hint>
     <hint type="destinationlabel">
-     <x>240</x>
-     <y>262</y>
+     <x>237</x>
+     <y>251</y>
     </hint>
    </hints>
   </connection>
@@ -4417,12 +4424,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>245</x>
-     <y>476</y>
+     <x>109</x>
+     <y>156</y>
     </hint>
     <hint type="destinationlabel">
-     <x>245</x>
-     <y>524</y>
+     <x>109</x>
+     <y>204</y>
     </hint>
    </hints>
   </connection>
@@ -4433,12 +4440,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>245</x>
-     <y>452</y>
+     <x>109</x>
+     <y>132</y>
     </hint>
     <hint type="destinationlabel">
-     <x>245</x>
-     <y>548</y>
+     <x>109</x>
+     <y>228</y>
     </hint>
    </hints>
   </connection>
@@ -4449,12 +4456,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>245</x>
-     <y>185</y>
+     <x>84</x>
+     <y>169</y>
     </hint>
     <hint type="destinationlabel">
-     <x>87</x>
-     <y>212</y>
+     <x>117</x>
+     <y>168</y>
     </hint>
    </hints>
   </connection>
@@ -4465,12 +4472,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>245</x>
-     <y>185</y>
+     <x>84</x>
+     <y>169</y>
     </hint>
     <hint type="destinationlabel">
-     <x>137</x>
-     <y>212</y>
+     <x>169</x>
+     <y>168</y>
     </hint>
    </hints>
   </connection>
@@ -4481,12 +4488,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>245</x>
-     <y>185</y>
+     <x>84</x>
+     <y>169</y>
     </hint>
     <hint type="destinationlabel">
-     <x>194</x>
-     <y>212</y>
+     <x>235</x>
+     <y>168</y>
     </hint>
    </hints>
   </connection>
@@ -4497,12 +4504,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>245</x>
-     <y>185</y>
+     <x>84</x>
+     <y>169</y>
     </hint>
     <hint type="destinationlabel">
-     <x>235</x>
-     <y>212</y>
+     <x>331</x>
+     <y>168</y>
     </hint>
    </hints>
   </connection>
@@ -4529,12 +4536,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>88</x>
-     <y>458</y>
+     <x>32</x>
+     <y>473</y>
     </hint>
     <hint type="destinationlabel">
-     <x>413</x>
-     <y>459</y>
+     <x>208</x>
+     <y>470</y>
     </hint>
    </hints>
   </connection>
@@ -4545,12 +4552,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>108</x>
-     <y>318</y>
+     <x>97</x>
+     <y>304</y>
     </hint>
     <hint type="destinationlabel">
-     <x>184</x>
-     <y>317</y>
+     <x>187</x>
+     <y>303</y>
     </hint>
    </hints>
   </connection>
@@ -4561,12 +4568,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>71</x>
-     <y>479</y>
+     <x>32</x>
+     <y>418</y>
     </hint>
     <hint type="destinationlabel">
-     <x>131</x>
-     <y>479</y>
+     <x>117</x>
+     <y>419</y>
     </hint>
    </hints>
   </connection>
@@ -4609,8 +4616,8 @@
    <slot>accept()</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>262</x>
-     <y>535</y>
+     <x>272</x>
+     <y>587</y>
     </hint>
     <hint type="destinationlabel">
      <x>262</x>
@@ -4625,8 +4632,8 @@
    <slot>reject()</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>262</x>
-     <y>535</y>
+     <x>272</x>
+     <y>587</y>
     </hint>
     <hint type="destinationlabel">
      <x>262</x>
@@ -4641,12 +4648,12 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>142</x>
-     <y>470</y>
+     <x>56</x>
+     <y>495</y>
     </hint>
     <hint type="destinationlabel">
-     <x>273</x>
-     <y>470</y>
+     <x>280</x>
+     <y>496</y>
     </hint>
    </hints>
   </connection>
@@ -4657,14 +4664,30 @@
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>142</x>
-     <y>470</y>
+     <x>56</x>
+     <y>495</y>
     </hint>
     <hint type="destinationlabel">
-     <x>318</x>
-     <y>470</y>
+     <x>319</x>
+     <y>496</y>
     </hint>
    </hints>
   </connection>
+  <connection>
+   <sender>interlacedCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>interlacedComboBox</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel">
+     <x>70</x>
+     <y>149</y>
+    </hint>
+    <hint type="destinationlabel">
+     <x>151</x>
+     <y>149</y>
+    </hint>
+   </hints>
+  </connection>
  </connections>
 </ui>

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-09-27 17:34:52 UTC (rev 6673)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-09-27 21:46:39 UTC (rev 6674)
@@ -407,14 +407,30 @@
 	_param.b_cabac = cabac;
 }
 
-bool x264Options::getInterlaced(void)
+unsigned int x264Options::getInterlaced(void)
 {
+#if X264_BUILD > 88
+	if (_param.b_interlaced)
+	{
+		if (_param.b_tff)
+			return 2;
+		else
+			return 1;
+	}
+	else
+		return 0;
+#else
 	return _param.b_interlaced;
+#endif
 }
 
-void x264Options::setInterlaced(bool interlaced)
+void x264Options::setInterlaced(unsigned int interlaced)
 {
-	_param.b_interlaced = interlaced;
+	_param.b_interlaced = !!interlaced;
+
+#if X264_BUILD > 88
+	_param.b_tff = (interlaced == 2 ? 1 : 0);
+#endif
 }
 
 bool x264Options::getConstrainedIntraPrediction(void)
@@ -1028,6 +1044,19 @@
 	_param.i_slice_count = sliceCount;
 }
 
+#if X264_BUILD > 88
+unsigned int x264Options::getHrdParameter(void)
+{
+	return _param.i_nal_hrd;
+}
+
+void x264Options::setHrdParameter(unsigned int hrdParameter)
+{
+	if (hrdParameter <= 2)
+		_param.i_nal_hrd = hrdParameter;
+}
+#endif
+
 void x264Options::addOptionsToXml(xmlNodePtr xmlNodeRoot)
 {
 	const int bufferSize = 100;
@@ -1206,7 +1235,21 @@
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"loopFilterAlphaC0", number2String(xmlBuffer, bufferSize, getLoopFilterAlphaC0()));
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"loopFilterBeta", number2String(xmlBuffer, bufferSize, getLoopFilterBeta()));
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"cabac", boolean2String(xmlBuffer, bufferSize, getCabac()));
-	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"interlaced", boolean2String(xmlBuffer, bufferSize, getInterlaced()));
+
+	switch (getInterlaced())
+	{
+		case 1:
+			strcpy((char*)xmlBuffer, "bff");
+			break;
+		case 2:
+			strcpy((char*)xmlBuffer, "tff");
+			break;
+		default:
+			strcpy((char*)xmlBuffer, "disabled");
+			break;
+	}
+
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"interlaced", xmlBuffer);
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"constrainedIntraPrediction", boolean2String(xmlBuffer, bufferSize, getConstrainedIntraPrediction()));
 
 	switch (getCqmPreset())
@@ -1412,6 +1455,23 @@
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"sliceMaxSize", number2String(xmlBuffer, bufferSize, getSliceMaxSize()));
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"sliceMaxMacroblocks", number2String(xmlBuffer, bufferSize, getSliceMaxMacroblocks()));
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"sliceCount", number2String(xmlBuffer, bufferSize, getSliceCount()));
+
+#if X264_BUILD > 88
+	switch (getHrdParameter())
+	{
+		case X264_NAL_HRD_VBR:
+			strcpy((char*)xmlBuffer, "vbr");
+			break;
+		case X264_NAL_HRD_CBR:
+			strcpy((char*)xmlBuffer, "cbr");
+			break;
+		default:
+			strcpy((char*)xmlBuffer, "none");
+			break;
+	}
+
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"hrd", xmlBuffer);
+#endif
 }
 
 int x264Options::fromXml(const char *xml, PluginXmlType xmlType)
@@ -1481,7 +1541,16 @@
 			else if (strcmp((char*)xmlChild->name, "cabac") == 0)
 				setCabac(string2Boolean(content));
 			else if (strcmp((char*)xmlChild->name, "interlaced") == 0)
-				setInterlaced(string2Boolean(content));
+			{
+				int interlaced = 0;
+
+				if (strcmp(content, "bff") == 0)
+					interlaced = 1;
+				else if (strcmp(content, "tff") == 0)
+					interlaced = 2;
+
+				setInterlaced(interlaced);
+			}
 			else if (strcmp((char*)xmlChild->name, "constrainedIntraPrediction") == 0)
 				setConstrainedIntraPrediction(string2Boolean(content));
 			else if (strcmp((char*)xmlChild->name, "cqmPreset") == 0)
@@ -1553,7 +1622,22 @@
 				setSliceMaxMacroblocks(atoi(content));
 			else if (strcmp((char*)xmlChild->name, "sliceCount") == 0)
 				setSliceCount(atoi(content));
+#if X264_BUILD > 88
+			else if (strcmp((char*)xmlChild->name, "hdr") == 0)
+			{
+				unsigned int hdr = 0;
 
+				if (strcmp(content, "none") == 0)
+					hdr = X264_NAL_HRD_NONE;
+				else if (strcmp(content, "vbr") == 0)
+					hdr = X264_NAL_HRD_VBR;
+				else if (strcmp(content, "cbr") == 0)
+					hdr = X264_NAL_HRD_CBR;
+
+				setHrdParameter(hdr);
+			}
+#endif
+
 			xmlFree(content);
 		}
 	}

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.h	2010-09-27 17:34:52 UTC (rev 6673)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.h	2010-09-27 21:46:39 UTC (rev 6674)
@@ -150,8 +150,8 @@
 	bool getCabac(void);
 	void setCabac(bool cabac);
 
-	bool getInterlaced(void);
-	void setInterlaced(bool interlaced);
+	unsigned int getInterlaced(void);
+	void setInterlaced(unsigned int interlaced);
 
 	bool getConstrainedIntraPrediction(void);
 	void setConstrainedIntraPrediction(bool constrainedIntra);
@@ -323,6 +323,11 @@
 	unsigned int getSliceCount(void);
 	void setSliceCount(unsigned int sliceCount);
 
+#if X264_BUILD > 88
+	unsigned int getHrdParameter(void);
+	void setHrdParameter(unsigned int hrdParameter);
+#endif
+
 	int fromXml(const char *xml, PluginXmlType xmlType);
 };
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2010-09-27 17:34:52 UTC (rev 6673)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2010-09-27 21:46:39 UTC (rev 6674)
@@ -247,7 +247,19 @@
                 </xs:simpleType>
               </xs:element>
               <xs:element name="cabac" type="xs:boolean" minOccurs="0"/>
-              <xs:element name="interlaced" type="xs:boolean" minOccurs="0"/>
+			  <xs:element name="interlaced" minOccurs="0">
+				  <xs:simpleType>
+					  <xs:restriction base="xs:string">
+						  <xs:enumeration value="disabled"/>
+						  <xs:enumeration value="bff"/>
+						  <xs:enumeration value="tff"/>
+
+						  <!-- boolean values deprecated core 89 -->
+						  <xs:enumeration value="false"/>
+						  <xs:enumeration value="true"/>
+					  </xs:restriction>
+				  </xs:simpleType>
+			  </xs:element>				
               <xs:element name="constrainedIntraPrediction" type="xs:boolean" minOccurs="0"/>
               <xs:element name="cqmPreset" minOccurs="0">
                 <xs:simpleType>
@@ -583,6 +595,15 @@
               <xs:element name="sliceMaxSize" type="uint" minOccurs="0"/>
               <xs:element name="sliceMaxMacroblocks" type="uint" minOccurs="0"/>
               <xs:element name="sliceCount" type="uint" minOccurs="0"/>
+			  <xs:element name="hrd" minOccurs="0">
+				  <xs:simpleType>
+					  <xs:restriction base="xs:string">
+						  <xs:enumeration value="none"/>
+						  <xs:enumeration value="vbr"/>
+						  <xs:enumeration value="cbr"/>
+					  </xs:restriction>
+				  </xs:simpleType>
+			  </xs:element>
             </xs:sequence>
           </xs:complexType>
         </xs:element>



From mean at mail.berlios.de  Tue Sep 28 07:16:16 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 28 Sep 2010 07:16:16 +0200
Subject: [Avidemux-svn-commit] r6675 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS
Message-ID: <20100928051616.CC386480EAB@sheep.berlios.de>

Author: mean
Date: 2010-09-28 07:16:16 +0200 (Tue, 28 Sep 2010)
New Revision: 6675

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTSConfig.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/ts_muxer.conf
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/ts_muxer.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/ts_muxer_desc.cpp
Log:
[TS/muxer] Add muxrate parameter to Ts muxer

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp	2010-09-27 21:46:39 UTC (rev 6674)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp	2010-09-28 05:16:16 UTC (rev 6675)
@@ -31,7 +31,8 @@
 
 ts_muxer tsMuxerConfig=
 {
-    false
+    false,
+    10
 };
 
 /**
@@ -104,7 +105,7 @@
         }
         
         // /audio
-        oc->mux_rate=30080*1000;
+        oc->mux_rate=tsMuxerConfig.muxRateInMBits*1000000LL;
         audio_st->codec->bit_rate=a[0]->getInfo()->byterate*8;        
        
         oc->preload=3000; // 30 ms preloading

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTSConfig.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTSConfig.cpp	2010-09-27 21:46:39 UTC (rev 6674)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTSConfig.cpp	2010-09-28 05:16:16 UTC (rev 6675)
@@ -19,9 +19,20 @@
 #define ADM_MINIMAL_UI_INTERFACE
 #include "DIA_factory.h"
 #include "fourcc.h"
+extern ts_muxer tsMuxerConfig;
 bool ffTSConfigure(void)
 {
+        uint32_t muxRate=(uint32_t)tsMuxerConfig.muxRateInMBits;
+
+        diaElemUInteger mux(&muxRate,"Mux rate (MBits/s)",3,60);
+
+        diaElem *tabs[]={&mux};
+        if( diaFactoryRun(("TS Muxer"),1,tabs))
+        {            
+            tsMuxerConfig.muxRateInMBits=muxRate;
             return true;
+        }
+        return false;
 }
 // EOF
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/ts_muxer.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/ts_muxer.conf	2010-09-27 21:46:39 UTC (rev 6674)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/ts_muxer.conf	2010-09-28 05:16:16 UTC (rev 6675)
@@ -1 +1,2 @@
 bool:acceptNonCompliant
+uint32_t:muxRateInMBits

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/ts_muxer.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/ts_muxer.h	2010-09-27 21:46:39 UTC (rev 6674)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/ts_muxer.h	2010-09-28 05:16:16 UTC (rev 6675)
@@ -3,6 +3,7 @@
 #define ADM_ts_muxer_CONF_H
 typedef struct {
    bool acceptNonCompliant;
+   uint32_t muxRateInMBits;
 }ts_muxer;
 #endif //ts_muxer
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/ts_muxer_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/ts_muxer_desc.cpp	2010-09-27 21:46:39 UTC (rev 6674)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/ts_muxer_desc.cpp	2010-09-28 05:16:16 UTC (rev 6675)
@@ -1,5 +1,6 @@
 // Automatically generated, do not edit!
 const ADM_paramList ts_muxer_param[]={
  {"acceptNonCompliant",offsetof( ts_muxer,acceptNonCompliant),"bool",ADM_param_bool},
+ {"muxRateInMBits",offsetof( ts_muxer,muxRateInMBits),"uint32_t",ADM_param_uint32_t},
 {NULL,0,NULL}
 };



From mean at mail.berlios.de  Tue Sep 28 07:31:17 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 28 Sep 2010 07:31:17 +0200
Subject: [Avidemux-svn-commit] r6676 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src
Message-ID: <20100928053117.A8F8D480F4C@sheep.berlios.de>

Author: mean
Date: 2010-09-28 07:31:17 +0200 (Tue, 28 Sep 2010)
New Revision: 6676

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
Log:
[H264/ExtractFrameType] Search deeper with there are several NALU in the buffer

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-28 05:16:16 UTC (rev 6675)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-28 05:31:17 UTC (rev 6676)
@@ -359,41 +359,45 @@
   uint32_t val, hnt;
 
 // FIXME :  no startcode only !
-
+  //ADM_info("Searching H264 frame type..\n");
   while (head + 4 < tail)
     {
 
-      uint32_t length =
-	(head[0] << 24) + (head[1] << 16) + (head[2] << 8) + (head[3]);
+      uint32_t length =(head[0] << 24) + (head[1] << 16) + (head[2] << 8) + (head[3]);
       //printf("Block size : %"LU", available : %"LU"\n",length,len);
-      if (length > len || length < 6)
-	{
-	  printf ("Warning , incomplete nal (%u/%u),(%0x/%0x)\n", length, len,
-		  length, len);
-	  *flags = 0;
-	  return 0;
-	}
+      if (length > len)// || length < 2)
+      {
+          ADM_warning ("Warning , incomplete nal (%u/%u),(%0x/%0x)\n", length, len, length, len);
+          *flags = 0;
+          return 0;
+        }
       head += 4;		// Skip nal lenth
       stream = *(head) & 0x1F;
       switch (stream)
-	{
-	case NAL_IDR:
-	  *flags = AVI_KEY_FRAME;
-
-	  return 1;
-	  break;
-	case NAL_NON_IDR:
-	  refineH264FrameType (head + 1, tail, flags);
-	  return 1;
-	  break;
-	default:
-	  printf ("??0x%x\n", stream);
-	case NAL_SEI:
-	  head += length;
-	  continue;
-	}
+        {
+            case NAL_SPS:
+            case NAL_PPS: 
+            case NAL_SEI:
+            case NAL_AU_DELIMITER:
+            case NAL_FILLER:
+                    break;
+            case NAL_IDR:
+              *flags = AVI_KEY_FRAME;
+              //ADM_info("Found IDR \n");
+              return 1;
+              break;
+            case NAL_NON_IDR:
+              refineH264FrameType (head + 1, tail, flags);
+              //ADM_info("Found Non IDR :%x\n",*flags);
+              return 1;
+              break;
+            default:
+              ADM_warning ("unknown nal ??0x%x\n", stream);
+              break;
+         }
+        head+=length;
     }
-  printf ("No stream\n");
+  ADM_warning ("No stream\n");
   return 0;
 }
 



From gruntster at mail.berlios.de  Tue Sep 28 22:43:51 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 28 Sep 2010 22:43:51 +0200
Subject: [Avidemux-svn-commit] r6677 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264:
	. qt4
Message-ID: <20100928204351.94B68480FD0@sheep.berlios.de>

Author: gruntster
Date: 2010-09-28 22:43:51 +0200 (Tue, 28 Sep 2010)
New Revision: 6677

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
Log:
[x264] max crf support

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2010-09-28 05:31:17 UTC (rev 6676)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2010-09-28 20:43:51 UTC (rev 6677)
@@ -472,6 +472,9 @@
 	printf("[x264] rc.i_rc_method = %d\n", x264Param->rc.i_rc_method);
 	printf("[x264] rc.i_bitrate = %d\n", x264Param->rc.i_bitrate);
 	printf("[x264] rc.f_rf_constant = %f\n", x264Param->rc.f_rf_constant);
+#if X264_BUILD > 89
+	printf("[x264] rc.f_rf_constant_max = %f\n", x264Param->rc.f_rf_constant_max);
+#endif
 	printf("[x264] rc.i_qp_constant = %d\n", x264Param->rc.i_qp_constant);	
 	printf("[x264] analyse.i_subpel_refine = %d\n", x264Param->analyse.i_subpel_refine);
 	printf("[x264] analyse.i_me_method = %d\n", x264Param->analyse.i_me_method);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-09-28 05:31:17 UTC (rev 6676)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-09-28 20:43:51 UTC (rev 6677)
@@ -69,8 +69,19 @@
 	connect(ui.quantiserSlider, SIGNAL(valueChanged(int)), this, SLOT(quantiserSlider_valueChanged(int)));
 	connect(ui.quantiserSpinBox, SIGNAL(valueChanged(int)), this, SLOT(quantiserSpinBox_valueChanged(int)));
 	connect(ui.targetRateControlSpinBox, SIGNAL(valueChanged(int)), this, SLOT(targetRateControlSpinBox_valueChanged(int)));
+	connect(ui.maxCrfSlider, SIGNAL(valueChanged(int)), this, SLOT(maxCrfSlider_valueChanged(int)));
+	connect(ui.maxCrfSpinBox, SIGNAL(valueChanged(int)), this, SLOT(maxCrfSpinBox_valueChanged(int)));
 	connect(ui.mbTreeCheckBox, SIGNAL(toggled(bool)), this, SLOT(mbTreeCheckBox_toggled(bool)));
 
+#if X264_BUILD < 90
+	ui.maxCrfCheckBox->setVisible(false);
+	ui.quantiserLabel1_2->setVisible(false);
+	ui.quantiserLabel2_2->setVisible(false);
+	ui.quantiserLabel3_2->setVisible(false);
+	ui.maxCrfSlider->setVisible(false);
+	ui.maxCrfSpinBox->setVisible(false);
+#endif
+
 #if X264_BUILD < 86
 	ui.fastFirstPassCheckBox->setVisible(false);
 #endif
@@ -353,7 +364,7 @@
 // General tab
 void x264ConfigDialog::encodingModeComboBox_currentIndexChanged(int index)
 {
-	bool enable = false;
+	bool enableQp = false, enableMaxCrf = false;
 
 	switch (index)
 	{
@@ -364,11 +375,12 @@
 			break;
 		case 1: // Constant Quality - 1 pass
 			ui.quantiserLabel2->setText(tr("Quantiser:"));
-			enable = true;
+			enableQp = true;
 			break;
 		case 2: // Average Quantiser - 1 pass
 			ui.quantiserLabel2->setText(tr("Quality:"));
-			enable = true;
+			enableQp = true;
+			enableMaxCrf = true;
 			break;
 		case 3: // Video Size - 2 pass
 			ui.targetRateControlLabel1->setText(tr("Target Video Size:"));
@@ -382,15 +394,20 @@
 			break;
 	}
 
-	ui.quantiserLabel1->setEnabled(enable);
-	ui.quantiserLabel2->setEnabled(enable);
-	ui.quantiserLabel3->setEnabled(enable);
-	ui.quantiserSlider->setEnabled(enable);
-	ui.quantiserSpinBox->setEnabled(enable);
+	ui.quantiserLabel1->setEnabled(enableQp);
+	ui.quantiserLabel2->setEnabled(enableQp);
+	ui.quantiserLabel3->setEnabled(enableQp);
+	ui.quantiserSlider->setEnabled(enableQp);
+	ui.quantiserSpinBox->setEnabled(enableQp);
 
-	ui.targetRateControlLabel1->setEnabled(!enable);
-	ui.targetRateControlLabel2->setEnabled(!enable);
-	ui.targetRateControlSpinBox->setEnabled(!enable);
+	ui.targetRateControlLabel1->setEnabled(!enableQp);
+	ui.targetRateControlLabel2->setEnabled(!enableQp);
+	ui.targetRateControlSpinBox->setEnabled(!enableQp);
+
+	if (!enableMaxCrf)
+		ui.maxCrfCheckBox->setChecked(false);
+
+	ui.maxCrfCheckBox->setEnabled(enableMaxCrf);
 }
 
 void x264ConfigDialog::quantiserSlider_valueChanged(int value)
@@ -411,6 +428,16 @@
 		lastBitrate = value;
 }
 
+void x264ConfigDialog::maxCrfSlider_valueChanged(int value)
+{
+	ui.maxCrfSpinBox->setValue(value);
+}
+
+void x264ConfigDialog::maxCrfSpinBox_valueChanged(int value)
+{
+	ui.maxCrfSlider->setValue(value);
+}
+
 void x264ConfigDialog::mbTreeCheckBox_toggled(bool checked)
 {
 	if (!disableGenericSlots && checked && !ui.aqVarianceCheckBox->isChecked())
@@ -585,6 +612,9 @@
 void x264ConfigDialog::loadSettings(vidEncOptions *encodeOptions, x264Options *options)
 {
 	bool origDisableGenericSlots = disableGenericSlots;
+#if X264_BUILD > 89
+	unsigned int maxCrf = options->getMaximumConstantRateFactor();
+#endif
 
 	disableGenericSlots = true;
 
@@ -602,6 +632,17 @@
 		case ADM_VIDENC_MODE_AQP:	// Average Quantizer (Single Pass)
 			ui.encodingModeComboBox->setCurrentIndex(2);
 			ui.quantiserSpinBox->setValue(encodeOptions->encodeModeParameter);
+
+#if X264_BUILD > 89
+			if (maxCrf == 0)
+				ui.maxCrfCheckBox->setChecked(false);
+			else
+			{
+				ui.maxCrfCheckBox->setChecked(true);
+				ui.maxCrfSlider->setValue(maxCrf);
+			}
+#endif
+
 			break;
 		case ADM_VIDENC_MODE_2PASS_SIZE:	// Video Size (Two Pass)
 			ui.encodingModeComboBox->setCurrentIndex(3);
@@ -862,6 +903,13 @@
 
 	options->setPresetConfiguration(ui.configurationComboBox->currentText().toUtf8().constData(), configurationType);
 
+#if X264_BUILD > 89
+	if (ui.encodingModeComboBox->currentIndex() == 2 && ui.maxCrfCheckBox->isChecked())
+		options->setMaximumConstantRateFactor(ui.maxCrfSlider->value());
+	else
+		options->setMaximumConstantRateFactor(0);
+#endif
+
 	options->setMbTree(ui.mbTreeCheckBox->isChecked());
 #if X264_BUILD > 85
 	options->setFastFirstPass(ui.fastFirstPassCheckBox->isChecked());

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.h	2010-09-28 05:31:17 UTC (rev 6676)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.h	2010-09-28 20:43:51 UTC (rev 6677)
@@ -72,6 +72,8 @@
 	void quantiserSlider_valueChanged(int value);
 	void quantiserSpinBox_valueChanged(int value);
 	void targetRateControlSpinBox_valueChanged(int value);
+	void maxCrfSlider_valueChanged(int value);
+	void maxCrfSpinBox_valueChanged(int value);
 	void mbTreeCheckBox_toggled(bool checked);
 
 	// Motion Estimation tab

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-28 05:31:17 UTC (rev 6676)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-28 20:43:51 UTC (rev 6677)
@@ -7,8 +7,8 @@
    <rect>
     <x>0</x>
     <y>0</y>
-    <width>503</width>
-    <height>598</height>
+    <width>529</width>
+    <height>592</height>
    </rect>
   </property>
   <property name="windowTitle">
@@ -122,13 +122,7 @@
          <property name="title">
           <string>Rate Control</string>
          </property>
-         <layout class="QVBoxLayout">
-          <property name="spacing">
-           <number>6</number>
-          </property>
-          <property name="margin">
-           <number>9</number>
-          </property>
+         <layout class="QVBoxLayout" name="verticalLayout_5">
           <item>
            <layout class="QGridLayout">
             <property name="margin">
@@ -276,6 +270,22 @@
              <number>0</number>
             </property>
             <item>
+             <spacer name="horizontalSpacer_3">
+              <property name="orientation">
+               <enum>Qt::Horizontal</enum>
+              </property>
+              <property name="sizeType">
+               <enum>QSizePolicy::Fixed</enum>
+              </property>
+              <property name="sizeHint" stdset="0">
+               <size>
+                <width>20</width>
+                <height>0</height>
+               </size>
+              </property>
+             </spacer>
+            </item>
+            <item>
              <layout class="QHBoxLayout">
               <property name="spacing">
                <number>12</number>
@@ -418,21 +428,14 @@
            </layout>
           </item>
           <item>
-           <widget class="QCheckBox" name="fastFirstPassCheckBox">
+           <widget class="QCheckBox" name="maxCrfCheckBox">
             <property name="text">
-             <string>Fast First Pass</string>
+             <string>Maximum Constant Rate Factor</string>
             </property>
            </widget>
           </item>
           <item>
-           <widget class="QCheckBox" name="mbTreeCheckBox">
-            <property name="text">
-             <string>Macroblock-tree Rate Control</string>
-            </property>
-           </widget>
-          </item>
-          <item>
-           <layout class="QHBoxLayout">
+           <layout class="QHBoxLayout" name="_16">
             <property name="spacing">
              <number>6</number>
             </property>
@@ -440,137 +443,190 @@
              <number>0</number>
             </property>
             <item>
-             <widget class="QLabel" name="lblLookahead">
-              <property name="text">
-               <string>Frametype Lookahead:</string>
-              </property>
-             </widget>
-            </item>
-            <item>
-             <widget class="QSpinBox" name="lookaheadSpinBox">
-              <property name="maximum">
-               <number>250</number>
-              </property>
-             </widget>
-            </item>
-            <item>
-             <widget class="QLabel" name="lblLookaheadFrames">
-              <property name="text">
-               <string>frames</string>
-              </property>
-             </widget>
-            </item>
-            <item>
-             <spacer name="spacer_3">
+             <spacer name="horizontalSpacer_4">
               <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
+              <property name="sizeType">
+               <enum>QSizePolicy::Fixed</enum>
+              </property>
               <property name="sizeHint" stdset="0">
                <size>
-                <width>0</width>
+                <width>20</width>
                 <height>0</height>
                </size>
               </property>
              </spacer>
             </item>
-           </layout>
-          </item>
-         </layout>
-        </widget>
-       </item>
-       <item>
-        <widget class="QGroupBox" name="groupBox_17">
-         <property name="title">
-          <string>Multithreading</string>
-         </property>
-         <layout class="QVBoxLayout">
-          <property name="spacing">
-           <number>6</number>
-          </property>
-          <property name="margin">
-           <number>9</number>
-          </property>
-          <item>
-           <layout class="QVBoxLayout">
-            <property name="spacing">
-             <number>6</number>
-            </property>
-            <property name="margin">
-             <number>0</number>
-            </property>
             <item>
-             <widget class="QRadioButton" name="threadDisableRadioButton">
-              <property name="text">
-               <string>Disable</string>
-              </property>
-             </widget>
-            </item>
-            <item>
-             <widget class="QRadioButton" name="threadAutoDetectRadioButton">
-              <property name="text">
-               <string>Auto-detect</string>
-              </property>
-              <property name="checked">
-               <bool>true</bool>
-              </property>
-             </widget>
-            </item>
-            <item>
-             <layout class="QHBoxLayout">
+             <layout class="QHBoxLayout" name="_17">
               <property name="spacing">
-               <number>6</number>
+               <number>12</number>
               </property>
               <property name="margin">
                <number>0</number>
               </property>
               <item>
-               <widget class="QRadioButton" name="threadCustomRadioButton">
-                <property name="text">
-                 <string comment="multithreading">Custom:</string>
+               <layout class="QVBoxLayout" name="_18">
+                <property name="spacing">
+                 <number>0</number>
                 </property>
-               </widget>
+                <property name="margin">
+                 <number>0</number>
+                </property>
+                <item>
+                 <layout class="QHBoxLayout" name="_19">
+                  <property name="spacing">
+                   <number>0</number>
+                  </property>
+                  <property name="margin">
+                   <number>0</number>
+                  </property>
+                  <item>
+                   <widget class="QLabel" name="quantiserLabel1_2">
+                    <property name="enabled">
+                     <bool>false</bool>
+                    </property>
+                    <property name="text">
+                     <string>0 (High Quality)</string>
+                    </property>
+                   </widget>
+                  </item>
+                  <item>
+                   <spacer>
+                    <property name="orientation">
+                     <enum>Qt::Horizontal</enum>
+                    </property>
+                    <property name="sizeHint" stdset="0">
+                     <size>
+                      <width>40</width>
+                      <height>20</height>
+                     </size>
+                    </property>
+                   </spacer>
+                  </item>
+                  <item>
+                   <widget class="QLabel" name="quantiserLabel2_2">
+                    <property name="enabled">
+                     <bool>false</bool>
+                    </property>
+                    <property name="text">
+                     <string>Quantiser</string>
+                    </property>
+                   </widget>
+                  </item>
+                  <item>
+                   <spacer>
+                    <property name="orientation">
+                     <enum>Qt::Horizontal</enum>
+                    </property>
+                    <property name="sizeHint" stdset="0">
+                     <size>
+                      <width>40</width>
+                      <height>20</height>
+                     </size>
+                    </property>
+                   </spacer>
+                  </item>
+                  <item>
+                   <widget class="QLabel" name="quantiserLabel3_2">
+                    <property name="enabled">
+                     <bool>false</bool>
+                    </property>
+                    <property name="text">
+                     <string>51 (Low Quality)</string>
+                    </property>
+                   </widget>
+                  </item>
+                 </layout>
+                </item>
+                <item>
+                 <widget class="QSlider" name="maxCrfSlider">
+                  <property name="enabled">
+                   <bool>false</bool>
+                  </property>
+                  <property name="minimumSize">
+                   <size>
+                    <width>375</width>
+                    <height>0</height>
+                   </size>
+                  </property>
+                  <property name="maximum">
+                   <number>51</number>
+                  </property>
+                  <property name="pageStep">
+                   <number>5</number>
+                  </property>
+                  <property name="value">
+                   <number>26</number>
+                  </property>
+                  <property name="orientation">
+                   <enum>Qt::Horizontal</enum>
+                  </property>
+                  <property name="tickPosition">
+                   <enum>QSlider::TicksBelow</enum>
+                  </property>
+                 </widget>
+                </item>
+               </layout>
               </item>
               <item>
-               <widget class="QSpinBox" name="threadCustomSpinBox">
+               <widget class="QSpinBox" name="maxCrfSpinBox">
                 <property name="enabled">
                  <bool>false</bool>
                 </property>
-                <property name="minimum">
-                 <number>2</number>
-                </property>
                 <property name="maximum">
-                 <number>32</number>
+                 <number>51</number>
                 </property>
+                <property name="value">
+                 <number>26</number>
+                </property>
                </widget>
               </item>
-              <item>
-               <spacer name="spacer_2">
-                <property name="orientation">
-                 <enum>Qt::Horizontal</enum>
-                </property>
-                <property name="sizeHint" stdset="0">
-                 <size>
-                  <width>0</width>
-                  <height>0</height>
-                 </size>
-                </property>
-               </spacer>
-              </item>
              </layout>
             </item>
+            <item>
+             <spacer name="spacer_22">
+              <property name="orientation">
+               <enum>Qt::Horizontal</enum>
+              </property>
+              <property name="sizeHint" stdset="0">
+               <size>
+                <width>0</width>
+                <height>0</height>
+               </size>
+              </property>
+             </spacer>
+            </item>
            </layout>
           </item>
           <item>
-           <widget class="QCheckBox" name="repeatabilityCheckBox">
+           <spacer name="verticalSpacer_2">
+            <property name="orientation">
+             <enum>Qt::Vertical</enum>
+            </property>
+            <property name="sizeType">
+             <enum>QSizePolicy::Fixed</enum>
+            </property>
+            <property name="sizeHint" stdset="0">
+             <size>
+              <width>20</width>
+              <height>4</height>
+             </size>
+            </property>
+           </spacer>
+          </item>
+          <item>
+           <widget class="QCheckBox" name="fastFirstPassCheckBox">
             <property name="text">
-             <string>Enforce Repeatability</string>
+             <string>Fast First Pass</string>
             </property>
            </widget>
           </item>
           <item>
-           <widget class="QCheckBox" name="sliceThreadingCheckBox">
+           <widget class="QCheckBox" name="mbTreeCheckBox">
             <property name="text">
-             <string>Slice-based Threading</string>
+             <string>Macroblock-tree Rate Control</string>
             </property>
            </widget>
           </item>
@@ -583,34 +639,28 @@
              <number>0</number>
             </property>
             <item>
-             <widget class="QCheckBox" name="threadedLookaheadCheckBox">
+             <widget class="QLabel" name="lblLookahead">
               <property name="text">
-               <string>Custom Threaded Lookahead Buffer:</string>
+               <string>Frametype Lookahead:</string>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QSpinBox" name="threadedLookaheadSpinBox">
-              <property name="enabled">
-               <bool>false</bool>
-              </property>
+             <widget class="QSpinBox" name="lookaheadSpinBox">
               <property name="maximum">
                <number>250</number>
               </property>
              </widget>
             </item>
             <item>
-             <widget class="QLabel" name="lblThreadedFrames">
-              <property name="enabled">
-               <bool>false</bool>
-              </property>
+             <widget class="QLabel" name="lblLookaheadFrames">
               <property name="text">
                <string>frames</string>
               </property>
              </widget>
             </item>
             <item>
-             <spacer name="spacer">
+             <spacer name="spacer_3">
               <property name="orientation">
                <enum>Qt::Horizontal</enum>
               </property>
@@ -2899,7 +2949,7 @@
      </widget>
      <widget class="QWidget" name="tab_7">
       <attribute name="title">
-       <string>Advanced</string>
+       <string>Advanced 1</string>
       </attribute>
       <layout class="QVBoxLayout">
        <property name="spacing">
@@ -3276,6 +3326,175 @@
        </item>
       </layout>
      </widget>
+     <widget class="QWidget" name="tab_9">
+      <attribute name="title">
+       <string>Advanced 2</string>
+      </attribute>
+      <layout class="QVBoxLayout" name="verticalLayout_4">
+       <item>
+        <widget class="QGroupBox" name="groupBox_17">
+         <property name="title">
+          <string>Multithreading</string>
+         </property>
+         <layout class="QVBoxLayout" name="_2">
+          <property name="spacing">
+           <number>6</number>
+          </property>
+          <property name="margin">
+           <number>9</number>
+          </property>
+          <item>
+           <layout class="QVBoxLayout" name="_4">
+            <property name="spacing">
+             <number>6</number>
+            </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
+            <item>
+             <widget class="QRadioButton" name="threadDisableRadioButton">
+              <property name="text">
+               <string>Disable</string>
+              </property>
+             </widget>
+            </item>
+            <item>
+             <widget class="QRadioButton" name="threadAutoDetectRadioButton">
+              <property name="text">
+               <string>Auto-detect</string>
+              </property>
+              <property name="checked">
+               <bool>true</bool>
+              </property>
+             </widget>
+            </item>
+            <item>
+             <layout class="QHBoxLayout" name="_14">
+              <property name="spacing">
+               <number>6</number>
+              </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
+              <item>
+               <widget class="QRadioButton" name="threadCustomRadioButton">
+                <property name="text">
+                 <string comment="multithreading">Custom:</string>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <widget class="QSpinBox" name="threadCustomSpinBox">
+                <property name="enabled">
+                 <bool>false</bool>
+                </property>
+                <property name="minimum">
+                 <number>2</number>
+                </property>
+                <property name="maximum">
+                 <number>32</number>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <spacer name="spacer_2">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>0</width>
+                  <height>0</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
+             </layout>
+            </item>
+           </layout>
+          </item>
+          <item>
+           <widget class="QCheckBox" name="repeatabilityCheckBox">
+            <property name="text">
+             <string>Enforce Repeatability</string>
+            </property>
+           </widget>
+          </item>
+          <item>
+           <widget class="QCheckBox" name="sliceThreadingCheckBox">
+            <property name="text">
+             <string>Slice-based Threading</string>
+            </property>
+           </widget>
+          </item>
+          <item>
+           <layout class="QHBoxLayout" name="_15">
+            <property name="spacing">
+             <number>6</number>
+            </property>
+            <property name="margin">
+             <number>0</number>
+            </property>
+            <item>
+             <widget class="QCheckBox" name="threadedLookaheadCheckBox">
+              <property name="text">
+               <string>Custom Threaded Lookahead Buffer:</string>
+              </property>
+             </widget>
+            </item>
+            <item>
+             <widget class="QSpinBox" name="threadedLookaheadSpinBox">
+              <property name="enabled">
+               <bool>false</bool>
+              </property>
+              <property name="maximum">
+               <number>250</number>
+              </property>
+             </widget>
+            </item>
+            <item>
+             <widget class="QLabel" name="lblThreadedFrames">
+              <property name="enabled">
+               <bool>false</bool>
+              </property>
+              <property name="text">
+               <string>frames</string>
+              </property>
+             </widget>
+            </item>
+            <item>
+             <spacer name="spacer">
+              <property name="orientation">
+               <enum>Qt::Horizontal</enum>
+              </property>
+              <property name="sizeHint" stdset="0">
+               <size>
+                <width>0</width>
+                <height>0</height>
+               </size>
+              </property>
+             </spacer>
+            </item>
+           </layout>
+          </item>
+         </layout>
+        </widget>
+       </item>
+       <item>
+        <spacer name="verticalSpacer">
+         <property name="orientation">
+          <enum>Qt::Vertical</enum>
+         </property>
+         <property name="sizeHint" stdset="0">
+          <size>
+           <width>20</width>
+           <height>256</height>
+          </size>
+         </property>
+        </spacer>
+       </item>
+      </layout>
+     </widget>
      <widget class="QWidget" name="tab_8">
       <attribute name="title">
        <string>Output 1</string>
@@ -4223,14 +4442,6 @@
   <tabstop>fastFirstPassCheckBox</tabstop>
   <tabstop>mbTreeCheckBox</tabstop>
   <tabstop>lookaheadSpinBox</tabstop>
-  <tabstop>threadDisableRadioButton</tabstop>
-  <tabstop>threadAutoDetectRadioButton</tabstop>
-  <tabstop>threadCustomRadioButton</tabstop>
-  <tabstop>threadCustomSpinBox</tabstop>
-  <tabstop>repeatabilityCheckBox</tabstop>
-  <tabstop>sliceThreadingCheckBox</tabstop>
-  <tabstop>threadedLookaheadCheckBox</tabstop>
-  <tabstop>threadedLookaheadSpinBox</tabstop>
   <tabstop>meMethodComboBox</tabstop>
   <tabstop>meSlider</tabstop>
   <tabstop>meSpinBox</tabstop>
@@ -4300,6 +4511,14 @@
   <tabstop>zoneAddButton</tabstop>
   <tabstop>zoneEditButton</tabstop>
   <tabstop>zoneDeleteButton</tabstop>
+  <tabstop>threadDisableRadioButton</tabstop>
+  <tabstop>threadAutoDetectRadioButton</tabstop>
+  <tabstop>threadCustomRadioButton</tabstop>
+  <tabstop>threadCustomSpinBox</tabstop>
+  <tabstop>repeatabilityCheckBox</tabstop>
+  <tabstop>sliceThreadingCheckBox</tabstop>
+  <tabstop>threadedLookaheadCheckBox</tabstop>
+  <tabstop>threadedLookaheadSpinBox</tabstop>
   <tabstop>idcLevelComboBox</tabstop>
   <tabstop>spsiComboBox</tabstop>
   <tabstop>accessUnitCheckBox</tabstop>
@@ -4562,22 +4781,6 @@
    </hints>
   </connection>
   <connection>
-   <sender>threadCustomRadioButton</sender>
-   <signal>toggled(bool)</signal>
-   <receiver>threadCustomSpinBox</receiver>
-   <slot>setEnabled(bool)</slot>
-   <hints>
-    <hint type="sourcelabel">
-     <x>32</x>
-     <y>418</y>
-    </hint>
-    <hint type="destinationlabel">
-     <x>117</x>
-     <y>419</y>
-    </hint>
-   </hints>
-  </connection>
-  <connection>
    <sender>aqVarianceCheckBox</sender>
    <signal>toggled(bool)</signal>
    <receiver>aqStrengthLabel</receiver>
@@ -4642,52 +4845,100 @@
    </hints>
   </connection>
   <connection>
-   <sender>threadedLookaheadCheckBox</sender>
+   <sender>interlacedCheckBox</sender>
    <signal>toggled(bool)</signal>
-   <receiver>threadedLookaheadSpinBox</receiver>
+   <receiver>interlacedComboBox</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>56</x>
-     <y>495</y>
+     <x>70</x>
+     <y>149</y>
     </hint>
     <hint type="destinationlabel">
-     <x>280</x>
-     <y>496</y>
+     <x>151</x>
+     <y>149</y>
     </hint>
    </hints>
   </connection>
   <connection>
-   <sender>threadedLookaheadCheckBox</sender>
+   <sender>maxCrfCheckBox</sender>
    <signal>toggled(bool)</signal>
-   <receiver>lblThreadedFrames</receiver>
+   <receiver>quantiserLabel1_2</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>56</x>
-     <y>495</y>
+     <x>263</x>
+     <y>248</y>
     </hint>
     <hint type="destinationlabel">
-     <x>319</x>
-     <y>496</y>
+     <x>97</x>
+     <y>277</y>
     </hint>
    </hints>
   </connection>
   <connection>
-   <sender>interlacedCheckBox</sender>
+   <sender>maxCrfCheckBox</sender>
    <signal>toggled(bool)</signal>
-   <receiver>interlacedComboBox</receiver>
+   <receiver>quantiserLabel2_2</receiver>
    <slot>setEnabled(bool)</slot>
    <hints>
     <hint type="sourcelabel">
-     <x>70</x>
-     <y>149</y>
+     <x>263</x>
+     <y>248</y>
     </hint>
     <hint type="destinationlabel">
-     <x>151</x>
-     <y>149</y>
+     <x>244</x>
+     <y>277</y>
     </hint>
    </hints>
   </connection>
+  <connection>
+   <sender>maxCrfCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>quantiserLabel3_2</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel">
+     <x>263</x>
+     <y>248</y>
+    </hint>
+    <hint type="destinationlabel">
+     <x>393</x>
+     <y>277</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>maxCrfCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>maxCrfSlider</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel">
+     <x>263</x>
+     <y>248</y>
+    </hint>
+    <hint type="destinationlabel">
+     <x>246</x>
+     <y>300</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>maxCrfCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>maxCrfSpinBox</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel">
+     <x>263</x>
+     <y>248</y>
+    </hint>
+    <hint type="destinationlabel">
+     <x>467</x>
+     <y>289</y>
+    </hint>
+   </hints>
+  </connection>
  </connections>
 </ui>

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-09-28 05:31:17 UTC (rev 6676)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-09-28 20:43:51 UTC (rev 6677)
@@ -813,6 +813,19 @@
 		_param.rc.i_qp_step = quantiserStep;
 }
 
+#if X264_BUILD > 89
+unsigned int x264Options::getMaximumConstantRateFactor(void)
+{
+	return (unsigned int)_param.rc.f_rf_constant_max;
+}
+
+void x264Options::setMaximumConstantRateFactor(unsigned int maxCrf)
+{
+	if (maxCrf <= 51)
+		_param.rc.f_rf_constant_max = maxCrf;
+}
+#endif
+
 float x264Options::getAverageBitrateTolerance(void)
 {
 	return _param.rc.f_rate_tolerance;
@@ -1400,6 +1413,9 @@
 	xmlNewChild(xmlNodeChild, NULL, (xmlChar*)"quantiserMinimum", number2String(xmlBuffer, bufferSize, getQuantiserMinimum()));
 	xmlNewChild(xmlNodeChild, NULL, (xmlChar*)"quantiserMaximum", number2String(xmlBuffer, bufferSize, getQuantiserMaximum()));
 	xmlNewChild(xmlNodeChild, NULL, (xmlChar*)"quantiserStep", number2String(xmlBuffer, bufferSize, getQuantiserStep()));
+#if X264_BUILD > 89
+	xmlNewChild(xmlNodeChild, NULL, (xmlChar*)"maximumConstantRateFactor", number2String(xmlBuffer, bufferSize, getMaximumConstantRateFactor()));
+#endif
 	xmlNewChild(xmlNodeChild, NULL, (xmlChar*)"averageBitrateTolerance", number2String(xmlBuffer, bufferSize, getAverageBitrateTolerance()));
 	xmlNewChild(xmlNodeChild, NULL, (xmlChar*)"vbvMaximumBitrate", number2String(xmlBuffer, bufferSize, getVbvMaximumBitrate()));
 	xmlNewChild(xmlNodeChild, NULL, (xmlChar*)"vbvBufferSize", number2String(xmlBuffer, bufferSize, getVbvBufferSize()));
@@ -1910,6 +1926,10 @@
 				setQuantiserMaximum(atoi(content));
 			else if (strcmp((char*)xmlChild->name, "quantiserStep") == 0)
 				setQuantiserStep(atoi(content));
+#if X264_BUILD > 89
+			else if (strcmp((char*)xmlChild->name, "maximumConstantRateFactor") == 0)
+				setMaximumConstantRateFactor(atoi(content));
+#endif
 			else if (strcmp((char*)xmlChild->name, "averageBitrateTolerance") == 0)
 				setAverageBitrateTolerance(string2Float(content));
 			else if (strcmp((char*)xmlChild->name, "vbvMaximumBitrate") == 0)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.h	2010-09-28 05:31:17 UTC (rev 6676)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.h	2010-09-28 20:43:51 UTC (rev 6677)
@@ -42,7 +42,6 @@
 #if X264_BUILD > 85
 	bool _fastFirstPast;
 #endif
-
 	void cleanUp(void);
 
 	void addOptionsToXml(xmlNodePtr xmlNodeRoot);
@@ -264,6 +263,11 @@
 	unsigned int getQuantiserStep(void);
 	void setQuantiserStep(unsigned int quantiserStep);
 
+#if X264_BUILD > 89
+	unsigned int getMaximumConstantRateFactor(void);
+	void setMaximumConstantRateFactor(unsigned int maxCrf);
+#endif
+
 	float getAverageBitrateTolerance(void);
 	void setAverageBitrateTolerance(float averageBitrateTolerance);
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2010-09-28 05:31:17 UTC (rev 6676)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2010-09-28 20:43:51 UTC (rev 6677)
@@ -474,6 +474,14 @@
                         </xs:restriction>
                       </xs:simpleType>
                     </xs:element>
+					<xs:element name="maximumConstantRateFactor" minOccurs="0">
+					  <xs:simpleType>
+						<xs:restriction base="xs:integer">
+						  <xs:minInclusive value="0"/>
+						  <xs:maxInclusive value="51"/>
+						</xs:restriction>
+					  </xs:simpleType>
+					</xs:element>
                     <xs:element name="averageBitrateTolerance" minOccurs="0">
                       <xs:simpleType>
                         <xs:restriction base="xs:float">



From gruntster at mail.berlios.de  Tue Sep 28 23:22:25 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 28 Sep 2010 23:22:25 +0200
Subject: [Avidemux-svn-commit] r6678 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264:
	. qt4
Message-ID: <20100928212226.27265480FD0@sheep.berlios.de>

Author: gruntster
Date: 2010-09-28 23:22:25 +0200 (Tue, 28 Sep 2010)
New Revision: 6678

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
Log:
[x264] support for fake interlaced

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2010-09-28 20:43:51 UTC (rev 6677)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2010-09-28 21:22:25 UTC (rev 6678)
@@ -490,6 +490,9 @@
 #if X264_BUILD > 88
 	printf("[x264] b_tff = %d\n", x264Param->b_tff);
 #endif
+#if X264_BUILD > 95
+	printf("[x264] b_fake_interlaced = %d\n", x264Param->b_fake_interlaced);
+#endif
 	printf("[x264] b_deblocking_filter = %d\n", x264Param->b_deblocking_filter);
 	printf("[x264] i_deblocking_filter_alphac0 = %d\n", x264Param->i_deblocking_filter_alphac0);
 	printf("[x264] i_deblocking_filter_beta = %d\n", x264Param->i_deblocking_filter_beta);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-09-28 20:43:51 UTC (rev 6677)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-09-28 21:22:25 UTC (rev 6678)
@@ -98,6 +98,10 @@
 	connect(ui.loopFilterCheckBox, SIGNAL(toggled(bool)), this, SLOT(loopFilterCheckBox_toggled(bool)));
 	connect(ui.cabacCheckBox, SIGNAL(toggled(bool)), this, SLOT(cabacCheckBox_toggled(bool)));
 
+#if X264_BUILD < 96
+	ui.interlacedComboBox->removeItem(2);
+#endif
+
 #if X264_BUILD < 89
 	ui.interlacedComboBox->removeItem(1);
 #endif

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-28 20:43:51 UTC (rev 6677)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-28 21:22:25 UTC (rev 6678)
@@ -1397,6 +1397,11 @@
                   <string>Top Field First</string>
                  </property>
                 </item>
+                <item>
+                 <property name="text">
+                  <string>Fake Interlaced</string>
+                 </property>
+                </item>
                </widget>
               </item>
               <item>

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-09-28 20:43:51 UTC (rev 6677)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-09-28 21:22:25 UTC (rev 6678)
@@ -418,7 +418,14 @@
 			return 1;
 	}
 	else
-		return 0;
+	{
+#	if X264_BUILD > 95
+		if (_param.b_fake_interlaced)
+			return 3;
+		else
+#endif
+			return 0;
+	}
 #else
 	return _param.b_interlaced;
 #endif
@@ -426,11 +433,15 @@
 
 void x264Options::setInterlaced(unsigned int interlaced)
 {
-	_param.b_interlaced = !!interlaced;
+	_param.b_interlaced = (interlaced == 1 || interlaced == 2);
 
 #if X264_BUILD > 88
 	_param.b_tff = (interlaced == 2 ? 1 : 0);
 #endif
+
+#if X264_BUILD > 95
+	_param.b_fake_interlaced = (interlaced == 3 ? 1 : 0);
+#endif
 }
 
 bool x264Options::getConstrainedIntraPrediction(void)
@@ -1257,6 +1268,11 @@
 		case 2:
 			strcpy((char*)xmlBuffer, "tff");
 			break;
+#if X264_BUILD > 95
+		case 3:
+			strcpy((char*)xmlBuffer, "fake");
+			break;
+#endif
 		default:
 			strcpy((char*)xmlBuffer, "disabled");
 			break;
@@ -1564,6 +1580,8 @@
 					interlaced = 1;
 				else if (strcmp(content, "tff") == 0)
 					interlaced = 2;
+				else if (strcmp(content, "fake") == 0)
+					interlaced = 3;
 
 				setInterlaced(interlaced);
 			}

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2010-09-28 20:43:51 UTC (rev 6677)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2010-09-28 21:22:25 UTC (rev 6678)
@@ -253,6 +253,7 @@
 						  <xs:enumeration value="disabled"/>
 						  <xs:enumeration value="bff"/>
 						  <xs:enumeration value="tff"/>
+						  <xs:enumeration value="fake"/>
 
 						  <!-- boolean values deprecated core 89 -->
 						  <xs:enumeration value="false"/>



From gruntster at mail.berlios.de  Wed Sep 29 00:02:38 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 29 Sep 2010 00:02:38 +0200
Subject: [Avidemux-svn-commit] r6679 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4
Message-ID: <20100928220239.052D6481084@sheep.berlios.de>

Author: gruntster
Date: 2010-09-29 00:02:38 +0200 (Wed, 29 Sep 2010)
New Revision: 6679

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
Log:
[x264] rearrange gop size controls

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-28 21:22:25 UTC (rev 6678)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-28 22:02:38 UTC (rev 6679)
@@ -1351,13 +1351,7 @@
       <attribute name="title">
        <string>Frame</string>
       </attribute>
-      <layout class="QVBoxLayout">
-       <property name="spacing">
-        <number>6</number>
-       </property>
-       <property name="margin">
-        <number>9</number>
-       </property>
+      <layout class="QVBoxLayout" name="verticalLayout_7">
        <item>
         <widget class="QGroupBox" name="groupBox_6">
          <property name="title">
@@ -1758,179 +1752,135 @@
          <property name="title">
           <string>I-frames</string>
          </property>
-         <layout class="QVBoxLayout">
-          <property name="spacing">
-           <number>6</number>
-          </property>
-          <property name="margin">
-           <number>9</number>
-          </property>
+         <layout class="QVBoxLayout" name="verticalLayout_6">
           <item>
-           <layout class="QVBoxLayout">
-            <property name="spacing">
-             <number>6</number>
-            </property>
-            <property name="margin">
-             <number>0</number>
-            </property>
-            <item>
-             <layout class="QGridLayout">
-              <property name="margin">
-               <number>0</number>
+           <layout class="QGridLayout" name="gridLayout_3">
+            <item row="0" column="0">
+             <widget class="QLabel" name="label_34">
+              <property name="text">
+               <string>GOP Size:</string>
               </property>
-              <property name="spacing">
-               <number>6</number>
-              </property>
-              <item row="0" column="1">
-               <layout class="QHBoxLayout">
-                <property name="spacing">
-                 <number>6</number>
-                </property>
-                <property name="margin">
-                 <number>0</number>
-                </property>
-                <item>
-                 <widget class="QSpinBox" name="minGopSizeSpinBox">
-                  <property name="maximum">
-                   <number>100</number>
-                  </property>
-                  <property name="value">
-                   <number>25</number>
-                  </property>
-                 </widget>
-                </item>
-                <item>
-                 <spacer name="spacer_29">
-                  <property name="orientation">
-                   <enum>Qt::Horizontal</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                   <size>
-                    <width>0</width>
-                    <height>0</height>
-                   </size>
-                  </property>
-                 </spacer>
-                </item>
-               </layout>
-              </item>
-              <item row="1" column="0">
-               <widget class="QLabel" name="label_26">
+             </widget>
+            </item>
+            <item row="0" column="1">
+             <layout class="QHBoxLayout" name="horizontalLayout_2">
+              <item>
+               <widget class="QLabel" name="label_28">
                 <property name="text">
-                 <string>Maximum GOP Size:</string>
+                 <string>Minimum:</string>
                 </property>
                </widget>
               </item>
-              <item row="2" column="0">
-               <widget class="QLabel" name="label_27">
-                <property name="text">
-                 <string>I-frame Threshold:</string>
+              <item>
+               <widget class="QSpinBox" name="minGopSizeSpinBox">
+                <property name="maximum">
+                 <number>100</number>
                 </property>
+                <property name="value">
+                 <number>25</number>
+                </property>
                </widget>
               </item>
-              <item row="1" column="1">
-               <layout class="QHBoxLayout">
-                <property name="spacing">
-                 <number>6</number>
+              <item>
+               <spacer name="spacer_29">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
                 </property>
-                <property name="margin">
-                 <number>0</number>
+                <property name="sizeType">
+                 <enum>QSizePolicy::Fixed</enum>
                 </property>
-                <item>
-                 <widget class="QSpinBox" name="maxGopSizeSpinBox">
-                  <property name="minimum">
-                   <number>1</number>
-                  </property>
-                  <property name="maximum">
-                   <number>1000</number>
-                  </property>
-                  <property name="value">
-                   <number>250</number>
-                  </property>
-                 </widget>
-                </item>
-                <item>
-                 <spacer name="spacer_30">
-                  <property name="orientation">
-                   <enum>Qt::Horizontal</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                   <size>
-                    <width>0</width>
-                    <height>0</height>
-                   </size>
-                  </property>
-                 </spacer>
-                </item>
-               </layout>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>10</width>
+                  <height>0</height>
+                 </size>
+                </property>
+               </spacer>
               </item>
-              <item row="0" column="0">
-               <widget class="QLabel" name="label_28">
+              <item>
+               <widget class="QLabel" name="label_26">
                 <property name="text">
-                 <string>Minimum GOP Size:</string>
+                 <string>Maximum:</string>
                 </property>
                </widget>
               </item>
-              <item row="2" column="1">
-               <layout class="QHBoxLayout">
-                <property name="spacing">
-                 <number>6</number>
+              <item>
+               <widget class="QSpinBox" name="maxGopSizeSpinBox">
+                <property name="minimum">
+                 <number>1</number>
                 </property>
-                <property name="margin">
-                 <number>0</number>
+                <property name="maximum">
+                 <number>1000</number>
                 </property>
-                <item>
-                 <widget class="QSpinBox" name="IFrameThresholdSpinBox">
-                  <property name="maximum">
-                   <number>100</number>
-                  </property>
-                  <property name="value">
-                   <number>40</number>
-                  </property>
-                 </widget>
-                </item>
-                <item>
-                 <spacer name="spacer_31">
-                  <property name="orientation">
-                   <enum>Qt::Horizontal</enum>
-                  </property>
-                  <property name="sizeHint" stdset="0">
-                   <size>
-                    <width>0</width>
-                    <height>0</height>
-                   </size>
-                  </property>
-                 </spacer>
-                </item>
-               </layout>
+                <property name="value">
+                 <number>250</number>
+                </property>
+               </widget>
               </item>
+              <item>
+               <spacer name="spacer_30">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>168</width>
+                  <height>13</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
              </layout>
             </item>
-            <item>
-             <spacer>
-              <property name="orientation">
-               <enum>Qt::Vertical</enum>
-              </property>
-              <property name="sizeType">
-               <enum>QSizePolicy::Fixed</enum>
-              </property>
-              <property name="sizeHint" stdset="0">
-               <size>
-                <width>362</width>
-                <height>2</height>
-               </size>
-              </property>
-             </spacer>
-            </item>
-            <item>
-             <widget class="QCheckBox" name="intraRefreshCheckBox">
+            <item row="1" column="0">
+             <widget class="QLabel" name="label_27">
               <property name="text">
-               <string>Periodic Intra Refresh</string>
+               <string>I-frame Threshold:</string>
               </property>
              </widget>
             </item>
+            <item row="1" column="1">
+             <layout class="QHBoxLayout">
+              <property name="spacing">
+               <number>6</number>
+              </property>
+              <property name="margin">
+               <number>0</number>
+              </property>
+              <item>
+               <widget class="QSpinBox" name="IFrameThresholdSpinBox">
+                <property name="maximum">
+                 <number>100</number>
+                </property>
+                <property name="value">
+                 <number>40</number>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <spacer name="spacer_31">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>0</width>
+                  <height>0</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
+             </layout>
+            </item>
            </layout>
           </item>
+          <item>
+           <widget class="QCheckBox" name="intraRefreshCheckBox">
+            <property name="text">
+             <string>Periodic Intra Refresh</string>
+            </property>
+           </widget>
+          </item>
          </layout>
         </widget>
        </item>



From mean at mail.berlios.de  Wed Sep 29 07:48:50 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed, 29 Sep 2010 07:48:50 +0200
Subject: [Avidemux-svn-commit] r6680 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src
Message-ID: <20100929054850.1CFA0480EC7@sheep.berlios.de>

Author: mean
Date: 2010-09-29 07:48:49 +0200 (Wed, 29 Sep 2010)
New Revision: 6680

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
Log:
[h264 info extractor] Use recovery time info to detect IDR

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-28 22:02:38 UTC (rev 6679)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-29 05:48:49 UTC (rev 6680)
@@ -346,8 +346,86 @@
   return 1;
 }
 /**
+    \fn getRecoveryFromSei
+    \brief We dont unescape here, very unlikely needed as we only decode recovery which is small
+*/
+static bool getRecoveryFromSei(uint32_t nalSize, uint8_t *org,uint32_t *recoveryLength)
+{
+    
+    uint8_t *payload=(uint8_t *)alloca(nalSize+16);
+    bool r=false;
+    nalSize=ADM_unescapeH264(nalSize,org,payload);
+    uint8_t *tail=payload+nalSize;
+    *recoveryLength=16;
+    while( payload<tail)
+    {
+                uint32_t sei_type=0,sei_size=0;
+                while(payload[0]==0xff) {sei_type+=0xff;payload++;};
+                sei_type+=payload[0];payload++;
+                while(payload[0]==0xff) {sei_size+=0xff;payload++;};
+                sei_size+=payload[0];payload++;
+                aprintf("  [SEI] Type : 0x%x size:%d\n",sei_type,sei_size);
+                if(payload+sei_size>tail) break;
+                switch(sei_type) // Recovery point
+                {
+                       case 6:
+                        {
+                            getBits bits(sei_size,payload);
+                            payload+=sei_size;
+                            *recoveryLength=bits.getUEG();
+                            r=true;
+                            break;
+                        }
+                        default:
+                            payload+=sei_size;
+                            break;
+                }
+    }
+    return r;
+}
+/**
+    \fn refineH264FrameType
+    \brief Try to detect B slice, warning the stream is not escaped!
+*/
+static bool getNalType (uint8_t * head, uint8_t * tail, uint32_t * flags,int recovery)
+{
+    uint8_t *out=(uint8_t *)alloca(tail-head);
+    int size=ADM_unescapeH264(tail-head,head,out);
+   
+    getBits bits(size,out);
+    uint32_t sliceType;
+    *flags = 0;
+  
+    bits.getUEG();               // first mb in slice
+    sliceType = bits.getUEG31(); // get_ue_golomb_31??
+    if (sliceType > 9)
+    {
+      ADM_warning ("Weird Slice %d\n", sliceType);
+      return false;
+    }
+    if (sliceType > 4)
+        sliceType -= 5;
+
+    switch(sliceType)
+    {
+        case 3:
+        case 0: *flags=  AVI_P_FRAME;break;
+        case 1: *flags = AVI_B_FRAME;break;
+        case 2: case 4:
+                if(!recovery) *flags=AVI_KEY_FRAME;
+                    else      *flags=AVI_P_FRAME;
+                break;
+        
+    }
+
+    return true;
+}
+
+/**
       \fn extractH264FrameType
-      \brief return frametype in flags (KEY_FRAME or 0). To be used only with  mkv/mp4 nal type (i.e. no startcode)
+      \brief return frametype in flags (KEY_FRAME or 0). 
+             To be used only with  mkv/mp4 nal type (i.e. no startcode)
+                    but 4 bytes NALU
       
 */
 uint8_t extractH264FrameType (uint32_t nalSize, uint8_t * buffer, uint32_t len,
@@ -358,13 +436,11 @@
 
   uint32_t val, hnt;
 
-// FIXME :  no startcode only !
-  //ADM_info("Searching H264 frame type..\n");
   while (head + 4 < tail)
     {
 
       uint32_t length =(head[0] << 24) + (head[1] << 16) + (head[2] << 8) + (head[3]);
-      //printf("Block size : %"LU", available : %"LU"\n",length,len);
+      
       if (length > len)// || length < 2)
       {
           ADM_warning ("Warning , incomplete nal (%u/%u),(%0x/%0x)\n", length, len, length, len);
@@ -373,22 +449,24 @@
         }
       head += 4;		// Skip nal lenth
       stream = *(head) & 0x1F;
+      uint32_t recovery;
+      int sliceType;
       switch (stream)
         {
+            case NAL_SEI:
+                getRecoveryFromSei(length-1, head+1,&recovery);
+                break;
             case NAL_SPS:
             case NAL_PPS: 
-            case NAL_SEI:
             case NAL_AU_DELIMITER:
             case NAL_FILLER:
                     break;
             case NAL_IDR:
               *flags = AVI_KEY_FRAME;
-              //ADM_info("Found IDR \n");
               return 1;
               break;
             case NAL_NON_IDR:
-              refineH264FrameType (head + 1, tail, flags);
-              //ADM_info("Found Non IDR :%x\n",*flags);
+              getNalType(head+1,head+length,flags,recovery);
               return 1;
               break;
             default:
@@ -403,17 +481,13 @@
 
 /**
       \fn extractH264FrameType_startCode
-      \brief return frametype in flags (KEY_FRAME or 0). To be used only with  avi / mpeg TS nal type (i.e. with startcode)
-      
+      \brief return frametype in flags (KEY_FRAME or 0). 
+      To be used only with  avi / mpeg TS nal type (i.e. with startcode 00 00 00 01     
 */
 uint8_t extractH264FrameType_startCode(uint32_t nalSize, uint8_t * buffer,uint32_t len, uint32_t * flags)
 {
   uint8_t *head = buffer, *tail = buffer + len;
   uint8_t stream;
-#define NAL_NON_IDR       1
-#define NAL_IDR           5
-#define NAL_SEI           6
-
   uint32_t val, hnt;
 
 // FIXME :  no startcode only !
@@ -455,25 +529,11 @@
 }
 /**
     \fn refineH264FrameType
-    \brief Try to detect B slice, warning the stream is not escaped!
+    \brief Try to detect frame type from stream
 */
+
 void refineH264FrameType (uint8_t * head, uint8_t * tail, uint32_t * flags)
 {
-  getBits bits(tail-head,head);
-  uint32_t sliceType;
-  *flags = 0;
-  
-  bits.getUEG();
-  sliceType = bits.getUEG31(); // get_ue_golomb_31??
-  if (sliceType > 9)
-    {
-      printf ("Weird Slice %d\n", sliceType);
-      return;
-    }
-  if (sliceType > 4)
-    sliceType -= 5;
-  if (sliceType == 1)
-    *flags = AVI_B_FRAME;
-  //printf("[H264] Slice type : %"LU"\n",sliceType);
+   getNalType (head,tail, flags,16); // No recovery here
 }
 //EOF



From mean at mail.berlios.de  Wed Sep 29 07:48:51 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed, 29 Sep 2010 07:48:51 +0200
Subject: [Avidemux-svn-commit] r6681 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src
Message-ID: <20100929054851.283DF480EC7@sheep.berlios.de>

Author: mean
Date: 2010-09-29 07:48:50 +0200 (Wed, 29 Sep 2010)
New Revision: 6681

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
Log:
[H264/info extractor, cleanup

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-29 05:48:49 UTC (rev 6680)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractorH264.cpp	2010-09-29 05:48:50 UTC (rev 6681)
@@ -25,8 +25,6 @@
 #include "ADM_videoInfoExtractor.h"
 #include "ADM_h264_tag.h"
 
-static void refineH264FrameType (uint8_t * head, uint8_t * tail,
-				 uint32_t * flags);
 bool ADM_findMpegStartCode (uint8_t * start, uint8_t * end,
 			    uint8_t * outstartcode, uint32_t * offset);
 /**
@@ -384,8 +382,9 @@
     return r;
 }
 /**
-    \fn refineH264FrameType
-    \brief Try to detect B slice, warning the stream is not escaped!
+    \fn getNalType
+    \brief Return the slice type. The stream is escaped by the function. If recovery==0 
+            I as considered IDR else as P.
 */
 static bool getNalType (uint8_t * head, uint8_t * tail, uint32_t * flags,int recovery)
 {
@@ -428,8 +427,7 @@
                     but 4 bytes NALU
       
 */
-uint8_t extractH264FrameType (uint32_t nalSize, uint8_t * buffer, uint32_t len,
-		      uint32_t * flags)
+uint8_t extractH264FrameType (uint32_t nalSize, uint8_t * buffer, uint32_t len,  uint32_t * flags)
 {
   uint8_t *head = buffer, *tail = buffer + len;
   uint8_t stream;
@@ -482,7 +480,8 @@
 /**
       \fn extractH264FrameType_startCode
       \brief return frametype in flags (KEY_FRAME or 0). 
-      To be used only with  avi / mpeg TS nal type (i.e. with startcode 00 00 00 01     
+      To be used only with  avi / mpeg TS nal type 
+        (i.e. with startcode 00 00 00 01)     
 */
 uint8_t extractH264FrameType_startCode(uint32_t nalSize, uint8_t * buffer,uint32_t len, uint32_t * flags)
 {
@@ -495,16 +494,15 @@
   while (head + 4 < tail)
     {
       // Search startcode
-
       hnt = (head[0] << 24) + (head[1] << 16) + (head[2] << 8) + (head[3]);
       head += 4;
       while ((hnt != 1) && head < tail)
-	{
+        {
 
-	  hnt <<= 8;
-	  val = *head++;
-	  hnt += val;
-	}
+          hnt <<= 8;
+          val = *head++;
+          hnt += val;
+        }
       if (head >= tail)
 	break;
       stream = *(head++) & 0x1f;
@@ -516,24 +514,16 @@
 	  return 1;
 	  break;
 	case NAL_NON_IDR:
-	  refineH264FrameType (head, tail, flags);
+	   getNalType (head,tail, flags,16); // No recovery here
 	  return 1;
 	  break;
+    case NAL_SPS:case NAL_PPS: case NAL_FILLER: case NAL_AU_DELIMITER: break;
 	default:
-	  printf ("??0x%x\n", stream);
+	  ADM_warning ("??0x%x\n", stream);
 	  continue;
 	}
     }
   printf ("No stream\n");
   return 0;
 }
-/**
-    \fn refineH264FrameType
-    \brief Try to detect frame type from stream
-*/
-
-void refineH264FrameType (uint8_t * head, uint8_t * tail, uint32_t * flags)
-{
-   getNalType (head,tail, flags,16); // No recovery here
-}
 //EOF



From mean at mail.berlios.de  Wed Sep 29 07:48:52 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed, 29 Sep 2010 07:48:52 +0200
Subject: [Avidemux-svn-commit] r6682 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4
Message-ID: <20100929054852.3F0AE480EC7@sheep.berlios.de>

Author: mean
Date: 2010-09-29 07:48:52 +0200 (Wed, 29 Sep 2010)
New Revision: 6682

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp
Log:
[Mp4/demux] Add verbose flag

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp	2010-09-29 05:48:50 UTC (rev 6681)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp	2010-09-29 05:48:52 UTC (rev 6682)
@@ -26,8 +26,13 @@
 
 #include "ADM_mp4Tree.h"
 
+#if 1
 #define adm_printf(...) {}
 #define aprintf(...) {}
+#else
+#define adm_printf(a,b...) ADM_info(b)
+#define aprintf(...) ADM_info
+#endif
 
 #define QT_TR_NOOP(x) x
 #define TRACK_OTHER 0



From gruntster at mail.berlios.de  Wed Sep 29 21:01:12 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 29 Sep 2010 21:01:12 +0200
Subject: [Avidemux-svn-commit] r6683 - in
	branches/avidemux_2.5_branch_gruntster: avidemux cmake
Message-ID: <20100929190112.418F5481024@sheep.berlios.de>

Author: gruntster
Date: 2010-09-29 21:01:12 +0200 (Wed, 29 Sep 2010)
New Revision: 6683

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/cmake/config.h.cmake
Log:
[sdl] disable SDL support for Qt GUI

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt	2010-09-29 05:48:52 UTC (rev 6682)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt	2010-09-29 19:01:12 UTC (rev 6683)
@@ -296,10 +296,6 @@
 	IF (ADM_UI_GTK)
 		TARGET_LINK_LIBRARIES(avidemux2_gtk ADM_libsdl_gtk)
 	ENDIF (ADM_UI_GTK)
-
-	IF (ADM_UI_QT4)
-		TARGET_LINK_LIBRARIES(avidemux2_qt4 ADM_libsdl_qt4)
-	ENDIF (ADM_UI_QT4)
 ENDIF (APPLE AND USE_SDL)
 
 ###########################################
@@ -415,10 +411,6 @@
 	IF (ADM_UI_GTK)
 		TARGET_LINK_LIBRARIES(avidemux2_gtk ${SDL_LIBRARY})
 	ENDIF (ADM_UI_GTK)
-
-	IF (ADM_UI_QT4)
-		TARGET_LINK_LIBRARIES(avidemux2_qt4 ${SDL_LIBRARY})
-	ENDIF (ADM_UI_QT4)
 ENDIF (USE_SDL)
 
 ###########################################

Modified: branches/avidemux_2.5_branch_gruntster/cmake/config.h.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/config.h.cmake	2010-09-29 05:48:52 UTC (rev 6682)
+++ branches/avidemux_2.5_branch_gruntster/cmake/config.h.cmake	2010-09-29 19:01:12 UTC (rev 6683)
@@ -59,7 +59,7 @@
 #cmakedefine USE_OPENGL
 #endif
 
-#if ${CONFIG_HEADER_TYPE} == ADM_BUILD_GTK || ${CONFIG_HEADER_TYPE} == ADM_BUILD_QT4
+#if ${CONFIG_HEADER_TYPE} == ADM_BUILD_GTK
 /* SDL detected */
 #cmakedefine USE_SDL
 #endif



From gruntster at mail.berlios.de  Wed Sep 29 21:43:13 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 29 Sep 2010 21:43:13 +0200
Subject: [Avidemux-svn-commit] r6684 -
	branches/avidemux_2.5_branch_gruntster/avidemux
Message-ID: <20100929194313.77C4E481024@sheep.berlios.de>

Author: gruntster
Date: 2010-09-29 21:43:13 +0200 (Wed, 29 Sep 2010)
New Revision: 6684

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp
Log:
[win32] redirect output regardless of SDL

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp	2010-09-29 19:01:12 UTC (rev 6683)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp	2010-09-29 19:43:13 UTC (rev 6684)
@@ -100,8 +100,12 @@
 
 int main(int argc, char *argv[])
 {
-#if defined(__WIN32) && defined(USE_SDL)
-	redirectStdoutToFile();
+	char uiDesc[15];
+	getUIDescription(uiDesc);
+
+#if defined(__WIN32)
+	if (strcmp(uiDesc, "CLI") != 0)
+		redirectStdoutToFile();
 #endif
 
 #if defined(ADM_DEBUG) && defined(FIND_LEAKS)
@@ -153,12 +157,8 @@
 	printf(" (PowerPC)");
 #endif
 
-	printf("\n");
+	printf("\nUser Interface: %s\n", uiDesc);
 
-	char uiDesc[15];
-	getUIDescription(uiDesc);
-	printf("User Interface: %s\n", uiDesc);
-
 #ifdef __WIN32
 	char version[250];
 



From gruntster at mail.berlios.de  Wed Sep 29 21:46:39 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 29 Sep 2010 21:46:39 +0200
Subject: [Avidemux-svn-commit] r6685 -
	branches/avidemux_2.5_branch_gruntster/platforms/windows/installer
Message-ID: <20100929194640.0E0C1481024@sheep.berlios.de>

Author: gruntster
Date: 2010-09-29 21:46:39 +0200 (Wed, 29 Sep 2010)
New Revision: 6685

Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
Log:
[win32] drop SDL from Qt installer

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2010-09-29 19:43:13 UTC (rev 6684)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2010-09-29 19:46:39 UTC (rev 6685)
@@ -291,7 +291,6 @@
     ${File} libaften.dll
     ${File} libxml2-*.dll
     ${File} pthreadGC2.dll
-    ${File} SDL.dll
     ${File} AUTHORS.
     ${File} COPYING.
     ${File} README.
@@ -335,6 +334,7 @@
         SetOutPath $INSTDIR
         ${File} avidemux2_gtk.exe
         ${File} gtk2_prefs.exe
+		${File} intl.dll
         ${File} libADM_render_gtk.dll
         ${File} libADM_UIGtk.dll
         ${File} libatk-1.0-0.dll
@@ -352,6 +352,7 @@
         ${File} libpangoft2-1.0-0.dll
         ${File} libpangowin32-1.0-0.dll
         ${File} libpng14-14.dll
+		${File} SDL.dll
     ${MementoSectionEnd}
 !endif
 
@@ -420,12 +421,6 @@
 		${MementoSectionEnd}
 	SectionGroupEnd
 	SectionGroup "Audio Devices" SecGrpAudioDevice
-		${MementoUnselectedSection} SDL SecAudDevSdl
-			SectionIn 2
-			SetOverwrite on
-			SetOutPath $INSTDIR\plugins\audioDevices
-			${File} plugins\audioDevices\libADM_av_sdl.dll
-		${MementoSectionEnd}
 		${MementoSection} "MS Windows (Waveform)" SecAudDevWaveform
 			SectionIn 1 2
 			SetOverwrite on



From gruntster at mail.berlios.de  Wed Sep 29 21:48:29 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 29 Sep 2010 21:48:29 +0200
Subject: [Avidemux-svn-commit] r6686 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264:
	. qt4
Message-ID: <20100929194829.821FA481024@sheep.berlios.de>

Author: gruntster
Date: 2010-09-29 21:48:29 +0200 (Wed, 29 Sep 2010)
New Revision: 6686

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
Log:
[x264] open gop support

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2010-09-29 19:46:39 UTC (rev 6685)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2010-09-29 19:48:29 UTC (rev 6686)
@@ -486,6 +486,9 @@
 	printf("[x264] analyse.b_transform_8x8 = %d\n", x264Param->analyse.b_transform_8x8);
 	printf("[x264] analyse.inter = %d\n", x264Param->analyse.inter);
 	printf("[x264] b_cabac = %d\n", x264Param->b_cabac);
+#if X264_BUILD > 101
+	printf("[x264] i_open_gop = %d\n", x264Param->i_open_gop);
+#endif
 	printf("[x264] b_interlaced = %d\n", x264Param->b_interlaced);
 #if X264_BUILD > 88
 	printf("[x264] b_tff = %d\n", x264Param->b_tff);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-09-29 19:46:39 UTC (rev 6685)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-09-29 19:48:29 UTC (rev 6686)
@@ -98,6 +98,11 @@
 	connect(ui.loopFilterCheckBox, SIGNAL(toggled(bool)), this, SLOT(loopFilterCheckBox_toggled(bool)));
 	connect(ui.cabacCheckBox, SIGNAL(toggled(bool)), this, SLOT(cabacCheckBox_toggled(bool)));
 
+#if X264_BUILD < 102
+	ui.openGopCheckBox->setVisible(false);
+	ui.openGopComboBox->setVisible(false);
+#endif
+
 #if X264_BUILD < 96
 	ui.interlacedComboBox->removeItem(2);
 #endif
@@ -750,6 +755,16 @@
 	// Frame tab
 	ui.cabacCheckBox->setChecked(options->getCabac());
 
+#if X264_BUILD > 101
+	if (options->getOpenGopMode())
+	{
+		ui.openGopCheckBox->setChecked(true);
+		ui.openGopComboBox->setCurrentIndex(options->getOpenGopMode() - 1);
+	}
+	else
+		ui.openGopCheckBox->setChecked(false);
+#endif
+
 	if (options->getInterlaced() > 0)
 	{
 		ui.interlacedCheckBox->setChecked(true);
@@ -982,6 +997,13 @@
 	// Frame tab
 	options->setCabac(ui.cabacCheckBox->isChecked());
 
+#if X264_BUILD > 101
+	if (ui.openGopCheckBox->isChecked())
+		options->setOpenGopMode(ui.openGopComboBox->currentIndex() + 1);
+	else
+		options->setOpenGopMode(0);
+#endif
+
 	if (ui.interlacedCheckBox->isChecked())
 		options->setInterlaced(ui.interlacedComboBox->currentIndex() + 1);
 	else

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-29 19:46:39 UTC (rev 6685)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-29 19:48:29 UTC (rev 6686)
@@ -1368,59 +1368,13 @@
           <item>
            <layout class="QGridLayout" name="gridLayout_2">
             <item row="0" column="0">
-             <widget class="QCheckBox" name="interlacedCheckBox">
-              <property name="text">
-               <string>Interlaced:</string>
-              </property>
-             </widget>
-            </item>
-            <item row="0" column="1">
-             <layout class="QHBoxLayout" name="horizontalLayout">
-              <item>
-               <widget class="QComboBox" name="interlacedComboBox">
-                <property name="enabled">
-                 <bool>false</bool>
-                </property>
-                <item>
-                 <property name="text">
-                  <string>Bottom Field First</string>
-                 </property>
-                </item>
-                <item>
-                 <property name="text">
-                  <string>Top Field First</string>
-                 </property>
-                </item>
-                <item>
-                 <property name="text">
-                  <string>Fake Interlaced</string>
-                 </property>
-                </item>
-               </widget>
-              </item>
-              <item>
-               <spacer name="horizontalSpacer_2">
-                <property name="orientation">
-                 <enum>Qt::Horizontal</enum>
-                </property>
-                <property name="sizeHint" stdset="0">
-                 <size>
-                  <width>40</width>
-                  <height>20</height>
-                 </size>
-                </property>
-               </spacer>
-              </item>
-             </layout>
-            </item>
-            <item row="1" column="0">
              <widget class="QCheckBox" name="loopFilterCheckBox">
               <property name="text">
                <string>Loop Filter:</string>
               </property>
              </widget>
             </item>
-            <item row="1" column="1">
+            <item row="0" column="1">
              <layout class="QHBoxLayout">
               <property name="spacing">
                <number>6</number>
@@ -1505,6 +1459,93 @@
               </item>
              </layout>
             </item>
+            <item row="1" column="0">
+             <widget class="QCheckBox" name="openGopCheckBox">
+              <property name="text">
+               <string>Open GOP:</string>
+              </property>
+             </widget>
+            </item>
+            <item row="1" column="1">
+             <layout class="QHBoxLayout" name="horizontalLayout_4">
+              <item>
+               <widget class="QComboBox" name="openGopComboBox">
+                <property name="enabled">
+                 <bool>false</bool>
+                </property>
+                <item>
+                 <property name="text">
+                  <string>Normal Mode</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>Blu-ray Mode</string>
+                 </property>
+                </item>
+               </widget>
+              </item>
+              <item>
+               <spacer name="horizontalSpacer_5">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>40</width>
+                  <height>20</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
+             </layout>
+            </item>
+            <item row="2" column="0">
+             <widget class="QCheckBox" name="interlacedCheckBox">
+              <property name="text">
+               <string>Interlaced:</string>
+              </property>
+             </widget>
+            </item>
+            <item row="2" column="1">
+             <layout class="QHBoxLayout" name="horizontalLayout">
+              <item>
+               <widget class="QComboBox" name="interlacedComboBox">
+                <property name="enabled">
+                 <bool>false</bool>
+                </property>
+                <item>
+                 <property name="text">
+                  <string>Bottom Field First</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>Top Field First</string>
+                 </property>
+                </item>
+                <item>
+                 <property name="text">
+                  <string>Fake Interlaced</string>
+                 </property>
+                </item>
+               </widget>
+              </item>
+              <item>
+               <spacer name="horizontalSpacer_2">
+                <property name="orientation">
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" stdset="0">
+                 <size>
+                  <width>40</width>
+                  <height>20</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
+             </layout>
+            </item>
            </layout>
           </item>
           <item>
@@ -4416,11 +4457,13 @@
   <tabstop>i8x8CheckBox</tabstop>
   <tabstop>i4x4CheckBox</tabstop>
   <tabstop>cabacCheckBox</tabstop>
-  <tabstop>interlacedCheckBox</tabstop>
-  <tabstop>interlacedComboBox</tabstop>
   <tabstop>loopFilterCheckBox</tabstop>
   <tabstop>alphaC0SpinBox</tabstop>
   <tabstop>betaSpinBox</tabstop>
+  <tabstop>openGopCheckBox</tabstop>
+  <tabstop>openGopComboBox</tabstop>
+  <tabstop>interlacedCheckBox</tabstop>
+  <tabstop>interlacedComboBox</tabstop>
   <tabstop>refFramesSpinBox</tabstop>
   <tabstop>maxBFramesSpinBox</tabstop>
   <tabstop>BFrameBiasSpinBox</tabstop>
@@ -4492,6 +4535,9 @@
   <tabstop>chromaSampleSpinBox</tabstop>
   <tabstop>fullRangeSamplesCheckBox</tabstop>
   <tabstop>buttonBox</tabstop>
+  <tabstop>maxCrfCheckBox</tabstop>
+  <tabstop>maxCrfSlider</tabstop>
+  <tabstop>maxCrfSpinBox</tabstop>
  </tabstops>
  <resources/>
  <connections>
@@ -4895,5 +4941,21 @@
     </hint>
    </hints>
   </connection>
+  <connection>
+   <sender>openGopCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>openGopComboBox</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel">
+     <x>70</x>
+     <y>177</y>
+    </hint>
+    <hint type="destinationlabel">
+     <x>151</x>
+     <y>177</y>
+    </hint>
+   </hints>
+  </connection>
  </connections>
 </ui>

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-09-29 19:46:39 UTC (rev 6685)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-09-29 19:48:29 UTC (rev 6686)
@@ -407,6 +407,19 @@
 	_param.b_cabac = cabac;
 }
 
+#if X264_BUILD > 101
+unsigned int x264Options::getOpenGopMode(void)
+{
+	return _param.i_open_gop;
+}
+
+void x264Options::setOpenGopMode(unsigned int openGopMode)
+{
+	if (openGopMode < 3)
+		_param.i_open_gop = openGopMode;
+}
+#endif
+
 unsigned int x264Options::getInterlaced(void)
 {
 #if X264_BUILD > 88
@@ -1260,6 +1273,21 @@
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"loopFilterBeta", number2String(xmlBuffer, bufferSize, getLoopFilterBeta()));
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"cabac", boolean2String(xmlBuffer, bufferSize, getCabac()));
 
+	switch (getOpenGopMode())
+	{
+		case 1:
+			strcpy((char*)xmlBuffer, "normal");
+			break;
+		case 2:
+			strcpy((char*)xmlBuffer, "bluray");
+			break;
+		default:
+			strcpy((char*)xmlBuffer, "disabled");
+			break;
+	}
+
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"openGop", xmlBuffer);
+
 	switch (getInterlaced())
 	{
 		case 1:
@@ -1572,6 +1600,19 @@
 				setLoopFilterBeta(atoi(content));
 			else if (strcmp((char*)xmlChild->name, "cabac") == 0)
 				setCabac(string2Boolean(content));
+#if X264_BUILD > 101
+			else if (strcmp((char*)xmlChild->name, "openGop") == 0)
+			{
+				int openGop = 0;
+
+				if (strcmp(content, "normal") == 0)
+					openGop = 1;
+				else if (strcmp(content, "bluray") == 0)
+					openGop = 2;
+
+				setOpenGopMode(openGop);
+			}
+#endif
 			else if (strcmp((char*)xmlChild->name, "interlaced") == 0)
 			{
 				int interlaced = 0;

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.h	2010-09-29 19:46:39 UTC (rev 6685)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.h	2010-09-29 19:48:29 UTC (rev 6686)
@@ -149,6 +149,11 @@
 	bool getCabac(void);
 	void setCabac(bool cabac);
 
+#if X264_BUILD > 101
+	unsigned int getOpenGopMode(void);
+	void setOpenGopMode(unsigned int openGopMode);
+#endif
+
 	unsigned int getInterlaced(void);
 	void setInterlaced(unsigned int interlaced);
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2010-09-29 19:46:39 UTC (rev 6685)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2010-09-29 19:48:29 UTC (rev 6686)
@@ -247,20 +247,29 @@
                 </xs:simpleType>
               </xs:element>
               <xs:element name="cabac" type="xs:boolean" minOccurs="0"/>
+			  <xs:element name="openGop" minOccurs="0">
+				<xs:simpleType>
+				  <xs:restriction base="xs:string">
+					<xs:enumeration value="disabled"/>
+					<xs:enumeration value="normal"/>
+					<xs:enumeration value="bluray"/>
+				  </xs:restriction>
+				</xs:simpleType>
+			  </xs:element>
 			  <xs:element name="interlaced" minOccurs="0">
-				  <xs:simpleType>
-					  <xs:restriction base="xs:string">
-						  <xs:enumeration value="disabled"/>
-						  <xs:enumeration value="bff"/>
-						  <xs:enumeration value="tff"/>
-						  <xs:enumeration value="fake"/>
+				<xs:simpleType>
+				  <xs:restriction base="xs:string">
+					<xs:enumeration value="disabled"/>
+					<xs:enumeration value="bff"/>
+					<xs:enumeration value="tff"/>
+					<xs:enumeration value="fake"/>
 
-						  <!-- boolean values deprecated core 89 -->
-						  <xs:enumeration value="false"/>
-						  <xs:enumeration value="true"/>
-					  </xs:restriction>
-				  </xs:simpleType>
-			  </xs:element>				
+					<!-- boolean values deprecated core 89 -->
+					<xs:enumeration value="false"/>
+					<xs:enumeration value="true"/>
+				  </xs:restriction>
+				</xs:simpleType>
+			  </xs:element>
               <xs:element name="constrainedIntraPrediction" type="xs:boolean" minOccurs="0"/>
               <xs:element name="cqmPreset" minOccurs="0">
                 <xs:simpleType>



From gruntster at mail.berlios.de  Wed Sep 29 22:04:31 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 29 Sep 2010 22:04:31 +0200
Subject: [Avidemux-svn-commit] r6687 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264:
	. qt4
Message-ID: <20100929200431.52AAB481024@sheep.berlios.de>

Author: gruntster
Date: 2010-09-29 22:04:31 +0200 (Wed, 29 Sep 2010)
New Revision: 6687

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
Log:
[x264] support infinite keyint

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-29 19:48:29 UTC (rev 6686)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-09-29 20:04:31 UTC (rev 6687)
@@ -1847,9 +1847,6 @@
               </item>
               <item>
                <widget class="QSpinBox" name="maxGopSizeSpinBox">
-                <property name="minimum">
-                 <number>1</number>
-                </property>
                 <property name="maximum">
                  <number>1000</number>
                 </property>

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-09-29 19:48:29 UTC (rev 6686)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-09-29 20:04:31 UTC (rev 6687)
@@ -291,11 +291,21 @@
 
 unsigned int x264Options::getGopMaximumSize(void)
 {
+#if X264_BUILD > 101
+	if (_param.i_keyint_max == X264_KEYINT_MAX_INFINITE)
+		return 0;
+	else
+#endif
 	return _param.i_keyint_max;
 }
 
 void x264Options::setGopMaximumSize(unsigned int gopSize)
 {
+#if X264_BUILD > 101
+	if (gopSize == 0)
+		_param.i_keyint_max = X264_KEYINT_MAX_INFINITE;
+	else
+#endif
 	if (gopSize <= 1000)
 		_param.i_keyint_max = gopSize;
 }



From gruntster at mail.berlios.de  Wed Sep 29 22:09:26 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 29 Sep 2010 22:09:26 +0200
Subject: [Avidemux-svn-commit] r6688 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264
Message-ID: <20100929200926.24607481024@sheep.berlios.de>

Author: gruntster
Date: 2010-09-29 22:09:25 +0200 (Wed, 29 Sep 2010)
New Revision: 6688

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
Log:
[x264] build fix

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-09-29 20:04:31 UTC (rev 6687)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-09-29 20:09:25 UTC (rev 6688)
@@ -1283,6 +1283,7 @@
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"loopFilterBeta", number2String(xmlBuffer, bufferSize, getLoopFilterBeta()));
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"cabac", boolean2String(xmlBuffer, bufferSize, getCabac()));
 
+#if X264_BUILD > 101
 	switch (getOpenGopMode())
 	{
 		case 1:
@@ -1297,6 +1298,7 @@
 	}
 
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"openGop", xmlBuffer);
+#endif
 
 	switch (getInterlaced())
 	{



From gruntster at mail.berlios.de  Wed Sep 29 22:20:48 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 29 Sep 2010 22:20:48 +0200
Subject: [Avidemux-svn-commit] r6689 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4
Message-ID: <20100929202048.A26FF481024@sheep.berlios.de>

Author: gruntster
Date: 2010-09-29 22:20:48 +0200 (Wed, 29 Sep 2010)
New Revision: 6689

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.h
Log:
[x264] permit trellis without cabac

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-09-29 20:09:25 UTC (rev 6688)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-09-29 20:20:48 UTC (rev 6689)
@@ -96,7 +96,6 @@
 
 	// Frame tab
 	connect(ui.loopFilterCheckBox, SIGNAL(toggled(bool)), this, SLOT(loopFilterCheckBox_toggled(bool)));
-	connect(ui.cabacCheckBox, SIGNAL(toggled(bool)), this, SLOT(cabacCheckBox_toggled(bool)));
 
 #if X264_BUILD < 102
 	ui.openGopCheckBox->setVisible(false);
@@ -112,7 +111,6 @@
 #endif
 
 	// Analysis tab
-	connect(ui.trellisCheckBox, SIGNAL(toggled(bool)), this, SLOT(trellisCheckBox_toggled(bool)));
 	connect(ui.matrixCustomEditButton, SIGNAL(pressed()), this, SLOT(matrixCustomEditButton_pressed()));
 
 	// Quantiser tab
@@ -494,29 +492,6 @@
 	}
 }
 
-void x264ConfigDialog::cabacCheckBox_toggled(bool checked)
-{
-	if (!disableGenericSlots && !checked && ui.trellisCheckBox->isChecked())
-	{
-		if (GUI_Question(tr("Trellis optimisation isn't possible without CABAC coding enabled.  Trellis optimisation will automatically be disabled.\n\nDo you wish to continue?").toUtf8().constData()))
-			ui.trellisCheckBox->setChecked(false);
-		else
-			ui.cabacCheckBox->setChecked(true);
-	}
-}
-
-// Analysis tab
-void x264ConfigDialog::trellisCheckBox_toggled(bool checked)
-{
-	if (!disableGenericSlots && checked && !ui.cabacCheckBox->isChecked())
-	{
-		if (GUI_Question(tr("Trellis optimisation requires CABAC coding to be enabled.  CABAC coding will automatically be enabled.\n\nDo you wish to continue?").toUtf8().constData()))
-			ui.cabacCheckBox->setChecked(true);
-		else
-			ui.trellisCheckBox->setChecked(false);
-	}
-}
-
 void x264ConfigDialog::matrixCustomEditButton_pressed()
 {
 	x264CustomMatrixDialog dialog(this, intra4x4Luma, intraChroma, inter4x4Luma, interChroma, intra8x8Luma, inter8x8Luma);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.h	2010-09-29 20:09:25 UTC (rev 6688)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.h	2010-09-29 20:20:48 UTC (rev 6689)
@@ -84,10 +84,8 @@
 
 	// Frame tab
 	void loopFilterCheckBox_toggled(bool checked);
-	void cabacCheckBox_toggled(bool checked);
 
 	// Analysis tab
-	void trellisCheckBox_toggled(bool checked);
 	void matrixCustomEditButton_pressed();
 
 	// Quantiser tab



From mean at mail.berlios.de  Thu Sep 30 07:31:10 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 30 Sep 2010 07:31:10 +0200
Subject: [Avidemux-svn-commit] r6690 - in
	branches/avidemux_2.6_branch_mean/avidemux: common/ADM_render
	qt4/ADM_UIs/src
Message-ID: <20100930053110.79777481009@sheep.berlios.de>

Author: mean
Date: 2010-09-30 07:31:10 +0200 (Thu, 30 Sep 2010)
New Revision: 6690

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_simpleRender.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_flyDialogQt4.cpp
Log:
[color] Invert Qt4 color, might break win32 colors

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_simpleRender.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_simpleRender.cpp	2010-09-29 20:20:48 UTC (rev 6689)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_simpleRender.cpp	2010-09-30 05:31:10 UTC (rev 6690)
@@ -64,7 +64,7 @@
     MUI_rgbDraw(MUI_getDrawWidget(),displayWidth,displayHeight,videoBuffer);
     return true;
 }
-#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
+#if !(ADM_UI_TYPE_BUILD == ADM_UI_QT4)
     #define IVERT ADM_COLOR_BGR32A
 #else
     #define IVERT ADM_COLOR_RGB32A

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_flyDialogQt4.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_flyDialogQt4.cpp	2010-09-29 20:20:48 UTC (rev 6689)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_flyDialogQt4.cpp	2010-09-30 05:31:10 UTC (rev 6690)
@@ -148,7 +148,7 @@
 */
 bool  ADM_flyDialogQt4::isRgbInverted(void)
 {
-  return 1; 
+  return 0; 
 }
 
 



From mean at mail.berlios.de  Thu Sep 30 20:03:53 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 30 Sep 2010 20:03:53 +0200
Subject: [Avidemux-svn-commit] r6691 - in branches/avidemux_2.6_branch_mean:
	avidemux/common/ADM_commonUI avidemux_core/ADM_coreImage/src
	avidemux_core/ADM_coreVideoCodec/src
Message-ID: <20100930180353.530F8481013@sheep.berlios.de>

Author: mean
Date: 2010-09-30 20:03:52 +0200 (Thu, 30 Sep 2010)
New Revision: 6691

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageSave.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
Log:
[color] (bad) fix for inverted RGB management

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h	2010-09-30 05:31:10 UTC (rev 6690)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h	2010-09-30 18:03:52 UTC (rev 6691)
@@ -31,6 +31,9 @@
             {MENU_ACTION,"Open",    NULL,ACT_OPEN_VIDEO,       MKICON(fileopen), "Ctrl+O"},
             {MENU_ACTION,"Append",  NULL,ACT_APPEND_VIDEO     ,NULL,             "Ctrl+A"},
             {MENU_ACTION,"Save",    NULL,ACT_SAVE_VIDEO       ,MKICON(filesaveas),"Ctrl+S"},
+            {MENU_SUBMENU,"Save as Image",    NULL,ACT_DUMMY    ,NULL,NULL},
+            {MENU_SUBACTION,"Save as BMP",    NULL,ACT_SAVE_BMP ,NULL,NULL},
+            {MENU_SUBACTION,"Save as Jpeg",   NULL,ACT_SAVE_JPG ,NULL,NULL},
             {MENU_ACTION,"Close",   NULL,ACT_CLOSE          ,NULL,                "Ctrl+W"},
             {MENU_SEPARATOR,NULL,NULL,ACT_DUMMY             ,NULL,NULL},
             {MENU_SUBMENU,"Js Project",NULL,ACT_DUMMY       ,NULL,NULL},

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp	2010-09-30 05:31:10 UTC (rev 6690)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp	2010-09-30 18:03:52 UTC (rev 6691)
@@ -91,7 +91,7 @@
     case ADM_COLOR_RGB32A: return PIX_FMT_RGBA;
     case ADM_COLOR_BGR32A: return PIX_FMT_RGBA; // Faster that way...PIX_FMT_BGR32;
     case ADM_COLOR_RGB24: return PIX_FMT_RGB24;
-    case ADM_COLOR_BGR24: return PIX_FMT_RGB24;
+    case ADM_COLOR_BGR24: return PIX_FMT_BGR24;
     default : ADM_assert(0); 
   }
   return PIX_FMT_YUV420P;
@@ -333,11 +333,12 @@
     {
              swapRGB32(dstWidth,dstHeight,to);
     }
+/*
     if(toColor==ADM_COLOR_BGR24)
     {
              swapRGB24(dstWidth,dstHeight,to);
     }
-
+*/
     return true;
 }
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageSave.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageSave.cpp	2010-09-30 05:31:10 UTC (rev 6690)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageSave.cpp	2010-09-30 18:03:52 UTC (rev 6691)
@@ -80,7 +80,7 @@
 //            ADM_dealloc(out);
             return 0;
         }
-        ADMColorScalerSimple converter(bmph.biWidth, bmph.biHeight, ADM_COLOR_YV12,ADM_COLOR_BGR24);
+        ADMColorScalerSimple converter(bmph.biWidth, bmph.biHeight, ADM_COLOR_YV12,ADM_COLOR_RGB24);
         converter.convertImage(this,out);
         uint32_t ww=bmph.biWidth;
         uint32_t hh=bmph.biHeight;

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2010-09-30 05:31:10 UTC (rev 6690)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2010-09-30 18:03:52 UTC (rev 6691)
@@ -444,7 +444,7 @@
       out->_colorspace = ADM_COLOR_YV12;
       break;
 	case PIX_FMT_RGB24:
-	  out->_colorspace = ADM_COLOR_RGB24;
+	  out->_colorspace = ADM_COLOR_BGR24;
 	  break;
     case PIX_FMT_BGRA:
       out->_colorspace = ADM_COLOR_BGR32A;



