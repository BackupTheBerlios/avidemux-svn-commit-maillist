<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r4948 -	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2009-June/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4948%20-%0A%09branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer&In-Reply-To=%3C200906220530.n5M5UsVP006360%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002162.html">
   <LINK REL="Next"  HREF="002164.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r4948 -	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4948%20-%0A%09branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer&In-Reply-To=%3C200906220530.n5M5UsVP006360%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r4948 -	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer">mean at mail.berlios.de
       </A><BR>
    <I>Mon Jun 22 07:30:54 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002162.html">[Avidemux-svn-commit] r4947 -	branches/avidemux_2.6_branch_mean/cmake
</A></li>
        <LI>Next message: <A HREF="002164.html">[Avidemux-svn-commit] r4949 - in branches/avidemux_2.6_branch_mean:	avidemux avidemux/gtk avidemux/qt4 avidemux_core
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2163">[ date ]</a>
              <a href="thread.html#2163">[ thread ]</a>
              <a href="subject.html#2163">[ subject ]</a>
              <a href="author.html#2163">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2009-06-22 07:30:48 +0200 (Mon, 22 Jun 2009)
New Revision: 4948

Removed:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer_h264.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer_internal.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer_mpeg2.cpp
Log:
[dir] Remove no longer used mpegIndexer

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/CMakeLists.txt	2009-06-22 05:30:44 UTC (rev 4947)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/CMakeLists.txt	2009-06-22 05:30:48 UTC (rev 4948)
@@ -1,7 +0,0 @@
-SET(ADM_mpegIndexer_SRCS
-        dmx_indexer.cpp
-        dmx_indexer_h264.cpp
-        dmx_indexer_mpeg2.cpp
-)
-ADD_ADM_LIB_ALL_TARGETS(ADM_mpegIndexer ${ADM_mpegIndexer_SRCS})
-INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/../ADM_coreDemuxerMpeg/include)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer.cpp	2009-06-22 05:30:44 UTC (rev 4947)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer.cpp	2009-06-22 05:30:48 UTC (rev 4948)
@@ -1,352 +0,0 @@
-/***************************************************************************
-                        2nd gen indexer
-
-
-    copyright            : (C) 2005 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-
-#include &quot;ADM_default.h&quot;
-#include &quot;prefs.h&quot;
-#include &quot;ADM_assert.h&quot;
-
-
-#include &quot;DIA_coreToolkit.h&quot;
-#include &quot;DIA_fileSel.h&quot;
-#include &quot;ADM_quota.h&quot;
-#include &quot;ADM_commonUI/DIA_idx_pg.h&quot;
-#include &quot;avidemutils.h&quot;
-
-
-#include &quot;ADM_debugID.h&quot;
-#define MODULE_NAME MODULE_MPEG
-#include &quot;ADM_debug.h&quot;
-#include &quot;dmx_demuxerEs.h&quot;
-#include &quot;dmx_demuxerPS.h&quot;
-#include &quot;dmx_demuxerTS.h&quot;
-#include &quot;dmx_demuxerMSDVR.h&quot;
-#include &quot;dmx_identify.h&quot;
-
-#define MIN_DELTA_PTS 150 // autofix in ms
-
-#include &quot;dmx_indexer_internal.h&quot;
-
-
-
-
-static uint32_t computeTimeDifference(TimeStamp *f,TimeStamp *l);
-
-uint8_t dmx_indexer(const char *mpeg,char *file);
-
-/**
-        \fn    dmx_indexer
-        \brief Create index file
-        @param mpeg Name of the file to index
-        @param file Name of the index file to create
-        @param preferedAudio Default audio track
-        @param nbTracks # of tracks, including video
-        @param tracks track descriptor
-        @return 1 on success, 0 on failure
-
-    The incoming file can be mpeg PS/TS/ES or ASF.
-    The payload can be mostly mpeg2, with some work done to support later mpeg4/H264 in TS mostly
-
-*/
-uint8_t dmx_indexer(const char *mpeg,const char *file,uint32_t preferedAudio,uint8_t autosync,uint32_t nbTracks,MPEG_TRACK *tracks)
-{
-        DIA_progressIndexing *work;
-        dmx_demuxer *demuxer;
-
-        char *realname=ADM_PathCanonize(mpeg);
-        FILE *out;
-        DMX_TYPE mpegType;
-        uint8_t  mpegTypeChar;
-        uint32_t multi=0;
-
-        dmx_payloadType payloadType=DMX_PAYLOAD_MPEG2;
-
-
-
-        mpegType=dmxIdentify(realname);
-
-        if(mpegType==DMX_MPG_UNKNOWN)
-        {
-                delete [] realname;
-                return 0;
-        }
-
-
-
-        switch(mpegType)
-        {
-               case DMX_MPG_MSDVR:
-                                {
-                                  dmx_demuxerMSDVR *dmx;
-                                  dmx=new dmx_demuxerMSDVR(nbTracks,tracks,0);
-                                  demuxer=dmx;
-                                  mpegTypeChar='M';
-                                  break;
-                                }
-                case DMX_MPG_TS:
-                case DMX_MPG_TS2:
-                                {
-                                dmx_demuxerTS *dmx;
-                                dmx=new dmx_demuxerTS(nbTracks,tracks,0,mpegType);
-                                demuxer=dmx;
-                                switch(mpegType)
-                                {
-                                  case DMX_MPG_TS :mpegTypeChar='T';break;
-                                  case DMX_MPG_TS2 :mpegTypeChar='S';break;
-                                  default: ADM_assert(0);
-                                }
-                                switch(tracks[0].streamType)
-                                  {
-                                    case ADM_STREAM_H264:       payloadType=DMX_PAYLOAD_H264;break;
-                                    case ADM_STREAM_MPEG4:      payloadType=DMX_PAYLOAD_MPEG4;break;
-                                    case ADM_STREAM_MPEG_VIDEO: payloadType=DMX_PAYLOAD_MPEG2;break;
-                                  default: ADM_assert(0);
-
-                                  }
-                                break;
-                                }
-                case DMX_MPG_ES:
-                                demuxer=new dmx_demuxerES;
-                                mpegTypeChar='E';
-                                break;
-                case DMX_MPG_H264_ES:
-                                payloadType=DMX_PAYLOAD_H264;
-                                demuxer=new dmx_demuxerES;
-                                mpegTypeChar='E';
-                                break;
-                case DMX_MPG_PS:
-                		{
-                		dmx_demuxerPS *dmx;
-                                fileParser    *fp;
-                                FP_TYPE       type=FP_PROBE;
-                                        fp=new fileParser;
-                                        fp-&gt;open(realname,&amp;type);
-                                        delete fp;
-                                        if(type==FP_APPEND)
-                                        {
-                                          if(GUI_Question(QT_TR_NOOP(&quot;There is several mpeg file, append them ?&quot;)))
-                                                        multi=1;
-                                        }
-                                        dmx=new dmx_demuxerPS(nbTracks,tracks,multi);
-                                        demuxer=dmx;
-                                        mpegTypeChar='P';
-                            }
-                                break;
-                default : ADM_assert(0);
-
-        }
-
-        demuxer-&gt;open(realname);
-
-        out=qfopen(file,&quot;wt&quot;);
-        if(!out)
-        {
-                        printf(&quot;\n Error : cannot open index !&quot;);
-                        delete demuxer;
-                        delete [] realname;
-                        return 0;
-        }
-        qfprintf(out,&quot;ADMY0003\n&quot;);
-        qfprintf(out,&quot;Type     : %c\n&quot;,mpegTypeChar); // ES for now
-        qfprintf(out,&quot;File     : %s\n&quot;,realname);
-        qfprintf(out,&quot;Append   : %d\n&quot;,multi);
-        qfprintf(out,&quot;Image    : %c\n&quot;,'P'); // Progressive
-        qfprintf(out,&quot;Picture  : %04lu x %04lu %05lu fps\n&quot;,0,0,0); // width...
-        qfprintf(out,&quot;Payload  : %c%c%c%c\n&quot;,'M','P','E','G'); // width...
-        qfprintf(out,&quot;Nb Gop   : %08lu \n&quot;,0); // width...
-        qfprintf(out,&quot;Nb Images: %010lu \n&quot;,0); // width...
-        qfprintf(out,&quot;Nb Audio : %02lu\n&quot;,nbTracks-1);
-        qfprintf(out,&quot;Main aud : %02lu\n&quot;,preferedAudio);
-        qfprintf(out,&quot;Streams  : &quot;);
-        for(int s=0;s&lt;nbTracks;s++)
-        {
-                if(!s){
-			qfprintf(out,&quot;V%04x:%04x &quot;,tracks[0].pid,tracks[0].pes);
-		}else{
-			qfprintf(out,&quot;A%04x:%04x &quot;,tracks[s].pid,tracks[s].pes);
-		}
-        }
-        qfprintf(out,&quot;\n&quot;);
-        qfprintf(out,&quot;# NGop NImg nbImg type:abs:rel:size ...\n&quot;);
-
-
-        uint8_t  grabbing=0,seq_found=0;
-
-        uint32_t total_frame=0,val;
-
-		uint32_t originalPriority = getpriority(PRIO_PROCESS, 0);
-		uint32_t priorityLevel;
-
-		prefs-&gt;get(PRIORITY_INDEXING,&amp;priorityLevel);
-		setpriority(PRIO_PROCESS, 0, ADM_getNiceValue(priorityLevel));
-
-        work=new DIA_progressIndexing(mpeg);
-
-        printf(&quot;*********Indexing started (%d audio tracks)***********\n&quot;,nbTracks);
-        dmx_runData run;
-
-        memset(&amp;run,0,sizeof(dmx_runData));
-
-        run.totalFileSize=demuxer-&gt;getSize();
-        run.demuxer=demuxer;
-        run.work=work;
-        run.nbTrack=nbTracks;
-        run.fd=out;
-
-        dmx_videoIndexer *idxer=NULL;
-
-        switch(payloadType)
-        {
-          case DMX_PAYLOAD_MPEG2:
-                  {
-                            idxer=new dmx_videoIndexerMpeg2(&amp;run);
-                            break;
-                  }
-          case DMX_PAYLOAD_MPEG4:ADM_assert(0);
-          case DMX_PAYLOAD_H264:
-                            idxer=new dmx_videoIndexerH264(&amp;run);
-                            break;
-          default: ADM_assert(0);
-        }
-
-        idxer-&gt;run();
-        idxer-&gt;cleanup();
-
-        delete idxer;
-        idxer=NULL;
-
-
-        printf(&quot;*********Indexing Ended (%d audio tracks)***********\n&quot;,nbTracks);
-
-         switch(run.imageAR)
-         {
-           case 1: 	qfprintf(out,&quot;# Video Aspect Ratio : %s\n&quot;, &quot;1:1&quot; );break;
-           case 2: 	qfprintf(out,&quot;# Video Aspect Ratio : %s\n&quot;, &quot;4:3&quot; );break;
-           case 3: 	qfprintf(out,&quot;# Video Aspect Ratio : %s\n&quot;, &quot;16:9&quot; );break;
-           default:
-              printf(&quot;imageAR=%u\n&quot;,run.imageAR);
-              GUI_Error_HIG(QT_TR_NOOP(&quot;Can't determine aspect ratio&quot;),NULL);
-	}
-
-        /* Now update......... */
-          fseeko(out,0,SEEK_SET);
-        // Update if needed
-        uint32_t compfps,delta=computeTimeDifference(&amp;(run.firstStamp),&amp;(run.lastStamp));
-
-        delta=delta/1000; // in second
-        if(delta)
-        {
-                 compfps= (1000*run.nbImage)/delta;    // 3 Million images should be enough, no overflow
-        }
-        else
-        {
-                compfps=run.imageFPS;
-        }
-
-        // Detect film (i.e. NTSC with computed fps close to 24)
-        if(run.imageFPS==29970 || run.imageFPS==30000)
-        {
-                if(compfps&gt;23800 &amp;&amp; compfps &lt; 24200) run.imageFPS=23976;
-        }
-        // Detect interlaced vs progressive
-        // If field encoded, the average fps is about twice as theoritical fps
-        char type='P';
-        float err;
-
-        err=run.imageFPS*2;
-        err-=compfps;
-        err*=100;
-        err/=run.imageFPS*2;
-        if(err&lt;0) err=-err;
-        printf(&quot;%&quot;LU&quot; :%&quot;LU&quot; / %&quot;LU&quot; , %f\n&quot;,run.imageFPS,run.imageFPS*2,compfps,err);
-
-        if(err&lt;10)
-        {
-                type='I';
-                printf(&quot;Seems to be field encoded\n&quot;);
-        }
-        else
-        {
-                printf(&quot;Seems to be frame encoded\n&quot;);
-        }
-
-        // Now dump the delta PTS
-        // *****************Update header*************
-        qfprintf(out,&quot;ADMY0003\n&quot;);
-        qfprintf(out,&quot;Type     : %c\n&quot;,mpegTypeChar); // ES for now
-        qfprintf(out,&quot;File     : %s\n&quot;,realname);
-        qfprintf(out,&quot;Append   : %d\n&quot;,multi);
-        qfprintf(out,&quot;Image    : %c\n&quot;,type); // Progressive
-        qfprintf(out,&quot;Picture  : %04lu x %04lu %05lu fps\n&quot;,run.imageW,run.imageH,run.imageFPS); // width...
-        switch(payloadType)
-        {
-          case DMX_PAYLOAD_MPEG2:
-                            qfprintf(out,&quot;Payload  : MPEG\n&quot;); // MPEG,MP_4,H264
-                            break;
-          case DMX_PAYLOAD_MPEG4:
-                            qfprintf(out,&quot;Payload  : MP_4\n&quot;); // MPEG,MP_4,H264
-                            break;
-          case DMX_PAYLOAD_H264:
-                            qfprintf(out,&quot;Payload  : H264\n&quot;); // MPEG,MP_4,H264
-                            break;
-          default: ADM_assert(0);
-        }
-        qfprintf(out,&quot;Nb Gop   : %08lu \n&quot;,run.nbGop); // width...
-        qfprintf(out,&quot;Nb Images: %010lu \n&quot;,run.nbImage); // width...
-
-        qfclose(out);
-        delete work;
-
-        printf(&quot;*********Indexing stopped***********\n&quot;);
-        printf(&quot;Found       :%&quot;LU&quot; gop\n&quot;,run.nbGop);
-        printf(&quot;Found       :%&quot;LU&quot; image\n&quot;,run.nbImage);
-        printf(&quot;Average fps :%&quot;LU&quot; /1000 fps\n&quot;,compfps);
-
-          delete demuxer;
-          delete [] realname;
-
-		  setpriority(PRIO_PROCESS, 0, originalPriority);
-
-          return 1;
-}
-uint32_t computeTimeDifference(TimeStamp *f,TimeStamp *l)
-{
-        uint32_t h,m,s,ms,r=0,result=0;
-#define DOIT(x,next) if(l-&gt;x &lt; f-&gt;x) \
-                        { \
-                                r=(next-(f-&gt;x-l-&gt;x));\
-                                result-=1; \
-                        }\
-                         else r=(l-&gt;x-f-&gt;x);\
-                        result=result*next+r;
-
-#define PRINT(z,x) printf(#z&quot;%02d:%02d:%02d\n&quot;,x-&gt;hh,x-&gt;mm,x-&gt;ss,x-&gt;ff);
-        DOIT(hh,0);
-        DOIT(mm,60);
-        DOIT(ss,60);
-        DOIT(ff,1000);
-#if 0
-        PRINT(first,f);
-        PRINT(last,l);
-
-#endif
-        printf(&quot;Time difference:%lu s\n&quot;,result/1000);
-        return result;
-
-}
-
-//

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer_h264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer_h264.cpp	2009-06-22 05:30:44 UTC (rev 4947)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer_h264.cpp	2009-06-22 05:30:48 UTC (rev 4948)
@@ -1,385 +0,0 @@
-/***************************************************************************
-                        2nd gen indexer                                                 
-                             
-    
-    copyright            : (C) 2005 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-
-#include &quot;ADM_default.h&quot;
-#include &quot;ADM_assert.h&quot;
-
-#include &quot;DIA_fileSel.h&quot;
-#include &quot;ADM_quota.h&quot;
-#include &quot;ADM_commonUI/DIA_idx_pg.h&quot;
-
-
-
-#include &quot;ADM_debugID.h&quot;
-#define MODULE_NAME MODULE_MPEG
-#include &quot;ADM_debug.h&quot;
-#include &quot;dmx_demuxerEs.h&quot;
-#include &quot;dmx_demuxerPS.h&quot;
-#include &quot;dmx_demuxerTS.h&quot;
-#include &quot;dmx_demuxerMSDVR.h&quot;
-#include &quot;dmx_identify.h&quot;
-
-#define MIN_DELTA_PTS 150 // autofix in ms
-
-#include &quot;dmx_indexer_internal.h&quot;
-
-#include &quot;ADM_h264_tag.h&quot;
-#undef aprintf
-#define aprintf printf
-static const char Type[5]={'X','I','P','B','P'};
-
-
-extern uint8_t extractSPSInfo(uint8_t *data, uint32_t len,uint32_t *wwidth,uint32_t *hheight, uint32_t *fps1000);
-
-dmx_videoIndexerH264::dmx_videoIndexerH264(dmx_runData *run) : dmx_videoIndexer(run)
-{
-  _frames=new IndFrame[MAX_PUSHED];
-  firstPicPTS=ADM_NO_PTS;
-  seq_found=0;
-  grabbing=0;
-  
-}
-dmx_videoIndexerH264::~dmx_videoIndexerH264()
-{
-          if(_frames) delete [] _frames;
-          _frames=NULL;
-}
-/**
-      \fn cleanup
-      \brief do cleanup and purge non processed data at the end of the mpeg2 stream
-*/
-void dmx_videoIndexerH264::cleanup(void)
-{
-  uint64_t lastAbs,lastRel;
-          _run-&gt;demuxer-&gt;getPos(&amp;lastAbs,&amp;lastRel);
-          if(_run-&gt;nbPushed)  gopDump(lastAbs,lastRel);
-          dumpPts(firstPicPTS); 
-          
-}
-
-/**
-      \fn run 
-      \brief main indexing loop for mpeg2 payload
-*/
-
-
-// 12 : Filler
-uint8_t   dmx_videoIndexerH264::run  (void)
-{
-dmx_demuxer *demuxer=_run-&gt;demuxer;
-uint64_t syncAbs,syncRel;
-uint8_t streamid;   
-uint32_t temporal_ref,ftype,val;
-uint64_t pts,dts;
-uint8_t pic_started=0;
-      
-      
-#if 0
-    FILE *f=fopen(&quot;/tmp/foo.h264&quot;,&quot;wt&quot;);
-    uint8_t buffer[80];
-    ADM_assert(f);
-    for(int i=0;i&lt;1024*1024*2;i++)
-    {
-       _run-&gt;demuxer-&gt;read(buffer,60);
-        fwrite(buffer,60,1,f);
-    }
-    fclose(f);
-    exit(0);  
-
-#endif
-      
-      printf(&quot;Starting H264 indexer\n&quot;);
-      while(1)
-      {
-
-              if(!demuxer-&gt;syncH264(&amp;streamid,&amp;syncAbs,&amp;syncRel,&amp;pts,&amp;dts)) return 0;
-              streamid=streamid &amp; 0x1f;
-              //if(streamid&gt;31) continue;
-             // printf(&quot;Found NAL : %d 0x %x\n&quot;,streamid,streamid);
-#define T(x) case NAL_##x: printf(#x&quot; found\n&quot;);break;
-#if 1
-                switch(streamid)
-                {
-                    T(NON_IDR);
-                    T(IDR);
-                    T(SPS);
-                    T(PPS);
-                    T(SEI);
-                    T(AU_DELIMITER);
-                    T(FILLER);
-                  default :printf(&quot;%02x ?\n&quot;,streamid);
-                }
-#endif
-                 if((_run-&gt;totalFileSize&gt;&gt;16)&gt;50)
-              {
-                    _run-&gt;work-&gt;update(syncAbs&gt;&gt;16,_run-&gt;totalFileSize&gt;&gt;16,
-                               _run-&gt;nbImage,_run-&gt;lastStamp.hh,_run-&gt;lastStamp.mm,_run-&gt;lastStamp.ss);
-              }else
-              {
-                    _run-&gt;work-&gt;update(syncAbs,_run-&gt;totalFileSize,_run-&gt;nbImage,
-                            _run-&gt;lastStamp.hh,_run-&gt;lastStamp.mm,_run-&gt;lastStamp.ss);
-              }
-              /* Till we have a SPS no need to continue */
-              if(!seq_found &amp;&amp; streamid!=NAL_SPS) continue;
-              if(!seq_found)
-              {
-                    // Our firt frame is here
-                    // Important to initialize the mpeg decoder !
-                    _run-&gt;imageAR = 1;	// 1:1 to suppress warning
-
-                      uint8_t buffer[60] ; // should be enough
-                      uint64_t xA,xR;
-                      _run-&gt;demuxer-&gt;getPos(&amp;xA,&amp;xR);
-                      _run-&gt;demuxer-&gt;read(buffer,60);
-                      if(extractSPSInfo(buffer,60,&amp;( _run-&gt;imageW),&amp;( _run-&gt;imageH),&amp;(_run-&gt;imageFPS)))
-                      {
-                            seq_found=1;
-                            startFrame(1,syncAbs,syncRel);
-                           _run-&gt;demuxer-&gt;setPos(xA,xR);
-                           _run-&gt;demuxer-&gt;stamp();
-                      }else
-                        _run-&gt;demuxer-&gt;setPos(xA,xR);
-                      
-                      grabbing=1;
-                      continue;
-              }
-              
-              // Ignore multiple chunk of the same pic
-              
-              if((streamid==NAL_NON_IDR || streamid==NAL_IDR)&amp;&amp;pic_started) 
-              {
-                aprintf(&quot;Still capturing, ignore\n&quot;);
-                continue;
-              }
-              if(_run-&gt;work-&gt;isAborted()) return 0;
-              
-              switch(streamid)
-                      {
-                      case NAL_AU_DELIMITER:
-                              if(pic_started)
-                                  pic_started=0;
-                              grabbing=0;
-                              break;
-                      case NAL_SPS: // 
-                              pic_started=0;
-                              grabbing=1;
-                              aprintf(&quot;Sps %d\n&quot;,_run-&gt;nbGop);
-                              gopDump(syncAbs,syncRel);
-                              break;
-                      case NAL_IDR: // IDR
-                              aprintf(&quot;IDR %d\n&quot;,_run-&gt;nbGop);
-                              uint32_t gop;   
-                              if(grabbing) 
-                              {
-                                aprintf(&quot;Grabbing, updating type\n&quot;);
-                                updateFrameType(1);
-                                pic_started=1;
-                                grabbing=0;
-                                continue;
-                              }
-                              aprintf(&quot;Dumping gop-\n&quot;);
-                              gopDump(syncAbs,syncRel);
-                              aprintf(&quot;New Frame-\n&quot;);
-                              updateFrameType(1);
-                              if(firstPicPTS==ADM_NO_PTS &amp;&amp; pts!=ADM_NO_PTS)
-                                      firstPicPTS=pts;
-                              _run-&gt;totalFrame++;
-                              pic_started=1;
-                              break;
-                      case NAL_NON_IDR : // picture
-                              
-                              if(grabbing) 
-                              {
-                                updateFrameType(2);
-                                pic_started=1;
-                                grabbing=0;
-                                aprintf(&quot;Grabbing, updating type-2-\n&quot;);
-                                continue;
-                              }
-                              _run-&gt;totalFrame++;
-                              if(_run-&gt;nbPushed&gt;MAX_PUSHED/2)
-                              {
-                                aprintf(&quot;Gop too big, dumping-\n&quot;);
-                                gopDump(syncAbs,syncRel);
-                                updateFrameType(2); 
-                              }else
-                              {
-                                aprintf(&quot;Staring new frame-\n&quot;);
-                                startFrame(2,syncAbs,syncRel);
-                              }
-                              pic_started=1;
-                              break;
-                      default:
-                        break;
-                      }
-                
-      }
-    _frames[0].type=1; /* Always starts with an infra */
-    return 1; 
-}
-
-
-
-
-/**
-      \fn Push
-      \brief Add a frame to the current gop
-
-*/
-uint8_t dmx_videoIndexerH264::startFrame(uint32_t ftype,uint64_t abs,uint64_t rel)
-{
-                                            
-        _frames[_run-&gt;nbPushed].type=ftype;
-        
-        if(_run-&gt;nbPushed) // Update previous if it exists
-        {
-                aprintf(&quot;Start frame : empty\n&quot;);
-                _frames[_run-&gt;nbPushed-1].size=_run-&gt;demuxer-&gt;elapsed();
-        
-        }else
-        {
-         aprintf(&quot;Start frame %u  in gop\n&quot;,_run-&gt;nbPushed); 
-        }
-        _frames[_run-&gt;nbPushed].abs=abs;
-        _frames[_run-&gt;nbPushed].rel=rel;        
-        _run-&gt;demuxer-&gt;stamp();
-        _run-&gt;nbPushed++;
-        
-        ADM_assert(_run-&gt;nbPushed&lt;MAX_PUSHED);
-        return 1;
-
-}
-/**
-    \fn updateFrameType
-    \brief update the current frame type.Needed as we start from SPS if present
-*/
-uint8_t dmx_videoIndexerH264::updateFrameType(uint32_t ftype)
-{
-  ADM_assert(_run-&gt;nbPushed);
-  _frames[_run-&gt;nbPushed-1].type=ftype;
-  aprintf(&quot;updateFrameType %u for frame %u -1 in gop\n&quot;,ftype,_run-&gt;nbPushed); 
-  return 1;
-}
-/**
-    \fn dumpPts
-    \brief
-
-*/
-uint8_t dmx_videoIndexerH264::dumpPts(uint64_t firstPts)
-{
-uint64_t stats[_run-&gt;nbTrack],p;
-double d;
-dmx_demuxer *demuxer=_run-&gt;demuxer;
-
-        if(!demuxer-&gt;getAllPTS(stats)) return 0;
-        qfprintf(_run-&gt;fd,&quot;# Video 1st PTS : %07u\n&quot;,firstPts);
-        if(firstPts==ADM_NO_PTS) return 1;
-        for(int i=1;i&lt;_run-&gt;nbTrack;i++)
-        {
-                p=stats[i];
-                if(p==ADM_NO_PTS)
-                {
-                        qfprintf(_run-&gt;fd,&quot;# track %d no pts\n&quot;,i);
-                }
-                else
-                {
-                        
-                        d=firstPts; // it is in 90 khz tick
-                        d-=stats[i];
-                        d/=90.;
-                        qfprintf(_run-&gt;fd,&quot;# track %d PTS : %07u &quot;,i,stats[i]);
-                        qfprintf(_run-&gt;fd,&quot; delta=%04d ms\n&quot;,(int)d);
-                }
-
-        }
-        return 1;
-}
-/**
-      \fn       gopDump
-      \brief    Dump the content of a gop into the index file
-*/
-uint8_t dmx_videoIndexerH264::gopDump(uint64_t abs,uint64_t rel)
-{
-  dmx_demuxer *demuxer=_run-&gt;demuxer;
-  
-        /* No frame */
-        if(!_run-&gt;nbPushed) return 1;
-
-uint64_t stats[_run-&gt;nbTrack];
-
-        _frames[_run-&gt;nbPushed-1].size=demuxer-&gt;elapsed();    // Update previous frame
-        qfprintf(_run-&gt;fd,&quot;V %03u %06u %02u &quot;,_run-&gt;nbGop,_run-&gt;nbImage,_run-&gt;nbPushed);
-
-        /* First frame must be IDR */
-        if(!_run-&gt;nbGop) _frames[0].type=1;
-        
-        for(uint32_t i=0;i&lt;_run-&gt;nbPushed;i++) 
-        {
-
-                qfprintf(_run-&gt;fd,&quot;%c:%08&quot;LLX&quot;,%05x&quot;,
-                        Type[_frames[i].type],
-                        _frames[i].abs,
-                        _frames[i].rel);
-                qfprintf(_run-&gt;fd,&quot;,%05x &quot;,
-                        _frames[i].size);
-        }
-        
-        qfprintf(_run-&gt;fd,&quot;\n&quot;);
-
-        // audio if any
-        //*******************************************
-        // Nb image abs_pos audio seen
-        // The Nb image is used to compute a drift
-        //*******************************************
-        if(demuxer-&gt;hasAudio() &amp; _run-&gt;nbTrack&gt;1)
-        {
-                demuxer-&gt;getStats(stats);
-                
-                qfprintf(_run-&gt;fd,&quot;A %u %&quot;LLX&quot; &quot;,_run-&gt;nbImage,abs);
-                for(uint32_t i=1;i&lt;_run-&gt;nbTrack;i++)
-                {
-                        qfprintf(_run-&gt;fd,&quot;:%&quot;LLX&quot; &quot;,stats[i]);
-                }
-                qfprintf(_run-&gt;fd,&quot;\n&quot;);
-                
-        }
-        // Print some gop stamp infos, does not hurt
-        qfprintf(_run-&gt;fd,&quot;# Timestamp %02d:%02d:%02d,%03d\n&quot;,
-                 _run-&gt;lastStamp.hh,_run-&gt;lastStamp.mm,_run-&gt;lastStamp.ss,_run-&gt;lastStamp.ff);
-        _run-&gt;nbGop++;
-        _run-&gt;nbImage+=_run-&gt;nbPushed;
-        _run-&gt;nbPushed=0;
-        startFrame(2,abs,rel);
-        return 1;
-        
-}
-/**
-      \fn gopUpdate( 
-      \brief Update the timecode hh:mm:ss.xx inside a gop header
-*/
-uint8_t dmx_videoIndexerH264::gopUpdate(void)
-{
-
-        return 1;
-}
-/********************************************************************************************/
-/********************************************************************************************/
-/********************************************************************************************/
-/********************************************************************************************/
-
-//

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer_internal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer_internal.h	2009-06-22 05:30:44 UTC (rev 4947)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer_internal.h	2009-06-22 05:30:48 UTC (rev 4948)
@@ -1,138 +0,0 @@
-/***************************************************************************
-                        3nd gen indexer                                                 
-                             
-    
-    copyright            : (C) 2005 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef DMX_INDEXER_INTERNAL_H
-#define DMX_INDEXER_INTERNAL_H
-
-#define MAX_PUSHED 200
-
-
-typedef struct TimeStamp
-{
-        uint16_t hh,mm,ss,ff;
-}TimeStamp;
-
-
-typedef struct IndFrame
-{
-	uint32_t type;
-	uint32_t size;
-	uint64_t abs;
-	uint64_t rel;
-	
-}IndFrame;
-/*****************************************/
-typedef struct dmx_runData
-{
-  
-      FILE     *fd;
-      dmx_demuxer *demuxer;
-      DIA_progressIndexing *work;
-
-      uint64_t totalFileSize; 
-      uint32_t totalFrame;
-      uint32_t nbImage;
-      uint32_t nbPushed,nbGop;      
-      uint32_t nbTrack;
-      uint32_t imageW,imageH,imageFPS,imageAR;
-      TimeStamp firstStamp,lastStamp; /* Time code hh:mm:ss */
-      
-}dmx_runData;
-
-/*********************************************************************************************/
-/* Base Class for indexer , depending of the payload type, new derivated classes are created */
-/*********************************************************************************************/
-class dmx_videoIndexer
-{
-protected:
-   FILE                 *_fd;
-   uint64_t             _totalFileSize; 
-   uint32_t             _nbTrack;
-   dmx_demuxer          *_demuxer;
-   DIA_progressIndexing *_work;
-   IndFrame             *_frames;
-   dmx_runData          *_run;
-   
-public:
-          dmx_videoIndexer(dmx_runData *run)
-          {
-              _run=run;
-          }
-  virtual uint8_t  run(void)=0;
-  virtual void     cleanup(void)=0;
-  virtual           ~dmx_videoIndexer() 
-              {
-                  if(_frames)
-                  {
-                    delete [] _frames;
-                    _frames=NULL; 
-                  }
-              }
-};
-/**************************************************/
-/* Class to index mpeg2 payload in ES/PS/TS/MSDVR */
-/**************************************************/
-class dmx_videoIndexerMpeg2 :public dmx_videoIndexer
-{
-protected:
-          uint64_t firstPicPTS;
-          uint32_t grabbing;
-          uint32_t seq_found;
-          
-          
-          uint8_t gopDump(uint64_t abs,uint64_t rel);
-          uint8_t gopUpdate(void);
-          uint8_t dumpPts(uint64_t firstPts);
-          uint8_t Push(uint32_t ftype,uint64_t abs,uint64_t rel);
-public:
-                  dmx_videoIndexerMpeg2(dmx_runData *run);
- 
-          uint8_t run(void);
-          void    cleanup(void);
-  virtual         ~dmx_videoIndexerMpeg2();
-             
-};
-/**************************************************/
-/* Class to index H264 payload in ES/PS/TS/MSDVR */
-/**************************************************/
-class dmx_videoIndexerH264 :public dmx_videoIndexer
-{
-protected:
-          uint64_t firstPicPTS;
-          uint32_t grabbing;
-          uint32_t seq_found;
-          
-          
-          uint8_t gopDump(uint64_t abs,uint64_t rel);
-          uint8_t gopUpdate(void);
-          uint8_t dumpPts(uint64_t firstPts);
-          uint8_t startFrame(uint32_t ftype,uint64_t abs,uint64_t rel);
-          uint8_t updateFrameType(uint32_t ftypel);
-public:
-                  dmx_videoIndexerH264(dmx_runData *run);
- 
-          uint8_t run(void);
-          void    cleanup(void);
-  virtual         ~dmx_videoIndexerH264();
-             
-};
-
-/********************************************************/
-
-#endif
-//EOF
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer_mpeg2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer_mpeg2.cpp	2009-06-22 05:30:44 UTC (rev 4947)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_mpegIndexer/dmx_indexer_mpeg2.cpp	2009-06-22 05:30:48 UTC (rev 4948)
@@ -1,384 +0,0 @@
-/***************************************************************************
-                        2nd gen indexer                                                 
-                             
-    
-    copyright            : (C) 2005 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-
-#include &quot;ADM_default.h&quot;
-
-#include &quot;DIA_fileSel.h&quot;
-#include &quot;ADM_quota.h&quot;
-#include &quot;ADM_commonUI/DIA_idx_pg.h&quot;
-
-
-
-#include &quot;ADM_debugID.h&quot;
-#define MODULE_NAME MODULE_MPEG
-#include &quot;ADM_debug.h&quot;
-#include &quot;dmx_demuxerEs.h&quot;
-#include &quot;dmx_demuxerPS.h&quot;
-#include &quot;dmx_demuxerTS.h&quot;
-#include &quot;dmx_demuxerMSDVR.h&quot;
-#include &quot;dmx_identify.h&quot;
-
-#define MIN_DELTA_PTS 150 // autofix in ms
-
-#include &quot;dmx_indexer_internal.h&quot;
-
-static const char Type[5]={'X','I','P','B','P'};
-
-static const uint32_t FPS[16]={
-                0,                      // 0
-                23976,          // 1 (23.976 fps) - FILM
-                24000,          // 2 (24.000 fps)
-                25000,          // 3 (25.000 fps) - PAL
-                29970,          // 4 (29.970 fps) - NTSC
-                30000,          // 5 (30.000 fps)
-                50000,          // 6 (50.000 fps) - PAL noninterlaced
-                59940,          // 7 (59.940 fps) - NTSC noninterlaced
-                60000,          // 8 (60.000 fps)
-                0,                      // 9
-                0,                      // 10
-                0,                      // 11
-                0,                      // 12
-                0,                      // 13
-                0,                      // 14
-                0                       // 15
-        };
-
-
-dmx_videoIndexerMpeg2::dmx_videoIndexerMpeg2(dmx_runData *run) : dmx_videoIndexer(run)
-{
-  _frames=new IndFrame[MAX_PUSHED];
-  firstPicPTS=ADM_NO_PTS;
-  seq_found=0;
-  grabbing=0;
-  
-}
-dmx_videoIndexerMpeg2::~dmx_videoIndexerMpeg2()
-{
-          if(_frames) delete [] _frames;
-          _frames=NULL;
-}
-/**
-      \fn cleanup
-      \brief do cleanup and purge non processed data at the end of the mpeg2 stream
-*/
-void dmx_videoIndexerMpeg2::cleanup(void)
-{
-  uint64_t lastAbs,lastRel;
-          _run-&gt;demuxer-&gt;getPos(&amp;lastAbs,&amp;lastRel);
-          if(_run-&gt;nbPushed)  gopDump(lastAbs,lastRel);
-          dumpPts(firstPicPTS); 
-          
-}
-
-/**
-      \fn run 
-      \brief main indexing loop for mpeg2 payload
-*/
-uint8_t   dmx_videoIndexerMpeg2::run  (void)
-{
-dmx_demuxer *demuxer=_run-&gt;demuxer;
-uint64_t syncAbs,syncRel;
-uint8_t streamid;   
-uint32_t temporal_ref,ftype,val;
-uint64_t pts,dts;
-
-      
-
-      while(1)
-      {
-
-              if(!demuxer-&gt;sync(&amp;streamid,&amp;syncAbs,&amp;syncRel,&amp;pts,&amp;dts)) return 0;   
-              if((_run-&gt;totalFileSize&gt;&gt;16)&gt;50)
-              {
-                    _run-&gt;work-&gt;update(syncAbs&gt;&gt;16,_run-&gt;totalFileSize&gt;&gt;16,
-                               _run-&gt;nbImage,_run-&gt;lastStamp.hh,_run-&gt;lastStamp.mm,_run-&gt;lastStamp.ss);
-              }else
-              {
-                    _run-&gt;work-&gt;update(syncAbs,_run-&gt;totalFileSize,_run-&gt;nbImage,
-                            _run-&gt;lastStamp.hh,_run-&gt;lastStamp.mm,_run-&gt;lastStamp.ss);
-              }
-              if(_run-&gt;work-&gt;isAborted()) return 0;
-              switch(streamid)
-                      {
-                      case 0xB3: // sequence start
-                              aprintf(&quot;Seq %d\n&quot;,_run-&gt;nbGop);
-                              if(grabbing) continue;
-                              grabbing=1;    
-                              
-                              gopDump(syncAbs,syncRel);
-                              if(seq_found)
-                              {
-                                      demuxer-&gt;forward(8);  // Ignore
-                                      continue;
-                              }
-                              // Our firt frame is here
-                              // Important to initialize the mpeg decoder !
-                              _frames[0].abs=syncAbs;
-                              _frames[0].rel=syncRel;
-                              //
-                              seq_found=1;
-                              val=demuxer-&gt;read32i();
-                              _run-&gt;imageW=val&gt;&gt;20;
-                              _run-&gt;imageW=((_run-&gt;imageW+15)&amp;~15);
-                              _run-&gt;imageH= (((val&gt;&gt;8) &amp; 0xfff)+15)&amp; ~15;
-                              _run-&gt;imageAR=(val&gt;&gt;4)&amp;0xf;
-                              _run-&gt;imageFPS= FPS[val &amp; 0xf];
-                              demuxer-&gt;forward(4);
-                              break;
-                      case 0xb8: // GOP
-                              aprintf(&quot;GOP %d\n&quot;,_run-&gt;nbGop);
-#ifdef SHOW_PTS
-                              if(pts!=ADM_NO_PTS)
-                              {
-                              qfprintf(run-&gt;fd,&quot;# %lu\n&quot;,pts/90);
-                              }
-#endif
-                              uint32_t gop;   
-                              if(!seq_found) continue;
-                              if(grabbing) 
-                              {         
-                                      gopUpdate();
-                                      continue;;
-                              }
-                              gopDump(syncAbs,syncRel);
-                              gopUpdate();
-                              
-                              break;
-                      case 0x00 : // picture
-                            
-                              aprintf(&quot;pic \n&quot;);
-                              if(!seq_found)
-                              { 
-                                      continue;
-                                      printf(&quot;No sequence start yet, skipping..\n&quot;);
-                              }
-                              if(firstPicPTS==ADM_NO_PTS &amp;&amp; pts!=ADM_NO_PTS)
-                                      firstPicPTS=pts;
-                              grabbing=0;
-                              _run-&gt;totalFrame++;
-                              val=demuxer-&gt;read16i();
-                              temporal_ref=val&gt;&gt;6;
-                              ftype=7 &amp; (val&gt;&gt;3);
-                              //aprintf(&quot;Temporal ref:%lu\n&quot;,temporal_ref);
-                              // skip illegal values
-                              if(ftype&lt;1 || ftype&gt;3)
-                              {
-                                      printf(&quot;[Indexer]Met illegal pic at %&quot;LLX&quot; + %&quot;LLX&quot;\n&quot;,
-                                                      syncAbs,syncRel);
-                                      continue;
-                              }
-#define USING dts
-#if 0
-                              if(USING!=ADM_NO_PTS)
-                              {
-                                      if(olddts!=ADM_NO_PTS )
-                                      {                
-                                              if(USING&gt;=olddts)
-                                              {
-                                              uint64_t delta,deltaRef;
-                                                      delta=USING-olddts;
-                                                      
-                                                      delta/=90;
-                                                    //  printf(&quot;Delta :%llu ms\n&quot;,delta);
-                                                      // compute what we should be using
-                                                      deltaRef=nbPushed+nbImage-run-&gt;lastRefPic;
-                                                      // in ms
-                                                      deltaRef=(deltaRef*1000*1000)/run-&gt;imageFPS;
-                                                      if(abs(delta-deltaRef)&gt;MIN_DELTA_PTS)
-                                                      {
-                                                              printf(&quot;Discontinuity %llu %llu!\n&quot;,delta,deltaRef);
-                                                      }
-                                              } 
-                                      }
-                                      olddts=USING;
-                                      run-&gt;lastRefPic=nbPushed+nbImage;
-                              }
-#endif
-                              
-                              Push(ftype,syncAbs,syncRel);
-                          
-                              break;
-                      default:
-                        break;
-                      }
-      }
-                      return 1; 
-}
-
-
-
-/**** Push a frame
-There is a +- 2 correction when we switch gop
-as in the frame header we read 2 bytes
-Between frames, the error is self cancelling.
-
-**/
-/**
-      \fn Push
-      \brief Add a frame to the current gop
-
-*/
-uint8_t dmx_videoIndexerMpeg2::Push(uint32_t ftype,uint64_t abs,uint64_t rel)
-{
-                                            
-        _frames[_run-&gt;nbPushed].type=ftype;
-        
-        if(_run-&gt;nbPushed)
-        {                
-                _frames[_run-&gt;nbPushed-1].size=_run-&gt;demuxer-&gt;elapsed();
-                if(_run-&gt;nbPushed==1) _frames[_run-&gt;nbPushed-1].size-=2;
-                _frames[_run-&gt;nbPushed].abs=abs;
-                _frames[_run-&gt;nbPushed].rel=rel;        
-                _run-&gt;demuxer-&gt;stamp();
-        
-        }
-        //aprintf(&quot;\tpushed %d %&quot;LLX&quot;\n&quot;,nbPushed,abs);
-        _run-&gt;nbPushed++;
-        
-        ADM_assert(_run-&gt;nbPushed&lt;MAX_PUSHED);
-        return 1;
-
-}
-/**
-    \fn dumpPts
-    \brief
-
-*/
-uint8_t dmx_videoIndexerMpeg2::dumpPts(uint64_t firstPts)
-{
-uint64_t stats[_run-&gt;nbTrack],p;
-double d;
-dmx_demuxer *demuxer=_run-&gt;demuxer;
-
-        if(!demuxer-&gt;getAllPTS(stats)) return 0;
-        qfprintf(_run-&gt;fd,&quot;# Video 1st PTS : %07&quot;LLU&quot;\n&quot;,firstPts);
-        if(firstPts==ADM_NO_PTS) return 1;
-        for(int i=1;i&lt;_run-&gt;nbTrack;i++)
-        {
-                p=stats[i];
-                if(p==ADM_NO_PTS)
-                {
-                        qfprintf(_run-&gt;fd,&quot;# track %d no pts\n&quot;,i);
-                }
-                else
-                {
-                        
-                        d=firstPts; // it is in 90 khz tick
-                        d-=stats[i];
-                        d/=90.;
-                        qfprintf(_run-&gt;fd,&quot;# track %d PTS : %07&quot;LLU&quot; &quot;,i,stats[i]);
-                        qfprintf(_run-&gt;fd,&quot; delta=%04d ms\n&quot;,(int)d);
-                }
-
-        }
-        return 1;
-}
-/**
-      \fn       gopDump
-      \brief    Dump the content of a gop into the index file
-*/
-uint8_t dmx_videoIndexerMpeg2::gopDump(uint64_t abs,uint64_t rel)
-{
-  dmx_demuxer *demuxer=_run-&gt;demuxer;
-        if(!_run-&gt;nbPushed &amp;&amp; !_run-&gt;nbImage) demuxer-&gt;stamp();
-        if(!_run-&gt;nbPushed) return 1;
-
-uint64_t stats[_run-&gt;nbTrack];
-
-        _frames[_run-&gt;nbPushed-1].size=demuxer-&gt;elapsed()+2;
-        qfprintf(_run-&gt;fd,&quot;V %03u %06u %02u &quot;,_run-&gt;nbGop,_run-&gt;nbImage,_run-&gt;nbPushed);
-
-        // For each picture Type : abs position : relat position : size
-        for(uint32_t i=0;i&lt;_run-&gt;nbPushed;i++) 
-        {
-
-                qfprintf(_run-&gt;fd,&quot;%c:%08&quot;LLX&quot;,%05&quot;LLX,
-                        Type[_frames[i].type],
-                        _frames[i].abs,
-                        _frames[i].rel);
-                qfprintf(_run-&gt;fd,&quot;,%05x &quot;,
-                        _frames[i].size);
-        }
-        
-        qfprintf(_run-&gt;fd,&quot;\n&quot;);
-
-        // audio if any
-        //*******************************************
-        // Nb image abs_pos audio seen
-        // The Nb image is used to compute a drift
-        //*******************************************
-        if(demuxer-&gt;hasAudio() &amp; _run-&gt;nbTrack&gt;1)
-        {
-                demuxer-&gt;getStats(stats);
-                
-                qfprintf(_run-&gt;fd,&quot;A %u %&quot;LLX&quot; &quot;,_run-&gt;nbImage,abs);
-                for(uint32_t i=1;i&lt;_run-&gt;nbTrack;i++)
-                {
-                        qfprintf(_run-&gt;fd,&quot;:%&quot;LLX&quot; &quot;,stats[i]);
-                }
-                qfprintf(_run-&gt;fd,&quot;\n&quot;);
-                
-        }
-        // Print some gop stamp infos, does not hurt
-        qfprintf(_run-&gt;fd,&quot;# Timestamp %02d:%02d:%02d,%03d\n&quot;,
-                 _run-&gt;lastStamp.hh,_run-&gt;lastStamp.mm,_run-&gt;lastStamp.ss,_run-&gt;lastStamp.ff);
-        _run-&gt;nbGop++;
-        _run-&gt;nbImage+=_run-&gt;nbPushed;
-        _run-&gt;nbPushed=0;
-                
-        _frames[0].abs=abs;
-        _frames[0].rel=rel;
-        demuxer-&gt;stamp();
-        return 1;
-        
-}
-/**
-      \fn gopUpdate( 
-      \brief Update the timecode hh:mm:ss.xx inside a gop header
-*/
-uint8_t dmx_videoIndexerMpeg2::gopUpdate(void)
-{
-uint32_t a1,a2,a3,a4;
-uint32_t hh,mm,ss,ff;
-TimeStamp *ts;
-dmx_demuxer *demuxer=_run-&gt;demuxer;
-
-        a1=demuxer-&gt;read8i();
-        a2=demuxer-&gt;read8i();
-        a3=demuxer-&gt;read8i();
-        a4=demuxer-&gt;read8i();
-        hh=(a1&gt;&gt;2)&amp;0x1f;
-        mm=((a1&amp;3)&lt;&lt;4)+(a2&gt;&gt;4);
-        ss=((a2&amp;7)&lt;&lt;3)+(a3&gt;&gt;5);
-        ff=((a3&amp;0x1f)&lt;&lt;1)+(a4&gt;&gt;7);
-        if(!_run-&gt;nbGop)  ts=&amp;(_run-&gt;firstStamp);
-                else ts=&amp;(_run-&gt;lastStamp);
-        
-        ts-&gt;hh=hh;
-        ts-&gt;mm=mm;
-        ts-&gt;ss=ss;
-        ts-&gt;ff=ff;
-        if(!_run-&gt;nbGop) memcpy(&amp;(_run-&gt;lastStamp),&amp;(_run-&gt;firstStamp),sizeof(_run-&gt;firstStamp));
-        return 1;
-}
-/********************************************************************************************/
-/********************************************************************************************/
-/********************************************************************************************/
-/********************************************************************************************/
-
-//


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002162.html">[Avidemux-svn-commit] r4947 -	branches/avidemux_2.6_branch_mean/cmake
</A></li>
	<LI>Next message: <A HREF="002164.html">[Avidemux-svn-commit] r4949 - in branches/avidemux_2.6_branch_mean:	avidemux avidemux/gtk avidemux/qt4 avidemux_core
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2163">[ date ]</a>
              <a href="thread.html#2163">[ thread ]</a>
              <a href="subject.html#2163">[ subject ]</a>
              <a href="author.html#2163">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
