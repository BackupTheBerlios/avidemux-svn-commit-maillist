<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r4878 - in	branches/avidemux_2.6_branch_mean/avidemux: .	ADM_coreVideoEncoder/include ADM_coreVideoEncoder/src	ADM_coreVideoFilter/include ADM_coreVideoFilter/src	ADM_muxerGate/include ADM_muxerGate/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2009-June/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4878%20-%20in%0A%09branches/avidemux_2.6_branch_mean/avidemux%3A%20.%0A%09ADM_coreVideoEncoder/include%20ADM_coreVideoEncoder/src%0A%09ADM_coreVideoFilter/include%20ADM_coreVideoFilter/src%0A%09ADM_muxerGate/include%20ADM_muxerGate/src&In-Reply-To=%3C200906010838.n518ciH5006873%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002099.html">
   <LINK REL="Next"  HREF="002101.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r4878 - in	branches/avidemux_2.6_branch_mean/avidemux: .	ADM_coreVideoEncoder/include ADM_coreVideoEncoder/src	ADM_coreVideoFilter/include ADM_coreVideoFilter/src	ADM_muxerGate/include ADM_muxerGate/src</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4878%20-%20in%0A%09branches/avidemux_2.6_branch_mean/avidemux%3A%20.%0A%09ADM_coreVideoEncoder/include%20ADM_coreVideoEncoder/src%0A%09ADM_coreVideoFilter/include%20ADM_coreVideoFilter/src%0A%09ADM_muxerGate/include%20ADM_muxerGate/src&In-Reply-To=%3C200906010838.n518ciH5006873%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r4878 - in	branches/avidemux_2.6_branch_mean/avidemux: .	ADM_coreVideoEncoder/include ADM_coreVideoEncoder/src	ADM_coreVideoFilter/include ADM_coreVideoFilter/src	ADM_muxerGate/include ADM_muxerGate/src">mean at mail.berlios.de
       </A><BR>
    <I>Mon Jun  1 10:38:44 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002099.html">[Avidemux-svn-commit] r4877 - in	branches/avidemux_2.6_branch_mean/avidemux: . ADM_codecs	ADM_coreUtils/include ADM_coreUtils/src ADM_coreVideoEncoder	ADM_coreVideoEncoder/include ADM_coreVideoEncoder/src	ADM_coreVideoFilter/include ADM_coreVideoFilter/src	ADM_editor ADM_encoder ADM_muxerGate/include ADM_muxerGate/src
</A></li>
        <LI>Next message: <A HREF="002101.html">[Avidemux-svn-commit] r4879 -	branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2100">[ date ]</a>
              <a href="thread.html#2100">[ thread ]</a>
              <a href="subject.html#2100">[ subject ]</a>
              <a href="author.html#2100">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2009-06-01 10:38:43 +0200 (Mon, 01 Jun 2009)
New Revision: 4878

Added:
   branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoFilter/include/ADM_filterChain.h
   branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoFilter/src/ADM_filterChain.cpp
   branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/ADM_createStreams.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoEncoder/include/ADM_yv12Encoder.h
   branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoEncoder/src/ADM_VideoEncoders.cpp
   branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoFilter/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/include/ADM_videoProcess.h
   branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/ADM_videoCopy.cpp
   branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/ADM_videoProcess.cpp
   branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/gui_savenew.cpp
Log:
[Encoder/filter] More skeleton

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoEncoder/include/ADM_yv12Encoder.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoEncoder/include/ADM_yv12Encoder.h	2009-06-01 08:38:39 UTC (rev 4877)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoEncoder/include/ADM_yv12Encoder.h	2009-06-01 08:38:43 UTC (rev 4878)
@@ -34,13 +34,13 @@
                             ADM_yv12Encoder(ADM_coreVideoFilter *src);
                             ~ADM_yv12Encoder();
 virtual        bool         encode (ADMBitstream * out);
-virtual        const char *getDisplayName(void)=0;       /// E.g. FFmpeg mpeg4      
-virtual        const char *getCodecName(void)=0;         /// aka fourcc
-virtual        const char *getFCCHandler(void)=0;        /// fourcc 2, needed to build AVI header
+virtual        const char *getDisplayName(void);       /// E.g. FFmpeg mpeg4      
+virtual        const char *getCodecName(void);         /// aka fourcc
+virtual        const char *getFCCHandler(void);        /// fourcc 2, needed to build AVI header
 
-virtual        bool        configure(void)=0;           /// Pop-up UI
-virtual        bool        getConfiguration(uint32_t *l,uint8_t **d)=0; /// Get current conf to save it
-virtual        bool        setConfiguration(uint32_t l,uint8_t *d)=0;   /// Set conf, call it just after creation
+virtual        bool        configure(void);           /// Pop-up UI
+virtual        bool        getConfiguration(uint32_t *l,uint8_t **d); /// Get current conf to save it
+virtual        bool        setConfiguration(uint32_t l,uint8_t *d);   /// Set conf, call it just after creation
 };
 
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoEncoder/src/ADM_VideoEncoders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoEncoder/src/ADM_VideoEncoders.cpp	2009-06-01 08:38:39 UTC (rev 4877)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoEncoder/src/ADM_VideoEncoders.cpp	2009-06-01 08:38:43 UTC (rev 4878)
@@ -16,7 +16,16 @@
  *                                                                         *
  ***************************************************************************/
 #include &quot;ADM_default.h&quot;
-#include &quot;ADM_coreVideoEncoder.cpp&quot;
+#include &quot;ADM_coreVideoEncoder.h&quot;
 #include &quot;ADM_yv12Encoder.h&quot;
-
-
+#include &quot;ADM_filterChain.h&quot;
+/**
+    \fn createVideoEncoder
+*/
+ADM_coreVideoEncoder *createVideoEncoder(ADM_coreVideoFilter *chain)
+{
+    // 1- Create encoder itself...
+    ADM_yv12Encoder *yv=new ADM_yv12Encoder(chain);
+    return yv;
+}
+// EOF

Copied: branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoFilter/include/ADM_filterChain.h (from rev 4877, branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoEncoder/src/ADM_VideoEncoders.cpp)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoEncoder/src/ADM_VideoEncoders.cpp	2009-06-01 08:38:39 UTC (rev 4877)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoFilter/include/ADM_filterChain.h	2009-06-01 08:38:43 UTC (rev 4878)
@@ -0,0 +1,30 @@
+/***************************************************************************
+                          \fn ADM_filterChain.h
+                          \brief Base class for Video Filters
+                           (c) Mean 2009
+
+
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef ADM_filterChain_H
+#define ADM_filterChain_H
+#include &quot;ADM_coreVideoFilter.h&quot;
+#include &lt;vector&gt;
+typedef std::vector &lt;ADM_coreVideoFilter *&gt;ADM_videoFilterChain;
+
+
+ADM_videoFilterChain *createVideoFilterChain(uint64_t startAt,uint64_t endAt);
+bool                 destroyVideoFilterChain(ADM_videoFilterChain *chain);
+
+
+#endif
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoFilter/src/ADM_filterChain.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoFilter/src/ADM_filterChain.cpp	2009-06-01 08:38:39 UTC (rev 4877)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoFilter/src/ADM_filterChain.cpp	2009-06-01 08:38:43 UTC (rev 4878)
@@ -0,0 +1,50 @@
+/***************************************************************************
+                          \fn ADM_filterChain.cpp
+                          \brief Base class for Video Filters
+                           (c) Mean 2009
+
+
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;ADM_default.h&quot;
+#include &quot;ADM_coreVideoFilter.h&quot;
+#include &quot;ADM_filterChain.h&quot;
+#include &quot;ADM_videoFilterBridge.h&quot;
+/**
+    \fn createVideoFilterChain
+    \brief Create a filter chain
+*/
+ADM_videoFilterChain *createVideoFilterChain(uint64_t startAt,uint64_t endAt)
+{
+    ADM_videoFilterChain *chain=new ADM_videoFilterChain;
+    // 1- Add bridge always # 1
+    ADM_videoFilterBridge *bridge=new ADM_videoFilterBridge(startAt,endAt);
+    chain-&gt;push_back(bridge);
+    return chain;
+}
+/**
+        \fn destroyVideoFilterChain
+        \brief Destroy a filter chain
+*/
+bool                 destroyVideoFilterChain(ADM_videoFilterChain *chain)
+{
+    ADM_assert(chain-&gt;size());
+    for(int i=0;i&lt;chain-&gt;size();i++)
+    {
+        ADM_coreVideoFilter *filter=(*chain)[i];
+        delete filter;
+    }
+    chain-&gt;erase(chain-&gt;begin(),chain-&gt;end()-1);
+    return true;
+}
+
+// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoFilter/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoFilter/src/CMakeLists.txt	2009-06-01 08:38:39 UTC (rev 4877)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_coreVideoFilter/src/CMakeLists.txt	2009-06-01 08:38:43 UTC (rev 4878)
@@ -9,5 +9,6 @@
 
 SET(ADM_internalVideoFilter_SRCS 
 	ADM_videoFilterBridge.cpp
+        ADM_filterChain.cpp
 )
 ADD_LIBRARY(ADM_internalVideoFilter STATIC ${ADM_internalVideoFilter_SRCS})

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/include/ADM_videoProcess.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/include/ADM_videoProcess.h	2009-06-01 08:38:39 UTC (rev 4877)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/include/ADM_videoProcess.h	2009-06-01 08:38:43 UTC (rev 4878)
@@ -1,6 +1,16 @@
 /**
+    \file ADM_videoProcess.h
+    \brief Wrap an encoder as a VideoStream
+*/
 
-*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
 #ifndef ADM_VIDEOPROCESS_H
 #define ADM_VIDEOPROCESS_H
 #include &quot;ADM_muxer.h&quot;
@@ -13,6 +23,7 @@
 /**
     \class ADM_videoStreamProcess
     \brief Wrapper around encoder
+    @warning After creation, the VideoStream becomes the owner of the encoder and it will deleted here
 
 */
 class ADM_videoStreamProcess: public ADM_videoStream

Added: branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/ADM_createStreams.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/ADM_createStreams.cpp	2009-06-01 08:38:39 UTC (rev 4877)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/ADM_createStreams.cpp	2009-06-01 08:38:43 UTC (rev 4878)
@@ -0,0 +1,45 @@
+/***************************************************************************
+                          \fn ADM_createStreams.cpp
+                          \brief Take a filterChain &amp; create a stream with it
+                           (c) Mean 2009
+
+
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;ADM_default.h&quot;
+#include &quot;ADM_coreVideoFilter.h&quot;
+#include &quot;ADM_filterChain.h&quot;
+#include &quot;ADM_coreVideoEncoder.h&quot;
+#include &quot;ADM_muxer.h&quot;
+#include &quot;ADM_videoProcess.h&quot;
+
+extern ADM_coreVideoEncoder *createVideoEncoder(ADM_coreVideoFilter *chain);
+/**
+    \fn createVideoEncoder
+    \brief Create encoder then VideoStream from filterChain
+    @return created VideoStream
+*/
+ADM_videoStream  *createVideoEncoder(ADM_videoFilterChain *chain)
+{
+    int sz=chain-&gt;size();
+    ADM_assert(sz);
+    ADM_coreVideoFilter *filter=(*chain)[sz-1];
+    ADM_assert(filter);
+    ADM_coreVideoEncoder *encoder=createVideoEncoder(filter);
+    if(!encoder)
+    {
+        printf(&quot;[createVideoEncoder] Cannot create encoder\n&quot;);
+        return NULL;
+    }
+    ADM_videoStreamProcess *stream=new ADM_videoStreamProcess(encoder);
+    return stream;
+}
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/ADM_videoCopy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/ADM_videoCopy.cpp	2009-06-01 08:38:39 UTC (rev 4877)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/ADM_videoCopy.cpp	2009-06-01 08:38:43 UTC (rev 4878)
@@ -5,6 +5,14 @@
 
 */
 
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
 #include &quot;ADM_default.h&quot;
 #include &quot;ADM_videoCopy.h&quot;
 #include &quot;ADM_editor/ADM_edit.hxx&quot;

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/ADM_videoProcess.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/ADM_videoProcess.cpp	2009-06-01 08:38:39 UTC (rev 4877)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/ADM_videoProcess.cpp	2009-06-01 08:38:43 UTC (rev 4878)
@@ -5,6 +5,14 @@
 
 */
 
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
 #include &quot;ADM_default.h&quot;
 #include &quot;ADM_videoProcess.h&quot;
 #include &quot;fourcc.h&quot;
@@ -35,6 +43,8 @@
     if(bitstream)
         delete bitstream;
     bitstream=NULL;
+    if(encoder) delete encoder;
+    encoder=NULL;
 }
 /**
     \fn getExtraData

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/CMakeLists.txt	2009-06-01 08:38:39 UTC (rev 4877)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_muxerGate/src/CMakeLists.txt	2009-06-01 08:38:43 UTC (rev 4878)
@@ -1,6 +1,7 @@
 SET(ADM_muxerGate_SRCS
 ADM_videoCopy.cpp
 ADM_videoProcess.cpp
+ADM_createStreams.cpp
 )
 include_directories(../include)
 ADD_LIBRARY(ADM_muxerGate STATIC ${ADM_muxerGate_SRCS})

Modified: branches/avidemux_2.6_branch_mean/avidemux/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/CMakeLists.txt	2009-06-01 08:38:39 UTC (rev 4877)
+++ branches/avidemux_2.6_branch_mean/avidemux/CMakeLists.txt	2009-06-01 08:38:43 UTC (rev 4878)
@@ -207,6 +207,7 @@
 # The part of the video filter that is inside avidemux
 ########################################################
 ADD_LIB_ALL_TARGETS(ADM_internalVideoFilter)
+ADD_LIB_ALL_TARGETS(ADM_internalVideoEncoder)
 ###########################################
 # Construct ADM_UIs
 ###########################################

Modified: branches/avidemux_2.6_branch_mean/avidemux/gui_savenew.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gui_savenew.cpp	2009-06-01 08:38:39 UTC (rev 4877)
+++ branches/avidemux_2.6_branch_mean/avidemux/gui_savenew.cpp	2009-06-01 08:38:43 UTC (rev 4878)
@@ -36,32 +36,29 @@
 #include &quot;ADM_userInterfaces/ADM_commonUI/GUI_ui.h&quot;
 #include &quot;ADM_muxer.h&quot;
 #include &quot;ADM_videoCopy.h&quot;
+#include &quot;ADM_filterChain.h&quot;
 
-static uint8_t  A_SaveAudioNVideo(const char *name);
- extern int A_SaveUnpackedVop(const char *name);
- extern uint8_t oplug_dummy(const char *name);
- extern int A_SavePackedVop(const char *name);
- extern uint8_t ogmSave(const char *name);
- extern uint8_t ADM_saveRaw(const char *name);
- uint8_t A_SaveAudioDualAudio(const char *name);
- extern uint8_t mpeg_passthrough(const char *name,ADM_OUT_FORMAT format);
-ADM_muxer *ADM_MuxerSpawnFromIndex(int index);
-
-extern ADM_audioStream *createEncodingStream(uint64_t startTime,int32_t shift);
-
+ADM_muxer               *ADM_MuxerSpawnFromIndex(int index);
+extern ADM_audioStream  *createEncodingStream(uint64_t startTime,int32_t shift);
+extern ADM_videoStream  *createVideoEncoder(ADM_videoFilterChain *chain);
 /**
     \fn A_Save
+    \brief Instantiate &amp; initiate streams to feed muxer
 */
 int A_Save(const char *name)
 {
     int ret=1;
     ADM_muxer *muxer=NULL;
     int index=UI_GetCurrentFormat();
+    bool process=true;
+    ADM_videoFilterChain *chain=NULL;
+    
     if(!(muxer=ADM_MuxerSpawnFromIndex(index)))
     {
         GUI_Error_HIG(&quot;Muxer&quot;,&quot;Cannot instantiante muxer&quot;);
         return 0;
     }
+
     // Audio Stream ?
     ADM_audioStream *audio=NULL;
     int nbAStream=1;
@@ -72,9 +69,32 @@
         audio=NULL;
         nbAStream=0; // FIXME
     }
-    
-    // Video Stream ?
-    ADM_videoStream *video=new ADM_videoStreamCopy();
+    ADM_videoStream *video=NULL;
+    // Video Stream 
+    if(process) // Copy
+    {
+        video=new ADM_videoStreamCopy();
+    }else
+    {
+        // 1- create filter chain
+        chain=createVideoFilterChain(0,10000000000);
+        if(!chain)
+        {
+                GUI_Error_HIG(&quot;Video&quot;,&quot;Cannot instantiante video Chain&quot;);
+                delete muxer;
+                return 0;
+        }
+        // 2- Create Encoder
+        video=createVideoEncoder(chain);
+        if(!video)
+        {
+                GUI_Error_HIG(&quot;Video&quot;,&quot;Cannot create encoder&quot;);
+                destroyVideoFilterChain(chain);
+                delete muxer;
+                return 0;
+        }
+        
+    }
     //
     ADM_audioStream *astreams[1];
     if (!audioProcessMode())
@@ -87,8 +107,6 @@
             // Access..
             ADM_audioStream *access=createEncodingStream(0,0); // FIXME LEAK
             astreams[0]=access;
-
-            
         }
     }
     if(!muxer-&gt;open(name,video,nbAStream,astreams))
@@ -105,315 +123,21 @@
     if(muxer) delete muxer;
     if (!audioProcessMode() &amp;&amp; astreams[0])
         delete astreams[0];
+    delete video;
     return ret;
 }
-#if 0
-uint32_t end;
-int ret=0;
-	// depending on the type we save a avi, a mpeg or a XVCD
-	CodecFamilty family;
-	family= videoCodecGetFamily();
-	// in case of copy mode, we stick to avi file format
-	if(!videoProcessMode())
-	{
-		family=CodecFamilyAVI;
-		if( UI_GetCurrentFormat()==ADM_PS ||UI_GetCurrentFormat()==ADM_TS )  // exception
-		{
-			family=CodecFamilyMpeg;
-		}
-                        
-	}
-        else
-        {
-                if(UI_GetCurrentFormat()==ADM_AVI_DUAL)
-                {
-                  GUI_Error_HIG(QT_TR_NOOP(&quot;Dual audio can only be used in copy mode&quot;),QT_TR_NOOP( &quot;Select Copy as the video codec.&quot;));
-                        return 0;
-                }
-        }
-	printf(&quot;**saving:**\n&quot;);
-	// Check if we need to do a sanity B frame check
-	if(!videoProcessMode())
-	{	
-		uint32_t pb;
-		end=avifileinfo-&gt;nb_frames;
-		// if the last frame is the last frame (!)
-		// we add one to keep it, else we systematically skip
-		// the last frame
-#if 0					
-		if(frameEnd==end-1) end=frameEnd+1;
-		else
-			end=frameEnd;
-
-		if(!video_body-&gt;sanityCheckRef(frameStart,end,&amp;pb))
-		{
-			if(pb)
-			{
-				GUI_Error_HIG(&quot;Cannot save the file&quot;, &quot;The video starts/ends with a lonely B-frame. Please remove it.&quot;);
-				return 0;
-			}
-			if(!GUI_Question(&quot;Warning !\n Bframe has lost its reference frame\nContinue ?&quot;))
-				return 0;
-		}
-#endif
-		// Alter frameEnd so that it is not a B frame	
-		// as frameEnd -1 position	
-		uint32_t tgt=frameEnd;;
-		uint32_t flag=0,found=0;
-		
-		// need to do something ?
-		if(frameEnd&gt;frameStart)
-		{
-			tgt=frameEnd;
-			if(tgt==end-1) tgt++;
-			video_body-&gt;getFlags(tgt-1,&amp;flag);
-			if((frameEnd&amp;AVI_B_FRAME))
-			{
-				printf(&quot;Last frame is a B frame, choosing better candidate\n&quot;);
-				 // The last real one is not a I/P Frame
-				 // Go forward or rewind
-				 if(tgt&lt;end-1)
-				{	// Try next if possible
-					video_body-&gt;getFlags(tgt,&amp;flag);
-					if(!(flag&amp;AVI_B_FRAME))
-					{
-						printf(&quot;Taking next frame as last frame %lu\n&quot;,tgt+1);
-				 		frameEnd=tgt+1;
-				 		found=1;
-					}
-				}
-				if(!found) // next frame not possible, rewind
-				{
-					if(tgt&gt;=end-2) tgt=end-2;
-					while(tgt&gt;frameStart)
-					{
-						printf(&quot;Trying :%lu\n&quot;,tgt);
-						video_body-&gt;getFlags(tgt,&amp;flag);
-						if(!(flag&amp;AVI_B_FRAME))
-						{
-							printf(&quot;Taking previous frame as last frame %lu\n&quot;,tgt+1);
-				 			frameEnd=tgt+1;
-				 			found=1;
-							break;
-						}
-						else tgt--;
-					}
-				}
-				ADM_assert(found);
-			}
-		}
-		
-		
-		
-	}
-        printf(&quot;Output format:%d\n&quot;,UI_GetCurrentFormat());
-	switch(family)
-	{
-		case CodecFamilyAVI:
-					printf(&quot; AVI family\n&quot;);
-					switch(UI_GetCurrentFormat())
-					{
-                        case ADM_AVI:
-								ret=A_SaveAudioNVideo(name);
-								break;
-#if 0
-						case ADM_DUMMY:
-					                            			ret=oplug_dummy(name);
-					                            			break;
-						case ADM_FLV:
-                            			ret=oplug_flv(name);
-                            			break;
-                        case ADM_MP4:
-                        case ADM_PSP:
-                        case ADM_MATROSKA:
-                        
-                                                    ret=oplug_mp4(name,UI_GetCurrentFormat());
-                                                    break;
-						
-						case ADM_OGM:
-//								ret=ogmSave(name);
-								break;
-						case ADM_ES:
-								ret=ADM_saveRaw(name);
-								break;
-						case ADM_AVI_DUAL:
-								ret=A_SaveAudioDualAudio(name);
-								break;
-                                                case ADM_AVI_PAK:
-								ret=A_SavePackedVop(name);
-								break;
-
-						case ADM_AVI_UNP:
-								ret=A_SaveUnpackedVop(name);
-								break;
-#endif
-						default:
-                                                  GUI_Error_HIG(QT_TR_NOOP(&quot;Incompatible output format&quot;), NULL);
-					}
-					break;
-		case CodecFamilyMpeg:
-					printf(&quot; MPEG family\n&quot;);
-					if(!videoProcessMode())
-					{
-						
-						printf(&quot;Using pass through\n&quot;);
-                                                switch(UI_GetCurrentFormat())
-                                                {
-                                                  case ADM_PS:
-                                                  case ADM_TS:
-						     //     ret=mpeg_passthrough(name,UI_GetCurrentFormat());
-                                                          break;
-                                                  default:
-                                                    GUI_Error_HIG(QT_TR_NOOP(&quot;Incompatible output format&quot;), NULL);
-                                                }
-                                                break;
-                                        } // THERE IS NO BREAK HERE, NOT A MISTAKE!
-		case CodecFamilyXVCD:
-                    switch(UI_GetCurrentFormat())
-                    {
-                        case ADM_TS:
-                        case ADM_PS:
-                        case ADM_ES:
-                             //   ret=oplug_mpegff(name,UI_GetCurrentFormat());;
-                                break;
-                        default:
-                          GUI_Error_HIG(QT_TR_NOOP(&quot;Incompatible output format&quot;), NULL);
-                    }
-                    break;
-                default:
-                            ADM_assert(0);
-                            return 0;
-        }
-        getFirstVideoFilter(0,avifileinfo-&gt;nb_frames);
-        return ret;
-#endif
-
+// Leftovers....
 uint8_t  A_SaveAudioDualAudio(const char *inname)
 {
-#if 0
-GenericAviSaveCopyDualAudio *nw;
-const char *name;
-uint8_t ret=0;
-
-		if(! secondaudiostream)
-		{
-                  GUI_Error_HIG(QT_TR_NOOP(&quot;There is no second track&quot;), QT_TR_NOOP(&quot;Select a second audio track in the Audio menu.&quot;));
-				  	return 0;
-		}
-		if(!inname)
-                  GUI_FileSelWrite(QT_TR_NOOP(&quot;Select dual audio AVI to write&quot;), (char**)&amp; name);
-		else
-			name=inname;
-			
-		if(!name) return 0;
-
-//     		nw=new   GenericAviSaveCopyDualAudio(secondaudiostream);
-	//	ret=nw-&gt;saveAvi(name);
-      // 		delete nw;
-                return ret;
-#endif
 }
 //___________________________________
 int A_SaveUnpackedVop(const char *name)
 {
-#if 0
-  aviInfo info;
-GenericAviSave	*nw;
-int ret;
-
-	video_body-&gt;getVideoInfo(&amp;info);
-	if( !isMpeg4Compatible(  info.fcc))
-	{
-          GUI_Error_HIG(QT_TR_NOOP(&quot;This cannot have packed VOP&quot;),QT_TR_NOOP( &quot;It is not MPEG-4 video. File will not be saved.&quot;));
-		return 0;
-        }
-	//
-	nw=new   GenericAviSaveCopyUnpack();
-	ret=nw-&gt;saveAvi(name);
-	delete nw;
-	return ret;
-#endif
 }
 int A_SavePackedVop(const char *name)
 {
-#if 0
-  aviInfo info;
-GenericAviSave	*nw;
-int ret;
-
-	video_body-&gt;getVideoInfo(&amp;info);
-	if( !isMpeg4Compatible(  info.fcc))
-	{
-          GUI_Error_HIG(QT_TR_NOOP(&quot;This cannot have packed VOP&quot;),QT_TR_NOOP( &quot;It is not MPEG-4 video. File will not be saved.&quot;));
-		return 0;
-        }
-	//
-	nw=new   GenericAviSaveCopyPack();
-	ret=nw-&gt;saveAvi(name);
-	delete nw;
-	return ret;
-#endif
 }
 //___________________________________
 uint8_t  A_SaveAudioNVideo(const char *name)
 {
-#if 0
-     uint32_t needSmart=0,fl;
-     GenericAviSave	*nw=NULL;
-     aviInfo info;
-     uint8_t ret=0;
-
-     video_body-&gt;getVideoInfo(&amp;info);
-
-     printf(&quot;\n video process mode : %d&quot;,videoProcessMode());
-     if (!videoProcessMode())
-     {
-          if(video_body-&gt;isMultiSeg()) needSmart=1;
-                  video_body-&gt;getFlags(frameStart,&amp;fl);
-          if(!(fl&amp;AVI_KEY_FRAME)) needSmart=1;
-
-          if(needSmart) printf(&quot;\n probably need smart copy mode\n&quot;);
-      
-          if( !isMpeg4Compatible(  info.fcc)
-                &amp;&amp; !isMSMpeg4Compatible(info.fcc))
-             {
-                    printf(&quot;\n not encodable, cancelling smart mode\n&quot;);
-                    needSmart=0;
-               }
-
-
-               int value=video_body-&gt;getEnv(ENV_EDITOR_SMART);
-               nw=NULL;
-               if(needSmart)
-               {
-                  if(value)
-                  {
-                     nw=new   GenericAviSaveSmart(3);
-                  }
-                  else
-                  {
-                    if(GUI_Question(QT_TR_NOOP(&quot;You may need smart copy.\n Enable it ?&quot;)))
-                    {
-                        value=4;
-                        if( ! DIA_GetIntegerValue(&amp;value, 2, 31, &quot;_Q factor (set 4):&quot;,&quot;&quot;))
-                                      return 0;
-                        nw=new   GenericAviSaveSmart(value);
-                    }
-                }
-               }
-              if(!nw)
-                    nw=new   GenericAviSaveCopy;
-               
-       }
-       else
-       {
-
-              printf(&quot;\n Process mode\n&quot;);
-              nw=new   GenericAviSaveProcess;
-        }
-     ret=nw-&gt;saveAvi(name);
-     delete nw;
-
-return ret;
-#endif
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002099.html">[Avidemux-svn-commit] r4877 - in	branches/avidemux_2.6_branch_mean/avidemux: . ADM_codecs	ADM_coreUtils/include ADM_coreUtils/src ADM_coreVideoEncoder	ADM_coreVideoEncoder/include ADM_coreVideoEncoder/src	ADM_coreVideoFilter/include ADM_coreVideoFilter/src	ADM_editor ADM_encoder ADM_muxerGate/include ADM_muxerGate/src
</A></li>
	<LI>Next message: <A HREF="002101.html">[Avidemux-svn-commit] r4879 -	branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2100">[ date ]</a>
              <a href="thread.html#2100">[ thread ]</a>
              <a href="subject.html#2100">[ subject ]</a>
              <a href="author.html#2100">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
