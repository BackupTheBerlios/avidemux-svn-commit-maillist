<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r4114 - in	branches/avidemux_2.4_branch/avidemux: . ADM_filter	ADM_osSupport ADM_script ADM_toolkit	ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2008-June/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4114%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%20.%20ADM_filter%0A%09ADM_osSupport%20ADM_script%20ADM_toolkit%0A%09ADM_userInterfaces/ADM_GTK/ADM_gui2%0A%09ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk%0A%09ADM_userInterfaces/ADM_NONE/ADM_gui2%0A%09ADM_userInterfaces/ADM_QT4/ADM_gui&In-Reply-To=%3C200806170215.m5H2FiXS008319%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001369.html">
   <LINK REL="Next"  HREF="001371.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r4114 - in	branches/avidemux_2.4_branch/avidemux: . ADM_filter	ADM_osSupport ADM_script ADM_toolkit	ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui</H1>
    <B>gruntster at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4114%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%20.%20ADM_filter%0A%09ADM_osSupport%20ADM_script%20ADM_toolkit%0A%09ADM_userInterfaces/ADM_GTK/ADM_gui2%0A%09ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk%0A%09ADM_userInterfaces/ADM_NONE/ADM_gui2%0A%09ADM_userInterfaces/ADM_QT4/ADM_gui&In-Reply-To=%3C200806170215.m5H2FiXS008319%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r4114 - in	branches/avidemux_2.4_branch/avidemux: . ADM_filter	ADM_osSupport ADM_script ADM_toolkit	ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui">gruntster at mail.berlios.de
       </A><BR>
    <I>Tue Jun 17 04:15:44 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001369.html">[Avidemux-svn-commit] r4113 -	branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec
</A></li>
        <LI>Next message: <A HREF="001371.html">[Avidemux-svn-commit] r4115 - in	branches/avidemux_2.4_branch/avidemux: ADM_audio	ADM_outputs/oplug_avi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1370">[ date ]</a>
              <a href="thread.html#1370">[ thread ]</a>
              <a href="subject.html#1370">[ subject ]</a>
              <a href="author.html#1370">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: gruntster
Date: 2008-06-17 04:15:24 +0200 (Tue, 17 Jun 2008)
New Revision: 4114

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_filter/filter_saveload.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_filter/video_filters.h
   branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_fileio.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSAvidemux.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_toolkit/automation.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_toolkit/filesel.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/TLK_filesel.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/file_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/file_qt4.cpp
   branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
   branches/avidemux_2.4_branch/avidemux/gtkgui.h
Log:
[DND] fix GTK drag and drop for Win32 and Qt4 for Linux (FS#366)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_filter/filter_saveload.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_filter/filter_saveload.cpp	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/ADM_filter/filter_saveload.cpp	2008-06-17 02:15:24 UTC (rev 4114)
@@ -63,12 +63,12 @@
 /**
 	Xml Read/write ConfCouple from files
 */
-void filterSaveXml(char *docname)
+void filterSaveXml(const char *docname)
 {
 	filterSaveXml(docname,0);
 }
 
-void filterSaveXml(char *docname,uint8_t silent)
+void filterSaveXml(const char *docname,uint8_t silent)
 {
  xmlDocPtr xdoc;
  xmlNodePtr node;
@@ -136,12 +136,12 @@
 		xmlFreeDoc(xdoc);
 	return ;
 }
-void filterLoadXml(char *docname)
+void filterLoadXml(const char *docname)
 {
 	filterLoadXml(docname,0);
 }
 
-int filterLoadXml(char *docname,uint8_t silent)
+int filterLoadXml(const char *docname,uint8_t silent)
 {
  xmlDocPtr xdoc;
  xmlNodePtr node,subnode;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_filter/video_filters.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_filter/video_filters.h	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/ADM_filter/video_filters.h	2008-06-17 02:15:24 UTC (rev 4114)
@@ -179,15 +179,15 @@
   void	filterSetPostProc( void );
   
 #ifdef USE_LIBXML2
-void filterSaveXml(char *name);
-void filterSaveXml(char *name,uint8_t silent);
-void filterLoadXml(char *name);
-int  filterLoadXml(char *name,uint8_t silent);
+void filterSaveXml(const char *name);
+void filterSaveXml(const char *name,uint8_t silent);
+void filterLoadXml(const char *name);
+int  filterLoadXml(const char *name,uint8_t silent);
 #endif
- void filterSave(char *name);
- void filterLoad(char *name);
- int filterLoad(char *name,uint8_t silent);
- void filterSave(char *name,uint8_t silent);
+ void filterSave(const char *name);
+ void filterLoad(const char *name);
+ int filterLoad(const char *name,uint8_t silent);
+ void filterSave(const char *name,uint8_t silent);
 CONFcouple *filterBuildCouple(FILTER_PARAM *param,uint32_t n,Arg *args);
 void filterSaveScriptJS(FILE *f);
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_fileio.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_fileio.cpp	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_fileio.cpp	2008-06-17 02:15:24 UTC (rev 4114)
@@ -40,6 +40,8 @@
 #undef fopen
 #undef fclose
 
+extern char * actual_workbench_file;
+
 size_t ADM_fread (void *ptr, size_t size, size_t n, FILE *sstream)
 {
   return fread(ptr,size,n,sstream); 
@@ -408,3 +410,94 @@
 		*root=full;
 		return ;
 }
+
+// CYB 2005.02.23: DND
+void fileReadWrite(SELFILE_CB *cb, int rw, const char *name)
+{
+
+	if(name)
+	{
+		if(cb)
+		{
+			FILE *fd;
+			fd=fopen(name,&quot;rb&quot;);
+			if(rw==0) // read
+			{
+				// try to open it..
+				if(!fd)
+				{
+                                  GUI_Error_HIG(QT_TR_NOOP(&quot;File error&quot;), QT_TR_NOOP(&quot;Cannot open \&quot;%s\&quot;.&quot;), name);
+					return;
+				}
+			}
+			else // write
+			{
+				if(fd){
+				  struct stat buf;
+				  int fdino;
+					fclose(fd);
+
+					char msg[300];
+
+					snprintf(msg, 300, QT_TR_NOOP(&quot;%s already exists.\n\nDo you want to replace it?&quot;), GetFileName(name));
+
+                                        if(!GUI_Question(msg))
+						return;
+	                                /*
+	                                ** JSC Fri Feb 10 00:07:30 CET 2006
+	                                ** compare existing output file inode against each current open files inode
+	                                ** i'm ignoring st_dev, so we may get false positives
+	                                ** i'm testing until fd=1024, should be MAXFD computed by configure
+	                                ** keep in mind:
+	                                ** you can overwrite .idx files, they are loaded into memory and closed soon
+	                                ** you cannot overwrite segment data files, all files are kept open and
+	                                ** are detected here
+	                                */
+#ifndef ADM_WIN32
+					if( stat(name,&amp;buf) == -1 ){
+						fprintf(stderr,&quot;stat(%s) failed\n&quot;,name);
+						return;
+					}
+#endif
+					fdino = buf.st_ino;
+					for(int i=0;i&lt;1024;i++){
+						if( fstat(i,&amp;buf) != -1 ){
+							if( buf.st_ino == fdino ){
+							  char str[512];
+								snprintf(str,512,&quot;File \&quot;%s\&quot; exists and is opened by Avidemux&quot;,name);
+								GUI_Error_HIG(str,
+                                                                    QT_TR_NOOP(&quot;It is possible that you are trying to overwrite an input file!&quot;));
+								return;
+							}
+						}
+					}
+					/*
+	                                ** compare output file against actual EMCAscript file
+					** need to stat() to avoid symlink (/home/x.js) vs. real file (/export/home/x.js) case
+	                                */
+					if( actual_workbench_file ){
+						if( stat(actual_workbench_file,&amp;buf) != -1 ){
+							if( buf.st_ino == fdino ){
+							  char str[512];
+								snprintf(str,512,&quot;File \&quot;%s\&quot; exists and is the actual ECMAscript file&quot;,name);
+                                                                GUI_Error_HIG(str,QT_TR_NOOP(&quot;It is possible that you are trying to overwrite an input file!&quot;));
+								return;
+							}
+						}
+					}
+				}
+
+				// check we have right access to it
+				fd=fopen(name,&quot;wb&quot;);
+				if(!fd)
+				{
+                                  GUI_Error_HIG(QT_TR_NOOP(&quot;Cannot write the file&quot;),QT_TR_NOOP( &quot;No write access to \&quot;%s\&quot;.&quot;), name);
+					return;
+				}
+			}
+			fclose(fd);
+			cb(name);
+		} // no callback -&gt; return value
+	}
+}
+// CYB 2005.02.23: DND

Modified: branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSAvidemux.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSAvidemux.cpp	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSAvidemux.cpp	2008-06-17 02:15:24 UTC (rev 4114)
@@ -37,12 +37,12 @@
 #include &quot;ADM_osSupport/ADM_debug.h&quot;
 
 
-extern int A_openAvi (char *name);
+extern int A_openAvi (const char *name);
 extern int A_Save (const char *name);
-extern int A_appendAvi (char *name);
+extern int A_appendAvi (const char *name);
 extern uint8_t ogmSave(char *name);
 extern int GUI_GoToFrame(uint32_t frame);
-extern int filterLoadXml(char *docname,uint8_t silent);
+extern int filterLoadXml(const char *docname,uint8_t silent);
 extern int A_delete(uint32_t start, uint32_t end);
 
 extern uint8_t A_ListAllBlackFrames( char *file );

Modified: branches/avidemux_2.4_branch/avidemux/ADM_toolkit/automation.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_toolkit/automation.cpp	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/ADM_toolkit/automation.cpp	2008-06-17 02:15:24 UTC (rev 4114)
@@ -29,7 +29,7 @@
 #include &lt;ctype.h&gt;
 
 #include &quot;avi_vars.h&quot;
-#include &lt;ADM_assert.h&gt;
+#include &quot;ADM_assert.h&quot;
 
 #include &quot;gui_action.hxx&quot;
 #include &quot;ADM_encoder/ADM_vidEncode.hxx&quot;
@@ -50,9 +50,8 @@
 
 extern uint8_t loadVideoCodecConf( const char *name);
 extern int A_saveJpg (char *name);
-extern void filterLoadXml(char *n);
-extern int A_openAvi(char *name);
-extern int A_appendAvi (char *name);
+extern void filterLoadXml(const char *n);
+extern int A_appendAvi (const char *name);
 extern void A_saveAudio(char *name);
 extern int A_loadNone( void );
 extern void A_saveAudioDecodedTest(char *name);
@@ -101,7 +100,7 @@
 extern int A_SaveUnpackedVop(const char *name);
 extern int A_SavePackedVop(const char *name);
 extern int A_saveDVDPS(char *name);
-extern void A_saveWorkbench (char *name);
+extern void A_saveWorkbench (const char *name);
 extern uint8_t A_rebuildKeyFrame (void);
 extern uint8_t A_setContainer(const char *cont);
 uint8_t scriptAddVar(char *var,char *value);
@@ -146,7 +145,7 @@
         {&quot;run&quot;,			1,&quot;load and run a script&quot;,		(one_arg_type)A_parseECMAScript},
         {&quot;audio-normalize&quot;,	1,&quot;activate normalization&quot;,		call_normalize},
         {&quot;audio-resample&quot;,	1,&quot;resample to x hz&quot;,			call_resample},
-        {&quot;filters&quot;,		1,&quot;load a filter preset&quot;,		filterLoadXml}   ,
+        {&quot;filters&quot;,		1,&quot;load a filter preset&quot;,		(one_arg_type)filterLoadXml}   ,
         {&quot;codec-conf&quot;,		1,&quot;load a codec configuration&quot;,		(one_arg_type )loadVideoCodecConf}   ,
         {&quot;vcd-res&quot;,		0,&quot;set VCD resolution&quot;,			(one_arg_type)setVCD}              ,
         {&quot;svcd-res&quot;,		0,&quot;set SVCD resolution&quot;,		(one_arg_type)setSVCD}              ,
@@ -161,8 +160,8 @@
         {&quot;save-raw-audio&quot;,	1,&quot;save audio as-is &quot;,			A_saveAudio},
         {&quot;save-raw-video&quot;,	1,&quot;save raw video stream (mpeg/... ) &quot;,	(one_arg_type)ADM_saveRaw},
         {&quot;save-uncompressed-audio&quot;,1,&quot;save uncompressed audio&quot;,A_saveAudioDecodedTest},
-        {&quot;load&quot;,		1,&quot;load video or workbench&quot;,		(one_arg_type )A_openAvi},
-        {&quot;load-workbench&quot;,	1,&quot;load workbench file&quot;,		(one_arg_type)A_openAvi},
+        {&quot;load&quot;,		1,&quot;load video or workbench&quot;, (one_arg_type)A_openAvi},
+        {&quot;load-workbench&quot;,	1,&quot;load workbench file&quot;, (one_arg_type)A_openAvi},
         {&quot;append&quot;,		1,&quot;append video&quot;,			(one_arg_type)A_appendAvi},
         {&quot;save&quot;,		1,&quot;save avi&quot;,				save},		
         {&quot;save-workbench&quot;,	1,&quot;save workbench file&quot;,		(one_arg_type)A_saveWorkbench},

Modified: branches/avidemux_2.4_branch/avidemux/ADM_toolkit/filesel.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_toolkit/filesel.h	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/ADM_toolkit/filesel.h	2008-06-17 02:15:24 UTC (rev 4114)
@@ -15,9 +15,9 @@
 
 #ifndef FILESEL_H
 #define FILESEL_H
-typedef void SELFILE_CB(char *);
-void GUI_FileSelRead(const char *label,SELFILE_CB cb) ;
-void GUI_FileSelWrite(const char *label,SELFILE_CB cb) ;
+typedef void SELFILE_CB(const char *);
+void GUI_FileSelRead(const char *label,SELFILE_CB *cb) ;
+void GUI_FileSelWrite(const char *label,SELFILE_CB *cb) ;
 void GUI_FileSelRead(const char *label, char * * name);
 void GUI_FileSelWrite(const char *label, char * * name);
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2008-06-17 02:15:24 UTC (rev 4114)
@@ -81,7 +81,7 @@
 static uint32_t ADM_nbCustom=0;
 // Needed for DND
 // extern int A_openAvi (char *name);
-extern void A_appendAvi (char *name);
+extern int A_appendAvi (const char *name);
 
 
 static void on_audio_change(void);
@@ -129,7 +129,7 @@
 extern void guiCallback(GtkMenuItem * menuitem, gpointer user_data);
 extern void HandleAction(Action act);
 extern gboolean UI_on_key_press(GtkWidget *widget, GdkEventKey* event, gpointer user_data);
-extern void fileReadWrite(SELFILE_CB cb, int rw, char *name);
+extern void fileReadWrite(SELFILE_CB *cb, int rw, const char *name);
 
 // To build vcodec
 extern uint32_t encoderGetNbEncoder(void);
@@ -1120,21 +1120,25 @@
     \fn DNDmerge
     \brief Extract the actual filename from the DNDstring <A HREF="file://abcd">file://abcd</A> and store it into where
 */
-static void DNDmerge(char **where, char *start,char *end)
+static void DNDmerge(char **where, char *start, char *end)
 {
-  int len=end-start;
-  ADM_assert(len&gt;7); // <A HREF="file://">file://</A> = 7 bytes
-  len-=7;
-  *where=(char *)ADM_alloc(end-start+1);  // 7 more but who cares ?
-  memcpy(*where,start+7,len);
-  
-  // chomp it
-  char *tail=(*where)+len;
-  do
-  { 
-      *tail=0;
-      tail--;
-  }while(*tail==0xA || *tail==0xd);
+	char urlFile[end - start + 1];
+	char *tail = urlFile + (end - start);
+
+	memcpy(urlFile, start, end - start);
+
+	do
+	{
+		*tail = 0;
+		tail--;
+	} while (*tail == '\r' || *tail == '\n');
+
+	gchar *filename = g_filename_from_uri(urlFile, NULL, NULL);
+
+	*where = new char[strlen(filename) + 1];
+	strcpy(*where, filename);
+
+	g_free(filename);
 }
 // DND CYB
 #define MAX_DND_FILES 20
@@ -1150,7 +1154,7 @@
    char *names[MAX_DND_FILES];
    
     memset(names,0,sizeof(char *)*MAX_DND_FILES);
-    if (info != TARGET_URI_LIST)
+    if (info != TARGET_STRING &amp;&amp; info != TARGET_URL)
     {
       gtk_drag_finish(dc,TRUE,FALSE,t);
       return;
@@ -1184,15 +1188,13 @@
     for(int i=0;i&lt;current-1;i++)
     {
       printf(&quot;DND : %d %s\n&quot;,i,names[i]);
-      char *filename=names[i];
-      if (avifileinfo) 
-              {
-                    fileReadWrite(A_appendAvi, 0, (char*)filename);
-               }
-               else
-               {
-                    fileReadWrite(reinterpret_cast &lt;void (*)(char *)&gt; (A_openAvi), 0, (char*)filename);
-               }
+      const char *filename = names[i];
+
+	  if (avifileinfo)
+		  fileReadWrite(reinterpret_cast &lt;void (*)(const char *)&gt; (A_appendAvi), 0, filename);
+	  else
+		  fileReadWrite(reinterpret_cast &lt;void (*)(const char *)&gt; (A_openAvi), 0, filename);
+
       ADM_dealloc(names[i]); 
     }
     gtk_drag_finish(dc,TRUE,FALSE,t);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/TLK_filesel.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/TLK_filesel.cpp	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/TLK_filesel.cpp	2008-06-17 02:15:24 UTC (rev 4114)
@@ -38,7 +38,7 @@
 #include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
 #include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
 
-extern char * actual_workbench_file;
+extern void fileReadWrite(SELFILE_CB *cb, int rw, const char *name);
 
 static void GUI_FileSel(const char *label, SELFILE_CB * cb, int rw, char **name=NULL);
 char            *PathCanonize(const char *tmpname);
@@ -307,98 +307,6 @@
     GUI_FileSel(label, NULL, 1,name);
 }
 
-// CYB 2005.02.23: DND
-void fileReadWrite(SELFILE_CB *cb, int rw, char *name)
-{
-
-	if(name)
-	{
-		if(cb)
-		{
-			FILE *fd;
-			fd=fopen(name,&quot;rb&quot;);
-			if(rw==0) // read
-			{
-				// try to open it..
-				if(!fd)
-				{
-                                  GUI_Error_HIG(QT_TR_NOOP(&quot;File error&quot;), QT_TR_NOOP(&quot;Cannot open \&quot;%s\&quot;.&quot;), name);
-					return;
-				}
-			}
-			else // write
-			{
-				if(fd){
-				  struct stat buf;
-				  int fdino;
-					fclose(fd);
-
-					char msg[300];
-
-					snprintf(msg, 300, QT_TR_NOOP(&quot;%s already exists.\n\nDo you want to replace it?&quot;), GetFileName(name));
-
-                                        if(!GUI_Question(msg))
-						return;
-	                                /*
-	                                ** JSC Fri Feb 10 00:07:30 CET 2006
-	                                ** compare existing output file inode against each current open files inode
-	                                ** i'm ignoring st_dev, so we may get false positives
-	                                ** i'm testing until fd=1024, should be MAXFD computed by configure
-	                                ** keep in mind:
-	                                ** you can overwrite .idx files, they are loaded into memory and closed soon
-	                                ** you cannot overwrite segment data files, all files are kept open and
-	                                ** are detected here
-	                                */
-#ifndef ADM_WIN32
-					if( stat(name,&amp;buf) == -1 ){
-						fprintf(stderr,&quot;stat(%s) failed\n&quot;,name);
-						return;
-					}
-#endif
-					fdino = buf.st_ino;
-					for(int i=0;i&lt;1024;i++){
-						if( fstat(i,&amp;buf) != -1 ){
-							if( buf.st_ino == fdino ){
-							  char str[512];
-								snprintf(str,512,&quot;File \&quot;%s\&quot; exists and is opened by Avidemux&quot;,name);
-								GUI_Error_HIG(str,
-                                                                    QT_TR_NOOP(&quot;It is possible that you are trying to overwrite an input file!&quot;));
-								return;
-							}
-						}
-					}
-					/*
-	                                ** compare output file against actual EMCAscript file
-					** need to stat() to avoid symlink (/home/x.js) vs. real file (/export/home/x.js) case
-	                                */
-					if( actual_workbench_file ){
-						if( stat(actual_workbench_file,&amp;buf) != -1 ){
-							if( buf.st_ino == fdino ){
-							  char str[512];
-								snprintf(str,512,&quot;File \&quot;%s\&quot; exists and is the actual ECMAscript file&quot;,name);
-                                                                GUI_Error_HIG(str,QT_TR_NOOP(&quot;It is possible that you are trying to overwrite an input file!&quot;));
-								return;
-							}
-						}
-					}
-				}
-
-				// check we have right access to it
-				fd=fopen(name,&quot;wb&quot;);
-				if(!fd)
-				{
-                                  GUI_Error_HIG(QT_TR_NOOP(&quot;Cannot write the file&quot;),QT_TR_NOOP( &quot;No write access to \&quot;%s\&quot;.&quot;), name);
-					return;
-				}
-			}
-			fclose(fd);
-			cb(name);
-		} // no callback -&gt; return value
-	}
-}
-// CYB 2005.02.23: DND
-
-
 void GUI_FileSel(const char *label, SELFILE_CB * cb, int rw,char **rname)
 {				/* Create the selector */
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/file_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/file_none.cpp	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/file_none.cpp	2008-06-17 02:15:24 UTC (rev 4114)
@@ -20,9 +20,9 @@
 { 
   return 0;
 }
-void GUI_FileSelRead(const char *label,SELFILE_CB cb) 
+void GUI_FileSelRead(const char *label,SELFILE_CB *cb) 
 {}
-void GUI_FileSelWrite(const char *label,SELFILE_CB cb) 
+void GUI_FileSelWrite(const char *label,SELFILE_CB *cb) 
 {}
 void GUI_FileSelRead(const char *label, char * * name)
 {}

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2008-06-17 02:15:24 UTC (rev 4114)
@@ -39,6 +39,7 @@
 #include &quot;ADM_editor/ADM_outputfmt.h&quot;
 #include &quot;ADM_toolkit/filesel.h&quot;
 #include &quot;prefs.h&quot;
+#include &quot;avi_vars.h&quot;
 
 extern int global_argc;
 extern char **global_argv;
@@ -55,7 +56,9 @@
 extern void loadTranslator(void);
 extern void initTranslator(void);
 extern void destroyTranslator(void);
-extern int A_openAvi2(char *name, uint8_t mode);
+extern int A_openAvi(const char *name);
+extern int A_appendAvi(const char *name);
+extern void fileReadWrite(SELFILE_CB *cb, int rw, const char *name);
 
 int SliderIsShifted=0;
 static void setupMenus(void);
@@ -330,6 +333,8 @@
 	ui.lineEdit_2-&gt;installEventFilter(this);
 
 	this-&gt;setFocus(Qt::OtherFocusReason);
+
+	setAcceptDrops(true);
 }
 /**
 \fn     custom
@@ -486,13 +491,18 @@
 	{
 		urlList = event-&gt;mimeData()-&gt;urls();
 
-		if (urlList.size() &gt; 0)
+		for (int fileIndex = 0; fileIndex &lt; urlList.size(); fileIndex++)
 		{
-			fileName = urlList[0].toLocalFile();
+			fileName = urlList[fileIndex].toLocalFile();
 			info.setFile(fileName);
 
 			if (info.isFile())
-				A_openAvi2(fileName.toUtf8().data(), 0);
+			{
+				if (avifileinfo)
+					fileReadWrite(reinterpret_cast &lt;void (*)(const char *)&gt; (A_appendAvi), 0, fileName.toUtf8().data());
+				else
+					fileReadWrite(reinterpret_cast &lt;void (*)(const char *)&gt; (A_openAvi), 0, fileName.toUtf8().data());
+			}
 		}
 	}
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/file_qt4.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/file_qt4.cpp	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/file_qt4.cpp	2008-06-17 02:15:24 UTC (rev 4114)
@@ -25,7 +25,7 @@
 static void GUI_FileSelSelect(const char *label, char **name, uint32_t access) ;
 
 //****************************************************************************************************
-void GUI_FileSelRead(const char *label,SELFILE_CB cb) 
+void GUI_FileSelRead(const char *label,SELFILE_CB *cb) 
 {
   char *name;
   GUI_FileSelRead(label,&amp;name);
@@ -36,7 +36,7 @@
   }
 }
 //****************************************************************************************************
-void GUI_FileSelWrite(const char *label,SELFILE_CB cb) 
+void GUI_FileSelWrite(const char *label,SELFILE_CB *cb) 
 {
   char *name;
   GUI_FileSelWrite(label,&amp;name);

Modified: branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2008-06-17 02:15:24 UTC (rev 4114)
@@ -70,8 +70,8 @@
 
 void A_handleSecondTrack (int tracktype);
 int A_delete(uint32_t start, uint32_t end);
-void A_saveImg (char *name);
-void A_saveBunchJpg( char *name);
+void A_saveImg (const char *name);
+void A_saveBunchJpg( const char *name);
 void A_requantize(void);
 int A_saveJpg (char *name);
 int A_loadWave (char *name);
@@ -79,9 +79,9 @@
 int A_loadMP3 (char *name);
 int A_loadNone( void );
 void A_saveAudioDecodedTest (char *name);
-void A_openBrokenAvi (char *name);
-int A_openAvi2 (char *name, uint8_t mode);
-int A_appendAvi (char *name);
+void A_openBrokenAvi (const char *name);
+int A_openAvi2 (const char *name, uint8_t mode);
+int A_appendAvi (const char *name);
 void A_externalAudioTrack( void );
 
 void HandleAction (Action action);
@@ -117,7 +117,7 @@
 void ADM_cutWizard (void);
 uint8_t  ADM_saveRaw (const char *name);
 char * actual_workbench_file;
-void A_saveWorkbench (char *name);
+void A_saveWorkbench (const char *name);
 void updateLoaded (void);
 extern void encoderSetLogFile (char *name);
 extern void videoCodecSelect (void);
@@ -872,18 +872,18 @@
 //_____________________________________________________________
 
 void
-A_openBrokenAvi (char *name)
+A_openBrokenAvi (const char *name)
 {
   A_openAvi2 (name, 1);
 }
 
 int
-A_openAvi (char *name)
+A_openAvi (const char *name)
 {
   return A_openAvi2 (name, 0);
 }
 extern void GUI_PreviewEnd (void);
-int A_openAvi2 (char *name, uint8_t mode)
+int A_openAvi2 (const char *name, uint8_t mode)
 {
   uint8_t res;
   gchar *name_utf8;
@@ -1094,7 +1094,7 @@
 //  Append an AVI to the existing one
 //___________________________________________
 int
-A_appendAvi (char *name)
+A_appendAvi (const char *name)
 {
 
 
@@ -1289,11 +1289,12 @@
       \brief Save the selection  as a bunch of jpeg 95% qual
 
 */
-void A_saveBunchJpg(char *name)
+void A_saveBunchJpg(const char *name)
 {
   ADMImage *src=NULL;
   uint32_t curImg;
   char	 fullName[2048],*ext;
+  char *baseName;
   DIA_working *working;
   uint8_t success=0;
 
@@ -1303,7 +1304,7 @@
                         return;
                 }
         // Split name into base + extension
-        PathSplit(name,&amp;name,&amp;ext);
+        PathSplit(name,&amp;baseName,&amp;ext);
 
         src=new ADMImage(avifileinfo-&gt;width,avifileinfo-&gt;height);
         ADM_assert(src);
@@ -1318,7 +1319,7 @@
                         goto _bunch_abort;
                 }
                 if(!working-&gt;isAlive()) goto _bunch_abort;
-                sprintf(fullName,&quot;%s%04d.jpg&quot;,name,curImg-frameStart);
+                sprintf(fullName,&quot;%s%04d.jpg&quot;,baseName,curImg-frameStart);
                 if(!src-&gt;saveAsJpg(fullName)) goto _bunch_abort;
         }
         success=1;
@@ -1338,7 +1339,7 @@
       \fn A_saveImg
       \brief Save current displayed image as a BMP file
 */
-void A_saveImg (char *name)
+void A_saveImg (const char *name)
 {
 
   ADMImage image(avifileinfo-&gt;width,avifileinfo-&gt;height);
@@ -1779,7 +1780,7 @@
 }
 
 void
-A_saveWorkbench (char *name)
+A_saveWorkbench (const char *name)
 {
 #if 0
   video_body-&gt;saveWorbench (name);

Modified: branches/avidemux_2.4_branch/avidemux/gtkgui.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gtkgui.h	2008-06-17 00:03:41 UTC (rev 4113)
+++ branches/avidemux_2.4_branch/avidemux/gtkgui.h	2008-06-17 02:15:24 UTC (rev 4114)
@@ -15,7 +15,7 @@
  *                                                                         *
  ***************************************************************************/
 
-int 			A_openAvi		(char *name);
+int 			A_openAvi		(const char *name);
 void 			A_saveAudio	(char *name);
 void 			A_saveAudioDecoded	(char *name);
 void 			A_saveAVI		(char *name);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001369.html">[Avidemux-svn-commit] r4113 -	branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec
</A></li>
	<LI>Next message: <A HREF="001371.html">[Avidemux-svn-commit] r4115 - in	branches/avidemux_2.4_branch/avidemux: ADM_audio	ADM_outputs/oplug_avi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1370">[ date ]</a>
              <a href="thread.html#1370">[ thread ]</a>
              <a href="subject.html#1370">[ subject ]</a>
              <a href="author.html#1370">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
