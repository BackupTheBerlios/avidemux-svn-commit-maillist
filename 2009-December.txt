From gruntster at mail.berlios.de  Tue Dec  1 20:22:34 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 1 Dec 2009 20:22:34 +0100
Subject: [Avidemux-svn-commit] r5603 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264
Message-ID: <200912011922.nB1JMYkR025747@sheep.berlios.de>

Author: gruntster
Date: 2009-12-01 20:22:29 +0100 (Tue, 01 Dec 2009)
New Revision: 5603

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
Log:
[x264] add bframe as references option to correct xml block

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2009-11-30 20:16:58 UTC (rev 5602)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2009-12-01 19:22:29 UTC (rev 5603)
@@ -1183,7 +1183,7 @@
 			break;
 	}
 
-	xmlNewChild(xmlNodeChild, NULL, (xmlChar*)"bFrameReferences", xmlBuffer);
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"bFrameReferences", xmlBuffer);
 #else
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"bFrameReferences", boolean2String(xmlBuffer, bufferSize, (bool)getBFrameReferences()));
 #endif



From gruntster at mail.berlios.de  Tue Dec  1 21:38:49 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 1 Dec 2009 21:38:49 +0100
Subject: [Avidemux-svn-commit] r5604 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_core/src
	ADM_editor
Message-ID: <200912012038.nB1KcnKq031813@sheep.berlios.de>

Author: gruntster
Date: 2009-12-01 21:38:45 +0100 (Tue, 01 Dec 2009)
New Revision: 5604

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edit.cpp
Log:
[win32] use avidemux open function instead when checking if file system is writeable

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp	2009-12-01 19:22:29 UTC (rev 5603)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp	2009-12-01 20:38:45 UTC (rev 5604)
@@ -135,61 +135,58 @@
 #endif
 }
 
-#if __WIN32
-extern "C"
+int ADM_open(const char *path, int oflag, int aflag)
 {
-	// libavformat uses open (in the file_open function) so we need to override that too.
-	// Following the same rules as ADM_fopen.
-	int ADM_open(const char *path, int oflag, ...)
-	{
-		int fileNameLength = utf8StringToWideChar(path, -1, NULL);
-		wchar_t wcFile[fileNameLength];
-		int creation = 0, access = 0;
-		HANDLE hFile;
+#ifdef __WIN32
+	int fileNameLength = utf8StringToWideChar(path, -1, NULL);
+	wchar_t wcFile[fileNameLength];
+	int creation = 0, access = 0;
+	HANDLE hFile;
 
-		utf8StringToWideChar(path, -1, wcFile);
+	utf8StringToWideChar(path, -1, wcFile);
 
-		if (oflag & O_WRONLY || oflag & O_RDWR)
-		{
-			access = GENERIC_WRITE;
+	if (oflag & O_WRONLY || oflag & O_RDWR)
+	{
+		access = GENERIC_WRITE;
 
-			if (oflag & O_RDWR)
-				access |= GENERIC_READ;
+		if (oflag & O_RDWR)
+			access |= GENERIC_READ;
 
-			if (oflag & O_CREAT)
-			{
-				if (oflag & O_EXCL)
-					creation = CREATE_NEW;
-				else if (oflag & O_TRUNC)
-					creation = CREATE_ALWAYS;
-				else
-					creation = OPEN_ALWAYS;
-			}
-			else if (oflag & O_TRUNC)
-				creation = TRUNCATE_EXISTING;
-		}
-		else if (oflag & O_RDONLY)
-			creation = OPEN_EXISTING;
-
-		if (creation & GENERIC_WRITE)
+		if (oflag & O_CREAT)
 		{
-			hFile = CreateFileW(wcFile, access, 0, NULL, creation, 0, NULL);
-
-			if (hFile == INVALID_HANDLE_VALUE)
-				return -1;
+			if (oflag & O_EXCL)
+				creation = CREATE_NEW;
+			else if (oflag & O_TRUNC)
+				creation = CREATE_ALWAYS;
 			else
-				CloseHandle(hFile);
+				creation = OPEN_ALWAYS;
 		}
+		else if (oflag & O_TRUNC)
+			creation = TRUNCATE_EXISTING;
+	}
+	else if (oflag & O_RDONLY)
+		creation = OPEN_EXISTING;
 
-		hFile = CreateFileW(wcFile, access, FILE_SHARE_READ, NULL, creation, 0, NULL);
+	if (creation & GENERIC_WRITE)
+	{
+		hFile = CreateFileW(wcFile, access, 0, NULL, creation, 0, NULL);
 
 		if (hFile == INVALID_HANDLE_VALUE)
 			return -1;
 		else
-			return _open_osfhandle((intptr_t)hFile, oflag);
+			CloseHandle(hFile);
 	}
-}
+
+	hFile = CreateFileW(wcFile, access, FILE_SHARE_READ, NULL, creation, 0, NULL);
+
+	if (hFile == INVALID_HANDLE_VALUE)
+		return -1;
+	else
+		return _open_osfhandle((intptr_t)hFile, oflag);
+#else
+	return open(path, oflag, aflag);
 #endif
+}
 
 int ADM_fclose(FILE *file)
 {

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edit.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edit.cpp	2009-12-01 19:22:29 UTC (rev 5603)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edit.cpp	2009-12-01 20:38:45 UTC (rev 5604)
@@ -65,6 +65,8 @@
 
 extern uint8_t loadVideoCodecConf( const char *name);
 extern uint8_t parseScript(char *name);
+extern int ADM_open(const char *path, int oflag, int aflag);
+
 uint8_t UI_SetCurrentFormat( ADM_OUT_FORMAT fmt );
 const char *VBR_MSG = QT_TR_NOOP("Avidemux detected VBR MP3 audio in this file. For keeping audio/video in sync, time map is needed. Build it now?\n\nYou can do it later with \"Audio -> Build VBR Time Map\".");
 //
@@ -338,7 +340,7 @@
         }
 	/* check for "Read-only file system" */
 	{
-                int fd = open(tmpname,O_CREAT|O_EXCL|O_WRONLY,S_IRUSR|S_IWUSR);
+                int fd = ADM_open(tmpname,O_CREAT|O_EXCL|O_WRONLY,S_IRUSR|S_IWUSR);
                 if( fd >= 0 )
                 {
                     close(fd);



From gruntster at mail.berlios.de  Tue Dec  1 21:48:17 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 1 Dec 2009 21:48:17 +0100
Subject: [Avidemux-svn-commit] r5605 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries
Message-ID: <200912012048.nB1KmHZx000301@sheep.berlios.de>

Author: gruntster
Date: 2009-12-01 21:47:34 +0100 (Tue, 01 Dec 2009)
New Revision: 5605

Added:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg_r20602.tar.gz
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/libswscale_r29964.tar.gz
Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg_r19575.tar.gz
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/libswscale_r29474.tar.gz
Log:
[ffmpeg] update ffmpeg & libswscale tarballs

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg_r19575.tar.gz
===================================================================
(Binary files differ)

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg_r20602.tar.gz (from rev 5604, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg_r19575.tar.gz)
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/libswscale_r29474.tar.gz
===================================================================
(Binary files differ)

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/libswscale_r29964.tar.gz (from rev 5604, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/libswscale_r29474.tar.gz)
===================================================================
(Binary files differ)



From mean at mail.berlios.de  Wed Dec  2 20:02:22 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 2 Dec 2009 20:02:22 +0100
Subject: [Avidemux-svn-commit] r5606 - in branches/avidemux_2.6_branch_mean:
	avidemux/common avidemux/common/ADM_script avidemux/qt4
	avidemux/qt4/ADM_userInterfaces
	avidemux/qt4/ADM_userInterfaces/ADM_gui
	avidemux/qt4/ADM_userInterfaces/ADM_shell
	avidemux_plugins/ADM_demuxers/Asf
	avidemux_plugins/ADM_muxers/muxerffTS
Message-ID: <200912021902.nB2J2Mai010785@sheep.berlios.de>

Author: mean
Date: 2009-12-02 20:02:21 +0100 (Wed, 02 Dec 2009)
New Revision: 5606

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/qt4Shell.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/shell.ui
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp
Log:
[Js] Shell + qt4 UI for shell

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.cpp	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.cpp	2009-12-02 19:02:21 UTC (rev 5606)
@@ -18,6 +18,7 @@
 #include "ADM_JSGlobal.h"
 #include "ADM_JSAvidemux.h"
 #include "ADM_JSDirectorySearch.h"
+#include "ADM_jsShell.h"
 
 extern uint8_t JS_AvidemuxFunction(JSContext *cx,JSObject *global);
 extern void A_Resync(void);
@@ -151,23 +152,4 @@
 	printf("[ECMA] success : %d\n", g_bJSSuccess);
 }// end JS_setSuccess
 
-bool parseECMAScript(const char *name)
-{// begin parseECMAScript
-	jsval rval;
-	uintN lineno = 0;
-	g_bJSSuccess = 0;
-	printf("Spidermonkey compiling \"%s\"...",name);
-	JSScript *pJSScript = JS_CompileFile(g_pCx, g_pObject, name);
-	printf("Done.\n");
-	if(pJSScript != NULL)
-	{// begin execute external file
-		printf("Spidermonkey executing \"%s\"...",name);
-		JSBool ok = JS_ExecuteScript(g_pCx, g_pObject, pJSScript, &rval);
-		JS_DestroyScript(g_pCx,pJSScript);
-		printf("Done.\n");
-	}// end execute external file
-        // Run garbage collector now, it is safe
-        JS_GC(g_pCx);
-	A_Resync();
-	return g_bJSSuccess;
-}// end parseECMAScript
+

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.h	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.h	2009-12-02 19:02:21 UTC (rev 5606)
@@ -11,6 +11,7 @@
 bool SpidermonkeyInit();
 void SpidermonkeyDestroy();
 bool parseECMAScript(const char *name);
+bool interactiveECMAScript(const char *name);
 void JS_setSuccess(bool bSuccess);
 void *StartThreadSpidermonkey(void *pData);
 

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp	2009-12-02 19:02:21 UTC (rev 5606)
@@ -0,0 +1,67 @@
+/**
+    \file ADM_JSif.cpp
+    \brief interface to js
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_default.h"
+#include <string.h>
+#include <pthread.h>
+#include "DIA_coreToolkit.h"
+#include "ADM_JSGlobal.h"
+#include "ADM_JSAvidemux.h"
+#include "ADM_jsShell.h"
+void    A_Resync(void);
+
+/**
+    \fn parseECMAScript
+    \brief Compile & execute ecma script
+*/
+bool parseECMAScript(const char *name)
+{// begin parseECMAScript
+	jsval rval;
+	uintN lineno = 0;
+	g_bJSSuccess = 0;
+	printf("Spidermonkey compiling \"%s\"...",name);
+	JSScript *pJSScript = JS_CompileFile(g_pCx, g_pObject, name);
+	printf("Done.\n");
+	if(pJSScript != NULL)
+	{// begin execute external file
+		printf("Spidermonkey executing \"%s\"...",name);
+		JSBool ok = JS_ExecuteScript(g_pCx, g_pObject, pJSScript, &rval);
+		JS_DestroyScript(g_pCx,pJSScript);
+		printf("Done.\n");
+	}// end execute external file
+        // Run garbage collector now, it is safe
+    JS_GC(g_pCx);
+	A_Resync();
+	return g_bJSSuccess;
+}// end parseECMAScript
+/**
+    \fn jsEvaluate
+*/
+static bool jsEvaluate(const char *str)
+{
+jsval rval;
+   JS_EvaluateScript(g_pCx,g_pObject,str,strlen(str),"dummy",1,&rval);
+   return true; 
+}
+/**
+    \fn    interactiveECMAScript
+    \brief interprete & execute ecma script (interactive)
+*/
+bool interactiveECMAScript(const char *name)
+{
+    ADM_startShell(jsEvaluate);
+    JS_GC(g_pCx);
+	A_Resync();
+    ADM_info("Ending JS shell...\n");
+	return true;
+}
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h	2009-12-02 19:02:21 UTC (rev 5606)
@@ -0,0 +1,28 @@
+/**
+    \file ADM_JSif.cpp
+    \brief interface to js
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_JS_IF_H
+#define ADM_JS_IF_H
+/**
+    \fn parseECMAScript
+    \brief Compile & execute ecma script
+*/
+bool parseECMAScript(const char *name);
+
+/**
+    \fn    interactiveECMAScript
+    \brief interprete & execute ecma script (interactive)
+*/
+bool interactiveECMAScript(const char *name);
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h	2009-12-02 19:02:21 UTC (rev 5606)
@@ -0,0 +1,22 @@
+/**
+    \file ADM_jsShell.h
+    \brief Base class for js interactive shell
+    \author mean, fixounet at free.fr
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef ADM_JS_SHELL_H
+#define ADM_JS_SHELL_H
+
+typedef bool (jsShellEvaluate)(const char *str);
+bool ADM_startShell(jsShellEvaluate *eval);
+
+#endif // ADM_JS_SHELL_H
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt	2009-12-02 19:02:21 UTC (rev 5606)
@@ -1,7 +1,9 @@
 SET(ADM_script_SRCS
 	ADM_AvidemuxAudio.cpp  ADM_AvidemuxVideo.cpp    ADM_JSAvidemux.cpp       ADM_JSDirectorySearch.cpp  ADM_JSGlobal.cpp
 	ADM_Avidemux.cpp       ADM_JSAvidemuxAudio.cpp  ADM_JSAvidemuxVideo.cpp  ADM_JSFunctions.cpp        DirectorySearch.cpp
-        ADM_JSFunctionsNonRegFactory.cpp)
+        ADM_JSFunctionsNonRegFactory.cpp
+        ADM_JSif.cpp
+)
 
 ADD_LIBRARY(ADM_script6 STATIC ${ADM_script_SRCS})
 ADD_TARGET_CFLAGS(ADM_script6 "-DJS_THREADSAFE -DXP_UNIX")

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2009-12-02 19:02:21 UTC (rev 5606)
@@ -40,6 +40,7 @@
 
 #include "avi_vars.h"
 #include "prototype.h" // FIXME
+#include "ADM_script/ADM_JSif.h"
 char * actual_workbench_file;
 renderZoom currentZoom=ZOOM_1_1;
 //***********************************
@@ -83,10 +84,6 @@
 static void cleanUp (void);
 void        updateLoaded (void);
 extern void encoderSetLogFile (char *name);
-
-//__________
-extern bool parseECMAScript(const char *name);
-
 extern void videoCodecConfigureUI(int codecIndex = -1);
 extern void audioCodecChanged(int newcodec);
 extern void videoCodecChanged(int newcodec);
@@ -123,6 +120,9 @@
   }
   switch (action)
     {
+        case ACT_JS_SHELL:
+                                interactiveECMAScript("dummy");
+                                return;
         case ACT_AVS_PROXY:
                                 GUI_avsProxy();
                                 return;

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names	2009-12-02 19:02:21 UTC (rev 5606)
@@ -151,3 +151,4 @@
 ACT(JOG)
 ACT(GLYPHEDIT)
 ACT(PLUGIN_INFO)
+ACT(JS_SHELL)

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui	2009-12-02 19:02:21 UTC (rev 5606)
@@ -1333,6 +1333,7 @@
     <addaction name="actionOCR"/>
     <addaction name="actionOCR_DVB_T_TS_files"/>
     <addaction name="actionGlyphs_Edit"/>
+    <addaction name="actionJavaScript_shell"/>
    </widget>
    <widget class="QMenu" name="menuEdit">
     <property name="title">
@@ -2328,6 +2329,11 @@
     <string>Plugins</string>
    </property>
   </action>
+  <action name="actionJavaScript_shell">
+   <property name="text">
+    <string>JavaScript shell</string>
+   </property>
+  </action>
  </widget>
  <customwidgets>
   <customwidget>

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/translation_table.h	2009-12-02 19:02:21 UTC (rev 5606)
@@ -69,7 +69,8 @@
 PROCESS(actionIPOD,ACT_AUTO_IPOD) \
 PROCESS(actionAdd_to_joblist,ACT_ADD_JOB) \
 PROCESS(actionShow_Joblist,ACT_HANDLE_JOB)  \
-PROCESS(actionPlugins,ACT_PLUGIN_INFO)  
+PROCESS(actionPlugins,ACT_PLUGIN_INFO) \
+PROCESS(actionJavaScript_shell,ACT_JS_SHELL) 
 
 #if 0
 PROCESS(actionPrevious_intra_frame,ACT_PreviousKFrame) \

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/CMakeLists.txt	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/CMakeLists.txt	2009-12-02 19:02:21 UTC (rev 5606)
@@ -0,0 +1,22 @@
+SET(ADM_LIB ADM_shellQt4)
+
+SET(    uiFiles
+        shell.ui  
+        )
+SET(headers
+	Q_shell.h
+)
+
+QT4_WRAP_UI(${ADM_LIB}_headers ${uiFiles})
+QT4_WRAP_CPP(${ADM_LIB}_source ${headers})
+
+SET(${ADM_LIB}_SRCS 
+	${${ADM_LIB}_headers}  ${${ADM_LIB}_source} 
+        Q_shell.cpp  
+        qt4Shell.cpp
+)
+
+INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})
+INCLUDE_DIRECTORIES("${CMAKE_SOURCE_DIR}/avidemux/ADM_UIs/ADM_QT4/include")
+INCLUDE_DIRECTORIES("${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/common/ADM_script/")
+ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp	2009-12-02 19:02:21 UTC (rev 5606)
@@ -0,0 +1,57 @@
+/***************************************************************************
+
+    \file Q_shell.cpp
+    \brief UI for qt4 shell interface
+    \author mean, fixount at free.fr 2007/2009
+        
+    
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include <vector>
+#include "ADM_inttype.h"
+#include <QtCore/QFileInfo>
+#include <QtCore/QUrl>
+#include <QtGui/QKeyEvent>
+#include <QtGui/QGraphicsView>
+#include "Q_shell.h"
+#include "ADM_default.h"
+#include "ui_shell.h"
+
+qShell::qShell(jsShellEvaluate *s) : QDialog()
+{
+    ADM_info("Setting up JS shell..\n");
+    evaluator=s;
+    ui.setupUi(this);
+    connect((ui.evalute),SIGNAL(clicked(bool)),this,SLOT(evaluate(bool)));
+}
+
+qShell::~qShell()
+{
+    ADM_info("Destroying JS shell..\n");
+} 
+bool qShell::run(void)
+{
+    this->exec();
+    return true;
+}
+bool            qShell::evaluate(bool x)
+{
+    ADM_info("Evaluating...\n");
+    // 1 Get text from UI
+    QString text=ui.textBrowser_2->toPlainText();
+    ui.textBrowser->append(text);
+    ui.textBrowser_2->setPlainText("");
+    evaluator(text.toAscii());
+    return true;
+}
+//EOF
+
+

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.h	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.h	2009-12-02 19:02:21 UTC (rev 5606)
@@ -0,0 +1,28 @@
+/**
+    \file Q_shell.h
+*/
+#ifndef Q_SHELL_H
+#define Q_SHELL_H
+#include "ADM_inttype.h"
+#include <QtGui/QItemDelegate>
+#include "ui_shell.h"
+#include "ADM_jsShell.h"
+/**
+    \class ADM_jsQt4Shell
+*/
+
+class qShell: public QDialog
+{
+	Q_OBJECT
+protected:
+    jsShellEvaluate      *evaluator;
+    Ui_SpiderMonkeyShell ui;
+public:
+                    qShell(jsShellEvaluate *s) ;
+    virtual         ~qShell() ;
+    bool            run(void);
+public slots:
+    bool            evaluate(bool x);
+};
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/qt4Shell.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/qt4Shell.cpp	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/qt4Shell.cpp	2009-12-02 19:02:21 UTC (rev 5606)
@@ -0,0 +1,21 @@
+/**
+        \file qt4Shell.cpp
+        \brief qt4 Specific js interactive shell
+*/
+
+#include "Q_shell.h"
+#include "ADM_default.h"
+
+/**
+        \fn ADM_createJsShell
+        \brief create the input for a js shell
+*/
+bool ADM_startShell(jsShellEvaluate eval)
+{
+        qShell *s= new qShell(eval);
+        s->run();
+        delete s;
+        return true;
+}
+//EOF
+

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/shell.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/shell.ui	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/shell.ui	2009-12-02 19:02:21 UTC (rev 5606)
@@ -0,0 +1,61 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<ui version="4.0">
+ <class>SpiderMonkeyShell</class>
+ <widget class="QDialog" name="SpiderMonkeyShell">
+  <property name="windowModality">
+   <enum>Qt::ApplicationModal</enum>
+  </property>
+  <property name="geometry">
+   <rect>
+    <x>0</x>
+    <y>0</y>
+    <width>558</width>
+    <height>336</height>
+   </rect>
+  </property>
+  <property name="windowTitle">
+   <string>Shell</string>
+  </property>
+  <property name="modal">
+   <bool>true</bool>
+  </property>
+  <widget class="QTextBrowser" name="textBrowser">
+   <property name="geometry">
+    <rect>
+     <x>20</x>
+     <y>0</y>
+     <width>511</width>
+     <height>191</height>
+    </rect>
+   </property>
+  </widget>
+  <widget class="QTextBrowser" name="textBrowser_2">
+   <property name="geometry">
+    <rect>
+     <x>20</x>
+     <y>190</y>
+     <width>511</width>
+     <height>91</height>
+    </rect>
+   </property>
+   <property name="readOnly">
+    <bool>false</bool>
+   </property>
+  </widget>
+  <widget class="QPushButton" name="evalute">
+   <property name="geometry">
+    <rect>
+     <x>430</x>
+     <y>300</y>
+     <width>97</width>
+     <height>24</height>
+    </rect>
+   </property>
+   <property name="text">
+    <string>Evaluate</string>
+   </property>
+  </widget>
+ </widget>
+ <resources/>
+ <connections/>
+</ui>

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/CMakeLists.txt	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/CMakeLists.txt	2009-12-02 19:02:21 UTC (rev 5606)
@@ -7,3 +7,4 @@
 subdirs (PREORDER ADM_filters)
 ADD_SUBDIRECTORY(ADM_dialog)
 ADD_SUBDIRECTORY(ADM_gui)
+ADD_SUBDIRECTORY(ADM_shell)

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2009-12-02 19:02:21 UTC (rev 5606)
@@ -84,6 +84,7 @@
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UIQT4)
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_guiQt4)
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UI_QT4)
+TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_shellQt4)
 ###########################################
 # Construct Core libraries
 ###########################################

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2009-12-02 19:02:21 UTC (rev 5606)
@@ -306,7 +306,11 @@
    // Do some sanity check
    if(_offset+paddingLen!=pakSize)
    {
-     printf("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! %d %d\n",_offset,paddingLen);
+     ADM_warning("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! %d+%d!=%d\n",_offset,paddingLen,pakSize);
+     if(pakSize>(_offset+paddingLen))
+     {
+        skip(pakSize-_offset-paddingLen);
+      }
    }
    currentPacket++;
    return 1;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp	2009-12-01 20:47:34 UTC (rev 5605)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp	2009-12-02 19:02:21 UTC (rev 5606)
@@ -61,7 +61,7 @@
      w=s->getWidth();
      h=s->getHeight();
         
-     if(!isMpeg12Compatible(fcc))
+     if(!isMpeg12Compatible(fcc) && !isH264Compatible(fcc))
      {
             printf("[ffTS] video not compatible\n");
             return false;



From mean at mail.berlios.de  Wed Dec  2 20:02:26 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 2 Dec 2009 20:02:26 +0100
Subject: [Avidemux-svn-commit] r5607 - in branches/avidemux_2.6_branch_mean:
	avidemux/cli avidemux/cli/ADM_userInterfaces
	avidemux/cli/ADM_userInterfaces/ADM_shell
	avidemux/common/ADM_script avidemux/gtk
	avidemux/gtk/ADM_userInterfaces
	avidemux/gtk/ADM_userInterfaces/ADM_shell
	avidemux/qt4/ADM_userInterfaces/ADM_shell
	avidemux_plugins/ADM_muxers/muxerffTS
Message-ID: <200912021902.nB2J2QGI010802@sheep.berlios.de>

Author: mean
Date: 2009-12-02 20:02:25 +0100 (Wed, 02 Dec 2009)
New Revision: 5607

Added:
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/cliShell.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/gtkShell.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/qt4Shell.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/shell.ui
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp
Log:
[Script/UI] Add a small interactive shell for javascript

Added: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/CMakeLists.txt	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/CMakeLists.txt	2009-12-02 19:02:25 UTC (rev 5607)
@@ -0,0 +1,8 @@
+SET(ADM_LIB ADM_shellCli)
+
+SET(${ADM_LIB}_SRCS 
+        cliShell.cpp
+)
+
+INCLUDE_DIRECTORIES("${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/common/ADM_script/")
+ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})

Added: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/cliShell.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/cliShell.cpp	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/cliShell.cpp	2009-12-02 19:02:25 UTC (rev 5607)
@@ -0,0 +1,37 @@
+/**
+        \file cliShell.cpp
+        \brief cli Specific js interactive shell
+*/
+
+
+#include "ADM_default.h"
+#include "ADM_jsShell.h"
+/**
+    \fn cliShellLogger
+    \brief Redirect output to the shell
+*/
+/*
+static bool cliShellLogger(void *cookie,const char *v)
+{
+    qShell *s=(qShell *)cookie;
+    s->print(v);
+    return true;
+}
+*/
+/**
+        \fn ADM_createJsShell
+        \brief create the input for a js shell
+*/
+bool ADM_startShell(jsShellEvaluate eval)
+{
+      /*  qShell *s= new qShell(eval);
+        ADM_jsRegisterLogger((void *)s,cliShellLogger);
+        s->run();
+        ADM_jsUnregisterLogger();
+        delete s;
+        return true;
+        */
+        return false;
+}
+//EOF
+

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt	2009-12-02 19:02:25 UTC (rev 5607)
@@ -67,6 +67,8 @@
 TARGET_LINK_LIBRARIES(avidemux3_cli ADM_gui2Cli6)
 TARGET_LINK_LIBRARIES(avidemux3_cli ADM_toolkitCli6)
 TARGET_LINK_LIBRARIES(avidemux3_cli ADM_UI_Cli6)
+TARGET_LINK_LIBRARIES(avidemux3_cli ADM_UI_Cli6)
+TARGET_LINK_LIBRARIES(avidemux3_cli ADM_shellCli)
 ###########################################
 # External libs
 ###########################################

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp	2009-12-02 19:02:25 UTC (rev 5607)
@@ -47,6 +47,7 @@
 std::vector <std::string> g_vIncludes;
 extern char **environ;
 extern char *script_getVar(char *in, int *r);
+extern bool jsLog(const char *v);
 
 JSBool displayError(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool displayInfo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
@@ -242,12 +243,16 @@
         *rval=STRING_TO_JSVAL(JS_NewStringCopyZ(cx,name));
         return JS_TRUE;
 }
+/**
+
+*/
 JSBool print(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin print
         if(argc != 1)
                 return JS_FALSE;
-	fprintf(stderr,"JSConsole: %s\n", JS_GetStringBytes(JS_ValueToString(cx, argv[0])));
+        char *out=JS_GetStringBytes(JS_ValueToString(cx, argv[0]));
+        jsLog(out);
         return JS_TRUE;
 }// end print
 /*****************************************************

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp	2009-12-02 19:02:25 UTC (rev 5607)
@@ -20,6 +20,10 @@
 #include "ADM_jsShell.h"
 void    A_Resync(void);
 
+
+static jsLoggerFunc *jsLogger=NULL;
+static void *jsLoggerCookie=NULL;
+
 /**
     \fn parseECMAScript
     \brief Compile & execute ecma script
@@ -64,4 +68,32 @@
 	A_Resync();
     ADM_info("Ending JS shell...\n");
 	return true;
-}
\ No newline at end of file
+}
+/**
+    \fn jsLog
+*/
+bool jsLog(const char *v)
+{
+    if(!jsLogger)
+        fprintf(stderr,"<i>%s</i>\n",v);
+    else    
+        jsLogger(jsLoggerCookie,v);
+    return true;
+}
+/**
+    \fn ADM_jsRegisterLogger
+*/
+bool ADM_jsRegisterLogger(void *cookie,jsLoggerFunc *fun)
+{
+    jsLoggerCookie=cookie;
+    jsLogger=fun;
+    return true;
+}
+/**
+    \fn ADM_jsUnregisterLogger
+*/
+bool ADM_jsUnregisterLogger(void)
+{
+    jsLogger=NULL;
+    return true;
+}

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h	2009-12-02 19:02:25 UTC (rev 5607)
@@ -19,4 +19,8 @@
 typedef bool (jsShellEvaluate)(const char *str);
 bool ADM_startShell(jsShellEvaluate *eval);
 
+typedef bool (jsLoggerFunc)(void *cookie,const char *);
+bool ADM_jsRegisterLogger(void *cookie,jsLoggerFunc *fun);
+bool ADM_jsUnregisterLogger(void);
+
 #endif // ADM_JS_SHELL_H
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/CMakeLists.txt	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/CMakeLists.txt	2009-12-02 19:02:25 UTC (rev 5607)
@@ -0,0 +1,8 @@
+SET(ADM_LIB ADM_shellGtk)
+
+SET(${ADM_LIB}_SRCS 
+        gtkShell.cpp
+)
+
+INCLUDE_DIRECTORIES("${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/common/ADM_script/")
+ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})

Added: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/gtkShell.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/gtkShell.cpp	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/gtkShell.cpp	2009-12-02 19:02:25 UTC (rev 5607)
@@ -0,0 +1,37 @@
+/**
+        \file gtkShell.cpp
+        \brief gtk Specific js interactive shell
+*/
+
+
+#include "ADM_default.h"
+#include "ADM_jsShell.h"
+/**
+    \fn gtkShellLogger
+    \brief Redirect output to the shell
+*/
+/*
+static bool gtkShellLogger(void *cookie,const char *v)
+{
+    qShell *s=(qShell *)cookie;
+    s->print(v);
+    return true;
+}
+*/
+/**
+        \fn ADM_createJsShell
+        \brief create the input for a js shell
+*/
+bool ADM_startShell(jsShellEvaluate eval)
+{
+      /*  qShell *s= new qShell(eval);
+        ADM_jsRegisterLogger((void *)s,gtkShellLogger);
+        s->run();
+        ADM_jsUnregisterLogger();
+        delete s;
+        return true;
+        */
+        return false;
+}
+//EOF
+

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/CMakeLists.txt	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/CMakeLists.txt	2009-12-02 19:02:25 UTC (rev 5607)
@@ -11,4 +11,5 @@
 ADD_SUBDIRECTORY(ADM_gui2)
 ADD_SUBDIRECTORY(ADM_ocr)
 ADD_SUBDIRECTORY(ADM_toolkit_gtk)
+ADD_SUBDIRECTORY(ADM_shell)
 ADD_SUBDIRECTORY(glade)

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt	2009-12-02 19:02:25 UTC (rev 5607)
@@ -74,6 +74,7 @@
 #TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_ocrGtk)
 TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_toolkitGtk)
 TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_UI_GTK)
+TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_shellGtk)
 ###########################################
 # External libs
 ###########################################

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp	2009-12-02 19:02:25 UTC (rev 5607)
@@ -52,6 +52,17 @@
     evaluator(text.toAscii());
     return true;
 }
+bool qShell::print(const char *s)
+{
+    ui.textBrowser->append(s);
+    return true;
+}
+bool qShell::clear(bool x)
+{
+    ui.textBrowser->clear();
+    return true;
+}
+
 //EOF
 
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.h	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.h	2009-12-02 19:02:25 UTC (rev 5607)
@@ -21,8 +21,10 @@
                     qShell(jsShellEvaluate *s) ;
     virtual         ~qShell() ;
     bool            run(void);
+    bool            print(const char *s);
 public slots:
     bool            evaluate(bool x);
+    bool            clear(bool x);
 };
 
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/qt4Shell.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/qt4Shell.cpp	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/qt4Shell.cpp	2009-12-02 19:02:25 UTC (rev 5607)
@@ -5,6 +5,16 @@
 
 #include "Q_shell.h"
 #include "ADM_default.h"
+/**
+    \fn qt4ShellLogger
+    \brief Redirect output to the shell
+*/
+static bool qt4ShellLogger(void *cookie,const char *v)
+{
+    qShell *s=(qShell *)cookie;
+    s->print(v);
+    return true;
+}
 
 /**
         \fn ADM_createJsShell
@@ -13,7 +23,9 @@
 bool ADM_startShell(jsShellEvaluate eval)
 {
         qShell *s= new qShell(eval);
+        ADM_jsRegisterLogger((void *)s,qt4ShellLogger);
         s->run();
+        ADM_jsUnregisterLogger();
         delete s;
         return true;
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/shell.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/shell.ui	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/shell.ui	2009-12-02 19:02:25 UTC (rev 5607)
@@ -25,9 +25,15 @@
      <x>20</x>
      <y>0</y>
      <width>511</width>
-     <height>191</height>
+     <height>161</height>
     </rect>
    </property>
+   <property name="focusPolicy">
+    <enum>Qt::NoFocus</enum>
+   </property>
+   <property name="contextMenuPolicy">
+    <enum>Qt::NoContextMenu</enum>
+   </property>
   </widget>
   <widget class="QTextBrowser" name="textBrowser_2">
    <property name="geometry">
@@ -54,7 +60,23 @@
    <property name="text">
     <string>Evaluate</string>
    </property>
+   <property name="shortcut">
+    <string>Ctrl+Return</string>
+   </property>
   </widget>
+  <widget class="QPushButton" name="clear">
+   <property name="geometry">
+    <rect>
+     <x>430</x>
+     <y>160</y>
+     <width>97</width>
+     <height>24</height>
+    </rect>
+   </property>
+   <property name="text">
+    <string>Clear</string>
+   </property>
+  </widget>
  </widget>
  <resources/>
  <connections/>

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp	2009-12-02 19:02:21 UTC (rev 5606)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp	2009-12-02 19:02:25 UTC (rev 5607)
@@ -104,7 +104,7 @@
         
         // /audio
         oc->mux_rate=30080*1000;
-        
+        audio_st->codec->bit_rate=a[0]->getInfo()->byterate*8;        
        
         oc->preload=3000; // 30 ms preloading
         oc->max_delay=2000; // 500 ms



From mean at mail.berlios.de  Thu Dec  3 07:14:06 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 3 Dec 2009 07:14:06 +0100
Subject: [Avidemux-svn-commit] r5608 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src
Message-ID: <200912030614.nB36E62Z017343@sheep.berlios.de>

Author: mean
Date: 2009-12-03 07:14:04 +0100 (Thu, 03 Dec 2009)
New Revision: 5608

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp
Log:
[core] fcntl.h include (arch/jh3h3 post)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp	2009-12-02 19:02:25 UTC (rev 5607)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp	2009-12-03 06:14:04 UTC (rev 5608)
@@ -20,7 +20,9 @@
 #include <errno.h>
 #include <sys/stat.h>
 #include <unistd.h>
-
+#ifndef __WIN32
+#include <fcntl.h>
+#endif
 #ifdef __WIN32
 #include <direct.h>
 #include <shlobj.h>



From mean at mail.berlios.de  Thu Dec  3 07:15:50 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 3 Dec 2009 07:15:50 +0100
Subject: [Avidemux-svn-commit] r5609 -
	branches/avidemux_2.5_branch_gruntster/po
Message-ID: <200912030615.nB36FoGN020501@sheep.berlios.de>

Author: mean
Date: 2009-12-03 07:15:48 +0100 (Thu, 03 Dec 2009)
New Revision: 5609

Modified:
   branches/avidemux_2.5_branch_gruntster/po/hu.po
Log:
[i18n] Hu update by alaci

Modified: branches/avidemux_2.5_branch_gruntster/po/hu.po
===================================================================
--- branches/avidemux_2.5_branch_gruntster/po/hu.po	2009-12-03 06:14:04 UTC (rev 5608)
+++ branches/avidemux_2.5_branch_gruntster/po/hu.po	2009-12-03 06:15:48 UTC (rev 5609)
@@ -8,8 +8,8 @@
 "Project-Id-Version: Avidemux 2.5+svn_5560\n"
 "Report-Msgid-Bugs-To: \n"
 "POT-Creation-Date: 2009-05-30 23:43+0200\n"
-"PO-Revision-Date: 2009-11-26 15:31+0100\n"
-"Last-Translator: Laszlo Andrassy <andrassy.laszlo at gmail.com>\n"
+"PO-Revision-Date: 2009-11-27 17:07+0100\n"
+"Last-Translator: Andr?ssy L?szl? <andrassy.laszlo at gmail.com>\n"
 "Language-Team: Hungarian\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
@@ -272,7 +272,7 @@
 
 #: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:303
 msgid "_Average bitrate (kb/s):"
-msgstr "_?tlagos bitr?ta (kb/s):"
+msgstr "?tlagos _bitr?ta (kb/s):"
 
 #: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:308
 msgid "-"
@@ -890,7 +890,7 @@
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_properties.cpp:221
 msgid "Frame Count:"
-msgstr "Frame ?sszeg:"
+msgstr "Frame mennyis?g:"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_properties.cpp:228
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_properties.cpp:406
@@ -899,7 +899,7 @@
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_properties.cpp:249
 msgid "Image Size:"
-msgstr "K?p m?rete:"
+msgstr "K?pm?ret:"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_properties.cpp:270
 msgid "Codec 4CC:"
@@ -1977,7 +1977,7 @@
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_about.cpp:62
 msgid "translator-credits"
-msgstr "Andr?ssy L?szl?, <andrassy.laszlo at gmail.com>"
+msgstr "Andr?ssy L?szl? <andrassy.laszlo at gmail.com>, 2009"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_exLame.cpp:63
 msgid "Lame command"
@@ -2208,7 +2208,7 @@
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:485
 msgid "_Paste"
-msgstr "_Beilleszt?s"
+msgstr "Bei_lleszt?s"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:496
 msgid "_Delete"
@@ -2224,7 +2224,7 @@
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:531
 msgid "Pre_ferences"
-msgstr "Be?ll?t?sok"
+msgstr "Be?ll?_t?sok"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:539
 msgid "_View"
@@ -3562,7 +3562,7 @@
 
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp:240
 msgid "_Use alternative tag for MP3 in .mp4"
-msgstr "Alternat?v MP3 Tag haszn?lata .mp4-ben"
+msgstr "Alternat?_v MP3 Tag haszn?lata .mp4-ben"
 
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp:244
 msgid "XVideo (best)"
@@ -3916,7 +3916,7 @@
 
 #: avidemux/ADM_outputs/oplug_avi/op_avisave.cpp:66
 msgid "Mux by packet size"
-msgstr "Multiplexel?s m?ret alapj?n"
+msgstr "Multiplexel?s csomagm?ret alapj?n"
 
 #: avidemux/ADM_outputs/oplug_avi/op_avisave.cpp:69
 msgid "Muxing _type:"
@@ -3932,7 +3932,7 @@
 
 #: avidemux/ADM_outputs/oplug_avi/op_avisave.cpp:73
 msgid "Mux in _blocks of x bytes:"
-msgstr "Multiplex?l?s x b?jtos blokkokban"
+msgstr "Multiplexel?s x b?jtos blokkokban"
 
 #: avidemux/ADM_outputs/oplug_avi/op_avisave.cpp:80
 msgid "AVI Muxer Options"



From mean at mail.berlios.de  Thu Dec  3 20:10:06 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 3 Dec 2009 20:10:06 +0100
Subject: [Avidemux-svn-commit] r5610 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec
Message-ID: <200912031910.nB3JA6AS032342@sheep.berlios.de>

Author: mean
Date: 2009-12-03 20:10:05 +0100 (Thu, 03 Dec 2009)
New Revision: 5610

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp
Log:
[DTS] Change channel decoding layout

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp	2009-12-03 06:15:48 UTC (rev 5609)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp	2009-12-03 19:10:05 UTC (rev 5610)
@@ -169,13 +169,25 @@
             {
             CHANNEL_TYPE *p_ch_type = channelMapping;
         #define DOIT(x,y) if(_context->channel_layout & CH_##x) *(p_ch_type++)=CHTYP_##y;
-                DOIT(LOW_FREQUENCY,LFE);
-                DOIT(FRONT_LEFT,FRONT_LEFT);
-                DOIT(FRONT_CENTER,FRONT_CENTER);
-                DOIT(FRONT_RIGHT,FRONT_RIGHT);
-                DOIT(SIDE_LEFT,REAR_LEFT);
-                DOIT(SIDE_RIGHT,REAR_RIGHT);
+                if(_context->codec_id == CODEC_ID_DTS)
+                {
+                    
+                    DOIT(FRONT_LEFT,FRONT_LEFT);
+                    DOIT(FRONT_RIGHT,FRONT_RIGHT);
+                    DOIT(FRONT_CENTER,FRONT_CENTER);
+                    DOIT(SIDE_LEFT,REAR_LEFT);
+                    DOIT(SIDE_RIGHT,REAR_RIGHT);
+                    DOIT(LOW_FREQUENCY,LFE);
 
+                }else   
+                {
+                    DOIT(LOW_FREQUENCY,LFE);
+                    DOIT(FRONT_LEFT,FRONT_LEFT);
+                    DOIT(FRONT_CENTER,FRONT_CENTER);
+                    DOIT(FRONT_RIGHT,FRONT_RIGHT);
+                    DOIT(SIDE_LEFT,REAR_LEFT);
+                    DOIT(SIDE_RIGHT,REAR_RIGHT);
+                }
             }
 
         }



From gruntster at mail.berlios.de  Thu Dec  3 20:13:29 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu, 3 Dec 2009 20:13:29 +0100
Subject: [Avidemux-svn-commit] r5611 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264
Message-ID: <200912031913.nB3JDTf8032552@sheep.berlios.de>

Author: gruntster
Date: 2009-12-03 20:13:25 +0100 (Thu, 03 Dec 2009)
New Revision: 5611

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
Log:
[x264] support old bframe as references setting

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2009-12-03 19:10:05 UTC (rev 5610)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2009-12-03 19:13:25 UTC (rev 5611)
@@ -1460,7 +1460,7 @@
 
 				if (strcmp(content, "strict") == 0)
 					bFrameReferences = 1;
-				else if (strcmp(content, "normal") == 0 || strcmp(content, "true") == 0)
+				else if (strcmp(content, "normal") == 0 || strcmp(content, "1") == 0)
 #if X264_BUILD >= 78
 					bFrameReferences = 2;
 #else

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2009-12-03 19:10:05 UTC (rev 5610)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2009-12-03 19:13:25 UTC (rev 5611)
@@ -219,8 +219,8 @@
                     <xs:enumeration value="normal"/>
 
                     <!-- boolean values deprecated core 78 -->
-                    <xs:enumeration value="true"/>
-                    <xs:enumeration value="false"/>
+                    <xs:enumeration value="0"/>
+                    <xs:enumeration value="1"/>
                   </xs:restriction>
                 </xs:simpleType>
               </xs:element>



From mean at mail.berlios.de  Fri Dec  4 07:48:01 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 4 Dec 2009 07:48:01 +0100
Subject: [Avidemux-svn-commit] r5612 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script
Message-ID: <200912040648.nB46m1xM027774@sheep.berlios.de>

Author: mean
Date: 2009-12-04 07:47:59 +0100 (Fri, 04 Dec 2009)
New Revision: 5612

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt
Log:
[JS] Put all debug functions in the same file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.cpp	2009-12-03 19:13:25 UTC (rev 5611)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.cpp	2009-12-04 06:47:59 UTC (rev 5612)
@@ -39,12 +39,13 @@
 JSFunctionSpec *ADM_JsVideoGetFunctions(void);
 JSPropertySpec *ADM_JsClassGetProperties(void);
 JSFunctionSpec *ADM_JsClassGetFunctions(void);
+JSFunctionSpec *ADM_JsDebugGetFunctions(void);
 
 static void dumpFunc(JSFunctionSpec *f)
 {
     while(f->name)
     {
-        printf("\t%s(..)\n",f->name);
+        jsLog(JS_LOG_NORMAL,"     %s(..)\n",f->name);
         f++;
     }
 }
@@ -52,7 +53,7 @@
 {
     while(f->name)
     {
-        printf("\t%s=xxx\n",f->name);
+        jsLog(JS_LOG_NORMAL,"     %s=xxx\n",f->name);
         f++;
     }
 }
@@ -62,18 +63,20 @@
 */
 void ADM_dumpJSHooks(void)
 {
-    printf("Dumping JS interface\n");
-    printf("********************\n");
-    printf("app.\n");
+    jsLog(JS_LOG_NORMAL,"Dumping JS interface\n");
+    jsLog(JS_LOG_NORMAL,"********************\n");
+    jsLog(JS_LOG_NORMAL,"Debug functions :\n");
+    dumpFunc(ADM_JsDebugGetFunctions());
+    jsLog(JS_LOG_NORMAL,"app.\n");
     dumpFunc(ADM_JsClassGetFunctions());
     dumpProps(ADM_JsClassGetProperties());
-    printf("app.video\n");
+    jsLog(JS_LOG_NORMAL,"app.video\n");
     dumpFunc(ADM_JsVideoGetFunctions());
     dumpProps(ADM_JsVideoGetProperties());
-    printf("app.audio\n");
+    jsLog(JS_LOG_NORMAL,"app.audio\n");
     dumpFunc(ADM_JsAudioGetFunctions());
     dumpProps(ADM_JsAudioGetProperties());
-    printf("Done\n");
-    printf("****\n");
+    jsLog(JS_LOG_NORMAL,"Done\n");
+    jsLog(JS_LOG_NORMAL,"****\n");
 
 }
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp	2009-12-03 19:13:25 UTC (rev 5611)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp	2009-12-04 06:47:59 UTC (rev 5612)
@@ -0,0 +1,147 @@
+/**
+    \file ADM_JSDebug.cpp
+    \brief Debug oriented functions for avidemux JS/JS shell
+    \author mean (c) 2009 fixounet at free.fr
+
+
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_default.h"
+#include <string.h>
+#include <pthread.h>
+#include "DIA_coreToolkit.h"
+#include "ADM_JSGlobal.h"
+#include "ADM_JSDebug.h"
+#include "ADM_JSif.h"
+/**/
+
+JS_PROTOTYPE displayError;
+JS_PROTOTYPE displayInfo;
+JS_PROTOTYPE print;
+JS_PROTOTYPE displayInfo;
+JS_PROTOTYPE assertTest;
+JS_PROTOTYPE crashTest;
+JS_PROTOTYPE help;
+/**/
+static JSFunctionSpec adm_debug_functions[] = {
+  /*    name          native          nargs    */
+  {"displayError",  displayError,       1},
+  {"displayInfo",   displayInfo,        1},
+  {"print",         print,              1},
+  {"assert",        assertTest,         0},
+  {"crashTest",     crashTest,          0},
+  {"help",          help,               0},
+  {0}
+};
+
+void ADM_dumpJSHooks(void);
+/**
+    \fn JS_AvidemuxRegisterDebugFunction
+*/
+bool JS_AvidemuxRegisterDebugFunction(JSContext *cx,JSObject *global)
+{
+	if(JS_DefineFunctions(cx, global, adm_debug_functions) == true)
+		return true;
+
+	ADM_warning("Unable to define functions\n");
+	return false;
+}
+/**
+    \fn ADM_JsDebugGetFunctions
+
+*/
+JSFunctionSpec *ADM_JsDebugGetFunctions(void)
+{
+    return adm_debug_functions;
+}
+
+/**
+    \fn displayError
+    \brief error popup
+*/
+JSBool displayError(JSContext *cx, JSObject *obj, uintN argc, 
+                                       jsval *argv, jsval *rval)
+{// begin displayError
+	// default return value
+	if(argc != 1)
+		return JS_FALSE;
+	if(JSVAL_IS_STRING(argv[0]) == false)
+		return JS_FALSE;
+	char  *stringa = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
+	GUI_Verbose();
+	GUI_Error_HIG("Error",stringa);
+	GUI_Quiet();
+
+	return JS_TRUE;
+}// end displayError
+/**
+    \fn displayInfo
+    \brief info popup
+*/
+
+JSBool displayInfo(JSContext *cx, JSObject *obj, uintN argc, 
+                                       jsval *argv, jsval *rval)
+{// begin displayInfo
+	// default return value
+	if(argc != 1)
+		return JS_FALSE;
+	if(JSVAL_IS_STRING(argv[0]) == false)
+		return JS_FALSE;
+	char  *stringa = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
+	GUI_Verbose();
+	GUI_Info_HIG(ADM_LOG_IMPORTANT,"Info",stringa);
+	GUI_Quiet();
+	return JS_TRUE;
+}// end displayInfo
+ /**
+    \fn print
+*/
+JSBool print(JSContext *cx, JSObject *obj, uintN argc, 
+                                       jsval *argv, jsval *rval)
+{// begin print
+        if(argc != 1)
+                return JS_FALSE;
+        char *out=JS_GetStringBytes(JS_ValueToString(cx, argv[0]));
+        jsLog(JS_LOG_NORMAL,"%s",out);
+        return JS_TRUE;
+}// end print
+/**
+    \fn crashTest
+    \brief Force a crash
+*/
+JSBool crashTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+  
+  int *foobar=NULL;
+  *foobar=0; // CRASH!
+  return JS_TRUE;
+}
+/**
+    \fn assertTest
+    \brief Force a crash
+*/
+JSBool assertTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+  
+  ADM_assert(0);
+  return JS_TRUE;
+}
+/**
+    \fn help
+    \brief dump avidemux specific functions
+*/
+JSBool help(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+  
+  ADM_dumpJSHooks();
+  return JS_TRUE;
+}
+
+// EOF
\ No newline at end of file

Copied: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.h (from rev 5607, branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h	2009-12-02 19:02:25 UTC (rev 5607)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.h	2009-12-04 06:47:59 UTC (rev 5612)
@@ -0,0 +1,22 @@
+/**
+    \file ADM_JSDebug.h
+    \brief Debug oriented functions for avidemux JS/JS shell
+    \author mean (c) 2009 fixounet at free.fr
+
+
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef ADMJS_DEBUG_H
+#define ADMJS_DEBUG_H
+
+
+
+#endif
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp	2009-12-03 19:13:25 UTC (rev 5611)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp	2009-12-04 06:47:59 UTC (rev 5612)
@@ -47,14 +47,11 @@
 std::vector <std::string> g_vIncludes;
 extern char **environ;
 extern char *script_getVar(char *in, int *r);
-extern bool jsLog(const char *v);
 
-JSBool displayError(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool displayInfo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
+
 JSBool fileWriteSelect(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool dirSelect(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool fileReadSelect(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool print(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 
 JSBool allFilesFrom(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool nextFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
@@ -84,18 +81,13 @@
 JSBool facNotch(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool facThreadCount(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool facSlider(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool crashTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool assertTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 
 
 static JSFunctionSpec adm_functions[] = {
   /*    name          native          nargs    */
-  {"displayError",      displayError,         1},
-  {"displayInfo",       displayInfo,        1},
   {"fileReadSelect",    fileReadSelect,        0},
   {"fileWriteSelect",   fileWriteSelect,        0},
   {"dirSelect",         dirSelect,        0},
-  {"print",             print,        1},
   {"allFilesFrom",      allFilesFrom,        0},
   {"nextFile",          nextFile,        0},
   {"setSuccess",          setSuccess,        1},
@@ -121,8 +113,6 @@
   {"dialogFactoryMatrix",       facMatrix,        0},
   {"dialogFactoryNotch",       facNotch,		  0},
   {"dialogFactoryThreadCount", facThreadCount,		  0},
-  {"crashTest",               crashTest,          0},
-  {"assertTest",               assertTest,        0},
   {0}
 };
 
@@ -174,36 +164,6 @@
 	return JS_TRUE;
 }// end setSuccess
 
-JSBool displayError(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin displayError
-	// default return value
-	if(argc != 1)
-		return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-	char  *stringa = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-	GUI_Verbose();
-	GUI_Error_HIG("Error",stringa);
-	GUI_Quiet();
-
-	return JS_TRUE;
-}// end displayError
-JSBool displayInfo(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin displayInfo
-	// default return value
-	if(argc != 1)
-		return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-	char  *stringa = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-	GUI_Verbose();
-	GUI_Info_HIG(ADM_LOG_IMPORTANT,"Info",stringa);
-	GUI_Quiet();
-	return JS_TRUE;
-}// end displayInfo
-
 JSBool fileReadSelect(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin fileReadSelect
@@ -243,18 +203,6 @@
         *rval=STRING_TO_JSVAL(JS_NewStringCopyZ(cx,name));
         return JS_TRUE;
 }
-/**
-
-*/
-JSBool print(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin print
-        if(argc != 1)
-                return JS_FALSE;
-        char *out=JS_GetStringBytes(JS_ValueToString(cx, argv[0]));
-        jsLog(out);
-        return JS_TRUE;
-}// end print
 /*****************************************************
         To process a whole directiry at a time
 *******************************************************/
@@ -503,18 +451,5 @@
   return JS_TRUE;
 }// end systemExecute
 
-JSBool crashTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  
-  int *foobar=NULL;
-  *foobar=0; // CRASH!
-  return JS_TRUE;
-}
-JSBool assertTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  
-  ADM_assert(0);
-  return JS_TRUE;
-}
 
 //EOF 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.cpp	2009-12-03 19:13:25 UTC (rev 5611)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.cpp	2009-12-04 06:47:59 UTC (rev 5612)
@@ -19,49 +19,46 @@
 #include "ADM_JSAvidemux.h"
 #include "ADM_JSDirectorySearch.h"
 #include "ADM_jsShell.h"
-
+#include <stdarg.h>
 extern uint8_t JS_AvidemuxFunction(JSContext *cx,JSObject *global);
+extern bool JS_AvidemuxRegisterDebugFunction(JSContext *cx,JSObject *global);
 extern void A_Resync(void);
+extern bool isJsLogRedirected(void);
 extern char * actual_workbench_file;
-
-void
-printJSError(JSContext *cx, const char *message, JSErrorReport *report)
+/**
+    \fn printJSError
+*/
+void  printJSError(JSContext *cx, const char *message, JSErrorReport *report)
 {// begin printJSError
 int quiet=GUI_isQuiet();
 char buf[4];
 FILE *fd = ADM_fopen(report->filename,"rb");
-        if(quiet)
-                GUI_Verbose();
-	if( fd ){
+    if(quiet)
+            GUI_Verbose();
+	if( fd )
+    {
 		fread(buf,1,4,fd);
 		fclose(fd);
 	}
-	if( strncmp(buf,"//AD",4) ){
+	if( strncmp(buf,"//AD",4) )
+    {
             if (report->filename || report->lineno)
-		GUI_Error_HIG("Spidermonkey ECMAScript Error",
-		              "%s: line %d:\nMsg: %s\n"
+                jsLog(JS_LOG_ERROR,"%s: line %d:\nMsg: %s\n"
                               "Not an ECMAScript file. Try open it with 'File' -> 'Open...'",
                               report->filename,
                               report->lineno,
                               message);
             else
-		GUI_Error_HIG("Spidermonkey ECMAScript Error",
-                              "Not an ECMAScript file. Try open it with 'File' -> 'Open...'");
-	}else{
-		GUI_Error_HIG("Spidermonkey ECMAScript Error", 
-			"%s: line %d:\nMsg: %s\n",
-			report->filename,
-			report->lineno,
-			message);
+                jsLog(JS_LOG_ERROR,"Not an ECMAScript file. Try open it with 'File' -> 'Open...'");
+    
+	}else
+    {
+            jsLog(JS_LOG_ERROR,"%s: line %d:\nMsg: %s\n",report->filename,report->lineno,message);
 	}
-        fprintf(stderr, "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  Spidermonkey ECMAScript Error\n");
-        if (report->filename || report->lineno)
-            fprintf(stderr, "\t%s: line %d:\n\tMsg: %s\n",
-                   report->filename, report->lineno, message);
+       
+    if(quiet)
+            GUI_Quiet();
 
-        if(quiet)
-                GUI_Quiet();
-
 }// end printJSError
 
 bool SpidermonkeyInit()
@@ -97,7 +94,8 @@
 			JSObject *dsObj = ADM_JSDirectorySearch::JSInit(cx, global);
 			// register error handler
 			JS_SetErrorReporter(cx, printJSError);
-                        JS_AvidemuxFunction(cx,global);
+            JS_AvidemuxFunction(cx,global);
+            JS_AvidemuxRegisterDebugFunction(cx,global);
 			return true;
 		}// end context created
 	}// end runtime created

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.h	2009-12-03 19:13:25 UTC (rev 5611)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.h	2009-12-04 06:47:59 UTC (rev 5612)
@@ -5,16 +5,19 @@
 
 #include "ADM_smjs/jsapi.h"
 #include <pthread.h>
+#include "ADM_JSif.h"
+bool jsLog(JS_LOG_TYPE type, const char *fmt,...);
 
 // javscript debugging helper
 void printJSError(JSContext *cx, const char *message, JSErrorReport *report);
 bool SpidermonkeyInit();
 void SpidermonkeyDestroy();
-bool parseECMAScript(const char *name);
-bool interactiveECMAScript(const char *name);
 void JS_setSuccess(bool bSuccess);
 void *StartThreadSpidermonkey(void *pData);
 
+
+typedef JSBool JS_PROTOTYPE(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
+
 #ifdef JSDECLARE
 #define JSVAR(a,b,c) a b=c
 #else

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp	2009-12-03 19:13:25 UTC (rev 5611)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp	2009-12-04 06:47:59 UTC (rev 5612)
@@ -18,9 +18,10 @@
 #include "ADM_JSGlobal.h"
 #include "ADM_JSAvidemux.h"
 #include "ADM_jsShell.h"
+#include "ADM_JSif.h"
+#include <stdarg.h>
+
 void    A_Resync(void);
-
-
 static jsLoggerFunc *jsLogger=NULL;
 static void *jsLoggerCookie=NULL;
 
@@ -49,6 +50,14 @@
 	return g_bJSSuccess;
 }// end parseECMAScript
 /**
+    \fn jsLogger
+*/
+bool isJsLogRedirected(void)
+{
+    if(jsLogger) return true;
+    return false;
+}
+/**
     \fn jsEvaluate
 */
 static bool jsEvaluate(const char *str)
@@ -72,13 +81,25 @@
 /**
     \fn jsLog
 */
-bool jsLog(const char *v)
+bool jsLog(JS_LOG_TYPE type, const char *prf,...)
 {
-    if(!jsLogger)
-        fprintf(stderr,"<i>%s</i>\n",v);
-    else    
-        jsLogger(jsLoggerCookie,v);
-    return true;
+ static char print_buffer[1024];
+  	
+		va_list 	list;
+		va_start(list,	prf);
+		vsnprintf(print_buffer,1023,prf,list);
+		va_end(list);
+		print_buffer[1023]=0; // ensure the string is terminated
+        if(true==isJsLogRedirected())
+            jsLogger(jsLoggerCookie,type,print_buffer);
+        else
+        {
+            if(type==JS_LOG_ERROR)
+                GUI_Error_HIG("Spidermonkey ECMAScript Error","%s",print_buffer);
+            else
+                ADM_warning("[JS]%s",print_buffer);
+        }
+        return true;
 }
 /**
     \fn ADM_jsRegisterLogger

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h	2009-12-03 19:13:25 UTC (rev 5611)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h	2009-12-04 06:47:59 UTC (rev 5612)
@@ -13,7 +13,26 @@
  ***************************************************************************/
 #ifndef ADM_JS_IF_H
 #define ADM_JS_IF_H
+
 /**
+    \enum JS_LOG_TYPE
+*/
+typedef enum
+{
+    JS_LOG_NORMAL,
+    JS_LOG_ERROR
+}JS_LOG_TYPE;
+/**
+    \typedef jsLoggerFunc
+*/
+typedef bool (jsLoggerFunc)(void *cookie,JS_LOG_TYPE type,const char *);
+/*
+
+*/
+bool ADM_jsRegisterLogger(void *cookie,jsLoggerFunc *fun);
+bool ADM_jsUnregisterLogger(void);
+
+/**
     \fn parseECMAScript
     \brief Compile & execute ecma script
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h	2009-12-03 19:13:25 UTC (rev 5611)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h	2009-12-04 06:47:59 UTC (rev 5612)
@@ -15,12 +15,9 @@
 
 #ifndef ADM_JS_SHELL_H
 #define ADM_JS_SHELL_H
-
+#include "ADM_JSif.h"
 typedef bool (jsShellEvaluate)(const char *str);
 bool ADM_startShell(jsShellEvaluate *eval);
 
-typedef bool (jsLoggerFunc)(void *cookie,const char *);
-bool ADM_jsRegisterLogger(void *cookie,jsLoggerFunc *fun);
-bool ADM_jsUnregisterLogger(void);
 
 #endif // ADM_JS_SHELL_H
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt	2009-12-03 19:13:25 UTC (rev 5611)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt	2009-12-04 06:47:59 UTC (rev 5612)
@@ -2,7 +2,7 @@
 	ADM_AvidemuxAudio.cpp  ADM_AvidemuxVideo.cpp    ADM_JSAvidemux.cpp       ADM_JSDirectorySearch.cpp  ADM_JSGlobal.cpp
 	ADM_Avidemux.cpp       ADM_JSAvidemuxAudio.cpp  ADM_JSAvidemuxVideo.cpp  ADM_JSFunctions.cpp        DirectorySearch.cpp
         ADM_JSFunctionsNonRegFactory.cpp
-        ADM_JSif.cpp
+        ADM_JSif.cpp ADM_JSDebug.cpp
 )
 
 ADD_LIBRARY(ADM_script6 STATIC ${ADM_script_SRCS})



From mean at mail.berlios.de  Fri Dec  4 07:48:06 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 4 Dec 2009 07:48:06 +0100
Subject: [Avidemux-svn-commit] r5613 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell
Message-ID: <200912040648.nB46m6v5027845@sheep.berlios.de>

Author: mean
Date: 2009-12-04 07:48:05 +0100 (Fri, 04 Dec 2009)
New Revision: 5613

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/qt4Shell.cpp
Log:
[QT4] I/f for js shell

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp	2009-12-04 06:47:59 UTC (rev 5612)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp	2009-12-04 06:48:05 UTC (rev 5613)
@@ -31,6 +31,8 @@
     evaluator=s;
     ui.setupUi(this);
     connect((ui.evalute),SIGNAL(clicked(bool)),this,SLOT(evaluate(bool)));
+    connect((ui.clear),SIGNAL(clicked(bool)),this,SLOT(clear(bool)));
+    print(JS_LOG_NORMAL,"Enter your commands then press the evaluate button or CTRL+ENTER\nReady.\n");
 }
 
 qShell::~qShell()
@@ -47,16 +49,32 @@
     ADM_info("Evaluating...\n");
     // 1 Get text from UI
     QString text=ui.textBrowser_2->toPlainText();
+    ui.textBrowser->setFontItalic(true);
     ui.textBrowser->append(text);
+    ui.textBrowser->setFontItalic(false);
     ui.textBrowser_2->setPlainText("");
     evaluator(text.toAscii());
     return true;
 }
-bool qShell::print(const char *s)
+/**
+    \fn print
+*/
+bool qShell::print(JS_LOG_TYPE type,const char *s)
 {
-    ui.textBrowser->append(s);
+    QString string(s);
+    //printf("**%s",s);
+    switch(type)
+    {
+        case JS_LOG_NORMAL: ui.textBrowser->setTextColor(QColor(0,0,0));break;
+        case JS_LOG_ERROR : ui.textBrowser->setTextColor(QColor(255,0,0));break;
+    }
+    ui.textBrowser->append(string.toAscii());
+    ui.textBrowser->setTextColor(QColor(0,0,0));
     return true;
 }
+/**
+    \fn clear
+*/
 bool qShell::clear(bool x)
 {
     ui.textBrowser->clear();

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.h	2009-12-04 06:47:59 UTC (rev 5612)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.h	2009-12-04 06:48:05 UTC (rev 5613)
@@ -21,7 +21,7 @@
                     qShell(jsShellEvaluate *s) ;
     virtual         ~qShell() ;
     bool            run(void);
-    bool            print(const char *s);
+    bool            print(JS_LOG_TYPE type, const char *s);
 public slots:
     bool            evaluate(bool x);
     bool            clear(bool x);

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/qt4Shell.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/qt4Shell.cpp	2009-12-04 06:47:59 UTC (rev 5612)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/qt4Shell.cpp	2009-12-04 06:48:05 UTC (rev 5613)
@@ -9,10 +9,10 @@
     \fn qt4ShellLogger
     \brief Redirect output to the shell
 */
-static bool qt4ShellLogger(void *cookie,const char *v)
+static bool qt4ShellLogger(void *cookie,JS_LOG_TYPE type,const char *v)
 {
     qShell *s=(qShell *)cookie;
-    s->print(v);
+    s->print(type,v);
     return true;
 }
 



From mean at mail.berlios.de  Fri Dec  4 19:49:29 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 4 Dec 2009 19:49:29 +0100
Subject: [Avidemux-svn-commit] r5614 - in
	branches/avidemux_2.6_branch_mean/avidemux: common/ADM_script
	qt4/ADM_userInterfaces/ADM_shell
Message-ID: <200912041849.nB4InTQi030423@sheep.berlios.de>

Author: mean
Date: 2009-12-04 19:49:29 +0100 (Fri, 04 Dec 2009)
New Revision: 5614

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/shell.ui
Log:
[JS] Add tiny debug function

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.cpp	2009-12-04 06:48:05 UTC (rev 5613)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.cpp	2009-12-04 18:49:29 UTC (rev 5614)
@@ -45,7 +45,7 @@
 {
     while(f->name)
     {
-        jsLog(JS_LOG_NORMAL,"     %s(..)\n",f->name);
+        jsLog(JS_LOG_NORMAL,"     %s(..)",f->name);
         f++;
     }
 }
@@ -53,7 +53,7 @@
 {
     while(f->name)
     {
-        jsLog(JS_LOG_NORMAL,"     %s=xxx\n",f->name);
+        jsLog(JS_LOG_NORMAL,"     %s=xxx",f->name);
         f++;
     }
 }
@@ -63,20 +63,20 @@
 */
 void ADM_dumpJSHooks(void)
 {
-    jsLog(JS_LOG_NORMAL,"Dumping JS interface\n");
-    jsLog(JS_LOG_NORMAL,"********************\n");
-    jsLog(JS_LOG_NORMAL,"Debug functions :\n");
+    jsLog(JS_LOG_NORMAL,"Dumping JS interface");
+    jsLog(JS_LOG_NORMAL,"********************");
+    jsLog(JS_LOG_NORMAL,"Debug functions :");
     dumpFunc(ADM_JsDebugGetFunctions());
-    jsLog(JS_LOG_NORMAL,"app.\n");
+    jsLog(JS_LOG_NORMAL,"app.");
     dumpFunc(ADM_JsClassGetFunctions());
     dumpProps(ADM_JsClassGetProperties());
-    jsLog(JS_LOG_NORMAL,"app.video\n");
+    jsLog(JS_LOG_NORMAL,"app.video");
     dumpFunc(ADM_JsVideoGetFunctions());
     dumpProps(ADM_JsVideoGetProperties());
-    jsLog(JS_LOG_NORMAL,"app.audio\n");
+    jsLog(JS_LOG_NORMAL,"app.audio");
     dumpFunc(ADM_JsAudioGetFunctions());
     dumpProps(ADM_JsAudioGetProperties());
-    jsLog(JS_LOG_NORMAL,"Done\n");
-    jsLog(JS_LOG_NORMAL,"****\n");
+    jsLog(JS_LOG_NORMAL,"Done");
+    jsLog(JS_LOG_NORMAL,"****");
 
 }
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp	2009-12-04 06:48:05 UTC (rev 5613)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp	2009-12-04 18:49:29 UTC (rev 5614)
@@ -67,10 +67,6 @@
     { "hasGmc", hasGmc, 0, 0, 0 },        // Postprocess
     { "frameSize", getFrameSize, 1, 0, 0 },        // FrameSize
     { "frameType", getFrameType, 1, 0, 0 },        // Postprocess
-
-
-    { "dumpEditing", dumpEditing,0,0,0},
-    { "dumpTiming", dumpTiming,0,0,0},
 	{ 0 }
 };
 /*********************************/
@@ -540,45 +536,8 @@
 #endif
         return JS_TRUE;
 }// end PostProcess
+
 /**
-    \fn dumpEditing
-    \brief dump segment, video & all
-*/
-JSBool ADM_JSAvidemuxVideo::dumpEditing(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-uint32_t info;
-uint32_t frame;
-uint32_t sz;
-        if(argc != 0)
-          return JS_FALSE;
-  
-        enterLock();
-        video_body->dumpEditing();
-        leaveLock(); 
-        
-        return JS_TRUE;
-}// end PostProcess
-/**
-    \fn dumpTiming
-    \brief dump segment, video & all
-*/
-JSBool ADM_JSAvidemuxVideo::dumpTiming(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-uint32_t info;
-uint32_t frame;
-uint32_t sz;
-        if(argc != 0)
-          return JS_FALSE;
-  
-        enterLock();
-        video_body->dumpTiming();
-        leaveLock(); 
-        
-        return JS_TRUE;
-}// end PostProcess
-/**
     \fn A_setVideoCodec
 */
 bool A_setVideoCodec(const char *nm)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp	2009-12-04 06:48:05 UTC (rev 5613)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp	2009-12-04 18:49:29 UTC (rev 5614)
@@ -17,9 +17,11 @@
 #include <string.h>
 #include <pthread.h>
 #include "DIA_coreToolkit.h"
+
 #include "ADM_JSGlobal.h"
 #include "ADM_JSDebug.h"
 #include "ADM_JSif.h"
+#include "ADM_editor/ADM_edit.hxx"
 /**/
 
 JS_PROTOTYPE displayError;
@@ -29,7 +31,16 @@
 JS_PROTOTYPE assertTest;
 JS_PROTOTYPE crashTest;
 JS_PROTOTYPE help;
+JS_PROTOTYPE dumpEditing;
+JS_PROTOTYPE dumpTiming;
 /**/
+
+extern JSFunctionSpec *ADM_JsAudioGetFunctions(void);
+extern JSFunctionSpec *ADM_JsVideoGetFunctions(void);
+extern JSFunctionSpec *ADM_JsClassGetFunctions(void);
+extern JSFunctionSpec *ADM_JsDebugGetFunctions(void);
+
+/**/
 static JSFunctionSpec adm_debug_functions[] = {
   /*    name          native          nargs    */
   {"displayError",  displayError,       1},
@@ -38,9 +49,11 @@
   {"assert",        assertTest,         0},
   {"crashTest",     crashTest,          0},
   {"help",          help,               0},
+  {"dumpEditing",   dumpEditing,        0},
+  {"dumpTiming",    dumpTiming,         0},
   {0}
 };
-
+extern ADM_Composer *video_body;
 void ADM_dumpJSHooks(void);
 /**
     \fn JS_AvidemuxRegisterDebugFunction
@@ -133,15 +146,84 @@
   ADM_assert(0);
   return JS_TRUE;
 }
+
+static void dumpFunc(JSFunctionSpec *f)
+{
+    while(f->name)
+    {
+        jsLog(JS_LOG_NORMAL,"     %s(..)",f->name);
+        f++;
+    }
+}
 /**
     \fn help
     \brief dump avidemux specific functions
 */
 JSBool help(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
+        if(!argc)
+        {
+            jsLog(JS_LOG_NORMAL,"help(\"video\"); or help(\"audio\"); or help(\"debug\"); or debug(\"functions\"");
+            return JS_TRUE;
+        }
+        if(argc != 1)
+        {
+          jsLog(JS_LOG_ERROR,"help accepts only one arg, type help() to get them\n");
+          return JS_FALSE;
+        } 
+        JSFunctionSpec *table=NULL;
+        char *f=JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
+        
+#define DUMPTABLE(x,y) if(!strcasecmp(f,#x)) table=y();
+        if(f)
+        {
+            DUMPTABLE(audio,ADM_JsAudioGetFunctions);
+            DUMPTABLE(video,ADM_JsVideoGetFunctions);
+            DUMPTABLE(debug,ADM_JsDebugGetFunctions);
+            DUMPTABLE(functions,ADM_JsClassGetFunctions);
+        }
+        if(table) dumpFunc(table);
+        else jsLog(JS_LOG_ERROR,"%s not found",f);
   
-  ADM_dumpJSHooks();
   return JS_TRUE;
 }
-
+/**
+    \fn dumpEditing
+    \brief dump segment, video & all
+*/
+JSBool dumpEditing(JSContext *cx, JSObject *obj, uintN argc, 
+                                       jsval *argv, jsval *rval)
+{// begin PostProcess
+uint32_t info;
+uint32_t frame;
+uint32_t sz;
+        if(argc)
+        {
+            return JS_FALSE;
+        }
+        enterLock();
+        video_body->dumpEditing();
+        leaveLock(); 
+        
+        return JS_TRUE;
+}// end PostProcess
+/**
+    \fn dumpTiming
+    \brief dump segment, video & all
+*/
+JSBool dumpTiming(JSContext *cx, JSObject *obj, uintN argc, 
+                                       jsval *argv, jsval *rval)
+{// begin PostProcess
+uint32_t info;
+uint32_t frame;
+uint32_t sz;
+        if(argc != 0)
+          return JS_FALSE;
+  
+        enterLock();
+        video_body->dumpTiming();
+        leaveLock(); 
+        
+        return JS_TRUE;
+}// end PostProcess
 // EOF
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp	2009-12-04 06:48:05 UTC (rev 5613)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp	2009-12-04 18:49:29 UTC (rev 5614)
@@ -97,7 +97,7 @@
             if(type==JS_LOG_ERROR)
                 GUI_Error_HIG("Spidermonkey ECMAScript Error","%s",print_buffer);
             else
-                ADM_warning("[JS]%s",print_buffer);
+                ADM_warning("[JS]%s\n",print_buffer);
         }
         return true;
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/shell.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/shell.ui	2009-12-04 06:48:05 UTC (rev 5613)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/shell.ui	2009-12-04 18:49:29 UTC (rev 5614)
@@ -9,8 +9,8 @@
    <rect>
     <x>0</x>
     <y>0</y>
-    <width>558</width>
-    <height>336</height>
+    <width>619</width>
+    <height>384</height>
    </rect>
   </property>
   <property name="windowTitle">
@@ -19,64 +19,94 @@
   <property name="modal">
    <bool>true</bool>
   </property>
-  <widget class="QTextBrowser" name="textBrowser">
-   <property name="geometry">
-    <rect>
-     <x>20</x>
-     <y>0</y>
-     <width>511</width>
-     <height>161</height>
-    </rect>
-   </property>
-   <property name="focusPolicy">
-    <enum>Qt::NoFocus</enum>
-   </property>
-   <property name="contextMenuPolicy">
-    <enum>Qt::NoContextMenu</enum>
-   </property>
-  </widget>
-  <widget class="QTextBrowser" name="textBrowser_2">
-   <property name="geometry">
-    <rect>
-     <x>20</x>
-     <y>190</y>
-     <width>511</width>
-     <height>91</height>
-    </rect>
-   </property>
-   <property name="readOnly">
-    <bool>false</bool>
-   </property>
-  </widget>
-  <widget class="QPushButton" name="evalute">
-   <property name="geometry">
-    <rect>
-     <x>430</x>
-     <y>300</y>
-     <width>97</width>
-     <height>24</height>
-    </rect>
-   </property>
-   <property name="text">
-    <string>Evaluate</string>
-   </property>
-   <property name="shortcut">
-    <string>Ctrl+Return</string>
-   </property>
-  </widget>
-  <widget class="QPushButton" name="clear">
-   <property name="geometry">
-    <rect>
-     <x>430</x>
-     <y>160</y>
-     <width>97</width>
-     <height>24</height>
-    </rect>
-   </property>
-   <property name="text">
-    <string>Clear</string>
-   </property>
-  </widget>
+  <layout class="QGridLayout" name="gridLayout">
+   <item row="0" column="0" colspan="4">
+    <widget class="QTextBrowser" name="textBrowser">
+     <property name="focusPolicy">
+      <enum>Qt::NoFocus</enum>
+     </property>
+     <property name="contextMenuPolicy">
+      <enum>Qt::NoContextMenu</enum>
+     </property>
+    </widget>
+   </item>
+   <item row="1" column="0">
+    <spacer name="horizontalSpacer">
+     <property name="orientation">
+      <enum>Qt::Horizontal</enum>
+     </property>
+     <property name="sizeHint" stdset="0">
+      <size>
+       <width>259</width>
+       <height>20</height>
+      </size>
+     </property>
+    </spacer>
+   </item>
+   <item row="1" column="1">
+    <widget class="QPushButton" name="clear">
+     <property name="text">
+      <string>Clear</string>
+     </property>
+    </widget>
+   </item>
+   <item row="1" column="2" colspan="2">
+    <spacer name="horizontalSpacer_3">
+     <property name="orientation">
+      <enum>Qt::Horizontal</enum>
+     </property>
+     <property name="sizeHint" stdset="0">
+      <size>
+       <width>276</width>
+       <height>20</height>
+      </size>
+     </property>
+    </spacer>
+   </item>
+   <item row="2" column="0" colspan="4">
+    <widget class="QTextBrowser" name="textBrowser_2">
+     <property name="readOnly">
+      <bool>false</bool>
+     </property>
+    </widget>
+   </item>
+   <item row="3" column="0">
+    <spacer name="horizontalSpacer_2">
+     <property name="orientation">
+      <enum>Qt::Horizontal</enum>
+     </property>
+     <property name="sizeHint" stdset="0">
+      <size>
+       <width>259</width>
+       <height>20</height>
+      </size>
+     </property>
+    </spacer>
+   </item>
+   <item row="3" column="1" colspan="2">
+    <widget class="QPushButton" name="evalute">
+     <property name="text">
+      <string>Evaluate</string>
+     </property>
+     <property name="shortcut">
+      <string>Ctrl+Return</string>
+     </property>
+    </widget>
+   </item>
+   <item row="3" column="3">
+    <spacer name="horizontalSpacer_4">
+     <property name="orientation">
+      <enum>Qt::Horizontal</enum>
+     </property>
+     <property name="sizeHint" stdset="0">
+      <size>
+       <width>258</width>
+       <height>20</height>
+      </size>
+     </property>
+    </spacer>
+   </item>
+  </layout>
  </widget>
  <resources/>
  <connections/>



From mean at mail.berlios.de  Fri Dec  4 20:20:43 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 4 Dec 2009 20:20:43 +0100
Subject: [Avidemux-svn-commit] r5615 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/faac
Message-ID: <200912041920.nB4JKhrH032414@sheep.berlios.de>

Author: mean
Date: 2009-12-04 20:20:43 +0100 (Fri, 04 Dec 2009)
New Revision: 5615

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp
Log:
[AAC] Slightly better channel mapping (?) ref #60

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp	2009-12-04 18:49:29 UTC (rev 5614)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp	2009-12-04 19:20:43 UTC (rev 5615)
@@ -74,12 +74,16 @@
     	outputChannelMapping[1] = CHTYP_FRONT_RIGHT;
       break;
     default :
-    	outputChannelMapping[0] = CHTYP_FRONT_CENTER;
-    	outputChannelMapping[1] = CHTYP_FRONT_LEFT;
-    	outputChannelMapping[2] = CHTYP_FRONT_RIGHT;
-    	outputChannelMapping[3] = CHTYP_REAR_LEFT;
-    	outputChannelMapping[4] = CHTYP_REAR_RIGHT;
-    	outputChannelMapping[5] = CHTYP_LFE;
+    	CHANNEL_TYPE *f=outputChannelMapping;
+        *f++ = CHTYP_FRONT_CENTER;
+    	*f++ = CHTYP_FRONT_LEFT;
+    	*f++ = CHTYP_FRONT_RIGHT;
+        
+        *f++ = CHTYP_REAR_LEFT;
+    	*f++ = CHTYP_REAR_RIGHT;
+        *f++ = CHTYP_LFE;
+        
+    	
   }
 };
 



From mean at mail.berlios.de  Fri Dec  4 22:23:36 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 4 Dec 2009 22:23:36 +0100
Subject: [Avidemux-svn-commit] r5616 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/faac
Message-ID: <200912042123.nB4LNaT4010537@sheep.berlios.de>

Author: mean
Date: 2009-12-04 22:23:35 +0100 (Fri, 04 Dec 2009)
New Revision: 5616

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp
Log:
[AAC] encoder, channel mapping take two , ref #60

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp	2009-12-04 19:20:43 UTC (rev 5615)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp	2009-12-04 21:23:35 UTC (rev 5616)
@@ -78,11 +78,13 @@
         *f++ = CHTYP_FRONT_CENTER;
     	*f++ = CHTYP_FRONT_LEFT;
     	*f++ = CHTYP_FRONT_RIGHT;
-        
+    	
+        *f++ = CHTYP_REAR_RIGHT;
+        *f++ = CHTYP_LFE;
         *f++ = CHTYP_REAR_LEFT;
-    	*f++ = CHTYP_REAR_RIGHT;
-        *f++ = CHTYP_LFE;
         
+        
+        
     	
   }
 };



From mean at mail.berlios.de  Sat Dec  5 09:36:03 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 5 Dec 2009 09:36:03 +0100
Subject: [Avidemux-svn-commit] r5617 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska
Message-ID: <200912050836.nB58a3pE029037@sheep.berlios.de>

Author: mean
Date: 2009-12-05 09:36:02 +0100 (Sat, 05 Dec 2009)
New Revision: 5617

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ebml.cpp
Log:
[mkv] Dont trow away headers if they are short

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ebml.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ebml.cpp	2009-12-04 21:23:35 UTC (rev 5616)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ebml.cpp	2009-12-05 08:36:02 UTC (rev 5617)
@@ -309,8 +309,8 @@
 }
 uint8_t ADM_ebml_file::finished(void)
 {
-  if(tell()>(_fileSize-4)) return 1;
-  if(tell()>(_begin+_size-4)) return 1;
+  if(tell()>(_fileSize-2)) return 1;
+  if(tell()>(_begin+_size-2)) return 1;
   return 0; 
 }
 /** 



From mean at mail.berlios.de  Sat Dec  5 19:25:11 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 5 Dec 2009 19:25:11 +0100
Subject: [Avidemux-svn-commit] r5618 - in branches/avidemux_2.6_branch_mean:
	addons/mkvscan avidemux_plugins/ADM_demuxers/Matroska
Message-ID: <200912051825.nB5IPBgi008853@sheep.berlios.de>

Author: mean
Date: 2009-12-05 19:24:59 +0100 (Sat, 05 Dec 2009)
New Revision: 5618

Modified:
   branches/avidemux_2.6_branch_mean/addons/mkvscan/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/addons/mkvscan/Makefile
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ebml.cpp
Log:
[mkv] Dont throw away short headers + update mkvscan

Modified: branches/avidemux_2.6_branch_mean/addons/mkvscan/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/addons/mkvscan/CMakeLists.txt	2009-12-05 08:36:02 UTC (rev 5617)
+++ branches/avidemux_2.6_branch_mean/addons/mkvscan/CMakeLists.txt	2009-12-05 18:24:59 UTC (rev 5618)
@@ -3,7 +3,7 @@
 set(MKV ../../avidemux_plugins/ADM_demuxers/Matroska/)
 INCLUDE_DIRECTORIES( ${MKV})
 #LINK_DIRECTORIES(${ITK_LIBRARY_DIRS})
-ADD_DEFINITIONS("-g")
+ADD_DEFINITIONS("-g -DADM_fopen=fopen")
 
 
 SET(sources

Modified: branches/avidemux_2.6_branch_mean/addons/mkvscan/Makefile
===================================================================
--- branches/avidemux_2.6_branch_mean/addons/mkvscan/Makefile	2009-12-05 08:36:02 UTC (rev 5617)
+++ branches/avidemux_2.6_branch_mean/addons/mkvscan/Makefile	2009-12-05 18:24:59 UTC (rev 5618)
@@ -1,5 +1,5 @@
 # CMAKE generated file: DO NOT EDIT!
-# Generated by "Unix Makefiles" Generator, CMake Version 2.6
+# Generated by "Unix Makefiles" Generator, CMake Version 2.8
 
 # Default target executed when no arguments are given to make.
 default_target: all
@@ -69,7 +69,7 @@
 
 # The main all target
 all: cmake_check_build_system
-	$(CMAKE_COMMAND) -E cmake_progress_start /home/fx/workspace/gitted/addons/mkvscan/CMakeFiles /home/fx/workspace/gitted/addons/mkvscan/CMakeFiles/progress.make
+	$(CMAKE_COMMAND) -E cmake_progress_start /home/fx/workspace/gitted/addons/mkvscan/CMakeFiles /home/fx/workspace/gitted/addons/mkvscan/CMakeFiles/progress.marks
 	$(MAKE) -f CMakeFiles/Makefile2 all
 	$(CMAKE_COMMAND) -E cmake_progress_start /home/fx/workspace/gitted/addons/mkvscan/CMakeFiles 0
 .PHONY : all

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ebml.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ebml.cpp	2009-12-05 08:36:02 UTC (rev 5617)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ebml.cpp	2009-12-05 18:24:59 UTC (rev 5618)
@@ -306,8 +306,8 @@
 }
 uint8_t ADM_ebml_file::finished(void)
 {
-  if(tell()>(_fileSize-4)) return 1;
-  if(tell()>(_begin+_size-4)) return 1;
+  if(tell()>(_fileSize-2)) return 1;
+  if(tell()>(_begin+_size-2)) return 1;
   return 0;
 }
 /**



From mean at mail.berlios.de  Sat Dec  5 19:25:14 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 5 Dec 2009 19:25:14 +0100
Subject: [Avidemux-svn-commit] r5619 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav
Message-ID: <200912051825.nB5IPEv5009011@sheep.berlios.de>

Author: mean
Date: 2009-12-05 19:25:13 +0100 (Sat, 05 Dec 2009)
New Revision: 5619

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
Log:
[DTS] correct channel mapping (merge from 2.5)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp	2009-12-05 18:24:59 UTC (rev 5618)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp	2009-12-05 18:25:13 UTC (rev 5619)
@@ -235,19 +235,36 @@
           {
             *outptr++=((float)run16[i])/32767.;
           }
+        }
           if(channels>=5 )
             {
             CHANNEL_TYPE *p_ch_type = channelMapping;
-        #define DOIT(x,y) if(_context->channel_layout & CH_##x) *(p_ch_type++)=ADM_CH_##y;
-                DOIT(LOW_FREQUENCY,LFE);
-                DOIT(FRONT_LEFT,FRONT_LEFT);
-                DOIT(FRONT_CENTER,FRONT_CENTER);
-                DOIT(FRONT_RIGHT,FRONT_RIGHT);
-                DOIT(SIDE_LEFT,REAR_LEFT);
-                DOIT(SIDE_RIGHT,REAR_RIGHT);
+#define DOIT(x,y) if(_context->channel_layout & CH_##x) *(p_ch_type++)=ADM_CH_##y;
+            if(_context->codec_id == CODEC_ID_DTS)
+                {
+                    
+                    DOIT(FRONT_LEFT,FRONT_LEFT);
+                    DOIT(FRONT_RIGHT,FRONT_RIGHT);
+                    DOIT(FRONT_CENTER,FRONT_CENTER);
 
+                    
+                    DOIT(LOW_FREQUENCY,LFE);
+                    DOIT(SIDE_LEFT,REAR_LEFT);
+                    DOIT(SIDE_RIGHT,REAR_RIGHT);
+                    
+                    
+ 
+                }else   
+                {
+                    DOIT(LOW_FREQUENCY,LFE);
+                    DOIT(FRONT_LEFT,FRONT_LEFT);
+                    DOIT(FRONT_CENTER,FRONT_CENTER);
+                    DOIT(FRONT_RIGHT,FRONT_RIGHT);
+                    DOIT(SIDE_LEFT,REAR_LEFT);
+                    DOIT(SIDE_RIGHT,REAR_RIGHT);
+                }
             }
-        }
+        
         return 1;
 }
 //---



From mean at mail.berlios.de  Sat Dec  5 19:25:19 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 5 Dec 2009 19:25:19 +0100
Subject: [Avidemux-svn-commit] r5621 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src
Message-ID: <200912051825.nB5IPJfO009140@sheep.berlios.de>

Author: mean
Date: 2009-12-05 19:25:18 +0100 (Sat, 05 Dec 2009)
New Revision: 5621

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
Log:
[ffMuxer] Fix writting of packet with a duration > one frame (mpeg2 ts copy for example)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2009-12-05 18:25:16 UTC (rev 5620)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2009-12-05 18:25:18 UTC (rev 5621)
@@ -291,13 +291,26 @@
         printf("[FF] Audio initialized\n");
         return true;
 }
+#define AUDIO_BUFFER_SIZE 48000*6*sizeof(float)
+class MuxAudioPacket
+{
+public:
+    MuxAudioPacket() {eof=false;dts=ADM_NO_PTS;present=false;size=0;}
+    uint8_t     buffer[AUDIO_BUFFER_SIZE];
+    uint32_t    size;
+    bool        eof;
+    bool        present;
+    uint64_t    dts;
+    uint32_t    samples;
+};
+
 /**
 
 */
 bool muxerFFmpeg::saveLoop(const char *title)
 {
-#define AUDIO_BUFFER_SIZE 48000*6*sizeof(float)
 
+
     printf("[FF] Saving\n");
     uint32_t bufSize=vStream->getWidth()*vStream->getHeight()*3;
     uint8_t *buffer=new uint8_t[bufSize];
@@ -314,15 +327,16 @@
     f*=1000000;
     videoIncrement=(uint64_t)f;
 
-    uint8_t *audioBuffer=new uint8_t[AUDIO_BUFFER_SIZE];
 
 
-    printf("[MP4]avg fps=%u\n",vStream->getAvgFps1000());
+    ADM_info("avg fps=%u\n",vStream->getAvgFps1000());
     AVRational *scale=&(video_st->codec->time_base);
     uint64_t videoDuration=vStream->getVideoDuration();
     
     encoding=createWorking(title);
 
+    MuxAudioPacket audioPackets[nbAStreams];
+
     while(true==vStream->getPacket(&len, buffer, bufSize,&pts,&dts,&flags))
     {
 	AVPacket pkt;
@@ -387,47 +401,61 @@
             // Now send audio until they all have DTS > lastVideoDts+increment
             for(int audio=0;audio<nbAStreams;audio++)
             {
-                uint32_t audioSize,nbSample;
-                uint64_t audioDts;
+                MuxAudioPacket *audioTrack=&(audioPackets[audio]);
                 ADM_audioStream*a=aStreams[audio];
                 uint32_t fq=a->getInfo()->frequency;
-                int nb=0;
-                while(a->getPacket(audioBuffer,&audioSize, AUDIO_BUFFER_SIZE,&nbSample,&audioDts))
+            
+                while(1)
                 {
+                    if(audioTrack->eof==true) break; // no more packet for this track
+                    if(audioTrack->present==false)
+                    {
+                        if(false==a->getPacket(audioTrack->buffer,
+                                                &(audioTrack->size), 
+                                                AUDIO_BUFFER_SIZE,
+                                                &(audioTrack->samples),
+                                                &(audioTrack->dts)))
+                        {
+                                audioTrack->eof=true;
+                                ADM_info("No more audio packets for audio track %d\n",audio);
+                                break;
+                        }
+                       // printf("Track %d , new audio packet DTS=%"LLD" size=%"LU"\n",audioTrack->dts,audioTrack->size);
+                        audioTrack->present=true;
+                    }
+                    if(audioTrack->dts!=ADM_NO_PTS)
+                    {
+                        if(audioTrack->dts>lastVideoDts+videoIncrement) break; // This packet is in the future
+                    }
                     // Write...
-                    nb++;
                     AVPacket pkt;
                     uint64_t rescaledDts;
-                    rescaledDts=audioDts;
+                    rescaledDts=audioTrack->dts;
                     muxerRescaleAudioTime(&rescaledDts,a->getInfo()->frequency);
-                    aprintf("[FF] A: Video frame  %d, audio Dts :%"LLU" size :%"LU" nbSample : %"LU" rescaled:%"LLU"\n",
-                                    written,audioDts,audioSize,nbSample,rescaledDts);
+                   //printf("[FF] A: Video frame  %d, audio Dts :%"LLU" size :%"LU" nbSample : %"LU" rescaled:%"LLU"\n",
+                     //               written,audioTrack->dts,audioTrack->size,audioTrack->samples,rescaledDts);
                     av_init_packet(&pkt);
                     
                     pkt.dts=rescaledDts;
                     pkt.pts=rescaledDts;
                     pkt.stream_index=1+audio;
-                    pkt.data= audioBuffer;
-                    pkt.size= audioSize;
+                    pkt.data= audioTrack->buffer;
+                    pkt.size= audioTrack->size;
                     ret =av_write_frame(oc, &pkt);
+                    audioTrack->present=false; // consumed
                     if(ret)
                     {
-                        printf("[FF]Error writing audio packet\n");
+                        ADM_warning("[FF]Error writing audio packet\n");
                         break;
                     }
-                    aprintf("[FF] A:%"LU" ms vs V: %"LU" ms\n",(uint32_t)audioDts/1000,(uint32_t)(lastVideoDts+videoIncrement)/1000);
-                    if(audioDts!=ADM_NO_PTS)
-                    {
-                        if(audioDts>lastVideoDts+videoIncrement) break;
-                    }
+                   // printf("[FF] A:%"LU" ms vs V: %"LU" ms\n",(uint32_t)audioTrack->dts/1000,(uint32_t)(lastVideoDts+videoIncrement)/1000);
                 }
                 //if(!nb) printf("[FF] A: No audio for video frame %d\n",written);
             }
 
     }
     delete [] buffer;
-    delete [] audioBuffer;
-    printf("[FF] Wrote %d frames, nb audio streams %d\n",written,nbAStreams);
+    ADM_info("[FF] Wrote %d frames, nb audio streams %d\n",written,nbAStreams);
     return result;
 }
 // EOF



From mean at mail.berlios.de  Sat Dec  5 19:25:16 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 5 Dec 2009 19:25:16 +0100
Subject: [Avidemux-svn-commit] r5620 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac
Message-ID: <200912051825.nB5IPGxr009109@sheep.berlios.de>

Author: mean
Date: 2009-12-05 19:25:16 +0100 (Sat, 05 Dec 2009)
New Revision: 5620

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp
Log:
[AAC] channel mapping (merge from 2.5)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp	2009-12-05 18:25:13 UTC (rev 5619)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp	2009-12-05 18:25:16 UTC (rev 5620)
@@ -71,12 +71,17 @@
     	outputChannelMapping[1] = ADM_CH_FRONT_RIGHT;
       break;
     default :
-    	outputChannelMapping[0] = ADM_CH_FRONT_CENTER;
-    	outputChannelMapping[1] = ADM_CH_FRONT_LEFT;
-    	outputChannelMapping[2] = ADM_CH_FRONT_RIGHT;
-    	outputChannelMapping[3] = ADM_CH_REAR_LEFT;
-    	outputChannelMapping[4] = ADM_CH_REAR_RIGHT;
-    	outputChannelMapping[5] = ADM_CH_LFE;
+
+    CHANNEL_TYPE *f=outputChannelMapping;
+        *f++ = ADM_CH_FRONT_CENTER;
+        *f++ = ADM_CH_FRONT_LEFT;
+        *f++ = ADM_CH_FRONT_RIGHT;
+
+        *f++ = ADM_CH_REAR_LEFT;
+        *f++ = ADM_CH_REAR_RIGHT;
+        *f++ = ADM_CH_LFE;
+        
+
   }
   wavheader.encoding=WAV_AAC;
 };



From mean at mail.berlios.de  Sun Dec  6 10:27:04 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 6 Dec 2009 10:27:04 +0100
Subject: [Avidemux-svn-commit] r5622 - in
	branches/avidemux_2.6_branch_mean/avidemux/common: ADM_editor
	ADM_script
Message-ID: <200912060927.nB69R4Ab008063@sheep.berlios.de>

Author: mean
Date: 2009-12-06 10:27:03 +0100 (Sun, 06 Dec 2009)
New Revision: 5622

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemux.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt
Log:
[JS] Fix loading of large integer from jscript + dumpEditing debug function from js

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp	2009-12-05 18:25:18 UTC (rev 5621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp	2009-12-06 09:27:03 UTC (rev 5622)
@@ -16,13 +16,14 @@
  ***************************************************************************/
 #include "ADM_default.h"
 #include "ADM_segment.h"
- #include "../ADM_codecs/ADM_codec.h"
- #include "ADM_image.h"
- #include "../ADM_editor/ADM_edCache.h"
- #include "ADM_pp.h"
- #include "ADM_colorspace.h"
+#include "../ADM_codecs/ADM_codec.h"
+#include "ADM_image.h"
+#include "../ADM_editor/ADM_edCache.h"
+#include "ADM_pp.h"
+#include "ADM_colorspace.h"
 #include "ADM_vidMisc.h"
 #include "ADM_audiocodec/ADM_audiocodec.h"
+#include "ADM_script/ADM_JSif.h"
 
 ADM_EditorSegment::ADM_EditorSegment(void)
 {
@@ -459,12 +460,12 @@
     {
         _SEGMENT *s=getSegment(i);
         
-        printf("Segment :%d/%d\n",i,n);
-        printf("\tReference    :%"LU"\n",s->_reference,ADM_us2plain(s->_reference));
-        printf("\tstartLinear  :%08"LLU" %s\n",s->_startTimeUs,ADM_us2plain(s->_startTimeUs));
-        printf("\tduration     :%08"LLU" %s\n",s->_durationUs,ADM_us2plain(s->_durationUs));
-        printf("\trefStartPts  :%08"LLU" %s\n",s->_refStartTimeUs,ADM_us2plain(s->_refStartTimeUs));
-        printf("\trefStartDts  :%08"LLU" %s\n",s->_refStartDts,ADM_us2plain(s->_refStartDts));
+        jsLog(JS_LOG_NORMAL,"Segment :%d/%d",i,n);
+        jsLog(JS_LOG_NORMAL,"\tReference    :%"LU,s->_reference,ADM_us2plain(s->_reference));
+        jsLog(JS_LOG_NORMAL,"\tstartLinear  :%08"LLU" %s",s->_startTimeUs,ADM_us2plain(s->_startTimeUs));
+        jsLog(JS_LOG_NORMAL,"\tduration     :%08"LLU" %s",s->_durationUs,ADM_us2plain(s->_durationUs));
+        jsLog(JS_LOG_NORMAL,"\trefStartPts  :%08"LLU" %s",s->_refStartTimeUs,ADM_us2plain(s->_refStartTimeUs));
+        jsLog(JS_LOG_NORMAL,"\trefStartDts  :%08"LLU" %s",s->_refStartDts,ADM_us2plain(s->_refStartDts));
     }
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemux.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemux.cpp	2009-12-05 18:25:18 UTC (rev 5621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemux.cpp	2009-12-06 09:27:03 UTC (rev 5622)
@@ -21,10 +21,12 @@
 #include "DIA_coreToolkit.h"
 #include "ADM_commonUI/GUI_ui.h"
 #include "ADM_muxerProto.h"
-
+#include "ADM_confCouple.h"
 #include "ADM_debugID.h"
 #define MODULE_NAME MODULE_SCRIPT
 #include "ADM_debug.h"
+#include "ADM_JSDebug.h"
+#include "ADM_jsUtils.h"
 
 extern int A_openAvi (const char *name);
 extern int A_Save (const char *name);
@@ -440,16 +442,18 @@
                                        jsval *argv, jsval *rval)
 {// begin AddSegment
         ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
+        //
+        uint32_t ref=0;
+        uint64_t duration=0,start=0;
+        ADM_PARAM_LIST params[3]={{ADM_JS_UINT32_T,&ref},{ADM_JS_UINT64_T,&start},{ADM_JS_UINT64_T,&duration}};
         // default return value
         *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 3)
-                return JS_FALSE;
-	if(JSVAL_IS_INT(argv[0]) == false || JSVAL_IS_INT(argv[1]) == false || JSVAL_IS_INT(argv[2]) == false)
-		return JS_FALSE;
-        uint64_t ref = JSVAL_TO_INT(argv[0]);
-        uint64_t start= JSVAL_TO_INT(argv[1]);
-        uint64_t duration= JSVAL_TO_INT(argv[2]);
-        aprintf("adding segment :%d %d %d\n",a,b,c);
+        if(false==ADM_jsArg2Vars(cx, obj, argc, argv, 3, params))
+        {
+            jsLog(JS_LOG_ERROR,"wrong arguments to AddSegment");
+            return JS_FALSE;
+        }
+        ADM_info("adding segment :%d %d %d\n",ref,start,duration);
         enterLock();
         *rval = BOOLEAN_TO_JSVAL( video_body->addSegment(ref,start,duration));
         leaveLock();

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp	2009-12-05 18:25:18 UTC (rev 5621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp	2009-12-06 09:27:03 UTC (rev 5622)
@@ -30,10 +30,8 @@
 
 //extern VF_FILTERS filterGetTagFromName(const char *inname);
 extern uint8_t A_ListAllBlackFrames( char *file );
-extern uint8_t loadVideoCodecConfString( const char *name);
 extern uint8_t ADM_saveRaw (const char *name);
 extern int A_saveJpg (char *name);
-extern uint8_t loadVideoCodecConf( const char *name);
 extern void filterCleanUp( void );
 extern bool jsArgToConfCouple(int nb,CONFcouple **conf,  jsval *argv);
 bool A_setVideoCodec(const char *nm);
@@ -48,7 +46,6 @@
 JSFunctionSpec ADM_JSAvidemuxVideo::avidemuxvideo_methods[] = 
 {
 	{ "clear", Clear, 0, 0, 0 },	// clear
-	{ "add", Add, 3, 0, 0 },	// add
     { "clearFilters", ClearFilters, 0, 0, 0 }, // Delete all filters
 	{ "addFilter", AddFilter, 10, 0, 0 },	// Add filter to filter chain
 	{ "codec", Codec, 1, 0, 0 },	// Set the video codec
@@ -184,24 +181,7 @@
         return JS_TRUE;
 }// end Clear
 
-JSBool ADM_JSAvidemuxVideo::Add(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin Add
-        ADM_JSAvidemuxVideo *p = (ADM_JSAvidemuxVideo *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 3)
-                return JS_FALSE;
-        if(JSVAL_IS_INT(argv[0]) == false || JSVAL_IS_INT(argv[1]) == false  || JSVAL_IS_INT(argv[2]) == false)
-                return JS_FALSE;
-        printf("Adding Video... \n");
-        enterLock();
-//        *rval = BOOLEAN_TO_JSVAL(video_body->addSegment(JSVAL_TO_INT(argv[0]),JSVAL_TO_INT(argv[1]),JSVAL_TO_INT(argv[2])));
-        leaveLock();
-        return JS_TRUE;
-}// end Add
 
-
 JSBool ADM_JSAvidemuxVideo::ClearFilters(JSContext *cx, JSObject *obj, uintN argc,
                                        jsval *argv, jsval *rval)
 {// begin Clear
@@ -209,7 +189,9 @@
         return JS_TRUE;
 }// end Clear
 
-
+/**
+    \fn AddFilter
+*/
 JSBool ADM_JSAvidemuxVideo::AddFilter(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin AddFilter
@@ -266,7 +248,9 @@
         return JS_TRUE;
 }// end Codec
 
-
+/**
+    \fn Save
+*/
 JSBool ADM_JSAvidemuxVideo::Save(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin Save
@@ -285,7 +269,9 @@
 #endif
         return JS_TRUE;
 }// end Save
-
+/**
+    \fn saveJpeg
+*/
 JSBool ADM_JSAvidemuxVideo::SaveJPEG(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin SaveJPG
@@ -304,7 +290,9 @@
 #endif
         return JS_TRUE;
 }// end SaveJPG
-
+/**
+    \fn ListBlackFrames
+*/
 JSBool ADM_JSAvidemuxVideo::ListBlackFrames(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin ListBlackFrames
@@ -324,7 +312,9 @@
 #endif
         return JS_TRUE;
 }// end ListBlackFrames
-
+/**
+    \fn PostProcess
+*/
 JSBool ADM_JSAvidemuxVideo::PostProcess(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin PostProcess
@@ -342,7 +332,9 @@
         *rval = BOOLEAN_TO_JSVAL(rtn);
         return JS_TRUE;
 }// end PostProcess
-
+/**
+    \fn GetFps1000
+*/
 JSBool ADM_JSAvidemuxVideo::GetFps1000(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin PostProcess
@@ -357,6 +349,9 @@
         *rval = INT_TO_JSVAL(info.fps1000);
         return JS_TRUE;
 }// end PostProcess
+/**
+    \fn GetNbFrames
+*/
 JSBool ADM_JSAvidemuxVideo::GetNbFrames(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin PostProcess
@@ -371,7 +366,9 @@
         *rval = INT_TO_JSVAL(info.nb_frames);
         return JS_TRUE;
 }// end PostProcess
-
+/**
+    \fn SetFps1000
+*/
 JSBool ADM_JSAvidemuxVideo::SetFps1000(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin PostProcess
@@ -405,7 +402,9 @@
         return JS_TRUE;
 }// end PostProcess
 
-
+/**
+    \fn GetWidth
+*/
 JSBool ADM_JSAvidemuxVideo::GetWidth(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin PostProcess
@@ -421,6 +420,9 @@
         *rval = INT_TO_JSVAL(info.width);
         return JS_TRUE;
 }// end PostProcess
+/**
+    \fn SetFps1000
+*/
 JSBool ADM_JSAvidemuxVideo::GetHeight(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin PostProcess
@@ -435,6 +437,10 @@
         *rval = INT_TO_JSVAL(info.height);
         return JS_TRUE;
 }// end PostProcess
+/**
+    \fn GetFCC
+*/
+
 JSBool ADM_JSAvidemuxVideo::GetFCC(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin PostProcess
@@ -450,6 +456,9 @@
         *rval = STRING_TO_JSVAL(JS_NewStringCopyZ(cx, fourCC::tostring(info.fcc)));
         return JS_TRUE;
 }// end PostProcess
+/**
+    \fn SetFps1000
+*/
 
 JSBool ADM_JSAvidemuxVideo::isVopPacked(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
@@ -467,6 +476,10 @@
         if(info & ADM_VOP_ON) *rval=JS_TRUE;
         return JS_TRUE;
 }// end PostProcess
+/**
+    \fn hasGmc
+*/
+
 JSBool ADM_JSAvidemuxVideo::hasGmc(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin PostProcess
@@ -483,6 +496,10 @@
         if(info & ADM_GMC_ON) *rval=JS_TRUE;
         return JS_TRUE;
 }// end PostProcess
+/**
+    \fn hasQpel
+*/
+
 JSBool ADM_JSAvidemuxVideo::hasQpel(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin PostProcess
@@ -499,6 +516,9 @@
         return JS_TRUE;
 }// end PostProcess
 
+/**
+    \fn getFrameSize
+*/
 
 JSBool ADM_JSAvidemuxVideo::getFrameSize(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
@@ -518,6 +538,10 @@
 #endif
         return JS_TRUE;
 }// end PostProcess
+/**
+    \fn getFrameType
+*/
+
 JSBool ADM_JSAvidemuxVideo::getFrameType(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin PostProcess

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.h	2009-12-05 18:25:18 UTC (rev 5621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.h	2009-12-06 09:27:03 UTC (rev 5622)
@@ -20,7 +20,6 @@
 	static void JSDestructor(JSContext *cx, JSObject *obj);
 	static JSObject *JSInit(JSContext *cx, JSObject *obj, JSObject *proto = NULL);
 	static JSBool Clear(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Add(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 	static JSBool ClearFilters(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 	static JSBool AddFilter(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 	static JSBool IndexMPEG(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp	2009-12-05 18:25:18 UTC (rev 5621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp	2009-12-06 09:27:03 UTC (rev 5622)
@@ -39,6 +39,7 @@
 extern JSFunctionSpec *ADM_JsVideoGetFunctions(void);
 extern JSFunctionSpec *ADM_JsClassGetFunctions(void);
 extern JSFunctionSpec *ADM_JsDebugGetFunctions(void);
+extern JSFunctionSpec *ADM_JsFunctionGetFunctions(void);
 
 /**/
 static JSFunctionSpec adm_debug_functions[] = {
@@ -163,7 +164,7 @@
 {
         if(!argc)
         {
-            jsLog(JS_LOG_NORMAL,"help(\"video\"); or help(\"audio\"); or help(\"debug\"); or debug(\"functions\"");
+            jsLog(JS_LOG_NORMAL,"help(\"class\"); or help(\"video\"); or help(\"audio\"); or help(\"debug\"); or debug(\"functions\"");
             return JS_TRUE;
         }
         if(argc != 1)
@@ -180,7 +181,8 @@
             DUMPTABLE(audio,ADM_JsAudioGetFunctions);
             DUMPTABLE(video,ADM_JsVideoGetFunctions);
             DUMPTABLE(debug,ADM_JsDebugGetFunctions);
-            DUMPTABLE(functions,ADM_JsClassGetFunctions);
+            DUMPTABLE(functions,ADM_JsFunctionGetFunctions);
+            DUMPTABLE(class,ADM_JsClassGetFunctions);
         }
         if(table) dumpFunc(table);
         else jsLog(JS_LOG_ERROR,"%s not found",f);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp	2009-12-05 18:25:18 UTC (rev 5621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp	2009-12-06 09:27:03 UTC (rev 5622)
@@ -115,6 +115,10 @@
   {"dialogFactoryThreadCount", facThreadCount,		  0},
   {0}
 };
+JSFunctionSpec *ADM_JsFunctionGetFunctions(void)
+{
+    return adm_functions;
+}
 
 uint8_t JS_AvidemuxFunction(JSContext *cx,JSObject *global)
 {

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h	2009-12-05 18:25:18 UTC (rev 5621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h	2009-12-06 09:27:03 UTC (rev 5622)
@@ -43,5 +43,9 @@
     \brief interprete & execute ecma script (interactive)
 */
 bool interactiveECMAScript(const char *name);
+/**
+    \fn jsLog
 
+*/
+bool jsLog(JS_LOG_TYPE type, const char *fmt,...);
 #endif

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.cpp	2009-12-05 18:25:18 UTC (rev 5621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.cpp	2009-12-06 09:27:03 UTC (rev 5622)
@@ -0,0 +1,99 @@
+/**
+    \file ADM_jsUtils
+    \brief Simple param -> type utilities
+    \author mean fixounet at free.fr 2009
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_default.h"
+#include <string.h>
+#include <pthread.h>
+#include "DIA_coreToolkit.h"
+
+#include "ADM_JSGlobal.h"
+#include "ADM_JSDebug.h"
+#include "ADM_JSif.h"
+#include "ADM_jsUtils.h"
+/**
+    \fn ADM_jsArg2Vars  
+    \brief convert jsvals to native type with checking
+*/
+bool ADM_jsArg2Vars(JSContext *cx, JSObject *obj, int argc, jsval *argv, int paramNumber, ADM_PARAM_LIST *param)
+{
+    if(paramNumber!=argc)
+    {
+        ADM_warning("Wrong number of parameters : %d vs %d\n",argc,paramNumber);
+        return false;
+    }
+    for(int i=0;i<argc;i++)
+    {
+        jsval j=argv[i];
+        ADM_PARAM_LIST *p=param+i;
+        switch(p->type)
+        {
+            case ADM_JS_UINT64_T:
+            case ADM_JS_UINT32_T:
+            case ADM_JS_INT64_T:
+            case ADM_JS_INT32_T:
+                {
+                        if(!JSVAL_IS_NUMBER(j))
+                        {
+                            ADM_warning("Expected number and got %d\n",j);
+                            return false;
+                        }
+                        // If it is an int...
+                        double v=0;
+                        if(JSVAL_IS_INT(j)) 
+                        {
+                            v=(int64_t)JSVAL_TO_INT(j);
+                            //ADM_warning("Value is int :%"LLD"\n",JSVAL_TO_INT(j));
+                        }
+                        if(JSVAL_IS_DOUBLE(j)) 
+                        {
+                            v=(int64_t)*(JSVAL_TO_DOUBLE(j));
+                            //ADM_warning("Value is float :%f\n",(float)*(JSVAL_TO_DOUBLE(j)));
+                        }
+                        // 
+                        //ADM_warning("%f\n",(float)v);
+                        // Affect
+                        switch(p->type)
+                        {
+                            case ADM_JS_UINT64_T: *(uint64_t *)p->value=(uint64_t)v;break;
+                            case ADM_JS_UINT32_T: *(uint32_t *)p->value=(uint32_t)v;break;
+                            case ADM_JS_INT64_T:  *(int64_t *)p->value=(int64_t)v;break;
+                            case ADM_JS_INT32_T:  *(int32_t *)p->value=(int32_t)v;break;
+                            default: ADM_assert(0);break;
+                        }
+                 }
+                        break;
+            case  ADM_JS_STRING:
+                        if(!JSVAL_IS_STRING(j))
+                        {
+                            ADM_warning("Expected string and got %d\n",j);
+                            return false;
+                        }
+                        p->value=(void *)(JSVAL_TO_STRING(j));
+                        break;
+            case  ADM_JS_BOOL:
+                        if(!JSVAL_IS_BOOLEAN(j))
+                        {
+                            ADM_warning("Expected boolean and got %d\n",j);
+                            return false;
+                        }
+                        *(bool *)p->value=JSVAL_TO_BOOLEAN(j);
+                        break;
+            default:
+                    ADM_assert(0);
+                    break;
+        }
+
+    }
+    return true;
+}
+// EOF

Copied: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.h (from rev 5621, branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h	2009-12-05 18:25:18 UTC (rev 5621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.h	2009-12-06 09:27:03 UTC (rev 5622)
@@ -0,0 +1,39 @@
+/**
+    \file ADM_jsUtils
+    \brief Simple param -> type utilities
+    \author mean fixounet at free.fr 2009
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_JS_UTILS_H
+#define ADM_JS_UTILS_H
+
+typedef enum
+{
+    ADM_JS_INVALID=0,
+    ADM_JS_UINT32_T=1,
+    ADM_JS_INT32_T,
+    ADM_JS_UINT64_T,
+    ADM_JS_INT64_T,
+    ADM_JS_STRING,
+    ADM_JS_BOOL,
+    ADM_JS_MAX
+}ADM_PARAM_TYPE;
+
+typedef struct
+{
+    ADM_PARAM_TYPE type;
+    void           *value;
+
+}ADM_PARAM_LIST;
+
+bool ADM_jsArg2Vars(JSContext *cx, JSObject *obj, int argc, jsval *argv, int paramNumber, ADM_PARAM_LIST *param);
+
+
+#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt	2009-12-05 18:25:18 UTC (rev 5621)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt	2009-12-06 09:27:03 UTC (rev 5622)
@@ -3,6 +3,7 @@
 	ADM_Avidemux.cpp       ADM_JSAvidemuxAudio.cpp  ADM_JSAvidemuxVideo.cpp  ADM_JSFunctions.cpp        DirectorySearch.cpp
         ADM_JSFunctionsNonRegFactory.cpp
         ADM_JSif.cpp ADM_JSDebug.cpp
+        ADM_jsUtils.cpp
 )
 
 ADD_LIBRARY(ADM_script6 STATIC ${ADM_script_SRCS})



From mean at mail.berlios.de  Sun Dec  6 11:57:34 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 6 Dec 2009 11:57:34 +0100
Subject: [Avidemux-svn-commit] r5623 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska
Message-ID: <200912061057.nB6AvYpb012424@sheep.berlios.de>

Author: mean
Date: 2009-12-06 11:57:34 +0100 (Sun, 06 Dec 2009)
New Revision: 5623

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkvEntries.cpp
Log:
[MKV] Fix vorbis multichannel loading, fixes #61

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkvEntries.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkvEntries.cpp	2009-12-06 09:27:03 UTC (rev 5622)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkvEntries.cpp	2009-12-06 10:57:34 UTC (rev 5623)
@@ -201,6 +201,7 @@
         case  MKV_TRACK_TYPE: entry->trackType=father.readUnsignedInt(len);break;
 
         case  MKV_AUDIO_FREQUENCY: entry->fq=(uint32_t)floor(father.readFloat(len));break;
+        case  MKV_AUDIO_CHANNELS: entry->chan=father.readUnsignedInt(len);break;
         //case MKV_AUDIO_OUT_FREQUENCY:entry->fq=(uint32_t)floor(father.readFloat(len));break;
         case  MKV_VIDEO_WIDTH: entry->w=father.readUnsignedInt(len);break;
         case  MKV_VIDEO_HEIGHT: entry->h=father.readUnsignedInt(len);break;



From mean at mail.berlios.de  Sun Dec  6 11:57:36 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 6 Dec 2009 11:57:36 +0100
Subject: [Avidemux-svn-commit] r5624 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDecoders/ADM_ad_vorbis
Message-ID: <200912061057.nB6AvaA7012434@sheep.berlios.de>

Author: mean
Date: 2009-12-06 11:57:36 +0100 (Sun, 06 Dec 2009)
New Revision: 5624

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDecoders/ADM_ad_vorbis/ADM_ad_vorbis.cpp
Log:
[VORBIS] Fix channel layout for multichannel vorbis track, refs #60 and #61

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDecoders/ADM_ad_vorbis/ADM_ad_vorbis.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDecoders/ADM_ad_vorbis/ADM_ad_vorbis.cpp	2009-12-06 10:57:34 UTC (rev 5623)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDecoders/ADM_ad_vorbis/ADM_ad_vorbis.cpp	2009-12-06 10:57:36 UTC (rev 5624)
@@ -154,13 +154,32 @@
 	printf("Vorbis init successfull\n");
 	STRUCT->ampscale=1;
 	_init=1;
-
-	channelMapping[0] = CHTYP_FRONT_LEFT;
-	channelMapping[1] = CHTYP_FRONT_RIGHT;
-	channelMapping[2] = CHTYP_REAR_LEFT;
-	channelMapping[3] = CHTYP_REAR_RIGHT;
-	channelMapping[4] = CHTYP_FRONT_CENTER;
-	channelMapping[5] = CHTYP_LFE;
+CHANNEL_TYPE *p_ch_type = channelMapping;
+#define DOIT(y) *(p_ch_type++)=CHTYP_##y;
+    switch(STRUCT->vinfo.channels)
+    {
+    case 1:
+    case 2:
+    {
+        DOIT(FRONT_LEFT);
+        DOIT(FRONT_RIGHT);
+        break;
+    }
+    default:
+    case 5:
+    {
+        DOIT(FRONT_LEFT);
+        DOIT(FRONT_CENTER);
+        DOIT(FRONT_RIGHT);
+        
+        
+        DOIT(REAR_LEFT);
+        DOIT(REAR_RIGHT);
+        DOIT(LFE);
+        break;
+    }
+    }
+	
  }
  // This codec expects more or less one packet at a time !
  



From mean at mail.berlios.de  Sun Dec  6 12:01:40 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 6 Dec 2009 12:01:40 +0100
Subject: [Avidemux-svn-commit] r5626 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_vorbis
Message-ID: <200912061101.nB6B1eJV012710@sheep.berlios.de>

Author: mean
Date: 2009-12-06 12:01:40 +0100 (Sun, 06 Dec 2009)
New Revision: 5626

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_vorbis/ADM_ad_vorbis.cpp
Log:
[Vorbis] Vorbis channel layout

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_vorbis/ADM_ad_vorbis.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_vorbis/ADM_ad_vorbis.cpp	2009-12-06 11:01:39 UTC (rev 5625)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_vorbis/ADM_ad_vorbis.cpp	2009-12-06 11:01:40 UTC (rev 5626)
@@ -153,13 +153,31 @@
 	printf("Vorbis init successfull\n");
 	STRUCT->ampscale=1;
 	_init=1;
-
-	channelMapping[0] = ADM_CH_FRONT_LEFT;
-	channelMapping[1] = ADM_CH_FRONT_RIGHT;
-	channelMapping[2] = ADM_CH_REAR_LEFT;
-	channelMapping[3] = ADM_CH_REAR_RIGHT;
-	channelMapping[4] = ADM_CH_FRONT_CENTER;
-	channelMapping[5] = ADM_CH_LFE;
+  CHANNEL_TYPE *p_ch_type = channelMapping;
+#define DOIT(y) *(p_ch_type++)=ADM_CH_##y;
+    switch(STRUCT->vinfo.channels)
+    {
+    case 1:
+    case 2:
+    {
+        DOIT(FRONT_LEFT);
+        DOIT(FRONT_RIGHT);
+        break;
+    }
+    default:
+    case 5:
+    {
+        DOIT(FRONT_LEFT);
+        DOIT(FRONT_CENTER);
+        DOIT(FRONT_RIGHT);
+        
+        
+        DOIT(REAR_LEFT);
+        DOIT(REAR_RIGHT);
+        DOIT(LFE);
+        break;
+    }
+    }
  }
  // This codec expects more or less one packet at a time !
 
@@ -195,7 +213,7 @@
 
 	// Puge them
 	 vorbis_synthesis_read(&STRUCT->vdsp,nb_synth);
-	 printf("This round : in %d bytes, out %d bytes synthetized:%d\n",nbIn,*nbOut,nb_synth);
+	 //printf("This round : in %d bytes, out %d bytes synthetized:%d\n",nbIn,*nbOut,nb_synth);
 	return 1;
 
 }



From mean at mail.berlios.de  Sun Dec  6 12:01:39 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 6 Dec 2009 12:01:39 +0100
Subject: [Avidemux-svn-commit] r5625 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska
Message-ID: <200912061101.nB6B1dKP012700@sheep.berlios.de>

Author: mean
Date: 2009-12-06 12:01:39 +0100 (Sun, 06 Dec 2009)
New Revision: 5625

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp
Log:
[MKV] Fix multichannel audio track loading (esp vorbis)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp	2009-12-06 10:57:36 UTC (rev 5624)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp	2009-12-06 11:01:39 UTC (rev 5625)
@@ -196,6 +196,7 @@
         //case MKV_AUDIO_OUT_FREQUENCY:entry->fq=(uint32_t)floor(father.readFloat(len));break;
         case  MKV_VIDEO_WIDTH: entry->w=father.readUnsignedInt(len);break;
         case  MKV_VIDEO_HEIGHT: entry->h=father.readUnsignedInt(len);break;
+        case  MKV_AUDIO_CHANNELS: entry->chan=father.readUnsignedInt(len);break;
         case  MKV_TRACK_TIMECODESCALE:
                                 {
                                     printf("[Mkv] TimeCodeScale=%"LLU"\n",father.readUnsignedInt(len));



From mean at mail.berlios.de  Wed Dec  9 07:41:35 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 9 Dec 2009 07:41:35 +0100
Subject: [Avidemux-svn-commit] r5627 - in
	branches/avidemux_2.6_branch_mean/avidemux: . common
	common/ADM_script2 common/ADM_script2/include
	common/ADM_script2/src common/ADM_toolkit qt4
Message-ID: <200912090641.nB96fZMS022990@sheep.berlios.de>

Author: mean
Date: 2009-12-09 07:41:29 +0100 (Wed, 09 Dec 2009)
New Revision: 5627

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_js.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsDebug.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsIf.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsShell.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/StdFile.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/adm_scanner.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsUtils.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/idl.make
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/updateIdl.sh
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
   branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
   branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
Log:
[JS] Replace old jscript hooks by new ones

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/CMakeLists.txt	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/CMakeLists.txt	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1 @@
+subdirs (src)

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_js.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_js.h	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_js.h	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,39 @@
+/**
+    \file ADM_js
+    \brief Standard includes and defines
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_JS_H
+#define ADM_JS_H
+
+
+#include "ADM_default.h"
+#include <string.h>
+#include <pthread.h>
+#include "DIA_coreToolkit.h"
+#include "jsapi.h"
+
+#include "ADM_jsUtils.h"
+#include "ADM_jsShell.h"
+#include "ADM_jsDebug.h"
+
+typedef JSBool JS_PROTOTYPE(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
+
+#if !defined(ADM_JS_THREADSAFE)
+#define enterLock() {}
+#define leaveLock() {}
+#else
+#define enterLock() jsrefcount nRefCount = JS_SuspendRequest(cx)
+#define leaveLock() {JS_ResumeRequest(cx,nRefCount); }
+
+#endif
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsDebug.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsDebug.h	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsDebug.h	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,26 @@
+/**
+    \file ADM_JSDebug.h
+    \brief Debug oriented functions for avidemux JS/JS shell
+    \author mean (c) 2009 fixounet at free.fr
+
+
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef ADMJS_DEBUG_H
+#define ADMJS_DEBUG_H
+extern "C"
+{
+void jsPopupError(const char *s);
+void jsPopupInfo(const char *s);
+};
+
+
+#endif
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsIf.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsIf.h	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsIf.h	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,51 @@
+/**
+    \file ADM_JSif.cpp
+    \brief interface to js
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_JS_IF_H
+#define ADM_JS_IF_H
+
+/**
+    \enum JS_LOG_TYPE
+*/
+typedef enum
+{
+    JS_LOG_NORMAL,
+    JS_LOG_ERROR
+}JS_LOG_TYPE;
+/**
+    \typedef jsLoggerFunc
+*/
+typedef bool (jsLoggerFunc)(void *cookie,JS_LOG_TYPE type,const char *);
+/*
+
+*/
+bool ADM_jsRegisterLogger(void *cookie,jsLoggerFunc *fun);
+bool ADM_jsUnregisterLogger(void);
+
+/**
+    \fn parseECMAScript
+    \brief Compile & execute ecma script
+*/
+bool parseECMAScript(const char *name);
+
+/**
+    \fn    interactiveECMAScript
+    \brief interprete & execute ecma script (interactive)
+*/
+bool interactiveECMAScript(const char *name);
+/**
+    \fn jsLog
+
+*/
+bool jsLog(JS_LOG_TYPE type, const char *fmt,...);
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsShell.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsShell.h	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsShell.h	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,23 @@
+/**
+    \file ADM_jsShell.h
+    \brief Base class for js interactive shell
+    \author mean, fixounet at free.fr
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef ADM_JS_SHELL_H
+#define ADM_JS_SHELL_H
+#include "ADM_jsIf.h"
+typedef bool (jsShellEvaluate)(const char *str);
+bool ADM_startShell(jsShellEvaluate *eval);
+
+
+#endif // ADM_JS_SHELL_H
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,40 @@
+/**
+    \file ADM_jsUtils
+    \brief Simple param -> type utilities
+    \author mean fixounet at free.fr 2009
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_JS_UTILS_H
+#define ADM_JS_UTILS_H
+
+typedef enum
+{
+    ADM_JS_INVALID=0,
+    ADM_JS_UINT32_T=1,
+    ADM_JS_INT32_T,
+    ADM_JS_UINT64_T,
+    ADM_JS_INT64_T,
+    ADM_JS_STRING,
+    ADM_JS_BOOL,
+    ADM_JS_MAX
+}ADM_PARAM_TYPE;
+
+typedef struct
+{
+    ADM_PARAM_TYPE type;
+    void           *value;
+
+}ADM_PARAM_LIST;
+
+// since long int will be coded by js as double, we need a centralized version to convert
+bool ADM_jsArg2Vars(const char *caller, int argc, jsval *argv, int paramNumber, ADM_PARAM_LIST *param);
+
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/StdFile.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/StdFile.h	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/StdFile.h	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,63 @@
+// StdFile.h: interface for the CStdFile class.
+//
+//////////////////////////////////////////////////////////////////////
+/*
+Copyright 2001-2005 Anish Mistry. All rights reserved.
+
+Note:  This file is available under a BSD license.  Contact the author
+at amistry at am-productions.biz
+*/
+
+#if !defined(AFX_STDFILE_H__44214218_8F1A_4792_8D4D_8147F50E168D__INCLUDED_)
+#define AFX_STDFILE_H__44214218_8F1A_4792_8D4D_8147F50E168D__INCLUDED_
+
+#if _MSC_VER > 1000
+#pragma once
+#endif // _MSC_VER > 1000
+
+#include <iostream>
+#include <iomanip>
+#include <fstream>
+#include <stdlib.h>
+#include <string>
+
+using namespace std;
+
+#ifdef __WIN32
+	const char DIRECTORY_DELIMITOR = '\\';
+#else
+	const char DIRECTORY_DELIMITOR = '/';
+	#define _MAX_PATH 1024
+#endif
+
+class CStdFile
+{
+public:
+	char Peek();
+	int WriteString(const char *pBuffer);
+	char * ReadString(char *pBuffer, int nMaxLen,char cDelim = ' ');
+	unsigned long int GetPos();
+	unsigned long int Seek(unsigned long int pos,ios::seekdir start);
+	unsigned long int GetLength();
+	unsigned long int Write(const char *buffer, unsigned long int bytesToWrite);
+	unsigned long int Read(char *buffer, unsigned long int bytesToRead);
+	const char * GetFilePath();
+	const char * GetFileName();
+	CStdFile(void);
+	virtual ~CStdFile(void);
+//	static bool Copy(const char *source,const char *dest, bool bOverwrite);
+	static int Rename(const char *source,const char *dest);
+	static int Delete(const char *fileName);
+	virtual bool Open(const char *filename, ios::openmode accessFlags);
+	unsigned long int WriteLine(const char *);
+	unsigned long int ReadLine(char *bufferOut);
+	virtual bool Close();
+
+protected:
+	void GetName(const char *fileString,char *fileBufferOut);
+	char *m_pPath;
+	char *m_pName;
+	fstream m_fsFile;
+};
+
+#endif // !defined(AFX_STDFILE_H__44214218_8F1A_4792_8D4D_8147F50E168D__INCLUDED_)

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/adm_scanner.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/adm_scanner.h	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/adm_scanner.h	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,26 @@
+/*
+	Type used by scanner
+
+*/
+#ifndef ADMSCANNER
+#define ADMSCANNER
+
+#define ADM_MAX_VAR 50
+//#include "ADM_videoFilter_iface.h"
+
+typedef enum
+{
+	ASC_OK,
+	ASC_UNKNOWN_FUNC,
+	ASC_BAD_NUM_PARAM,
+	ASC_BAD_PARAM,
+	ASC_EXEC_FAILED
+}ASC_ERROR;
+
+//int PushParam(APM_TYPE, char *value);
+int Call(char *string);
+
+
+#endif
+//END
+

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,201 @@
+/**
+    \file ADM_JSDebug.cpp
+    \brief Debug oriented functions for avidemux JS/JS shell
+    \author mean (c) 2009 fixounet at free.fr
+
+
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_js.h"
+#include "ADM_editor/ADM_edit.hxx"
+/**/
+/**/
+
+extern JSFunctionSpec *ADM_JsAudioGetFunctions(void);
+extern JSFunctionSpec *ADM_JsVideoGetFunctions(void);
+extern JSFunctionSpec *ADM_JsClassGetFunctions(void);
+extern JSFunctionSpec *ADM_JsDebugGetFunctions(void);
+extern JSFunctionSpec *ADM_JsFunctionGetFunctions(void);
+
+extern ADM_Composer *video_body;
+void ADM_dumpJSHooks(void);
+#if 0
+/**
+    \fn JS_AvidemuxRegisterDebugFunction
+*/
+bool JS_AvidemuxRegisterDebugFunction(JSContext *cx,JSObject *global)
+{
+	if(JS_DefineFunctions(cx, global, adm_debug_functions) == true)
+		return true;
+
+	ADM_warning("Unable to define functions\n");
+	return false;
+}
+
+/**
+    \fn ADM_JsDebugGetFunctions
+
+*/
+JSFunctionSpec *ADM_JsDebugGetFunctions(void)
+{
+    return adm_debug_functions;
+}
+#endif
+/**
+    \fn displayError
+    \brief error popup
+*/
+void jsPopupError(const char *s)
+{// begin displayError
+	
+	GUI_Verbose();
+	GUI_Error_HIG("Error",s);
+	GUI_Quiet();
+
+}// end displayError
+/**
+    \fn displayInfo
+    \brief info popup
+*/
+
+void jsPopupInfo(const char *s)
+{// begin displayInfo
+	
+	GUI_Verbose();
+	GUI_Info_HIG(ADM_LOG_IMPORTANT,"Info",s);
+	GUI_Quiet();
+	
+}// end displayInfo
+ /**
+    \fn print
+*/
+void jsPrint(const char *s)
+{// begin print
+        jsLog(JS_LOG_NORMAL,"%s",s);
+}// end print
+
+
+static void dumpFunc(JSFunctionSpec *f)
+{
+    while(f->name)
+    {
+        jsLog(JS_LOG_NORMAL,"     %s(..)",f->name);
+        f++;
+    }
+}
+/**
+    \fn help
+    \brief dump avidemux specific functions
+*/
+JSBool help(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+#if 0
+        if(!argc)
+        {
+            jsLog(JS_LOG_NORMAL,"help(\"class\"); or help(\"video\"); or help(\"audio\"); or help(\"debug\"); or debug(\"functions\"");
+            return JS_TRUE;
+        }
+        if(argc != 1)
+        {
+          jsLog(JS_LOG_ERROR,"help accepts only one arg, type help() to get them\n");
+          return JS_FALSE;
+        } 
+        JSFunctionSpec *table=NULL;
+        char *f=JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
+        
+#define DUMPTABLE(x,y) if(!strcasecmp(f,#x)) table=y();
+        if(f)
+        {
+            DUMPTABLE(audio,ADM_JsAudioGetFunctions);
+            DUMPTABLE(video,ADM_JsVideoGetFunctions);
+            DUMPTABLE(debug,ADM_JsDebugGetFunctions);
+            DUMPTABLE(functions,ADM_JsFunctionGetFunctions);
+            DUMPTABLE(class,ADM_JsClassGetFunctions);
+        }
+        if(table) dumpFunc(table);
+        else jsLog(JS_LOG_ERROR,"%s not found",f);
+#endif  
+  return JS_TRUE;
+}
+/**
+    \fn dumpEditing
+    \brief dump segment, video & all
+*/
+JSBool dumpEditing(JSContext *cx, JSObject *obj, uintN argc, 
+                                       jsval *argv, jsval *rval)
+{// begin PostProcess
+uint32_t info;
+uint32_t frame;
+uint32_t sz;
+        if(argc)
+        {
+            return JS_FALSE;
+        }
+        enterLock();
+        video_body->dumpEditing();
+        leaveLock(); 
+        
+        return JS_TRUE;
+}// end PostProcess
+/**
+    \fn dumpTiming
+    \brief dump segment, video & all
+*/
+JSBool dumpTiming(JSContext *cx, JSObject *obj, uintN argc, 
+                                       jsval *argv, jsval *rval)
+{// begin PostProcess
+uint32_t info;
+uint32_t frame;
+uint32_t sz;
+        if(argc != 0)
+          return JS_FALSE;
+  
+        enterLock();
+        video_body->dumpTiming();
+        leaveLock(); 
+        
+        return JS_TRUE;
+}// end PostProcess
+/**
+    \fn printJSError
+*/
+void  printJSError(JSContext *cx, const char *message, JSErrorReport *report)
+{// begin printJSError
+int quiet=GUI_isQuiet();
+char buf[4];
+FILE *fd = ADM_fopen(report->filename,"rb");
+    if(quiet)
+            GUI_Verbose();
+	if( fd )
+    {
+		fread(buf,1,4,fd);
+		fclose(fd);
+	}
+	if( strncmp(buf,"//AD",4) )
+    {
+            if (report->filename || report->lineno)
+                jsLog(JS_LOG_ERROR,"%s: line %d:\nMsg: %s\n"
+                              "Not an ECMAScript file. Try open it with 'File' -> 'Open...'",
+                              report->filename,
+                              report->lineno,
+                              message);
+            else
+                jsLog(JS_LOG_ERROR,"Not an ECMAScript file. Try open it with 'File' -> 'Open...'");
+    
+	}else
+    {
+            jsLog(JS_LOG_ERROR,"%s: line %d:\nMsg: %s\n",report->filename,report->lineno,message);
+	}
+       
+    if(quiet)
+            GUI_Quiet();
+
+}// end printJSError
+// EOF
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,232 @@
+/**
+    \file ADM_JSif.cpp
+    \brief interface to js
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "ADM_js.h"
+#include <stdarg.h>
+void    A_Resync(void);
+static jsLoggerFunc *jsLogger=NULL;
+static void *jsLoggerCookie=NULL;
+extern char * actual_workbench_file;
+
+#define JSVAR(a,b,c) a b=c
+
+#if defined( __MINGW32__) && defined(JSDECLARE)
+ pthread_t g_pThreadSpidermonkey ;
+#else
+JSVAR( pthread_t, g_pThreadSpidermonkey , 0);
+#endif
+JSVAR( pthread_mutex_t, g_pSpiderMonkeyMutex , PTHREAD_MUTEX_INITIALIZER);
+// expose our main javascript context to the entire program
+JSVAR( bool, g_bJSSuccess , 0);
+JSVAR( JSObject, *g_pObject,NULL);
+JSVAR( JSContext, *g_pCx,NULL);
+JSVAR( JSRuntime, *g_pRt,NULL);
+
+extern void  printJSError(JSContext *cx, const char *message, JSErrorReport *report);
+/**
+    \fn parseECMAScript
+    \brief Compile & execute ecma script
+*/
+bool parseECMAScript(const char *name)
+{// begin parseECMAScript
+	jsval rval;
+	uintN lineno = 0;
+	g_bJSSuccess = 0;
+	printf("Spidermonkey compiling \"%s\"...",name);
+	JSScript *pJSScript = JS_CompileFile(g_pCx, g_pObject, name);
+	printf("Done.\n");
+	if(pJSScript != NULL)
+	{// begin execute external file
+		printf("Spidermonkey executing \"%s\"...",name);
+		JSBool ok = JS_ExecuteScript(g_pCx, g_pObject, pJSScript, &rval);
+		JS_DestroyScript(g_pCx,pJSScript);
+		printf("Done.\n");
+	}// end execute external file
+        // Run garbage collector now, it is safe
+    JS_GC(g_pCx);
+	A_Resync();
+	return g_bJSSuccess;
+}// end parseECMAScript
+/**
+    \fn jsLogger
+*/
+bool isJsLogRedirected(void)
+{
+    if(jsLogger) return true;
+    return false;
+}
+/**
+    \fn jsEvaluate
+*/
+static bool jsEvaluate(const char *str)
+{
+jsval rval;
+   JS_EvaluateScript(g_pCx,g_pObject,str,strlen(str),"dummy",1,&rval);
+   return true; 
+}
+/**
+    \fn    interactiveECMAScript
+    \brief interprete & execute ecma script (interactive)
+*/
+bool interactiveECMAScript(const char *name)
+{
+    ADM_startShell(jsEvaluate);
+    JS_GC(g_pCx);
+	A_Resync();
+    ADM_info("Ending JS shell...\n");
+	return true;
+}
+/**
+    \fn jsLog
+*/
+bool jsLog(JS_LOG_TYPE type, const char *prf,...)
+{
+ static char print_buffer[1024];
+  	
+		va_list 	list;
+		va_start(list,	prf);
+		vsnprintf(print_buffer,1023,prf,list);
+		va_end(list);
+		print_buffer[1023]=0; // ensure the string is terminated
+        if(true==isJsLogRedirected())
+            jsLogger(jsLoggerCookie,type,print_buffer);
+        else
+        {
+            if(type==JS_LOG_ERROR)
+                GUI_Error_HIG("Spidermonkey ECMAScript Error","%s",print_buffer);
+            else
+                ADM_warning("[JS]%s\n",print_buffer);
+        }
+        return true;
+}
+
+/**
+    \fn ADM_jsRegisterLogger
+*/
+bool ADM_jsRegisterLogger(void *cookie,jsLoggerFunc *fun)
+{
+    jsLoggerCookie=cookie;
+    jsLogger=fun;
+    return true;
+}
+/**
+    \fn ADM_jsUnregisterLogger
+*/
+bool ADM_jsUnregisterLogger(void)
+{
+    jsLogger=NULL;
+    return true;
+}
+
+/**
+    \fn SpidermonkeyInit
+*/
+bool SpidermonkeyInit()
+{// begin SpidermonkeyInit
+	// setup JS
+	g_pCx = NULL;
+	g_pObject = NULL;
+	g_pRt = NULL;
+	JSRuntime *rt = JS_NewRuntime(1000000L);
+	g_pRt = rt;
+	if ( rt == NULL )
+	{
+		// Do some error reporting
+		printf("Spidermonkey failed to initialize runtime!\n");
+	}
+	else
+	{// begin runtime created
+		JSContext *cx = JS_NewContext(rt, 8192);
+		g_pCx = cx;
+		if ( cx == NULL )
+		{
+			// Do some error reporting
+			printf("Spidermonkey failed to initialize context!\n");
+		}
+		else
+		{// begin context created
+
+			// register error handler
+			JS_SetErrorReporter(cx, printJSError);
+            //JS_AvidemuxFunction(cx,global);
+            
+			return true;
+		}// end context created
+	}// end runtime created
+	return false;
+}// end SpidermonkeyInit
+/**
+    \fn SpidermonkeyDestroy
+*/
+void SpidermonkeyDestroy()
+{// begin SpidermonkeyDestroy
+#ifdef ADM_JS_THREADSAFE
+	JS_SetContextThread(g_pCx);	
+#endif
+	JS_DestroyContext(g_pCx);
+	JS_DestroyRuntime(g_pRt);
+}// end SpidermonkeyDestroy
+
+void *StartThreadSpidermonkey(void *pData)
+{// begin StartThreadSpidermonkey
+        pthread_mutex_lock(&g_pSpiderMonkeyMutex);
+        /*
+        The following mailling list post describes how to CORRECTLY use
+        the threading API support with Spidermonkey
+        "Thread from SpiderMonkey newsgroup"
+        http://archive.gingerall.cz/archives/public/sablot2004/msg00117.html
+        */
+        // Notify the Spidermonkey that we'll be processing in a thread
+#ifdef ADM_JS_THREADSAFE
+        JS_SetContextThread(g_pCx);
+        JS_BeginRequest(g_pCx);
+#endif
+        bool ret = false;
+        const char *pScriptFile = static_cast<const char *>(pData);
+        ret = parseECMAScript(pScriptFile);
+        if(ret == false)
+        {
+                if( actual_workbench_file )
+                        ADM_dealloc(actual_workbench_file);
+                actual_workbench_file = ADM_strdup(pScriptFile);
+        }
+        // Notify Spidermonkey that our thread processing has finished
+#ifdef ADM_JS_THREADSAFE
+        JS_EndRequest(g_pCx);
+        JS_ClearContextThread(g_pCx);
+#endif
+        pthread_mutex_unlock(&g_pSpiderMonkeyMutex);
+
+        return NULL;
+}// end StartThreadSpidermonkey
+/**
+    \fn JS_setSuccess
+*/
+void JS_setSuccess(bool bSuccess)
+{// begin JS_setSuccess
+	g_bJSSuccess = bSuccess;
+	printf("[ECMA] success : %d\n", g_bJSSuccess);
+}// end JS_setSuccess
+/**
+    \fn ADM_jsExit
+*/
+bool ADM_jsExit(void)
+{
+    ADM_info("Waiting for Spidermonkey to finish...\n");
+    pthread_mutex_lock(&g_pSpiderMonkeyMutex);
+    ADM_info("Cleaning up Spidermonkey.\n");
+    SpidermonkeyDestroy();
+    pthread_mutex_unlock(&g_pSpiderMonkeyMutex);
+    return true;
+}
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,260 @@
+/*
+--- DO NOT EDIT THIS FILE !!! ---
+
+This file has been generated automatically with 'jsapigen'.
+
+jsapigen is a glue-code generator for SpiderMonkey. It is distributed
+under the conditions of version 3 of the GNU General Public License.
+Please have a look at http://jsapigen.sourceforge.net.
+
+This file is NOT part of jsapigen and is NOT necessarily covered by
+jsapigen's license. For licensing information regarding this file,
+please refer to the software package which it is part of.
+
+*/
+#include <string.h>
+#include <wchar.h>
+#include <jsapi.h>
+#ifndef JS_THREADSAFE
+#if JS_VERSION <= 170
+#define jsrefcount int
+#define JS_BeginRequest(cx)
+#define JS_EndRequest(cx)
+#define JS_SuspendRequest(cx)
+#define JS_ResumeRequest(cx, saveDepth)
+#endif
+#endif
+#ifndef JS_FS
+#define JS_FS(name, call, nargs, flags, extra) {name, call, nargs, flags, extra}
+#endif
+#ifndef JS_FS_END
+#define JS_FS_END {NULL, NULL, 0, 0, 0}
+#endif
+static JSBool
+jjjsPopupError(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var2;
+    char *var7;
+    int var6;
+    int var8;
+    jsval var9;
+    JSString *var10;
+    jsval var43;
+    size_t var11;
+    size_t var12;
+    int var14;
+    jschar *var13;
+    jsval var44;
+    JSBool var1;
+    var2 = NULL;
+    var7 = NULL;
+    var6 = 0;
+    var8 = 0;
+    var9 = JSVAL_NULL;
+    var10 = NULL;
+    var43 = JSVAL_NULL;
+    var11 = 0;
+    var12 = 0;
+    var14 = 0;
+    var13 = NULL;
+    var44 = JSVAL_NULL;
+    var1 = JS_FALSE;
+    var2 = obj;
+    var6 = argc;
+    var8 = 0;
+    var8 = var8 < var6;
+    if (var8) {
+    var9 = argv[0];
+    var10 = JS_ValueToString(cx, var9);
+    if (!var10) {
+        goto do_return;
+    }
+    var43 = STRING_TO_JSVAL(var10);
+    argv[argc+0] = var43;
+    var11 = JS_GetStringLength(var10);
+    var12 = 1;
+    var12 += var11;
+    var7 = JS_malloc(cx, var12);
+    if (!var7) {
+        goto do_return;
+    }
+    var14 = 1;
+    var13 = JS_GetStringChars(var10);
+    var44 = STRING_TO_JSVAL(var10);
+    argv[argc+1] = var44;
+    {
+        size_t i;
+        for (i = 0; i < var11; ++i) {
+            var7[i] = wctob(var13[i]);
+        }
+        var7[var11] = '\0';
+    }
+    }
+    admPopupError(var7);
+    var1 = JS_TRUE;
+    do_return:
+    if (var14) {
+        JS_free(cx, var7);
+        var7 = NULL;
+        var14 = 0;
+    }
+    return var1;
+}
+static JSBool
+jjjspPopupInfo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var16;
+    char *var21;
+    int var20;
+    int var22;
+    jsval var23;
+    JSString *var24;
+    jsval var45;
+    size_t var25;
+    size_t var26;
+    int var28;
+    jschar *var27;
+    jsval var46;
+    JSBool var15;
+    var16 = NULL;
+    var21 = NULL;
+    var20 = 0;
+    var22 = 0;
+    var23 = JSVAL_NULL;
+    var24 = NULL;
+    var45 = JSVAL_NULL;
+    var25 = 0;
+    var26 = 0;
+    var28 = 0;
+    var27 = NULL;
+    var46 = JSVAL_NULL;
+    var15 = JS_FALSE;
+    var16 = obj;
+    var20 = argc;
+    var22 = 0;
+    var22 = var22 < var20;
+    if (var22) {
+    var23 = argv[0];
+    var24 = JS_ValueToString(cx, var23);
+    if (!var24) {
+        goto do_return;
+    }
+    var45 = STRING_TO_JSVAL(var24);
+    argv[argc+0] = var45;
+    var25 = JS_GetStringLength(var24);
+    var26 = 1;
+    var26 += var25;
+    var21 = JS_malloc(cx, var26);
+    if (!var21) {
+        goto do_return;
+    }
+    var28 = 1;
+    var27 = JS_GetStringChars(var24);
+    var46 = STRING_TO_JSVAL(var24);
+    argv[argc+1] = var46;
+    {
+        size_t i;
+        for (i = 0; i < var25; ++i) {
+            var21[i] = wctob(var27[i]);
+        }
+        var21[var25] = '\0';
+    }
+    }
+    admPopupInfo(var21);
+    var15 = JS_TRUE;
+    do_return:
+    if (var28) {
+        JS_free(cx, var21);
+        var21 = NULL;
+        var28 = 0;
+    }
+    return var15;
+}
+static JSBool
+jjjsPrint(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var30;
+    char *var35;
+    int var34;
+    int var36;
+    jsval var37;
+    JSString *var38;
+    jsval var47;
+    size_t var39;
+    size_t var40;
+    int var42;
+    jschar *var41;
+    jsval var48;
+    JSBool var29;
+    var30 = NULL;
+    var35 = NULL;
+    var34 = 0;
+    var36 = 0;
+    var37 = JSVAL_NULL;
+    var38 = NULL;
+    var47 = JSVAL_NULL;
+    var39 = 0;
+    var40 = 0;
+    var42 = 0;
+    var41 = NULL;
+    var48 = JSVAL_NULL;
+    var29 = JS_FALSE;
+    var30 = obj;
+    var34 = argc;
+    var36 = 0;
+    var36 = var36 < var34;
+    if (var36) {
+    var37 = argv[0];
+    var38 = JS_ValueToString(cx, var37);
+    if (!var38) {
+        goto do_return;
+    }
+    var47 = STRING_TO_JSVAL(var38);
+    argv[argc+0] = var47;
+    var39 = JS_GetStringLength(var38);
+    var40 = 1;
+    var40 += var39;
+    var35 = JS_malloc(cx, var40);
+    if (!var35) {
+        goto do_return;
+    }
+    var42 = 1;
+    var41 = JS_GetStringChars(var38);
+    var48 = STRING_TO_JSVAL(var38);
+    argv[argc+1] = var48;
+    {
+        size_t i;
+        for (i = 0; i < var39; ++i) {
+            var35[i] = wctob(var41[i]);
+        }
+        var35[var39] = '\0';
+    }
+    }
+    admPrint(var35);
+    var29 = JS_TRUE;
+    do_return:
+    if (var42) {
+        JS_free(cx, var35);
+        var35 = NULL;
+        var42 = 0;
+    }
+    return var29;
+}
+static JSPropertySpec jj_static_ps[] = {
+    {NULL, 0, 0, NULL, NULL}
+};
+static JSPropertySpec jj_ps[] = {
+    {NULL, 0, 0, NULL, NULL}
+};
+static JSFunctionSpec jj_static_fs[] = {
+    JS_FS("jsPopupError", jjjsPopupError, 1, 0, 2),
+    JS_FS("jspPopupInfo", jjjspPopupInfo, 1, 0, 2),
+    JS_FS("jsPrint", jjjsPrint, 1, 0, 2),
+    JS_FS_END
+};
+static JSFunctionSpec jj_fs[] = {
+    JS_FS("jsPopupError", jjjsPopupError, 1, 0, 2),
+    JS_FS("jspPopupInfo", jjjspPopupInfo, 1, 0, 2),
+    JS_FS("jsPrint", jjjsPrint, 1, 0, 2),
+    JS_FS_END
+};

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,10 @@
+/*
+###############################################################
+       return C function     JS Function  params
+###############################################################
+*/
+function void jsPopupError : admPopupError   (cstring  ) <static>;
+function void jspPopupInfo : admPopupInfo    (cstring  ) <static>;
+function void jsPrint      : admPrint        (cstring  ) <static>;
+
+

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory.cpp	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory.cpp	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,429 @@
+/**
+    \file ADM_JSif.cpp
+    \brief interface to js
+
+ Author: Anish Mistry/mean/gruntster
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_js.h"
+#include "ADM_editor/ADM_edit.hxx"
+#include "DIA_fileSel.h"
+#include "DIA_factory.h"
+
+
+extern "C"
+{
+    void jsCrashTest(void);
+    void jsAssertTest(void);
+}
+
+/**
+    \fn crashTest
+    \brief Force a crash
+*/
+void jsCrashTest(void)
+{
+  
+  int *foobar=NULL;
+  *foobar=0; // CRASH!
+
+}
+/**
+    \fn assertTest
+    \brief Force a crash
+*/
+void jsAssertTest(void)
+{
+  
+  ADM_assert(0);
+
+}
+
+
+/**
+    \fn jsFacInt
+*/
+bool jsFacInt(void)
+{
+  uint32_t tog=0;
+   diaElemUInteger blend(&tog,QT_TR_NOOP("Uinteger"),0,255);
+    diaElem *elems[]={&blend   };
+    
+  if(diaFactoryRun(QT_TR_NOOP("Test uinteger"),1,elems))
+  {
+    jsLog(JS_LOG_NORMAL,"Value : %u\n",tog);
+    return true;
+  }
+  return false;
+}
+
+/**
+    \fn jsFacFloat
+*/
+bool jsFacFloat(void)
+{
+  ELEM_TYPE_FLOAT tog=0;
+   diaElemFloat blend(&tog,QT_TR_NOOP("Float"),0,255);
+    diaElem *elems[]={&blend   };
+    
+  if(diaFactoryRun("Test float",1,elems))
+  {
+    jsLog(JS_LOG_NORMAL,"Value : %f\n",(float)tog);
+    return true;
+  }
+  return false;
+}
+
+/**
+    \fn jsFacToggle
+*/
+bool jsFacToggle(void)
+{
+  uint32_t tog=0;
+  uint32_t test=0;
+   diaElemToggle blend(&tog,QT_TR_NOOP("Toggle"));
+    diaElemUInteger     bt(&test,"Entry",0,10);
+    diaElemUInteger     bt2(&test,"Entry",0,10);
+    diaElem *elems[]={&blend,&bt,&bt2   };
+    blend.link(1,&bt);
+    blend.link(0,&bt2);
+    
+  if(diaFactoryRun("Test Toggle",3,elems))
+   {
+    jsLog(JS_LOG_NORMAL,"Value : %u\n",tog);
+    return true;
+  }
+  return false;
+}
+
+/**
+    \fn jsFacMenu
+*/
+bool jsFacMenu(void)
+{
+   uint32_t tog=4;
+   ELEM_TYPE_FLOAT f=1; 
+   
+    diaMenuEntry menu[]={
+                             {2,   QT_TR_NOOP("No Strategy"),NULL},
+                             {4,     QT_TR_NOOP("3:2 Pulldown"),NULL},
+                             {6,     QT_TR_NOOP("Pal/Secam"),NULL},
+                             {7,  QT_TR_NOOP("NTSC converted from PAL"),NULL}
+                          };
+   diaElemMenu blend(&tog,QT_TR_NOOP("menu"),4,menu);
+    
+    // Link it to another
+    diaElemFloat toggle(&f,"Linked float",1,2);
+    blend.link(&(menu[1]),1,&toggle);
+    //
+diaElem *elems[]={&blend,&toggle   };
+  if(diaFactoryRun("Test Menu",2,elems))
+   {
+    jsLog(JS_LOG_NORMAL,"Value : %"LU"\n",tog);
+    return true;
+  }
+  return false;
+}
+
+/**
+    \fn jsFacFile
+*/
+bool jsFacFile(void)
+{
+   uint32_t tog=0;
+   char *test=ADM_strdup("Entry test1");
+    
+      diaElemFile fread(0,&test,"Entry");
+      diaElem *elems[]={&fread   };
+  if(diaFactoryRun("Test FileRead",1,elems))
+   {
+    jsLog(JS_LOG_NORMAL,"Value : %s\n",test);
+    if(test) ADM_dealloc(test);
+    return true;
+  }
+ if(test) ADM_dealloc(test);
+  return false;
+}
+
+/**
+    \fn jsFacDirSel
+*/
+bool jsFacDirSel(void)
+{
+   uint32_t tog=0;
+   char *test=ADM_strdup("Entry test1");
+    
+  diaElemDirSelect fread(&test,"Entry");
+  diaElem *elems[]={&fread   };
+  if(diaFactoryRun("Test DirSel",1,elems))
+  {
+    jsLog(JS_LOG_NORMAL,"Value : %s\n",test);
+    if(test) ADM_dealloc(test);
+    return true;
+  }
+ if(test) ADM_dealloc(test);
+  return false;
+}
+
+/**
+    \fn jsFacBitrate
+*/
+bool jsFacBitrate(void)
+{
+
+   COMPRES_PARAMS test={
+  COMPRESS_CQ,
+  1,
+  1500,
+  700,
+  1000,
+  ADM_ENC_CAP_CQ+ADM_ENC_CAP_2PASS+ADM_ENC_CAP_CBR+ADM_ENC_CAP_SAME
+  };
+    
+      diaElemBitrate bt(&test,"Entry");
+      diaElem *elems[]={&bt   };
+  if(diaFactoryRun("Test BitRate",1,elems))
+   {
+    
+    return true;
+  }
+  return false;
+}
+
+/**
+    \fn jsFacInt
+*/
+bool jsFacBar(void)
+{
+    
+      diaElemBar bar1(25,"25");
+      diaElemBar bar2(65,"65");
+      diaElem *elems[]={&bar1,&bar2   };
+  if(diaFactoryRun("Test FileRead",2,elems))
+  {
+   return true;
+  }
+  return false;
+}
+
+void clickMe(void *cookie)
+{
+  GUI_Error_HIG("Button","Button pressed!"); 
+}
+
+/**
+    \fn jsFacButton
+*/
+bool jsFacButton(void)
+{
+    
+      diaElemButton bar1("Button",clickMe,NULL);
+      diaElem *elems[]={&bar1   };
+  if(diaFactoryRun("Test Button",1,elems))
+  {
+    return true;
+  }
+  return false;
+}
+
+/**
+    \fn jsFacSlider
+*/
+bool jsFacSlider(void)
+{
+  int32_t val=4;
+      diaElemSlider slide(&val,"foo", 0,10);
+      
+      diaElem *elems[]={&slide   };
+  if(diaFactoryRun("Test Slider",1,elems))
+  {
+    jsLog(JS_LOG_NORMAL,"Value : %d\n",(int)val);
+    return true;
+  }
+  return false;
+}
+
+/**
+    \fn jsFacInt
+*/
+bool jsFacRoText(void)
+
+{
+    
+      diaElemReadOnlyText txt("blah blah","Value:");
+      
+      diaElem *elems[]={&txt   };
+  if(diaFactoryRun("Test FileRead",1,elems))
+  {
+    return true;
+  }
+  return false;
+}
+
+/**
+    \fn jsFacText
+*/
+bool jsFacText(void)
+{
+    
+      char *foo=ADM_strdup("blah");
+      diaElemText txt(&foo,"Text",NULL);
+      
+      diaElem *elems[]={&txt   };
+  if(diaFactoryRun("Test FileRead",1,elems))
+ {
+    jsLog(JS_LOG_NORMAL,"Out:%s",foo);
+    if(foo) ADM_dealloc(foo);
+    return true;
+  }
+  if(foo) ADM_dealloc(foo);
+  return false;
+}
+
+/**
+    \fn jsFacInt
+*/
+bool jsFacTab(void)
+{
+    
+      uint32_t test,test2;
+      
+      diaElemReadOnlyText txt("blah blah","Value:");
+      diaElemUInteger     bt(&test,"Entry",0,10);
+      diaElemUInteger     bt2(&test2,"Entry",0,10);
+      
+      
+      diaElem *elems1[]={&txt   };
+      diaElem *elems2[]={&bt,&bt2   };
+      
+      diaElemTabs tab1("T1",1,(diaElem **)elems1);
+      diaElemTabs tab2("T2",2,(diaElem **)elems2);
+      
+      diaElemTabs *tabs[2]={&tab1,&tab2};
+          
+      
+  if(diaFactoryRunTabs("Test FileRead",2,tabs))
+ {
+    return true;
+  }
+  return false;
+}
+
+/**
+    \fn jsFacInt
+*/
+bool jsFacFrame(void)
+{
+    
+      uint32_t test,test2;
+      
+      diaElemReadOnlyText align("*****","Value:");
+      diaElemReadOnlyText txt("blah blah","Value:");
+      diaElemUInteger     bt(&test,"Entry1",0,10);
+      diaElemUInteger     bt2(&test2,"Entry2",0,10);
+      diaElemFrame        frm("Frame1");
+      
+      frm.swallow(&txt);
+      frm.swallow(&bt);
+      frm.swallow(&bt2);
+      
+         diaElem *elems[]={&align,&frm   };
+  if(diaFactoryRun("Test frame",2,elems))
+ {
+    return true;
+  }
+  return false;
+}
+
+
+/**
+    \fn jsFacHex
+*/
+bool jsFacHex(void)
+{
+    
+      uint8_t data[100];
+      for(int i=0;i<100;i++) data[i]=i;
+      
+      diaElemHex binhex("*****",100,data);
+      
+      
+         diaElem *elems[]={&binhex   };
+  if(diaFactoryRun("Test binHex",1,elems))
+  {
+    return true;
+  }
+  return false;
+      
+}
+
+/**
+    \fn jsFacMatrix
+*/
+bool jsFacMatrix(void)
+{
+    
+      uint8_t data[16];
+      for(int i=0;i<100;i++) data[i]=i;
+      
+      diaElemMatrix Matrix(data,"Matrix",4);
+      
+      
+         diaElem *elems[]={&Matrix   };
+  if(diaFactoryRun("Test Matrix",1,elems))
+  {
+      for(int x=0;x<4*4;x++)
+      {
+          if(x && !(x&3)) printf("\n");
+          jsLog(JS_LOG_NORMAL,"%02x ",data[x]);
+          
+      }
+      return true;
+  }
+  return false;
+}
+
+/**
+    \fn jsFacThreadcount
+*/
+bool jsFacThreadcount(void)
+{
+	uint32_t val=1;
+	diaElemThreadCount threadcount(&val,"ThreadCount");
+      
+    diaElem *elems[]={&threadcount   };
+    
+  if(diaFactoryRun("Test ThreadCount",1,elems))
+  {
+         jsLog(JS_LOG_NORMAL,"Thread: %u ",(unsigned int)val);
+        return true;
+  }
+  return false;
+}
+
+/**
+    \fn jsFacNotch
+*/
+bool jsFacNotch(void)
+{
+    
+	diaElemNotch notch(1,"Notch");
+      
+         diaElem *elems[]={&notch   };
+  if(diaFactoryRun("Test Notch",1,elems))
+  {
+    return true;
+  }
+  return false;
+      
+}
+
+//EOF 

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,1500 @@
+/*
+--- DO NOT EDIT THIS FILE !!! ---
+
+This file has been generated automatically with 'jsapigen'.
+
+jsapigen is a glue-code generator for SpiderMonkey. It is distributed
+under the conditions of version 3 of the GNU General Public License.
+Please have a look at http://jsapigen.sourceforge.net.
+
+This file is NOT part of jsapigen and is NOT necessarily covered by
+jsapigen's license. For licensing information regarding this file,
+please refer to the software package which it is part of.
+
+*/
+#include <string.h>
+#include <wchar.h>
+#include <jsapi.h>
+#ifndef JS_THREADSAFE
+#if JS_VERSION <= 170
+#define jsrefcount int
+#define JS_BeginRequest(cx)
+#define JS_EndRequest(cx)
+#define JS_SuspendRequest(cx)
+#define JS_ResumeRequest(cx, saveDepth)
+#endif
+#endif
+#ifndef JS_FS
+#define JS_FS(name, call, nargs, flags, extra) {name, call, nargs, flags, extra}
+#endif
+#ifndef JS_FS_END
+#define JS_FS_END {NULL, NULL, 0, 0, 0}
+#endif
+static JSBool
+jjjsTestFacInt(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var2;
+    void *var3;
+    int var6;
+    jsval var7;
+    JSObject *var8;
+    JSObject *var9;
+    JSClass *var10;
+    char *var12;
+    JSBool var14;
+    jsval var15;
+    JSObject *var16;
+    jsval var373;
+    char *var20;
+    JSBool var17;
+    jsval var18;
+    JSObject *var19;
+    jsval var374;
+    JSObject *var11;
+    jsval var375;
+    JSBool var1;
+    var2 = NULL;
+    var3 = NULL;
+    var6 = 0;
+    var7 = JSVAL_NULL;
+    var8 = NULL;
+    var9 = NULL;
+    var10 = NULL;
+    var12 = NULL;
+    var14 = JS_FALSE;
+    var15 = JSVAL_NULL;
+    var16 = NULL;
+    var373 = JSVAL_NULL;
+    var20 = NULL;
+    var17 = JS_FALSE;
+    var18 = JSVAL_NULL;
+    var19 = NULL;
+    var374 = JSVAL_NULL;
+    var11 = NULL;
+    var375 = JSVAL_NULL;
+    var1 = JS_FALSE;
+    var2 = obj;
+    var6 = argc;
+    var3 = admFacInt();
+    var9 = JS_GetGlobalObject(cx);
+    var12 = "bool";
+    var14 = JS_GetProperty(cx, var9, var12, &var15);
+    if (JS_ValueToObject(cx, var15, &var16) != JS_TRUE) {
+        goto do_return;
+    }
+    var373 = OBJECT_TO_JSVAL(var16);
+    argv[argc+0] = var373;
+    var20 = "prototype";
+    var17 = JS_GetProperty(cx, var16, var20, &var18);
+    if (JS_ValueToObject(cx, var18, &var19) != JS_TRUE) {
+        goto do_return;
+    }
+    var374 = OBJECT_TO_JSVAL(var19);
+    argv[argc+1] = var374;
+    var10 = JS_GET_CLASS(cx, var19);
+    var11 = NULL;
+    var8 = JS_NewObject(cx, var10, var11, var9);
+    var375 = OBJECT_TO_JSVAL(var8);
+    argv[argc+2] = var375;
+    if (JS_SetPrivate(cx, var8, var3) != JS_TRUE) {
+        goto do_return;
+    }
+    var7 = OBJECT_TO_JSVAL(var8);
+    if (rval) {
+        *rval = var7;
+    }
+    var1 = JS_TRUE;
+    do_return:
+    return var1;
+}
+static JSBool
+jjjsTestFacFloat(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var22;
+    void *var23;
+    int var26;
+    jsval var27;
+    JSObject *var28;
+    JSObject *var29;
+    JSClass *var30;
+    char *var32;
+    JSBool var34;
+    jsval var35;
+    JSObject *var36;
+    jsval var376;
+    char *var40;
+    JSBool var37;
+    jsval var38;
+    JSObject *var39;
+    jsval var377;
+    JSObject *var31;
+    jsval var378;
+    JSBool var21;
+    var22 = NULL;
+    var23 = NULL;
+    var26 = 0;
+    var27 = JSVAL_NULL;
+    var28 = NULL;
+    var29 = NULL;
+    var30 = NULL;
+    var32 = NULL;
+    var34 = JS_FALSE;
+    var35 = JSVAL_NULL;
+    var36 = NULL;
+    var376 = JSVAL_NULL;
+    var40 = NULL;
+    var37 = JS_FALSE;
+    var38 = JSVAL_NULL;
+    var39 = NULL;
+    var377 = JSVAL_NULL;
+    var31 = NULL;
+    var378 = JSVAL_NULL;
+    var21 = JS_FALSE;
+    var22 = obj;
+    var26 = argc;
+    var23 = admFacFloat();
+    var29 = JS_GetGlobalObject(cx);
+    var32 = "bool";
+    var34 = JS_GetProperty(cx, var29, var32, &var35);
+    if (JS_ValueToObject(cx, var35, &var36) != JS_TRUE) {
+        goto do_return;
+    }
+    var376 = OBJECT_TO_JSVAL(var36);
+    argv[argc+0] = var376;
+    var40 = "prototype";
+    var37 = JS_GetProperty(cx, var36, var40, &var38);
+    if (JS_ValueToObject(cx, var38, &var39) != JS_TRUE) {
+        goto do_return;
+    }
+    var377 = OBJECT_TO_JSVAL(var39);
+    argv[argc+1] = var377;
+    var30 = JS_GET_CLASS(cx, var39);
+    var31 = NULL;
+    var28 = JS_NewObject(cx, var30, var31, var29);
+    var378 = OBJECT_TO_JSVAL(var28);
+    argv[argc+2] = var378;
+    if (JS_SetPrivate(cx, var28, var23) != JS_TRUE) {
+        goto do_return;
+    }
+    var27 = OBJECT_TO_JSVAL(var28);
+    if (rval) {
+        *rval = var27;
+    }
+    var21 = JS_TRUE;
+    do_return:
+    return var21;
+}
+static JSBool
+jjjsTestFacToggle(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var42;
+    void *var43;
+    int var46;
+    jsval var47;
+    JSObject *var48;
+    JSObject *var49;
+    JSClass *var50;
+    char *var52;
+    JSBool var54;
+    jsval var55;
+    JSObject *var56;
+    jsval var379;
+    char *var60;
+    JSBool var57;
+    jsval var58;
+    JSObject *var59;
+    jsval var380;
+    JSObject *var51;
+    jsval var381;
+    JSBool var41;
+    var42 = NULL;
+    var43 = NULL;
+    var46 = 0;
+    var47 = JSVAL_NULL;
+    var48 = NULL;
+    var49 = NULL;
+    var50 = NULL;
+    var52 = NULL;
+    var54 = JS_FALSE;
+    var55 = JSVAL_NULL;
+    var56 = NULL;
+    var379 = JSVAL_NULL;
+    var60 = NULL;
+    var57 = JS_FALSE;
+    var58 = JSVAL_NULL;
+    var59 = NULL;
+    var380 = JSVAL_NULL;
+    var51 = NULL;
+    var381 = JSVAL_NULL;
+    var41 = JS_FALSE;
+    var42 = obj;
+    var46 = argc;
+    var43 = admFacToggle();
+    var49 = JS_GetGlobalObject(cx);
+    var52 = "bool";
+    var54 = JS_GetProperty(cx, var49, var52, &var55);
+    if (JS_ValueToObject(cx, var55, &var56) != JS_TRUE) {
+        goto do_return;
+    }
+    var379 = OBJECT_TO_JSVAL(var56);
+    argv[argc+0] = var379;
+    var60 = "prototype";
+    var57 = JS_GetProperty(cx, var56, var60, &var58);
+    if (JS_ValueToObject(cx, var58, &var59) != JS_TRUE) {
+        goto do_return;
+    }
+    var380 = OBJECT_TO_JSVAL(var59);
+    argv[argc+1] = var380;
+    var50 = JS_GET_CLASS(cx, var59);
+    var51 = NULL;
+    var48 = JS_NewObject(cx, var50, var51, var49);
+    var381 = OBJECT_TO_JSVAL(var48);
+    argv[argc+2] = var381;
+    if (JS_SetPrivate(cx, var48, var43) != JS_TRUE) {
+        goto do_return;
+    }
+    var47 = OBJECT_TO_JSVAL(var48);
+    if (rval) {
+        *rval = var47;
+    }
+    var41 = JS_TRUE;
+    do_return:
+    return var41;
+}
+static JSBool
+jjjsTestFacMenu(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var62;
+    void *var63;
+    int var66;
+    jsval var67;
+    JSObject *var68;
+    JSObject *var69;
+    JSClass *var70;
+    char *var72;
+    JSBool var74;
+    jsval var75;
+    JSObject *var76;
+    jsval var382;
+    char *var80;
+    JSBool var77;
+    jsval var78;
+    JSObject *var79;
+    jsval var383;
+    JSObject *var71;
+    jsval var384;
+    JSBool var61;
+    var62 = NULL;
+    var63 = NULL;
+    var66 = 0;
+    var67 = JSVAL_NULL;
+    var68 = NULL;
+    var69 = NULL;
+    var70 = NULL;
+    var72 = NULL;
+    var74 = JS_FALSE;
+    var75 = JSVAL_NULL;
+    var76 = NULL;
+    var382 = JSVAL_NULL;
+    var80 = NULL;
+    var77 = JS_FALSE;
+    var78 = JSVAL_NULL;
+    var79 = NULL;
+    var383 = JSVAL_NULL;
+    var71 = NULL;
+    var384 = JSVAL_NULL;
+    var61 = JS_FALSE;
+    var62 = obj;
+    var66 = argc;
+    var63 = admFacMenu();
+    var69 = JS_GetGlobalObject(cx);
+    var72 = "bool";
+    var74 = JS_GetProperty(cx, var69, var72, &var75);
+    if (JS_ValueToObject(cx, var75, &var76) != JS_TRUE) {
+        goto do_return;
+    }
+    var382 = OBJECT_TO_JSVAL(var76);
+    argv[argc+0] = var382;
+    var80 = "prototype";
+    var77 = JS_GetProperty(cx, var76, var80, &var78);
+    if (JS_ValueToObject(cx, var78, &var79) != JS_TRUE) {
+        goto do_return;
+    }
+    var383 = OBJECT_TO_JSVAL(var79);
+    argv[argc+1] = var383;
+    var70 = JS_GET_CLASS(cx, var79);
+    var71 = NULL;
+    var68 = JS_NewObject(cx, var70, var71, var69);
+    var384 = OBJECT_TO_JSVAL(var68);
+    argv[argc+2] = var384;
+    if (JS_SetPrivate(cx, var68, var63) != JS_TRUE) {
+        goto do_return;
+    }
+    var67 = OBJECT_TO_JSVAL(var68);
+    if (rval) {
+        *rval = var67;
+    }
+    var61 = JS_TRUE;
+    do_return:
+    return var61;
+}
+static JSBool
+jjjsTestFacFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var82;
+    void *var83;
+    int var86;
+    jsval var87;
+    JSObject *var88;
+    JSObject *var89;
+    JSClass *var90;
+    char *var92;
+    JSBool var94;
+    jsval var95;
+    JSObject *var96;
+    jsval var385;
+    char *var100;
+    JSBool var97;
+    jsval var98;
+    JSObject *var99;
+    jsval var386;
+    JSObject *var91;
+    jsval var387;
+    JSBool var81;
+    var82 = NULL;
+    var83 = NULL;
+    var86 = 0;
+    var87 = JSVAL_NULL;
+    var88 = NULL;
+    var89 = NULL;
+    var90 = NULL;
+    var92 = NULL;
+    var94 = JS_FALSE;
+    var95 = JSVAL_NULL;
+    var96 = NULL;
+    var385 = JSVAL_NULL;
+    var100 = NULL;
+    var97 = JS_FALSE;
+    var98 = JSVAL_NULL;
+    var99 = NULL;
+    var386 = JSVAL_NULL;
+    var91 = NULL;
+    var387 = JSVAL_NULL;
+    var81 = JS_FALSE;
+    var82 = obj;
+    var86 = argc;
+    var83 = admFacFile();
+    var89 = JS_GetGlobalObject(cx);
+    var92 = "bool";
+    var94 = JS_GetProperty(cx, var89, var92, &var95);
+    if (JS_ValueToObject(cx, var95, &var96) != JS_TRUE) {
+        goto do_return;
+    }
+    var385 = OBJECT_TO_JSVAL(var96);
+    argv[argc+0] = var385;
+    var100 = "prototype";
+    var97 = JS_GetProperty(cx, var96, var100, &var98);
+    if (JS_ValueToObject(cx, var98, &var99) != JS_TRUE) {
+        goto do_return;
+    }
+    var386 = OBJECT_TO_JSVAL(var99);
+    argv[argc+1] = var386;
+    var90 = JS_GET_CLASS(cx, var99);
+    var91 = NULL;
+    var88 = JS_NewObject(cx, var90, var91, var89);
+    var387 = OBJECT_TO_JSVAL(var88);
+    argv[argc+2] = var387;
+    if (JS_SetPrivate(cx, var88, var83) != JS_TRUE) {
+        goto do_return;
+    }
+    var87 = OBJECT_TO_JSVAL(var88);
+    if (rval) {
+        *rval = var87;
+    }
+    var81 = JS_TRUE;
+    do_return:
+    return var81;
+}
+static JSBool
+jjjsTestFacBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var102;
+    void *var103;
+    int var106;
+    jsval var107;
+    JSObject *var108;
+    JSObject *var109;
+    JSClass *var110;
+    char *var112;
+    JSBool var114;
+    jsval var115;
+    JSObject *var116;
+    jsval var388;
+    char *var120;
+    JSBool var117;
+    jsval var118;
+    JSObject *var119;
+    jsval var389;
+    JSObject *var111;
+    jsval var390;
+    JSBool var101;
+    var102 = NULL;
+    var103 = NULL;
+    var106 = 0;
+    var107 = JSVAL_NULL;
+    var108 = NULL;
+    var109 = NULL;
+    var110 = NULL;
+    var112 = NULL;
+    var114 = JS_FALSE;
+    var115 = JSVAL_NULL;
+    var116 = NULL;
+    var388 = JSVAL_NULL;
+    var120 = NULL;
+    var117 = JS_FALSE;
+    var118 = JSVAL_NULL;
+    var119 = NULL;
+    var389 = JSVAL_NULL;
+    var111 = NULL;
+    var390 = JSVAL_NULL;
+    var101 = JS_FALSE;
+    var102 = obj;
+    var106 = argc;
+    var103 = admFacBitrate();
+    var109 = JS_GetGlobalObject(cx);
+    var112 = "bool";
+    var114 = JS_GetProperty(cx, var109, var112, &var115);
+    if (JS_ValueToObject(cx, var115, &var116) != JS_TRUE) {
+        goto do_return;
+    }
+    var388 = OBJECT_TO_JSVAL(var116);
+    argv[argc+0] = var388;
+    var120 = "prototype";
+    var117 = JS_GetProperty(cx, var116, var120, &var118);
+    if (JS_ValueToObject(cx, var118, &var119) != JS_TRUE) {
+        goto do_return;
+    }
+    var389 = OBJECT_TO_JSVAL(var119);
+    argv[argc+1] = var389;
+    var110 = JS_GET_CLASS(cx, var119);
+    var111 = NULL;
+    var108 = JS_NewObject(cx, var110, var111, var109);
+    var390 = OBJECT_TO_JSVAL(var108);
+    argv[argc+2] = var390;
+    if (JS_SetPrivate(cx, var108, var103) != JS_TRUE) {
+        goto do_return;
+    }
+    var107 = OBJECT_TO_JSVAL(var108);
+    if (rval) {
+        *rval = var107;
+    }
+    var101 = JS_TRUE;
+    do_return:
+    return var101;
+}
+static JSBool
+jjjsTestFacBar(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var122;
+    void *var123;
+    int var126;
+    jsval var127;
+    JSObject *var128;
+    JSObject *var129;
+    JSClass *var130;
+    char *var132;
+    JSBool var134;
+    jsval var135;
+    JSObject *var136;
+    jsval var391;
+    char *var140;
+    JSBool var137;
+    jsval var138;
+    JSObject *var139;
+    jsval var392;
+    JSObject *var131;
+    jsval var393;
+    JSBool var121;
+    var122 = NULL;
+    var123 = NULL;
+    var126 = 0;
+    var127 = JSVAL_NULL;
+    var128 = NULL;
+    var129 = NULL;
+    var130 = NULL;
+    var132 = NULL;
+    var134 = JS_FALSE;
+    var135 = JSVAL_NULL;
+    var136 = NULL;
+    var391 = JSVAL_NULL;
+    var140 = NULL;
+    var137 = JS_FALSE;
+    var138 = JSVAL_NULL;
+    var139 = NULL;
+    var392 = JSVAL_NULL;
+    var131 = NULL;
+    var393 = JSVAL_NULL;
+    var121 = JS_FALSE;
+    var122 = obj;
+    var126 = argc;
+    var123 = admFacBar();
+    var129 = JS_GetGlobalObject(cx);
+    var132 = "bool";
+    var134 = JS_GetProperty(cx, var129, var132, &var135);
+    if (JS_ValueToObject(cx, var135, &var136) != JS_TRUE) {
+        goto do_return;
+    }
+    var391 = OBJECT_TO_JSVAL(var136);
+    argv[argc+0] = var391;
+    var140 = "prototype";
+    var137 = JS_GetProperty(cx, var136, var140, &var138);
+    if (JS_ValueToObject(cx, var138, &var139) != JS_TRUE) {
+        goto do_return;
+    }
+    var392 = OBJECT_TO_JSVAL(var139);
+    argv[argc+1] = var392;
+    var130 = JS_GET_CLASS(cx, var139);
+    var131 = NULL;
+    var128 = JS_NewObject(cx, var130, var131, var129);
+    var393 = OBJECT_TO_JSVAL(var128);
+    argv[argc+2] = var393;
+    if (JS_SetPrivate(cx, var128, var123) != JS_TRUE) {
+        goto do_return;
+    }
+    var127 = OBJECT_TO_JSVAL(var128);
+    if (rval) {
+        *rval = var127;
+    }
+    var121 = JS_TRUE;
+    do_return:
+    return var121;
+}
+static JSBool
+jjjsTestFacRoText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var142;
+    void *var143;
+    int var146;
+    jsval var147;
+    JSObject *var148;
+    JSObject *var149;
+    JSClass *var150;
+    char *var152;
+    JSBool var154;
+    jsval var155;
+    JSObject *var156;
+    jsval var394;
+    char *var160;
+    JSBool var157;
+    jsval var158;
+    JSObject *var159;
+    jsval var395;
+    JSObject *var151;
+    jsval var396;
+    JSBool var141;
+    var142 = NULL;
+    var143 = NULL;
+    var146 = 0;
+    var147 = JSVAL_NULL;
+    var148 = NULL;
+    var149 = NULL;
+    var150 = NULL;
+    var152 = NULL;
+    var154 = JS_FALSE;
+    var155 = JSVAL_NULL;
+    var156 = NULL;
+    var394 = JSVAL_NULL;
+    var160 = NULL;
+    var157 = JS_FALSE;
+    var158 = JSVAL_NULL;
+    var159 = NULL;
+    var395 = JSVAL_NULL;
+    var151 = NULL;
+    var396 = JSVAL_NULL;
+    var141 = JS_FALSE;
+    var142 = obj;
+    var146 = argc;
+    var143 = admFacRoText();
+    var149 = JS_GetGlobalObject(cx);
+    var152 = "bool";
+    var154 = JS_GetProperty(cx, var149, var152, &var155);
+    if (JS_ValueToObject(cx, var155, &var156) != JS_TRUE) {
+        goto do_return;
+    }
+    var394 = OBJECT_TO_JSVAL(var156);
+    argv[argc+0] = var394;
+    var160 = "prototype";
+    var157 = JS_GetProperty(cx, var156, var160, &var158);
+    if (JS_ValueToObject(cx, var158, &var159) != JS_TRUE) {
+        goto do_return;
+    }
+    var395 = OBJECT_TO_JSVAL(var159);
+    argv[argc+1] = var395;
+    var150 = JS_GET_CLASS(cx, var159);
+    var151 = NULL;
+    var148 = JS_NewObject(cx, var150, var151, var149);
+    var396 = OBJECT_TO_JSVAL(var148);
+    argv[argc+2] = var396;
+    if (JS_SetPrivate(cx, var148, var143) != JS_TRUE) {
+        goto do_return;
+    }
+    var147 = OBJECT_TO_JSVAL(var148);
+    if (rval) {
+        *rval = var147;
+    }
+    var141 = JS_TRUE;
+    do_return:
+    return var141;
+}
+static JSBool
+jjjsTestFacText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var162;
+    void *var163;
+    int var166;
+    jsval var167;
+    JSObject *var168;
+    JSObject *var169;
+    JSClass *var170;
+    char *var172;
+    JSBool var174;
+    jsval var175;
+    JSObject *var176;
+    jsval var397;
+    char *var180;
+    JSBool var177;
+    jsval var178;
+    JSObject *var179;
+    jsval var398;
+    JSObject *var171;
+    jsval var399;
+    JSBool var161;
+    var162 = NULL;
+    var163 = NULL;
+    var166 = 0;
+    var167 = JSVAL_NULL;
+    var168 = NULL;
+    var169 = NULL;
+    var170 = NULL;
+    var172 = NULL;
+    var174 = JS_FALSE;
+    var175 = JSVAL_NULL;
+    var176 = NULL;
+    var397 = JSVAL_NULL;
+    var180 = NULL;
+    var177 = JS_FALSE;
+    var178 = JSVAL_NULL;
+    var179 = NULL;
+    var398 = JSVAL_NULL;
+    var171 = NULL;
+    var399 = JSVAL_NULL;
+    var161 = JS_FALSE;
+    var162 = obj;
+    var166 = argc;
+    var163 = admFacText();
+    var169 = JS_GetGlobalObject(cx);
+    var172 = "bool";
+    var174 = JS_GetProperty(cx, var169, var172, &var175);
+    if (JS_ValueToObject(cx, var175, &var176) != JS_TRUE) {
+        goto do_return;
+    }
+    var397 = OBJECT_TO_JSVAL(var176);
+    argv[argc+0] = var397;
+    var180 = "prototype";
+    var177 = JS_GetProperty(cx, var176, var180, &var178);
+    if (JS_ValueToObject(cx, var178, &var179) != JS_TRUE) {
+        goto do_return;
+    }
+    var398 = OBJECT_TO_JSVAL(var179);
+    argv[argc+1] = var398;
+    var170 = JS_GET_CLASS(cx, var179);
+    var171 = NULL;
+    var168 = JS_NewObject(cx, var170, var171, var169);
+    var399 = OBJECT_TO_JSVAL(var168);
+    argv[argc+2] = var399;
+    if (JS_SetPrivate(cx, var168, var163) != JS_TRUE) {
+        goto do_return;
+    }
+    var167 = OBJECT_TO_JSVAL(var168);
+    if (rval) {
+        *rval = var167;
+    }
+    var161 = JS_TRUE;
+    do_return:
+    return var161;
+}
+static JSBool
+jjjsTestFacTab(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var182;
+    void *var183;
+    int var186;
+    jsval var187;
+    JSObject *var188;
+    JSObject *var189;
+    JSClass *var190;
+    char *var192;
+    JSBool var194;
+    jsval var195;
+    JSObject *var196;
+    jsval var400;
+    char *var200;
+    JSBool var197;
+    jsval var198;
+    JSObject *var199;
+    jsval var401;
+    JSObject *var191;
+    jsval var402;
+    JSBool var181;
+    var182 = NULL;
+    var183 = NULL;
+    var186 = 0;
+    var187 = JSVAL_NULL;
+    var188 = NULL;
+    var189 = NULL;
+    var190 = NULL;
+    var192 = NULL;
+    var194 = JS_FALSE;
+    var195 = JSVAL_NULL;
+    var196 = NULL;
+    var400 = JSVAL_NULL;
+    var200 = NULL;
+    var197 = JS_FALSE;
+    var198 = JSVAL_NULL;
+    var199 = NULL;
+    var401 = JSVAL_NULL;
+    var191 = NULL;
+    var402 = JSVAL_NULL;
+    var181 = JS_FALSE;
+    var182 = obj;
+    var186 = argc;
+    var183 = admFacTab();
+    var189 = JS_GetGlobalObject(cx);
+    var192 = "bool";
+    var194 = JS_GetProperty(cx, var189, var192, &var195);
+    if (JS_ValueToObject(cx, var195, &var196) != JS_TRUE) {
+        goto do_return;
+    }
+    var400 = OBJECT_TO_JSVAL(var196);
+    argv[argc+0] = var400;
+    var200 = "prototype";
+    var197 = JS_GetProperty(cx, var196, var200, &var198);
+    if (JS_ValueToObject(cx, var198, &var199) != JS_TRUE) {
+        goto do_return;
+    }
+    var401 = OBJECT_TO_JSVAL(var199);
+    argv[argc+1] = var401;
+    var190 = JS_GET_CLASS(cx, var199);
+    var191 = NULL;
+    var188 = JS_NewObject(cx, var190, var191, var189);
+    var402 = OBJECT_TO_JSVAL(var188);
+    argv[argc+2] = var402;
+    if (JS_SetPrivate(cx, var188, var183) != JS_TRUE) {
+        goto do_return;
+    }
+    var187 = OBJECT_TO_JSVAL(var188);
+    if (rval) {
+        *rval = var187;
+    }
+    var181 = JS_TRUE;
+    do_return:
+    return var181;
+}
+static JSBool
+jjjsTestFrame(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var202;
+    void *var203;
+    int var206;
+    jsval var207;
+    JSObject *var208;
+    JSObject *var209;
+    JSClass *var210;
+    char *var212;
+    JSBool var214;
+    jsval var215;
+    JSObject *var216;
+    jsval var403;
+    char *var220;
+    JSBool var217;
+    jsval var218;
+    JSObject *var219;
+    jsval var404;
+    JSObject *var211;
+    jsval var405;
+    JSBool var201;
+    var202 = NULL;
+    var203 = NULL;
+    var206 = 0;
+    var207 = JSVAL_NULL;
+    var208 = NULL;
+    var209 = NULL;
+    var210 = NULL;
+    var212 = NULL;
+    var214 = JS_FALSE;
+    var215 = JSVAL_NULL;
+    var216 = NULL;
+    var403 = JSVAL_NULL;
+    var220 = NULL;
+    var217 = JS_FALSE;
+    var218 = JSVAL_NULL;
+    var219 = NULL;
+    var404 = JSVAL_NULL;
+    var211 = NULL;
+    var405 = JSVAL_NULL;
+    var201 = JS_FALSE;
+    var202 = obj;
+    var206 = argc;
+    var203 = admFacFrame();
+    var209 = JS_GetGlobalObject(cx);
+    var212 = "bool";
+    var214 = JS_GetProperty(cx, var209, var212, &var215);
+    if (JS_ValueToObject(cx, var215, &var216) != JS_TRUE) {
+        goto do_return;
+    }
+    var403 = OBJECT_TO_JSVAL(var216);
+    argv[argc+0] = var403;
+    var220 = "prototype";
+    var217 = JS_GetProperty(cx, var216, var220, &var218);
+    if (JS_ValueToObject(cx, var218, &var219) != JS_TRUE) {
+        goto do_return;
+    }
+    var404 = OBJECT_TO_JSVAL(var219);
+    argv[argc+1] = var404;
+    var210 = JS_GET_CLASS(cx, var219);
+    var211 = NULL;
+    var208 = JS_NewObject(cx, var210, var211, var209);
+    var405 = OBJECT_TO_JSVAL(var208);
+    argv[argc+2] = var405;
+    if (JS_SetPrivate(cx, var208, var203) != JS_TRUE) {
+        goto do_return;
+    }
+    var207 = OBJECT_TO_JSVAL(var208);
+    if (rval) {
+        *rval = var207;
+    }
+    var201 = JS_TRUE;
+    do_return:
+    return var201;
+}
+static JSBool
+jjjsTestHex(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var222;
+    void *var223;
+    int var226;
+    jsval var227;
+    JSObject *var228;
+    JSObject *var229;
+    JSClass *var230;
+    char *var232;
+    JSBool var234;
+    jsval var235;
+    JSObject *var236;
+    jsval var406;
+    char *var240;
+    JSBool var237;
+    jsval var238;
+    JSObject *var239;
+    jsval var407;
+    JSObject *var231;
+    jsval var408;
+    JSBool var221;
+    var222 = NULL;
+    var223 = NULL;
+    var226 = 0;
+    var227 = JSVAL_NULL;
+    var228 = NULL;
+    var229 = NULL;
+    var230 = NULL;
+    var232 = NULL;
+    var234 = JS_FALSE;
+    var235 = JSVAL_NULL;
+    var236 = NULL;
+    var406 = JSVAL_NULL;
+    var240 = NULL;
+    var237 = JS_FALSE;
+    var238 = JSVAL_NULL;
+    var239 = NULL;
+    var407 = JSVAL_NULL;
+    var231 = NULL;
+    var408 = JSVAL_NULL;
+    var221 = JS_FALSE;
+    var222 = obj;
+    var226 = argc;
+    var223 = admFacHex();
+    var229 = JS_GetGlobalObject(cx);
+    var232 = "bool";
+    var234 = JS_GetProperty(cx, var229, var232, &var235);
+    if (JS_ValueToObject(cx, var235, &var236) != JS_TRUE) {
+        goto do_return;
+    }
+    var406 = OBJECT_TO_JSVAL(var236);
+    argv[argc+0] = var406;
+    var240 = "prototype";
+    var237 = JS_GetProperty(cx, var236, var240, &var238);
+    if (JS_ValueToObject(cx, var238, &var239) != JS_TRUE) {
+        goto do_return;
+    }
+    var407 = OBJECT_TO_JSVAL(var239);
+    argv[argc+1] = var407;
+    var230 = JS_GET_CLASS(cx, var239);
+    var231 = NULL;
+    var228 = JS_NewObject(cx, var230, var231, var229);
+    var408 = OBJECT_TO_JSVAL(var228);
+    argv[argc+2] = var408;
+    if (JS_SetPrivate(cx, var228, var223) != JS_TRUE) {
+        goto do_return;
+    }
+    var227 = OBJECT_TO_JSVAL(var228);
+    if (rval) {
+        *rval = var227;
+    }
+    var221 = JS_TRUE;
+    do_return:
+    return var221;
+}
+static JSBool
+jjjsTestDirSel(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var242;
+    void *var243;
+    int var246;
+    jsval var247;
+    JSObject *var248;
+    JSObject *var249;
+    JSClass *var250;
+    char *var252;
+    JSBool var254;
+    jsval var255;
+    JSObject *var256;
+    jsval var409;
+    char *var260;
+    JSBool var257;
+    jsval var258;
+    JSObject *var259;
+    jsval var410;
+    JSObject *var251;
+    jsval var411;
+    JSBool var241;
+    var242 = NULL;
+    var243 = NULL;
+    var246 = 0;
+    var247 = JSVAL_NULL;
+    var248 = NULL;
+    var249 = NULL;
+    var250 = NULL;
+    var252 = NULL;
+    var254 = JS_FALSE;
+    var255 = JSVAL_NULL;
+    var256 = NULL;
+    var409 = JSVAL_NULL;
+    var260 = NULL;
+    var257 = JS_FALSE;
+    var258 = JSVAL_NULL;
+    var259 = NULL;
+    var410 = JSVAL_NULL;
+    var251 = NULL;
+    var411 = JSVAL_NULL;
+    var241 = JS_FALSE;
+    var242 = obj;
+    var246 = argc;
+    var243 = admFacDirSel();
+    var249 = JS_GetGlobalObject(cx);
+    var252 = "bool";
+    var254 = JS_GetProperty(cx, var249, var252, &var255);
+    if (JS_ValueToObject(cx, var255, &var256) != JS_TRUE) {
+        goto do_return;
+    }
+    var409 = OBJECT_TO_JSVAL(var256);
+    argv[argc+0] = var409;
+    var260 = "prototype";
+    var257 = JS_GetProperty(cx, var256, var260, &var258);
+    if (JS_ValueToObject(cx, var258, &var259) != JS_TRUE) {
+        goto do_return;
+    }
+    var410 = OBJECT_TO_JSVAL(var259);
+    argv[argc+1] = var410;
+    var250 = JS_GET_CLASS(cx, var259);
+    var251 = NULL;
+    var248 = JS_NewObject(cx, var250, var251, var249);
+    var411 = OBJECT_TO_JSVAL(var248);
+    argv[argc+2] = var411;
+    if (JS_SetPrivate(cx, var248, var243) != JS_TRUE) {
+        goto do_return;
+    }
+    var247 = OBJECT_TO_JSVAL(var248);
+    if (rval) {
+        *rval = var247;
+    }
+    var241 = JS_TRUE;
+    do_return:
+    return var241;
+}
+static JSBool
+jjjsTestButton(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var262;
+    void *var263;
+    int var266;
+    jsval var267;
+    JSObject *var268;
+    JSObject *var269;
+    JSClass *var270;
+    char *var272;
+    JSBool var274;
+    jsval var275;
+    JSObject *var276;
+    jsval var412;
+    char *var280;
+    JSBool var277;
+    jsval var278;
+    JSObject *var279;
+    jsval var413;
+    JSObject *var271;
+    jsval var414;
+    JSBool var261;
+    var262 = NULL;
+    var263 = NULL;
+    var266 = 0;
+    var267 = JSVAL_NULL;
+    var268 = NULL;
+    var269 = NULL;
+    var270 = NULL;
+    var272 = NULL;
+    var274 = JS_FALSE;
+    var275 = JSVAL_NULL;
+    var276 = NULL;
+    var412 = JSVAL_NULL;
+    var280 = NULL;
+    var277 = JS_FALSE;
+    var278 = JSVAL_NULL;
+    var279 = NULL;
+    var413 = JSVAL_NULL;
+    var271 = NULL;
+    var414 = JSVAL_NULL;
+    var261 = JS_FALSE;
+    var262 = obj;
+    var266 = argc;
+    var263 = admFacButton();
+    var269 = JS_GetGlobalObject(cx);
+    var272 = "bool";
+    var274 = JS_GetProperty(cx, var269, var272, &var275);
+    if (JS_ValueToObject(cx, var275, &var276) != JS_TRUE) {
+        goto do_return;
+    }
+    var412 = OBJECT_TO_JSVAL(var276);
+    argv[argc+0] = var412;
+    var280 = "prototype";
+    var277 = JS_GetProperty(cx, var276, var280, &var278);
+    if (JS_ValueToObject(cx, var278, &var279) != JS_TRUE) {
+        goto do_return;
+    }
+    var413 = OBJECT_TO_JSVAL(var279);
+    argv[argc+1] = var413;
+    var270 = JS_GET_CLASS(cx, var279);
+    var271 = NULL;
+    var268 = JS_NewObject(cx, var270, var271, var269);
+    var414 = OBJECT_TO_JSVAL(var268);
+    argv[argc+2] = var414;
+    if (JS_SetPrivate(cx, var268, var263) != JS_TRUE) {
+        goto do_return;
+    }
+    var267 = OBJECT_TO_JSVAL(var268);
+    if (rval) {
+        *rval = var267;
+    }
+    var261 = JS_TRUE;
+    do_return:
+    return var261;
+}
+static JSBool
+jjjsTestMatrix(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var282;
+    void *var283;
+    int var286;
+    jsval var287;
+    JSObject *var288;
+    JSObject *var289;
+    JSClass *var290;
+    char *var292;
+    JSBool var294;
+    jsval var295;
+    JSObject *var296;
+    jsval var415;
+    char *var300;
+    JSBool var297;
+    jsval var298;
+    JSObject *var299;
+    jsval var416;
+    JSObject *var291;
+    jsval var417;
+    JSBool var281;
+    var282 = NULL;
+    var283 = NULL;
+    var286 = 0;
+    var287 = JSVAL_NULL;
+    var288 = NULL;
+    var289 = NULL;
+    var290 = NULL;
+    var292 = NULL;
+    var294 = JS_FALSE;
+    var295 = JSVAL_NULL;
+    var296 = NULL;
+    var415 = JSVAL_NULL;
+    var300 = NULL;
+    var297 = JS_FALSE;
+    var298 = JSVAL_NULL;
+    var299 = NULL;
+    var416 = JSVAL_NULL;
+    var291 = NULL;
+    var417 = JSVAL_NULL;
+    var281 = JS_FALSE;
+    var282 = obj;
+    var286 = argc;
+    var283 = admFacMatrix();
+    var289 = JS_GetGlobalObject(cx);
+    var292 = "bool";
+    var294 = JS_GetProperty(cx, var289, var292, &var295);
+    if (JS_ValueToObject(cx, var295, &var296) != JS_TRUE) {
+        goto do_return;
+    }
+    var415 = OBJECT_TO_JSVAL(var296);
+    argv[argc+0] = var415;
+    var300 = "prototype";
+    var297 = JS_GetProperty(cx, var296, var300, &var298);
+    if (JS_ValueToObject(cx, var298, &var299) != JS_TRUE) {
+        goto do_return;
+    }
+    var416 = OBJECT_TO_JSVAL(var299);
+    argv[argc+1] = var416;
+    var290 = JS_GET_CLASS(cx, var299);
+    var291 = NULL;
+    var288 = JS_NewObject(cx, var290, var291, var289);
+    var417 = OBJECT_TO_JSVAL(var288);
+    argv[argc+2] = var417;
+    if (JS_SetPrivate(cx, var288, var283) != JS_TRUE) {
+        goto do_return;
+    }
+    var287 = OBJECT_TO_JSVAL(var288);
+    if (rval) {
+        *rval = var287;
+    }
+    var281 = JS_TRUE;
+    do_return:
+    return var281;
+}
+static JSBool
+jjjsTestNotch(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var302;
+    void *var303;
+    int var306;
+    jsval var307;
+    JSObject *var308;
+    JSObject *var309;
+    JSClass *var310;
+    char *var312;
+    JSBool var314;
+    jsval var315;
+    JSObject *var316;
+    jsval var418;
+    char *var320;
+    JSBool var317;
+    jsval var318;
+    JSObject *var319;
+    jsval var419;
+    JSObject *var311;
+    jsval var420;
+    JSBool var301;
+    var302 = NULL;
+    var303 = NULL;
+    var306 = 0;
+    var307 = JSVAL_NULL;
+    var308 = NULL;
+    var309 = NULL;
+    var310 = NULL;
+    var312 = NULL;
+    var314 = JS_FALSE;
+    var315 = JSVAL_NULL;
+    var316 = NULL;
+    var418 = JSVAL_NULL;
+    var320 = NULL;
+    var317 = JS_FALSE;
+    var318 = JSVAL_NULL;
+    var319 = NULL;
+    var419 = JSVAL_NULL;
+    var311 = NULL;
+    var420 = JSVAL_NULL;
+    var301 = JS_FALSE;
+    var302 = obj;
+    var306 = argc;
+    var303 = admFacNotch();
+    var309 = JS_GetGlobalObject(cx);
+    var312 = "bool";
+    var314 = JS_GetProperty(cx, var309, var312, &var315);
+    if (JS_ValueToObject(cx, var315, &var316) != JS_TRUE) {
+        goto do_return;
+    }
+    var418 = OBJECT_TO_JSVAL(var316);
+    argv[argc+0] = var418;
+    var320 = "prototype";
+    var317 = JS_GetProperty(cx, var316, var320, &var318);
+    if (JS_ValueToObject(cx, var318, &var319) != JS_TRUE) {
+        goto do_return;
+    }
+    var419 = OBJECT_TO_JSVAL(var319);
+    argv[argc+1] = var419;
+    var310 = JS_GET_CLASS(cx, var319);
+    var311 = NULL;
+    var308 = JS_NewObject(cx, var310, var311, var309);
+    var420 = OBJECT_TO_JSVAL(var308);
+    argv[argc+2] = var420;
+    if (JS_SetPrivate(cx, var308, var303) != JS_TRUE) {
+        goto do_return;
+    }
+    var307 = OBJECT_TO_JSVAL(var308);
+    if (rval) {
+        *rval = var307;
+    }
+    var301 = JS_TRUE;
+    do_return:
+    return var301;
+}
+static JSBool
+jjjsTestThreadCount(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var322;
+    void *var323;
+    int var326;
+    jsval var327;
+    JSObject *var328;
+    JSObject *var329;
+    JSClass *var330;
+    char *var332;
+    JSBool var334;
+    jsval var335;
+    JSObject *var336;
+    jsval var421;
+    char *var340;
+    JSBool var337;
+    jsval var338;
+    JSObject *var339;
+    jsval var422;
+    JSObject *var331;
+    jsval var423;
+    JSBool var321;
+    var322 = NULL;
+    var323 = NULL;
+    var326 = 0;
+    var327 = JSVAL_NULL;
+    var328 = NULL;
+    var329 = NULL;
+    var330 = NULL;
+    var332 = NULL;
+    var334 = JS_FALSE;
+    var335 = JSVAL_NULL;
+    var336 = NULL;
+    var421 = JSVAL_NULL;
+    var340 = NULL;
+    var337 = JS_FALSE;
+    var338 = JSVAL_NULL;
+    var339 = NULL;
+    var422 = JSVAL_NULL;
+    var331 = NULL;
+    var423 = JSVAL_NULL;
+    var321 = JS_FALSE;
+    var322 = obj;
+    var326 = argc;
+    var323 = admFacThreadCount();
+    var329 = JS_GetGlobalObject(cx);
+    var332 = "bool";
+    var334 = JS_GetProperty(cx, var329, var332, &var335);
+    if (JS_ValueToObject(cx, var335, &var336) != JS_TRUE) {
+        goto do_return;
+    }
+    var421 = OBJECT_TO_JSVAL(var336);
+    argv[argc+0] = var421;
+    var340 = "prototype";
+    var337 = JS_GetProperty(cx, var336, var340, &var338);
+    if (JS_ValueToObject(cx, var338, &var339) != JS_TRUE) {
+        goto do_return;
+    }
+    var422 = OBJECT_TO_JSVAL(var339);
+    argv[argc+1] = var422;
+    var330 = JS_GET_CLASS(cx, var339);
+    var331 = NULL;
+    var328 = JS_NewObject(cx, var330, var331, var329);
+    var423 = OBJECT_TO_JSVAL(var328);
+    argv[argc+2] = var423;
+    if (JS_SetPrivate(cx, var328, var323) != JS_TRUE) {
+        goto do_return;
+    }
+    var327 = OBJECT_TO_JSVAL(var328);
+    if (rval) {
+        *rval = var327;
+    }
+    var321 = JS_TRUE;
+    do_return:
+    return var321;
+}
+static JSBool
+jjjsTestSlider(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var342;
+    void *var343;
+    int var346;
+    jsval var347;
+    JSObject *var348;
+    JSObject *var349;
+    JSClass *var350;
+    char *var352;
+    JSBool var354;
+    jsval var355;
+    JSObject *var356;
+    jsval var424;
+    char *var360;
+    JSBool var357;
+    jsval var358;
+    JSObject *var359;
+    jsval var425;
+    JSObject *var351;
+    jsval var426;
+    JSBool var341;
+    var342 = NULL;
+    var343 = NULL;
+    var346 = 0;
+    var347 = JSVAL_NULL;
+    var348 = NULL;
+    var349 = NULL;
+    var350 = NULL;
+    var352 = NULL;
+    var354 = JS_FALSE;
+    var355 = JSVAL_NULL;
+    var356 = NULL;
+    var424 = JSVAL_NULL;
+    var360 = NULL;
+    var357 = JS_FALSE;
+    var358 = JSVAL_NULL;
+    var359 = NULL;
+    var425 = JSVAL_NULL;
+    var351 = NULL;
+    var426 = JSVAL_NULL;
+    var341 = JS_FALSE;
+    var342 = obj;
+    var346 = argc;
+    var343 = admFacSlider();
+    var349 = JS_GetGlobalObject(cx);
+    var352 = "bool";
+    var354 = JS_GetProperty(cx, var349, var352, &var355);
+    if (JS_ValueToObject(cx, var355, &var356) != JS_TRUE) {
+        goto do_return;
+    }
+    var424 = OBJECT_TO_JSVAL(var356);
+    argv[argc+0] = var424;
+    var360 = "prototype";
+    var357 = JS_GetProperty(cx, var356, var360, &var358);
+    if (JS_ValueToObject(cx, var358, &var359) != JS_TRUE) {
+        goto do_return;
+    }
+    var425 = OBJECT_TO_JSVAL(var359);
+    argv[argc+1] = var425;
+    var350 = JS_GET_CLASS(cx, var359);
+    var351 = NULL;
+    var348 = JS_NewObject(cx, var350, var351, var349);
+    var426 = OBJECT_TO_JSVAL(var348);
+    argv[argc+2] = var426;
+    if (JS_SetPrivate(cx, var348, var343) != JS_TRUE) {
+        goto do_return;
+    }
+    var347 = OBJECT_TO_JSVAL(var348);
+    if (rval) {
+        *rval = var347;
+    }
+    var341 = JS_TRUE;
+    do_return:
+    return var341;
+}
+static JSBool
+jjjsCrashTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var362;
+    int var366;
+    JSBool var361;
+    var362 = NULL;
+    var366 = 0;
+    var361 = JS_FALSE;
+    var362 = obj;
+    var366 = argc;
+    crashTest();
+    var361 = JS_TRUE;
+    return var361;
+}
+static JSBool
+jjjsAssertTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var368;
+    int var372;
+    JSBool var367;
+    var368 = NULL;
+    var372 = 0;
+    var367 = JS_FALSE;
+    var368 = obj;
+    var372 = argc;
+    assertTest();
+    var367 = JS_TRUE;
+    return var367;
+}
+static JSPropertySpec jj_static_ps[] = {
+    {NULL, 0, 0, NULL, NULL}
+};
+static JSPropertySpec jj_ps[] = {
+    {NULL, 0, 0, NULL, NULL}
+};
+static JSFunctionSpec jj_static_fs[] = {
+    JS_FS("jsTestFacInt", jjjsTestFacInt, 0, 0, 3),
+    JS_FS("jsTestFacFloat", jjjsTestFacFloat, 0, 0, 3),
+    JS_FS("jsTestFacToggle", jjjsTestFacToggle, 0, 0, 3),
+    JS_FS("jsTestFacMenu", jjjsTestFacMenu, 0, 0, 3),
+    JS_FS("jsTestFacFile", jjjsTestFacFile, 0, 0, 3),
+    JS_FS("jsTestFacBitrate", jjjsTestFacBitrate, 0, 0, 3),
+    JS_FS("jsTestFacBar", jjjsTestFacBar, 0, 0, 3),
+    JS_FS("jsTestFacRoText", jjjsTestFacRoText, 0, 0, 3),
+    JS_FS("jsTestFacText", jjjsTestFacText, 0, 0, 3),
+    JS_FS("jsTestFacTab", jjjsTestFacTab, 0, 0, 3),
+    JS_FS("jsTestFrame", jjjsTestFrame, 0, 0, 3),
+    JS_FS("jsTestHex", jjjsTestHex, 0, 0, 3),
+    JS_FS("jsTestDirSel", jjjsTestDirSel, 0, 0, 3),
+    JS_FS("jsTestButton", jjjsTestButton, 0, 0, 3),
+    JS_FS("jsTestMatrix", jjjsTestMatrix, 0, 0, 3),
+    JS_FS("jsTestNotch", jjjsTestNotch, 0, 0, 3),
+    JS_FS("jsTestThreadCount", jjjsTestThreadCount, 0, 0, 3),
+    JS_FS("jsTestSlider", jjjsTestSlider, 0, 0, 3),
+    JS_FS("jsCrashTest", jjjsCrashTest, 0, 0, 0),
+    JS_FS("jsAssertTest", jjjsAssertTest, 0, 0, 0),
+    JS_FS_END
+};
+static JSFunctionSpec jj_fs[] = {
+    JS_FS("jsTestFacInt", jjjsTestFacInt, 0, 0, 3),
+    JS_FS("jsTestFacFloat", jjjsTestFacFloat, 0, 0, 3),
+    JS_FS("jsTestFacToggle", jjjsTestFacToggle, 0, 0, 3),
+    JS_FS("jsTestFacMenu", jjjsTestFacMenu, 0, 0, 3),
+    JS_FS("jsTestFacFile", jjjsTestFacFile, 0, 0, 3),
+    JS_FS("jsTestFacBitrate", jjjsTestFacBitrate, 0, 0, 3),
+    JS_FS("jsTestFacBar", jjjsTestFacBar, 0, 0, 3),
+    JS_FS("jsTestFacRoText", jjjsTestFacRoText, 0, 0, 3),
+    JS_FS("jsTestFacText", jjjsTestFacText, 0, 0, 3),
+    JS_FS("jsTestFacTab", jjjsTestFacTab, 0, 0, 3),
+    JS_FS("jsTestFrame", jjjsTestFrame, 0, 0, 3),
+    JS_FS("jsTestHex", jjjsTestHex, 0, 0, 3),
+    JS_FS("jsTestDirSel", jjjsTestDirSel, 0, 0, 3),
+    JS_FS("jsTestButton", jjjsTestButton, 0, 0, 3),
+    JS_FS("jsTestMatrix", jjjsTestMatrix, 0, 0, 3),
+    JS_FS("jsTestNotch", jjjsTestNotch, 0, 0, 3),
+    JS_FS("jsTestThreadCount", jjjsTestThreadCount, 0, 0, 3),
+    JS_FS("jsTestSlider", jjjsTestSlider, 0, 0, 3),
+    JS_FS("jsCrashTest", jjjsCrashTest, 0, 0, 0),
+    JS_FS("jsAssertTest", jjjsAssertTest, 0, 0, 0),
+    JS_FS_END
+};

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,27 @@
+/*
+###############################################################
+       return C function     JS Function  params
+###############################################################
+*/
+function bool jsTestFacInt : admFacInt   (void  ) <static>;
+function bool jsTestFacFloat : admFacFloat   (void  ) <static>;
+function bool jsTestFacToggle : admFacToggle   (void  ) <static>;
+function bool jsTestFacMenu : admFacMenu   (void  ) <static>;
+function bool jsTestFacFile : admFacFile   (void  ) <static>;
+function bool jsTestFacBitrate : admFacBitrate   (void  ) <static>;
+function bool jsTestFacBar : admFacBar   (void  ) <static>;
+function bool jsTestFacRoText : admFacRoText   (void  ) <static>;
+function bool jsTestFacText : admFacText   (void  ) <static>;
+function bool jsTestFacTab :  admFacTab   (void  ) <static>;
+function bool jsTestFrame :   admFacFrame   (void  ) <static>;
+function bool jsTestHex :     admFacHex   (void  ) <static>;
+function bool jsTestDirSel :  admFacDirSel   (void  ) <static>;
+function bool jsTestButton :  admFacButton   (void  ) <static>;
+function bool jsTestMatrix :  admFacMatrix   (void  ) <static>;
+function bool jsTestNotch :   admFacNotch   (void  ) <static>;
+function bool jsTestThreadCount : admFacThreadCount   (void  ) <static>;
+function bool jsTestSlider :  admFacSlider   (void  ) <static>;
+function void jsCrashTest :   crashTest   (void  ) <static>;
+function void jsAssertTest :  assertTest   (void  ) <static>;
+
+

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsUtils.cpp	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsUtils.cpp	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,95 @@
+/**
+    \file ADM_jsUtils
+    \brief Simple param -> type utilities
+    \author mean fixounet at free.fr 2009
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_js.h"
+/**
+    \fn ADM_jsArg2Vars  
+    \brief convert jsvals to native type with checking
+*/
+bool ADM_jsArg2Vars(const char *caller, int argc, jsval *argv, int paramNumber, ADM_PARAM_LIST *param)
+{
+    if(paramNumber!=argc)
+    {
+        ADM_warning("[%s]Wrong number of parameters : %d vs %d\n",caller,argc,paramNumber);
+        return false;
+    }
+    for(int i=0;i<argc;i++)
+    {
+        jsval j=argv[i];
+        ADM_PARAM_LIST *p=param+i;
+        switch(p->type)
+        {
+            case ADM_JS_UINT64_T:
+            case ADM_JS_UINT32_T:
+            case ADM_JS_INT64_T:
+            case ADM_JS_INT32_T:
+                {
+                        if(!JSVAL_IS_NUMBER(j))
+                        {
+                            ADM_warning("[%s]Expected number and got %d\n",caller,j);
+                            return false;
+                        }
+                        // If it is an int...
+                        double v=0;
+                        if(JSVAL_IS_INT(j)) 
+                        {
+                            v=(int64_t)JSVAL_TO_INT(j);
+                            //ADM_warning("Value is int :%"LLD"\n",JSVAL_TO_INT(j));
+                        }
+                        if(JSVAL_IS_DOUBLE(j)) 
+                        {
+                            v=(int64_t)*(JSVAL_TO_DOUBLE(j));
+                            //ADM_warning("Value is float :%f\n",(float)*(JSVAL_TO_DOUBLE(j)));
+                        }
+                        // 
+                        //ADM_warning("%f\n",(float)v);
+                        // Affect
+                        switch(p->type)
+                        {
+                            case ADM_JS_UINT64_T: *(uint64_t *)p->value=(uint64_t)v;break;
+                            case ADM_JS_UINT32_T: *(uint32_t *)p->value=(uint32_t)v;break;
+                            case ADM_JS_INT64_T:  *(int64_t *)p->value=(int64_t)v;break;
+                            case ADM_JS_INT32_T:  *(int32_t *)p->value=(int32_t)v;break;
+                            default: ADM_assert(0);break;
+                        }
+                 }
+                        break;
+            case  ADM_JS_STRING:
+                {
+                        if(!JSVAL_IS_STRING(j))
+                        {
+                            ADM_warning("[%s]Expected string and got %d\n",caller,j);
+                            return false;
+                        }
+                        char *out=JS_GetStringBytes(JSVAL_TO_STRING(j));
+                        char **m=(char **)(p->value);
+                        *m=out;
+                }
+                        break;
+            case  ADM_JS_BOOL:
+                        if(!JSVAL_IS_BOOLEAN(j))
+                        {
+                            ADM_warning("[%s]Expected boolean and got %d\n",caller,j);
+                            return false;
+                        }
+                        *(bool *)p->value=JSVAL_TO_BOOLEAN(j);
+                        break;
+            default:
+                    ADM_assert(0);
+                    break;
+        }
+
+    }
+    return true;
+}
+// EOF

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,16 @@
+SET(ADM_script_SRCS
+        ADM_jsIf.cpp
+        ADM_jsDebug.cpp
+        ADM_jsUtils.cpp
+# Wrapper code
+        ADM_jsIf_js.c
+# Factory test
+        ADM_jsTestFactory.cpp  
+        ADM_jsTestFactory_js.c
+
+)
+
+ADD_LIBRARY(ADM_script26 STATIC ${ADM_script_SRCS})
+ADD_DEFINITIONS("-DJS_THREADSAFE -DXP_UNIX")
+include_directories(${CMAKE_CURRENT_SOURCE_DIR}/../include)
+include_directories(${AVIDEMUX_TOP_SOURCE_DIR}/avidemux_core/ADM_smjs)

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/idl.make
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/idl.make	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/idl.make	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1,6 @@
+idls:=$(shell ls *.idl)
+cs:=$(subst .idl,.c,$(idls))
+%.c : %.idl
+	echo processing $@
+	jsapigen < $< > $@ 
+all: $(cs)

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/updateIdl.sh
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/updateIdl.sh	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/updateIdl.sh	2009-12-09 06:41:29 UTC (rev 5627)
@@ -0,0 +1 @@
+jsapigen < ADM_jsIf_js.idl  > ADM_jsIf_js.c

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp	2009-12-09 06:41:29 UTC (rev 5627)
@@ -96,9 +96,9 @@
 extern int A_saveDVDPS(char *name);
 extern void A_saveWorkbench (const char *name);
 extern uint8_t A_rebuildKeyFrame (void);
-extern uint8_t A_setContainer(const char *cont);
+//extern uint8_t A_setContainer(const char *cont);
 uint8_t scriptAddVar(char *var,char *value);
-extern void ADM_dumpJSHooks(void);
+//extern void ADM_dumpJSHooks(void);
 extern uint8_t ADM_vob2vobsub(char *nameVob, char *nameVobSub, char *nameIfo);
 
 #ifdef __WIN32
@@ -138,7 +138,7 @@
 
 AUTOMATON reaction_table[]=
 {
-        {"js",                  0,"Dump the javascript functions",(one_arg_type)ADM_dumpJSHooks},
+        //{"js",                  0,"Dump the javascript functions",(one_arg_type)ADM_dumpJSHooks},
         {"nogui",               0,"Run in silent mode",		(one_arg_type)GUI_Quiet}   ,
 //        {"listfilters",		0,"list all filters by name",		(one_arg_type)filterListAll}   ,
         {"run",			1,"load and run a script",		(one_arg_type)A_parseECMAScript},
@@ -570,7 +570,8 @@
 	return 1;
 }
 int set_output_format(const char *str){
-  	return A_setContainer(str);
+  	//return A_setContainer(str);
+    return 0;
 }
 
 /*

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/CMakeLists.txt	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/CMakeLists.txt	2009-12-09 06:41:29 UTC (rev 5627)
@@ -15,6 +15,7 @@
 ADD_SUBDIRECTORY(ADM_render)
 ADD_SUBDIRECTORY(ADM_requant)
 ADD_SUBDIRECTORY(ADM_script)
+ADD_SUBDIRECTORY(ADM_script2)
 ADD_SUBDIRECTORY(ADM_toolkit)
 #ADD_SUBDIRECTORY(ADM_video)
 #ADD_SUBDIRECTORY(ADM_videoFilter)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2009-12-09 06:41:29 UTC (rev 5627)
@@ -103,8 +103,7 @@
 // Spidermonkey/Scripting stuff  
 bool SpidermonkeyInit(void);
 void SpidermonkeyDestroy(void);
-
-extern pthread_mutex_t g_pSpiderMonkeyMutex;
+bool ADM_jsExit(void);
 #if defined(ADM_DEBUG) && defined(FIND_LEAKS)
 extern const char* new_progname;
 extern int check_leaks();
@@ -314,11 +313,7 @@
 	printf("Cleaning up\n");
     delete video_body;	
     // wait for thread to finish executing
-    printf("Waiting for Spidermonkey to finish...\n");
-    pthread_mutex_lock(&g_pSpiderMonkeyMutex);
-    printf("Cleaning up Spidermonkey.\n");
-    SpidermonkeyDestroy();
-    pthread_mutex_unlock(&g_pSpiderMonkeyMutex);
+    ADM_jsExit();
 //    filterCleanUp();
 	ADM_lavDestroy();
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2009-12-09 06:41:29 UTC (rev 5627)
@@ -95,10 +95,11 @@
 #ADM_filter6 
 ADM_osSupport6 
 ADM_requant6 
-ADM_script6 
-ADM_toolkit6
+#ADM_script6 
+ADM_script26 
 ADM_videoEncoder6 
 ADM_internalVideoFilter6
+ADM_toolkit6
 
 #ADM_video6 
 #ADM_videoFilter6 

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2009-12-06 11:01:40 UTC (rev 5626)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2009-12-09 06:41:29 UTC (rev 5627)
@@ -85,6 +85,7 @@
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_guiQt4)
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UI_QT4)
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_shellQt4)
+TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_toolkit6)
 ###########################################
 # Construct Core libraries
 ###########################################



From mean at mail.berlios.de  Wed Dec  9 07:41:40 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 9 Dec 2009 07:41:40 +0100
Subject: [Avidemux-svn-commit] r5628 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui
Message-ID: <200912090641.nB96feFR023169@sheep.berlios.de>

Author: mean
Date: 2009-12-09 07:41:38 +0100 (Wed, 09 Dec 2009)
New Revision: 5628

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui
Log:
[Qt4] Cleanup ui, remove old menu entries

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui	2009-12-09 06:41:29 UTC (rev 5627)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui	2009-12-09 06:41:38 UTC (rev 5628)
@@ -1397,25 +1397,12 @@
     <addaction name="actionJump_to_Frame"/>
     <addaction name="actionJump_to_Time"/>
    </widget>
-   <widget class="QMenu" name="menuAuto">
-    <property name="title">
-     <string>A&amp;uto</string>
-    </property>
-    <addaction name="actionVCD"/>
-    <addaction name="actionSVCD"/>
-    <addaction name="actionDVD"/>
-    <addaction name="actionPSP"/>
-    <addaction name="actionPSP_H264"/>
-    <addaction name="actionFLV"/>
-    <addaction name="actionIPOD"/>
-   </widget>
    <addaction name="menuFile"/>
    <addaction name="menuEdit"/>
    <addaction name="menuView"/>
    <addaction name="menuVideo"/>
    <addaction name="menuAudio"/>
    <addaction name="menuTools"/>
-   <addaction name="menuAuto"/>
    <addaction name="menuGo"/>
    <addaction name="menuCustom"/>
    <addaction name="menuHelp"/>



From mean at mail.berlios.de  Wed Dec  9 07:41:42 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 9 Dec 2009 07:41:42 +0100
Subject: [Avidemux-svn-commit] r5629 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src
Message-ID: <200912090641.nB96fgDB023275@sheep.berlios.de>

Author: mean
Date: 2009-12-09 07:41:41 +0100 (Wed, 09 Dec 2009)
New Revision: 5629

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
Log:
[js] Fix init of spidermonkey

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-09 06:41:38 UTC (rev 5628)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-09 06:41:41 UTC (rev 5629)
@@ -28,11 +28,12 @@
 #endif
 JSVAR( pthread_mutex_t, g_pSpiderMonkeyMutex , PTHREAD_MUTEX_INITIALIZER);
 // expose our main javascript context to the entire program
-JSVAR( bool, g_bJSSuccess , 0);
-JSVAR( JSObject, *g_pObject,NULL);
-JSVAR( JSContext, *g_pCx,NULL);
-JSVAR( JSRuntime, *g_pRt,NULL);
+static bool g_bJSSuccess=false;
+static JSObject   *g_pObject=NULL;
+static JSContext  *g_pCx=NULL;
+static JSRuntime  *g_pRt=NULL;
 
+
 extern void  printJSError(JSContext *cx, const char *message, JSErrorReport *report);
 /**
     \fn parseECMAScript
@@ -156,6 +157,9 @@
 		}
 		else
 		{// begin context created
+            JSObject *global = JS_NewObject(cx, NULL, 0, 0);
+            g_pObject = global;
+            JS_InitStandardClasses(cx, global);
 
 			// register error handler
 			JS_SetErrorReporter(cx, printJSError);
@@ -229,4 +233,5 @@
     SpidermonkeyDestroy();
     pthread_mutex_unlock(&g_pSpiderMonkeyMutex);
     return true;
-}
\ No newline at end of file
+}
+//EOF



From mean at mail.berlios.de  Wed Dec  9 07:41:45 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 9 Dec 2009 07:41:45 +0100
Subject: [Avidemux-svn-commit] r5630 - in
	branches/avidemux_2.6_branch_mean/avidemux/common: .
	ADM_script2/include ADM_script2/src
Message-ID: <200912090641.nB96fjbk023338@sheep.berlios.de>

Author: mean
Date: 2009-12-09 07:41:44 +0100 (Wed, 09 Dec 2009)
New Revision: 5630

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsIf.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
Log:
[JS] Cleanup js if

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsIf.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsIf.h	2009-12-09 06:41:41 UTC (rev 5629)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsIf.h	2009-12-09 06:41:44 UTC (rev 5630)
@@ -48,4 +48,17 @@
 
 */
 bool jsLog(JS_LOG_TYPE type, const char *fmt,...);
+
+/**
+    \fn SpidermonkeyInit
+*/
+bool SpidermonkeyInit(void);
+/**
+    \fn SpidermonkeyDestroy
+*/
+void SpidermonkeyDestroy(void);
+/**
+    \fn SpidermonkeyExit
+*/
+bool SpidermonkeyExit(void);
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-09 06:41:41 UTC (rev 5629)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-09 06:41:44 UTC (rev 5630)
@@ -223,9 +223,9 @@
 	printf("[ECMA] success : %d\n", g_bJSSuccess);
 }// end JS_setSuccess
 /**
-    \fn ADM_jsExit
+    \fn SpidermonkeyExit
 */
-bool ADM_jsExit(void)
+bool SpidermonkeyExit(void)
 {
     ADM_info("Waiting for Spidermonkey to finish...\n");
     pthread_mutex_lock(&g_pSpiderMonkeyMutex);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2009-12-09 06:41:41 UTC (rev 5629)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2009-12-09 06:41:44 UTC (rev 5630)
@@ -55,7 +55,7 @@
 #include "ADM_render/GUI_sdlRender.h"
 #endif
 
-
+#include "ADM_script2/include/ADM_jsIf.h"
 void onexit( void );
 //extern void automation(int argc, char **argv);
 
@@ -101,9 +101,6 @@
 extern int UI_RunApp(void);
 
 // Spidermonkey/Scripting stuff  
-bool SpidermonkeyInit(void);
-void SpidermonkeyDestroy(void);
-bool ADM_jsExit(void);
 #if defined(ADM_DEBUG) && defined(FIND_LEAKS)
 extern const char* new_progname;
 extern int check_leaks();
@@ -313,7 +310,7 @@
 	printf("Cleaning up\n");
     delete video_body;	
     // wait for thread to finish executing
-    ADM_jsExit();
+    SpidermonkeyExit();
 //    filterCleanUp();
 	ADM_lavDestroy();
 



From mean at mail.berlios.de  Wed Dec  9 07:41:52 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 9 Dec 2009 07:41:52 +0100
Subject: [Avidemux-svn-commit] r5631 - in
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2:
	include src
Message-ID: <200912090641.nB96fqdD023434@sheep.berlios.de>

Author: mean
Date: 2009-12-09 07:41:51 +0100 (Wed, 09 Dec 2009)
New Revision: 5631

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsDebug.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl
Log:
[Js] Begin hooking our functions

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsDebug.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsDebug.h	2009-12-09 06:41:44 UTC (rev 5630)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsDebug.h	2009-12-09 06:41:51 UTC (rev 5631)
@@ -20,6 +20,7 @@
 {
 void jsPopupError(const char *s);
 void jsPopupInfo(const char *s);
+void jsPrint(const char *s);
 };
 
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2009-12-09 06:41:44 UTC (rev 5630)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2009-12-09 06:41:51 UTC (rev 5631)
@@ -15,14 +15,10 @@
  ***************************************************************************/
 #include "ADM_js.h"
 #include "ADM_editor/ADM_edit.hxx"
+#include "ADM_jsDebug.h"
 /**/
 /**/
 
-extern JSFunctionSpec *ADM_JsAudioGetFunctions(void);
-extern JSFunctionSpec *ADM_JsVideoGetFunctions(void);
-extern JSFunctionSpec *ADM_JsClassGetFunctions(void);
-extern JSFunctionSpec *ADM_JsDebugGetFunctions(void);
-extern JSFunctionSpec *ADM_JsFunctionGetFunctions(void);
 
 extern ADM_Composer *video_body;
 void ADM_dumpJSHooks(void);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-09 06:41:44 UTC (rev 5630)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-09 06:41:51 UTC (rev 5631)
@@ -32,6 +32,14 @@
 static JSObject   *g_pObject=NULL;
 static JSContext  *g_pCx=NULL;
 static JSRuntime  *g_pRt=NULL;
+static JSClass global_class = {
+   
+"Avidemux", JSCLASS_HAS_PRIVATE,
+        JS_PropertyStub, JS_PropertyStub,
+        JS_PropertyStub, JS_PropertyStub,
+        JS_EnumerateStub, JS_ResolveStub,
+        JS_ConvertStub, JS_FinalizeStub
+};
 
 
 extern void  printJSError(JSContext *cx, const char *message, JSErrorReport *report);
@@ -44,15 +52,15 @@
 	jsval rval;
 	uintN lineno = 0;
 	g_bJSSuccess = 0;
-	printf("Spidermonkey compiling \"%s\"...",name);
+	ADM_info("Spidermonkey compiling \"%s\"...",name);
 	JSScript *pJSScript = JS_CompileFile(g_pCx, g_pObject, name);
-	printf("Done.\n");
+	ADM_info("Done.\n");
 	if(pJSScript != NULL)
 	{// begin execute external file
 		printf("Spidermonkey executing \"%s\"...",name);
 		JSBool ok = JS_ExecuteScript(g_pCx, g_pObject, pJSScript, &rval);
 		JS_DestroyScript(g_pCx,pJSScript);
-		printf("Done.\n");
+		ADM_info("Done.\n");
 	}// end execute external file
         // Run garbage collector now, it is safe
     JS_GC(g_pCx);
@@ -129,7 +137,22 @@
     jsLogger=NULL;
     return true;
 }
+/**
+    \fn jsRegisterAvidemux
+*/
+extern "C" JSFunctionSpec  *jsGetIfFunctions(void);
+static bool jsRegisterAvidemux(JSContext *cx,JSObject *obj)
+{
+    
 
+    JSFunctionSpec *ifFunc=jsGetIfFunctions();
+    if (JS_DefineFunctions(cx, obj, ifFunc) != JS_TRUE) 
+    {
+                    ADM_error("Cannot register jsIf functions\n");
+    }
+	ADM_warning("JS_DefineFunctions: Unable to define functions\n");
+	return true;
+}
 /**
     \fn SpidermonkeyInit
 */
@@ -148,22 +171,23 @@
 	}
 	else
 	{// begin runtime created
-		JSContext *cx = JS_NewContext(rt, 8192);
-		g_pCx = cx;
-		if ( cx == NULL )
+		g_pCx = JS_NewContext(rt, 8192);
+		if ( g_pCx == NULL )
 		{
 			// Do some error reporting
 			printf("Spidermonkey failed to initialize context!\n");
 		}
 		else
 		{// begin context created
-            JSObject *global = JS_NewObject(cx, NULL, 0, 0);
-            g_pObject = global;
-            JS_InitStandardClasses(cx, global);
-
+            g_pObject = JS_NewObject(g_pCx, &global_class, 0, 0);
+            
+            if(JS_TRUE!=JS_InitStandardClasses(g_pCx, g_pObject))
+                ADM_error("Cannot inizialize standard classes\n");
 			// register error handler
-			JS_SetErrorReporter(cx, printJSError);
-            //JS_AvidemuxFunction(cx,global);
+			JS_SetErrorReporter(g_pCx, printJSError);
+                
+            //register our functions
+            jsRegisterAvidemux(g_pCx,g_pObject);
             
 			return true;
 		}// end context created
@@ -181,7 +205,9 @@
 	JS_DestroyContext(g_pCx);
 	JS_DestroyRuntime(g_pRt);
 }// end SpidermonkeyDestroy
-
+/**
+    \fn StartThreadSpidermonkey
+*/
 void *StartThreadSpidermonkey(void *pData)
 {// begin StartThreadSpidermonkey
         pthread_mutex_lock(&g_pSpiderMonkeyMutex);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c	2009-12-09 06:41:44 UTC (rev 5630)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c	2009-12-09 06:41:51 UTC (rev 5631)
@@ -31,7 +31,7 @@
 #define JS_FS_END {NULL, NULL, 0, 0, 0}
 #endif
 static JSBool
-jjjsPopupError(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmPopupError(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var2;
     char *var7;
@@ -90,7 +90,7 @@
         var7[var11] = '\0';
     }
     }
-    admPopupError(var7);
+    jsPopupError(var7);
     var1 = JS_TRUE;
     do_return:
     if (var14) {
@@ -101,7 +101,7 @@
     return var1;
 }
 static JSBool
-jjjspPopupInfo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmpPopupInfo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var16;
     char *var21;
@@ -160,7 +160,7 @@
         var21[var25] = '\0';
     }
     }
-    admPopupInfo(var21);
+    jsPopupInfo(var21);
     var15 = JS_TRUE;
     do_return:
     if (var28) {
@@ -171,7 +171,7 @@
     return var15;
 }
 static JSBool
-jjjsPrint(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmPrint(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var30;
     char *var35;
@@ -230,7 +230,7 @@
         var35[var39] = '\0';
     }
     }
-    admPrint(var35);
+    jsPrint(var35);
     var29 = JS_TRUE;
     do_return:
     if (var42) {
@@ -247,14 +247,21 @@
     {NULL, 0, 0, NULL, NULL}
 };
 static JSFunctionSpec jj_static_fs[] = {
-    JS_FS("jsPopupError", jjjsPopupError, 1, 0, 2),
-    JS_FS("jspPopupInfo", jjjspPopupInfo, 1, 0, 2),
-    JS_FS("jsPrint", jjjsPrint, 1, 0, 2),
+    JS_FS("admPopupError", jjadmPopupError, 1, 0, 2),
+    JS_FS("admpPopupInfo", jjadmpPopupInfo, 1, 0, 2),
+    JS_FS("admPrint", jjadmPrint, 1, 0, 2),
     JS_FS_END
 };
 static JSFunctionSpec jj_fs[] = {
-    JS_FS("jsPopupError", jjjsPopupError, 1, 0, 2),
-    JS_FS("jspPopupInfo", jjjspPopupInfo, 1, 0, 2),
-    JS_FS("jsPrint", jjjsPrint, 1, 0, 2),
+    JS_FS("admPopupError", jjadmPopupError, 1, 0, 2),
+    JS_FS("admpPopupInfo", jjadmpPopupInfo, 1, 0, 2),
+    JS_FS("admPrint", jjadmPrint, 1, 0, 2),
     JS_FS_END
 };
+
+JSFunctionSpec  *jsGetIfFunctions(void)
+{
+        return jj_static_fs;
+}
+
+

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl	2009-12-09 06:41:44 UTC (rev 5630)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl	2009-12-09 06:41:51 UTC (rev 5631)
@@ -1,10 +1,17 @@
 /*
 ###############################################################
-       return C function     JS Function  params
+       return JS function     CM Function  params
 ###############################################################
 */
-function void jsPopupError : admPopupError   (cstring  ) <static>;
-function void jspPopupInfo : admPopupInfo    (cstring  ) <static>;
-function void jsPrint      : admPrint        (cstring  ) <static>;
+function void admPopupError : jsPopupError   (cstring  ) <static>;
+function void admpPopupInfo : jsPopupInfo    (cstring  ) <static>;
+function void admPrint      : jsPrint        (cstring  ) <static>;
+/*function void print         : jsPrint        (cstring  ) <static>;*/
 
+%<
+JSFunctionSpec  *jsGetIfFunctions(void)
+{
+        return jj_static_fs;
+}
 
+%>



From mean at mail.berlios.de  Wed Dec  9 20:12:50 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 9 Dec 2009 20:12:50 +0100
Subject: [Avidemux-svn-commit] r5633 - in
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2:
	include src
Message-ID: <200912091912.nB9JCoi9006233@sheep.berlios.de>

Author: mean
Date: 2009-12-09 20:12:50 +0100 (Wed, 09 Dec 2009)
New Revision: 5633

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsTestFactory.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsDebug.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl
Log:
[js] Hook more functions through jsapigen, it crashes if the function returns something at the moment

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsDebug.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsDebug.h	2009-12-09 19:12:33 UTC (rev 5632)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsDebug.h	2009-12-09 19:12:50 UTC (rev 5633)
@@ -21,6 +21,8 @@
 void jsPopupError(const char *s);
 void jsPopupInfo(const char *s);
 void jsPrint(const char *s);
+void jsPrint2(const char *s);
+void jsHelp(const char *s);
 };
 
 

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsTestFactory.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsTestFactory.h	2009-12-09 19:12:33 UTC (rev 5632)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsTestFactory.h	2009-12-09 19:12:50 UTC (rev 5633)
@@ -0,0 +1,45 @@
+/**
+    \file ADM_jsTestFactory.h
+    \brief  Simple js hook to test factory
+    \author mean (c) 2009 fixounet at free.fr
+
+
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef ADMJS_FACTORY_H
+#define ADMJS_FACTORY_H
+extern "C"
+{
+bool jsTestCrash(void);
+bool jsTestAssert(void);
+bool jsTestFacNotch(void);
+bool jsTestFacThreadCount(void);
+bool jsTestFacMatrix(void);
+bool jsTestFacMatrix(void);
+bool jsTestFacHex(void);
+bool jsTestFacFrame(void);
+bool jsTestFacTab(void);
+bool jsTestFacText(void);
+bool jsTestFacRoText(void);
+bool jsTestFacSlider(void);
+bool jsTestFacButton(void);
+bool jsTestFacBar(void);
+bool jsTestFacBitrate(void);
+bool jsTestFacDirSel(void);
+bool jsTestFacFile(void);
+bool jsTestFacMenu(void);
+bool jsTestFacToggle(void);
+bool jsTestFacFloat(void);
+bool jsTestFacInt(void);
+};
+
+
+#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2009-12-09 19:12:33 UTC (rev 5632)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2009-12-09 19:12:50 UTC (rev 5633)
@@ -76,6 +76,10 @@
 {// begin print
         jsLog(JS_LOG_NORMAL,"%s",s);
 }// end print
+void jsPrint2(const char *s)
+{// begin print
+        jsLog(JS_LOG_NORMAL,"%s",s);
+}// end print
 
 
 static void dumpFunc(JSFunctionSpec *f)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-09 19:12:33 UTC (rev 5632)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-09 19:12:50 UTC (rev 5633)
@@ -32,6 +32,7 @@
 static JSObject   *g_pObject=NULL;
 static JSContext  *g_pCx=NULL;
 static JSRuntime  *g_pRt=NULL;
+/*
 static JSClass global_class = {
    
 "Avidemux", JSCLASS_HAS_PRIVATE,
@@ -40,8 +41,14 @@
         JS_EnumerateStub, JS_ResolveStub,
         JS_ConvertStub, JS_FinalizeStub
 };
+*/
+   static JSClass global_class = {
+            "global", JSCLASS_GLOBAL_FLAGS,
+            JS_PropertyStub, JS_PropertyStub, JS_PropertyStub, JS_PropertyStub,
+            JS_EnumerateStub, JS_ResolveStub, JS_ConvertStub, JS_FinalizeStub,
+            JSCLASS_NO_OPTIONAL_MEMBERS
+            };
 
-
 extern void  printJSError(JSContext *cx, const char *message, JSErrorReport *report);
 /**
     \fn parseECMAScript
@@ -141,18 +148,42 @@
     \fn jsRegisterAvidemux
 */
 extern "C" JSFunctionSpec  *jsGetIfFunctions(void);
-static bool jsRegisterAvidemux(JSContext *cx,JSObject *obj)
+extern "C" JSFunctionSpec  *jsGetTestFunctions(void);
+static bool registerOne(const char *name,JSFunctionSpec *s,JSContext *cx,JSObject *obj)
 {
-    
-
-    JSFunctionSpec *ifFunc=jsGetIfFunctions();
-    if (JS_DefineFunctions(cx, obj, ifFunc) != JS_TRUE) 
+    if (JS_DefineFunctions(cx, obj, s) != JS_TRUE) 
     {
-                    ADM_error("Cannot register jsIf functions\n");
+            ADM_error("Cannot register %s functions\n",name);
+            return false;
     }
-	ADM_warning("JS_DefineFunctions: Unable to define functions\n");
-	return true;
+    ADM_info("Registered %s functions\n",name);
+    return true;
 }
+static void  dump(JSFunctionSpec *f)
+{
+    while(f->name)
+    {
+        jsLog(JS_LOG_NORMAL,"    %s",f->name);
+        f++;
+    }
+}
+extern "C" 
+{
+void jsHelp(const char *s)
+{
+    if(!s) goto none;
+    if(!strcasecmp(s,"debug")) return dump(jsGetIfFunctions());
+    if(!strcasecmp(s,"test")) return dump(jsGetTestFunctions());
+none:
+        jsLog(JS_LOG_NORMAL,"please use help(\"debug\") or help(\"test\"");
+}
+}
+static bool jsRegisterAvidemux(JSContext *cx,JSObject *obj)
+{
+        registerOne("If",   jsGetIfFunctions(),    cx,obj);
+        registerOne("Test", jsGetTestFunctions(),  cx,obj);
+        return true;
+}
 /**
     \fn SpidermonkeyInit
 */
@@ -164,35 +195,38 @@
 	g_pRt = NULL;
 	JSRuntime *rt = JS_NewRuntime(1000000L);
 	g_pRt = rt;
-	if ( rt == NULL )
+	if ( !rt  )
 	{
 		// Do some error reporting
-		printf("Spidermonkey failed to initialize runtime!\n");
+		ADM_error("Spidermonkey failed to initialize runtime!\n");
+        return false;
 	}
-	else
-	{// begin runtime created
-		g_pCx = JS_NewContext(rt, 8192);
-		if ( g_pCx == NULL )
-		{
-			// Do some error reporting
-			printf("Spidermonkey failed to initialize context!\n");
-		}
-		else
-		{// begin context created
-            g_pObject = JS_NewObject(g_pCx, &global_class, 0, 0);
-            
-            if(JS_TRUE!=JS_InitStandardClasses(g_pCx, g_pObject))
-                ADM_error("Cannot inizialize standard classes\n");
-			// register error handler
-			JS_SetErrorReporter(g_pCx, printJSError);
-                
-            //register our functions
-            jsRegisterAvidemux(g_pCx,g_pObject);
-            
-			return true;
-		}// end context created
-	}// end runtime created
-	return false;
+	
+// begin runtime created
+    g_pCx = JS_NewContext(rt, 8192);
+    if ( !g_pCx  )
+    {
+        // Do some error reporting
+        ADM_error("Spidermonkey failed to initialize context!\n");
+        return false;
+    }
+   
+   // begin context created
+    g_pObject = JS_NewObject(g_pCx, &global_class, 0, 0);
+    
+    if(JS_TRUE!=JS_InitStandardClasses(g_pCx, g_pObject))
+    {
+        ADM_error("Cannot initialize standard classes\n");
+        return false;
+    }
+    // register error handler
+    JS_SetErrorReporter(g_pCx, printJSError);
+        
+    //register our functions
+    jsRegisterAvidemux(g_pCx,g_pObject);
+    ADM_info("Spidermonkey initialized\n");
+    return true;
+
 }// end SpidermonkeyInit
 /**
     \fn SpidermonkeyDestroy

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c	2009-12-09 19:12:33 UTC (rev 5632)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c	2009-12-09 19:12:50 UTC (rev 5633)
@@ -39,12 +39,12 @@
     int var8;
     jsval var9;
     JSString *var10;
-    jsval var43;
+    jsval var71;
     size_t var11;
     size_t var12;
     int var14;
     jschar *var13;
-    jsval var44;
+    jsval var72;
     JSBool var1;
     var2 = NULL;
     var7 = NULL;
@@ -52,12 +52,12 @@
     var8 = 0;
     var9 = JSVAL_NULL;
     var10 = NULL;
-    var43 = JSVAL_NULL;
+    var71 = JSVAL_NULL;
     var11 = 0;
     var12 = 0;
     var14 = 0;
     var13 = NULL;
-    var44 = JSVAL_NULL;
+    var72 = JSVAL_NULL;
     var1 = JS_FALSE;
     var2 = obj;
     var6 = argc;
@@ -69,8 +69,8 @@
     if (!var10) {
         goto do_return;
     }
-    var43 = STRING_TO_JSVAL(var10);
-    argv[argc+0] = var43;
+    var71 = STRING_TO_JSVAL(var10);
+    argv[argc+0] = var71;
     var11 = JS_GetStringLength(var10);
     var12 = 1;
     var12 += var11;
@@ -80,8 +80,8 @@
     }
     var14 = 1;
     var13 = JS_GetStringChars(var10);
-    var44 = STRING_TO_JSVAL(var10);
-    argv[argc+1] = var44;
+    var72 = STRING_TO_JSVAL(var10);
+    argv[argc+1] = var72;
     {
         size_t i;
         for (i = 0; i < var11; ++i) {
@@ -109,12 +109,12 @@
     int var22;
     jsval var23;
     JSString *var24;
-    jsval var45;
+    jsval var73;
     size_t var25;
     size_t var26;
     int var28;
     jschar *var27;
-    jsval var46;
+    jsval var74;
     JSBool var15;
     var16 = NULL;
     var21 = NULL;
@@ -122,12 +122,12 @@
     var22 = 0;
     var23 = JSVAL_NULL;
     var24 = NULL;
-    var45 = JSVAL_NULL;
+    var73 = JSVAL_NULL;
     var25 = 0;
     var26 = 0;
     var28 = 0;
     var27 = NULL;
-    var46 = JSVAL_NULL;
+    var74 = JSVAL_NULL;
     var15 = JS_FALSE;
     var16 = obj;
     var20 = argc;
@@ -139,8 +139,8 @@
     if (!var24) {
         goto do_return;
     }
-    var45 = STRING_TO_JSVAL(var24);
-    argv[argc+0] = var45;
+    var73 = STRING_TO_JSVAL(var24);
+    argv[argc+0] = var73;
     var25 = JS_GetStringLength(var24);
     var26 = 1;
     var26 += var25;
@@ -150,8 +150,8 @@
     }
     var28 = 1;
     var27 = JS_GetStringChars(var24);
-    var46 = STRING_TO_JSVAL(var24);
-    argv[argc+1] = var46;
+    var74 = STRING_TO_JSVAL(var24);
+    argv[argc+1] = var74;
     {
         size_t i;
         for (i = 0; i < var25; ++i) {
@@ -179,12 +179,12 @@
     int var36;
     jsval var37;
     JSString *var38;
-    jsval var47;
+    jsval var75;
     size_t var39;
     size_t var40;
     int var42;
     jschar *var41;
-    jsval var48;
+    jsval var76;
     JSBool var29;
     var30 = NULL;
     var35 = NULL;
@@ -192,12 +192,12 @@
     var36 = 0;
     var37 = JSVAL_NULL;
     var38 = NULL;
-    var47 = JSVAL_NULL;
+    var75 = JSVAL_NULL;
     var39 = 0;
     var40 = 0;
     var42 = 0;
     var41 = NULL;
-    var48 = JSVAL_NULL;
+    var76 = JSVAL_NULL;
     var29 = JS_FALSE;
     var30 = obj;
     var34 = argc;
@@ -209,8 +209,8 @@
     if (!var38) {
         goto do_return;
     }
-    var47 = STRING_TO_JSVAL(var38);
-    argv[argc+0] = var47;
+    var75 = STRING_TO_JSVAL(var38);
+    argv[argc+0] = var75;
     var39 = JS_GetStringLength(var38);
     var40 = 1;
     var40 += var39;
@@ -220,8 +220,8 @@
     }
     var42 = 1;
     var41 = JS_GetStringChars(var38);
-    var48 = STRING_TO_JSVAL(var38);
-    argv[argc+1] = var48;
+    var76 = STRING_TO_JSVAL(var38);
+    argv[argc+1] = var76;
     {
         size_t i;
         for (i = 0; i < var39; ++i) {
@@ -240,6 +240,146 @@
     }
     return var29;
 }
+static JSBool
+jjprint(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var44;
+    char *var49;
+    int var48;
+    int var50;
+    jsval var51;
+    JSString *var52;
+    jsval var77;
+    size_t var53;
+    size_t var54;
+    int var56;
+    jschar *var55;
+    jsval var78;
+    JSBool var43;
+    var44 = NULL;
+    var49 = NULL;
+    var48 = 0;
+    var50 = 0;
+    var51 = JSVAL_NULL;
+    var52 = NULL;
+    var77 = JSVAL_NULL;
+    var53 = 0;
+    var54 = 0;
+    var56 = 0;
+    var55 = NULL;
+    var78 = JSVAL_NULL;
+    var43 = JS_FALSE;
+    var44 = obj;
+    var48 = argc;
+    var50 = 0;
+    var50 = var50 < var48;
+    if (var50) {
+    var51 = argv[0];
+    var52 = JS_ValueToString(cx, var51);
+    if (!var52) {
+        goto do_return;
+    }
+    var77 = STRING_TO_JSVAL(var52);
+    argv[argc+0] = var77;
+    var53 = JS_GetStringLength(var52);
+    var54 = 1;
+    var54 += var53;
+    var49 = JS_malloc(cx, var54);
+    if (!var49) {
+        goto do_return;
+    }
+    var56 = 1;
+    var55 = JS_GetStringChars(var52);
+    var78 = STRING_TO_JSVAL(var52);
+    argv[argc+1] = var78;
+    {
+        size_t i;
+        for (i = 0; i < var53; ++i) {
+            var49[i] = wctob(var55[i]);
+        }
+        var49[var53] = '\0';
+    }
+    }
+    jsPrint2(var49);
+    var43 = JS_TRUE;
+    do_return:
+    if (var56) {
+        JS_free(cx, var49);
+        var49 = NULL;
+        var56 = 0;
+    }
+    return var43;
+}
+static JSBool
+jjhelp(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var58;
+    char *var63;
+    int var62;
+    int var64;
+    jsval var65;
+    JSString *var66;
+    jsval var79;
+    size_t var67;
+    size_t var68;
+    int var70;
+    jschar *var69;
+    jsval var80;
+    JSBool var57;
+    var58 = NULL;
+    var63 = NULL;
+    var62 = 0;
+    var64 = 0;
+    var65 = JSVAL_NULL;
+    var66 = NULL;
+    var79 = JSVAL_NULL;
+    var67 = 0;
+    var68 = 0;
+    var70 = 0;
+    var69 = NULL;
+    var80 = JSVAL_NULL;
+    var57 = JS_FALSE;
+    var58 = obj;
+    var62 = argc;
+    var64 = 0;
+    var64 = var64 < var62;
+    if (var64) {
+    var65 = argv[0];
+    var66 = JS_ValueToString(cx, var65);
+    if (!var66) {
+        goto do_return;
+    }
+    var79 = STRING_TO_JSVAL(var66);
+    argv[argc+0] = var79;
+    var67 = JS_GetStringLength(var66);
+    var68 = 1;
+    var68 += var67;
+    var63 = JS_malloc(cx, var68);
+    if (!var63) {
+        goto do_return;
+    }
+    var70 = 1;
+    var69 = JS_GetStringChars(var66);
+    var80 = STRING_TO_JSVAL(var66);
+    argv[argc+1] = var80;
+    {
+        size_t i;
+        for (i = 0; i < var67; ++i) {
+            var63[i] = wctob(var69[i]);
+        }
+        var63[var67] = '\0';
+    }
+    }
+    jsHelp(var63);
+    var57 = JS_TRUE;
+    do_return:
+    if (var70) {
+        JS_free(cx, var63);
+        var63 = NULL;
+        var70 = 0;
+    }
+    return var57;
+}
 static JSPropertySpec jj_static_ps[] = {
     {NULL, 0, 0, NULL, NULL}
 };
@@ -250,12 +390,16 @@
     JS_FS("admPopupError", jjadmPopupError, 1, 0, 2),
     JS_FS("admpPopupInfo", jjadmpPopupInfo, 1, 0, 2),
     JS_FS("admPrint", jjadmPrint, 1, 0, 2),
+    JS_FS("print", jjprint, 1, 0, 2),
+    JS_FS("help", jjhelp, 1, 0, 2),
     JS_FS_END
 };
 static JSFunctionSpec jj_fs[] = {
     JS_FS("admPopupError", jjadmPopupError, 1, 0, 2),
     JS_FS("admpPopupInfo", jjadmpPopupInfo, 1, 0, 2),
     JS_FS("admPrint", jjadmPrint, 1, 0, 2),
+    JS_FS("print", jjprint, 1, 0, 2),
+    JS_FS("help", jjhelp, 1, 0, 2),
     JS_FS_END
 };
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl	2009-12-09 19:12:33 UTC (rev 5632)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl	2009-12-09 19:12:50 UTC (rev 5633)
@@ -6,7 +6,8 @@
 function void admPopupError : jsPopupError   (cstring  ) <static>;
 function void admpPopupInfo : jsPopupInfo    (cstring  ) <static>;
 function void admPrint      : jsPrint        (cstring  ) <static>;
-/*function void print         : jsPrint        (cstring  ) <static>;*/
+function void print         : jsPrint2       (cstring  ) <static>;
+function void help          : jsHelp         (cstring  ) <static>;
 
 %<
 JSFunctionSpec  *jsGetIfFunctions(void)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory.cpp	2009-12-09 19:12:33 UTC (rev 5632)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory.cpp	2009-12-09 19:12:50 UTC (rev 5633)
@@ -17,41 +17,36 @@
 #include "ADM_editor/ADM_edit.hxx"
 #include "DIA_fileSel.h"
 #include "DIA_factory.h"
+#include "ADM_jsTestFactory.h"
 
 
-extern "C"
-{
-    void jsCrashTest(void);
-    void jsAssertTest(void);
-}
-
 /**
     \fn crashTest
     \brief Force a crash
 */
-void jsCrashTest(void)
+bool jsTestCrash(void)
 {
   
   int *foobar=NULL;
   *foobar=0; // CRASH!
-
+  return true;
 }
 /**
     \fn assertTest
     \brief Force a crash
 */
-void jsAssertTest(void)
+bool jsTestAssert(void)
 {
   
   ADM_assert(0);
-
+  return true;
 }
 
 
 /**
-    \fn jsFacInt
+    \fn jsTestFacInt
 */
-bool jsFacInt(void)
+bool jsTestFacInt(void)
 {
   uint32_t tog=0;
    diaElemUInteger blend(&tog,QT_TR_NOOP("Uinteger"),0,255);
@@ -66,9 +61,9 @@
 }
 
 /**
-    \fn jsFacFloat
+    \fn jsTestFacFloat
 */
-bool jsFacFloat(void)
+bool jsTestFacFloat(void)
 {
   ELEM_TYPE_FLOAT tog=0;
    diaElemFloat blend(&tog,QT_TR_NOOP("Float"),0,255);
@@ -83,9 +78,9 @@
 }
 
 /**
-    \fn jsFacToggle
+    \fn jsTestFacToggle
 */
-bool jsFacToggle(void)
+bool jsTestFacToggle(void)
 {
   uint32_t tog=0;
   uint32_t test=0;
@@ -105,9 +100,9 @@
 }
 
 /**
-    \fn jsFacMenu
+    \fn jsTestFacMenu
 */
-bool jsFacMenu(void)
+bool jsTestFacMenu(void)
 {
    uint32_t tog=4;
    ELEM_TYPE_FLOAT f=1; 
@@ -134,9 +129,9 @@
 }
 
 /**
-    \fn jsFacFile
+    \fn jsTestFacFile
 */
-bool jsFacFile(void)
+bool jsTestFacFile(void)
 {
    uint32_t tog=0;
    char *test=ADM_strdup("Entry test1");
@@ -154,9 +149,9 @@
 }
 
 /**
-    \fn jsFacDirSel
+    \fn jsTestFacDirSel
 */
-bool jsFacDirSel(void)
+bool jsTestFacDirSel(void)
 {
    uint32_t tog=0;
    char *test=ADM_strdup("Entry test1");
@@ -174,9 +169,9 @@
 }
 
 /**
-    \fn jsFacBitrate
+    \fn jsTestFacBitrate
 */
-bool jsFacBitrate(void)
+bool jsTestFacBitrate(void)
 {
 
    COMPRES_PARAMS test={
@@ -199,9 +194,9 @@
 }
 
 /**
-    \fn jsFacInt
+    \fn jsTestFacInt
 */
-bool jsFacBar(void)
+bool jsTestFacBar(void)
 {
     
       diaElemBar bar1(25,"25");
@@ -220,9 +215,9 @@
 }
 
 /**
-    \fn jsFacButton
+    \fn jsTestFacButton
 */
-bool jsFacButton(void)
+bool jsTestFacButton(void)
 {
     
       diaElemButton bar1("Button",clickMe,NULL);
@@ -235,9 +230,9 @@
 }
 
 /**
-    \fn jsFacSlider
+    \fn jsTestFacSlider
 */
-bool jsFacSlider(void)
+bool jsTestFacSlider(void)
 {
   int32_t val=4;
       diaElemSlider slide(&val,"foo", 0,10);
@@ -252,9 +247,9 @@
 }
 
 /**
-    \fn jsFacInt
+    \fn jsTestFacInt
 */
-bool jsFacRoText(void)
+bool jsTestFacRoText(void)
 
 {
     
@@ -269,9 +264,9 @@
 }
 
 /**
-    \fn jsFacText
+    \fn jsTestFacText
 */
-bool jsFacText(void)
+bool jsTestFacText(void)
 {
     
       char *foo=ADM_strdup("blah");
@@ -289,9 +284,9 @@
 }
 
 /**
-    \fn jsFacInt
+    \fn jsTestFacInt
 */
-bool jsFacTab(void)
+bool jsTestFacTab(void)
 {
     
       uint32_t test,test2;
@@ -318,9 +313,9 @@
 }
 
 /**
-    \fn jsFacInt
+    \fn jsTestFacInt
 */
-bool jsFacFrame(void)
+bool jsTestFacFrame(void)
 {
     
       uint32_t test,test2;
@@ -345,9 +340,9 @@
 
 
 /**
-    \fn jsFacHex
+    \fn jsTestFacHex
 */
-bool jsFacHex(void)
+bool jsTestFacHex(void)
 {
     
       uint8_t data[100];
@@ -366,9 +361,9 @@
 }
 
 /**
-    \fn jsFacMatrix
+    \fn jsTestFacMatrix
 */
-bool jsFacMatrix(void)
+bool jsTestFacMatrix(void)
 {
     
       uint8_t data[16];
@@ -392,9 +387,9 @@
 }
 
 /**
-    \fn jsFacThreadcount
+    \fn jsTestFacThreadcount
 */
-bool jsFacThreadcount(void)
+bool jsTestFacThreadCount(void)
 {
 	uint32_t val=1;
 	diaElemThreadCount threadcount(&val,"ThreadCount");
@@ -410,9 +405,9 @@
 }
 
 /**
-    \fn jsFacNotch
+    \fn jsTestFacNotch
 */
-bool jsFacNotch(void)
+bool jsTestFacNotch(void)
 {
     
 	diaElemNotch notch(1,"Notch");

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c	2009-12-09 19:12:33 UTC (rev 5632)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c	2009-12-09 19:12:50 UTC (rev 5633)
@@ -12,6 +12,10 @@
 please refer to the software package which it is part of.
 
 */
+#ifdef HAVE_ALLOCA_H
+#include <alloca.h>
+#endif
+#include <stdlib.h>
 #include <string.h>
 #include <wchar.h>
 #include <jsapi.h>
@@ -30,8 +34,11 @@
 #ifndef JS_FS_END
 #define JS_FS_END {NULL, NULL, 0, 0, 0}
 #endif
+#ifdef HAVE_ALLOCA_H
+static size_t jj_alloca_limit = 0;
+#endif
 static JSBool
-jjjsTestFacInt(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacInt(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var2;
     void *var3;
@@ -75,7 +82,7 @@
     var1 = JS_FALSE;
     var2 = obj;
     var6 = argc;
-    var3 = admFacInt();
+    var3 = jsTestFacInt();
     var9 = JS_GetGlobalObject(cx);
     var12 = "bool";
     var14 = JS_GetProperty(cx, var9, var12, &var15);
@@ -108,7 +115,7 @@
     return var1;
 }
 static JSBool
-jjjsTestFacFloat(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacFloat(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var22;
     void *var23;
@@ -152,7 +159,7 @@
     var21 = JS_FALSE;
     var22 = obj;
     var26 = argc;
-    var23 = admFacFloat();
+    var23 = jsTestFacFloat();
     var29 = JS_GetGlobalObject(cx);
     var32 = "bool";
     var34 = JS_GetProperty(cx, var29, var32, &var35);
@@ -185,7 +192,7 @@
     return var21;
 }
 static JSBool
-jjjsTestFacToggle(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacToggle(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var42;
     void *var43;
@@ -229,7 +236,7 @@
     var41 = JS_FALSE;
     var42 = obj;
     var46 = argc;
-    var43 = admFacToggle();
+    var43 = jsTestFacToggle();
     var49 = JS_GetGlobalObject(cx);
     var52 = "bool";
     var54 = JS_GetProperty(cx, var49, var52, &var55);
@@ -262,7 +269,7 @@
     return var41;
 }
 static JSBool
-jjjsTestFacMenu(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacMenu(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var62;
     void *var63;
@@ -306,7 +313,7 @@
     var61 = JS_FALSE;
     var62 = obj;
     var66 = argc;
-    var63 = admFacMenu();
+    var63 = jsTestFacMenu();
     var69 = JS_GetGlobalObject(cx);
     var72 = "bool";
     var74 = JS_GetProperty(cx, var69, var72, &var75);
@@ -339,7 +346,7 @@
     return var61;
 }
 static JSBool
-jjjsTestFacFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var82;
     void *var83;
@@ -383,7 +390,7 @@
     var81 = JS_FALSE;
     var82 = obj;
     var86 = argc;
-    var83 = admFacFile();
+    var83 = jsTestFacFile();
     var89 = JS_GetGlobalObject(cx);
     var92 = "bool";
     var94 = JS_GetProperty(cx, var89, var92, &var95);
@@ -416,7 +423,7 @@
     return var81;
 }
 static JSBool
-jjjsTestFacBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var102;
     void *var103;
@@ -460,7 +467,7 @@
     var101 = JS_FALSE;
     var102 = obj;
     var106 = argc;
-    var103 = admFacBitrate();
+    var103 = jsTestFacBitrate();
     var109 = JS_GetGlobalObject(cx);
     var112 = "bool";
     var114 = JS_GetProperty(cx, var109, var112, &var115);
@@ -493,7 +500,7 @@
     return var101;
 }
 static JSBool
-jjjsTestFacBar(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacBar(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var122;
     void *var123;
@@ -537,7 +544,7 @@
     var121 = JS_FALSE;
     var122 = obj;
     var126 = argc;
-    var123 = admFacBar();
+    var123 = jsTestFacBar();
     var129 = JS_GetGlobalObject(cx);
     var132 = "bool";
     var134 = JS_GetProperty(cx, var129, var132, &var135);
@@ -570,7 +577,7 @@
     return var121;
 }
 static JSBool
-jjjsTestFacRoText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacRoText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var142;
     void *var143;
@@ -614,7 +621,7 @@
     var141 = JS_FALSE;
     var142 = obj;
     var146 = argc;
-    var143 = admFacRoText();
+    var143 = jsTestFacRoText();
     var149 = JS_GetGlobalObject(cx);
     var152 = "bool";
     var154 = JS_GetProperty(cx, var149, var152, &var155);
@@ -647,7 +654,7 @@
     return var141;
 }
 static JSBool
-jjjsTestFacText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var162;
     void *var163;
@@ -691,7 +698,7 @@
     var161 = JS_FALSE;
     var162 = obj;
     var166 = argc;
-    var163 = admFacText();
+    var163 = jsTestFacText();
     var169 = JS_GetGlobalObject(cx);
     var172 = "bool";
     var174 = JS_GetProperty(cx, var169, var172, &var175);
@@ -724,7 +731,7 @@
     return var161;
 }
 static JSBool
-jjjsTestFacTab(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacTab(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var182;
     void *var183;
@@ -768,7 +775,7 @@
     var181 = JS_FALSE;
     var182 = obj;
     var186 = argc;
-    var183 = admFacTab();
+    var183 = jsTestFacTab();
     var189 = JS_GetGlobalObject(cx);
     var192 = "bool";
     var194 = JS_GetProperty(cx, var189, var192, &var195);
@@ -801,7 +808,7 @@
     return var181;
 }
 static JSBool
-jjjsTestFrame(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFrame(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var202;
     void *var203;
@@ -845,7 +852,7 @@
     var201 = JS_FALSE;
     var202 = obj;
     var206 = argc;
-    var203 = admFacFrame();
+    var203 = jsTestFacFrame();
     var209 = JS_GetGlobalObject(cx);
     var212 = "bool";
     var214 = JS_GetProperty(cx, var209, var212, &var215);
@@ -878,7 +885,7 @@
     return var201;
 }
 static JSBool
-jjjsTestHex(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestHex(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var222;
     void *var223;
@@ -922,7 +929,7 @@
     var221 = JS_FALSE;
     var222 = obj;
     var226 = argc;
-    var223 = admFacHex();
+    var223 = jsTestFacHex();
     var229 = JS_GetGlobalObject(cx);
     var232 = "bool";
     var234 = JS_GetProperty(cx, var229, var232, &var235);
@@ -955,7 +962,7 @@
     return var221;
 }
 static JSBool
-jjjsTestDirSel(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestDirSel(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var242;
     void *var243;
@@ -999,7 +1006,7 @@
     var241 = JS_FALSE;
     var242 = obj;
     var246 = argc;
-    var243 = admFacDirSel();
+    var243 = jsTestFacDirSel();
     var249 = JS_GetGlobalObject(cx);
     var252 = "bool";
     var254 = JS_GetProperty(cx, var249, var252, &var255);
@@ -1032,7 +1039,7 @@
     return var241;
 }
 static JSBool
-jjjsTestButton(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestButton(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var262;
     void *var263;
@@ -1076,7 +1083,7 @@
     var261 = JS_FALSE;
     var262 = obj;
     var266 = argc;
-    var263 = admFacButton();
+    var263 = jsTestFacButton();
     var269 = JS_GetGlobalObject(cx);
     var272 = "bool";
     var274 = JS_GetProperty(cx, var269, var272, &var275);
@@ -1109,7 +1116,7 @@
     return var261;
 }
 static JSBool
-jjjsTestMatrix(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestMatrix(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var282;
     void *var283;
@@ -1153,7 +1160,7 @@
     var281 = JS_FALSE;
     var282 = obj;
     var286 = argc;
-    var283 = admFacMatrix();
+    var283 = jsTestFacMatrix();
     var289 = JS_GetGlobalObject(cx);
     var292 = "bool";
     var294 = JS_GetProperty(cx, var289, var292, &var295);
@@ -1186,7 +1193,7 @@
     return var281;
 }
 static JSBool
-jjjsTestNotch(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestNotch(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var302;
     void *var303;
@@ -1230,7 +1237,7 @@
     var301 = JS_FALSE;
     var302 = obj;
     var306 = argc;
-    var303 = admFacNotch();
+    var303 = jsTestFacNotch();
     var309 = JS_GetGlobalObject(cx);
     var312 = "bool";
     var314 = JS_GetProperty(cx, var309, var312, &var315);
@@ -1263,7 +1270,7 @@
     return var301;
 }
 static JSBool
-jjjsTestThreadCount(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestThreadCount(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var322;
     void *var323;
@@ -1307,7 +1314,7 @@
     var321 = JS_FALSE;
     var322 = obj;
     var326 = argc;
-    var323 = admFacThreadCount();
+    var323 = jsTestFacThreadCount();
     var329 = JS_GetGlobalObject(cx);
     var332 = "bool";
     var334 = JS_GetProperty(cx, var329, var332, &var335);
@@ -1340,7 +1347,7 @@
     return var321;
 }
 static JSBool
-jjjsTestSlider(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestSlider(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var342;
     void *var343;
@@ -1384,7 +1391,7 @@
     var341 = JS_FALSE;
     var342 = obj;
     var346 = argc;
-    var343 = admFacSlider();
+    var343 = jsTestFacSlider();
     var349 = JS_GetGlobalObject(cx);
     var352 = "bool";
     var354 = JS_GetProperty(cx, var349, var352, &var355);
@@ -1417,7 +1424,7 @@
     return var341;
 }
 static JSBool
-jjjsCrashTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestCrash(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var362;
     int var366;
@@ -1427,12 +1434,12 @@
     var361 = JS_FALSE;
     var362 = obj;
     var366 = argc;
-    crashTest();
+    jsTestCrash();
     var361 = JS_TRUE;
     return var361;
 }
 static JSBool
-jjjsAssertTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestAssert(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var368;
     int var372;
@@ -1442,7 +1449,7 @@
     var367 = JS_FALSE;
     var368 = obj;
     var372 = argc;
-    assertTest();
+    jsTestAssert();
     var367 = JS_TRUE;
     return var367;
 }
@@ -1453,48 +1460,55 @@
     {NULL, 0, 0, NULL, NULL}
 };
 static JSFunctionSpec jj_static_fs[] = {
-    JS_FS("jsTestFacInt", jjjsTestFacInt, 0, 0, 3),
-    JS_FS("jsTestFacFloat", jjjsTestFacFloat, 0, 0, 3),
-    JS_FS("jsTestFacToggle", jjjsTestFacToggle, 0, 0, 3),
-    JS_FS("jsTestFacMenu", jjjsTestFacMenu, 0, 0, 3),
-    JS_FS("jsTestFacFile", jjjsTestFacFile, 0, 0, 3),
-    JS_FS("jsTestFacBitrate", jjjsTestFacBitrate, 0, 0, 3),
-    JS_FS("jsTestFacBar", jjjsTestFacBar, 0, 0, 3),
-    JS_FS("jsTestFacRoText", jjjsTestFacRoText, 0, 0, 3),
-    JS_FS("jsTestFacText", jjjsTestFacText, 0, 0, 3),
-    JS_FS("jsTestFacTab", jjjsTestFacTab, 0, 0, 3),
-    JS_FS("jsTestFrame", jjjsTestFrame, 0, 0, 3),
-    JS_FS("jsTestHex", jjjsTestHex, 0, 0, 3),
-    JS_FS("jsTestDirSel", jjjsTestDirSel, 0, 0, 3),
-    JS_FS("jsTestButton", jjjsTestButton, 0, 0, 3),
-    JS_FS("jsTestMatrix", jjjsTestMatrix, 0, 0, 3),
-    JS_FS("jsTestNotch", jjjsTestNotch, 0, 0, 3),
-    JS_FS("jsTestThreadCount", jjjsTestThreadCount, 0, 0, 3),
-    JS_FS("jsTestSlider", jjjsTestSlider, 0, 0, 3),
-    JS_FS("jsCrashTest", jjjsCrashTest, 0, 0, 0),
-    JS_FS("jsAssertTest", jjjsAssertTest, 0, 0, 0),
+    JS_FS("admTestFacInt", jjadmTestFacInt, 0, 0, 3),
+    JS_FS("admTestFacFloat", jjadmTestFacFloat, 0, 0, 3),
+    JS_FS("admTestFacToggle", jjadmTestFacToggle, 0, 0, 3),
+    JS_FS("admTestFacMenu", jjadmTestFacMenu, 0, 0, 3),
+    JS_FS("admTestFacFile", jjadmTestFacFile, 0, 0, 3),
+    JS_FS("admTestFacBitrate", jjadmTestFacBitrate, 0, 0, 3),
+    JS_FS("admTestFacBar", jjadmTestFacBar, 0, 0, 3),
+    JS_FS("admTestFacRoText", jjadmTestFacRoText, 0, 0, 3),
+    JS_FS("admTestFacText", jjadmTestFacText, 0, 0, 3),
+    JS_FS("admTestFacTab", jjadmTestFacTab, 0, 0, 3),
+    JS_FS("admTestFrame", jjadmTestFrame, 0, 0, 3),
+    JS_FS("admTestHex", jjadmTestHex, 0, 0, 3),
+    JS_FS("admTestDirSel", jjadmTestDirSel, 0, 0, 3),
+    JS_FS("admTestButton", jjadmTestButton, 0, 0, 3),
+    JS_FS("admTestMatrix", jjadmTestMatrix, 0, 0, 3),
+    JS_FS("admTestNotch", jjadmTestNotch, 0, 0, 3),
+    JS_FS("admTestThreadCount", jjadmTestThreadCount, 0, 0, 3),
+    JS_FS("admTestSlider", jjadmTestSlider, 0, 0, 3),
+    JS_FS("admTestCrash", jjadmTestCrash, 0, 0, 0),
+    JS_FS("admTestAssert", jjadmTestAssert, 0, 0, 0),
     JS_FS_END
 };
 static JSFunctionSpec jj_fs[] = {
-    JS_FS("jsTestFacInt", jjjsTestFacInt, 0, 0, 3),
-    JS_FS("jsTestFacFloat", jjjsTestFacFloat, 0, 0, 3),
-    JS_FS("jsTestFacToggle", jjjsTestFacToggle, 0, 0, 3),
-    JS_FS("jsTestFacMenu", jjjsTestFacMenu, 0, 0, 3),
-    JS_FS("jsTestFacFile", jjjsTestFacFile, 0, 0, 3),
-    JS_FS("jsTestFacBitrate", jjjsTestFacBitrate, 0, 0, 3),
-    JS_FS("jsTestFacBar", jjjsTestFacBar, 0, 0, 3),
-    JS_FS("jsTestFacRoText", jjjsTestFacRoText, 0, 0, 3),
-    JS_FS("jsTestFacText", jjjsTestFacText, 0, 0, 3),
-    JS_FS("jsTestFacTab", jjjsTestFacTab, 0, 0, 3),
-    JS_FS("jsTestFrame", jjjsTestFrame, 0, 0, 3),
-    JS_FS("jsTestHex", jjjsTestHex, 0, 0, 3),
-    JS_FS("jsTestDirSel", jjjsTestDirSel, 0, 0, 3),
-    JS_FS("jsTestButton", jjjsTestButton, 0, 0, 3),
-    JS_FS("jsTestMatrix", jjjsTestMatrix, 0, 0, 3),
-    JS_FS("jsTestNotch", jjjsTestNotch, 0, 0, 3),
-    JS_FS("jsTestThreadCount", jjjsTestThreadCount, 0, 0, 3),
-    JS_FS("jsTestSlider", jjjsTestSlider, 0, 0, 3),
-    JS_FS("jsCrashTest", jjjsCrashTest, 0, 0, 0),
-    JS_FS("jsAssertTest", jjjsAssertTest, 0, 0, 0),
+    JS_FS("admTestFacInt", jjadmTestFacInt, 0, 0, 3),
+    JS_FS("admTestFacFloat", jjadmTestFacFloat, 0, 0, 3),
+    JS_FS("admTestFacToggle", jjadmTestFacToggle, 0, 0, 3),
+    JS_FS("admTestFacMenu", jjadmTestFacMenu, 0, 0, 3),
+    JS_FS("admTestFacFile", jjadmTestFacFile, 0, 0, 3),
+    JS_FS("admTestFacBitrate", jjadmTestFacBitrate, 0, 0, 3),
+    JS_FS("admTestFacBar", jjadmTestFacBar, 0, 0, 3),
+    JS_FS("admTestFacRoText", jjadmTestFacRoText, 0, 0, 3),
+    JS_FS("admTestFacText", jjadmTestFacText, 0, 0, 3),
+    JS_FS("admTestFacTab", jjadmTestFacTab, 0, 0, 3),
+    JS_FS("admTestFrame", jjadmTestFrame, 0, 0, 3),
+    JS_FS("admTestHex", jjadmTestHex, 0, 0, 3),
+    JS_FS("admTestDirSel", jjadmTestDirSel, 0, 0, 3),
+    JS_FS("admTestButton", jjadmTestButton, 0, 0, 3),
+    JS_FS("admTestMatrix", jjadmTestMatrix, 0, 0, 3),
+    JS_FS("admTestNotch", jjadmTestNotch, 0, 0, 3),
+    JS_FS("admTestThreadCount", jjadmTestThreadCount, 0, 0, 3),
+    JS_FS("admTestSlider", jjadmTestSlider, 0, 0, 3),
+    JS_FS("admTestCrash", jjadmTestCrash, 0, 0, 0),
+    JS_FS("admTestAssert", jjadmTestAssert, 0, 0, 0),
     JS_FS_END
 };
+
+JSFunctionSpec  *jsGetTestFunctions(void)
+{
+        return jj_static_fs;
+}
+
+

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl	2009-12-09 19:12:33 UTC (rev 5632)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl	2009-12-09 19:12:50 UTC (rev 5633)
@@ -1,27 +1,34 @@
 /*
 ###############################################################
-       return C function     JS Function  params
+       return JS function     C Function  params
 ###############################################################
 */
-function bool jsTestFacInt : admFacInt   (void  ) <static>;
-function bool jsTestFacFloat : admFacFloat   (void  ) <static>;
-function bool jsTestFacToggle : admFacToggle   (void  ) <static>;
-function bool jsTestFacMenu : admFacMenu   (void  ) <static>;
-function bool jsTestFacFile : admFacFile   (void  ) <static>;
-function bool jsTestFacBitrate : admFacBitrate   (void  ) <static>;
-function bool jsTestFacBar : admFacBar   (void  ) <static>;
-function bool jsTestFacRoText : admFacRoText   (void  ) <static>;
-function bool jsTestFacText : admFacText   (void  ) <static>;
-function bool jsTestFacTab :  admFacTab   (void  ) <static>;
-function bool jsTestFrame :   admFacFrame   (void  ) <static>;
-function bool jsTestHex :     admFacHex   (void  ) <static>;
-function bool jsTestDirSel :  admFacDirSel   (void  ) <static>;
-function bool jsTestButton :  admFacButton   (void  ) <static>;
-function bool jsTestMatrix :  admFacMatrix   (void  ) <static>;
-function bool jsTestNotch :   admFacNotch   (void  ) <static>;
-function bool jsTestThreadCount : admFacThreadCount   (void  ) <static>;
-function bool jsTestSlider :  admFacSlider   (void  ) <static>;
-function void jsCrashTest :   crashTest   (void  ) <static>;
-function void jsAssertTest :  assertTest   (void  ) <static>;
+function bool admTestFacInt     :  jsTestFacInt     (void  ) <static>;
+function bool admTestFacFloat   :  jsTestFacFloat   (void  ) <static>;
+function bool admTestFacToggle  :  jsTestFacToggle  (void  ) <static>;
+function bool admTestFacMenu    :  jsTestFacMenu    (void  ) <static>;
+function bool admTestFacFile    :  jsTestFacFile    (void  ) <static>;
+function bool admTestFacBitrate :  jsTestFacBitrate (void  ) <static>;
+function bool admTestFacBar     :  jsTestFacBar     (void  ) <static>;
+function bool admTestFacRoText  :  jsTestFacRoText  (void  ) <static>;
+function bool admTestFacText    :  jsTestFacText    (void  ) <static>;
+function bool admTestFacTab     :  jsTestFacTab     (void  ) <static>;
+function bool admTestFrame      :  jsTestFacFrame   (void  ) <static>;
+function bool admTestHex        :  jsTestFacHex     (void  ) <static>;
+function bool admTestDirSel     :  jsTestFacDirSel  (void  ) <static>;
+function bool admTestButton     :  jsTestFacButton  (void  ) <static>;
+function bool admTestMatrix     :  jsTestFacMatrix  (void  ) <static>;
+function bool admTestNotch      :  jsTestFacNotch   (void  ) <static>;
+function bool admTestThreadCount:  jsTestFacThreadCount   (void  ) <static>;
+function bool admTestSlider     :  jsTestFacSlider  (void  ) <static>;
+function void admTestCrash      :  jsTestCrash      (void  ) <static>;
+function void admTestAssert     :  jsTestAssert     (void  ) <static>;
 
+%<
+JSFunctionSpec  *jsGetTestFunctions(void)
+{
+        return jj_static_fs;
+}
 
+%>
+



From mean at mail.berlios.de  Thu Dec 10 07:16:08 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 10 Dec 2009 07:16:08 +0100
Subject: [Avidemux-svn-commit] r5634 - in
	branches/avidemux_2.6_branch_mean/avidemux: cli
	cli/ADM_userInterfaces gtk
Message-ID: <200912100616.nBA6G88n003455@sheep.berlios.de>

Author: mean
Date: 2009-12-10 07:16:06 +0100 (Thu, 10 Dec 2009)
New Revision: 5634

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt
Log:
[Build] Fix gtk and cli linking

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/CMakeLists.txt	2009-12-09 19:12:50 UTC (rev 5633)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/CMakeLists.txt	2009-12-10 06:16:06 UTC (rev 5634)
@@ -2,4 +2,5 @@
 ADD_SUBDIRECTORY(ADM_dialog)
 ADD_SUBDIRECTORY(ADM_filters)
 ADD_SUBDIRECTORY(ADM_gui2)
+ADD_SUBDIRECTORY(ADM_shell)
 ADD_LIBRARY(ADM_toolkitCli6 SHARED ui_support.cpp)

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt	2009-12-09 19:12:50 UTC (rev 5633)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt	2009-12-10 06:16:06 UTC (rev 5634)
@@ -69,6 +69,7 @@
 TARGET_LINK_LIBRARIES(avidemux3_cli ADM_UI_Cli6)
 TARGET_LINK_LIBRARIES(avidemux3_cli ADM_UI_Cli6)
 TARGET_LINK_LIBRARIES(avidemux3_cli ADM_shellCli)
+TARGET_LINK_LIBRARIES(avidemux3_cli ADM_toolkit6)
 ###########################################
 # External libs
 ###########################################

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt	2009-12-09 19:12:50 UTC (rev 5633)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt	2009-12-10 06:16:06 UTC (rev 5634)
@@ -75,6 +75,7 @@
 TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_toolkitGtk)
 TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_UI_GTK)
 TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_shellGtk)
+TARGET_LINK_LIBRARIES(avidemux3_gtk ADM_toolkit6)
 ###########################################
 # External libs
 ###########################################



From mean at mail.berlios.de  Thu Dec 10 07:16:12 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 10 Dec 2009 07:16:12 +0100
Subject: [Avidemux-svn-commit] r5635 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src
Message-ID: <200912100616.nBA6GCxN003509@sheep.berlios.de>

Author: mean
Date: 2009-12-10 07:16:11 +0100 (Thu, 10 Dec 2009)
New Revision: 5635

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl
Log:
[Js] Use non static functions

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c	2009-12-10 06:16:06 UTC (rev 5634)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c	2009-12-10 06:16:11 UTC (rev 5635)
@@ -12,10 +12,6 @@
 please refer to the software package which it is part of.
 
 */
-#ifdef HAVE_ALLOCA_H
-#include <alloca.h>
-#endif
-#include <stdlib.h>
 #include <string.h>
 #include <wchar.h>
 #include <jsapi.h>
@@ -34,9 +30,6 @@
 #ifndef JS_FS_END
 #define JS_FS_END {NULL, NULL, 0, 0, 0}
 #endif
-#ifdef HAVE_ALLOCA_H
-static size_t jj_alloca_limit = 0;
-#endif
 static JSBool
 jjadmTestFacInt(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
@@ -1508,7 +1501,7 @@
 
 JSFunctionSpec  *jsGetTestFunctions(void)
 {
-        return jj_static_fs;
+        return jj_fs;
 }
 
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl	2009-12-10 06:16:06 UTC (rev 5634)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl	2009-12-10 06:16:11 UTC (rev 5635)
@@ -27,7 +27,7 @@
 %<
 JSFunctionSpec  *jsGetTestFunctions(void)
 {
-        return jj_static_fs;
+        return jj_fs;
 }
 
 %>



From mean at mail.berlios.de  Thu Dec 10 20:12:13 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 10 Dec 2009 20:12:13 +0100
Subject: [Avidemux-svn-commit] r5636 -
	branches/avidemux_2.5_branch_gruntster/po
Message-ID: <200912101912.nBAJCDMA026746@sheep.berlios.de>

Author: mean
Date: 2009-12-10 20:12:12 +0100 (Thu, 10 Dec 2009)
New Revision: 5636

Modified:
   branches/avidemux_2.5_branch_gruntster/po/avidemux_zh_TW.ts
   branches/avidemux_2.5_branch_gruntster/po/zh_TW.po
Log:
[po] Chinese traditional update by Dongjun Wu

Modified: branches/avidemux_2.5_branch_gruntster/po/avidemux_zh_TW.ts
===================================================================
--- branches/avidemux_2.5_branch_gruntster/po/avidemux_zh_TW.ts	2009-12-10 06:16:11 UTC (rev 5635)
+++ branches/avidemux_2.5_branch_gruntster/po/avidemux_zh_TW.ts	2009-12-10 19:12:12 UTC (rev 5636)
@@ -83,7 +83,7 @@
     </message>
     <message>
         <source>Not activated.</source>
-        <translation>?????</translation>
+        <translation type="obsolete">?????</translation>
     </message>
     <message>
         <source>Internal error finding codec &apos;&apos;</source>
@@ -103,7 +103,7 @@
         <source>Avidemux detected VBR MP3 audio in this file. For keeping audio/video in sync, time map is needed. Build it now?
 
 You can do it later with &quot;Audio -&gt; Build VBR Time Map&quot;.</source>
-        <translation>Avidemux ????????? VBR MP3 ???????????????????????????
+        <translation>Avidemux ????????? VBR MP3 ???????????????????????????
 
 ??????? \&quot;?? -&gt; ?? VBR ????\&quot; ????</translation>
     </message>
@@ -249,7 +249,7 @@
     </message>
     <message>
         <source>Copy</source>
-        <translation>????</translation>
+        <translation>??</translation>
     </message>
     <message>
         <source>Wrong output format</source>
@@ -1039,9 +1039,9 @@
         <source>I have detected a crash file. 
 Do you want to load it  ?
 (It will be deleted in all cases, you should save it if you want to keep it)</source>
-        <translation>?????????
+        <translation>?????????
 ????? ?
-(????????????????????????)</translation>
+(???????????????????????)</translation>
     </message>
     <message>
         <source>Oops</source>
@@ -1275,7 +1275,7 @@
 Continue anyway?</source>
         <translation>??????????????????
 
-??????????</translation>
+??????</translation>
     </message>
     <message>
         <source>
@@ -1296,7 +1296,7 @@
     </message>
     <message>
         <source>You can&apos;t use the Copy codec.</source>
-        <translation>??????????????</translation>
+        <translation>????????????</translation>
     </message>
     <message>
         <source>There is no audio track</source>
@@ -2396,15 +2396,15 @@
     </message>
     <message>
         <source>Video Codecs</source>
-        <translation>??????</translation>
+        <translation type="obsolete">??????</translation>
     </message>
     <message>
         <source>Xvid</source>
-        <translation>Xvid</translation>
+        <translation type="obsolete">Xvid</translation>
     </message>
     <message>
         <source>x264</source>
-        <translation>x264</translation>
+        <translation type="obsolete">x264</translation>
     </message>
     <message>
         <source>Audio Codecs</source>
@@ -2448,11 +2448,11 @@
     </message>
     <message>
         <source>aRts</source>
-        <translation>aRts</translation>
+        <translation type="obsolete">aRts</translation>
     </message>
     <message>
         <source>ESD</source>
-        <translation>ESD</translation>
+        <translation type="obsolete">ESD</translation>
     </message>
     <message>
         <source>Fontconfig</source>
@@ -2468,11 +2468,11 @@
     </message>
     <message>
         <source>ALSA</source>
-        <translation>ALSA</translation>
+        <translation type="obsolete">ALSA</translation>
     </message>
     <message>
         <source>OSS</source>
-        <translation>OSS</translation>
+        <translation type="obsolete">OSS</translation>
     </message>
     <message>
         <source>SDL</source>
@@ -2500,7 +2500,7 @@
     </message>
     <message>
         <source>Codecs</source>
-        <translation>???</translation>
+        <translation type="obsolete">???</translation>
     </message>
     <message>
         <source>Libraries</source>
@@ -3596,7 +3596,7 @@
     </message>
     <message>
         <source>Cannot save the audio in copy mode</source>
-        <translation>??? ???? ???????</translation>
+        <translation>????????????</translation>
     </message>
     <message>
         <source>Select WAV PCM as the audio codec, otherwise the audio file would be raw PCM.</source>
@@ -3712,7 +3712,7 @@
     </message>
     <message>
         <source>Switch audio codec to Copy.</source>
-        <translation>??????????????</translation>
+        <translation>????????????</translation>
     </message>
     <message>
         <source>Cannot delete the selection.</source>
@@ -3918,11 +3918,11 @@
     </message>
     <message>
         <source>Dual audio can only be used in copy mode</source>
-        <translation>??????????????</translation>
+        <translation>????????????</translation>
     </message>
     <message>
         <source>Select Copy as the video codec.</source>
-        <translation>?? ???? ?????????</translation>
+        <translation>?????????????</translation>
     </message>
     <message>
         <source>Incompatible output format</source>
@@ -4028,6 +4028,31 @@
         <translation>? MP3 ?????????????
 ?? lame ????</translation>
     </message>
+    <message>
+        <source>Audio filters cannot be applied in Copy mode</source>
+        <translation>?????????????</translation>
+    </message>
+    <message>
+        <source>To apply filters the audio must be transcoded.</source>
+        <translation>?????????????</translation>
+    </message>
+    <message>
+        <source>Video filters cannot be applied in Copy mode</source>
+        <translation>?????????????</translation>
+    </message>
+    <message>
+        <source>To apply filters the video must be transcoded.</source>
+        <translation>?????????????</translation>
+    </message>
+    <message>
+        <source>Not activated, make sure number of channels and bitrate are compatible with encoder!</source>
+        <translation>??????????????????????!</translation>
+    </message>
+    <message>
+        <source>Cannot cut.</source>
+        <translatorcomment>?????</translatorcomment>
+        <translation></translation>
+    </message>
 </context>
 <context>
     <name>ADMImage</name>
@@ -4905,7 +4930,7 @@
     </message>
     <message>
         <source>DivX 5 + packed?</source>
-        <translation>DivX 5 + ?????</translation>
+        <translation>DivX 5 + ???</translation>
     </message>
     <message>
         <source>Rebuilding Frames</source>
@@ -4929,7 +4954,7 @@
     </message>
     <message>
         <source>File type identified but no loader support detected...</source>
-        <translation>???????????????????...</translation>
+        <translation>???????????????????...</translation>
     </message>
     <message>
         <source>May be related to an old index file.</source>
@@ -4979,7 +5004,7 @@
     </message>
     <message>
         <source>Packed Bitstream detected</source>
-        <translation>??????????</translation>
+        <translation>??????????</translation>
     </message>
     <message>
         <source>Do you want me to unpack it ?</source>
@@ -5146,7 +5171,7 @@
     </message>
     <message>
         <source>Save As</source>
-        <translation>??</translation>
+        <translation>????</translation>
     </message>
     <message>
         <source>Delete</source>
@@ -5177,7 +5202,7 @@
     </message>
     <message>
         <source>Auto-detect</source>
-        <translation type="obsolete">????</translation>
+        <translation type="obsolete">????</translation>
     </message>
     <message>
         <source>Custom</source>
@@ -5616,7 +5641,7 @@
     </message>
     <message>
         <source>Use chroma to also detect scene change</source>
-        <translation type="obsolete">????????????</translation>
+        <translation type="obsolete">???????????</translation>
     </message>
     <message>
         <source>Settings</source>
@@ -7098,7 +7123,7 @@
     </message>
     <message>
         <source>Save P&amp;roject As...</source>
-        <translation>?????(&amp;R)...</translation>
+        <translation>????(&amp;R)...</translation>
     </message>
     <message>
         <source>Save Project As</source>

Modified: branches/avidemux_2.5_branch_gruntster/po/zh_TW.po
===================================================================
--- branches/avidemux_2.5_branch_gruntster/po/zh_TW.po	2009-12-10 06:16:11 UTC (rev 5635)
+++ branches/avidemux_2.5_branch_gruntster/po/zh_TW.po	2009-12-10 19:12:12 UTC (rev 5636)
@@ -3,8 +3,8 @@
 msgstr ""
 "Project-Id-Version: zh_TW\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2009-07-21 14:00+0800\n"
-"PO-Revision-Date: 2009-07-22 10:45+0800\n"
+"POT-Creation-Date: 2009-12-10 16:51+0800\n"
+"PO-Revision-Date: 2009-12-10 17:06+0800\n"
 "Last-Translator: Dong-Jun Wu <ziyawu at gmail.com>\n"
 "Language-Team: Traditional Chinese <ziyawu at gmail.com>\n"
 "MIME-Version: 1.0\n"
@@ -12,7 +12,7 @@
 "Content-Transfer-Encoding: 8bit\n"
 "X-Poedit-Language: Chinese (traditional)\n"
 "X-Poedit-Country: TAIWAN\n"
-"Plural-Forms: nplurals=2; plural=n != 1;\n"
+"Plural-Forms: nplurals=2; plural=(n > 1);\n"
 
 #: avidemux/ADM_editor/ADM_outputfmt.h:43
 #: avidemux/ADM_outputs/oplug_avi/op_avisave.cpp:370
@@ -159,7 +159,7 @@
 #: avidemux/ADM_outputs/oplug_mpeg/op_mpegpass.cpp:177
 #: avidemux/ADM_outputs/oplug_dummy/oplug_dummy.cpp:136
 #: avidemux/ADM_outputs/oplug_dummy/oplug_dummy.cpp:168
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:308
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:312
 #: avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp:182
 #: avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp:228
 #: avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp:249
@@ -169,17 +169,17 @@
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:1084
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:1124
 msgid "Copy"
-msgstr "????"
+msgstr "??"
 
 #: avidemux/guiplay.cpp:352
 msgid "Trouble initializing audio device"
 msgstr "???????????"
 
-#: avidemux/ADM_audiocodec/ADM_codecwma.cpp:91
+#: avidemux/ADM_audiocodec/ADM_codecwma.cpp:93
 msgid "Internal error"
 msgstr "????"
 
-#: avidemux/ADM_audiocodec/ADM_codecwma.cpp:91
+#: avidemux/ADM_audiocodec/ADM_codecwma.cpp:93
 msgid "Cannot open WMA2 codec."
 msgstr "???? WMA2 ?????"
 
@@ -193,7 +193,7 @@
 
 #: avidemux/ADM_editor/ADM_edFrameType.cpp:61
 msgid "DivX 5 + packed?"
-msgstr "DivX 5 + ?????"
+msgstr "DivX 5 + ???"
 
 #: avidemux/ADM_editor/ADM_edFrameType.cpp:91
 msgid "Rebuilding Frames"
@@ -215,34 +215,34 @@
 msgid "No more supported."
 msgstr "?????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:69
+#: avidemux/ADM_editor/ADM_edit.cpp:71
 msgid ""
 "Avidemux detected VBR MP3 audio in this file. For keeping audio/video in sync, time map is needed. Build it now?\n"
 "\n"
 "You can do it later with \"Audio -> Build VBR Time Map\"."
 msgstr ""
-"Avidemux ????????? VBR MP3 ???????????????????????????\n"
+"Avidemux ????????? VBR MP3 ???????????????????????????\n"
 "\n"
 "??????? \"?? -> ?? VBR ????\" ????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:394
+#: avidemux/ADM_editor/ADM_edit.cpp:396
 msgid "File type identified but no loader support detected..."
-msgstr "???????????????????..."
+msgstr "???????????????????..."
 
-#: avidemux/ADM_editor/ADM_edit.cpp:395
+#: avidemux/ADM_editor/ADM_edit.cpp:397
 msgid "May be related to an old index file."
 msgstr "???????????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:402
+#: avidemux/ADM_editor/ADM_edit.cpp:404
 #, c-format
 msgid "Attempt to open %s failed!"
 msgstr "????? %s ???"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:418
+#: avidemux/ADM_editor/ADM_edit.cpp:420
 msgid "Video dimensions don't match."
 msgstr "????????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:418
+#: avidemux/ADM_editor/ADM_edit.cpp:420
 msgid ""
 "You cannot mix different video dimensions yet. Using the partial video filter later will not work around this problem. The workaround is:\n"
 "\n"
@@ -254,65 +254,65 @@
 "1.) \"????\" / \"????\" / \"??\" ????????????\n"
 "2.) ??????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:530
+#: avidemux/ADM_editor/ADM_edit.cpp:532
 msgid "Build Time Map"
 msgstr "??????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:530
+#: avidemux/ADM_editor/ADM_edit.cpp:532
 msgid "Build VBR time map?"
 msgstr "???????? (VBR) ?????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:564
+#: avidemux/ADM_editor/ADM_edit.cpp:566
 msgid "Use safe mode"
 msgstr "??????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:564
+#: avidemux/ADM_editor/ADM_edit.cpp:566
 msgid "H.264 detected"
-msgstr "??? H.264"
+msgstr "??? H.264"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:564
+#: avidemux/ADM_editor/ADM_edit.cpp:566
 msgid ""
 "If the file is using B-frames as reference it can lead to a crash or stuttering.\n"
 "Avidemux can use another mode which is safe but YOU WILL LOSE FRAME ACCURACY.\n"
 "Do you want to use that mode?"
 msgstr ""
-"???????? B-????????????????????????\n"
+"???????? B ????????????????????????\n"
 "Avidemux ???????????????????????????\n"
 "????????? ?"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:694
+#: avidemux/ADM_editor/ADM_edit.cpp:696
 msgid "Packed Bitstream detected"
 msgstr "??????????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:695
+#: avidemux/ADM_editor/ADM_edit.cpp:697
 msgid "Do you want me to unpack it ?"
 msgstr "????????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:715
+#: avidemux/ADM_editor/ADM_edit.cpp:717
 msgid "Could not unpack the video"
 msgstr "??????????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:715
+#: avidemux/ADM_editor/ADM_edit.cpp:717
 msgid "Using backup decoder - not frame accurate."
 msgstr "??????? - ???????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:719
+#: avidemux/ADM_editor/ADM_edit.cpp:721
 msgid "Weird"
 msgstr "???"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:719
+#: avidemux/ADM_editor/ADM_edit.cpp:721
 msgid "The unpacking succeedeed but the index is still not up to date."
 msgstr "?????????????????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:732
+#: avidemux/ADM_editor/ADM_edit.cpp:734
 msgid "Index is not up to date"
 msgstr "???????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:732
+#: avidemux/ADM_editor/ADM_edit.cpp:734
 msgid "You should use Tool->Rebuild frame. Do it now ?"
-msgstr "????? ??->?????????????"
+msgstr "????? ?? -> ?????????????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:1494
+#: avidemux/ADM_editor/ADM_edit.cpp:1496
 msgid ""
 "This looks like mpeg\n"
 " Do you want to index it?"
@@ -320,7 +320,7 @@
 "????? mpeg\n"
 " ??????"
 
-#: avidemux/ADM_editor/ADM_edit.cpp:1546
+#: avidemux/ADM_editor/ADM_edit.cpp:1548
 msgid "Indexing failed"
 msgstr "????"
 
@@ -348,7 +348,7 @@
 
 #: avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp:92
 #: avidemux/ADM_outputs/oplug_mp4/oplug_mp4.cpp:171
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:181
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:183
 #: avidemux/ADM_outputs/oplug_ogm/op_ogsaveprocess.cpp:78
 msgid "Reuse the existing log file?"
 msgstr "???????????"
@@ -373,7 +373,7 @@
 #: avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp:262
 #: avidemux/ADM_outputs/oplug_mp4/oplug_mp4.cpp:189
 #: avidemux/ADM_outputs/oplug_dummy/oplug_dummy.cpp:146
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:302
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:306
 #: avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp:192
 #: avidemux/ADM_outputs/oplug_ogm/op_ogsaveprocess.cpp:165
 msgid "Encoding"
@@ -438,12 +438,12 @@
 #: avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp:180
 #: avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp:232
 #: avidemux/ADM_outputs/oplug_ogm/op_ogaudio.cpp:66
-#: avidemux/gtk_gui.cpp:1999
-#: avidemux/gtk_gui.cpp:2098
+#: avidemux/gtk_gui.cpp:2049
+#: avidemux/gtk_gui.cpp:2148
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_encoding.cpp:540
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_encoding.cpp:555
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_encoding.cpp:570
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:211
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:205
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_audioFilter.cpp:66
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_audioFilter.cpp:75
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_lavcodec.cpp:37
@@ -552,7 +552,7 @@
 msgstr ""
 "??????????????????\n"
 "\n"
-"??????????"
+"??????"
 
 #: avidemux/ADM_outputs/oplug_mp4/oplug_mp4.cpp:300
 #: avidemux/ADM_outputs/oplug_mp4/oplug_mp4.cpp:452
@@ -616,22 +616,22 @@
 msgstr "---"
 
 #: avidemux/ADM_outputs/oplug_mpeg/op_mpegpass.cpp:182
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:225
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:229
 msgid "MPEG TS"
 msgstr "MPEG TS"
 
 #: avidemux/ADM_outputs/oplug_mpeg/op_mpegpass.cpp:183
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:226
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:230
 msgid "MPEG VCD"
 msgstr "MPEG VCD"
 
 #: avidemux/ADM_outputs/oplug_mpeg/op_mpegpass.cpp:184
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:227
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:231
 msgid "MPEG SVCD"
 msgstr "MPEG SVCD"
 
 #: avidemux/ADM_outputs/oplug_mpeg/op_mpegpass.cpp:185
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:228
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:232
 msgid "MPEG DVD"
 msgstr "MPEG DVD"
 
@@ -639,64 +639,64 @@
 msgid "Dummy"
 msgstr "??"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:140
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:142
 msgid "For VCD, audio must be 44.1 kHz MP2."
 msgstr "VCD ?????? 44.1 kHz MP2?"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:160
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:162
 #: avidemux/ADM_libraries/ADM_lvemux/ADM_muxer.cpp:75
 msgid "Incompatible audio"
 msgstr "??????"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:160
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:162
 msgid "For DVD, audio must be 48 kHz MP2, AC3 or LPCM."
 msgstr "DVD ?????? 48 kHz MP2, AC3 ? LPCM?"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:198
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:200
 msgid "libmpeg2enc VCD"
 msgstr "libmpeg2enc VCD"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:201
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:203
 msgid "libmpeg2enc SVCD"
 msgstr "libmpeg2enc SVCD"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:204
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:206
 msgid "libmpeg2enc DVD"
 msgstr "libmpeg2enc DVD"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:207
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:209
 msgid "FFmpeg MPEG-1 VBR"
 msgstr "FFmpeg MPEG-1 VBR"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:210
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:212
 msgid "FFmpeg MPEG-2 SVCD VBR"
 msgstr "FFmpeg MPEG-2 SVCD VBR"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:213
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:215
 msgid "FFmpeg MPEG-2 DVD VBR"
 msgstr "FFmpeg MPEG-2 DVD VBR"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:216
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:218
 msgid "MPEG Requantizer"
 msgstr "MPEG ??????"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:224
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:228
 msgid "MPEG ES"
 msgstr "MPEG ES"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:240
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:244
 msgid "Pass 1/2"
 msgstr "?? 1/2"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:249
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:253
 msgid "Error in pass 1"
 msgstr "??? 1 ?????"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:295
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:299
 #: avidemux/ADM_outputs/oplug_ogm/op_ogsave.cpp:101
-#: avidemux/gtk_gui.cpp:889
-#: avidemux/gtk_gui.cpp:1499
-#: avidemux/gtk_gui.cpp:2607
+#: avidemux/gtk_gui.cpp:939
+#: avidemux/gtk_gui.cpp:1549
+#: avidemux/gtk_gui.cpp:2657
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_ocr.cpp:103
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_ocr.cpp:108
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_ocr.cpp:115
@@ -710,19 +710,19 @@
 msgid "File error"
 msgstr "????"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:295
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:299
 #: avidemux/ADM_outputs/oplug_ogm/op_ogsave.cpp:101
-#: avidemux/gtk_gui.cpp:1499
-#: avidemux/gtk_gui.cpp:2607
+#: avidemux/gtk_gui.cpp:1549
+#: avidemux/gtk_gui.cpp:2657
 #, c-format
 msgid "Cannot open \"%s\" for writing."
 msgstr "???? \"%s\" ????"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:300
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:304
 msgid "Pass 2/2"
 msgstr "?? 2/2"
 
-#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:392
+#: avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp:396
 msgid "Error in pass 2"
 msgstr "??? 2 ?????"
 
@@ -779,7 +779,7 @@
 msgid "No stts table"
 msgstr "?? stts ?"
 
-#: avidemux/ADM_inputs/ADM_openDML/ADM_openDMLDepack.cpp:86
+#: avidemux/ADM_inputs/ADM_openDML/ADM_openDMLDepack.cpp:75
 msgid "Unpacking bitstream"
 msgstr "?????????"
 
@@ -862,19 +862,27 @@
 msgid "Select ECMAScript to Run"
 msgstr "?? ECMAScript ???"
 
-#: avidemux/gtk_gui.cpp:313
+#: avidemux/gtk_gui.cpp:277
+msgid "Audio filters cannot be applied in Copy mode"
+msgstr "?????????????"
+
+#: avidemux/gtk_gui.cpp:277
+msgid "To apply filters the audio must be transcoded."
+msgstr "?????????????"
+
+#: avidemux/gtk_gui.cpp:321
 msgid "Obsolete"
 msgstr "??"
 
-#: avidemux/gtk_gui.cpp:341
+#: avidemux/gtk_gui.cpp:349
 msgid "Not coded in this version"
 msgstr "????????"
 
-#: avidemux/gtk_gui.cpp:356
+#: avidemux/gtk_gui.cpp:364
 msgid "Select Video/Image File..."
 msgstr "????/????..."
 
-#: avidemux/gtk_gui.cpp:409
+#: avidemux/gtk_gui.cpp:417
 msgid ""
 "This is to be used to undo packed VOP on MPEG-4.\n"
 "Continue ?"
@@ -882,183 +890,196 @@
 "??????? MPEG-4 ????? VOP ?\n"
 "????"
 
-#: avidemux/gtk_gui.cpp:411
+#: avidemux/gtk_gui.cpp:419
 msgid "Select AVI File to Write"
 msgstr "?? AVI ?????"
 
-#: avidemux/gtk_gui.cpp:417
+#: avidemux/gtk_gui.cpp:425
 msgid "Select OGM File to Write"
 msgstr "?? OGM ?????"
 
-#: avidemux/gtk_gui.cpp:421
-#: avidemux/gtk_gui.cpp:433
+#: avidemux/gtk_gui.cpp:429
+#: avidemux/gtk_gui.cpp:441
 msgid "Select Workbench to Save"
 msgstr "?????????"
 
-#: avidemux/gtk_gui.cpp:463
+#: avidemux/gtk_gui.cpp:471
 msgid "Select Raw File to Save"
 msgstr "?? RAW ?????"
 
-#: avidemux/gtk_gui.cpp:473
+#: avidemux/gtk_gui.cpp:481
 msgid "Select AVI File..."
 msgstr "?? AVI ??..."
 
-#: avidemux/gtk_gui.cpp:476
+#: avidemux/gtk_gui.cpp:484
 msgid "Select AVI File to Append..."
 msgstr "?? AVI ?????..."
 
-#: avidemux/gtk_gui.cpp:480
+#: avidemux/gtk_gui.cpp:488
 msgid "Select File to Save Audio"
 msgstr "?????????"
 
-#: avidemux/gtk_gui.cpp:514
+#: avidemux/gtk_gui.cpp:522
 msgid "Select JPEG Sequence to Save"
 msgstr "?? JPEG ??????"
 
-#: avidemux/gtk_gui.cpp:517
+#: avidemux/gtk_gui.cpp:525
 msgid "Select BMP to Save"
 msgstr "?? BMP ????"
 
-#: avidemux/gtk_gui.cpp:521
+#: avidemux/gtk_gui.cpp:529
 msgid "Select JPEG to Save"
 msgstr "?? JPG ????"
 
-#: avidemux/gtk_gui.cpp:574
-#: avidemux/gtk_gui.cpp:683
+#: avidemux/gtk_gui.cpp:594
+#: avidemux/gtk_gui.cpp:717
 msgid "Select File to Save"
 msgstr "????????"
 
-#: avidemux/gtk_gui.cpp:626
+#: avidemux/gtk_gui.cpp:658
 msgid "Select MP3 to Load"
 msgstr "?? MP3 ????"
 
-#: avidemux/gtk_gui.cpp:629
+#: avidemux/gtk_gui.cpp:661
 msgid "Select AC3 to Load"
 msgstr "?? AC3 ????"
 
-#: avidemux/gtk_gui.cpp:632
+#: avidemux/gtk_gui.cpp:664
 msgid "Select WAV to Load"
 msgstr "?? WAV ????"
 
-#: avidemux/gtk_gui.cpp:670
+#: avidemux/gtk_gui.cpp:704
 msgid "Go to Frame"
 msgstr "????"
 
-#: avidemux/gtk_gui.cpp:670
+#: avidemux/gtk_gui.cpp:704
 msgid "_Go to frame:"
 msgstr "???? (_G):"
 
-#: avidemux/gtk_gui.cpp:675
+#: avidemux/gtk_gui.cpp:709
 msgid "Out of bounds"
 msgstr "????"
 
-#: avidemux/gtk_gui.cpp:681
-#: avidemux/gtk_gui.cpp:689
-#: avidemux/gtk_gui.cpp:1909
+#: avidemux/gtk_gui.cpp:715
+#: avidemux/gtk_gui.cpp:723
+#: avidemux/gtk_gui.cpp:770
+#: avidemux/gtk_gui.cpp:1959
 msgid "Marker A > B"
 msgstr "?? A > B"
 
-#: avidemux/gtk_gui.cpp:681
+#: avidemux/gtk_gui.cpp:715
 msgid "An invalid frame range has been selected.  Make sure marker A is placed before marker B."
 msgstr "?????????????  ???? A ???? B ????"
 
-#: avidemux/gtk_gui.cpp:689
+#: avidemux/gtk_gui.cpp:723
 msgid "Cannot copy."
 msgstr "????"
 
-#: avidemux/gtk_gui.cpp:701
+#: avidemux/gtk_gui.cpp:735
 msgid "Something bad happened (II))"
 msgstr "??????? (II))"
 
-#: avidemux/gtk_gui.cpp:715
+#: avidemux/gtk_gui.cpp:749
 msgid "Are you sure?"
 msgstr "????"
 
-#: avidemux/gtk_gui.cpp:774
+#: avidemux/gtk_gui.cpp:770
+msgid "Cannot cut."
+msgstr "?????"
+
+#: avidemux/gtk_gui.cpp:813
 msgid "Use custom value"
 msgstr "?????"
 
-#: avidemux/gtk_gui.cpp:775
+#: avidemux/gtk_gui.cpp:814
 msgid "Frame Rate"
 msgstr "???"
 
-#: avidemux/gtk_gui.cpp:775
+#: avidemux/gtk_gui.cpp:814
 msgid "_Frames per second"
 msgstr "????? (_F)"
 
-#: avidemux/gtk_gui.cpp:778
+#: avidemux/gtk_gui.cpp:817
 msgid "PAL - 25 FPS"
 msgstr "PAL - 25 FPS"
 
-#: avidemux/gtk_gui.cpp:779
+#: avidemux/gtk_gui.cpp:818
 msgid "FILM - 24 FPS"
 msgstr "FILM - 24 FPS"
 
-#: avidemux/gtk_gui.cpp:780
+#: avidemux/gtk_gui.cpp:819
 msgid "NTSC - 30 FPS"
 msgstr "NTSC - 30 FPS"
 
-#: avidemux/gtk_gui.cpp:782
+#: avidemux/gtk_gui.cpp:821
 msgid "Standard Frame Rate:"
 msgstr "?????:"
 
-#: avidemux/gtk_gui.cpp:788
+#: avidemux/gtk_gui.cpp:827
 msgid "Change Frame Rate"
 msgstr "?????"
 
-#: avidemux/gtk_gui.cpp:819
+#: avidemux/gtk_gui.cpp:863
 msgid "Width is not a multiple of 8"
 msgstr "??? 8 ???"
 
-#: avidemux/gtk_gui.cpp:820
+#: avidemux/gtk_gui.cpp:864
 msgid "This will make trouble for AVI files."
 msgstr "???? AVI ??????"
 
-#: avidemux/gtk_gui.cpp:830
+#: avidemux/gtk_gui.cpp:875
+msgid "Video filters cannot be applied in Copy mode"
+msgstr "?????????????"
+
+#: avidemux/gtk_gui.cpp:875
+msgid "To apply filters the video must be transcoded."
+msgstr "?????????????"
+
+#: avidemux/gtk_gui.cpp:880
 msgid "Rebuild all Keyframes?"
 msgstr "??????????"
 
-#: avidemux/gtk_gui.cpp:886
+#: avidemux/gtk_gui.cpp:936
 msgid "Permission error"
 msgstr "??????"
 
-#: avidemux/gtk_gui.cpp:886
+#: avidemux/gtk_gui.cpp:936
 #: avidemux/ADM_coreUI/src/DIA_fileSel.cpp:129
 #, c-format
 msgid "Cannot open \"%s\"."
 msgstr "???? \"%s\"."
 
-#: avidemux/gtk_gui.cpp:889
+#: avidemux/gtk_gui.cpp:939
 #, c-format
 msgid "\"%s\" does not exist."
 msgstr "\"%s\" ????"
 
-#: avidemux/gtk_gui.cpp:892
+#: avidemux/gtk_gui.cpp:942
 msgid "Error opening file"
 msgstr "??????"
 
-#: avidemux/gtk_gui.cpp:892
+#: avidemux/gtk_gui.cpp:942
 #, c-format
 msgid "Error opening \"%s\"."
 msgstr "?? \"%s\" ???"
 
-#: avidemux/gtk_gui.cpp:936
+#: avidemux/gtk_gui.cpp:986
 msgid "Cannot open project using the video loader."
 msgstr "???????????????"
 
-#: avidemux/gtk_gui.cpp:937
+#: avidemux/gtk_gui.cpp:987
 msgid "Try 'File' -> 'Load/Run Project...'"
 msgstr "?? '??' -> '??/?? ??...'"
 
-#: avidemux/gtk_gui.cpp:939
+#: avidemux/gtk_gui.cpp:989
 msgid "Could not open the file"
 msgstr "???????"
 
-#: avidemux/gtk_gui.cpp:973
+#: avidemux/gtk_gui.cpp:1023
 msgid "Multiple Audio Tracks"
 msgstr "???"
 
-#: avidemux/gtk_gui.cpp:973
+#: avidemux/gtk_gui.cpp:1023
 msgid ""
 "The file you just loaded contains several audio tracks.\n"
 "Go to Audio->MainTrack to select the active one."
@@ -1066,303 +1087,303 @@
 "????????????????\n"
 "?? ??->???? ??????????"
 
-#: avidemux/gtk_gui.cpp:1027
+#: avidemux/gtk_gui.cpp:1077
 msgid "No audio decoder found for this file"
 msgstr "?????????????????"
 
-#: avidemux/gtk_gui.cpp:1028
+#: avidemux/gtk_gui.cpp:1078
 msgid "Save (A+V) will generate bad AVI. Save audio will work."
 msgstr "?? (A+V) ?????? AVI??????????"
 
-#: avidemux/gtk_gui.cpp:1087
+#: avidemux/gtk_gui.cpp:1137
 msgid "Something failed when appending"
 msgstr "??????????"
 
-#: avidemux/gtk_gui.cpp:1098
-#: avidemux/gtk_gui.cpp:1928
+#: avidemux/gtk_gui.cpp:1148
+#: avidemux/gtk_gui.cpp:1978
 msgid "Something bad happened (II)"
 msgstr "??????? (II)"
 
-#: avidemux/gtk_gui.cpp:1162
+#: avidemux/gtk_gui.cpp:1212
 msgid "Cannot save the audio in copy mode"
-msgstr "??? ???? ???????"
+msgstr "????????????"
 
-#: avidemux/gtk_gui.cpp:1162
+#: avidemux/gtk_gui.cpp:1212
 msgid "Select WAV PCM as the audio codec, otherwise the audio file would be raw PCM."
 msgstr "?? WAV PCM ???????????????????? PCM?"
 
-#: avidemux/gtk_gui.cpp:1170
-#: avidemux/gtk_gui.cpp:1538
+#: avidemux/gtk_gui.cpp:1220
+#: avidemux/gtk_gui.cpp:1588
 msgid "Saving audio"
 msgstr "??????"
 
-#: avidemux/gtk_gui.cpp:1247
+#: avidemux/gtk_gui.cpp:1297
 msgid "Get Frame"
 msgstr "????"
 
-#: avidemux/gtk_gui.cpp:1247
+#: avidemux/gtk_gui.cpp:1297
 msgid "Cannot get this frame to save"
 msgstr "???????????"
 
-#: avidemux/gtk_gui.cpp:1285
+#: avidemux/gtk_gui.cpp:1335
 msgid "Mark A > B"
 msgstr "?? A > B"
 
-#: avidemux/gtk_gui.cpp:1285
+#: avidemux/gtk_gui.cpp:1335
 msgid "Set your markers correctly."
 msgstr "??????????"
 
-#: avidemux/gtk_gui.cpp:1294
+#: avidemux/gtk_gui.cpp:1344
 msgid "Saving as set of jpegs"
 msgstr "??????? jpeg ?"
 
-#: avidemux/gtk_gui.cpp:1300
+#: avidemux/gtk_gui.cpp:1350
 msgid "Cannot decode frame"
 msgstr "??????"
 
-#: avidemux/gtk_gui.cpp:1300
+#: avidemux/gtk_gui.cpp:1350
 msgid "Aborting."
 msgstr "?????"
 
-#: avidemux/gtk_gui.cpp:1311
-#: avidemux/gtk_gui.cpp:1330
-#: avidemux/gtk_gui.cpp:2272
+#: avidemux/gtk_gui.cpp:1361
+#: avidemux/gtk_gui.cpp:1380
+#: avidemux/gtk_gui.cpp:2322
 msgid "Done"
 msgstr "??"
 
-#: avidemux/gtk_gui.cpp:1311
+#: avidemux/gtk_gui.cpp:1361
 #, c-format
 msgid "Saved %d images."
 msgstr "??? %d ????"
 
-#: avidemux/gtk_gui.cpp:1313
+#: avidemux/gtk_gui.cpp:1363
 msgid "Error"
 msgstr "??"
 
-#: avidemux/gtk_gui.cpp:1313
+#: avidemux/gtk_gui.cpp:1363
 msgid "Could not save all images."
 msgstr "?????????"
 
-#: avidemux/gtk_gui.cpp:1330
+#: avidemux/gtk_gui.cpp:1380
 #, c-format
 msgid "Saved \"%s\"."
 msgstr "??? \"%s\"?"
 
-#: avidemux/gtk_gui.cpp:1332
+#: avidemux/gtk_gui.cpp:1382
 msgid "BMP op failed"
 msgstr "BMP ????"
 
-#: avidemux/gtk_gui.cpp:1332
+#: avidemux/gtk_gui.cpp:1382
 #, c-format
 msgid "Saving %s as a BMP file failed."
 msgstr "?? %s ? BMP ????"
 
-#: avidemux/gtk_gui.cpp:1354
-#: avidemux/gtk_gui.cpp:1420
+#: avidemux/gtk_gui.cpp:1404
+#: avidemux/gtk_gui.cpp:1470
 msgid "Failed to open the file"
 msgstr "???????"
 
-#: avidemux/gtk_gui.cpp:1354
-#: avidemux/gtk_gui.cpp:1420
+#: avidemux/gtk_gui.cpp:1404
+#: avidemux/gtk_gui.cpp:1470
 msgid "Not a WAV file?"
 msgstr "???? WAV ??"
 
-#: avidemux/gtk_gui.cpp:1355
+#: avidemux/gtk_gui.cpp:1405
 msgid "WAV open file failed..."
 msgstr "WAV ??????..."
 
-#: avidemux/gtk_gui.cpp:1492
+#: avidemux/gtk_gui.cpp:1542
 msgid "Cannot decompress audio frame"
 msgstr "????????"
 
-#: avidemux/gtk_gui.cpp:1506
+#: avidemux/gtk_gui.cpp:1556
 msgid "Memory Error"
 msgstr "?????"
 
-#: avidemux/gtk_gui.cpp:1559
+#: avidemux/gtk_gui.cpp:1609
 msgid "No frames to encode"
 msgstr "??????????"
 
-#: avidemux/gtk_gui.cpp:1559
+#: avidemux/gtk_gui.cpp:1609
 msgid "Please check markers. Is \"A>\" == \">B\"?"
 msgstr "?????? ? \"A>\" == \">B\"?"
 
-#: avidemux/gtk_gui.cpp:1698
+#: avidemux/gtk_gui.cpp:1748
 msgid "Saving raw video stream"
 msgstr "??????????"
 
-#: avidemux/gtk_gui.cpp:1844
+#: avidemux/gtk_gui.cpp:1894
 msgid "Checking video"
 msgstr "??????"
 
-#: avidemux/gtk_gui.cpp:1860
+#: avidemux/gtk_gui.cpp:1910
 msgid "No error found"
 msgstr "??????"
 
-#: avidemux/gtk_gui.cpp:1864
+#: avidemux/gtk_gui.cpp:1914
 #, c-format
 msgid "Errors found in %u frames"
 msgstr "? %u ??????"
 
-#: avidemux/gtk_gui.cpp:1882
+#: avidemux/gtk_gui.cpp:1932
 msgid "Cannot decompress the audio stream"
 msgstr "?????????"
 
-#: avidemux/gtk_gui.cpp:1882
+#: avidemux/gtk_gui.cpp:1932
 msgid "Switch audio codec to Copy."
-msgstr "???????????????"
+msgstr "?????????????"
 
-#: avidemux/gtk_gui.cpp:1909
+#: avidemux/gtk_gui.cpp:1959
 msgid "Cannot delete the selection."
 msgstr "??????????"
 
-#: avidemux/gtk_gui.cpp:1914
+#: avidemux/gtk_gui.cpp:1964
 msgid "You can't remove all frames"
 msgstr "??????????"
 
-#: avidemux/gtk_gui.cpp:1921
-#: avidemux/gtk_gui.cpp:2543
+#: avidemux/gtk_gui.cpp:1971
+#: avidemux/gtk_gui.cpp:2593
 msgid "Something bad happened"
 msgstr "???????"
 
-#: avidemux/gtk_gui.cpp:1990
+#: avidemux/gtk_gui.cpp:2040
 msgid "Could not get tracks info"
 msgstr "????????"
 
-#: avidemux/gtk_gui.cpp:1998
+#: avidemux/gtk_gui.cpp:2048
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp:358
 msgid "Video"
 msgstr "??"
 
-#: avidemux/gtk_gui.cpp:1998
+#: avidemux/gtk_gui.cpp:2048
 msgid "Take audio from video file"
 msgstr "???????"
 
-#: avidemux/gtk_gui.cpp:1999
-#: avidemux/gtk_gui.cpp:2098
+#: avidemux/gtk_gui.cpp:2049
+#: avidemux/gtk_gui.cpp:2148
 msgid "No audio"
 msgstr "????"
 
-#: avidemux/gtk_gui.cpp:2000
-#: avidemux/gtk_gui.cpp:2099
+#: avidemux/gtk_gui.cpp:2050
+#: avidemux/gtk_gui.cpp:2149
 msgid "External AC3"
 msgstr "??? AC3"
 
-#: avidemux/gtk_gui.cpp:2000
-#: avidemux/gtk_gui.cpp:2099
+#: avidemux/gtk_gui.cpp:2050
+#: avidemux/gtk_gui.cpp:2149
 msgid "Take audio from external AC3 file"
 msgstr "???? AC3 ?????"
 
-#: avidemux/gtk_gui.cpp:2001
-#: avidemux/gtk_gui.cpp:2100
+#: avidemux/gtk_gui.cpp:2051
+#: avidemux/gtk_gui.cpp:2150
 msgid "External MP3"
 msgstr "??? MP3"
 
-#: avidemux/gtk_gui.cpp:2001
-#: avidemux/gtk_gui.cpp:2100
+#: avidemux/gtk_gui.cpp:2051
+#: avidemux/gtk_gui.cpp:2150
 msgid "Take audio from external MP3 file"
 msgstr "???? MP3 ?????"
 
-#: avidemux/gtk_gui.cpp:2002
-#: avidemux/gtk_gui.cpp:2101
+#: avidemux/gtk_gui.cpp:2052
+#: avidemux/gtk_gui.cpp:2151
 msgid "External WAV"
 msgstr "??? WAV"
 
-#: avidemux/gtk_gui.cpp:2002
-#: avidemux/gtk_gui.cpp:2101
+#: avidemux/gtk_gui.cpp:2052
+#: avidemux/gtk_gui.cpp:2151
 msgid "Take audio from external WAV file"
 msgstr "???? WAV ?????"
 
-#: avidemux/gtk_gui.cpp:2006
-#: avidemux/gtk_gui.cpp:2106
+#: avidemux/gtk_gui.cpp:2056
+#: avidemux/gtk_gui.cpp:2156
 msgid "_Audio source:"
 msgstr "????(_A):"
 
-#: avidemux/gtk_gui.cpp:2010
-#: avidemux/gtk_gui.cpp:2107
+#: avidemux/gtk_gui.cpp:2060
+#: avidemux/gtk_gui.cpp:2157
 msgid "_External file:"
 msgstr "????(_E):"
 
-#: avidemux/gtk_gui.cpp:2010
-#: avidemux/gtk_gui.cpp:2107
+#: avidemux/gtk_gui.cpp:2060
+#: avidemux/gtk_gui.cpp:2157
 #: avidemux/ADM_videoFilter/ADM_vidParticle.cpp:187
 #: avidemux/ADM_videoFilter/ADM_vidSwissArmyKnife.cpp:321
 msgid "Select file"
 msgstr "????"
 
-#: avidemux/gtk_gui.cpp:2019
+#: avidemux/gtk_gui.cpp:2069
 #, c-format
 msgid "Audio track %d (%s/%d channels/%d kbit per s/%d ms shift)"
 msgstr "?? %d (%s/%d ??? s/%d ms ?? /%d kbit )"
 
-#: avidemux/gtk_gui.cpp:2025
+#: avidemux/gtk_gui.cpp:2075
 msgid "_Track from video:"
 msgstr "?????? (_T):"
 
-#: avidemux/gtk_gui.cpp:2035
+#: avidemux/gtk_gui.cpp:2085
 msgid "Main Audio Track"
 msgstr "????"
 
-#: avidemux/gtk_gui.cpp:2041
-#: avidemux/gtk_gui.cpp:2119
+#: avidemux/gtk_gui.cpp:2091
+#: avidemux/gtk_gui.cpp:2169
 msgid "Cannot load"
 msgstr "????"
 
-#: avidemux/gtk_gui.cpp:2041
-#: avidemux/gtk_gui.cpp:2119
+#: avidemux/gtk_gui.cpp:2091
+#: avidemux/gtk_gui.cpp:2169
 msgid "The selected audio file does not exist."
 msgstr "??????????"
 
-#: avidemux/gtk_gui.cpp:2116
+#: avidemux/gtk_gui.cpp:2166
 msgid "Second Audio Track"
 msgstr "????"
 
-#: avidemux/gtk_gui.cpp:2148
+#: avidemux/gtk_gui.cpp:2198
 msgid "Error loading the MP3 file"
 msgstr "?? MP3 ????"
 
-#: avidemux/gtk_gui.cpp:2157
-#: avidemux/gtk_gui.cpp:2179
-#: avidemux/gtk_gui.cpp:2201
+#: avidemux/gtk_gui.cpp:2207
+#: avidemux/gtk_gui.cpp:2229
+#: avidemux/gtk_gui.cpp:2251
 msgid "Second track loaded"
 msgstr "???????"
 
-#: avidemux/gtk_gui.cpp:2171
+#: avidemux/gtk_gui.cpp:2221
 msgid "Error loading the AC3 file"
 msgstr "?? AC3 ????"
 
-#: avidemux/gtk_gui.cpp:2193
+#: avidemux/gtk_gui.cpp:2243
 msgid "Error loading the WAV file"
 msgstr "?? WAV ????"
 
-#: avidemux/gtk_gui.cpp:2260
+#: avidemux/gtk_gui.cpp:2310
 msgid "Saving failed"
 msgstr "????"
 
-#: avidemux/gtk_gui.cpp:2260
+#: avidemux/gtk_gui.cpp:2310
 msgid "Saving the job failed. Maybe you have permission issue with ~/.avidemux"
 msgstr "???????????????? ~/.avidemux"
 
-#: avidemux/gtk_gui.cpp:2272
+#: avidemux/gtk_gui.cpp:2322
 #, c-format
 msgid "File %s has been successfully saved."
 msgstr "?? %s ????????"
 
-#: avidemux/gtk_gui.cpp:2276
+#: avidemux/gtk_gui.cpp:2326
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_jobs.cpp:8
 msgid "Failed"
 msgstr "??"
 
-#: avidemux/gtk_gui.cpp:2276
+#: avidemux/gtk_gui.cpp:2326
 #, c-format
 msgid "File %s was NOT saved correctly."
 msgstr "?? %s ??????"
 
-#: avidemux/gtk_gui.cpp:2442
+#: avidemux/gtk_gui.cpp:2492
 msgid "AvsProxy"
 msgstr "AvsProxy"
 
-#: avidemux/gtk_gui.cpp:2442
+#: avidemux/gtk_gui.cpp:2492
 msgid ""
 "Failed to connect to avsproxy.\n"
 "Is it running ?"
@@ -1370,31 +1391,31 @@
 "????? avsproxy?\n"
 "???????"
 
-#: avidemux/gtk_gui.cpp:2447
+#: avidemux/gtk_gui.cpp:2497
 msgid "avsproxy"
 msgstr "avsproxy"
 
-#: avidemux/gtk_gui.cpp:2475
+#: avidemux/gtk_gui.cpp:2525
 msgid "Frame type:"
 msgstr "????:"
 
-#: avidemux/gtk_gui.cpp:2476
+#: avidemux/gtk_gui.cpp:2526
 msgid "Frame size:"
 msgstr "????:"
 
-#: avidemux/gtk_gui.cpp:2478
+#: avidemux/gtk_gui.cpp:2528
 msgid "Frame Hex Dump"
 msgstr "??16 ????"
 
-#: avidemux/gtk_gui.cpp:2529
+#: avidemux/gtk_gui.cpp:2579
 msgid "Memory error"
 msgstr "?????"
 
-#: avidemux/gtk_gui.cpp:2536
+#: avidemux/gtk_gui.cpp:2586
 msgid "Error converting to BMP"
 msgstr "?? BMP ??"
 
-#: avidemux/gtk_gui.cpp:2598
+#: avidemux/gtk_gui.cpp:2648
 msgid "Cannot encode the frame"
 msgstr "???????"
 
@@ -1411,9 +1432,9 @@
 #: avidemux/gui_autodrive.cpp:109
 #: avidemux/gui_autodrive.cpp:115
 #: avidemux/gui_autodrive.cpp:130
-#: avidemux/gui_autodrive.cpp:157
-#: avidemux/gui_autodrive.cpp:192
-#: avidemux/ADM_audiofilter/audiofilter_buildchain.cpp:290
+#: avidemux/gui_autodrive.cpp:153
+#: avidemux/gui_autodrive.cpp:188
+#: avidemux/ADM_audiofilter/audiofilter_buildchain.cpp:291
 msgid "Codec Error"
 msgstr "??????"
 
@@ -1445,11 +1466,11 @@
 msgid "Cannot select FLV1  codec."
 msgstr "???? FLV1  ?????"
 
-#: avidemux/gui_autodrive.cpp:157
+#: avidemux/gui_autodrive.cpp:153
 msgid "Cannot select mpeg4 sp codec."
 msgstr "???? mpeg4 sp ?????"
 
-#: avidemux/gui_autodrive.cpp:193
+#: avidemux/gui_autodrive.cpp:189
 msgid ""
 "You don't have FAAC!.\n"
 "It is needed to create PSP compatible video."
@@ -1457,81 +1478,81 @@
 "????? FAAC?.\n"
 "?? PSP ?????????"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_threadCount.cpp:87
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_threadCount.cpp:88
 msgid "Disable"
 msgstr "??"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_threadCount.cpp:91
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_threadCount.cpp:92
 msgid "Auto-detect"
-msgstr "????"
+msgstr "????"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_threadCount.cpp:99
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_threadCount.cpp:100
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_calculator.cpp:549
 msgid "Custom"
 msgstr "??"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:111
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:141
 msgid "_Encoding mode:"
 msgstr "???? (_E):"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:121
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:283
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:151
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:280
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flv1.cpp:36
 msgid "_Bitrate (kb/s):"
 msgstr "??? (_B) (kb/s):"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:135
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:165
 msgid "Single pass - bitrate"
 msgstr "???? - ???"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:137
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:167
 msgid "Single pass - constant quality"
 msgstr "???? - ????"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:139
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:169
 msgid "Single pass - same qz as input"
 msgstr "???? - ????????"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:141
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:171
 msgid "Single pass - Average quantizer"
 msgstr "???? - ?????"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:144
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:174
 msgid "Two pass - video size"
 msgstr "???? - ????"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:146
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:176
 msgid "Two pass - average bitrate"
 msgstr "???? - ?????"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:288
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:285
 #: plugins/ADM_videoFilters/ForcedPP/ADM_vidForcedPP.cpp:45
 msgid "_Quantizer:"
 msgstr "???:"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:293
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:290
 msgid "A_vg Quantizer:"
 msgstr "?????:"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:298
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:295
 msgid "_Video size (MB):"
 msgstr "???? (MB):"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:303
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:300
 msgid "_Average bitrate (kb/s):"
 msgstr "????? (kb/s):"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:308
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp:305
 msgid "-"
 msgstr "-"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_hex.cpp:103
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_hex.cpp:137
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_hex.cpp:104
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_hex.cpp:138
 msgid "_Previous"
 msgstr "??? (_P)"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_hex.cpp:111
-#: avidemux/ADM_UIs/ADM_GTK/src/FAC_hex.cpp:167
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_hex.cpp:112
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_hex.cpp:168
 msgid "_Next"
 msgstr "??? (_N)"
 
@@ -1539,11 +1560,46 @@
 msgid "Select Color"
 msgstr "????"
 
-#: avidemux/ADM_UIs/ADM_GTK/src/DIA_filesel.cpp:119
-#: avidemux/ADM_UIs/ADM_GTK/src/DIA_filesel.cpp:279
+#: avidemux/ADM_UIs/ADM_GTK/src/DIA_filesel.cpp:121
+#: avidemux/ADM_UIs/ADM_GTK/src/DIA_filesel.cpp:282
 msgid "_Browse..."
 msgstr "??... (_B)"
 
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp:84
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp:90
+#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:117
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:198
+msgid "<default>"
+msgstr "<??>"
+
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp:85
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp:91
+#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:118
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:199
+msgid "<custom>"
+msgstr "<??>"
+
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp:156
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp:310
+#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:215
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:326
+msgid "Save As"
+msgstr "????"
+
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp:198
+#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:249
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:360
+msgid "Are you sure you wish to delete the selected configuration?"
+msgstr "?????????? ?"
+
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp:300
+msgid "Configuration:"
+msgstr "??:"
+
+#: avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp:314
+msgid "Delete"
+msgstr "??"
+
 #: avidemux/ADM_audio/audiotimeline.cpp:78
 #: avidemux/ADM_audio/audiotimeline.cpp:89
 msgid "Building VBR map"
@@ -1553,17 +1609,17 @@
 msgid "Requant"
 msgstr "????"
 
-#: avidemux/ADM_encoder/adm_encConfig.cpp:595
+#: avidemux/ADM_encoder/adm_encConfig.cpp:610
 msgid "Only QCIF and subQCIF are allowed for H.263"
 msgstr "H.263 ??? QCIF ? subQCIF"
 
 #: avidemux/gui_savenew.cpp:78
 msgid "Dual audio can only be used in copy mode"
-msgstr "??????? ???? ???"
+msgstr "???????????"
 
 #: avidemux/gui_savenew.cpp:78
 msgid "Select Copy as the video codec."
-msgstr "?? ???? ??????????"
+msgstr "??????????????"
 
 #: avidemux/gui_savenew.cpp:198
 #: avidemux/gui_savenew.cpp:214
@@ -1652,7 +1708,7 @@
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:371
 msgid "Save P_roject As..."
-msgstr "?????... (_R)"
+msgstr "????... (_R)"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:379
 msgid "_Load/Run Project..."
@@ -1856,14 +1912,17 @@
 msgstr "?? (_U)"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:775
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:140
 msgid "_VCD"
 msgstr "_VCD"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:779
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:145
 msgid "_SVCD"
 msgstr "_SVCD"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:783
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:162
 msgid "_DVD"
 msgstr "_DVD"
 
@@ -2200,8 +2259,8 @@
 msgid "Open Avidemux"
 msgstr "?? Avidemux"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/ADM_icons.cpp:228
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/ADM_icons.cpp:252
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/ADM_icons.cpp:230
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/ADM_icons.cpp:254
 #, c-format
 msgid "Couldn't find pixmap file: %s"
 msgstr "???????: %s"
@@ -2233,7 +2292,7 @@
 msgstr "??"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtersub.cpp:151
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:332
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:319
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_threshold.cpp:536
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_preview.cpp:175
 msgid "Preview"
@@ -2252,12 +2311,10 @@
 msgstr "??"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filterlist.cpp:125
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:286
 msgid "Interlacing"
 msgstr "??"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filterlist.cpp:150
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:310
 msgid "Colors"
 msgstr "??"
 
@@ -2272,7 +2329,6 @@
 msgstr "??/??"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filterlist.cpp:225
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:382
 msgid "Subtitles"
 msgstr "??"
 
@@ -2280,137 +2336,97 @@
 msgid "Miscellaneous"
 msgstr "????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:240
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:227
 msgid "The filter is already partial"
 msgstr "?????????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:338
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:340
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:325
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:327
 msgid "Load set of filters"
 msgstr "???????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:353
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:340
 msgid "Nothing to save"
 msgstr "??????????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:357
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:359
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:344
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager.cpp:346
 msgid "Save set of filters"
 msgstr "???????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:124
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:81
 msgid "Video Filter Manager"
 msgstr "???????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:146
-msgid "Open filter list [Ctrl-O]"
-msgstr "?????? [Ctrl-O]"
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:102
+msgid "<b>Available Filters</b>"
+msgstr "<b>?????</b>"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:155
-msgid "Save filter list [Ctrl-S]"
-msgstr "?????? [Ctrl-S]"
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:141
+msgid "VCD resolution"
+msgstr "VCD ???"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:163
-msgid "Save Script"
-msgstr "????"
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:146
+msgid "SVCD resolution"
+msgstr "SVCD ???"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:166
-msgid "Save as script [Ctrl-J]"
-msgstr "????? [Ctrl-J]"
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:151
+msgid "Half D1 resolution"
+msgstr "Half D1 ???"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:174
-msgid "DVD Res"
-msgstr "DVD ??"
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:156
+msgid "<sup>1</sup>/<sub>2</sub> D_1"
+msgstr "<sup>1</sup>/<sub>2</sub> D_1"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:177
-msgid "DVD resolution [Ctrl-1]"
-msgstr "DVD ??? [Ctrl-1]"
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:163
+msgid "DVD resolution"
+msgstr "DVD ???"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:185
-msgid "Half D1 Res"
-msgstr "Half D1 ??"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:188
-msgid "Half D1 resolution [Ctrl-2]"
-msgstr "Half D1 ??? [Ctrl-2]"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:196
-msgid "SVCD Res"
-msgstr "SVCD ??"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:199
-msgid "SVCD resolution [Ctrl-3]"
-msgstr "SVCD ??? [Ctrl-3]"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:207
-msgid "VCD Res"
-msgstr "VCD ??"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:210
-msgid "VCD resolution [Ctrl-4]"
-msgstr "VCD ??? [Ctrl-4]"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:261
-msgid "Transform"
-msgstr "??"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:334
-msgid "Noise"
-msgstr "??"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:358
-msgid "Sharpness"
-msgstr "???"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:406
-msgid "Misc"
-msgstr "??"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:417
-msgid "External"
-msgstr "???"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:428
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:187
 msgid "Add selected filter to the Active Filters list"
 msgstr "??????????????????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:434
-msgid "<b>Available Filters</b>"
-msgstr "<b>?????</b>"
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:193
+msgid "<b>Active Filters</b>"
+msgstr "<b >??????</b>"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:479
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:228
 msgid "Remove filter"
 msgstr "????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:488
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:237
 msgid "Move filter down"
 msgstr "????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:497
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:246
 msgid "Move filter up"
 msgstr "????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:503
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:255
+msgid "Open filter list"
+msgstr "??????"
+
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:264
+msgid "Save filter list"
+msgstr "??????"
+
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:270
 msgid "P_artial"
 msgstr "?? (_A)"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:506
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:273
 msgid "Apply the current filter only to a part of the file"
 msgstr "????????????????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:511
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:278
 msgid "Configure filter"
 msgstr "????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:521
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:288
 msgid "C_onfigure"
 msgstr "?? (_O)"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:525
-msgid "<b >Active Filters</b>"
-msgstr "<b >??????</b>"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:552
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters/gui_filtermanager_dialog.cpp:313
 msgid "_Preview"
 msgstr "?? (_P)"
 
@@ -2594,7 +2610,7 @@
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_resize.cpp:368
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_resize.cpp:390
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_resizeWiz.cpp:42
-#: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:326
+#: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:327
 #: plugins/ADM_videoFilters/AvisynthResize/gtk/gtk_resize.cpp:365
 #: plugins/ADM_videoFilters/AvisynthResize/gtk/gtk_resize.cpp:387
 #: plugins/ADM_videoFilters/MplayerResize/gtk/gtk_resize.cpp:365
@@ -2891,7 +2907,7 @@
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_encoding.cpp:585
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_encoding.cpp:782
-#: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:328
+#: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:329
 msgid "Unknown"
 msgstr "??"
 
@@ -3061,34 +3077,26 @@
 msgid "The idx/sub file does not set."
 msgstr "? idx/sub ?????"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:188
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:182
 msgid "VobSub Settings"
 msgstr "VobSub ??"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:205
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:199
 msgid "Select .idx"
 msgstr "?? .idx"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:219
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:213
 msgid "Select Language :"
 msgstr "???? :"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:233
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:227
 msgid "Select Sub"
 msgstr "?? Sub"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:246
-msgid "Extra Shrink Factor :"
-msgstr "???????:"
-
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:261
+#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:232
 msgid "Shift (ms) :"
 msgstr "?? (ms) :"
 
-#: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_vobsub.cpp:275
-msgid "Extra Settings"
-msgstr "?????"
-
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_about.cpp:33
 msgid "and all the others."
 msgstr "???????"
@@ -3789,7 +3797,7 @@
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_about.cpp:62
 msgid "translator-credits"
-msgstr "??? (Dong-Jun Wu) <ziyawu at gmail.com>"
+msgstr "Dongjun Wu (ziyawu at gmail.com)"
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_idx_pg.cpp:39
 msgid "Continue indexing"
@@ -3864,7 +3872,7 @@
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_properties.cpp:87
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_audioFilter.cpp:89
 #: plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp:212
-#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:286
+#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:290
 msgid "Mono"
 msgstr "??"
 
@@ -3872,7 +3880,7 @@
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_audioFilter.cpp:90
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp:277
 #: plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp:210
-#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:284
+#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:288
 msgid "Stereo"
 msgstr "???"
 
@@ -4011,91 +4019,59 @@
 msgid "Sure ?"
 msgstr "???"
 
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:126
-msgid "Video Codecs"
-msgstr "??????"
-
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:127
-msgid "Xvid"
-msgstr "Xvid"
-
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:128
-msgid "x264"
-msgstr "x264"
-
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:136
-msgid "aRts"
-msgstr "aRts"
-
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:137
-msgid "ESD"
-msgstr "ESD"
-
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:138
+#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:83
 msgid "Fontconfig"
 msgstr "Fontconfig"
 
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:139
+#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:84
 msgid "FreeType 2"
 msgstr "FreeType 2"
 
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:140
+#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:85
 msgid "Gettext"
 msgstr "Gettext"
 
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:141
-msgid "ALSA"
-msgstr "ALSA"
-
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:142
-msgid "OSS"
-msgstr "OSS"
-
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:143
+#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:86
 msgid "SDL"
 msgstr "SDL"
 
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:144
+#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:87
 msgid "XVideo"
 msgstr "XVideo"
 
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:146
+#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:89
 msgid "AltiVec"
 msgstr "AltiVec"
 
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:147
+#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:90
 msgid "PowerPC"
 msgstr "PowerPC"
 
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:148
+#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:91
 msgid "x86"
 msgstr "x86"
 
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:149
+#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:92
 msgid "x86-64"
 msgstr "x86-64"
 
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:156
-msgid "Codecs"
-msgstr "????"
-
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:157
+#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:99
 msgid "Libraries"
 msgstr "???"
 
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:158
+#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:100
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp:362
 msgid "CPU"
 msgstr "CPU"
 
-#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:162
+#: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp:104
 msgid "Built-in Support"
 msgstr "?????"
 
 #: avidemux/ADM_userInterfaces/ADM_commonUI/DIA_mjpeg.cpp:30
 #: plugins/ADM_videoFilters/Decimate/ADM_vidDecDec.cpp:184
 #: plugins/ADM_audioEncoders/vorbis/audioencoder_vorbis.cpp:320
-#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:317
+#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:323
 msgid "_Quality:"
 msgstr "?? (_Q):"
 
@@ -5015,9 +4991,9 @@
 "Do you want to load it  ?\n"
 "(It will be deleted in all cases, you should save it if you want to keep it)"
 msgstr ""
-"?????????\n"
+"?????????\n"
 "????? ?\n"
-"(????????????????????????)"
+"(???????????????????????)"
 
 #: avidemux/ADM_osSupport/ADM_misc.cpp:15
 #, c-format
@@ -5127,20 +5103,20 @@
 msgid "Only YV12/I420 or YUY2/I422 JPegs are supported"
 msgstr "??? YV12/I420 ? YUY2/I422 JPEG"
 
-#: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:321
+#: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:322
 msgid "NTSC 4:3"
 msgstr "NTSC 4:3"
 
-#: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:322
 #: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:323
+#: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:324
 msgid "NTSC 16:9"
 msgstr "NTSC 16:9"
 
-#: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:324
+#: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:325
 msgid "PAL 4:3"
 msgstr "PAL 4:3"
 
-#: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:325
+#: avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp:326
 msgid "PAL 16:9"
 msgstr "PAL 16:9"
 
@@ -5571,7 +5547,7 @@
 msgid "There are no jobs stored"
 msgstr "????????"
 
-#: avidemux/ADM_audiofilter/audiofilter_buildchain.cpp:290
+#: avidemux/ADM_audiofilter/audiofilter_buildchain.cpp:291
 msgid ""
 "The number of channels is greater than what the selected audio codec can do.\n"
 "Either change codec or use the mixer filter to have less channels."
@@ -5579,13 +5555,13 @@
 "????????????????????\n"
 "????????????????????????"
 
-#: avidemux/ADM_audiofilter/audiofilter_buildchain.cpp:301
+#: avidemux/ADM_audiofilter/audiofilter_buildchain.cpp:303
 msgid "[BuildChain] Encoder initialization failed"
 msgstr "[???] ????????"
 
-#: avidemux/ADM_audiofilter/audiofilter_buildchain.cpp:301
-msgid "Not activated."
-msgstr "?????"
+#: avidemux/ADM_audiofilter/audiofilter_buildchain.cpp:303
+msgid "Not activated, make sure number of channels and bitrate are compatible with encoder!"
+msgstr "???????????????????????"
 
 #: avidemux/ADM_coreUI/src/DIA_fileSel.cpp:142
 #, c-format
@@ -5715,20 +5691,18 @@
 msgstr "????????????"
 
 #: plugins/ADM_videoFilters/KeepField/ADM_vidHzStackField.cpp:33
-msgid "separatefields"
-msgstr "????"
+msgid "Horizontal Stack Field"
+msgstr "??????"
 
 #: plugins/ADM_videoFilters/KeepField/ADM_vidHzStackField.cpp:36
-msgid "Put botj fields side by side."
-msgstr "? botj ???????"
+msgid "Put both fields side by side."
+msgstr "??????????"
 
-#: plugins/ADM_videoFilters/KeepField/ADM_vidSeparateField.cpp:34
-#: plugins/ADM_videoFilters/Fade/ADM_vidFade.cpp:41
-#: plugins/ADM_videoFilters/Fade/ADM_vidFade.cpp:64
-msgid "Fade"
-msgstr "??"
+#: plugins/ADM_videoFilters/KeepField/ADM_vidSeparateField.cpp:32
+msgid "Separate Fields"
+msgstr "????"
 
-#: plugins/ADM_videoFilters/KeepField/ADM_vidSeparateField.cpp:37
+#: plugins/ADM_videoFilters/KeepField/ADM_vidSeparateField.cpp:35
 msgid "Each field becomes full picture, half sized."
 msgstr "?????????????????????"
 
@@ -5896,7 +5870,7 @@
 
 #: plugins/ADM_videoFilters/CNR2/gtk/DIA_cnr2.cpp:290
 msgid "Use also chroma to detect scene change"
-msgstr "????????????"
+msgstr "???????????"
 
 #: plugins/ADM_videoFilters/CNR2/gtk/DIA_cnr2.cpp:294
 msgid "<b>Mode</b>"
@@ -6100,7 +6074,7 @@
 msgstr "? Bach ???"
 
 #: plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deint.cpp:90
-#: plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deint.cpp:120
+#: plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deint.cpp:121
 msgid "libavcodec deinterlacer"
 msgstr "libavcodec ????"
 
@@ -6128,11 +6102,15 @@
 msgid "FFmpeg deint"
 msgstr "FFmpeg ???"
 
-#: plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deint.cpp:115
+#: plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deint.cpp:112
+msgid "Lowpass5 deint"
+msgstr "Lowpass5 ???"
+
+#: plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deint.cpp:116
 msgid "_Deinterlacing:"
 msgstr "??? (_D):"
 
-#: plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deint.cpp:116
+#: plugins/ADM_videoFilters/lavDeinterlace/ADM_lavpp_deint.cpp:117
 msgid "_Autolevel"
 msgstr "???? (_A)"
 
@@ -6669,11 +6647,11 @@
 
 #: plugins/ADM_videoFilters/Mosaic/ADM_vidMosaic.cpp:76
 msgid "_Horizontal stacking:"
-msgstr "???? (_H):"
+msgstr "???? (_H):"
 
 #: plugins/ADM_videoFilters/Mosaic/ADM_vidMosaic.cpp:77
 msgid "_Vertical stacking:"
-msgstr "???? (_V):"
+msgstr "???? (_V):"
 
 #: plugins/ADM_videoFilters/Mosaic/ADM_vidMosaic.cpp:78
 msgid "_Shrink factor:"
@@ -7243,8 +7221,8 @@
 msgstr "????:"
 
 #: plugins/ADM_videoFilters/ASharp/gtk/DIA_asharp.cpp:214
-msgid "Unknown flag :"
-msgstr "?????:"
+msgid "High Quality Block Filtering :"
+msgstr "??????? :"
 
 #: plugins/ADM_videoFilters/ASharp/ADM_vidAsharp.cpp:59
 msgid "asharp"
@@ -7254,20 +7232,20 @@
 msgid "Adaptative sharpener by MarcFD."
 msgstr "?????????? MarcFD?"
 
-#: plugins/ADM_videoFilters/FluxSmooth/ADM_vidFlux.cpp:56
-#: plugins/ADM_videoFilters/FluxSmooth/ADM_vidFlux.cpp:127
+#: plugins/ADM_videoFilters/FluxSmooth/ADM_vidFlux.cpp:55
+#: plugins/ADM_videoFilters/FluxSmooth/ADM_vidFlux.cpp:132
 msgid "FluxSmooth"
 msgstr "????"
 
-#: plugins/ADM_videoFilters/FluxSmooth/ADM_vidFlux.cpp:59
+#: plugins/ADM_videoFilters/FluxSmooth/ADM_vidFlux.cpp:58
 msgid "Spatio-temporal cleaner by Ross Thomas."
 msgstr "??-????????? Ross Thomas?"
 
-#: plugins/ADM_videoFilters/FluxSmooth/ADM_vidFlux.cpp:122
+#: plugins/ADM_videoFilters/FluxSmooth/ADM_vidFlux.cpp:127
 msgid "_Temporal threshold:"
 msgstr "????? (_T):"
 
-#: plugins/ADM_videoFilters/FluxSmooth/ADM_vidFlux.cpp:123
+#: plugins/ADM_videoFilters/FluxSmooth/ADM_vidFlux.cpp:128
 msgid "_Spatial threshold:"
 msgstr "????? (_S):"
 
@@ -7391,6 +7369,24 @@
 msgid "Convert picture to greyscale (black and white)."
 msgstr "??????? (?????)?"
 
+#: plugins/ADM_videoFilters/CurveEditor/ADM_vidCurveEditor.cpp:47
+msgid "Color Curve Editor"
+msgstr "???????"
+
+#: plugins/ADM_videoFilters/CurveEditor/ADM_vidCurveEditor.cpp:50
+msgid "Color adjustment by color curves in YUV color space."
+msgstr "? YUV ???????????????"
+
+#: plugins/ADM_videoFilters/CurveEditor/ADM_vidCurveEditor.cpp:151
+#, c-format
+msgid "Control points count: Y:%d, U:%d, V:%d"
+msgstr "????: Y:%d, U:%d, V:%d"
+
+#: plugins/ADM_videoFilters/Fade/ADM_vidFade.cpp:41
+#: plugins/ADM_videoFilters/Fade/ADM_vidFade.cpp:64
+msgid "Fade"
+msgstr "??"
+
 #: plugins/ADM_videoFilters/Fade/ADM_vidFade.cpp:44
 msgid "Fade in/out."
 msgstr "??/??"
@@ -7447,8 +7443,8 @@
 #: plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp:225
 #: plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp:226
 #: plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp:218
-#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:315
-#: plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp:268
+#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:321
+#: plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp:274
 msgid "_Bitrate:"
 msgstr "??? (_B):"
 
@@ -7458,17 +7454,17 @@
 
 #: plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp:231
 #: plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp:224
-#: plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp:274
+#: plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp:280
 msgid "Aften Configuration"
 msgstr "Aften ??"
 
 #: plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp:211
-#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:285
+#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:289
 msgid "Joint stereo"
 msgstr "?????"
 
 #: plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp:228
-#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:289
+#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:293
 msgid "C_hannel mode:"
 msgstr "????(_H):"
 
@@ -7476,83 +7472,63 @@
 msgid "TwoLame Configuration"
 msgstr "TwoLame ??"
 
-#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:293
+#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:297
 msgid "CBR"
 msgstr "CBR"
 
-#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:294
+#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:298
 msgid "ABR"
 msgstr "ABR"
 
-#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:296
+#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:300
 msgid "Extreme"
 msgstr "??"
 
-#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:299
+#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:303
 msgid "Bit_rate mode:"
 msgstr "????? (_R):"
 
-#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:319
+#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:325
 msgid "_Disable reservoir"
 msgstr "????? (_D)"
 
-#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:323
+#: plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp:329
 msgid "LAME Configuration"
 msgstr "LAME ??"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:112
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:192
-msgid "<default>"
-msgstr "<??>"
-
-#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:113
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:193
-msgid "<custom>"
-msgstr "<??>"
-
-#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:211
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:321
-msgid "Save As"
-msgstr "??"
-
-#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:211
+#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:215
 msgid "Xvid Configuration File (*.xml)"
 msgstr "Xvid ??? (*.xml)"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:242
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:355
-msgid "Are you sure you wish to delete the selected configuration?"
-msgstr "?????????? ?"
-
-#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:262
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:373
+#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:269
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:378
 msgid "Target Bitrate:"
 msgstr "?????:"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:263
-#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:283
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:374
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:392
+#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:270
+#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:290
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:379
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:397
 msgid "kbit/s"
 msgstr "kbit/s"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:269
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:378
+#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:276
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:383
 msgid "Quantiser:"
 msgstr "???:"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:275
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:386
+#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:282
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:391
 msgid "Target Video Size:"
 msgstr "??????:"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:276
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:387
+#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:283
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:392
 msgid "MB"
 msgstr "MB"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:282
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:391
+#: plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp:289
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:396
 msgid "Average Bitrate:"
 msgstr "?????:"
 
@@ -7581,32 +7557,34 @@
 msgid "Bitrate Factor"
 msgstr "?????"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:82
-msgid "Hadamard Exhaustive Search"
-msgstr "????????"
-
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:87
-msgid "9 (Best)"
-msgstr "9 (??)"
-
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:107
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:113
 msgid "Disabled"
 msgstr "???"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:108
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:114
 msgid "Enabled"
 msgstr "???"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:321
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:326
 msgid "x264 Configuration File (*.xml)"
 msgstr "x264 ??? (*.xml)"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:382
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:387
 msgid "Quality:"
 msgstr "??:"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:472
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:435
 msgid ""
+"Macroblock-Tree optimisation requires Variance Adaptive Quantisation to be enabled.  Variance Adaptive Quantisation will automatically be enabled.\n"
+"\n"
+"Do you wish to continue?"
+msgstr ""
+"???-?? (Macroblock-Tree) ??????????????? (Variance Adaptive Quantisation)????????????????\n"
+"\n"
+"???????"
+
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:481
+msgid ""
 "Trellis optimisation isn't possible without CABAC coding enabled.  Trellis optimisation will automatically be disabled.\n"
 "\n"
 " Do you wish to continue?"
@@ -7615,7 +7593,7 @@
 "\n"
 " ???????"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:482
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:491
 msgid ""
 "Trellis optimisation requires CABAC coding to be enabled.  CABAC coding will automatically be enabled.\n"
 "\n"
@@ -7625,7 +7603,17 @@
 "\n"
 "???????"
 
-#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:515
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:513
+msgid ""
+"Macroblock-Tree optimisation requires Variance Adaptive Quantisation to be enabled.  Macroblock-Tree optimisation will automatically be disabled.\n"
+"\n"
+"Do you wish to continue?"
+msgstr ""
+"???-?? (Macroblock-Tree) ??????????????? (Variance Adaptive Quantisation)??????????-??????\n"
+"\n"
+" ???????"
+
+#: plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp:537
 msgid "Are you sure you wish to delete the selected zone?"
 msgstr "??????????? ?"
 
@@ -7645,6 +7633,56 @@
 msgid "Value"
 msgstr "??"
 
+#~ msgid "Extra Shrink Factor :"
+#~ msgstr "???????:"
+#~ msgid "Extra Settings"
+#~ msgstr "?????"
+#~ msgid "Hadamard Exhaustive Search"
+#~ msgstr "????????"
+#~ msgid "9 (Best)"
+#~ msgstr "9 (??)"
+#~ msgid "Not activated."
+#~ msgstr "?????"
+#~ msgid "Save Script"
+#~ msgstr "????"
+#~ msgid "Save as script [Ctrl-J]"
+#~ msgstr "????? [Ctrl-J]"
+#~ msgid "DVD Res"
+#~ msgstr "DVD ??"
+#~ msgid "Half D1 Res"
+#~ msgstr "Half D1 ??"
+#~ msgid "SVCD Res"
+#~ msgstr "SVCD ??"
+#~ msgid "VCD Res"
+#~ msgstr "VCD ??"
+#~ msgid "Transform"
+#~ msgstr "??"
+#~ msgid "Noise"
+#~ msgstr "??"
+#~ msgid "Sharpness"
+#~ msgstr "???"
+#~ msgid "Misc"
+#~ msgstr "??"
+#~ msgid "External"
+#~ msgstr "???"
+#~ msgid "Unknown flag :"
+#~ msgstr "?????:"
+#~ msgid "Video Codecs"
+#~ msgstr "??????"
+#~ msgid "Xvid"
+#~ msgstr "Xvid"
+#~ msgid "x264"
+#~ msgstr "x264"
+#~ msgid "aRts"
+#~ msgstr "aRts"
+#~ msgid "ESD"
+#~ msgstr "ESD"
+#~ msgid "ALSA"
+#~ msgstr "ALSA"
+#~ msgid "OSS"
+#~ msgstr "OSS"
+#~ msgid "Codecs"
+#~ msgstr "????"
 #~ msgid "DivX"
 #~ msgstr "DivX"
 #~ msgid "DV (lavc)"



From mean at mail.berlios.de  Fri Dec 11 11:14:15 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 11:14:15 +0100
Subject: [Avidemux-svn-commit] r5637 -
	branches/avidemux_2.6_branch_mean/autononreg/dialogFactory
Message-ID: <200912111014.nBBAEFYE024110@sheep.berlios.de>

Author: mean
Date: 2009-12-11 11:14:15 +0100 (Fri, 11 Dec 2009)
New Revision: 5637

Modified:
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/bar.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/binhex.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/bitrate.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/button.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/dirsel.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/fileread.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/float.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/frame.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/hex.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/integer.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/matrix.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/menu.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/notch.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/readonlytext.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/slider.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/tabs.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/text.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/threadcount.js
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/toggle.js
Log:
[js] update factory test

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/bar.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/bar.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/bar.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,7 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
+print("Testing factory bar");
+	admTestFacBar();
+print("/Testing factory bar");
 
-	dialogFactoryBar();
-
 /* End of test
 */

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/binhex.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/binhex.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/binhex.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,6 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryHex();
-
+print("Testing factory Hex");
+	admTestFacHex();
+print("Testing factory Hex");
 /* End of test
 */

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/bitrate.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/bitrate.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/bitrate.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,6 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryBitrate();
-
+print("Testing factory Bitrate");
+	admTestFacBitrate();
+print("Testing factory Bitrate");
 /* End of test
 */

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/button.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/button.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/button.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,4 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryButton();
-
-/* End of test
-*/
+print("Testing factory Button");
+	admTestFacButton();
+print("Testing factory Button");

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/dirsel.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/dirsel.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/dirsel.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,7 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
+print("Testing factory DirSel");
+	admTestFacDirSel();
+print("Testing factory DirSel");
 
-	dialogFactoryDirSel();
-
 /* End of test
 */

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/fileread.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/fileread.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/fileread.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,6 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryFileSel();
-
+print("Testing factory FileSel");
+	admTestFacFile();
+print("Testing factory FileSel");
 /* End of test
 */

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/float.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/float.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/float.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,6 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryFloat();
-
+print("Testing factory Float");
+	admTestFacFloat();
+print("Testing factory Float");
 /* End of test
 */

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/frame.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/frame.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/frame.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,4 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryFrame();
-
-/* End of test
-*/
+print("Testing factory Frame");
+	admTestFacFrame();
+print("Testing factory Frame");

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/hex.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/hex.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/hex.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,4 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryHex();
-
-/* End of test
-*/
+print("Testing factory hex");
+	admTestFacHex();
+print("Testing factory hex");

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/integer.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/integer.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/integer.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,6 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryInt();
-
+print("Testing factory int");
+	admTestFacInt();
+print("Testing factory int");
 /* End of test
 */

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/matrix.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/matrix.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/matrix.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,4 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryMatrix();
-
-/* End of test
-*/
+print("Testing factory Matrix");
+	admTestFacMatrix();
+print("Testing factory Matrix");

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/menu.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/menu.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/menu.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,6 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryMenu();
-
+print("Testing factory Menu");
+	admTestFacMenu();
+print("Testing factory Menu");
 /* End of test
 */

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/notch.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/notch.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/notch.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,6 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryNotch();
-
+print("Testing factory Notch");
+	admTestFacNotch();
+print("Testing factory Notch");
 /* End of test
 */

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/readonlytext.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/readonlytext.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/readonlytext.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,6 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryRoText();
-
+print("Testing factory RoTexy");
+	admTestFacRoText();
+print("Testing factory RoText");
 /* End of test
 */

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/slider.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/slider.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/slider.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,4 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactorySlider();
-
-/* End of test
-*/
+print("Testing factory Slider");
+	admTestFacSlider();
+print("Testing factory Slider");

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/tabs.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/tabs.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/tabs.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,6 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryTabs();
-
+print("Testing factory Tabs");
+	admTestFacTab();
+print("Testing factory Tabs");
 /* End of test
 */

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/text.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/text.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/text.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,6 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryText();
-
+print("Testing factory Text");
+	admTestFacText();
+print("Testing factory Text");
 /* End of test
 */

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/threadcount.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/threadcount.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/threadcount.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,4 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryThreadCount();
-
-/* End of test
-*/
+print("Testing factory ThreadCount");
+	admTestFacThreadCount();
+print("Testing factory ThreadCount");

Modified: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/toggle.js
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/toggle.js	2009-12-10 19:12:12 UTC (rev 5636)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/toggle.js	2009-12-11 10:14:15 UTC (rev 5637)
@@ -1,10 +1,4 @@
 //AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
-var app = new Avidemux();
-var file="/work/samples/2mn.avi";
-var goodfcc="DIV3";
-var fps;
-
-	dialogFactoryToggle();
-
-/* End of test
-*/
+print("Testing factory Toggle");
+	admTestFacToggle();
+print("Testing factory Toggle");



From mean at mail.berlios.de  Fri Dec 11 11:14:18 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 11:14:18 +0100
Subject: [Avidemux-svn-commit] r5638 - in
	branches/avidemux_2.6_branch_mean/avidemux/common: . ADM_toolkit
Message-ID: <200912111014.nBBAEIgd024120@sheep.berlios.de>

Author: mean
Date: 2009-12-11 11:14:17 +0100 (Fri, 11 Dec 2009)
New Revision: 5638

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/A_functions.h
   branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/gtkgui.h
Log:
[Main] Shuffle headers

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp	2009-12-11 10:14:15 UTC (rev 5637)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp	2009-12-11 10:14:17 UTC (rev 5638)
@@ -33,6 +33,7 @@
 #include "gui_action.hxx"
 #include "prefs.h"
 #include "gtkgui.h"
+#include "A_functions.h"
 
 
 #include "ADM_debugID.h"
@@ -56,10 +57,8 @@
 extern void A_saveAudioProcessed(char *name);
 extern uint8_t A_SaveAudioNVideo(char *name);
 extern void GUI_Quiet( void);
-extern bool A_parseECMAScript(const char *name);
 extern void GUI_Verbose( void);
 extern void audioFilter_SetBitrate( int i);
-extern void A_Save(const char *name);
 extern void videoCodecSelectByName(const char *name);
 extern int videoCodecConfigure(char *p,uint32_t i, uint8_t  *c);
 extern void updateLoaded( void );

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/A_functions.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/A_functions.h	2009-12-11 10:14:15 UTC (rev 5637)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/A_functions.h	2009-12-11 10:14:17 UTC (rev 5638)
@@ -19,12 +19,17 @@
 void    A_audioTrack(void);
 int     A_Save(const char *name);
 int     A_SaveWrapper( char *name);
-void    A_parseECMAScript(const char *name);
-uint8_t A_autoDrive(Action action);
+bool    A_parseECMAScript(const char *name);
+//uint8_t A_autoDrive(Action action);
 uint8_t A_TimeShift(void);
 void    A_ResetMarkers(void);
 void    A_Rewind(void);
 void    A_jog(void);
 uint8_t A_jumpToTime(uint32_t hh,uint32_t mm,uint32_t ss,uint32_t ms);
+int 			A_openAvi		(const char *name);
+void 			A_saveAudio	(char *name);
+void 			A_saveAudioDecoded	(char *name);
+void 			A_saveAVI		(char *name);
+void 			A_playAvi		(void);
 
 #endif
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2009-12-11 10:14:15 UTC (rev 5637)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2009-12-11 10:14:17 UTC (rev 5638)
@@ -863,7 +863,7 @@
 
 
 
-void A_parseECMAScript(const char *name){
+bool A_parseECMAScript(const char *name){
   bool ret;
   char *longname = ADM_PathCanonize(name);
    if (playing){
@@ -874,8 +874,10 @@
       if( actual_workbench_file )
          ADM_dealloc(actual_workbench_file);
       actual_workbench_file = ADM_strdup(longname);
+      
    }
    ADM_dealloc(longname);
+   return ret;
 }
 
 /*

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gtkgui.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gtkgui.h	2009-12-11 10:14:15 UTC (rev 5637)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gtkgui.h	2009-12-11 10:14:17 UTC (rev 5638)
@@ -15,11 +15,6 @@
  *                                                                         *
  ***************************************************************************/
 
-int 			A_openAvi		(const char *name);
-void 			A_saveAudio	(char *name);
-void 			A_saveAudioDecoded	(char *name);
-void 			A_saveAVI		(char *name);
-void 			A_playAvi		(void);
 void 			GUI_setCurrentFrameAndTime(void );
 void 			GUI_setAllFrameAndTime(void );
 



From mean at mail.berlios.de  Fri Dec 11 11:14:19 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 11:14:19 +0100
Subject: [Avidemux-svn-commit] r5639 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src
Message-ID: <200912111014.nBBAEJKS024130@sheep.berlios.de>

Author: mean
Date: 2009-12-11 11:14:19 +0100 (Fri, 11 Dec 2009)
New Revision: 5639

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl
Log:
[js] Fix admTestFac** js functions

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory.cpp	2009-12-11 10:14:17 UTC (rev 5638)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory.cpp	2009-12-11 10:14:19 UTC (rev 5639)
@@ -24,7 +24,7 @@
     \fn crashTest
     \brief Force a crash
 */
-bool jsTestCrash(void)
+int jsTestCrash(void)
 {
   
   int *foobar=NULL;
@@ -35,7 +35,7 @@
     \fn assertTest
     \brief Force a crash
 */
-bool jsTestAssert(void)
+int jsTestAssert(void)
 {
   
   ADM_assert(0);
@@ -46,7 +46,7 @@
 /**
     \fn jsTestFacInt
 */
-bool jsTestFacInt(void)
+int jsTestFacInt(void)
 {
   uint32_t tog=0;
    diaElemUInteger blend(&tog,QT_TR_NOOP("Uinteger"),0,255);
@@ -63,7 +63,7 @@
 /**
     \fn jsTestFacFloat
 */
-bool jsTestFacFloat(void)
+int jsTestFacFloat(void)
 {
   ELEM_TYPE_FLOAT tog=0;
    diaElemFloat blend(&tog,QT_TR_NOOP("Float"),0,255);
@@ -80,7 +80,7 @@
 /**
     \fn jsTestFacToggle
 */
-bool jsTestFacToggle(void)
+int jsTestFacToggle(void)
 {
   uint32_t tog=0;
   uint32_t test=0;
@@ -102,7 +102,7 @@
 /**
     \fn jsTestFacMenu
 */
-bool jsTestFacMenu(void)
+int jsTestFacMenu(void)
 {
    uint32_t tog=4;
    ELEM_TYPE_FLOAT f=1; 
@@ -131,7 +131,7 @@
 /**
     \fn jsTestFacFile
 */
-bool jsTestFacFile(void)
+int jsTestFacFile(void)
 {
    uint32_t tog=0;
    char *test=ADM_strdup("Entry test1");
@@ -151,7 +151,7 @@
 /**
     \fn jsTestFacDirSel
 */
-bool jsTestFacDirSel(void)
+int jsTestFacDirSel(void)
 {
    uint32_t tog=0;
    char *test=ADM_strdup("Entry test1");
@@ -171,7 +171,7 @@
 /**
     \fn jsTestFacBitrate
 */
-bool jsTestFacBitrate(void)
+int jsTestFacBitrate(void)
 {
 
    COMPRES_PARAMS test={
@@ -196,7 +196,7 @@
 /**
     \fn jsTestFacInt
 */
-bool jsTestFacBar(void)
+int jsTestFacBar(void)
 {
     
       diaElemBar bar1(25,"25");
@@ -217,7 +217,7 @@
 /**
     \fn jsTestFacButton
 */
-bool jsTestFacButton(void)
+int jsTestFacButton(void)
 {
     
       diaElemButton bar1("Button",clickMe,NULL);
@@ -232,7 +232,7 @@
 /**
     \fn jsTestFacSlider
 */
-bool jsTestFacSlider(void)
+int jsTestFacSlider(void)
 {
   int32_t val=4;
       diaElemSlider slide(&val,"foo", 0,10);
@@ -249,7 +249,7 @@
 /**
     \fn jsTestFacInt
 */
-bool jsTestFacRoText(void)
+int jsTestFacRoText(void)
 
 {
     
@@ -266,7 +266,7 @@
 /**
     \fn jsTestFacText
 */
-bool jsTestFacText(void)
+int jsTestFacText(void)
 {
     
       char *foo=ADM_strdup("blah");
@@ -286,7 +286,7 @@
 /**
     \fn jsTestFacInt
 */
-bool jsTestFacTab(void)
+int jsTestFacTab(void)
 {
     
       uint32_t test,test2;
@@ -315,7 +315,7 @@
 /**
     \fn jsTestFacInt
 */
-bool jsTestFacFrame(void)
+int jsTestFacFrame(void)
 {
     
       uint32_t test,test2;
@@ -342,7 +342,7 @@
 /**
     \fn jsTestFacHex
 */
-bool jsTestFacHex(void)
+int jsTestFacHex(void)
 {
     
       uint8_t data[100];
@@ -363,7 +363,7 @@
 /**
     \fn jsTestFacMatrix
 */
-bool jsTestFacMatrix(void)
+int jsTestFacMatrix(void)
 {
     
       uint8_t data[16];
@@ -389,7 +389,7 @@
 /**
     \fn jsTestFacThreadcount
 */
-bool jsTestFacThreadCount(void)
+int jsTestFacThreadCount(void)
 {
 	uint32_t val=1;
 	diaElemThreadCount threadcount(&val,"ThreadCount");
@@ -407,7 +407,7 @@
 /**
     \fn jsTestFacNotch
 */
-bool jsTestFacNotch(void)
+int jsTestFacNotch(void)
 {
     
 	diaElemNotch notch(1,"Notch");

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c	2009-12-11 10:14:17 UTC (rev 5638)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.c	2009-12-11 10:14:19 UTC (rev 5639)
@@ -34,72 +34,22 @@
 jjadmTestFacInt(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var2;
-    void *var3;
+    int var3;
     int var6;
     jsval var7;
-    JSObject *var8;
-    JSObject *var9;
-    JSClass *var10;
-    char *var12;
-    JSBool var14;
-    jsval var15;
-    JSObject *var16;
-    jsval var373;
-    char *var20;
-    JSBool var17;
-    jsval var18;
-    JSObject *var19;
-    jsval var374;
-    JSObject *var11;
-    jsval var375;
     JSBool var1;
     var2 = NULL;
-    var3 = NULL;
+    var3 = 0;
     var6 = 0;
     var7 = JSVAL_NULL;
-    var8 = NULL;
-    var9 = NULL;
-    var10 = NULL;
-    var12 = NULL;
-    var14 = JS_FALSE;
-    var15 = JSVAL_NULL;
-    var16 = NULL;
-    var373 = JSVAL_NULL;
-    var20 = NULL;
-    var17 = JS_FALSE;
-    var18 = JSVAL_NULL;
-    var19 = NULL;
-    var374 = JSVAL_NULL;
-    var11 = NULL;
-    var375 = JSVAL_NULL;
     var1 = JS_FALSE;
     var2 = obj;
     var6 = argc;
     var3 = jsTestFacInt();
-    var9 = JS_GetGlobalObject(cx);
-    var12 = "bool";
-    var14 = JS_GetProperty(cx, var9, var12, &var15);
-    if (JS_ValueToObject(cx, var15, &var16) != JS_TRUE) {
+    if (JS_NewNumberValue(cx, var3, &var7) != JS_TRUE) {
         goto do_return;
     }
-    var373 = OBJECT_TO_JSVAL(var16);
-    argv[argc+0] = var373;
-    var20 = "prototype";
-    var17 = JS_GetProperty(cx, var16, var20, &var18);
-    if (JS_ValueToObject(cx, var18, &var19) != JS_TRUE) {
-        goto do_return;
-    }
-    var374 = OBJECT_TO_JSVAL(var19);
-    argv[argc+1] = var374;
-    var10 = JS_GET_CLASS(cx, var19);
-    var11 = NULL;
-    var8 = JS_NewObject(cx, var10, var11, var9);
-    var375 = OBJECT_TO_JSVAL(var8);
-    argv[argc+2] = var375;
-    if (JS_SetPrivate(cx, var8, var3) != JS_TRUE) {
-        goto do_return;
-    }
-    var7 = OBJECT_TO_JSVAL(var8);
+    argv[argc+0] = var7;
     if (rval) {
         *rval = var7;
     }
@@ -110,1341 +60,491 @@
 static JSBool
 jjadmTestFacFloat(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var22;
-    void *var23;
-    int var26;
-    jsval var27;
-    JSObject *var28;
-    JSObject *var29;
-    JSClass *var30;
-    char *var32;
-    JSBool var34;
-    jsval var35;
-    JSObject *var36;
-    jsval var376;
-    char *var40;
-    JSBool var37;
-    jsval var38;
-    JSObject *var39;
-    jsval var377;
-    JSObject *var31;
-    jsval var378;
-    JSBool var21;
-    var22 = NULL;
-    var23 = NULL;
-    var26 = 0;
-    var27 = JSVAL_NULL;
-    var28 = NULL;
-    var29 = NULL;
-    var30 = NULL;
-    var32 = NULL;
-    var34 = JS_FALSE;
-    var35 = JSVAL_NULL;
-    var36 = NULL;
-    var376 = JSVAL_NULL;
-    var40 = NULL;
-    var37 = JS_FALSE;
-    var38 = JSVAL_NULL;
-    var39 = NULL;
-    var377 = JSVAL_NULL;
-    var31 = NULL;
-    var378 = JSVAL_NULL;
-    var21 = JS_FALSE;
-    var22 = obj;
-    var26 = argc;
-    var23 = jsTestFacFloat();
-    var29 = JS_GetGlobalObject(cx);
-    var32 = "bool";
-    var34 = JS_GetProperty(cx, var29, var32, &var35);
-    if (JS_ValueToObject(cx, var35, &var36) != JS_TRUE) {
+    JSObject *var9;
+    int var10;
+    int var13;
+    jsval var14;
+    JSBool var8;
+    var9 = NULL;
+    var10 = 0;
+    var13 = 0;
+    var14 = JSVAL_NULL;
+    var8 = JS_FALSE;
+    var9 = obj;
+    var13 = argc;
+    var10 = jsTestFacFloat();
+    if (JS_NewNumberValue(cx, var10, &var14) != JS_TRUE) {
         goto do_return;
     }
-    var376 = OBJECT_TO_JSVAL(var36);
-    argv[argc+0] = var376;
-    var40 = "prototype";
-    var37 = JS_GetProperty(cx, var36, var40, &var38);
-    if (JS_ValueToObject(cx, var38, &var39) != JS_TRUE) {
-        goto do_return;
-    }
-    var377 = OBJECT_TO_JSVAL(var39);
-    argv[argc+1] = var377;
-    var30 = JS_GET_CLASS(cx, var39);
-    var31 = NULL;
-    var28 = JS_NewObject(cx, var30, var31, var29);
-    var378 = OBJECT_TO_JSVAL(var28);
-    argv[argc+2] = var378;
-    if (JS_SetPrivate(cx, var28, var23) != JS_TRUE) {
-        goto do_return;
-    }
-    var27 = OBJECT_TO_JSVAL(var28);
+    argv[argc+0] = var14;
     if (rval) {
-        *rval = var27;
+        *rval = var14;
     }
-    var21 = JS_TRUE;
+    var8 = JS_TRUE;
     do_return:
-    return var21;
+    return var8;
 }
 static JSBool
 jjadmTestFacToggle(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var42;
-    void *var43;
-    int var46;
-    jsval var47;
-    JSObject *var48;
-    JSObject *var49;
-    JSClass *var50;
-    char *var52;
-    JSBool var54;
-    jsval var55;
-    JSObject *var56;
-    jsval var379;
-    char *var60;
-    JSBool var57;
-    jsval var58;
-    JSObject *var59;
-    jsval var380;
-    JSObject *var51;
-    jsval var381;
-    JSBool var41;
-    var42 = NULL;
-    var43 = NULL;
-    var46 = 0;
-    var47 = JSVAL_NULL;
-    var48 = NULL;
-    var49 = NULL;
-    var50 = NULL;
-    var52 = NULL;
-    var54 = JS_FALSE;
-    var55 = JSVAL_NULL;
-    var56 = NULL;
-    var379 = JSVAL_NULL;
-    var60 = NULL;
-    var57 = JS_FALSE;
-    var58 = JSVAL_NULL;
-    var59 = NULL;
-    var380 = JSVAL_NULL;
-    var51 = NULL;
-    var381 = JSVAL_NULL;
-    var41 = JS_FALSE;
-    var42 = obj;
-    var46 = argc;
-    var43 = jsTestFacToggle();
-    var49 = JS_GetGlobalObject(cx);
-    var52 = "bool";
-    var54 = JS_GetProperty(cx, var49, var52, &var55);
-    if (JS_ValueToObject(cx, var55, &var56) != JS_TRUE) {
+    JSObject *var16;
+    int var17;
+    int var20;
+    jsval var21;
+    JSBool var15;
+    var16 = NULL;
+    var17 = 0;
+    var20 = 0;
+    var21 = JSVAL_NULL;
+    var15 = JS_FALSE;
+    var16 = obj;
+    var20 = argc;
+    var17 = jsTestFacToggle();
+    if (JS_NewNumberValue(cx, var17, &var21) != JS_TRUE) {
         goto do_return;
     }
-    var379 = OBJECT_TO_JSVAL(var56);
-    argv[argc+0] = var379;
-    var60 = "prototype";
-    var57 = JS_GetProperty(cx, var56, var60, &var58);
-    if (JS_ValueToObject(cx, var58, &var59) != JS_TRUE) {
-        goto do_return;
-    }
-    var380 = OBJECT_TO_JSVAL(var59);
-    argv[argc+1] = var380;
-    var50 = JS_GET_CLASS(cx, var59);
-    var51 = NULL;
-    var48 = JS_NewObject(cx, var50, var51, var49);
-    var381 = OBJECT_TO_JSVAL(var48);
-    argv[argc+2] = var381;
-    if (JS_SetPrivate(cx, var48, var43) != JS_TRUE) {
-        goto do_return;
-    }
-    var47 = OBJECT_TO_JSVAL(var48);
+    argv[argc+0] = var21;
     if (rval) {
-        *rval = var47;
+        *rval = var21;
     }
-    var41 = JS_TRUE;
+    var15 = JS_TRUE;
     do_return:
-    return var41;
+    return var15;
 }
 static JSBool
 jjadmTestFacMenu(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var62;
-    void *var63;
-    int var66;
-    jsval var67;
-    JSObject *var68;
-    JSObject *var69;
-    JSClass *var70;
-    char *var72;
-    JSBool var74;
-    jsval var75;
-    JSObject *var76;
-    jsval var382;
-    char *var80;
-    JSBool var77;
-    jsval var78;
-    JSObject *var79;
-    jsval var383;
-    JSObject *var71;
-    jsval var384;
-    JSBool var61;
-    var62 = NULL;
-    var63 = NULL;
-    var66 = 0;
-    var67 = JSVAL_NULL;
-    var68 = NULL;
-    var69 = NULL;
-    var70 = NULL;
-    var72 = NULL;
-    var74 = JS_FALSE;
-    var75 = JSVAL_NULL;
-    var76 = NULL;
-    var382 = JSVAL_NULL;
-    var80 = NULL;
-    var77 = JS_FALSE;
-    var78 = JSVAL_NULL;
-    var79 = NULL;
-    var383 = JSVAL_NULL;
-    var71 = NULL;
-    var384 = JSVAL_NULL;
-    var61 = JS_FALSE;
-    var62 = obj;
-    var66 = argc;
-    var63 = jsTestFacMenu();
-    var69 = JS_GetGlobalObject(cx);
-    var72 = "bool";
-    var74 = JS_GetProperty(cx, var69, var72, &var75);
-    if (JS_ValueToObject(cx, var75, &var76) != JS_TRUE) {
+    JSObject *var23;
+    int var24;
+    int var27;
+    jsval var28;
+    JSBool var22;
+    var23 = NULL;
+    var24 = 0;
+    var27 = 0;
+    var28 = JSVAL_NULL;
+    var22 = JS_FALSE;
+    var23 = obj;
+    var27 = argc;
+    var24 = jsTestFacMenu();
+    if (JS_NewNumberValue(cx, var24, &var28) != JS_TRUE) {
         goto do_return;
     }
-    var382 = OBJECT_TO_JSVAL(var76);
-    argv[argc+0] = var382;
-    var80 = "prototype";
-    var77 = JS_GetProperty(cx, var76, var80, &var78);
-    if (JS_ValueToObject(cx, var78, &var79) != JS_TRUE) {
-        goto do_return;
-    }
-    var383 = OBJECT_TO_JSVAL(var79);
-    argv[argc+1] = var383;
-    var70 = JS_GET_CLASS(cx, var79);
-    var71 = NULL;
-    var68 = JS_NewObject(cx, var70, var71, var69);
-    var384 = OBJECT_TO_JSVAL(var68);
-    argv[argc+2] = var384;
-    if (JS_SetPrivate(cx, var68, var63) != JS_TRUE) {
-        goto do_return;
-    }
-    var67 = OBJECT_TO_JSVAL(var68);
+    argv[argc+0] = var28;
     if (rval) {
-        *rval = var67;
+        *rval = var28;
     }
-    var61 = JS_TRUE;
+    var22 = JS_TRUE;
     do_return:
-    return var61;
+    return var22;
 }
 static JSBool
 jjadmTestFacFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var82;
-    void *var83;
-    int var86;
-    jsval var87;
-    JSObject *var88;
-    JSObject *var89;
-    JSClass *var90;
-    char *var92;
-    JSBool var94;
-    jsval var95;
-    JSObject *var96;
-    jsval var385;
-    char *var100;
-    JSBool var97;
-    jsval var98;
-    JSObject *var99;
-    jsval var386;
-    JSObject *var91;
-    jsval var387;
-    JSBool var81;
-    var82 = NULL;
-    var83 = NULL;
-    var86 = 0;
-    var87 = JSVAL_NULL;
-    var88 = NULL;
-    var89 = NULL;
-    var90 = NULL;
-    var92 = NULL;
-    var94 = JS_FALSE;
-    var95 = JSVAL_NULL;
-    var96 = NULL;
-    var385 = JSVAL_NULL;
-    var100 = NULL;
-    var97 = JS_FALSE;
-    var98 = JSVAL_NULL;
-    var99 = NULL;
-    var386 = JSVAL_NULL;
-    var91 = NULL;
-    var387 = JSVAL_NULL;
-    var81 = JS_FALSE;
-    var82 = obj;
-    var86 = argc;
-    var83 = jsTestFacFile();
-    var89 = JS_GetGlobalObject(cx);
-    var92 = "bool";
-    var94 = JS_GetProperty(cx, var89, var92, &var95);
-    if (JS_ValueToObject(cx, var95, &var96) != JS_TRUE) {
+    JSObject *var30;
+    int var31;
+    int var34;
+    jsval var35;
+    JSBool var29;
+    var30 = NULL;
+    var31 = 0;
+    var34 = 0;
+    var35 = JSVAL_NULL;
+    var29 = JS_FALSE;
+    var30 = obj;
+    var34 = argc;
+    var31 = jsTestFacFile();
+    if (JS_NewNumberValue(cx, var31, &var35) != JS_TRUE) {
         goto do_return;
     }
-    var385 = OBJECT_TO_JSVAL(var96);
-    argv[argc+0] = var385;
-    var100 = "prototype";
-    var97 = JS_GetProperty(cx, var96, var100, &var98);
-    if (JS_ValueToObject(cx, var98, &var99) != JS_TRUE) {
-        goto do_return;
-    }
-    var386 = OBJECT_TO_JSVAL(var99);
-    argv[argc+1] = var386;
-    var90 = JS_GET_CLASS(cx, var99);
-    var91 = NULL;
-    var88 = JS_NewObject(cx, var90, var91, var89);
-    var387 = OBJECT_TO_JSVAL(var88);
-    argv[argc+2] = var387;
-    if (JS_SetPrivate(cx, var88, var83) != JS_TRUE) {
-        goto do_return;
-    }
-    var87 = OBJECT_TO_JSVAL(var88);
+    argv[argc+0] = var35;
     if (rval) {
-        *rval = var87;
+        *rval = var35;
     }
-    var81 = JS_TRUE;
+    var29 = JS_TRUE;
     do_return:
-    return var81;
+    return var29;
 }
 static JSBool
 jjadmTestFacBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var102;
-    void *var103;
-    int var106;
-    jsval var107;
-    JSObject *var108;
-    JSObject *var109;
-    JSClass *var110;
-    char *var112;
-    JSBool var114;
-    jsval var115;
-    JSObject *var116;
-    jsval var388;
-    char *var120;
-    JSBool var117;
-    jsval var118;
-    JSObject *var119;
-    jsval var389;
-    JSObject *var111;
-    jsval var390;
-    JSBool var101;
-    var102 = NULL;
-    var103 = NULL;
-    var106 = 0;
-    var107 = JSVAL_NULL;
-    var108 = NULL;
-    var109 = NULL;
-    var110 = NULL;
-    var112 = NULL;
-    var114 = JS_FALSE;
-    var115 = JSVAL_NULL;
-    var116 = NULL;
-    var388 = JSVAL_NULL;
-    var120 = NULL;
-    var117 = JS_FALSE;
-    var118 = JSVAL_NULL;
-    var119 = NULL;
-    var389 = JSVAL_NULL;
-    var111 = NULL;
-    var390 = JSVAL_NULL;
-    var101 = JS_FALSE;
-    var102 = obj;
-    var106 = argc;
-    var103 = jsTestFacBitrate();
-    var109 = JS_GetGlobalObject(cx);
-    var112 = "bool";
-    var114 = JS_GetProperty(cx, var109, var112, &var115);
-    if (JS_ValueToObject(cx, var115, &var116) != JS_TRUE) {
+    JSObject *var37;
+    int var38;
+    int var41;
+    jsval var42;
+    JSBool var36;
+    var37 = NULL;
+    var38 = 0;
+    var41 = 0;
+    var42 = JSVAL_NULL;
+    var36 = JS_FALSE;
+    var37 = obj;
+    var41 = argc;
+    var38 = jsTestFacBitrate();
+    if (JS_NewNumberValue(cx, var38, &var42) != JS_TRUE) {
         goto do_return;
     }
-    var388 = OBJECT_TO_JSVAL(var116);
-    argv[argc+0] = var388;
-    var120 = "prototype";
-    var117 = JS_GetProperty(cx, var116, var120, &var118);
-    if (JS_ValueToObject(cx, var118, &var119) != JS_TRUE) {
-        goto do_return;
-    }
-    var389 = OBJECT_TO_JSVAL(var119);
-    argv[argc+1] = var389;
-    var110 = JS_GET_CLASS(cx, var119);
-    var111 = NULL;
-    var108 = JS_NewObject(cx, var110, var111, var109);
-    var390 = OBJECT_TO_JSVAL(var108);
-    argv[argc+2] = var390;
-    if (JS_SetPrivate(cx, var108, var103) != JS_TRUE) {
-        goto do_return;
-    }
-    var107 = OBJECT_TO_JSVAL(var108);
+    argv[argc+0] = var42;
     if (rval) {
-        *rval = var107;
+        *rval = var42;
     }
-    var101 = JS_TRUE;
+    var36 = JS_TRUE;
     do_return:
-    return var101;
+    return var36;
 }
 static JSBool
 jjadmTestFacBar(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var122;
-    void *var123;
-    int var126;
-    jsval var127;
-    JSObject *var128;
-    JSObject *var129;
-    JSClass *var130;
-    char *var132;
-    JSBool var134;
-    jsval var135;
-    JSObject *var136;
-    jsval var391;
-    char *var140;
-    JSBool var137;
-    jsval var138;
-    JSObject *var139;
-    jsval var392;
-    JSObject *var131;
-    jsval var393;
-    JSBool var121;
-    var122 = NULL;
-    var123 = NULL;
-    var126 = 0;
-    var127 = JSVAL_NULL;
-    var128 = NULL;
-    var129 = NULL;
-    var130 = NULL;
-    var132 = NULL;
-    var134 = JS_FALSE;
-    var135 = JSVAL_NULL;
-    var136 = NULL;
-    var391 = JSVAL_NULL;
-    var140 = NULL;
-    var137 = JS_FALSE;
-    var138 = JSVAL_NULL;
-    var139 = NULL;
-    var392 = JSVAL_NULL;
-    var131 = NULL;
-    var393 = JSVAL_NULL;
-    var121 = JS_FALSE;
-    var122 = obj;
-    var126 = argc;
-    var123 = jsTestFacBar();
-    var129 = JS_GetGlobalObject(cx);
-    var132 = "bool";
-    var134 = JS_GetProperty(cx, var129, var132, &var135);
-    if (JS_ValueToObject(cx, var135, &var136) != JS_TRUE) {
+    JSObject *var44;
+    int var45;
+    int var48;
+    jsval var49;
+    JSBool var43;
+    var44 = NULL;
+    var45 = 0;
+    var48 = 0;
+    var49 = JSVAL_NULL;
+    var43 = JS_FALSE;
+    var44 = obj;
+    var48 = argc;
+    var45 = jsTestFacBar();
+    if (JS_NewNumberValue(cx, var45, &var49) != JS_TRUE) {
         goto do_return;
     }
-    var391 = OBJECT_TO_JSVAL(var136);
-    argv[argc+0] = var391;
-    var140 = "prototype";
-    var137 = JS_GetProperty(cx, var136, var140, &var138);
-    if (JS_ValueToObject(cx, var138, &var139) != JS_TRUE) {
-        goto do_return;
-    }
-    var392 = OBJECT_TO_JSVAL(var139);
-    argv[argc+1] = var392;
-    var130 = JS_GET_CLASS(cx, var139);
-    var131 = NULL;
-    var128 = JS_NewObject(cx, var130, var131, var129);
-    var393 = OBJECT_TO_JSVAL(var128);
-    argv[argc+2] = var393;
-    if (JS_SetPrivate(cx, var128, var123) != JS_TRUE) {
-        goto do_return;
-    }
-    var127 = OBJECT_TO_JSVAL(var128);
+    argv[argc+0] = var49;
     if (rval) {
-        *rval = var127;
+        *rval = var49;
     }
-    var121 = JS_TRUE;
+    var43 = JS_TRUE;
     do_return:
-    return var121;
+    return var43;
 }
 static JSBool
 jjadmTestFacRoText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var142;
-    void *var143;
-    int var146;
-    jsval var147;
-    JSObject *var148;
-    JSObject *var149;
-    JSClass *var150;
-    char *var152;
-    JSBool var154;
-    jsval var155;
-    JSObject *var156;
-    jsval var394;
-    char *var160;
-    JSBool var157;
-    jsval var158;
-    JSObject *var159;
-    jsval var395;
-    JSObject *var151;
-    jsval var396;
-    JSBool var141;
-    var142 = NULL;
-    var143 = NULL;
-    var146 = 0;
-    var147 = JSVAL_NULL;
-    var148 = NULL;
-    var149 = NULL;
-    var150 = NULL;
-    var152 = NULL;
-    var154 = JS_FALSE;
-    var155 = JSVAL_NULL;
-    var156 = NULL;
-    var394 = JSVAL_NULL;
-    var160 = NULL;
-    var157 = JS_FALSE;
-    var158 = JSVAL_NULL;
-    var159 = NULL;
-    var395 = JSVAL_NULL;
-    var151 = NULL;
-    var396 = JSVAL_NULL;
-    var141 = JS_FALSE;
-    var142 = obj;
-    var146 = argc;
-    var143 = jsTestFacRoText();
-    var149 = JS_GetGlobalObject(cx);
-    var152 = "bool";
-    var154 = JS_GetProperty(cx, var149, var152, &var155);
-    if (JS_ValueToObject(cx, var155, &var156) != JS_TRUE) {
+    JSObject *var51;
+    int var52;
+    int var55;
+    jsval var56;
+    JSBool var50;
+    var51 = NULL;
+    var52 = 0;
+    var55 = 0;
+    var56 = JSVAL_NULL;
+    var50 = JS_FALSE;
+    var51 = obj;
+    var55 = argc;
+    var52 = jsTestFacRoText();
+    if (JS_NewNumberValue(cx, var52, &var56) != JS_TRUE) {
         goto do_return;
     }
-    var394 = OBJECT_TO_JSVAL(var156);
-    argv[argc+0] = var394;
-    var160 = "prototype";
-    var157 = JS_GetProperty(cx, var156, var160, &var158);
-    if (JS_ValueToObject(cx, var158, &var159) != JS_TRUE) {
-        goto do_return;
-    }
-    var395 = OBJECT_TO_JSVAL(var159);
-    argv[argc+1] = var395;
-    var150 = JS_GET_CLASS(cx, var159);
-    var151 = NULL;
-    var148 = JS_NewObject(cx, var150, var151, var149);
-    var396 = OBJECT_TO_JSVAL(var148);
-    argv[argc+2] = var396;
-    if (JS_SetPrivate(cx, var148, var143) != JS_TRUE) {
-        goto do_return;
-    }
-    var147 = OBJECT_TO_JSVAL(var148);
+    argv[argc+0] = var56;
     if (rval) {
-        *rval = var147;
+        *rval = var56;
     }
-    var141 = JS_TRUE;
+    var50 = JS_TRUE;
     do_return:
-    return var141;
+    return var50;
 }
 static JSBool
 jjadmTestFacText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var162;
-    void *var163;
-    int var166;
-    jsval var167;
-    JSObject *var168;
-    JSObject *var169;
-    JSClass *var170;
-    char *var172;
-    JSBool var174;
-    jsval var175;
-    JSObject *var176;
-    jsval var397;
-    char *var180;
-    JSBool var177;
-    jsval var178;
-    JSObject *var179;
-    jsval var398;
-    JSObject *var171;
-    jsval var399;
-    JSBool var161;
-    var162 = NULL;
-    var163 = NULL;
-    var166 = 0;
-    var167 = JSVAL_NULL;
-    var168 = NULL;
-    var169 = NULL;
-    var170 = NULL;
-    var172 = NULL;
-    var174 = JS_FALSE;
-    var175 = JSVAL_NULL;
-    var176 = NULL;
-    var397 = JSVAL_NULL;
-    var180 = NULL;
-    var177 = JS_FALSE;
-    var178 = JSVAL_NULL;
-    var179 = NULL;
-    var398 = JSVAL_NULL;
-    var171 = NULL;
-    var399 = JSVAL_NULL;
-    var161 = JS_FALSE;
-    var162 = obj;
-    var166 = argc;
-    var163 = jsTestFacText();
-    var169 = JS_GetGlobalObject(cx);
-    var172 = "bool";
-    var174 = JS_GetProperty(cx, var169, var172, &var175);
-    if (JS_ValueToObject(cx, var175, &var176) != JS_TRUE) {
+    JSObject *var58;
+    int var59;
+    int var62;
+    jsval var63;
+    JSBool var57;
+    var58 = NULL;
+    var59 = 0;
+    var62 = 0;
+    var63 = JSVAL_NULL;
+    var57 = JS_FALSE;
+    var58 = obj;
+    var62 = argc;
+    var59 = jsTestFacText();
+    if (JS_NewNumberValue(cx, var59, &var63) != JS_TRUE) {
         goto do_return;
     }
-    var397 = OBJECT_TO_JSVAL(var176);
-    argv[argc+0] = var397;
-    var180 = "prototype";
-    var177 = JS_GetProperty(cx, var176, var180, &var178);
-    if (JS_ValueToObject(cx, var178, &var179) != JS_TRUE) {
-        goto do_return;
-    }
-    var398 = OBJECT_TO_JSVAL(var179);
-    argv[argc+1] = var398;
-    var170 = JS_GET_CLASS(cx, var179);
-    var171 = NULL;
-    var168 = JS_NewObject(cx, var170, var171, var169);
-    var399 = OBJECT_TO_JSVAL(var168);
-    argv[argc+2] = var399;
-    if (JS_SetPrivate(cx, var168, var163) != JS_TRUE) {
-        goto do_return;
-    }
-    var167 = OBJECT_TO_JSVAL(var168);
+    argv[argc+0] = var63;
     if (rval) {
-        *rval = var167;
+        *rval = var63;
     }
-    var161 = JS_TRUE;
+    var57 = JS_TRUE;
     do_return:
-    return var161;
+    return var57;
 }
 static JSBool
 jjadmTestFacTab(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var182;
-    void *var183;
-    int var186;
-    jsval var187;
-    JSObject *var188;
-    JSObject *var189;
-    JSClass *var190;
-    char *var192;
-    JSBool var194;
-    jsval var195;
-    JSObject *var196;
-    jsval var400;
-    char *var200;
-    JSBool var197;
-    jsval var198;
-    JSObject *var199;
-    jsval var401;
-    JSObject *var191;
-    jsval var402;
-    JSBool var181;
-    var182 = NULL;
-    var183 = NULL;
-    var186 = 0;
-    var187 = JSVAL_NULL;
-    var188 = NULL;
-    var189 = NULL;
-    var190 = NULL;
-    var192 = NULL;
-    var194 = JS_FALSE;
-    var195 = JSVAL_NULL;
-    var196 = NULL;
-    var400 = JSVAL_NULL;
-    var200 = NULL;
-    var197 = JS_FALSE;
-    var198 = JSVAL_NULL;
-    var199 = NULL;
-    var401 = JSVAL_NULL;
-    var191 = NULL;
-    var402 = JSVAL_NULL;
-    var181 = JS_FALSE;
-    var182 = obj;
-    var186 = argc;
-    var183 = jsTestFacTab();
-    var189 = JS_GetGlobalObject(cx);
-    var192 = "bool";
-    var194 = JS_GetProperty(cx, var189, var192, &var195);
-    if (JS_ValueToObject(cx, var195, &var196) != JS_TRUE) {
+    JSObject *var65;
+    int var66;
+    int var69;
+    jsval var70;
+    JSBool var64;
+    var65 = NULL;
+    var66 = 0;
+    var69 = 0;
+    var70 = JSVAL_NULL;
+    var64 = JS_FALSE;
+    var65 = obj;
+    var69 = argc;
+    var66 = jsTestFacTab();
+    if (JS_NewNumberValue(cx, var66, &var70) != JS_TRUE) {
         goto do_return;
     }
-    var400 = OBJECT_TO_JSVAL(var196);
-    argv[argc+0] = var400;
-    var200 = "prototype";
-    var197 = JS_GetProperty(cx, var196, var200, &var198);
-    if (JS_ValueToObject(cx, var198, &var199) != JS_TRUE) {
-        goto do_return;
-    }
-    var401 = OBJECT_TO_JSVAL(var199);
-    argv[argc+1] = var401;
-    var190 = JS_GET_CLASS(cx, var199);
-    var191 = NULL;
-    var188 = JS_NewObject(cx, var190, var191, var189);
-    var402 = OBJECT_TO_JSVAL(var188);
-    argv[argc+2] = var402;
-    if (JS_SetPrivate(cx, var188, var183) != JS_TRUE) {
-        goto do_return;
-    }
-    var187 = OBJECT_TO_JSVAL(var188);
+    argv[argc+0] = var70;
     if (rval) {
-        *rval = var187;
+        *rval = var70;
     }
-    var181 = JS_TRUE;
+    var64 = JS_TRUE;
     do_return:
-    return var181;
+    return var64;
 }
 static JSBool
-jjadmTestFrame(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacFrame(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var202;
-    void *var203;
-    int var206;
-    jsval var207;
-    JSObject *var208;
-    JSObject *var209;
-    JSClass *var210;
-    char *var212;
-    JSBool var214;
-    jsval var215;
-    JSObject *var216;
-    jsval var403;
-    char *var220;
-    JSBool var217;
-    jsval var218;
-    JSObject *var219;
-    jsval var404;
-    JSObject *var211;
-    jsval var405;
-    JSBool var201;
-    var202 = NULL;
-    var203 = NULL;
-    var206 = 0;
-    var207 = JSVAL_NULL;
-    var208 = NULL;
-    var209 = NULL;
-    var210 = NULL;
-    var212 = NULL;
-    var214 = JS_FALSE;
-    var215 = JSVAL_NULL;
-    var216 = NULL;
-    var403 = JSVAL_NULL;
-    var220 = NULL;
-    var217 = JS_FALSE;
-    var218 = JSVAL_NULL;
-    var219 = NULL;
-    var404 = JSVAL_NULL;
-    var211 = NULL;
-    var405 = JSVAL_NULL;
-    var201 = JS_FALSE;
-    var202 = obj;
-    var206 = argc;
-    var203 = jsTestFacFrame();
-    var209 = JS_GetGlobalObject(cx);
-    var212 = "bool";
-    var214 = JS_GetProperty(cx, var209, var212, &var215);
-    if (JS_ValueToObject(cx, var215, &var216) != JS_TRUE) {
+    JSObject *var72;
+    int var73;
+    int var76;
+    jsval var77;
+    JSBool var71;
+    var72 = NULL;
+    var73 = 0;
+    var76 = 0;
+    var77 = JSVAL_NULL;
+    var71 = JS_FALSE;
+    var72 = obj;
+    var76 = argc;
+    var73 = jsTestFacFrame();
+    if (JS_NewNumberValue(cx, var73, &var77) != JS_TRUE) {
         goto do_return;
     }
-    var403 = OBJECT_TO_JSVAL(var216);
-    argv[argc+0] = var403;
-    var220 = "prototype";
-    var217 = JS_GetProperty(cx, var216, var220, &var218);
-    if (JS_ValueToObject(cx, var218, &var219) != JS_TRUE) {
-        goto do_return;
-    }
-    var404 = OBJECT_TO_JSVAL(var219);
-    argv[argc+1] = var404;
-    var210 = JS_GET_CLASS(cx, var219);
-    var211 = NULL;
-    var208 = JS_NewObject(cx, var210, var211, var209);
-    var405 = OBJECT_TO_JSVAL(var208);
-    argv[argc+2] = var405;
-    if (JS_SetPrivate(cx, var208, var203) != JS_TRUE) {
-        goto do_return;
-    }
-    var207 = OBJECT_TO_JSVAL(var208);
+    argv[argc+0] = var77;
     if (rval) {
-        *rval = var207;
+        *rval = var77;
     }
-    var201 = JS_TRUE;
+    var71 = JS_TRUE;
     do_return:
-    return var201;
+    return var71;
 }
 static JSBool
-jjadmTestHex(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacHex(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var222;
-    void *var223;
-    int var226;
-    jsval var227;
-    JSObject *var228;
-    JSObject *var229;
-    JSClass *var230;
-    char *var232;
-    JSBool var234;
-    jsval var235;
-    JSObject *var236;
-    jsval var406;
-    char *var240;
-    JSBool var237;
-    jsval var238;
-    JSObject *var239;
-    jsval var407;
-    JSObject *var231;
-    jsval var408;
-    JSBool var221;
-    var222 = NULL;
-    var223 = NULL;
-    var226 = 0;
-    var227 = JSVAL_NULL;
-    var228 = NULL;
-    var229 = NULL;
-    var230 = NULL;
-    var232 = NULL;
-    var234 = JS_FALSE;
-    var235 = JSVAL_NULL;
-    var236 = NULL;
-    var406 = JSVAL_NULL;
-    var240 = NULL;
-    var237 = JS_FALSE;
-    var238 = JSVAL_NULL;
-    var239 = NULL;
-    var407 = JSVAL_NULL;
-    var231 = NULL;
-    var408 = JSVAL_NULL;
-    var221 = JS_FALSE;
-    var222 = obj;
-    var226 = argc;
-    var223 = jsTestFacHex();
-    var229 = JS_GetGlobalObject(cx);
-    var232 = "bool";
-    var234 = JS_GetProperty(cx, var229, var232, &var235);
-    if (JS_ValueToObject(cx, var235, &var236) != JS_TRUE) {
+    JSObject *var79;
+    int var80;
+    int var83;
+    jsval var84;
+    JSBool var78;
+    var79 = NULL;
+    var80 = 0;
+    var83 = 0;
+    var84 = JSVAL_NULL;
+    var78 = JS_FALSE;
+    var79 = obj;
+    var83 = argc;
+    var80 = jsTestFacHex();
+    if (JS_NewNumberValue(cx, var80, &var84) != JS_TRUE) {
         goto do_return;
     }
-    var406 = OBJECT_TO_JSVAL(var236);
-    argv[argc+0] = var406;
-    var240 = "prototype";
-    var237 = JS_GetProperty(cx, var236, var240, &var238);
-    if (JS_ValueToObject(cx, var238, &var239) != JS_TRUE) {
-        goto do_return;
-    }
-    var407 = OBJECT_TO_JSVAL(var239);
-    argv[argc+1] = var407;
-    var230 = JS_GET_CLASS(cx, var239);
-    var231 = NULL;
-    var228 = JS_NewObject(cx, var230, var231, var229);
-    var408 = OBJECT_TO_JSVAL(var228);
-    argv[argc+2] = var408;
-    if (JS_SetPrivate(cx, var228, var223) != JS_TRUE) {
-        goto do_return;
-    }
-    var227 = OBJECT_TO_JSVAL(var228);
+    argv[argc+0] = var84;
     if (rval) {
-        *rval = var227;
+        *rval = var84;
     }
-    var221 = JS_TRUE;
+    var78 = JS_TRUE;
     do_return:
-    return var221;
+    return var78;
 }
 static JSBool
-jjadmTestDirSel(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacDirSel(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var242;
-    void *var243;
-    int var246;
-    jsval var247;
-    JSObject *var248;
-    JSObject *var249;
-    JSClass *var250;
-    char *var252;
-    JSBool var254;
-    jsval var255;
-    JSObject *var256;
-    jsval var409;
-    char *var260;
-    JSBool var257;
-    jsval var258;
-    JSObject *var259;
-    jsval var410;
-    JSObject *var251;
-    jsval var411;
-    JSBool var241;
-    var242 = NULL;
-    var243 = NULL;
-    var246 = 0;
-    var247 = JSVAL_NULL;
-    var248 = NULL;
-    var249 = NULL;
-    var250 = NULL;
-    var252 = NULL;
-    var254 = JS_FALSE;
-    var255 = JSVAL_NULL;
-    var256 = NULL;
-    var409 = JSVAL_NULL;
-    var260 = NULL;
-    var257 = JS_FALSE;
-    var258 = JSVAL_NULL;
-    var259 = NULL;
-    var410 = JSVAL_NULL;
-    var251 = NULL;
-    var411 = JSVAL_NULL;
-    var241 = JS_FALSE;
-    var242 = obj;
-    var246 = argc;
-    var243 = jsTestFacDirSel();
-    var249 = JS_GetGlobalObject(cx);
-    var252 = "bool";
-    var254 = JS_GetProperty(cx, var249, var252, &var255);
-    if (JS_ValueToObject(cx, var255, &var256) != JS_TRUE) {
+    JSObject *var86;
+    int var87;
+    int var90;
+    jsval var91;
+    JSBool var85;
+    var86 = NULL;
+    var87 = 0;
+    var90 = 0;
+    var91 = JSVAL_NULL;
+    var85 = JS_FALSE;
+    var86 = obj;
+    var90 = argc;
+    var87 = jsTestFacDirSel();
+    if (JS_NewNumberValue(cx, var87, &var91) != JS_TRUE) {
         goto do_return;
     }
-    var409 = OBJECT_TO_JSVAL(var256);
-    argv[argc+0] = var409;
-    var260 = "prototype";
-    var257 = JS_GetProperty(cx, var256, var260, &var258);
-    if (JS_ValueToObject(cx, var258, &var259) != JS_TRUE) {
-        goto do_return;
-    }
-    var410 = OBJECT_TO_JSVAL(var259);
-    argv[argc+1] = var410;
-    var250 = JS_GET_CLASS(cx, var259);
-    var251 = NULL;
-    var248 = JS_NewObject(cx, var250, var251, var249);
-    var411 = OBJECT_TO_JSVAL(var248);
-    argv[argc+2] = var411;
-    if (JS_SetPrivate(cx, var248, var243) != JS_TRUE) {
-        goto do_return;
-    }
-    var247 = OBJECT_TO_JSVAL(var248);
+    argv[argc+0] = var91;
     if (rval) {
-        *rval = var247;
+        *rval = var91;
     }
-    var241 = JS_TRUE;
+    var85 = JS_TRUE;
     do_return:
-    return var241;
+    return var85;
 }
 static JSBool
-jjadmTestButton(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacButton(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var262;
-    void *var263;
-    int var266;
-    jsval var267;
-    JSObject *var268;
-    JSObject *var269;
-    JSClass *var270;
-    char *var272;
-    JSBool var274;
-    jsval var275;
-    JSObject *var276;
-    jsval var412;
-    char *var280;
-    JSBool var277;
-    jsval var278;
-    JSObject *var279;
-    jsval var413;
-    JSObject *var271;
-    jsval var414;
-    JSBool var261;
-    var262 = NULL;
-    var263 = NULL;
-    var266 = 0;
-    var267 = JSVAL_NULL;
-    var268 = NULL;
-    var269 = NULL;
-    var270 = NULL;
-    var272 = NULL;
-    var274 = JS_FALSE;
-    var275 = JSVAL_NULL;
-    var276 = NULL;
-    var412 = JSVAL_NULL;
-    var280 = NULL;
-    var277 = JS_FALSE;
-    var278 = JSVAL_NULL;
-    var279 = NULL;
-    var413 = JSVAL_NULL;
-    var271 = NULL;
-    var414 = JSVAL_NULL;
-    var261 = JS_FALSE;
-    var262 = obj;
-    var266 = argc;
-    var263 = jsTestFacButton();
-    var269 = JS_GetGlobalObject(cx);
-    var272 = "bool";
-    var274 = JS_GetProperty(cx, var269, var272, &var275);
-    if (JS_ValueToObject(cx, var275, &var276) != JS_TRUE) {
+    JSObject *var93;
+    int var94;
+    int var97;
+    jsval var98;
+    JSBool var92;
+    var93 = NULL;
+    var94 = 0;
+    var97 = 0;
+    var98 = JSVAL_NULL;
+    var92 = JS_FALSE;
+    var93 = obj;
+    var97 = argc;
+    var94 = jsTestFacButton();
+    if (JS_NewNumberValue(cx, var94, &var98) != JS_TRUE) {
         goto do_return;
     }
-    var412 = OBJECT_TO_JSVAL(var276);
-    argv[argc+0] = var412;
-    var280 = "prototype";
-    var277 = JS_GetProperty(cx, var276, var280, &var278);
-    if (JS_ValueToObject(cx, var278, &var279) != JS_TRUE) {
-        goto do_return;
-    }
-    var413 = OBJECT_TO_JSVAL(var279);
-    argv[argc+1] = var413;
-    var270 = JS_GET_CLASS(cx, var279);
-    var271 = NULL;
-    var268 = JS_NewObject(cx, var270, var271, var269);
-    var414 = OBJECT_TO_JSVAL(var268);
-    argv[argc+2] = var414;
-    if (JS_SetPrivate(cx, var268, var263) != JS_TRUE) {
-        goto do_return;
-    }
-    var267 = OBJECT_TO_JSVAL(var268);
+    argv[argc+0] = var98;
     if (rval) {
-        *rval = var267;
+        *rval = var98;
     }
-    var261 = JS_TRUE;
+    var92 = JS_TRUE;
     do_return:
-    return var261;
+    return var92;
 }
 static JSBool
-jjadmTestMatrix(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacMatrix(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var282;
-    void *var283;
-    int var286;
-    jsval var287;
-    JSObject *var288;
-    JSObject *var289;
-    JSClass *var290;
-    char *var292;
-    JSBool var294;
-    jsval var295;
-    JSObject *var296;
-    jsval var415;
-    char *var300;
-    JSBool var297;
-    jsval var298;
-    JSObject *var299;
-    jsval var416;
-    JSObject *var291;
-    jsval var417;
-    JSBool var281;
-    var282 = NULL;
-    var283 = NULL;
-    var286 = 0;
-    var287 = JSVAL_NULL;
-    var288 = NULL;
-    var289 = NULL;
-    var290 = NULL;
-    var292 = NULL;
-    var294 = JS_FALSE;
-    var295 = JSVAL_NULL;
-    var296 = NULL;
-    var415 = JSVAL_NULL;
-    var300 = NULL;
-    var297 = JS_FALSE;
-    var298 = JSVAL_NULL;
-    var299 = NULL;
-    var416 = JSVAL_NULL;
-    var291 = NULL;
-    var417 = JSVAL_NULL;
-    var281 = JS_FALSE;
-    var282 = obj;
-    var286 = argc;
-    var283 = jsTestFacMatrix();
-    var289 = JS_GetGlobalObject(cx);
-    var292 = "bool";
-    var294 = JS_GetProperty(cx, var289, var292, &var295);
-    if (JS_ValueToObject(cx, var295, &var296) != JS_TRUE) {
+    JSObject *var100;
+    int var101;
+    int var104;
+    jsval var105;
+    JSBool var99;
+    var100 = NULL;
+    var101 = 0;
+    var104 = 0;
+    var105 = JSVAL_NULL;
+    var99 = JS_FALSE;
+    var100 = obj;
+    var104 = argc;
+    var101 = jsTestFacMatrix();
+    if (JS_NewNumberValue(cx, var101, &var105) != JS_TRUE) {
         goto do_return;
     }
-    var415 = OBJECT_TO_JSVAL(var296);
-    argv[argc+0] = var415;
-    var300 = "prototype";
-    var297 = JS_GetProperty(cx, var296, var300, &var298);
-    if (JS_ValueToObject(cx, var298, &var299) != JS_TRUE) {
-        goto do_return;
-    }
-    var416 = OBJECT_TO_JSVAL(var299);
-    argv[argc+1] = var416;
-    var290 = JS_GET_CLASS(cx, var299);
-    var291 = NULL;
-    var288 = JS_NewObject(cx, var290, var291, var289);
-    var417 = OBJECT_TO_JSVAL(var288);
-    argv[argc+2] = var417;
-    if (JS_SetPrivate(cx, var288, var283) != JS_TRUE) {
-        goto do_return;
-    }
-    var287 = OBJECT_TO_JSVAL(var288);
+    argv[argc+0] = var105;
     if (rval) {
-        *rval = var287;
+        *rval = var105;
     }
-    var281 = JS_TRUE;
+    var99 = JS_TRUE;
     do_return:
-    return var281;
+    return var99;
 }
 static JSBool
-jjadmTestNotch(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacNotch(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var302;
-    void *var303;
-    int var306;
-    jsval var307;
-    JSObject *var308;
-    JSObject *var309;
-    JSClass *var310;
-    char *var312;
-    JSBool var314;
-    jsval var315;
-    JSObject *var316;
-    jsval var418;
-    char *var320;
-    JSBool var317;
-    jsval var318;
-    JSObject *var319;
-    jsval var419;
-    JSObject *var311;
-    jsval var420;
-    JSBool var301;
-    var302 = NULL;
-    var303 = NULL;
-    var306 = 0;
-    var307 = JSVAL_NULL;
-    var308 = NULL;
-    var309 = NULL;
-    var310 = NULL;
-    var312 = NULL;
-    var314 = JS_FALSE;
-    var315 = JSVAL_NULL;
-    var316 = NULL;
-    var418 = JSVAL_NULL;
-    var320 = NULL;
-    var317 = JS_FALSE;
-    var318 = JSVAL_NULL;
-    var319 = NULL;
-    var419 = JSVAL_NULL;
-    var311 = NULL;
-    var420 = JSVAL_NULL;
-    var301 = JS_FALSE;
-    var302 = obj;
-    var306 = argc;
-    var303 = jsTestFacNotch();
-    var309 = JS_GetGlobalObject(cx);
-    var312 = "bool";
-    var314 = JS_GetProperty(cx, var309, var312, &var315);
-    if (JS_ValueToObject(cx, var315, &var316) != JS_TRUE) {
+    JSObject *var107;
+    int var108;
+    int var111;
+    jsval var112;
+    JSBool var106;
+    var107 = NULL;
+    var108 = 0;
+    var111 = 0;
+    var112 = JSVAL_NULL;
+    var106 = JS_FALSE;
+    var107 = obj;
+    var111 = argc;
+    var108 = jsTestFacNotch();
+    if (JS_NewNumberValue(cx, var108, &var112) != JS_TRUE) {
         goto do_return;
     }
-    var418 = OBJECT_TO_JSVAL(var316);
-    argv[argc+0] = var418;
-    var320 = "prototype";
-    var317 = JS_GetProperty(cx, var316, var320, &var318);
-    if (JS_ValueToObject(cx, var318, &var319) != JS_TRUE) {
-        goto do_return;
-    }
-    var419 = OBJECT_TO_JSVAL(var319);
-    argv[argc+1] = var419;
-    var310 = JS_GET_CLASS(cx, var319);
-    var311 = NULL;
-    var308 = JS_NewObject(cx, var310, var311, var309);
-    var420 = OBJECT_TO_JSVAL(var308);
-    argv[argc+2] = var420;
-    if (JS_SetPrivate(cx, var308, var303) != JS_TRUE) {
-        goto do_return;
-    }
-    var307 = OBJECT_TO_JSVAL(var308);
+    argv[argc+0] = var112;
     if (rval) {
-        *rval = var307;
+        *rval = var112;
     }
-    var301 = JS_TRUE;
+    var106 = JS_TRUE;
     do_return:
-    return var301;
+    return var106;
 }
 static JSBool
-jjadmTestThreadCount(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacThreadCount(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var322;
-    void *var323;
-    int var326;
-    jsval var327;
-    JSObject *var328;
-    JSObject *var329;
-    JSClass *var330;
-    char *var332;
-    JSBool var334;
-    jsval var335;
-    JSObject *var336;
-    jsval var421;
-    char *var340;
-    JSBool var337;
-    jsval var338;
-    JSObject *var339;
-    jsval var422;
-    JSObject *var331;
-    jsval var423;
-    JSBool var321;
-    var322 = NULL;
-    var323 = NULL;
-    var326 = 0;
-    var327 = JSVAL_NULL;
-    var328 = NULL;
-    var329 = NULL;
-    var330 = NULL;
-    var332 = NULL;
-    var334 = JS_FALSE;
-    var335 = JSVAL_NULL;
-    var336 = NULL;
-    var421 = JSVAL_NULL;
-    var340 = NULL;
-    var337 = JS_FALSE;
-    var338 = JSVAL_NULL;
-    var339 = NULL;
-    var422 = JSVAL_NULL;
-    var331 = NULL;
-    var423 = JSVAL_NULL;
-    var321 = JS_FALSE;
-    var322 = obj;
-    var326 = argc;
-    var323 = jsTestFacThreadCount();
-    var329 = JS_GetGlobalObject(cx);
-    var332 = "bool";
-    var334 = JS_GetProperty(cx, var329, var332, &var335);
-    if (JS_ValueToObject(cx, var335, &var336) != JS_TRUE) {
+    JSObject *var114;
+    int var115;
+    int var118;
+    jsval var119;
+    JSBool var113;
+    var114 = NULL;
+    var115 = 0;
+    var118 = 0;
+    var119 = JSVAL_NULL;
+    var113 = JS_FALSE;
+    var114 = obj;
+    var118 = argc;
+    var115 = jsTestFacThreadCount();
+    if (JS_NewNumberValue(cx, var115, &var119) != JS_TRUE) {
         goto do_return;
     }
-    var421 = OBJECT_TO_JSVAL(var336);
-    argv[argc+0] = var421;
-    var340 = "prototype";
-    var337 = JS_GetProperty(cx, var336, var340, &var338);
-    if (JS_ValueToObject(cx, var338, &var339) != JS_TRUE) {
-        goto do_return;
-    }
-    var422 = OBJECT_TO_JSVAL(var339);
-    argv[argc+1] = var422;
-    var330 = JS_GET_CLASS(cx, var339);
-    var331 = NULL;
-    var328 = JS_NewObject(cx, var330, var331, var329);
-    var423 = OBJECT_TO_JSVAL(var328);
-    argv[argc+2] = var423;
-    if (JS_SetPrivate(cx, var328, var323) != JS_TRUE) {
-        goto do_return;
-    }
-    var327 = OBJECT_TO_JSVAL(var328);
+    argv[argc+0] = var119;
     if (rval) {
-        *rval = var327;
+        *rval = var119;
     }
-    var321 = JS_TRUE;
+    var113 = JS_TRUE;
     do_return:
-    return var321;
+    return var113;
 }
 static JSBool
-jjadmTestSlider(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmTestFacSlider(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var342;
-    void *var343;
-    int var346;
-    jsval var347;
-    JSObject *var348;
-    JSObject *var349;
-    JSClass *var350;
-    char *var352;
-    JSBool var354;
-    jsval var355;
-    JSObject *var356;
-    jsval var424;
-    char *var360;
-    JSBool var357;
-    jsval var358;
-    JSObject *var359;
-    jsval var425;
-    JSObject *var351;
-    jsval var426;
-    JSBool var341;
-    var342 = NULL;
-    var343 = NULL;
-    var346 = 0;
-    var347 = JSVAL_NULL;
-    var348 = NULL;
-    var349 = NULL;
-    var350 = NULL;
-    var352 = NULL;
-    var354 = JS_FALSE;
-    var355 = JSVAL_NULL;
-    var356 = NULL;
-    var424 = JSVAL_NULL;
-    var360 = NULL;
-    var357 = JS_FALSE;
-    var358 = JSVAL_NULL;
-    var359 = NULL;
-    var425 = JSVAL_NULL;
-    var351 = NULL;
-    var426 = JSVAL_NULL;
-    var341 = JS_FALSE;
-    var342 = obj;
-    var346 = argc;
-    var343 = jsTestFacSlider();
-    var349 = JS_GetGlobalObject(cx);
-    var352 = "bool";
-    var354 = JS_GetProperty(cx, var349, var352, &var355);
-    if (JS_ValueToObject(cx, var355, &var356) != JS_TRUE) {
+    JSObject *var121;
+    int var122;
+    int var125;
+    jsval var126;
+    JSBool var120;
+    var121 = NULL;
+    var122 = 0;
+    var125 = 0;
+    var126 = JSVAL_NULL;
+    var120 = JS_FALSE;
+    var121 = obj;
+    var125 = argc;
+    var122 = jsTestFacSlider();
+    if (JS_NewNumberValue(cx, var122, &var126) != JS_TRUE) {
         goto do_return;
     }
-    var424 = OBJECT_TO_JSVAL(var356);
-    argv[argc+0] = var424;
-    var360 = "prototype";
-    var357 = JS_GetProperty(cx, var356, var360, &var358);
-    if (JS_ValueToObject(cx, var358, &var359) != JS_TRUE) {
-        goto do_return;
-    }
-    var425 = OBJECT_TO_JSVAL(var359);
-    argv[argc+1] = var425;
-    var350 = JS_GET_CLASS(cx, var359);
-    var351 = NULL;
-    var348 = JS_NewObject(cx, var350, var351, var349);
-    var426 = OBJECT_TO_JSVAL(var348);
-    argv[argc+2] = var426;
-    if (JS_SetPrivate(cx, var348, var343) != JS_TRUE) {
-        goto do_return;
-    }
-    var347 = OBJECT_TO_JSVAL(var348);
+    argv[argc+0] = var126;
     if (rval) {
-        *rval = var347;
+        *rval = var126;
     }
-    var341 = JS_TRUE;
+    var120 = JS_TRUE;
     do_return:
-    return var341;
+    return var120;
 }
 static JSBool
 jjadmTestCrash(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var362;
-    int var366;
-    JSBool var361;
-    var362 = NULL;
-    var366 = 0;
-    var361 = JS_FALSE;
-    var362 = obj;
-    var366 = argc;
+    JSObject *var128;
+    int var132;
+    JSBool var127;
+    var128 = NULL;
+    var132 = 0;
+    var127 = JS_FALSE;
+    var128 = obj;
+    var132 = argc;
     jsTestCrash();
-    var361 = JS_TRUE;
-    return var361;
+    var127 = JS_TRUE;
+    return var127;
 }
 static JSBool
 jjadmTestAssert(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var368;
-    int var372;
-    JSBool var367;
-    var368 = NULL;
-    var372 = 0;
-    var367 = JS_FALSE;
-    var368 = obj;
-    var372 = argc;
+    JSObject *var134;
+    int var138;
+    JSBool var133;
+    var134 = NULL;
+    var138 = 0;
+    var133 = JS_FALSE;
+    var134 = obj;
+    var138 = argc;
     jsTestAssert();
-    var367 = JS_TRUE;
-    return var367;
+    var133 = JS_TRUE;
+    return var133;
 }
 static JSPropertySpec jj_static_ps[] = {
     {NULL, 0, 0, NULL, NULL}
@@ -1453,47 +553,47 @@
     {NULL, 0, 0, NULL, NULL}
 };
 static JSFunctionSpec jj_static_fs[] = {
-    JS_FS("admTestFacInt", jjadmTestFacInt, 0, 0, 3),
-    JS_FS("admTestFacFloat", jjadmTestFacFloat, 0, 0, 3),
-    JS_FS("admTestFacToggle", jjadmTestFacToggle, 0, 0, 3),
-    JS_FS("admTestFacMenu", jjadmTestFacMenu, 0, 0, 3),
-    JS_FS("admTestFacFile", jjadmTestFacFile, 0, 0, 3),
-    JS_FS("admTestFacBitrate", jjadmTestFacBitrate, 0, 0, 3),
-    JS_FS("admTestFacBar", jjadmTestFacBar, 0, 0, 3),
-    JS_FS("admTestFacRoText", jjadmTestFacRoText, 0, 0, 3),
-    JS_FS("admTestFacText", jjadmTestFacText, 0, 0, 3),
-    JS_FS("admTestFacTab", jjadmTestFacTab, 0, 0, 3),
-    JS_FS("admTestFrame", jjadmTestFrame, 0, 0, 3),
-    JS_FS("admTestHex", jjadmTestHex, 0, 0, 3),
-    JS_FS("admTestDirSel", jjadmTestDirSel, 0, 0, 3),
-    JS_FS("admTestButton", jjadmTestButton, 0, 0, 3),
-    JS_FS("admTestMatrix", jjadmTestMatrix, 0, 0, 3),
-    JS_FS("admTestNotch", jjadmTestNotch, 0, 0, 3),
-    JS_FS("admTestThreadCount", jjadmTestThreadCount, 0, 0, 3),
-    JS_FS("admTestSlider", jjadmTestSlider, 0, 0, 3),
+    JS_FS("admTestFacInt", jjadmTestFacInt, 0, 0, 1),
+    JS_FS("admTestFacFloat", jjadmTestFacFloat, 0, 0, 1),
+    JS_FS("admTestFacToggle", jjadmTestFacToggle, 0, 0, 1),
+    JS_FS("admTestFacMenu", jjadmTestFacMenu, 0, 0, 1),
+    JS_FS("admTestFacFile", jjadmTestFacFile, 0, 0, 1),
+    JS_FS("admTestFacBitrate", jjadmTestFacBitrate, 0, 0, 1),
+    JS_FS("admTestFacBar", jjadmTestFacBar, 0, 0, 1),
+    JS_FS("admTestFacRoText", jjadmTestFacRoText, 0, 0, 1),
+    JS_FS("admTestFacText", jjadmTestFacText, 0, 0, 1),
+    JS_FS("admTestFacTab", jjadmTestFacTab, 0, 0, 1),
+    JS_FS("admTestFacFrame", jjadmTestFacFrame, 0, 0, 1),
+    JS_FS("admTestFacHex", jjadmTestFacHex, 0, 0, 1),
+    JS_FS("admTestFacDirSel", jjadmTestFacDirSel, 0, 0, 1),
+    JS_FS("admTestFacButton", jjadmTestFacButton, 0, 0, 1),
+    JS_FS("admTestFacMatrix", jjadmTestFacMatrix, 0, 0, 1),
+    JS_FS("admTestFacNotch", jjadmTestFacNotch, 0, 0, 1),
+    JS_FS("admTestFacThreadCount", jjadmTestFacThreadCount, 0, 0, 1),
+    JS_FS("admTestFacSlider", jjadmTestFacSlider, 0, 0, 1),
     JS_FS("admTestCrash", jjadmTestCrash, 0, 0, 0),
     JS_FS("admTestAssert", jjadmTestAssert, 0, 0, 0),
     JS_FS_END
 };
 static JSFunctionSpec jj_fs[] = {
-    JS_FS("admTestFacInt", jjadmTestFacInt, 0, 0, 3),
-    JS_FS("admTestFacFloat", jjadmTestFacFloat, 0, 0, 3),
-    JS_FS("admTestFacToggle", jjadmTestFacToggle, 0, 0, 3),
-    JS_FS("admTestFacMenu", jjadmTestFacMenu, 0, 0, 3),
-    JS_FS("admTestFacFile", jjadmTestFacFile, 0, 0, 3),
-    JS_FS("admTestFacBitrate", jjadmTestFacBitrate, 0, 0, 3),
-    JS_FS("admTestFacBar", jjadmTestFacBar, 0, 0, 3),
-    JS_FS("admTestFacRoText", jjadmTestFacRoText, 0, 0, 3),
-    JS_FS("admTestFacText", jjadmTestFacText, 0, 0, 3),
-    JS_FS("admTestFacTab", jjadmTestFacTab, 0, 0, 3),
-    JS_FS("admTestFrame", jjadmTestFrame, 0, 0, 3),
-    JS_FS("admTestHex", jjadmTestHex, 0, 0, 3),
-    JS_FS("admTestDirSel", jjadmTestDirSel, 0, 0, 3),
-    JS_FS("admTestButton", jjadmTestButton, 0, 0, 3),
-    JS_FS("admTestMatrix", jjadmTestMatrix, 0, 0, 3),
-    JS_FS("admTestNotch", jjadmTestNotch, 0, 0, 3),
-    JS_FS("admTestThreadCount", jjadmTestThreadCount, 0, 0, 3),
-    JS_FS("admTestSlider", jjadmTestSlider, 0, 0, 3),
+    JS_FS("admTestFacInt", jjadmTestFacInt, 0, 0, 1),
+    JS_FS("admTestFacFloat", jjadmTestFacFloat, 0, 0, 1),
+    JS_FS("admTestFacToggle", jjadmTestFacToggle, 0, 0, 1),
+    JS_FS("admTestFacMenu", jjadmTestFacMenu, 0, 0, 1),
+    JS_FS("admTestFacFile", jjadmTestFacFile, 0, 0, 1),
+    JS_FS("admTestFacBitrate", jjadmTestFacBitrate, 0, 0, 1),
+    JS_FS("admTestFacBar", jjadmTestFacBar, 0, 0, 1),
+    JS_FS("admTestFacRoText", jjadmTestFacRoText, 0, 0, 1),
+    JS_FS("admTestFacText", jjadmTestFacText, 0, 0, 1),
+    JS_FS("admTestFacTab", jjadmTestFacTab, 0, 0, 1),
+    JS_FS("admTestFacFrame", jjadmTestFacFrame, 0, 0, 1),
+    JS_FS("admTestFacHex", jjadmTestFacHex, 0, 0, 1),
+    JS_FS("admTestFacDirSel", jjadmTestFacDirSel, 0, 0, 1),
+    JS_FS("admTestFacButton", jjadmTestFacButton, 0, 0, 1),
+    JS_FS("admTestFacMatrix", jjadmTestFacMatrix, 0, 0, 1),
+    JS_FS("admTestFacNotch", jjadmTestFacNotch, 0, 0, 1),
+    JS_FS("admTestFacThreadCount", jjadmTestFacThreadCount, 0, 0, 1),
+    JS_FS("admTestFacSlider", jjadmTestFacSlider, 0, 0, 1),
     JS_FS("admTestCrash", jjadmTestCrash, 0, 0, 0),
     JS_FS("admTestAssert", jjadmTestAssert, 0, 0, 0),
     JS_FS_END

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl	2009-12-11 10:14:17 UTC (rev 5638)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsTestFactory_js.idl	2009-12-11 10:14:19 UTC (rev 5639)
@@ -3,26 +3,26 @@
        return JS function     C Function  params
 ###############################################################
 */
-function bool admTestFacInt     :  jsTestFacInt     (void  ) <static>;
-function bool admTestFacFloat   :  jsTestFacFloat   (void  ) <static>;
-function bool admTestFacToggle  :  jsTestFacToggle  (void  ) <static>;
-function bool admTestFacMenu    :  jsTestFacMenu    (void  ) <static>;
-function bool admTestFacFile    :  jsTestFacFile    (void  ) <static>;
-function bool admTestFacBitrate :  jsTestFacBitrate (void  ) <static>;
-function bool admTestFacBar     :  jsTestFacBar     (void  ) <static>;
-function bool admTestFacRoText  :  jsTestFacRoText  (void  ) <static>;
-function bool admTestFacText    :  jsTestFacText    (void  ) <static>;
-function bool admTestFacTab     :  jsTestFacTab     (void  ) <static>;
-function bool admTestFrame      :  jsTestFacFrame   (void  ) <static>;
-function bool admTestHex        :  jsTestFacHex     (void  ) <static>;
-function bool admTestDirSel     :  jsTestFacDirSel  (void  ) <static>;
-function bool admTestButton     :  jsTestFacButton  (void  ) <static>;
-function bool admTestMatrix     :  jsTestFacMatrix  (void  ) <static>;
-function bool admTestNotch      :  jsTestFacNotch   (void  ) <static>;
-function bool admTestThreadCount:  jsTestFacThreadCount   (void  ) <static>;
-function bool admTestSlider     :  jsTestFacSlider  (void  ) <static>;
-function void admTestCrash      :  jsTestCrash      (void  ) <static>;
-function void admTestAssert     :  jsTestAssert     (void  ) <static>;
+function int admTestFacInt     :  jsTestFacInt     (void  ) <static>;
+function int admTestFacFloat   :  jsTestFacFloat   (void  ) <static>;
+function int admTestFacToggle  :  jsTestFacToggle  (void  ) <static>;
+function int admTestFacMenu    :  jsTestFacMenu    (void  ) <static>;
+function int admTestFacFile    :  jsTestFacFile    (void  ) <static>;
+function int admTestFacBitrate :  jsTestFacBitrate (void  ) <static>;
+function int admTestFacBar     :  jsTestFacBar     (void  ) <static>;
+function int admTestFacRoText  :  jsTestFacRoText  (void  ) <static>;
+function int admTestFacText    :  jsTestFacText    (void  ) <static>;
+function int admTestFacTab     :  jsTestFacTab     (void  ) <static>;
+function int admTestFacFrame   :  jsTestFacFrame   (void  ) <static>;
+function int admTestFacHex     :  jsTestFacHex     (void  ) <static>;
+function int admTestFacDirSel  :  jsTestFacDirSel  (void  ) <static>;
+function int admTestFacButton  :  jsTestFacButton  (void  ) <static>;
+function int admTestFacMatrix  :  jsTestFacMatrix  (void  ) <static>;
+function int admTestFacNotch   :  jsTestFacNotch   (void  ) <static>;
+function int admTestFacThreadCount:  jsTestFacThreadCount   (void  ) <static>;
+function int admTestFacSlider  :  jsTestFacSlider  (void  ) <static>;
+function void admTestCrash     :  jsTestCrash      (void  ) <static>;
+function void admTestAssert    :  jsTestAssert     (void  ) <static>;
 
 %<
 JSFunctionSpec  *jsGetTestFunctions(void)



From mean at mail.berlios.de  Fri Dec 11 11:14:21 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 11:14:21 +0100
Subject: [Avidemux-svn-commit] r5640 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include
Message-ID: <200912111014.nBBAELqt024140@sheep.berlios.de>

Author: mean
Date: 2009-12-11 11:14:21 +0100 (Fri, 11 Dec 2009)
New Revision: 5640

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsTestFactory.h
Log:
[js] Fix admTestFac** js functions

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsTestFactory.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsTestFactory.h	2009-12-11 10:14:19 UTC (rev 5639)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsTestFactory.h	2009-12-11 10:14:21 UTC (rev 5640)
@@ -18,27 +18,27 @@
 #define ADMJS_FACTORY_H
 extern "C"
 {
-bool jsTestCrash(void);
-bool jsTestAssert(void);
-bool jsTestFacNotch(void);
-bool jsTestFacThreadCount(void);
-bool jsTestFacMatrix(void);
-bool jsTestFacMatrix(void);
-bool jsTestFacHex(void);
-bool jsTestFacFrame(void);
-bool jsTestFacTab(void);
-bool jsTestFacText(void);
-bool jsTestFacRoText(void);
-bool jsTestFacSlider(void);
-bool jsTestFacButton(void);
-bool jsTestFacBar(void);
-bool jsTestFacBitrate(void);
-bool jsTestFacDirSel(void);
-bool jsTestFacFile(void);
-bool jsTestFacMenu(void);
-bool jsTestFacToggle(void);
-bool jsTestFacFloat(void);
-bool jsTestFacInt(void);
+int jsTestCrash(void);
+int jsTestAssert(void);
+int jsTestFacNotch(void);
+int jsTestFacThreadCount(void);
+int jsTestFacMatrix(void);
+int jsTestFacMatrix(void);
+int jsTestFacHex(void);
+int jsTestFacFrame(void);
+int jsTestFacTab(void);
+int jsTestFacText(void);
+int jsTestFacRoText(void);
+int jsTestFacSlider(void);
+int jsTestFacButton(void);
+int jsTestFacBar(void);
+int jsTestFacBitrate(void);
+int jsTestFacDirSel(void);
+int jsTestFacFile(void);
+int jsTestFacMenu(void);
+int jsTestFacToggle(void);
+int jsTestFacFloat(void);
+int jsTestFacInt(void);
 };
 
 



From mean at mail.berlios.de  Fri Dec 11 11:14:22 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 11:14:22 +0100
Subject: [Avidemux-svn-commit] r5641 -
	branches/avidemux_2.6_branch_mean/autononreg/dialogFactory
Message-ID: <200912111014.nBBAEMJK024150@sheep.berlios.de>

Author: mean
Date: 2009-12-11 11:14:22 +0100 (Fri, 11 Dec 2009)
New Revision: 5641

Added:
   branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/run_non_reg.sh
Log:
[js] Added auto run shell script for factory check

Added: branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/run_non_reg.sh
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/run_non_reg.sh	2009-12-11 10:14:21 UTC (rev 5640)
+++ branches/avidemux_2.6_branch_mean/autononreg/dialogFactory/run_non_reg.sh	2009-12-11 10:14:22 UTC (rev 5641)
@@ -0,0 +1,11 @@
+#!/bin/bash
+export PRG=~/workspace/qt4/avidemux3_qt4
+export SRC=.
+echo "Running tests..."
+#*****************
+cd functiontest
+perl ../foreach.pl $SRC/*.js "echo %f &&  $PRG    --run %f --quit > /dev/null"
+cd ..
+#*****************
+echo "## ALL done checking...##"
+		



From mean at mail.berlios.de  Fri Dec 11 11:14:24 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 11:14:24 +0100
Subject: [Avidemux-svn-commit] r5642 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src
Message-ID: <200912111014.nBBAEO7s024160@sheep.berlios.de>

Author: mean
Date: 2009-12-11 11:14:24 +0100 (Fri, 11 Dec 2009)
New Revision: 5642

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
Log:
[js] adm class

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp	2009-12-11 10:14:22 UTC (rev 5641)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp	2009-12-11 10:14:24 UTC (rev 5642)
@@ -0,0 +1,70 @@
+/**
+    \file ADM_jsLoad.cpp
+    \brief Load oriented functions
+    \author mean (c) 2009 fixounet at free.fr
+
+
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_js.h"
+#include "ADM_editor/ADM_edit.hxx"
+#include "ADM_jsLoad.h"
+#include "ADM_jsAvidemux.h"
+#include "A_functions.h"
+extern ADM_Composer *video_body;
+/**
+    \fn jsLoadFile
+*/
+int jsLoadVideo(const char *s)
+{
+int ret=0;
+        enterLock();
+        if(A_openAvi(s)) 
+        {
+          ret=1;
+        }
+        leaveLock();
+    return ret;
+}
+#if 0
+/**
+    \fn jsAppendFile
+*/
+int jsAppendFile(const char *s)
+{
+int ret=0;
+        enterLock();
+        if(A_appendAvi(s)) 
+        {
+          ret=1;
+        }
+        leaveLock();
+    return ret;
+}
+
+/**
+    \fn jsClearSegments
+*/
+int jsClearSegments(void)
+{
+    video_body->clearSegment();
+    return 1;
+}
+/**
+    \fn jsAddSegment
+
+*/
+int  jsAddSegment(int ref, double start, double duration)
+{
+    if(true==video_body->addSegment(ref,(uint64_t)start,(uint64_t)duration)) return 1;
+    return 0;
+}
+#endif
+// EOF
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 10:14:22 UTC (rev 5641)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 10:14:24 UTC (rev 5642)
@@ -0,0 +1,223 @@
+/*
+--- DO NOT EDIT THIS FILE !!! ---
+
+This file has been generated automatically with 'jsapigen'.
+
+jsapigen is a glue-code generator for SpiderMonkey. It is distributed
+under the conditions of version 3 of the GNU General Public License.
+Please have a look at http://jsapigen.sourceforge.net.
+
+This file is NOT part of jsapigen and is NOT necessarily covered by
+jsapigen's license. For licensing information regarding this file,
+please refer to the software package which it is part of.
+
+*/
+
+#include "stdio.h"
+#include "ADM_jsAvidemux.h"
+void jsAvidemux(void)
+{
+        printf("Constructor invoked\n");
+}
+
+#include <string.h>
+#include <wchar.h>
+#include <jsapi.h>
+#ifndef JS_THREADSAFE
+#if JS_VERSION <= 170
+#define jsrefcount int
+#define JS_BeginRequest(cx)
+#define JS_EndRequest(cx)
+#define JS_SuspendRequest(cx)
+#define JS_ResumeRequest(cx, saveDepth)
+#endif
+#endif
+#ifndef JS_FS
+#define JS_FS(name, call, nargs, flags, extra) {name, call, nargs, flags, extra}
+#endif
+#ifndef JS_FS_END
+#define JS_FS_END {NULL, NULL, 0, 0, 0}
+#endif
+static JSPropertySpec jj_static_ps[] = {
+    {NULL, 0, 0, NULL, NULL}
+};
+static JSPropertySpec jj_ps[] = {
+    {NULL, 0, 0, NULL, NULL}
+};
+static JSFunctionSpec jj_static_fs[] = {
+    JS_FS_END
+};
+static JSFunctionSpec jj_fs[] = {
+    JS_FS_END
+};
+static JSBool
+jjadmloadVideo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var2;
+    char *var7;
+    int var3;
+    int var6;
+    int var8;
+    jsval var9;
+    JSString *var10;
+    jsval var22;
+    size_t var11;
+    size_t var12;
+    int var14;
+    jschar *var13;
+    jsval var23;
+    jsval var15;
+    JSBool var1;
+    var2 = NULL;
+    var7 = NULL;
+    var3 = 0;
+    var6 = 0;
+    var8 = 0;
+    var9 = JSVAL_NULL;
+    var10 = NULL;
+    var22 = JSVAL_NULL;
+    var11 = 0;
+    var12 = 0;
+    var14 = 0;
+    var13 = NULL;
+    var23 = JSVAL_NULL;
+    var15 = JSVAL_NULL;
+    var1 = JS_FALSE;
+    var2 = obj;
+    var6 = argc;
+    var8 = 0;
+    var8 = var8 < var6;
+    if (var8) {
+    var9 = argv[0];
+    var10 = JS_ValueToString(cx, var9);
+    if (!var10) {
+        goto do_return;
+    }
+    var22 = STRING_TO_JSVAL(var10);
+    argv[argc+0] = var22;
+    var11 = JS_GetStringLength(var10);
+    var12 = 1;
+    var12 += var11;
+    var7 = JS_malloc(cx, var12);
+    if (!var7) {
+        goto do_return;
+    }
+    var14 = 1;
+    var13 = JS_GetStringChars(var10);
+    var23 = STRING_TO_JSVAL(var10);
+    argv[argc+1] = var23;
+    {
+        size_t i;
+        for (i = 0; i < var11; ++i) {
+            var7[i] = wctob(var13[i]);
+        }
+        var7[var11] = '\0';
+    }
+    }
+    var3 = jsLoadVideo(var7);
+    if (JS_NewNumberValue(cx, var3, &var15) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+2] = var15;
+    if (rval) {
+        *rval = var15;
+    }
+    var1 = JS_TRUE;
+    do_return:
+    if (var14) {
+        JS_free(cx, var7);
+        var7 = NULL;
+        var14 = 0;
+    }
+    return var1;
+}
+static JSBool
+jjadm__construct__(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var17;
+    int var21;
+    JSBool var16;
+    var17 = NULL;
+    var21 = 0;
+    var16 = JS_FALSE;
+    var17 = obj;
+    var21 = argc;
+    jsAvidemux();
+    var16 = JS_TRUE;
+    return var16;
+}
+static JSPropertySpec jjadm_static_ps[] = {
+    {NULL, 0, 0, NULL, NULL}
+};
+static JSPropertySpec jjadm_ps[] = {
+    {NULL, 0, 0, NULL, NULL}
+};
+static JSFunctionSpec jjadm_static_fs[] = {
+    JS_FS("loadVideo", jjadmloadVideo, 1, 0, 3),
+    JS_FS_END
+};
+static JSFunctionSpec jjadm_fs[] = {
+    JS_FS_END
+};
+static JSClass jjadm_class = {
+    "adm",
+    0,
+    JS_PropertyStub,
+    JS_PropertyStub,
+    JS_PropertyStub,
+    JS_PropertyStub,
+    JS_EnumerateStub,
+    JS_ResolveStub,
+    JS_ConvertStub,
+    JS_FinalizeStub,
+    NULL,
+    NULL,
+    NULL,
+    jjadm__construct__,
+    NULL,
+    NULL,
+    NULL,
+    NULL
+};
+static JSObject *
+jjadm_init(JSContext *cx, JSObject *obj)
+{
+    JSObject *parent_proto, *proto;
+    JSClass *class;
+    if (!cx || !obj) {
+        JS_ReportError(cx, "invalid parameter");
+        return NULL;
+    }
+    if (!JS_EnterLocalRootScope(cx)) {
+        JS_ReportError(cx, "JS_EnterLocalRootScope failed");
+        return NULL;
+    }
+    parent_proto = NULL;
+    proto = NULL;
+    parent_proto = JS_NewObject(cx, NULL, NULL, NULL);
+    if (!parent_proto) {
+        JS_LeaveLocalRootScope(cx);
+        JS_ReportError(cx, "failed to create prototype");
+        return NULL;
+    }
+    class = &jjadm_class;
+    proto = JS_InitClass(cx, obj, parent_proto, class, jjadm__construct__, 0, jjadm_ps, jjadm_fs, jjadm_static_ps, jjadm_static_fs);
+    if (!proto) {
+        JS_LeaveLocalRootScope(cx);
+        JS_ReportError(cx, "failed to init class");
+        return NULL;
+    }
+    JS_LeaveLocalRootScope(cx);
+    return proto;
+}
+
+
+JSObject *jsAvidemuxInit(JSContext *cx,JSObject *obj)
+{
+          if (JS_DefineFunctions(cx, obj, jj_static_fs) != JS_TRUE) 
+          {
+                return NULL;
+          }
+          return jjadm_init(cx,obj);
+}
+

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 10:14:22 UTC (rev 5641)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 10:14:24 UTC (rev 5642)
@@ -0,0 +1,26 @@
+%{
+#include "stdio.h"
+#include "ADM_jsAvidemux.h"
+void jsAvidemux(void)
+{
+        printf("Constructor invoked\n");
+}
+%}
+class adm
+{
+        /*            JSFUNC      C FUNC  PARAM     */
+        function int loadVideo  : jsLoadVideo (cstring ) <static>;
+        construct               : jsAvidemux  ( ) <static>      ;
+};
+
+%<
+
+JSObject *jsAvidemuxInit(JSContext *cx,JSObject *obj)
+{
+          if (JS_DefineFunctions(cx, obj, jj_static_fs) != JS_TRUE) 
+          {
+                return NULL;
+          }
+          return jjadm_init(cx,obj);
+}
+%>

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-11 10:14:22 UTC (rev 5641)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-11 10:14:24 UTC (rev 5642)
@@ -149,6 +149,8 @@
 */
 extern "C" JSFunctionSpec  *jsGetIfFunctions(void);
 extern "C" JSFunctionSpec  *jsGetTestFunctions(void);
+extern "C" JSFunctionSpec  *jsGetAvidemuxFunctions(void);
+extern "C" JSObject *jsAvidemuxInit(JSContext *cx,JSObject *obj);
 static bool registerOne(const char *name,JSFunctionSpec *s,JSContext *cx,JSObject *obj)
 {
     if (JS_DefineFunctions(cx, obj, s) != JS_TRUE) 
@@ -174,6 +176,7 @@
     if(!s) goto none;
     if(!strcasecmp(s,"debug")) return dump(jsGetIfFunctions());
     if(!strcasecmp(s,"test")) return dump(jsGetTestFunctions());
+//    if(!strcasecmp(s,"load")) return dump(jsGetAvidemuxFunctions());
 none:
         jsLog(JS_LOG_NORMAL,"please use help(\"debug\") or help(\"test\"");
 }
@@ -182,6 +185,8 @@
 {
         registerOne("If",   jsGetIfFunctions(),    cx,obj);
         registerOne("Test", jsGetTestFunctions(),  cx,obj);
+      //  registerOne("Load", jsGetAvidemuxFunctions(),  cx,obj);
+        jsAvidemuxInit(cx,obj);
         return true;
 }
 /**
@@ -213,7 +218,11 @@
    
    // begin context created
     g_pObject = JS_NewObject(g_pCx, &global_class, 0, 0);
-    
+    if(!g_pObject)
+    {
+        ADM_error("Cannot initialize object\n");
+        return false;
+    }
     if(JS_TRUE!=JS_InitStandardClasses(g_pCx, g_pObject))
     {
         ADM_error("Cannot initialize standard classes\n");

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2009-12-11 10:14:22 UTC (rev 5641)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2009-12-11 10:14:24 UTC (rev 5642)
@@ -7,6 +7,9 @@
 # Factory test
         ADM_jsTestFactory.cpp  
         ADM_jsTestFactory_js.c
+# Load segment
+        ADM_jsAvidemux.cpp
+        ADM_jsAvidemux_js.c
 
 )
 



From mean at mail.berlios.de  Fri Dec 11 11:14:27 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 11:14:27 +0100
Subject: [Avidemux-svn-commit] r5644 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src
Message-ID: <200912111014.nBBAERkA024182@sheep.berlios.de>

Author: mean
Date: 2009-12-11 11:14:27 +0100 (Fri, 11 Dec 2009)
New Revision: 5644

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
Log:
[js] Win32

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-11 10:14:25 UTC (rev 5643)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-11 10:14:27 UTC (rev 5644)
@@ -21,7 +21,7 @@
 
 #define JSVAR(a,b,c) a b=c
 
-#if defined( __MINGW32__) && defined(JSDECLARE)
+#if defined( __MINGW32__) 
  pthread_t g_pThreadSpidermonkey ;
 #else
 JSVAR( pthread_t, g_pThreadSpidermonkey , 0);



From mean at mail.berlios.de  Fri Dec 11 11:14:26 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 11:14:26 +0100
Subject: [Avidemux-svn-commit] r5643 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_smjs
Message-ID: <200912111014.nBBAEQR6024172@sheep.berlios.de>

Author: mean
Date: 2009-12-11 11:14:25 +0100 (Fri, 11 Dec 2009)
New Revision: 5643

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_smjs/jsautocfg.h
Log:
[js] 32/64 bits setup

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_smjs/jsautocfg.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_smjs/jsautocfg.h	2009-12-11 10:14:24 UTC (rev 5642)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_smjs/jsautocfg.h	2009-12-11 10:14:25 UTC (rev 5643)
@@ -1,19 +1,15 @@
-#ifndef js_autocfg___
-#define js_autocfg___
+#ifndef js_cpucfg___
+#define js_cpucfg___
 
 /* AUTOMATICALLY GENERATED - DO NOT EDIT */
-#include "ADM_coreConfig.h"
-
-
 #ifdef ADM_BIG_ENDIAN
 #undef   IS_LITTLE_ENDIAN 
-#define  IS_BIG_ENDIAN 1
+#define  IS_BIG_ENDIAN   1
 #else
 #define IS_LITTLE_ENDIAN 1
 #undef  IS_BIG_ENDIAN
 #endif
 
-
 #define JS_BYTES_PER_BYTE   1L
 #define JS_BYTES_PER_SHORT  2L
 #define JS_BYTES_PER_INT    4L
@@ -25,31 +21,9 @@
 #ifdef ADM_CPU_64BIT
 #define JS_BYTES_PER_LONG   8L
 #define JS_BYTES_PER_WORD   8L
-#define JS_BITS_PER_LONG    64L
-#define JS_BITS_PER_WORD    64L
-#define JS_BITS_PER_LONG_LOG2   6L
-#define JS_BITS_PER_WORD_LOG2   6L
-#define JS_ALIGN_OF_LONG    8L
-#define JS_ALIGN_OF_INT64   8L
-#define JS_ALIGN_OF_DOUBLE  8L
-#define JS_ALIGN_OF_POINTER 8L
-#define JS_ALIGN_OF_WORD    8L
-
-
-#else // 32bits
+#else
 #define JS_BYTES_PER_LONG   4L
 #define JS_BYTES_PER_WORD   4L
-#define JS_BITS_PER_LONG    32L
-#define JS_BITS_PER_WORD    32L
-#define JS_BITS_PER_LONG_LOG2   5L
-#define JS_BITS_PER_WORD_LOG2   5L
-
-#define JS_ALIGN_OF_LONG    4L
-#define JS_ALIGN_OF_INT64   4L
-#define JS_ALIGN_OF_DOUBLE  4L
-#define JS_ALIGN_OF_POINTER 4L
-#define JS_ALIGN_OF_WORD    4L
-
 #endif
 
 #define JS_BITS_PER_BYTE    8L
@@ -59,6 +33,14 @@
 #define JS_BITS_PER_FLOAT   32L
 #define JS_BITS_PER_DOUBLE  64L
 
+#ifdef ADM_CPU_64BIT
+#define JS_BITS_PER_WORD    64L
+#define JS_BITS_PER_LONG    64L
+#else
+#define JS_BITS_PER_WORD    32L
+#define JS_BITS_PER_LONG    32L
+#endif
+
 #define JS_BITS_PER_BYTE_LOG2   3L
 #define JS_BITS_PER_SHORT_LOG2  4L
 #define JS_BITS_PER_INT_LOG2    5L
@@ -66,14 +48,39 @@
 #define JS_BITS_PER_FLOAT_LOG2  5L
 #define JS_BITS_PER_DOUBLE_LOG2 6L
 
+#ifdef ADM_CPU_64BIT
+#define JS_BITS_PER_WORD_LOG2   6L
+#define JS_BITS_PER_LONG_LOG2   6L
+#else
+#define JS_BITS_PER_WORD_LOG2   5L
+#define JS_BITS_PER_LONG_LOG2   5L
+#endif
+
+#define JS_ALIGN_OF_FLOAT   4L
 #define JS_ALIGN_OF_SHORT   2L
 #define JS_ALIGN_OF_INT     4L
-#define JS_ALIGN_OF_FLOAT   4L
 
+#ifdef ADM_CPU_64BIT
+#define ADM_ALIGN               8L
+#else
+#define ADM_ALIGN               4L
+#endif
+
+#define JS_ALIGN_OF_LONG    ADM_ALIGN
+#define JS_ALIGN_OF_INT64   ADM_ALIGN
+#define JS_ALIGN_OF_DOUBLE  ADM_ALIGN
+#define JS_ALIGN_OF_POINTER ADM_ALIGN
+#define JS_ALIGN_OF_WORD    ADM_ALIGN
+
+#ifdef ADM_CPU_64BIT
+#define JS_BYTES_PER_WORD_LOG2   3L
+#define JS_BYTES_PER_DWORD_LOG2  3L
+#define JS_WORDS_PER_DWORD_LOG2  0L
+#else
 #define JS_BYTES_PER_WORD_LOG2   2L
 #define JS_BYTES_PER_DWORD_LOG2  3L
 #define JS_WORDS_PER_DWORD_LOG2  1L
-
+#endif
 #define JS_STACK_GROWTH_DIRECTION (-1)
 
 #endif /* js_cpucfg___ */



From mean at mail.berlios.de  Fri Dec 11 11:14:29 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 11:14:29 +0100
Subject: [Avidemux-svn-commit] r5645 - in
	branches/avidemux_2.6_branch_mean/avidemux/common: ADM_editor
	ADM_script2/include ADM_script2/src
Message-ID: <200912111014.nBBAETTI024197@sheep.berlios.de>

Author: mean
Date: 2009-12-11 11:14:28 +0100 (Fri, 11 Dec 2009)
New Revision: 5645

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsUtils.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
Log:
[Js] Use jsapigen to rebuild js binding, does not work well with variable # of args

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp	2009-12-11 10:14:27 UTC (rev 5644)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp	2009-12-11 10:14:28 UTC (rev 5645)
@@ -81,7 +81,6 @@
   qfprintf (fd, "//--automatically built--\n");
   qfprintf (fd, "//--Project: %s\n\n",name);
 
-  qfprintf (fd, "var app = new Avidemux();\n");
   qfprintf (fd,"\n//** Video **\n");
   qfprintf (fd,"// %02ld videos source \n", _segments.getNbRefVideos());
 
@@ -93,38 +92,39 @@
         nm=ADM_cleanupPath(_segments.getRefVideo(i)->_aviheader->getMyName() );
         if(!i)
         {
-                qfprintf (fd, "app.load(\"%s\");\n", nm);
+                qfprintf (fd, "adm.loadVideo(\"%s\");\n", nm);
         }
         else
         {
-                qfprintf (fd, "app.append(\"%s\");\n", nm);
+                qfprintf (fd, "adm.appendVideo(\"%s\");\n", nm);
         }
         ADM_dealloc(nm);
     }
 
   qfprintf (fd,"//%02ld segments\n", _segments.getNbSegments());
-  qfprintf (fd,"app.clearSegments();\n");
+  qfprintf (fd,"adm.clearSegments();\n");
   
  
 
     for (uint32_t i = 0; i < _segments.getNbSegments(); i++)
     {
         _SEGMENT *seg=_segments.getSegment(i);
-        qfprintf (fd, "app.addSegment(%"LU",%"LLU",%"LLU");\n",seg->_reference,seg->_refStartTimeUs,seg->_durationUs);
+        qfprintf (fd, "adm.addSegment(%"LU",%"LLU",%"LLU");\n",seg->_reference,seg->_refStartTimeUs,seg->_durationUs);
     }
 
 // Markers
 //
+#if 0
         qfprintf(fd,"app.markerA=%"LLU";\n",getMarkerAPts());
         qfprintf(fd,"app.markerB=%"LLU";\n",getMarkerBPts());
-        
+#endif        
 // postproc
 //___________________________
 
 uint32_t pptype, ppstrength,ppswap;
         video_body->getPostProc( &pptype, &ppstrength, &ppswap);
         qfprintf(fd,"\n//** Postproc **\n");
-        qfprintf(fd,"app.video.setPostProc(%d,%d,%d);\n",pptype,ppstrength,ppswap);
+        qfprintf(fd,"adm.setPostProc(%d,%d,%d);\n",pptype,ppstrength,ppswap);
 
 // fps
 #if 0
@@ -142,11 +142,11 @@
 		qfprintf(fd, "\n//** Video Codec conf **\n");
         CONFcouple *couples=NULL;
     
-        qfprintf(fd, "app.video.codec(\"%s\"", videoEncoder6_GetCurrentEncoderName());
+        qfprintf(fd, "adm.videoCodec(\"%s\"", videoEncoder6_GetCurrentEncoderName());
         videoEncoder6_GetConfiguration(&couples);
         dumpConf(fd,couples);
         qfprintf(fd,");\n");
-
+#if 0
 // Video filters....
 //______________________________________________
     qfprintf(fd,"\n//** Filters **\n");
@@ -250,6 +250,7 @@
   {
         qfprintf(fd,"setSuccess(%d);\n",1);
   }
+#endif
   qfprintf(fd,"//app.Exit();\n");
   qfprintf(fd,"\n//End of script\n");
   // All done

Copied: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h (from rev 5644, branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h	2009-12-11 10:14:27 UTC (rev 5644)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h	2009-12-11 10:14:28 UTC (rev 5645)
@@ -0,0 +1,29 @@
+/**
+    \file ADM_jsAvidemux
+    \brief Standard includes and defines
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_JS_AVIDEMUX_H
+#define ADM_JS_AVIDEMUX_H
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+int jsLoadVideo(const char *c);
+int jsAppendVideo(const char *c);
+int jsClearSegments(void);
+int jsAddSegment(int ref, double start, double duration);
+#ifdef __cplusplus
+};
+#endif
+
+#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h	2009-12-11 10:14:27 UTC (rev 5644)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h	2009-12-11 10:14:28 UTC (rev 5645)
@@ -13,7 +13,7 @@
  ***************************************************************************/
 #ifndef ADM_JS_UTILS_H
 #define ADM_JS_UTILS_H
-
+#include "ADM_confCouple.h"
 typedef enum
 {
     ADM_JS_INVALID=0,
@@ -35,6 +35,6 @@
 
 // since long int will be coded by js as double, we need a centralized version to convert
 bool ADM_jsArg2Vars(const char *caller, int argc, jsval *argv, int paramNumber, ADM_PARAM_LIST *param);
+bool stringsToConfCouple(int nb,CONFcouple **conf,  const char **argv);
 
-
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp	2009-12-11 10:14:27 UTC (rev 5644)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp	2009-12-11 10:14:28 UTC (rev 5645)
@@ -15,7 +15,6 @@
  ***************************************************************************/
 #include "ADM_js.h"
 #include "ADM_editor/ADM_edit.hxx"
-#include "ADM_jsLoad.h"
 #include "ADM_jsAvidemux.h"
 #include "A_functions.h"
 extern ADM_Composer *video_body;
@@ -33,11 +32,11 @@
         leaveLock();
     return ret;
 }
-#if 0
+
 /**
     \fn jsAppendFile
 */
-int jsAppendFile(const char *s)
+int jsAppendVideo(const char *s)
 {
 int ret=0;
         enterLock();
@@ -66,5 +65,6 @@
     if(true==video_body->addSegment(ref,(uint64_t)start,(uint64_t)duration)) return 1;
     return 0;
 }
-#endif
+
+
 // EOF
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 10:14:27 UTC (rev 5644)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 10:14:28 UTC (rev 5645)
@@ -60,12 +60,12 @@
     int var8;
     jsval var9;
     JSString *var10;
-    jsval var22;
+    jsval var138;
     size_t var11;
     size_t var12;
     int var14;
     jschar *var13;
-    jsval var23;
+    jsval var139;
     jsval var15;
     JSBool var1;
     var2 = NULL;
@@ -75,12 +75,12 @@
     var8 = 0;
     var9 = JSVAL_NULL;
     var10 = NULL;
-    var22 = JSVAL_NULL;
+    var138 = JSVAL_NULL;
     var11 = 0;
     var12 = 0;
     var14 = 0;
     var13 = NULL;
-    var23 = JSVAL_NULL;
+    var139 = JSVAL_NULL;
     var15 = JSVAL_NULL;
     var1 = JS_FALSE;
     var2 = obj;
@@ -93,8 +93,8 @@
     if (!var10) {
         goto do_return;
     }
-    var22 = STRING_TO_JSVAL(var10);
-    argv[argc+0] = var22;
+    var138 = STRING_TO_JSVAL(var10);
+    argv[argc+0] = var138;
     var11 = JS_GetStringLength(var10);
     var12 = 1;
     var12 += var11;
@@ -104,8 +104,8 @@
     }
     var14 = 1;
     var13 = JS_GetStringChars(var10);
-    var23 = STRING_TO_JSVAL(var10);
-    argv[argc+1] = var23;
+    var139 = STRING_TO_JSVAL(var10);
+    argv[argc+1] = var139;
     {
         size_t i;
         for (i = 0; i < var11; ++i) {
@@ -132,20 +132,575 @@
     return var1;
 }
 static JSBool
-jjadm__construct__(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmclearSegments(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var17;
+    int var18;
     int var21;
+    jsval var22;
     JSBool var16;
     var17 = NULL;
+    var18 = 0;
     var21 = 0;
+    var22 = JSVAL_NULL;
     var16 = JS_FALSE;
     var17 = obj;
     var21 = argc;
-    jsAvidemux();
+    var18 = jsClearSegments();
+    if (JS_NewNumberValue(cx, var18, &var22) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+0] = var22;
+    if (rval) {
+        *rval = var22;
+    }
     var16 = JS_TRUE;
+    do_return:
     return var16;
 }
+static JSBool
+jjadmappendVideo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var24;
+    char *var29;
+    int var25;
+    int var28;
+    int var30;
+    jsval var31;
+    JSString *var32;
+    jsval var142;
+    size_t var33;
+    size_t var34;
+    int var36;
+    jschar *var35;
+    jsval var143;
+    jsval var37;
+    JSBool var23;
+    var24 = NULL;
+    var29 = NULL;
+    var25 = 0;
+    var28 = 0;
+    var30 = 0;
+    var31 = JSVAL_NULL;
+    var32 = NULL;
+    var142 = JSVAL_NULL;
+    var33 = 0;
+    var34 = 0;
+    var36 = 0;
+    var35 = NULL;
+    var143 = JSVAL_NULL;
+    var37 = JSVAL_NULL;
+    var23 = JS_FALSE;
+    var24 = obj;
+    var28 = argc;
+    var30 = 0;
+    var30 = var30 < var28;
+    if (var30) {
+    var31 = argv[0];
+    var32 = JS_ValueToString(cx, var31);
+    if (!var32) {
+        goto do_return;
+    }
+    var142 = STRING_TO_JSVAL(var32);
+    argv[argc+0] = var142;
+    var33 = JS_GetStringLength(var32);
+    var34 = 1;
+    var34 += var33;
+    var29 = JS_malloc(cx, var34);
+    if (!var29) {
+        goto do_return;
+    }
+    var36 = 1;
+    var35 = JS_GetStringChars(var32);
+    var143 = STRING_TO_JSVAL(var32);
+    argv[argc+1] = var143;
+    {
+        size_t i;
+        for (i = 0; i < var33; ++i) {
+            var29[i] = wctob(var35[i]);
+        }
+        var29[var33] = '\0';
+    }
+    }
+    var25 = jsAppendVideo(var29);
+    if (JS_NewNumberValue(cx, var25, &var37) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+2] = var37;
+    if (rval) {
+        *rval = var37;
+    }
+    var23 = JS_TRUE;
+    do_return:
+    if (var36) {
+        JS_free(cx, var29);
+        var29 = NULL;
+        var36 = 0;
+    }
+    return var23;
+}
+static JSBool
+jjadmaddSegment(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var39;
+    int var44;
+    double var45;
+    double var46;
+    int var40;
+    int var43;
+    int var47;
+    jsval var48;
+    int32 var49;
+    int var50;
+    jsval var51;
+    jsdouble var52;
+    int var53;
+    jsval var54;
+    jsdouble var55;
+    jsval var56;
+    JSBool var38;
+    var39 = NULL;
+    var44 = 0;
+    var45 = 0.0;
+    var46 = 0.0;
+    var40 = 0;
+    var43 = 0;
+    var47 = 0;
+    var48 = JSVAL_NULL;
+    var49 = 0;
+    var50 = 0;
+    var51 = JSVAL_NULL;
+    var52 = 0.0;
+    var53 = 0;
+    var54 = JSVAL_NULL;
+    var55 = 0.0;
+    var56 = JSVAL_NULL;
+    var38 = JS_FALSE;
+    var39 = obj;
+    var43 = argc;
+    var47 = 0;
+    var47 = var47 < var43;
+    if (var47) {
+    var48 = argv[0];
+    if (JS_ValueToInt32(cx, var48, &var49) != JS_TRUE) {
+        goto do_return;
+    }
+    var44 = (int)var49;
+    }
+    var50 = 1;
+    var50 = var50 < var43;
+    if (var50) {
+    var51 = argv[1];
+    if (JS_ValueToNumber(cx, var51, &var52) != JS_TRUE) {
+        goto do_return;
+    }
+    var45 = (double)var52;
+    }
+    var53 = 2;
+    var53 = var53 < var43;
+    if (var53) {
+    var54 = argv[2];
+    if (JS_ValueToNumber(cx, var54, &var55) != JS_TRUE) {
+        goto do_return;
+    }
+    var46 = (double)var55;
+    }
+    var40 = jsAddSegment(var44, var45, var46);
+    if (JS_NewNumberValue(cx, var40, &var56) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+0] = var56;
+    if (rval) {
+        *rval = var56;
+    }
+    var38 = JS_TRUE;
+    do_return:
+    return var38;
+}
+static JSBool
+jjadmsetPostProc(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var58;
+    int var63;
+    int var64;
+    int var65;
+    int var59;
+    int var62;
+    int var66;
+    jsval var67;
+    int32 var68;
+    int var69;
+    jsval var70;
+    int32 var71;
+    int var72;
+    jsval var73;
+    int32 var74;
+    jsval var75;
+    JSBool var57;
+    var58 = NULL;
+    var63 = 0;
+    var64 = 0;
+    var65 = 0;
+    var59 = 0;
+    var62 = 0;
+    var66 = 0;
+    var67 = JSVAL_NULL;
+    var68 = 0;
+    var69 = 0;
+    var70 = JSVAL_NULL;
+    var71 = 0;
+    var72 = 0;
+    var73 = JSVAL_NULL;
+    var74 = 0;
+    var75 = JSVAL_NULL;
+    var57 = JS_FALSE;
+    var58 = obj;
+    var62 = argc;
+    var66 = 0;
+    var66 = var66 < var62;
+    if (var66) {
+    var67 = argv[0];
+    if (JS_ValueToInt32(cx, var67, &var68) != JS_TRUE) {
+        goto do_return;
+    }
+    var63 = (int)var68;
+    }
+    var69 = 1;
+    var69 = var69 < var62;
+    if (var69) {
+    var70 = argv[1];
+    if (JS_ValueToInt32(cx, var70, &var71) != JS_TRUE) {
+        goto do_return;
+    }
+    var64 = (int)var71;
+    }
+    var72 = 2;
+    var72 = var72 < var62;
+    if (var72) {
+    var73 = argv[2];
+    if (JS_ValueToInt32(cx, var73, &var74) != JS_TRUE) {
+        goto do_return;
+    }
+    var65 = (int)var74;
+    }
+    var59 = jsSetPostProc(var63, var64, var65);
+    if (JS_NewNumberValue(cx, var59, &var75) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+0] = var75;
+    if (rval) {
+        *rval = var75;
+    }
+    var57 = JS_TRUE;
+    do_return:
+    return var57;
+}
+static JSBool
+jjadmvideoCodec(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var77;
+    char *var82;
+    char **var83;
+    int var78;
+    int var81;
+    int var84;
+    jsval var85;
+    JSString *var86;
+    jsval var147;
+    size_t var87;
+    size_t var88;
+    int var90;
+    jschar *var89;
+    jsval var148;
+    int var91;
+    jsval var92;
+    JSObject *var93;
+    jsval var149;
+    jsuint var94;
+    char **var96;
+    size_t var97;
+    int var123;
+    size_t var98;
+    JSString *var99;
+    size_t var100;
+    JSString **var106;
+    int var124;
+    jsuint var101;
+    jsint var102;
+    JSBool var103;
+    jsval var104;
+    JSString *var105;
+    jsval var150;
+    size_t var109;
+    jsuint var107;
+    jsint var108;
+    JSString *var111;
+    size_t var110;
+    size_t var112;
+    char var121;
+    size_t var122;
+    char *var113;
+    int var125;
+    char *var114;
+    size_t var115;
+    int var126;
+    char *var118;
+    jsuint var116;
+    jsint var117;
+    JSString *var120;
+    size_t var119;
+    size_t var127;
+    size_t var128;
+    int var130;
+    jschar *var129;
+    jsval var151;
+    jsval var131;
+    JSBool var76;
+    var77 = NULL;
+    var82 = NULL;
+    var83 = NULL;
+    var78 = 0;
+    var81 = 0;
+    var84 = 0;
+    var85 = JSVAL_NULL;
+    var86 = NULL;
+    var147 = JSVAL_NULL;
+    var87 = 0;
+    var88 = 0;
+    var90 = 0;
+    var89 = NULL;
+    var148 = JSVAL_NULL;
+    var91 = 0;
+    var92 = JSVAL_NULL;
+    var93 = NULL;
+    var149 = JSVAL_NULL;
+    var94 = 0;
+    var96 = NULL;
+    var97 = 0;
+    var123 = 0;
+    var98 = 0;
+    var99 = NULL;
+    var100 = 0;
+    var106 = NULL;
+    var124 = 0;
+    var101 = 0;
+    var102 = 0;
+    var103 = JS_FALSE;
+    var104 = JSVAL_NULL;
+    var105 = NULL;
+    var150 = JSVAL_NULL;
+    var109 = 0;
+    var107 = 0;
+    var108 = 0;
+    var111 = NULL;
+    var110 = 0;
+    var112 = 0;
+    var121 = 0;
+    var122 = 0;
+    var113 = NULL;
+    var125 = 0;
+    var114 = NULL;
+    var115 = 0;
+    var126 = 0;
+    var118 = NULL;
+    var116 = 0;
+    var117 = 0;
+    var120 = NULL;
+    var119 = 0;
+    var127 = 0;
+    var128 = 0;
+    var130 = 0;
+    var129 = NULL;
+    var151 = JSVAL_NULL;
+    var131 = JSVAL_NULL;
+    var76 = JS_FALSE;
+    var77 = obj;
+    var81 = argc;
+    var84 = 0;
+    var84 = var84 < var81;
+    if (var84) {
+    var85 = argv[0];
+    var86 = JS_ValueToString(cx, var85);
+    if (!var86) {
+        goto do_return;
+    }
+    var147 = STRING_TO_JSVAL(var86);
+    argv[argc+0] = var147;
+    var87 = JS_GetStringLength(var86);
+    var88 = 1;
+    var88 += var87;
+    var82 = JS_malloc(cx, var88);
+    if (!var82) {
+        goto do_return;
+    }
+    var90 = 1;
+    var89 = JS_GetStringChars(var86);
+    var148 = STRING_TO_JSVAL(var86);
+    argv[argc+1] = var148;
+    {
+        size_t i;
+        for (i = 0; i < var87; ++i) {
+            var82[i] = wctob(var89[i]);
+        }
+        var82[var87] = '\0';
+    }
+    }
+    var91 = 1;
+    var91 = var91 < var81;
+    if (var91) {
+    var92 = argv[1];
+    if (JS_ValueToObject(cx, var92, &var93) != JS_TRUE) {
+        goto do_return;
+    }
+    var149 = OBJECT_TO_JSVAL(var93);
+    argv[argc+2] = var149;
+    if (JS_GetArrayLength(cx, var93, &var94) != JS_TRUE) {
+        goto do_return;
+    }
+    var97 = sizeof(var96);
+    var97 *= var94;
+    var83 = JS_malloc(cx, var97);
+    if (!var83) {
+        goto do_return;
+    }
+    var123 = 1;
+    var98 = var94;
+    var100 = sizeof(var99);
+    var98 *= var100;
+    var106 = JS_malloc(cx, var98);
+    if (!var106) {
+        goto do_return;
+    }
+    var124 = 1;
+    var101 = var94;
+    var102 = -1;
+    while (var101)
+    {
+    var101 += var102;
+    var103 = JS_GetElement(cx, var93, var101, &var104);
+    var105 = JS_ValueToString(cx, var104);
+    if (!var105) {
+        goto do_return;
+    }
+    var150 = STRING_TO_JSVAL(var105);
+    argv[argc+3] = var150;
+    var106[var101] = var105;
+    }
+    var109 = 0;
+    var107 = var94;
+    var108 = -1;
+    while (var107)
+    {
+    var107 += var108;
+    var111 = var106[var107];
+    var110 = JS_GetStringLength(var111);
+    var109 += var110;
+    var112 = 1;
+    var109 += var112;
+    }
+    var122 = sizeof(var121);
+    var122 *= var109;
+    var113 = JS_malloc(cx, var122);
+    if (!var113) {
+        goto do_return;
+    }
+    var125 = 1;
+    var115 = sizeof(var114);
+    var115 *= var94;
+    var83 = JS_malloc(cx, var115);
+    if (!var83) {
+        goto do_return;
+    }
+    var126 = 1;
+    var118 = var113;
+    var118 += var109;
+    var116 = var94;
+    var117 = -1;
+    while (var116)
+    {
+    var116 += var117;
+    var120 = var106[var116];
+    var119 = JS_GetStringLength(var120);
+    var118 -= var119;
+    var118 += var117;
+    var127 = JS_GetStringLength(var120);
+    var128 = 1;
+    var128 += var127;
+    var118 = JS_malloc(cx, var128);
+    if (!var118) {
+        goto do_return;
+    }
+    var130 = 1;
+    var129 = JS_GetStringChars(var120);
+    var151 = STRING_TO_JSVAL(var120);
+    argv[argc+4] = var151;
+    {
+        size_t i;
+        for (i = 0; i < var127; ++i) {
+            var118[i] = wctob(var129[i]);
+        }
+        var118[var127] = '\0';
+    }
+    var83[var116] = var118;
+    }
+    }
+    var78 = jsVideoCodec(var82, var83);
+    if (JS_NewNumberValue(cx, var78, &var131) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+5] = var131;
+    if (rval) {
+        *rval = var131;
+    }
+    var76 = JS_TRUE;
+    do_return:
+    if (var130) {
+        JS_free(cx, var118);
+        var118 = NULL;
+        var130 = 0;
+    }
+    if (var126) {
+        JS_free(cx, var83);
+        var83 = NULL;
+        var126 = 0;
+    }
+    if (var125) {
+        JS_free(cx, var113);
+        var113 = NULL;
+        var125 = 0;
+    }
+    if (var124) {
+        JS_free(cx, var106);
+        var106 = NULL;
+        var124 = 0;
+    }
+    if (var123) {
+        JS_free(cx, var83);
+        var83 = NULL;
+        var123 = 0;
+    }
+    if (var90) {
+        JS_free(cx, var82);
+        var82 = NULL;
+        var90 = 0;
+    }
+    return var76;
+}
+static JSBool
+jjadm__construct__(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var133;
+    int var137;
+    JSBool var132;
+    var133 = NULL;
+    var137 = 0;
+    var132 = JS_FALSE;
+    var133 = obj;
+    var137 = argc;
+    jsAvidemux();
+    var132 = JS_TRUE;
+    return var132;
+}
 static JSPropertySpec jjadm_static_ps[] = {
     {NULL, 0, 0, NULL, NULL}
 };
@@ -154,6 +709,11 @@
 };
 static JSFunctionSpec jjadm_static_fs[] = {
     JS_FS("loadVideo", jjadmloadVideo, 1, 0, 3),
+    JS_FS("clearSegments", jjadmclearSegments, 0, 0, 1),
+    JS_FS("appendVideo", jjadmappendVideo, 1, 0, 3),
+    JS_FS("addSegment", jjadmaddSegment, 3, 0, 1),
+    JS_FS("setPostProc", jjadmsetPostProc, 3, 0, 1),
+    JS_FS("videoCodec", jjadmvideoCodec, 2, 0, 6),
     JS_FS_END
 };
 static JSFunctionSpec jjadm_fs[] = {

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 10:14:27 UTC (rev 5644)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 10:14:28 UTC (rev 5645)
@@ -6,11 +6,16 @@
         printf("Constructor invoked\n");
 }
 %}
+        /*            JSFUNC      C FUNC  PARAM     */
 class adm
 {
-        /*            JSFUNC      C FUNC  PARAM     */
-        function int loadVideo  : jsLoadVideo (cstring ) <static>;
-        construct               : jsAvidemux  ( ) <static>      ;
+        function int loadVideo      : jsLoadVideo (cstring ) <static>;
+        function int clearSegments  : jsClearSegments () <static>;
+        function int appendVideo    : jsAppendVideo (cstring ) <static>;
+        function int addSegment     : jsAddSegment (int ,double , double ) <static>;
+        function int setPostProc    : jsSetPostProc (int ,int , int ) <static>;
+        function int videoCodec     : jsVideoCodec(cstring,cstring[])   <static>;
+        construct                   : jsAvidemux  ( ) <static>     ; 
 };
 
 %<

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2009-12-11 10:14:27 UTC (rev 5644)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2009-12-11 10:14:28 UTC (rev 5645)
@@ -181,13 +181,12 @@
 	if( strncmp(buf,"//AD",4) )
     {
             if (report->filename || report->lineno)
-                jsLog(JS_LOG_ERROR,"%s: line %d:\nMsg: %s\n"
-                              "Not an ECMAScript file. Try open it with 'File' -> 'Open...'",
+                jsLog(JS_LOG_ERROR,"%s: line %d:\nMsg: %s\n",
                               report->filename,
                               report->lineno,
                               message);
             else
-                jsLog(JS_LOG_ERROR,"Not an ECMAScript file. Try open it with 'File' -> 'Open...'");
+                jsLog(JS_LOG_ERROR,"Error");
     
 	}else
     {

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsUtils.cpp	2009-12-11 10:14:27 UTC (rev 5644)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsUtils.cpp	2009-12-11 10:14:28 UTC (rev 5645)
@@ -92,4 +92,40 @@
     }
     return true;
 }
+/**
+    \fn stringsToConfCouple
+    \brief Convert js args to confcouple
+
+*/
+bool stringsToConfCouple(int nb,CONFcouple **conf,  const char **argv)
+{
+  *conf=NULL;
+  if(!nb) return true;
+  CONFcouple *c=new CONFcouple(nb);
+  *conf=c;
+    for(int i=0;i<nb;i++)
+    {
+        
+        char *dupe=   ADM_strdup(argv[i]);
+        char *name,*value;
+        // dupe is in the form name=value
+        name=dupe;
+        value=name;
+        char *tail=dupe+strlen(dupe);
+        while(value<tail)
+        {
+            if(*value=='=') 
+                {
+                    *value=0;
+                    value++;
+                    break;
+                }
+            value++;
+        }
+        c->setInternalName(name,value);
+        //printf("%s -> [%s,%s]\n",param,name,value);
+        ADM_dezalloc(dupe);
+    }
+    return true;
+}
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2009-12-11 10:14:27 UTC (rev 5644)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2009-12-11 10:14:28 UTC (rev 5645)
@@ -10,7 +10,8 @@
 # Load segment
         ADM_jsAvidemux.cpp
         ADM_jsAvidemux_js.c
-
+#
+        ADM_jsVideo.cpp
 )
 
 ADD_LIBRARY(ADM_script26 STATIC ${ADM_script_SRCS})



From mean at mail.berlios.de  Fri Dec 11 11:14:30 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 11:14:30 +0100
Subject: [Avidemux-svn-commit] r5646 - in
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2:
	include src
Message-ID: <200912111014.nBBAEUL6024207@sheep.berlios.de>

Author: mean
Date: 2009-12-11 11:14:30 +0100 (Fri, 11 Dec 2009)
New Revision: 5646

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsVideo.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp
Log:
[js] New file for main class

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsVideo.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsVideo.h	2009-12-11 10:14:28 UTC (rev 5645)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsVideo.h	2009-12-11 10:14:30 UTC (rev 5646)
@@ -0,0 +1,27 @@
+/**
+    \file ADM_jsVideo
+    \brief Video codec etc..
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_JS_VIDEO_H
+#define ADM_JS_VIDEO_H
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+int jsVideoCodec(const char *codec,const char **p);
+int jsSetPostProc (int a,int b, int c);
+#ifdef __cplusplus
+};
+#endif
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp	2009-12-11 10:14:28 UTC (rev 5645)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp	2009-12-11 10:14:30 UTC (rev 5646)
@@ -0,0 +1,74 @@
+/**
+    \file ADM_jsVideo.cpp
+    \brief Video oriented functions
+    \author mean (c) 2009 fixounet at free.fr
+
+
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_js.h"
+#include "ADM_editor/ADM_edit.hxx"
+#include "ADM_jsAvidemux.h"
+#include "ADM_jsVideo.h"
+#include "A_functions.h"
+#include "ADM_videoEncoderApi.h"
+#include "GUI_ui.h"
+extern ADM_Composer *video_body;
+bool A_setVideoCodec(const char *nm);
+/**
+    \fn jsSetPostProc
+*/
+int jsSetPostProc (int a,int b, int c)
+{
+    return video_body->setPostProc(a,b,c);
+}
+
+/**
+    \fn jsLoadFile
+*/
+int jsVideoCodec(const char *codec,const char **params)
+{
+    // First how many params ?
+    const char **p=params;
+    int nb=0;
+    while(*p) {nb++;p++;}
+       
+        if(A_setVideoCodec(codec)==false)
+        {
+            jsLog(JS_LOG_ERROR,"Could not select codec %s\n",codec);
+            return 0;
+        }
+        CONFcouple *c;
+        stringsToConfCouple(nb,&c,params);
+        if(false==videoEncoder6_SetConfiguration(c))
+        {
+            jsLog(JS_LOG_NORMAL,"Selected codec %s\n",codec);
+            return 0;
+        }
+    
+    return 1;
+}
+
+/**
+    \fn A_setVideoCodec
+*/
+bool A_setVideoCodec(const char *nm)
+{
+    int idx=videoEncoder6_GetIndexFromName(nm);
+    if(idx==-1)
+    {
+        ADM_error("No such encoder :%s\n",nm);
+    }
+    // Select by index
+    videoEncoder6_SetCurrentEncoder(idx);
+    UI_setVideoCodec(idx);
+    return true;
+}
+//EOF
\ No newline at end of file



From mean at mail.berlios.de  Fri Dec 11 11:14:32 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 11:14:32 +0100
Subject: [Avidemux-svn-commit] r5647 - in
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2:
	include src
Message-ID: <200912111014.nBBAEWCA024217@sheep.berlios.de>

Author: mean
Date: 2009-12-11 11:14:32 +0100 (Fri, 11 Dec 2009)
New Revision: 5647

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsVideo.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsUtils.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/idl.make
Log:
[script] Add video function + workaround jsapigen limitation with variable number of arhiments

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h	2009-12-11 10:14:30 UTC (rev 5646)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h	2009-12-11 10:14:32 UTC (rev 5647)
@@ -13,7 +13,7 @@
  ***************************************************************************/
 #ifndef ADM_JS_AVIDEMUX_H
 #define ADM_JS_AVIDEMUX_H
-
+#include "jsapi.h"
 #ifdef __cplusplus
 extern "C" {
 #endif
@@ -22,6 +22,7 @@
 int jsAppendVideo(const char *c);
 int jsClearSegments(void);
 int jsAddSegment(int ref, double start, double duration);
+JSBool jsAdmvideoCodec(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 #ifdef __cplusplus
 };
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h	2009-12-11 10:14:30 UTC (rev 5646)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsUtils.h	2009-12-11 10:14:32 UTC (rev 5647)
@@ -36,5 +36,5 @@
 // since long int will be coded by js as double, we need a centralized version to convert
 bool ADM_jsArg2Vars(const char *caller, int argc, jsval *argv, int paramNumber, ADM_PARAM_LIST *param);
 bool stringsToConfCouple(int nb,CONFcouple **conf,  const char **argv);
-
+bool jsArgToConfCouple(int nb,CONFcouple **conf,  jsval *argv);
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsVideo.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsVideo.h	2009-12-11 10:14:30 UTC (rev 5646)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsVideo.h	2009-12-11 10:14:32 UTC (rev 5647)
@@ -20,6 +20,7 @@
 
 int jsVideoCodec(const char *codec,const char **p);
 int jsSetPostProc (int a,int b, int c);
+
 #ifdef __cplusplus
 };
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 10:14:30 UTC (rev 5646)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 10:14:32 UTC (rev 5647)
@@ -396,7 +396,7 @@
     return var57;
 }
 static JSBool
-jjadmvideoCodec(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmvideoCodec_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var77;
     char *var82;
@@ -713,7 +713,7 @@
     JS_FS("appendVideo", jjadmappendVideo, 1, 0, 3),
     JS_FS("addSegment", jjadmaddSegment, 3, 0, 1),
     JS_FS("setPostProc", jjadmsetPostProc, 3, 0, 1),
-    JS_FS("videoCodec", jjadmvideoCodec, 2, 0, 6),
+    JS_FS("videoCodec", jsAdmvideoCodec,  2, 0, 6),
     JS_FS_END
 };
 static JSFunctionSpec jjadm_fs[] = {

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 10:14:30 UTC (rev 5646)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 10:14:32 UTC (rev 5647)
@@ -14,7 +14,7 @@
         function int appendVideo    : jsAppendVideo (cstring ) <static>;
         function int addSegment     : jsAddSegment (int ,double , double ) <static>;
         function int setPostProc    : jsSetPostProc (int ,int , int ) <static>;
-        function int videoCodec     : jsVideoCodec(cstring,cstring[])   <static>;
+        function int videoCodec_ignore     : jsVideoCodec(cstring,cstring[])   <static>;
         construct                   : jsAvidemux  ( ) <static>     ; 
 };
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsUtils.cpp	2009-12-11 10:14:30 UTC (rev 5646)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsUtils.cpp	2009-12-11 10:14:32 UTC (rev 5647)
@@ -128,4 +128,40 @@
     }
     return true;
 }
+/**
+    \fn jsArgToConfCouple
+    \brief Convert js args to confcouple
+
+*/
+bool jsArgToConfCouple(int nb,CONFcouple **conf,  jsval *argv)
+{
+  *conf=NULL;
+  if(!nb) return true;
+  CONFcouple *c=new CONFcouple(nb);
+  *conf=c;
+    for(int i=0;i<nb;i++)
+    {
+        char *param = JS_GetStringBytes(JSVAL_TO_STRING(argv[i]));
+        char *dupe=   ADM_strdup(param);
+        char *name,*value;
+        // dupe is in the form name=value
+        name=dupe;
+        value=name;
+        char *tail=dupe+strlen(dupe);
+        while(value<tail)
+        {
+            if(*value=='=') 
+                {
+                    *value=0;
+                    value++;
+                    break;
+                }
+            value++;
+        }
+        c->setInternalName(name,value);
+        //printf("%s -> [%s,%s]\n",param,name,value);
+        ADM_dezalloc(dupe);
+    }
+    return true;
+}
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp	2009-12-11 10:14:30 UTC (rev 5646)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp	2009-12-11 10:14:32 UTC (rev 5647)
@@ -4,6 +4,10 @@
     \author mean (c) 2009 fixounet at free.fr
 
 
+    jsapigen does not like much variable number of arguments
+    In that case, we patch the generated file to go back to native spidermonkey api
+
+
 */
 /***************************************************************************
  *                                                                         *
@@ -30,31 +34,37 @@
     return video_body->setPostProc(a,b,c);
 }
 
+
 /**
-    \fn jsLoadFile
+    \fn Codec
+    
 */
-int jsVideoCodec(const char *codec,const char **params)
-{
-    // First how many params ?
-    const char **p=params;
-    int nb=0;
-    while(*p) {nb++;p++;}
-       
+extern "C" int   jsVideoCodec(const char *a,const char **b) {return 0;}
+JSBool jsAdmvideoCodec(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{// begin Codec
+        *rval = BOOLEAN_TO_JSVAL(false);
+        if(argc <1)
+                return JS_FALSE;
+        if(JSVAL_IS_STRING(argv[0]) == false )
+        {
+                jsLog(JS_LOG_ERROR,"Cannot set codec, first parameter is not a string\n");
+                return JS_FALSE;
+        }
+        char *codec=JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
+        // Set codec.
+        
         if(A_setVideoCodec(codec)==false)
         {
             jsLog(JS_LOG_ERROR,"Could not select codec %s\n",codec);
-            return 0;
+            return JS_FALSE;
         }
         CONFcouple *c;
-        stringsToConfCouple(nb,&c,params);
-        if(false==videoEncoder6_SetConfiguration(c))
-        {
-            jsLog(JS_LOG_NORMAL,"Selected codec %s\n",codec);
-            return 0;
-        }
-    
-    return 1;
-}
+        jsArgToConfCouple(argc-1,&c,argv+1);
+        *rval = BOOLEAN_TO_JSVAL( videoEncoder6_SetConfiguration(c));
+        jsLog(JS_LOG_NORMAL,"Selected codec %s\n",codec);
+        if(c) delete c;
+        return JS_TRUE;
+}// end Codec
 
 /**
     \fn A_setVideoCodec

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/idl.make
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/idl.make	2009-12-11 10:14:30 UTC (rev 5646)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/idl.make	2009-12-11 10:14:32 UTC (rev 5647)
@@ -2,5 +2,6 @@
 cs:=$(subst .idl,.c,$(idls))
 %.c : %.idl
 	echo processing $@
-	jsapigen < $< > $@ 
+	jsapigen < $< > /tmp/xx
+	cat /tmp/xx   | sed 's/"\(.*\)_ignore"/"\1"/g'  | sed 's/, jjadm\(.*\)_ignore,/, jsAdm\1, /g' > $@
 all: $(cs)



From mean at mail.berlios.de  Fri Dec 11 11:24:42 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 11:24:42 +0100
Subject: [Avidemux-svn-commit] r5648 -
	branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2
Message-ID: <200912111024.nBBAOg06024853@sheep.berlios.de>

Author: mean
Date: 2009-12-11 11:24:42 +0100 (Fri, 11 Dec 2009)
New Revision: 5648

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
Log:
[gtk] Add missing include

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2009-12-11 10:14:32 UTC (rev 5647)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2009-12-11 10:24:42 UTC (rev 5648)
@@ -39,6 +39,7 @@
 #include "ADM_render/GUI_renderInternal.h"
 #include "ADM_vidMisc.h"
 #include "GUI_glade.h"
+#include "A_functions.h"
 
 extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h);
 extern void ADM_initUIGtk(GtkWidget *guiRootWindow);



From mean at mail.berlios.de  Fri Dec 11 16:24:39 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 16:24:39 +0100
Subject: [Avidemux-svn-commit] r5649 - in
	branches/avidemux_2.6_branch_mean/avidemux/common: ADM_editor
	ADM_script2/include ADM_script2/src
Message-ID: <200912111524.nBBFOdnt005391@sheep.berlios.de>

Author: mean
Date: 2009-12-11 16:24:38 +0100 (Fri, 11 Dec 2009)
New Revision: 5649

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAudio.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
Log:
[js] More methods added to adm class

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp	2009-12-11 10:24:42 UTC (rev 5648)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp	2009-12-11 15:24:38 UTC (rev 5649)
@@ -146,7 +146,7 @@
         videoEncoder6_GetConfiguration(&couples);
         dumpConf(fd,couples);
         qfprintf(fd,");\n");
-#if 0
+
 // Video filters....
 //______________________________________________
     qfprintf(fd,"\n//** Filters **\n");
@@ -155,7 +155,7 @@
     {
         // Grab its name...
         uint32_t tag=ADM_vf_getTag(i);
-        qfprintf(fd, "app.video.addFilter(\"%s\"", ADM_vf_getInternalNameFromTag(tag));
+        qfprintf(fd, "adm.addVideoFilter(\"%s\"", ADM_vf_getInternalNameFromTag(tag));
         // Now get the filter settings (if any)
         CONFcouple *c=NULL;
         ADM_vf_getConfigurationFromIndex(i,&c);
@@ -173,7 +173,7 @@
    uint32_t delay,bitrate;
    
    qfprintf(fd,"\n//** Audio **\n");
-   qfprintf(fd,"app.audio.reset();\n");
+   qfprintf(fd,"adm.audioReset();\n");
 #if 0
    // External audio ?
         char *audioName;
@@ -199,7 +199,7 @@
 #endif
    couples=NULL;
    getAudioExtraConf(&bitrate,&couples);
-    qfprintf(fd,"app.audio.codec(\"%s\",%d",audioCodecGetName(),bitrate); 
+    qfprintf(fd,"adm.audioCodec(\"%s\",%d",audioCodecGetName(),bitrate); 
     dumpConf(fd,couples);
     qfprintf(fd,");\n");
 
@@ -236,7 +236,7 @@
         const char *containerName=ADM_mx_getName(index);
         ADM_mx_getExtraConf( index,&containerConf);
         
-        qfprintf(fd,"app.setContainer(\"%s\"",containerName); 
+        qfprintf(fd,"adm.setContainer(\"%s\"",containerName); 
         dumpConf(fd,containerConf);
         qfprintf(fd,");\n");
   // -------- /Muxer -----------------------
@@ -250,7 +250,7 @@
   {
         qfprintf(fd,"setSuccess(%d);\n",1);
   }
-#endif
+
   qfprintf(fd,"//app.Exit();\n");
   qfprintf(fd,"\n//End of script\n");
   // All done

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h	2009-12-11 10:24:42 UTC (rev 5648)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h	2009-12-11 15:24:38 UTC (rev 5649)
@@ -22,6 +22,12 @@
 int jsAppendVideo(const char *c);
 int jsClearSegments(void);
 int jsAddSegment(int ref, double start, double duration);
+int jsAudioReset(void);
+
+// non jsapigen function, variables number of args
+JSBool jsAdmaddVideoFilter(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
+JSBool jsAdmaudioCodec(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
+JSBool jsAdmsetContainer(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool jsAdmvideoCodec(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 #ifdef __cplusplus
 };

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAudio.cpp	2009-12-11 10:24:42 UTC (rev 5648)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAudio.cpp	2009-12-11 15:24:38 UTC (rev 5649)
@@ -0,0 +1,80 @@
+/**
+    \file ADM_jsAudio.cpp
+    \brief Audio oriented functions
+    \author mean (c) 2009 fixounet at free.fr
+
+
+    jsapigen does not like much variable number of arguments
+    In that case, we patch the generated file to go back to native spidermonkey api
+
+
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_js.h"
+#include "ADM_editor/ADM_edit.hxx"
+#include "ADM_jsAvidemux.h"
+#include "A_functions.h"
+#include "GUI_ui.h"
+#include "ADM_audioFilterInterface.h"
+#include "audioEncoderApi.h"
+extern ADM_Composer *video_body;
+/**
+    \fn int jsAudioReset(void);
+*/
+int jsAudioReset (void)
+{
+    audioFilterReset();
+    return 1;
+}
+/**
+    \fn 
+*/  
+extern "C" int   jsAudioCodec(const char *a,const char **b) {return 0;}
+JSBool jsAdmaudioCodec(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+        // default return value
+        *rval = BOOLEAN_TO_JSVAL(false);
+        if(argc < 2)
+                return JS_FALSE;
+        if(JSVAL_IS_STRING(argv[0]) == false || JSVAL_IS_INT(argv[1]) == false )            return JS_FALSE;
+        for(int i=2;i<argc;i++)  if(JSVAL_IS_STRING(argv[i]) == false) return JS_FALSE;
+
+        // Get Codec...
+        char *name = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
+        ADM_LowerCase(name);
+        
+        // First search the codec by its name
+        if(!audioCodecSetByName(name))
+        {
+                *rval = BOOLEAN_TO_JSVAL(false);
+                jsLog(JS_LOG_ERROR,"Cannot set audio codec %s\n",name);
+        }
+        else
+        {
+            // begin set bitrate
+            uint32_t bitrate=JSVAL_TO_INT(argv[1]);
+            // Construct couples
+            CONFcouple *c=NULL;
+            if(argc>2)
+            {
+                int nb=argc-2;
+                jsArgToConfCouple( nb,&c,  argv+2);
+            }
+            *rval = BOOLEAN_TO_JSVAL(setAudioExtraConf(bitrate,c));
+            if(c) delete c;
+        }
+
+        // end set bitrate
+        
+        return JS_TRUE;
+}
+
+
+//EOF
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp	2009-12-11 10:24:42 UTC (rev 5648)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp	2009-12-11 15:24:38 UTC (rev 5649)
@@ -17,19 +17,37 @@
 #include "ADM_editor/ADM_edit.hxx"
 #include "ADM_jsAvidemux.h"
 #include "A_functions.h"
+#include "ADM_muxerProto.h"
+#include "GUI_ui.h"
 extern ADM_Composer *video_body;
 /**
+    \fn ADM_JSAvidemux
+    \brief Select the current container from a string
+*/
+bool A_setContainer(const char *cont)
+{
+    int idx=ADM_MuxerIndexFromName(cont);
+    if(idx==-1)
+    {
+        ADM_error("Cannot find muxer for format=%s\n",cont);
+        return false;
+    }
+    UI_SetCurrentFormat(idx);
+    return true;
+}
+
+/**
     \fn jsLoadFile
 */
 int jsLoadVideo(const char *s)
 {
 int ret=0;
-        enterLock();
+        
         if(A_openAvi(s)) 
         {
           ret=1;
         }
-        leaveLock();
+        
     return ret;
 }
 
@@ -39,12 +57,12 @@
 int jsAppendVideo(const char *s)
 {
 int ret=0;
-        enterLock();
+        
         if(A_appendAvi(s)) 
         {
           ret=1;
         }
-        leaveLock();
+        
     return ret;
 }
 
@@ -67,4 +85,35 @@
 }
 
 
+/**
+    \fn Codec
+    
+*/
+extern "C" int   jsSetContainer(const char *a,const char **b) {return 0;}
+JSBool jsAdmsetContainer(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{// begin Codec
+    
+        // default return value
+        *rval = BOOLEAN_TO_JSVAL(false);
+        if(argc < 1)
+                return JS_FALSE;
+        if(JSVAL_IS_STRING(argv[0]) == false)
+                return JS_FALSE;
+        char *str = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
+        
+        if(A_setContainer(str))
+        {
+            CONFcouple *c;
+            jsArgToConfCouple(argc-1,&c,argv+1);
+            int idx=ADM_MuxerIndexFromName(str);
+            if(idx!=-1)
+            {
+                *rval = BOOLEAN_TO_JSVAL( ADM_mx_setExtraConf(idx,c));
+            }
+            if(c) delete c;
+        }
+        return JS_TRUE;
+}// end Codec
+
+
 // EOF
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 10:24:42 UTC (rev 5648)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 15:24:38 UTC (rev 5649)
@@ -60,12 +60,12 @@
     int var8;
     jsval var9;
     JSString *var10;
-    jsval var138;
+    jsval var313;
     size_t var11;
     size_t var12;
     int var14;
     jschar *var13;
-    jsval var139;
+    jsval var314;
     jsval var15;
     JSBool var1;
     var2 = NULL;
@@ -75,12 +75,12 @@
     var8 = 0;
     var9 = JSVAL_NULL;
     var10 = NULL;
-    var138 = JSVAL_NULL;
+    var313 = JSVAL_NULL;
     var11 = 0;
     var12 = 0;
     var14 = 0;
     var13 = NULL;
-    var139 = JSVAL_NULL;
+    var314 = JSVAL_NULL;
     var15 = JSVAL_NULL;
     var1 = JS_FALSE;
     var2 = obj;
@@ -93,8 +93,8 @@
     if (!var10) {
         goto do_return;
     }
-    var138 = STRING_TO_JSVAL(var10);
-    argv[argc+0] = var138;
+    var313 = STRING_TO_JSVAL(var10);
+    argv[argc+0] = var313;
     var11 = JS_GetStringLength(var10);
     var12 = 1;
     var12 += var11;
@@ -104,8 +104,8 @@
     }
     var14 = 1;
     var13 = JS_GetStringChars(var10);
-    var139 = STRING_TO_JSVAL(var10);
-    argv[argc+1] = var139;
+    var314 = STRING_TO_JSVAL(var10);
+    argv[argc+1] = var314;
     {
         size_t i;
         for (i = 0; i < var11; ++i) {
@@ -168,12 +168,12 @@
     int var30;
     jsval var31;
     JSString *var32;
-    jsval var142;
+    jsval var317;
     size_t var33;
     size_t var34;
     int var36;
     jschar *var35;
-    jsval var143;
+    jsval var318;
     jsval var37;
     JSBool var23;
     var24 = NULL;
@@ -183,12 +183,12 @@
     var30 = 0;
     var31 = JSVAL_NULL;
     var32 = NULL;
-    var142 = JSVAL_NULL;
+    var317 = JSVAL_NULL;
     var33 = 0;
     var34 = 0;
     var36 = 0;
     var35 = NULL;
-    var143 = JSVAL_NULL;
+    var318 = JSVAL_NULL;
     var37 = JSVAL_NULL;
     var23 = JS_FALSE;
     var24 = obj;
@@ -201,8 +201,8 @@
     if (!var32) {
         goto do_return;
     }
-    var142 = STRING_TO_JSVAL(var32);
-    argv[argc+0] = var142;
+    var317 = STRING_TO_JSVAL(var32);
+    argv[argc+0] = var317;
     var33 = JS_GetStringLength(var32);
     var34 = 1;
     var34 += var33;
@@ -212,8 +212,8 @@
     }
     var36 = 1;
     var35 = JS_GetStringChars(var32);
-    var143 = STRING_TO_JSVAL(var32);
-    argv[argc+1] = var143;
+    var318 = STRING_TO_JSVAL(var32);
+    argv[argc+1] = var318;
     {
         size_t i;
         for (i = 0; i < var33; ++i) {
@@ -396,310 +396,1210 @@
     return var57;
 }
 static JSBool
-jjadmvideoCodec_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmaudioReset(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var77;
-    char *var82;
-    char **var83;
     int var78;
     int var81;
-    int var84;
-    jsval var85;
-    JSString *var86;
-    jsval var147;
-    size_t var87;
-    size_t var88;
-    int var90;
-    jschar *var89;
-    jsval var148;
+    jsval var82;
+    JSBool var76;
+    var77 = NULL;
+    var78 = 0;
+    var81 = 0;
+    var82 = JSVAL_NULL;
+    var76 = JS_FALSE;
+    var77 = obj;
+    var81 = argc;
+    var78 = jsAudioReset();
+    if (JS_NewNumberValue(cx, var78, &var82) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+0] = var82;
+    if (rval) {
+        *rval = var82;
+    }
+    var76 = JS_TRUE;
+    do_return:
+    return var76;
+}
+static JSBool
+jjadmvideoCodec_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var84;
+    char *var89;
+    char **var90;
+    int var85;
+    int var88;
     int var91;
     jsval var92;
-    JSObject *var93;
-    jsval var149;
-    jsuint var94;
-    char **var96;
-    size_t var97;
-    int var123;
-    size_t var98;
-    JSString *var99;
-    size_t var100;
-    JSString **var106;
-    int var124;
+    JSString *var93;
+    jsval var323;
+    size_t var94;
+    size_t var95;
+    int var97;
+    jschar *var96;
+    jsval var324;
+    int var98;
+    jsval var99;
+    JSObject *var100;
+    jsval var325;
     jsuint var101;
-    jsint var102;
-    JSBool var103;
-    jsval var104;
-    JSString *var105;
-    jsval var150;
-    size_t var109;
-    jsuint var107;
-    jsint var108;
-    JSString *var111;
-    size_t var110;
-    size_t var112;
-    char var121;
+    char **var103;
+    size_t var104;
+    int var130;
+    size_t var105;
+    JSString *var106;
+    size_t var107;
+    JSString **var113;
+    int var131;
+    jsuint var108;
+    jsint var109;
+    JSBool var110;
+    jsval var111;
+    JSString *var112;
+    jsval var326;
+    size_t var116;
+    jsuint var114;
+    jsint var115;
+    JSString *var118;
+    size_t var117;
+    size_t var119;
+    char var128;
+    size_t var129;
+    char *var120;
+    int var132;
+    char *var121;
     size_t var122;
-    char *var113;
-    int var125;
-    char *var114;
-    size_t var115;
-    int var126;
-    char *var118;
-    jsuint var116;
-    jsint var117;
-    JSString *var120;
-    size_t var119;
-    size_t var127;
-    size_t var128;
-    int var130;
-    jschar *var129;
-    jsval var151;
-    jsval var131;
-    JSBool var76;
-    var77 = NULL;
-    var82 = NULL;
-    var83 = NULL;
-    var78 = 0;
-    var81 = 0;
-    var84 = 0;
-    var85 = JSVAL_NULL;
-    var86 = NULL;
-    var147 = JSVAL_NULL;
-    var87 = 0;
+    int var133;
+    char *var125;
+    jsuint var123;
+    jsint var124;
+    JSString *var127;
+    size_t var126;
+    size_t var134;
+    size_t var135;
+    int var137;
+    jschar *var136;
+    jsval var327;
+    jsval var138;
+    JSBool var83;
+    var84 = NULL;
+    var89 = NULL;
+    var90 = NULL;
+    var85 = 0;
     var88 = 0;
-    var90 = 0;
-    var89 = NULL;
-    var148 = JSVAL_NULL;
     var91 = 0;
     var92 = JSVAL_NULL;
     var93 = NULL;
-    var149 = JSVAL_NULL;
+    var323 = JSVAL_NULL;
     var94 = 0;
+    var95 = 0;
+    var97 = 0;
     var96 = NULL;
-    var97 = 0;
-    var123 = 0;
+    var324 = JSVAL_NULL;
     var98 = 0;
-    var99 = NULL;
-    var100 = 0;
+    var99 = JSVAL_NULL;
+    var100 = NULL;
+    var325 = JSVAL_NULL;
+    var101 = 0;
+    var103 = NULL;
+    var104 = 0;
+    var130 = 0;
+    var105 = 0;
     var106 = NULL;
-    var124 = 0;
-    var101 = 0;
-    var102 = 0;
-    var103 = JS_FALSE;
-    var104 = JSVAL_NULL;
-    var105 = NULL;
-    var150 = JSVAL_NULL;
-    var109 = 0;
     var107 = 0;
+    var113 = NULL;
+    var131 = 0;
     var108 = 0;
-    var111 = NULL;
-    var110 = 0;
-    var112 = 0;
-    var121 = 0;
-    var122 = 0;
-    var113 = NULL;
-    var125 = 0;
-    var114 = NULL;
+    var109 = 0;
+    var110 = JS_FALSE;
+    var111 = JSVAL_NULL;
+    var112 = NULL;
+    var326 = JSVAL_NULL;
+    var116 = 0;
+    var114 = 0;
     var115 = 0;
-    var126 = 0;
     var118 = NULL;
-    var116 = 0;
     var117 = 0;
-    var120 = NULL;
     var119 = 0;
-    var127 = 0;
     var128 = 0;
-    var130 = 0;
-    var129 = NULL;
-    var151 = JSVAL_NULL;
-    var131 = JSVAL_NULL;
-    var76 = JS_FALSE;
-    var77 = obj;
-    var81 = argc;
-    var84 = 0;
-    var84 = var84 < var81;
-    if (var84) {
-    var85 = argv[0];
-    var86 = JS_ValueToString(cx, var85);
-    if (!var86) {
+    var129 = 0;
+    var120 = NULL;
+    var132 = 0;
+    var121 = NULL;
+    var122 = 0;
+    var133 = 0;
+    var125 = NULL;
+    var123 = 0;
+    var124 = 0;
+    var127 = NULL;
+    var126 = 0;
+    var134 = 0;
+    var135 = 0;
+    var137 = 0;
+    var136 = NULL;
+    var327 = JSVAL_NULL;
+    var138 = JSVAL_NULL;
+    var83 = JS_FALSE;
+    var84 = obj;
+    var88 = argc;
+    var91 = 0;
+    var91 = var91 < var88;
+    if (var91) {
+    var92 = argv[0];
+    var93 = JS_ValueToString(cx, var92);
+    if (!var93) {
         goto do_return;
     }
-    var147 = STRING_TO_JSVAL(var86);
-    argv[argc+0] = var147;
-    var87 = JS_GetStringLength(var86);
-    var88 = 1;
-    var88 += var87;
-    var82 = JS_malloc(cx, var88);
-    if (!var82) {
+    var323 = STRING_TO_JSVAL(var93);
+    argv[argc+0] = var323;
+    var94 = JS_GetStringLength(var93);
+    var95 = 1;
+    var95 += var94;
+    var89 = JS_malloc(cx, var95);
+    if (!var89) {
         goto do_return;
     }
-    var90 = 1;
-    var89 = JS_GetStringChars(var86);
-    var148 = STRING_TO_JSVAL(var86);
-    argv[argc+1] = var148;
+    var97 = 1;
+    var96 = JS_GetStringChars(var93);
+    var324 = STRING_TO_JSVAL(var93);
+    argv[argc+1] = var324;
     {
         size_t i;
-        for (i = 0; i < var87; ++i) {
-            var82[i] = wctob(var89[i]);
+        for (i = 0; i < var94; ++i) {
+            var89[i] = wctob(var96[i]);
         }
-        var82[var87] = '\0';
+        var89[var94] = '\0';
     }
     }
-    var91 = 1;
-    var91 = var91 < var81;
-    if (var91) {
-    var92 = argv[1];
-    if (JS_ValueToObject(cx, var92, &var93) != JS_TRUE) {
+    var98 = 1;
+    var98 = var98 < var88;
+    if (var98) {
+    var99 = argv[1];
+    if (JS_ValueToObject(cx, var99, &var100) != JS_TRUE) {
         goto do_return;
     }
-    var149 = OBJECT_TO_JSVAL(var93);
-    argv[argc+2] = var149;
-    if (JS_GetArrayLength(cx, var93, &var94) != JS_TRUE) {
+    var325 = OBJECT_TO_JSVAL(var100);
+    argv[argc+2] = var325;
+    if (JS_GetArrayLength(cx, var100, &var101) != JS_TRUE) {
         goto do_return;
     }
-    var97 = sizeof(var96);
-    var97 *= var94;
-    var83 = JS_malloc(cx, var97);
-    if (!var83) {
+    var104 = sizeof(var103);
+    var104 *= var101;
+    var90 = JS_malloc(cx, var104);
+    if (!var90) {
         goto do_return;
     }
-    var123 = 1;
-    var98 = var94;
-    var100 = sizeof(var99);
-    var98 *= var100;
-    var106 = JS_malloc(cx, var98);
-    if (!var106) {
+    var130 = 1;
+    var105 = var101;
+    var107 = sizeof(var106);
+    var105 *= var107;
+    var113 = JS_malloc(cx, var105);
+    if (!var113) {
         goto do_return;
     }
-    var124 = 1;
-    var101 = var94;
-    var102 = -1;
-    while (var101)
+    var131 = 1;
+    var108 = var101;
+    var109 = -1;
+    while (var108)
     {
-    var101 += var102;
-    var103 = JS_GetElement(cx, var93, var101, &var104);
-    var105 = JS_ValueToString(cx, var104);
-    if (!var105) {
+    var108 += var109;
+    var110 = JS_GetElement(cx, var100, var108, &var111);
+    var112 = JS_ValueToString(cx, var111);
+    if (!var112) {
         goto do_return;
     }
-    var150 = STRING_TO_JSVAL(var105);
-    argv[argc+3] = var150;
-    var106[var101] = var105;
+    var326 = STRING_TO_JSVAL(var112);
+    argv[argc+3] = var326;
+    var113[var108] = var112;
     }
-    var109 = 0;
-    var107 = var94;
-    var108 = -1;
-    while (var107)
+    var116 = 0;
+    var114 = var101;
+    var115 = -1;
+    while (var114)
     {
-    var107 += var108;
-    var111 = var106[var107];
-    var110 = JS_GetStringLength(var111);
-    var109 += var110;
-    var112 = 1;
-    var109 += var112;
+    var114 += var115;
+    var118 = var113[var114];
+    var117 = JS_GetStringLength(var118);
+    var116 += var117;
+    var119 = 1;
+    var116 += var119;
     }
-    var122 = sizeof(var121);
-    var122 *= var109;
-    var113 = JS_malloc(cx, var122);
-    if (!var113) {
+    var129 = sizeof(var128);
+    var129 *= var116;
+    var120 = JS_malloc(cx, var129);
+    if (!var120) {
         goto do_return;
     }
-    var125 = 1;
-    var115 = sizeof(var114);
-    var115 *= var94;
-    var83 = JS_malloc(cx, var115);
-    if (!var83) {
+    var132 = 1;
+    var122 = sizeof(var121);
+    var122 *= var101;
+    var90 = JS_malloc(cx, var122);
+    if (!var90) {
         goto do_return;
     }
-    var126 = 1;
-    var118 = var113;
-    var118 += var109;
-    var116 = var94;
-    var117 = -1;
-    while (var116)
+    var133 = 1;
+    var125 = var120;
+    var125 += var116;
+    var123 = var101;
+    var124 = -1;
+    while (var123)
     {
-    var116 += var117;
-    var120 = var106[var116];
-    var119 = JS_GetStringLength(var120);
-    var118 -= var119;
-    var118 += var117;
-    var127 = JS_GetStringLength(var120);
-    var128 = 1;
-    var128 += var127;
-    var118 = JS_malloc(cx, var128);
-    if (!var118) {
+    var123 += var124;
+    var127 = var113[var123];
+    var126 = JS_GetStringLength(var127);
+    var125 -= var126;
+    var125 += var124;
+    var134 = JS_GetStringLength(var127);
+    var135 = 1;
+    var135 += var134;
+    var125 = JS_malloc(cx, var135);
+    if (!var125) {
         goto do_return;
     }
-    var130 = 1;
-    var129 = JS_GetStringChars(var120);
-    var151 = STRING_TO_JSVAL(var120);
-    argv[argc+4] = var151;
+    var137 = 1;
+    var136 = JS_GetStringChars(var127);
+    var327 = STRING_TO_JSVAL(var127);
+    argv[argc+4] = var327;
     {
         size_t i;
-        for (i = 0; i < var127; ++i) {
-            var118[i] = wctob(var129[i]);
+        for (i = 0; i < var134; ++i) {
+            var125[i] = wctob(var136[i]);
         }
-        var118[var127] = '\0';
+        var125[var134] = '\0';
     }
-    var83[var116] = var118;
+    var90[var123] = var125;
     }
     }
-    var78 = jsVideoCodec(var82, var83);
-    if (JS_NewNumberValue(cx, var78, &var131) != JS_TRUE) {
+    var85 = jsVideoCodec(var89, var90);
+    if (JS_NewNumberValue(cx, var85, &var138) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+5] = var131;
+    argv[argc+5] = var138;
     if (rval) {
-        *rval = var131;
+        *rval = var138;
     }
-    var76 = JS_TRUE;
+    var83 = JS_TRUE;
     do_return:
-    if (var130) {
-        JS_free(cx, var118);
-        var118 = NULL;
-        var130 = 0;
+    if (var137) {
+        JS_free(cx, var125);
+        var125 = NULL;
+        var137 = 0;
     }
-    if (var126) {
-        JS_free(cx, var83);
-        var83 = NULL;
-        var126 = 0;
+    if (var133) {
+        JS_free(cx, var90);
+        var90 = NULL;
+        var133 = 0;
     }
-    if (var125) {
+    if (var132) {
+        JS_free(cx, var120);
+        var120 = NULL;
+        var132 = 0;
+    }
+    if (var131) {
         JS_free(cx, var113);
         var113 = NULL;
-        var125 = 0;
+        var131 = 0;
     }
-    if (var124) {
-        JS_free(cx, var106);
-        var106 = NULL;
-        var124 = 0;
+    if (var130) {
+        JS_free(cx, var90);
+        var90 = NULL;
+        var130 = 0;
     }
-    if (var123) {
-        JS_free(cx, var83);
-        var83 = NULL;
-        var123 = 0;
+    if (var97) {
+        JS_free(cx, var89);
+        var89 = NULL;
+        var97 = 0;
     }
-    if (var90) {
-        JS_free(cx, var82);
-        var82 = NULL;
-        var90 = 0;
+    return var83;
+}
+static JSBool
+jjadmaddVideoFilter_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var140;
+    char *var145;
+    char **var146;
+    int var141;
+    int var144;
+    int var147;
+    jsval var148;
+    JSString *var149;
+    jsval var329;
+    size_t var150;
+    size_t var151;
+    int var153;
+    jschar *var152;
+    jsval var330;
+    int var154;
+    jsval var155;
+    JSObject *var156;
+    jsval var331;
+    jsuint var157;
+    char **var159;
+    size_t var160;
+    int var186;
+    size_t var161;
+    JSString *var162;
+    size_t var163;
+    JSString **var169;
+    int var187;
+    jsuint var164;
+    jsint var165;
+    JSBool var166;
+    jsval var167;
+    JSString *var168;
+    jsval var332;
+    size_t var172;
+    jsuint var170;
+    jsint var171;
+    JSString *var174;
+    size_t var173;
+    size_t var175;
+    char var184;
+    size_t var185;
+    char *var176;
+    int var188;
+    char *var177;
+    size_t var178;
+    int var189;
+    char *var181;
+    jsuint var179;
+    jsint var180;
+    JSString *var183;
+    size_t var182;
+    size_t var190;
+    size_t var191;
+    int var193;
+    jschar *var192;
+    jsval var333;
+    jsval var194;
+    JSBool var139;
+    var140 = NULL;
+    var145 = NULL;
+    var146 = NULL;
+    var141 = 0;
+    var144 = 0;
+    var147 = 0;
+    var148 = JSVAL_NULL;
+    var149 = NULL;
+    var329 = JSVAL_NULL;
+    var150 = 0;
+    var151 = 0;
+    var153 = 0;
+    var152 = NULL;
+    var330 = JSVAL_NULL;
+    var154 = 0;
+    var155 = JSVAL_NULL;
+    var156 = NULL;
+    var331 = JSVAL_NULL;
+    var157 = 0;
+    var159 = NULL;
+    var160 = 0;
+    var186 = 0;
+    var161 = 0;
+    var162 = NULL;
+    var163 = 0;
+    var169 = NULL;
+    var187 = 0;
+    var164 = 0;
+    var165 = 0;
+    var166 = JS_FALSE;
+    var167 = JSVAL_NULL;
+    var168 = NULL;
+    var332 = JSVAL_NULL;
+    var172 = 0;
+    var170 = 0;
+    var171 = 0;
+    var174 = NULL;
+    var173 = 0;
+    var175 = 0;
+    var184 = 0;
+    var185 = 0;
+    var176 = NULL;
+    var188 = 0;
+    var177 = NULL;
+    var178 = 0;
+    var189 = 0;
+    var181 = NULL;
+    var179 = 0;
+    var180 = 0;
+    var183 = NULL;
+    var182 = 0;
+    var190 = 0;
+    var191 = 0;
+    var193 = 0;
+    var192 = NULL;
+    var333 = JSVAL_NULL;
+    var194 = JSVAL_NULL;
+    var139 = JS_FALSE;
+    var140 = obj;
+    var144 = argc;
+    var147 = 0;
+    var147 = var147 < var144;
+    if (var147) {
+    var148 = argv[0];
+    var149 = JS_ValueToString(cx, var148);
+    if (!var149) {
+        goto do_return;
     }
-    return var76;
+    var329 = STRING_TO_JSVAL(var149);
+    argv[argc+0] = var329;
+    var150 = JS_GetStringLength(var149);
+    var151 = 1;
+    var151 += var150;
+    var145 = JS_malloc(cx, var151);
+    if (!var145) {
+        goto do_return;
+    }
+    var153 = 1;
+    var152 = JS_GetStringChars(var149);
+    var330 = STRING_TO_JSVAL(var149);
+    argv[argc+1] = var330;
+    {
+        size_t i;
+        for (i = 0; i < var150; ++i) {
+            var145[i] = wctob(var152[i]);
+        }
+        var145[var150] = '\0';
+    }
+    }
+    var154 = 1;
+    var154 = var154 < var144;
+    if (var154) {
+    var155 = argv[1];
+    if (JS_ValueToObject(cx, var155, &var156) != JS_TRUE) {
+        goto do_return;
+    }
+    var331 = OBJECT_TO_JSVAL(var156);
+    argv[argc+2] = var331;
+    if (JS_GetArrayLength(cx, var156, &var157) != JS_TRUE) {
+        goto do_return;
+    }
+    var160 = sizeof(var159);
+    var160 *= var157;
+    var146 = JS_malloc(cx, var160);
+    if (!var146) {
+        goto do_return;
+    }
+    var186 = 1;
+    var161 = var157;
+    var163 = sizeof(var162);
+    var161 *= var163;
+    var169 = JS_malloc(cx, var161);
+    if (!var169) {
+        goto do_return;
+    }
+    var187 = 1;
+    var164 = var157;
+    var165 = -1;
+    while (var164)
+    {
+    var164 += var165;
+    var166 = JS_GetElement(cx, var156, var164, &var167);
+    var168 = JS_ValueToString(cx, var167);
+    if (!var168) {
+        goto do_return;
+    }
+    var332 = STRING_TO_JSVAL(var168);
+    argv[argc+3] = var332;
+    var169[var164] = var168;
+    }
+    var172 = 0;
+    var170 = var157;
+    var171 = -1;
+    while (var170)
+    {
+    var170 += var171;
+    var174 = var169[var170];
+    var173 = JS_GetStringLength(var174);
+    var172 += var173;
+    var175 = 1;
+    var172 += var175;
+    }
+    var185 = sizeof(var184);
+    var185 *= var172;
+    var176 = JS_malloc(cx, var185);
+    if (!var176) {
+        goto do_return;
+    }
+    var188 = 1;
+    var178 = sizeof(var177);
+    var178 *= var157;
+    var146 = JS_malloc(cx, var178);
+    if (!var146) {
+        goto do_return;
+    }
+    var189 = 1;
+    var181 = var176;
+    var181 += var172;
+    var179 = var157;
+    var180 = -1;
+    while (var179)
+    {
+    var179 += var180;
+    var183 = var169[var179];
+    var182 = JS_GetStringLength(var183);
+    var181 -= var182;
+    var181 += var180;
+    var190 = JS_GetStringLength(var183);
+    var191 = 1;
+    var191 += var190;
+    var181 = JS_malloc(cx, var191);
+    if (!var181) {
+        goto do_return;
+    }
+    var193 = 1;
+    var192 = JS_GetStringChars(var183);
+    var333 = STRING_TO_JSVAL(var183);
+    argv[argc+4] = var333;
+    {
+        size_t i;
+        for (i = 0; i < var190; ++i) {
+            var181[i] = wctob(var192[i]);
+        }
+        var181[var190] = '\0';
+    }
+    var146[var179] = var181;
+    }
+    }
+    var141 = jsVideoFilter(var145, var146);
+    if (JS_NewNumberValue(cx, var141, &var194) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+5] = var194;
+    if (rval) {
+        *rval = var194;
+    }
+    var139 = JS_TRUE;
+    do_return:
+    if (var193) {
+        JS_free(cx, var181);
+        var181 = NULL;
+        var193 = 0;
+    }
+    if (var189) {
+        JS_free(cx, var146);
+        var146 = NULL;
+        var189 = 0;
+    }
+    if (var188) {
+        JS_free(cx, var176);
+        var176 = NULL;
+        var188 = 0;
+    }
+    if (var187) {
+        JS_free(cx, var169);
+        var169 = NULL;
+        var187 = 0;
+    }
+    if (var186) {
+        JS_free(cx, var146);
+        var146 = NULL;
+        var186 = 0;
+    }
+    if (var153) {
+        JS_free(cx, var145);
+        var145 = NULL;
+        var153 = 0;
+    }
+    return var139;
 }
 static JSBool
+jjadmaudioCodec_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var196;
+    char *var201;
+    char **var202;
+    int var197;
+    int var200;
+    int var203;
+    jsval var204;
+    JSString *var205;
+    jsval var335;
+    size_t var206;
+    size_t var207;
+    int var209;
+    jschar *var208;
+    jsval var336;
+    int var210;
+    jsval var211;
+    JSObject *var212;
+    jsval var337;
+    jsuint var213;
+    char **var215;
+    size_t var216;
+    int var242;
+    size_t var217;
+    JSString *var218;
+    size_t var219;
+    JSString **var225;
+    int var243;
+    jsuint var220;
+    jsint var221;
+    JSBool var222;
+    jsval var223;
+    JSString *var224;
+    jsval var338;
+    size_t var228;
+    jsuint var226;
+    jsint var227;
+    JSString *var230;
+    size_t var229;
+    size_t var231;
+    char var240;
+    size_t var241;
+    char *var232;
+    int var244;
+    char *var233;
+    size_t var234;
+    int var245;
+    char *var237;
+    jsuint var235;
+    jsint var236;
+    JSString *var239;
+    size_t var238;
+    size_t var246;
+    size_t var247;
+    int var249;
+    jschar *var248;
+    jsval var339;
+    jsval var250;
+    JSBool var195;
+    var196 = NULL;
+    var201 = NULL;
+    var202 = NULL;
+    var197 = 0;
+    var200 = 0;
+    var203 = 0;
+    var204 = JSVAL_NULL;
+    var205 = NULL;
+    var335 = JSVAL_NULL;
+    var206 = 0;
+    var207 = 0;
+    var209 = 0;
+    var208 = NULL;
+    var336 = JSVAL_NULL;
+    var210 = 0;
+    var211 = JSVAL_NULL;
+    var212 = NULL;
+    var337 = JSVAL_NULL;
+    var213 = 0;
+    var215 = NULL;
+    var216 = 0;
+    var242 = 0;
+    var217 = 0;
+    var218 = NULL;
+    var219 = 0;
+    var225 = NULL;
+    var243 = 0;
+    var220 = 0;
+    var221 = 0;
+    var222 = JS_FALSE;
+    var223 = JSVAL_NULL;
+    var224 = NULL;
+    var338 = JSVAL_NULL;
+    var228 = 0;
+    var226 = 0;
+    var227 = 0;
+    var230 = NULL;
+    var229 = 0;
+    var231 = 0;
+    var240 = 0;
+    var241 = 0;
+    var232 = NULL;
+    var244 = 0;
+    var233 = NULL;
+    var234 = 0;
+    var245 = 0;
+    var237 = NULL;
+    var235 = 0;
+    var236 = 0;
+    var239 = NULL;
+    var238 = 0;
+    var246 = 0;
+    var247 = 0;
+    var249 = 0;
+    var248 = NULL;
+    var339 = JSVAL_NULL;
+    var250 = JSVAL_NULL;
+    var195 = JS_FALSE;
+    var196 = obj;
+    var200 = argc;
+    var203 = 0;
+    var203 = var203 < var200;
+    if (var203) {
+    var204 = argv[0];
+    var205 = JS_ValueToString(cx, var204);
+    if (!var205) {
+        goto do_return;
+    }
+    var335 = STRING_TO_JSVAL(var205);
+    argv[argc+0] = var335;
+    var206 = JS_GetStringLength(var205);
+    var207 = 1;
+    var207 += var206;
+    var201 = JS_malloc(cx, var207);
+    if (!var201) {
+        goto do_return;
+    }
+    var209 = 1;
+    var208 = JS_GetStringChars(var205);
+    var336 = STRING_TO_JSVAL(var205);
+    argv[argc+1] = var336;
+    {
+        size_t i;
+        for (i = 0; i < var206; ++i) {
+            var201[i] = wctob(var208[i]);
+        }
+        var201[var206] = '\0';
+    }
+    }
+    var210 = 1;
+    var210 = var210 < var200;
+    if (var210) {
+    var211 = argv[1];
+    if (JS_ValueToObject(cx, var211, &var212) != JS_TRUE) {
+        goto do_return;
+    }
+    var337 = OBJECT_TO_JSVAL(var212);
+    argv[argc+2] = var337;
+    if (JS_GetArrayLength(cx, var212, &var213) != JS_TRUE) {
+        goto do_return;
+    }
+    var216 = sizeof(var215);
+    var216 *= var213;
+    var202 = JS_malloc(cx, var216);
+    if (!var202) {
+        goto do_return;
+    }
+    var242 = 1;
+    var217 = var213;
+    var219 = sizeof(var218);
+    var217 *= var219;
+    var225 = JS_malloc(cx, var217);
+    if (!var225) {
+        goto do_return;
+    }
+    var243 = 1;
+    var220 = var213;
+    var221 = -1;
+    while (var220)
+    {
+    var220 += var221;
+    var222 = JS_GetElement(cx, var212, var220, &var223);
+    var224 = JS_ValueToString(cx, var223);
+    if (!var224) {
+        goto do_return;
+    }
+    var338 = STRING_TO_JSVAL(var224);
+    argv[argc+3] = var338;
+    var225[var220] = var224;
+    }
+    var228 = 0;
+    var226 = var213;
+    var227 = -1;
+    while (var226)
+    {
+    var226 += var227;
+    var230 = var225[var226];
+    var229 = JS_GetStringLength(var230);
+    var228 += var229;
+    var231 = 1;
+    var228 += var231;
+    }
+    var241 = sizeof(var240);
+    var241 *= var228;
+    var232 = JS_malloc(cx, var241);
+    if (!var232) {
+        goto do_return;
+    }
+    var244 = 1;
+    var234 = sizeof(var233);
+    var234 *= var213;
+    var202 = JS_malloc(cx, var234);
+    if (!var202) {
+        goto do_return;
+    }
+    var245 = 1;
+    var237 = var232;
+    var237 += var228;
+    var235 = var213;
+    var236 = -1;
+    while (var235)
+    {
+    var235 += var236;
+    var239 = var225[var235];
+    var238 = JS_GetStringLength(var239);
+    var237 -= var238;
+    var237 += var236;
+    var246 = JS_GetStringLength(var239);
+    var247 = 1;
+    var247 += var246;
+    var237 = JS_malloc(cx, var247);
+    if (!var237) {
+        goto do_return;
+    }
+    var249 = 1;
+    var248 = JS_GetStringChars(var239);
+    var339 = STRING_TO_JSVAL(var239);
+    argv[argc+4] = var339;
+    {
+        size_t i;
+        for (i = 0; i < var246; ++i) {
+            var237[i] = wctob(var248[i]);
+        }
+        var237[var246] = '\0';
+    }
+    var202[var235] = var237;
+    }
+    }
+    var197 = jsAudioCodec(var201, var202);
+    if (JS_NewNumberValue(cx, var197, &var250) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+5] = var250;
+    if (rval) {
+        *rval = var250;
+    }
+    var195 = JS_TRUE;
+    do_return:
+    if (var249) {
+        JS_free(cx, var237);
+        var237 = NULL;
+        var249 = 0;
+    }
+    if (var245) {
+        JS_free(cx, var202);
+        var202 = NULL;
+        var245 = 0;
+    }
+    if (var244) {
+        JS_free(cx, var232);
+        var232 = NULL;
+        var244 = 0;
+    }
+    if (var243) {
+        JS_free(cx, var225);
+        var225 = NULL;
+        var243 = 0;
+    }
+    if (var242) {
+        JS_free(cx, var202);
+        var202 = NULL;
+        var242 = 0;
+    }
+    if (var209) {
+        JS_free(cx, var201);
+        var201 = NULL;
+        var209 = 0;
+    }
+    return var195;
+}
+static JSBool
+jjadmsetContainer_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var252;
+    char *var257;
+    char **var258;
+    int var253;
+    int var256;
+    int var259;
+    jsval var260;
+    JSString *var261;
+    jsval var341;
+    size_t var262;
+    size_t var263;
+    int var265;
+    jschar *var264;
+    jsval var342;
+    int var266;
+    jsval var267;
+    JSObject *var268;
+    jsval var343;
+    jsuint var269;
+    char **var271;
+    size_t var272;
+    int var298;
+    size_t var273;
+    JSString *var274;
+    size_t var275;
+    JSString **var281;
+    int var299;
+    jsuint var276;
+    jsint var277;
+    JSBool var278;
+    jsval var279;
+    JSString *var280;
+    jsval var344;
+    size_t var284;
+    jsuint var282;
+    jsint var283;
+    JSString *var286;
+    size_t var285;
+    size_t var287;
+    char var296;
+    size_t var297;
+    char *var288;
+    int var300;
+    char *var289;
+    size_t var290;
+    int var301;
+    char *var293;
+    jsuint var291;
+    jsint var292;
+    JSString *var295;
+    size_t var294;
+    size_t var302;
+    size_t var303;
+    int var305;
+    jschar *var304;
+    jsval var345;
+    jsval var306;
+    JSBool var251;
+    var252 = NULL;
+    var257 = NULL;
+    var258 = NULL;
+    var253 = 0;
+    var256 = 0;
+    var259 = 0;
+    var260 = JSVAL_NULL;
+    var261 = NULL;
+    var341 = JSVAL_NULL;
+    var262 = 0;
+    var263 = 0;
+    var265 = 0;
+    var264 = NULL;
+    var342 = JSVAL_NULL;
+    var266 = 0;
+    var267 = JSVAL_NULL;
+    var268 = NULL;
+    var343 = JSVAL_NULL;
+    var269 = 0;
+    var271 = NULL;
+    var272 = 0;
+    var298 = 0;
+    var273 = 0;
+    var274 = NULL;
+    var275 = 0;
+    var281 = NULL;
+    var299 = 0;
+    var276 = 0;
+    var277 = 0;
+    var278 = JS_FALSE;
+    var279 = JSVAL_NULL;
+    var280 = NULL;
+    var344 = JSVAL_NULL;
+    var284 = 0;
+    var282 = 0;
+    var283 = 0;
+    var286 = NULL;
+    var285 = 0;
+    var287 = 0;
+    var296 = 0;
+    var297 = 0;
+    var288 = NULL;
+    var300 = 0;
+    var289 = NULL;
+    var290 = 0;
+    var301 = 0;
+    var293 = NULL;
+    var291 = 0;
+    var292 = 0;
+    var295 = NULL;
+    var294 = 0;
+    var302 = 0;
+    var303 = 0;
+    var305 = 0;
+    var304 = NULL;
+    var345 = JSVAL_NULL;
+    var306 = JSVAL_NULL;
+    var251 = JS_FALSE;
+    var252 = obj;
+    var256 = argc;
+    var259 = 0;
+    var259 = var259 < var256;
+    if (var259) {
+    var260 = argv[0];
+    var261 = JS_ValueToString(cx, var260);
+    if (!var261) {
+        goto do_return;
+    }
+    var341 = STRING_TO_JSVAL(var261);
+    argv[argc+0] = var341;
+    var262 = JS_GetStringLength(var261);
+    var263 = 1;
+    var263 += var262;
+    var257 = JS_malloc(cx, var263);
+    if (!var257) {
+        goto do_return;
+    }
+    var265 = 1;
+    var264 = JS_GetStringChars(var261);
+    var342 = STRING_TO_JSVAL(var261);
+    argv[argc+1] = var342;
+    {
+        size_t i;
+        for (i = 0; i < var262; ++i) {
+            var257[i] = wctob(var264[i]);
+        }
+        var257[var262] = '\0';
+    }
+    }
+    var266 = 1;
+    var266 = var266 < var256;
+    if (var266) {
+    var267 = argv[1];
+    if (JS_ValueToObject(cx, var267, &var268) != JS_TRUE) {
+        goto do_return;
+    }
+    var343 = OBJECT_TO_JSVAL(var268);
+    argv[argc+2] = var343;
+    if (JS_GetArrayLength(cx, var268, &var269) != JS_TRUE) {
+        goto do_return;
+    }
+    var272 = sizeof(var271);
+    var272 *= var269;
+    var258 = JS_malloc(cx, var272);
+    if (!var258) {
+        goto do_return;
+    }
+    var298 = 1;
+    var273 = var269;
+    var275 = sizeof(var274);
+    var273 *= var275;
+    var281 = JS_malloc(cx, var273);
+    if (!var281) {
+        goto do_return;
+    }
+    var299 = 1;
+    var276 = var269;
+    var277 = -1;
+    while (var276)
+    {
+    var276 += var277;
+    var278 = JS_GetElement(cx, var268, var276, &var279);
+    var280 = JS_ValueToString(cx, var279);
+    if (!var280) {
+        goto do_return;
+    }
+    var344 = STRING_TO_JSVAL(var280);
+    argv[argc+3] = var344;
+    var281[var276] = var280;
+    }
+    var284 = 0;
+    var282 = var269;
+    var283 = -1;
+    while (var282)
+    {
+    var282 += var283;
+    var286 = var281[var282];
+    var285 = JS_GetStringLength(var286);
+    var284 += var285;
+    var287 = 1;
+    var284 += var287;
+    }
+    var297 = sizeof(var296);
+    var297 *= var284;
+    var288 = JS_malloc(cx, var297);
+    if (!var288) {
+        goto do_return;
+    }
+    var300 = 1;
+    var290 = sizeof(var289);
+    var290 *= var269;
+    var258 = JS_malloc(cx, var290);
+    if (!var258) {
+        goto do_return;
+    }
+    var301 = 1;
+    var293 = var288;
+    var293 += var284;
+    var291 = var269;
+    var292 = -1;
+    while (var291)
+    {
+    var291 += var292;
+    var295 = var281[var291];
+    var294 = JS_GetStringLength(var295);
+    var293 -= var294;
+    var293 += var292;
+    var302 = JS_GetStringLength(var295);
+    var303 = 1;
+    var303 += var302;
+    var293 = JS_malloc(cx, var303);
+    if (!var293) {
+        goto do_return;
+    }
+    var305 = 1;
+    var304 = JS_GetStringChars(var295);
+    var345 = STRING_TO_JSVAL(var295);
+    argv[argc+4] = var345;
+    {
+        size_t i;
+        for (i = 0; i < var302; ++i) {
+            var293[i] = wctob(var304[i]);
+        }
+        var293[var302] = '\0';
+    }
+    var258[var291] = var293;
+    }
+    }
+    var253 = jsSetContainer(var257, var258);
+    if (JS_NewNumberValue(cx, var253, &var306) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+5] = var306;
+    if (rval) {
+        *rval = var306;
+    }
+    var251 = JS_TRUE;
+    do_return:
+    if (var305) {
+        JS_free(cx, var293);
+        var293 = NULL;
+        var305 = 0;
+    }
+    if (var301) {
+        JS_free(cx, var258);
+        var258 = NULL;
+        var301 = 0;
+    }
+    if (var300) {
+        JS_free(cx, var288);
+        var288 = NULL;
+        var300 = 0;
+    }
+    if (var299) {
+        JS_free(cx, var281);
+        var281 = NULL;
+        var299 = 0;
+    }
+    if (var298) {
+        JS_free(cx, var258);
+        var258 = NULL;
+        var298 = 0;
+    }
+    if (var265) {
+        JS_free(cx, var257);
+        var257 = NULL;
+        var265 = 0;
+    }
+    return var251;
+}
+static JSBool
 jjadm__construct__(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var133;
-    int var137;
-    JSBool var132;
-    var133 = NULL;
-    var137 = 0;
-    var132 = JS_FALSE;
-    var133 = obj;
-    var137 = argc;
+    JSObject *var308;
+    int var312;
+    JSBool var307;
+    var308 = NULL;
+    var312 = 0;
+    var307 = JS_FALSE;
+    var308 = obj;
+    var312 = argc;
     jsAvidemux();
-    var132 = JS_TRUE;
-    return var132;
+    var307 = JS_TRUE;
+    return var307;
 }
 static JSPropertySpec jjadm_static_ps[] = {
     {NULL, 0, 0, NULL, NULL}
@@ -713,7 +1613,11 @@
     JS_FS("appendVideo", jjadmappendVideo, 1, 0, 3),
     JS_FS("addSegment", jjadmaddSegment, 3, 0, 1),
     JS_FS("setPostProc", jjadmsetPostProc, 3, 0, 1),
+    JS_FS("audioReset", jjadmaudioReset, 0, 0, 1),
     JS_FS("videoCodec", jsAdmvideoCodec,  2, 0, 6),
+    JS_FS("addVideoFilter", jsAdmaddVideoFilter,  2, 0, 6),
+    JS_FS("audioCodec", jsAdmaudioCodec,  2, 0, 6),
+    JS_FS("setContainer", jsAdmsetContainer,  2, 0, 6),
     JS_FS_END
 };
 static JSFunctionSpec jjadm_fs[] = {

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 10:24:42 UTC (rev 5648)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 15:24:38 UTC (rev 5649)
@@ -14,7 +14,11 @@
         function int appendVideo    : jsAppendVideo (cstring ) <static>;
         function int addSegment     : jsAddSegment (int ,double , double ) <static>;
         function int setPostProc    : jsSetPostProc (int ,int , int ) <static>;
+        function int audioReset     : jsAudioReset () <static>;
         function int videoCodec_ignore     : jsVideoCodec(cstring,cstring[])   <static>;
+        function int addVideoFilter_ignore : jsVideoFilter(cstring,cstring[])   <static>;
+        function int audioCodec_ignore     : jsAudioCodec(cstring,cstring[])   <static>;
+        function int setContainer_ignore   : jsSetContainer(cstring,cstring[])   <static>;
         construct                   : jsAvidemux  ( ) <static>     ; 
 };
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp	2009-12-11 10:24:42 UTC (rev 5648)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp	2009-12-11 15:24:38 UTC (rev 5649)
@@ -23,6 +23,8 @@
 #include "ADM_jsVideo.h"
 #include "A_functions.h"
 #include "ADM_videoEncoderApi.h"
+#include "ADM_videoFilterApi.h"
+#include "ADM_videoFilters.h"
 #include "GUI_ui.h"
 extern ADM_Composer *video_body;
 bool A_setVideoCodec(const char *nm);
@@ -67,6 +69,32 @@
 }// end Codec
 
 /**
+    \fn Codec
+    
+*/
+extern "C" int   jsVideoFilter(const char *a,const char **b) {return 0;}
+JSBool jsAdmaddVideoFilter(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{// begin Codec
+   uint32_t filterTag;
+
+        // default return value
+        *rval = BOOLEAN_TO_JSVAL(false);
+        if(argc == 0)
+                return JS_FALSE;
+        char *filterName=JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
+        filterTag = ADM_vf_getTagFromInternalName(filterName);
+        jsLog(JS_LOG_NORMAL,"Adding Filter %s -> %"LU"... \n",filterName,filterTag);
+
+        
+        CONFcouple *c=NULL;
+        if(argc)
+            jsArgToConfCouple(argc-1,&c,argv+1);
+        *rval=BOOLEAN_TO_JSVAL(  ADM_vf_addFilterFromTag(filterTag,c,false));
+        if(c) delete c;
+        
+        return JS_TRUE;
+}// end Codec
+/**
     \fn A_setVideoCodec
 */
 bool A_setVideoCodec(const char *nm)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2009-12-11 10:24:42 UTC (rev 5648)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2009-12-11 15:24:38 UTC (rev 5649)
@@ -12,6 +12,8 @@
         ADM_jsAvidemux_js.c
 #
         ADM_jsVideo.cpp
+#
+        ADM_jsAudio.cpp
 )
 
 ADD_LIBRARY(ADM_script26 STATIC ${ADM_script_SRCS})



From mean at mail.berlios.de  Fri Dec 11 16:24:42 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 16:24:42 +0100
Subject: [Avidemux-svn-commit] r5650 - in
	branches/avidemux_2.6_branch_mean/avidemux/common: ADM_editor
	ADM_script2/include ADM_script2/src
Message-ID: <200912111524.nBBFOgEM005401@sheep.berlios.de>

Author: mean
Date: 2009-12-11 16:24:41 +0100 (Fri, 11 Dec 2009)
New Revision: 5650

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAudio.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp
Log:
[js] Just enough functions to load our project

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp	2009-12-11 15:24:38 UTC (rev 5649)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp	2009-12-11 15:24:41 UTC (rev 5650)
@@ -114,10 +114,10 @@
 
 // Markers
 //
-#if 0
-        qfprintf(fd,"app.markerA=%"LLU";\n",getMarkerAPts());
-        qfprintf(fd,"app.markerB=%"LLU";\n",getMarkerBPts());
-#endif        
+
+        qfprintf(fd,"adm.markerA=%"LLU";\n",getMarkerAPts());
+        qfprintf(fd,"adm.markerB=%"LLU";\n",getMarkerBPts());
+
 // postproc
 //___________________________
 
@@ -205,7 +205,7 @@
 
 
     uint32_t x=audioFilterGetResample();
-    if(x) qfprintf(fd,"app.audio.resample=%u;\n",audioFilterGetResample());
+    if(x) qfprintf(fd,"app.audioResample=%u;\n",audioFilterGetResample());
 
     
 //   qfprintf(fd,"app.audio.normalizeMode=%d;\n",audioGetNormalizeMode());
@@ -213,7 +213,7 @@
 //   qfprintf(fd,"app.audio.delay=%d;\n",audioGetDelay());
 // if (audioGetDrc()) qfprintf(fd,"app.audio.drc=true;\n");
    if(CHANNEL_INVALID!=audioFilterGetMixer())
-        qfprintf(fd,"app.audio.mixer(\"%s\");\n",AudioMixerIdToString(audioFilterGetMixer()));
+        qfprintf(fd,"app.audioMixer(\"%s\");\n",AudioMixerIdToString(audioFilterGetMixer()));
 
    
 
@@ -221,8 +221,8 @@
         switch(audioFilterGetFrameRate())
         {
                 case FILMCONV_NONE:      ;break;
-                case FILMCONV_PAL2FILM:  qfprintf(fd,"app.audio.pal2film=true;\n");break;
-                case FILMCONV_FILM2PAL:  qfprintf(fd,"app.audio.film2pal=true;\n");break;
+                case FILMCONV_PAL2FILM:  qfprintf(fd,"app.audioPal2film=1;\n");break;
+                case FILMCONV_FILM2PAL:  qfprintf(fd,"app.audioFilm2pal=1;\n");break;
                 default:ADM_assert(0);
         }
    

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h	2009-12-11 15:24:38 UTC (rev 5649)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h	2009-12-11 15:24:41 UTC (rev 5650)
@@ -23,6 +23,15 @@
 int jsClearSegments(void);
 int jsAddSegment(int ref, double start, double duration);
 int jsAudioReset(void);
+int jsAudioMixer(const char *s);
+// Fq
+int32_t jsGetResample(void);
+void    jsSetResample(int32_t fq);
+// Markers
+double jsGetMarkerA(void);
+double jsGetMarkerB(void);
+void   jsSetMarkerA(double a);
+void   jsSetMarkerB(double b);
 
 // non jsapigen function, variables number of args
 JSBool jsAdmaddVideoFilter(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAudio.cpp	2009-12-11 15:24:38 UTC (rev 5649)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAudio.cpp	2009-12-11 15:24:41 UTC (rev 5650)
@@ -75,6 +75,26 @@
         
         return JS_TRUE;
 }
+/**
+    \fn jsAudioMixer
+*/
+int jsAudioMixer(const char *s)
+{
+    CHANNEL_CONF c=AudioMuxerStringToId(s);
+    return audioFilterSetMixer(c);
+}
+/**
+    \fn jsGetResample
+*/
+int32_t jsGetResample(void)
+{
 
+}
+/**
+    \fn jsSetResample
+*/
+void    jsSetResample(int32_t fq)
+{
 
+}
 //EOF
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 15:24:38 UTC (rev 5649)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 15:24:41 UTC (rev 5650)
@@ -51,1557 +51,1788 @@
     JS_FS_END
 };
 static JSBool
-jjadmloadVideo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmmarkerA_get(JSContext *cx, JSObject *obj, jsval id, jsval *val)
 {
-    JSObject *var2;
-    char *var7;
-    int var3;
-    int var6;
-    int var8;
-    jsval var9;
-    JSString *var10;
-    jsval var313;
-    size_t var11;
-    size_t var12;
-    int var14;
-    jschar *var13;
-    jsval var314;
-    jsval var15;
+    double var2;
+    jsval var5;
     JSBool var1;
-    var2 = NULL;
-    var7 = NULL;
-    var3 = 0;
-    var6 = 0;
-    var8 = 0;
-    var9 = JSVAL_NULL;
-    var10 = NULL;
-    var313 = JSVAL_NULL;
-    var11 = 0;
-    var12 = 0;
-    var14 = 0;
-    var13 = NULL;
-    var314 = JSVAL_NULL;
-    var15 = JSVAL_NULL;
+    var2 = 0.0;
+    var5 = JSVAL_NULL;
     var1 = JS_FALSE;
-    var2 = obj;
-    var6 = argc;
-    var8 = 0;
-    var8 = var8 < var6;
-    if (var8) {
-    var9 = argv[0];
-    var10 = JS_ValueToString(cx, var9);
-    if (!var10) {
+    if (!JS_EnterLocalRootScope(cx)) {
         goto do_return;
     }
-    var313 = STRING_TO_JSVAL(var10);
-    argv[argc+0] = var313;
-    var11 = JS_GetStringLength(var10);
-    var12 = 1;
-    var12 += var11;
-    var7 = JS_malloc(cx, var12);
-    if (!var7) {
+    var2 = jsGetMarkerA();
+    if (JS_NewNumberValue(cx, var2, &var5) != JS_TRUE) {
         goto do_return;
     }
-    var14 = 1;
-    var13 = JS_GetStringChars(var10);
-    var314 = STRING_TO_JSVAL(var10);
-    argv[argc+1] = var314;
-    {
-        size_t i;
-        for (i = 0; i < var11; ++i) {
-            var7[i] = wctob(var13[i]);
-        }
-        var7[var11] = '\0';
+    if (val) {
+        *val = var5;
     }
+    var1 = JS_TRUE;
+    do_return:
+    JS_LeaveLocalRootScope(cx);
+    return var1;
+}
+static JSBool
+jjadmmarkerA_set(JSContext *cx, JSObject *obj, jsval id, jsval *val)
+{
+    double var7;
+    jsval var10;
+    jsdouble var11;
+    JSBool var6;
+    var7 = 0.0;
+    var10 = JSVAL_NULL;
+    var11 = 0.0;
+    var6 = JS_FALSE;
+    if (!JS_EnterLocalRootScope(cx)) {
+        goto do_return;
     }
-    var3 = jsLoadVideo(var7);
-    if (JS_NewNumberValue(cx, var3, &var15) != JS_TRUE) {
+    var10 = *val;
+    if (JS_ValueToNumber(cx, var10, &var11) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+2] = var15;
-    if (rval) {
-        *rval = var15;
+    var7 = (double)var11;
+    jsSetMarkerA(var7);
+    var6 = JS_TRUE;
+    do_return:
+    JS_LeaveLocalRootScope(cx);
+    return var6;
+}
+static JSBool
+jjadmmarkerB_get(JSContext *cx, JSObject *obj, jsval id, jsval *val)
+{
+    double var13;
+    jsval var16;
+    JSBool var12;
+    var13 = 0.0;
+    var16 = JSVAL_NULL;
+    var12 = JS_FALSE;
+    if (!JS_EnterLocalRootScope(cx)) {
+        goto do_return;
     }
-    var1 = JS_TRUE;
+    var13 = jsGetMarkerB();
+    if (JS_NewNumberValue(cx, var13, &var16) != JS_TRUE) {
+        goto do_return;
+    }
+    if (val) {
+        *val = var16;
+    }
+    var12 = JS_TRUE;
     do_return:
-    if (var14) {
-        JS_free(cx, var7);
-        var7 = NULL;
-        var14 = 0;
-    }
-    return var1;
+    JS_LeaveLocalRootScope(cx);
+    return var12;
 }
 static JSBool
-jjadmclearSegments(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmmarkerB_set(JSContext *cx, JSObject *obj, jsval id, jsval *val)
 {
-    JSObject *var17;
-    int var18;
-    int var21;
-    jsval var22;
-    JSBool var16;
-    var17 = NULL;
-    var18 = 0;
-    var21 = 0;
-    var22 = JSVAL_NULL;
-    var16 = JS_FALSE;
-    var17 = obj;
-    var21 = argc;
-    var18 = jsClearSegments();
-    if (JS_NewNumberValue(cx, var18, &var22) != JS_TRUE) {
+    double var18;
+    jsval var21;
+    jsdouble var22;
+    JSBool var17;
+    var18 = 0.0;
+    var21 = JSVAL_NULL;
+    var22 = 0.0;
+    var17 = JS_FALSE;
+    if (!JS_EnterLocalRootScope(cx)) {
         goto do_return;
     }
-    argv[argc+0] = var22;
-    if (rval) {
-        *rval = var22;
+    var21 = *val;
+    if (JS_ValueToNumber(cx, var21, &var22) != JS_TRUE) {
+        goto do_return;
     }
-    var16 = JS_TRUE;
+    var18 = (double)var22;
+    jsSetMarkerB(var18);
+    var17 = JS_TRUE;
     do_return:
-    return var16;
+    JS_LeaveLocalRootScope(cx);
+    return var17;
 }
 static JSBool
-jjadmappendVideo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmaudioResample_get(JSContext *cx, JSObject *obj, jsval id, jsval *val)
 {
-    JSObject *var24;
-    char *var29;
-    int var25;
-    int var28;
-    int var30;
-    jsval var31;
-    JSString *var32;
-    jsval var317;
-    size_t var33;
-    size_t var34;
-    int var36;
-    jschar *var35;
-    jsval var318;
-    jsval var37;
+    int var24;
+    jsval var27;
     JSBool var23;
-    var24 = NULL;
-    var29 = NULL;
-    var25 = 0;
-    var28 = 0;
-    var30 = 0;
-    var31 = JSVAL_NULL;
-    var32 = NULL;
-    var317 = JSVAL_NULL;
-    var33 = 0;
-    var34 = 0;
-    var36 = 0;
-    var35 = NULL;
-    var318 = JSVAL_NULL;
-    var37 = JSVAL_NULL;
+    var24 = 0;
+    var27 = JSVAL_NULL;
     var23 = JS_FALSE;
-    var24 = obj;
-    var28 = argc;
-    var30 = 0;
-    var30 = var30 < var28;
-    if (var30) {
-    var31 = argv[0];
-    var32 = JS_ValueToString(cx, var31);
-    if (!var32) {
+    if (!JS_EnterLocalRootScope(cx)) {
         goto do_return;
     }
-    var317 = STRING_TO_JSVAL(var32);
-    argv[argc+0] = var317;
-    var33 = JS_GetStringLength(var32);
-    var34 = 1;
-    var34 += var33;
-    var29 = JS_malloc(cx, var34);
-    if (!var29) {
+    var24 = jsGetResample();
+    if (JS_NewNumberValue(cx, var24, &var27) != JS_TRUE) {
         goto do_return;
     }
-    var36 = 1;
-    var35 = JS_GetStringChars(var32);
-    var318 = STRING_TO_JSVAL(var32);
-    argv[argc+1] = var318;
-    {
-        size_t i;
-        for (i = 0; i < var33; ++i) {
-            var29[i] = wctob(var35[i]);
-        }
-        var29[var33] = '\0';
+    if (val) {
+        *val = var27;
     }
+    var23 = JS_TRUE;
+    do_return:
+    JS_LeaveLocalRootScope(cx);
+    return var23;
+}
+static JSBool
+jjadmaudioResample_set(JSContext *cx, JSObject *obj, jsval id, jsval *val)
+{
+    int var29;
+    jsval var32;
+    int32 var33;
+    JSBool var28;
+    var29 = 0;
+    var32 = JSVAL_NULL;
+    var33 = 0;
+    var28 = JS_FALSE;
+    if (!JS_EnterLocalRootScope(cx)) {
+        goto do_return;
     }
-    var25 = jsAppendVideo(var29);
-    if (JS_NewNumberValue(cx, var25, &var37) != JS_TRUE) {
+    var32 = *val;
+    if (JS_ValueToInt32(cx, var32, &var33) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+2] = var37;
-    if (rval) {
-        *rval = var37;
-    }
-    var23 = JS_TRUE;
+    var29 = (int)var33;
+    jsSetResample(var29);
+    var28 = JS_TRUE;
     do_return:
-    if (var36) {
-        JS_free(cx, var29);
-        var29 = NULL;
-        var36 = 0;
-    }
-    return var23;
+    JS_LeaveLocalRootScope(cx);
+    return var28;
 }
 static JSBool
-jjadmaddSegment(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmloadVideo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var39;
-    int var44;
-    double var45;
-    double var46;
-    int var40;
-    int var43;
+    JSObject *var35;
+    char *var40;
+    int var36;
+    int var39;
+    int var41;
+    jsval var42;
+    JSString *var43;
+    jsval var361;
+    size_t var44;
+    size_t var45;
     int var47;
+    jschar *var46;
+    jsval var362;
     jsval var48;
-    int32 var49;
-    int var50;
-    jsval var51;
-    jsdouble var52;
-    int var53;
-    jsval var54;
-    jsdouble var55;
-    jsval var56;
-    JSBool var38;
-    var39 = NULL;
+    JSBool var34;
+    var35 = NULL;
+    var40 = NULL;
+    var36 = 0;
+    var39 = 0;
+    var41 = 0;
+    var42 = JSVAL_NULL;
+    var43 = NULL;
+    var361 = JSVAL_NULL;
     var44 = 0;
-    var45 = 0.0;
-    var46 = 0.0;
-    var40 = 0;
-    var43 = 0;
+    var45 = 0;
     var47 = 0;
+    var46 = NULL;
+    var362 = JSVAL_NULL;
     var48 = JSVAL_NULL;
-    var49 = 0;
-    var50 = 0;
-    var51 = JSVAL_NULL;
-    var52 = 0.0;
-    var53 = 0;
-    var54 = JSVAL_NULL;
-    var55 = 0.0;
-    var56 = JSVAL_NULL;
-    var38 = JS_FALSE;
-    var39 = obj;
-    var43 = argc;
-    var47 = 0;
-    var47 = var47 < var43;
-    if (var47) {
-    var48 = argv[0];
-    if (JS_ValueToInt32(cx, var48, &var49) != JS_TRUE) {
+    var34 = JS_FALSE;
+    var35 = obj;
+    var39 = argc;
+    var41 = 0;
+    var41 = var41 < var39;
+    if (var41) {
+    var42 = argv[0];
+    var43 = JS_ValueToString(cx, var42);
+    if (!var43) {
         goto do_return;
     }
-    var44 = (int)var49;
-    }
-    var50 = 1;
-    var50 = var50 < var43;
-    if (var50) {
-    var51 = argv[1];
-    if (JS_ValueToNumber(cx, var51, &var52) != JS_TRUE) {
+    var361 = STRING_TO_JSVAL(var43);
+    argv[argc+0] = var361;
+    var44 = JS_GetStringLength(var43);
+    var45 = 1;
+    var45 += var44;
+    var40 = JS_malloc(cx, var45);
+    if (!var40) {
         goto do_return;
     }
-    var45 = (double)var52;
+    var47 = 1;
+    var46 = JS_GetStringChars(var43);
+    var362 = STRING_TO_JSVAL(var43);
+    argv[argc+1] = var362;
+    {
+        size_t i;
+        for (i = 0; i < var44; ++i) {
+            var40[i] = wctob(var46[i]);
+        }
+        var40[var44] = '\0';
     }
-    var53 = 2;
-    var53 = var53 < var43;
-    if (var53) {
-    var54 = argv[2];
-    if (JS_ValueToNumber(cx, var54, &var55) != JS_TRUE) {
+    }
+    var36 = jsLoadVideo(var40);
+    if (JS_NewNumberValue(cx, var36, &var48) != JS_TRUE) {
         goto do_return;
     }
-    var46 = (double)var55;
+    argv[argc+2] = var48;
+    if (rval) {
+        *rval = var48;
     }
-    var40 = jsAddSegment(var44, var45, var46);
-    if (JS_NewNumberValue(cx, var40, &var56) != JS_TRUE) {
+    var34 = JS_TRUE;
+    do_return:
+    if (var47) {
+        JS_free(cx, var40);
+        var40 = NULL;
+        var47 = 0;
+    }
+    return var34;
+}
+static JSBool
+jjadmclearSegments(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var50;
+    int var51;
+    int var54;
+    jsval var55;
+    JSBool var49;
+    var50 = NULL;
+    var51 = 0;
+    var54 = 0;
+    var55 = JSVAL_NULL;
+    var49 = JS_FALSE;
+    var50 = obj;
+    var54 = argc;
+    var51 = jsClearSegments();
+    if (JS_NewNumberValue(cx, var51, &var55) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+0] = var56;
+    argv[argc+0] = var55;
     if (rval) {
-        *rval = var56;
+        *rval = var55;
     }
-    var38 = JS_TRUE;
+    var49 = JS_TRUE;
     do_return:
-    return var38;
+    return var49;
 }
 static JSBool
-jjadmsetPostProc(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmappendVideo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var58;
+    JSObject *var57;
+    char *var62;
+    int var58;
+    int var61;
     int var63;
-    int var64;
-    int var65;
-    int var59;
-    int var62;
-    int var66;
-    jsval var67;
-    int32 var68;
+    jsval var64;
+    JSString *var65;
+    jsval var365;
+    size_t var66;
+    size_t var67;
     int var69;
+    jschar *var68;
+    jsval var366;
     jsval var70;
-    int32 var71;
-    int var72;
-    jsval var73;
-    int32 var74;
-    jsval var75;
-    JSBool var57;
-    var58 = NULL;
+    JSBool var56;
+    var57 = NULL;
+    var62 = NULL;
+    var58 = 0;
+    var61 = 0;
     var63 = 0;
-    var64 = 0;
-    var65 = 0;
-    var59 = 0;
-    var62 = 0;
+    var64 = JSVAL_NULL;
+    var65 = NULL;
+    var365 = JSVAL_NULL;
     var66 = 0;
-    var67 = JSVAL_NULL;
-    var68 = 0;
+    var67 = 0;
     var69 = 0;
+    var68 = NULL;
+    var366 = JSVAL_NULL;
     var70 = JSVAL_NULL;
-    var71 = 0;
-    var72 = 0;
-    var73 = JSVAL_NULL;
-    var74 = 0;
-    var75 = JSVAL_NULL;
-    var57 = JS_FALSE;
-    var58 = obj;
-    var62 = argc;
-    var66 = 0;
-    var66 = var66 < var62;
-    if (var66) {
-    var67 = argv[0];
-    if (JS_ValueToInt32(cx, var67, &var68) != JS_TRUE) {
+    var56 = JS_FALSE;
+    var57 = obj;
+    var61 = argc;
+    var63 = 0;
+    var63 = var63 < var61;
+    if (var63) {
+    var64 = argv[0];
+    var65 = JS_ValueToString(cx, var64);
+    if (!var65) {
         goto do_return;
     }
-    var63 = (int)var68;
+    var365 = STRING_TO_JSVAL(var65);
+    argv[argc+0] = var365;
+    var66 = JS_GetStringLength(var65);
+    var67 = 1;
+    var67 += var66;
+    var62 = JS_malloc(cx, var67);
+    if (!var62) {
+        goto do_return;
     }
     var69 = 1;
-    var69 = var69 < var62;
-    if (var69) {
-    var70 = argv[1];
-    if (JS_ValueToInt32(cx, var70, &var71) != JS_TRUE) {
-        goto do_return;
+    var68 = JS_GetStringChars(var65);
+    var366 = STRING_TO_JSVAL(var65);
+    argv[argc+1] = var366;
+    {
+        size_t i;
+        for (i = 0; i < var66; ++i) {
+            var62[i] = wctob(var68[i]);
+        }
+        var62[var66] = '\0';
     }
-    var64 = (int)var71;
     }
-    var72 = 2;
-    var72 = var72 < var62;
-    if (var72) {
-    var73 = argv[2];
-    if (JS_ValueToInt32(cx, var73, &var74) != JS_TRUE) {
+    var58 = jsAppendVideo(var62);
+    if (JS_NewNumberValue(cx, var58, &var70) != JS_TRUE) {
         goto do_return;
     }
-    var65 = (int)var74;
-    }
-    var59 = jsSetPostProc(var63, var64, var65);
-    if (JS_NewNumberValue(cx, var59, &var75) != JS_TRUE) {
-        goto do_return;
-    }
-    argv[argc+0] = var75;
+    argv[argc+2] = var70;
     if (rval) {
-        *rval = var75;
+        *rval = var70;
     }
-    var57 = JS_TRUE;
+    var56 = JS_TRUE;
     do_return:
-    return var57;
+    if (var69) {
+        JS_free(cx, var62);
+        var62 = NULL;
+        var69 = 0;
+    }
+    return var56;
 }
 static JSBool
-jjadmaudioReset(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmaddSegment(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var77;
-    int var78;
-    int var81;
-    jsval var82;
-    JSBool var76;
-    var77 = NULL;
-    var78 = 0;
-    var81 = 0;
-    var82 = JSVAL_NULL;
-    var76 = JS_FALSE;
-    var77 = obj;
-    var81 = argc;
-    var78 = jsAudioReset();
-    if (JS_NewNumberValue(cx, var78, &var82) != JS_TRUE) {
+    JSObject *var72;
+    int var77;
+    double var78;
+    double var79;
+    int var73;
+    int var76;
+    int var80;
+    jsval var81;
+    int32 var82;
+    int var83;
+    jsval var84;
+    jsdouble var85;
+    int var86;
+    jsval var87;
+    jsdouble var88;
+    jsval var89;
+    JSBool var71;
+    var72 = NULL;
+    var77 = 0;
+    var78 = 0.0;
+    var79 = 0.0;
+    var73 = 0;
+    var76 = 0;
+    var80 = 0;
+    var81 = JSVAL_NULL;
+    var82 = 0;
+    var83 = 0;
+    var84 = JSVAL_NULL;
+    var85 = 0.0;
+    var86 = 0;
+    var87 = JSVAL_NULL;
+    var88 = 0.0;
+    var89 = JSVAL_NULL;
+    var71 = JS_FALSE;
+    var72 = obj;
+    var76 = argc;
+    var80 = 0;
+    var80 = var80 < var76;
+    if (var80) {
+    var81 = argv[0];
+    if (JS_ValueToInt32(cx, var81, &var82) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+0] = var82;
+    var77 = (int)var82;
+    }
+    var83 = 1;
+    var83 = var83 < var76;
+    if (var83) {
+    var84 = argv[1];
+    if (JS_ValueToNumber(cx, var84, &var85) != JS_TRUE) {
+        goto do_return;
+    }
+    var78 = (double)var85;
+    }
+    var86 = 2;
+    var86 = var86 < var76;
+    if (var86) {
+    var87 = argv[2];
+    if (JS_ValueToNumber(cx, var87, &var88) != JS_TRUE) {
+        goto do_return;
+    }
+    var79 = (double)var88;
+    }
+    var73 = jsAddSegment(var77, var78, var79);
+    if (JS_NewNumberValue(cx, var73, &var89) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+0] = var89;
     if (rval) {
-        *rval = var82;
+        *rval = var89;
     }
-    var76 = JS_TRUE;
+    var71 = JS_TRUE;
     do_return:
-    return var76;
+    return var71;
 }
 static JSBool
-jjadmvideoCodec_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmsetPostProc(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var84;
-    char *var89;
-    char **var90;
-    int var85;
-    int var88;
-    int var91;
-    jsval var92;
-    JSString *var93;
-    jsval var323;
-    size_t var94;
-    size_t var95;
+    JSObject *var91;
+    int var96;
     int var97;
-    jschar *var96;
-    jsval var324;
     int var98;
-    jsval var99;
-    JSObject *var100;
-    jsval var325;
-    jsuint var101;
-    char **var103;
-    size_t var104;
-    int var130;
-    size_t var105;
-    JSString *var106;
-    size_t var107;
-    JSString **var113;
-    int var131;
-    jsuint var108;
-    jsint var109;
-    JSBool var110;
-    jsval var111;
-    JSString *var112;
-    jsval var326;
-    size_t var116;
-    jsuint var114;
-    jsint var115;
-    JSString *var118;
-    size_t var117;
-    size_t var119;
-    char var128;
-    size_t var129;
-    char *var120;
-    int var132;
-    char *var121;
-    size_t var122;
-    int var133;
-    char *var125;
-    jsuint var123;
-    jsint var124;
-    JSString *var127;
-    size_t var126;
-    size_t var134;
-    size_t var135;
-    int var137;
-    jschar *var136;
-    jsval var327;
-    jsval var138;
-    JSBool var83;
-    var84 = NULL;
-    var89 = NULL;
-    var90 = NULL;
-    var85 = 0;
-    var88 = 0;
-    var91 = 0;
-    var92 = JSVAL_NULL;
-    var93 = NULL;
-    var323 = JSVAL_NULL;
-    var94 = 0;
-    var95 = 0;
+    int var92;
+    int var95;
+    int var99;
+    jsval var100;
+    int32 var101;
+    int var102;
+    jsval var103;
+    int32 var104;
+    int var105;
+    jsval var106;
+    int32 var107;
+    jsval var108;
+    JSBool var90;
+    var91 = NULL;
+    var96 = 0;
     var97 = 0;
-    var96 = NULL;
-    var324 = JSVAL_NULL;
     var98 = 0;
-    var99 = JSVAL_NULL;
-    var100 = NULL;
-    var325 = JSVAL_NULL;
+    var92 = 0;
+    var95 = 0;
+    var99 = 0;
+    var100 = JSVAL_NULL;
     var101 = 0;
-    var103 = NULL;
+    var102 = 0;
+    var103 = JSVAL_NULL;
     var104 = 0;
-    var130 = 0;
     var105 = 0;
-    var106 = NULL;
+    var106 = JSVAL_NULL;
     var107 = 0;
-    var113 = NULL;
-    var131 = 0;
-    var108 = 0;
-    var109 = 0;
-    var110 = JS_FALSE;
-    var111 = JSVAL_NULL;
-    var112 = NULL;
-    var326 = JSVAL_NULL;
-    var116 = 0;
+    var108 = JSVAL_NULL;
+    var90 = JS_FALSE;
+    var91 = obj;
+    var95 = argc;
+    var99 = 0;
+    var99 = var99 < var95;
+    if (var99) {
+    var100 = argv[0];
+    if (JS_ValueToInt32(cx, var100, &var101) != JS_TRUE) {
+        goto do_return;
+    }
+    var96 = (int)var101;
+    }
+    var102 = 1;
+    var102 = var102 < var95;
+    if (var102) {
+    var103 = argv[1];
+    if (JS_ValueToInt32(cx, var103, &var104) != JS_TRUE) {
+        goto do_return;
+    }
+    var97 = (int)var104;
+    }
+    var105 = 2;
+    var105 = var105 < var95;
+    if (var105) {
+    var106 = argv[2];
+    if (JS_ValueToInt32(cx, var106, &var107) != JS_TRUE) {
+        goto do_return;
+    }
+    var98 = (int)var107;
+    }
+    var92 = jsSetPostProc(var96, var97, var98);
+    if (JS_NewNumberValue(cx, var92, &var108) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+0] = var108;
+    if (rval) {
+        *rval = var108;
+    }
+    var90 = JS_TRUE;
+    do_return:
+    return var90;
+}
+static JSBool
+jjadmaudioReset(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var110;
+    int var111;
+    int var114;
+    jsval var115;
+    JSBool var109;
+    var110 = NULL;
+    var111 = 0;
     var114 = 0;
-    var115 = 0;
-    var118 = NULL;
-    var117 = 0;
-    var119 = 0;
-    var128 = 0;
+    var115 = JSVAL_NULL;
+    var109 = JS_FALSE;
+    var110 = obj;
+    var114 = argc;
+    var111 = jsAudioReset();
+    if (JS_NewNumberValue(cx, var111, &var115) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+0] = var115;
+    if (rval) {
+        *rval = var115;
+    }
+    var109 = JS_TRUE;
+    do_return:
+    return var109;
+}
+static JSBool
+jjadmaudioMixer(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var117;
+    char *var122;
+    int var118;
+    int var121;
+    int var123;
+    jsval var124;
+    JSString *var125;
+    jsval var371;
+    size_t var126;
+    size_t var127;
+    int var129;
+    jschar *var128;
+    jsval var372;
+    jsval var130;
+    JSBool var116;
+    var117 = NULL;
+    var122 = NULL;
+    var118 = 0;
+    var121 = 0;
+    var123 = 0;
+    var124 = JSVAL_NULL;
+    var125 = NULL;
+    var371 = JSVAL_NULL;
+    var126 = 0;
+    var127 = 0;
     var129 = 0;
-    var120 = NULL;
-    var132 = 0;
-    var121 = NULL;
-    var122 = 0;
-    var133 = 0;
-    var125 = NULL;
+    var128 = NULL;
+    var372 = JSVAL_NULL;
+    var130 = JSVAL_NULL;
+    var116 = JS_FALSE;
+    var117 = obj;
+    var121 = argc;
     var123 = 0;
-    var124 = 0;
-    var127 = NULL;
-    var126 = 0;
-    var134 = 0;
-    var135 = 0;
-    var137 = 0;
-    var136 = NULL;
-    var327 = JSVAL_NULL;
-    var138 = JSVAL_NULL;
-    var83 = JS_FALSE;
-    var84 = obj;
-    var88 = argc;
-    var91 = 0;
-    var91 = var91 < var88;
-    if (var91) {
-    var92 = argv[0];
-    var93 = JS_ValueToString(cx, var92);
-    if (!var93) {
+    var123 = var123 < var121;
+    if (var123) {
+    var124 = argv[0];
+    var125 = JS_ValueToString(cx, var124);
+    if (!var125) {
         goto do_return;
     }
-    var323 = STRING_TO_JSVAL(var93);
-    argv[argc+0] = var323;
-    var94 = JS_GetStringLength(var93);
-    var95 = 1;
-    var95 += var94;
-    var89 = JS_malloc(cx, var95);
-    if (!var89) {
+    var371 = STRING_TO_JSVAL(var125);
+    argv[argc+0] = var371;
+    var126 = JS_GetStringLength(var125);
+    var127 = 1;
+    var127 += var126;
+    var122 = JS_malloc(cx, var127);
+    if (!var122) {
         goto do_return;
     }
-    var97 = 1;
-    var96 = JS_GetStringChars(var93);
-    var324 = STRING_TO_JSVAL(var93);
-    argv[argc+1] = var324;
+    var129 = 1;
+    var128 = JS_GetStringChars(var125);
+    var372 = STRING_TO_JSVAL(var125);
+    argv[argc+1] = var372;
     {
         size_t i;
-        for (i = 0; i < var94; ++i) {
-            var89[i] = wctob(var96[i]);
+        for (i = 0; i < var126; ++i) {
+            var122[i] = wctob(var128[i]);
         }
-        var89[var94] = '\0';
+        var122[var126] = '\0';
     }
     }
-    var98 = 1;
-    var98 = var98 < var88;
-    if (var98) {
-    var99 = argv[1];
-    if (JS_ValueToObject(cx, var99, &var100) != JS_TRUE) {
+    var118 = jsAudioMixer(var122);
+    if (JS_NewNumberValue(cx, var118, &var130) != JS_TRUE) {
         goto do_return;
     }
-    var325 = OBJECT_TO_JSVAL(var100);
-    argv[argc+2] = var325;
-    if (JS_GetArrayLength(cx, var100, &var101) != JS_TRUE) {
+    argv[argc+2] = var130;
+    if (rval) {
+        *rval = var130;
+    }
+    var116 = JS_TRUE;
+    do_return:
+    if (var129) {
+        JS_free(cx, var122);
+        var122 = NULL;
+        var129 = 0;
+    }
+    return var116;
+}
+static JSBool
+jjadmvideoCodec_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var132;
+    char *var137;
+    char **var138;
+    int var133;
+    int var136;
+    int var139;
+    jsval var140;
+    JSString *var141;
+    jsval var374;
+    size_t var142;
+    size_t var143;
+    int var145;
+    jschar *var144;
+    jsval var375;
+    int var146;
+    jsval var147;
+    JSObject *var148;
+    jsval var376;
+    jsuint var149;
+    char **var151;
+    size_t var152;
+    int var178;
+    size_t var153;
+    JSString *var154;
+    size_t var155;
+    JSString **var161;
+    int var179;
+    jsuint var156;
+    jsint var157;
+    JSBool var158;
+    jsval var159;
+    JSString *var160;
+    jsval var377;
+    size_t var164;
+    jsuint var162;
+    jsint var163;
+    JSString *var166;
+    size_t var165;
+    size_t var167;
+    char var176;
+    size_t var177;
+    char *var168;
+    int var180;
+    char *var169;
+    size_t var170;
+    int var181;
+    char *var173;
+    jsuint var171;
+    jsint var172;
+    JSString *var175;
+    size_t var174;
+    size_t var182;
+    size_t var183;
+    int var185;
+    jschar *var184;
+    jsval var378;
+    jsval var186;
+    JSBool var131;
+    var132 = NULL;
+    var137 = NULL;
+    var138 = NULL;
+    var133 = 0;
+    var136 = 0;
+    var139 = 0;
+    var140 = JSVAL_NULL;
+    var141 = NULL;
+    var374 = JSVAL_NULL;
+    var142 = 0;
+    var143 = 0;
+    var145 = 0;
+    var144 = NULL;
+    var375 = JSVAL_NULL;
+    var146 = 0;
+    var147 = JSVAL_NULL;
+    var148 = NULL;
+    var376 = JSVAL_NULL;
+    var149 = 0;
+    var151 = NULL;
+    var152 = 0;
+    var178 = 0;
+    var153 = 0;
+    var154 = NULL;
+    var155 = 0;
+    var161 = NULL;
+    var179 = 0;
+    var156 = 0;
+    var157 = 0;
+    var158 = JS_FALSE;
+    var159 = JSVAL_NULL;
+    var160 = NULL;
+    var377 = JSVAL_NULL;
+    var164 = 0;
+    var162 = 0;
+    var163 = 0;
+    var166 = NULL;
+    var165 = 0;
+    var167 = 0;
+    var176 = 0;
+    var177 = 0;
+    var168 = NULL;
+    var180 = 0;
+    var169 = NULL;
+    var170 = 0;
+    var181 = 0;
+    var173 = NULL;
+    var171 = 0;
+    var172 = 0;
+    var175 = NULL;
+    var174 = 0;
+    var182 = 0;
+    var183 = 0;
+    var185 = 0;
+    var184 = NULL;
+    var378 = JSVAL_NULL;
+    var186 = JSVAL_NULL;
+    var131 = JS_FALSE;
+    var132 = obj;
+    var136 = argc;
+    var139 = 0;
+    var139 = var139 < var136;
+    if (var139) {
+    var140 = argv[0];
+    var141 = JS_ValueToString(cx, var140);
+    if (!var141) {
         goto do_return;
     }
-    var104 = sizeof(var103);
-    var104 *= var101;
-    var90 = JS_malloc(cx, var104);
-    if (!var90) {
+    var374 = STRING_TO_JSVAL(var141);
+    argv[argc+0] = var374;
+    var142 = JS_GetStringLength(var141);
+    var143 = 1;
+    var143 += var142;
+    var137 = JS_malloc(cx, var143);
+    if (!var137) {
         goto do_return;
     }
-    var130 = 1;
-    var105 = var101;
-    var107 = sizeof(var106);
-    var105 *= var107;
-    var113 = JS_malloc(cx, var105);
-    if (!var113) {
+    var145 = 1;
+    var144 = JS_GetStringChars(var141);
+    var375 = STRING_TO_JSVAL(var141);
+    argv[argc+1] = var375;
+    {
+        size_t i;
+        for (i = 0; i < var142; ++i) {
+            var137[i] = wctob(var144[i]);
+        }
+        var137[var142] = '\0';
+    }
+    }
+    var146 = 1;
+    var146 = var146 < var136;
+    if (var146) {
+    var147 = argv[1];
+    if (JS_ValueToObject(cx, var147, &var148) != JS_TRUE) {
         goto do_return;
     }
-    var131 = 1;
-    var108 = var101;
-    var109 = -1;
-    while (var108)
+    var376 = OBJECT_TO_JSVAL(var148);
+    argv[argc+2] = var376;
+    if (JS_GetArrayLength(cx, var148, &var149) != JS_TRUE) {
+        goto do_return;
+    }
+    var152 = sizeof(var151);
+    var152 *= var149;
+    var138 = JS_malloc(cx, var152);
+    if (!var138) {
+        goto do_return;
+    }
+    var178 = 1;
+    var153 = var149;
+    var155 = sizeof(var154);
+    var153 *= var155;
+    var161 = JS_malloc(cx, var153);
+    if (!var161) {
+        goto do_return;
+    }
+    var179 = 1;
+    var156 = var149;
+    var157 = -1;
+    while (var156)
     {
-    var108 += var109;
-    var110 = JS_GetElement(cx, var100, var108, &var111);
-    var112 = JS_ValueToString(cx, var111);
-    if (!var112) {
+    var156 += var157;
+    var158 = JS_GetElement(cx, var148, var156, &var159);
+    var160 = JS_ValueToString(cx, var159);
+    if (!var160) {
         goto do_return;
     }
-    var326 = STRING_TO_JSVAL(var112);
-    argv[argc+3] = var326;
-    var113[var108] = var112;
+    var377 = STRING_TO_JSVAL(var160);
+    argv[argc+3] = var377;
+    var161[var156] = var160;
     }
-    var116 = 0;
-    var114 = var101;
-    var115 = -1;
-    while (var114)
+    var164 = 0;
+    var162 = var149;
+    var163 = -1;
+    while (var162)
     {
-    var114 += var115;
-    var118 = var113[var114];
-    var117 = JS_GetStringLength(var118);
-    var116 += var117;
-    var119 = 1;
-    var116 += var119;
+    var162 += var163;
+    var166 = var161[var162];
+    var165 = JS_GetStringLength(var166);
+    var164 += var165;
+    var167 = 1;
+    var164 += var167;
     }
-    var129 = sizeof(var128);
-    var129 *= var116;
-    var120 = JS_malloc(cx, var129);
-    if (!var120) {
+    var177 = sizeof(var176);
+    var177 *= var164;
+    var168 = JS_malloc(cx, var177);
+    if (!var168) {
         goto do_return;
     }
-    var132 = 1;
-    var122 = sizeof(var121);
-    var122 *= var101;
-    var90 = JS_malloc(cx, var122);
-    if (!var90) {
+    var180 = 1;
+    var170 = sizeof(var169);
+    var170 *= var149;
+    var138 = JS_malloc(cx, var170);
+    if (!var138) {
         goto do_return;
     }
-    var133 = 1;
-    var125 = var120;
-    var125 += var116;
-    var123 = var101;
-    var124 = -1;
-    while (var123)
+    var181 = 1;
+    var173 = var168;
+    var173 += var164;
+    var171 = var149;
+    var172 = -1;
+    while (var171)
     {
-    var123 += var124;
-    var127 = var113[var123];
-    var126 = JS_GetStringLength(var127);
-    var125 -= var126;
-    var125 += var124;
-    var134 = JS_GetStringLength(var127);
-    var135 = 1;
-    var135 += var134;
-    var125 = JS_malloc(cx, var135);
-    if (!var125) {
+    var171 += var172;
+    var175 = var161[var171];
+    var174 = JS_GetStringLength(var175);
+    var173 -= var174;
+    var173 += var172;
+    var182 = JS_GetStringLength(var175);
+    var183 = 1;
+    var183 += var182;
+    var173 = JS_malloc(cx, var183);
+    if (!var173) {
         goto do_return;
     }
-    var137 = 1;
-    var136 = JS_GetStringChars(var127);
-    var327 = STRING_TO_JSVAL(var127);
-    argv[argc+4] = var327;
+    var185 = 1;
+    var184 = JS_GetStringChars(var175);
+    var378 = STRING_TO_JSVAL(var175);
+    argv[argc+4] = var378;
     {
         size_t i;
-        for (i = 0; i < var134; ++i) {
-            var125[i] = wctob(var136[i]);
+        for (i = 0; i < var182; ++i) {
+            var173[i] = wctob(var184[i]);
         }
-        var125[var134] = '\0';
+        var173[var182] = '\0';
     }
-    var90[var123] = var125;
+    var138[var171] = var173;
     }
     }
-    var85 = jsVideoCodec(var89, var90);
-    if (JS_NewNumberValue(cx, var85, &var138) != JS_TRUE) {
+    var133 = jsVideoCodec(var137, var138);
+    if (JS_NewNumberValue(cx, var133, &var186) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+5] = var138;
+    argv[argc+5] = var186;
     if (rval) {
-        *rval = var138;
+        *rval = var186;
     }
-    var83 = JS_TRUE;
+    var131 = JS_TRUE;
     do_return:
-    if (var137) {
-        JS_free(cx, var125);
-        var125 = NULL;
-        var137 = 0;
+    if (var185) {
+        JS_free(cx, var173);
+        var173 = NULL;
+        var185 = 0;
     }
-    if (var133) {
-        JS_free(cx, var90);
-        var90 = NULL;
-        var133 = 0;
+    if (var181) {
+        JS_free(cx, var138);
+        var138 = NULL;
+        var181 = 0;
     }
-    if (var132) {
-        JS_free(cx, var120);
-        var120 = NULL;
-        var132 = 0;
+    if (var180) {
+        JS_free(cx, var168);
+        var168 = NULL;
+        var180 = 0;
     }
-    if (var131) {
-        JS_free(cx, var113);
-        var113 = NULL;
-        var131 = 0;
+    if (var179) {
+        JS_free(cx, var161);
+        var161 = NULL;
+        var179 = 0;
     }
-    if (var130) {
-        JS_free(cx, var90);
-        var90 = NULL;
-        var130 = 0;
+    if (var178) {
+        JS_free(cx, var138);
+        var138 = NULL;
+        var178 = 0;
     }
-    if (var97) {
-        JS_free(cx, var89);
-        var89 = NULL;
-        var97 = 0;
+    if (var145) {
+        JS_free(cx, var137);
+        var137 = NULL;
+        var145 = 0;
     }
-    return var83;
+    return var131;
 }
 static JSBool
 jjadmaddVideoFilter_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var140;
-    char *var145;
-    char **var146;
-    int var141;
-    int var144;
-    int var147;
-    jsval var148;
-    JSString *var149;
-    jsval var329;
-    size_t var150;
-    size_t var151;
-    int var153;
-    jschar *var152;
-    jsval var330;
-    int var154;
-    jsval var155;
-    JSObject *var156;
-    jsval var331;
-    jsuint var157;
-    char **var159;
-    size_t var160;
-    int var186;
-    size_t var161;
-    JSString *var162;
-    size_t var163;
-    JSString **var169;
-    int var187;
-    jsuint var164;
-    jsint var165;
-    JSBool var166;
-    jsval var167;
-    JSString *var168;
-    jsval var332;
-    size_t var172;
-    jsuint var170;
-    jsint var171;
-    JSString *var174;
-    size_t var173;
-    size_t var175;
-    char var184;
-    size_t var185;
-    char *var176;
-    int var188;
-    char *var177;
-    size_t var178;
+    JSObject *var188;
+    char *var193;
+    char **var194;
     int var189;
-    char *var181;
-    jsuint var179;
-    jsint var180;
-    JSString *var183;
-    size_t var182;
-    size_t var190;
-    size_t var191;
-    int var193;
-    jschar *var192;
-    jsval var333;
-    jsval var194;
-    JSBool var139;
-    var140 = NULL;
-    var145 = NULL;
-    var146 = NULL;
-    var141 = 0;
-    var144 = 0;
-    var147 = 0;
-    var148 = JSVAL_NULL;
-    var149 = NULL;
-    var329 = JSVAL_NULL;
-    var150 = 0;
-    var151 = 0;
-    var153 = 0;
-    var152 = NULL;
-    var330 = JSVAL_NULL;
-    var154 = 0;
-    var155 = JSVAL_NULL;
-    var156 = NULL;
-    var331 = JSVAL_NULL;
-    var157 = 0;
-    var159 = NULL;
-    var160 = 0;
-    var186 = 0;
-    var161 = 0;
-    var162 = NULL;
-    var163 = 0;
-    var169 = NULL;
-    var187 = 0;
-    var164 = 0;
-    var165 = 0;
-    var166 = JS_FALSE;
-    var167 = JSVAL_NULL;
-    var168 = NULL;
-    var332 = JSVAL_NULL;
-    var172 = 0;
-    var170 = 0;
-    var171 = 0;
-    var174 = NULL;
-    var173 = 0;
-    var175 = 0;
-    var184 = 0;
-    var185 = 0;
-    var176 = NULL;
-    var188 = 0;
-    var177 = NULL;
-    var178 = 0;
+    int var192;
+    int var195;
+    jsval var196;
+    JSString *var197;
+    jsval var380;
+    size_t var198;
+    size_t var199;
+    int var201;
+    jschar *var200;
+    jsval var381;
+    int var202;
+    jsval var203;
+    JSObject *var204;
+    jsval var382;
+    jsuint var205;
+    char **var207;
+    size_t var208;
+    int var234;
+    size_t var209;
+    JSString *var210;
+    size_t var211;
+    JSString **var217;
+    int var235;
+    jsuint var212;
+    jsint var213;
+    JSBool var214;
+    jsval var215;
+    JSString *var216;
+    jsval var383;
+    size_t var220;
+    jsuint var218;
+    jsint var219;
+    JSString *var222;
+    size_t var221;
+    size_t var223;
+    char var232;
+    size_t var233;
+    char *var224;
+    int var236;
+    char *var225;
+    size_t var226;
+    int var237;
+    char *var229;
+    jsuint var227;
+    jsint var228;
+    JSString *var231;
+    size_t var230;
+    size_t var238;
+    size_t var239;
+    int var241;
+    jschar *var240;
+    jsval var384;
+    jsval var242;
+    JSBool var187;
+    var188 = NULL;
+    var193 = NULL;
+    var194 = NULL;
     var189 = 0;
-    var181 = NULL;
-    var179 = 0;
-    var180 = 0;
-    var183 = NULL;
-    var182 = 0;
-    var190 = 0;
-    var191 = 0;
-    var193 = 0;
-    var192 = NULL;
-    var333 = JSVAL_NULL;
-    var194 = JSVAL_NULL;
-    var139 = JS_FALSE;
-    var140 = obj;
-    var144 = argc;
-    var147 = 0;
-    var147 = var147 < var144;
-    if (var147) {
-    var148 = argv[0];
-    var149 = JS_ValueToString(cx, var148);
-    if (!var149) {
+    var192 = 0;
+    var195 = 0;
+    var196 = JSVAL_NULL;
+    var197 = NULL;
+    var380 = JSVAL_NULL;
+    var198 = 0;
+    var199 = 0;
+    var201 = 0;
+    var200 = NULL;
+    var381 = JSVAL_NULL;
+    var202 = 0;
+    var203 = JSVAL_NULL;
+    var204 = NULL;
+    var382 = JSVAL_NULL;
+    var205 = 0;
+    var207 = NULL;
+    var208 = 0;
+    var234 = 0;
+    var209 = 0;
+    var210 = NULL;
+    var211 = 0;
+    var217 = NULL;
+    var235 = 0;
+    var212 = 0;
+    var213 = 0;
+    var214 = JS_FALSE;
+    var215 = JSVAL_NULL;
+    var216 = NULL;
+    var383 = JSVAL_NULL;
+    var220 = 0;
+    var218 = 0;
+    var219 = 0;
+    var222 = NULL;
+    var221 = 0;
+    var223 = 0;
+    var232 = 0;
+    var233 = 0;
+    var224 = NULL;
+    var236 = 0;
+    var225 = NULL;
+    var226 = 0;
+    var237 = 0;
+    var229 = NULL;
+    var227 = 0;
+    var228 = 0;
+    var231 = NULL;
+    var230 = 0;
+    var238 = 0;
+    var239 = 0;
+    var241 = 0;
+    var240 = NULL;
+    var384 = JSVAL_NULL;
+    var242 = JSVAL_NULL;
+    var187 = JS_FALSE;
+    var188 = obj;
+    var192 = argc;
+    var195 = 0;
+    var195 = var195 < var192;
+    if (var195) {
+    var196 = argv[0];
+    var197 = JS_ValueToString(cx, var196);
+    if (!var197) {
         goto do_return;
     }
-    var329 = STRING_TO_JSVAL(var149);
-    argv[argc+0] = var329;
-    var150 = JS_GetStringLength(var149);
-    var151 = 1;
-    var151 += var150;
-    var145 = JS_malloc(cx, var151);
-    if (!var145) {
+    var380 = STRING_TO_JSVAL(var197);
+    argv[argc+0] = var380;
+    var198 = JS_GetStringLength(var197);
+    var199 = 1;
+    var199 += var198;
+    var193 = JS_malloc(cx, var199);
+    if (!var193) {
         goto do_return;
     }
-    var153 = 1;
-    var152 = JS_GetStringChars(var149);
-    var330 = STRING_TO_JSVAL(var149);
-    argv[argc+1] = var330;
+    var201 = 1;
+    var200 = JS_GetStringChars(var197);
+    var381 = STRING_TO_JSVAL(var197);
+    argv[argc+1] = var381;
     {
         size_t i;
-        for (i = 0; i < var150; ++i) {
-            var145[i] = wctob(var152[i]);
+        for (i = 0; i < var198; ++i) {
+            var193[i] = wctob(var200[i]);
         }
-        var145[var150] = '\0';
+        var193[var198] = '\0';
     }
     }
-    var154 = 1;
-    var154 = var154 < var144;
-    if (var154) {
-    var155 = argv[1];
-    if (JS_ValueToObject(cx, var155, &var156) != JS_TRUE) {
+    var202 = 1;
+    var202 = var202 < var192;
+    if (var202) {
+    var203 = argv[1];
+    if (JS_ValueToObject(cx, var203, &var204) != JS_TRUE) {
         goto do_return;
     }
-    var331 = OBJECT_TO_JSVAL(var156);
-    argv[argc+2] = var331;
-    if (JS_GetArrayLength(cx, var156, &var157) != JS_TRUE) {
+    var382 = OBJECT_TO_JSVAL(var204);
+    argv[argc+2] = var382;
+    if (JS_GetArrayLength(cx, var204, &var205) != JS_TRUE) {
         goto do_return;
     }
-    var160 = sizeof(var159);
-    var160 *= var157;
-    var146 = JS_malloc(cx, var160);
-    if (!var146) {
+    var208 = sizeof(var207);
+    var208 *= var205;
+    var194 = JS_malloc(cx, var208);
+    if (!var194) {
         goto do_return;
     }
-    var186 = 1;
-    var161 = var157;
-    var163 = sizeof(var162);
-    var161 *= var163;
-    var169 = JS_malloc(cx, var161);
-    if (!var169) {
+    var234 = 1;
+    var209 = var205;
+    var211 = sizeof(var210);
+    var209 *= var211;
+    var217 = JS_malloc(cx, var209);
+    if (!var217) {
         goto do_return;
     }
-    var187 = 1;
-    var164 = var157;
-    var165 = -1;
-    while (var164)
+    var235 = 1;
+    var212 = var205;
+    var213 = -1;
+    while (var212)
     {
-    var164 += var165;
-    var166 = JS_GetElement(cx, var156, var164, &var167);
-    var168 = JS_ValueToString(cx, var167);
-    if (!var168) {
+    var212 += var213;
+    var214 = JS_GetElement(cx, var204, var212, &var215);
+    var216 = JS_ValueToString(cx, var215);
+    if (!var216) {
         goto do_return;
     }
-    var332 = STRING_TO_JSVAL(var168);
-    argv[argc+3] = var332;
-    var169[var164] = var168;
+    var383 = STRING_TO_JSVAL(var216);
+    argv[argc+3] = var383;
+    var217[var212] = var216;
     }
-    var172 = 0;
-    var170 = var157;
-    var171 = -1;
-    while (var170)
+    var220 = 0;
+    var218 = var205;
+    var219 = -1;
+    while (var218)
     {
-    var170 += var171;
-    var174 = var169[var170];
-    var173 = JS_GetStringLength(var174);
-    var172 += var173;
-    var175 = 1;
-    var172 += var175;
+    var218 += var219;
+    var222 = var217[var218];
+    var221 = JS_GetStringLength(var222);
+    var220 += var221;
+    var223 = 1;
+    var220 += var223;
     }
-    var185 = sizeof(var184);
-    var185 *= var172;
-    var176 = JS_malloc(cx, var185);
-    if (!var176) {
+    var233 = sizeof(var232);
+    var233 *= var220;
+    var224 = JS_malloc(cx, var233);
+    if (!var224) {
         goto do_return;
     }
-    var188 = 1;
-    var178 = sizeof(var177);
-    var178 *= var157;
-    var146 = JS_malloc(cx, var178);
-    if (!var146) {
+    var236 = 1;
+    var226 = sizeof(var225);
+    var226 *= var205;
+    var194 = JS_malloc(cx, var226);
+    if (!var194) {
         goto do_return;
     }
-    var189 = 1;
-    var181 = var176;
-    var181 += var172;
-    var179 = var157;
-    var180 = -1;
-    while (var179)
+    var237 = 1;
+    var229 = var224;
+    var229 += var220;
+    var227 = var205;
+    var228 = -1;
+    while (var227)
     {
-    var179 += var180;
-    var183 = var169[var179];
-    var182 = JS_GetStringLength(var183);
-    var181 -= var182;
-    var181 += var180;
-    var190 = JS_GetStringLength(var183);
-    var191 = 1;
-    var191 += var190;
-    var181 = JS_malloc(cx, var191);
-    if (!var181) {
+    var227 += var228;
+    var231 = var217[var227];
+    var230 = JS_GetStringLength(var231);
+    var229 -= var230;
+    var229 += var228;
+    var238 = JS_GetStringLength(var231);
+    var239 = 1;
+    var239 += var238;
+    var229 = JS_malloc(cx, var239);
+    if (!var229) {
         goto do_return;
     }
-    var193 = 1;
-    var192 = JS_GetStringChars(var183);
-    var333 = STRING_TO_JSVAL(var183);
-    argv[argc+4] = var333;
+    var241 = 1;
+    var240 = JS_GetStringChars(var231);
+    var384 = STRING_TO_JSVAL(var231);
+    argv[argc+4] = var384;
     {
         size_t i;
-        for (i = 0; i < var190; ++i) {
-            var181[i] = wctob(var192[i]);
+        for (i = 0; i < var238; ++i) {
+            var229[i] = wctob(var240[i]);
         }
-        var181[var190] = '\0';
+        var229[var238] = '\0';
     }
-    var146[var179] = var181;
+    var194[var227] = var229;
     }
     }
-    var141 = jsVideoFilter(var145, var146);
-    if (JS_NewNumberValue(cx, var141, &var194) != JS_TRUE) {
+    var189 = jsVideoFilter(var193, var194);
+    if (JS_NewNumberValue(cx, var189, &var242) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+5] = var194;
+    argv[argc+5] = var242;
     if (rval) {
-        *rval = var194;
+        *rval = var242;
     }
-    var139 = JS_TRUE;
+    var187 = JS_TRUE;
     do_return:
-    if (var193) {
-        JS_free(cx, var181);
-        var181 = NULL;
-        var193 = 0;
+    if (var241) {
+        JS_free(cx, var229);
+        var229 = NULL;
+        var241 = 0;
     }
-    if (var189) {
-        JS_free(cx, var146);
-        var146 = NULL;
-        var189 = 0;
+    if (var237) {
+        JS_free(cx, var194);
+        var194 = NULL;
+        var237 = 0;
     }
-    if (var188) {
-        JS_free(cx, var176);
-        var176 = NULL;
-        var188 = 0;
+    if (var236) {
+        JS_free(cx, var224);
+        var224 = NULL;
+        var236 = 0;
     }
-    if (var187) {
-        JS_free(cx, var169);
-        var169 = NULL;
-        var187 = 0;
+    if (var235) {
+        JS_free(cx, var217);
+        var217 = NULL;
+        var235 = 0;
     }
-    if (var186) {
-        JS_free(cx, var146);
-        var146 = NULL;
-        var186 = 0;
+    if (var234) {
+        JS_free(cx, var194);
+        var194 = NULL;
+        var234 = 0;
     }
-    if (var153) {
-        JS_free(cx, var145);
-        var145 = NULL;
-        var153 = 0;
+    if (var201) {
+        JS_free(cx, var193);
+        var193 = NULL;
+        var201 = 0;
     }
-    return var139;
+    return var187;
 }
 static JSBool
 jjadmaudioCodec_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var196;
-    char *var201;
-    char **var202;
-    int var197;
-    int var200;
-    int var203;
-    jsval var204;
-    JSString *var205;
-    jsval var335;
-    size_t var206;
-    size_t var207;
-    int var209;
-    jschar *var208;
-    jsval var336;
-    int var210;
-    jsval var211;
-    JSObject *var212;
-    jsval var337;
-    jsuint var213;
-    char **var215;
-    size_t var216;
-    int var242;
-    size_t var217;
-    JSString *var218;
-    size_t var219;
-    JSString **var225;
-    int var243;
-    jsuint var220;
-    jsint var221;
-    JSBool var222;
-    jsval var223;
-    JSString *var224;
-    jsval var338;
-    size_t var228;
-    jsuint var226;
-    jsint var227;
-    JSString *var230;
-    size_t var229;
-    size_t var231;
-    char var240;
-    size_t var241;
-    char *var232;
-    int var244;
-    char *var233;
-    size_t var234;
+    JSObject *var244;
+    char *var249;
+    char **var250;
     int var245;
-    char *var237;
-    jsuint var235;
-    jsint var236;
-    JSString *var239;
-    size_t var238;
-    size_t var246;
-    size_t var247;
-    int var249;
-    jschar *var248;
-    jsval var339;
-    jsval var250;
-    JSBool var195;
-    var196 = NULL;
-    var201 = NULL;
-    var202 = NULL;
-    var197 = 0;
-    var200 = 0;
-    var203 = 0;
-    var204 = JSVAL_NULL;
-    var205 = NULL;
-    var335 = JSVAL_NULL;
-    var206 = 0;
-    var207 = 0;
-    var209 = 0;
-    var208 = NULL;
-    var336 = JSVAL_NULL;
-    var210 = 0;
-    var211 = JSVAL_NULL;
-    var212 = NULL;
-    var337 = JSVAL_NULL;
-    var213 = 0;
-    var215 = NULL;
-    var216 = 0;
-    var242 = 0;
-    var217 = 0;
-    var218 = NULL;
-    var219 = 0;
-    var225 = NULL;
-    var243 = 0;
-    var220 = 0;
-    var221 = 0;
-    var222 = JS_FALSE;
-    var223 = JSVAL_NULL;
-    var224 = NULL;
-    var338 = JSVAL_NULL;
-    var228 = 0;
-    var226 = 0;
-    var227 = 0;
-    var230 = NULL;
-    var229 = 0;
-    var231 = 0;
-    var240 = 0;
-    var241 = 0;
-    var232 = NULL;
-    var244 = 0;
-    var233 = NULL;
-    var234 = 0;
+    int var248;
+    int var251;
+    jsval var252;
+    JSString *var253;
+    jsval var386;
+    size_t var254;
+    size_t var255;
+    int var257;
+    jschar *var256;
+    jsval var387;
+    int var258;
+    jsval var259;
+    JSObject *var260;
+    jsval var388;
+    jsuint var261;
+    char **var263;
+    size_t var264;
+    int var290;
+    size_t var265;
+    JSString *var266;
+    size_t var267;
+    JSString **var273;
+    int var291;
+    jsuint var268;
+    jsint var269;
+    JSBool var270;
+    jsval var271;
+    JSString *var272;
+    jsval var389;
+    size_t var276;
+    jsuint var274;
+    jsint var275;
+    JSString *var278;
+    size_t var277;
+    size_t var279;
+    char var288;
+    size_t var289;
+    char *var280;
+    int var292;
+    char *var281;
+    size_t var282;
+    int var293;
+    char *var285;
+    jsuint var283;
+    jsint var284;
+    JSString *var287;
+    size_t var286;
+    size_t var294;
+    size_t var295;
+    int var297;
+    jschar *var296;
+    jsval var390;
+    jsval var298;
+    JSBool var243;
+    var244 = NULL;
+    var249 = NULL;
+    var250 = NULL;
     var245 = 0;
-    var237 = NULL;
-    var235 = 0;
-    var236 = 0;
-    var239 = NULL;
-    var238 = 0;
-    var246 = 0;
-    var247 = 0;
-    var249 = 0;
-    var248 = NULL;
-    var339 = JSVAL_NULL;
-    var250 = JSVAL_NULL;
-    var195 = JS_FALSE;
-    var196 = obj;
-    var200 = argc;
-    var203 = 0;
-    var203 = var203 < var200;
-    if (var203) {
-    var204 = argv[0];
-    var205 = JS_ValueToString(cx, var204);
-    if (!var205) {
+    var248 = 0;
+    var251 = 0;
+    var252 = JSVAL_NULL;
+    var253 = NULL;
+    var386 = JSVAL_NULL;
+    var254 = 0;
+    var255 = 0;
+    var257 = 0;
+    var256 = NULL;
+    var387 = JSVAL_NULL;
+    var258 = 0;
+    var259 = JSVAL_NULL;
+    var260 = NULL;
+    var388 = JSVAL_NULL;
+    var261 = 0;
+    var263 = NULL;
+    var264 = 0;
+    var290 = 0;
+    var265 = 0;
+    var266 = NULL;
+    var267 = 0;
+    var273 = NULL;
+    var291 = 0;
+    var268 = 0;
+    var269 = 0;
+    var270 = JS_FALSE;
+    var271 = JSVAL_NULL;
+    var272 = NULL;
+    var389 = JSVAL_NULL;
+    var276 = 0;
+    var274 = 0;
+    var275 = 0;
+    var278 = NULL;
+    var277 = 0;
+    var279 = 0;
+    var288 = 0;
+    var289 = 0;
+    var280 = NULL;
+    var292 = 0;
+    var281 = NULL;
+    var282 = 0;
+    var293 = 0;
+    var285 = NULL;
+    var283 = 0;
+    var284 = 0;
+    var287 = NULL;
+    var286 = 0;
+    var294 = 0;
+    var295 = 0;
+    var297 = 0;
+    var296 = NULL;
+    var390 = JSVAL_NULL;
+    var298 = JSVAL_NULL;
+    var243 = JS_FALSE;
+    var244 = obj;
+    var248 = argc;
+    var251 = 0;
+    var251 = var251 < var248;
+    if (var251) {
+    var252 = argv[0];
+    var253 = JS_ValueToString(cx, var252);
+    if (!var253) {
         goto do_return;
     }
-    var335 = STRING_TO_JSVAL(var205);
-    argv[argc+0] = var335;
-    var206 = JS_GetStringLength(var205);
-    var207 = 1;
-    var207 += var206;
-    var201 = JS_malloc(cx, var207);
-    if (!var201) {
+    var386 = STRING_TO_JSVAL(var253);
+    argv[argc+0] = var386;
+    var254 = JS_GetStringLength(var253);
+    var255 = 1;
+    var255 += var254;
+    var249 = JS_malloc(cx, var255);
+    if (!var249) {
         goto do_return;
     }
-    var209 = 1;
-    var208 = JS_GetStringChars(var205);
-    var336 = STRING_TO_JSVAL(var205);
-    argv[argc+1] = var336;
+    var257 = 1;
+    var256 = JS_GetStringChars(var253);
+    var387 = STRING_TO_JSVAL(var253);
+    argv[argc+1] = var387;
     {
         size_t i;
-        for (i = 0; i < var206; ++i) {
-            var201[i] = wctob(var208[i]);
+        for (i = 0; i < var254; ++i) {
+            var249[i] = wctob(var256[i]);
         }
-        var201[var206] = '\0';
+        var249[var254] = '\0';
     }
     }
-    var210 = 1;
-    var210 = var210 < var200;
-    if (var210) {
-    var211 = argv[1];
-    if (JS_ValueToObject(cx, var211, &var212) != JS_TRUE) {
+    var258 = 1;
+    var258 = var258 < var248;
+    if (var258) {
+    var259 = argv[1];
+    if (JS_ValueToObject(cx, var259, &var260) != JS_TRUE) {
         goto do_return;
     }
-    var337 = OBJECT_TO_JSVAL(var212);
-    argv[argc+2] = var337;
-    if (JS_GetArrayLength(cx, var212, &var213) != JS_TRUE) {
+    var388 = OBJECT_TO_JSVAL(var260);
+    argv[argc+2] = var388;
+    if (JS_GetArrayLength(cx, var260, &var261) != JS_TRUE) {
         goto do_return;
     }
-    var216 = sizeof(var215);
-    var216 *= var213;
-    var202 = JS_malloc(cx, var216);
-    if (!var202) {
+    var264 = sizeof(var263);
+    var264 *= var261;
+    var250 = JS_malloc(cx, var264);
+    if (!var250) {
         goto do_return;
     }
-    var242 = 1;
-    var217 = var213;
-    var219 = sizeof(var218);
-    var217 *= var219;
-    var225 = JS_malloc(cx, var217);
-    if (!var225) {
+    var290 = 1;
+    var265 = var261;
+    var267 = sizeof(var266);
+    var265 *= var267;
+    var273 = JS_malloc(cx, var265);
+    if (!var273) {
         goto do_return;
     }
-    var243 = 1;
-    var220 = var213;
-    var221 = -1;
-    while (var220)
+    var291 = 1;
+    var268 = var261;
+    var269 = -1;
+    while (var268)
     {
-    var220 += var221;
-    var222 = JS_GetElement(cx, var212, var220, &var223);
-    var224 = JS_ValueToString(cx, var223);
-    if (!var224) {
+    var268 += var269;
+    var270 = JS_GetElement(cx, var260, var268, &var271);
+    var272 = JS_ValueToString(cx, var271);
+    if (!var272) {
         goto do_return;
     }
-    var338 = STRING_TO_JSVAL(var224);
-    argv[argc+3] = var338;
-    var225[var220] = var224;
+    var389 = STRING_TO_JSVAL(var272);
+    argv[argc+3] = var389;
+    var273[var268] = var272;
     }
-    var228 = 0;
-    var226 = var213;
-    var227 = -1;
-    while (var226)
+    var276 = 0;
+    var274 = var261;
+    var275 = -1;
+    while (var274)
     {
-    var226 += var227;
-    var230 = var225[var226];
-    var229 = JS_GetStringLength(var230);
-    var228 += var229;
-    var231 = 1;
-    var228 += var231;
+    var274 += var275;
+    var278 = var273[var274];
+    var277 = JS_GetStringLength(var278);
+    var276 += var277;
+    var279 = 1;
+    var276 += var279;
     }
-    var241 = sizeof(var240);
-    var241 *= var228;
-    var232 = JS_malloc(cx, var241);
-    if (!var232) {
+    var289 = sizeof(var288);
+    var289 *= var276;
+    var280 = JS_malloc(cx, var289);
+    if (!var280) {
         goto do_return;
     }
-    var244 = 1;
-    var234 = sizeof(var233);
-    var234 *= var213;
-    var202 = JS_malloc(cx, var234);
-    if (!var202) {
+    var292 = 1;
+    var282 = sizeof(var281);
+    var282 *= var261;
+    var250 = JS_malloc(cx, var282);
+    if (!var250) {
         goto do_return;
     }
-    var245 = 1;
-    var237 = var232;
-    var237 += var228;
-    var235 = var213;
-    var236 = -1;
-    while (var235)
+    var293 = 1;
+    var285 = var280;
+    var285 += var276;
+    var283 = var261;
+    var284 = -1;
+    while (var283)
     {
-    var235 += var236;
-    var239 = var225[var235];
-    var238 = JS_GetStringLength(var239);
-    var237 -= var238;
-    var237 += var236;
-    var246 = JS_GetStringLength(var239);
-    var247 = 1;
-    var247 += var246;
-    var237 = JS_malloc(cx, var247);
-    if (!var237) {
+    var283 += var284;
+    var287 = var273[var283];
+    var286 = JS_GetStringLength(var287);
+    var285 -= var286;
+    var285 += var284;
+    var294 = JS_GetStringLength(var287);
+    var295 = 1;
+    var295 += var294;
+    var285 = JS_malloc(cx, var295);
+    if (!var285) {
         goto do_return;
     }
-    var249 = 1;
-    var248 = JS_GetStringChars(var239);
-    var339 = STRING_TO_JSVAL(var239);
-    argv[argc+4] = var339;
+    var297 = 1;
+    var296 = JS_GetStringChars(var287);
+    var390 = STRING_TO_JSVAL(var287);
+    argv[argc+4] = var390;
     {
         size_t i;
-        for (i = 0; i < var246; ++i) {
-            var237[i] = wctob(var248[i]);
+        for (i = 0; i < var294; ++i) {
+            var285[i] = wctob(var296[i]);
         }
-        var237[var246] = '\0';
+        var285[var294] = '\0';
     }
-    var202[var235] = var237;
+    var250[var283] = var285;
     }
     }
-    var197 = jsAudioCodec(var201, var202);
-    if (JS_NewNumberValue(cx, var197, &var250) != JS_TRUE) {
+    var245 = jsAudioCodec(var249, var250);
+    if (JS_NewNumberValue(cx, var245, &var298) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+5] = var250;
+    argv[argc+5] = var298;
     if (rval) {
-        *rval = var250;
+        *rval = var298;
     }
-    var195 = JS_TRUE;
+    var243 = JS_TRUE;
     do_return:
-    if (var249) {
-        JS_free(cx, var237);
-        var237 = NULL;
-        var249 = 0;
+    if (var297) {
+        JS_free(cx, var285);
+        var285 = NULL;
+        var297 = 0;
     }
-    if (var245) {
-        JS_free(cx, var202);
-        var202 = NULL;
-        var245 = 0;
+    if (var293) {
+        JS_free(cx, var250);
+        var250 = NULL;
+        var293 = 0;
     }
-    if (var244) {
-        JS_free(cx, var232);
-        var232 = NULL;
-        var244 = 0;
+    if (var292) {
+        JS_free(cx, var280);
+        var280 = NULL;
+        var292 = 0;
     }
-    if (var243) {
-        JS_free(cx, var225);
-        var225 = NULL;
-        var243 = 0;
+    if (var291) {
+        JS_free(cx, var273);
+        var273 = NULL;
+        var291 = 0;
     }
-    if (var242) {
-        JS_free(cx, var202);
-        var202 = NULL;
-        var242 = 0;
+    if (var290) {
+        JS_free(cx, var250);
+        var250 = NULL;
+        var290 = 0;
     }
-    if (var209) {
-        JS_free(cx, var201);
-        var201 = NULL;
-        var209 = 0;
+    if (var257) {
+        JS_free(cx, var249);
+        var249 = NULL;
+        var257 = 0;
     }
-    return var195;
+    return var243;
 }
 static JSBool
 jjadmsetContainer_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var252;
-    char *var257;
-    char **var258;
-    int var253;
-    int var256;
-    int var259;
-    jsval var260;
-    JSString *var261;
-    jsval var341;
-    size_t var262;
-    size_t var263;
-    int var265;
-    jschar *var264;
-    jsval var342;
-    int var266;
-    jsval var267;
-    JSObject *var268;
-    jsval var343;
-    jsuint var269;
-    char **var271;
-    size_t var272;
-    int var298;
-    size_t var273;
-    JSString *var274;
-    size_t var275;
-    JSString **var281;
-    int var299;
-    jsuint var276;
-    jsint var277;
-    JSBool var278;
-    jsval var279;
-    JSString *var280;
-    jsval var344;
-    size_t var284;
-    jsuint var282;
-    jsint var283;
-    JSString *var286;
-    size_t var285;
-    size_t var287;
-    char var296;
-    size_t var297;
-    char *var288;
-    int var300;
-    char *var289;
-    size_t var290;
+    JSObject *var300;
+    char *var305;
+    char **var306;
     int var301;
-    char *var293;
-    jsuint var291;
-    jsint var292;
-    JSString *var295;
-    size_t var294;
-    size_t var302;
-    size_t var303;
-    int var305;
-    jschar *var304;
-    jsval var345;
-    jsval var306;
-    JSBool var251;
-    var252 = NULL;
-    var257 = NULL;
-    var258 = NULL;
-    var253 = 0;
-    var256 = 0;
-    var259 = 0;
-    var260 = JSVAL_NULL;
-    var261 = NULL;
-    var341 = JSVAL_NULL;
-    var262 = 0;
-    var263 = 0;
-    var265 = 0;
-    var264 = NULL;
-    var342 = JSVAL_NULL;
-    var266 = 0;
-    var267 = JSVAL_NULL;
-    var268 = NULL;
-    var343 = JSVAL_NULL;
-    var269 = 0;
-    var271 = NULL;
-    var272 = 0;
-    var298 = 0;
-    var273 = 0;
-    var274 = NULL;
-    var275 = 0;
-    var281 = NULL;
-    var299 = 0;
-    var276 = 0;
-    var277 = 0;
-    var278 = JS_FALSE;
-    var279 = JSVAL_NULL;
-    var280 = NULL;
-    var344 = JSVAL_NULL;
-    var284 = 0;
-    var282 = 0;
-    var283 = 0;
-    var286 = NULL;
-    var285 = 0;
-    var287 = 0;
-    var296 = 0;
-    var297 = 0;
-    var288 = NULL;
-    var300 = 0;
-    var289 = NULL;
-    var290 = 0;
+    int var304;
+    int var307;
+    jsval var308;
+    JSString *var309;
+    jsval var392;
+    size_t var310;
+    size_t var311;
+    int var313;
+    jschar *var312;
+    jsval var393;
+    int var314;
+    jsval var315;
+    JSObject *var316;
+    jsval var394;
+    jsuint var317;
+    char **var319;
+    size_t var320;
+    int var346;
+    size_t var321;
+    JSString *var322;
+    size_t var323;
+    JSString **var329;
+    int var347;
+    jsuint var324;
+    jsint var325;
+    JSBool var326;
+    jsval var327;
+    JSString *var328;
+    jsval var395;
+    size_t var332;
+    jsuint var330;
+    jsint var331;
+    JSString *var334;
+    size_t var333;
+    size_t var335;
+    char var344;
+    size_t var345;
+    char *var336;
+    int var348;
+    char *var337;
+    size_t var338;
+    int var349;
+    char *var341;
+    jsuint var339;
+    jsint var340;
+    JSString *var343;
+    size_t var342;
+    size_t var350;
+    size_t var351;
+    int var353;
+    jschar *var352;
+    jsval var396;
+    jsval var354;
+    JSBool var299;
+    var300 = NULL;
+    var305 = NULL;
+    var306 = NULL;
     var301 = 0;
-    var293 = NULL;
-    var291 = 0;
-    var292 = 0;
-    var295 = NULL;
-    var294 = 0;
-    var302 = 0;
-    var303 = 0;
-    var305 = 0;
-    var304 = NULL;
-    var345 = JSVAL_NULL;
-    var306 = JSVAL_NULL;
-    var251 = JS_FALSE;
-    var252 = obj;
-    var256 = argc;
-    var259 = 0;
-    var259 = var259 < var256;
-    if (var259) {
-    var260 = argv[0];
-    var261 = JS_ValueToString(cx, var260);
-    if (!var261) {
+    var304 = 0;
+    var307 = 0;
+    var308 = JSVAL_NULL;
+    var309 = NULL;
+    var392 = JSVAL_NULL;
+    var310 = 0;
+    var311 = 0;
+    var313 = 0;
+    var312 = NULL;
+    var393 = JSVAL_NULL;
+    var314 = 0;
+    var315 = JSVAL_NULL;
+    var316 = NULL;
+    var394 = JSVAL_NULL;
+    var317 = 0;
+    var319 = NULL;
+    var320 = 0;
+    var346 = 0;
+    var321 = 0;
+    var322 = NULL;
+    var323 = 0;
+    var329 = NULL;
+    var347 = 0;
+    var324 = 0;
+    var325 = 0;
+    var326 = JS_FALSE;
+    var327 = JSVAL_NULL;
+    var328 = NULL;
+    var395 = JSVAL_NULL;
+    var332 = 0;
+    var330 = 0;
+    var331 = 0;
+    var334 = NULL;
+    var333 = 0;
+    var335 = 0;
+    var344 = 0;
+    var345 = 0;
+    var336 = NULL;
+    var348 = 0;
+    var337 = NULL;
+    var338 = 0;
+    var349 = 0;
+    var341 = NULL;
+    var339 = 0;
+    var340 = 0;
+    var343 = NULL;
+    var342 = 0;
+    var350 = 0;
+    var351 = 0;
+    var353 = 0;
+    var352 = NULL;
+    var396 = JSVAL_NULL;
+    var354 = JSVAL_NULL;
+    var299 = JS_FALSE;
+    var300 = obj;
+    var304 = argc;
+    var307 = 0;
+    var307 = var307 < var304;
+    if (var307) {
+    var308 = argv[0];
+    var309 = JS_ValueToString(cx, var308);
+    if (!var309) {
         goto do_return;
     }
-    var341 = STRING_TO_JSVAL(var261);
-    argv[argc+0] = var341;
-    var262 = JS_GetStringLength(var261);
-    var263 = 1;
-    var263 += var262;
-    var257 = JS_malloc(cx, var263);
-    if (!var257) {
+    var392 = STRING_TO_JSVAL(var309);
+    argv[argc+0] = var392;
+    var310 = JS_GetStringLength(var309);
+    var311 = 1;
+    var311 += var310;
+    var305 = JS_malloc(cx, var311);
+    if (!var305) {
         goto do_return;
     }
-    var265 = 1;
-    var264 = JS_GetStringChars(var261);
-    var342 = STRING_TO_JSVAL(var261);
-    argv[argc+1] = var342;
+    var313 = 1;
+    var312 = JS_GetStringChars(var309);
+    var393 = STRING_TO_JSVAL(var309);
+    argv[argc+1] = var393;
     {
         size_t i;
-        for (i = 0; i < var262; ++i) {
-            var257[i] = wctob(var264[i]);
+        for (i = 0; i < var310; ++i) {
+            var305[i] = wctob(var312[i]);
         }
-        var257[var262] = '\0';
+        var305[var310] = '\0';
     }
     }
-    var266 = 1;
-    var266 = var266 < var256;
-    if (var266) {
-    var267 = argv[1];
-    if (JS_ValueToObject(cx, var267, &var268) != JS_TRUE) {
+    var314 = 1;
+    var314 = var314 < var304;
+    if (var314) {
+    var315 = argv[1];
+    if (JS_ValueToObject(cx, var315, &var316) != JS_TRUE) {
         goto do_return;
     }
-    var343 = OBJECT_TO_JSVAL(var268);
-    argv[argc+2] = var343;
-    if (JS_GetArrayLength(cx, var268, &var269) != JS_TRUE) {
+    var394 = OBJECT_TO_JSVAL(var316);
+    argv[argc+2] = var394;
+    if (JS_GetArrayLength(cx, var316, &var317) != JS_TRUE) {
         goto do_return;
     }
-    var272 = sizeof(var271);
-    var272 *= var269;
-    var258 = JS_malloc(cx, var272);
-    if (!var258) {
+    var320 = sizeof(var319);
+    var320 *= var317;
+    var306 = JS_malloc(cx, var320);
+    if (!var306) {
         goto do_return;
     }
-    var298 = 1;
-    var273 = var269;
-    var275 = sizeof(var274);
-    var273 *= var275;
-    var281 = JS_malloc(cx, var273);
-    if (!var281) {
+    var346 = 1;
+    var321 = var317;
+    var323 = sizeof(var322);
+    var321 *= var323;
+    var329 = JS_malloc(cx, var321);
+    if (!var329) {
         goto do_return;
     }
-    var299 = 1;
-    var276 = var269;
-    var277 = -1;
-    while (var276)
+    var347 = 1;
+    var324 = var317;
+    var325 = -1;
+    while (var324)
     {
-    var276 += var277;
-    var278 = JS_GetElement(cx, var268, var276, &var279);
-    var280 = JS_ValueToString(cx, var279);
-    if (!var280) {
+    var324 += var325;
+    var326 = JS_GetElement(cx, var316, var324, &var327);
+    var328 = JS_ValueToString(cx, var327);
+    if (!var328) {
         goto do_return;
     }
-    var344 = STRING_TO_JSVAL(var280);
-    argv[argc+3] = var344;
-    var281[var276] = var280;
+    var395 = STRING_TO_JSVAL(var328);
+    argv[argc+3] = var395;
+    var329[var324] = var328;
     }
-    var284 = 0;
-    var282 = var269;
-    var283 = -1;
-    while (var282)
+    var332 = 0;
+    var330 = var317;
+    var331 = -1;
+    while (var330)
     {
-    var282 += var283;
-    var286 = var281[var282];
-    var285 = JS_GetStringLength(var286);
-    var284 += var285;
-    var287 = 1;
-    var284 += var287;
+    var330 += var331;
+    var334 = var329[var330];
+    var333 = JS_GetStringLength(var334);
+    var332 += var333;
+    var335 = 1;
+    var332 += var335;
     }
-    var297 = sizeof(var296);
-    var297 *= var284;
-    var288 = JS_malloc(cx, var297);
-    if (!var288) {
+    var345 = sizeof(var344);
+    var345 *= var332;
+    var336 = JS_malloc(cx, var345);
+    if (!var336) {
         goto do_return;
     }
-    var300 = 1;
-    var290 = sizeof(var289);
-    var290 *= var269;
-    var258 = JS_malloc(cx, var290);
-    if (!var258) {
+    var348 = 1;
+    var338 = sizeof(var337);
+    var338 *= var317;
+    var306 = JS_malloc(cx, var338);
+    if (!var306) {
         goto do_return;
     }
-    var301 = 1;
-    var293 = var288;
-    var293 += var284;
-    var291 = var269;
-    var292 = -1;
-    while (var291)
+    var349 = 1;
+    var341 = var336;
+    var341 += var332;
+    var339 = var317;
+    var340 = -1;
+    while (var339)
     {
-    var291 += var292;
-    var295 = var281[var291];
-    var294 = JS_GetStringLength(var295);
-    var293 -= var294;
-    var293 += var292;
-    var302 = JS_GetStringLength(var295);
-    var303 = 1;
-    var303 += var302;
-    var293 = JS_malloc(cx, var303);
-    if (!var293) {
+    var339 += var340;
+    var343 = var329[var339];
+    var342 = JS_GetStringLength(var343);
+    var341 -= var342;
+    var341 += var340;
+    var350 = JS_GetStringLength(var343);
+    var351 = 1;
+    var351 += var350;
+    var341 = JS_malloc(cx, var351);
+    if (!var341) {
         goto do_return;
     }
-    var305 = 1;
-    var304 = JS_GetStringChars(var295);
-    var345 = STRING_TO_JSVAL(var295);
-    argv[argc+4] = var345;
+    var353 = 1;
+    var352 = JS_GetStringChars(var343);
+    var396 = STRING_TO_JSVAL(var343);
+    argv[argc+4] = var396;
     {
         size_t i;
-        for (i = 0; i < var302; ++i) {
-            var293[i] = wctob(var304[i]);
+        for (i = 0; i < var350; ++i) {
+            var341[i] = wctob(var352[i]);
         }
-        var293[var302] = '\0';
+        var341[var350] = '\0';
     }
-    var258[var291] = var293;
+    var306[var339] = var341;
     }
     }
-    var253 = jsSetContainer(var257, var258);
-    if (JS_NewNumberValue(cx, var253, &var306) != JS_TRUE) {
+    var301 = jsSetContainer(var305, var306);
+    if (JS_NewNumberValue(cx, var301, &var354) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+5] = var306;
+    argv[argc+5] = var354;
     if (rval) {
-        *rval = var306;
+        *rval = var354;
     }
-    var251 = JS_TRUE;
+    var299 = JS_TRUE;
     do_return:
-    if (var305) {
-        JS_free(cx, var293);
-        var293 = NULL;
-        var305 = 0;
+    if (var353) {
+        JS_free(cx, var341);
+        var341 = NULL;
+        var353 = 0;
     }
-    if (var301) {
-        JS_free(cx, var258);
-        var258 = NULL;
-        var301 = 0;
+    if (var349) {
+        JS_free(cx, var306);
+        var306 = NULL;
+        var349 = 0;
     }
-    if (var300) {
-        JS_free(cx, var288);
-        var288 = NULL;
-        var300 = 0;
+    if (var348) {
+        JS_free(cx, var336);
+        var336 = NULL;
+        var348 = 0;
     }
-    if (var299) {
-        JS_free(cx, var281);
-        var281 = NULL;
-        var299 = 0;
+    if (var347) {
+        JS_free(cx, var329);
+        var329 = NULL;
+        var347 = 0;
     }
-    if (var298) {
-        JS_free(cx, var258);
-        var258 = NULL;
-        var298 = 0;
+    if (var346) {
+        JS_free(cx, var306);
+        var306 = NULL;
+        var346 = 0;
     }
-    if (var265) {
-        JS_free(cx, var257);
-        var257 = NULL;
-        var265 = 0;
+    if (var313) {
+        JS_free(cx, var305);
+        var305 = NULL;
+        var313 = 0;
     }
-    return var251;
+    return var299;
 }
 static JSBool
 jjadm__construct__(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var308;
-    int var312;
-    JSBool var307;
-    var308 = NULL;
-    var312 = 0;
-    var307 = JS_FALSE;
-    var308 = obj;
-    var312 = argc;
+    JSObject *var356;
+    int var360;
+    JSBool var355;
+    var356 = NULL;
+    var360 = 0;
+    var355 = JS_FALSE;
+    var356 = obj;
+    var360 = argc;
     jsAvidemux();
-    var307 = JS_TRUE;
-    return var307;
+    var355 = JS_TRUE;
+    return var355;
 }
 static JSPropertySpec jjadm_static_ps[] = {
+    {"markerA", 0, 0|JSPROP_ENUMERATE, jjadmmarkerA_get, jjadmmarkerA_set},
+    {"markerB", 0, 0|JSPROP_ENUMERATE, jjadmmarkerB_get, jjadmmarkerB_set},
+    {"audioResample", 0, 0|JSPROP_ENUMERATE, jjadmaudioResample_get, jjadmaudioResample_set},
     {NULL, 0, 0, NULL, NULL}
 };
 static JSPropertySpec jjadm_ps[] = {
@@ -1614,6 +1845,7 @@
     JS_FS("addSegment", jjadmaddSegment, 3, 0, 1),
     JS_FS("setPostProc", jjadmsetPostProc, 3, 0, 1),
     JS_FS("audioReset", jjadmaudioReset, 0, 0, 1),
+    JS_FS("audioMixer", jjadmaudioMixer, 1, 0, 3),
     JS_FS("videoCodec", jsAdmvideoCodec,  2, 0, 6),
     JS_FS("addVideoFilter", jsAdmaddVideoFilter,  2, 0, 6),
     JS_FS("audioCodec", jsAdmaudioCodec,  2, 0, 6),

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 15:24:38 UTC (rev 5649)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 15:24:41 UTC (rev 5650)
@@ -15,11 +15,18 @@
         function int addSegment     : jsAddSegment (int ,double , double ) <static>;
         function int setPostProc    : jsSetPostProc (int ,int , int ) <static>;
         function int audioReset     : jsAudioReset () <static>;
+        function int audioMixer     : jsAudioMixer (cstring ) <static>;
+        /*            JSFUNC                 C FUNC           PARAM     */
+/* Override as jsapigen cannot handle multiple args the way we need it to */
         function int videoCodec_ignore     : jsVideoCodec(cstring,cstring[])   <static>;
         function int addVideoFilter_ignore : jsVideoFilter(cstring,cstring[])   <static>;
         function int audioCodec_ignore     : jsAudioCodec(cstring,cstring[])   <static>;
         function int setContainer_ignore   : jsSetContainer(cstring,cstring[])   <static>;
-        construct                   : jsAvidemux  ( ) <static>     ; 
+/* Properties */
+        property double markerA            : jsGetMarkerA,jsSetMarkerA <static>;
+        property double markerB            : jsGetMarkerB,jsSetMarkerB <static>;
+        property int    audioResample      : jsGetResample,jsSetResample <static>;
+        construct                          : jsAvidemux  ( ) <static>     ; 
 };
 
 %<

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-11 15:24:38 UTC (rev 5649)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-11 15:24:41 UTC (rev 5650)
@@ -286,10 +286,10 @@
 /**
     \fn JS_setSuccess
 */
-void JS_setSuccess(bool bSuccess)
+extern "C" void jsSetSuccess(int bSuccess)
 {// begin JS_setSuccess
 	g_bJSSuccess = bSuccess;
-	printf("[ECMA] success : %d\n", g_bJSSuccess);
+	jsLog(JS_LOG_NORMAL,"[ECMA] success : %d\n", g_bJSSuccess);
 }// end JS_setSuccess
 /**
     \fn SpidermonkeyExit

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c	2009-12-11 15:24:38 UTC (rev 5649)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.c	2009-12-11 15:24:41 UTC (rev 5650)
@@ -39,12 +39,12 @@
     int var8;
     jsval var9;
     JSString *var10;
-    jsval var71;
+    jsval var81;
     size_t var11;
     size_t var12;
     int var14;
     jschar *var13;
-    jsval var72;
+    jsval var82;
     JSBool var1;
     var2 = NULL;
     var7 = NULL;
@@ -52,12 +52,12 @@
     var8 = 0;
     var9 = JSVAL_NULL;
     var10 = NULL;
-    var71 = JSVAL_NULL;
+    var81 = JSVAL_NULL;
     var11 = 0;
     var12 = 0;
     var14 = 0;
     var13 = NULL;
-    var72 = JSVAL_NULL;
+    var82 = JSVAL_NULL;
     var1 = JS_FALSE;
     var2 = obj;
     var6 = argc;
@@ -69,8 +69,8 @@
     if (!var10) {
         goto do_return;
     }
-    var71 = STRING_TO_JSVAL(var10);
-    argv[argc+0] = var71;
+    var81 = STRING_TO_JSVAL(var10);
+    argv[argc+0] = var81;
     var11 = JS_GetStringLength(var10);
     var12 = 1;
     var12 += var11;
@@ -80,8 +80,8 @@
     }
     var14 = 1;
     var13 = JS_GetStringChars(var10);
-    var72 = STRING_TO_JSVAL(var10);
-    argv[argc+1] = var72;
+    var82 = STRING_TO_JSVAL(var10);
+    argv[argc+1] = var82;
     {
         size_t i;
         for (i = 0; i < var11; ++i) {
@@ -109,12 +109,12 @@
     int var22;
     jsval var23;
     JSString *var24;
-    jsval var73;
+    jsval var83;
     size_t var25;
     size_t var26;
     int var28;
     jschar *var27;
-    jsval var74;
+    jsval var84;
     JSBool var15;
     var16 = NULL;
     var21 = NULL;
@@ -122,12 +122,12 @@
     var22 = 0;
     var23 = JSVAL_NULL;
     var24 = NULL;
-    var73 = JSVAL_NULL;
+    var83 = JSVAL_NULL;
     var25 = 0;
     var26 = 0;
     var28 = 0;
     var27 = NULL;
-    var74 = JSVAL_NULL;
+    var84 = JSVAL_NULL;
     var15 = JS_FALSE;
     var16 = obj;
     var20 = argc;
@@ -139,8 +139,8 @@
     if (!var24) {
         goto do_return;
     }
-    var73 = STRING_TO_JSVAL(var24);
-    argv[argc+0] = var73;
+    var83 = STRING_TO_JSVAL(var24);
+    argv[argc+0] = var83;
     var25 = JS_GetStringLength(var24);
     var26 = 1;
     var26 += var25;
@@ -150,8 +150,8 @@
     }
     var28 = 1;
     var27 = JS_GetStringChars(var24);
-    var74 = STRING_TO_JSVAL(var24);
-    argv[argc+1] = var74;
+    var84 = STRING_TO_JSVAL(var24);
+    argv[argc+1] = var84;
     {
         size_t i;
         for (i = 0; i < var25; ++i) {
@@ -179,12 +179,12 @@
     int var36;
     jsval var37;
     JSString *var38;
-    jsval var75;
+    jsval var85;
     size_t var39;
     size_t var40;
     int var42;
     jschar *var41;
-    jsval var76;
+    jsval var86;
     JSBool var29;
     var30 = NULL;
     var35 = NULL;
@@ -192,12 +192,12 @@
     var36 = 0;
     var37 = JSVAL_NULL;
     var38 = NULL;
-    var75 = JSVAL_NULL;
+    var85 = JSVAL_NULL;
     var39 = 0;
     var40 = 0;
     var42 = 0;
     var41 = NULL;
-    var76 = JSVAL_NULL;
+    var86 = JSVAL_NULL;
     var29 = JS_FALSE;
     var30 = obj;
     var34 = argc;
@@ -209,8 +209,8 @@
     if (!var38) {
         goto do_return;
     }
-    var75 = STRING_TO_JSVAL(var38);
-    argv[argc+0] = var75;
+    var85 = STRING_TO_JSVAL(var38);
+    argv[argc+0] = var85;
     var39 = JS_GetStringLength(var38);
     var40 = 1;
     var40 += var39;
@@ -220,8 +220,8 @@
     }
     var42 = 1;
     var41 = JS_GetStringChars(var38);
-    var76 = STRING_TO_JSVAL(var38);
-    argv[argc+1] = var76;
+    var86 = STRING_TO_JSVAL(var38);
+    argv[argc+1] = var86;
     {
         size_t i;
         for (i = 0; i < var39; ++i) {
@@ -249,12 +249,12 @@
     int var50;
     jsval var51;
     JSString *var52;
-    jsval var77;
+    jsval var87;
     size_t var53;
     size_t var54;
     int var56;
     jschar *var55;
-    jsval var78;
+    jsval var88;
     JSBool var43;
     var44 = NULL;
     var49 = NULL;
@@ -262,12 +262,12 @@
     var50 = 0;
     var51 = JSVAL_NULL;
     var52 = NULL;
-    var77 = JSVAL_NULL;
+    var87 = JSVAL_NULL;
     var53 = 0;
     var54 = 0;
     var56 = 0;
     var55 = NULL;
-    var78 = JSVAL_NULL;
+    var88 = JSVAL_NULL;
     var43 = JS_FALSE;
     var44 = obj;
     var48 = argc;
@@ -279,8 +279,8 @@
     if (!var52) {
         goto do_return;
     }
-    var77 = STRING_TO_JSVAL(var52);
-    argv[argc+0] = var77;
+    var87 = STRING_TO_JSVAL(var52);
+    argv[argc+0] = var87;
     var53 = JS_GetStringLength(var52);
     var54 = 1;
     var54 += var53;
@@ -290,8 +290,8 @@
     }
     var56 = 1;
     var55 = JS_GetStringChars(var52);
-    var78 = STRING_TO_JSVAL(var52);
-    argv[argc+1] = var78;
+    var88 = STRING_TO_JSVAL(var52);
+    argv[argc+1] = var88;
     {
         size_t i;
         for (i = 0; i < var53; ++i) {
@@ -319,12 +319,12 @@
     int var64;
     jsval var65;
     JSString *var66;
-    jsval var79;
+    jsval var89;
     size_t var67;
     size_t var68;
     int var70;
     jschar *var69;
-    jsval var80;
+    jsval var90;
     JSBool var57;
     var58 = NULL;
     var63 = NULL;
@@ -332,12 +332,12 @@
     var64 = 0;
     var65 = JSVAL_NULL;
     var66 = NULL;
-    var79 = JSVAL_NULL;
+    var89 = JSVAL_NULL;
     var67 = 0;
     var68 = 0;
     var70 = 0;
     var69 = NULL;
-    var80 = JSVAL_NULL;
+    var90 = JSVAL_NULL;
     var57 = JS_FALSE;
     var58 = obj;
     var62 = argc;
@@ -349,8 +349,8 @@
     if (!var66) {
         goto do_return;
     }
-    var79 = STRING_TO_JSVAL(var66);
-    argv[argc+0] = var79;
+    var89 = STRING_TO_JSVAL(var66);
+    argv[argc+0] = var89;
     var67 = JS_GetStringLength(var66);
     var68 = 1;
     var68 += var67;
@@ -360,8 +360,8 @@
     }
     var70 = 1;
     var69 = JS_GetStringChars(var66);
-    var80 = STRING_TO_JSVAL(var66);
-    argv[argc+1] = var80;
+    var90 = STRING_TO_JSVAL(var66);
+    argv[argc+1] = var90;
     {
         size_t i;
         for (i = 0; i < var67; ++i) {
@@ -380,6 +380,39 @@
     }
     return var57;
 }
+static JSBool
+jjsetSuccess(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var72;
+    int var77;
+    int var76;
+    int var78;
+    jsval var79;
+    int32 var80;
+    JSBool var71;
+    var72 = NULL;
+    var77 = 0;
+    var76 = 0;
+    var78 = 0;
+    var79 = JSVAL_NULL;
+    var80 = 0;
+    var71 = JS_FALSE;
+    var72 = obj;
+    var76 = argc;
+    var78 = 0;
+    var78 = var78 < var76;
+    if (var78) {
+    var79 = argv[0];
+    if (JS_ValueToInt32(cx, var79, &var80) != JS_TRUE) {
+        goto do_return;
+    }
+    var77 = (int)var80;
+    }
+    jsSetSuccess(var77);
+    var71 = JS_TRUE;
+    do_return:
+    return var71;
+}
 static JSPropertySpec jj_static_ps[] = {
     {NULL, 0, 0, NULL, NULL}
 };
@@ -392,6 +425,7 @@
     JS_FS("admPrint", jjadmPrint, 1, 0, 2),
     JS_FS("print", jjprint, 1, 0, 2),
     JS_FS("help", jjhelp, 1, 0, 2),
+    JS_FS("setSuccess", jjsetSuccess, 1, 0, 0),
     JS_FS_END
 };
 static JSFunctionSpec jj_fs[] = {
@@ -400,6 +434,7 @@
     JS_FS("admPrint", jjadmPrint, 1, 0, 2),
     JS_FS("print", jjprint, 1, 0, 2),
     JS_FS("help", jjhelp, 1, 0, 2),
+    JS_FS("setSuccess", jjsetSuccess, 1, 0, 0),
     JS_FS_END
 };
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl	2009-12-11 15:24:38 UTC (rev 5649)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf_js.idl	2009-12-11 15:24:41 UTC (rev 5650)
@@ -8,6 +8,7 @@
 function void admPrint      : jsPrint        (cstring  ) <static>;
 function void print         : jsPrint2       (cstring  ) <static>;
 function void help          : jsHelp         (cstring  ) <static>;
+function void setSuccess    : jsSetSuccess   (int  )   <static>;
 
 %<
 JSFunctionSpec  *jsGetIfFunctions(void)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp	2009-12-11 15:24:38 UTC (rev 5649)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp	2009-12-11 15:24:41 UTC (rev 5650)
@@ -109,4 +109,33 @@
     UI_setVideoCodec(idx);
     return true;
 }
+/**
+    \fn jsGetMarkerA
+*/
+double jsGetMarkerA(void)
+{
+
+}
+/**
+    \fn jsGetMarkerB
+*/
+double jsGetMarkerB(void)
+{
+
+}
+/**
+    \fn jsSetMarkerA
+*/
+void   jsSetMarkerA(double a)
+{
+
+}
+/**
+    \fn jsGetMarkerB
+*/
+void   jsSetMarkerB(double b)
+{
+
+}
+
 //EOF
\ No newline at end of file



From mean at mail.berlios.de  Fri Dec 11 20:06:38 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 11 Dec 2009 20:06:38 +0100
Subject: [Avidemux-svn-commit] r5651 - in
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2:
	include src
Message-ID: <200912111906.nBBJ6c61030348@sheep.berlios.de>

Author: mean
Date: 2009-12-11 20:06:36 +0100 (Fri, 11 Dec 2009)
New Revision: 5651

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_js.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
Log:
[js] Improve registering + help combined

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_js.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_js.h	2009-12-11 15:24:41 UTC (rev 5650)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_js.h	2009-12-11 19:06:36 UTC (rev 5651)
@@ -18,22 +18,31 @@
 #include "ADM_default.h"
 #include <string.h>
 #include <pthread.h>
+#include <vector>
+using std::vector;
 #include "DIA_coreToolkit.h"
 #include "jsapi.h"
-
 #include "ADM_jsUtils.h"
 #include "ADM_jsShell.h"
 #include "ADM_jsDebug.h"
 
 typedef JSBool JS_PROTOTYPE(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
+/**
+    \struct ADM_JS_HOOK
+*/
+typedef struct
+{
+    const char      *name;
+    const char      *text;
+    JSFunctionSpec  *jsFunctions;
+}ADM_JS_HOOK;
+extern vector <ADM_JS_HOOK >jsHooks;
 #if !defined(ADM_JS_THREADSAFE)
-#define enterLock() {}
-#define leaveLock() {}
+    #define enterLock() {}
+    #define leaveLock() {}
 #else
-#define enterLock() jsrefcount nRefCount = JS_SuspendRequest(cx)
-#define leaveLock() {JS_ResumeRequest(cx,nRefCount); }
-
+    #define enterLock() jsrefcount nRefCount = JS_SuspendRequest(cx)
+    #define leaveLock() {JS_ResumeRequest(cx,nRefCount); }
 #endif
 
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 15:24:41 UTC (rev 5650)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 19:06:36 UTC (rev 5651)
@@ -1917,3 +1917,9 @@
           return jjadm_init(cx,obj);
 }
 
+JSFunctionSpec  *jsGetAdmFunctions(void)
+{
+        return jjadm_static_fs;
+}
+
+

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 15:24:41 UTC (rev 5650)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 19:06:36 UTC (rev 5651)
@@ -39,4 +39,10 @@
           }
           return jjadm_init(cx,obj);
 }
+
+JSFunctionSpec  *jsGetAdmFunctions(void)
+{
+        return jjadm_static_fs;
+}
+
 %>

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2009-12-11 15:24:41 UTC (rev 5650)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2009-12-11 19:06:36 UTC (rev 5651)
@@ -16,35 +16,13 @@
 #include "ADM_js.h"
 #include "ADM_editor/ADM_edit.hxx"
 #include "ADM_jsDebug.h"
+#include <vector>
 /**/
 /**/
-
-
 extern ADM_Composer *video_body;
 void ADM_dumpJSHooks(void);
-#if 0
+extern vector <JSFunctionSpec *>listOfHooks;
 /**
-    \fn JS_AvidemuxRegisterDebugFunction
-*/
-bool JS_AvidemuxRegisterDebugFunction(JSContext *cx,JSObject *global)
-{
-	if(JS_DefineFunctions(cx, global, adm_debug_functions) == true)
-		return true;
-
-	ADM_warning("Unable to define functions\n");
-	return false;
-}
-
-/**
-    \fn ADM_JsDebugGetFunctions
-
-*/
-JSFunctionSpec *ADM_JsDebugGetFunctions(void)
-{
-    return adm_debug_functions;
-}
-#endif
-/**
     \fn displayError
     \brief error popup
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-11 15:24:41 UTC (rev 5650)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-11 19:06:36 UTC (rev 5651)
@@ -14,11 +14,17 @@
 
 #include "ADM_js.h"
 #include <stdarg.h>
+#include <vector>
+
 void    A_Resync(void);
+
+/* our variables */
 static jsLoggerFunc *jsLogger=NULL;
 static void *jsLoggerCookie=NULL;
 extern char * actual_workbench_file;
+vector <ADM_JS_HOOK >jsHooks;
 
+
 #define JSVAR(a,b,c) a b=c
 
 #if defined( __MINGW32__) 
@@ -32,17 +38,8 @@
 static JSObject   *g_pObject=NULL;
 static JSContext  *g_pCx=NULL;
 static JSRuntime  *g_pRt=NULL;
-/*
+
 static JSClass global_class = {
-   
-"Avidemux", JSCLASS_HAS_PRIVATE,
-        JS_PropertyStub, JS_PropertyStub,
-        JS_PropertyStub, JS_PropertyStub,
-        JS_EnumerateStub, JS_ResolveStub,
-        JS_ConvertStub, JS_FinalizeStub
-};
-*/
-   static JSClass global_class = {
             "global", JSCLASS_GLOBAL_FLAGS,
             JS_PropertyStub, JS_PropertyStub, JS_PropertyStub, JS_PropertyStub,
             JS_EnumerateStub, JS_ResolveStub, JS_ConvertStub, JS_FinalizeStub,
@@ -149,9 +146,9 @@
 */
 extern "C" JSFunctionSpec  *jsGetIfFunctions(void);
 extern "C" JSFunctionSpec  *jsGetTestFunctions(void);
-extern "C" JSFunctionSpec  *jsGetAvidemuxFunctions(void);
+extern "C" JSFunctionSpec  *jsGetAdmFunctions(void);
 extern "C" JSObject *jsAvidemuxInit(JSContext *cx,JSObject *obj);
-static bool registerOne(const char *name,JSFunctionSpec *s,JSContext *cx,JSObject *obj)
+static bool registerOne(const char *name,const char *text,JSFunctionSpec *s,JSContext *cx,JSObject *obj)
 {
     if (JS_DefineFunctions(cx, obj, s) != JS_TRUE) 
     {
@@ -159,6 +156,11 @@
             return false;
     }
     ADM_info("Registered %s functions\n",name);
+    ADM_JS_HOOK h;
+    h.name=name;    
+    h.text=text;
+    h.jsFunctions=s;
+    jsHooks.push_back(h);
     return true;
 }
 static void  dump(JSFunctionSpec *f)
@@ -169,25 +171,52 @@
         f++;
     }
 }
+/**
+    \fn jsHelp
+    \brief help command
+
+*/
 extern "C" 
 {
 void jsHelp(const char *s)
 {
+int n=jsHooks.size();
     if(!s) goto none;
-    if(!strcasecmp(s,"debug")) return dump(jsGetIfFunctions());
-    if(!strcasecmp(s,"test")) return dump(jsGetTestFunctions());
+    {
+    for(int i=0;i<n;i++)
+        if(!strcasecmp(s,jsHooks[i].name))
+        {
+            const char *t=jsHooks[i].text;
+            if(t)
+                jsLog(JS_LOG_NORMAL,"%s",t);
+            return dump(jsHooks[i].jsFunctions);
+        }
+    }
 //    if(!strcasecmp(s,"load")) return dump(jsGetAvidemuxFunctions());
 none:
-        jsLog(JS_LOG_NORMAL,"please use help(\"debug\") or help(\"test\"");
+        jsLog(JS_LOG_NORMAL,"please use help(\"xxx\") with xx among");
+
+        for(int i=0;i<n;i++)
+            jsLog(JS_LOG_NORMAL,"    %s",jsHooks[i].name);
+
 }
-}
+} // extern "C"
+/**
+    \fn jsRegisterAvidemux
+    \brief Register avidemux hookd
+*/
 static bool jsRegisterAvidemux(JSContext *cx,JSObject *obj)
 {
-        registerOne("If",   jsGetIfFunctions(),    cx,obj);
-        registerOne("Test", jsGetTestFunctions(),  cx,obj);
-      //  registerOne("Load", jsGetAvidemuxFunctions(),  cx,obj);
-        jsAvidemuxInit(cx,obj);
-        return true;
+ADM_JS_HOOK h;
+        registerOne("Debug","",   jsGetIfFunctions(),    cx,obj);
+        registerOne("Test","", jsGetTestFunctions(),  cx,obj);
+        // Register also our class (for  help() )
+            h.name="adm";
+            h.text="Please prefix this with adm.";
+            h.jsFunctions=jsGetAdmFunctions();
+            jsHooks.push_back(h);
+            jsAvidemuxInit(cx,obj);
+            return true;
 }
 /**
     \fn SpidermonkeyInit



From mean at mail.berlios.de  Sat Dec 12 08:51:49 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 12 Dec 2009 08:51:49 +0100
Subject: [Avidemux-svn-commit] r5652 - in
	branches/avidemux_2.6_branch_mean/avidemux/common:
	ADM_script2/include ADM_script2/src ADM_videoFilter2/include
	ADM_videoFilter2/src
Message-ID: <200912120751.nBC7pnqV023361@sheep.berlios.de>

Author: mean
Date: 2009-12-12 08:51:48 +0100 (Sat, 12 Dec 2009)
New Revision: 5652

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/include/ADM_videoFilters.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilters.cpp
Log:
[js] Add clearVideoFilters

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h	2009-12-11 19:06:36 UTC (rev 5651)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h	2009-12-12 07:51:48 UTC (rev 5652)
@@ -32,7 +32,8 @@
 double jsGetMarkerB(void);
 void   jsSetMarkerA(double a);
 void   jsSetMarkerB(double b);
-
+//
+int    jsClearVideoFilters();
 // non jsapigen function, variables number of args
 JSBool jsAdmaddVideoFilter(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool jsAdmaudioCodec(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-11 19:06:36 UTC (rev 5651)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.c	2009-12-12 07:51:48 UTC (rev 5652)
@@ -207,12 +207,12 @@
     int var41;
     jsval var42;
     JSString *var43;
-    jsval var361;
+    jsval var368;
     size_t var44;
     size_t var45;
     int var47;
     jschar *var46;
-    jsval var362;
+    jsval var369;
     jsval var48;
     JSBool var34;
     var35 = NULL;
@@ -222,12 +222,12 @@
     var41 = 0;
     var42 = JSVAL_NULL;
     var43 = NULL;
-    var361 = JSVAL_NULL;
+    var368 = JSVAL_NULL;
     var44 = 0;
     var45 = 0;
     var47 = 0;
     var46 = NULL;
-    var362 = JSVAL_NULL;
+    var369 = JSVAL_NULL;
     var48 = JSVAL_NULL;
     var34 = JS_FALSE;
     var35 = obj;
@@ -240,8 +240,8 @@
     if (!var43) {
         goto do_return;
     }
-    var361 = STRING_TO_JSVAL(var43);
-    argv[argc+0] = var361;
+    var368 = STRING_TO_JSVAL(var43);
+    argv[argc+0] = var368;
     var44 = JS_GetStringLength(var43);
     var45 = 1;
     var45 += var44;
@@ -251,8 +251,8 @@
     }
     var47 = 1;
     var46 = JS_GetStringChars(var43);
-    var362 = STRING_TO_JSVAL(var43);
-    argv[argc+1] = var362;
+    var369 = STRING_TO_JSVAL(var43);
+    argv[argc+1] = var369;
     {
         size_t i;
         for (i = 0; i < var44; ++i) {
@@ -315,12 +315,12 @@
     int var63;
     jsval var64;
     JSString *var65;
-    jsval var365;
+    jsval var372;
     size_t var66;
     size_t var67;
     int var69;
     jschar *var68;
-    jsval var366;
+    jsval var373;
     jsval var70;
     JSBool var56;
     var57 = NULL;
@@ -330,12 +330,12 @@
     var63 = 0;
     var64 = JSVAL_NULL;
     var65 = NULL;
-    var365 = JSVAL_NULL;
+    var372 = JSVAL_NULL;
     var66 = 0;
     var67 = 0;
     var69 = 0;
     var68 = NULL;
-    var366 = JSVAL_NULL;
+    var373 = JSVAL_NULL;
     var70 = JSVAL_NULL;
     var56 = JS_FALSE;
     var57 = obj;
@@ -348,8 +348,8 @@
     if (!var65) {
         goto do_return;
     }
-    var365 = STRING_TO_JSVAL(var65);
-    argv[argc+0] = var365;
+    var372 = STRING_TO_JSVAL(var65);
+    argv[argc+0] = var372;
     var66 = JS_GetStringLength(var65);
     var67 = 1;
     var67 += var66;
@@ -359,8 +359,8 @@
     }
     var69 = 1;
     var68 = JS_GetStringChars(var65);
-    var366 = STRING_TO_JSVAL(var65);
-    argv[argc+1] = var366;
+    var373 = STRING_TO_JSVAL(var65);
+    argv[argc+1] = var373;
     {
         size_t i;
         for (i = 0; i < var66; ++i) {
@@ -579,12 +579,12 @@
     int var123;
     jsval var124;
     JSString *var125;
-    jsval var371;
+    jsval var378;
     size_t var126;
     size_t var127;
     int var129;
     jschar *var128;
-    jsval var372;
+    jsval var379;
     jsval var130;
     JSBool var116;
     var117 = NULL;
@@ -594,12 +594,12 @@
     var123 = 0;
     var124 = JSVAL_NULL;
     var125 = NULL;
-    var371 = JSVAL_NULL;
+    var378 = JSVAL_NULL;
     var126 = 0;
     var127 = 0;
     var129 = 0;
     var128 = NULL;
-    var372 = JSVAL_NULL;
+    var379 = JSVAL_NULL;
     var130 = JSVAL_NULL;
     var116 = JS_FALSE;
     var117 = obj;
@@ -612,8 +612,8 @@
     if (!var125) {
         goto do_return;
     }
-    var371 = STRING_TO_JSVAL(var125);
-    argv[argc+0] = var371;
+    var378 = STRING_TO_JSVAL(var125);
+    argv[argc+0] = var378;
     var126 = JS_GetStringLength(var125);
     var127 = 1;
     var127 += var126;
@@ -623,8 +623,8 @@
     }
     var129 = 1;
     var128 = JS_GetStringChars(var125);
-    var372 = STRING_TO_JSVAL(var125);
-    argv[argc+1] = var372;
+    var379 = STRING_TO_JSVAL(var125);
+    argv[argc+1] = var379;
     {
         size_t i;
         for (i = 0; i < var126; ++i) {
@@ -651,1183 +651,1210 @@
     return var116;
 }
 static JSBool
-jjadmvideoCodec_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjadmclearVideoFilters(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var132;
-    char *var137;
-    char **var138;
     int var133;
     int var136;
-    int var139;
-    jsval var140;
-    JSString *var141;
-    jsval var374;
-    size_t var142;
-    size_t var143;
-    int var145;
-    jschar *var144;
-    jsval var375;
+    jsval var137;
+    JSBool var131;
+    var132 = NULL;
+    var133 = 0;
+    var136 = 0;
+    var137 = JSVAL_NULL;
+    var131 = JS_FALSE;
+    var132 = obj;
+    var136 = argc;
+    var133 = jsClearVideoFilters();
+    if (JS_NewNumberValue(cx, var133, &var137) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+0] = var137;
+    if (rval) {
+        *rval = var137;
+    }
+    var131 = JS_TRUE;
+    do_return:
+    return var131;
+}
+static JSBool
+jjadmvideoCodec_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var139;
+    char *var144;
+    char **var145;
+    int var140;
+    int var143;
     int var146;
     jsval var147;
-    JSObject *var148;
-    jsval var376;
-    jsuint var149;
-    char **var151;
-    size_t var152;
-    int var178;
-    size_t var153;
-    JSString *var154;
-    size_t var155;
-    JSString **var161;
-    int var179;
+    JSString *var148;
+    jsval var382;
+    size_t var149;
+    size_t var150;
+    int var152;
+    jschar *var151;
+    jsval var383;
+    int var153;
+    jsval var154;
+    JSObject *var155;
+    jsval var384;
     jsuint var156;
-    jsint var157;
-    JSBool var158;
-    jsval var159;
-    JSString *var160;
-    jsval var377;
-    size_t var164;
-    jsuint var162;
-    jsint var163;
-    JSString *var166;
-    size_t var165;
-    size_t var167;
-    char var176;
+    char **var158;
+    size_t var159;
+    int var185;
+    size_t var160;
+    JSString *var161;
+    size_t var162;
+    JSString **var168;
+    int var186;
+    jsuint var163;
+    jsint var164;
+    JSBool var165;
+    jsval var166;
+    JSString *var167;
+    jsval var385;
+    size_t var171;
+    jsuint var169;
+    jsint var170;
+    JSString *var173;
+    size_t var172;
+    size_t var174;
+    char var183;
+    size_t var184;
+    char *var175;
+    int var187;
+    char *var176;
     size_t var177;
-    char *var168;
-    int var180;
-    char *var169;
-    size_t var170;
-    int var181;
-    char *var173;
-    jsuint var171;
-    jsint var172;
-    JSString *var175;
-    size_t var174;
-    size_t var182;
-    size_t var183;
-    int var185;
-    jschar *var184;
-    jsval var378;
-    jsval var186;
-    JSBool var131;
-    var132 = NULL;
-    var137 = NULL;
-    var138 = NULL;
-    var133 = 0;
-    var136 = 0;
-    var139 = 0;
-    var140 = JSVAL_NULL;
-    var141 = NULL;
-    var374 = JSVAL_NULL;
-    var142 = 0;
+    int var188;
+    char *var180;
+    jsuint var178;
+    jsint var179;
+    JSString *var182;
+    size_t var181;
+    size_t var189;
+    size_t var190;
+    int var192;
+    jschar *var191;
+    jsval var386;
+    jsval var193;
+    JSBool var138;
+    var139 = NULL;
+    var144 = NULL;
+    var145 = NULL;
+    var140 = 0;
     var143 = 0;
-    var145 = 0;
-    var144 = NULL;
-    var375 = JSVAL_NULL;
     var146 = 0;
     var147 = JSVAL_NULL;
     var148 = NULL;
-    var376 = JSVAL_NULL;
+    var382 = JSVAL_NULL;
     var149 = 0;
+    var150 = 0;
+    var152 = 0;
     var151 = NULL;
-    var152 = 0;
-    var178 = 0;
+    var383 = JSVAL_NULL;
     var153 = 0;
-    var154 = NULL;
-    var155 = 0;
+    var154 = JSVAL_NULL;
+    var155 = NULL;
+    var384 = JSVAL_NULL;
+    var156 = 0;
+    var158 = NULL;
+    var159 = 0;
+    var185 = 0;
+    var160 = 0;
     var161 = NULL;
-    var179 = 0;
-    var156 = 0;
-    var157 = 0;
-    var158 = JS_FALSE;
-    var159 = JSVAL_NULL;
-    var160 = NULL;
-    var377 = JSVAL_NULL;
-    var164 = 0;
     var162 = 0;
+    var168 = NULL;
+    var186 = 0;
     var163 = 0;
-    var166 = NULL;
-    var165 = 0;
-    var167 = 0;
-    var176 = 0;
-    var177 = 0;
-    var168 = NULL;
-    var180 = 0;
-    var169 = NULL;
+    var164 = 0;
+    var165 = JS_FALSE;
+    var166 = JSVAL_NULL;
+    var167 = NULL;
+    var385 = JSVAL_NULL;
+    var171 = 0;
+    var169 = 0;
     var170 = 0;
-    var181 = 0;
     var173 = NULL;
-    var171 = 0;
     var172 = 0;
-    var175 = NULL;
     var174 = 0;
-    var182 = 0;
     var183 = 0;
-    var185 = 0;
-    var184 = NULL;
-    var378 = JSVAL_NULL;
-    var186 = JSVAL_NULL;
-    var131 = JS_FALSE;
-    var132 = obj;
-    var136 = argc;
-    var139 = 0;
-    var139 = var139 < var136;
-    if (var139) {
-    var140 = argv[0];
-    var141 = JS_ValueToString(cx, var140);
-    if (!var141) {
+    var184 = 0;
+    var175 = NULL;
+    var187 = 0;
+    var176 = NULL;
+    var177 = 0;
+    var188 = 0;
+    var180 = NULL;
+    var178 = 0;
+    var179 = 0;
+    var182 = NULL;
+    var181 = 0;
+    var189 = 0;
+    var190 = 0;
+    var192 = 0;
+    var191 = NULL;
+    var386 = JSVAL_NULL;
+    var193 = JSVAL_NULL;
+    var138 = JS_FALSE;
+    var139 = obj;
+    var143 = argc;
+    var146 = 0;
+    var146 = var146 < var143;
+    if (var146) {
+    var147 = argv[0];
+    var148 = JS_ValueToString(cx, var147);
+    if (!var148) {
         goto do_return;
     }
-    var374 = STRING_TO_JSVAL(var141);
-    argv[argc+0] = var374;
-    var142 = JS_GetStringLength(var141);
-    var143 = 1;
-    var143 += var142;
-    var137 = JS_malloc(cx, var143);
-    if (!var137) {
+    var382 = STRING_TO_JSVAL(var148);
+    argv[argc+0] = var382;
+    var149 = JS_GetStringLength(var148);
+    var150 = 1;
+    var150 += var149;
+    var144 = JS_malloc(cx, var150);
+    if (!var144) {
         goto do_return;
     }
-    var145 = 1;
-    var144 = JS_GetStringChars(var141);
-    var375 = STRING_TO_JSVAL(var141);
-    argv[argc+1] = var375;
+    var152 = 1;
+    var151 = JS_GetStringChars(var148);
+    var383 = STRING_TO_JSVAL(var148);
+    argv[argc+1] = var383;
     {
         size_t i;
-        for (i = 0; i < var142; ++i) {
-            var137[i] = wctob(var144[i]);
+        for (i = 0; i < var149; ++i) {
+            var144[i] = wctob(var151[i]);
         }
-        var137[var142] = '\0';
+        var144[var149] = '\0';
     }
     }
-    var146 = 1;
-    var146 = var146 < var136;
-    if (var146) {
-    var147 = argv[1];
-    if (JS_ValueToObject(cx, var147, &var148) != JS_TRUE) {
+    var153 = 1;
+    var153 = var153 < var143;
+    if (var153) {
+    var154 = argv[1];
+    if (JS_ValueToObject(cx, var154, &var155) != JS_TRUE) {
         goto do_return;
     }
-    var376 = OBJECT_TO_JSVAL(var148);
-    argv[argc+2] = var376;
-    if (JS_GetArrayLength(cx, var148, &var149) != JS_TRUE) {
+    var384 = OBJECT_TO_JSVAL(var155);
+    argv[argc+2] = var384;
+    if (JS_GetArrayLength(cx, var155, &var156) != JS_TRUE) {
         goto do_return;
     }
-    var152 = sizeof(var151);
-    var152 *= var149;
-    var138 = JS_malloc(cx, var152);
-    if (!var138) {
+    var159 = sizeof(var158);
+    var159 *= var156;
+    var145 = JS_malloc(cx, var159);
+    if (!var145) {
         goto do_return;
     }
-    var178 = 1;
-    var153 = var149;
-    var155 = sizeof(var154);
-    var153 *= var155;
-    var161 = JS_malloc(cx, var153);
-    if (!var161) {
+    var185 = 1;
+    var160 = var156;
+    var162 = sizeof(var161);
+    var160 *= var162;
+    var168 = JS_malloc(cx, var160);
+    if (!var168) {
         goto do_return;
     }
-    var179 = 1;
-    var156 = var149;
-    var157 = -1;
-    while (var156)
+    var186 = 1;
+    var163 = var156;
+    var164 = -1;
+    while (var163)
     {
-    var156 += var157;
-    var158 = JS_GetElement(cx, var148, var156, &var159);
-    var160 = JS_ValueToString(cx, var159);
-    if (!var160) {
+    var163 += var164;
+    var165 = JS_GetElement(cx, var155, var163, &var166);
+    var167 = JS_ValueToString(cx, var166);
+    if (!var167) {
         goto do_return;
     }
-    var377 = STRING_TO_JSVAL(var160);
-    argv[argc+3] = var377;
-    var161[var156] = var160;
+    var385 = STRING_TO_JSVAL(var167);
+    argv[argc+3] = var385;
+    var168[var163] = var167;
     }
-    var164 = 0;
-    var162 = var149;
-    var163 = -1;
-    while (var162)
+    var171 = 0;
+    var169 = var156;
+    var170 = -1;
+    while (var169)
     {
-    var162 += var163;
-    var166 = var161[var162];
-    var165 = JS_GetStringLength(var166);
-    var164 += var165;
-    var167 = 1;
-    var164 += var167;
+    var169 += var170;
+    var173 = var168[var169];
+    var172 = JS_GetStringLength(var173);
+    var171 += var172;
+    var174 = 1;
+    var171 += var174;
     }
-    var177 = sizeof(var176);
-    var177 *= var164;
-    var168 = JS_malloc(cx, var177);
-    if (!var168) {
+    var184 = sizeof(var183);
+    var184 *= var171;
+    var175 = JS_malloc(cx, var184);
+    if (!var175) {
         goto do_return;
     }
-    var180 = 1;
-    var170 = sizeof(var169);
-    var170 *= var149;
-    var138 = JS_malloc(cx, var170);
-    if (!var138) {
+    var187 = 1;
+    var177 = sizeof(var176);
+    var177 *= var156;
+    var145 = JS_malloc(cx, var177);
+    if (!var145) {
         goto do_return;
     }
-    var181 = 1;
-    var173 = var168;
-    var173 += var164;
-    var171 = var149;
-    var172 = -1;
-    while (var171)
+    var188 = 1;
+    var180 = var175;
+    var180 += var171;
+    var178 = var156;
+    var179 = -1;
+    while (var178)
     {
-    var171 += var172;
-    var175 = var161[var171];
-    var174 = JS_GetStringLength(var175);
-    var173 -= var174;
-    var173 += var172;
-    var182 = JS_GetStringLength(var175);
-    var183 = 1;
-    var183 += var182;
-    var173 = JS_malloc(cx, var183);
-    if (!var173) {
+    var178 += var179;
+    var182 = var168[var178];
+    var181 = JS_GetStringLength(var182);
+    var180 -= var181;
+    var180 += var179;
+    var189 = JS_GetStringLength(var182);
+    var190 = 1;
+    var190 += var189;
+    var180 = JS_malloc(cx, var190);
+    if (!var180) {
         goto do_return;
     }
-    var185 = 1;
-    var184 = JS_GetStringChars(var175);
-    var378 = STRING_TO_JSVAL(var175);
-    argv[argc+4] = var378;
+    var192 = 1;
+    var191 = JS_GetStringChars(var182);
+    var386 = STRING_TO_JSVAL(var182);
+    argv[argc+4] = var386;
     {
         size_t i;
-        for (i = 0; i < var182; ++i) {
-            var173[i] = wctob(var184[i]);
+        for (i = 0; i < var189; ++i) {
+            var180[i] = wctob(var191[i]);
         }
-        var173[var182] = '\0';
+        var180[var189] = '\0';
     }
-    var138[var171] = var173;
+    var145[var178] = var180;
     }
     }
-    var133 = jsVideoCodec(var137, var138);
-    if (JS_NewNumberValue(cx, var133, &var186) != JS_TRUE) {
+    var140 = jsVideoCodec(var144, var145);
+    if (JS_NewNumberValue(cx, var140, &var193) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+5] = var186;
+    argv[argc+5] = var193;
     if (rval) {
-        *rval = var186;
+        *rval = var193;
     }
-    var131 = JS_TRUE;
+    var138 = JS_TRUE;
     do_return:
-    if (var185) {
-        JS_free(cx, var173);
-        var173 = NULL;
-        var185 = 0;
+    if (var192) {
+        JS_free(cx, var180);
+        var180 = NULL;
+        var192 = 0;
     }
-    if (var181) {
-        JS_free(cx, var138);
-        var138 = NULL;
-        var181 = 0;
+    if (var188) {
+        JS_free(cx, var145);
+        var145 = NULL;
+        var188 = 0;
     }
-    if (var180) {
+    if (var187) {
+        JS_free(cx, var175);
+        var175 = NULL;
+        var187 = 0;
+    }
+    if (var186) {
         JS_free(cx, var168);
         var168 = NULL;
-        var180 = 0;
+        var186 = 0;
     }
-    if (var179) {
-        JS_free(cx, var161);
-        var161 = NULL;
-        var179 = 0;
+    if (var185) {
+        JS_free(cx, var145);
+        var145 = NULL;
+        var185 = 0;
     }
-    if (var178) {
-        JS_free(cx, var138);
-        var138 = NULL;
-        var178 = 0;
+    if (var152) {
+        JS_free(cx, var144);
+        var144 = NULL;
+        var152 = 0;
     }
-    if (var145) {
-        JS_free(cx, var137);
-        var137 = NULL;
-        var145 = 0;
-    }
-    return var131;
+    return var138;
 }
 static JSBool
 jjadmaddVideoFilter_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var188;
-    char *var193;
-    char **var194;
-    int var189;
-    int var192;
-    int var195;
-    jsval var196;
-    JSString *var197;
-    jsval var380;
-    size_t var198;
-    size_t var199;
-    int var201;
-    jschar *var200;
-    jsval var381;
+    JSObject *var195;
+    char *var200;
+    char **var201;
+    int var196;
+    int var199;
     int var202;
     jsval var203;
-    JSObject *var204;
-    jsval var382;
-    jsuint var205;
-    char **var207;
-    size_t var208;
-    int var234;
-    size_t var209;
-    JSString *var210;
-    size_t var211;
-    JSString **var217;
-    int var235;
+    JSString *var204;
+    jsval var388;
+    size_t var205;
+    size_t var206;
+    int var208;
+    jschar *var207;
+    jsval var389;
+    int var209;
+    jsval var210;
+    JSObject *var211;
+    jsval var390;
     jsuint var212;
-    jsint var213;
-    JSBool var214;
-    jsval var215;
-    JSString *var216;
-    jsval var383;
-    size_t var220;
-    jsuint var218;
-    jsint var219;
-    JSString *var222;
-    size_t var221;
-    size_t var223;
-    char var232;
+    char **var214;
+    size_t var215;
+    int var241;
+    size_t var216;
+    JSString *var217;
+    size_t var218;
+    JSString **var224;
+    int var242;
+    jsuint var219;
+    jsint var220;
+    JSBool var221;
+    jsval var222;
+    JSString *var223;
+    jsval var391;
+    size_t var227;
+    jsuint var225;
+    jsint var226;
+    JSString *var229;
+    size_t var228;
+    size_t var230;
+    char var239;
+    size_t var240;
+    char *var231;
+    int var243;
+    char *var232;
     size_t var233;
-    char *var224;
-    int var236;
-    char *var225;
-    size_t var226;
-    int var237;
-    char *var229;
-    jsuint var227;
-    jsint var228;
-    JSString *var231;
-    size_t var230;
-    size_t var238;
-    size_t var239;
-    int var241;
-    jschar *var240;
-    jsval var384;
-    jsval var242;
-    JSBool var187;
-    var188 = NULL;
-    var193 = NULL;
-    var194 = NULL;
-    var189 = 0;
-    var192 = 0;
-    var195 = 0;
-    var196 = JSVAL_NULL;
-    var197 = NULL;
-    var380 = JSVAL_NULL;
-    var198 = 0;
+    int var244;
+    char *var236;
+    jsuint var234;
+    jsint var235;
+    JSString *var238;
+    size_t var237;
+    size_t var245;
+    size_t var246;
+    int var248;
+    jschar *var247;
+    jsval var392;
+    jsval var249;
+    JSBool var194;
+    var195 = NULL;
+    var200 = NULL;
+    var201 = NULL;
+    var196 = 0;
     var199 = 0;
-    var201 = 0;
-    var200 = NULL;
-    var381 = JSVAL_NULL;
     var202 = 0;
     var203 = JSVAL_NULL;
     var204 = NULL;
-    var382 = JSVAL_NULL;
+    var388 = JSVAL_NULL;
     var205 = 0;
+    var206 = 0;
+    var208 = 0;
     var207 = NULL;
-    var208 = 0;
-    var234 = 0;
+    var389 = JSVAL_NULL;
     var209 = 0;
-    var210 = NULL;
-    var211 = 0;
+    var210 = JSVAL_NULL;
+    var211 = NULL;
+    var390 = JSVAL_NULL;
+    var212 = 0;
+    var214 = NULL;
+    var215 = 0;
+    var241 = 0;
+    var216 = 0;
     var217 = NULL;
-    var235 = 0;
-    var212 = 0;
-    var213 = 0;
-    var214 = JS_FALSE;
-    var215 = JSVAL_NULL;
-    var216 = NULL;
-    var383 = JSVAL_NULL;
-    var220 = 0;
     var218 = 0;
+    var224 = NULL;
+    var242 = 0;
     var219 = 0;
-    var222 = NULL;
-    var221 = 0;
-    var223 = 0;
-    var232 = 0;
-    var233 = 0;
-    var224 = NULL;
-    var236 = 0;
-    var225 = NULL;
+    var220 = 0;
+    var221 = JS_FALSE;
+    var222 = JSVAL_NULL;
+    var223 = NULL;
+    var391 = JSVAL_NULL;
+    var227 = 0;
+    var225 = 0;
     var226 = 0;
-    var237 = 0;
     var229 = NULL;
-    var227 = 0;
     var228 = 0;
-    var231 = NULL;
     var230 = 0;
-    var238 = 0;
     var239 = 0;
-    var241 = 0;
-    var240 = NULL;
-    var384 = JSVAL_NULL;
-    var242 = JSVAL_NULL;
-    var187 = JS_FALSE;
-    var188 = obj;
-    var192 = argc;
-    var195 = 0;
-    var195 = var195 < var192;
-    if (var195) {
-    var196 = argv[0];
-    var197 = JS_ValueToString(cx, var196);
-    if (!var197) {
+    var240 = 0;
+    var231 = NULL;
+    var243 = 0;
+    var232 = NULL;
+    var233 = 0;
+    var244 = 0;
+    var236 = NULL;
+    var234 = 0;
+    var235 = 0;
+    var238 = NULL;
+    var237 = 0;
+    var245 = 0;
+    var246 = 0;
+    var248 = 0;
+    var247 = NULL;
+    var392 = JSVAL_NULL;
+    var249 = JSVAL_NULL;
+    var194 = JS_FALSE;
+    var195 = obj;
+    var199 = argc;
+    var202 = 0;
+    var202 = var202 < var199;
+    if (var202) {
+    var203 = argv[0];
+    var204 = JS_ValueToString(cx, var203);
+    if (!var204) {
         goto do_return;
     }
-    var380 = STRING_TO_JSVAL(var197);
-    argv[argc+0] = var380;
-    var198 = JS_GetStringLength(var197);
-    var199 = 1;
-    var199 += var198;
-    var193 = JS_malloc(cx, var199);
-    if (!var193) {
+    var388 = STRING_TO_JSVAL(var204);
+    argv[argc+0] = var388;
+    var205 = JS_GetStringLength(var204);
+    var206 = 1;
+    var206 += var205;
+    var200 = JS_malloc(cx, var206);
+    if (!var200) {
         goto do_return;
     }
-    var201 = 1;
-    var200 = JS_GetStringChars(var197);
-    var381 = STRING_TO_JSVAL(var197);
-    argv[argc+1] = var381;
+    var208 = 1;
+    var207 = JS_GetStringChars(var204);
+    var389 = STRING_TO_JSVAL(var204);
+    argv[argc+1] = var389;
     {
         size_t i;
-        for (i = 0; i < var198; ++i) {
-            var193[i] = wctob(var200[i]);
+        for (i = 0; i < var205; ++i) {
+            var200[i] = wctob(var207[i]);
         }
-        var193[var198] = '\0';
+        var200[var205] = '\0';
     }
     }
-    var202 = 1;
-    var202 = var202 < var192;
-    if (var202) {
-    var203 = argv[1];
-    if (JS_ValueToObject(cx, var203, &var204) != JS_TRUE) {
+    var209 = 1;
+    var209 = var209 < var199;
+    if (var209) {
+    var210 = argv[1];
+    if (JS_ValueToObject(cx, var210, &var211) != JS_TRUE) {
         goto do_return;
     }
-    var382 = OBJECT_TO_JSVAL(var204);
-    argv[argc+2] = var382;
-    if (JS_GetArrayLength(cx, var204, &var205) != JS_TRUE) {
+    var390 = OBJECT_TO_JSVAL(var211);
+    argv[argc+2] = var390;
+    if (JS_GetArrayLength(cx, var211, &var212) != JS_TRUE) {
         goto do_return;
     }
-    var208 = sizeof(var207);
-    var208 *= var205;
-    var194 = JS_malloc(cx, var208);
-    if (!var194) {
+    var215 = sizeof(var214);
+    var215 *= var212;
+    var201 = JS_malloc(cx, var215);
+    if (!var201) {
         goto do_return;
     }
-    var234 = 1;
-    var209 = var205;
-    var211 = sizeof(var210);
-    var209 *= var211;
-    var217 = JS_malloc(cx, var209);
-    if (!var217) {
+    var241 = 1;
+    var216 = var212;
+    var218 = sizeof(var217);
+    var216 *= var218;
+    var224 = JS_malloc(cx, var216);
+    if (!var224) {
         goto do_return;
     }
-    var235 = 1;
-    var212 = var205;
-    var213 = -1;
-    while (var212)
+    var242 = 1;
+    var219 = var212;
+    var220 = -1;
+    while (var219)
     {
-    var212 += var213;
-    var214 = JS_GetElement(cx, var204, var212, &var215);
-    var216 = JS_ValueToString(cx, var215);
-    if (!var216) {
+    var219 += var220;
+    var221 = JS_GetElement(cx, var211, var219, &var222);
+    var223 = JS_ValueToString(cx, var222);
+    if (!var223) {
         goto do_return;
     }
-    var383 = STRING_TO_JSVAL(var216);
-    argv[argc+3] = var383;
-    var217[var212] = var216;
+    var391 = STRING_TO_JSVAL(var223);
+    argv[argc+3] = var391;
+    var224[var219] = var223;
     }
-    var220 = 0;
-    var218 = var205;
-    var219 = -1;
-    while (var218)
+    var227 = 0;
+    var225 = var212;
+    var226 = -1;
+    while (var225)
     {
-    var218 += var219;
-    var222 = var217[var218];
-    var221 = JS_GetStringLength(var222);
-    var220 += var221;
-    var223 = 1;
-    var220 += var223;
+    var225 += var226;
+    var229 = var224[var225];
+    var228 = JS_GetStringLength(var229);
+    var227 += var228;
+    var230 = 1;
+    var227 += var230;
     }
-    var233 = sizeof(var232);
-    var233 *= var220;
-    var224 = JS_malloc(cx, var233);
-    if (!var224) {
+    var240 = sizeof(var239);
+    var240 *= var227;
+    var231 = JS_malloc(cx, var240);
+    if (!var231) {
         goto do_return;
     }
-    var236 = 1;
-    var226 = sizeof(var225);
-    var226 *= var205;
-    var194 = JS_malloc(cx, var226);
-    if (!var194) {
+    var243 = 1;
+    var233 = sizeof(var232);
+    var233 *= var212;
+    var201 = JS_malloc(cx, var233);
+    if (!var201) {
         goto do_return;
     }
-    var237 = 1;
-    var229 = var224;
-    var229 += var220;
-    var227 = var205;
-    var228 = -1;
-    while (var227)
+    var244 = 1;
+    var236 = var231;
+    var236 += var227;
+    var234 = var212;
+    var235 = -1;
+    while (var234)
     {
-    var227 += var228;
-    var231 = var217[var227];
-    var230 = JS_GetStringLength(var231);
-    var229 -= var230;
-    var229 += var228;
-    var238 = JS_GetStringLength(var231);
-    var239 = 1;
-    var239 += var238;
-    var229 = JS_malloc(cx, var239);
-    if (!var229) {
+    var234 += var235;
+    var238 = var224[var234];
+    var237 = JS_GetStringLength(var238);
+    var236 -= var237;
+    var236 += var235;
+    var245 = JS_GetStringLength(var238);
+    var246 = 1;
+    var246 += var245;
+    var236 = JS_malloc(cx, var246);
+    if (!var236) {
         goto do_return;
     }
-    var241 = 1;
-    var240 = JS_GetStringChars(var231);
-    var384 = STRING_TO_JSVAL(var231);
-    argv[argc+4] = var384;
+    var248 = 1;
+    var247 = JS_GetStringChars(var238);
+    var392 = STRING_TO_JSVAL(var238);
+    argv[argc+4] = var392;
     {
         size_t i;
-        for (i = 0; i < var238; ++i) {
-            var229[i] = wctob(var240[i]);
+        for (i = 0; i < var245; ++i) {
+            var236[i] = wctob(var247[i]);
         }
-        var229[var238] = '\0';
+        var236[var245] = '\0';
     }
-    var194[var227] = var229;
+    var201[var234] = var236;
     }
     }
-    var189 = jsVideoFilter(var193, var194);
-    if (JS_NewNumberValue(cx, var189, &var242) != JS_TRUE) {
+    var196 = jsVideoFilter(var200, var201);
+    if (JS_NewNumberValue(cx, var196, &var249) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+5] = var242;
+    argv[argc+5] = var249;
     if (rval) {
-        *rval = var242;
+        *rval = var249;
     }
-    var187 = JS_TRUE;
+    var194 = JS_TRUE;
     do_return:
-    if (var241) {
-        JS_free(cx, var229);
-        var229 = NULL;
-        var241 = 0;
+    if (var248) {
+        JS_free(cx, var236);
+        var236 = NULL;
+        var248 = 0;
     }
-    if (var237) {
-        JS_free(cx, var194);
-        var194 = NULL;
-        var237 = 0;
+    if (var244) {
+        JS_free(cx, var201);
+        var201 = NULL;
+        var244 = 0;
     }
-    if (var236) {
+    if (var243) {
+        JS_free(cx, var231);
+        var231 = NULL;
+        var243 = 0;
+    }
+    if (var242) {
         JS_free(cx, var224);
         var224 = NULL;
-        var236 = 0;
+        var242 = 0;
     }
-    if (var235) {
-        JS_free(cx, var217);
-        var217 = NULL;
-        var235 = 0;
+    if (var241) {
+        JS_free(cx, var201);
+        var201 = NULL;
+        var241 = 0;
     }
-    if (var234) {
-        JS_free(cx, var194);
-        var194 = NULL;
-        var234 = 0;
+    if (var208) {
+        JS_free(cx, var200);
+        var200 = NULL;
+        var208 = 0;
     }
-    if (var201) {
-        JS_free(cx, var193);
-        var193 = NULL;
-        var201 = 0;
-    }
-    return var187;
+    return var194;
 }
 static JSBool
 jjadmaudioCodec_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var244;
-    char *var249;
-    char **var250;
-    int var245;
-    int var248;
-    int var251;
-    jsval var252;
-    JSString *var253;
-    jsval var386;
-    size_t var254;
-    size_t var255;
-    int var257;
-    jschar *var256;
-    jsval var387;
+    JSObject *var251;
+    char *var256;
+    char **var257;
+    int var252;
+    int var255;
     int var258;
     jsval var259;
-    JSObject *var260;
-    jsval var388;
-    jsuint var261;
-    char **var263;
-    size_t var264;
-    int var290;
-    size_t var265;
-    JSString *var266;
-    size_t var267;
-    JSString **var273;
-    int var291;
+    JSString *var260;
+    jsval var394;
+    size_t var261;
+    size_t var262;
+    int var264;
+    jschar *var263;
+    jsval var395;
+    int var265;
+    jsval var266;
+    JSObject *var267;
+    jsval var396;
     jsuint var268;
-    jsint var269;
-    JSBool var270;
-    jsval var271;
-    JSString *var272;
-    jsval var389;
-    size_t var276;
-    jsuint var274;
-    jsint var275;
-    JSString *var278;
-    size_t var277;
-    size_t var279;
-    char var288;
+    char **var270;
+    size_t var271;
+    int var297;
+    size_t var272;
+    JSString *var273;
+    size_t var274;
+    JSString **var280;
+    int var298;
+    jsuint var275;
+    jsint var276;
+    JSBool var277;
+    jsval var278;
+    JSString *var279;
+    jsval var397;
+    size_t var283;
+    jsuint var281;
+    jsint var282;
+    JSString *var285;
+    size_t var284;
+    size_t var286;
+    char var295;
+    size_t var296;
+    char *var287;
+    int var299;
+    char *var288;
     size_t var289;
-    char *var280;
-    int var292;
-    char *var281;
-    size_t var282;
-    int var293;
-    char *var285;
-    jsuint var283;
-    jsint var284;
-    JSString *var287;
-    size_t var286;
-    size_t var294;
-    size_t var295;
-    int var297;
-    jschar *var296;
-    jsval var390;
-    jsval var298;
-    JSBool var243;
-    var244 = NULL;
-    var249 = NULL;
-    var250 = NULL;
-    var245 = 0;
-    var248 = 0;
-    var251 = 0;
-    var252 = JSVAL_NULL;
-    var253 = NULL;
-    var386 = JSVAL_NULL;
-    var254 = 0;
+    int var300;
+    char *var292;
+    jsuint var290;
+    jsint var291;
+    JSString *var294;
+    size_t var293;
+    size_t var301;
+    size_t var302;
+    int var304;
+    jschar *var303;
+    jsval var398;
+    jsval var305;
+    JSBool var250;
+    var251 = NULL;
+    var256 = NULL;
+    var257 = NULL;
+    var252 = 0;
     var255 = 0;
-    var257 = 0;
-    var256 = NULL;
-    var387 = JSVAL_NULL;
     var258 = 0;
     var259 = JSVAL_NULL;
     var260 = NULL;
-    var388 = JSVAL_NULL;
+    var394 = JSVAL_NULL;
     var261 = 0;
+    var262 = 0;
+    var264 = 0;
     var263 = NULL;
-    var264 = 0;
-    var290 = 0;
+    var395 = JSVAL_NULL;
     var265 = 0;
-    var266 = NULL;
-    var267 = 0;
+    var266 = JSVAL_NULL;
+    var267 = NULL;
+    var396 = JSVAL_NULL;
+    var268 = 0;
+    var270 = NULL;
+    var271 = 0;
+    var297 = 0;
+    var272 = 0;
     var273 = NULL;
-    var291 = 0;
-    var268 = 0;
-    var269 = 0;
-    var270 = JS_FALSE;
-    var271 = JSVAL_NULL;
-    var272 = NULL;
-    var389 = JSVAL_NULL;
-    var276 = 0;
     var274 = 0;
+    var280 = NULL;
+    var298 = 0;
     var275 = 0;
-    var278 = NULL;
-    var277 = 0;
-    var279 = 0;
-    var288 = 0;
-    var289 = 0;
-    var280 = NULL;
-    var292 = 0;
-    var281 = NULL;
+    var276 = 0;
+    var277 = JS_FALSE;
+    var278 = JSVAL_NULL;
+    var279 = NULL;
+    var397 = JSVAL_NULL;
+    var283 = 0;
+    var281 = 0;
     var282 = 0;
-    var293 = 0;
     var285 = NULL;
-    var283 = 0;
     var284 = 0;
-    var287 = NULL;
     var286 = 0;
-    var294 = 0;
     var295 = 0;
-    var297 = 0;
-    var296 = NULL;
-    var390 = JSVAL_NULL;
-    var298 = JSVAL_NULL;
-    var243 = JS_FALSE;
-    var244 = obj;
-    var248 = argc;
-    var251 = 0;
-    var251 = var251 < var248;
-    if (var251) {
-    var252 = argv[0];
-    var253 = JS_ValueToString(cx, var252);
-    if (!var253) {
+    var296 = 0;
+    var287 = NULL;
+    var299 = 0;
+    var288 = NULL;
+    var289 = 0;
+    var300 = 0;
+    var292 = NULL;
+    var290 = 0;
+    var291 = 0;
+    var294 = NULL;
+    var293 = 0;
+    var301 = 0;
+    var302 = 0;
+    var304 = 0;
+    var303 = NULL;
+    var398 = JSVAL_NULL;
+    var305 = JSVAL_NULL;
+    var250 = JS_FALSE;
+    var251 = obj;
+    var255 = argc;
+    var258 = 0;
+    var258 = var258 < var255;
+    if (var258) {
+    var259 = argv[0];
+    var260 = JS_ValueToString(cx, var259);
+    if (!var260) {
         goto do_return;
     }
-    var386 = STRING_TO_JSVAL(var253);
-    argv[argc+0] = var386;
-    var254 = JS_GetStringLength(var253);
-    var255 = 1;
-    var255 += var254;
-    var249 = JS_malloc(cx, var255);
-    if (!var249) {
+    var394 = STRING_TO_JSVAL(var260);
+    argv[argc+0] = var394;
+    var261 = JS_GetStringLength(var260);
+    var262 = 1;
+    var262 += var261;
+    var256 = JS_malloc(cx, var262);
+    if (!var256) {
         goto do_return;
     }
-    var257 = 1;
-    var256 = JS_GetStringChars(var253);
-    var387 = STRING_TO_JSVAL(var253);
-    argv[argc+1] = var387;
+    var264 = 1;
+    var263 = JS_GetStringChars(var260);
+    var395 = STRING_TO_JSVAL(var260);
+    argv[argc+1] = var395;
     {
         size_t i;
-        for (i = 0; i < var254; ++i) {
-            var249[i] = wctob(var256[i]);
+        for (i = 0; i < var261; ++i) {
+            var256[i] = wctob(var263[i]);
         }
-        var249[var254] = '\0';
+        var256[var261] = '\0';
     }
     }
-    var258 = 1;
-    var258 = var258 < var248;
-    if (var258) {
-    var259 = argv[1];
-    if (JS_ValueToObject(cx, var259, &var260) != JS_TRUE) {
+    var265 = 1;
+    var265 = var265 < var255;
+    if (var265) {
+    var266 = argv[1];
+    if (JS_ValueToObject(cx, var266, &var267) != JS_TRUE) {
         goto do_return;
     }
-    var388 = OBJECT_TO_JSVAL(var260);
-    argv[argc+2] = var388;
-    if (JS_GetArrayLength(cx, var260, &var261) != JS_TRUE) {
+    var396 = OBJECT_TO_JSVAL(var267);
+    argv[argc+2] = var396;
+    if (JS_GetArrayLength(cx, var267, &var268) != JS_TRUE) {
         goto do_return;
     }
-    var264 = sizeof(var263);
-    var264 *= var261;
-    var250 = JS_malloc(cx, var264);
-    if (!var250) {
+    var271 = sizeof(var270);
+    var271 *= var268;
+    var257 = JS_malloc(cx, var271);
+    if (!var257) {
         goto do_return;
     }
-    var290 = 1;
-    var265 = var261;
-    var267 = sizeof(var266);
-    var265 *= var267;
-    var273 = JS_malloc(cx, var265);
-    if (!var273) {
+    var297 = 1;
+    var272 = var268;
+    var274 = sizeof(var273);
+    var272 *= var274;
+    var280 = JS_malloc(cx, var272);
+    if (!var280) {
         goto do_return;
     }
-    var291 = 1;
-    var268 = var261;
-    var269 = -1;
-    while (var268)
+    var298 = 1;
+    var275 = var268;
+    var276 = -1;
+    while (var275)
     {
-    var268 += var269;
-    var270 = JS_GetElement(cx, var260, var268, &var271);
-    var272 = JS_ValueToString(cx, var271);
-    if (!var272) {
+    var275 += var276;
+    var277 = JS_GetElement(cx, var267, var275, &var278);
+    var279 = JS_ValueToString(cx, var278);
+    if (!var279) {
         goto do_return;
     }
-    var389 = STRING_TO_JSVAL(var272);
-    argv[argc+3] = var389;
-    var273[var268] = var272;
+    var397 = STRING_TO_JSVAL(var279);
+    argv[argc+3] = var397;
+    var280[var275] = var279;
     }
-    var276 = 0;
-    var274 = var261;
-    var275 = -1;
-    while (var274)
+    var283 = 0;
+    var281 = var268;
+    var282 = -1;
+    while (var281)
     {
-    var274 += var275;
-    var278 = var273[var274];
-    var277 = JS_GetStringLength(var278);
-    var276 += var277;
-    var279 = 1;
-    var276 += var279;
+    var281 += var282;
+    var285 = var280[var281];
+    var284 = JS_GetStringLength(var285);
+    var283 += var284;
+    var286 = 1;
+    var283 += var286;
     }
-    var289 = sizeof(var288);
-    var289 *= var276;
-    var280 = JS_malloc(cx, var289);
-    if (!var280) {
+    var296 = sizeof(var295);
+    var296 *= var283;
+    var287 = JS_malloc(cx, var296);
+    if (!var287) {
         goto do_return;
     }
-    var292 = 1;
-    var282 = sizeof(var281);
-    var282 *= var261;
-    var250 = JS_malloc(cx, var282);
-    if (!var250) {
+    var299 = 1;
+    var289 = sizeof(var288);
+    var289 *= var268;
+    var257 = JS_malloc(cx, var289);
+    if (!var257) {
         goto do_return;
     }
-    var293 = 1;
-    var285 = var280;
-    var285 += var276;
-    var283 = var261;
-    var284 = -1;
-    while (var283)
+    var300 = 1;
+    var292 = var287;
+    var292 += var283;
+    var290 = var268;
+    var291 = -1;
+    while (var290)
     {
-    var283 += var284;
-    var287 = var273[var283];
-    var286 = JS_GetStringLength(var287);
-    var285 -= var286;
-    var285 += var284;
-    var294 = JS_GetStringLength(var287);
-    var295 = 1;
-    var295 += var294;
-    var285 = JS_malloc(cx, var295);
-    if (!var285) {
+    var290 += var291;
+    var294 = var280[var290];
+    var293 = JS_GetStringLength(var294);
+    var292 -= var293;
+    var292 += var291;
+    var301 = JS_GetStringLength(var294);
+    var302 = 1;
+    var302 += var301;
+    var292 = JS_malloc(cx, var302);
+    if (!var292) {
         goto do_return;
     }
-    var297 = 1;
-    var296 = JS_GetStringChars(var287);
-    var390 = STRING_TO_JSVAL(var287);
-    argv[argc+4] = var390;
+    var304 = 1;
+    var303 = JS_GetStringChars(var294);
+    var398 = STRING_TO_JSVAL(var294);
+    argv[argc+4] = var398;
     {
         size_t i;
-        for (i = 0; i < var294; ++i) {
-            var285[i] = wctob(var296[i]);
+        for (i = 0; i < var301; ++i) {
+            var292[i] = wctob(var303[i]);
         }
-        var285[var294] = '\0';
+        var292[var301] = '\0';
     }
-    var250[var283] = var285;
+    var257[var290] = var292;
     }
     }
-    var245 = jsAudioCodec(var249, var250);
-    if (JS_NewNumberValue(cx, var245, &var298) != JS_TRUE) {
+    var252 = jsAudioCodec(var256, var257);
+    if (JS_NewNumberValue(cx, var252, &var305) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+5] = var298;
+    argv[argc+5] = var305;
     if (rval) {
-        *rval = var298;
+        *rval = var305;
     }
-    var243 = JS_TRUE;
+    var250 = JS_TRUE;
     do_return:
-    if (var297) {
-        JS_free(cx, var285);
-        var285 = NULL;
-        var297 = 0;
+    if (var304) {
+        JS_free(cx, var292);
+        var292 = NULL;
+        var304 = 0;
     }
-    if (var293) {
-        JS_free(cx, var250);
-        var250 = NULL;
-        var293 = 0;
+    if (var300) {
+        JS_free(cx, var257);
+        var257 = NULL;
+        var300 = 0;
     }
-    if (var292) {
+    if (var299) {
+        JS_free(cx, var287);
+        var287 = NULL;
+        var299 = 0;
+    }
+    if (var298) {
         JS_free(cx, var280);
         var280 = NULL;
-        var292 = 0;
+        var298 = 0;
     }
-    if (var291) {
-        JS_free(cx, var273);
-        var273 = NULL;
-        var291 = 0;
+    if (var297) {
+        JS_free(cx, var257);
+        var257 = NULL;
+        var297 = 0;
     }
-    if (var290) {
-        JS_free(cx, var250);
-        var250 = NULL;
-        var290 = 0;
+    if (var264) {
+        JS_free(cx, var256);
+        var256 = NULL;
+        var264 = 0;
     }
-    if (var257) {
-        JS_free(cx, var249);
-        var249 = NULL;
-        var257 = 0;
-    }
-    return var243;
+    return var250;
 }
 static JSBool
 jjadmsetContainer_ignore(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var300;
-    char *var305;
-    char **var306;
-    int var301;
-    int var304;
-    int var307;
-    jsval var308;
-    JSString *var309;
-    jsval var392;
-    size_t var310;
-    size_t var311;
-    int var313;
-    jschar *var312;
-    jsval var393;
+    JSObject *var307;
+    char *var312;
+    char **var313;
+    int var308;
+    int var311;
     int var314;
     jsval var315;
-    JSObject *var316;
-    jsval var394;
-    jsuint var317;
-    char **var319;
-    size_t var320;
-    int var346;
-    size_t var321;
-    JSString *var322;
-    size_t var323;
-    JSString **var329;
-    int var347;
+    JSString *var316;
+    jsval var400;
+    size_t var317;
+    size_t var318;
+    int var320;
+    jschar *var319;
+    jsval var401;
+    int var321;
+    jsval var322;
+    JSObject *var323;
+    jsval var402;
     jsuint var324;
-    jsint var325;
-    JSBool var326;
-    jsval var327;
-    JSString *var328;
-    jsval var395;
-    size_t var332;
-    jsuint var330;
-    jsint var331;
-    JSString *var334;
-    size_t var333;
-    size_t var335;
-    char var344;
+    char **var326;
+    size_t var327;
+    int var353;
+    size_t var328;
+    JSString *var329;
+    size_t var330;
+    JSString **var336;
+    int var354;
+    jsuint var331;
+    jsint var332;
+    JSBool var333;
+    jsval var334;
+    JSString *var335;
+    jsval var403;
+    size_t var339;
+    jsuint var337;
+    jsint var338;
+    JSString *var341;
+    size_t var340;
+    size_t var342;
+    char var351;
+    size_t var352;
+    char *var343;
+    int var355;
+    char *var344;
     size_t var345;
-    char *var336;
-    int var348;
-    char *var337;
-    size_t var338;
-    int var349;
-    char *var341;
-    jsuint var339;
-    jsint var340;
-    JSString *var343;
-    size_t var342;
-    size_t var350;
-    size_t var351;
-    int var353;
-    jschar *var352;
-    jsval var396;
-    jsval var354;
-    JSBool var299;
-    var300 = NULL;
-    var305 = NULL;
-    var306 = NULL;
-    var301 = 0;
-    var304 = 0;
-    var307 = 0;
-    var308 = JSVAL_NULL;
-    var309 = NULL;
-    var392 = JSVAL_NULL;
-    var310 = 0;
+    int var356;
+    char *var348;
+    jsuint var346;
+    jsint var347;
+    JSString *var350;
+    size_t var349;
+    size_t var357;
+    size_t var358;
+    int var360;
+    jschar *var359;
+    jsval var404;
+    jsval var361;
+    JSBool var306;
+    var307 = NULL;
+    var312 = NULL;
+    var313 = NULL;
+    var308 = 0;
     var311 = 0;
-    var313 = 0;
-    var312 = NULL;
-    var393 = JSVAL_NULL;
     var314 = 0;
     var315 = JSVAL_NULL;
     var316 = NULL;
-    var394 = JSVAL_NULL;
+    var400 = JSVAL_NULL;
     var317 = 0;
+    var318 = 0;
+    var320 = 0;
     var319 = NULL;
-    var320 = 0;
-    var346 = 0;
+    var401 = JSVAL_NULL;
     var321 = 0;
-    var322 = NULL;
-    var323 = 0;
+    var322 = JSVAL_NULL;
+    var323 = NULL;
+    var402 = JSVAL_NULL;
+    var324 = 0;
+    var326 = NULL;
+    var327 = 0;
+    var353 = 0;
+    var328 = 0;
     var329 = NULL;
-    var347 = 0;
-    var324 = 0;
-    var325 = 0;
-    var326 = JS_FALSE;
-    var327 = JSVAL_NULL;
-    var328 = NULL;
-    var395 = JSVAL_NULL;
-    var332 = 0;
     var330 = 0;
+    var336 = NULL;
+    var354 = 0;
     var331 = 0;
-    var334 = NULL;
-    var333 = 0;
-    var335 = 0;
-    var344 = 0;
-    var345 = 0;
-    var336 = NULL;
-    var348 = 0;
-    var337 = NULL;
+    var332 = 0;
+    var333 = JS_FALSE;
+    var334 = JSVAL_NULL;
+    var335 = NULL;
+    var403 = JSVAL_NULL;
+    var339 = 0;
+    var337 = 0;
     var338 = 0;
-    var349 = 0;
     var341 = NULL;
-    var339 = 0;
     var340 = 0;
-    var343 = NULL;
     var342 = 0;
-    var350 = 0;
     var351 = 0;
-    var353 = 0;
-    var352 = NULL;
-    var396 = JSVAL_NULL;
-    var354 = JSVAL_NULL;
-    var299 = JS_FALSE;
-    var300 = obj;
-    var304 = argc;
-    var307 = 0;
-    var307 = var307 < var304;
-    if (var307) {
-    var308 = argv[0];
-    var309 = JS_ValueToString(cx, var308);
-    if (!var309) {
+    var352 = 0;
+    var343 = NULL;
+    var355 = 0;
+    var344 = NULL;
+    var345 = 0;
+    var356 = 0;
+    var348 = NULL;
+    var346 = 0;
+    var347 = 0;
+    var350 = NULL;
+    var349 = 0;
+    var357 = 0;
+    var358 = 0;
+    var360 = 0;
+    var359 = NULL;
+    var404 = JSVAL_NULL;
+    var361 = JSVAL_NULL;
+    var306 = JS_FALSE;
+    var307 = obj;
+    var311 = argc;
+    var314 = 0;
+    var314 = var314 < var311;
+    if (var314) {
+    var315 = argv[0];
+    var316 = JS_ValueToString(cx, var315);
+    if (!var316) {
         goto do_return;
     }
-    var392 = STRING_TO_JSVAL(var309);
-    argv[argc+0] = var392;
-    var310 = JS_GetStringLength(var309);
-    var311 = 1;
-    var311 += var310;
-    var305 = JS_malloc(cx, var311);
-    if (!var305) {
+    var400 = STRING_TO_JSVAL(var316);
+    argv[argc+0] = var400;
+    var317 = JS_GetStringLength(var316);
+    var318 = 1;
+    var318 += var317;
+    var312 = JS_malloc(cx, var318);
+    if (!var312) {
         goto do_return;
     }
-    var313 = 1;
-    var312 = JS_GetStringChars(var309);
-    var393 = STRING_TO_JSVAL(var309);
-    argv[argc+1] = var393;
+    var320 = 1;
+    var319 = JS_GetStringChars(var316);
+    var401 = STRING_TO_JSVAL(var316);
+    argv[argc+1] = var401;
     {
         size_t i;
-        for (i = 0; i < var310; ++i) {
-            var305[i] = wctob(var312[i]);
+        for (i = 0; i < var317; ++i) {
+            var312[i] = wctob(var319[i]);
         }
-        var305[var310] = '\0';
+        var312[var317] = '\0';
     }
     }
-    var314 = 1;
-    var314 = var314 < var304;
-    if (var314) {
-    var315 = argv[1];
-    if (JS_ValueToObject(cx, var315, &var316) != JS_TRUE) {
+    var321 = 1;
+    var321 = var321 < var311;
+    if (var321) {
+    var322 = argv[1];
+    if (JS_ValueToObject(cx, var322, &var323) != JS_TRUE) {
         goto do_return;
     }
-    var394 = OBJECT_TO_JSVAL(var316);
-    argv[argc+2] = var394;
-    if (JS_GetArrayLength(cx, var316, &var317) != JS_TRUE) {
+    var402 = OBJECT_TO_JSVAL(var323);
+    argv[argc+2] = var402;
+    if (JS_GetArrayLength(cx, var323, &var324) != JS_TRUE) {
         goto do_return;
     }
-    var320 = sizeof(var319);
-    var320 *= var317;
-    var306 = JS_malloc(cx, var320);
-    if (!var306) {
+    var327 = sizeof(var326);
+    var327 *= var324;
+    var313 = JS_malloc(cx, var327);
+    if (!var313) {
         goto do_return;
     }
-    var346 = 1;
-    var321 = var317;
-    var323 = sizeof(var322);
-    var321 *= var323;
-    var329 = JS_malloc(cx, var321);
-    if (!var329) {
+    var353 = 1;
+    var328 = var324;
+    var330 = sizeof(var329);
+    var328 *= var330;
+    var336 = JS_malloc(cx, var328);
+    if (!var336) {
         goto do_return;
     }
-    var347 = 1;
-    var324 = var317;
-    var325 = -1;
-    while (var324)
+    var354 = 1;
+    var331 = var324;
+    var332 = -1;
+    while (var331)
     {
-    var324 += var325;
-    var326 = JS_GetElement(cx, var316, var324, &var327);
-    var328 = JS_ValueToString(cx, var327);
-    if (!var328) {
+    var331 += var332;
+    var333 = JS_GetElement(cx, var323, var331, &var334);
+    var335 = JS_ValueToString(cx, var334);
+    if (!var335) {
         goto do_return;
     }
-    var395 = STRING_TO_JSVAL(var328);
-    argv[argc+3] = var395;
-    var329[var324] = var328;
+    var403 = STRING_TO_JSVAL(var335);
+    argv[argc+3] = var403;
+    var336[var331] = var335;
     }
-    var332 = 0;
-    var330 = var317;
-    var331 = -1;
-    while (var330)
+    var339 = 0;
+    var337 = var324;
+    var338 = -1;
+    while (var337)
     {
-    var330 += var331;
-    var334 = var329[var330];
-    var333 = JS_GetStringLength(var334);
-    var332 += var333;
-    var335 = 1;
-    var332 += var335;
+    var337 += var338;
+    var341 = var336[var337];
+    var340 = JS_GetStringLength(var341);
+    var339 += var340;
+    var342 = 1;
+    var339 += var342;
     }
-    var345 = sizeof(var344);
-    var345 *= var332;
-    var336 = JS_malloc(cx, var345);
-    if (!var336) {
+    var352 = sizeof(var351);
+    var352 *= var339;
+    var343 = JS_malloc(cx, var352);
+    if (!var343) {
         goto do_return;
     }
-    var348 = 1;
-    var338 = sizeof(var337);
-    var338 *= var317;
-    var306 = JS_malloc(cx, var338);
-    if (!var306) {
+    var355 = 1;
+    var345 = sizeof(var344);
+    var345 *= var324;
+    var313 = JS_malloc(cx, var345);
+    if (!var313) {
         goto do_return;
     }
-    var349 = 1;
-    var341 = var336;
-    var341 += var332;
-    var339 = var317;
-    var340 = -1;
-    while (var339)
+    var356 = 1;
+    var348 = var343;
+    var348 += var339;
+    var346 = var324;
+    var347 = -1;
+    while (var346)
     {
-    var339 += var340;
-    var343 = var329[var339];
-    var342 = JS_GetStringLength(var343);
-    var341 -= var342;
-    var341 += var340;
-    var350 = JS_GetStringLength(var343);
-    var351 = 1;
-    var351 += var350;
-    var341 = JS_malloc(cx, var351);
-    if (!var341) {
+    var346 += var347;
+    var350 = var336[var346];
+    var349 = JS_GetStringLength(var350);
+    var348 -= var349;
+    var348 += var347;
+    var357 = JS_GetStringLength(var350);
+    var358 = 1;
+    var358 += var357;
+    var348 = JS_malloc(cx, var358);
+    if (!var348) {
         goto do_return;
     }
-    var353 = 1;
-    var352 = JS_GetStringChars(var343);
-    var396 = STRING_TO_JSVAL(var343);
-    argv[argc+4] = var396;
+    var360 = 1;
+    var359 = JS_GetStringChars(var350);
+    var404 = STRING_TO_JSVAL(var350);
+    argv[argc+4] = var404;
     {
         size_t i;
-        for (i = 0; i < var350; ++i) {
-            var341[i] = wctob(var352[i]);
+        for (i = 0; i < var357; ++i) {
+            var348[i] = wctob(var359[i]);
         }
-        var341[var350] = '\0';
+        var348[var357] = '\0';
     }
-    var306[var339] = var341;
+    var313[var346] = var348;
     }
     }
-    var301 = jsSetContainer(var305, var306);
-    if (JS_NewNumberValue(cx, var301, &var354) != JS_TRUE) {
+    var308 = jsSetContainer(var312, var313);
+    if (JS_NewNumberValue(cx, var308, &var361) != JS_TRUE) {
         goto do_return;
     }
-    argv[argc+5] = var354;
+    argv[argc+5] = var361;
     if (rval) {
-        *rval = var354;
+        *rval = var361;
     }
-    var299 = JS_TRUE;
+    var306 = JS_TRUE;
     do_return:
-    if (var353) {
-        JS_free(cx, var341);
-        var341 = NULL;
-        var353 = 0;
+    if (var360) {
+        JS_free(cx, var348);
+        var348 = NULL;
+        var360 = 0;
     }
-    if (var349) {
-        JS_free(cx, var306);
-        var306 = NULL;
-        var349 = 0;
+    if (var356) {
+        JS_free(cx, var313);
+        var313 = NULL;
+        var356 = 0;
     }
-    if (var348) {
+    if (var355) {
+        JS_free(cx, var343);
+        var343 = NULL;
+        var355 = 0;
+    }
+    if (var354) {
         JS_free(cx, var336);
         var336 = NULL;
-        var348 = 0;
+        var354 = 0;
     }
-    if (var347) {
-        JS_free(cx, var329);
-        var329 = NULL;
-        var347 = 0;
+    if (var353) {
+        JS_free(cx, var313);
+        var313 = NULL;
+        var353 = 0;
     }
-    if (var346) {
-        JS_free(cx, var306);
-        var306 = NULL;
-        var346 = 0;
+    if (var320) {
+        JS_free(cx, var312);
+        var312 = NULL;
+        var320 = 0;
     }
-    if (var313) {
-        JS_free(cx, var305);
-        var305 = NULL;
-        var313 = 0;
-    }
-    return var299;
+    return var306;
 }
 static JSBool
 jjadm__construct__(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
-    JSObject *var356;
-    int var360;
-    JSBool var355;
-    var356 = NULL;
-    var360 = 0;
-    var355 = JS_FALSE;
-    var356 = obj;
-    var360 = argc;
+    JSObject *var363;
+    int var367;
+    JSBool var362;
+    var363 = NULL;
+    var367 = 0;
+    var362 = JS_FALSE;
+    var363 = obj;
+    var367 = argc;
     jsAvidemux();
-    var355 = JS_TRUE;
-    return var355;
+    var362 = JS_TRUE;
+    return var362;
 }
 static JSPropertySpec jjadm_static_ps[] = {
     {"markerA", 0, 0|JSPROP_ENUMERATE, jjadmmarkerA_get, jjadmmarkerA_set},
@@ -1846,6 +1873,7 @@
     JS_FS("setPostProc", jjadmsetPostProc, 3, 0, 1),
     JS_FS("audioReset", jjadmaudioReset, 0, 0, 1),
     JS_FS("audioMixer", jjadmaudioMixer, 1, 0, 3),
+    JS_FS("clearVideoFilters", jjadmclearVideoFilters, 0, 0, 1),
     JS_FS("videoCodec", jsAdmvideoCodec,  2, 0, 6),
     JS_FS("addVideoFilter", jsAdmaddVideoFilter,  2, 0, 6),
     JS_FS("audioCodec", jsAdmaudioCodec,  2, 0, 6),

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-11 19:06:36 UTC (rev 5651)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux_js.idl	2009-12-12 07:51:48 UTC (rev 5652)
@@ -14,9 +14,12 @@
         function int appendVideo    : jsAppendVideo (cstring ) <static>;
         function int addSegment     : jsAddSegment (int ,double , double ) <static>;
         function int setPostProc    : jsSetPostProc (int ,int , int ) <static>;
+        /*            JSFUNC                 C FUNC           PARAM     */
         function int audioReset     : jsAudioReset () <static>;
         function int audioMixer     : jsAudioMixer (cstring ) <static>;
         /*            JSFUNC                 C FUNC           PARAM     */
+        function int clearVideoFilters   : jsClearVideoFilters() <static>;
+        
 /* Override as jsapigen cannot handle multiple args the way we need it to */
         function int videoCodec_ignore     : jsVideoCodec(cstring,cstring[])   <static>;
         function int addVideoFilter_ignore : jsVideoFilter(cstring,cstring[])   <static>;

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp	2009-12-11 19:06:36 UTC (rev 5651)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsVideo.cpp	2009-12-12 07:51:48 UTC (rev 5652)
@@ -110,6 +110,13 @@
     return true;
 }
 /**
+     \fn jsClearFilters
+*/
+int jsClearVideoFilters()
+{
+    return ADM_vf_clearFilters();
+}
+/**
     \fn jsGetMarkerA
 */
 double jsGetMarkerA(void)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/include/ADM_videoFilters.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/include/ADM_videoFilters.h	2009-12-11 19:06:36 UTC (rev 5651)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/include/ADM_videoFilters.h	2009-12-12 07:51:48 UTC (rev 5652)
@@ -39,4 +39,5 @@
 bool                    ADM_vf_configureFilterAtIndex(int index);
 bool                    ADM_vf_moveFilterDown(int index);
 bool                    ADM_vf_moveFilterUp(int index);
+bool                    ADM_vf_clearFilters(void);
 #endif
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilters.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilters.cpp	2009-12-11 19:06:36 UTC (rev 5651)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilters.cpp	2009-12-12 07:51:48 UTC (rev 5652)
@@ -186,8 +186,20 @@
     return ADM_vf_recreateChain();
 }
 
+/**
+    \fn ADM_vf_clearFilters
+*/
+bool ADM_vf_clearFilters(void)
+{
+    ADM_info("clear filters\n");
+    //
+    int nb=ADM_VideoFilters.size();
+    for(int i=0;i<nb;i++)
+        delete ADM_VideoFilters[i].instance;
+    ADM_VideoFilters.clear();
+    return true;
+}
 
-
 /**
     \fn createVideoFilterChain
     \brief Create a filter chain



From mean at mail.berlios.de  Sat Dec 12 08:51:52 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 12 Dec 2009 08:51:52 +0100
Subject: [Avidemux-svn-commit] r5653 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include
Message-ID: <200912120751.nBC7pqFV023373@sheep.berlios.de>

Author: mean
Date: 2009-12-12 08:51:51 +0100 (Sat, 12 Dec 2009)
New Revision: 5653

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h
Log:
[js] win32 build fix

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h	2009-12-12 07:51:48 UTC (rev 5652)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsAvidemux.h	2009-12-12 07:51:51 UTC (rev 5653)
@@ -13,6 +13,7 @@
  ***************************************************************************/
 #ifndef ADM_JS_AVIDEMUX_H
 #define ADM_JS_AVIDEMUX_H
+#include "ADM_inttype.h"
 #include "jsapi.h"
 #ifdef __cplusplus
 extern "C" {



From mean at mail.berlios.de  Sat Dec 12 08:58:52 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 12 Dec 2009 08:58:52 +0100
Subject: [Avidemux-svn-commit] r5654 - tags
Message-ID: <200912120758.nBC7wqLY024187@sheep.berlios.de>

Author: mean
Date: 2009-12-12 08:58:51 +0100 (Sat, 12 Dec 2009)
New Revision: 5654

Added:
   tags/avidemux_2.5.2rc/
Log:
Tag 2.5.2rc


Copied: tags/avidemux_2.5.2rc (from rev 5653, branches/avidemux_2.5_branch_gruntster)



From mean at mail.berlios.de  Sat Dec 12 21:34:03 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 12 Dec 2009 21:34:03 +0100
Subject: [Avidemux-svn-commit] r5655 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: . ADM_core/src
Message-ID: <200912122034.nBCKY3wM013469@sheep.berlios.de>

Author: mean
Date: 2009-12-12 21:34:03 +0100 (Sat, 12 Dec 2009)
New Revision: 5655

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp
Log:
[Osx] Patch by surfer

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp	2009-12-12 07:58:51 UTC (rev 5654)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp	2009-12-12 20:34:03 UTC (rev 5655)
@@ -361,7 +361,7 @@
 	const char *pluginDir="ADM_plugins";
 
 #ifdef __APPLE__
-    const char *startDir="../Libraries/lib";
+    const char *startDir="../lib";
 #else
     const char *startDir="lib";
 #endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp	2009-12-12 07:58:51 UTC (rev 5654)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp	2009-12-12 20:34:03 UTC (rev 5655)
@@ -222,7 +222,7 @@
 	const char *pluginDir="ADM_plugins";
 
 #ifdef __APPLE__
-    const char *startDir="../Libraries/lib";
+    const char *startDir="../lib";
 #else
     const char *startDir="lib";
 #endif



From mean at mail.berlios.de  Wed Dec 16 20:22:18 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 16 Dec 2009 20:22:18 +0100
Subject: [Avidemux-svn-commit] r5657 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_osSupport
Message-ID: <200912161922.nBGJMIwY012875@sheep.berlios.de>

Author: mean
Date: 2009-12-16 20:22:17 +0100 (Wed, 16 Dec 2009)
New Revision: 5657

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_osSupport/ADM_misc.cpp
Log:
[i18n] Fix buffer overflow with large language (greek) launchpad 344528

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_osSupport/ADM_misc.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_osSupport/ADM_misc.cpp	2009-12-16 18:42:50 UTC (rev 5656)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_osSupport/ADM_misc.cpp	2009-12-16 19:22:17 UTC (rev 5657)
@@ -6,17 +6,19 @@
 char* ms2timedisplay(uint32_t ms)
 {
 	uint32_t mm, ss;
-	static char string[20];
+#define ADM_MAX_STRING 256
+#define LU "u"
+	static char string[ADM_MAX_STRING+1];
 
 	mm = (uint32_t)floor(ms / 60000.);
 	
 	if (mm > 1)
 	{
-		sprintf(string, QT_TR_NOOP("%lu minutes"), mm);
+		snprintf(string, ADM_MAX_STRING,QT_TR_NOOP("%"LU" minutes"), mm);
 	}
 	else if (mm == 1)
 	{
-		sprintf(string, QT_TR_NOOP("%lu minute"), mm);
+		snprintf(string,ADM_MAX_STRING, QT_TR_NOOP("%"LU" minute"), mm);
 	}
 	else
 	{
@@ -24,14 +26,14 @@
 
 		if (ss == 1)
 		{
-			sprintf(string, QT_TR_NOOP("%lu second"), ss);
+			snprintf(string,ADM_MAX_STRING, QT_TR_NOOP("%"LU" second"), ss);
 		}
 		else
 		{
-			sprintf(string, QT_TR_NOOP("%lu seconds"), ss);
+			snprintf(string,ADM_MAX_STRING, QT_TR_NOOP("%"LU" seconds"), ss);
 		}
 	}
-
+    string[ADM_MAX_STRING]=0;
 	return string;
 }
 



From mean at mail.berlios.de  Thu Dec 17 20:46:31 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 17 Dec 2009 20:46:31 +0100
Subject: [Avidemux-svn-commit] r5658 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Rotate
Message-ID: <200912171946.nBHJkVTH014650@sheep.berlios.de>

Author: mean
Date: 2009-12-17 20:46:30 +0100 (Thu, 17 Dec 2009)
New Revision: 5658

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Rotate/ADM_vidRotate.cpp
Log:
[Rotate] Fix load/save of rotate filter

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Rotate/ADM_vidRotate.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Rotate/ADM_vidRotate.cpp	2009-12-16 19:22:17 UTC (rev 5657)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Rotate/ADM_vidRotate.cpp	2009-12-17 19:46:30 UTC (rev 5658)
@@ -44,11 +44,10 @@
 
 
 //********** Register chunk ************
-static FILTER_PARAM flipParam={0,{""}};
 
 //REGISTERX(VF_TRANSFORM, "rotate",QT_TR_NOOP("Rotate"),QT_TR_NOOP(
 //    "Rotate the picture by 90, 180 or 270 degrees."),VF_ROTATE,1,rotate_create,rotate_script);
-VF_DEFINE_FILTER(ADMVideoRotate,flipParam,
+VF_DEFINE_FILTER(ADMVideoRotate,rotpParam,
                                 rotate,
                                 QT_TR_NOOP("Rotate"),
                                 1,



From mean at mail.berlios.de  Fri Dec 18 07:24:37 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 18 Dec 2009 07:24:37 +0100
Subject: [Avidemux-svn-commit] r5659 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Equalizer
Message-ID: <200912180624.nBI6ObHX029929@sheep.berlios.de>

Author: mean
Date: 2009-12-18 07:24:23 +0100 (Fri, 18 Dec 2009)
New Revision: 5659

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Equalizer/ADM_vidEqualizer.cpp
Log:
[Equalizer] Fix load/save

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Equalizer/ADM_vidEqualizer.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Equalizer/ADM_vidEqualizer.cpp	2009-12-17 19:46:30 UTC (rev 5658)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Equalizer/ADM_vidEqualizer.cpp	2009-12-18 06:24:23 UTC (rev 5659)
@@ -14,8 +14,28 @@
 #include "ADM_vidEqualizer.h"
 
 
-static FILTER_PARAM equalizer_template={8,{"0","1","2","3"
-					,"4","5","6","7"}};
+static FILTER_PARAM equalizer_template={256,
+{
+"x0","x1","x2","x3","x4","x5","x6","x7","x8","x9","x10","x11","x12","x13","x14","x15","x16","x17","x18",
+"x19","x20","x21","x22","x23","x24"
+/*,"x25","x26","x27","x28","x29","x30","x31","x32","x33","x34","x35","x36",
+"x37","x38","x39","x40","x41","x42","x43","x44","x45","x46","x47","x48","x49","x50","x51","x52","x53","x54",
+"x55","x56","x57","x58","x59","x60","x61","x62","x63","x64","x65","x66","x67","x68","x69","x70","x71","x72",
+"x73","x74","x75","x76","x77","x78","x79","x80","x81","x82","x83","x84","x85","x86","x87","x88","x89","x90",
+"x91","x92","x93","x94","x95","x96","x97","x98","x99","x100","x101","x102","x103","x104","x105","x106",
+"x107","x108","x109","x110","x111","x112","x113","x114","x115","x116","x117","x118","x119","x120","x121",
+"x122","x123","x124","x125","x126","x127","x128","x129","x130","x131","x132","x133","x134","x135","x136",
+"x137","x138","x139","x140","x141","x142","x143","x144","x145","x146","x147","x148","x149","x150","x151",
+"x152","x153","x154","x155","x156","x157","x158","x159","x160","x161","x162","x163","x164","x165","x166",
+"x167","x168","x169","x170","x171","x172","x173","x174","x175","x176","x177","x178","x179","x180","x181",
+"x182","x183","x184","x185","x186","x187","x188","x189","x190","x191","x192","x193","x194","x195","x196",
+"x197","x198","x199","x200","x201","x202","x203","x204","x205","x206","x207","x208","x209","x210","x211",
+"x212","x213","x214","x215","x216","x217","x218","x219","x220","x221","x222","x223","x224","x225","x226",
+"x227","x228","x229","x230","x231","x232","x233","x234","x235","x236","x237","x238","x239","x240","x241",
+"x242","x243","x244","x245","x246","x247","x248","x249","x250","x251","x252","x253","x254","x255"
+*/
+}
+};
 //REGISTERX(VF_COLORS, "equalizer",QT_TR_NOOP("Luma equalizer"),
 //QT_TR_NOOP("Luma correction filter with histogram."),VF_EQUALIZER,1,equalizer_create,equalizer_script);
 VF_DEFINE_FILTER_UI(vidEqualizer,equalizer_template,
@@ -63,8 +83,9 @@
 		        char dummy[10];
                         for(int i=0;i<256;i++)  
                         {
-                                sprintf(dummy,"x%03d",i);
+                                sprintf(dummy,"x%d",i);
                                 couples->getCouple((char *)dummy,&(_param->_scaler[i]));
+                                //printf("%d",_param->_scaler[i]);
                         }
 		}
 		else // Default
@@ -118,7 +139,7 @@
 
         for(int i=0;i<256;i++)  
         {
-                sprintf(dummy,"x%03d",i);
+                sprintf(dummy,"x%d",i);
                 (*couples)->setCouple(dummy,(_param->_scaler[i]));
         }
 	return 1;



From mean at mail.berlios.de  Sat Dec 19 15:20:59 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 19 Dec 2009 15:20:59 +0100
Subject: [Avidemux-svn-commit] r5660 - tags
Message-ID: <200912191420.nBJEKxRr008877@sheep.berlios.de>

Author: mean
Date: 2009-12-19 15:20:59 +0100 (Sat, 19 Dec 2009)
New Revision: 5660

Added:
   tags/avidemux_2.5.2/
Log:
[tag] 2.5.2



Copied: tags/avidemux_2.5.2 (from rev 5659, branches/avidemux_2.5_branch_gruntster)



From gruntster at mail.berlios.de  Sat Dec 19 19:51:39 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 19:51:39 +0100
Subject: [Avidemux-svn-commit] r5661 - in
	branches/avidemux_2.5_branch_gruntster: avidemux/ADM_core/src
	cmake/patches
Message-ID: <200912191851.nBJIpd99009573@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 19:51:33 +0100 (Sat, 19 Dec 2009)
New Revision: 5661

Removed:
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavutil_mem.c.patch
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_memsupport.cpp
   branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
Log:
[ffmpeg] remove overloaded av* memory functions and let ffmpeg libs look after themselves - it might break things that aren't correctly freed using av_free

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_memsupport.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_memsupport.cpp	2009-12-19 14:20:59 UTC (rev 5660)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_memsupport.cpp	2009-12-19 18:51:33 UTC (rev 5661)
@@ -42,13 +42,6 @@
 extern size_t getSizeFromPointer(void* ptr);
 #endif
 
-extern "C"
-{
-	void *av_malloc(unsigned int size);
-	void av_free(void *ptr);
-	void *av_realloc(void *ptr, unsigned int size);
-}
-
 void ADM_memStat(void);
 void ADM_memStatInit(void);
 void ADM_memStatEnd(void);
@@ -180,50 +173,7 @@
 {
 	ADM_dezalloc(c);
 }
-//********************************
-// lavcodec wrapper
-//********************************
-extern "C"
-{
-	void *av_malloc(unsigned int size)
-	{
- 		return ADM_alloc(size);
-	}
 
-	void av_freep(void *arg)
-	{
-		void **ptr= (void**)arg;
-		av_free(*ptr);
-		*ptr = NULL;
-	}
-
-	void *av_mallocz(unsigned int size)
-	{
-		void *ptr;
-
-		ptr = av_malloc(size);
-
-		if (ptr)
-			memset(ptr, 0, size);
-
-		return ptr;
-	}
-
-	char *av_strdup(const char *s)
-	{
-		char *ptr;
-		int len;
-
-		len = strlen(s) + 1;
-		ptr = (char *)av_malloc(len);
-
-		if (ptr)
-			memcpy(ptr, s, len);
-
-		return ptr;
-	}
-}
-
 /**
  * av_realloc semantics (same as glibc): if ptr is NULL and size > 0,
  * identical to malloc(size). If size is zero, it is identical to
@@ -282,18 +232,6 @@
 #endif
 }
 
-void *av_realloc(void *ptr, unsigned int newsize)
-{
-	return ADM_realloc(ptr,newsize);
-}
-
-/* NOTE: ptr = NULL is explicetly allowed */
-void av_free(void *ptr)
-{
-	if(ptr)
-		ADM_dealloc(ptr);  
-}
-
 char *ADM_strdup(const char *in)
 {
 	if(!in)
@@ -365,58 +303,5 @@
 
 	return nalloc;
 }
-
-extern "C"
-{
-	void *av_malloc(unsigned int size)
-	{
-		return operator new(size, (char*)_DEBUG_NEW_CALLER_ADDRESS, 0);
-	}
-	void av_freep(void *arg)
-	{
-		void **ptr = (void**)arg;
-		av_free(*ptr);
-		*ptr = NULL;
-	}
-
-	void *av_mallocz(unsigned int size)
-	{
-		void *ptr;
-
-		ptr = operator new(size, (char*)_DEBUG_NEW_CALLER_ADDRESS, 0);
-
-		if (ptr)
-			memset(ptr, 0, size);
-
-		return ptr;
-	}
-}
-
-char *av_strdup(const char *s)
-{
-    char *ptr;
-    int len;
-    len = strlen(s) + 1;
-	ptr = (char *)operator new(len, (char*)_DEBUG_NEW_CALLER_ADDRESS, 0);
-
-    if (ptr)
-        memcpy(ptr, s, len);
-
-    return ptr;
-}
-
-void *av_realloc(void *ptr, unsigned int newsize)
-{
-	if(!ptr)
-		return operator new(newsize, (char*)_DEBUG_NEW_CALLER_ADDRESS, 0);
-	else
-		return ADM_realloc(ptr,newsize);
-}
-
-void av_free(void *ptr)
-{
-	if(ptr)
-		operator delete(ptr, (char*)_DEBUG_NEW_CALLER_ADDRESS, 0);
-}
 #endif
 // EOF

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2009-12-19 14:20:59 UTC (rev 5660)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2009-12-19 18:51:33 UTC (rev 5661)
@@ -33,4 +33,3 @@
 updatePatch libavformat movenc.c
 updatePatch libavutil avutil.h
 updatePatch libavutil internal.h
-updatePatch libavutil mem.c

Deleted: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavutil_mem.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavutil_mem.c.patch	2009-12-19 14:20:59 UTC (rev 5660)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavutil_mem.c.patch	2009-12-19 18:51:33 UTC (rev 5661)
@@ -1,202 +0,0 @@
-*** libavutil/mem.c.old	Wed Apr  1 18:35:44 2009
---- libavutil/mem.c	Wed Apr  1 18:35:44 2009
-***************
-*** 46,132 ****
-  
-  void *av_malloc(unsigned int size)
-  {
-!     void *ptr = NULL;
-! #if CONFIG_MEMALIGN_HACK
-!     long diff;
-! #endif
-  
-!     /* let's disallow possible ambiguous cases */
-!     if(size > (INT_MAX-16) )
-!         return NULL;
-! 
-! #if CONFIG_MEMALIGN_HACK
-!     ptr = malloc(size+16);
-!     if(!ptr)
-!         return ptr;
-!     diff= ((-(long)ptr - 1)&15) + 1;
-!     ptr = (char*)ptr + diff;
-!     ((char*)ptr)[-1]= diff;
-! #elif HAVE_POSIX_MEMALIGN
-!     if (posix_memalign(&ptr,16,size))
-!         ptr = NULL;
-! #elif HAVE_MEMALIGN
-!     ptr = memalign(16,size);
-!     /* Why 64?
-!        Indeed, we should align it:
-!          on 4 for 386
-!          on 16 for 486
-!          on 32 for 586, PPro - K6-III
-!          on 64 for K7 (maybe for P3 too).
-!        Because L1 and L2 caches are aligned on those values.
-!        But I don't want to code such logic here!
-!      */
-!      /* Why 16?
-!         Because some CPUs need alignment, for example SSE2 on P4, & most RISC CPUs
-!         it will just trigger an exception and the unaligned load will be done in the
-!         exception handler or it will just segfault (SSE2 on P4).
-!         Why not larger? Because I did not see a difference in benchmarks ...
-!      */
-!      /* benchmarks with P3
-!         memalign(64)+1          3071,3051,3032
-!         memalign(64)+2          3051,3032,3041
-!         memalign(64)+4          2911,2896,2915
-!         memalign(64)+8          2545,2554,2550
-!         memalign(64)+16         2543,2572,2563
-!         memalign(64)+32         2546,2545,2571
-!         memalign(64)+64         2570,2533,2558
-  
-!         BTW, malloc seems to do 8-byte alignment by default here.
-!      */
-! #else
-!     ptr = malloc(size);
-  #endif
--     return ptr;
-  }
-  
-! void *av_realloc(void *ptr, unsigned int size)
-  {
-! #if CONFIG_MEMALIGN_HACK
-!     int diff;
-! #endif
-  
-!     /* let's disallow possible ambiguous cases */
-!     if(size > (INT_MAX-16) )
-!         return NULL;
-! 
-! #if CONFIG_MEMALIGN_HACK
-!     //FIXME this isn't aligned correctly, though it probably isn't needed
-!     if(!ptr) return av_malloc(size);
-!     diff= ((char*)ptr)[-1];
-!     return (char*)realloc((char*)ptr - diff, size + diff) + diff;
-  #else
-!     return realloc(ptr, size);
-  #endif
-  }
-  
-  void av_free(void *ptr)
-  {
-!     /* XXX: this test should not be needed on most libcs */
-!     if (ptr)
-! #if CONFIG_MEMALIGN_HACK
-!         free((char*)ptr - ((char*)ptr)[-1]);
-  #else
-!         free(ptr);
-  #endif
-  }
-  
---- 46,155 ----
-  
-  void *av_malloc(unsigned int size)
-  {
-! #ifdef __APPLE__
-! 	return malloc(size);
-! #else
-! 	char *c;
-  
-! 	uint64_t l, lorg;
-! 	uint32_t *backdoor;
-  
-! 	l = (uint64_t)malloc(size + 32);
-! 
-! 	// Get next boundary
-! 	lorg = l;
-! 	l = (l + 15) & 0xfffffffffffffff0LL;
-! 	l += 16;
-! 	c = (char*)l;
-! 	backdoor = (uint32_t*)(c - 8);
-! 	*backdoor = (0xdead << 16) + l - lorg;
-! 	backdoor[1] = size;
-! 
-! 	return c;
-  #endif
-  }
-  
-! void *av_realloc(void *ptr, unsigned int newsize)
-  {
-! #ifdef __APPLE__
-! 	if (!ptr)
-! 		return av_malloc(newsize);
-! 
-! 	if (!newsize)
-! 	{
-! 		av_free(ptr);
-! 		return NULL;
-! 	}
-  
-! 	return realloc(ptr, newsize);
-  #else
-! 	void *nalloc;
-! 
-! 	if (!ptr)
-! 		return av_malloc(newsize);
-! 
-! 	if (!newsize) 
-! 	{
-! 		av_free(ptr);
-! 		return NULL;
-! 	}
-! 
-! 	// now we either shrink them or expand them
-! 	// in case of shrink, we do nothing
-! 	// in case of expand we have to copy
-! 	// Do copy everytime (slower)
-! 	uint32_t *backdoor;
-! 	uint32_t size, offset;
-! 	char *c = (char*)ptr;
-! 
-! 	backdoor = (uint32_t*)ptr;
-! 	backdoor -= 2;
-! 
-! 	assert(((*backdoor) >> 16) == 0xdead);
-! 
-! 	offset = backdoor[0] & 0xffff;
-! 	size = backdoor[1];
-! 
-! 	if(size >= newsize) // do nothing
-! 		return ptr;
-! 
-! 	// Allocate a new one
-! 	nalloc = av_malloc(newsize);
-! 	memcpy(nalloc, ptr, size);
-! 	av_free(ptr);
-! 
-! 	return nalloc;
-  #endif
-  }
-  
-  void av_free(void *ptr)
-  {
-! #ifdef __APPLE__
-! 	if (!ptr)
-! 		return;
-! 
-! 	free(ptr);
-  #else
-! 	uint32_t *backdoor;
-! 	uint32_t size, offset;
-! 	char *c = (char*)ptr;
-! 
-! 	if (!ptr)
-! 		return;
-! 
-! 	backdoor = (uint32_t*)ptr;
-! 	backdoor -= 2;
-! 
-! 	if (*backdoor == 0xbeefbeef)
-! 		assert(0);
-! 
-! 	assert(((*backdoor) >> 16) == 0xdead);
-! 
-! 	offset = backdoor[0] & 0xffff;
-! 	size = backdoor[1];
-! 	*backdoor = 0xbeefbeef; // Scratch sig
-! 
-! 	free(c - offset);
-  #endif
-  }
-  



From gruntster at mail.berlios.de  Sat Dec 19 20:29:09 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 20:29:09 +0100
Subject: [Avidemux-svn-commit] r5662 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/McDeint
Message-ID: <200912191929.nBJJT9Tw011880@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 20:29:04 +0100 (Sat, 19 Dec 2009)
New Revision: 5662

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/McDeint/CMakeLists.txt
Log:
[mcdeint] link to libavutil since it was using an override function for av_free

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/McDeint/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/McDeint/CMakeLists.txt	2009-12-19 18:51:33 UTC (rev 5661)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/McDeint/CMakeLists.txt	2009-12-19 19:29:04 UTC (rev 5662)
@@ -9,8 +9,11 @@
 add_library(ADM_libavcodec UNKNOWN IMPORTED)
 set_property(TARGET ADM_libavcodec PROPERTY IMPORTED_LOCATION "${FFMPEG_LIB_DIR}/${LIBAVCODEC_LIB}")
 
+add_library(ADM_libavutil UNKNOWN IMPORTED)
+set_property(TARGET ADM_libavutil PROPERTY IMPORTED_LOCATION "${FFMPEG_LIB_DIR}/${LIBAVUTIL_LIB}")
+
 ADD_LIBRARY(ADM_vf_mcdeint SHARED ${ADM_vf_mcdeint_SRCS})
-TARGET_LINK_LIBRARIES(ADM_vf_mcdeint ADM_libavcodec)
+TARGET_LINK_LIBRARIES(ADM_vf_mcdeint ADM_libavcodec ADM_libavutil)
 
 INIT_VIDEOFILTER_PLUGIN(ADM_vf_mcdeint)
 INSTALL_VIDEOFILTER(ADM_vf_mcdeint)



From gruntster at mail.berlios.de  Sat Dec 19 21:00:16 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 21:00:16 +0100
Subject: [Avidemux-svn-commit] r5663 - in
	branches/avidemux_2.5_branch_gruntster/avidemux:
	ADM_audiocodec ADM_codecs
Message-ID: <200912192000.nBJK0Gni014011@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 21:00:07 +0100 (Sat, 19 Dec 2009)
New Revision: 5663

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmp43.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
Log:
[ffmpeg] use av_free to clean up avcodec contexts

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp	2009-12-19 19:29:04 UTC (rev 5662)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp	2009-12-19 20:00:07 UTC (rev 5663)
@@ -110,7 +110,7 @@
  ADM_AudiocodecWMA::~ADM_AudiocodecWMA()
  {
         avcodec_close(_context);
-        ADM_dealloc(_context);
+        av_free(_context);
         _contextVoid=NULL;
 }    
 /*-------------------------------------------------------------------------------------------------------------------------

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmp43.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmp43.cpp	2009-12-19 19:29:04 UTC (rev 5662)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmp43.cpp	2009-12-19 20:00:07 UTC (rev 5663)
@@ -192,12 +192,8 @@
   _context = NULL;
   _refCopy = 0;
   _usingMT = 0;
-#if LIBAVCODEC_BUILD >= 4624
+
   _context = avcodec_alloc_context ();
-#else
-  _context = new AVCodecContext;
-  memset (_context, 0, sizeof (AVCodecContext));
-#endif
   ADM_assert (_context);
   memset (&_frame, 0, sizeof (_frame));
 
@@ -234,7 +230,7 @@
     }
 
   avcodec_close (_context);
-  ADM_dealloc (_context);
+  av_free(_context);
   delete[]_internalBuffer;
   printf ("[lavc] Destroyed\n");
 }

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-19 19:29:04 UTC (rev 5662)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-19 20:00:07 UTC (rev 5663)
@@ -59,7 +59,7 @@
     if (_context)
     {
         avcodec_close (_context);
-        ADM_dealloc (_context);
+        av_free(_context);
         _context = NULL;
     }
     return 1;



From gruntster at mail.berlios.de  Sat Dec 19 21:10:01 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 21:10:01 +0100
Subject: [Avidemux-svn-commit] r5664 - in
	branches/avidemux_2.5_branch_gruntster/avidemux:
	ADM_audiocodec ADM_codecs ADM_outputs
Message-ID: <200912192010.nBJKA1sB014933@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 21:09:57 +0100 (Sat, 19 Dec 2009)
New Revision: 5664

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmp43.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/ADM_lavformat.cpp
Log:
[ffmpeg] change usage of deprecated functions to new API

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp	2009-12-19 20:00:07 UTC (rev 5663)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_codecwma.cpp	2009-12-19 20:09:57 UTC (rev 5664)
@@ -122,6 +122,7 @@
 int max=0,pout=0;
 int16_t *run16;
 int nbChunk;
+AVPacket avpkt;
 
         *nbOut=0;
         // Shrink
@@ -139,8 +140,12 @@
         {
           nbChunk=(_tail-_head)/_blockalign;
           pout=SCRATCH_PAD_SIZE;
-          out=avcodec_decode_audio2(_context,(int16_t *)scratchPad,
-                                   &pout,_buffer+_head,nbChunk*_blockalign);
+
+		  av_init_packet(&avpkt);
+		  avpkt.data = _buffer + _head;
+		  avpkt.size = nbChunk * _blockalign;
+
+          out=avcodec_decode_audio3(_context, (int16_t *)scratchPad, &pout, &avpkt);
                 
           if(out<0)
           {

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmp43.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmp43.cpp	2009-12-19 20:00:07 UTC (rev 5663)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmp43.cpp	2009-12-19 20:09:57 UTC (rev 5664)
@@ -304,6 +304,8 @@
   int strideTab2[3];
   int ret = 0;
   out->_noPicture = 0;
+  AVPacket avpkt;
+
   if (_showMv)
     {
       _context->debug_mv |= FF_SHOW;
@@ -336,7 +338,11 @@
   
   _frame.opaque=(void *)in->demuxerFrameNo;
   
-  ret = avcodec_decode_video (_context, &_frame, &got_picture, in->data, in->dataLength);
+  av_init_packet(&avpkt);
+  avpkt.data = in->data;
+  avpkt.size = in->dataLength;
+
+  ret = avcodec_decode_video2(_context, &_frame, &got_picture, &avpkt);
   out->_qStride = 0;		//Default = no quant
   if (0 > ret && !_context->hurry_up)
     {
@@ -755,9 +761,14 @@
 {
   int ret=0;
   int got_picture=0;
-  ret=avcodec_decode_subtitle(_context, out,
-                            &got_picture,
-                            in->data, in->dataLength); 
+  AVPacket avpkt;
+
+  av_init_packet(&avpkt);
+  avpkt.data = in->data;
+  avpkt.size = in->dataLength;
+
+  ret=avcodec_decode_subtitle2(_context, out, &got_picture, &avpkt); 
+
      if(ret<0) 
      {
         printf("[lavc] FFSUB Error %d\n",ret);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/ADM_lavformat.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/ADM_lavformat.cpp	2009-12-19 20:00:07 UTC (rev 5663)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/ADM_lavformat.cpp	2009-12-19 20:09:57 UTC (rev 5664)
@@ -148,7 +148,7 @@
                 ADM_assert(0);
 		return 0;
 	}
-	oc = av_alloc_format_context();
+	oc = avformat_alloc_context();
 	if (!oc)
 	{
        		printf("Lav:Cannot allocate context\n");
@@ -712,7 +712,7 @@
                 movenc_init();
                 flvenc_init();
                 matroskaenc_init();
-                register_protocol(&file_protocol);
+                av_register_protocol(&file_protocol);
 }
 extern "C"
 {



From gruntster at mail.berlios.de  Sat Dec 19 21:16:30 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 21:16:30 +0100
Subject: [Avidemux-svn-commit] r5665 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src
Message-ID: <200912192016.nBJKGUoq015374@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 21:16:25 +0100 (Sat, 19 Dec 2009)
New Revision: 5665

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_win32.cpp
Log:
[Win32] detect Windows 7

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_win32.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_win32.cpp	2009-12-19 20:09:57 UTC (rev 5664)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_win32.cpp	2009-12-19 20:16:25 UTC (rev 5665)
@@ -210,12 +210,15 @@
 
 	if (osvi.dwPlatformId != VER_PLATFORM_WIN32_NT)
 		return false;
-// Vista
-	if (osvi.dwMajorVersion == 6 && osvi.dwMinorVersion == 0)
+// Windows Vista / Windows 7
+	if (osvi.dwMajorVersion == 6 && osvi.dwMinorVersion <= 1)
 	{
 		if (osvi.wProductType == VER_NT_WORKSTATION)
 		{
-			index += sprintf(version + index, "Microsoft Windows Vista");
+			if (osvi.dwMinorVersion == 1)
+				index += sprintf(version + index, "Microsoft Windows 7");
+			else
+				index += sprintf(version + index, "Microsoft Windows Vista");
 
 			uint32_t productType = 0;
 
@@ -278,7 +281,10 @@
 		}
 		else if (osvi.wProductType == VER_NT_SERVER)
 		{
-			index += sprintf(version + index, "Microsoft Windows Server 2008");
+			if (osvi.dwMinorVersion == 1)
+				index += sprintf(version + index, "Microsoft Windows Server 2008 R2");
+			else
+				index += sprintf(version + index, "Microsoft Windows Server 2008");
 
 			if (osvi.wSuiteMask & VER_SUITE_DATACENTER)
 				index += sprintf(version + index, " Datacenter Edition");
@@ -373,6 +379,9 @@
 	index += sprintf(version + index, " (%d.%d.%d", osvi.dwMajorVersion, osvi.dwMinorVersion, osvi.dwBuildNumber & 0xFFFF);
 
 // 64-bit Windows
+#ifdef __WIN64
+	index += sprintf(version + index, "; 64-bit");
+#else
 	bool isWow64 = false;
 	HMODULE hKernel = GetModuleHandle("kernel32.dll");
 
@@ -392,6 +401,7 @@
 		index += sprintf(version + index, "; 64-bit");
 	else
 		index += sprintf(version + index, "; 32-bit");
+#endif
 
 	index += sprintf(version + index, ")");
 	



From gruntster at mail.berlios.de  Sat Dec 19 21:23:33 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 21:23:33 +0100
Subject: [Avidemux-svn-commit] r5666 - in
	branches/avidemux_2.5_branch_gruntster/platforms/windows:
	build_scripts/avidemux build_scripts/avidemux/Tools installer
Message-ID: <200912192023.nBJKNXmi015701@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 21:23:28 +0100 (Sat, 19 Dec 2009)
New Revision: 5666

Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/touch_files.xslt
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
Log:
[Win32] bump version of installer

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml	2009-12-19 20:16:25 UTC (rev 5665)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml	2009-12-19 20:23:28 UTC (rev 5666)
@@ -1,5 +1,20 @@
 <?xml version="1.0"?>
 <log>
+  <buildentry revision="5660 [2.5.2 Final]" date="2009-12-19">
+  </buildentry>
+  <buildentry revision="5636 [2.5.2 RC1]" date="2009-12-12">
+  </buildentry>
+  <buildentry revision="5602" date="2009-11-30">
+  </buildentry>
+  <buildentry revision="5590" date="2009-11-28">
+    <comment>Updated Cairo to version 1.8.8-3.</comment>
+    <comment>Updated Fontconfig to version 2.8.0-1.</comment>
+    <comment>Updated Freetype to version 2.3.11-1.</comment>
+    <comment>Updated GLib to version 2.22.2-1.</comment>
+    <comment>Updated GTK+ to version 2.18.3-1.</comment>
+    <comment>Updated Pango to version 1.26.0-1.</comment>
+    <comment>Updated x264 to r1352.</comment>
+  </buildentry>
   <buildentry revision="5567" date="2009-11-26">
   </buildentry>
   <buildentry revision="5558" date="2009-11-24">

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/touch_files.xslt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/touch_files.xslt	2009-12-19 20:16:25 UTC (rev 5665)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/touch_files.xslt	2009-12-19 20:23:28 UTC (rev 5666)
@@ -106,7 +106,7 @@
   <xsl:template name='getFileName'>
     <xsl:param name='revision' />
 
-    <xsl:text>2.4/</xsl:text>
+    <xsl:text>2.5/</xsl:text>
 
     <xsl:choose>
       <xsl:when test="contains($revision, 'Final')">

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2009-12-19 20:16:25 UTC (rev 5665)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2009-12-19 20:23:28 UTC (rev 5666)
@@ -18,7 +18,7 @@
 !define INTERNALNAME "Avidemux 2.5"
 !define REGKEY "SOFTWARE\${INTERNALNAME}"
 !define UNINST_REGKEY "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${INTERNALNAME}"
-!define VERSION 2.5.1.${REVISION}
+!define VERSION 2.5.2.${REVISION}
 !define COMPANY "Free Software Foundation"
 !define URL "http://www.avidemux.org"
 
@@ -37,13 +37,13 @@
 
 !ifdef INST_BOTH
 OutFile ${EXEDIR}\avidemux_2.5_r${REVISION}_full_win32.exe
-Name "Avidemux 2.5.1 Full beta r${REVISION}"
+Name "Avidemux 2.5.2 Full beta r${REVISION}"
 !else ifdef INST_QT
 OutFile ${EXEDIR}\avidemux_2.5_r${REVISION}_win32.exe
-Name "Avidemux 2.5.1 beta r${REVISION}"
+Name "Avidemux 2.5.2 beta r${REVISION}"
 !else ifdef INST_GTK
 OutFile ${EXEDIR}\avidemux_2.5_r${REVISION}_gtk_win32.exe
-Name "Avidemux 2.5.1 GTK+ beta r${REVISION}"
+Name "Avidemux 2.5.2 GTK+ beta r${REVISION}"
 !endif
 
 ##########################
@@ -135,7 +135,7 @@
 XPStyle on
 ShowInstDetails nevershow
 ShowUninstDetails nevershow
-VIProductVersion 2.5.1.${REVISION}
+VIProductVersion 2.5.2.${REVISION}
 VIAddVersionKey ProductName Avidemux
 VIAddVersionKey ProductVersion "${VERSION} (beta)"
 VIAddVersionKey FileVersion ""



From gruntster at mail.berlios.de  Sat Dec 19 21:26:20 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 21:26:20 +0100
Subject: [Avidemux-svn-commit] r5667 - in
	branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts:
	. avidemux x264
Message-ID: <200912192026.nBJKQKQW016868@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 21:26:13 +0100 (Sat, 19 Dec 2009)
New Revision: 5667

Added:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1. Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1a. Prepare Build.bat
Removed:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1. Perform Build.bat
Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1b. Continue Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2. Create Packages.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Set Avidemux Environment Variables.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/x264/Perform Build.bat
Log:
[Win32] update build scripts to support 64-bit build

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat	2009-12-19 20:23:28 UTC (rev 5666)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat	2009-12-19 20:26:13 UTC (rev 5667)
@@ -5,8 +5,23 @@
 set nsisDir=%ProgramFiles32%\NSIS
 
 set devDir=E:\Dev
-set mingwDir=%devDir%\MinGW
-set msysDir=E:/Dev/MSYS
+
+if "%BuildBits%" == "32" (
+	set mingwDir=%devDir%\MinGW
+	set msysDir=E:/Dev/MSYS
+	set qtDir=%devDir%\Qt
+	goto :setVars )
+
+if "%BuildBits%" == "64" (
+	set mingwDir=%devDir%\MinGW-w64
+	set msysDir=E:/Dev/MSYS-64
+	set qtDir=%devDir%\Qt-64
+	goto :setVars )
+
+echo Error - BuildBits variable not set
+goto error
+
+:setVars
 set usrLocalDir=%msysDir%/local
 set CMAKE_INCLUDE_PATH=%usrLocalDir%/include
 set CMAKE_LIBRARY_PATH=%usrLocalDir%/lib
@@ -15,7 +30,6 @@
 set CFLAGS=-I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
 set CXXFLAGS=-I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
 set LDFLAGS=-L%CMAKE_LIBRARY_PATH%
-set qtDir=%devDir%\Qt
 
 if exist "%qtDir%" (
 	for /f %%d in ('dir /b /ad /on %qtDir%') do set qtVer=%%d
@@ -26,16 +40,6 @@
 
 set qtDir=%qtDir%\%qtVer%
 
-if exist "%devDir%\CMake 2.4\bin" (
-	set cmakeDir=%devDir%\CMake 2.4\bin
-	goto foundCMake
-)
-
-if exist "%ProgramFiles32%\CMake 2.4\bin" (
-	set cmakeDir=%ProgramFiles32%\CMake 2.4\bin
-	goto foundCMake
-)
-
 if exist "%devDir%\CMake 2.6\bin" (
 	set cmakeDir=%devDir%\CMake 2.6\bin
 	goto foundCMake
@@ -69,7 +73,7 @@
 	goto error
 )
 
-set PATH=%PATH%;%cmakeDir%;%mingwDir%\bin;%usrLocalDir%\bin;%msysDir%\bin;%qtDir%\bin
+set PATH=%PATH%;%cmakeDir%;%mingwDir%\bin;%usrLocalDir%\bin;%msysDir%\bin;%msysDir%\local32\bin;%qtDir%\bin
 
 goto end
 

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1. Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1. Build.bat	2009-12-19 20:23:28 UTC (rev 5666)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1. Build.bat	2009-12-19 20:26:13 UTC (rev 5667)
@@ -0,0 +1,30 @@
+ at echo off
+
+:start
+echo MinGW build for Avidemux
+echo ========================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo 3. Debug build
+echo X. Exit
+echo.
+
+choice /c 123x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 (
+	set DebugFlags=-DCMAKE_BUILD_TYPE=Debug
+	echo.
+	echo -- Debug mode set --
+	echo.
+	goto :start	)
+
+if errorlevel 4 goto end
+
+verify >nul
+echo.
+
+call "1a. Prepare Build"
+
+:end
\ No newline at end of file

Deleted: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1. Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1. Perform Build.bat	2009-12-19 20:23:28 UTC (rev 5666)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1. Perform Build.bat	2009-12-19 20:26:13 UTC (rev 5667)
@@ -1,38 +0,0 @@
- at echo off
-
-set curDir=%CD%
-call "Set Avidemux Environment Variables"
-
-if errorlevel 1 goto error
-
-cd "%sourceDir%"
-echo Cleaning build directories
-rmdir /s /q build 2> NUL
-
-cd "%sourceDir%\plugins"
-rmdir /s /q build 2> NUL
-
-if exist build goto removalFailure
-cd "%sourceDir%"
-if exist build goto removalFailure
-
-mkdir build
-mkdir plugins\build
-
-echo Performing Subversion update
-svn up .
-
-cd %curDir%
-call "1b. Continue Build"
-
-goto end
-
-:removalFailure
-echo ERROR - build directories could not be fully deleted.
-echo Aborting.
-
-:error
-set ERRORLEVEL=1
-
-:end
-pause
\ No newline at end of file

Copied: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1a. Prepare Build.bat (from rev 5654, branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1. Perform Build.bat)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1. Perform Build.bat	2009-12-12 07:58:51 UTC (rev 5654)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1a. Prepare Build.bat	2009-12-19 20:26:13 UTC (rev 5667)
@@ -0,0 +1,38 @@
+ at echo off
+
+set curDir=%CD%
+call "Set Avidemux Environment Variables"
+
+if errorlevel 1 goto error
+
+cd "%sourceDir%"
+echo Cleaning build directory (%CD%\%BuildFolder%)
+rmdir /s /q %buildFolder% 2> NUL
+
+cd "%sourceDir%\plugins"
+rmdir /s /q %buildFolder% 2> NUL
+
+if exist %buildFolder% goto removalFailure
+cd "%sourceDir%"
+if exist %buildFolder% goto removalFailure
+
+mkdir %buildFolder%
+mkdir plugins\%buildFolder%
+
+echo Performing Subversion update
+svn up .
+
+cd %curDir%
+call "1b. Continue Build"
+
+goto end
+
+:removalFailure
+echo ERROR - build directories could not be fully deleted.
+echo Aborting.
+
+:error
+set ERRORLEVEL=1
+pause
+
+:end

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1b. Continue Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1b. Continue Build.bat	2009-12-19 20:23:28 UTC (rev 5666)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1b. Continue Build.bat	2009-12-19 20:26:13 UTC (rev 5667)
@@ -3,28 +3,26 @@
 call "Set Avidemux Environment Variables"
 if errorlevel 1 goto error
 
-cd "%sourceDir%\build"
-cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DCMAKE_EXE_LINKER_FLAGS="-shared-libgcc" -DCMAKE_SHARED_LINKER_FLAGS="-shared-libgcc" -DUSE_SYSTEM_SPIDERMONKEY=ON -DCMAKE_INCLUDE_PATH="%SpiderMonkeySourceDir%" -DCMAKE_LIBRARY_PATH="%SpiderMonkeyLibDir%" ..
+cd "%sourceDir%\%buildFolder%"
+cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DCMAKE_EXE_LINKER_FLAGS="-shared-libgcc" -DCMAKE_SHARED_LINKER_FLAGS="-shared-libgcc" -DUSE_SYSTEM_SPIDERMONKEY=ON -DCMAKE_INCLUDE_PATH="%SpiderMonkeySourceDir%" -DCMAKE_LIBRARY_PATH="%SpiderMonkeyLibDir%" %DebugFlags% ..
 
 if errorlevel 1 goto error
 pause
 
 set msysSourceDir=%sourceDir:\=/%
-cd "%sourceDir%\plugins\build"
-cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_CORECONFIG_DIR="%msysSourceDir%/build/config" -DAVIDEMUX_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_SOURCE_DIR="%msysSourceDir%" -DCMAKE_EXE_LINKER_FLAGS="-shared-libgcc" -DCMAKE_SHARED_LINKER_FLAGS="-shared-libgcc" ..
+cd "%sourceDir%\plugins\%buildFolder%"
+cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_CORECONFIG_DIR="%msysSourceDir%/build/config" -DAVIDEMUX_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_SOURCE_DIR="%msysSourceDir%" -DCMAKE_EXE_LINKER_FLAGS="-shared-libgcc" -DCMAKE_SHARED_LINKER_FLAGS="-shared-libgcc" %DebugFlags% ..
 
 if errorlevel 1 goto error
 pause
 
-cd "%sourceDir%\build"
+cd "%sourceDir%\%buildFolder%"
 make install
 
-cd "%sourceDir%\plugins\build"
+cd "%sourceDir%\plugins\%buildFolder%"
 make install
 
 del /s "%buildDir%\*.a"
-del "%buildDir%\plugins\audioDecoder\libADM_ad_dca.dll"
-del "%buildDir%\plugins\audioDecoder\libADM_ad_amrnb.dll"
 
 echo Finished!
 goto end

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2. Create Packages.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2. Create Packages.bat	2009-12-19 20:23:28 UTC (rev 5666)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2. Create Packages.bat	2009-12-19 20:26:13 UTC (rev 5667)
@@ -1,8 +1,10 @@
- at call "2a. Update Notes.bat"
+ at echo off
 
+call "2a. Update Notes.bat"
+
 if errorlevel 1 goto error
 
- at call "2b. Package Build.bat"
+call "2b. Package Build.bat"
 
 goto end
 

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Set Avidemux Environment Variables.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Set Avidemux Environment Variables.bat	2009-12-19 20:23:28 UTC (rev 5666)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Set Avidemux Environment Variables.bat	2009-12-19 20:26:13 UTC (rev 5667)
@@ -26,7 +26,10 @@
 	goto error
 )
 
-set buildDir=%devDir%\avidemux_2.5_build
+if "%BuildBits%" == "32" (set buildFolder=build)
+if "%BuildBits%" == "64" (set buildFolder=build64)
+
+set buildDir=%devDir%\avidemux_2.5_%buildFolder%
 set curDir=%CD%
 cd ..\..\..\..
 set sourceDir=%CD%
@@ -37,9 +40,12 @@
 	goto error
 )
 
-set SpiderMonkeySourceDir=%devDir%\js\src
-set SpiderMonkeyLibDir=%devDir%\js\src\WINNT6.0_OPT.OBJ
+if "%BuildBits%" == "32" (set jsFolder=js)
+if "%BuildBits%" == "64" (set jsFolder=js-64)
 
+set SpiderMonkeySourceDir=%devDir%\%jsFolder%\src
+set SpiderMonkeyLibDir=%devDir%\%jsFolder%\src\WINNT6.0_OPT.OBJ
+
 goto end
 
 :error

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/x264/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/x264/Perform Build.bat	2009-12-19 20:23:28 UTC (rev 5666)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/x264/Perform Build.bat	2009-12-19 20:26:13 UTC (rev 5667)
@@ -1,5 +1,19 @@
 @echo off
 
+echo MSYS build for x264
+echo ===================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto :eof
+
+verify >nul
 call "../Set Common Environment Variables"
 
 if errorlevel 1 goto error
@@ -10,21 +24,32 @@
 del "%usrLocalDir%\include\x264.h"
 cd "%devDir%"
 
-rm -r -f x264
+if "%BuildBits%" == "32" (
+	set sourceFolder=x264
+	set buildFolder=build
+)
 
+if "%BuildBits%" == "64" (
+	set sourceFolder=x264-64
+	set buildFolder=build64
+	set configFlags=--host=x86_64-pc-mingw32
+)
+
+rm -r -f %sourceFolder%
+
 echo Downloading from git
-git clone git://git.videolan.org/x264.git
+git clone git://git.videolan.org/x264.git %sourceFolder%
 if errorlevel 1 goto end
 
-cd "%devDir%/x264"
-sh ./configure --prefix=/usr/local --enable-shared
+cd "%devDir%/%sourceFolder%"
+sh ./configure --prefix=/usr/local --enable-shared %configFlags%
 if errorlevel 1 goto end
 
 make install
 if errorlevel 1 goto end
 
-del "%devDir%\avidemux_2.5_build\libx264-*.dll"
-copy "%usrLocalDir%/bin/libx264-*.dll" "%devDir%\avidemux_2.5_build"
+del "%devDir%\avidemux_2.5_%buildFolder%\libx264-*.dll"
+copy "%usrLocalDir%/bin/libx264-*.dll" "%devDir%\avidemux_2.5_%buildFolder%"
 
 :end
 pause
\ No newline at end of file



From gruntster at mail.berlios.de  Sat Dec 19 21:28:35 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 21:28:35 +0100
Subject: [Avidemux-svn-commit] r5668 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src
Message-ID: <200912192028.nBJKSZSQ017056@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 21:28:30 +0100 (Sat, 19 Dec 2009)
New Revision: 5668

Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/gtkmarkscale.c
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/gtkmarkscale.h
Log:
[GTK] remove unused files

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/gtkmarkscale.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/gtkmarkscale.c	2009-12-19 20:26:13 UTC (rev 5667)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/gtkmarkscale.c	2009-12-19 20:28:30 UTC (rev 5668)
@@ -1,165 +0,0 @@
-#include "gtkmarkscale.h"
-
-static GtkWidgetClass *parent_class = NULL;
-
-static gboolean gtk_markscale_expose (GtkWidget *widget, GdkEventExpose *event);
-
-static void gtk_markscale_realize (GtkWidget *widget);
-
-G_DEFINE_TYPE (GtkMarkScale, gtk_markscale, GTK_TYPE_SCALE)
-
-
-uint32_t markA;
-uint32_t markB;
-uint32_t nbFrames;
-
-static void
-gtk_markscale_class_init (GtkMarkScaleClass *class)
-{
-  GtkWidgetClass *widget_class;
-  GtkRangeClass *range_class;
-  GtkScaleClass *scale_class;
-  parent_class = g_type_class_peek_parent(class);
-  widget_class = GTK_WIDGET_CLASS (class);
-  range_class = GTK_RANGE_CLASS (class);
-  scale_class = GTK_SCALE_CLASS (class);
-  
-  range_class->slider_detail = "hscale";
-  
-  widget_class->expose_event = gtk_markscale_expose;
-  widget_class->realize = gtk_markscale_realize;
-}
-
-static void
-gtk_markscale_init (GtkMarkScale *markscale)
-{
-  GtkRange *range;
-
-  range = GTK_RANGE (markscale);
-
-  range->orientation = GTK_ORIENTATION_HORIZONTAL;
-  range->flippable = TRUE;
-  markA = 0;
-  markB = 0;
-  nbFrames = 0;
-}
-
-void gtk_markscale_setA(GtkWidget *widget, uint32_t a)
-{
-	markA = a;
-}
-
-void gtk_markscale_setB(GtkWidget *widget, uint32_t b)
-{
-	markB = b;
-	GdkRectangle rect;
-	rect.x = widget->allocation.x;
-	rect.y = widget->allocation.y;
-	rect.width = widget->allocation.width;
-	rect.height = widget->allocation.height;
-	gdk_window_invalidate_rect(widget->window, &rect, FALSE);
-}
-
-void gtk_markscale_setNbFrames(GtkWidget *widget, uint32_t total)
-{
-	nbFrames = total;
-}
-
-GtkWidget*
-gtk_markscale_new (GtkAdjustment *adjustment)
-{
-  return g_object_new (GTK_TYPE_MARKSCALE, "adjustment", adjustment, NULL);
-}
-
-static void gtk_markscale_realize (GtkWidget *widget)
-{
-	parent_class->realize(widget);
-	gtk_widget_set_size_request(widget, widget->allocation.width, widget->allocation.height+10);
-}
-
-static gboolean
-gtk_markscale_expose (GtkWidget      *widget,
-                   GdkEventExpose *event)
-{
-  GtkScale *scale;
-  
-  scale = GTK_SCALE (widget);
-
-  if (GTK_WIDGET_CLASS (gtk_markscale_parent_class)->expose_event)
-    GTK_WIDGET_CLASS (gtk_markscale_parent_class)->expose_event (widget, event);
-
-      gint x, y;
-      GtkStateType state_type;
-      state_type = GTK_STATE_NORMAL;
-      if (!GTK_WIDGET_IS_SENSITIVE (scale))
-        state_type = GTK_STATE_INSENSITIVE;
-	
-	if (nbFrames>1)
-	{
-		GdkGC *gc = gdk_gc_new(widget->window);
-	
-		int width = widget->allocation.width;
-		int start = widget->allocation.x + (int)floor((width-1)*((float)markA/(nbFrames-1)));
-		int end =  widget->allocation.x + (int)floor((width-1)*((float)markB/(nbFrames-1)));
-		int top = widget->allocation.y + 1;
-		int bottom = widget->allocation.y + widget->allocation.height - 2;
-		
-	//mark A:
-		gdk_draw_line (widget->window,
-					   gc,
-					   start,
-					   top,
-					   start+4,
-					   top);
-		gdk_draw_line (widget->window,
-					   gc,
-					   start,
-					   top,
-					   start,
-					   top+4);
-	
-		gdk_draw_line (widget->window,
-					   gc,
-					   start,
-					   bottom,
-					   start+4,
-					   bottom);
-		gdk_draw_line (widget->window,
-					   gc,
-					   start,
-					   bottom - 4,
-					   start,
-					   bottom);
-	
-	//mark B:
-		gdk_draw_line (widget->window,
-					   gc,
-					   end,
-					   top,
-					   end-4,
-					   top);
-		gdk_draw_line (widget->window,
-					   gc,
-					   end,
-					   top,
-					   end,
-					   top+4);
-	
-		gdk_draw_line (widget->window,
-					   gc,
-					   end,
-					   bottom,
-					   end-4,
-					   bottom);
-		gdk_draw_line (widget->window,
-					   gc,
-					   end,
-					   bottom-4,
-					   end,
-					   bottom);
-	}
-  return FALSE;
-}
-
-
-#define __GTK_MARKSCALE_C__

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/gtkmarkscale.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/gtkmarkscale.h	2009-12-19 20:26:13 UTC (rev 5667)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/gtkmarkscale.h	2009-12-19 20:28:30 UTC (rev 5668)
@@ -1,45 +0,0 @@
-#ifndef __GTK_MARKSCALE_H__
-#define __GTK_MARKSCALE_H__
-
-
-#include <gdk/gdk.h>
-#include <gtk/gtkscale.h>
-#include <stdint.h>
-
-G_BEGIN_DECLS
-
-#define GTK_TYPE_MARKSCALE            (gtk_markscale_get_type ())
-#define GTK_MARKSCALE(obj)            (G_TYPE_CHECK_INSTANCE_CAST ((obj), GTK_TYPE_MARKSCALE, GtkMarkScale))
-#define GTK_MARKSCALE_CLASS(klass)    (G_TYPE_CHECK_CLASS_CAST ((klass), GTK_TYPE_MARKSCALE, GtkMarkScaleClass))
-#define GTK_IS_MARKSCALE(obj)         (G_TYPE_CHECK_INSTANCE_TYPE ((obj), GTK_TYPE_MARKSCALE))
-#define GTK_IS_MARKSCALE_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), GTK_TYPE_MARKSCALE))
-#define GTK_MARKSCALE_GET_CLASS(obj)  (G_TYPE_INSTANCE_GET_CLASS ((obj), GTK_TYPE_MARKSCALE, GtkMarkScaleClass))
-
-
-typedef struct _GtkMarkScale       GtkMarkScale;
-typedef struct _GtkMarkScaleClass  GtkMarkScaleClass;
-
-struct _GtkMarkScale
-{
-  GtkScale scale;
-};
-
-struct _GtkMarkScaleClass
-{
-  GtkScaleClass parent_class;
-};
-
-
-GType      gtk_markscale_get_type       (void) G_GNUC_CONST;
-GtkWidget* gtk_markscale_new            (GtkAdjustment *adjustment);
-GtkWidget* gtk_markscale_new_with_range (gdouble        min,
-                                      gdouble        max,
-                                      gdouble        step);
-
-void gtk_markscale_setA(GtkWidget *widget, uint32_t a);
-void gtk_markscale_setB(GtkWidget *widget, uint32_t b);
-void gtk_markscale_setNbFrames(GtkWidget *widget, uint32_t total);
-
-G_END_DECLS
-
-#endif /* __GTK_MARKSCALE_H__ */



From gruntster at mail.berlios.de  Sat Dec 19 21:30:52 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 21:30:52 +0100
Subject: [Avidemux-svn-commit] r5669 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML
Message-ID: <200912192030.nBJKUqDN017230@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 21:30:48 +0100 (Sat, 19 Dec 2009)
New Revision: 5669

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML/ADM_openDML.cpp
Log:
[odml] fix calculation of extra data - use struct size not pointer size

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML/ADM_openDML.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML/ADM_openDML.cpp	2009-12-19 20:28:30 UTC (rev 5668)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML/ADM_openDML.cpp	2009-12-19 20:30:48 UTC (rev 5669)
@@ -366,7 +366,7 @@
                                         }
                                         // now read extra stuff
                                         fseeko(_fd,_Tracks[run].strf.offset,SEEK_SET);		
-                                        extra=_Tracks[run].strf.size-sizeof(_wavHeader);
+                                        extra=_Tracks[run].strf.size-sizeof(WAVHeader);
                                         if(extra<0)
                                         {	
                                                 printf("WavHeader is not big enough (%lu/%lu)!\n",



From gruntster at mail.berlios.de  Sat Dec 19 21:34:28 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 21:34:28 +0100
Subject: [Avidemux-svn-commit] r5670 - in
	branches/avidemux_2.5_branch_gruntster/avidemux:
	ADM_audiofilter ADM_filter ADM_inputs/ADM_mp4
	ADM_inputs/ADM_openDML ADM_libraries/ADM_utilities
	ADM_toolkit ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk
Message-ID: <200912192034.nBJKYSvp017399@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 21:34:21 +0100 (Sat, 19 Dec 2009)
New Revision: 5670

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiodeng_buildfilters.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_filter/vidVCD.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4/ADM_mp4Analyzer.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML/ADM_odml_odml.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/automation.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/gtkmarkscale.c
Log:
[general] tweaks to remove unnecessary compiler warning

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiodeng_buildfilters.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiodeng_buildfilters.cpp	2009-12-19 20:30:48 UTC (rev 5669)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiodeng_buildfilters.cpp	2009-12-19 20:34:21 UTC (rev 5670)
@@ -62,7 +62,8 @@
         {AudioAC3,"AC3"},
         {AudioNone,"NONE"}
 };
-typedef struct Mixer_String
+
+struct Mixer_String
 {
   const char         *name;
   CHANNEL_CONF conf;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_filter/vidVCD.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_filter/vidVCD.cpp	2009-12-19 20:30:48 UTC (rev 5669)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_filter/vidVCD.cpp	2009-12-19 20:34:21 UTC (rev 5670)
@@ -60,7 +60,7 @@
                                                                 {1.,1.066667,1.43} // PAL  1:1 4:3 16:9
                                                         };
 
-typedef struct targetFmt
+struct targetFmt
 {
         int x1,x2,y1,y2;
 };

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4/ADM_mp4Analyzer.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4/ADM_mp4Analyzer.cpp	2009-12-19 20:30:48 UTC (rev 5669)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4/ADM_mp4Analyzer.cpp	2009-12-19 20:34:21 UTC (rev 5670)
@@ -1108,7 +1108,7 @@
             uint32_t  cel=0;
             for(uint32_t i=0;i<scope;i++)
             {
-              if(info->Ctts[i]>4294967290)
+              if(info->Ctts[i]>4294967290UL)
               {
                 if(i)
                   info->Ctts[i]=info->Ctts[0];

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML/ADM_odml_odml.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML/ADM_odml_odml.cpp	2009-12-19 20:30:48 UTC (rev 5669)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_openDML/ADM_odml_odml.cpp	2009-12-19 20:34:21 UTC (rev 5670)
@@ -47,7 +47,6 @@
 	uint32_t	chunkId;
 	uint32_t	reserver[3];
 }  PPACKED;
-typedef struct OPENDML_INDEX;
 
 struct OPENDML_ENTRY
 {
@@ -55,7 +54,6 @@
 	uint32_t	size;
 	uint32_t	duration;
 } PPACKED;
-typedef struct OPENDML_ENTRY;
     
 struct OPENML_SECONDARY_INDEX
 {
@@ -67,7 +65,6 @@
 	uint64_t	base;
 	uint32_t	reserver;
 } PPACKED;
-typedef struct OPENML_SECONDARY_INDEX;
 
  static int readMasterIndex(OPENDML_INDEX *index,FILE *fd);
  static int readSuperEntries(OPENDML_ENTRY *entries,int count,FILE *fd);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp	2009-12-19 20:30:48 UTC (rev 5669)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/avidemutils.cpp	2009-12-19 20:34:21 UTC (rev 5670)
@@ -310,7 +310,7 @@
 
 }
 /* Compute aspect ration from common ARWidth / AR Height value */
-typedef struct ARDescriptor
+struct ARDescriptor
 {
   int width;
   int height;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/automation.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/automation.cpp	2009-12-19 20:30:48 UTC (rev 5669)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/automation.cpp	2009-12-19 20:34:21 UTC (rev 5670)
@@ -132,7 +132,7 @@
 typedef	void (*three_arg_type)(char *arg,char *otherarg,char *yetother);
 //_________________________________________________________________________
 
-typedef struct AUTOMATON
+struct AUTOMATON
 {
           const char    *string;
           uint8_t       have_arg;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/gtkmarkscale.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/gtkmarkscale.c	2009-12-19 20:30:48 UTC (rev 5669)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/gtkmarkscale.c	2009-12-19 20:34:21 UTC (rev 5670)
@@ -1,3 +1,5 @@
+#include <math.h>
+
 #include "gtkmarkscale.h"
 
 static GtkWidgetClass *parent_class = NULL;



From gruntster at mail.berlios.de  Sat Dec 19 21:41:17 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 21:41:17 +0100
Subject: [Avidemux-svn-commit] r5671 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Srt
Message-ID: <200912192041.nBJKfHQ8017769@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 21:41:13 +0100 (Sat, 19 Dec 2009)
New Revision: 5671

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Srt/ADM_vidSRTload.cpp
Log:
[Win64] compilation fix for srt plugin

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Srt/ADM_vidSRTload.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Srt/ADM_vidSRTload.cpp	2009-12-19 20:34:21 UTC (rev 5670)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Srt/ADM_vidSRTload.cpp	2009-12-19 20:41:13 UTC (rev 5671)
@@ -394,7 +394,7 @@
 uint8_t	ADM_utfInit( char *charset )
 {
 	myConv=iconv_open("UTF-16",charset); //"WINDOWS-1251");
-	if((long int)myConv==-1)
+	if((intptr_t)myConv==-1)
 	{
 		printf("\n Error initializing iconv...\n");
 		return  0;
@@ -474,7 +474,7 @@
 uint8_t ADM_utfEnd( void)
 {
   // Purge iconv
-  if((long int)myConv!=-1)
+  if((intptr_t)myConv!=-1)
 	{
 		iconv_close(myConv);
 		myConv=(iconv_t)-1;



From gruntster at mail.berlios.de  Sat Dec 19 22:56:36 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 22:56:36 +0100
Subject: [Avidemux-svn-commit] r5672 - branches/avidemux_2.5_branch_gruntster
Message-ID: <200912192156.nBJLua04022384@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 22:56:32 +0100 (Sat, 19 Dec 2009)
New Revision: 5672

Modified:
   branches/avidemux_2.5_branch_gruntster/CMakeLists.txt
Log:
[general] bump version

Modified: branches/avidemux_2.5_branch_gruntster/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/CMakeLists.txt	2009-12-19 20:41:13 UTC (rev 5671)
+++ branches/avidemux_2.5_branch_gruntster/CMakeLists.txt	2009-12-19 21:56:32 UTC (rev 5672)
@@ -97,7 +97,7 @@
 ########################################
 # Standard Avidemux defines
 ########################################
-SET(VERSION 2.5.1)
+SET(VERSION 2.5.2)
 
 # Define internal flags for GTK+ and Qt4 builds.  These are turned off
 # if a showstopper is found.  CLI is automatically assumed as possible



From gruntster at mail.berlios.de  Sat Dec 19 23:37:50 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 23:37:50 +0100
Subject: [Avidemux-svn-commit] r5673 - in
	branches/avidemux_2.5_branch_gruntster/cmake: . patches
Message-ID: <200912192237.nBJMbouv025456@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 23:37:44 +0100 (Sat, 19 Dec 2009)
New Revision: 5673

Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo_enc.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_movenc.c.patch
Log:
[ffmpeg] update FFmpeg to r20900 & libswscale r30075

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2009-12-19 21:56:32 UTC (rev 5672)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2009-12-19 22:37:44 UTC (rev 5673)
@@ -1,7 +1,7 @@
 include(admFFmpegUtil)
 
-set(FFMPEG_VERSION 20602)	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=cd19c43eca5350279332e3112f51fc0442531b54;sf=tgz
-set(SWSCALE_VERSION 29964)	# http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=abcb4191ddc81061de1b0083ea06d364836d616d;sf=tgz
+set(FFMPEG_VERSION 20900)	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=c2a40c2de2f3b764180c6e74e8c2a88d2f56dfac;sf=tgz
+set(SWSCALE_VERSION 30075)	# http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=8158fe4ce45496fb7ded193cd9d64e9e75268be4;sf=tgz
 
 set(LIBRARY_SOURCE_DIR "${CMAKE_SOURCE_DIR}/avidemux/ADM_libraries")
 set(FFMPEG_SOURCE_DIR "${LIBRARY_SOURCE_DIR}/ffmpeg")

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2009-12-19 21:56:32 UTC (rev 5672)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2009-12-19 22:37:44 UTC (rev 5673)
@@ -1,19 +1,19 @@
-*** libavcodec/avcodec.h.old	Tue Nov 24 18:57:43 2009
---- libavcodec/avcodec.h	Tue Nov 24 18:57:43 2009
+*** libavcodec/avcodec.h.old	Sat Dec 19 22:15:38 2009
+--- libavcodec/avcodec.h	Sat Dec 19 22:15:38 2009
 ***************
-*** 580,585 ****
---- 580,587 ----
-  #define CODEC_FLAG2_CHUNKS        0x00008000 ///< Input bitstream might be truncated at a packet boundaries instead of only at frame boundaries.
+*** 583,588 ****
+--- 583,590 ----
   #define CODEC_FLAG2_NON_LINEAR_QUANT 0x00010000 ///< Use MPEG-2 nonlinear quantizer.
   #define CODEC_FLAG2_BIT_RESERVOIR 0x00020000 ///< Use a bit reservoir when encoding if possible
+  #define CODEC_FLAG2_MBTREE        0x00040000 ///< Use macroblock tree ratecontrol (x264 only)
 + //MEANX: NEVER EVER USE CLOSED GOP ?
-+ #define CODEC_FLAG2_32_PULLDOWN   0x80000000 
++ #define CODEC_FLAG2_32_PULLDOWN   0x80000000
   
   /* Unsupported options :
    *              Syntax Arithmetic coding (SAC)
 ***************
-*** 1438,1443 ****
---- 1440,1446 ----
+*** 1441,1446 ****
+--- 1443,1449 ----
        * - decoding: unused
        */
       int rc_max_rate;
@@ -22,8 +22,8 @@
       /**
        * minimum bitrate
 ***************
-*** 1452,1457 ****
---- 1455,1462 ----
+*** 1455,1460 ****
+--- 1458,1465 ----
        * - decoding: unused
        */
       int rc_buffer_size;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2009-12-19 21:56:32 UTC (rev 5672)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2009-12-19 22:37:44 UTC (rev 5673)
@@ -1,8 +1,8 @@
-*** libavcodec/h264.c.old	Tue Nov 24 18:57:52 2009
---- libavcodec/h264.c	Tue Nov 24 18:57:52 2009
+*** libavcodec/h264.c.old	Sat Dec 19 22:15:48 2009
+--- libavcodec/h264.c	Sat Dec 19 22:15:48 2009
 ***************
-*** 8161,8166 ****
---- 8161,8177 ----
+*** 8158,8163 ****
+--- 8158,8174 ----
       return 0;
   }
   

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12.c.patch	2009-12-19 21:56:32 UTC (rev 5672)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12.c.patch	2009-12-19 22:37:44 UTC (rev 5673)
@@ -1,8 +1,8 @@
-*** libavcodec/mpeg12.c.old	Sat Jun 27 18:45:12 2009
---- libavcodec/mpeg12.c	Sat Jun 27 18:45:11 2009
+*** libavcodec/mpeg12.c.old	Sat Dec 19 22:15:50 2009
+--- libavcodec/mpeg12.c	Sat Dec 19 22:15:50 2009
 ***************
-*** 1962,1967 ****
---- 1962,1972 ----
+*** 1946,1951 ****
+--- 1946,1956 ----
           ff_er_frame_end(s);
   
           MPV_frame_end(s);

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo_enc.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo_enc.c.patch	2009-12-19 21:56:32 UTC (rev 5672)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo_enc.c.patch	2009-12-19 22:37:44 UTC (rev 5673)
@@ -1,8 +1,8 @@
-*** libavcodec/mpegvideo_enc.c.old	Sun Jan 25 00:55:20 2009
---- libavcodec/mpegvideo_enc.c	Sun Jan 25 00:55:19 2009
+*** libavcodec/mpegvideo_enc.c.old	Sat Dec 19 22:15:57 2009
+--- libavcodec/mpegvideo_enc.c	Sat Dec 19 22:15:58 2009
 ***************
-*** 349,360 ****
---- 349,362 ----
+*** 363,374 ****
+--- 363,376 ----
   
           av_log(avctx, AV_LOG_INFO, "Warning vbv_delay will be set to 0xFFFF (=VBR) as the specified vbv buffer is too large for the given bitrate!\n");
       }
@@ -18,8 +18,8 @@
       if(s->obmc && s->avctx->mb_decision != FF_MB_DECISION_SIMPLE){
           av_log(avctx, AV_LOG_ERROR, "OBMC is only supported with simple mb decision\n");
 ***************
-*** 387,396 ****
---- 389,400 ----
+*** 409,418 ****
+--- 411,422 ----
           return -1;
       }
   

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2009-12-19 21:56:32 UTC (rev 5672)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2009-12-19 22:37:44 UTC (rev 5673)
@@ -1,8 +1,8 @@
-*** libavcodec/utils.c.old	Tue Nov 24 18:58:03 2009
---- libavcodec/utils.c	Tue Nov 24 18:58:03 2009
+*** libavcodec/utils.c.old	Sat Dec 19 22:15:59 2009
+--- libavcodec/utils.c	Sat Dec 19 22:16:00 2009
 ***************
-*** 614,623 ****
---- 614,625 ----
+*** 616,625 ****
+--- 616,627 ----
   
       if((avctx->codec->capabilities & CODEC_CAP_DELAY) || avpkt->size){
           //FIXME remove the check below _after_ ensuring that all audio check that the available space is enough
@@ -16,7 +16,7 @@
           *frame_size_ptr < avctx->channels * avctx->frame_size * sizeof(int16_t)){
               av_log(avctx, AV_LOG_ERROR, "buffer %d too small\n", *frame_size_ptr);
 ***************
-*** 1051,1057 ****
+*** 1053,1059 ****
           return -1;
       }
   #if !HAVE_MKSTEMP
@@ -24,7 +24,7 @@
   #else
       snprintf(*filename, len, "/tmp/%sXXXXXX", prefix);
       fd = mkstemp(*filename);
---- 1053,1059 ----
+--- 1055,1061 ----
           return -1;
       }
   #if !HAVE_MKSTEMP

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch	2009-12-19 21:56:32 UTC (rev 5672)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch	2009-12-19 22:37:44 UTC (rev 5673)
@@ -1,7 +1,7 @@
-*** libavformat/isom.c.old	Tue Nov 24 18:58:10 2009
---- libavformat/isom.c	Tue Nov 24 18:58:10 2009
+*** libavformat/isom.c.old	Sat Dec 19 22:16:07 2009
+--- libavformat/isom.c	Sat Dec 19 22:16:07 2009
 ***************
-*** 200,206 ****
+*** 203,209 ****
       { CODEC_ID_MP1, MKTAG('.', 'm', 'p', '1') }, /* MPEG layer 1 */
       { CODEC_ID_MP2, MKTAG('.', 'm', 'p', '2') }, /* MPEG layer 2 */
   
@@ -9,7 +9,7 @@
       { CODEC_ID_MP3, 0x6D730055 }, /* MPEG layer 3 */
   
   /*  { CODEC_ID_OGG_VORBIS, MKTAG('O', 'g', 'g', 'S') }, *//* sample files at http://heroinewarrior.com/xmovie.php3 use this tag */
---- 200,209 ----
+--- 203,212 ----
       { CODEC_ID_MP1, MKTAG('.', 'm', 'p', '1') }, /* MPEG layer 1 */
       { CODEC_ID_MP2, MKTAG('.', 'm', 'p', '2') }, /* MPEG layer 2 */
   

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_movenc.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_movenc.c.patch	2009-12-19 21:56:32 UTC (rev 5672)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_movenc.c.patch	2009-12-19 22:37:44 UTC (rev 5673)
@@ -1,8 +1,8 @@
-*** libavformat/movenc.c.old	Tue Nov 24 18:58:13 2009
---- libavformat/movenc.c	Tue Nov 24 18:58:13 2009
+*** libavformat/movenc.c.old	Sat Dec 19 22:16:15 2009
+--- libavformat/movenc.c	Sat Dec 19 22:16:15 2009
 ***************
-*** 2066,2068 ****
---- 2066,2080 ----
+*** 2135,2137 ****
+--- 2135,2149 ----
       .codec_tag = (const AVCodecTag* const []){codec_ipod_tags, 0},
   };
   #endif



From gruntster at mail.berlios.de  Sat Dec 19 23:49:38 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sat, 19 Dec 2009 23:49:38 +0100
Subject: [Avidemux-svn-commit] r5674 -
	branches/avidemux_2.5_branch_gruntster/cmake
Message-ID: <200912192249.nBJMncPu026038@sheep.berlios.de>

Author: gruntster
Date: 2009-12-19 23:49:33 +0100 (Sat, 19 Dec 2009)
New Revision: 5674

Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
Log:
[ffmpeg] no need to build ffplay

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2009-12-19 22:37:44 UTC (rev 5673)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2009-12-19 22:49:33 UTC (rev 5674)
@@ -16,7 +16,7 @@
 set(FFMPEG_PROTOCOLS  file)
 set(FFMPEG_FLAGS  --enable-shared --disable-static --disable-filters --disable-protocols --disable-indevs --disable-outdevs --disable-bsfs
 				  --disable-parsers --disable-decoders --disable-encoders --disable-demuxers --disable-muxers --enable-postproc --enable-gpl 
-				  --enable-runtime-cpudetect --prefix=${CMAKE_INSTALL_PREFIX})
+				  --enable-runtime-cpudetect --disable-ffplay --prefix=${CMAKE_INSTALL_PREFIX})
 
 include(admFFmpegPatch)
 include(admFFmpegPrepareTar)



From gruntster at mail.berlios.de  Sun Dec 20 00:28:35 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 20 Dec 2009 00:28:35 +0100
Subject: [Avidemux-svn-commit] r5675 - in
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core:
	include src
Message-ID: <200912192328.nBJNSZbJ028066@sheep.berlios.de>

Author: gruntster
Date: 2009-12-20 00:28:29 +0100 (Sun, 20 Dec 2009)
New Revision: 5675

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_memsupport.cpp
Log:
[Win64] disable custom memory functions for Win64 since Qt doesn't like it and mingw-w64 allocates 4-byte aligned

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h	2009-12-19 22:49:33 UTC (rev 5674)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h	2009-12-19 23:28:29 UTC (rev 5675)
@@ -78,7 +78,7 @@
 #define access	ADM_access
 #endif
 
-#ifndef __APPLE__
+#if !defined(__APPLE__) && !defined(__WIN64)
 #ifndef ADM_LEGACY_PROGGY
   #define malloc #error
   #define realloc #error

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_memsupport.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_memsupport.cpp	2009-12-19 22:49:33 UTC (rev 5674)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_memsupport.cpp	2009-12-19 23:28:29 UTC (rev 5675)
@@ -80,7 +80,7 @@
 
 void *ADM_alloc(size_t size)
 {
-#ifdef __APPLE__
+#if defined(__APPLE__) || defined(__WIN64)
 	return malloc(size);
 #else
 	char *c;
@@ -114,7 +114,7 @@
 
 void ADM_dezalloc(void *ptr)
 {
-#ifdef __APPLE__
+#if defined(__APPLE__) || defined(__WIN64)
 	if (!ptr)
 		return;
 
@@ -181,7 +181,7 @@
  */
 void *ADM_realloc(void *ptr, size_t newsize)
 {
-#ifdef __APPLE__
+#if defined(__APPLE__) || defined(__WIN64)
 	if(!ptr)
 		return ADM_alloc(newsize);
 



From gruntster at mail.berlios.de  Sun Dec 20 00:31:35 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 20 Dec 2009 00:31:35 +0100
Subject: [Avidemux-svn-commit] r5676 -
	branches/avidemux_2.5_branch_gruntster/cmake
Message-ID: <200912192331.nBJNVZhm029279@sheep.berlios.de>

Author: gruntster
Date: 2009-12-20 00:31:27 +0100 (Sun, 20 Dec 2009)
New Revision: 5676

Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
Log:
[Win64] don't enable FFmpeg memalign hack for Win64 since it isn't necessary

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2009-12-19 23:28:29 UTC (rev 5675)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2009-12-19 23:31:27 UTC (rev 5676)
@@ -68,7 +68,11 @@
 endforeach (protocol)
 
 if (WIN32)
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-memalign-hack --enable-w32threads)
+	if (ADM_CPU_X86_32)
+		set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-memalign-hack)
+	endif (ADM_CPU_X86_32)
+
+	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-w32threads)
 else (WIN32)
 	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-pthreads)
 endif (WIN32)



From gruntster at mail.berlios.de  Sun Dec 20 18:50:12 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 20 Dec 2009 18:50:12 +0100
Subject: [Avidemux-svn-commit] r5677 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities
Message-ID: <200912201750.nBKHoCn1009458@sheep.berlios.de>

Author: gruntster
Date: 2009-12-20 18:50:04 +0100 (Sun, 20 Dec 2009)
New Revision: 5677

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/avifmt.h
Log:
[Win64] check for existing definition of constants to suppress unnecessary warnings with mingw-w64

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/avifmt.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/avifmt.h	2009-12-19 23:31:27 UTC (rev 5676)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/avifmt.h	2009-12-20 17:50:04 UTC (rev 5677)
@@ -12,19 +12,20 @@
 
 #ifndef NOAVIFMT
 
-#if !defined(__WINE_WINDEF_H) && !defined(_WINDEF_H)
+#ifndef LOBYTE
 #define LOBYTE(w)              ((uint8_t)(uint16_t)(w))
+#endif
+#ifndef HIBYTE
 #define HIBYTE(w)              ((uint8_t)((uint16_t)(w) >> 8))
-
+#endif
+#ifndef LOWORD
 #define LOWORD(l)              ((uint16_t)(uint32_t)(l))
+#endif
+#ifndef HIWORD
 #define HIWORD(l)              ((uint16_t)((uint32_t)(l) >> 16))
-
+#endif
+#ifndef MAKELONG
 #define MAKELONG(low,high)     ((int32_t)(((uint16_t)(low)) | (((uint32_t)((uint16_t)(high))) << 16)))
-
-#endif // __WINE_WINDEF_H
-
-#ifdef _MSC_VER
-#pragma warning(disable:4200)
 #endif
 
 /* The following is a short description of the AVI file format.
@@ -230,8 +231,12 @@
 #define AVIIF_NOTIME	0x00000100L // this frame doesn't take any time
 #define AVIIF_COMPUSE	0x0FFF0000L // these bits are for compressor use
 
+#ifndef FOURCC_RIFF
 #define FOURCC_RIFF	mmioFOURCC('R', 'I', 'F', 'F')
+#endif
+#ifndef FOURCC_LIST
 #define FOURCC_LIST	mmioFOURCC('L', 'I', 'S', 'T')
+#endif
 
 typedef struct __attribute__((__packed__))
 {



From gruntster at mail.berlios.de  Sun Dec 20 19:02:09 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 20 Dec 2009 19:02:09 +0100
Subject: [Avidemux-svn-commit] r5678 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: . ADM_icons/xpm
Message-ID: <200912201802.nBKI299T021500@sheep.berlios.de>

Author: gruntster
Date: 2009-12-20 19:02:00 +0100 (Sun, 20 Dec 2009)
New Revision: 5678

Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_icons/xpm/adm.o
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_icons/xpm/adm.rc
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_icons/xpm/avidemux.o
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt
Log:
[Win32] remove 32-bit object files since they're already dynamically built and not 64-bit compatible

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_icons/xpm/adm.o
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_icons/xpm/adm.rc
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_icons/xpm/adm.rc	2009-12-20 17:50:04 UTC (rev 5677)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_icons/xpm/adm.rc	2009-12-20 18:02:00 UTC (rev 5678)
@@ -1 +0,0 @@
-100 ICON "adm.ico"

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_icons/xpm/avidemux.o
===================================================================
(Binary files differ)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt	2009-12-20 17:50:04 UTC (rev 5677)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt	2009-12-20 18:02:00 UTC (rev 5678)
@@ -452,14 +452,14 @@
 
 	ADD_LIB_ALL_TARGETS(winmm)
 
-	ADD_TARGET_LDFLAGS(avidemux2_cli "-Wl,-subsystem,console ${CMAKE_SOURCE_DIR}/avidemux/ADM_icons/xpm/adm.o")
+	ADD_TARGET_LDFLAGS(avidemux2_cli "-Wl,-subsystem,console")
 
 	IF (ADM_UI_GTK)
-		ADD_TARGET_LDFLAGS(avidemux2_gtk "-mwindows ${CMAKE_SOURCE_DIR}/avidemux/ADM_icons/xpm/adm.o")
+		ADD_TARGET_LDFLAGS(avidemux2_gtk "-mwindows")
 	ENDIF (ADM_UI_GTK)
 
 	IF (ADM_UI_QT4)
-		ADD_TARGET_LDFLAGS(avidemux2_qt4 "-mwindows ${CMAKE_SOURCE_DIR}/avidemux/ADM_icons/xpm/avidemux.o")
+		ADD_TARGET_LDFLAGS(avidemux2_qt4 "-mwindows")
 	ENDIF (ADM_UI_QT4)
 ENDIF (WIN32)
 



From gruntster at mail.berlios.de  Sun Dec 20 20:49:50 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 20 Dec 2009 20:49:50 +0100
Subject: [Avidemux-svn-commit] r5679 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif
Message-ID: <200912201949.nBKJnoBT025807@sheep.berlios.de>

Author: gruntster
Date: 2009-12-20 20:49:46 +0100 (Sun, 20 Dec 2009)
New Revision: 5679

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif/ADM_vidYadif_asm.c
Log:
[Win64] fix compilation error for Yadif plugin on Win64

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif/ADM_vidYadif_asm.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif/ADM_vidYadif_asm.c	2009-12-20 18:02:00 UTC (rev 5678)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif/ADM_vidYadif_asm.c	2009-12-20 19:49:46 UTC (rev 5679)
@@ -1,16 +1,15 @@
-
-
-#include <stdio.h>
 #include <stdlib.h>
-#include <string.h>
 #include <inttypes.h>
-#include <math.h>
 
 #include "ADM_default.h"
 
 #ifdef ADM_CPU_X86
+#ifdef ADM_CPU_64BIT
+typedef int64_t x86_reg;
+#else
+typedef int32_t x86_reg;
+#endif
 
-
 #define LOAD4(mem,dst) \
             "movd      "mem", "#dst" \n\t"\
             "punpcklbw %%mm7, "#dst" \n\t"
@@ -188,8 +187,8 @@
             :[prev] "r"(prev),\
              [cur]  "r"(cur),\
              [next] "r"(next),\
-             [prefs]"r"((long)refs),\
-             [mrefs]"r"((long)-refs),\
+             [prefs]"r"((x86_reg)refs),\
+             [mrefs]"r"((x86_reg)-refs),\
              [pw1]  "m"(pw_1),\
              [pb1]  "m"(pb_1),\
              [mode] "g"(mode)\



From gruntster at mail.berlios.de  Sun Dec 20 21:04:30 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 20 Dec 2009 21:04:30 +0100
Subject: [Avidemux-svn-commit] r5680 -
	branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux
Message-ID: <200912202004.nBKK4U6L027220@sheep.berlios.de>

Author: gruntster
Date: 2009-12-20 21:04:26 +0100 (Sun, 20 Dec 2009)
New Revision: 5680

Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1b. Continue Build.bat
Log:
[Win64] fix script to use correct config path for 64-bit build

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1b. Continue Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1b. Continue Build.bat	2009-12-20 19:49:46 UTC (rev 5679)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1b. Continue Build.bat	2009-12-20 20:04:26 UTC (rev 5680)
@@ -11,7 +11,7 @@
 
 set msysSourceDir=%sourceDir:\=/%
 cd "%sourceDir%\plugins\%buildFolder%"
-cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_CORECONFIG_DIR="%msysSourceDir%/build/config" -DAVIDEMUX_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_SOURCE_DIR="%msysSourceDir%" -DCMAKE_EXE_LINKER_FLAGS="-shared-libgcc" -DCMAKE_SHARED_LINKER_FLAGS="-shared-libgcc" %DebugFlags% ..
+cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_CORECONFIG_DIR="%msysSourceDir%/%buildFolder%/config" -DAVIDEMUX_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_SOURCE_DIR="%msysSourceDir%" -DCMAKE_EXE_LINKER_FLAGS="-shared-libgcc" -DCMAKE_SHARED_LINKER_FLAGS="-shared-libgcc" %DebugFlags% ..
 
 if errorlevel 1 goto error
 pause



From mean at mail.berlios.de  Mon Dec 21 14:31:20 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:20 +0100
Subject: [Avidemux-svn-commit] r5681 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter:
	include src
Message-ID: <200912211331.nBLDVKV0028060@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:18 +0100 (Mon, 21 Dec 2009)
New Revision: 5681

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/DIA_flyDialog.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp
Log:
[fly] Move flyDialog to coreFilter

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/DIA_flyDialog.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/DIA_flyDialog.h	2009-12-20 20:04:26 UTC (rev 5680)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/DIA_flyDialog.h	2009-12-21 13:31:18 UTC (rev 5681)
@@ -0,0 +1,156 @@
+/****************************************************************************
+ copyright            : (C) 2007 by mean
+ email                : fixounet at free.fr
+ 
+ Simple class to do filter that have a configuration that have real time effect
+ 
+ Case 1: The filter process YUV
+ 
+ YUV-> Process->YUVOUT->YUV2RGB->RGBUFFEROUT
+ 
+ Case 2: The filter process RGV
+ 
+ YUV-> YUV2RGB->RGB->Process->RGBUFFEROUT
+ 
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_FLY_DIALOG_H
+#define ADM_FLY_DIALOG_H
+
+#if !defined(ADM_FLY_INTERNAL)
+#if !defined(ADM_UI_TYPE_BUILD)
+#error No ADM_UI_TYPE_BUILD defined
+#endif
+#include "DIA_uiTypes.h"
+
+#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
+        #include <QtGui/QWidget>
+        #include <QtGui/QDialog>
+#endif //UI_BUILD_TYPE
+#endif //ADM_FLY_INTERNAL 
+
+#include "ADM_default.h"
+#include "ADM_colorspace.h"
+#include "ADM_coreVideoFilter.h"
+enum ResizeMethod {
+    RESIZE_NONE = 0,	// No automatic resize
+	RESIZE_AUTO = 1,	// Resize image when convenient (YUV: after filter, RGB: before applying filter)
+	RESIZE_LAST = 2		// Resize image after filter has been applied (slower for RGB)
+};
+
+class diaMenuEntry;  // defined in DIA_factory.h; only need pointer here
+
+struct MenuMapping
+{
+    const char * widgetName; // name of the combo box widget or equivalent
+    uint32_t paramOffset;   // offsetof(FOO_PARAM, menu_option_member)
+    uint32_t count;
+    const diaMenuEntry * menu;
+};
+
+typedef float gfloat;
+
+class ADM_flyDialog
+{
+  protected:
+          uint32_t      _w, _h, _zoomW, _zoomH;
+          float         _zoom;
+          uint32_t      _zoomChangeCount;
+          ADM_coreVideoFilter *_in;
+      
+          ADMImage      *_yuvBuffer;
+          ADMImage      *_yuvBufferOut;
+          uint8_t       *_rgbBuffer;
+          uint8_t       *_rgbBufferOut;
+          uint8_t       *_rgbBufferDisplay;
+          uint8_t       _isYuvProcessing;
+          ResizeMethod  _resizeMethod;
+          ADMImageResizer *_resizer;
+
+  
+          void EndConstructor(void);
+          void copyYuvFinalToRgb(void);
+          void copyYuvScratchToRgb(void);
+          void copyRgbFinalToDisplay(void);
+          
+  public:
+          void recomputeSize(void);
+         
+  public:
+          void    *_cookie; // whatever
+          void    *_slider; // widget
+          void    *_canvas; // Drawing zone
+          ColYuvRgb *_rgb;
+
+          /* Filter dependant */
+  virtual uint8_t    process(void)=0;
+  virtual uint8_t    download(void)=0;
+  virtual uint8_t    upload(void)=0;
+          /* /filter dependant */
+  
+        /* This is GTK/QT/whatever dependant */
+          
+  
+          
+          
+  
+  virtual uint8_t  update(void) {};
+            uint8_t  cleanup(void);
+  
+
+#ifdef USE_JOG
+  static void jogDial (void * my_data, signed short offset);
+  static void jogRing (void * my_data, gfloat angle);
+#endif
+
+          ADM_flyDialog(uint32_t width, uint32_t height, ADM_coreVideoFilter *in,
+                             void *canvas, void *slider, int yuv, ResizeMethod resizeMethod);
+  virtual ~ADM_flyDialog(void);
+// UI dependant part
+// They are not defined as pure to avoid unresolved problem, especially on win32.
+// You should never use flyDialog as is, but using the macro to pull flyDialogGtk/flyDialogQt4/... 
+  
+  virtual uint8_t  isRgbInverted(void)=0;
+  virtual uint8_t  display(void)=0;
+  virtual float   calcZoomFactor(void)=0;
+  virtual uint32_t sliderGet(void)=0;
+  virtual uint8_t  sliderSet(uint32_t value) =0;
+  virtual void    postInit(uint8_t reInit)=0;
+  virtual uint8_t sliderChanged(void);
+};
+#if !defined(ADM_FLY_INTERNAL)
+
+#ifdef ADM_UI_TYPE_BUILD
+#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
+  #include "DIA_flyDialogQt4.h"
+  #define FLY_DIALOG_TYPE ADM_flyDialogQt4
+#else 
+  #if ADM_UI_TYPE_BUILD == ADM_UI_GTK
+    #include "DIA_flyDialogGtk.h"
+    #define FLY_DIALOG_TYPE ADM_flyDialogGtk
+  #else 
+    #if ADM_UI_TYPE_BUILD == ADM_UI_CLI
+      #include "DIA_flyDialogCli.h"
+      #define FLY_DIALOG_TYPE ADM_flyDialogCli
+    #else
+        #if ADM_UI_TYPE_BUILD != ADM_UI_NONE
+#error unknown UI type
+        #endif
+    #endif //CLI
+  #endif //GTK
+#endif // QT
+#else
+  #define FLY_DIALOG_TYPE ADM_UI_TYPE_BUILD_IS_NOT_DEFINED
+#endif
+ 
+#endif //  ADM_FLY_INTERNAL
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp	2009-12-20 20:04:26 UTC (rev 5680)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp	2009-12-21 13:31:18 UTC (rev 5681)
@@ -0,0 +1,274 @@
+/***************************************************************************
+    copyright            : (C) 2006 by mean
+    email                : fixounet at free.fr
+***************************************************************************/
+
+/***************************************************************************
+*                                                                         *
+*   This program is free software; you can redistribute it and/or modify  *
+*   it under the terms of the GNU General Public License as published by  *
+*   the Free Software Foundation; either version 2 of the License, or     *
+*   (at your option) any later version.                                   *
+*                                                                         *
+***************************************************************************///
+
+#include "ADM_default.h"
+
+#include "ADM_coreVideoFilter.h"
+#define ADM_FLY_INTERNAL
+#include "DIA_flyDialog.h"
+#include "ADM_assert.h"
+
+extern "C" {
+#include "ADM_ffmpeg/libavcodec/avcodec.h"
+}
+
+ADM_flyDialog::ADM_flyDialog(uint32_t width,uint32_t height,ADM_coreVideoFilter *in,
+                                void *canvas, void *slider,int yuv, ResizeMethod resizeMethod)
+{
+	ADM_assert(canvas);
+
+	if (slider)
+		ADM_assert(in);
+
+	_w = width;
+	_h = height;
+	_isYuvProcessing = yuv;
+	_in = in;
+	_slider = slider;
+	_canvas = canvas;
+	_cookie = NULL;
+	_resizeMethod = resizeMethod;
+        _zoomChangeCount = 0;
+        _resizer=NULL;
+        _rgbBufferDisplay=NULL;
+
+	_rgb=NULL;
+
+	_yuvBuffer=new ADMImage(_w,_h);
+
+	if(_isYuvProcessing)
+	{
+		_yuvBufferOut=new ADMImage(_w,_h);
+		_rgbBuffer=NULL;
+	}
+	else
+	{
+		_rgbBuffer =new uint8_t [_w*_h*4];
+		_yuvBufferOut=NULL;
+	}
+
+	_rgbBufferOut =new uint8_t [_w*_h*4];
+
+	
+
+	
+}
+/**
+ *      \fn Endconstructor
+ *      \brief We call some virtual functions in the constructor; it does not work, so we do the 2nd part of the constructor here
+ */
+void ADM_flyDialog::EndConstructor(void)
+  {
+    if (isRgbInverted())
+                _rgb=new ColYuvRgb(_w,_h,1);
+        else
+                _rgb=new ColYuvRgb(_w,_h);
+
+        _rgb->reset(_w,_h);
+        if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
+                {
+                        _zoom = calcZoomFactor();
+
+                        if (_zoom == 1)
+                                _resizeMethod = RESIZE_NONE;
+                        else
+                        {
+                                _zoomW = uint32_t (_w * _zoom);
+                                _zoomH = uint32_t (_h * _zoom);
+                        }
+                }
+                else
+                        _zoom = 1;
+
+                if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
+                {
+                        PixelFormat sourceColour;
+
+                        if (_resizeMethod == RESIZE_AUTO || _isYuvProcessing)
+                                sourceColour = PIX_FMT_YUV420P;
+                        else
+                                sourceColour = PIX_FMT_RGB32;
+
+                        _resizer = new ADMImageResizer(_w, _h, _zoomW, _zoomH, sourceColour, PIX_FMT_RGB32);
+                        _rgbBufferDisplay = new uint8_t[_w * _h * 4];
+                }
+                else
+                {
+                        _zoomW = _w;
+                        _zoomH = _h;
+
+                        _resizer = NULL;
+                        _rgbBufferDisplay = NULL;
+                }
+                postInit (false);
+  }
+void ADM_flyDialog::recomputeSize(void)
+{
+    float new_zoom = calcZoomFactor();
+
+    ResizeMethod new_resizeMethod;
+    uint32_t new_zoomW;
+    uint32_t new_zoomH;
+
+    if (new_zoom == 1)
+    {
+        new_resizeMethod = RESIZE_NONE;
+        new_zoomW = _w;
+        new_zoomH = _h;
+    }
+    else
+    {
+        new_resizeMethod = RESIZE_AUTO;
+        new_zoomW = uint32_t (_w * new_zoom);
+        new_zoomH = uint32_t (_h * new_zoom);
+    }
+
+    if (new_resizeMethod == _resizeMethod && new_zoom == _zoom
+        && new_zoomW == _zoomW && new_zoomH == _zoomH)
+        return;
+
+    if (++_zoomChangeCount > 3 || new_zoomH < 30 || new_zoomW < 30)
+    {
+        printf ("Resisting zoom size change from %dx%d (zoom %.5f) to %dx%d (zoom %.5f)\n",
+                _zoomW, _zoomH, _zoom, new_zoomW, new_zoomH, new_zoom);
+        return;
+    }
+
+    printf ("Fixing zoom size from %dx%d (zoom %.5f) to correct %dx%d (zoom %.5f)\n",
+            _zoomW, _zoomH, _zoom, new_zoomW, new_zoomH, new_zoom);
+
+    _resizeMethod = new_resizeMethod;
+    _zoom = new_zoom;
+    _zoomW = new_zoomW;
+    _zoomH = new_zoomH;
+
+    delete _resizer;
+    if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
+    {
+        PixelFormat sourceColour;
+
+        if (_resizeMethod == RESIZE_AUTO || _isYuvProcessing)
+            sourceColour = PIX_FMT_YUV420P;
+        else
+            sourceColour = PIX_FMT_RGB32;
+
+        _resizer = new ADMImageResizer(_w, _h, _zoomW, _zoomH, sourceColour, PIX_FMT_RGB32);
+        if (!_rgbBufferDisplay)
+            _rgbBufferDisplay = new uint8_t[_w * _h * 4];
+    }
+    else
+    {
+        _resizer = NULL;
+        delete _rgbBufferDisplay;
+        _rgbBufferDisplay = NULL;
+    }
+
+    postInit (true);
+    sliderChanged();
+}
+
+/**
+    \fn cleanup
+    \brief deallocate
+*/
+uint8_t ADM_flyDialog::cleanup(void)
+{
+#define DEL1(x)    if(x) {delete [] x;x=NULL;}
+#define DEL2(x)    if(x) {delete  x;x=NULL;}
+  
+	DEL2(_yuvBufferOut);
+	DEL2(_yuvBuffer);
+	DEL1(_rgbBuffer);
+	DEL1(_rgbBufferOut);
+	DEL1(_rgbBufferDisplay);
+	DEL2(_rgb);
+	DEL2(_resizer);
+}
+/**
+    \fn ~ADM_flyDialog
+    \brief destructor
+*/
+ADM_flyDialog::~ADM_flyDialog(void)
+{
+  
+  // FIXME cleanup2();
+  cleanup(); 
+}
+
+/**
+      \fn sliderChanged
+      \brief callback to handle image changes
+*/
+uint8_t    ADM_flyDialog::sliderChanged(void)
+{
+  uint32_t fn= sliderGet();
+  uint32_t len,flags;
+  
+    ADM_assert(_yuvBuffer);
+    ADM_assert(_rgbBufferOut);
+    ADM_assert(_in);
+    
+    //if(!_in->getFrameNumberNoAlloc(fn,&len,_yuvBuffer,&flags))
+    {
+      printf("[FlyDialog] Cannot get frame %u\n",fn); 
+      return 0;
+    }
+
+    // Process...    
+    if(_isYuvProcessing)
+    {
+        process();
+		copyYuvFinalToRgb();
+    }
+	else // RGB Processing      
+    {
+        ADM_assert(_rgbBuffer);
+		copyYuvScratchToRgb();
+        process();
+    }
+
+    return display();
+}
+
+void ADM_flyDialog::copyYuvFinalToRgb(void)
+{
+	if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
+		_resizer->resize(_yuvBufferOut->data, _rgbBufferOut);
+	else
+		_rgb->scale(_yuvBufferOut->data, _rgbBufferOut);
+}
+
+void ADM_flyDialog::copyYuvScratchToRgb(void)
+{
+	if (_resizeMethod == RESIZE_AUTO)
+		_resizer->resize(_yuvBuffer->data,_rgbBuffer);
+	else
+		_rgb->scale(_yuvBuffer->data,_rgbBuffer);
+}
+
+void ADM_flyDialog::copyRgbFinalToDisplay(void)
+{
+	if (_resizeMethod == RESIZE_LAST)
+	{
+		_resizer->resize(_rgbBufferOut, _rgbBufferDisplay);
+
+		uint8_t* tempRgb = _rgbBufferDisplay;
+
+		_rgbBufferDisplay = _rgbBufferOut;
+		_rgbBufferOut = tempRgb;
+	}
+}
+
+//EOF
+



From mean at mail.berlios.de  Mon Dec 21 14:31:23 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:23 +0100
Subject: [Avidemux-svn-commit] r5682 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include
Message-ID: <200912211331.nBLDVNuQ028100@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:22 +0100 (Mon, 21 Dec 2009)
New Revision: 5682

Removed:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_videoFilter.h
Log:
[cleanup] Delete old videoFilter declaration

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_videoFilter.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_videoFilter.h	2009-12-21 13:31:18 UTC (rev 5681)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_videoFilter.h	2009-12-21 13:31:22 UTC (rev 5682)
@@ -1,205 +0,0 @@
-/***************************************************************************
-                          ADM_genvideo.hxx  -  description
-                             -------------------
-    begin                : Tue Mar 19 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
- 
-#define ADM_FILTER_API_VERSION 3
-/**
-	Note for filter writers :
-
-		The constructor accept 2 parameters
-
-				_in : previous filter in the chain, the source of incoming image
-				couple : A configuration seen as couples of string
-						"size" "13" for example. Passing null means either
-						it has no parameters or set the default value for them.
-
-				_uncompressed : optional internal buffer
-
-				configure return 1 if the conf has changed, 0 else.
-
-
-
-*/
-#ifndef __ADM_VIDEO__
-#define __ADM_VIDEO__
-
-#define INT int32_t
-#include "ADM_confCouple.h"
-#include "ADM_image.h"
-
-#define Pixel uint8_t
-typedef struct
- {
- 		uint32_t width;
- 		uint32_t height;
- 		uint32_t nb_frames;
- 		uint32_t encoding;
- 		uint32_t codec;
- 		uint32_t fps1000;
-		uint32_t orgFrame;
- }ADV_Info;
-
-
-typedef struct
-{
-    uint32_t					w,h;
-    uint32_t				algo;
-}RESIZE_PARAMS;
-
-
-
-typedef struct
-{
- 	uint32_t newfps, precision;
-}CHFPS_PARAMS;
-
-typedef struct {
-    int pixel;
-    double weight;
-} CONTRIB;
-
-
-typedef struct {
-    uint32_t  n;			/* number of contributors */
-    CONTRIB *p;			/* pointer to list of contributions */
-} CLIST;
-
-typedef struct
-{
-	uint32_t 	width;		/* horizontal size of the image in Pixels */
-	uint32_t	height;		/* vertical size of the image in Pixels */
-	Pixel *	data;		/* pointer to first scanline of image */
-
-} Image;
-
-
-
- class AVDMGenericVideoStream {
-protected:
-	ADV_Info _info;
-	ADMImage *_uncompressed;
-	AVDMGenericVideoStream *_in;
-	/* not really used */
-	uint8_t getPixel(int32_t x, int32_t y, uint8_t *data);
-	uint8_t getPixelU(int32_t x, int32_t y, uint8_t *data);
-	uint8_t setPixelU(uint8_t val, int32_t x, int32_t y, uint8_t *data);
-	uint8_t unPackChroma(uint8_t *ssrc, uint8_t *ddst);
-	/* /not really used */
-public:
-	virtual uint32_t getPARWidth(void);
-	virtual uint32_t getPARHeight(void);
-
-	// return 1 -> conf changed need rebuild, 0 means conf not changed
-	virtual uint8_t configure(AVDMGenericVideoStream *instream)=0;
-	AVDMGenericVideoStream(void) {
-		_uncompressed=NULL;
-		_in=NULL;
-	}
-	;
-	virtual ~AVDMGenericVideoStream() {
-	}
-	;
-	virtual char *printConf(void) {
-		static char *str=(char *)".";
-		return str;
-	}
-	;
-
-	virtual uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-			ADMImage *data, uint32_t *flags)=0;
-	ADV_Info *getInfo(void) {
-		return &_info;
-	}
-	;
-	virtual uint8_t getCoupledConf(CONFcouple **couples) {
-		*couples=NULL;
-		return 0;
-	}
-	;
-};
-
-void     DIA_previewInit(uint32_t width, uint32_t height);
-uint8_t  DIA_previewUpdate(uint8_t *data);
-void 	 DIA_previewEnd(void);
-uint8_t  DIA_previewStillAlive(void);
-uint8_t	 DIA_filterPreview(const char *captionText, AVDMGenericVideoStream *videoStream, uint32_t frame);
-
- // Pseudo class used to register filters automagically
- // Does not work atm
-class AVDMVideo_FilterDec
-{
-private:
-	int dum;
-public:
-  	AVDMVideo_FilterDec(char *name, AVDMGenericVideoStream *(*create) (AVDMGenericVideoStream *in, void *));
-};
-
-
-
-
-/**
-	These macros are used to build the create_ function automatically
-	That way external sw has no need to know the underlying class
-*/
-#undef NEW
-#define NEW(x) (x *)ADM_alloc(sizeof(x))
-#undef DELETE
-#define DELETE(x) {if(x){ADM_dealloc(x);x=NULL;}}
-#define CREATOR(x,clss)  return new clss(in,x);
-#define BUILD_CREATE(name,clss) AVDMGenericVideoStream *name(AVDMGenericVideoStream *in, CONFcouple *conf) \
-{		CREATOR(conf,clss); }
-#define VARIABLE_PARAMS 0xff
-#define SCRIPT_CREATE(name,clss,tmplate) \
-AVDMGenericVideoStream *name (AVDMGenericVideoStream *in, int n,Arg *args); \
-AVDMGenericVideoStream *name (AVDMGenericVideoStream *in, int n,Arg *args) \
-{ 							\
-CONFcouple		*couple; 			\
-AVDMGenericVideoStream *filter; 			\
-	couple=filterBuildCouple(&tmplate,n,args);	\
-	if(!couple) { printf("Filter built failed\n");return NULL;}\
-	filter= new clss(in,couple);			\
-	delete couple;					\
-	return filter;					\
-}
-
-
-
-#define GET(x) ADM_assert(couples->getCouple((char *)#x,&(_param->x)))
-#define GET2(x,t) (assert(couples->getCouple((char *)#x,&(t))),(_param->x)=(t))
-#define CSET(x)  (*couples)->setCouple((char *)#x,(_param->x))
-
-typedef struct
- {
-          uint32_t    nb;
-          const char  *param[25];
- }FILTER_PARAM;
- 
-#include "ADM_videoFilter_iface.h"
- CONFcouple *filterBuildCouple(FILTER_PARAM *param,uint32_t n,Arg *args); 
- 
-#define MPLAYER_RESIZE_PREFFERED
- // You should not use this functions.
- // Needed for some legacy filters...
- AVDMGenericVideoStream *getLastVideoFilter( uint32_t frameStart, uint32_t nbFrame);
- AVDMGenericVideoStream *getLastVideoFilter( void );
- AVDMGenericVideoStream *getFirstVideoFilter( uint32_t frameStart, uint32_t nbFrame);
- AVDMGenericVideoStream *getFirstVideoFilter( void);
- AVDMGenericVideoStream *getFirstCurrentVideoFilter( void);
-// 
-#include "ADM_videoFilterCache.h"
- 
-#endif
-



From mean at mail.berlios.de  Mon Dec 21 14:31:27 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:27 +0100
Subject: [Avidemux-svn-commit] r5683 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_osSupport
Message-ID: <200912211331.nBLDVRag028127@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:26 +0100 (Mon, 21 Dec 2009)
New Revision: 5683

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_osSupport/ADM_misc.cpp
Log:
[Misc] Fix buffer overflow with some languages (greek)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_osSupport/ADM_misc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_osSupport/ADM_misc.cpp	2009-12-21 13:31:22 UTC (rev 5682)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_osSupport/ADM_misc.cpp	2009-12-21 13:31:26 UTC (rev 5683)
@@ -5,17 +5,18 @@
 char* ms2timedisplay(uint32_t ms)
 {
 	uint32_t mm, ss;
-	static char string[20];
+#define ADM_MAX_STRING 256
+	static char string[ADM_MAX_STRING+1];
 
 	mm = (uint32_t)floor(ms / 60000.);
 	
 	if (mm > 1)
 	{
-		sprintf(string, QT_TR_NOOP("%"LU" minutes"), mm);
+		snprintf(string, ADM_MAX_STRING,QT_TR_NOOP("%"LU" minutes"), mm);
 	}
 	else if (mm == 1)
 	{
-		sprintf(string, QT_TR_NOOP("%"LU" minute"), mm);
+		snprintf(string,ADM_MAX_STRING, QT_TR_NOOP("%"LU" minute"), mm);
 	}
 	else
 	{
@@ -23,14 +24,14 @@
 
 		if (ss == 1)
 		{
-			sprintf(string, QT_TR_NOOP("%"LU" second"), ss);
+			snprintf(string,ADM_MAX_STRING, QT_TR_NOOP("%"LU" second"), ss);
 		}
 		else
 		{
-			sprintf(string, QT_TR_NOOP("%"LU" seconds"), ss);
+			snprintf(string,ADM_MAX_STRING, QT_TR_NOOP("%"LU" seconds"), ss);
 		}
 	}
-
+    string[ADM_MAX_STRING]=0;
 	return string;
 }
 



From mean at mail.berlios.de  Mon Dec 21 14:31:31 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:31 +0100
Subject: [Avidemux-svn-commit] r5684 - in branches/avidemux_2.6_branch_mean:
	avidemux_core/ADM_coreVideoFilter/include
	avidemux_core/ADM_coreVideoFilter/src
	avidemux_plugins/ADM_videoFilters6/dummy
	avidemux_plugins/ADM_videoFilters6/resize
	avidemux_plugins/ADM_videoFilters6/verticalFlip
Message-ID: <200912211331.nBLDVVPa028158@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:30 +0100 (Mon, 21 Dec 2009)
New Revision: 5684

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilter.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_coreVideoFilter.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/dummy/dummyVideoFilter.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/resize/swScaleResize.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/verticalFlip/verticalFlip.cpp
Log:
[videoFilter] Change seek to frame to seek to time

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilter.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilter.h	2009-12-21 13:31:26 UTC (rev 5683)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilter.h	2009-12-21 13:31:30 UTC (rev 5684)
@@ -44,8 +44,8 @@
             ~ADM_coreVideoFilter();
 
        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
-       virtual bool         getFrame(uint32_t frame,ADMImage *image)=0;    /// Return the next image
-       virtual bool         getNextFrame(ADMImage *image);              /// Dont mix getFrame & getNextFrame !
+       virtual bool         goToTime(uint64_t usSeek);              
+       virtual bool         getNextFrame(ADMImage *image)=0;              /// Dont mix getFrame & getNextFrame !
 	   virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
 	   virtual bool         getCoupledConf(CONFcouple **couples)=0 ;   /// Return the current filter configuration
        virtual bool         configure(void) {return true;}             /// Start graphical user interface

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_coreVideoFilter.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_coreVideoFilter.cpp	2009-12-21 13:31:26 UTC (rev 5683)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_coreVideoFilter.cpp	2009-12-21 13:31:30 UTC (rev 5684)
@@ -64,13 +64,20 @@
     return previousFilter->getInfo();
 }
 /**
-        \fn getNextFrame
-        \brief 
-*/  
-bool         ADM_coreVideoFilter::getNextFrame(ADMImage *image)     
+    \fn goToTime
+    \brief sort of seek, used for preview video filters, does not have to be frame accurate
+*/
+bool         ADM_coreVideoFilter::goToTime(uint64_t usSeek)
 {
-      bool r=getFrame(nextFrame,image);
-      nextFrame++;
-      return r;
+    float thisIncrement=info.frameIncrement;
+    float oldIncrement=previousFilter->getInfo()->frameIncrement;
+    ADM_assert(thisIncrement);
+    ADM_assert(oldIncrement);
+    if(thisIncrement==oldIncrement) return previousFilter->goToTime(usSeek);
+    float newSeek=usSeek;
+    newSeek/=thisIncrement;
+    newSeek*=oldIncrement;
+    return  previousFilter->goToTime((uint64_t)newSeek);
+
 }
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/CMakeLists.txt	2009-12-21 13:31:26 UTC (rev 5683)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/CMakeLists.txt	2009-12-21 13:31:30 UTC (rev 5684)
@@ -1,9 +1,10 @@
 SET(ADM_CoreVideoFilter_SRCS 
 	ADM_coreVideoFilter.cpp
+        DIA_flyDialog.cpp
 )
 
 ADD_LIBRARY(ADM_coreVideoFilter6 SHARED ${ADM_CoreVideoFilter_SRCS})
-TARGET_LINK_LIBRARIES(ADM_coreVideoFilter6 ADM_core6)
+TARGET_LINK_LIBRARIES(ADM_coreVideoFilter6 ADM_core6 ADM_coreImage6)
 
 ADM_INSTALL_LIB(ADM_coreVideoFilter6)
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/dummy/dummyVideoFilter.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/dummy/dummyVideoFilter.cpp	2009-12-21 13:31:26 UTC (rev 5683)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/dummy/dummyVideoFilter.cpp	2009-12-21 13:31:30 UTC (rev 5684)
@@ -28,7 +28,7 @@
                     ~dummyVideoFilter();
 
        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
-       virtual bool         getFrame(uint32_t frame,ADMImage *image);    /// Return the next image
+       virtual bool         getNextFrame(ADMImage *image);    /// Return the next image
 	 //  virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
 	   virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
        virtual bool         configure(void) {return true;}             /// Start graphical user interface
@@ -68,10 +68,10 @@
     \fn getFrame
     \brief Get a processed frame
 */
-bool dummyVideoFilter::getFrame(uint32_t frame,ADMImage *image)
+bool dummyVideoFilter::getNextFrame(ADMImage *image)
 {
     // since we do nothing, just get the output of previous filter
-    return previousFilter->getFrame(frame,image);
+    return previousFilter->getNextFrame(image);
 }
 /**
     \fn getCoupledConf

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/resize/swScaleResize.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/resize/swScaleResize.cpp	2009-12-21 13:31:26 UTC (rev 5683)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/resize/swScaleResize.cpp	2009-12-21 13:31:30 UTC (rev 5684)
@@ -62,7 +62,7 @@
                     ~swScaleResizeFilter();
 
        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
-       virtual bool         getFrame(uint32_t frame,ADMImage *image);    /// Return the next image
+       virtual bool         getNextFrame(ADMImage *image);    /// Return the next image
        virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
 	   virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
        virtual bool         configure(void) ;             /// Start graphical user interface
@@ -117,12 +117,12 @@
     \fn getFrame
     \brief Get a processed frame
 */
-bool swScaleResizeFilter::getFrame(uint32_t frame,ADMImage *image)
+bool swScaleResizeFilter::getNextFrame(ADMImage *image)
 {
     // since we do nothing, just get the output of previous filter
-    if(false==previousFilter->getFrame(frame,original))
+    if(false==previousFilter->getNextFrame(original))
     {
-        ADM_warning("Vertical flip : Cannot get frame\n");
+        ADM_warning("swResize : Cannot get frame\n");
         return false;
     }
     uint8_t *src[3];

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/verticalFlip/verticalFlip.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/verticalFlip/verticalFlip.cpp	2009-12-21 13:31:26 UTC (rev 5683)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/verticalFlip/verticalFlip.cpp	2009-12-21 13:31:30 UTC (rev 5684)
@@ -28,7 +28,7 @@
                     ~verticalFlipFilter();
 
        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
-       virtual bool         getFrame(uint32_t frame,ADMImage *image);    /// Return the next image
+       virtual bool         getNextFrame(ADMImage *image);    /// Return the next image
 	 //  virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
 	   virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
        virtual bool         configure(void) {return true;}             /// Start graphical user interface
@@ -82,12 +82,12 @@
     \fn getFrame
     \brief Get a processed frame
 */
-bool verticalFlipFilter::getFrame(uint32_t frame,ADMImage *image)
+bool verticalFlipFilter::getNextFrame(ADMImage *image)
 {
     // since we do nothing, just get the output of previous filter
-    if(false==previousFilter->getFrame(frame,image))
+    if(false==previousFilter->getNextFrame(image))
     {
-        ADM_warning("Vertical flip : Cannot get frame\n");
+        ADM_warning("FlipFilter : Cannot get frame\n");
         return false;
     }
     // do in place flip



From mean at mail.berlios.de  Mon Dec 21 14:31:34 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:34 +0100
Subject: [Avidemux-svn-commit] r5685 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include
Message-ID: <200912211331.nBLDVYrD028183@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:33 +0100 (Mon, 21 Dec 2009)
New Revision: 5685

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilterInternal.h
Log:
[videoFilter] Change seek to frame to seek to time

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilterInternal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilterInternal.h	2009-12-21 13:31:30 UTC (rev 5684)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilterInternal.h	2009-12-21 13:31:33 UTC (rev 5685)
@@ -12,7 +12,7 @@
 #include "ADM_paramList.h"
 #include "ADM_coreUtils.h"
 
-#define VF_API_VERSION 1
+#define VF_API_VERSION 2
 /* These are the 6 functions exported by each plugin ...*/
 typedef ADM_coreVideoFilter  *(ADM_vf_CreateFunction)(ADM_coreVideoFilter *previous,CONFcouple *conf);
 typedef void              (ADM_vf_DeleteFunction)(ADM_coreVideoFilter *codec);



From mean at mail.berlios.de  Mon Dec 21 14:31:37 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:37 +0100
Subject: [Avidemux-svn-commit] r5686 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_smjs
Message-ID: <200912211331.nBLDVbcv028209@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:36 +0100 (Mon, 21 Dec 2009)
New Revision: 5686

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_smjs/jsautocfg.h
Log:
[js] Need core include to know if we are 64 bits

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_smjs/jsautocfg.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_smjs/jsautocfg.h	2009-12-21 13:31:33 UTC (rev 5685)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_smjs/jsautocfg.h	2009-12-21 13:31:36 UTC (rev 5686)
@@ -1,6 +1,7 @@
 #ifndef js_cpucfg___
 #define js_cpucfg___
 
+#include "ADM_coreConfig.h"
 /* AUTOMATICALLY GENERATED - DO NOT EDIT */
 #ifdef ADM_BIG_ENDIAN
 #undef   IS_LITTLE_ENDIAN 



From mean at mail.berlios.de  Mon Dec 21 14:31:40 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:40 +0100
Subject: [Avidemux-svn-commit] r5687 - in
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2:
	include src
Message-ID: <200912211331.nBLDVeLk028236@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:39 +0100 (Mon, 21 Dec 2009)
New Revision: 5687

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/include/ADM_videoFilterBridge.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilterBridge.cpp
Log:
[Bridge] update to new video filter api

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/include/ADM_videoFilterBridge.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/include/ADM_videoFilterBridge.h	2009-12-21 13:31:36 UTC (rev 5686)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/include/ADM_videoFilterBridge.h	2009-12-21 13:31:39 UTC (rev 5687)
@@ -35,8 +35,8 @@
 public:
                             ADM_videoFilterBridge(uint64_t startTime, uint64_t endTime);
                             ~ADM_videoFilterBridge();
-       virtual bool         getFrame(uint32_t frame,ADMImage *image);
-       
+       virtual bool         goToTime(uint64_t usSeek);  
+       virtual bool         getNextFrame(ADMImage *image);      
 	   virtual FilterInfo  *getInfo(void);                                      /// Return picture parameters after this filter
 	   virtual bool         getCoupledConf(CONFcouple **couples) {*couples=NULL;return true;} ; /// Return the current filter configuration
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilterBridge.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilterBridge.cpp	2009-12-21 13:31:36 UTC (rev 5686)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilterBridge.cpp	2009-12-21 13:31:39 UTC (rev 5687)
@@ -45,11 +45,7 @@
 */
 bool ADM_videoFilterBridge::rewind(void)
 {
-    printf("[VideoBridge] Goint to %"LU" ms\n",(uint32_t)(startTime/1000));
-    video_body->goToTimeVideo(startTime);
-    firstImage=true;
-    lastSentImage=0;
-    return true;
+    return goToTime(0);
 }
 
 /**
@@ -101,21 +97,9 @@
             so we in case of non-sequential access we rely on the cache of decoded image.
             (TODO)
 */
-bool         ADM_videoFilterBridge::getFrame(uint32_t frame,ADMImage *image)
-{
-    if(frame==0)
-    {
-        rewind();
+bool         ADM_videoFilterBridge::getNextFrame(ADMImage *image)
+{  
         return nextFrame(image);
-    }
-    // Sequential access ?
-    if(frame==lastSentImage+1)
-    {
-        return nextFrame(image);
-    }
-    // Non sequential access : todo
-    ADM_assert(0);
-    return false;
 }
 /**
     \fn ADM_videoFilterBridge
@@ -125,4 +109,14 @@
 {
     return &bridgeInfo;
 }
+/**
+    \fn goToTime
+*/
+bool         ADM_videoFilterBridge::goToTime(uint64_t usSeek)
+{
+    video_body->goToTimeVideo(startTime+usSeek);
+    firstImage=true;
+    lastSentImage=0;
+    return true;
+}
 // EOF



From mean at mail.berlios.de  Mon Dec 21 14:31:43 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:43 +0100
Subject: [Avidemux-svn-commit] r5688 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage:
	include src
Message-ID: <200912211331.nBLDVhfT028256@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:42 +0100 (Mon, 21 Dec 2009)
New Revision: 5688

Removed:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/DIA_flyDialog.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/DIA_flyDialog.cpp
Log:
[fly] Remove them from coreImage, they are now in corevideoFilter

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/DIA_flyDialog.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/DIA_flyDialog.h	2009-12-21 13:31:39 UTC (rev 5687)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/DIA_flyDialog.h	2009-12-21 13:31:42 UTC (rev 5688)
@@ -1,153 +0,0 @@
-/****************************************************************************
- copyright            : (C) 2007 by mean
- email                : fixounet at free.fr
- 
- Simple class to do filter that have a configuration that have real time effect
- 
- Case 1: The filter process YUV
- 
- YUV-> Process->YUVOUT->YUV2RGB->RGBUFFEROUT
- 
- Case 2: The filter process RGV
- 
- YUV-> YUV2RGB->RGB->Process->RGBUFFEROUT
- 
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef ADM_FLY_DIALOG_H
-#define ADM_FLY_DIALOG_H
-
-#if !defined(ADM_UI_TYPE_BUILD)
-#error No ADM_UI_TYPE_BUILD defined
-#endif
-#include "DIA_uiTypes.h"
-
-#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
-        #include <QtGui/QWidget>
-        #include <QtGui/QDialog>
-#endif 
-
-#include "ADM_default.h"
-#include "ADM_colorspace.h"
-#include "ADM_videoFilter.h"
-enum ResizeMethod {
-        RESIZE_NONE = 0,	// No automatic resize
-	RESIZE_AUTO = 1,	// Resize image when convenient (YUV: after filter, RGB: before applying filter)
-	RESIZE_LAST = 2		// Resize image after filter has been applied (slower for RGB)
-};
-
-class diaMenuEntry;  // defined in DIA_factory.h; only need pointer here
-
-struct MenuMapping
-{
-    const char * widgetName; // name of the combo box widget or equivalent
-    uint32_t paramOffset;   // offsetof(FOO_PARAM, menu_option_member)
-    uint32_t count;
-    const diaMenuEntry * menu;
-};
-
-typedef float gfloat;
-
-class ADM_flyDialog
-{
-  protected:
-          uint32_t      _w, _h, _zoomW, _zoomH;
-          float         _zoom;
-          uint32_t      _zoomChangeCount;
-          AVDMGenericVideoStream *_in;
-      
-          ADMImage      *_yuvBuffer;
-          ADMImage      *_yuvBufferOut;
-          uint8_t       *_rgbBuffer;
-          uint8_t       *_rgbBufferOut;
-          uint8_t       *_rgbBufferDisplay;
-          uint8_t       _isYuvProcessing;
-          ResizeMethod  _resizeMethod;
-          ADMImageResizer *_resizer;
-
-  
-          void EndConstructor(void);
-          void copyYuvFinalToRgb(void);
-          void copyYuvScratchToRgb(void);
-          void copyRgbFinalToDisplay(void);
-          
-  public:
-          void recomputeSize(void);
-         
-  public:
-          void    *_cookie; // whatever
-          void    *_slider; // widget
-          void    *_canvas; // Drawing zone
-          ColYuvRgb *_rgb;
-
-          /* Filter dependant */
-  virtual uint8_t    process(void)=0;
-  virtual uint8_t    download(void)=0;
-  virtual uint8_t    upload(void)=0;
-          /* /filter dependant */
-  
-        /* This is GTK/QT/whatever dependant */
-          
-  
-          
-          
-  
-  virtual uint8_t  update(void) {};
-            uint8_t  cleanup(void);
-  
-
-#ifdef USE_JOG
-  static void jogDial (void * my_data, signed short offset);
-  static void jogRing (void * my_data, gfloat angle);
-#endif
-
-          ADM_flyDialog(uint32_t width, uint32_t height, AVDMGenericVideoStream *in,
-                             void *canvas, void *slider, int yuv, ResizeMethod resizeMethod);
-  virtual ~ADM_flyDialog(void);
-// UI dependant part
-// They are not defined as pure to avoid unresolved problem, especially on win32.
-// You should never use flyDialog as is, but using the macro to pull flyDialogGtk/flyDialogQt4/... 
-  
-  virtual uint8_t  isRgbInverted(void)=0;
-  virtual uint8_t  display(void)=0;
-  virtual float   calcZoomFactor(void)=0;
-  virtual uint32_t sliderGet(void)=0;
-  virtual uint8_t  sliderSet(uint32_t value) =0;
-  virtual void    postInit(uint8_t reInit)=0;
-  virtual uint8_t sliderChanged(void);
-};
-
-#ifdef ADM_UI_TYPE_BUILD
-#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
-  #include "DIA_flyDialogQt4.h"
-  #define FLY_DIALOG_TYPE ADM_flyDialogQt4
-#else 
-  #if ADM_UI_TYPE_BUILD == ADM_UI_GTK
-    #include "DIA_flyDialogGtk.h"
-    #define FLY_DIALOG_TYPE ADM_flyDialogGtk
-  #else 
-    #if ADM_UI_TYPE_BUILD == ADM_UI_CLI
-      #include "DIA_flyDialogCli.h"
-      #define FLY_DIALOG_TYPE ADM_flyDialogCli
-    #else
-        #if ADM_UI_TYPE_BUILD != ADM_UI_NONE
-#error unknown UI type
-        #endif
-    #endif //CLI
-  #endif //GTK
-#endif // QT
-#else
-  #define FLY_DIALOG_TYPE ADM_UI_TYPE_BUILD_IS_NOT_DEFINED
-#endif
- 
- 
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/DIA_flyDialog.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/DIA_flyDialog.cpp	2009-12-21 13:31:39 UTC (rev 5687)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/DIA_flyDialog.cpp	2009-12-21 13:31:42 UTC (rev 5688)
@@ -1,273 +0,0 @@
-/***************************************************************************
-    copyright            : (C) 2006 by mean
-    email                : fixounet at free.fr
-***************************************************************************/
-
-/***************************************************************************
-*                                                                         *
-*   This program is free software; you can redistribute it and/or modify  *
-*   it under the terms of the GNU General Public License as published by  *
-*   the Free Software Foundation; either version 2 of the License, or     *
-*   (at your option) any later version.                                   *
-*                                                                         *
-***************************************************************************///
-
-#include "ADM_default.h"
-
-#include "ADM_videoFilter.h"
-#include "DIA_flyDialog.h"
-#include "ADM_assert.h"
-
-extern "C" {
-#include "ADM_ffmpeg/libavcodec/avcodec.h"
-}
-
-ADM_flyDialog::ADM_flyDialog(uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
-                                void *canvas, void *slider,int yuv, ResizeMethod resizeMethod)
-{
-	ADM_assert(canvas);
-
-	if (slider)
-		ADM_assert(in);
-
-	_w = width;
-	_h = height;
-	_isYuvProcessing = yuv;
-	_in = in;
-	_slider = slider;
-	_canvas = canvas;
-	_cookie = NULL;
-	_resizeMethod = resizeMethod;
-        _zoomChangeCount = 0;
-        _resizer=NULL;
-        _rgbBufferDisplay=NULL;
-
-	_rgb=NULL;
-
-	_yuvBuffer=new ADMImage(_w,_h);
-
-	if(_isYuvProcessing)
-	{
-		_yuvBufferOut=new ADMImage(_w,_h);
-		_rgbBuffer=NULL;
-	}
-	else
-	{
-		_rgbBuffer =new uint8_t [_w*_h*4];
-		_yuvBufferOut=NULL;
-	}
-
-	_rgbBufferOut =new uint8_t [_w*_h*4];
-
-	
-
-	
-}
-/**
- *      \fn Endconstructor
- *      \brief We call some virtual functions in the constructor; it does not work, so we do the 2nd part of the constructor here
- */
-void ADM_flyDialog::EndConstructor(void)
-  {
-    if (isRgbInverted())
-                _rgb=new ColYuvRgb(_w,_h,1);
-        else
-                _rgb=new ColYuvRgb(_w,_h);
-
-        _rgb->reset(_w,_h);
-        if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
-                {
-                        _zoom = calcZoomFactor();
-
-                        if (_zoom == 1)
-                                _resizeMethod = RESIZE_NONE;
-                        else
-                        {
-                                _zoomW = uint32_t (_w * _zoom);
-                                _zoomH = uint32_t (_h * _zoom);
-                        }
-                }
-                else
-                        _zoom = 1;
-
-                if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
-                {
-                        PixelFormat sourceColour;
-
-                        if (_resizeMethod == RESIZE_AUTO || _isYuvProcessing)
-                                sourceColour = PIX_FMT_YUV420P;
-                        else
-                                sourceColour = PIX_FMT_RGB32;
-
-                        _resizer = new ADMImageResizer(_w, _h, _zoomW, _zoomH, sourceColour, PIX_FMT_RGB32);
-                        _rgbBufferDisplay = new uint8_t[_w * _h * 4];
-                }
-                else
-                {
-                        _zoomW = _w;
-                        _zoomH = _h;
-
-                        _resizer = NULL;
-                        _rgbBufferDisplay = NULL;
-                }
-                postInit (false);
-  }
-void ADM_flyDialog::recomputeSize(void)
-{
-    float new_zoom = calcZoomFactor();
-
-    ResizeMethod new_resizeMethod;
-    uint32_t new_zoomW;
-    uint32_t new_zoomH;
-
-    if (new_zoom == 1)
-    {
-        new_resizeMethod = RESIZE_NONE;
-        new_zoomW = _w;
-        new_zoomH = _h;
-    }
-    else
-    {
-        new_resizeMethod = RESIZE_AUTO;
-        new_zoomW = uint32_t (_w * new_zoom);
-        new_zoomH = uint32_t (_h * new_zoom);
-    }
-
-    if (new_resizeMethod == _resizeMethod && new_zoom == _zoom
-        && new_zoomW == _zoomW && new_zoomH == _zoomH)
-        return;
-
-    if (++_zoomChangeCount > 3 || new_zoomH < 30 || new_zoomW < 30)
-    {
-        printf ("Resisting zoom size change from %dx%d (zoom %.5f) to %dx%d (zoom %.5f)\n",
-                _zoomW, _zoomH, _zoom, new_zoomW, new_zoomH, new_zoom);
-        return;
-    }
-
-    printf ("Fixing zoom size from %dx%d (zoom %.5f) to correct %dx%d (zoom %.5f)\n",
-            _zoomW, _zoomH, _zoom, new_zoomW, new_zoomH, new_zoom);
-
-    _resizeMethod = new_resizeMethod;
-    _zoom = new_zoom;
-    _zoomW = new_zoomW;
-    _zoomH = new_zoomH;
-
-    delete _resizer;
-    if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
-    {
-        PixelFormat sourceColour;
-
-        if (_resizeMethod == RESIZE_AUTO || _isYuvProcessing)
-            sourceColour = PIX_FMT_YUV420P;
-        else
-            sourceColour = PIX_FMT_RGB32;
-
-        _resizer = new ADMImageResizer(_w, _h, _zoomW, _zoomH, sourceColour, PIX_FMT_RGB32);
-        if (!_rgbBufferDisplay)
-            _rgbBufferDisplay = new uint8_t[_w * _h * 4];
-    }
-    else
-    {
-        _resizer = NULL;
-        delete _rgbBufferDisplay;
-        _rgbBufferDisplay = NULL;
-    }
-
-    postInit (true);
-    sliderChanged();
-}
-
-/**
-    \fn cleanup
-    \brief deallocate
-*/
-uint8_t ADM_flyDialog::cleanup(void)
-{
-#define DEL1(x)    if(x) {delete [] x;x=NULL;}
-#define DEL2(x)    if(x) {delete  x;x=NULL;}
-  
-	DEL2(_yuvBufferOut);
-	DEL2(_yuvBuffer);
-	DEL1(_rgbBuffer);
-	DEL1(_rgbBufferOut);
-	DEL1(_rgbBufferDisplay);
-	DEL2(_rgb);
-	DEL2(_resizer);
-}
-/**
-    \fn ~ADM_flyDialog
-    \brief destructor
-*/
-ADM_flyDialog::~ADM_flyDialog(void)
-{
-  
-  // FIXME cleanup2();
-  cleanup(); 
-}
-
-/**
-      \fn sliderChanged
-      \brief callback to handle image changes
-*/
-uint8_t    ADM_flyDialog::sliderChanged(void)
-{
-  uint32_t fn= sliderGet();
-  uint32_t len,flags;
-  
-    ADM_assert(_yuvBuffer);
-    ADM_assert(_rgbBufferOut);
-    ADM_assert(_in);
-    
-    if(!_in->getFrameNumberNoAlloc(fn,&len,_yuvBuffer,&flags))
-    {
-      printf("[FlyDialog] Cannot get frame %u\n",fn); 
-      return 0;
-    }
-
-    // Process...    
-    if(_isYuvProcessing)
-    {
-        process();
-		copyYuvFinalToRgb();
-    }
-	else // RGB Processing      
-    {
-        ADM_assert(_rgbBuffer);
-		copyYuvScratchToRgb();
-        process();
-    }
-
-    return display();
-}
-
-void ADM_flyDialog::copyYuvFinalToRgb(void)
-{
-	if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
-		_resizer->resize(_yuvBufferOut->data, _rgbBufferOut);
-	else
-		_rgb->scale(_yuvBufferOut->data, _rgbBufferOut);
-}
-
-void ADM_flyDialog::copyYuvScratchToRgb(void)
-{
-	if (_resizeMethod == RESIZE_AUTO)
-		_resizer->resize(_yuvBuffer->data,_rgbBuffer);
-	else
-		_rgb->scale(_yuvBuffer->data,_rgbBuffer);
-}
-
-void ADM_flyDialog::copyRgbFinalToDisplay(void)
-{
-	if (_resizeMethod == RESIZE_LAST)
-	{
-		_resizer->resize(_rgbBufferOut, _rgbBufferDisplay);
-
-		uint8_t* tempRgb = _rgbBufferDisplay;
-
-		_rgbBufferDisplay = _rgbBufferOut;
-		_rgbBufferOut = tempRgb;
-	}
-}
-
-//EOF
-



From mean at mail.berlios.de  Mon Dec 21 14:31:45 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:45 +0100
Subject: [Avidemux-svn-commit] r5689 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <200912211331.nBLDVjxT028274@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:44 +0100 (Mon, 21 Dec 2009)
New Revision: 5689

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
Log:
[guiplay] Remove reference to GenericVideoStream

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2009-12-21 13:31:42 UTC (rev 5688)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2009-12-21 13:31:44 UTC (rev 5689)
@@ -21,8 +21,6 @@
 #include "avi_vars.h"
 #include "audio_out.h"
 #include "DIA_coreToolkit.h"
-//#include "ADM_videoFilter.h"
-//#include "ADM_videoFilter_internal.h"
 #include "gtkgui.h"
 #include "ADM_render/GUI_render.h"
 #include "avidemutils.h"
@@ -93,7 +91,6 @@
 {
     
     uint32_t framelen,flags;
-    AVDMGenericVideoStream *filter;
     uint32_t max,err;
     uint64_t oldTimeFrame;
    



From mean at mail.berlios.de  Mon Dec 21 14:31:47 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:47 +0100
Subject: [Avidemux-svn-commit] r5690 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src
Message-ID: <200912211331.nBLDVl2T028295@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:46 +0100 (Mon, 21 Dec 2009)
New Revision: 5690

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractor.cpp
Log:
[infoExtractor] Re-indent + return frame rate in case of field, i.e 50/60 for interlaced h264

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractor.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractor.cpp	2009-12-21 13:31:44 UTC (rev 5689)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_infoExtractor.cpp	2009-12-21 13:31:46 UTC (rev 5690)
@@ -24,116 +24,123 @@
 #include "ADM_videoInfoExtractor.h"
 #include "ADM_h264_tag.h"
 
-static void refineH264FrameType(uint8_t *head,uint8_t *tail,uint32_t *flags);
-bool ADM_findMpegStartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset);
+static void refineH264FrameType (uint8_t * head, uint8_t * tail,
+				 uint32_t * flags);
+bool ADM_findMpegStartCode (uint8_t * start, uint8_t * end,
+			    uint8_t * outstartcode, uint32_t * offset);
 /*
     Extract width & height from vol header passed as arg
 
 
 */
-uint8_t extractMpeg4Info(uint8_t *data,uint32_t dataSize,uint32_t *w,uint32_t *h,uint32_t *time_inc)
+uint8_t
+extractMpeg4Info (uint8_t * data, uint32_t dataSize, uint32_t * w,
+		  uint32_t * h, uint32_t * time_inc)
 {
-    // Search startcode
-    uint8_t b;
-    uint32_t idx=0;
-    uint32_t mw,mh;
-    uint32_t timeVal;
-    
-    //mixDump(data,dataSize);
-    //printf("\n");
-    while(1)
+  // Search startcode
+  uint8_t b;
+  uint32_t idx = 0;
+  uint32_t mw, mh;
+  uint32_t timeVal;
+
+  //mixDump(data,dataSize);
+  //printf("\n");
+  while (1)
     {
-        uint32_t startcode=0xffffffff;
-        while(dataSize>2)
-        {
-            startcode=(startcode<<8)+data[idx];
-            idx++;
-            dataSize--;
-            if((startcode&0xffffff)==1) break;
-        }
-        if(dataSize>2)
-        {
-            //printf("Startcodec:%x\n",data[idx]);
-            if((data[idx]&0xF0)==0x20) //VOL start
-            {
-                dataSize--;
-                idx++;
+      uint32_t startcode = 0xffffffff;
+      while (dataSize > 2)
+	{
+	  startcode = (startcode << 8) + data[idx];
+	  idx++;
+	  dataSize--;
+	  if ((startcode & 0xffffff) == 1)
+	    break;
+	}
+      if (dataSize > 2)
+	{
+	  //printf("Startcodec:%x\n",data[idx]);
+	  if ((data[idx] & 0xF0) == 0x20)	//VOL start
+	    {
+	      dataSize--;
+	      idx++;
 #if 0
-                printf("VOL Header:\n");
+	      printf ("VOL Header:\n");
 
-                if(dataSize<16)
-                {
-                  mixDump(data+idx,dataSize);printf("\n");
-                }
-                else
-                {
-                  mixDump(data+idx,16);printf("\n");
-                }
+	      if (dataSize < 16)
+		{
+		  mixDump (data + idx, dataSize);
+		  printf ("\n");
+		}
+	      else
+		{
+		  mixDump (data + idx, 16);
+		  printf ("\n");
+		}
 #endif
-                // Here we go !
-                GetBitContext s;
-                init_get_bits( &s,data+idx, dataSize*8);
-                //
-                skip_bits1(&s); // Random access
-                skip_bits(&s,8); // Obj type indication
-                if(get_bits(&s,1)) // VO od 
-                {
-                      skip_bits(&s,4); // Ver
-                      skip_bits(&s,3);  // Priority
-                }
-                if(get_bits(&s,4)==15) // custom A/R
-                {
-                      skip_bits(&s,8);
-                      skip_bits(&s,8);
-                }
-                if(get_bits(&s,1)) // Vol control param
-                {
-                      skip_bits(&s,2);   //Chroma
-                      skip_bits(&s,1);   // Low delay
-                      if(get_bits(&s,1)) // VBV Info
-                      {
-                        skip_bits(&s,16);
-                        skip_bits(&s,16);
-                        skip_bits(&s,16);
-                        skip_bits(&s,15);
-                        skip_bits(&s,16);
-                      }
-                  }
-                 skip_bits(&s,2); //  Shape
-                 skip_bits(&s,1); //  Marker
-                 timeVal=get_bits(&s,16); // Time increment
-                 *time_inc = av_log2(timeVal - 1) + 1;
-                 if (*time_inc < 1)
-                    *time_inc = 1;
-                 skip_bits(&s,1); //  Marker
-                 if(get_bits(&s,1)) // Fixed vop rate, compute how much bits needed
-                 {
-                     get_bits(&s, *time_inc);
-                 }
-                  skip_bits(&s,1); //  Marker
-                  mw=get_bits(&s,13);
-                  skip_bits(&s,1); //  Marker
-                  mh=get_bits(&s,13);
-                // /Here we go
-                //printf("%d x %d \n",mw,mh);
-                *h=mh;
-                *w=mw;
-                return 1;;
-                // Free get bits ?
-                // WTF ?
-            }
-            continue;
-        }
-        else
-        {
-            printf("No more startcode\n");
-            // Free get bits ?
-            return 0;
-            
-        }
+	      // Here we go !
+	      GetBitContext s;
+	      init_get_bits (&s, data + idx, dataSize * 8);
+	      //
+	      skip_bits1 (&s);	// Random access
+	      skip_bits (&s, 8);	// Obj type indication
+	      if (get_bits (&s, 1))	// VO od 
+		{
+		  skip_bits (&s, 4);	// Ver
+		  skip_bits (&s, 3);	// Priority
+		}
+	      if (get_bits (&s, 4) == 15)	// custom A/R
+		{
+		  skip_bits (&s, 8);
+		  skip_bits (&s, 8);
+		}
+	      if (get_bits (&s, 1))	// Vol control param
+		{
+		  skip_bits (&s, 2);	//Chroma
+		  skip_bits (&s, 1);	// Low delay
+		  if (get_bits (&s, 1))	// VBV Info
+		    {
+		      skip_bits (&s, 16);
+		      skip_bits (&s, 16);
+		      skip_bits (&s, 16);
+		      skip_bits (&s, 15);
+		      skip_bits (&s, 16);
+		    }
+		}
+	      skip_bits (&s, 2);	//  Shape
+	      skip_bits (&s, 1);	//  Marker
+	      timeVal = get_bits (&s, 16);	// Time increment
+	      *time_inc = av_log2 (timeVal - 1) + 1;
+	      if (*time_inc < 1)
+		*time_inc = 1;
+	      skip_bits (&s, 1);	//  Marker
+	      if (get_bits (&s, 1))	// Fixed vop rate, compute how much bits needed
+		{
+		  get_bits (&s, *time_inc);
+		}
+	      skip_bits (&s, 1);	//  Marker
+	      mw = get_bits (&s, 13);
+	      skip_bits (&s, 1);	//  Marker
+	      mh = get_bits (&s, 13);
+	      // /Here we go
+	      //printf("%d x %d \n",mw,mh);
+	      *h = mh;
+	      *w = mw;
+	      return 1;;
+	      // Free get bits ?
+	      // WTF ?
+	    }
+	  continue;
+	}
+      else
+	{
+	  printf ("No more startcode\n");
+	  // Free get bits ?
+	  return 0;
+
+	}
     }
-    
-    return 0;
+
+  return 0;
 }
 /**
     \fn extractVopInfo
@@ -142,236 +149,273 @@
     Warning this function expects data to start AFTER startcode, contrarily to other functions here!
 */
 
-uint8_t extractVopInfo(uint8_t *data, uint32_t len,uint32_t timeincbits,uint32_t *vopType,uint32_t *modulo, uint32_t *time_inc,uint32_t *vopcoded)
+uint8_t
+extractVopInfo (uint8_t * data, uint32_t len, uint32_t timeincbits,
+		uint32_t * vopType, uint32_t * modulo, uint32_t * time_inc,
+		uint32_t * vopcoded)
 {
-   GetBitContext s;
-   int vop;
-   uint32_t vp,tinc;
-           init_get_bits( &s,data, len*8);
-           vop=get_bits(&s,2);
-           switch(vop)
-           {
-             case 0: vp=AVI_KEY_FRAME;break;
-             case 1: vp=0;break;
-             case 2: vp=AVI_B_FRAME;break;
-             case 3: vp=0;break;  // D FRAME ????
-             default:
-                printf("Unknown vop type :%d\n",vop);
-                return 0;
-           }
-           /* Read modulo */
-           int imodulo=0;
-           while (get_bits1(&s) != 0)
-                  imodulo++;
-           if(!get_bits1(&s))
-           {
-              printf("Wrong marker1\n");
-              return 0; 
-           }
-           
-           /* Read time */
-           tinc=get_bits(&s,timeincbits);
-           /* Marker */
-            if(!get_bits1(&s))
-           {
-              printf("Wrong marker2\n");
-              return 0; 
-           }
-           /* Vop coded */
-           *modulo=imodulo;
-           *vopcoded=get_bits1(&s);
-           *vopType=vp;
-           *time_inc=tinc;
-           return 1;
+  GetBitContext s;
+  int vop;
+  uint32_t vp, tinc;
+  init_get_bits (&s, data, len * 8);
+  vop = get_bits (&s, 2);
+  switch (vop)
+    {
+    case 0:
+      vp = AVI_KEY_FRAME;
+      break;
+    case 1:
+      vp = 0;
+      break;
+    case 2:
+      vp = AVI_B_FRAME;
+      break;
+    case 3:
+      vp = 0;
+      break;			// D FRAME ????
+    default:
+      printf ("Unknown vop type :%d\n", vop);
+      return 0;
+    }
+  /* Read modulo */
+  int imodulo = 0;
+  while (get_bits1 (&s) != 0)
+    imodulo++;
+  if (!get_bits1 (&s))
+    {
+      printf ("Wrong marker1\n");
+      return 0;
+    }
+
+  /* Read time */
+  tinc = get_bits (&s, timeincbits);
+  /* Marker */
+  if (!get_bits1 (&s))
+    {
+      printf ("Wrong marker2\n");
+      return 0;
+    }
+  /* Vop coded */
+  *modulo = imodulo;
+  *vopcoded = get_bits1 (&s);
+  *vopType = vp;
+  *time_inc = tinc;
+  return 1;
 }
 /**
       \brief extractH263FLVInfo
       \fn Extract width/height from FLV header
 */
-uint8_t extractH263FLVInfo(uint8_t *buffer,uint32_t len,uint32_t *w,uint32_t *h)
+uint8_t
+extractH263FLVInfo (uint8_t * buffer, uint32_t len, uint32_t * w,
+		    uint32_t * h)
 {
-        GetBitContext gb;
-        int format;
-        init_get_bits( &gb,buffer, len*8);
-        if (get_bits_long(&gb, 17) != 1) {
-            printf("[FLV]Wrong FLV1 header\n");
-            return 0;
-        }
-        format = get_bits(&gb, 5);
-        if (format != 0 && format != 1) {
-            printf("[FLV]Wrong FLV1 header format\n");
-            return 0;        }
-        
-        get_bits(&gb, 8); /* picture timestamp */
-        format = get_bits(&gb, 3);
-        switch (format) {
-        case 0:
-            *w = get_bits(&gb, 8);
-            *h = get_bits(&gb, 8);
-            break;
-        case 1:
-            *w = get_bits(&gb, 16);
-            *h = get_bits(&gb, 16);
-            break;
-        case 2:
-            *w = 352;
-            *h = 288;
-            break;
-        case 3:
-            *w = 176;
-            *h = 144;
-            break;
-        case 4:
-            *w = 128;
-            *h = 96;
-            break;
-        case 5:
-            *w = 320;
-            *h = 240;
-            break;
-        case 6:
-            *w = 160;
-            *h = 120;
-            break;
-        default:
-             printf("[FLV]Wrong width format\n");
-             return 0;
-            break;
-        }
-        return 1;
+  GetBitContext gb;
+  int format;
+  init_get_bits (&gb, buffer, len * 8);
+  if (get_bits_long (&gb, 17) != 1)
+    {
+      printf ("[FLV]Wrong FLV1 header\n");
+      return 0;
+    }
+  format = get_bits (&gb, 5);
+  if (format != 0 && format != 1)
+    {
+      printf ("[FLV]Wrong FLV1 header format\n");
+      return 0;
+    }
+
+  get_bits (&gb, 8);		/* picture timestamp */
+  format = get_bits (&gb, 3);
+  switch (format)
+    {
+    case 0:
+      *w = get_bits (&gb, 8);
+      *h = get_bits (&gb, 8);
+      break;
+    case 1:
+      *w = get_bits (&gb, 16);
+      *h = get_bits (&gb, 16);
+      break;
+    case 2:
+      *w = 352;
+      *h = 288;
+      break;
+    case 3:
+      *w = 176;
+      *h = 144;
+      break;
+    case 4:
+      *w = 128;
+      *h = 96;
+      break;
+    case 5:
+      *w = 320;
+      *h = 240;
+      break;
+    case 6:
+      *w = 160;
+      *h = 120;
+      break;
+    default:
+      printf ("[FLV]Wrong width format\n");
+      return 0;
+      break;
+    }
+  return 1;
 }
 /*
         Extract H263 width & height from header
 
 */
-uint8_t extractH263Info(uint8_t *data,uint32_t dataSize,uint32_t *w,uint32_t *h)
+uint8_t
+extractH263Info (uint8_t * data, uint32_t dataSize, uint32_t * w,
+		 uint32_t * h)
 {
-uint32_t val;
-                GetBitContext s;
-                init_get_bits( &s,data, dataSize*8);
-                
-                 mixDump(data,10);
-                 val=get_bits(&s,16);
-                 if(val)
-                 {
-                    printf("incorrect H263 header sync\n");
-                    return 0;
-                 }
-                 val=get_bits(&s,6);
-                 if(val!=0x20)
-                 {
-                    printf("incorrect H263 header sync (2)\n");
-                    return 0;
-                 }
-                 //
-                 skip_bits(&s,8); // timestamps in 30 fps tick
-                 skip_bits(&s,1); // Marker
-                 skip_bits(&s,1); // Id
-                 skip_bits(&s,1); // Split
-                 skip_bits(&s,1); // Document Camera indicator
-                 skip_bits(&s,1); // Full Picture Freeze Release
-                 val=get_bits(&s,3);
-                 switch(val)
-                 {
-                   
-                    case 1: *w=128;*h=96;return 1;break;
-                    case 2: *w=176;*h=144;return 1;break;
-                    case 6:
-                    case 7:
-                            printf("H263+:Todo\n");
-                    default:
-                        printf("Invalid format\n");return 0;break;
-                 }
-                 return 0;
+  uint32_t val;
+  GetBitContext s;
+  init_get_bits (&s, data, dataSize * 8);
+
+  mixDump (data, 10);
+  val = get_bits (&s, 16);
+  if (val)
+    {
+      printf ("incorrect H263 header sync\n");
+      return 0;
+    }
+  val = get_bits (&s, 6);
+  if (val != 0x20)
+    {
+      printf ("incorrect H263 header sync (2)\n");
+      return 0;
+    }
+  //
+  skip_bits (&s, 8);		// timestamps in 30 fps tick
+  skip_bits (&s, 1);		// Marker
+  skip_bits (&s, 1);		// Id
+  skip_bits (&s, 1);		// Split
+  skip_bits (&s, 1);		// Document Camera indicator
+  skip_bits (&s, 1);		// Full Picture Freeze Release
+  val = get_bits (&s, 3);
+  switch (val)
+    {
+
+    case 1:
+      *w = 128;
+      *h = 96;
+      return 1;
+      break;
+    case 2:
+      *w = 176;
+      *h = 144;
+      return 1;
+      break;
+    case 6:
+    case 7:
+      printf ("H263+:Todo\n");
+    default:
+      printf ("Invalid format\n");
+      return 0;
+      break;
+    }
+  return 0;
 }
 /**
     \fn unescapeH264
     \brief Remove escape stuff
 
 */
-static uint32_t unescapeH264(uint32_t len,uint8_t *in, uint8_t *out)
+static uint32_t
+unescapeH264 (uint32_t len, uint8_t * in, uint8_t * out)
 {
-  uint32_t outlen=0;
-  uint8_t *tail=in+len;
-    if(len<3) return 0;
-    while(in<tail-3)
+  uint32_t outlen = 0;
+  uint8_t *tail = in + len;
+  if (len < 3)
+    return 0;
+  while (in < tail - 3)
     {
-      if(!in[0]  && !in[1] && in[2]==3)
-      {
-        out[0]=0;
-        out[1]=0;
-        out+=2;
-        outlen+=2;
-        in+=3; 
-      }
-      *out++=*in++;
+      if (!in[0] && !in[1] && in[2] == 3)
+	{
+	  out[0] = 0;
+	  out[1] = 0;
+	  out += 2;
+	  outlen += 2;
+	  in += 3;
+	}
+      *out++ = *in++;
       outlen++;
     }
-    // copy last bytes
-    uint32_t left=tail-in;
-    memcpy(out,in,left);
-    outlen+=left;
-    return outlen;
-    
+  // copy last bytes
+  uint32_t left = tail - in;
+  memcpy (out, in, left);
+  outlen += left;
+  return outlen;
+
 }
 /**
         \fn extractVUIInfo
 */
-static uint8_t extractVUIInfo(GetBitContext *s, uint32_t *fps1000, uint32_t *darNum, uint32_t *darDen)
+static uint8_t
+extractVUIInfo (GetBitContext * s, uint32_t * fps1000, uint32_t * darNum,
+		uint32_t * darDen)
 {
-	*fps1000 = *darNum = *darDen = 0;
+  *fps1000 = *darNum = *darDen = 0;
 
-	if (get_bits1(s))
+  if (get_bits1 (s))
+    {
+      unsigned int aspect_ratio_information = get_bits (s, 8);
+
+      if (aspect_ratio_information == 255)
 	{
-		unsigned int aspect_ratio_information = get_bits(s, 8);
-
-		if (aspect_ratio_information == 255)
-		{
-			*darNum = get_bits_long(s, 16);
-			*darDen = get_bits_long(s, 16);
-		}
-		else if (aspect_ratio_information < sizeof(pixel_aspect) / sizeof(*pixel_aspect))
-		{
-			*darNum = pixel_aspect[aspect_ratio_information].num;
-			*darDen = pixel_aspect[aspect_ratio_information].den;
-		}
+	  *darNum = get_bits_long (s, 16);
+	  *darDen = get_bits_long (s, 16);
 	}
+      else if (aspect_ratio_information <
+	       sizeof (pixel_aspect) / sizeof (*pixel_aspect))
+	{
+	  *darNum = pixel_aspect[aspect_ratio_information].num;
+	  *darDen = pixel_aspect[aspect_ratio_information].den;
+	}
+    }
 
-	if (get_bits1(s))	// overscan
-		get_bits1(s);
+  if (get_bits1 (s))		// overscan
+    get_bits1 (s);
 
-	if (get_bits1(s))	// vsp_color
-	{
-		get_bits(s, 4);
+  if (get_bits1 (s))		// vsp_color
+    {
+      get_bits (s, 4);
 
-		if (get_bits1(s))
-		{
-			get_bits(s, 8);
-			get_bits(s, 8);
-			get_bits(s, 8);
-		}
-	}
-
-	if (get_bits1(s))	// chroma
+      if (get_bits1 (s))
 	{
-		get_ue_golomb(s);
-		get_ue_golomb(s);
+	  get_bits (s, 8);
+	  get_bits (s, 8);
+	  get_bits (s, 8);
 	}
+    }
 
-	if (get_bits1(s))	// timing
-	{
-		uint32_t timeinc_unit = get_bits_long(s, 32);
-		uint32_t timeinc_resolution = get_bits_long(s, 32);
-		uint32_t fixed_fps = get_bits1(s);
+  if (get_bits1 (s))		// chroma
+    {
+      get_ue_golomb (s);
+      get_ue_golomb (s);
+    }
 
-		if (timeinc_unit > 0 && timeinc_resolution > 0)
-			*fps1000 = (uint32_t)(((float)timeinc_resolution / (float)timeinc_unit) * 1000);
+  if (get_bits1 (s))		// timing
+    {
+      uint32_t timeinc_unit = get_bits_long (s, 32);
+      uint32_t timeinc_resolution = get_bits_long (s, 32);
+      uint32_t fixed_fps = get_bits1 (s);
 
-		if (fixed_fps)
-			*fps1000 /= 2;
-	}
+      if (timeinc_unit > 0 && timeinc_resolution > 0)
+	*fps1000 =
+	  (uint32_t) (((float) timeinc_resolution / (float) timeinc_unit) *
+		      1000);
+/* No!
+      if (fixed_fps)
+	*fps1000 /= 2;
+*/
+    }
 
-	return 1;
+  return 1;
 }
 
 /**
@@ -379,151 +423,163 @@
     \brief Extract info from H264 SPS
     See 7.3.2.1 of 14496-10
 */
-uint8_t extractSPSInfo(uint8_t *data, uint32_t len,uint32_t *wwidth,uint32_t *hheight, uint32_t *fps1000, uint32_t *darNum, uint32_t *darDen)
+uint8_t
+extractSPSInfo (uint8_t * data, uint32_t len, uint32_t * wwidth,
+		uint32_t * hheight, uint32_t * fps1000, uint32_t * darNum,
+		uint32_t * darDen)
 {
-   GetBitContext s;
-   
-   uint32_t profile,constraint,level,pic_order_cnt_type,w,h, mbh, frame_mbs_only;
-   uint8_t buf[len];
-   uint32_t outlen;
-   uint32_t id,dum;
-   
-           outlen=unescapeH264(len,data,buf);
-           init_get_bits( &s,buf, outlen*8);
-            
-           profile=get_bits(&s,8);
-           constraint=get_bits(&s,8)>>5;
-           level=get_bits(&s,8);
-           id=get_ue_golomb(&s); // Seq parameter set id           
-           printf("[H264]Profile : %u, Level :%u, SPSid:%u\n",profile,level,id);
-           if(profile>=100) // ?? Borrowed from H264.C/FFMPEG
-           {
-                printf("[H264]Warning : High profile\n");
-                if(get_ue_golomb(&s) == 3) //chroma_format_idc
-                    get_bits1(&s);  //residual_color_transform_flag
-                get_ue_golomb(&s);  //bit_depth_luma_minus8
-                get_ue_golomb(&s);  //bit_depth_chroma_minus8
-                get_bits1(&s);      // Transform bypass
-                if (get_bits1(&s)) // Scaling matrix
-                {
-                    printf("[H264] Scaling matrix present\n");
-                    get_bits(&s, 8);
-                }
-           }
-           
+  GetBitContext s;
 
-           dum=get_ue_golomb(&s); // log2_max_frame_num_minus4
-           printf("[H264]Log2maxFrame-4:%u\n",dum);
-           pic_order_cnt_type=get_ue_golomb(&s);
-           printf("[H264]Pic Order Cnt Type:%u\n",pic_order_cnt_type);
-           if(!pic_order_cnt_type) // pic_order_cnt_type
-           {
-              dum=get_ue_golomb(&s); //log2_max_pic_order_cnt_lsb_minus4
-              printf("[H264]Log2maxPix-4:%u\n",dum);
-           }else
-           {
-             if(pic_order_cnt_type==1)
-             {
-                 get_bits1(&s);   //delta_pic_order_always_zero_flag
-                 get_se_golomb(&s);   //offset_for_non_ref_pic
-                 get_se_golomb(&s);  // offset_for_top_to_bottom_field
-                 int i=get_ue_golomb(&s);  //num_ref_frames_in_pic_order_cnt_cycle
+  uint32_t profile, constraint, level, pic_order_cnt_type, w, h, mbh,
+    frame_mbs_only;
+  uint8_t buf[len];
+  uint32_t outlen;
+  uint32_t id, dum;
 
-                 for(int j=0;j<i;j++)
-                 {
-                      get_se_golomb(&s);
-                 }
-             }else if(pic_order_cnt_type!=2)
-             {
-               printf("Error in SPS\n");
-               return 0;
-             }
-           }
-           dum=get_ue_golomb(&s);     //num_ref_frames
-           printf("[H264] # of ref frames : %u\n",dum);
-           get_bits1(&s);         // gaps_in_frame_num_value_allowed_flag
-		   w = get_ue_golomb(&s) + 1;   //pic_width_in_mbs_minus1
+  outlen = unescapeH264 (len, data, buf);
+  init_get_bits (&s, buf, outlen * 8);
 
-		   mbh = get_ue_golomb(&s) + 1;
-		   frame_mbs_only = get_bits1(&s);
-		   h = (2 - frame_mbs_only) * mbh;   //pic_height_in_mbs_minus1
+  profile = get_bits (&s, 8);
+  constraint = get_bits (&s, 8) >> 5;
+  level = get_bits (&s, 8);
+  id = get_ue_golomb (&s);	// Seq parameter set id           
+  printf ("[H264]Profile : %u, Level :%u, SPSid:%u\n", profile, level, id);
+  if (profile >= 100)		// ?? Borrowed from H264.C/FFMPEG
+    {
+      printf ("[H264]Warning : High profile\n");
+      if (get_ue_golomb (&s) == 3)	//chroma_format_idc
+	get_bits1 (&s);		//residual_color_transform_flag
+      get_ue_golomb (&s);	//bit_depth_luma_minus8
+      get_ue_golomb (&s);	//bit_depth_chroma_minus8
+      get_bits1 (&s);		// Transform bypass
+      if (get_bits1 (&s))	// Scaling matrix
+	{
+	  printf ("[H264] Scaling matrix present\n");
+	  get_bits (&s, 8);
+	}
+    }
 
-           printf("[H264] Width in mb -1  :%d\n",w); 
-           printf("[H264] Height in mb -1 :%d\n", h);
 
-		   *wwidth = w * 16;
-		   *hheight= h * 16;
-           
-		   if (!frame_mbs_only)
-			   get_bits1(&s);
+  dum = get_ue_golomb (&s);	// log2_max_frame_num_minus4
+  printf ("[H264]Log2maxFrame-4:%u\n", dum);
+  pic_order_cnt_type = get_ue_golomb (&s);
+  printf ("[H264]Pic Order Cnt Type:%u\n", pic_order_cnt_type);
+  if (!pic_order_cnt_type)	// pic_order_cnt_type
+    {
+      dum = get_ue_golomb (&s);	//log2_max_pic_order_cnt_lsb_minus4
+      printf ("[H264]Log2maxPix-4:%u\n", dum);
+    }
+  else
+    {
+      if (pic_order_cnt_type == 1)
+	{
+	  get_bits1 (&s);	//delta_pic_order_always_zero_flag
+	  get_se_golomb (&s);	//offset_for_non_ref_pic
+	  get_se_golomb (&s);	// offset_for_top_to_bottom_field
+	  int i = get_ue_golomb (&s);	//num_ref_frames_in_pic_order_cnt_cycle
 
-		   get_bits1(&s);
+	  for (int j = 0; j < i; j++)
+	    {
+	      get_se_golomb (&s);
+	    }
+	}
+      else if (pic_order_cnt_type != 2)
+	{
+	  printf ("Error in SPS\n");
+	  return 0;
+	}
+    }
+  dum = get_ue_golomb (&s);	//num_ref_frames
+  printf ("[H264] # of ref frames : %u\n", dum);
+  get_bits1 (&s);		// gaps_in_frame_num_value_allowed_flag
+  w = get_ue_golomb (&s) + 1;	//pic_width_in_mbs_minus1
 
-		   if(get_bits1(&s))
-		   {
-			   get_ue_golomb(&s);
-			   get_ue_golomb(&s);
-			   get_ue_golomb(&s);
-			   get_ue_golomb(&s);
-		   }
+  mbh = get_ue_golomb (&s) + 1;
+  frame_mbs_only = get_bits1 (&s);
+  h = (2 - frame_mbs_only) * mbh;	//pic_height_in_mbs_minus1
 
-		   if(get_bits1(&s))
-           {
-			   extractVUIInfo(&s, fps1000, darNum, darDen);
-               printf("[H264] Fps %"LU", a.r. %"LU",%"LU"\n",*fps1000,*darNum,*darDen);
-           }else
-            {
-                printf("[H264] Unknown FPS, setting 25\n");
-                *fps1000=25000;
-            }
-           return 1;
+  printf ("[H264] Width in mb -1  :%d\n", w);
+  printf ("[H264] Height in mb -1 :%d\n", h);
+
+  *wwidth = w * 16;
+  *hheight = h * 16;
+
+  if (!frame_mbs_only)
+    get_bits1 (&s);
+
+  get_bits1 (&s);
+
+  if (get_bits1 (&s))
+    {
+      get_ue_golomb (&s);
+      get_ue_golomb (&s);
+      get_ue_golomb (&s);
+      get_ue_golomb (&s);
+    }
+
+  if (get_bits1 (&s))
+    {
+      extractVUIInfo (&s, fps1000, darNum, darDen);
+      printf ("[H264] Fps %" LU ", a.r. %" LU ",%" LU "\n", *fps1000, *darNum,
+	      *darDen);
+    }
+  else
+    {
+      printf ("[H264] Unknown FPS, setting 25\n");
+      *fps1000 = 25000;
+    }
+  return 1;
 }
 /**
       \fn extractH264FrameType
       \brief return frametype in flags (KEY_FRAME or 0). To be used only with  mkv/mp4 nal type (i.e. no startcode)
       
 */
-uint8_t extractH264FrameType(uint32_t nalSize,uint8_t *buffer,uint32_t len,uint32_t *flags)
+uint8_t
+extractH264FrameType (uint32_t nalSize, uint8_t * buffer, uint32_t len,
+		      uint32_t * flags)
 {
-  uint8_t *head=buffer, *tail=buffer+len;
+  uint8_t *head = buffer, *tail = buffer + len;
   uint8_t stream;
-  
-  uint32_t val,hnt;  
-  
+
+  uint32_t val, hnt;
+
 // FIXME :  no startcode only !
-  
-  while(head+4<tail)
-  {
-    
-              uint32_t length=(head[0]<<24) + (head[1]<<16) +(head[2]<<8)+(head[3]);
-              //printf("Block size : %"LU", available : %"LU"\n",length,len);
-              if(length>len||length<6)
-              {
-                printf("Warning , incomplete nal (%u/%u),(%0x/%0x)\n",length,len,length,len);
-                *flags=0;
-                return 0;
-              }
-              head+=4; // Skip nal lenth
-              stream=*(head)&0x1F;
-                switch(stream)
-                {
-                  case NAL_IDR: 
-                                  *flags=AVI_KEY_FRAME;
-                                  
-                                  return 1;
-                                  break; 
-                  case NAL_NON_IDR: 
-                                  refineH264FrameType(head+1,tail,flags);
-                                  return 1;
-                                  break;                  
-                  default:
-                          printf("??0x%x\n",stream);
-                  case NAL_SEI:  
-                          head+=length;
-                          continue;
-                }
-  }
-  printf("No stream\n");
+
+  while (head + 4 < tail)
+    {
+
+      uint32_t length =
+	(head[0] << 24) + (head[1] << 16) + (head[2] << 8) + (head[3]);
+      //printf("Block size : %"LU", available : %"LU"\n",length,len);
+      if (length > len || length < 6)
+	{
+	  printf ("Warning , incomplete nal (%u/%u),(%0x/%0x)\n", length, len,
+		  length, len);
+	  *flags = 0;
+	  return 0;
+	}
+      head += 4;		// Skip nal lenth
+      stream = *(head) & 0x1F;
+      switch (stream)
+	{
+	case NAL_IDR:
+	  *flags = AVI_KEY_FRAME;
+
+	  return 1;
+	  break;
+	case NAL_NON_IDR:
+	  refineH264FrameType (head + 1, tail, flags);
+	  return 1;
+	  break;
+	default:
+	  printf ("??0x%x\n", stream);
+	case NAL_SEI:
+	  head += length;
+	  continue;
+	}
+    }
+  printf ("No stream\n");
   return 0;
 }
 
@@ -532,73 +588,78 @@
       \brief return frametype in flags (KEY_FRAME or 0). To be used only with  avi / mpeg TS nal type (i.e. with startcode)
       
 */
-uint8_t extractH264FrameType_startCode(uint32_t nalSize,uint8_t *buffer,uint32_t len,uint32_t *flags)
+uint8_t
+extractH264FrameType_startCode (uint32_t nalSize, uint8_t * buffer,
+				uint32_t len, uint32_t * flags)
 {
-  uint8_t *head=buffer, *tail=buffer+len;
+  uint8_t *head = buffer, *tail = buffer + len;
   uint8_t stream;
 #define NAL_NON_IDR       1
 #define NAL_IDR           5
 #define NAL_SEI           6
 
-  uint32_t val,hnt;  
-  
+  uint32_t val, hnt;
+
 // FIXME :  no startcode only !
-  
-  while(head+4<tail)
-  {
-          // Search startcode
-      
-                hnt=(head[0]<<24) + (head[1]<<16) +(head[2]<<8)+(head[3]);
-                head+=4;
-                while((hnt!=1) && head<tail)
-                {
 
-                        hnt<<=8;
-                        val=*head++;
-                        hnt+=val;
-                }
-                if(head>=tail) break;
-                stream=*(head++) &0x1f;
-                switch(stream)
-                {
-                  case NAL_IDR: 
-                                  *flags=AVI_KEY_FRAME;
-                                 // printf("IDR\n");
-                                  return 1;
-                                  break; 
-                  case NAL_NON_IDR: 
-                                  refineH264FrameType(head,tail,flags);
-                                  return 1;
-                                  break;
-                  default:
-                          printf("??0x%x\n",stream);
-                          continue;
-                }
-  }
-  printf("No stream\n");
+  while (head + 4 < tail)
+    {
+      // Search startcode
+
+      hnt = (head[0] << 24) + (head[1] << 16) + (head[2] << 8) + (head[3]);
+      head += 4;
+      while ((hnt != 1) && head < tail)
+	{
+
+	  hnt <<= 8;
+	  val = *head++;
+	  hnt += val;
+	}
+      if (head >= tail)
+	break;
+      stream = *(head++) & 0x1f;
+      switch (stream)
+	{
+	case NAL_IDR:
+	  *flags = AVI_KEY_FRAME;
+	  // printf("IDR\n");
+	  return 1;
+	  break;
+	case NAL_NON_IDR:
+	  refineH264FrameType (head, tail, flags);
+	  return 1;
+	  break;
+	default:
+	  printf ("??0x%x\n", stream);
+	  continue;
+	}
+    }
+  printf ("No stream\n");
   return 0;
 }
 /**
     \fn refineH264FrameType
     \brief Try to detect B slice, warning the stream is not escaped!
 */
-void refineH264FrameType(uint8_t *head,uint8_t *tail,uint32_t *flags)
+void
+refineH264FrameType (uint8_t * head, uint8_t * tail, uint32_t * flags)
 {
-GetBitContext s;
-uint32_t sliceType;
-            *flags=0;
-            init_get_bits(&s,head, (tail-head)*8);
-            get_ue_golomb(&s);
-            sliceType= get_ue_golomb_31(&s);
-            if(sliceType > 9) 
-            {
-              printf("Weird Slice %d\n",sliceType);
-              return ;
-            }
-            if(sliceType > 4)
-                sliceType -= 5;
-            if(sliceType==1) *flags=AVI_B_FRAME;
-            //printf("[H264] Slice type : %"LU"\n",sliceType);
+  GetBitContext s;
+  uint32_t sliceType;
+  *flags = 0;
+  init_get_bits (&s, head, (tail - head) * 8);
+  get_ue_golomb (&s);
+  sliceType = get_ue_golomb_31 (&s);
+  if (sliceType > 9)
+    {
+      printf ("Weird Slice %d\n", sliceType);
+      return;
+    }
+  if (sliceType > 4)
+    sliceType -= 5;
+  if (sliceType == 1)
+    *flags = AVI_B_FRAME;
+  //printf("[H264] Slice type : %"LU"\n",sliceType);
 }
 /**
     \fn ADM_searchVop
@@ -606,69 +667,88 @@
     Used for packed bitstream and also to identify the frametype
 
 */
-uint32_t ADM_searchVop(uint8_t *begin, uint8_t *end,uint32_t *nb, ADM_vopS *vop,uint32_t *timeincbits)
+uint32_t
+ADM_searchVop (uint8_t * begin, uint8_t * end, uint32_t * nb, ADM_vopS * vop,
+	       uint32_t * timeincbits)
 {
 
-	uint32_t off=0;
-	uint32_t globalOff=0;
-	uint32_t voptype;
-	uint8_t code;
-        uint32_t w,h,t;
-        uint32_t modulo,time_inc,vopcoded,vopType;
-	*nb=0;
-	while(begin<end-3)
+  uint32_t off = 0;
+  uint32_t globalOff = 0;
+  uint32_t voptype;
+  uint8_t code;
+  uint32_t w, h, t;
+  uint32_t modulo, time_inc, vopcoded, vopType;
+  *nb = 0;
+  while (begin < end - 3)
+    {
+      if (ADM_findMpegStartCode (begin, end, &code, &off))
 	{
-    	if( ADM_findMpegStartCode(begin, end,&code,&off))
-    	{
-        	if(code==0xb6)
-			{
-				// Analyse a bit the vop header
-				uint8_t coding_type=begin[off];
-				coding_type>>=6;
-				aprintf("\t at %u %d Img type:%s\n",off,*nb,s_voptype[coding_type]);
-				switch(coding_type)
-				{
-					case 0: voptype=AVI_KEY_FRAME;break;
-					case 1: voptype=0;break;
-					case 2: voptype=AVI_B_FRAME;break;
-					case 3: printf("[Avi] Glouglou\n");voptype=0;break;
+	  if (code == 0xb6)
+	    {
+	      // Analyse a bit the vop header
+	      uint8_t coding_type = begin[off];
+	      coding_type >>= 6;
+	      aprintf ("\t at %u %d Img type:%s\n", off, *nb,
+		       s_voptype[coding_type]);
+	      switch (coding_type)
+		{
+		case 0:
+		  voptype = AVI_KEY_FRAME;
+		  break;
+		case 1:
+		  voptype = 0;
+		  break;
+		case 2:
+		  voptype = AVI_B_FRAME;
+		  break;
+		case 3:
+		  printf ("[Avi] Glouglou\n");
+		  voptype = 0;
+		  break;
 
-				}
-        	                vop[*nb].offset=globalOff+off-4;
-				vop[*nb].type=voptype;
+		}
+	      vop[*nb].offset = globalOff + off - 4;
+	      vop[*nb].type = voptype;
 
 
 
-                                /* Get more info */
-                                if( extractVopInfo(begin+off, end-begin-off, *timeincbits,&vopType,&modulo, &time_inc,&vopcoded))
-                                {
-                                    aprintf(" frame found: vopType:%x modulo:%d time_inc:%d vopcoded:%d\n",vopType,modulo,time_inc,vopcoded);
-                                    vop[*nb].modulo=modulo;
-                                    vop[*nb].timeInc=time_inc;
-                                    vop[*nb].vopCoded=vopcoded;
-                                }
-                                *nb=(*nb)+1;
-                                begin+=off+1;
-				globalOff+=off+1;
-				continue;
+	      /* Get more info */
+	      if (extractVopInfo
+		  (begin + off, end - begin - off, *timeincbits, &vopType,
+		   &modulo, &time_inc, &vopcoded))
+		{
+		  aprintf
+		    (" frame found: vopType:%x modulo:%d time_inc:%d vopcoded:%d\n",
+		     vopType, modulo, time_inc, vopcoded);
+		  vop[*nb].modulo = modulo;
+		  vop[*nb].timeInc = time_inc;
+		  vop[*nb].vopCoded = vopcoded;
+		}
+	      *nb = (*nb) + 1;
+	      begin += off + 1;
+	      globalOff += off + 1;
+	      continue;
 
-			}
-                else if(code==0x20 && off>=4	) // Vol start
-                {
+	    }
+	  else if (code == 0x20 && off >= 4)	// Vol start
+	    {
 
-                   if(extractMpeg4Info(begin+off-4,end+4-off-begin,&w,&h,timeincbits))
-                   {
-                      aprintf("Found Vol header : w:%d h:%d timeincbits:%d\n",w,h,*timeincbits);
-                   }
+	      if (extractMpeg4Info
+		  (begin + off - 4, end + 4 - off - begin, &w, &h,
+		   timeincbits))
+		{
+		  aprintf ("Found Vol header : w:%d h:%d timeincbits:%d\n", w,
+			   h, *timeincbits);
+		}
 
-                }
-        	begin+=off;
-        	globalOff+=off;
-        	continue;
-    	}
-    	return 1;
+	    }
+	  begin += off;
+	  globalOff += off;
+	  continue;
+	}
+      return 1;
     }
-	return 1;
+  return 1;
 }
 
 



From mean at mail.berlios.de  Mon Dec 21 14:31:49 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:49 +0100
Subject: [Avidemux-svn-commit] r5691 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src
Message-ID: <200912211331.nBLDVnSF028319@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:48 +0100 (Mon, 21 Dec 2009)
New Revision: 5691

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp
Log:
[core] Merge 5608

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp	2009-12-21 13:31:46 UTC (rev 5690)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp	2009-12-21 13:31:48 UTC (rev 5691)
@@ -20,11 +20,11 @@
 #include <errno.h>
 #include <sys/stat.h>
 #include <unistd.h>
-
-#ifdef __WIN32
+#ifndef __WIN32
+#include <fcntl.h>
+#else
 #include <direct.h>
 #include <shlobj.h>
-#include <fcntl.h>
 #elif defined(__APPLE__)
 #include <Carbon/Carbon.h>
 #endif



From mean at mail.berlios.de  Mon Dec 21 14:31:52 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:52 +0100
Subject: [Avidemux-svn-commit] r5692 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6:
	. crop crop/cli crop/gtk crop/qt4
Message-ID: <200912211331.nBLDVqJJ028350@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:51 +0100 (Mon, 21 Dec 2009)
New Revision: 5692

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/ADM_vidCrop.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/DIA_flyCrop.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/DIA_flyCrop.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/cli/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/cli/DIA_crop.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/crop.conf
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/crop.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/crop_desc.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/gtk/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/gtk/DIA_crop.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/Q_crop.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/Q_crop.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/crop.ui
Log:
[crop] Added crop video filter as example for flyDialog

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/ADM_vidCrop.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/ADM_vidCrop.cpp	2009-12-21 13:31:48 UTC (rev 5691)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/ADM_vidCrop.cpp	2009-12-21 13:31:51 UTC (rev 5692)
@@ -0,0 +1,193 @@
+/***************************************************************************
+    \file ADM_vidCrop
+    \brief Crop Filter
+    \author Mean 2002, fixounet at free.Fr
+
+          Crop top/left/right/bottom
+          Each one ,must be even
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_default.h"
+#include "ADM_coreVideoFilterInternal.h"
+#include "DIA_factory.h"
+#include "crop.h"
+#include "crop_desc.cpp"
+
+/**
+    \class CropFilter
+*/
+class  CropFilter:public ADM_coreVideoFilter
+ {
+
+ protected:
+                crop           configuration;
+                ADMImage       *original;
+
+ public:
+
+                                CropFilter(  ADM_coreVideoFilter *in,CONFcouple *couples);
+        virtual                 ~CropFilter();
+
+       virtual const char   *getConfiguration(void);          /// Return  current configuration as a human readable string
+       virtual bool         getNextFrame(ADMImage *image);    /// Return the next image
+       virtual FilterInfo  *getInfo(void);                    /// Return picture parameters after this filter
+	   virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+       virtual bool         configure(void) ;                 /// Start graphical user interface
+    
+ };
+ 
+
+// Add the hook to make it valid plugin
+DECLARE_VIDEO_FILTER(   CropFilter,   // Class
+                        1,0,0,              // Version
+                        ADM_UI_TYPE_BUILD,         // UI
+                        VF_TRANSFORM,            // Category
+                        "crop",            // internal name (must be uniq!)
+                        "crop",            // Display name
+                        "crop filter" // Description
+                    );
+
+
+//_______________________________________________________________
+/**
+    \fn CropFilter
+*/
+CropFilter::CropFilter(ADM_coreVideoFilter *in,CONFcouple *couples) :ADM_coreVideoFilter(in,couples)
+{
+
+        original=new ADMImage(info.width,info.height);
+        if(!couples || !ADM_paramLoad(couples,crop_param,&configuration))
+		{
+            // Default value
+            configuration.top=0;
+            configuration.bottom=0;
+            configuration.left=0;
+            configuration.right=0;
+        }
+        if(  in->getInfo()->width<(configuration.right+configuration.left))
+                {
+                    ADM_warning("Warning Cropping too much width ! Width reseted !\n");
+                        configuration.right=configuration.left=0;
+                }
+        if(  in->getInfo()->height<(configuration.bottom+configuration.top))
+                {
+                    ADM_warning("Warning Cropping too much height ! Height reseted !\n");
+                    configuration.bottom=configuration.top=0;
+                }
+
+        info.width= in->getInfo()->width- configuration.right- configuration.left;		
+        info.height=in->getInfo()->height-configuration.bottom-configuration.top;	
+}
+/**
+    \fn ~CropFilter
+*/
+CropFilter::~CropFilter()
+{
+    if(original) delete original;
+    original=NULL;
+}
+
+/**
+    \fn getNextFrame
+
+*/
+bool         CropFilter::getNextFrame(ADMImage *image)
+{
+FilterInfo  *prevInfo=previousFilter->getInfo();
+			// read uncompressed frame
+       		if(!previousFilter->getNextFrame(original)) return false;
+       		
+       		// Crop Y luma
+       		uint32_t y,x,line;
+       		uint8_t *src,*src2,*dest;
+       		
+       		y=prevInfo->height;
+       		x=prevInfo->width;
+       		line=info.width;
+       		src=YPLANE(original)+configuration.top*x+configuration.left;
+       		dest=YPLANE(image);
+       		
+       		for(uint32_t k=info.height;k>0;k--)
+       			{
+       			 	    memcpy(dest,src,line);
+       			 	    src+=x;
+       			 	    dest+=line;
+       			}
+         // Crop U  & V
+            src=UPLANE(original)+(x*configuration.top>>2)+(configuration.left>>1);
+            src2=VPLANE(original)+(x*configuration.top>>2)+(configuration.left>>1);
+            dest=UPLANE(image);
+            line>>=1;
+            x>>=1;       		       		 	
+            uint32_t loop=(info.height)>>1;
+            for(uint32_t k=loop;k>0;k--)
+                {
+                        memcpy(dest,src,line);
+                        src+=x;
+                        dest+=line;
+                }
+                dest=VPLANE(image);	
+                for(uint32_t k=((info.height)>>1);k>0;k--)
+                {
+                        memcpy(dest,src2,line);
+                        src2+=x;
+                        dest+=line;
+                }	
+            return 1;
+}
+/**
+    \fn getCoupledConf
+    \brief Return our current configuration as couple name=value
+*/
+bool         CropFilter::getCoupledConf(CONFcouple **couples)
+{
+    return ADM_paramSave(couples, crop_param,&configuration);
+}
+/**
+    \fn getConfiguration
+    \brief Return current setting as a string
+*/
+const char *CropFilter::getConfiguration(void)
+{
+    static char conf[80];
+    conf[0]=0;
+    snprintf(conf,80,"Crop : %"LU"x%"LU" => %"LU"x%"LU,
+                previousFilter->getInfo()->width,
+                previousFilter->getInfo()->height,
+                info.width,info.height
+                );
+    return conf;
+}
+/**
+    \fn Configure
+*/
+//extern int DIA_getCropParams(const char *name, CROP_PARAMS *param, AVDMGenericVideoStream *in);
+bool CropFilter::configure(void)
+
+{
+#if 0
+		uint8_t r;
+		uint32_t w,h;
+    	if(r = (DIA_getCropParams("Crop Settings",_param,instream )))
+    	{
+			w=_param->left+_param->right;
+			h=_param->top+_param->bottom;
+			ADM_assert(w<instream->getInfo()->width);
+			ADM_assert(h<instream->getInfo()->height);
+			_info.width=instream->getInfo()->width-w;
+			_info.height=instream->getInfo()->height-h;
+		}
+		return r;
+#endif
+    return false;
+}
+// EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/CMakeLists.txt	2009-12-21 13:31:48 UTC (rev 5691)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/CMakeLists.txt	2009-12-21 13:31:51 UTC (rev 5692)
@@ -0,0 +1,25 @@
+# Crop filter
+INCLUDE(vf_plugin)
+
+SET(CropCommon_SRCS ADM_vidCrop.cpp  DIA_flyCrop.cpp)
+
+# ---------- QT4 Version ----------------
+INCLUDE(vf_plugin_qt4)
+SET(ADM_vf_cropQT4_SRCS    qt4/Q_crop.cpp)
+SET(ADM_vf_cropQT4_Headers qt4/Q_crop.h)
+SET(ADM_vf_cropQT4_UI      qt4/crop)
+INIT_VIDEO_FILTER_QT4(ADM_vf_cropQt4 ${ADM_vf_cropQT4_SRCS} ${ADM_vf_cropQT4_Headers} ${ADM_vf_cropQT4_UI} ${CropCommon_SRCS})
+# /QT4
+
+
+#------------- Gtk Version ---------------
+INCLUDE(vf_plugin_gtk)
+SET(CropGtk_SRCS gtk/DIA_crop.cpp)
+INIT_VIDEO_FILTER_GTK(ADM_vf_cropGtk ${CropGtk_SRCS} ${CropCommon_SRC})
+
+#------------ Cli Version ----------------
+INCLUDE(vf_plugin_cli)
+SET(CropCli_SRCS cli/DIA_crop.cpp)
+INIT_VIDEO_FILTER_CLI(  ADM_vf_CropCli ${CropCli_SRCS} ${CropCommon_SRCS})
+#
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/DIA_flyCrop.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/DIA_flyCrop.cpp	2009-12-21 13:31:48 UTC (rev 5691)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/DIA_flyCrop.cpp	2009-12-21 13:31:51 UTC (rev 5692)
@@ -0,0 +1,230 @@
+/***************************************************************************
+                          DIA_flyCrop.cpp  -  description
+                             -------------------
+
+        Common part of the crop dialog
+    
+    copyright            : (C) 2002/2007 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "DIA_flyDialog.h"
+#include "ADM_default.h"
+#include "ADM_image.h"
+#include "DIA_flyCrop.h"
+
+
+static uint8_t 		Metrics( uint8_t *in, uint32_t width,uint32_t *avg, uint32_t *eqt);
+static uint8_t 		MetricsV( uint8_t *in, uint32_t width,uint32_t height,uint32_t *avg, uint32_t *eqt);
+
+uint8_t    flyCrop::process(void)
+{
+        uint32_t x,y;
+        uint8_t  *in;
+        uint32_t w=_w,h=_h;
+  
+        
+        memcpy(_rgbBufferOut,_rgbBuffer,_w*_h*4);
+        in=_rgbBufferOut;
+        for(y=0;y<top;y++)
+        {
+                for(x=0;x<w;x++)
+                {
+                        *in++=0;
+                        
+                        
+                        *in++=0xff;
+                        
+                        *in++=0;
+                        *in++=0;
+                }
+        }
+        // bottom
+        in=_rgbBufferOut+(w*4)*(h-bottom);
+        for(y=0;y<bottom;y++)
+        {
+                for(x=0;x<w;x++)
+                {
+                        *in++=0;
+                        
+                        
+                        *in++=0xff;
+                        *in++=0;
+                        *in++=0;
+                }
+        }
+        // left
+        in=_rgbBufferOut;
+        uint32_t stride=4*w-4;
+        for(y=0;y<h;y++)
+        {
+                for(x=0;x<left;x++)
+                {
+                        *(in+4*x)=0;
+                        
+                        
+                        *(in+4*x+1)=0xff;
+                        *(in+4*x+2)=0;
+                        *(in+4*x+3)=0;
+                }
+                for(x=0;x<right;x++)
+                {
+                        *(in-4*x+stride-4)=0;
+                        
+                        
+                        *(in-4*x+stride-3)=0xff;
+                        *(in-4*x+stride-2)=0;
+                        *(in-4*x+stride-1)=0;
+                        
+                }
+                in+=4*w;
+  
+        }
+
+		copyRgbFinalToDisplay();
+}
+
+/*----------------------------------
+  autocrop
+-----------------------------------*/
+
+uint8_t  flyCrop::autocrop(void)
+{
+uint8_t *in;
+uint32_t y,avg,eqt;
+	// Top
+
+#define THRESH_AVG   30
+#define THRESH_EQT   50
+        
+        in=_yuvBuffer->data;
+        for(y=0;y<((_h>>1)-2);y++)	
+        {
+                Metrics(in,_w,&avg,&eqt);
+                in+=_w;
+                //printf("LineT :%d avg: %d eqt: %d\n",y,avg,eqt);
+                if(avg> THRESH_AVG || eqt > THRESH_EQT)
+                        break;
+        }
+//gotcha_:	
+        if(y)
+                top=y-1;
+        else 
+                top=0;
+                
+        in=_yuvBuffer->data+_w*(_h-1);
+        for(y=0;y<((_h>>1)-2);y++)	
+        {
+                Metrics(in,_w,&avg,&eqt);
+                in-=_w;
+                //printf("Line B :%d avg: %d eqt: %d\n",y,avg,eqt);
+                if(avg> THRESH_AVG || eqt > THRESH_EQT)
+                                break;
+        }
+//gotcha_:	
+        if(y)
+                bottom=y-1;
+        else
+                bottom=0;
+
+                
+// Left
+        in=_yuvBuffer->data;
+        for(y=0;y<((_w>>1)-2);y++)	
+        {
+                MetricsV(in,_w,_h,&avg,&eqt);
+                in++;
+                //printf("Line L :%d avg: %d eqt: %d\n",y,avg,eqt);
+                if(avg> THRESH_AVG || eqt > THRESH_EQT)
+                                break;
+        }
+//gotcha_:	
+        if(y)
+                left=y-1;
+        else
+                left=0;		
+// Right
+        in=_yuvBuffer->data+_w-1;
+        for(y=0;y<((_w>>1)-2);y++)	
+        {
+                MetricsV(in,_w,_h,&avg,&eqt);
+                in--;
+                //printf("Line R :%d avg: %d eqt: %d\n",y,avg,eqt);
+                if(avg> THRESH_AVG || eqt > THRESH_EQT)
+                                break;
+        }
+//gotcha_:	
+        if(y)
+                right=y-1;
+        else
+                right=0;
+  
+              
+        // Update display
+        top=top & 0xfffe;
+        bottom=bottom & 0xfffe;
+        upload();
+        process();
+        display();
+        return 1;
+}
+/*---------------------------------------------
+	Compute the average value of pixels
+	and eqt is the "ecart type"
+*/
+uint8_t Metrics( uint8_t *in, uint32_t width,uint32_t *avg, uint32_t *eqt)
+{
+
+uint32_t x;
+uint32_t sum=0,eq=0;
+uint8_t v;
+              for(x=0;x<width;x++)
+              {
+                      sum+=*(in+x);
+              }
+              sum=sum/width;
+              *avg=sum;
+              for(x=0;x<width;x++)
+              {
+                      v=*(in+x)-sum;
+                      eq+=v*v;
+              }
+              eq=eq/(width*width);
+              *eqt=eq;
+              return 1;
+}
+/*---------------------------------------------
+	Compute the average value of pixels
+	and eqt is the "ecart type"
+*/
+uint8_t MetricsV( uint8_t *in,uint32_t width, uint32_t height,uint32_t *avg, uint32_t *eqt)
+{
+
+uint32_t x;
+uint32_t sum=0,eq=0;
+uint8_t v;
+              for(x=0;x<height;x++)
+              {
+                      sum+=*(in+x*width);
+              }
+              sum=sum/height;
+              *avg=sum;
+              for(x=0;x<height;x++)
+              {
+                      v=*(in+x*width)-sum;
+                      eq+=v*v;
+              }
+              eq=eq/(height*height);
+              *eqt=eq;
+              return 1;
+}
+//EOF
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/DIA_flyCrop.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/DIA_flyCrop.h	2009-12-21 13:31:48 UTC (rev 5691)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/DIA_flyCrop.h	2009-12-21 13:31:51 UTC (rev 5692)
@@ -0,0 +1,16 @@
+#ifndef FLY_CROP_H
+#define FLY_CROP_H
+class flyCrop : public FLY_DIALOG_TYPE
+{
+  
+  public:
+   uint32_t left,right,top,bottom;
+  public:
+   uint8_t    process(void);
+   uint8_t    download(void);
+   uint8_t    upload(void);
+   uint8_t    autocrop(void);
+   flyCrop (uint32_t width,uint32_t height,ADM_coreVideoFilter *in,
+                                    void *canvas, void *slider) : FLY_DIALOG_TYPE(width, height,in,canvas, slider,0,RESIZE_LAST) {};
+};
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/cli/DIA_crop.cpp
===================================================================

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/crop.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/crop.conf	2009-12-21 13:31:48 UTC (rev 5691)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/crop.conf	2009-12-21 13:31:51 UTC (rev 5692)
@@ -0,0 +1,4 @@
+uint32_t:top
+uint32_t:bottom
+uint32_t:left
+uint32_t:right

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/crop.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/crop.h	2009-12-21 13:31:48 UTC (rev 5691)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/crop.h	2009-12-21 13:31:51 UTC (rev 5692)
@@ -0,0 +1,11 @@
+// Automatically generated, do not edit!
+#ifndef ADM_crop_CONF_H
+#define ADM_crop_CONF_H
+typedef struct {
+   uint32_t top;
+   uint32_t bottom;
+   uint32_t left;
+   uint32_t right;
+}crop;
+#endif //crop
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/crop_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/crop_desc.cpp	2009-12-21 13:31:48 UTC (rev 5691)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/crop_desc.cpp	2009-12-21 13:31:51 UTC (rev 5692)
@@ -0,0 +1,8 @@
+// Automatically generated, do not edit!
+const ADM_paramList crop_param[]={
+ {"top",offsetof( crop,top),"uint32_t",ADM_param_uint32_t},
+ {"bottom",offsetof( crop,bottom),"uint32_t",ADM_param_uint32_t},
+ {"left",offsetof( crop,left),"uint32_t",ADM_param_uint32_t},
+ {"right",offsetof( crop,right),"uint32_t",ADM_param_uint32_t},
+{NULL,0,NULL}
+};

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/gtk/DIA_crop.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/gtk/DIA_crop.cpp	2009-12-21 13:31:48 UTC (rev 5691)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/gtk/DIA_crop.cpp	2009-12-21 13:31:51 UTC (rev 5692)
@@ -0,0 +1,386 @@
+/***************************************************************************
+                          DIA_crop.cpp  -  description
+                             -------------------
+
+			    GUI for cropping including autocrop
+			    +Revisted the Gtk2 way
+			     +Autocrop now in RGB space (more accurate)
+
+    begin                : Fri May 3 2002
+    copyright            : (C) 2002/2007 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "ADM_toolkitGtk.h"
+#include "ADM_image.h"
+#include "DIA_flyDialog.h"
+#include "DIA_flyCrop.h"
+#include "../crop.h"
+
+#if 1
+static GtkWidget	*create_dialog1 (void);
+
+/* Link between UI and core */
+static gboolean 	ui_draw( void );
+static void 		ui_autocrop (void );
+static void 		ui_reset( void );
+static void 		ui_upload(void);
+static void  		ui_read ( void);
+static void  		ui_update ( void);
+static void 		ui_frame_changed( void );
+
+static GtkWidget *dialog=NULL;
+
+/* Prevent loop when updating value */
+
+static int lock=0;
+static flyCrop *myCrop=NULL;
+/**
+    \fn DIA_getCropParams
+
+*/
+int DIA_getCropParams(const char *name, crop *param, ADM_coreVideoFilter *in)
+{
+	uint32_t width, height;
+
+	// Allocate space for green-ised video
+	width = in->getInfo()->width;
+	height = in->getInfo()->height;
+
+	uint8_t ret=0;
+
+	dialog=create_dialog1();
+	gtk_dialog_set_alternative_button_order(GTK_DIALOG(dialog),
+										GTK_RESPONSE_OK,
+										GTK_RESPONSE_CANCEL,
+										GTK_RESPONSE_APPLY,
+										-1);
+	gtk_register_dialog(dialog);
+	gtk_window_set_title(GTK_WINDOW(dialog), name);
+	gtk_widget_show(dialog);
+	
+#define CONNECT(x,y,z) 	gtk_signal_connect(GTK_OBJECT(WID(x)), #y, GTK_SIGNAL_FUNC(z), NULL);
+
+	CONNECT(drawingarea1,expose_event,ui_draw);
+	CONNECT(buttonAutocrop,clicked,ui_autocrop);
+	CONNECT(buttonReset,clicked,ui_reset);
+	CONNECT(scale,value_changed,ui_frame_changed);
+
+#define CONNECT_SPIN(x) CONNECT(spinbutton##x, value_changed,ui_update)
+          
+	CONNECT_SPIN(Top);
+	CONNECT_SPIN(Left);
+	CONNECT_SPIN(Right);
+	CONNECT_SPIN(Bottom);
+
+	myCrop=new flyCrop(width, height,in,WID(drawingarea1),WID(scale));
+	myCrop->left=param->left;
+	myCrop->right=param->right;
+	myCrop->top=param->top;
+	myCrop->bottom=param->bottom;
+	myCrop->upload();	
+	myCrop->sliderChanged();	
+
+	int response;
+
+	while((response = gtk_dialog_run(GTK_DIALOG(dialog))) == GTK_RESPONSE_APPLY)
+	{
+	  ui_update();
+	}
+
+	if(response==GTK_RESPONSE_OK)
+	{
+		ui_read( );
+		param->left=myCrop->left;
+		param->right=myCrop->right;
+		param->top=myCrop->top;
+		param->bottom=myCrop->bottom;
+		ret=1;
+	}
+
+	gtk_unregister_dialog(dialog);
+	gtk_widget_destroy(dialog);
+	delete myCrop;
+	return ret;
+}
+
+/*
+      Link GTK dialog and core
+*/
+void ui_frame_changed( void )
+{
+  myCrop->sliderChanged();
+}
+void ui_update(void)
+{
+  if(lock) return;
+  myCrop->download();
+  myCrop->process();
+  myCrop->display();
+}
+/*---------------------------------------------------------------------------
+	Actually draw the working frame on screen
+*/
+gboolean ui_draw( void )
+{
+        myCrop->display();
+}
+void ui_read (void )
+{
+        myCrop->download();
+}
+void ui_upload(void)
+{
+    myCrop->upload();
+}
+void ui_autocrop( void )
+{
+  myCrop->autocrop();
+ 
+}
+void ui_reset( void )
+{
+        myCrop->left=0;
+        myCrop->right=0;
+        myCrop->bottom=0;
+        myCrop->top=0;
+        
+	myCrop->upload();
+        myCrop->process();
+        myCrop->display();
+}
+
+/*---------------------------------------------------------------------------
+	Read entried from dialog box
+*/
+
+#define SPIN_GET(x,y) {x= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(WID(spinbutton##y))) ;}
+#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(spinbutton##y)),(gfloat)x) ;}
+
+
+//____________________________________
+uint8_t flyCrop::upload(void)
+{
+        lock++;
+        SPIN_SET(left,Left);
+        SPIN_SET(right,Right);
+        SPIN_SET(top,Top);
+        SPIN_SET(bottom,Bottom);
+        lock--;
+        return 1;
+}
+uint8_t flyCrop::download(void)
+{
+        int reject=0;
+        
+                        SPIN_GET(left,Left);
+                        SPIN_GET(right,Right);
+                        SPIN_GET(top,Top);
+                        SPIN_GET(bottom,Bottom);
+                        
+                        printf("%d %d %d %d\n",left,right,top,bottom);
+                        
+                        left&=0xffffe;
+                        right&=0xffffe;
+                        top&=0xffffe;
+                        bottom&=0xffffe;
+                        
+                        if((top+bottom)>_h)
+                                {
+                                        top=bottom=0;
+                                        reject=1;
+                                }
+                        if((left+right)>_w)
+                                {
+                                        left=right=0;
+                                        reject=1;
+                                }
+                        if(reject)
+                                upload();
+}
+// End common part
+//--------------------------------------------
+GtkWidget*
+create_dialog1 (void)
+{
+  GtkWidget *dialog1;
+  GtkWidget *dialog_vbox1;
+  GtkWidget *vbox1;
+  GtkWidget *drawingarea1;
+  GtkWidget *scale;
+  GtkWidget *table1;
+  GtkWidget *label1;
+  GtkWidget *label2;
+  GtkWidget *label3;
+  GtkWidget *label4;
+  GtkObject *spinbuttonRight_adj;
+  GtkWidget *spinbuttonRight;
+  GtkObject *spinbuttonLeft_adj;
+  GtkWidget *spinbuttonLeft;
+  GtkObject *spinbuttonBottom_adj;
+  GtkWidget *spinbuttonBottom;
+  GtkObject *spinbuttonTop_adj;
+  GtkWidget *spinbuttonTop;
+  GtkWidget *hbox1;
+  GtkWidget *hbox2;
+  GtkWidget *buttonAutocrop;
+  GtkWidget *buttonReset;
+  GtkWidget *dialog_action_area1;
+  GtkWidget *applybutton1;
+  GtkWidget *cancelbutton1;
+  GtkWidget *okbutton1;
+
+  dialog1 = gtk_dialog_new ();
+  gtk_window_set_title (GTK_WINDOW (dialog1), QT_TR_NOOP("Crop Settings"));
+  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
+
+  dialog_vbox1 = GTK_DIALOG (dialog1)->vbox;
+  gtk_widget_show (dialog_vbox1);
+
+  vbox1 = gtk_vbox_new (FALSE, 6);
+  gtk_widget_show (vbox1);
+  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
+  gtk_container_set_border_width (GTK_CONTAINER (vbox1), 6);
+
+  drawingarea1 = gtk_drawing_area_new ();
+  gtk_widget_show (drawingarea1);
+  gtk_box_pack_start (GTK_BOX (vbox1), drawingarea1, TRUE, TRUE, 0);
+
+  scale = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 0, 0, 0, 0, 0)));
+  gtk_widget_show (scale);
+  gtk_box_pack_start (GTK_BOX (vbox1), scale, FALSE, TRUE, 0);
+
+  table1 = gtk_table_new (2, 4, FALSE);
+  gtk_widget_show (table1);
+  gtk_box_pack_start (GTK_BOX (vbox1), table1, FALSE, FALSE, 10);
+  gtk_table_set_row_spacings (GTK_TABLE (table1), 4);
+  gtk_table_set_col_spacings (GTK_TABLE (table1), 15);
+
+  label1 = gtk_label_new (QT_TR_NOOP("Crop Left:"));
+  gtk_widget_show (label1);
+  gtk_table_attach (GTK_TABLE (table1), label1, 0, 1, 0, 1,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_misc_set_alignment (GTK_MISC (label1), 0, 0.5);
+
+  label2 = gtk_label_new (QT_TR_NOOP("Crop Right:"));
+  gtk_widget_show (label2);
+  gtk_table_attach (GTK_TABLE (table1), label2, 0, 1, 1, 2,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_misc_set_alignment (GTK_MISC (label2), 0, 0.5);
+
+  label3 = gtk_label_new (QT_TR_NOOP("Crop Top:"));
+  gtk_widget_show (label3);
+  gtk_table_attach (GTK_TABLE (table1), label3, 2, 3, 0, 1,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_misc_set_alignment (GTK_MISC (label3), 0, 0.5);
+
+  label4 = gtk_label_new (QT_TR_NOOP("Crop Bottom:"));
+  gtk_widget_show (label4);
+  gtk_table_attach (GTK_TABLE (table1), label4, 2, 3, 1, 2,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_misc_set_alignment (GTK_MISC (label4), 0, 0.5);
+
+  spinbuttonRight_adj = gtk_adjustment_new (1, 0, 1000, 1, 10, 10);
+  spinbuttonRight = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonRight_adj), 1, 0);
+  gtk_widget_show (spinbuttonRight);
+  gtk_table_attach (GTK_TABLE (table1), spinbuttonRight, 1, 2, 1, 2,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+
+  spinbuttonLeft_adj = gtk_adjustment_new (1, 0, 1000, 1, 10, 10);
+  spinbuttonLeft = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonLeft_adj), 1, 0);
+  gtk_widget_show (spinbuttonLeft);
+  gtk_table_attach (GTK_TABLE (table1), spinbuttonLeft, 1, 2, 0, 1,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+
+  spinbuttonBottom_adj = gtk_adjustment_new (1, 0, 1000, 1, 10, 10);
+  spinbuttonBottom = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonBottom_adj), 1, 0);
+  gtk_widget_show (spinbuttonBottom);
+  gtk_table_attach (GTK_TABLE (table1), spinbuttonBottom, 3, 4, 1, 2,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+
+  spinbuttonTop_adj = gtk_adjustment_new (1, 0, 1000, 1, 10, 10);
+  spinbuttonTop = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonTop_adj), 1, 0);
+  gtk_widget_show (spinbuttonTop);
+  gtk_table_attach (GTK_TABLE (table1), spinbuttonTop, 3, 4, 0, 1,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+
+  hbox1 = gtk_hbox_new (FALSE, 0);
+  gtk_widget_show (hbox1);
+  gtk_box_pack_start (GTK_BOX (vbox1), hbox1, FALSE, TRUE, 0);
+
+  hbox2 = gtk_hbox_new (TRUE, 6);
+  gtk_widget_show (hbox2);
+  gtk_box_pack_start (GTK_BOX (hbox1), hbox2, FALSE, TRUE, 0);
+
+  buttonAutocrop = gtk_button_new_with_mnemonic (QT_TR_NOOP("Auto Crop"));
+  gtk_widget_show (buttonAutocrop);
+  gtk_box_pack_start (GTK_BOX (hbox2), buttonAutocrop, FALSE, TRUE, 0);
+
+  buttonReset = gtk_button_new_from_stock ("gtk-clear");
+  gtk_widget_show (buttonReset);
+  gtk_box_pack_start (GTK_BOX (hbox2), buttonReset, FALSE, TRUE, 0);
+
+  dialog_action_area1 = GTK_DIALOG (dialog1)->action_area;
+  gtk_widget_show (dialog_action_area1);
+  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
+
+  applybutton1 = gtk_button_new_from_stock ("gtk-apply");
+  gtk_widget_show (applybutton1);
+  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), applybutton1, GTK_RESPONSE_APPLY);
+  GTK_WIDGET_SET_FLAGS (applybutton1, GTK_CAN_DEFAULT);
+
+  cancelbutton1 = gtk_button_new_from_stock ("gtk-cancel");
+  gtk_widget_show (cancelbutton1);
+  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
+  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
+
+  okbutton1 = gtk_button_new_from_stock ("gtk-ok");
+  gtk_widget_show (okbutton1);
+  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
+  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
+
+  /* Store pointers to all widgets, for use by lookup_widget(). */
+  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, "dialog1");
+  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, "dialog_vbox1");
+  GLADE_HOOKUP_OBJECT (dialog1, vbox1, "vbox1");
+  GLADE_HOOKUP_OBJECT (dialog1, drawingarea1, "drawingarea1");
+  GLADE_HOOKUP_OBJECT (dialog1, scale, "scale");
+  GLADE_HOOKUP_OBJECT (dialog1, table1, "table1");
+  GLADE_HOOKUP_OBJECT (dialog1, label1, "label1");
+  GLADE_HOOKUP_OBJECT (dialog1, label2, "label2");
+  GLADE_HOOKUP_OBJECT (dialog1, label3, "label3");
+  GLADE_HOOKUP_OBJECT (dialog1, label4, "label4");
+  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonRight, "spinbuttonRight");
+  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonLeft, "spinbuttonLeft");
+  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonBottom, "spinbuttonBottom");
+  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonTop, "spinbuttonTop");
+  GLADE_HOOKUP_OBJECT (dialog1, hbox1, "hbox1");
+  GLADE_HOOKUP_OBJECT (dialog1, hbox2, "hbox2");
+  GLADE_HOOKUP_OBJECT (dialog1, buttonAutocrop, "buttonAutocrop");
+  GLADE_HOOKUP_OBJECT (dialog1, buttonReset, "buttonReset");
+  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, "dialog_action_area1");
+  GLADE_HOOKUP_OBJECT (dialog1, applybutton1, "applybutton1");
+  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, "cancelbutton1");
+  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, "okbutton1");
+
+  return dialog1;
+}
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/Q_crop.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/Q_crop.cpp	2009-12-21 13:31:48 UTC (rev 5691)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/Q_crop.cpp	2009-12-21 13:31:51 UTC (rev 5692)
@@ -0,0 +1,171 @@
+/***************************************************************************
+                          DIA_crop.cpp  -  description
+                             -------------------
+
+			    GUI for cropping including autocrop
+			    +Revisted the Gtk2 way
+			     +Autocrop now in RGB space (more accurate)
+
+    begin                : Fri May 3 2002
+    copyright            : (C) 2002/2007 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#if 1
+#include "Q_crop.h"
+
+//
+//	Video is in YV12 Colorspace
+//
+//
+  Ui_cropWindow::Ui_cropWindow(crop *param,ADM_coreVideoFilter *in)
+  {
+    uint32_t width,height;
+        ui.setupUi(this);
+        lock=0;
+        // Allocate space for green-ised video
+        width=in->getInfo()->width;
+        height=in->getInfo()->height;
+
+        canvas=new ADM_QCanvas(ui.graphicsView,width,height);
+        
+        myCrop=new flyCrop( width, height,in,canvas,ui.horizontalSlider);
+        myCrop->left=param->left;
+        myCrop->right=param->right;
+        myCrop->top=param->top;
+        myCrop->bottom=param->bottom;
+        myCrop->_cookie=&ui;
+        myCrop->upload();
+        myCrop->sliderChanged();
+
+
+        connect( ui.horizontalSlider,SIGNAL(valueChanged(int)),this,SLOT(sliderUpdate(int)));
+        connect( ui.pushButtonAutoCrop,SIGNAL(clicked(bool)),this,SLOT(autoCrop(bool)));
+        connect( ui.pushButtonReset,SIGNAL(clicked(bool)),this,SLOT(reset(bool)));
+#define SPINNER(x) connect( ui.spinBox##x,SIGNAL(valueChanged(int)),this,SLOT(valueChanged(int))); 
+          SPINNER(Left);
+          SPINNER(Right);
+          SPINNER(Top);
+          SPINNER(Bottom);
+
+  }
+  void Ui_cropWindow::sliderUpdate(int foo)
+  {
+    myCrop->sliderChanged();
+  }
+  void Ui_cropWindow::gather(crop *param)
+  {
+    
+        myCrop->download();
+        param->left=myCrop->left;
+        param->right=myCrop->right;
+        param->top=myCrop->top;
+        param->bottom=myCrop->bottom;
+  }
+Ui_cropWindow::~Ui_cropWindow()
+{
+  if(myCrop) delete myCrop;
+  myCrop=NULL; 
+  if(canvas) delete canvas;
+  canvas=NULL;
+}
+void Ui_cropWindow::valueChanged( int f )
+{
+  if(lock) return;
+  lock++;
+  myCrop->download();
+  myCrop->process();
+  myCrop->display();
+  lock--;
+}
+
+void Ui_cropWindow::autoCrop( bool f )
+{
+  lock++;
+  myCrop->autocrop();
+  lock--;
+}
+void Ui_cropWindow::reset( bool f )
+{
+         myCrop->left=0;
+         myCrop->right=0;
+         myCrop->bottom=0;
+         myCrop->top=0;
+         lock++;
+         myCrop->upload();
+         myCrop->process();
+         myCrop->display();
+         lock--;
+}
+
+//************************
+uint8_t flyCrop::upload(void)
+{
+      Ui_cropDialog *w=(Ui_cropDialog *)_cookie;
+        
+        w->spinBoxLeft->setValue(left);
+        w->spinBoxRight->setValue(right);
+        w->spinBoxTop->setValue(top);
+        w->spinBoxBottom->setValue(bottom);
+        
+        return 1;
+}
+uint8_t flyCrop::download(void)
+{
+        int reject=0;
+Ui_cropDialog *w=(Ui_cropDialog *)_cookie;
+#define SPIN_GET(x,y) x=w->spinBox##y->value();
+                        SPIN_GET(left,Left);
+                        SPIN_GET(right,Right);
+                        SPIN_GET(top,Top);
+                        SPIN_GET(bottom,Bottom);
+                        
+                        printf("%d %d %d %d\n",left,right,top,bottom);
+                        
+                        left&=0xffffe;
+                        right&=0xffffe;
+                        top&=0xffffe;
+                        bottom&=0xffffe;
+                        
+                        if((top+bottom)>_h)
+                                {
+                                        top=bottom=0;
+                                        reject=1;
+                                }
+                        if((left+right)>_w)
+                                {
+                                        left=right=0;
+                                        reject=1;
+                                }
+                        if(reject)
+                                upload();
+}
+
+/**
+      \fn     DIA_getCropParams
+      \brief  Handle crop dialog
+*/
+int DIA_getCropParams(	const char *name,crop *param,ADM_coreVideoFilter *in)
+{
+        uint8_t ret=0;
+        
+        Ui_cropWindow dialog(param,in);        
+        if(dialog.exec()==QDialog::Accepted)
+        {
+            dialog.gather(param); 
+            ret=1;
+        }
+        return ret;
+}
+//____________________________________
+// EOF
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/Q_crop.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/Q_crop.h	2009-12-21 13:31:48 UTC (rev 5691)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/Q_crop.h	2009-12-21 13:31:51 UTC (rev 5692)
@@ -0,0 +1,36 @@
+#ifndef Q_crop_h
+#define Q_crop_h
+#include "DIA_flyDialog.h"
+#include "ui_crop.h"
+#include "ADM_image.h"
+#include "DIA_flyDialogQt4.h"
+#include "DIA_flyCrop.h"
+#include "crop.h"
+#if 1
+class Ui_cropWindow : public QDialog
+{
+	Q_OBJECT
+
+protected: 
+	int lock;
+
+public:
+	flyCrop *myCrop;
+	ADM_QCanvas *canvas;
+	Ui_cropWindow(crop *param,ADM_coreVideoFilter *in);
+	~Ui_cropWindow();
+	Ui_cropDialog ui;
+
+public slots:
+	void gather(crop *param);
+
+private slots:
+	void sliderUpdate(int foo);
+	void valueChanged(int foo);
+	void autoCrop(bool f);
+	void reset(bool f);
+};
+
+#endif	// Q_crop_h
+#endif
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/crop.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/crop.ui	2009-12-21 13:31:48 UTC (rev 5691)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/qt4/crop.ui	2009-12-21 13:31:51 UTC (rev 5692)
@@ -0,0 +1,231 @@
+<ui version="4.0" >
+ <class>cropDialog</class>
+ <widget class="QDialog" name="cropDialog" >
+  <property name="geometry" >
+   <rect>
+    <x>0</x>
+    <y>0</y>
+    <width>348</width>
+    <height>300</height>
+   </rect>
+  </property>
+  <property name="windowTitle" >
+   <string>Crop</string>
+  </property>
+  <layout class="QVBoxLayout" >
+   <property name="margin" >
+    <number>9</number>
+   </property>
+   <property name="spacing" >
+    <number>6</number>
+   </property>
+   <item>
+    <layout class="QGridLayout" >
+     <property name="margin" >
+      <number>0</number>
+     </property>
+     <property name="spacing" >
+      <number>6</number>
+     </property>
+     <item row="0" column="3" >
+      <widget class="QLabel" name="label_2" >
+       <property name="text" >
+        <string>Right:</string>
+       </property>
+      </widget>
+     </item>
+     <item row="1" column="0" >
+      <widget class="QLabel" name="label_4" >
+       <property name="text" >
+        <string>Top:</string>
+       </property>
+      </widget>
+     </item>
+     <item row="0" column="4" >
+      <widget class="QSpinBox" name="spinBoxRight" >
+       <property name="maximum" >
+        <number>2147483647</number>
+       </property>
+      </widget>
+     </item>
+     <item row="0" column="2" >
+      <spacer>
+       <property name="orientation" >
+        <enum>Qt::Horizontal</enum>
+       </property>
+       <property name="sizeType" >
+        <enum>QSizePolicy::Fixed</enum>
+       </property>
+       <property name="sizeHint" >
+        <size>
+         <width>26</width>
+         <height>20</height>
+        </size>
+       </property>
+      </spacer>
+     </item>
+     <item row="1" column="5" >
+      <spacer>
+       <property name="orientation" >
+        <enum>Qt::Horizontal</enum>
+       </property>
+       <property name="sizeHint" >
+        <size>
+         <width>40</width>
+         <height>20</height>
+        </size>
+       </property>
+      </spacer>
+     </item>
+     <item row="1" column="6" >
+      <widget class="QPushButton" name="pushButtonReset" >
+       <property name="text" >
+        <string>Reset</string>
+       </property>
+      </widget>
+     </item>
+     <item row="1" column="1" >
+      <widget class="QSpinBox" name="spinBoxTop" >
+       <property name="maximum" >
+        <number>2147483647</number>
+       </property>
+      </widget>
+     </item>
+     <item row="1" column="4" >
+      <widget class="QSpinBox" name="spinBoxBottom" >
+       <property name="maximum" >
+        <number>2147483647</number>
+       </property>
+      </widget>
+     </item>
+     <item row="1" column="3" >
+      <widget class="QLabel" name="label_3" >
+       <property name="text" >
+        <string>Bottom:</string>
+       </property>
+      </widget>
+     </item>
+     <item row="0" column="0" >
+      <widget class="QLabel" name="label" >
+       <property name="text" >
+        <string>Left:</string>
+       </property>
+      </widget>
+     </item>
+     <item row="0" column="5" >
+      <spacer>
+       <property name="orientation" >
+        <enum>Qt::Horizontal</enum>
+       </property>
+       <property name="sizeType" >
+        <enum>QSizePolicy::MinimumExpanding</enum>
+       </property>
+       <property name="sizeHint" >
+        <size>
+         <width>40</width>
+         <height>20</height>
+        </size>
+       </property>
+      </spacer>
+     </item>
+     <item row="0" column="1" >
+      <widget class="QSpinBox" name="spinBoxLeft" >
+       <property name="maximum" >
+        <number>2147483647</number>
+       </property>
+      </widget>
+     </item>
+     <item row="0" column="6" >
+      <widget class="QPushButton" name="pushButtonAutoCrop" >
+       <property name="text" >
+        <string>Auto Crop</string>
+       </property>
+      </widget>
+     </item>
+     <item row="1" column="2" >
+      <spacer>
+       <property name="orientation" >
+        <enum>Qt::Horizontal</enum>
+       </property>
+       <property name="sizeType" >
+        <enum>QSizePolicy::Fixed</enum>
+       </property>
+       <property name="sizeHint" >
+        <size>
+         <width>26</width>
+         <height>20</height>
+        </size>
+       </property>
+      </spacer>
+     </item>
+    </layout>
+   </item>
+   <item>
+    <widget class="QSlider" name="horizontalSlider" >
+     <property name="orientation" >
+      <enum>Qt::Horizontal</enum>
+     </property>
+    </widget>
+   </item>
+   <item>
+    <widget class="QGraphicsView" name="graphicsView" />
+   </item>
+   <item>
+    <widget class="QDialogButtonBox" name="buttonBox" >
+     <property name="orientation" >
+      <enum>Qt::Horizontal</enum>
+     </property>
+     <property name="standardButtons" >
+      <set>QDialogButtonBox::Cancel|QDialogButtonBox::NoButton|QDialogButtonBox::Ok</set>
+     </property>
+    </widget>
+   </item>
+  </layout>
+ </widget>
+ <tabstops>
+  <tabstop>spinBoxLeft</tabstop>
+  <tabstop>spinBoxRight</tabstop>
+  <tabstop>spinBoxTop</tabstop>
+  <tabstop>spinBoxBottom</tabstop>
+  <tabstop>pushButtonAutoCrop</tabstop>
+  <tabstop>pushButtonReset</tabstop>
+  <tabstop>horizontalSlider</tabstop>
+  <tabstop>graphicsView</tabstop>
+  <tabstop>buttonBox</tabstop>
+ </tabstops>
+ <resources/>
+ <connections>
+  <connection>
+   <sender>buttonBox</sender>
+   <signal>accepted()</signal>
+   <receiver>cropDialog</receiver>
+   <slot>accept()</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>248</x>
+     <y>254</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>157</x>
+     <y>274</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>buttonBox</sender>
+   <signal>rejected()</signal>
+   <receiver>cropDialog</receiver>
+   <slot>reject()</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>316</x>
+     <y>260</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>286</x>
+     <y>274</y>
+    </hint>
+   </hints>
+  </connection>
+ </connections>
+</ui>



From mean at mail.berlios.de  Mon Dec 21 14:31:58 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:31:58 +0100
Subject: [Avidemux-svn-commit] r5693 - in branches/avidemux_2.6_branch_mean:
	avidemux/gtk/ADM_UIs/include avidemux/qt4/ADM_UIs/include
	avidemux/qt4/ADM_UIs/src avidemux_core/ADM_core/src
	avidemux_core/ADM_coreVideoFilter/include
	avidemux_core/ADM_coreVideoFilter/src
	avidemux_plugins/ADM_videoFilters6
Message-ID: <200912211331.nBLDVwkq028381@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:31:55 +0100 (Mon, 21 Dec 2009)
New Revision: 5693

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/include/DIA_flyDialogGtk.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/DIA_flyDialogQt4.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_QCanvas.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_flyDialogQt4.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/DIA_flyDialog.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
Log:
[flyDialog] common+qt4, skeleton of the flyDialog class to ease on the fly filter preview

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/include/DIA_flyDialogGtk.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/include/DIA_flyDialogGtk.h	2009-12-21 13:31:51 UTC (rev 5692)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/include/DIA_flyDialogGtk.h	2009-12-21 13:31:55 UTC (rev 5693)
@@ -28,7 +28,7 @@
 class ADM_flyDialogGtk : public ADM_flyDialog
 {
 public:
-  ADM_flyDialogGtk(uint32_t width, uint32_t height, AVDMGenericVideoStream *in,
+  ADM_flyDialogGtk(uint32_t width, uint32_t height, ADM_coreVideoFilter *in,
                               void *canvas, void *slider, int yuv, ResizeMethod resizeMethod);
   virtual           ~ADM_flyDialogGtk(void);
   virtual uint8_t  isRgbInverted(void);

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/DIA_flyDialogQt4.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/DIA_flyDialogQt4.h	2009-12-21 13:31:51 UTC (rev 5692)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/DIA_flyDialogQt4.h	2009-12-21 13:31:55 UTC (rev 5693)
@@ -17,7 +17,7 @@
 #ifndef ADM_FLY_DIALOG_QT4H
 #define ADM_FLY_DIALOG_QT4H
 #include "ADM_image.h"
-#include "ADM_videoFilter.h"
+//#include "ADM_videoFilter.h"
 #include "DIA_flyDialog.h"
 
 class FlyDialogEventFilter : public QObject
@@ -35,7 +35,7 @@
 class ADM_flyDialogQt4 : public ADM_flyDialog
 {
 public:
-  ADM_flyDialogQt4(uint32_t width, uint32_t height, AVDMGenericVideoStream *in,
+  ADM_flyDialogQt4(uint32_t width, uint32_t height, ADM_coreVideoFilter *in,
                               void *canvas, void *slider, int yuv, ResizeMethod resizeMethod);
 
   

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt	2009-12-21 13:31:51 UTC (rev 5692)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt	2009-12-21 13:31:55 UTC (rev 5693)
@@ -7,8 +7,8 @@
 SET(${ADM_LIB}_T
 	T_bitrate.cpp  T_button.cpp  T_dialogFactory.cpp  T_filesel.cpp  T_menu.cpp
 	T_slider.cpp  T_threadCount.cpp  T_toggle.cpp  T_notch.cpp
-        #T_flyDialogQt4.cpp 
-        #T_QCanvas.cpp
+        T_flyDialogQt4.cpp 
+        T_QCanvas.cpp
 )
 
 SET(${ADM_LIB}_SRCS
@@ -20,5 +20,4 @@
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/../include)
 ADD_LIBRARY(${ADM_LIB} SHARED ${${ADM_LIB}_SRCS})
 TARGET_LINK_LIBRARIES(${ADM_LIB} ADM_core6 ADM_coreUI6 ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY} ADM_render6_qt4)
-#INSTALL(TARGETS ${ADM_LIB} RUNTIME DESTINATION ${BIN_DIR}  LIBRARY DESTINATION lib  ARCHIVE DESTINATION lib)
 ADM_INSTALL_LIB( ${ADM_LIB} )

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_QCanvas.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_QCanvas.cpp	2009-12-21 13:31:51 UTC (rev 5692)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_QCanvas.cpp	2009-12-21 13:31:55 UTC (rev 5693)
@@ -17,8 +17,6 @@
 #include <QtGui/QSlider>
 
 #include "ADM_default.h"
-
-#include "ADM_videoFilter.h"
 #include "DIA_flyDialogQt4.h"
 
 void ADM_QCanvas::changeSize(uint32_t w,uint32_t h)

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_flyDialogQt4.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_flyDialogQt4.cpp	2009-12-21 13:31:51 UTC (rev 5692)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_flyDialogQt4.cpp	2009-12-21 13:31:55 UTC (rev 5693)
@@ -1,6 +1,7 @@
 /***************************************************************************
-    copyright            : (C) 2006 by mean
-    email                : fixounet at free.fr
+    \file T_flyDialogQt4.cpp
+    \brief QT4 variabt of fly dialogs
+    \author mean (c) 2006, fixounet at free.fr
 ***************************************************************************/
 
 /***************************************************************************
@@ -19,19 +20,25 @@
 #include <QtGui/QSlider>
 
 #include "ADM_default.h"
-
-//#include "ADM_videoFilter.h"
 #include "DIA_flyDialog.h"
 #include "DIA_flyDialogQt4.h"
 
 extern float UI_calcZoomToFitScreen(QWidget* window, QWidget* canvas, uint32_t imageWidth, uint32_t imageHeight);
 extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w, uint32_t *h);
+/**
+    \fn    FlyDialogEventFilter
+    \brief
+*/
 
 FlyDialogEventFilter::FlyDialogEventFilter(ADM_flyDialog *flyDialog)
 {
 	recomputed = false;
 	this->flyDialog = flyDialog;
 }
+/**
+    \fn    eventFilter
+    \brief
+*/
 
 bool FlyDialogEventFilter::eventFilter(QObject *obj, QEvent *event)
 {
@@ -49,13 +56,21 @@
 
 	return QObject::eventFilter(obj, event);
 }
+/**
+    \fn    ADM_flyDialog
+    \brief
+*/
 
-  ADM_flyDialogQt4::ADM_flyDialogQt4(uint32_t width, uint32_t height, AVDMGenericVideoStream *in,
+  ADM_flyDialogQt4::ADM_flyDialogQt4(uint32_t width, uint32_t height, ADM_coreVideoFilter *in,
                               void *canvas, void *slider, int yuv, ResizeMethod resizeMethod):
                                 ADM_flyDialog(width,height,in,canvas,slider,yuv,resizeMethod) 
 {
         EndConstructor();
 }
+/**
+    \fn    postInit
+    \brief
+*/
 
 void ADM_flyDialogQt4::postInit(uint8_t reInit)
 {
@@ -67,7 +82,7 @@
 		FlyDialogEventFilter *eventFilter = new FlyDialogEventFilter(this);
 
 		if (slider)
-			slider->setMaximum(_in->getInfo()->nb_frames);
+			slider->setMaximum(ADM_FLY_SLIDER_MAX);
 
 		graphicsView->parentWidget()->installEventFilter(eventFilter);
 	}
@@ -76,11 +91,19 @@
 	graphicsView->setMinimumSize(_zoomW, _zoomH);
 	graphicsView->resize(_zoomW, _zoomH);
 }
+/**
+    \fn    calcZoomFactor
+    \brief
+*/
 
 float ADM_flyDialogQt4::calcZoomFactor(void)
 {
 	return UI_calcZoomToFitScreen(((ADM_QCanvas*)_canvas)->parentWidget()->parentWidget(), ((ADM_QCanvas*)_canvas)->parentWidget(), _w, _h);
 }
+/**
+    \fn    display
+    \brief
+*/
 
 uint8_t  ADM_flyDialogQt4::display(void)
 {
@@ -89,11 +112,16 @@
    view->dataBuffer=_rgbBufferOut;
    if(!_rgbBufferOut)
    {
-      printf("flyDialog: No rgbuffer ??\n"); 
+      ADM_info("flyDialog: No rgbuffer ??\n"); 
    } 
    view->repaint();
   return 1; 
 }
+/**
+    \fn    sliderGet
+    \brief
+*/
+
 uint32_t ADM_flyDialogQt4::sliderGet(void)
 {
   QSlider  *slide=(QSlider *)_slider;
@@ -101,13 +129,23 @@
   return slide->value();
   
 }
+/**
+    \fn    sliderSet
+    \brief
+*/
+
 uint8_t     ADM_flyDialogQt4::sliderSet(uint32_t value)
 {
   QSlider  *slide=(QSlider *)_slider;
   ADM_assert(slide);
+  if(value>ADM_FLY_SLIDER_MAX) value=ADM_FLY_SLIDER_MAX;
   slide->setValue(value);
   return 1; 
 }
+/**
+    \fn    isRgbInverted
+    \brief
+*/
 uint8_t  ADM_flyDialogQt4::isRgbInverted(void)
 {
   return 1; 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp	2009-12-21 13:31:51 UTC (rev 5692)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp	2009-12-21 13:31:55 UTC (rev 5693)
@@ -22,7 +22,8 @@
 #include <unistd.h>
 #ifndef __WIN32
 #include <fcntl.h>
-#else
+#endif
+#ifdef __WIN32
 #include <direct.h>
 #include <shlobj.h>
 #elif defined(__APPLE__)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/DIA_flyDialog.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/DIA_flyDialog.h	2009-12-21 13:31:51 UTC (rev 5692)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/DIA_flyDialog.h	2009-12-21 13:31:55 UTC (rev 5693)
@@ -40,6 +40,9 @@
 #include "ADM_default.h"
 #include "ADM_colorspace.h"
 #include "ADM_coreVideoFilter.h"
+
+#define ADM_FLY_SLIDER_MAX 1000
+
 enum ResizeMethod {
     RESIZE_NONE = 0,	// No automatic resize
 	RESIZE_AUTO = 1,	// Resize image when convenient (YUV: after filter, RGB: before applying filter)
@@ -57,7 +60,10 @@
 };
 
 typedef float gfloat;
-
+/**
+    \class ADM_flyDialog
+    \brief Base class for flyDialog
+*/
 class ADM_flyDialog
 {
   protected:
@@ -120,11 +126,11 @@
   
   virtual uint8_t  isRgbInverted(void)=0;
   virtual uint8_t  display(void)=0;
-  virtual float   calcZoomFactor(void)=0;
-  virtual uint32_t sliderGet(void)=0;
-  virtual uint8_t  sliderSet(uint32_t value) =0;
-  virtual void    postInit(uint8_t reInit)=0;
-  virtual uint8_t sliderChanged(void);
+  virtual float    calcZoomFactor(void)=0;
+  virtual uint32_t sliderGet(void)=0;             // Return the slider value between 0 and ADM_FLY_SLIDER_MAX
+  virtual uint8_t  sliderSet(uint32_t value) =0;  // Set slider value between 0 and ADM_FLY_SLIDE_MAX
+  virtual void     postInit(uint8_t reInit)=0;
+  virtual uint8_t  sliderChanged(void);
 };
 #if !defined(ADM_FLY_INTERNAL)
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp	2009-12-21 13:31:51 UTC (rev 5692)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp	2009-12-21 13:31:55 UTC (rev 5693)
@@ -22,7 +22,10 @@
 extern "C" {
 #include "ADM_ffmpeg/libavcodec/avcodec.h"
 }
-
+/**
+    \fn    ADM_flyDialog
+    \brief Constructor
+*/
 ADM_flyDialog::ADM_flyDialog(uint32_t width,uint32_t height,ADM_coreVideoFilter *in,
                                 void *canvas, void *slider,int yuv, ResizeMethod resizeMethod)
 {
@@ -113,6 +116,11 @@
                 }
                 postInit (false);
   }
+/**
+    \fn    recomputeSize
+    \brief recompute zoom factor
+*/
+
 void ADM_flyDialog::recomputeSize(void)
 {
     float new_zoom = calcZoomFactor();
@@ -218,7 +226,9 @@
     ADM_assert(_yuvBuffer);
     ADM_assert(_rgbBufferOut);
     ADM_assert(_in);
-    
+
+#warning    DISABLED
+
     //if(!_in->getFrameNumberNoAlloc(fn,&len,_yuvBuffer,&flags))
     {
       printf("[FlyDialog] Cannot get frame %u\n",fn); 
@@ -240,6 +250,10 @@
 
     return display();
 }
+/**
+    \fn    copyYuvFinalToRgb
+    \brief
+*/
 
 void ADM_flyDialog::copyYuvFinalToRgb(void)
 {
@@ -248,6 +262,10 @@
 	else
 		_rgb->scale(_yuvBufferOut->data, _rgbBufferOut);
 }
+/**
+    \fn    copyYuvScratchToRgb
+    \brief
+*/
 
 void ADM_flyDialog::copyYuvScratchToRgb(void)
 {
@@ -256,6 +274,10 @@
 	else
 		_rgb->scale(_yuvBuffer->data,_rgbBuffer);
 }
+/**
+    \fn    copyRgbFinalToDisplay
+    \brief
+*/
 
 void ADM_flyDialog::copyRgbFinalToDisplay(void)
 {

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2009-12-21 13:31:51 UTC (rev 5692)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/CMakeLists.txt	2009-12-21 13:31:55 UTC (rev 5693)
@@ -1,3 +1,4 @@
 ADD_SUBDIRECTORY(dummy)
 ADD_SUBDIRECTORY(verticalFlip)
 ADD_SUBDIRECTORY(resize)
+ADD_SUBDIRECTORY(crop)



From mean at mail.berlios.de  Mon Dec 21 14:32:04 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:04 +0100
Subject: [Avidemux-svn-commit] r5694 - in branches/avidemux_2.6_branch_mean:
	avidemux/cli/ADM_UIs/include avidemux/cli/ADM_UIs/src
	avidemux/cli/ADM_userInterfaces/ADM_dialog
	avidemux/cli/ADM_userInterfaces/ADM_gui2
	avidemux/common/ADM_script avidemux/gtk/ADM_UIs/src
	avidemux/gtk/ADM_userInterfaces/ADM_dialog
	avidemux/gtk/ADM_userInterfaces/ADM_filters
	avidemux/gtk/ADM_userInterfaces/ADM_ocr avidemux/qt4/ADM_UIs/include
	avidemux_plugins/ADM_videoFilters6/crop cmake
Message-ID: <200912211332.nBLDW48B028417@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:01 +0100 (Mon, 21 Dec 2009)
New Revision: 5694

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/include/DIA_flyDialogCli.h
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/src/DIA_flyDialogCli.cpp
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_gui2/preview_none.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/DIA_flyDialogGtk.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_calculator.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_flyPreview.h
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_preview.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_vcodec.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/gui_filtermanager.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_ocr/adm_ocr.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/DIA_flyDialogQt4.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/ADM_vidCrop.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/cmake/vf_plugin_qt4.cmake
Log:
[gtk/cli] Cleanup regarding old genericVideoStream+fixup for flyDialog

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/include/DIA_flyDialogCli.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/include/DIA_flyDialogCli.h	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/include/DIA_flyDialogCli.h	2009-12-21 13:32:01 UTC (rev 5694)
@@ -20,7 +20,7 @@
 class ADM_flyDialogCli : public ADM_flyDialog
 {
 public:
-  ADM_flyDialogCli(uint32_t width, uint32_t height, AVDMGenericVideoStream *in,
+  ADM_flyDialogCli(uint32_t width, uint32_t height, ADM_coreVideoFilter *in,
                               void *canvas, void *slider, int yuv, ResizeMethod resizeMethod):
                                 ADM_flyDialog(width,height,in,canvas,slider,yuv,resizeMethod) {};
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/src/DIA_flyDialogCli.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/src/DIA_flyDialogCli.cpp	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_UIs/src/DIA_flyDialogCli.cpp	2009-12-21 13:32:01 UTC (rev 5694)
@@ -15,11 +15,8 @@
 
 
 #include <math.h>
-
 #include "ADM_default.h"
-
 #include "ADM_image.h"
-#include "ADM_videoFilter.h"
 #include "DIA_flyDialog.h"
 #include "DIA_flyDialogCli.h"
 #include "ADM_assert.h"

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_none.cpp	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_dialog/DIA_none.cpp	2009-12-21 13:32:01 UTC (rev 5694)
@@ -23,12 +23,6 @@
 #include "ADM_default.h"
 
 #include "ADM_assert.h"
-
-#include "ADM_videoFilter.h"
-
-
-
-
 #include "audioencoder.h"
 #include "ADM_lavcodec.h"
 #include "ADM_render/GUI_render.cpp"

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_gui2/preview_none.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_gui2/preview_none.cpp	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_gui2/preview_none.cpp	2009-12-21 13:32:01 UTC (rev 5694)
@@ -10,7 +10,6 @@
 #include "ADM_assert.h"
 #include "fourcc.h"
 #include "ADM_editor/ADM_edit.hxx"
-#include "ADM_videoFilter.h"
 
 #include "ADM_render/GUI_render.h"
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp	2009-12-21 13:32:01 UTC (rev 5694)
@@ -27,8 +27,7 @@
 #include "ADM_videoEncoderApi.h"
 #include "ADM_videoFilterApi.h"
 #include "ADM_videoFilters.h"
-
-//extern VF_FILTERS filterGetTagFromName(const char *inname);
+#include "ADM_confCouple.h"
 extern uint8_t A_ListAllBlackFrames( char *file );
 extern uint8_t ADM_saveRaw (const char *name);
 extern int A_saveJpg (char *name);

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/CMakeLists.txt	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/CMakeLists.txt	2009-12-21 13:32:01 UTC (rev 5694)
@@ -22,7 +22,7 @@
         choice.cpp       
         toolkit_dialog.cpp
         toolkit.cpp
-#        DIA_flyDialogGtk.cpp
+        DIA_flyDialogGtk.cpp
 )
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/../include)
 ADD_LIBRARY(${ADM_LIB} SHARED ${${ADM_LIB}_SRCS})

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/DIA_flyDialogGtk.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/DIA_flyDialogGtk.cpp	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_UIs/src/DIA_flyDialogGtk.cpp	2009-12-21 13:32:01 UTC (rev 5694)
@@ -13,7 +13,6 @@
 ***************************************************************************///
 
 #include "ADM_toolkitGtk.h"
-#include "ADM_videoFilter.h"
 #include "DIA_flyDialogGtk.h"
 #include "DIA_factory.h"
 
@@ -34,7 +33,7 @@
  * 
  */
 
-ADM_flyDialogGtk::ADM_flyDialogGtk(uint32_t width, uint32_t height, AVDMGenericVideoStream *in,
+ADM_flyDialogGtk::ADM_flyDialogGtk(uint32_t width, uint32_t height, ADM_coreVideoFilter *in,
                               void *canvas, void *slider, int yuv, ResizeMethod resizeMethod):
                                 ADM_flyDialog(width,height,in,canvas,slider,yuv,resizeMethod)
   {
@@ -44,7 +43,7 @@
 {
 	if (_slider)
 	{
-		GtkAdjustment *adj = (GtkAdjustment*)gtk_adjustment_new(0, 0, _in->getInfo()->nb_frames - 1, 0, 1, 0);
+		GtkAdjustment *adj = (GtkAdjustment*)gtk_adjustment_new(0, 0, ADM_FLY_SLIDER_MAX, 0, 1, 0);
 
 		gtk_range_set_adjustment(GTK_RANGE(_slider), adj);
 		gtk_scale_set_digits(GTK_SCALE(_slider), 0);

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_calculator.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_calculator.cpp	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_calculator.cpp	2009-12-21 13:32:01 UTC (rev 5694)
@@ -22,8 +22,7 @@
 #include "DIA_fileSel.h"
 
 #include "ADM_editor/ADM_edit.hxx"
-#include "ADM_videoFilter.h"
-#include "ADM_videoFilter_internal.h"
+//#include "ADM_videoFilter_internal.h"
 
 #include "ADM_vidMisc.h"
 #include "avi_vars.h"
@@ -146,12 +145,16 @@
 /************************************/
 uint32_t getPicSize(void)
 {
+#warning FIXME
+return 720*576;
+#if 0
 uint32_t size;
          AVDMGenericVideoStream *last;
                 last=getLastVideoFilter();
                 size=last->getInfo()->width*last->getInfo()->height;
 
                 return size;
+#endif
 }
 //*************************************
 void update( void )

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_flyPreview.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_flyPreview.h	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_flyPreview.h	2009-12-21 13:32:01 UTC (rev 5694)
@@ -22,7 +22,7 @@
 	uint8_t upload(void) {return 1;}
 	uint8_t cleanup(void) {return 1;}
 
-	flySeekablePreview(uint32_t width, uint32_t height, AVDMGenericVideoStream *videoStream, void *canvas, void *slider) : 
+	flySeekablePreview(uint32_t width, uint32_t height, ADM_coreVideoFilter *videoStream, void *canvas, void *slider) : 
 	  ADM_flyDialogGtk(width, height, videoStream, canvas, slider, 0, RESIZE_AUTO) {delete[] _rgbBufferOut; _rgbBufferOut = NULL;};
 	virtual ~flySeekablePreview(void) {_rgbBufferOut = NULL;};
 };

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_preview.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_preview.cpp	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_preview.cpp	2009-12-21 13:32:01 UTC (rev 5694)
@@ -20,9 +20,6 @@
  ***************************************************************************/
 
 #include "ADM_toolkitGtk.h"
-#include "ADM_videoFilter.h"
-
-
 #include "DIA_flyDialog.h"
 #include "DIA_flyPreview.h"
 
@@ -37,10 +34,10 @@
 /* =================================
             Filter Preview
    ================================= */
-uint8_t DIA_filterPreview(const char *captionText, AVDMGenericVideoStream *videoStream, uint32_t frame)
+uint8_t DIA_filterPreview(const char *captionText, ADM_coreVideoFilter *videoStream, uint32_t frame)
 {
-	ADM_assert(frame <= videoStream->getInfo()->nb_frames);
 
+
 	GtkWidget *hbuttonbox1, *buttonOk, *scale;
 
 	dialog = create_dialog1();

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_vcodec.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_vcodec.cpp	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_vcodec.cpp	2009-12-21 13:32:01 UTC (rev 5694)
@@ -6,7 +6,7 @@
 #include "ADM_toolkitGtk.h"
 //___________________________________
 #include "ADM_editor/ADM_edit.hxx"
-#include "ADM_videoFilter.h"
+//#include "ADM_videoFilter.h"
 
 //#include "ADM_encoder/ADM_vidEncode.hxx"
 //#include "ADM_encoder/adm_encoder.h"

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/gui_filtermanager.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/gui_filtermanager.cpp	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/gui_filtermanager.cpp	2009-12-21 13:32:01 UTC (rev 5694)
@@ -14,8 +14,6 @@
 
 #include "DIA_coreToolkit.h"
 #include "DIA_fileSel.h"
-#include "ADM_videoFilter.h"
-#include "ADM_videoFilter_internal.h"
 #include "ADM_editor/ADM_edit.hxx"
 #include "avi_vars.h"
 //#include "ADM_filter/vidVCD.h"
@@ -42,11 +40,8 @@
   A_DOUBLECLICK,
   A_END
 }gui_act;
-//___________________________________________
-extern AVDMGenericVideoStream *filterCreateFromTag (VF_FILTERS tag,
-						    CONFcouple * conf,
-						    AVDMGenericVideoStream *
-						    in);
+//___________________________________________
+#if 0
 extern const char  *filterGetNameFromTag(VF_FILTERS tag);
 //___________________________________________
 extern FILTER videofilters[VF_MAX_FILTER];
@@ -68,7 +63,8 @@
 static void on_action_double_click_1 (GtkButton * button, gpointer user_data);
 static void updateFilterList (void);
 static VF_FILTERS getFilterFromSelection (void);
-static void wrapToolButton(GtkWidget * wid, gpointer user_data);
+static void wrapToolButton(GtkWidget * wid, gpointer user_data);
+#endif
 //___________________________________________
 #define NB_TREE 9
 static  uint32_t max = 0;
@@ -146,7 +142,7 @@
         dummy=(TPE)user_data;
 
         action=(gui_act) dummy;
-        on_action(action);
+//        on_action(action);
 }
 //
 // One of the button of the main dialog was pressed
@@ -365,10 +361,11 @@
 /*
  	\fn getFilterFromSelection
 	\brief returns the tag of the selected filter
-*/
+*/
+#if 0
 VF_FILTERS getFilterFromSelection (void)
 {
-#if 0
+
     uint32_t sel = 0;
 	uint8_t ret = 0;
     VF_FILTERS tag = VF_INVALID;
@@ -381,8 +378,9 @@
         tag = filterCategories[page-1][sel]->tag;
 	}
     return tag;
+
+}
 #endif
-}
 /**
  * 	\fn createFilterDialog
  *  \brief Create the dialog including list of all filters available on the left.

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_ocr/adm_ocr.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_ocr/adm_ocr.cpp	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_ocr/adm_ocr.cpp	2009-12-21 13:32:01 UTC (rev 5694)
@@ -34,7 +34,6 @@
 
 #include "DIA_coreToolkit.h"
 #include "ADM_editor/ADM_edit.hxx"
-#include "ADM_videoFilter.h"
 #include "DIA_fileSel.h"
 
 #if 0

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/DIA_flyDialogQt4.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/DIA_flyDialogQt4.h	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/DIA_flyDialogQt4.h	2009-12-21 13:32:01 UTC (rev 5694)
@@ -17,7 +17,6 @@
 #ifndef ADM_FLY_DIALOG_QT4H
 #define ADM_FLY_DIALOG_QT4H
 #include "ADM_image.h"
-//#include "ADM_videoFilter.h"
 #include "DIA_flyDialog.h"
 
 class FlyDialogEventFilter : public QObject

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/ADM_vidCrop.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/ADM_vidCrop.cpp	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/ADM_vidCrop.cpp	2009-12-21 13:32:01 UTC (rev 5694)
@@ -39,7 +39,7 @@
 
        virtual const char   *getConfiguration(void);          /// Return  current configuration as a human readable string
        virtual bool         getNextFrame(ADMImage *image);    /// Return the next image
-       virtual FilterInfo  *getInfo(void);                    /// Return picture parameters after this filter
+       //virtual FilterInfo  *getInfo(void);                    /// Return picture parameters after this filter
 	   virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
        virtual bool         configure(void) ;                 /// Start graphical user interface
     

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/CMakeLists.txt	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/CMakeLists.txt	2009-12-21 13:32:01 UTC (rev 5694)
@@ -15,7 +15,7 @@
 #------------- Gtk Version ---------------
 INCLUDE(vf_plugin_gtk)
 SET(CropGtk_SRCS gtk/DIA_crop.cpp)
-INIT_VIDEO_FILTER_GTK(ADM_vf_cropGtk ${CropGtk_SRCS} ${CropCommon_SRC})
+INIT_VIDEO_FILTER_GTK(ADM_vf_cropGtk ${CropGtk_SRCS} ${CropCommon_SRCS})
 
 #------------ Cli Version ----------------
 INCLUDE(vf_plugin_cli)

Modified: branches/avidemux_2.6_branch_mean/cmake/vf_plugin_qt4.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/vf_plugin_qt4.cmake	2009-12-21 13:31:55 UTC (rev 5693)
+++ branches/avidemux_2.6_branch_mean/cmake/vf_plugin_qt4.cmake	2009-12-21 13:32:01 UTC (rev 5694)
@@ -9,7 +9,6 @@
 		ADD_TARGET_CFLAGS(${lib} "-DADM_UI_TYPE_BUILD=4")
 		TARGET_LINK_LIBRARIES( ${lib} ADM_UIQT4  ADM_render6_qt4)
 		TARGET_LINK_LIBRARIES(${lib} ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY})
-
 		INIT_VIDEO_FILTER_INTERNAL(${lib})
 		INSTALL_VIDEO_FILTER_INTERNAL(${lib})
 	ENDIF (DO_QT4)



From mean at mail.berlios.de  Mon Dec 21 14:32:07 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:07 +0100
Subject: [Avidemux-svn-commit] r5695 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters
Message-ID: <200912211332.nBLDW7MQ028438@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:06 +0100 (Mon, 21 Dec 2009)
New Revision: 5695

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/filter.qrc
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/mainfilter.ui
Log:
[UI] Move video filter icons to the common folder

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/filter.qrc
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/filter.qrc	2009-12-21 13:32:01 UTC (rev 5694)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/filter.qrc	2009-12-21 13:32:06 UTC (rev 5695)
@@ -1,22 +1,22 @@
 <RCC>
-    <qresource prefix="/new/prefix1" >
-        <file>icons/1.png</file>
-        <file>icons/2.png</file>
-        <file>icons/3.png</file>
-        <file>icons/4.png</file>
-        <file>icons/5.png</file>
-        <file>icons/6.png</file>
-        <file>icons/7.png</file>
-        <file>icons/add.png</file>
-        <file>icons/cd.png</file>
-        <file>icons/close.png</file>
-        <file>icons/down.png</file>
-        <file>icons/exec.png</file>
-        <file>icons/fileopen.png</file>
-        <file>icons/filesave.png</file>
-        <file>icons/filesaveas.png</file>
-        <file>icons/remove.png</file>
-        <file>icons/thumbnail.png</file>
-        <file>icons/up.png</file>
-    </qresource>
+  <qresource prefix="/new/prefix1" >
+    <file>../../../common/ADM_icons/videoFilter/up.png</file>
+    <file>../../common/ADM_icons/videoFilter/add.png</file>
+    <file>../../common/ADM_icons/videoFilter/cd.png</file>
+    <file>../../common/ADM_icons/videoFilter/close.png</file>
+    <file>../../common/ADM_icons/videoFilter/down.png</file>
+    <file>../../common/ADM_icons/videoFilter/exec.png</file>
+    <file>../../common/ADM_icons/videoFilter/fileopen.png</file>
+    <file>../../common/ADM_icons/videoFilter/filesave.png</file>
+    <file>../../common/ADM_icons/videoFilter/filesaveas.png</file>
+    <file>../../common/ADM_icons/videoFilter/remove.png</file>
+    <file>../../common/ADM_icons/videoFilter/thumbnail.png</file>
+    <file>../../../common/ADM_icons/videoFilter/1.png</file>
+    <file>../../../common/ADM_icons/videoFilter/2.png</file>
+    <file>../../../common/ADM_icons/videoFilter/3.png</file>
+    <file>../../../common/ADM_icons/videoFilter/4.png</file>
+    <file>../../../common/ADM_icons/videoFilter/5.png</file>
+    <file>../../../common/ADM_icons/videoFilter/6.png</file>
+    <file>../../../common/ADM_icons/videoFilter/7.png</file>
+  </qresource>
 </RCC>

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/mainfilter.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/mainfilter.ui	2009-12-21 13:32:01 UTC (rev 5694)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/mainfilter.ui	2009-12-21 13:32:06 UTC (rev 5695)
@@ -1,7 +1,8 @@
-<ui version="4.0" >
+<?xml version="1.0" encoding="UTF-8"?>
+<ui version="4.0">
  <class>mainFilterDialog</class>
- <widget class="QDialog" name="mainFilterDialog" >
-  <property name="geometry" >
+ <widget class="QDialog" name="mainFilterDialog">
+  <property name="geometry">
    <rect>
     <x>0</x>
     <y>0</y>
@@ -9,266 +10,160 @@
     <height>545</height>
    </rect>
   </property>
-  <property name="minimumSize" >
+  <property name="minimumSize">
    <size>
     <width>0</width>
     <height>0</height>
    </size>
   </property>
-  <property name="windowTitle" >
+  <property name="windowTitle">
    <string>Video Filter Manager</string>
   </property>
-  <layout class="QVBoxLayout" >
-   <property name="margin" >
-    <number>9</number>
-   </property>
-   <property name="spacing" >
+  <layout class="QVBoxLayout">
+   <property name="spacing">
     <number>6</number>
    </property>
+   <property name="margin">
+    <number>9</number>
+   </property>
    <item>
-    <layout class="QGridLayout" >
-     <property name="margin" >
+    <layout class="QGridLayout">
+     <property name="margin">
       <number>0</number>
      </property>
-     <property name="spacing" >
+     <property name="spacing">
       <number>6</number>
      </property>
-     <item row="4" column="0" colspan="2" >
-      <layout class="QGridLayout" >
-       <property name="margin" >
+     <item row="4" column="0" colspan="2">
+      <layout class="QGridLayout">
+       <property name="margin">
         <number>0</number>
        </property>
-       <property name="spacing" >
+       <property name="spacing">
         <number>6</number>
        </property>
-       <item row="0" column="1" >
-        <widget class="QPushButton" name="pushButtonSVCD" >
-         <property name="sizePolicy" >
-          <sizepolicy>
-           <hsizetype>5</hsizetype>
-           <vsizetype>0</vsizetype>
+       <item row="0" column="1">
+        <widget class="QPushButton" name="pushButtonSVCD">
+         <property name="sizePolicy">
+          <sizepolicy hsizetype="Preferred" vsizetype="Fixed">
            <horstretch>0</horstretch>
            <verstretch>0</verstretch>
           </sizepolicy>
          </property>
-         <property name="minimumSize" >
+         <property name="minimumSize">
           <size>
            <width>72</width>
            <height>0</height>
           </size>
          </property>
-         <property name="text" >
+         <property name="text">
           <string>&amp;SVCD res</string>
          </property>
-         <property name="icon" >
-          <iconset resource="filter.qrc" >:/new/prefix1/icons/cd.png</iconset>
+         <property name="icon">
+          <iconset resource="filter.qrc">
+           <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/cd.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/cd.png</iconset>
          </property>
         </widget>
        </item>
-       <item row="1" column="1" >
-        <widget class="QPushButton" name="pushButtonVCD" >
-         <property name="sizePolicy" >
-          <sizepolicy>
-           <hsizetype>5</hsizetype>
-           <vsizetype>0</vsizetype>
+       <item row="1" column="1">
+        <widget class="QPushButton" name="pushButtonVCD">
+         <property name="sizePolicy">
+          <sizepolicy hsizetype="Preferred" vsizetype="Fixed">
            <horstretch>0</horstretch>
            <verstretch>0</verstretch>
           </sizepolicy>
          </property>
-         <property name="minimumSize" >
+         <property name="minimumSize">
           <size>
            <width>72</width>
            <height>0</height>
           </size>
          </property>
-         <property name="text" >
+         <property name="text">
           <string>&amp;VCD res</string>
          </property>
-         <property name="icon" >
-          <iconset resource="filter.qrc" >:/new/prefix1/icons/cd.png</iconset>
+         <property name="icon">
+          <iconset resource="filter.qrc">
+           <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/cd.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/cd.png</iconset>
          </property>
         </widget>
        </item>
-       <item row="1" column="0" >
-        <widget class="QPushButton" name="pushButtonHalfDVD" >
-         <property name="sizePolicy" >
-          <sizepolicy>
-           <hsizetype>7</hsizetype>
-           <vsizetype>5</vsizetype>
+       <item row="1" column="0">
+        <widget class="QPushButton" name="pushButtonHalfDVD">
+         <property name="sizePolicy">
+          <sizepolicy hsizetype="Expanding" vsizetype="Preferred">
            <horstretch>0</horstretch>
            <verstretch>0</verstretch>
           </sizepolicy>
          </property>
-         <property name="minimumSize" >
+         <property name="minimumSize">
           <size>
            <width>72</width>
            <height>0</height>
           </size>
          </property>
-         <property name="text" >
+         <property name="text">
           <string>&amp;Half D1 res</string>
          </property>
-         <property name="icon" >
-          <iconset resource="filter.qrc" >:/new/prefix1/icons/cd.png</iconset>
+         <property name="icon">
+          <iconset resource="filter.qrc">
+           <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/cd.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/cd.png</iconset>
          </property>
         </widget>
        </item>
-       <item row="0" column="0" >
-        <widget class="QPushButton" name="pushButtonDVD" >
-         <property name="sizePolicy" >
-          <sizepolicy>
-           <hsizetype>5</hsizetype>
-           <vsizetype>0</vsizetype>
+       <item row="0" column="0">
+        <widget class="QPushButton" name="pushButtonDVD">
+         <property name="sizePolicy">
+          <sizepolicy hsizetype="Preferred" vsizetype="Fixed">
            <horstretch>0</horstretch>
            <verstretch>0</verstretch>
           </sizepolicy>
          </property>
-         <property name="minimumSize" >
+         <property name="minimumSize">
           <size>
            <width>72</width>
            <height>0</height>
           </size>
          </property>
-         <property name="text" >
+         <property name="text">
           <string>&amp;DVD res</string>
          </property>
-         <property name="icon" >
-          <iconset resource="filter.qrc" >:/new/prefix1/icons/cd.png</iconset>
+         <property name="icon">
+          <iconset resource="filter.qrc">
+           <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/cd.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/cd.png</iconset>
          </property>
         </widget>
        </item>
       </layout>
      </item>
-     <item rowspan="4" row="1" column="2" colspan="2" >
-      <widget class="QListWidget" name="listWidgetAvailable" >
-       <property name="sizePolicy" >
-        <sizepolicy>
-         <hsizetype>7</hsizetype>
-         <vsizetype>7</vsizetype>
+     <item row="1" column="2" rowspan="4" colspan="2">
+      <widget class="QListWidget" name="listWidgetAvailable">
+       <property name="sizePolicy">
+        <sizepolicy hsizetype="Expanding" vsizetype="Expanding">
          <horstretch>0</horstretch>
          <verstretch>0</verstretch>
         </sizepolicy>
        </property>
-       <property name="minimumSize" >
+       <property name="minimumSize">
         <size>
          <width>340</width>
          <height>0</height>
         </size>
        </property>
-       <property name="spacing" >
+       <property name="spacing">
         <number>2</number>
        </property>
       </widget>
      </item>
-     <item rowspan="3" row="1" column="0" colspan="2" >
-      <widget class="QListWidget" name="listFilterCategory" >
-       <property name="sizePolicy" >
-        <sizepolicy>
-         <hsizetype>0</hsizetype>
-         <vsizetype>7</vsizetype>
-         <horstretch>0</horstretch>
-         <verstretch>0</verstretch>
-        </sizepolicy>
-       </property>
-       <property name="minimumSize" >
-        <size>
-         <width>100</width>
-         <height>340</height>
-        </size>
-       </property>
-       <property name="selectionBehavior" >
-        <enum>QAbstractItemView::SelectRows</enum>
-       </property>
-       <property name="iconSize" >
-        <size>
-         <width>24</width>
-         <height>24</height>
-        </size>
-       </property>
-       <property name="resizeMode" >
-        <enum>QListView::Adjust</enum>
-       </property>
-       <property name="spacing" >
-        <number>3</number>
-       </property>
-       <property name="currentRow" >
-        <number>0</number>
-       </property>
-       <item>
-        <property name="text" >
-         <string>Transform</string>
-        </property>
-        <property name="icon" >
-         <iconset resource="filter.qrc" >:/new/prefix1/icons/1.png</iconset>
-        </property>
-       </item>
-       <item>
-        <property name="text" >
-         <string>Interlacing</string>
-        </property>
-        <property name="icon" >
-         <iconset resource="filter.qrc" >:/new/prefix1/icons/2.png</iconset>
-        </property>
-       </item>
-       <item>
-        <property name="text" >
-         <string>Colors</string>
-        </property>
-        <property name="icon" >
-         <iconset resource="filter.qrc" >:/new/prefix1/icons/4.png</iconset>
-        </property>
-       </item>
-       <item>
-        <property name="text" >
-         <string>Noise</string>
-        </property>
-        <property name="icon" >
-         <iconset resource="filter.qrc" >:/new/prefix1/icons/5.png</iconset>
-        </property>
-       </item>
-       <item>
-        <property name="text" >
-         <string>Sharpness</string>
-        </property>
-        <property name="icon" >
-         <iconset resource="filter.qrc" >:/new/prefix1/icons/3.png</iconset>
-        </property>
-       </item>
-       <item>
-        <property name="text" >
-         <string>Subtitles</string>
-        </property>
-        <property name="icon" >
-         <iconset resource="filter.qrc" >:/new/prefix1/icons/7.png</iconset>
-        </property>
-       </item>
-       <item>
-        <property name="text" >
-         <string>Miscellaneous</string>
-        </property>
-        <property name="icon" >
-         <iconset resource="filter.qrc" >:/new/prefix1/icons/6.png</iconset>
-        </property>
-       </item>
-       <item>
-        <property name="text" >
-         <string>External</string>
-        </property>
-        <property name="icon" >
-         <iconset resource="filter.qrc" >:/new/prefix1/icons/exec.png</iconset>
-        </property>
-       </item>
-      </widget>
-     </item>
-     <item row="1" column="4" >
+     <item row="1" column="4">
       <spacer>
-       <property name="orientation" >
+       <property name="orientation">
         <enum>Qt::Horizontal</enum>
        </property>
-       <property name="sizeType" >
+       <property name="sizeType">
         <enum>QSizePolicy::Fixed</enum>
        </property>
-       <property name="sizeHint" >
+       <property name="sizeHint" stdset="0">
         <size>
          <width>12</width>
          <height>20</height>
@@ -276,56 +171,52 @@
        </property>
       </spacer>
      </item>
-     <item row="0" column="5" >
-      <widget class="QLabel" name="label_2" >
-       <property name="sizePolicy" >
-        <sizepolicy>
-         <hsizetype>5</hsizetype>
-         <vsizetype>4</vsizetype>
+     <item row="0" column="5">
+      <widget class="QLabel" name="label_2">
+       <property name="sizePolicy">
+        <sizepolicy hsizetype="Preferred" vsizetype="Maximum">
          <horstretch>0</horstretch>
          <verstretch>0</verstretch>
         </sizepolicy>
        </property>
-       <property name="text" >
-        <string>&lt;big>&lt;b>Active Filters&lt;/b>&lt;/big></string>
+       <property name="text">
+        <string>&lt;big&gt;&lt;b&gt;Active Filters&lt;/b&gt;&lt;/big&gt;</string>
        </property>
       </widget>
      </item>
-     <item rowspan="4" row="1" column="5" colspan="11" >
-      <widget class="QListWidget" name="listWidgetActive" >
-       <property name="sizePolicy" >
-        <sizepolicy>
-         <hsizetype>7</hsizetype>
-         <vsizetype>7</vsizetype>
+     <item row="1" column="5" rowspan="4" colspan="11">
+      <widget class="QListWidget" name="listWidgetActive">
+       <property name="sizePolicy">
+        <sizepolicy hsizetype="Expanding" vsizetype="Expanding">
          <horstretch>0</horstretch>
          <verstretch>0</verstretch>
         </sizepolicy>
        </property>
-       <property name="minimumSize" >
+       <property name="minimumSize">
         <size>
          <width>340</width>
          <height>0</height>
         </size>
        </property>
-       <property name="spacing" >
+       <property name="spacing">
         <number>2</number>
        </property>
       </widget>
      </item>
-     <item row="5" column="5" colspan="11" >
-      <layout class="QHBoxLayout" >
-       <property name="margin" >
-        <number>0</number>
-       </property>
-       <property name="spacing" >
+     <item row="5" column="5" colspan="11">
+      <layout class="QHBoxLayout">
+       <property name="spacing">
         <number>6</number>
        </property>
+       <property name="margin">
+        <number>0</number>
+       </property>
        <item>
         <spacer>
-         <property name="orientation" >
+         <property name="orientation">
           <enum>Qt::Horizontal</enum>
          </property>
-         <property name="sizeHint" >
+         <property name="sizeHint" stdset="0">
           <size>
            <width>0</width>
            <height>22</height>
@@ -334,111 +225,113 @@
         </spacer>
        </item>
        <item>
-        <widget class="QToolButton" name="toolButtonConfigure" >
-         <property name="sizePolicy" >
-          <sizepolicy>
-           <hsizetype>0</hsizetype>
-           <vsizetype>5</vsizetype>
+        <widget class="QToolButton" name="toolButtonConfigure">
+         <property name="sizePolicy">
+          <sizepolicy hsizetype="Fixed" vsizetype="Preferred">
            <horstretch>0</horstretch>
            <verstretch>0</verstretch>
           </sizepolicy>
          </property>
-         <property name="text" >
+         <property name="text">
           <string>C&amp;onfigure</string>
          </property>
         </widget>
        </item>
        <item>
-        <widget class="QToolButton" name="toolButtonPartial" >
-         <property name="sizePolicy" >
-          <sizepolicy>
-           <hsizetype>0</hsizetype>
-           <vsizetype>5</vsizetype>
+        <widget class="QToolButton" name="toolButtonPartial">
+         <property name="sizePolicy">
+          <sizepolicy hsizetype="Fixed" vsizetype="Preferred">
            <horstretch>0</horstretch>
            <verstretch>0</verstretch>
           </sizepolicy>
          </property>
-         <property name="text" >
+         <property name="text">
           <string>P&amp;artial</string>
          </property>
         </widget>
        </item>
        <item>
-        <widget class="QToolButton" name="toolButtonLoad" >
-         <property name="text" >
+        <widget class="QToolButton" name="toolButtonLoad">
+         <property name="text">
           <string>Load</string>
          </property>
-         <property name="icon" >
-          <iconset resource="filter.qrc" >:/new/prefix1/icons/fileopen.png</iconset>
+         <property name="icon">
+          <iconset resource="filter.qrc">
+           <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/fileopen.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/fileopen.png</iconset>
          </property>
         </widget>
        </item>
        <item>
-        <widget class="QToolButton" name="toolButtonSave" >
-         <property name="text" >
+        <widget class="QToolButton" name="toolButtonSave">
+         <property name="text">
           <string>Save</string>
          </property>
-         <property name="icon" >
-          <iconset resource="filter.qrc" >:/new/prefix1/icons/filesave.png</iconset>
+         <property name="icon">
+          <iconset resource="filter.qrc">
+           <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/filesave.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/filesave.png</iconset>
          </property>
         </widget>
        </item>
        <item>
-        <widget class="QToolButton" name="toolButtonSaveScript" >
-         <property name="text" >
+        <widget class="QToolButton" name="toolButtonSaveScript">
+         <property name="text">
           <string>Save Script</string>
          </property>
-         <property name="icon" >
-          <iconset resource="filter.qrc" >:/new/prefix1/icons/filesaveas.png</iconset>
+         <property name="icon">
+          <iconset resource="filter.qrc">
+           <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/filesaveas.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/filesaveas.png</iconset>
          </property>
         </widget>
        </item>
        <item>
-        <widget class="QToolButton" name="toolButtonDown" >
-         <property name="text" >
+        <widget class="QToolButton" name="toolButtonDown">
+         <property name="text">
           <string>Down</string>
          </property>
-         <property name="icon" >
-          <iconset resource="filter.qrc" >:/new/prefix1/icons/down.png</iconset>
+         <property name="icon">
+          <iconset resource="filter.qrc">
+           <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/down.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/down.png</iconset>
          </property>
         </widget>
        </item>
        <item>
-        <widget class="QToolButton" name="toolButtonUp" >
-         <property name="text" >
+        <widget class="QToolButton" name="toolButtonUp">
+         <property name="text">
           <string>Up</string>
          </property>
-         <property name="icon" >
-          <iconset resource="filter.qrc" >:/new/prefix1/icons/up.png</iconset>
+         <property name="icon">
+          <iconset resource="filter.qrc">
+           <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/up.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/up.png</iconset>
          </property>
         </widget>
        </item>
        <item>
-        <widget class="QToolButton" name="pushButtonRemove" >
-         <property name="text" >
+        <widget class="QToolButton" name="pushButtonRemove">
+         <property name="text">
           <string>Remove</string>
          </property>
-         <property name="icon" >
-          <iconset resource="filter.qrc" >:/new/prefix1/icons/remove.png</iconset>
+         <property name="icon">
+          <iconset resource="filter.qrc">
+           <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/remove.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/remove.png</iconset>
          </property>
         </widget>
        </item>
       </layout>
      </item>
-     <item row="5" column="2" colspan="2" >
-      <layout class="QHBoxLayout" >
-       <property name="margin" >
-        <number>0</number>
-       </property>
-       <property name="spacing" >
+     <item row="5" column="2" colspan="2">
+      <layout class="QHBoxLayout">
+       <property name="spacing">
         <number>6</number>
        </property>
+       <property name="margin">
+        <number>0</number>
+       </property>
        <item>
         <spacer>
-         <property name="orientation" >
+         <property name="orientation">
           <enum>Qt::Horizontal</enum>
          </property>
-         <property name="sizeHint" >
+         <property name="sizeHint" stdset="0">
           <size>
            <width>0</width>
            <height>22</height>
@@ -447,49 +340,145 @@
         </spacer>
        </item>
        <item>
-        <widget class="QToolButton" name="toolButtonAdd" >
-         <property name="text" >
+        <widget class="QToolButton" name="toolButtonAdd">
+         <property name="text">
           <string>Add</string>
          </property>
-         <property name="icon" >
-          <iconset resource="filter.qrc" >:/new/prefix1/icons/add.png</iconset>
+         <property name="icon">
+          <iconset resource="filter.qrc">
+           <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/add.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/add.png</iconset>
          </property>
-         <property name="toolButtonStyle" >
+         <property name="toolButtonStyle">
           <enum>Qt::ToolButtonIconOnly</enum>
          </property>
         </widget>
        </item>
       </layout>
      </item>
-     <item row="0" column="2" >
-      <widget class="QLabel" name="label" >
-       <property name="sizePolicy" >
-        <sizepolicy>
-         <hsizetype>5</hsizetype>
-         <vsizetype>4</vsizetype>
+     <item row="0" column="2">
+      <widget class="QLabel" name="label">
+       <property name="sizePolicy">
+        <sizepolicy hsizetype="Preferred" vsizetype="Maximum">
          <horstretch>0</horstretch>
          <verstretch>0</verstretch>
         </sizepolicy>
        </property>
-       <property name="text" >
-        <string>&lt;big>&lt;b>Available Filters&lt;/b>&lt;/big></string>
+       <property name="text">
+        <string>&lt;big&gt;&lt;b&gt;Available Filters&lt;/b&gt;&lt;/big&gt;</string>
        </property>
-       <property name="textFormat" >
+       <property name="textFormat">
         <enum>Qt::RichText</enum>
        </property>
       </widget>
      </item>
+     <item row="1" column="0" rowspan="3" colspan="2">
+      <widget class="QListWidget" name="listFilterCategory">
+       <property name="sizePolicy">
+        <sizepolicy hsizetype="Fixed" vsizetype="Expanding">
+         <horstretch>0</horstretch>
+         <verstretch>0</verstretch>
+        </sizepolicy>
+       </property>
+       <property name="minimumSize">
+        <size>
+         <width>100</width>
+         <height>340</height>
+        </size>
+       </property>
+       <property name="selectionBehavior">
+        <enum>QAbstractItemView::SelectRows</enum>
+       </property>
+       <property name="iconSize">
+        <size>
+         <width>24</width>
+         <height>24</height>
+        </size>
+       </property>
+       <property name="resizeMode">
+        <enum>QListView::Adjust</enum>
+       </property>
+       <property name="spacing">
+        <number>3</number>
+       </property>
+       <property name="currentRow">
+        <number>-1</number>
+       </property>
+       <item>
+        <property name="text">
+         <string>Transform</string>
+        </property>
+        <property name="icon">
+         <iconset resource="filter.qrc">
+          <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/1.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/1.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text">
+         <string>Interlacing</string>
+        </property>
+        <property name="icon">
+         <iconset resource="filter.qrc">
+          <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/2.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/2.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text">
+         <string>Colors</string>
+        </property>
+        <property name="icon">
+         <iconset resource="filter.qrc">
+          <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/4.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/4.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text">
+         <string>Noise</string>
+        </property>
+        <property name="icon">
+         <iconset>
+          <normaloff>../../../common/ADM_icons/videoFilter/5.png</normaloff>../../../common/ADM_icons/videoFilter/5.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text">
+         <string>Sharpness</string>
+        </property>
+        <property name="icon">
+         <iconset resource="filter.qrc">
+          <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/3.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/3.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text">
+         <string>Subtitles</string>
+        </property>
+        <property name="icon">
+         <iconset resource="filter.qrc">
+          <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/7.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/7.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text">
+         <string>Miscellaneous</string>
+        </property>
+        <property name="icon">
+         <iconset resource="filter.qrc">
+          <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/6.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/6.png</iconset>
+        </property>
+       </item>
+      </widget>
+     </item>
     </layout>
    </item>
    <item>
     <spacer>
-     <property name="orientation" >
+     <property name="orientation">
       <enum>Qt::Vertical</enum>
      </property>
-     <property name="sizeType" >
+     <property name="sizeType">
       <enum>QSizePolicy::Fixed</enum>
      </property>
-     <property name="sizeHint" >
+     <property name="sizeHint" stdset="0">
       <size>
        <width>707</width>
        <height>16</height>
@@ -498,19 +487,19 @@
     </spacer>
    </item>
    <item>
-    <layout class="QHBoxLayout" >
-     <property name="margin" >
-      <number>0</number>
-     </property>
-     <property name="spacing" >
+    <layout class="QHBoxLayout">
+     <property name="spacing">
       <number>6</number>
      </property>
+     <property name="margin">
+      <number>0</number>
+     </property>
      <item>
       <spacer>
-       <property name="orientation" >
+       <property name="orientation">
         <enum>Qt::Horizontal</enum>
        </property>
-       <property name="sizeHint" >
+       <property name="sizeHint" stdset="0">
         <size>
          <width>40</width>
          <height>20</height>
@@ -519,24 +508,26 @@
       </spacer>
      </item>
      <item>
-      <widget class="QPushButton" name="pushButtonPreview" >
-       <property name="text" >
+      <widget class="QPushButton" name="pushButtonPreview">
+       <property name="text">
         <string>&amp;Preview</string>
        </property>
-       <property name="icon" >
-        <iconset resource="filter.qrc" >:/new/prefix1/icons/thumbnail.png</iconset>
+       <property name="icon">
+        <iconset resource="filter.qrc">
+         <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/thumbnail.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/thumbnail.png</iconset>
        </property>
       </widget>
      </item>
      <item>
-      <widget class="QPushButton" name="buttonClose" >
-       <property name="text" >
+      <widget class="QPushButton" name="buttonClose">
+       <property name="text">
         <string>&amp;Close</string>
        </property>
-       <property name="icon" >
-        <iconset resource="filter.qrc" >:/new/prefix1/icons/close.png</iconset>
+       <property name="icon">
+        <iconset resource="filter.qrc">
+         <normaloff>:/new/prefix1/common/ADM_icons/videoFilter/close.png</normaloff>:/new/prefix1/common/ADM_icons/videoFilter/close.png</iconset>
        </property>
-       <property name="default" >
+       <property name="default">
         <bool>true</bool>
        </property>
       </widget>
@@ -566,7 +557,7 @@
   <tabstop>buttonClose</tabstop>
  </tabstops>
  <resources>
-  <include location="filter.qrc" />
+  <include location="filter.qrc"/>
  </resources>
  <connections/>
 </ui>



From mean at mail.berlios.de  Mon Dec 21 14:32:10 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:10 +0100
Subject: [Avidemux-svn-commit] r5696 - in
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons:
	. videoFilter
Message-ID: <200912211332.nBLDWARr028462@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:09 +0100 (Mon, 21 Dec 2009)
New Revision: 5696

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/1.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/2.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/3.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/4.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/5.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/6.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/7.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/add.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/cd.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/close.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/down.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/exec.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/fileopen.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/filesave.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/filesaveas.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/remove.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/thumbnail.png
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/up.png
Log:
[UI] Move video filter icons to the common folder

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/1.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/1.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/1.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,4 @@
+?PNG
+
+
+U?,V???\?????3??J????????'????????dwf^???
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/2.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/2.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/2.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,3 @@
+?PNG
+
+
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/3.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/3.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/3.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,6 @@
+?PNG
+
+
+?T*4\??K???w?;??v?*\??2?B??t?]i4+u?/~&????d??z?^?DD\??r?,?Tj)????k:(???~?d2?D"?`<?8????s?^?m?
+?[LdY?m??????-?ZM????e???o!??
+???n8??n??t(?JN:??????vlY??r9?m[???D"?^,;>;??6?O??:?%???4?????V?;p<#???'`???????u?p???*<z?
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/4.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/4.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/4.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,12 @@
+?PNG
+
+
+*????P????nQ??~?
+p?uO??? ????????<??6??<?????2????e\F?:?@????v+???U???H??(c
+d??[-?W?b?AA???????9/?+~???Z~?????>?????KN.Ew[$?H?r??Dkk?kk{??("?c??O??G/?^????f???3?N?#?????S???Z?_9??{?$
+???Q?o?d?c?bW)l?B???~??8?????W??'~?x?8??d!b*^???a6???;??B??+'/??
+ B?5]?Y?,????Qrk?z!??,DD(??(z?????? r??im???????d?S?????@?J1??m??????????Fw???A,K+?????/S(
+?q?0
+l9?z?Fo????c????g8????K.?@???-~??_?X??:0??<???)<???]???m???!?R??*0T????o?||??w???|??C???0??4?k??&9?~?c?E,'"N??????Io??tw???????m`???Z=p??e?D??????L???C?2v?????Ln?U?RX?E????????6+fu?vm?q?'?R|??:c?w?'???z?v???X[?E?????@kM?k?[A;????}????P??j&???*?'UJ?I3:~???;d??Uas-?R?|?lQJ?K?????]?ud??^??a7?z????f?????I???1?q??8?-?6?3???}??r????%????f>?y???? t???Z???Ul??8
+?,/]?????`??????6?k?j??I~????$:??S??t??y{ik?????a?o???[?J?O?[???|????u`
+8?
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/5.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/5.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/5.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,6 @@
+?PNG
+
+
+fc?l?izM?z/??&^
+??R*"?J???????s?M????}???}?y?s?FLL???3_?????z??6?m	
+????;l6?'?gff???
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/6.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/6.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/6.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,9 @@
+?PNG
+
+
+<u*?????!m%???@l%????K?,?%??-??L???5??}vFg?q???c??f~????????(@
+a?O)??
+ ??mc?H?????`???g??V??
+zvW?'?????x
+???
+9{?>?U?????E????d
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/7.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/7.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/7.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,4 @@
+?PNG
+
+
+o?P
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/add.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/add.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/add.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,3 @@
+?PNG
+
+
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/cd.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/cd.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/cd.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,9 @@
+?PNG
+
+
+b????$?~?2?9?????????w\\|??TOXw????!@
+h?0??{??\9?$II??
+aAnn?#`??SN. ?X^=???????~?f??@/1???????????RJVV?????04?f??ex?
+b(;"^?C??????
+ ?X?|{??;#?<(?@I)???b???F?~%e)?/?a
+-?Q???~1???????kA|?
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/close.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/close.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/close.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,6 @@
+?PNG
+
+
+&&?) }
+? ????3???m???????/?0???0pr??5IJ?0((H??????a???>a??????^00??!?????/?G??]??!1??????ANN??????30,X???0?@
+???????????|??L?;?????????????gggc&A`Tr???AXX??????z?p????_?|,j^?&@
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/down.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/down.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/down.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,4 @@
+?PNG
+
+
+6	&??f?? ??2???G0????f$DB?c,??7?R?A??i???a???DZ??i??M?? 
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/exec.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/exec.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/exec.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,10 @@
+?PNG
+
+
+???????;s????%H%???p????????????S?HR'????6A? ?2??6????/D?????b???????9??6Y?'????}?C:;????/????[?N}???,~[???i3??M????}?2???:#????*??2[?Am????mu ZwQ?5?^?qK?????-&??|??s9? C?p[V???S?(??
+U?cY?pWj?-=??jz????p? H	??w?z*????{??????6?
+H&T?%?s?%???)??J(??)??x?-!??:???
+???????Dd?????????d???1?/?
+????>m??e???/??8????K ?$'?@q?vQ?P
+Wy???
+?^I??I?_M???????[}?`??#]?????s?3v?UqB????:???????n?IC?O6????I0?
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/fileopen.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/fileopen.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/fileopen.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,6 @@
+?PNG
+
+
+??V_Y???t???F?E
+????d????????@'108???:?????7?@??
+
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/filesave.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/filesave.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/filesave.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,5 @@
+?PNG
+
+
+O80????	h????????
+?@??????????_???7778????l(I?????????3??????
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/filesaveas.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/filesaveas.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/filesaveas.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,9 @@
+?PNG
+
+
+??}?
+d???2??]`?l}??AIj?'?x?{?7.?p?z/??7@
+???w3??d??Yh???
+2?z??p??????Oh;+H ?X?~?????N????v????R???20?????K???;??w??I3??u?/??
+??@C?!;++#????"?	qi??l???e8?^??/?????
+??
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/remove.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/remove.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/remove.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,7 @@
+?PNG
+
+
+IDAT8?m?OL?w????????o?2*?i^P?BkRR?E\L??`?7o$?????yp?]?311????q	l?]\?h!??f???F,??Hm?Z????}???y?<??y~????????>]?(J!z?ME??z*????*K??????o0?????v_?v??????O?X??????????????pa&?H???$8???$????X^Y?????
+Q3??N??@k?Z??i8?Y??XlL?(JL???g?????[x? p?????|???{???.E?$|?o[[F.?????t_$???>??&?fy|??<??U,B????(???I>???????=??v^??L&i[[?%
+`dl???iU==>|??H????r??{?({?8??B?f??F??hu????=yBh`??????L?e??_?79I]Qp?*??)??x??p?????hb>{&fC!?C4*???-??????Kb????xT?Q?X2?mnm?????U???>???79??Nde???k?_?b??;???????5M].K?S?6?	??pG8,?????x?
+??,?q?"???Hss?'??u???t7??V?;?(???V??P?????????WI:??'?}$4M=??c^?5?2?^P?Z39?L????/???+?[???
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/thumbnail.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/thumbnail.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/thumbnail.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,7 @@
+?PNG
+
+
+	?
+???[?\t
+????W?j??
+????L??
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/up.png
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/up.png	2009-12-21 13:32:06 UTC (rev 5695)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_icons/videoFilter/up.png	2009-12-21 13:32:09 UTC (rev 5696)
@@ -0,0 +1,4 @@
+?PNG
+
+
+???(8Q?M???
\ No newline at end of file



From mean at mail.berlios.de  Mon Dec 21 14:32:13 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:13 +0100
Subject: [Avidemux-svn-commit] r5697 -
	branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk
Message-ID: <200912211332.nBLDWDMY028491@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:12 +0100 (Mon, 21 Dec 2009)
New Revision: 5697

Added:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/GUI_glade.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/GUI_glade.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/CMakeLists.txt
Log:
[gtk] move GUI_glade.cpp to gtk_toolkit as it will be used later by plugins

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/CMakeLists.txt	2009-12-21 13:32:09 UTC (rev 5696)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/CMakeLists.txt	2009-12-21 13:32:12 UTC (rev 5697)
@@ -2,9 +2,12 @@
 
 SET(${ADM_LIB}_SRCS
 	ADM_tray_gtk.cpp  
-    gtkmarkscale.c jogshuttle.c ADM_jogshuttle.cpp  mediactrl.c
-ADM_icons.cpp
+        gtkmarkscale.c jogshuttle.c ADM_jogshuttle.cpp  mediactrl.c
+        ADM_icons.cpp
+        GUI_glade.cpp
 
 )
 
-ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})
+ADD_DEFINITIONS("-DTARGET_DIR='\"${CMAKE_INSTALL_PREFIX}/lib/ADM_glade/\"' -DSOURCE_DIR='\"${CMAKE_CURRENT_SOURCE_DIR}\"'")
+ADD_LIBRARY(${ADM_LIB} SHARED ${${ADM_LIB}_SRCS})
+ADM_INSTALL_LIB(${ADM_LIB})

Added: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/GUI_glade.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/GUI_glade.cpp	2009-12-21 13:32:09 UTC (rev 5696)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/GUI_glade.cpp	2009-12-21 13:32:12 UTC (rev 5697)
@@ -0,0 +1,84 @@
+/**
+ *      \file GUI_glade.cpp
+ *      \brief simple utility class to deal with glade class
+ */
+#include <stdlib.h>
+#include "GUI_glade.h"
+#define GXML (GtkBuilder *)gxml
+
+admGlade::admGlade()
+{
+    gxml=NULL;
+}
+void admGlade::init(void)
+{
+GtkBuilder *x=NULL;
+    x =gtk_builder_new ();
+    if(!x)
+    {
+        printf("[GtkBuilder] Cannot create a builder\n");
+        exit(-1);
+    }
+    gxml=(void *)x; // Memleak!
+
+}
+
+/**
+ *
+ */
+admGlade::~admGlade()
+{
+
+}
+/**
+        \fn loadFile
+*/
+bool    admGlade::loadFile(const char *file)   
+{
+    if(tryLoad(TARGET_DIR,file)) return true;
+    if(tryLoad(SOURCE_DIR"/../glade",file)) return true;
+    if(tryLoad("glade",file)) return true;
+    return false;
+
+}
+/**
+        \fn tryLoad
+        \brief try loading the file in the dir prefix
+*/
+bool admGlade::tryLoad(const char *prefix, const char *file)
+{
+#define ADM_GLADE_PATH 1024
+char path[ADM_GLADE_PATH];
+GError *er=NULL;
+            GtkBuilder *x;
+            snprintf(path,ADM_GLADE_PATH,"%s/%s",prefix,file);
+            printf("Trying :<%s>\n",path);
+           
+            gtk_builder_add_from_file(GXML,path,&er);
+            if(er)
+            {
+                printf("[GtkBuilder] %s\n",er->message);
+                return false;
+            }
+            return true;
+
+
+}
+/**
+ *  \fn getWidget
+ *
+ */
+GtkWidget *admGlade::getWidget(const char *widgetName)
+{
+        if(!gxml) return NULL;
+        GtkWidget *w= (GtkWidget *)gtk_builder_get_object (GXML, widgetName);
+        if(!w) printf("[admGlade] Cannot locate widget %s\n",widgetName);
+        return w;
+}   
+//EOF
+
+
+
+
+
+

Added: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/GUI_glade.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/GUI_glade.h	2009-12-21 13:32:09 UTC (rev 5696)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_toolkit_gtk/GUI_glade.h	2009-12-21 13:32:12 UTC (rev 5697)
@@ -0,0 +1,32 @@
+/**
+ *      \file GUI_glade.h
+ *      \brief simple utility class to deal with glade class
+ */
+
+#ifndef ADM_GLADE_H
+#define ADM_GLADE_H
+#include <gtk/gtk.h>
+/**
+    \class admGlade
+    \brief simple glade wrapping class
+*/
+class admGlade
+{
+protected:
+        void *gxml;
+        bool tryLoad(const char *prefix, const char *file);
+public:
+                admGlade() ;
+        void    init(void);
+                ~admGlade();
+        bool    loadFile(const char *file);   
+        GtkWidget *getWidget(const char *widgetName);
+
+
+
+};
+
+
+
+#endif
+



From mean at mail.berlios.de  Mon Dec 21 14:32:16 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:16 +0100
Subject: [Avidemux-svn-commit] r5698 -
	branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2
Message-ID: <200912211332.nBLDWGUj028514@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:15 +0100 (Mon, 21 Dec 2009)
New Revision: 5698

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/CMakeLists.txt
Log:
[UI] Move video filter icons to the common folder

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/CMakeLists.txt	2009-12-21 13:32:12 UTC (rev 5697)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/CMakeLists.txt	2009-12-21 13:32:15 UTC (rev 5698)
@@ -1,11 +1,10 @@
 SET(ADM_LIB ADM_gui2Gtk)
 
 SET(${ADM_LIB}_SRCS
-	GUI_bindings.cpp  GUI_gtkRender.cpp  GUI_keymap.cpp  GUI_glade.cpp)
+	GUI_bindings.cpp  GUI_gtkRender.cpp  GUI_keymap.cpp  )
 
 IF (APPLE)
 	SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS} GUI_gtkRenderHelper.m)
 ENDIF (APPLE)
 
 ADD_LIBRARY(${ADM_LIB} STATIC  ${${ADM_LIB}_SRCS})
-ADD_DEFINITIONS("-DTARGET_DIR='\"${CMAKE_INSTALL_PREFIX}/lib/ADM_glade/\"' -DSOURCE_DIR='\"${CMAKE_CURRENT_SOURCE_DIR}\"'")



From mean at mail.berlios.de  Mon Dec 21 14:32:20 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:20 +0100
Subject: [Avidemux-svn-commit] r5699 - in
	branches/avidemux_2.6_branch_mean/avidemux:
	gtk/ADM_userInterfaces/ADM_filters gtk/ADM_userInterfaces/ADM_gui2
	qt4/ADM_userInterfaces/ADM_filters/icons
Message-ID: <200912211332.nBLDWKtU028578@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:18 +0100 (Mon, 21 Dec 2009)
New Revision: 5699

Added:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/videoFilter.gtkBuilder
Removed:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_glade.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_glade.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/1.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/2.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/3.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/4.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/5.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/6.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/7.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/add.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/cd.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/close.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/down.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/exec.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/fileopen.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/filesave.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/filesaveas.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/remove.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/thumbnail.png
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/up.png
Log:
[gtk] Skeleton for gtk video filter manager

Added: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/videoFilter.gtkBuilder
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/videoFilter.gtkBuilder	2009-12-21 13:32:15 UTC (rev 5698)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/videoFilter.gtkBuilder	2009-12-21 13:32:18 UTC (rev 5699)
@@ -0,0 +1,313 @@
+<?xml version="1.0"?>
+<interface>
+  <requires lib="gtk+" version="2.16"/>
+  <!-- interface-naming-policy project-wide -->
+  <object class="GtkTreeModelFilter" id="treemodelfilter1"/>
+  <object class="GtkListStore" id="liststore1"/>
+  <object class="GtkListStore" id="liststore2"/>
+  <object class="GtkListStore" id="liststore3"/>
+  <object class="GtkListStore" id="liststore4"/>
+  <object class="GtkListStore" id="liststore5"/>
+  <object class="GtkDialog" id="dialog1">
+    <property name="border_width">5</property>
+    <property name="type_hint">normal</property>
+    <property name="has_separator">False</property>
+    <child internal-child="vbox">
+      <object class="GtkVBox" id="dialog-vbox1">
+        <property name="visible">True</property>
+        <property name="orientation">vertical</property>
+        <property name="spacing">2</property>
+        <child>
+          <object class="GtkHBox" id="hbox1">
+            <property name="visible">True</property>
+            <property name="homogeneous">True</property>
+            <child>
+              <object class="GtkFrame" id="frame1">
+                <property name="visible">True</property>
+                <property name="label_xalign">0</property>
+                <property name="shadow_type">none</property>
+                <child>
+                  <object class="GtkAlignment" id="alignment1">
+                    <property name="visible">True</property>
+                    <property name="left_padding">12</property>
+                    <child>
+                      <object class="GtkVBox" id="vbox2">
+                        <property name="visible">True</property>
+                        <property name="orientation">vertical</property>
+                        <child>
+                          <object class="GtkHBox" id="hbox2">
+                            <property name="visible">True</property>
+                            <child>
+                              <object class="GtkNotebook" id="notebookCategory">
+                                <property name="visible">True</property>
+                                <property name="can_focus">True</property>
+                                <property name="tab_pos">left</property>
+                                <property name="tab_border">4</property>
+                                <child>
+                                  <object class="GtkTreeView" id="treeviewAvailable">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="model">liststore5</property>
+                                  </object>
+                                </child>
+                                <child type="tab">
+                                  <object class="GtkLabel" id="Transform">
+                                    <property name="visible">True</property>
+                                    <property name="label" translatable="yes">Transform</property>
+                                    <property name="ellipsize">end</property>
+                                  </object>
+                                  <packing>
+                                    <property name="tab_fill">False</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <placeholder/>
+                                </child>
+                                <child type="tab">
+                                  <object class="GtkLabel" id="label4">
+                                    <property name="visible">True</property>
+                                    <property name="yalign">0.44999998807907104</property>
+                                    <property name="label" translatable="yes">Interlacing</property>
+                                  </object>
+                                  <packing>
+                                    <property name="position">1</property>
+                                    <property name="tab_fill">False</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <placeholder/>
+                                </child>
+                                <child type="tab">
+                                  <object class="GtkLabel" id="label5">
+                                    <property name="visible">True</property>
+                                    <property name="label" translatable="yes">Colors</property>
+                                  </object>
+                                  <packing>
+                                    <property name="position">2</property>
+                                    <property name="tab_fill">False</property>
+                                  </packing>
+                                </child>
+                              </object>
+                              <packing>
+                                <property name="position">0</property>
+                              </packing>
+                            </child>
+                          </object>
+                          <packing>
+                            <property name="position">0</property>
+                          </packing>
+                        </child>
+                        <child>
+                          <object class="GtkHButtonBox" id="hbuttonbox2">
+                            <property name="visible">True</property>
+                            <property name="layout_style">end</property>
+                            <child>
+                              <object class="GtkButton" id="buttonAdd">
+                                <property name="label">gtk-add</property>
+                                <property name="visible">True</property>
+                                <property name="can_focus">True</property>
+                                <property name="receives_default">True</property>
+                                <property name="related_action">action2</property>
+                                <property name="use_stock">True</property>
+                              </object>
+                              <packing>
+                                <property name="expand">False</property>
+                                <property name="fill">False</property>
+                                <property name="position">0</property>
+                              </packing>
+                            </child>
+                          </object>
+                          <packing>
+                            <property name="expand">False</property>
+                            <property name="fill">False</property>
+                            <property name="pack_type">end</property>
+                            <property name="position">1</property>
+                          </packing>
+                        </child>
+                      </object>
+                    </child>
+                  </object>
+                </child>
+                <child type="label">
+                  <object class="GtkLabel" id="label1">
+                    <property name="visible">True</property>
+                    <property name="label" translatable="yes">&lt;b&gt;Available filters&lt;/b&gt;</property>
+                    <property name="use_markup">True</property>
+                  </object>
+                </child>
+              </object>
+              <packing>
+                <property name="position">0</property>
+              </packing>
+            </child>
+            <child>
+              <object class="GtkFrame" id="frame2">
+                <property name="visible">True</property>
+                <property name="label_xalign">0</property>
+                <property name="shadow_type">none</property>
+                <child>
+                  <object class="GtkAlignment" id="alignment2">
+                    <property name="visible">True</property>
+                    <property name="left_padding">12</property>
+                    <child>
+                      <object class="GtkVBox" id="vbox1">
+                        <property name="visible">True</property>
+                        <property name="orientation">vertical</property>
+                        <child>
+                          <object class="GtkTreeView" id="treeviewActiveFilter">
+                            <property name="visible">True</property>
+                            <property name="can_focus">True</property>
+                            <property name="model">liststore4</property>
+                          </object>
+                          <packing>
+                            <property name="position">0</property>
+                          </packing>
+                        </child>
+                        <child>
+                          <object class="GtkHButtonBox" id="hbuttonbox1">
+                            <property name="visible">True</property>
+                            <property name="layout_style">end</property>
+                            <child>
+                              <object class="GtkButton" id="buttonConfigure">
+                                <property name="label" translatable="yes">Configure</property>
+                                <property name="visible">True</property>
+                                <property name="can_focus">True</property>
+                                <property name="receives_default">True</property>
+                                <property name="related_action">action3</property>
+                                <property name="yalign">0.43999999761581421</property>
+                              </object>
+                              <packing>
+                                <property name="expand">False</property>
+                                <property name="fill">False</property>
+                                <property name="position">0</property>
+                              </packing>
+                            </child>
+                            <child>
+                              <object class="GtkButton" id="buttonUp">
+                                <property name="label">gtk-go-up</property>
+                                <property name="visible">True</property>
+                                <property name="can_focus">True</property>
+                                <property name="receives_default">True</property>
+                                <property name="related_action">action4</property>
+                                <property name="use_stock">True</property>
+                              </object>
+                              <packing>
+                                <property name="expand">False</property>
+                                <property name="fill">False</property>
+                                <property name="position">1</property>
+                              </packing>
+                            </child>
+                            <child>
+                              <object class="GtkButton" id="buttonDown">
+                                <property name="label">gtk-go-down</property>
+                                <property name="visible">True</property>
+                                <property name="can_focus">True</property>
+                                <property name="receives_default">True</property>
+                                <property name="related_action">action5</property>
+                                <property name="use_stock">True</property>
+                              </object>
+                              <packing>
+                                <property name="expand">False</property>
+                                <property name="fill">False</property>
+                                <property name="position">2</property>
+                              </packing>
+                            </child>
+                            <child>
+                              <object class="GtkButton" id="buttonRemove">
+                                <property name="label">gtk-remove</property>
+                                <property name="visible">True</property>
+                                <property name="can_focus">True</property>
+                                <property name="receives_default">True</property>
+                                <property name="related_action">action6</property>
+                                <property name="use_stock">True</property>
+                              </object>
+                              <packing>
+                                <property name="expand">False</property>
+                                <property name="fill">False</property>
+                                <property name="position">3</property>
+                              </packing>
+                            </child>
+                          </object>
+                          <packing>
+                            <property name="expand">False</property>
+                            <property name="fill">False</property>
+                            <property name="pack_type">end</property>
+                            <property name="position">1</property>
+                          </packing>
+                        </child>
+                      </object>
+                    </child>
+                  </object>
+                </child>
+                <child type="label">
+                  <object class="GtkLabel" id="label2">
+                    <property name="visible">True</property>
+                    <property name="yalign">0.4699999988079071</property>
+                    <property name="label" translatable="yes">&lt;b&gt;Active filters&lt;/b&gt;</property>
+                    <property name="use_markup">True</property>
+                  </object>
+                </child>
+              </object>
+              <packing>
+                <property name="position">1</property>
+              </packing>
+            </child>
+          </object>
+          <packing>
+            <property name="position">1</property>
+          </packing>
+        </child>
+        <child internal-child="action_area">
+          <object class="GtkHButtonBox" id="dialog-action_area1">
+            <property name="visible">True</property>
+            <property name="layout_style">end</property>
+            <child>
+              <object class="GtkButton" id="buttonCancel">
+                <property name="label">gtk-cancel</property>
+                <property name="visible">True</property>
+                <property name="can_focus">True</property>
+                <property name="receives_default">True</property>
+                <property name="use_stock">True</property>
+              </object>
+              <packing>
+                <property name="expand">False</property>
+                <property name="fill">False</property>
+                <property name="position">0</property>
+              </packing>
+            </child>
+            <child>
+              <object class="GtkButton" id="buttonOk">
+                <property name="label">gtk-ok</property>
+                <property name="visible">True</property>
+                <property name="can_focus">True</property>
+                <property name="receives_default">True</property>
+                <property name="related_action">action1</property>
+                <property name="use_stock">True</property>
+              </object>
+              <packing>
+                <property name="expand">False</property>
+                <property name="fill">False</property>
+                <property name="position">1</property>
+              </packing>
+            </child>
+          </object>
+          <packing>
+            <property name="expand">False</property>
+            <property name="pack_type">end</property>
+            <property name="position">0</property>
+          </packing>
+        </child>
+      </object>
+    </child>
+    <action-widgets>
+      <action-widget response="0">buttonCancel</action-widget>
+      <action-widget response="0">buttonOk</action-widget>
+    </action-widgets>
+  </object>
+  <object class="GtkAction" id="action1"/>
+  <object class="GtkAction" id="action2"/>
+  <object class="GtkAction" id="action3"/>
+  <object class="GtkAction" id="action4"/>
+  <object class="GtkAction" id="action5"/>
+  <object class="GtkAction" id="action6"/>
+</interface>

Deleted: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_glade.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_glade.cpp	2009-12-21 13:32:15 UTC (rev 5698)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_glade.cpp	2009-12-21 13:32:18 UTC (rev 5699)
@@ -1,84 +0,0 @@
-/**
- *      \file GUI_glade.cpp
- *      \brief simple utility class to deal with glade class
- */
-#include <stdlib.h>
-#include "GUI_glade.h"
-#define GXML (GtkBuilder *)gxml
-
-admGlade::admGlade()
-{
-    gxml=NULL;
-}
-void admGlade::init(void)
-{
-GtkBuilder *x=NULL;
-    x =gtk_builder_new ();
-    if(!x)
-    {
-        printf("[GtkBuilder] Cannot create a builder\n");
-        exit(-1);
-    }
-    gxml=(void *)x; // Memleak!
-
-}
-
-/**
- *
- */
-admGlade::~admGlade()
-{
-
-}
-/**
-        \fn loadFile
-*/
-bool    admGlade::loadFile(const char *file)   
-{
-    if(tryLoad(TARGET_DIR,file)) return true;
-    if(tryLoad(SOURCE_DIR"/../glade",file)) return true;
-    if(tryLoad("glade",file)) return true;
-    return false;
-
-}
-/**
-        \fn tryLoad
-        \brief try loading the file in the dir prefix
-*/
-bool admGlade::tryLoad(const char *prefix, const char *file)
-{
-#define ADM_GLADE_PATH 1024
-char path[ADM_GLADE_PATH];
-GError *er=NULL;
-            GtkBuilder *x;
-            snprintf(path,ADM_GLADE_PATH,"%s/%s",prefix,file);
-            printf("Trying :<%s>\n",path);
-           
-            gtk_builder_add_from_file(GXML,path,&er);
-            if(er)
-            {
-                printf("[GtkBuilder] %s\n",er->message);
-                return false;
-            }
-            return true;
-
-
-}
-/**
- *  \fn getWidget
- *
- */
-GtkWidget *admGlade::getWidget(const char *widgetName)
-{
-        if(!gxml) return NULL;
-        GtkWidget *w= (GtkWidget *)gtk_builder_get_object (GXML, widgetName);
-        if(!w) printf("[admGlade] Cannot locate widget %s\n",widgetName);
-        return w;
-}   
-//EOF
-
-
-
-
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_glade.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_glade.h	2009-12-21 13:32:15 UTC (rev 5698)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_glade.h	2009-12-21 13:32:18 UTC (rev 5699)
@@ -1,32 +0,0 @@
-/**
- *      \file GUI_glade.h
- *      \brief simple utility class to deal with glade class
- */
-
-#ifndef ADM_GLADE_H
-#define ADM_GLADE_H
-#include <gtk/gtk.h>
-/**
-    \class admGlade
-    \brief simple glade wrapping class
-*/
-class admGlade
-{
-protected:
-        void *gxml;
-        bool tryLoad(const char *prefix, const char *file);
-public:
-                admGlade() ;
-        void    init(void);
-                ~admGlade();
-        bool    loadFile(const char *file);   
-        GtkWidget *getWidget(const char *widgetName);
-
-
-
-};
-
-
-
-#endif
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/1.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/2.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/3.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/4.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/5.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/6.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/7.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/add.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/cd.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/close.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/down.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/exec.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/fileopen.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/filesave.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/filesaveas.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/remove.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/thumbnail.png
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/icons/up.png
===================================================================
(Binary files differ)



From mean at mail.berlios.de  Mon Dec 21 14:32:22 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:22 +0100
Subject: [Avidemux-svn-commit] r5700 -
	branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters
Message-ID: <200912211332.nBLDWMcg028600@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:21 +0100 (Mon, 21 Dec 2009)
New Revision: 5700

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/gui_filtermanager.cpp
Log:
[gtk] Skeleton for gtk video filter manager

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/CMakeLists.txt	2009-12-21 13:32:18 UTC (rev 5699)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/CMakeLists.txt	2009-12-21 13:32:21 UTC (rev 5700)
@@ -4,3 +4,5 @@
 	gui_filtermanager.cpp  gui_filtermanager_dialog.cpp)
 
 ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})
+FILE(GLOB ADM_filterIcons ${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/common/ADM_icons/videoFilter/*.png)
+INSTALL(FILES videoFilter.gtkBuilder ${ADM_filterIcons} DESTINATION "${CMAKE_INSTALL_PREFIX}/lib/ADM_glade/videoFilter")

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/gui_filtermanager.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/gui_filtermanager.cpp	2009-12-21 13:32:18 UTC (rev 5699)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/gui_filtermanager.cpp	2009-12-21 13:32:21 UTC (rev 5700)
@@ -16,7 +16,69 @@
 #include "DIA_fileSel.h"
 #include "ADM_editor/ADM_edit.hxx"
 #include "avi_vars.h"
-//#include "ADM_filter/vidVCD.h"
+#include "GUI_glade.h"
+
+static admGlade glade;
+#define WOD(x) glade.getWidget (#x)
+typedef enum
+{
+    actionUp=20,
+    actionDown,
+    actionAdd,
+    actionRemove,
+    actionConfigure
+}vFilterAction;
+/**
+    \fn GUI_handleVFilter
+*/
+int GUI_handleVFilter (void)
+{
+     ADM_info("Entering video filter\n");
+     glade.init();
+     if(!glade.loadFile("videoFilter/videoFilter.gtkBuilder"))
+     {
+            GUI_Error_HIG("Glade","Cannot load glade file");
+            return 0;
+    }
+    // create top window
+    GtkWidget *dialog=glade.getWidget("dialog1");
+    gtk_register_dialog(dialog);
+	#define ASSOCIATE(x,y)   gtk_dialog_add_action_widget (GTK_DIALOG (dialog), WOD(x),y)
+	    
+	    ASSOCIATE(buttonAdd,          actionAdd);
+	    ASSOCIATE(buttonConfigure,    actionConfigure);
+	    ASSOCIATE(buttonUp,           actionUp);
+	    ASSOCIATE(buttonDown,         actionDown);
+	    ASSOCIATE(buttonRemove,       actionRemove);
+	    
+	   
+	gtk_widget_show(dialog);
+    
+    bool ext=false;
+
+    while(false==ext)
+    {
+        gint action=gtk_dialog_run(GTK_DIALOG(dialog));
+        printf("Action:%d\n",action);
+        switch(action)
+        {
+            case actionAdd:
+            case actionUp:
+            case actionDown:
+            case actionRemove:
+            case actionConfigure:
+                    break;
+            default:
+                ext=true;
+
+        }
+    };
+    gtk_widget_destroy(dialog);
+    return 0;
+}
+
+
+#if 0
 //___________________________________________
 typedef enum 
 {
@@ -622,4 +684,4 @@
 
 }
 
-
+#endif



From mean at mail.berlios.de  Mon Dec 21 14:32:25 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:25 +0100
Subject: [Avidemux-svn-commit] r5701 -
	branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces
Message-ID: <200912211332.nBLDWPlQ028621@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:24 +0100 (Mon, 21 Dec 2009)
New Revision: 5701

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/CMakeLists.txt
Log:
[gtk] Add toolkit to include directories

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/CMakeLists.txt	2009-12-21 13:32:21 UTC (rev 5700)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/CMakeLists.txt	2009-12-21 13:32:24 UTC (rev 5701)
@@ -2,7 +2,7 @@
 
 SET(ADM_LIB ADM_UI_GTK)
 SET(${ADM_LIB}_SRCS ui_support.cpp)
-
+include_directories(ADM_toolkit_gtk)
 ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})
 ADD_DEFINITIONS(${GTK_CFLAGS})
 



From mean at mail.berlios.de  Mon Dec 21 14:32:28 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:28 +0100
Subject: [Avidemux-svn-commit] r5702 -
	branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2
Message-ID: <200912211332.nBLDWShm028641@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:27 +0100 (Mon, 21 Dec 2009)
New Revision: 5702

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
Log:
[Gtk] Catch the window destroyed event

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2009-12-21 13:32:24 UTC (rev 5701)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2009-12-21 13:32:27 UTC (rev 5702)
@@ -424,8 +424,8 @@
 			     "guiRootWindow",
 			     guiRootWindow,
 			     (GtkDestroyNotify) destroyCallback);
+    gtk_signal_connect(GTK_OBJECT(guiRootWindow), "delete-event", GTK_SIGNAL_FUNC(destroyCallback), (void *) NULL);
 
-
 //	now add callbacks
 	 gtk_widget_add_events(guiRootWindow, GDK_BUTTON_PRESS_MASK);
 	 gtk_signal_connect(GTK_OBJECT(guiRootWindow), "button_press_event", GTK_SIGNAL_FUNC(UI_returnFocus), NULL);
@@ -843,6 +843,7 @@
 gboolean destroyCallback(GtkWidget * widget,
 				  GdkEvent * event, gpointer user_data)
 {
+    ADM_info("Destroy callback for main window\n");
     UNUSED_ARG(widget);
     UNUSED_ARG(event);
     UNUSED_ARG(user_data);



From mean at mail.berlios.de  Mon Dec 21 14:32:30 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:30 +0100
Subject: [Avidemux-svn-commit] r5703 -
	branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters
Message-ID: <200912211332.nBLDWUSe028674@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:29 +0100 (Mon, 21 Dec 2009)
New Revision: 5703

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/videoFilter.gtkBuilder
Log:
[Gtk/VideoFilter] Put a name to the window + original height of 600

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/videoFilter.gtkBuilder
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/videoFilter.gtkBuilder	2009-12-21 13:32:27 UTC (rev 5702)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/videoFilter.gtkBuilder	2009-12-21 13:32:29 UTC (rev 5703)
@@ -10,6 +10,9 @@
   <object class="GtkListStore" id="liststore5"/>
   <object class="GtkDialog" id="dialog1">
     <property name="border_width">5</property>
+    <property name="title" translatable="yes">Video Filters</property>
+    <property name="modal">True</property>
+    <property name="default_height">600</property>
     <property name="type_hint">normal</property>
     <property name="has_separator">False</property>
     <child internal-child="vbox">



From mean at mail.berlios.de  Mon Dec 21 14:32:32 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:32 +0100
Subject: [Avidemux-svn-commit] r5704 -
	branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters
Message-ID: <200912211332.nBLDWWNV028701@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:32 +0100 (Mon, 21 Dec 2009)
New Revision: 5704

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/videoFilter.gtkBuilder
Log:
[gtk] Complete categories for video filter

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/videoFilter.gtkBuilder
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/videoFilter.gtkBuilder	2009-12-21 13:32:29 UTC (rev 5703)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_filters/videoFilter.gtkBuilder	2009-12-21 13:32:32 UTC (rev 5704)
@@ -54,10 +54,26 @@
                                   </object>
                                 </child>
                                 <child type="tab">
-                                  <object class="GtkLabel" id="Transform">
+                                  <object class="GtkHBox" id="hbox3">
                                     <property name="visible">True</property>
-                                    <property name="label" translatable="yes">Transform</property>
-                                    <property name="ellipsize">end</property>
+                                    <child>
+                                      <object class="GtkImage" id="image1">
+                                        <property name="visible">True</property>
+                                        <property name="pixbuf">1.png</property>
+                                      </object>
+                                      <packing>
+                                        <property name="position">0</property>
+                                      </packing>
+                                    </child>
+                                    <child>
+                                      <object class="GtkLabel" id="label8">
+                                        <property name="visible">True</property>
+                                        <property name="label" translatable="yes">Transform</property>
+                                      </object>
+                                      <packing>
+                                        <property name="position">1</property>
+                                      </packing>
+                                    </child>
                                   </object>
                                   <packing>
                                     <property name="tab_fill">False</property>
@@ -90,6 +106,45 @@
                                     <property name="tab_fill">False</property>
                                   </packing>
                                 </child>
+                                <child>
+                                  <placeholder/>
+                                </child>
+                                <child type="tab">
+                                  <object class="GtkLabel" id="label3">
+                                    <property name="visible">True</property>
+                                    <property name="label" translatable="yes">Noise</property>
+                                  </object>
+                                  <packing>
+                                    <property name="position">3</property>
+                                    <property name="tab_fill">False</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <placeholder/>
+                                </child>
+                                <child type="tab">
+                                  <object class="GtkLabel" id="label6">
+                                    <property name="visible">True</property>
+                                    <property name="label" translatable="yes">Sharpness</property>
+                                  </object>
+                                  <packing>
+                                    <property name="position">4</property>
+                                    <property name="tab_fill">False</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <placeholder/>
+                                </child>
+                                <child type="tab">
+                                  <object class="GtkLabel" id="label7">
+                                    <property name="visible">True</property>
+                                    <property name="label" translatable="yes">Misc</property>
+                                  </object>
+                                  <packing>
+                                    <property name="position">5</property>
+                                    <property name="tab_fill">False</property>
+                                  </packing>
+                                </child>
                               </object>
                               <packing>
                                 <property name="position">0</property>
@@ -193,6 +248,8 @@
                                 <property name="receives_default">True</property>
                                 <property name="related_action">action4</property>
                                 <property name="use_stock">True</property>
+                                <property name="xalign">0.46000000834465027</property>
+                                <property name="yalign">0.54000002145767212</property>
                               </object>
                               <packing>
                                 <property name="expand">False</property>



From mean at mail.berlios.de  Mon Dec 21 14:32:36 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:36 +0100
Subject: [Avidemux-svn-commit] r5705 - in branches/avidemux_2.6_branch_mean:
	avidemux/qt4 avidemux/qt4/ADM_UIs/src
	avidemux/qt4/ADM_userInterfaces cmake
Message-ID: <200912211332.nBLDWaJG028731@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:35 +0100 (Mon, 21 Dec 2009)
New Revision: 5705

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/cmake/vf_plugin_qt4.cmake
Log:
[Qt4] Rename ADM_UIQT4 to ADM_UIQT46 to avoid clash with 2.5

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt	2009-12-21 13:32:32 UTC (rev 5704)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt	2009-12-21 13:32:35 UTC (rev 5705)
@@ -1,4 +1,4 @@
-SET(ADM_LIB ADM_UIQT4)
+SET(ADM_LIB ADM_UIQT46)
 
 QT4_WRAP_CPP(${ADM_LIB}_source
 	T_bitrate.h  T_button.h  T_dialogFactory.h  T_filesel.h  T_menu.h  T_slider.h

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/CMakeLists.txt	2009-12-21 13:32:32 UTC (rev 5704)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/CMakeLists.txt	2009-12-21 13:32:35 UTC (rev 5705)
@@ -1,4 +1,4 @@
-SET(ADM_LIB ADM_UI_QT4)
+SET(ADM_LIB ADM_UI_QT46)
 SET(${ADM_LIB}_SRCS ui_support.cpp)
 ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2009-12-21 13:32:32 UTC (rev 5704)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2009-12-21 13:32:35 UTC (rev 5705)
@@ -76,14 +76,14 @@
 #############################################
 # Add qt specific libs
 #############################################
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UIQT4)
+TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UIQT46)
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_dialogQt4)
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_guiQt4)
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_filtersQt4)
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_internalVideoFilter6)
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UIQT4)
+TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UIQT46)
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_guiQt4)
-TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UI_QT4)
+TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_UI_QT46)
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_shellQt4)
 TARGET_LINK_LIBRARIES(avidemux3_qt4 ADM_toolkit6)
 ###########################################

Modified: branches/avidemux_2.6_branch_mean/cmake/vf_plugin_qt4.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/vf_plugin_qt4.cmake	2009-12-21 13:32:32 UTC (rev 5704)
+++ branches/avidemux_2.6_branch_mean/cmake/vf_plugin_qt4.cmake	2009-12-21 13:32:35 UTC (rev 5705)
@@ -7,7 +7,7 @@
 
 		ADD_LIBRARY(${lib} SHARED ${ARGN} ${_srcsQt} ${qt4_cpp} ${qt4_ui})
 		ADD_TARGET_CFLAGS(${lib} "-DADM_UI_TYPE_BUILD=4")
-		TARGET_LINK_LIBRARIES( ${lib} ADM_UIQT4  ADM_render6_qt4)
+		TARGET_LINK_LIBRARIES( ${lib} ADM_UIQT46  ADM_render6_qt4)
 		TARGET_LINK_LIBRARIES(${lib} ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY})
 		INIT_VIDEO_FILTER_INTERNAL(${lib})
 		INSTALL_VIDEO_FILTER_INTERNAL(${lib})



From mean at mail.berlios.de  Mon Dec 21 14:32:39 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 14:32:39 +0100
Subject: [Avidemux-svn-commit] r5706 - in branches/avidemux_2.6_branch_mean:
	avidemux_core/ADM_coreVideoFilter/src
	avidemux_plugins/ADM_videoFilters6/crop
Message-ID: <200912211332.nBLDWdes028762@sheep.berlios.de>

Author: mean
Date: 2009-12-21 14:32:38 +0100 (Mon, 21 Dec 2009)
New Revision: 5706

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/ADM_vidCrop.cpp
Log:
[flyDialog] First example of flyDialog filter : crop

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp	2009-12-21 13:32:35 UTC (rev 5705)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp	2009-12-21 13:32:38 UTC (rev 5706)
@@ -148,12 +148,12 @@
 
     if (++_zoomChangeCount > 3 || new_zoomH < 30 || new_zoomW < 30)
     {
-        printf ("Resisting zoom size change from %dx%d (zoom %.5f) to %dx%d (zoom %.5f)\n",
+        ADM_info ("Resisting zoom size change from %dx%d (zoom %.5f) to %dx%d (zoom %.5f)\n",
                 _zoomW, _zoomH, _zoom, new_zoomW, new_zoomH, new_zoom);
         return;
     }
 
-    printf ("Fixing zoom size from %dx%d (zoom %.5f) to correct %dx%d (zoom %.5f)\n",
+    ADM_info ("Fixing zoom size from %dx%d (zoom %.5f) to correct %dx%d (zoom %.5f)\n",
             _zoomW, _zoomH, _zoom, new_zoomW, new_zoomH, new_zoom);
 
     _resizeMethod = new_resizeMethod;
@@ -227,11 +227,15 @@
     ADM_assert(_rgbBufferOut);
     ADM_assert(_in);
 
-#warning    DISABLED
 
-    //if(!_in->getFrameNumberNoAlloc(fn,&len,_yuvBuffer,&flags))
+    double time;
+    time=fn;
+    time/=ADM_FLY_SLIDER_MAX;
+    time*=_in->getInfo()->totalDuration;
+    _in->goToTime(time);
+    if(!_in->getNextFrame(_yuvBuffer))
     {
-      printf("[FlyDialog] Cannot get frame %u\n",fn); 
+      ADM_warning("[FlyDialog] Cannot get frame %u\n",fn); 
       return 0;
     }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/ADM_vidCrop.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/ADM_vidCrop.cpp	2009-12-21 13:32:35 UTC (rev 5705)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/crop/ADM_vidCrop.cpp	2009-12-21 13:32:38 UTC (rev 5706)
@@ -170,24 +170,22 @@
 /**
     \fn Configure
 */
-//extern int DIA_getCropParams(const char *name, CROP_PARAMS *param, AVDMGenericVideoStream *in);
+extern int DIA_getCropParams(	const char *name,crop *param,ADM_coreVideoFilter *in);
+
 bool CropFilter::configure(void)
 
 {
-#if 0
 		uint8_t r;
 		uint32_t w,h;
-    	if(r = (DIA_getCropParams("Crop Settings",_param,instream )))
+    	if(r = (DIA_getCropParams("Crop Settings",&configuration,previousFilter )))
     	{
-			w=_param->left+_param->right;
-			h=_param->top+_param->bottom;
-			ADM_assert(w<instream->getInfo()->width);
-			ADM_assert(h<instream->getInfo()->height);
-			_info.width=instream->getInfo()->width-w;
-			_info.height=instream->getInfo()->height-h;
+			w=configuration.left+configuration.right;
+			h=configuration.top+configuration.bottom;
+			ADM_assert(w<previousFilter->getInfo()->width);
+			ADM_assert(h<previousFilter->getInfo()->height);
+			info.width=previousFilter->getInfo()->width-w;
+			info.height=previousFilter->getInfo()->height-h;
 		}
 		return r;
-#endif
-    return false;
 }
 // EOF



From mean at mail.berlios.de  Mon Dec 21 17:08:34 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 17:08:34 +0100
Subject: [Avidemux-svn-commit] r5707 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src
Message-ID: <200912211608.nBLG8YMW009166@sheep.berlios.de>

Author: mean
Date: 2009-12-21 17:08:34 +0100 (Mon, 21 Dec 2009)
New Revision: 5707

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilterBridge.cpp
Log:
[Editor] Bridge will use the video duration if no value are provided

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilterBridge.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilterBridge.cpp	2009-12-21 13:32:38 UTC (rev 5706)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilterBridge.cpp	2009-12-21 16:08:34 UTC (rev 5707)
@@ -28,6 +28,11 @@
 {
     printf("[VideoFilterBridge] Creating bridge from %"LU" s to %"LU" s\n",(uint32_t)(startTime/1000000LL),(uint32_t)(endTime/1000000LL));
     this->startTime=startTime;
+    if(endTime==-1LL)
+    {
+        uint64_t total=video_body->getVideoDuration();
+        endTime=total-startTime+1;
+    }
     this->endTime=endTime;
     
     aviInfo fo;
@@ -114,7 +119,16 @@
 */
 bool         ADM_videoFilterBridge::goToTime(uint64_t usSeek)
 {
-    video_body->goToTimeVideo(startTime+usSeek);
+    if(!usSeek)
+        video_body->goToTimeVideo(startTime+usSeek);
+    else
+    {
+        uint64_t seek=usSeek;
+        if(true==video_body->getPKFramePTS(&seek))
+        {
+                video_body->goToIntraTimeVideo(seek);
+        }else ADM_warning("Cannot find previous keyframe\n");
+    }
     firstImage=true;
     lastSentImage=0;
     return true;



From mean at mail.berlios.de  Mon Dec 21 17:08:36 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 17:08:36 +0100
Subject: [Avidemux-svn-commit] r5708 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src
Message-ID: <200912211608.nBLG8aZa009182@sheep.berlios.de>

Author: mean
Date: 2009-12-21 17:08:36 +0100 (Mon, 21 Dec 2009)
New Revision: 5708

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilters.cpp
Log:
[Editor] Bridge will use the video duration if no value are provided

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilters.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilters.cpp	2009-12-21 16:08:34 UTC (rev 5707)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilters.cpp	2009-12-21 16:08:36 UTC (rev 5708)
@@ -57,7 +57,9 @@
    if(!ADM_vf_getSize())
     {
         if(!bridge)
-            bridge=new ADM_videoFilterBridge(0,2*3600*1000*1000LL);
+        {
+            bridge=new ADM_videoFilterBridge(0,-1LL);
+        }
         last=bridge;
     }
     else    
@@ -256,4 +258,4 @@
 
         return true;
 }
-// EOF
\ No newline at end of file
+// EOF



From mean at mail.berlios.de  Mon Dec 21 17:08:37 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 17:08:37 +0100
Subject: [Avidemux-svn-commit] r5709 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src
Message-ID: <200912211608.nBLG8bcn009192@sheep.berlios.de>

Author: mean
Date: 2009-12-21 17:08:37 +0100 (Mon, 21 Dec 2009)
New Revision: 5709

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp
Log:
[core] Fix fnctl.h include

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp	2009-12-21 16:08:36 UTC (rev 5708)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp	2009-12-21 16:08:37 UTC (rev 5709)
@@ -19,19 +19,19 @@
 #include <dirent.h>
 #include <errno.h>
 #include <sys/stat.h>
-#include <unistd.h>
-#ifndef __WIN32
-#include <fcntl.h>
+#include <unistd.h>
+
+#if defined(__APPLE__)
+ #include <Carbon/Carbon.h>
+#else
+ #include <fcntl.h>
+ #ifdef __WIN32
+  #include <direct.h>
+  #include <shlobj.h>
+ #endif
 #endif
-#ifdef __WIN32
-#include <direct.h>
-#include <shlobj.h>
-#elif defined(__APPLE__)
-#include <Carbon/Carbon.h>
-#endif
 
 #include "ADM_default.h"
-//#include "DIA_fileSel.h"
 
 
 #ifdef __WIN32



From mean at mail.berlios.de  Mon Dec 21 19:33:15 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 19:33:15 +0100
Subject: [Avidemux-svn-commit] r5710 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters
Message-ID: <200912211833.nBLIXFaq009107@sheep.berlios.de>

Author: mean
Date: 2009-12-21 19:33:13 +0100 (Mon, 21 Dec 2009)
New Revision: 5710

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/filter.qrc
Log:
[qt4] Fix path for filtermanager icons

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/filter.qrc
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/filter.qrc	2009-12-21 16:08:37 UTC (rev 5709)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_filters/filter.qrc	2009-12-21 18:33:13 UTC (rev 5710)
@@ -1,16 +1,16 @@
 <RCC>
   <qresource prefix="/new/prefix1" >
     <file>../../../common/ADM_icons/videoFilter/up.png</file>
-    <file>../../common/ADM_icons/videoFilter/add.png</file>
-    <file>../../common/ADM_icons/videoFilter/cd.png</file>
-    <file>../../common/ADM_icons/videoFilter/close.png</file>
-    <file>../../common/ADM_icons/videoFilter/down.png</file>
-    <file>../../common/ADM_icons/videoFilter/exec.png</file>
-    <file>../../common/ADM_icons/videoFilter/fileopen.png</file>
-    <file>../../common/ADM_icons/videoFilter/filesave.png</file>
-    <file>../../common/ADM_icons/videoFilter/filesaveas.png</file>
-    <file>../../common/ADM_icons/videoFilter/remove.png</file>
-    <file>../../common/ADM_icons/videoFilter/thumbnail.png</file>
+    <file>../../../common/ADM_icons/videoFilter/add.png</file>
+    <file>../../../common/ADM_icons/videoFilter/cd.png</file>
+    <file>../../../common/ADM_icons/videoFilter/close.png</file>
+    <file>../../../common/ADM_icons/videoFilter/down.png</file>
+    <file>../../../common/ADM_icons/videoFilter/exec.png</file>
+    <file>../../../common/ADM_icons/videoFilter/fileopen.png</file>
+    <file>../../../common/ADM_icons/videoFilter/filesave.png</file>
+    <file>../../../common/ADM_icons/videoFilter/filesaveas.png</file>
+    <file>../../../common/ADM_icons/videoFilter/remove.png</file>
+    <file>../../../common/ADM_icons/videoFilter/thumbnail.png</file>
     <file>../../../common/ADM_icons/videoFilter/1.png</file>
     <file>../../../common/ADM_icons/videoFilter/2.png</file>
     <file>../../../common/ADM_icons/videoFilter/3.png</file>



From mean at mail.berlios.de  Mon Dec 21 19:40:49 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 21 Dec 2009 19:40:49 +0100
Subject: [Avidemux-svn-commit] r5711 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src
Message-ID: <200912211840.nBLIen6q031572@sheep.berlios.de>

Author: mean
Date: 2009-12-21 19:40:48 +0100 (Mon, 21 Dec 2009)
New Revision: 5711

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt
Log:
[flyDialog] link fix for win32

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt	2009-12-21 18:33:13 UTC (rev 5710)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt	2009-12-21 18:40:48 UTC (rev 5711)
@@ -19,5 +19,5 @@
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${QT_INCLUDE_DIR})
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/../include)
 ADD_LIBRARY(${ADM_LIB} SHARED ${${ADM_LIB}_SRCS})
-TARGET_LINK_LIBRARIES(${ADM_LIB} ADM_core6 ADM_coreUI6 ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY} ADM_render6_qt4)
+TARGET_LINK_LIBRARIES(${ADM_LIB} ADM_core6 ADM_coreUI6 ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY} ADM_render6_qt4 ADM_coreVideoFilter6)
 ADM_INSTALL_LIB( ${ADM_LIB} )



From gruntster at mail.berlios.de  Mon Dec 21 23:52:46 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 21 Dec 2009 23:52:46 +0100
Subject: [Avidemux-svn-commit] r5712 - in
	branches/avidemux_2.5_branch_gruntster: avidemux
	avidemux/ADM_core/include plugins/ADM_videoEncoder/ADM_vidEnc_xvid
Message-ID: <200912212252.nBLMqk3A026120@sheep.berlios.de>

Author: gruntster
Date: 2009-12-21 23:52:40 +0100 (Mon, 21 Dec 2009)
New Revision: 5712

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h
   branches/avidemux_2.5_branch_gruntster/avidemux/gui_action.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp
Log:
[Win64] fix fast memory copy

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h	2009-12-21 18:40:48 UTC (rev 5711)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h	2009-12-21 22:52:40 UTC (rev 5712)
@@ -18,6 +18,10 @@
 #include <assert.h>
 #include "ADM_inttype.h"
 
+#if defined(__WIN64)
+#include <intrin.h>
+#endif
+
 #define ADM_assert(x) { if(!(x)) {ADM_backTrack("Assert failed :"#x,__LINE__,__FILE__);  }}
 
 /* Functions we want to override to have better os support / debug / error control */

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/gui_action.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/gui_action.cpp	2009-12-21 18:40:48 UTC (rev 5711)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/gui_action.cpp	2009-12-21 22:52:40 UTC (rev 5712)
@@ -1,4 +1,3 @@
-#include "ADM_default.h"
 #include <strings.h>
 
 #include <vector>
@@ -13,6 +12,7 @@
 using std::sort;
 using std::equal_range;
 
+#include "ADM_default.h"
 #include "gui_action.hxx"
 
 struct ActionNameNum

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp	2009-12-21 18:40:48 UTC (rev 5711)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp	2009-12-21 22:52:40 UTC (rev 5712)
@@ -25,7 +25,6 @@
 #include <libxml/xmlschemas.h>
 
 #include "config.h"
-#include "ADM_default.h"
 #include "ADM_files.h"
 
 #include "../common/PluginOptions.cpp"



From gruntster at mail.berlios.de  Tue Dec 22 00:34:56 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 22 Dec 2009 00:34:56 +0100
Subject: [Avidemux-svn-commit] r5713 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid
Message-ID: <200912212334.nBLNYum5031473@sheep.berlios.de>

Author: gruntster
Date: 2009-12-22 00:34:49 +0100 (Tue, 22 Dec 2009)
New Revision: 5713

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp
Log:
[Win64] fix compilation error (r5712)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp	2009-12-21 22:52:40 UTC (rev 5712)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp	2009-12-21 23:34:49 UTC (rev 5713)
@@ -25,6 +25,7 @@
 #include <libxml/xmlschemas.h>
 
 #include "config.h"
+#include "ADM_inttype.h"
 #include "ADM_files.h"
 
 #include "../common/PluginOptions.cpp"



From mean at mail.berlios.de  Tue Dec 22 16:30:07 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 16:30:07 +0100
Subject: [Avidemux-svn-commit] r5714 - in branches/avidemux_2.6_branch_mean:
	avidemux_core/ADM_coreAudioDevice/include
	avidemux_plugins/ADM_audioDevices/Alsa
	avidemux_plugins/ADM_audioDevices/Esd
	avidemux_plugins/ADM_audioDevices/Jack
	avidemux_plugins/ADM_audioDevices/Oss
	avidemux_plugins/ADM_audioDevices/PulseAudioSimple
	avidemux_plugins/ADM_audioDevices/Sdl
	avidemux_plugins/ADM_audioDevices/Win32
Message-ID: <200912221530.nBMFU7d2024235@sheep.berlios.de>

Author: mean
Date: 2009-12-22 16:30:04 +0100 (Tue, 22 Dec 2009)
New Revision: 5714

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/include/ADM_audioDeviceInternal.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/include/ADM_audiodevice.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/include/audio_out.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Alsa/ADM_deviceALSA.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Alsa/ADM_deviceALSA.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd/ADM_deviceEsd.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd/ADM_deviceEsd.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Jack/ADM_deviceJack.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Jack/ADM_deviceJack.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Oss/ADM_deviceoss.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Oss/ADM_deviceoss.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Sdl/ADM_deviceSDL.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Sdl/ADM_deviceSDL.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Win32/ADM_deviceWin32.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Win32/ADM_deviceWin32.h
Log:
[AudioDevice] Add interface to gather stats from next elemts in the queue to feed vumeter + ask each device what is its prefered channel mapping

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/include/ADM_audioDeviceInternal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/include/ADM_audioDeviceInternal.h	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/include/ADM_audioDeviceInternal.h	2009-12-22 15:30:04 UTC (rev 5714)
@@ -8,7 +8,7 @@
 #ifndef ADM_audioDeviceInternal_H
 #define ADM_audioDeviceInternal_H
 
-#define ADM_AUDIO_DEVICE_API_VERSION 1
+#define ADM_AUDIO_DEVICE_API_VERSION 2
 #include "ADM_dynamicLoading.h"
 class ADM_AudioDevices :public ADM_LibWrapper
 {

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/include/ADM_audiodevice.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/include/ADM_audiodevice.h	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/include/ADM_audiodevice.h	2009-12-22 15:30:04 UTC (rev 5714)
@@ -20,7 +20,11 @@
 #define AUDIO_DEVICE_STARTED  1
 #define AUDIO_DEVICE_STOP_REQ 2
 #define AUDIO_DEVICE_STOP_GR  3
-
+extern bool   ADM_audioReorderChannels(uint32_t channels,float *data, uint32_t nb,CHANNEL_TYPE *input,CHANNEL_TYPE *output);
+/**
+    \class audioDevice
+    \brief Base class for audioDeviceThreaded, the one actually used.
+*/
  class audioDevice
  {
         protected:
@@ -30,7 +34,7 @@
         public:
                                         audioDevice(void) {};
                         virtual         ~audioDevice() {};
-                        virtual uint8_t  init(uint32_t channel, uint32_t fq ) =0;
+                        virtual uint8_t  init(uint32_t channel, uint32_t fq ,CHANNEL_TYPE *channelMapping) =0;
                         virtual uint8_t  stop(void)=0;
                         virtual uint8_t  play(uint32_t len, float *data) =0;
                         virtual uint8_t  setVolume(int volume) {return 1;}
@@ -47,6 +51,7 @@
 class audioDeviceThreaded: public audioDevice
 {
 protected:
+            CHANNEL_TYPE incomingMapping[MAX_CHANNELS];
             uint32_t    rdIndex;
             uint32_t    wrIndex;
             uint8_t     *audioBuffer;
@@ -65,15 +70,16 @@
     //
     virtual     bool     localInit(void)=0;
     virtual     bool     localStop(void)=0;
-    virtual     void     sendData(void)=0;    
+    virtual     void     sendData(void)=0;   
+    virtual const CHANNEL_TYPE *getWantedChannelMapping(uint32_t channels)=0;
 
 public:
     virtual     void        Loop(void);
-    virtual     uint8_t     init(uint32_t channel, uint32_t fq );
+    virtual     uint8_t     init(uint32_t channel, uint32_t fq,CHANNEL_TYPE *channelMapping );
     virtual     uint8_t     stop(void);
 
     virtual     uint8_t     play(uint32_t len, float *data);
-
+    virtual     bool        getVolumeStats(uint32_t *vol); // Vol is 6 channels between 0 and 255
 };
 
 /**
@@ -82,10 +88,12 @@
 */
 class dummyAudioDevice : public audioDeviceThreaded
 {
-		  public:
+ static const   CHANNEL_TYPE myChannelType[MAX_CHANNELS];
+		  protected:
                     virtual     bool     localInit(void);
                     virtual     bool     localStop(void);
                     virtual     void     sendData(void);    
+                    virtual const CHANNEL_TYPE *getWantedChannelMapping(uint32_t channels){return myChannelType;}
 }   ;
 
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/include/audio_out.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/include/audio_out.h	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/include/audio_out.h	2009-12-22 15:30:04 UTC (rev 5714)
@@ -17,7 +17,7 @@
 
 #ifndef AUDIOOUPUT_H
 #define AUDIOOUPUT_H
-
+#include "ADM_audiodef.h"
 typedef int AUDIO_DEVICE;
 
 void 		AVDM_audioSave( void ); /// Save in Prefs the current audio Device
@@ -26,7 +26,7 @@
 void 		AVDM_switch( AUDIO_DEVICE action );
 
 uint8_t 	AVDM_AudioPlay(float *ptr, uint32_t nb);
-uint32_t 	AVDM_AudioSetup(uint32_t fq, uint8_t channel);
+uint32_t 	AVDM_AudioSetup(uint32_t fq, uint8_t channel, CHANNEL_TYPE    *channelMapping);
 void 		AVDM_AudioClose(void);
 uint32_t    AVDM_GetLayencyMs(void);
 AUDIO_DEVICE 	AVDM_getCurrentDevice( void);
@@ -35,5 +35,6 @@
 uint32_t    ADM_av_getNbDevices(void);
 bool        ADM_av_getDeviceInfo(int filter, const char **name, uint32_t *major,uint32_t *minor,uint32_t *patch);
 uint32_t    AVDM_getMsFullness(void); /// Fullness in ms
+bool        AVDM_getStats(uint32_t *vol); // Retrieve volume info
 #endif
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Alsa/ADM_deviceALSA.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Alsa/ADM_deviceALSA.cpp	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Alsa/ADM_deviceALSA.cpp	2009-12-22 15:30:04 UTC (rev 5714)
@@ -291,6 +291,25 @@
 	return ;
 }
 /**
+    \fn getWantedChannelMapping
+*/
+const CHANNEL_TYPE mono[MAX_CHANNELS]={ADM_CH_MONO};
+const CHANNEL_TYPE stereo[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT};
+const CHANNEL_TYPE fiveDotOne[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT,ADM_CH_FRONT_CENTER,
+                                             ADM_CH_REAR_LEFT,ADM_CH_REAR_RIGHT,ADM_CH_LFE};
+const CHANNEL_TYPE *alsaAudioDevice::getWantedChannelMapping(uint32_t channels)
+{
+    switch(channels)
+    {
+        case 1: return mono;break;
+        case 2: return stereo;break;
+        default:
+                return fiveDotOne;
+                break;
+    }
+    return NULL;
+}
+/**
     \fn localStop
 
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Alsa/ADM_deviceALSA.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Alsa/ADM_deviceALSA.h	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Alsa/ADM_deviceALSA.h	2009-12-22 15:30:04 UTC (rev 5714)
@@ -20,15 +20,17 @@
  class alsaAudioDevice : public audioDeviceThreaded
  {
      protected :
+            virtual     bool    localInit(void);
+            virtual     bool    localStop(void);
+            virtual     void    sendData(void); 
+            virtual const CHANNEL_TYPE *getWantedChannelMapping(uint32_t channels);
             //	0-> no init done
             //	1-> device opened but init failed
             //	2->fully initialized
             uint32_t _init;
       public:
                                 alsaAudioDevice(void);
-            virtual     bool    localInit(void);
-            virtual     bool    localStop(void);
-            virtual     void    sendData(void); 
+          
             virtual     uint8_t setVolume(int volume);
      }     ;
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd/ADM_deviceEsd.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd/ADM_deviceEsd.cpp	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd/ADM_deviceEsd.cpp	2009-12-22 15:30:04 UTC (rev 5714)
@@ -112,4 +112,23 @@
     mutex.unlock();
 	return ;
 }
+/**
+    \fn getWantedChannelMapping
+*/
+const CHANNEL_TYPE mono[MAX_CHANNELS]={ADM_CH_MONO};
+const CHANNEL_TYPE stereo[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT};
+const CHANNEL_TYPE fiveDotOne[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT,ADM_CH_FRONT_CENTER,
+                                             ADM_CH_REAR_LEFT,ADM_CH_REAR_RIGHT,ADM_CH_LFE};
+const CHANNEL_TYPE *esdAudioDevice::getWantedChannelMapping(uint32_t channels)
+{
+    switch(channels)
+    {
+        case 1: return mono;break;
+        case 2: return stereo;break;
+        default:
+                return fiveDotOne;
+                break;
+    }
+    return NULL;
+}
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd/ADM_deviceEsd.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd/ADM_deviceEsd.h	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd/ADM_deviceEsd.h	2009-12-22 15:30:04 UTC (rev 5714)
@@ -25,6 +25,7 @@
          virtual     bool     localInit(void);
          virtual     bool     localStop(void);
          virtual     void     sendData(void); 
+         virtual const CHANNEL_TYPE *getWantedChannelMapping(uint32_t channels);
 		  public:
 		  			esdAudioDevice(void) {esdDevice=-1;esdServer=-1;}
 		     		 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Jack/ADM_deviceJack.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Jack/ADM_deviceJack.cpp	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Jack/ADM_deviceJack.cpp	2009-12-22 15:30:04 UTC (rev 5714)
@@ -254,4 +254,23 @@
 #endif
 	return 1;
 }
-
+/**
+    \fn getWantedChannelMapping
+*/
+const CHANNEL_TYPE mono[MAX_CHANNELS]={ADM_CH_MONO};
+const CHANNEL_TYPE stereo[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT};
+const CHANNEL_TYPE fiveDotOne[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT,ADM_CH_FRONT_CENTER,
+                                             ADM_CH_REAR_LEFT,ADM_CH_REAR_RIGHT,ADM_CH_LFE};
+const CHANNEL_TYPE *jackAudioDevice::getWantedChannelMapping(uint32_t channels)
+{
+    switch(channels)
+    {
+        case 1: return mono;break;
+        case 2: return stereo;break;
+        default:
+                return fiveDotOne;
+                break;
+    }
+    return NULL;
+}
+//EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Jack/ADM_deviceJack.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Jack/ADM_deviceJack.h	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Jack/ADM_deviceJack.h	2009-12-22 15:30:04 UTC (rev 5714)
@@ -20,11 +20,13 @@
 {
 public:
 	jackAudioDevice();
+protected:
     virtual     bool     localInit(void);
     virtual     bool     localStop(void);
     virtual     void     sendData(void); 
                 uint8_t  setVolume(int volume);
                 int      process(jack_nframes_t nframes);
+    virtual const CHANNEL_TYPE *getWantedChannelMapping(uint32_t channels);
 
 protected:
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Oss/ADM_deviceoss.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Oss/ADM_deviceoss.cpp	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Oss/ADM_deviceoss.cpp	2009-12-22 15:30:04 UTC (rev 5714)
@@ -171,4 +171,23 @@
     return;
    
 }
+/**
+    \fn getWantedChannelMapping
+*/
+const CHANNEL_TYPE mono[MAX_CHANNELS]={ADM_CH_MONO};
+const CHANNEL_TYPE stereo[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT};
+const CHANNEL_TYPE fiveDotOne[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT,ADM_CH_FRONT_CENTER,
+                                             ADM_CH_REAR_LEFT,ADM_CH_REAR_RIGHT,ADM_CH_LFE};
+const CHANNEL_TYPE *ossAudioDevice::getWantedChannelMapping(uint32_t channels)
+{
+    switch(channels)
+    {
+        case 1: return mono;break;
+        case 2: return stereo;break;
+        default:
+                return fiveDotOne;
+                break;
+    }
+    return NULL;
+}
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Oss/ADM_deviceoss.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Oss/ADM_deviceoss.h	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Oss/ADM_deviceoss.h	2009-12-22 15:30:04 UTC (rev 5714)
@@ -23,6 +23,7 @@
     virtual     bool     localInit(void);
     virtual     bool     localStop(void);
     virtual     void     sendData(void); 
+    virtual const CHANNEL_TYPE *getWantedChannelMapping(uint32_t channels);
 public:   
 			uint8_t setVolume(int volume);
 }     ;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.cpp	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.cpp	2009-12-22 15:30:04 UTC (rev 5714)
@@ -153,5 +153,23 @@
 	return ;
 
 }
-
+/**
+    \fn getWantedChannelMapping
+*/
+const CHANNEL_TYPE mono[MAX_CHANNELS]={ADM_CH_MONO};
+const CHANNEL_TYPE stereo[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT};
+const CHANNEL_TYPE fiveDotOne[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT,ADM_CH_FRONT_CENTER,
+                                             ADM_CH_REAR_LEFT,ADM_CH_REAR_RIGHT,ADM_CH_LFE};
+const CHANNEL_TYPE *pulseSimpleAudioDevice::getWantedChannelMapping(uint32_t channels)
+{
+    switch(channels)
+    {
+        case 1: return mono;break;
+        case 2: return stereo;break;
+        default:
+                return fiveDotOne;
+                break;
+    }
+    return NULL;
+}
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.h	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.h	2009-12-22 15:30:04 UTC (rev 5714)
@@ -24,6 +24,7 @@
          virtual     bool     localInit(void);
          virtual     bool     localStop(void);
          virtual     void     sendData(void); 
+         virtual const CHANNEL_TYPE *getWantedChannelMapping(uint32_t channels);
       public:
                 pulseSimpleAudioDevice(void);
                 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Sdl/ADM_deviceSDL.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Sdl/ADM_deviceSDL.cpp	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Sdl/ADM_deviceSDL.cpp	2009-12-22 15:30:04 UTC (rev 5714)
@@ -139,5 +139,23 @@
     ADM_usleep(5*1000);
 
 }
+/**
+    \fn getWantedChannelMapping
+*/
+const CHANNEL_TYPE mono[MAX_CHANNELS]={ADM_CH_MONO};
+const CHANNEL_TYPE stereo[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT};
+const CHANNEL_TYPE fiveDotOne[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT,ADM_CH_FRONT_CENTER,
+                                             ADM_CH_REAR_LEFT,ADM_CH_REAR_RIGHT,ADM_CH_LFE};
+const CHANNEL_TYPE *sdlAudioDevice::getWantedChannelMapping(uint32_t channels)
+{
+    switch(channels)
+    {
+        case 1: return mono;break;
+        case 2: return stereo;break;
+        default:
+                return fiveDotOne;
+                break;
+    }
+    return NULL;
+}
 
-

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Sdl/ADM_deviceSDL.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Sdl/ADM_deviceSDL.h	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Sdl/ADM_deviceSDL.h	2009-12-22 15:30:04 UTC (rev 5714)
@@ -13,13 +13,15 @@
  {
      protected :
                 bool       active;
-      public:
+
                 virtual     bool     localInit(void);
                 virtual     bool     localStop(void);
                 virtual     void     sendData(void);    
-                                     sdlAudioDevice();
+                                     
+                virtual const CHANNEL_TYPE *getWantedChannelMapping(uint32_t channels);
      public:
                 uint8_t callback( Uint8 *stream, int len);
+                        sdlAudioDevice();
      }     ;
 #endif
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Win32/ADM_deviceWin32.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Win32/ADM_deviceWin32.cpp	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Win32/ADM_deviceWin32.cpp	2009-12-22 15:30:04 UTC (rev 5714)
@@ -168,6 +168,25 @@
 	return ;
 }
 
+/**
+    \fn getWantedChannelMapping
+*/
+const CHANNEL_TYPE mono[MAX_CHANNELS]={ADM_CH_MONO};
+const CHANNEL_TYPE stereo[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT};
+const CHANNEL_TYPE fiveDotOne[MAX_CHANNELS]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT,ADM_CH_FRONT_CENTER,
+                                             ADM_CH_LFE,ADM_CH_REAR_LEFT,ADM_CH_REAR_RIGHT};
+const CHANNEL_TYPE *win32AudioDevice::getWantedChannelMapping(uint32_t channels)
+{
+    switch(channels)
+    {
+        case 1: return mono;break;
+        case 2: return stereo;break;
+        default:
+                return fiveDotOne;
+                break;
+    }
+    return NULL;
+}
 void handleMM(MMRESULT err)
 {
 #define ERMM(x) if(err==x) printf("[Win32] "#x"\n");

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Win32/ADM_deviceWin32.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Win32/ADM_deviceWin32.h	2009-12-21 23:34:49 UTC (rev 5713)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Win32/ADM_deviceWin32.h	2009-12-22 15:30:04 UTC (rev 5714)
@@ -19,7 +19,7 @@
 	virtual     bool     localInit(void);
     virtual     bool     localStop(void);
     virtual     void     sendData(void); 
-
+    virtual     const CHANNEL_TYPE *getWantedChannelMapping(uint32_t channels);
 public:
     uint8_t setVolume(int volume);
 	win32AudioDevice(void);



From mean at mail.berlios.de  Tue Dec 22 16:30:12 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 16:30:12 +0100
Subject: [Avidemux-svn-commit] r5715 - in
	branches/avidemux_2.6_branch_mean/avidemux:
	cli/ADM_userInterfaces/ADM_gui2 gtk/ADM_userInterfaces/ADM_gui2
	qt4/ADM_userInterfaces/ADM_gui
Message-ID: <200912221530.nBMFUCkq024276@sheep.berlios.de>

Author: mean
Date: 2009-12-22 16:30:10 +0100 (Tue, 22 Dec 2009)
New Revision: 5715

Added:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_vumeter.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_vumeter.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_gui2/gui_none.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui
Log:
[UI] Add a small level visualization widget to help debug the channel mapping

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_gui2/gui_none.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_gui2/gui_none.cpp	2009-12-22 15:30:04 UTC (rev 5714)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_gui2/gui_none.cpp	2009-12-22 15:30:10 UTC (rev 5715)
@@ -159,4 +159,8 @@
 void UI_setTotalTime(uint64_t t)
 {
 }
+bool UI_setVUMeter(uint32_t volume[6])
+{
+    return true;
+}
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2009-12-22 15:30:04 UTC (rev 5714)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_gui2/GUI_bindings.cpp	2009-12-22 15:30:10 UTC (rev 5715)
@@ -1594,5 +1594,11 @@
  _upd_in_progres--;
 #endif
 }
-
+/**
+    \fn UI_setVUMeter
+*/
+bool UI_setVUMeter(uint32_t volume[6])
+{
+    return true;
+}
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/CMakeLists.txt	2009-12-22 15:30:04 UTC (rev 5714)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/CMakeLists.txt	2009-12-22 15:30:10 UTC (rev 5715)
@@ -1,12 +1,13 @@
 SET(ADM_LIB ADM_guiQt4)
 
 QT4_WRAP_UI(${ADM_LIB}_header  gui2.ui )
-QT4_WRAP_CPP(${ADM_LIB}_source  Q_gui2.h  T_preview.h)
+QT4_WRAP_CPP(${ADM_LIB}_source  Q_gui2.h  T_preview.h T_vumeter.h)
 QT4_ADD_RESOURCES(${ADM_LIB}_resource  avidemux.qrc)
 
 SET(${ADM_LIB}_SRCS
 	Q_gui2.cpp  
         T_preview.cpp  
+        T_vumeter.cpp  
         #stubs.cpp
         file_qt4.cpp  gui_none.cpp  ADM_qslider.cpp
 	${${ADM_LIB}_header}  ${${ADM_LIB}_source}  ${${ADM_LIB}_resource})

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2009-12-22 15:30:04 UTC (rev 5714)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2009-12-22 15:30:10 UTC (rev 5715)
@@ -32,7 +32,7 @@
 #include "ADM_render/GUI_renderInternal.h"
 #include "ADM_coreVideoEncoderInternal.h"
 #include "ADM_muxerProto.h"
-
+#include "T_vumeter.h"
 extern int global_argc;
 extern char **global_argv;
 
@@ -585,7 +585,9 @@
 	printf("The screen seems to be %u x %u px\n",w,h);
 
 	UI_QT4VideoWidget(mw->ui.frame_video);  // Add the widget that will handle video display
-	UI_updateRecentMenu();
+	UI_updateRecentMenu();
+    // Init vumeter
+    UI_InitVUMeter(mw->ui.frameVU);
 	return 0;
 }
 
@@ -1054,7 +1056,14 @@
 		WIDGET(checkBox_TimeShift)->setCheckState(Qt::Unchecked);
 	WIDGET(spinBox_TimeValue)->setValue(value);
 	return 1;
+}
+/**
+    \fn UI_setVUMeter
+*/
+bool UI_setVUMeter( uint32_t volume[6])
+{
+    UI_vuUpdate( volume);
+    return true;
 }
-
 //********************************************
 //EOF

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_vumeter.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_vumeter.cpp	2009-12-22 15:30:04 UTC (rev 5714)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_vumeter.cpp	2009-12-22 15:30:10 UTC (rev 5715)
@@ -0,0 +1,105 @@
+/***************************************************************************
+    \file T_vumeter.cpp
+    \brief Class to draw volume unit audio graphs
+    \author mean (c) 2009
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <QtGui/QFrame>
+#include <QtGui/QImage>
+#include <QtGui/QPainter>
+
+/* Probably on unix/X11 ..*/
+#ifdef __APPLE__
+#include <Carbon/Carbon.h>
+#elif !defined(__WIN32)
+#include <QtGui/QX11Info>
+#endif
+#include "ADM_default.h"
+#include "T_vumeter.h"
+    
+
+static QFrame *hostFrame=NULL;
+static uint8_t *rgbDataBuffer=NULL;
+static uint32_t vuWidth=0,vuHeight=0;
+
+ADM_Qvumeter::ADM_Qvumeter(QWidget *z) : QWidget(z) {}
+ADM_Qvumeter::~ADM_Qvumeter() {}
+
+void ADM_Qvumeter::paintEvent(QPaintEvent *ev)
+{
+	if(!vuWidth || !vuWidth || !rgbDataBuffer )
+    {
+        ADM_warning("Vu meter: cannot update\n");
+		return ;
+    }
+		QImage image(rgbDataBuffer,vuWidth,vuHeight,QImage::Format_RGB32);
+		QPainter painter(this);
+		painter.drawImage(QPoint(1,1),image);
+		painter.end();
+}
+
+ADM_Qvumeter *vuWidget=NULL;
+/**
+    \fn UI_InitVUMeter
+*/
+bool UI_InitVUMeter(QFrame *host)
+{
+    vuWidget=new ADM_Qvumeter(host);
+    hostFrame=host;
+    vuWidth=64;
+    vuHeight=64;
+    vuWidget->resize(vuWidth,vuHeight);
+    host->resize(vuWidth+2,vuHeight+2);
+    rgbDataBuffer=new uint8_t[vuWidth*vuHeight*4];
+    memset(rgbDataBuffer,0,vuWidth*vuHeight*4);
+    vuWidget->show();
+    return true;
+   
+}
+/** 
+    \fn UI_vuUpdate
+    \brief Update vumeter, input is volume per channel between 0 & 255
+*/
+  #warning Assume rgb bbuffer is 32bits aligned...
+#define GREEN  0x0000FF00
+#define YELLOW 0x00A0C000
+#define RED    0x00FF0000
+
+bool UI_vuUpdate(uint32_t volume[6])
+{
+      memset(rgbDataBuffer,0,vuWidth*vuHeight*4);
+      // Draw lines
+      for(int i=0;i<6;i++)
+      {
+            int vol=volume[i];
+            if(vol>63) vol=63;
+            if(vol<5) vol=5;
+            uint8_t *ptr=rgbDataBuffer+vuWidth*(2+10*i)*4;
+            uint32_t *data=(uint32_t *)(ptr);
+            for(int j=0;j<vol;j++)
+            {
+                if(j<32) *data++=GREEN;
+                else
+                if(j<50) *data++=YELLOW;
+                else *data++=RED;
+            }
+            for(int j=vol;j<128;j++)
+            {
+                *data++=0;
+            }
+      }
+     // ADM_info("VU : %"LU" %"LU" %"LU"\n",volume[0],volume[1],volume[2]);
+      vuWidget->repaint();
+      return true;
+}
+//EOF 

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_vumeter.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_vumeter.h	2009-12-22 15:30:04 UTC (rev 5714)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_vumeter.h	2009-12-22 15:30:10 UTC (rev 5715)
@@ -0,0 +1,23 @@
+#ifndef T_vumeter_h
+#define T_vumeter_h
+
+#include <QtGui/QPaintEvent>
+#include <QtGui/QWidget>
+#include <QtGui/QFrame>
+#include "ADM_inttype.h"
+/**
+    \fn class ADM_Qvumeter
+*/
+class  ADM_Qvumeter : public QWidget
+{
+	Q_OBJECT
+
+public:
+	ADM_Qvumeter(QWidget *z);
+	~ADM_Qvumeter();
+	void paintEvent(QPaintEvent *ev);
+};
+
+bool UI_InitVUMeter(QFrame *host);
+bool UI_vuUpdate(uint32_t volume[6]);
+#endif	// T_preview_h

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui	2009-12-22 15:30:04 UTC (rev 5714)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/gui2.ui	2009-12-22 15:30:10 UTC (rev 5715)
@@ -7,8 +7,8 @@
    <rect>
     <x>0</x>
     <y>0</y>
-    <width>838</width>
-    <height>606</height>
+    <width>756</width>
+    <height>588</height>
    </rect>
   </property>
   <property name="windowTitle">
@@ -980,6 +980,52 @@
        </spacer>
       </item>
       <item>
+       <layout class="QVBoxLayout" name="verticalLayout">
+        <item>
+         <spacer name="verticalSpacer">
+          <property name="orientation">
+           <enum>Qt::Vertical</enum>
+          </property>
+          <property name="sizeHint" stdset="0">
+           <size>
+            <width>20</width>
+            <height>40</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+        <item>
+         <widget class="QFrame" name="frameVU">
+          <property name="minimumSize">
+           <size>
+            <width>64</width>
+            <height>64</height>
+           </size>
+          </property>
+          <property name="frameShape">
+           <enum>QFrame::StyledPanel</enum>
+          </property>
+          <property name="frameShadow">
+           <enum>QFrame::Raised</enum>
+          </property>
+         </widget>
+        </item>
+       </layout>
+      </item>
+      <item>
+       <spacer name="horizontalSpacer">
+        <property name="orientation">
+         <enum>Qt::Horizontal</enum>
+        </property>
+        <property name="sizeHint" stdset="0">
+         <size>
+          <width>40</width>
+          <height>20</height>
+         </size>
+        </property>
+       </spacer>
+      </item>
+      <item>
        <layout class="QVBoxLayout">
         <property name="spacing">
          <number>6</number>
@@ -1245,7 +1291,7 @@
     <rect>
      <x>0</x>
      <y>0</y>
-     <width>838</width>
+     <width>756</width>
      <height>21</height>
     </rect>
    </property>



From mean at mail.berlios.de  Tue Dec 22 16:30:15 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 16:30:15 +0100
Subject: [Avidemux-svn-commit] r5716 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src
Message-ID: <200912221530.nBMFUFYE024286@sheep.berlios.de>

Author: mean
Date: 2009-12-22 16:30:14 +0100 (Tue, 22 Dec 2009)
New Revision: 5716

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audiodevice.cpp
Log:
[AudioDevice] Add interface to gather stats from next elemts in the queue to feed vumeter + ask each device what is its prefered channel mapping

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp	2009-12-22 15:30:10 UTC (rev 5715)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp	2009-12-22 15:30:14 UTC (rev 5716)
@@ -65,9 +65,10 @@
     \fn audioDeviceThreaded
     \brief destructor
 */
-uint8_t audioDeviceThreaded::init(uint32_t channel, uint32_t fq )
+uint8_t audioDeviceThreaded::init(uint32_t channel, uint32_t fq ,CHANNEL_TYPE *channelMapping)
 {
     // Allocate buffer
+    memcpy(incomingMapping,channelMapping,sizeof(CHANNEL_TYPE)*MAX_CHANNELS);
     _channels=channel;
     _frequency=fq;
     sizeOf10ms=(_channels*_frequency*2)/100;
@@ -82,6 +83,7 @@
     // Spawn
     stopRequest=AUDIO_DEVICE_STARTED;
     ADM_assert(!pthread_create(&myThread,NULL,bouncer,this));
+    
 
     return 1;
 }
@@ -126,6 +128,7 @@
 }
 /**
     \fn write
+    \brief We assume that we have full channels each time
 
 */
 bool        audioDeviceThreaded::writeData(uint8_t *data,uint32_t lenInByte)
@@ -143,7 +146,18 @@
         mutex.unlock();
         return false;
     }
+    
     memcpy(audioBuffer+wrIndex,data,lenInByte);
+    // Reorder channels if needed...
+    uint32_t samples=lenInByte;
+    samples/=sizeof(float);
+    samples/=_channels;
+    ADM_audioReorderChannels(_channels,
+                    (float *)(audioBuffer+wrIndex),
+                    samples,
+                    incomingMapping,
+                    (CHANNEL_TYPE*)getWantedChannelMapping(_channels));
+    //
     wrIndex+=lenInByte;
     mutex.unlock();
     return true;
@@ -175,5 +189,54 @@
     return writeData((uint8_t *)data,len);
 
 }
+/**
+    \fn getVolumeStats
+    \brief Return stats about volume for each channel [6] between 0 & 255
+*/
+bool        audioDeviceThreaded::getVolumeStats(uint32_t *vol)
+{
+    float f[6];
+    uint32_t raw[6];
+    memset(vol,0,sizeof(uint32_t)*6);
+    // 20 ms should be enough, i.e. fq/50
+    uint32_t samples=_frequency/50;
+    mutex.lock();
+    if(samples*_channels*2 > (wrIndex-rdIndex))
+            samples=(wrIndex-rdIndex)/(2*_channels);
+    for(int i=0;i<6;i++) f[i]=0;
+    if(!samples) 
+    {
+        mutex.unlock();
+        return true;
+    }
 
+    int16_t *base=(int16_t *)(rdIndex+audioBuffer);
+    for(int i=0;i<samples;i++)
+        for(int chan=0;chan<_channels;chan++)
+        {
+                f[chan]+=abs(*base++);
+                
+        }
+    mutex.unlock();
+    // Normalize
+    for(int i=0;i<6;i++)
+    {
+        float d=f[i];
+        d/=samples;
+        d/=128;
+        if(d>127) d=127;
+        raw[i]=(uint32_t)d;
+    }
+    // Move channels around so that they fit Left/Right/Center/Rear Left, Rear Right,LFE
+    const CHANNEL_TYPE *chans=this->getWantedChannelMapping(_channels);
+    static const CHANNEL_TYPE output[6]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT,ADM_CH_FRONT_CENTER,ADM_CH_REAR_LEFT,ADM_CH_REAR_RIGHT,ADM_CH_LFE};
+    for(int i=0;i<_channels;i++)
+    {
+        CHANNEL_TYPE wanted=output[i];
+        for(int j=0;j<_channels;j++)
+            if(chans[j]==wanted) vol[i]=raw[j];
+    }
+    return true;
+    
+}
 //**

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audiodevice.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audiodevice.cpp	2009-12-22 15:30:10 UTC (rev 5715)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audiodevice.cpp	2009-12-22 15:30:14 UTC (rev 5716)
@@ -235,10 +235,10 @@
     \brief Initialize a device
 
 */
-uint32_t AVDM_AudioSetup(uint32_t fq, uint8_t channel)
+uint32_t AVDM_AudioSetup(uint32_t fq, uint8_t channel,CHANNEL_TYPE *channelMapping)
 {
 	
-	return device->init(channel,fq);
+	return device->init(channel,fq,channelMapping);
 }
 /**
     \fn AVDM_setVolume
@@ -281,10 +281,21 @@
     return device->getBufferFullness();
 
 }
+/**
+    \fn AVDM_getStats
+*/
+bool        AVDM_getStats(uint32_t *vol)
+{
+    return device->getVolumeStats(vol);
+}
 
 
-
 //**
+const CHANNEL_TYPE dummyAudioDevice::myChannelType[MAX_CHANNELS]=
+                            {ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT,ADM_CH_FRONT_CENTER,
+                             ADM_CH_REAR_LEFT, ADM_CH_REAR_RIGHT, ADM_CH_LFE,
+                             ADM_CH_INVALID,   ADM_CH_INVALID
+                            };
 bool dummyAudioDevice::localInit(void)                                {return true;}
 bool dummyAudioDevice::localStop(void)                                {return true;}
 void  dummyAudioDevice::sendData(void)                                {ADM_usleep(5000);}



From mean at mail.berlios.de  Tue Dec 22 16:30:17 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 16:30:17 +0100
Subject: [Avidemux-svn-commit] r5717 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libpostproc
Message-ID: <200912221530.nBMFUH00024296@sheep.berlios.de>

Author: mean
Date: 2009-12-22 16:30:16 +0100 (Tue, 22 Dec 2009)
New Revision: 5717

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libpostproc/postprocess.c
Log:
[postproc] Silence annoying ac_log

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libpostproc/postprocess.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libpostproc/postprocess.c	2009-12-22 15:30:14 UTC (rev 5716)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libpostproc/postprocess.c	2009-12-22 15:30:16 UTC (rev 5717)
@@ -1066,8 +1066,8 @@
         }
     }
 
-    av_log(c, AV_LOG_DEBUG, "using npp filters 0x%X/0x%X\n",
-           mode->lumMode, mode->chromMode);
+    // MEANX av_log(c, AV_LOG_DEBUG, "using npp filters 0x%X/0x%X\n",
+           //mode->lumMode, mode->chromMode);
 
     postProcess(src[0], srcStride[0], dst[0], dstStride[0],
                 width, height, QP_store, QPStride, 0, mode, c);



From mean at mail.berlios.de  Tue Dec 22 16:30:19 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 16:30:19 +0100
Subject: [Avidemux-svn-commit] r5718 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src
Message-ID: <200912221530.nBMFUJm7024309@sheep.berlios.de>

Author: mean
Date: 2009-12-22 16:30:18 +0100 (Tue, 22 Dec 2009)
New Revision: 5718

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter.cpp
Log:
[Playback] Follow user preference concerning downmix for local playback

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter.cpp	2009-12-22 15:30:16 UTC (rev 5717)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter.cpp	2009-12-22 15:30:18 UTC (rev 5718)
@@ -22,7 +22,7 @@
 #include "audiofilter_internal.h"
 #include "audiofilter_conf.h"
 #include "audiofilter_film2pal.h"
-
+#include "prefs.h"
 VectorOfAudioFilter PlaybackVector;
 extern ADM_Composer *video_body;
 
@@ -38,11 +38,38 @@
 AUDMAudioFilter *createPlaybackFilter(uint64_t startTime,int32_t shift)
 {
     //
+    uint32_t downmix;
     ADM_AUDIOFILTER_CONFIG playback;
     playback.startTimeInUs=startTime;
     playback.shiftInMs=shift;
     playback.mixerEnabled=true;
-    playback.mixerConf=CHANNEL_STEREO;
+    if(prefs->get(DOWNMIXING_PROLOGIC,&downmix)!=RC_OK)
+    {
+      downmix=0;
+    }
+      switch (downmix) {
+            case 0:
+                    playback.mixerEnabled=false;
+                    break;
+            case 1:
+                    
+                    playback.mixerConf=CHANNEL_STEREO;
+                    break;  
+            case 2:
+                    
+                    playback.mixerConf=CHANNEL_DOLBY_PROLOGIC;
+                    break;
+            case 3:
+                    
+                    playback.mixerConf=CHANNEL_DOLBY_PROLOGIC2;
+                    break;
+            default:
+                    ADM_assert(0);
+      }
+
+
+    // Fetch mixer from prefs...
+
     // If we have no audio, dont even try...
     if(!video_body->getInfo()) return NULL;
     //



From mean at mail.berlios.de  Tue Dec 22 16:30:23 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 16:30:23 +0100
Subject: [Avidemux-svn-commit] r5720 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit
Message-ID: <200912221530.nBMFUN1E024331@sheep.berlios.de>

Author: mean
Date: 2009-12-22 16:30:22 +0100 (Tue, 22 Dec 2009)
New Revision: 5720

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp
Log:
[automation] Merge from 2.5 to handle widechar names on the command line (win32)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp	2009-12-22 15:30:20 UTC (rev 5719)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp	2009-12-22 15:30:22 UTC (rev 5720)
@@ -219,8 +219,22 @@
 static three_arg_type three;
 static two_arg_type two;
 static int index;
-          argv=global_argv;
           argc=global_argc;
+#ifdef __WIN32
+	int utf8StringLength;
+
+	argv = new char*[argc];
+
+	for (int arg = 0; arg < argc; arg++)
+	{
+		utf8StringLength = ansiStringToUtf8(global_argv[arg], -1, NULL);
+		argv[arg] = new char[utf8StringLength];
+
+		ansiStringToUtf8(global_argv[arg], -1, argv[arg]);
+	}
+#else
+	argv = global_argv;
+#endif
           printf("\n *** Automated : %"LU" entries*************\n",(uint32_t)NB_AUTO);
           // we need to process
           argc-=1;
@@ -232,17 +246,7 @@
                       {
                             if(cur==1)
                             {
-#ifdef __WIN32
-								int utf8StringLength = ansiStringToUtf8(argv[cur], -1, NULL);
-								char utf8FileName[utf8StringLength];
-
-								ansiStringToUtf8(argv[cur], -1, utf8FileName);
-
-								A_openAvi(utf8FileName);
-#else
 								A_openAvi(argv[cur]);
-#endif
-
                             }
                             else
                                 printf("\n Found garbage %s\n",argv[cur]);
@@ -286,6 +290,12 @@
           } // end while
           GUI_Verbose();
           printf("\n ********** Automation ended***********\n");
+#ifdef __WIN32
+	for (int arg = 0; arg < argc; arg++)
+		delete [] argv[arg];
+
+	delete argv;
+#endif
           return 0; // Do not call me anymore
 }
 //_________________________________________________________________________



From mean at mail.berlios.de  Tue Dec 22 16:30:21 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 16:30:21 +0100
Subject: [Avidemux-svn-commit] r5719 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <200912221530.nBMFULl7024321@sheep.berlios.de>

Author: mean
Date: 2009-12-22 16:30:20 +0100 (Tue, 22 Dec 2009)
New Revision: 5719

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADMedAVIAUD.cpp
Log:
[editor] Try to silence end of audio message

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADMedAVIAUD.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADMedAVIAUD.cpp	2009-12-22 15:30:18 UTC (rev 5718)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADMedAVIAUD.cpp	2009-12-22 15:30:20 UTC (rev 5719)
@@ -80,6 +80,7 @@
    packetBufferSize=0; 
    uint64_t dts;
    _SEGMENT *seg=_segments.getSegment(_audioSeg);
+   static bool endOfAudio=false;
    if(!seg) return false;
 
    if(lastDts>=seg->_startTimeUs+seg->_durationUs)
@@ -98,8 +99,13 @@
                         &packetBufferSamples,&dts))
     {
               if(true==switchToNextAudioSegment())
+              {
+                 endOfAudio=false;
                  return refillPacketBuffer();
-             ADM_warning("End of audio\n");
+              }
+             if(endOfAudio==false)
+                ADM_warning("End of audio\n");
+             endOfAudio=true;
              return false;
     }
     //
@@ -114,6 +120,7 @@
           return refillPacketBuffer();
         }
     }
+    endOfAudio=false;
     return true;
 }
 



From mean at mail.berlios.de  Tue Dec 22 16:30:26 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 16:30:26 +0100
Subject: [Avidemux-svn-commit] r5721 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <200912221530.nBMFUQQl024343@sheep.berlios.de>

Author: mean
Date: 2009-12-22 16:30:24 +0100 (Tue, 22 Dec 2009)
New Revision: 5721

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
Log:
[playback] Update vumeter upon playback + gather channel information so that audiodevice can be properly configured

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2009-12-22 15:30:22 UTC (rev 5720)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2009-12-22 15:30:24 UTC (rev 5721)
@@ -26,9 +26,10 @@
 #include "avidemutils.h"
 #include "ADM_preview.h"
 #include "audiofilter.h"
+#include "GUI_ui.h"
 //___________________________________
-// In ms
-#define AUDIO_PRELOAD 200
+// In 10 ms chunks
+#define AUDIO_PRELOAD 100
 #define EVEN(x) (x&0xffffffe)
 //___________________________________
 
@@ -285,15 +286,15 @@
              if (! (oaf = playbackAudio->fill(256*16,  wavbuf,&status)))
              {
                   printf("[Playback] Error reading audio stream...\n");
-                  
-                  return false;
+                  break;
              }
             AVDM_AudioPlay(wavbuf, oaf);
             nbSamplesSent += oaf/channels;
             load+=oaf;
     }
-    //printf("[Playback] Wrote %u bytes\n",load);
-    // finally play the filled up buffer
+    uint32_t stat[6];
+    AVDM_getStats(stat);
+    UI_setVUMeter(stat);
     return true;
 }
 
@@ -306,7 +307,7 @@
 {
     uint32_t state,latency, preload;
     uint32_t small_;
-    uint32_t channels;
+    uint32_t channels,frequency;
 
     wavbuf = 0;
 
@@ -319,14 +320,20 @@
     if(!playbackAudio) return false;
 
     channels= playbackAudio->getInfo()->channels;
+    frequency=playbackAudio->getInfo()->frequency;
     preload=  (wavinfo->frequency * channels)/5;	// 200 ms preload
     // 4 sec buffer..               
     wavbuf =  (float *)  ADM_alloc((20*sizeof(float)*preload)); // 4 secs buffers
     ADM_assert(wavbuf);
+    // Read a at least one block to have the proper channel mapping
+    uint32_t fill=0;
+    AUD_Status status;
+    small_ = playbackAudio->fill(channels, wavbuf,&status);
+    fill+=small_;
     // Call it twice to be sure it is properly setup
-     state = AVDM_AudioSetup(playbackAudio->getInfo()->frequency,  channels );
+     state = AVDM_AudioSetup(frequency,  channels ,playbackAudio->getChannelMapping());
      AVDM_AudioClose();
-     state = AVDM_AudioSetup(playbackAudio->getInfo()->frequency,  channels );
+     state = AVDM_AudioSetup(frequency,  channels ,playbackAudio->getChannelMapping());
      latency=AVDM_GetLayencyMs();
      printf("[Playback] Latency : %d ms\n",latency);
       if (!state)
@@ -335,9 +342,6 @@
           cleanupAudio();
           return false;
       }
-     
-     AUD_Status status;
-    uint32_t fill=0;
     while(fill<preload)
     {
       if (!(small_ = playbackAudio->fill(preload-fill, wavbuf+fill,&status)))



From mean at mail.berlios.de  Tue Dec 22 16:30:28 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 16:30:28 +0100
Subject: [Avidemux-svn-commit] r5722 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI
Message-ID: <200912221530.nBMFUSR3024353@sheep.berlios.de>

Author: mean
Date: 2009-12-22 16:30:27 +0100 (Tue, 22 Dec 2009)
New Revision: 5722

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/GUI_ui.h
Log:
[ui] Prototype for vumeter

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/GUI_ui.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/GUI_ui.h	2009-12-22 15:30:24 UTC (rev 5721)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/GUI_ui.h	2009-12-22 15:30:27 UTC (rev 5722)
@@ -49,5 +49,8 @@
 uint8_t UI_arrow_disabled(void);
 
 void UI_refreshCustomMenu(void);
+
+bool UI_setVUMeter( uint32_t volume[6]); // Volume between 0 and 255.
+
 #endif
 // EOF



From mean at mail.berlios.de  Tue Dec 22 16:30:30 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 16:30:30 +0100
Subject: [Avidemux-svn-commit] r5723 - in
	branches/avidemux_2.6_branch_mean/avidemux_core:
	ADM_coreAudio/src ADM_coreAudioEncoder/src
Message-ID: <200912221530.nBMFUUHv024364@sheep.berlios.de>

Author: mean
Date: 2009-12-22 16:30:29 +0100 (Tue, 22 Dec 2009)
New Revision: 5723

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioUtils.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/src/audioencoder.cpp
Log:
[audio] Move reorderChannel to audioutils as it can be used by others beside audio encoder

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioUtils.cpp	2009-12-22 15:30:27 UTC (rev 5722)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioUtils.cpp	2009-12-22 15:30:29 UTC (rev 5723)
@@ -45,4 +45,47 @@
 		if (nr >= DITHER_SIZE)
 			nr = 0;
 	}
+}
+/**
+        \fn ADM_audioReorderChannels
+*/
+bool   ADM_audioReorderChannels(uint32_t channels,float *data, uint32_t nb,CHANNEL_TYPE *input,CHANNEL_TYPE *output)
+{
+
+    float tmp [channels];
+	static uint8_t reorder[MAX_CHANNELS];
+	static bool reorder_on;
+	
+	
+		reorder_on = 0;
+		int j = 0;
+        
+		// Should we reorder the channels (might be needed for encoder ?
+		if (channels > 2) 
+		{
+			CHANNEL_TYPE *p_ch_type;
+			for (int i = 0; i < channels; i++) 
+			{
+				for (int c = 0; c < channels; c++) 
+				{
+					if (input[c] == output[i]) 
+					{
+						if (j != c)
+							reorder_on = 1;
+						reorder[j++] = c;
+					}
+				}
+			}
+		}
+	
+
+	if (reorder_on)
+		for (int i = 0; i < nb; i++) 
+        {
+			memcpy(tmp, data, sizeof(tmp));
+			for (int c = 0; c < channels; c++)
+				*data++ = tmp[reorder[c]];
+		}
+
+    return true;
 }
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/src/audioencoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/src/audioencoder.cpp	2009-12-22 15:30:27 UTC (rev 5722)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/src/audioencoder.cpp	2009-12-22 15:30:29 UTC (rev 5723)
@@ -19,6 +19,9 @@
 #include "ADM_audioFilter.h"
 #include "audioencoder.h"
 #include "ADM_audioCodecEnum.h"
+
+extern bool   ADM_audioReorderChannels(uint32_t channels,float *data, uint32_t nb,CHANNEL_TYPE *input,CHANNEL_TYPE *output);
+
 /**
 
 */
@@ -93,43 +96,7 @@
 bool   ADM_AudioEncoder::reorderChannels(float *data, uint32_t nb,CHANNEL_TYPE *input,CHANNEL_TYPE *output)
 {
 int channels=wavheader.channels;
-
-    float tmp [channels];
-	static uint8_t reorder[MAX_CHANNELS];
-	static bool reorder_on;
-	
-	
-		reorder_on = 0;
-		int j = 0;
-        
-		// Should we reorder the channels (might be needed for encoder ?
-		if (channels > 2) 
-		{
-			CHANNEL_TYPE *p_ch_type;
-			for (int i = 0; i < channels; i++) 
-			{
-				for (int c = 0; c < channels; c++) 
-				{
-					if (input[c] == output[i]) 
-					{
-						if (j != c)
-							reorder_on = 1;
-						reorder[j++] = c;
-					}
-				}
-			}
-		}
-	
-
-	if (reorder_on)
-		for (int i = 0; i < nb; i++) 
-        {
-			memcpy(tmp, data, sizeof(tmp));
-			for (int c = 0; c < channels; c++)
-				*data++ = tmp[reorder[c]];
-		}
-
-    return true;
+       return ADM_audioReorderChannels(channels,data,nb,input,output);
 }
 
 //EOF



From mean at mail.berlios.de  Tue Dec 22 16:30:32 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 16:30:32 +0100
Subject: [Avidemux-svn-commit] r5724 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad
Message-ID: <200912221530.nBMFUWFJ024379@sheep.berlios.de>

Author: mean
Date: 2009-12-22 16:30:31 +0100 (Tue, 22 Dec 2009)
New Revision: 5724

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp
Log:
[faad] More detailed audio channel mapping, probably useless as it applies to mono and stereo

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp	2009-12-22 15:30:29 UTC (rev 5723)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp	2009-12-22 15:30:31 UTC (rev 5724)
@@ -96,14 +96,24 @@
 			printf("No conf header, will try to init later\n");
 
 		}
+        // Give our channel configuration
+        switch(info->channels)
+        {
+            case 1: channelMapping[0] = ADM_CH_FRONT_CENTER;
+                    break;
+            case 2: channelMapping[0] = ADM_CH_FRONT_LEFT;
+                    channelMapping[1] = ADM_CH_FRONT_RIGHT;
+                    break;
+            default:
+                channelMapping[0] = ADM_CH_FRONT_CENTER;
+                channelMapping[1] = ADM_CH_FRONT_LEFT;
+                channelMapping[2] = ADM_CH_FRONT_RIGHT;
+                channelMapping[3] = ADM_CH_REAR_LEFT;
+                channelMapping[4] = ADM_CH_REAR_RIGHT;
+                channelMapping[5] = ADM_CH_LFE;
+                break;
+        }
 
-		channelMapping[0] = ADM_CH_FRONT_CENTER;
-		channelMapping[1] = ADM_CH_FRONT_LEFT;
-		channelMapping[2] = ADM_CH_FRONT_RIGHT;
-		channelMapping[3] = ADM_CH_REAR_LEFT;
-		channelMapping[4] = ADM_CH_REAR_RIGHT;
-		channelMapping[5] = ADM_CH_LFE;
-
 		printf("[FAAD]Faad decoder created\n");
 }
 



From mean at mail.berlios.de  Tue Dec 22 21:07:05 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 21:07:05 +0100
Subject: [Avidemux-svn-commit] r5725 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src
Message-ID: <200912222007.nBMK75vm000126@sheep.berlios.de>

Author: mean
Date: 2009-12-22 21:07:05 +0100 (Tue, 22 Dec 2009)
New Revision: 5725

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_bridge.cpp
Log:
[audiobridge] silence end of stream error

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_bridge.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_bridge.cpp	2009-12-22 15:30:31 UTC (rev 5724)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_bridge.cpp	2009-12-22 20:07:05 UTC (rev 5725)
@@ -108,7 +108,7 @@
   _head+=available;
   if(!available)
   {
-    printf("[bridge] No data in %u max %u out %u\n",_tail-_head,max,available);
+    //printf("[bridge] No data in %u max %u out %u\n",_tail-_head,max,available);
   }
   return available;
 
@@ -120,6 +120,7 @@
 {
   uint32_t asked,got;
   uint64_t dts;
+  static bool endMet=false;
   *status=AUD_OK;
   // Hysteresis
   if((_tail-_head)<(AUD_PROCESS_BUFFER_SIZE>>2)) // Less than 1/4 full
@@ -145,9 +146,13 @@
       if (!got )
       {
         *status=AUD_END_OF_STREAM;
-        printf("[Bridge] End of stream\n");
+        if(endMet==false) ADM_warning("[Bridge] End of stream\n");
+        endMet=true;
+    
+    
         break;
       }
+      endMet=false;
       _tail+=got;
       if(_hold>0)
       {



From mean at mail.berlios.de  Tue Dec 22 21:07:07 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 21:07:07 +0100
Subject: [Avidemux-svn-commit] r5726 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd
Message-ID: <200912222007.nBMK77am000136@sheep.berlios.de>

Author: mean
Date: 2009-12-22 21:07:07 +0100 (Tue, 22 Dec 2009)
New Revision: 5726

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd/ADM_deviceEsd.cpp
Log:
[esd] Esd does not support more than 2 channels

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd/ADM_deviceEsd.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd/ADM_deviceEsd.cpp	2009-12-22 20:07:05 UTC (rev 5725)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/Esd/ADM_deviceEsd.cpp	2009-12-22 20:07:07 UTC (rev 5726)
@@ -62,7 +62,11 @@
 
 latency=0;
 esd_server_info_t *esdInfo;
-
+    if(_channels>2) 
+    {
+        ADM_warning("Esd does not support more than 2 channels apparently");
+        return false;
+    }
     esdServer=	esd_open_sound(NULL);
     if(esdServer>=0)
     {
@@ -74,9 +78,7 @@
 
 
     format=ESD_STREAM | ESD_PLAY | ESD_BITS16;
-    if(_channels==1) format|=ESD_MONO;
-        else format|=ESD_STEREO;
-
+    format |=_channels<<4;
     printf("[ESD]  : %"LU" Hz, %"LU" channels\n", _frequency, _channels);
     esdDevice=esd_play_stream(format,_frequency,NULL,"avidemux");
     if(esdDevice<=0)



From mean at mail.berlios.de  Tue Dec 22 21:07:10 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 21:07:10 +0100
Subject: [Avidemux-svn-commit] r5728 - in branches/avidemux_2.6_branch_mean:
	avidemux/common/ADM_codecs avidemux_core/ADM_ffmpeg/ffmpeg_config
Message-ID: <200912222007.nBMK7ASc000156@sheep.berlios.de>

Author: mean
Date: 2009-12-22 21:07:10 +0100 (Tue, 22 Dec 2009)
New Revision: 5728

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs/ADM_ffmp43.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs/ADM_ffmp43.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c
Log:
[ff] Add SVQ1 codec (not working, it outputs yv410 apparently

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs/ADM_ffmp43.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs/ADM_ffmp43.cpp	2009-12-22 20:07:08 UTC (rev 5727)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs/ADM_ffmp43.cpp	2009-12-22 20:07:10 UTC (rev 5728)
@@ -734,6 +734,12 @@
   WRAP_Open (CODEC_ID_VP6A);
 }
 
+//*************
+decoderFFSVQ1::decoderFFSVQ1 (uint32_t w, uint32_t h, uint32_t l, uint8_t * d):decoderFF (w,	   h)
+{
+  WRAP_Open (CODEC_ID_SVQ1);
+}
+
 //************
 decoderFFFLV1::decoderFFFLV1 (uint32_t w, uint32_t h, uint32_t l, uint8_t * d):decoderFF (w,	   h)
 {

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs/ADM_ffmp43.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs/ADM_ffmp43.h	2009-12-22 20:07:08 UTC (rev 5727)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs/ADM_ffmp43.h	2009-12-22 20:07:10 UTC (rev 5728)
@@ -352,6 +352,12 @@
 public:
   decoderFFMjpegB (uint32_t w, uint32_t h, uint32_t l, uint8_t * d);
 };
+class decoderFFSVQ1:public decoderFF
+{
+protected:
+public:
+  decoderFFSVQ1 (uint32_t w, uint32_t h, uint32_t l, uint8_t * d);
+};
 
 #ifdef USE_VDPAU
 class decoderFFVDPAU:public decoderFF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h	2009-12-22 20:07:08 UTC (rev 5727)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h	2009-12-22 20:07:10 UTC (rev 5728)
@@ -13,6 +13,7 @@
 #define CONFIG_MPEG1_VDPAU_DECODER 0
 #define CONFIG_VC1_VDPAU_DECODER 0
 #define CONFIG_WMV3_VDPAU_DECODER 0
+#define CONFIG_SVQ1_DECODER 1
 #define CONFIG_AAC_DECODER 1
 #define CONFIG_MPEG4AAC_DECODER 1
 #define CONFIG_DCA_DECODER 1
@@ -199,7 +200,6 @@
 #define CONFIG_RAWVIDEO_DECODER 0
 #define CONFIG_ROQ_DECODER 0
 #define CONFIG_SGI_DECODER 0
-#define CONFIG_SVQ1_DECODER 0
 #define CONFIG_TARGA_DECODER 0
 #define CONFIG_TIFF_DECODER 0
 #define CONFIG_ZLIB_DECODER 0

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c	2009-12-22 20:07:08 UTC (rev 5727)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c	2009-12-22 20:07:10 UTC (rev 5728)
@@ -35,6 +35,7 @@
 
 #define DECLARE_DECODER(a,b); printf("#define CONFIG_"#a"_DECODER 1\n");
   
+    DECLARE_DECODER (SVQ1, svq1);
     DECLARE_DECODER(AAC, eatgq);
     DECLARE_DECODER(MPEG4AAC, mpeg4aac);
     DECLARE_DECODER(DCA, dca);
@@ -233,7 +234,6 @@
     DECLARE_DECODER (RAWVIDEO, rawvideo);
     DECLARE_DECODER (ROQ, roq);
     DECLARE_DECODER (SGI, sgi);
-    DECLARE_DECODER (SVQ1, svq1);
     DECLARE_DECODER (TARGA, targa);
     DECLARE_DECODER (TIFF, tiff);
     DECLARE_DECODER (ZLIB, zlib);



From mean at mail.berlios.de  Tue Dec 22 21:07:08 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 21:07:08 +0100
Subject: [Avidemux-svn-commit] r5727 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs
Message-ID: <200912222007.nBMK78U7000146@sheep.berlios.de>

Author: mean
Date: 2009-12-22 21:07:08 +0100 (Tue, 22 Dec 2009)
New Revision: 5727

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs/ADM_codecs.cpp
Log:
[ff] Add SVQ1 codec (not working, it outputs yv410 apparently

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs/ADM_codecs.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs/ADM_codecs.cpp	2009-12-22 20:07:07 UTC (rev 5726)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_codecs/ADM_codecs.cpp	2009-12-22 20:07:08 UTC (rev 5727)
@@ -151,6 +151,12 @@
 
       return (decoders *) (new decoderFF_ffhuff (w, h, extraLen, extraData,bpp));
     }
+if (fourCC::check (fcc, (uint8_t *) "SVQ1"))
+    {
+
+      return (decoders *) (new decoderFFSVQ1 (w, h, extraLen, extraData));
+    }
+
   if (fourCC::check (fcc, (uint8_t *) "SVQ3"))
     {
 



From mean at mail.berlios.de  Tue Dec 22 21:07:13 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 21:07:13 +0100
Subject: [Avidemux-svn-commit] r5730 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4
Message-ID: <200912222007.nBMK7DDY000184@sheep.berlios.de>

Author: mean
Date: 2009-12-22 21:07:13 +0100 (Tue, 22 Dec 2009)
New Revision: 5730

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp
Log:
[MP4] Add svq1 codec from stsd

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp	2009-12-22 20:07:11 UTC (rev 5729)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Analyzer.cpp	2009-12-22 20:07:13 UTC (rev 5730)
@@ -589,6 +589,13 @@
                                         commonPart(MJPB);
                                         left=0;
                                   }
+                                  case MKFCCR('S','V','Q','1'):  //mjpegb
+                                 {
+                                       commonPart(SVQ1);
+                                       left=0;
+                                 }
+                                  break;
+
                                   case MKFCCR('m','j','p','a'):  //mjpegb
                                  {
                                        commonPart(MJPG);



From mean at mail.berlios.de  Tue Dec 22 21:07:15 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 21:07:15 +0100
Subject: [Avidemux-svn-commit] r5731 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <200912222007.nBMK7FZe000206@sheep.berlios.de>

Author: mean
Date: 2009-12-22 21:07:15 +0100 (Tue, 22 Dec 2009)
New Revision: 5731

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
Log:
[Play] Factorize vumeter to update is as soon as possible

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2009-12-22 20:07:13 UTC (rev 5730)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2009-12-22 20:07:15 UTC (rev 5731)
@@ -53,6 +53,7 @@
         uint32_t        nbSamplesSent ;        
         float           *wavbuf ;
         uint64_t        firstPts,lastPts;
+        uint64_t        vuMeterPts;
 
 private : 
         bool initialized;
@@ -60,6 +61,7 @@
         bool cleanup(void);
         bool audioPump(void);
         bool cleanupAudio(void);
+        bool updateVu(void);
 public:
         bool run(void);
         bool initialize(void);
@@ -198,6 +200,7 @@
     uint32_t systemTime;
     int refreshCounter=0;
     ticktock.reset();
+    vuMeterPts=0;
     do
     {
         
@@ -271,30 +274,32 @@
     uint32_t load = 0;
 	uint8_t channels;
 	uint32_t fq;
+    static bool errorMet=false;
 
     if (!playbackAudio)	    return false;
 
   
     channels= playbackAudio->getInfo()->channels;
     fq=playbackAudio->getInfo()->frequency;  
+    uint32_t slice=(fq * channels)/50; // 20 ms
 
-
      while(AVDM_getMsFullness() < AUDIO_PRELOAD)
       {
 
              AUD_Status status;
-             if (! (oaf = playbackAudio->fill(256*16,  wavbuf,&status)))
+             if (! (oaf = playbackAudio->fill(fq,  wavbuf,&status)))
              {
-                  printf("[Playback] Error reading audio stream...\n");
+                  if(errorMet==false)
+                    ADM_warning("[Playback] Error reading audio stream...\n");
+                  errorMet=true;
                   break;
              }
+            errorMet=false;
             AVDM_AudioPlay(wavbuf, oaf);
             nbSamplesSent += oaf/channels;
             load+=oaf;
     }
-    uint32_t stat[6];
-    AVDM_getStats(stat);
-    UI_setVUMeter(stat);
+    updateVu();
     return true;
 }
 
@@ -356,6 +361,7 @@
     ticktock.reset();
     uint32_t slice=(wavinfo->frequency * channels)/100; // 10 ms
     // pump data until latency is over
+    updateVu();
     while(ticktock.getElapsedMS()<latency)
     {
         if(AVDM_getMsFullness()<AUDIO_PRELOAD)
@@ -368,9 +374,26 @@
           AVDM_AudioPlay(wavbuf, slice);
         }
        ADM_usleep(10*1000);
+       updateVu();
     }
     printf("[Playback] Latency is now %u\n",ticktock.getElapsedMS());
     return true;
 }
+/**
+    \fn updateVu
+*/
+bool GUIPlayback::updateVu(void)
+{
+ uint64_t time=  ticktock.getElapsedMS();
+    // Refresh vumeter every 50 ms
+    
+    if(time>(vuMeterPts+50))
+    {
+        uint32_t stat[6];
+        AVDM_getStats(stat);
+        UI_setVUMeter(stat);
+        vuMeterPts=time;
+    }
 
+}
 // EOF



From mean at mail.berlios.de  Tue Dec 22 21:07:12 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 22 Dec 2009 21:07:12 +0100
Subject: [Avidemux-svn-commit] r5729 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src
Message-ID: <200912222007.nBMK7C9w000166@sheep.berlios.de>

Author: mean
Date: 2009-12-22 21:07:11 +0100 (Tue, 22 Dec 2009)
New Revision: 5729

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp
Log:
[vustats] Change display channel order + slight optimization

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp	2009-12-22 20:07:10 UTC (rev 5728)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp	2009-12-22 20:07:11 UTC (rev 5729)
@@ -229,12 +229,19 @@
     }
     // Move channels around so that they fit Left/Right/Center/Rear Left, Rear Right,LFE
     const CHANNEL_TYPE *chans=this->getWantedChannelMapping(_channels);
-    static const CHANNEL_TYPE output[6]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_RIGHT,ADM_CH_FRONT_CENTER,ADM_CH_REAR_LEFT,ADM_CH_REAR_RIGHT,ADM_CH_LFE};
-    for(int i=0;i<_channels;i++)
+    static const CHANNEL_TYPE output[6]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_CENTER,ADM_CH_FRONT_RIGHT,
+                                         ADM_CH_REAR_LEFT,ADM_CH_REAR_RIGHT,ADM_CH_LFE};
+    for(int i=0;i<6;i++)
     {
         CHANNEL_TYPE wanted=output[i];
         for(int j=0;j<_channels;j++)
-            if(chans[j]==wanted) vol[i]=raw[j];
+        {
+            if(chans[j]==wanted) 
+            {
+                vol[i]=raw[j];
+                break;
+            }
+        }
     }
     return true;
     



From mean at mail.berlios.de  Wed Dec 23 10:25:46 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 23 Dec 2009 10:25:46 +0100
Subject: [Avidemux-svn-commit] r5732 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui
Message-ID: <200912230925.nBN9PkPH003036@sheep.berlios.de>

Author: mean
Date: 2009-12-23 10:25:45 +0100 (Wed, 23 Dec 2009)
New Revision: 5732

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_vumeter.cpp
Log:
[vumeter] Fix display

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_vumeter.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_vumeter.cpp	2009-12-22 20:07:15 UTC (rev 5731)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_vumeter.cpp	2009-12-23 09:25:45 UTC (rev 5732)
@@ -83,7 +83,7 @@
       {
             int vol=volume[i];
             if(vol>63) vol=63;
-            if(vol<5) vol=5;
+            if(vol<3) vol=3;
             uint8_t *ptr=rgbDataBuffer+vuWidth*(2+10*i)*4;
             uint32_t *data=(uint32_t *)(ptr);
             for(int j=0;j<vol;j++)
@@ -93,12 +93,15 @@
                 if(j<50) *data++=YELLOW;
                 else *data++=RED;
             }
-            for(int j=vol;j<128;j++)
+            for(int j=vol;j<64;j++)
             {
                 *data++=0;
             }
       }
-     // ADM_info("VU : %"LU" %"LU" %"LU"\n",volume[0],volume[1],volume[2]);
+#if 0
+      ADM_info("VU : LEFT %"LU" CENTER %"LU" RIGHT %"LU" REARLEFT %"LU" REARRIGHT %"LU"\n",
+                    volume[0],volume[1],volume[2],volume[3],volume[4]);
+#endif
       vuWidget->repaint();
       return true;
 }



From mean at mail.berlios.de  Wed Dec 23 10:25:48 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 23 Dec 2009 10:25:48 +0100
Subject: [Avidemux-svn-commit] r5733 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <200912230925.nBN9PmfS003046@sheep.berlios.de>

Author: mean
Date: 2009-12-23 10:25:48 +0100 (Wed, 23 Dec 2009)
New Revision: 5733

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
Log:
[playback] Tweak audio handling

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2009-12-23 09:25:45 UTC (rev 5732)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2009-12-23 09:25:48 UTC (rev 5733)
@@ -59,7 +59,7 @@
         bool initialized;
         bool initializeAudio();
         bool cleanup(void);
-        bool audioPump(void);
+        bool audioPump(bool wait);
         bool cleanupAudio(void);
         bool updateVu(void);
 public:
@@ -239,9 +239,9 @@
                 {
                     if(delta>10)
                     {
-                        GUI_Sleep(10);
-                        audioPump();
-                    }
+                        audioPump(true);
+                    }else   
+                        audioPump(false);
                     
                     UI_purge();
                     refreshCounter=0;
@@ -268,7 +268,7 @@
     \brief send ~ worth of one video frame of audio
 */
 
-bool  GUIPlayback::audioPump(void)
+bool  GUIPlayback::audioPump(bool wait)
 {
     uint32_t oaf = 0;
     uint32_t load = 0;
@@ -282,6 +282,12 @@
     channels= playbackAudio->getInfo()->channels;
     fq=playbackAudio->getInfo()->frequency;  
     uint32_t slice=(fq * channels)/50; // 20 ms
+    if(AVDM_getMsFullness() >= AUDIO_PRELOAD)
+    {
+        if(wait==true) GUI_Sleep(10);
+        updateVu();
+        return true;
+    }
 
      while(AVDM_getMsFullness() < AUDIO_PRELOAD)
       {



From gruntster at mail.berlios.de  Wed Dec 23 21:00:27 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 23 Dec 2009 21:00:27 +0100
Subject: [Avidemux-svn-commit] r5734 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs
Message-ID: <200912232000.nBNK0RQr017167@sheep.berlios.de>

Author: gruntster
Date: 2009-12-23 21:00:22 +0100 (Wed, 23 Dec 2009)
New Revision: 5734

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_codecNull.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_codecs.cpp
Log:
[i420] support I420 video

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_codecNull.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_codecNull.h	2009-12-23 09:25:48 UTC (rev 5733)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_codecNull.h	2009-12-23 20:00:22 UTC (rev 5734)
@@ -31,3 +31,19 @@
     return 1;
   }
 };
+
+class decoderI420 : public decoders
+{
+public:
+	decoderI420(uint32_t w, uint32_t h) : decoders(w, h) {}
+	virtual ~decoderI420() {}
+
+	virtual uint8_t uncompress(ADMCompressedImage *in, ADMImage *out)
+	{
+		memcpy(YPLANE(out), in->data, _w * _h);
+		memcpy(UPLANE(out), in->data + (5 * (_w * _h) >> 2), (_w * _h) >> 2);
+		memcpy(VPLANE(out), in->data + (_w * _h), (_w * _h) >> 2);
+
+		return 1;
+	}
+};

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_codecs.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_codecs.cpp	2009-12-23 09:25:48 UTC (rev 5733)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_codecs.cpp	2009-12-23 20:00:22 UTC (rev 5734)
@@ -355,12 +355,16 @@
 #endif
 
     }
-  if (fourCC::check (fcc, (uint8_t *) "YV12")
-      || fourCC::check (fcc, (uint8_t *) "I420"))
+  if (fourCC::check (fcc, (uint8_t *) "YV12"))
     {
       printf ("\n using null codec\n");
       return (decoders *) (new decoderNull (w, h));
     }
+  if (fourCC::check (fcc, (uint8_t *) "I420"))
+  {
+	  printf ("\n using I420 codec\n");
+	  return (decoders *) (new decoderI420(w, h));
+  }
   if (fourCC::check (fcc, (uint8_t *) "UYVY"))
     {
       printf ("\n using uyvy codec\n");



From gruntster at mail.berlios.de  Wed Dec 23 21:07:05 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 23 Dec 2009 21:07:05 +0100
Subject: [Avidemux-svn-commit] r5735 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264
Message-ID: <200912232007.nBNK75x6017720@sheep.berlios.de>

Author: gruntster
Date: 2009-12-23 21:07:00 +0100 (Wed, 23 Dec 2009)
New Revision: 5735

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
Log:
[x264] fix handling of bFrameReferences with earlier versions of x264

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2009-12-23 20:00:22 UTC (rev 5734)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2009-12-23 20:07:00 UTC (rev 5735)
@@ -1460,7 +1460,7 @@
 
 				if (strcmp(content, "strict") == 0)
 					bFrameReferences = 1;
-				else if (strcmp(content, "normal") == 0 || strcmp(content, "1") == 0)
+				else if (strcmp(content, "normal") == 0 || strcmp(content, "1") == 0 || strcmp(content, "true") == 0)
 #if X264_BUILD >= 78
 					bFrameReferences = 2;
 #else

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2009-12-23 20:00:22 UTC (rev 5734)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2009-12-23 20:07:00 UTC (rev 5735)
@@ -221,6 +221,8 @@
                     <!-- boolean values deprecated core 78 -->
                     <xs:enumeration value="0"/>
                     <xs:enumeration value="1"/>
+                    <xs:enumeration value="false"/>
+                    <xs:enumeration value="true"/>
                   </xs:restriction>
                 </xs:simpleType>
               </xs:element>



From mean at mail.berlios.de  Sun Dec 27 18:34:41 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 27 Dec 2009 18:34:41 +0100
Subject: [Avidemux-svn-commit] r5736 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src
Message-ID: <200912271734.nBRHYfmS031812@sheep.berlios.de>

Author: mean
Date: 2009-12-27 18:34:34 +0100 (Sun, 27 Dec 2009)
New Revision: 5736

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp
Log:
[audioDevice] Wait for the device to be destroyed before releasing buffers

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp	2009-12-23 20:07:00 UTC (rev 5735)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp	2009-12-27 17:34:34 UTC (rev 5736)
@@ -83,8 +83,8 @@
     // Spawn
     stopRequest=AUDIO_DEVICE_STARTED;
     ADM_assert(!pthread_create(&myThread,NULL,bouncer,this));
-    
 
+
     return 1;
 }
 /**
@@ -106,12 +106,8 @@
 */
 uint8_t audioDeviceThreaded::stop()
 {
-    if(audioBuffer)
-    {
-        delete [] audioBuffer;
-        audioBuffer=NULL;
-    }
 
+
     if(stopRequest==AUDIO_DEVICE_STARTED)
     {
         stopRequest=AUDIO_DEVICE_STOP_REQ;
@@ -120,7 +116,13 @@
             ADM_usleep(1000);
         }
     }
+
     localStop();
+    if(audioBuffer)
+    {
+        delete [] audioBuffer;
+        audioBuffer=NULL;
+    }
     if(silence) delete [] silence;
     silence=NULL;
     stopRequest=AUDIO_DEVICE_STOPPED;
@@ -146,7 +148,7 @@
         mutex.unlock();
         return false;
     }
-    
+
     memcpy(audioBuffer+wrIndex,data,lenInByte);
     // Reorder channels if needed...
     uint32_t samples=lenInByte;
@@ -204,7 +206,7 @@
     if(samples*_channels*2 > (wrIndex-rdIndex))
             samples=(wrIndex-rdIndex)/(2*_channels);
     for(int i=0;i<6;i++) f[i]=0;
-    if(!samples) 
+    if(!samples)
     {
         mutex.unlock();
         return true;
@@ -215,7 +217,7 @@
         for(int chan=0;chan<_channels;chan++)
         {
                 f[chan]+=abs(*base++);
-                
+
         }
     mutex.unlock();
     // Normalize
@@ -236,7 +238,7 @@
         CHANNEL_TYPE wanted=output[i];
         for(int j=0;j<_channels;j++)
         {
-            if(chans[j]==wanted) 
+            if(chans[j]==wanted)
             {
                 vol[i]=raw[j];
                 break;
@@ -244,6 +246,6 @@
         }
     }
     return true;
-    
+
 }
 //**



From mean at mail.berlios.de  Sun Dec 27 18:36:09 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 27 Dec 2009 18:36:09 +0100
Subject: [Avidemux-svn-commit] r5737 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <200912271736.nBRHa94t000389@sheep.berlios.de>

Author: mean
Date: 2009-12-27 18:36:08 +0100 (Sun, 27 Dec 2009)
New Revision: 5737

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
Log:
[playback] Handle audio latency differently

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2009-12-27 17:34:34 UTC (rev 5736)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2009-12-27 17:36:08 UTC (rev 5737)
@@ -2,7 +2,7 @@
 /***************************************************************************
     \file  gui_play.cpp
 	\brief Playback loop
-    
+
     copyright            : (C) 2001/2009 by mean
     email                : fixounet at free.fr
  ***************************************************************************/
@@ -15,7 +15,7 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#include "ADM_default.h" 
+#include "ADM_default.h"
 #include <math.h>
 #include "prefs.h"
 #include "avi_vars.h"
@@ -44,18 +44,19 @@
 /**
     \class GUIPlayback
     \brief Wrapper for the playback stuff
-*/  
+*/
 class GUIPlayback
 {
 private:
         AUDMAudioFilter *playbackAudio;
         Clock           ticktock;
-        uint32_t        nbSamplesSent ;        
+        uint32_t        nbSamplesSent ;
         float           *wavbuf ;
         uint64_t        firstPts,lastPts;
         uint64_t        vuMeterPts;
+        uint64_t        audioLatency;
 
-private : 
+private :
         bool initialized;
         bool initializeAudio();
         bool cleanup(void);
@@ -92,15 +93,15 @@
 */
 void GUI_PlayAvi(void)
 {
-    
+
     uint32_t framelen,flags;
     uint32_t max,err;
     uint64_t oldTimeFrame;
-   
+
     // check we got everything...
     if (!avifileinfo)	return;
     if (!avifileinfo->fps1000)        return;
-    
+
     if (playing)
       {
         stop_req = 1;
@@ -112,7 +113,7 @@
 	originalPriority = getpriority(PRIO_PROCESS, 0);
 	prefs->get(PRIORITY_PLAYBACK,&priorityLevel);
 	setpriority(PRIO_PROCESS, 0, ADM_getNiceValue(priorityLevel));
-    
+
     if(getPreviewMode()==ADM_PREVIEW_OUTPUT)
     {
 //            filter=getLastVideoFilter();
@@ -121,7 +122,7 @@
     {
   //          filter=getFirstVideoFilter( );
     }
-    
+
     stop_req = 0;
     playing = 1;
 
@@ -131,23 +132,23 @@
     GUIPlayback *playLoop=new GUIPlayback;
     playLoop->initialize();
     playLoop->run();
-    
+
     delete playLoop;
    playing = 0;
-            
+
 //   getFirstVideoFilter( );
 
    admPreview::deferDisplay(0,0);
-   
-   
+
+
    UI_purge();
 #warning FIXME
 //   admPreview::seekToFrame(oldTimeFrame);
    admPreview::samePicture();
    GUI_setCurrentFrameAndTime();
    UI_purge();
-      
 
+
 }
 /**
     \fn cleanupAudio
@@ -157,9 +158,9 @@
       if (wavbuf)
               ADM_dealloc(wavbuf);
           wavbuf=NULL;
-    
+
       AVDM_AudioClose();
-      
+
       if (playbackAudio)
        {
             destroyPlaybackFilter();
@@ -195,7 +196,7 @@
 
 bool GUIPlayback::run(void)
 {
-   
+
     uint32_t movieTime;
     uint32_t systemTime;
     int refreshCounter=0;
@@ -203,18 +204,19 @@
     vuMeterPts=0;
     do
     {
-        
+
         admPreview::displayNow();;
         GUI_setCurrentFrameAndTime();
-        if(false==admPreview::nextPicture()) 
+        if(false==admPreview::nextPicture())
         {
             printf("[Play] Cancelling playback, nextPicture failed\n");
             break;
         }
-        audioPump();
+        audioPump(false);
         lastPts=admPreview::getCurrentPts();
         systemTime = ticktock.getElapsedMS();
         movieTime=(uint32_t)((lastPts-firstPts)/1000);
+        movieTime+=audioLatency;
        // printf("[Playback] systemTime: %lu movieTime : %lu  \r",systemTime,movieTime);
         if(systemTime>movieTime) // We are late, the current PTS is after current closk
         {
@@ -234,25 +236,25 @@
             int32_t delta;
                 delta=movieTime-systemTime;
                 // a call to whatever sleep function will last at leat 10 ms
-                // give some time to GTK                		
+                // give some time to GTK
                 while(delta > 10)
                 {
                     if(delta>10)
                     {
                         audioPump(true);
-                    }else   
+                    }else
                         audioPump(false);
-                    
+
                     UI_purge();
                     refreshCounter=0;
                     systemTime = ticktock.getElapsedMS();
-                    delta=movieTime-systemTime;                
+                    delta=movieTime-systemTime;
                 }
-                
+
                 if(getPreviewMode()==ADM_PREVIEW_SEPARATE )
                 {
                   UI_purge();
-                  UI_purge(); 
+                  UI_purge();
                   refreshCounter=0;
                 }
         }
@@ -278,9 +280,9 @@
 
     if (!playbackAudio)	    return false;
 
-  
+
     channels= playbackAudio->getInfo()->channels;
-    fq=playbackAudio->getInfo()->frequency;  
+    fq=playbackAudio->getInfo()->frequency;
     uint32_t slice=(fq * channels)/50; // 20 ms
     if(AVDM_getMsFullness() >= AUDIO_PRELOAD)
     {
@@ -323,7 +325,7 @@
     wavbuf = 0;
 
 //    if (!currentaudiostream)	  return;
-    
+
     double db;
     uint64_t startPts=firstPts;
 
@@ -333,7 +335,7 @@
     channels= playbackAudio->getInfo()->channels;
     frequency=playbackAudio->getInfo()->frequency;
     preload=  (wavinfo->frequency * channels)/5;	// 200 ms preload
-    // 4 sec buffer..               
+    // 4 sec buffer..
     wavbuf =  (float *)  ADM_alloc((20*sizeof(float)*preload)); // 4 secs buffers
     ADM_assert(wavbuf);
     // Read a at least one block to have the proper channel mapping
@@ -347,6 +349,7 @@
      state = AVDM_AudioSetup(frequency,  channels ,playbackAudio->getChannelMapping());
      latency=AVDM_GetLayencyMs();
      printf("[Playback] Latency : %d ms\n",latency);
+     audioLatency=latency; // ms -> us
       if (!state)
       {
           GUI_Error_HIG(QT_TR_NOOP("Trouble initializing audio device"), NULL);
@@ -368,6 +371,7 @@
     uint32_t slice=(wavinfo->frequency * channels)/100; // 10 ms
     // pump data until latency is over
     updateVu();
+    #if 0
     while(ticktock.getElapsedMS()<latency)
     {
         if(AVDM_getMsFullness()<AUDIO_PRELOAD)
@@ -382,6 +386,7 @@
        ADM_usleep(10*1000);
        updateVu();
     }
+    #endif
     printf("[Playback] Latency is now %u\n",ticktock.getElapsedMS());
     return true;
 }
@@ -392,7 +397,7 @@
 {
  uint64_t time=  ticktock.getElapsedMS();
     // Refresh vumeter every 50 ms
-    
+
     if(time>(vuMeterPts+50))
     {
         uint32_t stat[6];



From mean at mail.berlios.de  Sun Dec 27 18:36:11 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 27 Dec 2009 18:36:11 +0100
Subject: [Avidemux-svn-commit] r5738 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <200912271736.nBRHaBL6000400@sheep.berlios.de>

Author: mean
Date: 2009-12-27 18:36:11 +0100 (Sun, 27 Dec 2009)
New Revision: 5738

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
Log:
[playback] Smaller audio refill while playback is on

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2009-12-27 17:36:08 UTC (rev 5737)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2009-12-27 17:36:11 UTC (rev 5738)
@@ -295,7 +295,7 @@
       {
 
              AUD_Status status;
-             if (! (oaf = playbackAudio->fill(fq,  wavbuf,&status)))
+             if (! (oaf = playbackAudio->fill(slice,  wavbuf,&status)))
              {
                   if(errorMet==false)
                     ADM_warning("[Playback] Error reading audio stream...\n");



From mean at mail.berlios.de  Sun Dec 27 18:36:13 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 27 Dec 2009 18:36:13 +0100
Subject: [Avidemux-svn-commit] r5739 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src
Message-ID: <200912271736.nBRHaDvN000410@sheep.berlios.de>

Author: mean
Date: 2009-12-27 18:36:13 +0100 (Sun, 27 Dec 2009)
New Revision: 5739

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp
Log:
[audioDevice] Correctly reorder channel, return number of 10ms blocks available, use root mean square for vumeter with a tiny window

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp	2009-12-27 17:36:11 UTC (rev 5738)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioDevice/src/ADM_audioDeviceThreaded.cpp	2009-12-27 17:36:13 UTC (rev 5739)
@@ -18,7 +18,7 @@
 #include "ADM_default.h"
 #include "ADM_audiodevice.h"
 #include "ADM_audioDeviceInternal.h"
-
+#include "math.h"
 /**
     \fn audioDeviceThreaded
     \brief constructor
@@ -89,7 +89,7 @@
 }
 /**
     \fn getBufferFullness
-    \brief Returns the number of ms of audio in the buffer
+    \brief Returns the number of 10 ms of audio in the buffer
 
 */
 uint32_t   audioDeviceThreaded:: getBufferFullness(void)
@@ -97,7 +97,7 @@
     mutex.lock();
     float nbBytes=wrIndex-rdIndex;
     mutex.unlock();
-    nbBytes/=10*sizeOf10ms;
+    nbBytes/=sizeOf10ms;
     return 1+(uint32_t)nbBytes;
 }
 /**
@@ -150,16 +150,7 @@
     }
 
     memcpy(audioBuffer+wrIndex,data,lenInByte);
-    // Reorder channels if needed...
-    uint32_t samples=lenInByte;
-    samples/=sizeof(float);
-    samples/=_channels;
-    ADM_audioReorderChannels(_channels,
-                    (float *)(audioBuffer+wrIndex),
-                    samples,
-                    incomingMapping,
-                    (CHANNEL_TYPE*)getWantedChannelMapping(_channels));
-    //
+   
     wrIndex+=lenInByte;
     mutex.unlock();
     return true;
@@ -186,8 +177,18 @@
 */
 uint8_t     audioDeviceThreaded::play(uint32_t len, float *data)
 {
+    // Reorder channels if needed...
+    uint32_t samples=len;
+    samples/=_channels;
+    ADM_audioReorderChannels(_channels,
+                    (float *)(data),
+                    samples,
+                    incomingMapping,
+                    (CHANNEL_TYPE*)getWantedChannelMapping(_channels));
+    // dither to int16_t
 	dither16(data, len, _channels);
     len*=2;
+    // Store in buffer
     return writeData((uint8_t *)data,len);
 
 }
@@ -200,8 +201,8 @@
     float f[6];
     uint32_t raw[6];
     memset(vol,0,sizeof(uint32_t)*6);
-    // 20 ms should be enough, i.e. fq/50
-    uint32_t samples=_frequency/50;
+    // 5 ms should be enough, i.e. fq/200
+    uint32_t samples=_frequency/200;
     mutex.lock();
     if(samples*_channels*2 > (wrIndex-rdIndex))
             samples=(wrIndex-rdIndex)/(2*_channels);
@@ -211,24 +212,33 @@
         mutex.unlock();
         return true;
     }
-
-    int16_t *base=(int16_t *)(rdIndex+audioBuffer);
+#define USE_MEAN_SQUARE
+    uint8_t *base8=rdIndex+audioBuffer;
+    int16_t *base=(int16_t *)(base8);
     for(int i=0;i<samples;i++)
         for(int chan=0;chan<_channels;chan++)
         {
-                f[chan]+=abs(*base++);
-
+#ifdef USE_MEAN_SQUARE
+                f[chan]+=base[0]*base[0];
+#else
+                f[chan]+=abs(*base);
+#endif
+                base++;
         }
     mutex.unlock();
     // Normalize
     for(int i=0;i<6;i++)
     {
         float d=f[i];
-        d/=samples;
-        d/=128;
-        if(d>127) d=127;
+        d/=samples; // d is now between 0 and 32768
+#ifdef USE_MEAN_SQUARE
+        d=sqrt(d);
+#endif
+        d/=128;     // D is now between 0 and 255
+        if(d>255) d=255;
         raw[i]=(uint32_t)d;
     }
+    
     // Move channels around so that they fit Left/Right/Center/Rear Left, Rear Right,LFE
     const CHANNEL_TYPE *chans=this->getWantedChannelMapping(_channels);
     static const CHANNEL_TYPE output[6]={ADM_CH_FRONT_LEFT,ADM_CH_FRONT_CENTER,ADM_CH_FRONT_RIGHT,
@@ -245,6 +255,10 @@
             }
         }
     }
+#if 0
+    #define zz vol
+    printf("[%d] %02d %02d %02d %02d %02d %02d\n",samples,zz[0],zz[1],zz[2],zz[3],zz[4],zz[5]);
+#endif
     return true;
 
 }



From mean at mail.berlios.de  Sun Dec 27 18:36:15 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 27 Dec 2009 18:36:15 +0100
Subject: [Avidemux-svn-commit] r5740 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_ac3
Message-ID: <200912271736.nBRHaFTS000423@sheep.berlios.de>

Author: mean
Date: 2009-12-27 18:36:14 +0100 (Sun, 27 Dec 2009)
New Revision: 5740

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_ac3/ADM_ad_a52.cpp
Log:
[A52] Use ADM_info, printf, duplicate the given wavheader (just in case)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_ac3/ADM_ad_a52.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_ac3/ADM_ad_a52.cpp	2009-12-27 17:36:13 UTC (rev 5739)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_ac3/ADM_ad_a52.cpp	2009-12-27 17:36:14 UTC (rev 5740)
@@ -29,7 +29,6 @@
 	protected:
 		void *ac3_handle;
 		void *ac3_sample;
-		uint32_t _downmix;
 
 	public:
 		ADM_AudiocodecAC3(uint32_t fourcc, WAVHeader *info,uint32_t extraLength,uint8_t *extraDatab);
@@ -54,6 +53,7 @@
 		:   ADM_Audiocodec(fourcc)
 {
     int flags=0;
+    _wavHeader = new WAVHeader;
     ADM_assert(fourcc==WAV_AC3);
     ac3_handle=NULL;
     ac3_sample=NULL;
@@ -67,18 +67,17 @@
     ac3_handle=(void *)a52_init(flags);
     if(!ac3_handle)
     {
-        printf("Cannot init a52\n");
+        ADM_error("Cannot init a52\n");
         ADM_assert(0);
     }
     ac3_sample=(sample_t *)a52_samples(AC3_HANDLE);
     if(!ac3_sample)
     {
-        printf("Cannot init a52 sample\n");
+        ADM_warning("Cannot init a52 sample\n");
         ADM_assert(0);
     }
-        _downmix=0;
-      _wavHeader = info;
-      ADM_assert(_wavHeader);
+      _wavHeader = new WAVHeader;
+      *_wavHeader=*info;
 }
 
 ADM_AudiocodecAC3::~ADM_AudiocodecAC3( )
@@ -89,6 +88,11 @@
         ac3_handle=NULL;
         ac3_sample=NULL;
     }
+    if( _wavHeader)
+    {
+        delete  _wavHeader;
+        _wavHeader=NULL;
+    }
 }
 
 uint8_t ADM_AudiocodecAC3::beginDecompress( void )
@@ -115,13 +119,13 @@
         if(nbIn<7)
         {
             if(nbIn)
-                printf("[a52]: no data to decode avail %u\n",nbIn);
+                ADM_warning("[a52]: no enough data to decode, available %"LU" bytes, need at least 7\n",nbIn);
             break;
         }
         length = a52_syncinfo(inptr, &flags, &samprate, &bitrate);
         if(length==0)
         {
-            printf("[a52] No startcode found\n");
+            ADM_warning("[a52] No startcode found\n");
             break;
         }
         if(length>nbIn)
@@ -182,7 +186,7 @@
 
         if (a52_frame(AC3_HANDLE, inptr, &flags, &level, bias))
         {
-            printf("\n A52_frame failed!");
+            ADM_warning(" A52_frame failed!\n");
             inptr+=length;
             nbIn-=length;
             *nbOut += 256 * chan * 6;
@@ -195,7 +199,7 @@
         float *cur;
         for (int i = 0; i < 6; i++) {
                 if (a52_block(AC3_HANDLE)) {
-                        printf("\n A52_block failed! on fblock :%"LU"", i);
+                        ADM_warning(" A52_block failed! on fblock :%d\n", i);
                         // in that case we silent out the chunk
                         memset(outptr, 0, 256 * chan * sizeof(float));
                 } else {



From mean at mail.berlios.de  Sun Dec 27 18:36:17 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 27 Dec 2009 18:36:17 +0100
Subject: [Avidemux-svn-commit] r5741 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple
Message-ID: <200912271736.nBRHaH6d000433@sheep.berlios.de>

Author: mean
Date: 2009-12-27 18:36:17 +0100 (Sun, 27 Dec 2009)
New Revision: 5741

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.cpp
Log:
[PulseAudoSimple] Use aburdely short buffer so that vumeter are correct (to be enlarged later)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.cpp	2009-12-27 17:36:14 UTC (rev 5740)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.cpp	2009-12-27 17:36:17 UTC (rev 5741)
@@ -44,7 +44,7 @@
 */
 uint32_t pulseSimpleAudioDevice::getLatencyMs(void)
 {
-   return 500; //latency;
+   return 20; //latency;
 }
 
 /**
@@ -78,14 +78,20 @@
 int er;
 pa_buffer_attr attr;
 
-    memset(&attr,0,sizeof(attr));
     attr.maxlength = (uint32_t) -1;
     attr.tlength = (uint32_t )-1;
     attr.prebuf =(uint32_t) -1;
     attr.minreq = (uint32_t) -1;
     attr.fragsize =(uint32_t) -1;
-  
+  // We want something like 20 ms latency
+   uint64_t bufSize=_frequency;
+            bufSize*=_channels;
+            bufSize*=2;      // 1 second worth of audio
 
+  attr.maxlength=bufSize/25; // 50 ms
+  attr.tlength=bufSize/50; //  20 ms
+  attr.prebuf=bufSize/100; // 10 ms
+
   ss.format = PA_SAMPLE_S16LE;
   ss.channels = _channels;
   ss.rate =_frequency;
@@ -97,12 +103,12 @@
                     "Sound",            // Description of our stream.
                     &ss,                // Our sample format.
                     NULL,               // Use default channel map
-                    NULL, //&attr ,             // Use default buffering attributes.
+                    &attr ,             // Use default buffering attributes.
                     &er               // Ignore error code.
                     );
   if(!instance)
     {
-        printf("[PulseSimple] open failed :%s\n",pa_strerror(er));
+        ADM_info("[PulseSimple] open failed :%s\n",pa_strerror(er));
         return 0;
     }
 #if 0
@@ -116,9 +122,9 @@
     }
     pa_simple_drain(INSTANCE,&er);
     latency=ticktock.getElapsedMS();
-    printf("[Pulse] Latency :%lu, total %lu\n",latency,pa_simple_get_latency(INSTANCE,&er)/1000);
+    ADM_info("[Pulse] Latency :%"LU", total %"LU"\n",latency,pa_simple_get_latency(INSTANCE,&er)/1000);
 #endif
-    printf("[PulseSimple] open ok\n");
+    ADM_info("[PulseSimple] open ok\n");
     return 1;
 
 }



From mean at mail.berlios.de  Mon Dec 28 07:39:14 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 28 Dec 2009 07:39:14 +0100
Subject: [Avidemux-svn-commit] r5742 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple
Message-ID: <200912280639.nBS6dEBr029161@sheep.berlios.de>

Author: mean
Date: 2009-12-28 07:39:12 +0100 (Mon, 28 Dec 2009)
New Revision: 5742

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.cpp
Log:
[Pulse] Increase buffer + specify channel mapping

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.cpp	2009-12-27 17:36:17 UTC (rev 5741)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/PulseAudioSimple/ADM_devicePulseSimple.cpp	2009-12-28 06:39:12 UTC (rev 5742)
@@ -23,11 +23,12 @@
 #include  "pulse/simple.h"
 #include  "pulse/error.h"
 
-ADM_DECLARE_AUDIODEVICE(PulseAudioS,pulseSimpleAudioDevice,1,0,1,"PulseAudioSimple audio device (c) mean");
+ADM_DECLARE_AUDIODEVICE(PulseAudioS,pulseSimpleAudioDevice,1,0,2,"PulseAudioSimple audio device (c) mean");
 #define INSTANCE  ((pa_simple *)instance)
 
 // By default we use float NOT
 #define ADM_PULSE_INT16
+#define ADM_PULSE_LATENCY 50 // ms
 /**
     \fn pulseSimpleAudioDevice
     \brief Constructor
@@ -44,7 +45,7 @@
 */
 uint32_t pulseSimpleAudioDevice::getLatencyMs(void)
 {
-   return 20; //latency;
+   return ADM_PULSE_LATENCY; //latency;
 }
 
 /**
@@ -77,21 +78,36 @@
 pa_sample_spec ss;
 int er;
 pa_buffer_attr attr;
-
+pa_channel_map map,*pmap=NULL;
     attr.maxlength = (uint32_t) -1;
     attr.tlength = (uint32_t )-1;
     attr.prebuf =(uint32_t) -1;
     attr.minreq = (uint32_t) -1;
     attr.fragsize =(uint32_t) -1;
+
   // We want something like 20 ms latency
    uint64_t bufSize=_frequency;
             bufSize*=_channels;
             bufSize*=2;      // 1 second worth of audio
 
-  attr.maxlength=bufSize/25; // 50 ms
-  attr.tlength=bufSize/50; //  20 ms
-  attr.prebuf=bufSize/100; // 10 ms
+  bufSize=bufSize/1000;
+  bufSize*=ADM_PULSE_LATENCY;
+  attr.tlength=bufSize;       // Latency in bytes
+ 
 
+  // Channel mapping
+  if(_channels>2)
+    {
+        pmap=&map;
+        map.channels=_channels;
+        map.map[0]=PA_CHANNEL_POSITION_FRONT_LEFT;
+        map.map[1]=PA_CHANNEL_POSITION_FRONT_RIGHT;
+        map.map[2]=PA_CHANNEL_POSITION_FRONT_CENTER;
+        map.map[3]=PA_CHANNEL_POSITION_REAR_LEFT;
+        map.map[4]=PA_CHANNEL_POSITION_REAR_RIGHT;
+        map.map[5]=PA_CHANNEL_POSITION_SUBWOOFER;
+  }
+
   ss.format = PA_SAMPLE_S16LE;
   ss.channels = _channels;
   ss.rate =_frequency;
@@ -102,7 +118,7 @@
                     NULL,               // Use the default device.
                     "Sound",            // Description of our stream.
                     &ss,                // Our sample format.
-                    NULL,               // Use default channel map
+                    pmap,               // Use default channel map
                     &attr ,             // Use default buffering attributes.
                     &er               // Ignore error code.
                     );



From gruntster at mail.berlios.de  Mon Dec 28 13:04:44 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 28 Dec 2009 13:04:44 +0100
Subject: [Avidemux-svn-commit] r5743 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec:
	. xvidRateCtl
Message-ID: <200912281204.nBSC4iL2010318@sheep.berlios.de>

Author: gruntster
Date: 2009-12-28 13:04:18 +0100 (Mon, 28 Dec 2009)
New Revision: 5743

Added:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/rateControl.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/rateControl.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvid.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtl.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtl.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtlVbv.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtlVbv.h
Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.h
Log:
[mpeg-1] add Xvid rate control to MPEG-1 avcodec video plugin

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-28 06:39:12 UTC (rev 5742)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-28 12:04:18 UTC (rev 5743)
@@ -24,8 +24,10 @@
 add_library(ADM_libavcodec UNKNOWN IMPORTED)
 set_property(TARGET ADM_libavcodec PROPERTY IMPORTED_LOCATION "${FFMPEG_INSTALL_DIR}/${LIBAVCODEC_LIB}")
 
+add_subdirectory(xvidRateCtl)
+
 ADD_LIBRARY(ADM_vidEnc_avcodec SHARED ${ADM_vidEnc_avcodec_SRCS})
-TARGET_LINK_LIBRARIES(ADM_vidEnc_avcodec ${LIBXML2_LIBRARIES} ADM_core ADM_coreUI ADM_libavcodec)
+TARGET_LINK_LIBRARIES(ADM_vidEnc_avcodec ${LIBXML2_LIBRARIES} ADM_xvidRateCtl ADM_core ADM_coreUI ADM_libavcodec)
 
 INIT_VIDEO_ENCODER_PLUGIN(ADM_vidEnc_avcodec)
 INSTALL_VIDEO_ENCODER(ADM_vidEnc_avcodec)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-28 06:39:12 UTC (rev 5742)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-28 12:04:18 UTC (rev 5743)
@@ -72,7 +72,7 @@
 {
 	*major = 1;
 	*minor = 0;
-	*patch = 0;
+	*patch = 1;
 }
 
 const char* vidEncGetEncoderGuid(int encoderId)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp	2009-12-28 06:39:12 UTC (rev 5742)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp	2009-12-28 12:04:18 UTC (rev 5743)
@@ -43,6 +43,7 @@
 	_bitrateParam.finalsize = 700;
 
 	_statFile = NULL;
+	_xvidRc = NULL;
 }
 
 int Mpeg1Encoder::initContext(const char* logFileName)
@@ -95,6 +96,7 @@
 	_context->max_b_frames = 2;
 	_context->luma_elim_threshold = -2;
 	_context->chroma_elim_threshold = -5;
+	_context->lumi_masking = 0.05;
 	_context->me_range = 255;
 	_context->mb_decision = FF_MB_DECISION_RD;
 	_context->scenechange_threshold = 0xfffffff;
@@ -114,16 +116,26 @@
 	}
 	else 
 	{
-		if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE)
-			_context->bit_rate = calculateBitrate(_fpsNum, _fpsDen, _frameCount, _encodeOptions.encodeModeParameter);
+		if (_options.getXvidRateControl())
+		{
+			_context->max_qdiff = 10;
+			_context->bit_rate = 2500 * 1000 * 8;
+			_context->bit_rate_tolerance = 1024 * 8 * 1000;
+			_context->flags |= CODEC_FLAG_QSCALE;
+		}
 		else
-			_context->bit_rate = _encodeOptions.encodeModeParameter * 1000;
+		{
+			_context->bit_rate_tolerance = 8000000;
+			_context->flags |= CODEC_FLAG_PASS2;
 
-		if (_context->bit_rate > _options.getMaxBitrate() * 1000)
-			_context->bit_rate = _options.getMaxBitrate() * 1000;
+			if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE)
+				_context->bit_rate = calculateBitrate(_fpsNum, _fpsDen, _frameCount, _encodeOptions.encodeModeParameter);
+			else
+				_context->bit_rate = _encodeOptions.encodeModeParameter * 1000;
 
-		_context->bit_rate_tolerance = 8000000;
-		_context->flags |= CODEC_FLAG_PASS2;
+			if (_context->bit_rate > _options.getMaxBitrate() * 1000)
+				_context->bit_rate = _options.getMaxBitrate() * 1000;
+		}		
 	}
 
 	if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE || _encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_ABR)
@@ -137,8 +149,12 @@
 		strcpy(log, logFileName);
 #endif
 
-		if (_currentPass == 1)
+		if (_options.getXvidRateControl())
 		{
+			_xvidRc = new ADM_newXvidRcVBV((_fpsNum * 1000) / _fpsDen, log);
+		}
+		else if (_currentPass == 1)
+		{
 			_statFile = fopen(log, "wb");
 
 			if (!_statFile)
@@ -166,7 +182,7 @@
 		}
 	}
 
-	if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_CQP || _currentPass == 2)
+	if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_CQP || (_currentPass == 2 && !_options.getXvidRateControl()))
 	{
 		_context->rc_max_rate = _context->rc_max_rate_header;
 		_context->rc_buffer_size = _context->rc_buffer_size_header;
@@ -415,9 +431,40 @@
 
 	if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_CQP)
 		qz = _encodeOptions.encodeModeParameter;
-	else if (_currentPass == 1)
-		qz = 2;
+	else if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE || _encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_ABR)
+	{
+		if (_currentPass == 1)
+		{
+			qz = 2;
 
+			if (_options.getXvidRateControl())
+				_xvidRc->startPass1();
+		}
+		else if (_currentPass == 2 && _options.getXvidRateControl())
+		{
+			double d = _frameCount;
+			uint32_t maxBitrate = _options.getMaxBitrate() * 1000;
+			uint32_t bitrate;
+
+			if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE)
+				bitrate = calculateBitrate(_fpsNum, _fpsDen, _frameCount, _encodeOptions.encodeModeParameter);
+			else
+				bitrate = _encodeOptions.encodeModeParameter * 1000;
+
+			if (bitrate > maxBitrate)
+				bitrate = maxBitrate;
+
+			d *= 1000.;
+			d /= (_fpsNum * 1000) / _fpsDen;   // D is a duration in second
+			d *= bitrate;   // * bitrate = total bits
+			d /= 8;   // Byte
+			d /= 1024 * 1024;   // MB
+
+			_xvidRc->setVBVInfo(_options.getMaxBitrate(), _options.getMinBitrate(), _options.getBufferSize());
+			_xvidRc->startPass2((uint32_t)d, _frameCount);
+		}
+	}
+
 	if (qz)
 		_frame.quality = (int)floor(FF_QP2LAMBDA * qz + 0.5);
 
@@ -434,6 +481,12 @@
 		_statFile = NULL;
 	}
 
+	if (_xvidRc)
+	{
+		delete _xvidRc;
+		_xvidRc = NULL;
+	}
+
 	if (_context && _context->stats_in)
 	{
 		delete [] _context->stats_in;
@@ -445,11 +498,48 @@
 
 int Mpeg1Encoder::encodeFrame(vidEncEncodeParameters *encodeParams)
 {
+	ADM_rframe rf;
+	uint32_t qz;
+
+	if (_options.getXvidRateControl() && _currentPass == 2)
+	{
+		_xvidRc->getQz(&qz, &rf);
+
+		if (qz < 2)
+			qz = 2;
+
+		if (qz > 28)
+			qz = 28;
+
+		_frame.quality = (int)floor(FF_QP2LAMBDA * qz + 0.5);
+	}
+
 	int ret = AvcodecEncoder::encodeFrame(encodeParams);
 
 	if (_context->stats_out)
 		fprintf (_statFile, "%s", _context->stats_out);
 
+	if (_options.getXvidRateControl() && encodeParams->encodedDataSize && (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE || _encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_ABR))
+	{
+		switch (encodeParams->frameType)
+		{
+			case ADM_VIDENC_FRAMETYPE_IDR:
+				rf = RF_I;
+				break;
+			case ADM_VIDENC_FRAMETYPE_B:
+				rf = RF_B;
+				break;
+			case ADM_VIDENC_FRAMETYPE_P:
+				rf = RF_P;
+				break;
+		}
+
+		if (_currentPass == 1)
+			_xvidRc->logPass1(encodeParams->quantiser, rf, encodeParams->encodedDataSize);
+		else
+			_xvidRc->logPass2(qz, rf, encodeParams->encodedDataSize);
+	}
+
 	return ret;
 }
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.h	2009-12-28 06:39:12 UTC (rev 5742)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.h	2009-12-28 12:04:18 UTC (rev 5743)
@@ -25,8 +25,8 @@
 
 #include "encoder.h"
 #include "mpeg1EncoderOptions.h"
-#include "../../ADM_encoder/ADM_vidEncode.hxx"
 #include "DIA_factory.h"
+#include "xvidRateCtl/xvidRateCtlVbv.h"
 
 class Mpeg1Encoder : public AvcodecEncoder
 {
@@ -41,6 +41,7 @@
 		vidEncOptions _encodeOptions;
 
 		FILE *_statFile;
+		ADM_newXvidRcVBV *_xvidRc;
 
 		void updateEncodeProperties(vidEncOptions *encodeOptions);
 		unsigned int calculateBitrate(unsigned int fpsNum, unsigned int fpsDen, unsigned int frameCount, unsigned int sizeInMb);

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/CMakeLists.txt	2009-12-28 06:39:12 UTC (rev 5742)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/CMakeLists.txt	2009-12-28 12:04:18 UTC (rev 5743)
@@ -0,0 +1 @@
+add_library(ADM_xvidRateCtl rateControl.cpp  xvidRateCtl.cpp  xvidRateCtlVbv.cpp)
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/rateControl.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/rateControl.cpp	2009-12-28 06:39:12 UTC (rev 5742)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/rateControl.cpp	2009-12-28 12:04:18 UTC (rev 5743)
@@ -0,0 +1,27 @@
+//
+// C++ Implementation: %{MODULE}
+//
+// Description:
+//
+//
+// Author: %{AUTHOR} <%{EMAIL}>, (C) %{YEAR}
+//
+// Copyright: See COPYING file that comes with this distribution
+//
+//
+#include <string.h>
+#include <stdlib.h>
+#include "rateControl.h"
+
+ADM_ratecontrol::ADM_ratecontrol(uint32_t fps1000, char *logname)
+{
+	_fps1000 = fps1000;
+	_logname = strdup(logname);
+	_state = RS_IDLE;
+	_nbFrames++;
+}
+
+ADM_ratecontrol::~ADM_ratecontrol()
+{
+	free(_logname);
+}

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/rateControl.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/rateControl.h	2009-12-28 06:39:12 UTC (rev 5742)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/rateControl.h	2009-12-28 12:04:18 UTC (rev 5743)
@@ -0,0 +1,60 @@
+//
+// C++ Interface: %{MODULE}
+//
+// Description: 
+//
+//
+// Author: Mean (fixounet at free.fr)
+//
+// Copyright: See COPYING file that comes with this distribution GPL.
+//
+// FIXME : We need total frame # to do only pass2
+//
+#ifndef ADM_RTCL
+#define ADM_RTCL
+
+#include <inttypes.h>
+
+typedef enum 
+{
+	RF_I=1,
+	RF_P=2,
+	RF_B=3,
+} ADM_rframe;
+
+typedef enum
+{
+	RS_IDLE,
+	RS_PASS1,
+	RS_PASS2
+} ADM_rstate;
+
+typedef struct
+{
+	uint32_t quant;
+	uint32_t size;
+	ADM_rframe type;
+} ADM_pass_stat;
+
+class ADM_ratecontrol
+{
+protected:
+	uint32_t _nbFrames;
+	uint32_t _fps1000;
+	char 	*_logname;
+	ADM_rstate _state;
+
+public:
+	ADM_ratecontrol(uint32_t fps1000, char *logname);
+	virtual ~ADM_ratecontrol();
+	/** Maxbr & minbr in Bps, vbvsize in kBytes); Default is none */
+	virtual uint8_t setVBVInfo(uint32_t maxbr, uint32_t minbr, uint32_t vbvsize) = 0;
+	virtual	uint8_t startPass1(void) = 0;
+	virtual	uint8_t logPass1(uint32_t qz, ADM_rframe ftype, uint32_t size) = 0;
+	virtual	uint8_t startPass2(uint32_t size, uint32_t nbFrame) = 0;
+	virtual	uint8_t getQz(uint32_t *qz, ADM_rframe *type) = 0;
+	virtual	uint8_t logPass2(uint32_t qz, ADM_rframe ftype, uint32_t size) = 0;
+};
+
+#endif
+//EOF

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvid.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvid.h	2009-12-28 06:39:12 UTC (rev 5742)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvid.h	2009-12-28 12:04:18 UTC (rev 5743)
@@ -0,0 +1,780 @@
+/*****************************************************************************
+ *
+ * XVID MPEG-4 VIDEO CODEC
+ * - XviD Main header file -
+ *
+ *  Copyright(C) 2001-2003 Peter Ross <pross at xvid.org>
+ *
+ *  This program is free software ; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation ; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY ; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program ; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
+ *
+ * $Id: ADM_xvidr_internal.h 1039 2005-05-17 19:01:18Z mean $
+ *
+ ****************************************************************************/
+
+#ifndef _XVID_H_
+#define _XVID_H_
+
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+/*****************************************************************************
+ * versioning
+ ****************************************************************************/
+
+/* versioning
+	version takes the form "$major.$minor.$patch"
+	$patch is incremented when there is no api change
+	$minor is incremented when the api is changed, but remains backwards compatible
+	$major is incremented when the api is changed significantly
+
+	when initialising an xvid structure, you must always zero it, and set the version field.
+		memset(&struct,0,sizeof(struct));
+		struct.version = XVID_VERSION;
+
+	XVID_UNSTABLE is defined only during development.
+	*/
+
+#define XVID_MAKE_VERSION(a,b,c) ((((a)&0xff)<<16) | (((b)&0xff)<<8) | ((c)&0xff))
+#define XVID_VERSION_MAJOR(a)    ((char)(((a)>>16) & 0xff))
+#define XVID_VERSION_MINOR(a)    ((char)(((a)>> 8) & 0xff))
+#define XVID_VERSION_PATCH(a)    ((char)(((a)>> 0) & 0xff))
+
+#define XVID_MAKE_API(a,b)       ((((a)&0xff)<<16) | (((b)&0xff)<<0))
+#define XVID_API_MAJOR(a)        (((a)>>16) & 0xff)
+#define XVID_API_MINOR(a)        (((a)>> 0) & 0xff)
+
+#define XVID_VERSION             XVID_MAKE_VERSION(1,0,-124)
+#define XVID_API                 XVID_MAKE_API(4, 0)
+
+#define XVID_UNSTABLE
+
+/* Bitstream Version
+ * this will be writen into the bitstream to allow easy detection of xvid
+ * encoder bugs in the decoder, without this it might not possible to
+ * automatically distinquish between a file which has been encoded with an
+ * old & buggy XVID from a file which has been encoded with a bugfree version
+ * see the infamous interlacing bug ...
+ *
+ * this MUST be increased if an encoder bug is fixed, increasing it too often
+ * doesnt hurt but not increasing it could cause difficulty for decoders in the
+ * future
+ */
+#define XVID_BS_VERSION "0030"
+
+
+/*****************************************************************************
+ * error codes
+ ****************************************************************************/
+
+	/*	all functions return values <0 indicate error */
+
+#define XVID_ERR_FAIL		-1		/* general fault */
+#define XVID_ERR_MEMORY		-2		/* memory allocation error */
+#define XVID_ERR_FORMAT		-3		/* file format error */
+#define XVID_ERR_VERSION	-4		/* structure version not supported */
+#define XVID_ERR_END		-5		/* encoder only; end of stream reached */
+
+
+
+/*****************************************************************************
+ * xvid_image_t
+ ****************************************************************************/
+
+/* colorspace values */
+
+#define XVID_CSP_PLANAR   (1<< 0) /* 4:2:0 planar (==I420, except for pointers/strides) */
+#define XVID_CSP_USER	  XVID_CSP_PLANAR
+#define XVID_CSP_I420     (1<< 1) /* 4:2:0 planar */
+#define XVID_CSP_YV12     (1<< 2) /* 4:2:0 planar */
+#define XVID_CSP_YUY2     (1<< 3) /* 4:2:2 packed */
+#define XVID_CSP_UYVY     (1<< 4) /* 4:2:2 packed */
+#define XVID_CSP_YVYU     (1<< 5) /* 4:2:2 packed */
+#define XVID_CSP_BGRA     (1<< 6) /* 32-bit bgra packed */
+#define XVID_CSP_ABGR     (1<< 7) /* 32-bit abgr packed */
+#define XVID_CSP_RGBA     (1<< 8) /* 32-bit rgba packed */
+#define XVID_CSP_ARGB     (1<<15) /* 32-bit argb packed */
+#define XVID_CSP_BGR      (1<< 9) /* 24-bit bgr packed */
+#define XVID_CSP_RGB555   (1<<10) /* 16-bit rgb555 packed */
+#define XVID_CSP_RGB565   (1<<11) /* 16-bit rgb565 packed */
+#define XVID_CSP_SLICE    (1<<12) /* decoder only: 4:2:0 planar, per slice rendering */
+#define XVID_CSP_INTERNAL (1<<13) /* decoder only: 4:2:0 planar, returns ptrs to internal buffers */
+#define XVID_CSP_NULL     (1<<14) /* decoder only: dont output anything */
+#define XVID_CSP_VFLIP    (1<<31) /* vertical flip mask */
+
+/* xvid_image_t
+	for non-planar colorspaces use only plane[0] and stride[0]
+	four plane reserved for alpha*/
+typedef struct {
+	int csp;				/* [in] colorspace; or with XVID_CSP_VFLIP to perform vertical flip */
+	void * plane[4];		/* [in] image plane ptrs */
+	int stride[4];			/* [in] image stride; "bytes per row"*/
+} xvid_image_t;
+
+/* video-object-sequence profiles */
+#define XVID_PROFILE_S_L0    0x08 /* simple */
+#define XVID_PROFILE_S_L1    0x01
+#define XVID_PROFILE_S_L2    0x02
+#define XVID_PROFILE_S_L3    0x03
+#define XVID_PROFILE_ARTS_L1 0x91 /* advanced realtime simple */
+#define XVID_PROFILE_ARTS_L2 0x92
+#define XVID_PROFILE_ARTS_L3 0x93
+#define XVID_PROFILE_ARTS_L4 0x94
+#define XVID_PROFILE_AS_L0   0xf0 /* advanced simple */
+#define XVID_PROFILE_AS_L1   0xf1
+#define XVID_PROFILE_AS_L2   0xf2
+#define XVID_PROFILE_AS_L3   0xf3
+#define XVID_PROFILE_AS_L4   0xf4
+
+/* aspect ratios */
+#define XVID_PAR_11_VGA    1 /* 1:1 vga (square), default if supplied PAR is not a valid value */
+#define XVID_PAR_43_PAL    2 /* 4:3 pal (12:11 625-line) */
+#define XVID_PAR_43_NTSC   3 /* 4:3 ntsc (10:11 525-line) */
+#define XVID_PAR_169_PAL   4 /* 16:9 pal (16:11 625-line) */
+#define XVID_PAR_169_NTSC  5 /* 16:9 ntsc (40:33 525-line) */
+#define XVID_PAR_EXT      15 /* extended par; use par_width, par_height */
+
+/* frame type flags */
+#define XVID_TYPE_VOL     -1 /* decoder only: vol was decoded */
+#define XVID_TYPE_NOTHING  0 /* decoder only (encoder stats): nothing was decoded/encoded */
+#define XVID_TYPE_AUTO     0 /* encoder: automatically determine coding type */
+#define XVID_TYPE_IVOP     1 /* intra frame */
+#define XVID_TYPE_PVOP     2 /* predicted frame */
+#define XVID_TYPE_BVOP     3 /* bidirectionally encoded */
+#define XVID_TYPE_SVOP     4 /* predicted+sprite frame */
+
+
+/*****************************************************************************
+ * xvid_global()
+ ****************************************************************************/
+
+/* cpu_flags definitions (make sure to sync this with cpuid.asm for ia32) */
+
+#define XVID_CPU_FORCE    (1<<31) /* force passed cpu flags */
+#define XVID_CPU_ASM      (1<< 7) /* native assembly */
+/* ARCH_IS_IA32 */
+#define XVID_CPU_MMX      (1<< 0) /*       mmx : pentiumMMX,k6 */
+#define XVID_CPU_MMXEXT   (1<< 1) /*   mmx-ext : pentium2, athlon */
+#define XVID_CPU_SSE      (1<< 2) /*       sse : pentium3, athlonXP */
+#define XVID_CPU_SSE2     (1<< 3) /*      sse2 : pentium4, athlon64 */
+#define XVID_CPU_3DNOW    (1<< 4) /*     3dnow : k6-2 */
+#define XVID_CPU_3DNOWEXT (1<< 5) /* 3dnow-ext : athlon */
+#define XVID_CPU_TSC      (1<< 6) /*       tsc : Pentium */
+/* ARCH_IS_PPC */
+#define XVID_CPU_ALTIVEC  (1<< 0) /* altivec */
+
+
+#define XVID_DEBUG_ERROR     (1<< 0)
+#define XVID_DEBUG_STARTCODE (1<< 1)
+#define XVID_DEBUG_HEADER    (1<< 2)
+#define XVID_DEBUG_TIMECODE  (1<< 3)
+#define XVID_DEBUG_MB        (1<< 4)
+#define XVID_DEBUG_COEFF     (1<< 5)
+#define XVID_DEBUG_MV        (1<< 6)
+#define XVID_DEBUG_RC        (1<< 7)
+#define XVID_DEBUG_DEBUG     (1<<31)
+
+/* XVID_GBL_INIT param1 */
+typedef struct {
+	int version;
+	unsigned int cpu_flags; /* [in:opt] zero = autodetect cpu; XVID_CPU_FORCE|{cpu features} = force cpu features */
+	int debug;     /* [in:opt] debug level */
+} xvid_gbl_init_t;
+
+
+/* XVID_GBL_INFO param1 */
+typedef struct {
+	int version;
+	int actual_version; /* [out] returns the actual xvidcore version */
+	const char * build; /* [out] if !null, points to description of this xvid core build */
+	unsigned int cpu_flags;      /* [out] detected cpu features */
+	int num_threads;    /* [out] detected number of cpus/threads */
+} xvid_gbl_info_t;
+
+
+/* XVID_GBL_CONVERT param1 */
+typedef struct {
+	int version;
+	xvid_image_t input;  /* [in] input image & colorspace */
+	xvid_image_t output; /* [in] output image & colorspace */
+	int width;           /* [in] width */
+	int height;          /* [in] height */
+	int interlacing;     /* [in] interlacing */
+} xvid_gbl_convert_t;
+
+
+#define XVID_GBL_INIT    0 /* initialize xvidcore; must be called before using xvid_decore, or xvid_encore) */
+#define XVID_GBL_INFO    1 /* return some info about xvidcore, and the host computer */
+#define XVID_GBL_CONVERT 2 /* colorspace conversion utility */
+
+extern int xvid_global(void *handle, int opt, void *param1, void *param2);
+
+
+/*****************************************************************************
+ * xvid_decore()
+ ****************************************************************************/
+
+#define XVID_DEC_CREATE  0 /* create decore instance; return 0 on success */
+#define XVID_DEC_DESTROY 1 /* destroy decore instance: return 0 on success */
+#define XVID_DEC_DECODE  2 /* decode a frame: returns number of bytes consumed >= 0 */
+
+extern int xvid_decore(void *handle, int opt, void *param1, void *param2);
+
+/* XVID_DEC_CREATE param 1
+	image width & height may be specified here when the dimensions are
+	known in advance. */
+typedef struct {
+	int version;
+	int width;     /* [in:opt] image width */
+	int height;    /* [in:opt] image width */
+	void * handle; /* [out]	   decore context handle */
+} xvid_dec_create_t;
+
+
+/* XVID_DEC_DECODE param1 */
+/* general flags */
+#define XVID_LOWDELAY      (1<<0) /* lowdelay mode  */
+#define XVID_DISCONTINUITY (1<<1) /* indicates break in stream */
+#define XVID_DEBLOCKY      (1<<2) /* perform luma deblocking */
+#define XVID_DEBLOCKUV     (1<<3) /* perform chroma deblocking */
+#define XVID_FILMEFFECT    (1<<4) /* adds film grain */
+
+typedef struct {
+	int version;
+	int general;         /* [in:opt] general flags */
+	void *bitstream;     /* [in]     bitstream (read from)*/
+	int length;          /* [in]     bitstream length */
+	xvid_image_t output; /* [in]     output image (written to) */
+} xvid_dec_frame_t;
+
+
+/* XVID_DEC_DECODE param2 :: optional */
+typedef struct
+{
+	int version;
+
+	int type;                   /* [out] output data type */
+	union {
+		struct { /* type>0 {XVID_TYPE_IVOP,XVID_TYPE_PVOP,XVID_TYPE_BVOP,XVID_TYPE_SVOP} */
+			int general;        /* [out] flags */
+			int time_base;      /* [out] time base */
+			int time_increment; /* [out] time increment */
+
+			/* XXX: external deblocking stuff */
+			int * qscale;	    /* [out] pointer to quantizer table */
+			int qscale_stride;  /* [out] quantizer scale stride */
+
+		} vop;
+		struct {	/* XVID_TYPE_VOL */
+			int general;        /* [out] flags */
+			int width;          /* [out] width */
+			int height;         /* [out] height */
+			int par;            /* [out] pixel aspect ratio (refer to XVID_PAR_xxx above) */
+			int par_width;      /* [out] aspect ratio width  [1..255] */
+			int par_height;     /* [out] aspect ratio height [1..255] */
+		} vol;
+	} data;
+} xvid_dec_stats_t;
+
+#define XVID_ZONE_QUANT  (1<<0)
+#define XVID_ZONE_WEIGHT (1<<1)
+
+typedef struct
+{
+	int frame;
+	int mode;
+	int increment;
+	int base;
+} xvid_enc_zone_t;
+
+
+/*----------------------------------------------------------------------------
+ * xvid_enc_stats_t structure
+ *
+ * Used in:
+ *  - xvid_plg_data_t structure
+ *  - optional parameter in xvid_encore() function
+ *
+ * .coding_type = XVID_TYPE_NOTHING if the stats are not given
+ *--------------------------------------------------------------------------*/
+
+typedef struct {
+	int version;
+
+	/* encoding parameters */
+	int type;      /* [out] coding type */
+	int quant;     /* [out] frame quantizer */
+	int vol_flags; /* [out] vol flags (see above) */
+	int vop_flags; /* [out] vop flags (see above) */
+
+	/* bitrate */
+	int length;    /* [out] frame length */
+
+	int hlength;   /* [out] header length (bytes) */
+	int kblks;     /* [out] number of blocks compressed as Intra */
+	int mblks;     /* [out] number of blocks compressed as Inter */
+	int ublks;     /* [out] number of blocks marked as not_coded */
+
+	int sse_y;     /* [out] Y plane's sse */
+	int sse_u;     /* [out] U plane's sse */
+	int sse_v;     /* [out] V plane's sse */
+} xvid_enc_stats_t;
+
+/*****************************************************************************
+  xvid plugin system -- internals
+
+  xvidcore will call XVID_PLG_INFO and XVID_PLG_CREATE during XVID_ENC_CREATE
+  before encoding each frame xvidcore will call XVID_PLG_BEFORE
+  after encoding each frame xvidcore will call XVID_PLG_AFTER
+  xvidcore will call XVID_PLG_DESTROY during XVID_ENC_DESTROY
+ ****************************************************************************/
+
+
+#define XVID_PLG_CREATE  (1<<0)
+#define XVID_PLG_DESTROY (1<<1)
+#define XVID_PLG_INFO    (1<<2)
+#define XVID_PLG_BEFORE  (1<<3)
+#define XVID_PLG_FRAME   (1<<4)
+#define XVID_PLG_AFTER   (1<<5)
+
+/* xvid_plg_info_t.flags */
+#define XVID_REQORIGINAL (1<<0) /* plugin requires a copy of the original (uncompressed) image */
+#define XVID_REQPSNR     (1<<1) /* plugin requires psnr between the uncompressed and compressed image*/
+#define XVID_REQDQUANTS  (1<<2) /* plugin requires access to the dquant table */
+
+
+typedef struct
+{
+	int version;
+	int flags;   /* [in:opt] plugin flags */
+} xvid_plg_info_t;
+
+
+typedef struct
+{
+	int version;
+
+	int num_zones;           /* [out] */
+	xvid_enc_zone_t * zones; /* [out] */
+
+	int width;               /* [out] */
+	int height;              /* [out] */
+	int mb_width;            /* [out] */
+	int mb_height;           /* [out] */
+	int fincr;               /* [out] */
+	int fbase;               /* [out] */
+
+	void * param;            /* [out] */
+} xvid_plg_create_t;
+
+
+typedef struct
+{
+	int version;
+
+	int num_frames; /* [out] total frame encoded */
+} xvid_plg_destroy_t;
+
+typedef struct
+{
+	int version;
+
+	xvid_enc_zone_t * zone; /* [out] current zone */
+
+	int width;              /* [out] */
+	int height;             /* [out] */
+	int mb_width;           /* [out] */
+	int mb_height;          /* [out] */
+	int fincr;              /* [out] */
+	int fbase;              /* [out] */
+
+	int min_quant[3];       /* [out] */
+	int max_quant[3];       /* [out] */
+
+	xvid_image_t reference; /* [out] -> [out] */
+	xvid_image_t current;   /* [out] -> [in,out] */
+	xvid_image_t original;  /* [out] after: points the original (uncompressed) copy of the current frame */
+	int frame_num;          /* [out] frame number */
+
+	int type;               /* [in,out] */
+	int quant;              /* [in,out] */
+
+	int * dquant;           /* [in,out]	pointer to diff quantizer table */
+	int dquant_stride;      /* [in,out]	diff quantizer stride */
+
+	int vop_flags;          /* [in,out] */
+	int vol_flags;          /* [in,out] */
+	int motion_flags;       /* [in,out] */
+
+/* Deprecated, use the stats field instead.
+ * Will disapear before 1.0 */
+	int length;             /* [out] after: length of encoded frame */
+	int kblks;              /* [out] number of blocks compressed as Intra */
+	int mblks;              /* [out] number of blocks compressed as Inter */
+	int ublks;              /* [out] number of blocks marked not_coded */
+	int sse_y;              /* [out] Y plane's sse */
+	int sse_u;              /* [out] U plane's sse */
+	int sse_v;              /* [out] V plane's sse */
+/* End of duplicated data, kept only for binary compatibility */
+
+	int bquant_ratio;       /* [in] */
+	int bquant_offset;      /* [in] */
+
+	xvid_enc_stats_t stats; /* [out] frame statistics */
+} xvid_plg_data_t;
+
+/*****************************************************************************
+  xvid plugin system -- external
+
+  the application passes xvid an array of "xvid_plugin_t" at XVID_ENC_CREATE. the array
+  indicates the plugin function pointer and plugin-specific data.
+  xvidcore handles the rest. example:
+
+  xvid_enc_create_t create;
+  xvid_enc_plugin_t plugins[2];
+
+  plugins[0].func = xvid_psnr_func;
+  plugins[0].param = NULL;
+  plugins[1].func = xvid_cbr_func;
+  plugins[1].param = &cbr_data;
+
+  create.num_plugins = 2;
+  create.plugins = plugins;
+
+ ****************************************************************************/
+
+typedef int (xvid_plugin_func)(void * handle, int opt, void * param1, void * param2);
+
+typedef struct
+{
+	xvid_plugin_func * func;
+	void * param;
+} xvid_enc_plugin_t;
+
+
+extern xvid_plugin_func xvid_plugin_single;   /* single-pass rate control */
+//extern xvid_plugin_func xvid_plugin_2pass1;   /* two-pass rate control: first pass */
+//extern xvid_plugin_func xvid_plugin_2pass2;   /* two-pass rate control: second pass */
+
+extern xvid_plugin_func xvid_plugin_lumimasking;  /* lumimasking */
+
+extern xvid_plugin_func xvid_plugin_psnr;	/* write psnr values to stdout */
+extern xvid_plugin_func xvid_plugin_dump;	/* dump before and after yuvpgms */
+
+
+/* single pass rate control
+ * CBR and Constant quantizer modes */
+typedef struct
+{
+	int version;
+
+	int bitrate;               /* [in] bits per second */
+	int reaction_delay_factor; /* [in] */
+	int averaging_period;      /* [in] */
+	int buffer;                /* [in] */
+} xvid_plugin_single_t;
+
+
+typedef struct {
+	int version;
+
+	char * filename;
+} xvid_plugin_2pass1_t;
+
+
+#define XVID_PAYBACK_BIAS 0 /* payback with bias */
+#define XVID_PAYBACK_PROP 1 /* payback proportionally */
+
+typedef struct {
+	int version;
+
+	int bitrate;                  /* [in] bits per second */
+	char * filename;              /* [in] first pass stats filename */
+
+	int keyframe_boost;           /* [in] keyframe boost percentage: [0..100] */
+	int curve_compression_high;   /* [in] percentage of compression performed on the high part of the curve (above average) */
+	int curve_compression_low;    /* [in] percentage of compression performed on the low  part of the curve (below average) */
+	int overflow_control_strength;/* [in] Payback delay expressed in number of frames */
+	int max_overflow_improvement; /* [in] percentage of allowed range for a frame that gets bigger because of overflow bonus */
+	int max_overflow_degradation; /* [in] percentage of allowed range for a frame that gets smaller because of overflow penalty */
+
+	int kfreduction;              /* [in] maximum bitrate reduction applied to an iframe under the kfthreshold distance limit */
+	int kfthreshold;              /* [in] if an iframe is closer to the next iframe than this distance, a quantity of bits
+								   *      is substracted from its bit allocation. The reduction is computed as multiples of
+								   *      kfreduction/kthreshold. It reaches kfreduction when the distance == kfthreshold,
+								   *      0 for 1<distance<kfthreshold */
+
+	int container_frame_overhead; /* [in] How many bytes the controller has to compensate per frame due to container format overhead */
+
+#ifdef VBV
+  int vbv_size;
+  int vbv_initial;
+  int vbv_maxrate;
+  int vbv_peakrate;
+#endif
+
+}xvid_plugin_2pass2_t;
+
+/*****************************************************************************
+ *                             ENCODER API
+ ****************************************************************************/
+
+/*----------------------------------------------------------------------------
+ * Encoder operations
+ *--------------------------------------------------------------------------*/
+
+#define XVID_ENC_CREATE  0 /* create encoder instance; returns 0 on success */
+#define XVID_ENC_DESTROY 1 /* destroy encoder instance; returns 0 on success */
+#define XVID_ENC_ENCODE  2 /* encode a frame: returns number of ouput bytes
+                            * 0 means this frame should not be written (ie. encoder lag) */
+
+
+/*----------------------------------------------------------------------------
+ * Encoder entry point
+ *--------------------------------------------------------------------------*/
+
+extern int xvid_encore(void *handle, int opt, void *param1, void *param2);
+
+/* Quick API reference
+ *
+ * XVID_ENC_CREATE operation
+ *  - handle: ignored
+ *  - opt: XVID_ENC_CREATE
+ *  - param1: address of a xvid_enc_create_t structure
+ *  - param2: ignored
+ *
+ * XVID_ENC_ENCODE operation
+ *  - handle: an instance returned by a CREATE op
+ *  - opt: XVID_ENC_ENCODE
+ *  - param1: address of a xvid_enc_frame_t structure
+ *  - param2: address of a xvid_enc_stats_t structure (optional)
+ *            its return value is asynchronous to what is written to the buffer
+ *            depending on the delay introduced by bvop use. It's display
+ *            ordered.
+ *
+ * XVID_ENC_DESTROY operation
+ *  - handle: an instance returned by a CREATE op
+ *  - opt: XVID_ENC_DESTROY
+ *  - param1: ignored
+ *  - param2: ignored
+ */
+
+
+/*----------------------------------------------------------------------------
+ * "Global" flags
+ *
+ * These flags are used for xvid_enc_create_t->global field during instance
+ * creation (operation XVID_ENC_CREATE)
+ *--------------------------------------------------------------------------*/
+
+#define XVID_GLOBAL_PACKED            (1<<0) /* packed bitstream */
+#define XVID_GLOBAL_CLOSED_GOP        (1<<1) /* closed_gop:	was DX50BVOP dx50 bvop compatibility */
+#define XVID_GLOBAL_EXTRASTATS_ENABLE (1<<2)
+#if 0
+#define XVID_GLOBAL_VOL_AT_IVOP       (1<<3) /* write vol at every ivop: WIN32/divx compatibility */
+#define XVID_GLOBAL_FORCE_VOL         (1<<4) /* when vol-based parameters are changed, insert an ivop NOT recommended */
+#endif
+
+
+/*----------------------------------------------------------------------------
+ * "VOL" flags
+ *
+ * These flags are used for xvid_enc_frame_t->vol_flags field during frame
+ * encoding (operation XVID_ENC_ENCODE)
+ *--------------------------------------------------------------------------*/
+
+#define XVID_VOL_MPEGQUANT      (1<<0) /* enable MPEG type quantization */
+#define XVID_VOL_EXTRASTATS     (1<<1) /* enable plane sse stats */
+#define XVID_VOL_QUARTERPEL     (1<<2) /* enable quarterpel: frames will encoded as quarterpel */
+#define XVID_VOL_GMC            (1<<3) /* enable GMC; frames will be checked for gmc suitability */
+#define XVID_VOL_REDUCED_ENABLE (1<<4) /* enable reduced resolution vops: frames will be checked for rrv suitability */
+#define XVID_VOL_INTERLACING    (1<<5) /* enable interlaced encoding */
+
+
+/*----------------------------------------------------------------------------
+ * "VOP" flags
+ *
+ * These flags are used for xvid_enc_frame_t->vop_flags field during frame
+ * encoding (operation XVID_ENC_ENCODE)
+ *--------------------------------------------------------------------------*/
+
+/* Always valid */
+#define XVID_VOP_DEBUG                (1<< 0) /* print debug messages in frames */
+#define XVID_VOP_HALFPEL              (1<< 1) /* use halfpel interpolation */
+#define XVID_VOP_INTER4V              (1<< 2) /* use 4 motion vectors per MB */
+#define XVID_VOP_TRELLISQUANT         (1<< 3) /* use trellis based R-D "optimal" quantization */
+#define XVID_VOP_CHROMAOPT            (1<< 4) /* enable chroma optimization pre-filter */
+#define XVID_VOP_CARTOON              (1<< 5) /* use 'cartoon mode' */
+#define XVID_VOP_GREYSCALE            (1<< 6) /* enable greyscale only mode (even for  color input material chroma is ignored) */
+#define XVID_VOP_HQACPRED             (1<< 7) /* high quality ac prediction */
+#define XVID_VOP_MODEDECISION_RD      (1<< 8) /* enable DCT-ME and use it for mode decision */
+#define XVID_VOP_FAST_MODEDECISION_RD (1<<12) /* use simplified R-D mode decision */
+
+/* Only valid for vol_flags|=XVID_VOL_INTERLACING */
+#define XVID_VOP_TOPFIELDFIRST        (1<< 9) /* set top-field-first flag  */
+#define XVID_VOP_ALTERNATESCAN        (1<<10) /* set alternate vertical scan flag */
+
+/* only valid for vol_flags|=XVID_VOL_REDUCED_ENABLED */
+#define XVID_VOP_REDUCED              (1<<11) /* reduced resolution vop */
+
+
+/*----------------------------------------------------------------------------
+ * "Motion" flags
+ *
+ * These flags are used for xvid_enc_frame_t->motion field during frame
+ * encoding (operation XVID_ENC_ENCODE)
+ *--------------------------------------------------------------------------*/
+
+/* Motion Estimation Search Patterns */
+#define XVID_ME_ADVANCEDDIAMOND16     (1<< 0) /* use advdiamonds instead of diamonds as search pattern */
+#define XVID_ME_ADVANCEDDIAMOND8      (1<< 1) /* use advdiamond for XVID_ME_EXTSEARCH8 */
+#define XVID_ME_USESQUARES16          (1<< 2) /* use squares instead of diamonds as search pattern */
+#define XVID_ME_USESQUARES8           (1<< 3) /* use square for XVID_ME_EXTSEARCH8 */
+
+/* SAD operator based flags */
+#define XVID_ME_HALFPELREFINE16       (1<< 4)
+#define XVID_ME_HALFPELREFINE8        (1<< 6)
+#define XVID_ME_QUARTERPELREFINE16    (1<< 7)
+#define XVID_ME_QUARTERPELREFINE8     (1<< 8)
+#define XVID_ME_GME_REFINE            (1<< 9)
+#define XVID_ME_EXTSEARCH16           (1<<10) /* extend PMV by more searches */
+#define XVID_ME_EXTSEARCH8            (1<<11) /* use diamond/square for extended 8x8 search */
+#define XVID_ME_CHROMA_PVOP           (1<<12) /* also use chroma for P_VOP/S_VOP ME */
+#define XVID_ME_CHROMA_BVOP           (1<<13) /* also use chroma for B_VOP ME */
+#define XVID_ME_FASTREFINE16          (1<<25) /* use low-complexity refinement functions */
+#define XVID_ME_FASTREFINE8           (1<<29) /* low-complexity 8x8 sub-block refinement */
+
+/* Rate Distortion based flags
+ * Valid when XVID_VOP_MODEDECISION_RD is enabled */
+#define XVID_ME_HALFPELREFINE16_RD    (1<<14) /* perform RD-based halfpel refinement */
+#define XVID_ME_HALFPELREFINE8_RD     (1<<15) /* perform RD-based halfpel refinement for 8x8 mode */
+#define XVID_ME_QUARTERPELREFINE16_RD (1<<16) /* perform RD-based qpel refinement */
+#define XVID_ME_QUARTERPELREFINE8_RD  (1<<17) /* perform RD-based qpel refinement for 8x8 mode */
+#define XVID_ME_EXTSEARCH_RD          (1<<18) /* perform RD-based search using square pattern enable XVID_ME_EXTSEARCH8 to do this in 8x8 search as well */
+#define XVID_ME_CHECKPREDICTION_RD    (1<<19) /* always check vector equal to prediction */
+
+/* Other */
+#define XVID_ME_DETECT_STATIC_MOTION  (1<<24) /* speed-up ME by detecting stationary scenes */
+#define XVID_ME_SKIP_DELTASEARCH      (1<<26) /* speed-up by skipping b-frame delta search */
+#define XVID_ME_FAST_MODEINTERPOLATE  (1<<27) /* speed-up by partly skipping interpolate mode */
+#define XVID_ME_BFRAME_EARLYSTOP      (1<<28) /* speed-up by early exiting b-search */
+
+/* Unused */
+#define XVID_ME_UNRESTRICTED16        (1<<20) /* unrestricted ME, not implemented */
+#define XVID_ME_OVERLAPPING16         (1<<21) /* overlapping ME, not implemented */
+#define XVID_ME_UNRESTRICTED8         (1<<22) /* unrestricted ME, not implemented */
+#define XVID_ME_OVERLAPPING8          (1<<23) /* overlapping ME, not implemented */
+
+
+/*----------------------------------------------------------------------------
+ * xvid_enc_create_t structure definition
+ *
+ * This structure is passed as param1 during an instance creation (operation
+ * XVID_ENC_CREATE)
+ *--------------------------------------------------------------------------*/
+
+typedef struct {
+	int version;
+
+	int profile;                 /* [in] profile at level; refer to XVID_PROFILE_xxx */
+	int width;                   /* [in] frame dimensions; width, pixel units */
+	int height;                  /* [in] frame dimensions; height, pixel units */
+
+	int num_zones;               /* [in:opt] number of bitrate zones */
+	xvid_enc_zone_t * zones;     /*          ^^ zone array */
+
+	int num_plugins;             /* [in:opt] number of plugins */
+	xvid_enc_plugin_t * plugins; /*          ^^ plugin array */
+
+	int num_threads;             /* [in:opt] number of threads */
+	int max_bframes;             /* [in:opt] max sequential bframes (0=disable bframes) */
+
+	int global;                  /* [in:opt] global flags; controls encoding behavior */
+
+	/* --- vol-based stuff; included here for convenience */
+	int fincr;                   /* [in:opt] framerate increment; set to zero for variable framerate */
+	int fbase;                   /* [in] framerate base frame_duration = fincr/fbase seconds*/
+    /* ---------------------------------------------- */
+
+	/* --- vop-based; included here for convenience */
+	int max_key_interval;        /* [in:opt] the maximum interval between key frames */
+
+	int frame_drop_ratio;        /* [in:opt] frame dropping: 0=drop none... 100=drop all */
+
+	int bquant_ratio;            /* [in:opt] bframe quantizer multipier/offeset; used to decide bframes quant when bquant==-1 */
+	int bquant_offset;           /* bquant = (avg(past_ref_quant,future_ref_quant)*bquant_ratio + bquant_offset) / 100 */
+
+	int min_quant[3];            /* [in:opt] */
+	int max_quant[3];            /* [in:opt] */
+	/* ---------------------------------------------- */
+
+	void *handle;                /* [out] encoder instance handle */
+} xvid_enc_create_t;
+
+
+/*----------------------------------------------------------------------------
+ * xvid_enc_frame_t structure definition
+ *
+ * This structure is passed as param1 during a frame encoding (operation
+ * XVID_ENC_ENCODE)
+ *--------------------------------------------------------------------------*/
+
+/* out value for the frame structure->type field
+ * unlike stats output in param2, this field is not asynchronous and tells
+ * the client app, if the frame written into the stream buffer is an ivop
+ * usually used for indexing purpose in the container */
+#define XVID_KEYFRAME (1<<1)
+
+/* The structure */
+typedef struct {
+	int version;
+
+	/* VOL related stuff
+	 * unless XVID_FORCEVOL is set, the encoder will not react to any changes
+	 * here until the next VOL (keyframe). */
+
+	int vol_flags;                     /* [in] vol flags */
+	unsigned char *quant_intra_matrix; /* [in:opt] custom intra qmatrix */
+	unsigned char *quant_inter_matrix; /* [in:opt] custom inter qmatrix */
+
+	int par;                           /* [in:opt] pixel aspect ratio (refer to XVID_PAR_xxx above) */
+	int par_width;                     /* [in:opt] aspect ratio width */
+	int par_height;                    /* [in:opt] aspect ratio height */
+
+	/* Other fields that can change on a frame base */
+
+	int fincr;                         /* [in:opt] framerate increment, for variable framerate only */
+	int vop_flags;                     /* [in] (general)vop-based flags */
+	int motion;                        /* [in] ME options */
+
+	xvid_image_t input;                /* [in] input image (read from) */
+
+	int type;                          /* [in:opt] coding type */
+	int quant;                         /* [in] frame quantizer; if <=0, automatic (ratecontrol) */
+	int bframe_threshold;
+
+	void *bitstream;                   /* [in:opt] bitstream ptr (written to)*/
+	int length;                        /* [in:opt] bitstream length (bytes) */
+
+	int out_flags;                     /* [out] bitstream output flags */
+} xvid_enc_frame_t;
+
+#ifdef __cplusplus
+}
+#endif
+
+#endif
+

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtl.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtl.cpp	2009-12-28 06:39:12 UTC (rev 5742)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtl.cpp	2009-12-28 12:04:18 UTC (rev 5743)
@@ -0,0 +1,2359 @@
+ // Port of below to use with mpeg2enc/lavcodec
+ // port by mean, see below for original copyright/authors
+ 
+ /******************************************************************************
+ *
+ *  XviD Bit Rate Controller Library
+ *  - VBR 2 pass bitrate controller implementation -
+ *
+ *  Copyright (C)      2002 Foxer <email?>
+ *                     2002 Dirk Knop <dknop at gwdg.de>
+ *                2002-2003 Edouard Gomez <ed.gomez at free.fr>
+ *                     2003 Pete Ross <pross at xvid.org>
+ *
+ *  This curve treatment algorithm is the one originally implemented by Foxer
+ *  and tuned by Dirk Knop for the XviD vfw frontend.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * $Id: ADM_xvidratectl.cpp 3832 2008-03-06 18:32:32Z gruntster $
+ *
+ *****************************************************************************/
+
+//#define BQUANT_PRESCALE
+#undef BQUANT_PRESCALE
+#undef COMPENSATE_FORMULA
+#define MEANX_RESCALE
+/* forces second pass not to be bigger than first */
+#undef PASS_SMALLER
+
+/* automatically alters overflow controls (strength and improvement/degradation)
+to fight most common problems without user's knowladge */
+#define SMART_OVERFLOW_SETTING
+#define VBV
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include <limits.h>
+#include <math.h>
+
+#undef NDEBUG
+#include <assert.h>
+
+#include "xvidRateCtl.h"
+#include "xvid.h"
+
+#define aprintf(prt, args...);
+#define DPRINTF(a,b, args...) aprintf(b,## args);
+
+/*****************************************************************************
+* Some default settings
+****************************************************************************/
+
+#define DEFAULT_KEYFRAME_BOOST 0
+#define DEFAULT_OVERFLOW_CONTROL_STRENGTH 10
+#define DEFAULT_CURVE_COMPRESSION_HIGH 0
+#define DEFAULT_CURVE_COMPRESSION_LOW 0
+#define DEFAULT_MAX_OVERFLOW_IMPROVEMENT 10
+#define DEFAULT_MAX_OVERFLOW_DEGRADATION 10
+
+/* Keyframe settings */
+#define DEFAULT_KFREDUCTION 20
+#define DEFAULT_KFTHRESHOLD 1
+
+/*****************************************************************************
+* Some default constants (can be tuned)
+****************************************************************************/
+
+/* Specify the invariant part of the headers bits (header+MV)
+* as  hlength/cst */
+#define INVARIANT_HEADER_PART_IVOP 1 /* factor 1.0f   */
+#define INVARIANT_HEADER_PART_PVOP 2 /* factor 0.5f   */
+#define INVARIANT_HEADER_PART_BVOP 8 /* factor 0.125f */
+
+/*****************************************************************************
+* Structures
+****************************************************************************/
+
+/* Statistics */
+typedef struct {
+	int type;               /* first pass type */
+	int quant;              /* first pass quant */
+	int blks[3];            /* k,m,y blks */
+	int length;             /* first pass length */
+	int invariant;          /* what we assume as being invariant between the two passes, it's a sub part of header + MV bits */
+	int scaled_length;      /* scaled length */
+	int desired_length;     /* desired length; calculated during encoding */
+	int error;
+
+	int zone_mode;   /* XVID_ZONE_xxx */
+	double weight;
+} twopass_stat_t;
+
+typedef struct
+{
+	FILE * stat_file;
+	double fq_error;
+} rc_2pass1_t;
+
+/* Context struct */
+typedef struct
+{
+	xvid_plugin_2pass2_t param;
+
+	/*----------------------------------
+	* constant statistical data
+	*--------------------------------*/
+
+	/* Number of frames of the sequence */
+	int num_frames;
+
+	/* Number of Intra frames of the sequence */
+	int num_keyframes;
+
+	/* Target filesize to reach */
+	uint64_t target;
+
+	/* Count of each frame types */
+	int count[3];
+
+	/* Total length of each frame types (1st pass) */
+	uint64_t tot_length[3];
+	uint64_t tot_invariant[3];
+
+	/* Average length of each frame types (used first for 1st pass data and
+	* then for scaled averages */
+	double avg_length[3];
+
+	/* Minimum frame length allowed for each frame type */
+	int min_length[3];
+
+	/* Total bytes per frame type once the curve has been scaled
+	* NB: advanced parameters do not change this value. This field
+	*     represents the total scaled w/o any advanced settings */
+	uint64_t tot_scaled_length[3];
+
+	/* Maximum observed frame size observed during the first pass, the RC
+	* will try tp force all frame sizes in the second pass to be under that
+	* limit */
+	int max_length;
+
+	/*----------------------------------
+	* Zones statistical data
+	*--------------------------------*/
+
+	/* Total length used by XVID_ZONE_QUANT zones */
+	uint64_t tot_quant;
+	uint64_t tot_quant_invariant;
+
+	/* Holds the total amount of frame bytes, zone weighted (only scalable
+	* part of frame bytes) */
+	uint64_t tot_weighted;
+
+	/*----------------------------------
+	* Advanced settings helper ratios
+	*--------------------------------*/
+
+	/* This the ratio that has to be applied to all p/b frames in order
+	* to reserve/retrieve bits for/from keyframe boosting and consecutive
+	* keyframe penalty */
+	double pb_iboost_tax_ratio;
+
+	/* This the ratio to apply to all b/p frames in order to respect the
+	* assymetric curve compression while respecting a target filesize
+	* NB: The assymetric delta gain has to be computed before this ratio
+	*     is applied, and then the delta is added to the scaled size */
+	double assymetric_tax_ratio;
+
+	/*----------------------------------
+	* Data from the stats file kept
+	* into RAM for easy access
+	*--------------------------------*/
+
+	/* Array of keyframe locations
+	* eg: rc->keyframe_locations[100] returns the frame number of the 100th
+	*     keyframe */
+	int *keyframe_locations;
+
+	/* Index of the last keyframe used in the keyframe_location */
+	int KF_idx;
+
+	/* Array of all 1st pass data file -- see the twopass_stat_t structure
+	* definition for more details */
+	twopass_stat_t * stats;
+
+	/*----------------------------------
+	* Hysteresis helpers
+	*--------------------------------*/
+
+	/* This field holds the int2float conversion errors of each quant per
+	* frame type, this allow the RC to keep track of rouding error and thus
+	* increase or decrease the chosen quant according to this residue */
+	double quant_error[3][32];
+
+	/* This fields stores the count of each quant usage per frame type
+	* No real role but for debugging */
+	int quant_count[3][32];
+
+	/* Last valid quantizer used per frame type, it allows quantizer
+	* increament/decreament limitation in order to avoid big image quality
+	* "jumps" */
+	int last_quant[3];
+
+	/*----------------------------------
+	* Overflow control
+	*--------------------------------*/
+
+	/* Current overflow that has to be distributed to p/b frames */
+	double overflow;
+
+	/* Total overflow for keyframes -- not distributed directly */
+	double KFoverflow;
+
+	/* Amount of keyframe overflow to introduce to the global p/b frame
+	* overflow counter at each encoded frame */
+	double KFoverflow_partial;
+
+	/* Unknown ???
+	* ToDo: description */
+	double fq_error;
+
+	int min_quant; /* internal minimal quant, prevents wrong quants from being used */
+
+	/*----------------------------------
+	* Debug
+	*--------------------------------*/
+	double desired_total;
+	double real_total;
+} rc_2pass2_t;
+
+static xvid_plg_data_t  _2pass_data;
+/*****************************************************************************
+* Sub plugin functions prototypes
+****************************************************************************/
+
+static int rc_2pass2_create(xvid_plg_create_t * create, rc_2pass2_t ** handle);
+static int rc_2pass2_before(rc_2pass2_t * rc, xvid_plg_data_t * data);
+static int rc_2pass2_after(rc_2pass2_t * rc, xvid_plg_data_t * data);
+static int rc_2pass2_destroy(rc_2pass2_t * rc, xvid_plg_destroy_t * destroy);
+
+//MEANX: cpp
+static int scale_curve_for_vbv_compliancy(rc_2pass2_t * rc, const float fps);
+static int check_curve_for_vbv_compliancy(rc_2pass2_t * rc, const float fps);
+static void scaled_curve_apply_advanced_parameters(rc_2pass2_t * rc);
+static void first_pass_scale_curve_internal(rc_2pass2_t *rc);
+static void zone_process(rc_2pass2_t *rc, const xvid_plg_create_t * create);
+static void first_pass_stats_prepare_data(rc_2pass2_t * rc);
+static int  statsfile_load(rc_2pass2_t *rc, char * filename);
+static  int statsfile_count_frames(rc_2pass2_t * rc, char * filename);
+static char *skipspaces(char *string);
+static int iscomment(char *string);
+static char *readline(FILE *f);
+static int rc_2pass2_after(rc_2pass2_t * rc, xvid_plg_data_t * data);
+static int rc_2pass2_before(rc_2pass2_t * rc, xvid_plg_data_t * data);
+static int rc_2pass2_destroy(rc_2pass2_t * rc, xvid_plg_destroy_t * destroy);
+static int rc_2pass2_create(xvid_plg_create_t * create, rc_2pass2_t **handle);
+static int xvid_plugin_2pass1(void * handle, int opt, void * param1, void * param2);
+static  int rc_2pass1_after(rc_2pass1_t * rc, xvid_plg_data_t * data);
+
+static int rc_2pass1_before(rc_2pass1_t * rc, xvid_plg_data_t * data);
+static  int rc_2pass1_destroy(rc_2pass1_t * rc, xvid_plg_destroy_t * destroy);
+static  int rc_2pass1_create(xvid_plg_create_t * create, rc_2pass1_t ** handle);
+
+static void writeQuantStat(rc_2pass2_t * rc);
+
+//****************************************************************************************
+//****************************************************************************************
+//****************************************************************************************
+#define FAKE_VERSION  XVID_MAKE_VERSION(1,1,99) 
+static void *myHandle = NULL;
+
+ADM_newXvidRc::~ADM_newXvidRc()
+{
+	xvid_plg_destroy_t data;
+	printf("Destroying new xvid ratecontrol\n");
+	data.version=FAKE_VERSION;
+
+	switch(_state)
+	{
+		case RS_IDLE:
+			break;
+		case RS_PASS1:
+			rc_2pass1_destroy((rc_2pass1_t *)myHandle,&data);
+			break;
+		case RS_PASS2:writeQuantStat((rc_2pass2_t *)myHandle);
+			rc_2pass2_destroy((rc_2pass2_t *)myHandle,&data);
+			break;
+	}
+	_state = RS_IDLE;
+	myHandle = 0;
+}
+
+ADM_newXvidRc::ADM_newXvidRc(uint32_t fps1000, char *logname) : ADM_ratecontrol(fps1000,logname)
+{
+	_totalFrame=0;
+}
+
+uint8_t ADM_newXvidRc::setVBVInfo(uint32_t maxbr,uint32_t minbr, uint32_t vbvsize)
+{
+	return 1;
+}
+
+uint8_t ADM_newXvidRc::startPass1( void )
+{
+	xvid_plugin_2pass1_t 	data;
+	xvid_plg_create_t	create;
+	assert(_state==RS_IDLE);
+
+	create.version=FAKE_VERSION;
+	create.param=&data;	
+
+	data.version=FAKE_VERSION; // Fake 1.1
+	data.filename=_logname;
+
+	if(rc_2pass1_create(&create, (rc_2pass1_t **)&myHandle))
+	{
+		printf("XvidRC(new): pass1 failed\n");
+		return 0;
+	}
+
+	_state=RS_PASS1;
+
+	return 1;
+}
+
+uint8_t ADM_newXvidRc::logPass1(uint32_t qz, ADM_rframe ftype,uint32_t size)
+{
+	xvid_plg_data_t  data;
+
+	memset(&data,0,sizeof(data));
+	data.stats.version=FAKE_VERSION;
+	data.version=FAKE_VERSION;
+
+	switch(ftype)
+	{
+		case RF_I:
+			data.stats.type=XVID_TYPE_IVOP;
+			break;
+		case RF_P:
+			data.stats.type=XVID_TYPE_PVOP;
+			break;
+		case RF_B:
+			data.stats.type=XVID_TYPE_BVOP;
+			break;
+	}
+
+	data.stats.quant=qz;
+	data.stats.length=size;
+
+	rc_2pass1_after((rc_2pass1_t *)myHandle,&data);
+	_nbFrames++;
+
+	return 1;
+}
+uint8_t ADM_newXvidRc::getInfo(uint32_t framenum, uint32_t *qz, uint32_t *size,ADM_rframe *type )
+{
+	rc_2pass2_t * rc;
+	int override=0;
+
+	assert(_state==RS_PASS2);
+	rc=(rc_2pass2_t *)myHandle;
+	assert(rc);
+
+	assert(framenum<_totalFrame);
+	if(framenum>=rc->num_frames) // We may have 2 stray frames due to encoder lag
+	{
+		// but only 2
+		//ADM_assert(framenum<rc->num_frames+2)
+		override=1;
+	}
+
+	if(framenum>=_totalFrame-2)
+	{
+		override=1;
+	}
+
+	if(override)
+	{
+		printf("[Xvid rc] Override\n");
+		*type=RF_I;
+		*qz=4;
+		*size=1000;
+		return 1;
+	}
+
+	*qz=rc->stats[framenum].quant;
+	*size=rc->stats[framenum].length;
+
+	switch(rc->stats[framenum].type)
+	{
+		case XVID_TYPE_IVOP:
+			*type=RF_I;
+			break;
+		case XVID_TYPE_PVOP:
+			*type=RF_P;
+			break;
+		case XVID_TYPE_BVOP:
+			*type=RF_B;
+			break;
+		default:
+			printf("f:%lu Type : %d\n",framenum,rc->stats[framenum].type);
+			assert(0);
+	}
+
+	return 1;
+
+}
+//
+uint8_t ADM_newXvidRc::startPass2( uint32_t final_size,uint32_t nbFrame )
+{
+	xvid_plugin_2pass2_t 	data;
+	xvid_plg_create_t	create;
+
+	assert((_state==RS_IDLE)||(_state==RS_PASS1));
+
+	if (_state==RS_PASS1)
+	{
+		xvid_plg_destroy_t data;
+		printf("Destroying new xvid ratecontrol(pass1)\n");
+		data.version=FAKE_VERSION;
+		rc_2pass1_destroy((rc_2pass1_t *)myHandle,&data);
+		myHandle=NULL;
+	}
+
+	printf("[Xvid RC] Starting pass2 , %u frames\n",nbFrame);
+	_totalFrame=_nbFrames=nbFrame;
+	memset(&data,0,sizeof(data));
+	memset(&create,0,sizeof(create));
+
+	//avg/=1000; //bps / kbps
+
+	printf("Xvidr: pass2 : %lu MB, avg:%d, nbframe:%lu\n",final_size,0,_nbFrames);
+
+	create.version=FAKE_VERSION;
+	create.param=&data;	
+
+	data.version=FAKE_VERSION; // Fake 1.1
+	data.filename=_logname;
+
+	create.width=720;
+	create.height=576;
+
+	// incr/base =1000/fps1000
+	//base*1000=incr*fps1000
+	// base=fps1000 incr=1000
+	create.fbase=_fps1000;
+	create.fincr=1000;
+
+	data.bitrate=-1024*final_size;
+	data.keyframe_boost=10;
+	/*
+	data.curve_compression_high=10;
+	data.curve_compression_low=10;
+	data.overflow_control_strength=10;
+	data.max_overflow_improvement=10;
+	data.max_overflow_degradation=10;
+	data.kfreduction=10;
+	data.kfthreshold=10;
+	*/
+
+	if(rc_2pass2_create(&create, (rc_2pass2_t **)&myHandle))
+	{
+		printf("XvidRC(new): pass2 failed\n");
+		_state=RS_IDLE;
+		return 0;
+	}
+
+	_state=RS_PASS2;
+	_nbFrames=0;
+	memset(&_2pass_data,0,sizeof(_2pass_data));
+	_2pass_data.bquant_ratio=130;
+	_2pass_data.bquant_offset=100;
+	_2pass_data.version=FAKE_VERSION;
+
+	return 1;
+}
+
+uint8_t ADM_newXvidRc::getQz( uint32_t *qz, ADM_rframe *type )
+{
+	_2pass_data.frame_num=_nbFrames;
+	_2pass_data.quant=0;
+
+	rc_2pass2_before((rc_2pass2_t *)myHandle, &_2pass_data);
+	*qz=_2pass_data.quant;
+
+	switch(_2pass_data.type)
+	{
+		case XVID_TYPE_IVOP:
+			*type=RF_I;
+			break;
+		case XVID_TYPE_PVOP:
+			*type=RF_P;
+			break;
+		case XVID_TYPE_BVOP:
+			*type=RF_B;
+			break;
+		default:
+			assert(0);
+	}
+
+	return 1;
+}
+uint8_t ADM_newXvidRc::logPass2( uint32_t qz, ADM_rframe ftype,uint32_t size)
+{
+	switch(ftype)
+	{
+		case RF_I:
+			_2pass_data.type=XVID_TYPE_IVOP;
+			break;
+		case RF_P:
+			_2pass_data.type=XVID_TYPE_PVOP;
+			break;
+		case RF_B:
+			_2pass_data.type=XVID_TYPE_BVOP;
+			break;
+		default:
+			assert(0);		
+	}
+
+	_2pass_data.quant=qz;
+	_2pass_data.length=size;
+	_2pass_data.frame_num=_nbFrames;
+
+	for(int i=0;i<3;i++)
+	{
+		_2pass_data.min_quant[i]=2;
+		_2pass_data.max_quant[i]=31;
+
+	}
+
+	//rc_2pass2_after(rc_2pass2_t * rc, xvid_plg_data_t * data);
+	rc_2pass2_after((rc_2pass2_t *)myHandle,&_2pass_data);
+	_nbFrames++;
+
+	return 1;
+}
+
+/*****************************************************************************
+* Sub plugin functions definitions
+****************************************************************************/
+
+/* First a few local helping function prototypes */
+
+
+/*----------------------------------------------------------------------------
+*--------------------------------------------------------------------------*/
+
+int
+rc_2pass2_create(xvid_plg_create_t * create, rc_2pass2_t **handle)
+{
+	xvid_plugin_2pass2_t * param = (xvid_plugin_2pass2_t *)create->param;
+	rc_2pass2_t * rc;
+	int i;
+
+	rc =(rc_2pass2_t *) malloc(sizeof(rc_2pass2_t));
+	if (rc == NULL)
+		return XVID_ERR_MEMORY;
+
+	/* v1.0.x */
+	rc->param.version = param->version;
+	rc->param.bitrate = param->bitrate;
+	rc->param.filename = param->filename;
+	rc->param.keyframe_boost = param->keyframe_boost;
+	rc->param.curve_compression_high = param->curve_compression_high;
+	rc->param.curve_compression_low = param->curve_compression_low;
+	rc->param.overflow_control_strength = param->overflow_control_strength;
+	rc->param.max_overflow_improvement = param->max_overflow_improvement;
+	rc->param.max_overflow_degradation = param->max_overflow_degradation;
+	rc->param.kfreduction = param->kfreduction;
+	rc->param.kfthreshold = param->kfthreshold;
+	rc->param.container_frame_overhead = param->container_frame_overhead;
+
+	if (XVID_VERSION_MINOR(param->version) >= 1) {
+		rc->param.vbv_size = param->vbv_size;
+		rc->param.vbv_initial = param->vbv_initial;
+		rc->param.vbv_maxrate = param->vbv_maxrate;
+		rc->param.vbv_peakrate = param->vbv_peakrate;
+	}else{
+		rc->param.vbv_size =
+			rc->param.vbv_initial =
+			rc->param.vbv_maxrate =
+			rc->param.vbv_peakrate = 0;
+	}
+
+	/* Initialize all defaults */
+#define _INIT(a, b) if((a) <= 0) (a) = (b)
+	/* Let's set our defaults if needed */
+	_INIT(rc->param.keyframe_boost, DEFAULT_KEYFRAME_BOOST);
+	_INIT(rc->param.overflow_control_strength, DEFAULT_OVERFLOW_CONTROL_STRENGTH);
+	_INIT(rc->param.curve_compression_high, DEFAULT_CURVE_COMPRESSION_HIGH);
+	_INIT(rc->param.curve_compression_low, DEFAULT_CURVE_COMPRESSION_LOW);
+	_INIT(rc->param.max_overflow_improvement, DEFAULT_MAX_OVERFLOW_IMPROVEMENT);
+	_INIT(rc->param.max_overflow_degradation,  DEFAULT_MAX_OVERFLOW_DEGRADATION);
+
+	/* Keyframe settings */
+	_INIT(rc->param.kfreduction, DEFAULT_KFREDUCTION);
+	_INIT(rc->param.kfthreshold, DEFAULT_KFTHRESHOLD);
+#undef _INIT
+
+	/* Initialize some stuff to zero */
+	for(i=0; i<3; i++) {
+		int j;
+		for (j=0; j<32; j++) {
+			rc->quant_error[i][j] = 0;
+			rc->quant_count[i][j] = 0;
+		}
+	}
+
+	for (i=0; i<3; i++) rc->last_quant[i] = 0;
+
+	rc->fq_error = 0;
+	rc->min_quant = 1;
+
+	/* Count frames (and intra frames) in the stats file, store the result into
+	* the rc structure */
+	if (statsfile_count_frames(rc, param->filename) == -1) {
+		DPRINTF(XVID_DEBUG_RC,"[xvid rc] -- ERROR: fopen %s failed\n", param->filename);
+		free(rc);
+		return(XVID_ERR_FAIL);
+	}
+	printf("[xvid rc] -- found %d frames %d keyframes\n",rc->num_frames,rc->num_keyframes);
+	/* Allocate the stats' memory */
+	if ((rc->stats =(twopass_stat_t *) malloc(rc->num_frames * sizeof(twopass_stat_t))) == NULL) {
+		free(rc);
+		return(XVID_ERR_MEMORY);
+	}
+
+	/* Allocate keyframes location's memory
+	* PS: see comment in pre_process0 for the +1 location requirement */
+	rc->keyframe_locations = (int *)malloc((rc->num_keyframes + 1) * sizeof(int));
+	if (rc->keyframe_locations == NULL) {
+		free(rc->stats);
+		free(rc);
+		return(XVID_ERR_MEMORY);
+	}
+
+	/* Load the first pass stats */
+	if (statsfile_load(rc, param->filename) == -1) {
+		DPRINTF(XVID_DEBUG_RC,"[xvid rc] -- ERROR: fopen %s failed\n", param->filename);
+		free(rc->keyframe_locations);
+		free(rc->stats);
+		free(rc);
+		return XVID_ERR_FAIL;
+	}
+
+	/* Compute the target filesize */
+	if (rc->param.bitrate<0) {
+		/* if negative, bitrate equals the target (in kbytes) */
+		rc->target = ((uint64_t)(-rc->param.bitrate)) * 1024;
+	} else if (rc->num_frames  < create->fbase/create->fincr) {
+		/* Source sequence is less than 1s long, we do as if it was 1s long */
+		rc->target = rc->param.bitrate / 8;
+	} else {
+		/* Target filesize = bitrate/8 * numframes / framerate */
+		rc->target =
+			((uint64_t)rc->param.bitrate * (uint64_t)rc->num_frames * \
+			(uint64_t)create->fincr) / \
+			((uint64_t)create->fbase * 8);
+	}
+
+	DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- Frame rate: %d/%d (%ffps)\n",
+		create->fbase, create->fincr,
+		(double)create->fbase/(double)create->fincr);
+	DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- Number of frames: %d\n", rc->num_frames);
+	if(rc->param.bitrate>=0)
+		DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- Target bitrate: %ld\n", rc->param.bitrate);
+	DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- Target filesize: %lld\n", rc->target);
+
+	/* Compensate the average frame overhead caused by the container */
+	rc->target -= rc->num_frames*rc->param.container_frame_overhead;
+	DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- Container Frame overhead: %d\n", rc->param.container_frame_overhead);
+	if(rc->param.container_frame_overhead)
+		DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- New target filesize after container compensation: %lld\n", rc->target);
+
+	/* When bitrate is not given it means it has been scaled by an external
+	* application */
+	if (rc->param.bitrate) {
+		/* Apply zone settings
+		* - set rc->tot_quant which represents the total num of bytes spent in
+		*   fixed quant zones
+		* - set rc->tot_weighted which represents the total amount of bytes
+		*   spent in normal or weighted zones in first pass (normal zones can
+		*   be considered weight=1)
+		* - set rc->tot_quant_invariant which represents the total num of bytes
+		*   spent in fixed quant zones for headers */
+		zone_process(rc, create);
+	} else {
+		/* External scaling -- zones are ignored */
+		for (i=0;i<rc->num_frames;i++) {
+			rc->stats[i].zone_mode = XVID_ZONE_WEIGHT;
+			rc->stats[i].weight = 1.0;
+		}
+		rc->tot_quant = 0;
+	}
+
+	/* Gathers some information about first pass stats:
+	*  - finds the minimum frame length for each frame type during 1st pass.
+	*     rc->min_size[]
+	*  - determines the maximum frame length observed (no frame type distinction).
+	*     rc->max_size
+	*  - count how many times each frame type has been used.
+	*     rc->count[]
+	*  - total bytes used per frame type
+	*     rc->tot_length[]
+	*  - total bytes considered invariant between the 2 passes
+	*  - store keyframe location
+	*     rc->keyframe_locations[]
+	*/
+	first_pass_stats_prepare_data(rc);
+
+	/* If we have a user bitrate, it means it's an internal curve scaling */
+	if (rc->param.bitrate) {
+		/* Perform internal curve scaling */
+		first_pass_scale_curve_internal(rc);
+	}
+
+	/* Apply advanced curve options, and compute some parameters in order to
+	* shape the curve in the BEFORE/AFTER pair of functions */
+	scaled_curve_apply_advanced_parameters(rc);
+
+	/* Check curve for VBV compliancy and rescale if necessary */
+#ifdef VBV_FORCE
+	if (rc->param.vbv_size==0) {
+		rc->param.vbv_size      =  3145728;
+		rc->param.vbv_initial   =  2359296;
+		rc->param.vbv_maxrate  =  4000000;
+		rc->param.vbv_peakrate = 10000000;
+	}
+#endif
+
+	/* vbv_size==0 switches VBV check off */
+	if (rc->param.vbv_size > 0)  {
+		const double fps = (double)create->fbase/(double)create->fincr;
+		int status = check_curve_for_vbv_compliancy(rc, fps);
+
+		if (status) {
+			DPRINTF(XVID_DEBUG_RC, "[xvid rc] Underflow detected - Scaling Curve for compliancy.\n");
+		}
+
+		status = scale_curve_for_vbv_compliancy(rc, fps);
+
+		if (status == 0) {
+			DPRINTF(XVID_DEBUG_RC, "[xvid rc] VBV compliant curve scaling done.\n");
+		} else {
+			DPRINTF(XVID_DEBUG_RC, "[xvid rc] VBV compliant curve scaling impossible.\n");
+		}
+	}
+	*handle = rc;
+	return(0);
+}
+
+/*----------------------------------------------------------------------------
+*--------------------------------------------------------------------------*/
+
+int
+rc_2pass2_destroy(rc_2pass2_t * rc, xvid_plg_destroy_t * destroy)
+{
+	DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- target_total:%lld desired_total:%.2f (%.2f%%) actual_total:%.2f (%.2f%%)\n",
+		rc->target,
+		rc->desired_total,
+		100*rc->desired_total/(double)rc->target,
+		rc->real_total,
+		100*rc->real_total/(double)rc->target);
+
+	free(rc->keyframe_locations);
+	free(rc->stats);
+	free(rc);
+	return(0);
+}
+
+/*----------------------------------------------------------------------------
+*--------------------------------------------------------------------------*/
+
+int
+rc_2pass2_before(rc_2pass2_t * rc, xvid_plg_data_t * data)
+{
+	twopass_stat_t * s = &rc->stats[data->frame_num];
+	static double dbytes=0;
+	double scaled_quant;
+	double overflow;
+	int capped_to_max_framesize = 0;
+
+	/* This function is quite long but easy to understand. In order to simplify
+	* the code path (a bit), we treat 3 cases that can return immediatly. */
+
+	/* First case: Another plugin has already set a quantizer */
+	if (data->quant > 0)
+		return(0);
+
+	/* Second case: insufficent stats data
+	* We can't guess much what we should do, let core decide all alone */
+	if (data->frame_num >= rc->num_frames) {
+		DPRINTF(XVID_DEBUG_RC,"[xvid rc] -- stats file too short (now processing frame %d)",
+			data->frame_num);
+		return(0);
+	}
+
+	/* Third case: We are in a Quant zone
+	* Quant zones must just ensure we use the same settings as first pass
+	* So set the quantizer and the type */
+	if (s->zone_mode == XVID_ZONE_QUANT) {
+		/* Quant stuff */
+		rc->fq_error += s->weight;
+		data->quant = (int)rc->fq_error;
+		rc->fq_error -= data->quant;
+
+		/* The type stuff */
+		data->type = s->type;
+
+		/* The only required data for AFTER step is this one for the overflow
+		* control */
+		s->desired_length = s->length;
+
+		return(0);
+	}
+
+
+	/*************************************************************************/
+	/*************************************************************************/
+	/*************************************************************************/
+
+	/*-------------------------------------------------------------------------
+	* Frame bit allocation first part
+	*
+	* First steps apply user settings, just like it is done in the theoritical
+	* scaled_curve_apply_advanced_parameters
+	*-----------------------------------------------------------------------*/
+
+	/* Set desired to what we are wanting to obtain for this frame */
+	dbytes = (double)s->scaled_length;
+
+	/* IFrame user settings*/
+	if (s->type == XVID_TYPE_IVOP) {
+		/* Keyframe boosting -- All keyframes benefit from it */
+		dbytes += dbytes*rc->param.keyframe_boost / 100;
+
+#if 0 /* ToDo: decide how to apply kfthresholding */
+#endif
+	} else {
+
+		/* P/S/B frames must reserve some bits for iframe boosting */
+		dbytes *= rc->pb_iboost_tax_ratio;
+
+		/* Apply assymetric curve compression */
+		if (rc->param.curve_compression_high || rc->param.curve_compression_low) {
+			double assymetric_delta;
+
+			/* Compute the assymetric delta, this is computed before applying
+			* the tax, as done in the pre_process function */
+			if (dbytes > rc->avg_length[s->type-1])
+				assymetric_delta = (rc->avg_length[s->type-1] - dbytes) * rc->param.curve_compression_high / 100.0;
+			else
+				assymetric_delta = (rc->avg_length[s->type-1] - dbytes) * rc->param.curve_compression_low  / 100.0;
+
+			/* Now we must apply the assymetric tax, else our curve compression
+			* would not give a theoritical target size equal to what it is
+			* expected */
+			dbytes *= rc->assymetric_tax_ratio;
+
+			/* Now we can add the assymetric delta */
+			dbytes += assymetric_delta;
+		}
+	}
+
+	/* That is what we would like to have -- Don't put that chunk after
+	* overflow control, otherwise, overflow is counted twice and you obtain
+	* half sized bitrate sequences */
+	s->desired_length  = (int)dbytes;
+	rc->desired_total += dbytes;
+
+	/*------------------------------------------------------------------------
+	* Frame bit allocation: overflow control part.
+	*
+	* Unlike the theoritical scaled_curve_apply_advanced_parameters, here
+	* it's real encoding and we need to make sure we don't go so far from
+	* what is our ideal scaled curve.
+	*-----------------------------------------------------------------------*/
+
+	/* Compute the overflow we should compensate */
+	if (s->type != XVID_TYPE_IVOP || rc->overflow > 0) {
+		double frametype_factor;
+		double framesize_factor;
+
+		/* Take only the desired part of overflow */
+		overflow = rc->overflow;
+
+		/* Factor that will take care to decrease the overflow applied
+		* according to the importance of this frame type in term of
+		* overall size */
+		frametype_factor  = rc->count[XVID_TYPE_IVOP-1]*rc->avg_length[XVID_TYPE_IVOP-1];
+		frametype_factor += rc->count[XVID_TYPE_PVOP-1]*rc->avg_length[XVID_TYPE_PVOP-1];
+		frametype_factor += rc->count[XVID_TYPE_BVOP-1]*rc->avg_length[XVID_TYPE_BVOP-1];
+		frametype_factor /= rc->count[s->type-1]*rc->avg_length[s->type-1];
+		frametype_factor  = 1/frametype_factor;
+
+		/* Factor that will take care not to compensate too much for this frame
+		* size */
+		framesize_factor  = dbytes;
+		framesize_factor /= rc->avg_length[s->type-1];
+
+		/* Treat only the overflow part concerned by this frame type and size */
+		overflow *= frametype_factor;
+#if 0
+		/* Leave this one alone, as it impacts badly on quality */
+		overflow *= framesize_factor;
+#endif
+
+		/* Apply the overflow strength imposed by the user */
+		overflow *= (rc->param.overflow_control_strength/100.0f);
+	} else {
+		/* no negative overflow applied in IFrames because:
+		*  - their role is important as they're references for P/BFrames.
+		*  - there aren't much in typical sequences, so if an IFrame overflows too
+		*    much, this overflow may impact the next IFrame too much and generate
+		*    a sequence of poor quality frames */
+		overflow = 0;
+	}
+
+	/* Make sure we are not trying to compensate more overflow than we even have */
+	if (fabs(overflow) > fabs(rc->overflow))
+		overflow = rc->overflow;
+
+	/* Make sure the overflow doesn't make the frame size to get out of the range
+	* [-max_degradation..+max_improvment] */
+	if (overflow > dbytes*rc->param.max_overflow_improvement / 100) {
+		if(overflow <= dbytes)
+			dbytes += dbytes * rc->param.max_overflow_improvement / 100;
+		else
+			dbytes += overflow * rc->param.max_overflow_improvement / 100;
+	} else if (overflow < - dbytes * rc->param.max_overflow_degradation / 100) {
+		dbytes -= dbytes * rc->param.max_overflow_degradation / 100;
+	} else {
+		dbytes += overflow;
+	}
+
+	/*-------------------------------------------------------------------------
+	* Frame bit allocation last part:
+	*
+	* Cap frame length so we don't reach neither bigger frame sizes than first
+	* pass nor smaller than the allowed minimum.
+	*-----------------------------------------------------------------------*/
+
+#ifdef PASS_SMALLER
+	if (dbytes > s->length) {
+		dbytes = s->length;
+	}
+#endif
+
+	/* Prevent stupid desired sizes under logical values */
+	if (dbytes < rc->min_length[s->type-1]) {
+		dbytes = rc->min_length[s->type-1];
+	}
+
+	/*------------------------------------------------------------------------
+	* Desired frame length <-> quantizer mapping
+	*-----------------------------------------------------------------------*/
+	// Meanx
+	// For raw mpeg2 encoding access we will use bquant etc directly
+	// as for that, we do final=1squant*100/bquant_ratio+
+
+#ifdef BQUANT_PRESCALE 
+	if(s->type == XVID_TYPE_BVOP) {
+
+		twopass_stat_t *b_ref = s;
+
+		/* Find the reference frame */
+		while(b_ref != &rc->stats[0] && b_ref->type == XVID_TYPE_BVOP)
+			b_ref--;
+
+		/* Compute the original quant */
+		s->quant  = 2*(100*s->quant - data->bquant_offset);
+		s->quant += data->bquant_ratio - 1; /* to avoid rounding issues */
+		s->quant  = s->quant/data->bquant_ratio - b_ref->quant;
+	}
+
+#endif
+#ifdef MEANX_RESCALE
+	/* For bframes we prescale the quantizer to avoid too high quant scaling */
+	if(s->type == XVID_TYPE_BVOP) 
+	{
+		int newquant;
+
+		newquant=data->bquant_ratio*s->quant+data->bquant_offset;;
+		newquant/=100;
+
+		s->quant=newquant;		
+	}
+#endif
+
+	/* Don't laugh at this very 'simple' quant<->size relationship, it
+	* proves to be acurate enough for our algorithm */
+	scaled_quant = (double)s->quant*(double)s->length/(double)dbytes;
+
+#ifdef COMPENSATE_FORMULA
+	/* We know xvidcore will apply the bframe formula again, so we compensate
+	* it right now to make sure we would not apply it twice */
+	if(s->type == XVID_TYPE_BVOP) {
+
+		twopass_stat_t *b_ref = s;
+
+		/* Find the reference frame */
+		while(b_ref != &rc->stats[0] && b_ref->type == XVID_TYPE_BVOP)
+			b_ref--;
+
+		/* Compute the quant it would be if the core did not apply the bframe
+		* formula */
+		scaled_quant  = 100*scaled_quant - data->bquant_offset;
+		scaled_quant += data->bquant_ratio - 1; /* to avoid rouding issues */
+		scaled_quant /= data->bquant_ratio;
+	}
+#endif
+
+	/* Quantizer has been scaled using floating point operations/results, we
+	* must cast it to integer */
+	data->quant = (int)scaled_quant;
+
+	/* Let's clip the computed quantizer, if needed */
+	if (data->quant < 1) {
+		data->quant = 1;
+	} else if (data->quant > 31) {
+		data->quant = 31;
+	} else {
+
+		/* The frame quantizer has not been clipped, this appears to be a good
+		* computed quantizer, do not loose quantizer decimal part that we
+		* accumulate for later reuse when its sum represents a complete
+		* unit. */
+		rc->quant_error[s->type-1][data->quant] += scaled_quant - (double)data->quant;
+
+		if (rc->quant_error[s->type-1][data->quant] >= 1.0) {
+			rc->quant_error[s->type-1][data->quant] -= 1.0;
+			data->quant++;
+		} else if (rc->quant_error[s->type-1][data->quant] <= -1.0) {
+			rc->quant_error[s->type-1][data->quant] += 1.0;
+			data->quant--;
+		}
+	}
+
+	/* Now we have a computed quant that is in the right quante range, with a
+	* possible +1 correction due to cumulated error. We can now safely clip
+	* the quantizer again with user's quant ranges. "Safely" means the Rate
+	* Control could learn more about this quantizer, this knowledge is useful
+	* for future frames even if it this quantizer won't be really used atm,
+	* that's why we don't perform this clipping earlier. */
+	if (data->quant < data->min_quant[s->type-1]) {
+		data->quant = data->min_quant[s->type-1];
+	} else if (data->quant > data->max_quant[s->type-1]) {
+		data->quant = data->max_quant[s->type-1];
+	}
+
+	if (data->quant < rc->min_quant) data->quant = rc->min_quant;
+
+	/* To avoid big quality jumps from frame to frame, we apply a "security"
+	* rule that makes |last_quant - new_quant| <= 2. This rule only applies
+	* to predicted frames (P and B) */
+	if (s->type != XVID_TYPE_IVOP && rc->last_quant[s->type-1] && capped_to_max_framesize == 0) {
+
+		if (data->quant > rc->last_quant[s->type-1] + 2) {
+			data->quant = rc->last_quant[s->type-1] + 2;
+			DPRINTF(XVID_DEBUG_RC,
+				"[xvid rc] -- frame %d p/b-frame quantizer prevented from rising too steeply\n",
+				data->frame_num);
+		}
+		if (data->quant < rc->last_quant[s->type-1] - 2) {
+			data->quant = rc->last_quant[s->type-1] - 2;
+			DPRINTF(XVID_DEBUG_RC,
+				"[xvid rc] -- frame:%d p/b-frame quantizer prevented from falling too steeply\n",
+				data->frame_num);
+		}
+	}
+
+	/* We don't want to pollute the RC histerisis when our computed quant has
+	* been computed from a capped frame size */
+	if (capped_to_max_framesize == 0)
+		rc->last_quant[s->type-1] = data->quant;
+
+	/* Don't forget to force 1st pass frame type ;-) */
+	data->type = s->type;
+
+	return 0;
+}
+
+/*----------------------------------------------------------------------------
+*--------------------------------------------------------------------------*/
+
+int
+rc_2pass2_after(rc_2pass2_t * rc, xvid_plg_data_t * data)
+{
+	const char frame_type[4] = { 'i', 'p', 'b', 's'};
+	twopass_stat_t * s = &rc->stats[data->frame_num];
+
+	/* Insufficent stats data */
+	if (data->frame_num >= rc->num_frames)
+		return 0;
+
+	/* Update the quantizer counter */
+	rc->quant_count[s->type-1][data->quant]++;
+
+	/* Update the frame type overflow */
+	if (data->type == XVID_TYPE_IVOP) {
+		int kfdiff = 0;
+
+		if(rc->KF_idx != rc->num_frames -1) {
+			kfdiff  = rc->keyframe_locations[rc->KF_idx+1];
+			kfdiff -= rc->keyframe_locations[rc->KF_idx];
+		}
+
+		/* Flush Keyframe overflow accumulator */
+		rc->overflow += rc->KFoverflow;
+
+		/* Store the frame overflow to the keyframe accumulator */
+		rc->KFoverflow = s->desired_length - data->length;
+
+		if (kfdiff > 1) {
+			/* Non-consecutive keyframes case:
+			* We can then divide this total keyframe overflow into equal parts
+			* that we will distribute into regular overflow at each frame
+			* between the sequence bounded by two IFrames */
+			rc->KFoverflow_partial = rc->KFoverflow / (kfdiff - 1);
+		} else {
+			/* Consecutive keyframes case:
+			* Flush immediatly the keyframe overflow and reset keyframe
+			* overflow */
+			rc->overflow += rc->KFoverflow;
+			rc->KFoverflow = 0;
+			rc->KFoverflow_partial = 0;
+		}
+		rc->KF_idx++;
+	} else {
+		/* Accumulate the frame overflow */
+		rc->overflow += s->desired_length - data->length;
+
+		/* Distribute part of the keyframe overflow */
+		rc->overflow += rc->KFoverflow_partial;
+
+		/* Don't forget to substract that same amount from the total keyframe
+		* overflow */
+		rc->KFoverflow -= rc->KFoverflow_partial;
+	}
+
+	rc->overflow += (s->error = s->desired_length - data->length);
+	rc->real_total += data->length;
+
+	DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- frame:%d type:%c quant:%d stats:%d scaled:%d desired:%d actual:%d error:%d overflow:%.2f\n",
+		data->frame_num,
+		frame_type[data->type-1],
+		data->quant,
+		s->length,
+		s->scaled_length,
+		s->desired_length,
+		s->desired_length - s->error,
+		-s->error,
+		rc->overflow);
+
+	return(0);
+}
+
+void writeQuantStat(rc_2pass2_t * rc){
+	unsigned int i,j;
+	unsigned int sum,sum2,frames;
+	char str[strlen(rc->param.filename) + 4];
+	char *dot;
+	FILE *fd;
+	strcpy(str,rc->param.filename);
+	if( (dot = strrchr(str,'.')) ){
+		*dot = '\0';
+	}
+	strcat(str,".qs");
+	if( (fd=fopen(str,"wb")) ){
+		sum2=frames=0;
+		for(j=2;j<32;j++){
+			sum=0;
+			fprintf(fd,"q%02u: ",j);
+			for(i=0;i<3;i++){
+				sum+=rc->quant_count[i][j];
+				fprintf(fd,"%u: %6u ",i,rc->quant_count[i][j]);
+			}
+			sum2+=sum*j;
+			frames+=sum;
+			fprintf(fd,"sum: %6u\n",sum);
+		}
+		fprintf(fd,"\nQuant over all: %2.2f\n",(float)sum2/(float)frames);
+		fclose(fd);
+	}
+}
+
+/*****************************************************************************
+* Helper functions definition
+****************************************************************************/
+
+/* Default buffer size for reading lines */
+#define BUF_SZ   1024
+
+/* Helper functions for reading/parsing the stats file */
+
+/* This function counts the number of frame entries in the stats file
+* It also counts the number of I Frames */
+int
+statsfile_count_frames(rc_2pass2_t * rc, char * filename)
+{
+	FILE * f;
+	char *line;
+	int lines;
+
+	rc->num_frames = 0;
+	rc->num_keyframes = 0;
+
+	if ((f = fopen(filename, "rb")) == NULL)
+		return(-1);
+
+	lines = 0;
+	while ((line = readline(f)) != NULL) {
+
+		char *ptr;
+		char type;
+		int fields;
+
+		lines++;
+
+		/* We skip spaces */
+		ptr = skipspaces(line);
+
+		/* Skip coment lines or empty lines */
+		if(iscomment(ptr) || *ptr == '\0') {
+			free(line);
+			continue;
+		}
+
+		/* Read the stat line from buffer */
+		fields = sscanf(ptr, "%c", &type);
+
+		/* Valid stats files have at least 7 fields */
+		if (fields == 1) {
+			switch(type) {
+			case 'i':
+			case 'I':
+				rc->num_keyframes++;
+			case 'p':
+			case 'P':
+			case 'b':
+			case 'B':
+			case 's':
+			case 'S':
+				rc->num_frames++;
+				break;
+			default:
+				DPRINTF(XVID_DEBUG_RC,
+					"[xvid rc] -- WARNING: L%d unknown frame type used (%c).\n",
+					lines, type);
+			}
+		} else {
+			DPRINTF(XVID_DEBUG_RC,
+				"[xvid rc] -- WARNING: L%d misses some stat fields (%d).\n",
+				lines, 7-fields);
+		}
+
+		/* Free the line buffer */
+		free(line);
+	}
+
+	/* We are done with the file */
+	fclose(f);
+
+	return(0);
+}
+
+/* open stats file(s) and read into rc->stats array */
+int
+statsfile_load(rc_2pass2_t *rc, char * filename)
+{
+	FILE * f;
+	int processed_entries;
+
+	/* Opens the file */
+	if ((f = fopen(filename, "rb"))==NULL)
+		return(-1);
+
+	processed_entries = 0;
+	while(processed_entries < rc->num_frames) {
+		char type;
+		int fields;
+		twopass_stat_t * s = &rc->stats[processed_entries];
+		char *line, *ptr;
+
+		/* Read the line from the file */
+		if((line = readline(f)) == NULL)
+			break;
+
+		/* We skip spaces */
+		ptr = skipspaces(line);
+
+		/* Skip comment lines or empty lines */
+		if(iscomment(ptr) || *ptr == '\0') {
+			free(line);
+			continue;
+		}
+
+		/* Reset this field that is optional */
+		s->scaled_length = 0;
+
+		/* Convert the fields */
+		fields = sscanf(ptr,
+			"%c %d %d %d %d %d %d %d\n",
+			&type,
+			&s->quant,
+			&s->blks[0], &s->blks[1], &s->blks[2],
+			&s->length, &s->invariant /* not really yet */,
+			&s->scaled_length);
+
+		/* Free line buffer, we don't need it anymore */
+		free(line);
+
+		/* Fail silently, this has probably been warned in
+		* statsfile_count_frames */
+		if(fields != 7 && fields != 8)
+			continue;
+
+		/* Convert frame type and compute the invariant length part */
+		switch(type) {
+		case 'i':
+		case 'I':
+			s->type = XVID_TYPE_IVOP;
+			s->invariant /= INVARIANT_HEADER_PART_IVOP;
+			break;
+		case 'p':
+		case 'P':
+		case 's':
+		case 'S':
+			s->type = XVID_TYPE_PVOP;
+			s->invariant /= INVARIANT_HEADER_PART_PVOP;
+			break;
+		case 'b':
+		case 'B':
+			s->type = XVID_TYPE_BVOP;
+			s->invariant /= INVARIANT_HEADER_PART_BVOP;
+			break;
+		default:
+			/* Same as before, fail silently */
+			continue;
+		}
+
+		/* Ok it seems it's been processed correctly */
+		processed_entries++;
+	}
+
+	/* Close the file */
+	fclose(f);
+
+	return(0);
+}
+
+/* pre-process the statistics data
+* - for each type, count, tot_length, min_length, max_length
+* - set keyframes_locations, tot_prescaled */
+void
+first_pass_stats_prepare_data(rc_2pass2_t * rc)
+{
+	int i,j;
+
+	/* *rc fields initialization
+	* NB: INT_MAX and INT_MIN are used in order to be immediately replaced
+	*     with real values of the 1pass */
+	for (i=0; i<3; i++) {
+		rc->count[i]=0;
+		rc->tot_length[i] = 0;
+		rc->tot_invariant[i] = 0;
+		rc->min_length[i] = INT_MAX;
+	}
+
+	rc->max_length = INT_MIN;
+	rc->tot_weighted = 0;
+
+	/* Loop through all frames and find/compute all the stuff this function
+	* is supposed to do */
+	for (i=j=0; i<rc->num_frames; i++) {
+		twopass_stat_t * s = &rc->stats[i];
+
+		rc->count[s->type-1]++;
+		rc->tot_length[s->type-1] += s->length;
+		rc->tot_invariant[s->type-1] += s->invariant;
+		if (s->zone_mode != XVID_ZONE_QUANT)
+			rc->tot_weighted += (int)(s->weight*(s->length - s->invariant));
+
+		if (s->length < rc->min_length[s->type-1]) {
+			rc->min_length[s->type-1] = s->length;
+		}
+
+		if (s->length > rc->max_length) {
+			rc->max_length = s->length;
+		}
+
+		if (s->type == XVID_TYPE_IVOP) {
+			rc->keyframe_locations[j] = i;
+			j++;
+		}
+	}
+
+	/* NB:
+	* The "per sequence" overflow system considers a natural sequence to be
+	* formed by all frames between two iframes, so if we want to make sure
+	* the system does not go nuts during last sequence, we force the last
+	* frame to appear in the keyframe locations array. */
+	rc->keyframe_locations[j] = i;
+
+	DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- Min 1st pass IFrame length: %d\n", rc->min_length[0]);
+	DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- Min 1st pass PFrame length: %d\n", rc->min_length[1]);
+	DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- Min 1st pass BFrame length: %d\n", rc->min_length[2]);
+}
+
+/* calculate zone weight "center" */
+void
+zone_process(rc_2pass2_t *rc, const xvid_plg_create_t * create)
+{
+	int i,j;
+	int n = 0;
+
+	rc->tot_quant = 0;
+	rc->tot_quant_invariant = 0;
+
+	if (create->num_zones == 0) {
+		for (j = 0; j < rc->num_frames; j++) {
+			rc->stats[j].zone_mode = XVID_ZONE_WEIGHT;
+			rc->stats[j].weight = 1.0;
+		}
+		n += rc->num_frames;
+	}
+
+
+	for(i=0; i < create->num_zones; i++) {
+
+		int next = (i+1<create->num_zones) ? create->zones[i+1].frame : rc->num_frames;
+
+		/* Zero weight make no sense */
+		if (create->zones[i].increment == 0) create->zones[i].increment = 1;
+		/* And obviously an undetermined infinite makes even less sense */
+		if (create->zones[i].base == 0) create->zones[i].base = 1;
+
+		if (i==0 && create->zones[i].frame > 0) {
+			for (j = 0; j < create->zones[i].frame && j < rc->num_frames; j++) {
+				rc->stats[j].zone_mode = XVID_ZONE_WEIGHT;
+				rc->stats[j].weight = 1.0;
+			}
+			n += create->zones[i].frame;
+		}
+
+		if (create->zones[i].mode == XVID_ZONE_WEIGHT) {
+			for (j = create->zones[i].frame; j < next && j < rc->num_frames; j++ ) {
+				rc->stats[j].zone_mode = XVID_ZONE_WEIGHT;
+				rc->stats[j].weight = (double)create->zones[i].increment / (double)create->zones[i].base;
+			}
+			next -= create->zones[i].frame;
+			n += next;
+		} else{  /* XVID_ZONE_QUANT */
+			for (j = create->zones[i].frame; j < next && j < rc->num_frames; j++ ) {
+				rc->stats[j].zone_mode = XVID_ZONE_QUANT;
+				rc->stats[j].weight = (double)create->zones[i].increment / (double)create->zones[i].base;
+				rc->tot_quant += rc->stats[j].length;
+				rc->tot_quant_invariant += rc->stats[j].invariant;
+			}
+		}
+	}
+}
+
+
+/* scale the curve */
+void
+first_pass_scale_curve_internal(rc_2pass2_t *rc)
+{
+	int64_t target;
+	int64_t total_invariant;
+	double scaler;
+	int i, num_MBs;
+
+	/* We only scale texture data ! */
+	total_invariant	 = rc->tot_invariant[XVID_TYPE_IVOP-1];
+	total_invariant += rc->tot_invariant[XVID_TYPE_PVOP-1];
+	total_invariant += rc->tot_invariant[XVID_TYPE_BVOP-1];
+	/* don't forget to substract header bytes used in quant zones, otherwise we
+	* counting them twice */
+	total_invariant -= rc->tot_quant_invariant;
+
+	/* We remove the bytes used by the fixed quantizer zones during first pass
+	* with the same quants, so we know very precisely how much that
+	* represents */
+	target	= rc->target;
+	target -= rc->tot_quant;
+
+	/* Let's compute a linear scaler in order to perform curve scaling */
+	scaler = (double)(target - total_invariant) / (double)(rc->tot_weighted);
+
+#ifdef SMART_OVERFLOW_SETTING
+	if (scaler > 0.9) {
+		rc->param.max_overflow_degradation *= 5;
+		rc->param.max_overflow_improvement *= 5;
+		rc->param.overflow_control_strength *= 3;
+	} else if (scaler > 0.6) {
+		rc->param.max_overflow_degradation *= 2;
+		rc->param.max_overflow_improvement *= 2;
+		rc->param.overflow_control_strength *= 2;
+	} else {
+		rc->min_quant = 2;
+	}
+#endif
+
+	/* Compute min frame lengths (for each frame type) according to the number
+	* of MBs. We sum all block type counters of frame 0, this gives us the
+	* number of MBs.
+	*
+	* We compare these hardcoded values with observed values in first pass
+	* (determined in pre_process0).Then we keep the real minimum. */
+
+	/* Number of MBs */
+	num_MBs  = rc->stats[0].blks[0];
+	num_MBs += rc->stats[0].blks[1];
+	num_MBs += rc->stats[0].blks[2];
+
+	/* Minimum for I frames */
+	if(rc->min_length[XVID_TYPE_IVOP-1] > ((num_MBs*22) + 240) / 8)
+		rc->min_length[XVID_TYPE_IVOP-1] = ((num_MBs*22) + 240) / 8;
+
+	/* Minimum for P/S frames */
+	if(rc->min_length[XVID_TYPE_PVOP-1] > ((num_MBs) + 88)  / 8)
+		rc->min_length[XVID_TYPE_PVOP-1] = ((num_MBs) + 88)  / 8;
+
+	/* Minimum for B frames */
+	if(rc->min_length[XVID_TYPE_BVOP-1] > 8)
+		rc->min_length[XVID_TYPE_BVOP-1] = 8;
+
+	/* Perform an initial scale pass.
+	*
+	* If a frame size is scaled underneath our hardcoded minimums, then we
+	* force the frame size to the minimum, and deduct the original & scaled
+	* frame length from the original and target total lengths */
+	for (i=0; i<rc->num_frames; i++) {
+		twopass_stat_t * s = &rc->stats[i];
+		int len;
+
+		/* No need to scale frame length for which a specific quantizer is
+		* specified thanks to zones */
+		if (s->zone_mode == XVID_ZONE_QUANT) {
+			s->scaled_length = s->length;
+			continue;
+		}
+
+		/* Compute the scaled length -- only non invariant data length is scaled */
+		len = s->invariant + (int)((double)(s->length-s->invariant) * scaler * s->weight);
+
+		/* Compare with the computed minimum */
+		if (len < rc->min_length[s->type-1]) {
+			/* This is a 'forced size' frame, set its frame size to the
+			* computed minimum */
+			s->scaled_length = rc->min_length[s->type-1];
+
+			/* Remove both scaled and original size from their respective
+			* total counters, as we prepare a second pass for 'regular'
+			* frames */
+			target -= s->scaled_length;
+		} else {
+			/* Do nothing for now, we'll scale this later */
+			s->scaled_length = 0;
+		}
+	}
+
+	/* The first pass on data substracted all 'forced size' frames from the
+	* total counters. Now, it's possible to scale the 'regular' frames. */
+
+	/* Scaling factor for 'regular' frames */
+	scaler = (double)(target - total_invariant) / (double)(rc->tot_weighted);
+
+	/* Do another pass with the new scaler */
+	for (i=0; i<rc->num_frames; i++) {
+		twopass_stat_t * s = &rc->stats[i];
+
+		/* Ignore frame with forced frame sizes */
+		if (s->scaled_length == 0)
+			s->scaled_length = s->invariant + (int)((double)(s->length-s->invariant) * scaler * s->weight);
+	}
+
+	/* Job done */
+	return;
+}
+
+/* Apply all user settings to the scaled curve
+* This implies:
+*   keyframe boosting
+*   high/low compression */
+void
+scaled_curve_apply_advanced_parameters(rc_2pass2_t * rc)
+{
+	int i;
+	int64_t ivop_boost_total;
+
+	/* Reset the rate controller (per frame type) total byte counters */
+	for (i=0; i<3; i++) rc->tot_scaled_length[i] = 0;
+
+	/* Compute total bytes for each frame type */
+	for (i=0; i<rc->num_frames;i++) {
+		twopass_stat_t *s = &rc->stats[i];
+		rc->tot_scaled_length[s->type-1] += s->scaled_length;
+	}
+
+	/* First we compute the total amount of bits needed, as being described by
+	* the scaled distribution. During this pass over the complete stats data,
+	* we see how much bits two user settings will get/give from/to p&b frames:
+	*  - keyframe boosting
+	*  - keyframe distance penalty */
+	rc->KF_idx = 0;
+	ivop_boost_total = 0;
+	for (i=0; i<rc->num_frames; i++) {
+		twopass_stat_t * s = &rc->stats[i];
+
+		/* Some more work is needed for I frames */
+		if (s->type == XVID_TYPE_IVOP) {
+			int ivop_boost;
+
+			/* Accumulate bytes needed for keyframe boosting */
+			ivop_boost = s->scaled_length*rc->param.keyframe_boost/100;
+
+#if 0 /* ToDo: decide how to apply kfthresholding */
+#endif
+			/* If the frame size drops under the minimum length, then cap ivop_boost */
+			if (ivop_boost + s->scaled_length < rc->min_length[XVID_TYPE_IVOP-1])
+				ivop_boost = rc->min_length[XVID_TYPE_IVOP-1] - s->scaled_length;
+
+			/* Accumulate the ivop boost */
+			ivop_boost_total += ivop_boost;
+
+			/* Don't forget to update the keyframe index */
+			rc->KF_idx++;
+		}
+	}
+
+	/* Initialize the IBoost tax ratio for P/S/B frames
+	*
+	* This ratio has to be applied to p/b/s frames in order to reserve
+	* additional bits for keyframes (keyframe boosting) or if too much
+	* keyframe distance is applied, bits retrieved from the keyframes.
+	*
+	* ie pb_length *= rc->pb_iboost_tax_ratio;
+	*
+	*    gives the ideal length of a p/b frame */
+
+	/* Compute the total length of p/b/s frames (temporary storage into
+	* movie_curve) */
+	rc->pb_iboost_tax_ratio  = (double)rc->tot_scaled_length[XVID_TYPE_PVOP-1];
+	rc->pb_iboost_tax_ratio += (double)rc->tot_scaled_length[XVID_TYPE_BVOP-1];
+
+	/* Compute the ratio described above
+	*     taxed_total = sum(0, n, tax*scaled_length)
+	* <=> taxed_total = tax.sum(0, n, scaled_length)
+	* <=> tax = taxed_total / original_total */
+	rc->pb_iboost_tax_ratio =
+		(rc->pb_iboost_tax_ratio - ivop_boost_total) /
+		rc->pb_iboost_tax_ratio;
+
+	DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- IFrame boost tax ratio:%.2f\n",
+		rc->pb_iboost_tax_ratio);
+
+	/* Compute the average size of frames per frame type */
+	for(i=0; i<3; i++) {
+		/* Special case for missing type or weird case */
+		if (rc->count[i] == 0 || rc->pb_iboost_tax_ratio == 0) {
+			rc->avg_length[i] = 1;
+		} else {
+			rc->avg_length[i] = rc->tot_scaled_length[i];
+
+			if (i == (XVID_TYPE_IVOP-1)) {
+				/* I Frames total has to be added the boost total */
+				rc->avg_length[i] += ivop_boost_total;
+			} else {
+				/* P/B frames has to taxed */
+				rc->avg_length[i] *= rc->pb_iboost_tax_ratio;
+			}
+
+			/* Finally compute the average frame size */
+			rc->avg_length[i] /= (double)rc->count[i];
+		}
+	}
+
+	/* Assymetric curve compression */
+	if (rc->param.curve_compression_high || rc->param.curve_compression_low) {
+		double symetric_total;
+		double assymetric_delta_total;
+
+		/* Like I frame boosting, assymetric curve compression modifies the total
+		* amount of needed bits, we must compute the ratio so we can prescale
+		lengths */
+		symetric_total = 0;
+		assymetric_delta_total = 0;
+		for (i=0; i<rc->num_frames; i++) {
+			double assymetric_delta;
+			double dbytes;
+			twopass_stat_t * s = &rc->stats[i];
+
+			/* I Frames are not concerned by assymetric scaling */
+			if (s->type == XVID_TYPE_IVOP)
+				continue;
+
+			/* During the real run, we would have to apply the iboost tax */
+			dbytes = s->scaled_length * rc->pb_iboost_tax_ratio;
+
+			/* Update the symmetric curve compression total */
+			symetric_total += dbytes;
+
+			/* Apply assymetric curve compression */
+			if (dbytes > rc->avg_length[s->type-1])
+				assymetric_delta = (rc->avg_length[s->type-1] - dbytes) * (double)rc->param.curve_compression_high / 100.0f;
+			else
+				assymetric_delta = (rc->avg_length[s->type-1] - dbytes) * (double)rc->param.curve_compression_low  / 100.0f;
+
+			/* Cap to the minimum frame size if needed */
+			if (dbytes + assymetric_delta < rc->min_length[s->type-1])
+				assymetric_delta = rc->min_length[s->type-1] - dbytes;
+
+			/* Accumulate after assymetric curve compression */
+			assymetric_delta_total += assymetric_delta;
+		}
+
+		/* Compute the tax that all p/b frames have to pay in order to respect the
+		* bit distribution changes that the assymetric compression curve imposes
+		* We want assymetric_total = sum(0, n-1, tax.scaled_length)
+		*      ie assymetric_total = ratio.sum(0, n-1, scaled_length)
+		*         ratio = assymetric_total / symmetric_total */
+		rc->assymetric_tax_ratio = ((double)symetric_total - (double)assymetric_delta_total) / (double)symetric_total;
+	} else {
+		rc->assymetric_tax_ratio = 1.0f;
+	}
+
+	DPRINTF(XVID_DEBUG_RC, "[xvid rc] -- Assymetric tax ratio:%.2f\n", rc->assymetric_tax_ratio);
+
+	/* Last bits that need to be reset */
+	rc->overflow = 0;
+	rc->KFoverflow = 0;
+	rc->KFoverflow_partial = 0;
+	rc->KF_idx = 0;
+	rc->desired_total = 0;
+	rc->real_total = 0;
+
+	/* Job done */
+	return;
+}
+
+/*****************************************************************************
+* VBV compliancy check and scale
+* MPEG-4 standard specifies certain restrictions for bitrate/framesize in VBR
+* to enable playback on devices with limited readspeed and memory (and which
+* aren't...)
+*
+* DivX profiles have 2 criteria: VBV as in MPEG standard
+*                                a limit on peak bitrate for any 3 seconds
+*
+* But if VBV is fulfilled, peakrate is automatically fulfilled in any profile
+* define so far, so we check for it (for completeness) but correct only VBV
+*
+*****************************************************************************/
+
+#define VBV_COMPLIANT 0
+#define VBV_UNDERFLOW 1 /* video buffer runs empty */
+#define VBV_OVERFLOW 2  /* doesn't exist for VBR encoding */
+#define VBV_PEAKRATE 4  /* peak bitrate (within 3s) violated */
+
+int
+check_curve_for_vbv_compliancy(rc_2pass2_t * rc, const float fps)
+{
+	/* We do all calculations in float, for higher accuracy,
+	* and in bytes for convenience.
+	*
+	* typical values from DivX Home Theater profile:
+	*  vbv_size= 384*1024 (384kB)
+	*  vbv_initial= 288*1024 (75% fill)
+	*  maxrate= 4000000 (4MBps)
+	*  peakrate= 10000000 (10MBps)
+	*
+	*  PAL: offset3s = 75 (3 seconds of 25fps)
+	*  NTSC: offset3s = 90 (3 seconds of 29.97fps) or 72 (3 seconds of 23.976fps)
+	*/
+
+	const float vbv_size = (float)rc->param.vbv_size/8.f;
+	float vbvfill = (float)rc->param.vbv_initial/8.f;
+	float vbvmin;
+
+	const float maxrate = (float)rc->param.vbv_maxrate;
+	const float peakrate = (float)rc->param.vbv_peakrate;
+	const float r0 = (int)(maxrate/fps+0.5)/8.f;
+
+	int bytes3s = 0;
+	int offset3s = (int)(3.f*fps+0.5);
+	int i;
+
+	/* 1Gbit should be enough to inuitialize the vbvmin
+	*	an arbitrary high value */
+	vbvmin = 1000*1000*1000;
+
+	for (i=0; i<rc->num_frames; i++) {
+		/* DivX 3s peak bitrate check  */
+		bytes3s += rc->stats[i].scaled_length;
+		if (i>=offset3s)
+			bytes3s -= rc->stats[i-offset3s].scaled_length;
+
+		if (8.f*bytes3s > 3*peakrate)
+			return(VBV_PEAKRATE);
+
+		/* update vbv fill level */
+		vbvfill += r0 - rc->stats[i].scaled_length;
+
+		/* this check is _NOT_ an "overflow"! only reading from disk stops then */
+		if (vbvfill > vbv_size)
+			vbvfill = vbv_size;
+
+		/* but THIS would be an underflow. report it! */
+		if (vbvfill < 0)
+			return(VBV_UNDERFLOW);
+
+		/* Store the minimum buffer filling */
+		if (vbvfill < vbvmin)
+			vbvmin = vbvfill;
+	}
+
+	DPRINTF(XVID_DEBUG_RC, "[xvid rc] Minimum buffer fill: %f bytes\n", vbvmin);
+
+	return(VBV_COMPLIANT);
+}
+
+
+int
+scale_curve_for_vbv_compliancy(rc_2pass2_t * rc, const float fps)
+{
+	/* correct any VBV violations. Peak bitrate violations disappears
+	* by this automatically
+	*
+	* This implementation follows
+	*
+	* Westerink, Rajagopalan, Gonzales "Two-pass MPEG-2 variable-bitrate encoding"
+	* IBM J. RES. DEVELOP. VOL 43, No. 4, July 1999, p.471--488
+	*
+	* Thanks, guys! This paper rocks!!! */
+
+	/* For each scene of len N, we have to check up to N^2 possible buffer fills.
+	* This works well with MPEG-2 where N==12 or so, but for MPEG-4 it's a
+	* little slow...
+	*
+	* TODO: Better control on VBVfill between scenes */
+
+	const float vbv_size = (float)rc->param.vbv_size/8.f;
+	const float vbv_initial = (float)rc->param.vbv_initial/8.f;
+
+	const float maxrate = 0.9*rc->param.vbv_maxrate;
+	const float vbv_low = 0.10f*vbv_size;
+	const float r0 = (int)(maxrate/fps+0.5)/8.f;
+
+	int i,k,l,n,violation = 0;
+	float *scenefactor;
+	int *scenestart;
+	int *scenelength;
+
+	/* first step: determine how many "scenes" there are and store their
+	* boundaries we could get all this from existing keyframe_positions,
+	* somehow, but there we don't have a min_scenelength, and it's no big
+	* deal to get it again. */
+
+	const int min_scenelength = (int)(fps+0.5);
+	int num_scenes = 0;
+	int last_scene = -999;
+	for (i=0; i<rc->num_frames; i++) {
+		if ((rc->stats[i].type == XVID_TYPE_IVOP) && (i-last_scene>min_scenelength)) {
+			last_scene = i;
+			num_scenes++;
+		}
+	}
+
+	scenefactor = (float*)malloc(num_scenes*sizeof(float));
+	scenestart = (int*)malloc(num_scenes*sizeof(int));
+	scenelength = (int*)malloc(num_scenes*sizeof(int));
+
+	if ((!scenefactor) || (!scenestart) || (!scenelength) ) {
+		free(scenefactor);
+		free(scenestart);
+		free(scenelength);
+		/* remember: free(0) is valid and does exactly nothing. */
+		return(-1);
+	}
+
+	/* count again and safe the length/position */
+
+	num_scenes = 0;
+	last_scene = -999;
+	for (i=0; i<rc->num_frames; i++) {
+		if ((rc->stats[i].type == XVID_TYPE_IVOP) && (i-last_scene>min_scenelength)) {
+			if (num_scenes>0) {
+				scenelength[num_scenes-1]=i-last_scene;
+			}
+			scenestart[num_scenes]=i;
+			num_scenes++;
+			last_scene = i;
+		}
+	}
+	scenelength[num_scenes-1]=i-last_scene;
+
+	/* second step: check for each scene, how much we can scale its frames up or
+	* down such that the VBV restriction is just fulfilled */
+#define R(k,n) (((n)+1-(k))*r0)     /* how much enters the buffer between frame k and n */
+	for (l=0; l<num_scenes;l++) {
+		const int start = scenestart[l];
+		const int length = scenelength[l];
+		twopass_stat_t * frames = &rc->stats[start];
+
+		float S0n,Skn;
+		float f,minf = 99999.f;
+
+		S0n=0.;
+		for (n=0;n<=length-1;n++) {
+			S0n += frames[n].scaled_length;
+
+			k = 0;
+			Skn = S0n;
+			f = (R(k,n-1) + (vbv_initial - vbv_low)) / Skn;
+			if (f < minf)
+				minf = f;
+
+			for (k=1;k<=n;k++) {
+				Skn -= frames[k].scaled_length;
+
+				f = (R(k,n-1) + (vbv_size - vbv_low)) / Skn;
+				if (f < minf)
+					minf = f;
+			}
+		}
+
+		/* special case: at the end, fill buffer up to vbv_initial again
+		*
+		* TODO: Allow other values for buffer fill between scenes
+		* e.g. if n=N is smallest f-value, then check for better value */
+
+		n=length;
+		k=0;
+		Skn = S0n;
+		f = R(k,n-1)/Skn;
+		if (f < minf)
+			minf = f;
+
+		for (k=1;k<=n-1;k++) {
+			Skn -= frames[k].scaled_length;
+
+			f = (R(k,n-1) + (vbv_initial - vbv_low)) / Skn;
+			if (f < minf)
+				minf = f;
+		}
+
+		DPRINTF(XVID_DEBUG_RC, "[xvid rc] Scene %d (Frames %d-%d): VBVfactor %f\n",
+			l, start, start+length-1 , minf);
+
+		scenefactor[l] = minf;
+	}
+#undef R
+
+	/* last step: now we know of any scene how much it can be scaled up or down
+	* without violating VBV. Next, distribute bits from the evil scenes to the
+	* good ones */
+	do {
+		float S_red = 0.f;    /* how much to redistribute */
+		float S_elig = 0.f;   /* sum of bit for those scenes you can still swallow something*/
+		float f_red;
+		int l;
+
+		/* check how much is wrong */
+		for (l=0;l<num_scenes;l++) {
+			const int start = scenestart[l];
+			const int length = scenelength[l];
+			twopass_stat_t * frames = &rc->stats[start];
+
+			/* exactly 1 means "don't touch this anymore!" */
+			if (scenefactor[l] == 1.)
+				continue;
+
+			/* within limits */
+			if (scenefactor[l] > 1.) {
+				for (n= 0; n < length; n++)
+					S_elig += frames[n].scaled_length;
+			} else {
+				/* underflowing segment */
+				for (n= 0; n < length; n++) {
+					float newbytes = (float)frames[n].scaled_length * scenefactor[l];
+					S_red += (float)frames[n].scaled_length - (float)newbytes;
+					frames[n].scaled_length =(int)newbytes;
+				}
+				scenefactor[l] = 1.f;
+			}
+		}
+
+		/* no more underflows */
+		if (S_red < 1.f)
+			break;
+
+		if (S_elig < 1.f) {
+			DPRINTF(XVID_DEBUG_RC, "[xvid rc] Everything underflowing.\n");
+			free(scenefactor);
+			free(scenestart);
+			free(scenelength);
+			return(-2);
+		}
+
+		f_red = (1.f + S_red/S_elig);
+
+		DPRINTF(XVID_DEBUG_RC, "[xvid rc] Moving %.0f kB to avoid buffer underflow, correction factor: %.5f\n",
+			S_red/1024.f, f_red);
+
+		violation=0;
+		/* scale remaining scenes up to meet total size */
+		for (l=0; l<num_scenes; l++) {
+			const int start = scenestart[l];
+			const int length = scenelength[l];
+			twopass_stat_t * frames = &rc->stats[start];
+
+			if (scenefactor[l] == 1.)
+				continue;
+
+			/* there shouldn't be any segments with factor<1 left, so all the rest is >1 */
+			for (n= 0; n < length; n++) {
+				frames[n].scaled_length = (int)(frames[n].scaled_length * f_red + 0.5);
+			}
+
+			scenefactor[l] /= f_red;
+			if (scenefactor[l] < 1.f)
+				violation=1;
+		}
+
+	} while (violation);
+
+	free(scenefactor);
+	free(scenestart);
+	free(scenelength);
+	return(0);
+}
+
+
+/*****************************************************************************
+* Still more low level stuff (nothing to do with stats treatment)
+****************************************************************************/
+
+/* This function returns an allocated string containing a complete line read
+* from the file starting at the current position */
+char *
+readline(FILE *f)
+{
+	char *buffer = NULL;
+	int buffer_size = 0;
+	int pos = 0;
+
+	do {
+		int c;
+
+		/* Read a character from the stream */
+		c = fgetc(f);
+
+		/* Is that EOF or new line ? */
+		if(c == EOF || c == '\n')
+			break;
+
+		/* Do we have to update buffer ? */
+		if(pos >= buffer_size - 1) {
+			buffer_size += BUF_SZ;
+			buffer = (char*)realloc(buffer, buffer_size);
+			if (buffer == NULL)
+				return(NULL);
+		}
+
+		buffer[pos] = c;
+		pos++;
+	} while(1);
+
+	/* Read \n or EOF */
+	if (buffer == NULL) {
+		/* EOF, so we reached the end of the file, return NULL */
+		if(feof(f))
+			return(NULL);
+
+		/* Just an empty line with just a newline, allocate a 1 byte buffer to
+		* store a zero length string */
+		buffer = (char*)malloc(1);
+		if(buffer == NULL)
+			return(NULL);
+	}
+
+	/* Zero terminated string */
+	buffer[pos] = '\0';
+
+	return(buffer);
+}
+
+/* This function returns a pointer to the first non space char in the given
+* string */
+char *
+skipspaces(char *string)
+{
+	const char spaces[] =
+	{
+		' ','\t','\0'
+	};
+	const char *spacechar = spaces;
+
+	if (string == NULL) return(NULL);
+
+	while (*string != '\0') {
+		/* Test against space chars */
+		while (*spacechar != '\0') {
+			if (*string == *spacechar) {
+				string++;
+				spacechar = spaces;
+				break;
+			}
+			spacechar++;
+		}
+
+		/* No space char */
+		if (*spacechar == '\0') return(string);
+	}
+
+	return(string);
+}
+
+/* This function returns a boolean that tells if the string is only a
+* comment */
+int
+iscomment(char *string)
+{
+	const char comments[] =
+	{
+		'#',';', '%', '\0'
+	};
+	const char *cmtchar = comments;
+	int iscomment = 0;
+
+	if (string == NULL) return(1);
+
+	string = skipspaces(string);
+
+	while(*cmtchar != '\0') {
+		if(*string == *cmtchar) {
+			iscomment = 1;
+			break;
+		}
+		cmtchar++;
+	}
+
+	return(iscomment);
+}
+
+// Merged from xvid Pass1
+
+
+int rc_2pass1_create(xvid_plg_create_t * create, rc_2pass1_t ** handle)
+{
+	xvid_plugin_2pass1_t * param = (xvid_plugin_2pass1_t *)create->param;
+	rc_2pass1_t * rc;
+
+	/* check filename */
+	if ((param->filename == NULL) ||
+		(param->filename != NULL && param->filename[0] == '\0'))
+		return XVID_ERR_FAIL;
+
+	/* allocate context struct */
+	if((rc = (rc_2pass1_t *)malloc(sizeof(rc_2pass1_t))) == NULL)
+		return(XVID_ERR_MEMORY);
+
+	/* Initialize safe defaults for 2pass 1 */
+	rc->stat_file = NULL;
+
+	/* Open the 1st pass file */
+	if((rc->stat_file = fopen(param->filename, "w+b")) == NULL)
+		return(XVID_ERR_FAIL);
+
+	/* I swear xvidcore isn't buggy, but when using mencoder+xvid4 i observe
+	* this weird bug.
+	*
+	* Symptoms: The stats file grows until it's fclosed, but at this moment
+	*           a large part of the file is filled by 0x00 bytes w/o any
+	*           reasonable cause. The stats file is then completly unusable
+	*
+	* So far, i think i found "the why":
+	*  - take a MPEG stream containing 2 sequences (concatenate 2 MPEG files
+	*    together)
+	*  - Encode this MPEG file
+	*
+	* It should trigger the bug
+	*
+	* I think this is caused by some kind of race condition on mencoder module
+	* start/stop.
+	*  - mencoder encodes the first sequence
+	*    + xvid4 module opens xvid-twopass.stats and writes stats in it.
+	*  - mencoder detects the second sequence and initialize a second
+	*    module and stops the old encoder
+	*    + new xvid4 module opens a new xvid-twopass.stats, old xvid4
+	*      module closes it
+	*
+	* This is IT, got a racing condition.
+	* Unbuffered IO, may help ... */
+	setbuf(rc->stat_file, NULL);
+
+	/*
+	* The File Header
+	*/
+	fprintf(rc->stat_file, "# XviD 2pass stat file (core version %d.%d.%d)\n",
+		XVID_VERSION_MAJOR(XVID_VERSION),
+		XVID_VERSION_MINOR(XVID_VERSION),
+		XVID_VERSION_PATCH(XVID_VERSION));
+	fprintf(rc->stat_file, "# Please do not modify this file\n\n");
+
+	rc->fq_error = 0;
+
+	*handle = rc;
+	return(0);
+}
+
+
+int rc_2pass1_destroy(rc_2pass1_t * rc, xvid_plg_destroy_t * destroy)
+{
+	if (rc->stat_file) {
+		if (fclose(rc->stat_file) == EOF) {
+			DPRINTF(XVID_DEBUG_RC, "Error closing stats file (%s)", strerror(errno));
+		}
+	}
+	rc->stat_file = NULL; /* Just a paranoid reset */
+	free(rc); /* as the container structure is freed anyway */
+	return(0);
+}
+
+
+int rc_2pass1_before(rc_2pass1_t * rc, xvid_plg_data_t * data)
+{
+	if (data->quant <= 0) {
+		if (data->zone && data->zone->mode == XVID_ZONE_QUANT) {
+			/* We disable no options in quant zones, as their implementation is
+			* based on the fact we do first pass exactly the same way as the
+			* second one to have exact zone size */
+			rc->fq_error += (double)data->zone->increment / (double)data->zone->base;
+			data->quant = (int)rc->fq_error;
+			rc->fq_error -= data->quant;
+		} else {
+			data->quant = 2;
+
+#ifdef FAST1PASS
+			/* Given the fact our 2pass algorithm is based on very simple
+			* rules, we can disable some options that are too CPU intensive
+			* and do not provide the 2nd pass any benefit */
+
+			/* First disable some motion flags */
+			data->motion_flags &= ~XVID_ME_CHROMA_PVOP;
+			data->motion_flags &= ~XVID_ME_CHROMA_BVOP;
+			data->motion_flags &= ~XVID_ME_USESQUARES16;
+			data->motion_flags &= ~XVID_ME_ADVANCEDDIAMOND16;
+			data->motion_flags &= ~XVID_ME_EXTSEARCH16;
+
+			/* And enable fast replacements */
+			data->motion_flags |= XVID_ME_FAST_MODEINTERPOLATE;
+			data->motion_flags |= XVID_ME_SKIP_DELTASEARCH;
+			data->motion_flags |= XVID_ME_FASTREFINE16;
+			data->motion_flags |= XVID_ME_BFRAME_EARLYSTOP;
+
+			/* Now VOP flags (no fast replacements) */
+			data->vop_flags &= ~XVID_VOP_MODEDECISION_RD;
+			data->vop_flags &= ~XVID_VOP_FAST_MODEDECISION_RD;
+			data->vop_flags &= ~XVID_VOP_TRELLISQUANT;
+			data->vop_flags &= ~XVID_VOP_INTER4V;
+			data->vop_flags &= ~XVID_VOP_HQACPRED;
+
+			/* Finnaly VOL flags
+			*
+			* NB: Qpel cannot be disable because this option really changes
+			*     too much the texture data compressibility, and thus the
+			*     second pass gets confused by too much impredictability
+			*     of frame sizes, and actually hurts quality */
+#ifdef FAST1PASS_QPEL_TOO
+			/* or maybe we can disable it after all? */
+			data->vol_flags &= ~XVID_VOL_QUARTERPEL;
+#endif
+			data->vol_flags &= ~XVID_VOL_GMC;
+#endif
+		}
+	}
+	return(0);
+}
+
+
+int rc_2pass1_after(rc_2pass1_t * rc, xvid_plg_data_t * data)
+{
+	char type;
+	xvid_enc_stats_t *stats = &data->stats;
+
+	/* Frame type in ascii I/P/B */
+	switch(stats->type) {
+	case XVID_TYPE_IVOP:
+		type = 'i';
+		break;
+	case XVID_TYPE_PVOP:
+		type = 'p';
+		break;
+	case XVID_TYPE_BVOP:
+		type = 'b';
+		break;
+	case XVID_TYPE_SVOP:
+		type = 's';
+		break;
+	default: /* Should not go here */
+		return(XVID_ERR_FAIL);
+	}
+
+	/* write the resulting statistics */
+
+	fprintf(rc->stat_file, "%c %d %d %d %d %d %d\n",
+		type,
+		stats->quant,
+		stats->kblks,
+		stats->mblks,
+		stats->ublks,
+		stats->length,
+		stats->hlength);
+
+	return(0);
+}
+
+
+
+int xvid_plugin_2pass1(void * handle, int opt, void * param1, void * param2)
+{
+	switch(opt)
+	{
+	case XVID_PLG_INFO :
+	case XVID_PLG_FRAME :
+		return 0;
+
+	case XVID_PLG_CREATE :
+		return rc_2pass1_create((xvid_plg_create_t*)param1,(rc_2pass1_t **) param2);
+
+	case XVID_PLG_DESTROY :
+		return rc_2pass1_destroy((rc_2pass1_t*)handle, (xvid_plg_destroy_t*)param1);
+
+	case XVID_PLG_BEFORE :
+		return rc_2pass1_before((rc_2pass1_t*)handle, (xvid_plg_data_t*)param1);
+
+	case XVID_PLG_AFTER :
+		return rc_2pass1_after((rc_2pass1_t*)handle, (xvid_plg_data_t*)param1);
+	}
+
+	return XVID_ERR_FAIL;
+}
+
+//

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtl.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtl.h	2009-12-28 06:39:12 UTC (rev 5742)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtl.h	2009-12-28 12:04:18 UTC (rev 5743)
@@ -0,0 +1,25 @@
+#ifndef XVIDRATECTL_H
+#define XVIDRATECTL_H
+
+#include <inttypes.h>
+#include "rateControl.h"
+
+class ADM_newXvidRc : public ADM_ratecontrol
+{
+protected:
+	uint32_t _totalFrame;
+public:
+	ADM_newXvidRc(uint32_t fps1000, char *logname);
+	virtual 	~ADM_newXvidRc();
+	/** Maxbr & minbr in kbps, vbvsize in kBytes); Default is none */
+	virtual 	uint8_t setVBVInfo(uint32_t maxbr,uint32_t minbr, uint32_t vbvsize);
+	virtual		uint8_t startPass1( void );
+	virtual		uint8_t logPass1(uint32_t qz, ADM_rframe ftype,uint32_t size);
+	virtual		uint8_t startPass2( uint32_t size,uint32_t nbFrame );
+	virtual		uint8_t getQz( uint32_t *qz, ADM_rframe *type );
+	virtual		uint8_t logPass2( uint32_t qz, ADM_rframe ftype,uint32_t size);
+	// Used for VBV
+	uint8_t getInfo(uint32_t framenum, uint32_t *qz, uint32_t *size,ADM_rframe *type);
+
+};
+#endif

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtlVbv.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtlVbv.cpp	2009-12-28 06:39:12 UTC (rev 5742)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtlVbv.cpp	2009-12-28 12:04:18 UTC (rev 5743)
@@ -0,0 +1,335 @@
+//
+// C++ Implementation: %{MODULE}
+//
+// Description:
+//
+//
+// Author:Mean (fixounet at free.Fr)
+//
+// Copyright: See COPYING file that comes with this distribution GPL
+//	Use xvid cvs ratecontrol, including some VBV max bitrate constraints
+//		so that it can be used for mpeg1/2 with tight constraints
+//
+//	Reuse some of Peter Cheat predictor model
+//
+
+#include <string.h>
+#include <stdio.h>
+#include <math.h>
+
+#undef NDEBUG
+#include <assert.h>
+
+#include "xvidRateCtlVbv.h"
+
+#define aprintf(prt, args...);
+
+ADM_newXvidRcVBV::ADM_newXvidRcVBV(uint32_t fps1000, char *logname) : ADM_ratecontrol(fps1000,logname)
+{
+	rc=new ADM_newXvidRc(fps1000,logname);
+	_state=RS_IDLE; 
+	_minbr=0;
+	_maxbr=2*9*1000*1000; // ~ 9MB*2
+	_vbvsize=5*224*1024;	// 1MB vbv buffer size
+	_stat=NULL;
+	_lastSize=NULL;
+
+	_idxI=_idxP=_idxB=0;
+}
+ADM_newXvidRcVBV::~ADM_newXvidRcVBV()
+{
+	if(rc)
+		delete rc;
+	if(_stat)
+		delete [] _stat;
+	if(_lastSize)
+		delete [] _lastSize;
+	rc=NULL;
+	_stat=NULL;
+	_lastSize=NULL;
+}
+uint8_t ADM_newXvidRcVBV::setVBVInfo(uint32_t maxbr,uint32_t minbr, uint32_t vbvsize)
+{
+	_maxbr=maxbr*1000; // in b/s
+	_minbr=minbr*1000;
+	_vbvsize=vbvsize*1024;
+	printf("RC: Initializing vbv buffer \n");
+	printf("RC: with min br= %lu kbps\n",(minbr)/1000);
+	printf("RC:      max br= %lu kbps\n",(maxbr)/1000);
+	printf("Rc:      VBV   = %lu kB\n",_vbvsize/1024);
+
+	return 1;
+}
+
+uint8_t ADM_newXvidRcVBV::startPass1( void )
+{
+	return rc->startPass1();
+}
+uint8_t ADM_newXvidRcVBV::startPass2( uint32_t size,uint32_t nbFrame )
+{
+	printf("Starting Xvid VBV with %lu frames, target size :%lu MB\n",nbFrame,size);
+	_nbFrames=nbFrame;
+	if(! rc->startPass2(size,nbFrame)) return 0;
+	// Built pass 1 stat file in memory
+	// we will need it later to project
+	//________________________________
+	_stat=new ADM_pass_stat[nbFrame];
+	ADM_pass_stat *cur=_stat;
+
+	for(uint32_t i=0;i<nbFrame;i++)
+	{
+		rc->getInfo(i,&(cur->quant),&(cur->size),&(cur->type));
+		cur++;
+	}
+	// a roundup is close to fps
+	_roundup=(uint32_t )floor((_fps1000+500)/1000);
+	// Do so check
+	_vbv_fullness=(_vbvsize*8)/10; // Buffer starts 80% full
+	_byte_per_image=(_maxbr>>3)/_roundup;
+	_lastSize=new uint32_t[_roundup];
+	memset(_lastSize,0,_roundup*sizeof(uint32_t));
+	_frame=0;
+	for(uint32_t i=0;i<AVG_LOOKUP;i++)
+	{
+		_compr[0][i]=1.0;
+		_compr[1][i]=1.0;
+		_compr[2][i]=1.0;
+	}
+	printf("Rc: Byte per image : %lu \n",_byte_per_image);
+	return 1;
+}
+uint8_t ADM_newXvidRcVBV::logPass1(uint32_t qz, ADM_rframe ftype,uint32_t size)
+{
+	return rc->logPass1(qz,ftype,size);
+}
+uint8_t ADM_newXvidRcVBV::logPass2(uint32_t qz, ADM_rframe ftype,uint32_t size)
+{
+	// update stored value
+	_lastSize[_frame%_roundup]=size;
+
+	_vbv_fullness+=_byte_per_image;
+	if(_vbv_fullness<size)
+	{
+		printf("VBV buffer underflow :frame %lu, underflow : %lu\n",_frame,size-_vbv_fullness);
+	}
+	else
+	{
+		_vbv_fullness-=size;
+	}
+	if(_vbv_fullness>_vbvsize)
+	{
+		// not an error printf("VBV buffer overflow :frame %lu, overflow : %lu\n",_frame,_vbv_fullness-_vbvsize);
+		_vbv_fullness=_vbvsize;
+	}
+	// update compr
+	uint32_t rank;
+#define BLEND(x) case RF_##x: rank=_idx##x;_idx##x=_idx##x+1;_idx##x%=AVG_LOOKUP;break;	
+	switch(ftype)
+	{
+		BLEND(I)
+		BLEND(P)
+		BLEND(B)
+		default:
+			assert(0);
+	}    
+
+	_compr[ftype-1][rank]=getComp(_stat[_frame].size,_stat[_frame].quant,size,qz);
+	//
+	aprintf("Frame %08lu size %d type:%d vbv fullness %u, kbytes :%lu qz used :%d\n",_frame,size, ftype,(100*_vbv_fullness)/_vbvsize,_vbv_fullness/1024,qz);
+	// compute instantaneous br
+	uint32_t br=0;
+	for(uint32_t i=0;i<_roundup;i++)
+	{
+		br+=_lastSize[i];
+	}
+	br*=8;
+	br/=1000;
+	aprintf("br : %lu\n",br);
+	_frame++;
+	return rc->logPass2(qz,ftype,size);
+}
+uint8_t ADM_newXvidRcVBV::getQz( uint32_t *qz, ADM_rframe *type )
+{
+	if(! rc->getQz(qz,type)) return 0;
+	// Now we have the temptative quant
+	// Check that both the vbv buffer & bitrate stays full enough
+	if(*qz<2) *qz=2;
+	while(*qz<31 && project(_frame,*qz,*type)) (*qz)++;
+
+
+	return 1;
+}
+
+/**
+\fn ADM_newXvidRcVBV::verifyLog
+\brief Verify the file is correct and not corrupted as far as 2pass is concerned
+ at return 1 on success (file not corrupted), 0 else.
+
+A note of warning, the actual nbFrame can depend on the encoder/codec as there might be some
+encoder-delay that is more or less ignored
+Normally nbFrame should be actual nb frame +2 (to compensate for the 2 comment lines in xvid rc file)
+but as it is, when you use lavc based mpeg codec, the whole process will eat up 2 frames.
+
+*/
+uint8_t ADM_newXvidRcVBV::verifyLog(const char *file,uint32_t nbFrame)
+{
+	FILE *in;
+	char oneLine[1024];
+	uint32_t nb=0;
+	in=fopen(file,"rt");
+	if(!in) return 0;
+	while(fgets(oneLine,1023,in)) nb++;
+	fclose(in);
+	if(nbFrame+1==nb) 
+	{
+		printf("[XvidRC]Logfile Seems ok\n");
+		return 1;
+	}
+	printf("[XvidRC]Logfile Seems corrupted (%u/%u)\n",nb,nbFrame);
+	return 0;
+}
+//
+// Return 1 if the frame and Qz fails the sanity check
+//
+uint8_t ADM_newXvidRcVBV::project(uint32_t framenum, uint32_t q, ADM_rframe frame)
+{
+	if(!checkVBV(framenum,q,frame)) return 1;
+	//	if(!checkBitrate(framenum,q,frame)) return 1;
+	return 0;
+}
+uint8_t ADM_newXvidRcVBV::checkVBV(uint32_t framenum, uint32_t q, ADM_rframe frame)
+{
+
+	// Project the next frames with the same Q factor reduction as now
+	// and check
+
+	// A bit simplistic...
+
+	if(framenum<_nbFrames-_roundup)
+	{
+		uint32_t projected_vbv=(_vbv_fullness*9)/10; // Only use 90% of the buffer
+		uint32_t framesize;
+
+		// Q increase ratio
+
+		float compI=0,compP=0,compB=0,comp=0,size,qr;
+		float ratioI,ratioP,ratioB,ratio;
+
+		for(uint32_t i=0;i<AVG_LOOKUP;i++)
+		{
+			compI+=_compr[0][i];
+			compP+=_compr[1][i];
+			compB+=_compr[2][i];
+		}
+
+		compI=compI/AVG_LOOKUP;	// Average compression ratio
+		compP=compP/AVG_LOOKUP;	// Average compression ratio
+		compB=compB/AVG_LOOKUP;	// Average compression ratio
+		ratioI=getRatio(q,_stat[framenum].quant,compI);
+		ratioP=getRatio(q,_stat[framenum].quant,compP);
+		ratioB=getRatio(q,_stat[framenum].quant,compB);
+
+
+		for(uint32_t i=0;i<_roundup>>1;i++)
+		{
+			switch(_stat[framenum+i].type)
+			{
+				case RF_I:ratio=ratioI;comp=compI;break;
+				case RF_P:ratio=ratioP;comp=compP;break;
+				case RF_B:ratio=ratioB;comp=compB;break;
+				default:
+					assert(0);
+			}
+			size=ratio;
+			size*=_stat[framenum+i].size;
+			framesize=(uint32_t)floor(size);	// predicted size
+
+			if(frame==RF_I) // Keep a margin and anticipate BIG I frame
+				framesize=(framesize*12)/10;
+
+			aprintf("\t Org: %lu projected :%d VBV:%d q:%d ratio:%f alpha:%f  type :%d\n",_stat[framenum+i].size,framesize,
+				projected_vbv/1024,q,ratio,comp,_stat[framenum+i].type);
+			if(projected_vbv<framesize)
+			{
+				aprintf("potential underflow at %d + %d , q:%d\n",framenum,i,q);
+				return 0;
+			}
+			projected_vbv-=framesize;
+			projected_vbv+=_byte_per_image;
+			if(projected_vbv>_vbvsize)
+			{
+				projected_vbv=_vbvsize;
+			}
+		}
+	}
+	else
+	{
+		if(q<9) return 0;
+	}		
+	return 1;
+
+}
+
+
+/*__________________________________________________________________
+
+Reverse the below formula
+newbits/oldbuts=newquang^ -comp
+log(newq^ -comp)=log(newbit/oldbits)
+comp=-log(newbits/oldbits)/log(newq/oldq)
+*/
+float ADM_newXvidRcVBV::getComp(int oldbits, int qporg, int newbits, int qpused)
+{
+	float comp;
+	/*	
+	comp=newbits;
+	comp/=oldbits;
+	comp=log(comp);
+	comp/=log(qpused/qporg);
+	printf("Old q:%d new q : %d oldBits:%d newbits:%d comp:%f\n",
+	qporg,qpused,oldbits,newbits,-comp);
+	comp= -comp;
+	if(comp>3) comp=3;
+	if(comp<0.5) comp=0.5;
+	return comp;
+	*/
+	// Linear
+	// comp=(Nb*Nq)/(Ob*Oq);
+	comp=newbits;
+	comp*=qpused;
+	comp/=qporg;
+	comp/=oldbits;
+	// Clamp between max alpha/min alpha
+#define MAX_ALPHA 6
+#define MIN_ALPHA (1.0/MAX_ALPHA)
+	if(comp>MAX_ALPHA) comp=MAX_ALPHA;
+	if(comp<MIN_ALPHA) comp=MIN_ALPHA;
+	return comp;
+}
+/*_______________________________________________________________
+Predict the size of the image
+Using a exp(-comp) formula instead of linear formula
+
+Idea by Peter Cheat
+__________________________________________________________________
+*/
+float ADM_newXvidRcVBV::getRatio(uint32_t newq, uint32_t oldq, float alpha)
+{
+	// Peter Cheat formula :Pridicted Bits Frame 10 Will Use = (Bits Used At Quantiser 1) * (New Quantiser ^ -Compressibility)
+	// avg lookup compressibility
+	/*			exponential
+	qr=q;
+	qr=qr/_stat[framenum].quant;	// average size reduction
+	qr=pow(qr,-comp);
+	*/
+	// Linear
+	// Ob*Oq*alpha=Nb*Nq
+	// Nb/Ob=Oq/Nq*alpha
+	//alpha=1;
+	float comp;
+
+	comp=oldq;	
+	comp/=newq;
+	comp*=alpha;
+	return comp;
+}

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtlVbv.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtlVbv.h	2009-12-28 06:39:12 UTC (rev 5742)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/xvidRateCtlVbv.h	2009-12-28 12:04:18 UTC (rev 5743)
@@ -0,0 +1,40 @@
+#ifndef XVIDRATECTLVBV_H
+#define XVIDRATECTLVBV_H
+
+#include <inttypes.h>
+#include "rateControl.h"
+#include "xvidRateCtl.h"
+
+#define AVG_LOOKUP 5
+class ADM_newXvidRcVBV : public ADM_ratecontrol
+{
+protected:
+	ADM_newXvidRc	*rc;
+	uint32_t	_minbr,_maxbr,_vbvsize;
+	ADM_pass_stat  *_stat;
+	uint32_t	*_lastSize;
+	uint32_t	_roundup;
+	uint32_t	_frame;
+	uint32_t	_vbv_fullness;
+	uint32_t	_byte_per_image;
+	double		_compr[3][AVG_LOOKUP];  
+	uint32_t   _idxI,_idxP,_idxB;
+
+	uint8_t 	project(uint32_t framenum, uint32_t q, ADM_rframe frame);
+	uint8_t 	checkVBV(uint32_t framenum, uint32_t q, ADM_rframe frame);
+	float 		getRatio(uint32_t newq, uint32_t oldq, float alpha);
+	float 		getComp(int oldbits, int qporg, int newbits, int qpused);
+
+public:
+	ADM_newXvidRcVBV(uint32_t fps1000, char *logname);
+	virtual 	~ADM_newXvidRcVBV() ;
+	/** Maxbr & minbr in kbps, vbvsize in kBytes); Default is none */
+	virtual 	uint8_t setVBVInfo(uint32_t maxbr,uint32_t minbr, uint32_t vbvsize);
+	virtual		uint8_t startPass1( void );
+	virtual		uint8_t logPass1(uint32_t qz, ADM_rframe ftype,uint32_t size);
+	virtual		uint8_t startPass2( uint32_t size,uint32_t nbFrame );
+	virtual		uint8_t getQz( uint32_t *qz, ADM_rframe *type );
+	virtual		uint8_t logPass2( uint32_t qz, ADM_rframe ftype,uint32_t size);
+	uint8_t verifyLog(const char *file,uint32_t nbFrame);
+};
+#endif



From gruntster at mail.berlios.de  Mon Dec 28 13:53:40 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 28 Dec 2009 13:53:40 +0100
Subject: [Avidemux-svn-commit] r5744 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl
Message-ID: <200912281253.nBSCreGk010813@sheep.berlios.de>

Author: gruntster
Date: 2009-12-28 13:53:35 +0100 (Mon, 28 Dec 2009)
New Revision: 5744

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/CMakeLists.txt
Log:
[mpeg-1] unix compilation fix

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/CMakeLists.txt	2009-12-28 12:04:18 UTC (rev 5743)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/CMakeLists.txt	2009-12-28 12:53:35 UTC (rev 5744)
@@ -1 +1,5 @@
-add_library(ADM_xvidRateCtl rateControl.cpp  xvidRateCtl.cpp  xvidRateCtlVbv.cpp)
\ No newline at end of file
+add_library(ADM_xvidRateCtl rateControl.cpp  xvidRateCtl.cpp  xvidRateCtlVbv.cpp)
+
+if (UNIX)
+	add_target_cflags(ADM_xvidRateCtl -fPIC)
+endif (UNIX)
\ No newline at end of file



From gruntster at mail.berlios.de  Mon Dec 28 15:08:55 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 28 Dec 2009 15:08:55 +0100
Subject: [Avidemux-svn-commit] r5745 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: .
	ADM_libraries/ADM_utilities ADM_userInterfaces/ADM_QT4/ADM_gui
Message-ID: <200912281408.nBSE8tb4019782@sheep.berlios.de>

Author: gruntster
Date: 2009-12-28 15:08:49 +0100 (Mon, 28 Dec 2009)
New Revision: 5745

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/prefs.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui
   branches/avidemux_2.5_branch_gruntster/avidemux/prefs.h
   branches/avidemux_2.5_branch_gruntster/avidemux/prefs.in
Log:
[qt] increase recent files list from 4 to 6 for Qt interface and smarten saving of prefs

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/prefs.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/prefs.cpp	2009-12-28 12:53:35 UTC (rev 5744)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/prefs.cpp	2009-12-28 14:08:49 UTC (rev 5745)
@@ -11,11 +11,9 @@
  *                                                                         *
  ***************************************************************************/
 
-
-
-
-
 #include "config.h"
+#include <list>
+using namespace std;
 
 #ifdef USE_LIBXML2
 #include <libxml/tree.h>
@@ -107,6 +105,8 @@
 	{"lastfiles.file2",		FILENAME,"",	NULL, NULL, NULL },
 	{"lastfiles.file3",		FILENAME,"",	NULL, NULL, NULL },
 	{"lastfiles.file4",		FILENAME,"",	NULL, NULL, NULL },
+	{"lastfiles.file5",		FILENAME,"",	NULL, NULL, NULL },
+	{"lastfiles.file6",		FILENAME,"",	NULL, NULL, NULL },
 	{"lastdir_read",		FILENAME,"",	NULL, NULL, NULL },
 	{"lastdir_write",		FILENAME,"",	NULL, NULL, NULL },
 	{"message_level",		UINT,	"2",	NULL,	"0",	"2"	},
@@ -137,7 +137,7 @@
 	{"priority.playback",		UINT,	"0",	NULL,	"0",	"4"	}
 };
 
-int num_opts = 71;
+int num_opts = 73;
 // </prefs_gen>
 
 #ifdef USE_LIBXML2
@@ -232,7 +232,8 @@
 preferences::preferences(){
 	internal_lastfiles[0] = internal_lastfiles[1] = NULL;
 	internal_lastfiles[2] = internal_lastfiles[3] = NULL;
-	internal_lastfiles[4] = NULL;
+	internal_lastfiles[4] = internal_lastfiles[5] = NULL;
+	internal_lastfiles[6] = NULL;
 	#ifdef USE_LIBXML2
 	xdoc = NULL;
 	#endif
@@ -240,7 +241,7 @@
 
 preferences::~preferences(){
   unsigned int idx;
-	for( idx=0; idx < 4; idx++ ){
+	for( idx=0; idx < 6; idx++ ){
 		if( internal_lastfiles[idx] )
 			ADM_dealloc(internal_lastfiles[idx]);
 	}
@@ -847,44 +848,34 @@
 	PRT_LAFI("<= LASTFILES_",2,opt_defs[LASTFILES_FILE2].current_val);
 	PRT_LAFI("<= LASTFILES_",3,opt_defs[LASTFILES_FILE3].current_val);
 	PRT_LAFI("<= LASTFILES_",4,opt_defs[LASTFILES_FILE4].current_val);
+	PRT_LAFI("<= LASTFILES_",5,opt_defs[LASTFILES_FILE5].current_val);
+	PRT_LAFI("<= LASTFILES_",6,opt_defs[LASTFILES_FILE6].current_val);
 #endif
-	// change opt_defs array
-	//
-	// ToDo:
-	// * a call with a file already in lastfiles will resort lastfiles with
-	//   the actual argument on top
-	// * a call with a file new to lastfiles will drop LASTFILE_4, move all
-	//   one step down and add the file as LASTFILE_1
-	if( opt_defs[LASTFILES_FILE4].current_val &&
-	    !strncmp(opt_defs[LASTFILES_FILE4].current_val,internal_file,strlen(opt_defs[LASTFILES_FILE4].current_val)) ){
-	  char *x = opt_defs[LASTFILES_FILE4].current_val;
-		opt_defs[LASTFILES_FILE4].current_val = opt_defs[LASTFILES_FILE3].current_val;
-		opt_defs[LASTFILES_FILE3].current_val = opt_defs[LASTFILES_FILE2].current_val;
-		opt_defs[LASTFILES_FILE2].current_val = opt_defs[LASTFILES_FILE1].current_val;
-		opt_defs[LASTFILES_FILE1].current_val = x;
-	}else if( opt_defs[LASTFILES_FILE3].current_val &&
-            !strncmp(opt_defs[LASTFILES_FILE3].current_val,internal_file,strlen(opt_defs[LASTFILES_FILE3].current_val)) ){
-          char *x = opt_defs[LASTFILES_FILE3].current_val;
-		opt_defs[LASTFILES_FILE3].current_val = opt_defs[LASTFILES_FILE2].current_val;
-                opt_defs[LASTFILES_FILE2].current_val = opt_defs[LASTFILES_FILE1].current_val;
-                opt_defs[LASTFILES_FILE1].current_val = x;
-        }else if( opt_defs[LASTFILES_FILE2].current_val &&
-            !strncmp(opt_defs[LASTFILES_FILE2].current_val,internal_file,strlen(opt_defs[LASTFILES_FILE2].current_val)) ){
-          char *x = opt_defs[LASTFILES_FILE2].current_val;
-		opt_defs[LASTFILES_FILE2].current_val = opt_defs[LASTFILES_FILE1].current_val;
-		opt_defs[LASTFILES_FILE1].current_val = x;
-	}else if( opt_defs[LASTFILES_FILE1].current_val &&
-            !strncmp(opt_defs[LASTFILES_FILE1].current_val,internal_file,strlen(opt_defs[LASTFILES_FILE1].current_val)) ){
-		; // nothing to do - always on top
-	}else{
-		if( opt_defs[LASTFILES_FILE4].current_val )
-			ADM_dealloc(opt_defs[LASTFILES_FILE4].current_val);
-		opt_defs[LASTFILES_FILE4].current_val = opt_defs[LASTFILES_FILE3].current_val;
-		opt_defs[LASTFILES_FILE3].current_val = opt_defs[LASTFILES_FILE2].current_val;
-		opt_defs[LASTFILES_FILE2].current_val = opt_defs[LASTFILES_FILE1].current_val;
-		opt_defs[LASTFILES_FILE1].current_val = ADM_strdup(internal_file);
+
+	int firstIndex = LASTFILES_FILE1;
+	int lastIndex = LASTFILES_FILE6;
+	list<char*> lastFileList;
+	int currentIndex = firstIndex;
+
+	for (int index = firstIndex; index <= lastIndex; index++)
+	{
+		if (opt_defs[index].current_val && strcmp(opt_defs[index].current_val, internal_file) != 0)
+			lastFileList.push_back(opt_defs[index].current_val);
 	}
 
+	lastFileList.push_front(ADM_strdup(internal_file));
+
+	while (!lastFileList.empty())
+	{
+		if (currentIndex <= lastIndex)
+			opt_defs[currentIndex].current_val = lastFileList.front();
+		else
+			ADM_dealloc(lastFileList.front());
+
+		lastFileList.pop_front();
+		currentIndex++;
+	}
+
 #ifdef USE_LIBXML2
 	// change the xmlDocument
 	if( ! xdoc ){
@@ -917,6 +908,12 @@
 		q = goto_node_with_create(p, "file4");		// ->avidemux->lastfile->4
 		xmlNodeSetContent( q,
 			(xmlChar*)(opt_defs[LASTFILES_FILE4].current_val?opt_defs[LASTFILES_FILE4].current_val:""));
+		q = goto_node_with_create(p, "file5");		// ->avidemux->lastfile->5
+		xmlNodeSetContent( q,
+			(xmlChar*)(opt_defs[LASTFILES_FILE5].current_val?opt_defs[LASTFILES_FILE5].current_val:""));
+		q = goto_node_with_create(p, "file6");		// ->avidemux->lastfile->6
+		xmlNodeSetContent( q,
+			(xmlChar*)(opt_defs[LASTFILES_FILE6].current_val?opt_defs[LASTFILES_FILE6].current_val:""));
 		save_xml_to_file();
 	}
 #endif
@@ -926,6 +923,8 @@
 	PRT_LAFI("=> LASTFILES_",2,opt_defs[LASTFILES_FILE2].current_val);
 	PRT_LAFI("=> LASTFILES_",3,opt_defs[LASTFILES_FILE3].current_val);
 	PRT_LAFI("=> LASTFILES_",4,opt_defs[LASTFILES_FILE4].current_val);
+	PRT_LAFI("=> LASTFILES_",5,opt_defs[LASTFILES_FILE5].current_val);
+	PRT_LAFI("=> LASTFILES_",6,opt_defs[LASTFILES_FILE6].current_val);
 #endif
 	delete[] internal_file;
 	return RC_OK;
@@ -939,7 +938,7 @@
 #ifdef DEBUG_PREFS
 	fprintf(stderr,"Prefs: get_lastfile()\n");
 #endif
-	for( idx=0; idx < 4; idx++ ){
+	for( idx=0; idx < 6; idx++ ){
 		if( internal_lastfiles[idx] ){
 			ADM_dealloc(internal_lastfiles[idx]);
 			internal_lastfiles[idx] = NULL;
@@ -953,7 +952,11 @@
 		internal_lastfiles[2] = ADM_strdup(opt_defs[LASTFILES_FILE3].current_val);
 	if( opt_defs[LASTFILES_FILE4].current_val )
 		internal_lastfiles[3] = ADM_strdup(opt_defs[LASTFILES_FILE4].current_val);
-	internal_lastfiles[4] = NULL;
+	if( opt_defs[LASTFILES_FILE5].current_val )
+		internal_lastfiles[4] = ADM_strdup(opt_defs[LASTFILES_FILE5].current_val);
+	if( opt_defs[LASTFILES_FILE6].current_val )
+		internal_lastfiles[5] = ADM_strdup(opt_defs[LASTFILES_FILE6].current_val);
+	internal_lastfiles[6] = NULL;
 
 #ifdef DEBUG_PREFS
 	PRT_LAFI(0,internal_lastfiles[0]);
@@ -961,6 +964,8 @@
 	PRT_LAFI(2,internal_lastfiles[2]);
 	PRT_LAFI(3,internal_lastfiles[3]);
 	PRT_LAFI(4,internal_lastfiles[4]);
+	PRT_LAFI(5,internal_lastfiles[5]);
+	PRT_LAFI(6,internal_lastfiles[6]);
 #endif
 	return (const char**)internal_lastfiles;
 }

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2009-12-28 12:53:35 UTC (rev 5744)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2009-12-28 14:08:49 UTC (rev 5745)
@@ -85,7 +85,7 @@
 /*
     Declare the table converting widget name to our internal signal           
 */
-typedef struct adm_qt4_translation
+struct adm_qt4_translation
 {
 	const char *name;
 	Action     action; 
@@ -802,13 +802,13 @@
 {
 	const char **names;
 	uint32_t nb_item=0;
-	QAction *actions[4]={WIDGET(actionRecent0),WIDGET(actionRecent1),WIDGET(actionRecent2),WIDGET(actionRecent3)};
+	QAction *actions[6]={WIDGET(actionRecent0),WIDGET(actionRecent1),WIDGET(actionRecent2),WIDGET(actionRecent3),WIDGET(actionRecent4),WIDGET(actionRecent5)};
 	names=prefs->get_lastfiles();
 
 	// hide them all
-	for(int i=0;i<4;i++) actions[i]->setVisible(0);
+	for(int i=0;i<6;i++) actions[i]->setVisible(0);
 	// Redraw..
-	for( nb_item=0;nb_item<4;nb_item++)
+	for( nb_item=0;nb_item<6;nb_item++)
 	{
 		if(!names[nb_item]) 
 		{

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui	2009-12-28 12:53:35 UTC (rev 5744)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui	2009-12-28 14:08:49 UTC (rev 5745)
@@ -1397,6 +1397,8 @@
      <addaction name="actionRecent1" />
      <addaction name="actionRecent2" />
      <addaction name="actionRecent3" />
+     <addaction name="actionRecent4" />
+     <addaction name="actionRecent5" />
     </widget>
     <widget class="QMenu" name="menuSave" >
      <property name="title" >
@@ -1409,7 +1411,6 @@
      <addaction name="actionSave_Selection" />
     </widget>
     <addaction name="actionOpen" />
-    <addaction name="menuRecent_Files" />
     <addaction name="actionAppend" />
     <addaction name="menuSave" />
     <addaction name="actionClose" />
@@ -1425,6 +1426,8 @@
     <addaction name="separator" />
     <addaction name="actionConnect_to_AvsProxy" />
     <addaction name="separator" />
+    <addaction name="menuRecent_Files" />
+    <addaction name="separator" />
     <addaction name="actionQuit" />
    </widget>
    <widget class="QMenu" name="menuHelp" >
@@ -1528,7 +1531,7 @@
   </action>
   <action name="actionQuit" >
    <property name="text" >
-    <string>&amp;Quit</string>
+    <string>E&amp;xit</string>
    </property>
   </action>
   <action name="actionCut" >
@@ -2368,6 +2371,16 @@
     <string>&amp;Plugins...</string>
    </property>
   </action>
+  <action name="actionRecent4" >
+   <property name="text" >
+    <string>Recent4</string>
+   </property>
+  </action>
+  <action name="actionRecent5" >
+   <property name="text" >
+    <string>Recent5</string>
+   </property>
+  </action>
  </widget>
  <customwidgets>
   <customwidget>

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/prefs.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/prefs.h	2009-12-28 12:53:35 UTC (rev 5744)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/prefs.h	2009-12-28 14:08:49 UTC (rev 5745)
@@ -51,6 +51,8 @@
 	LASTFILES_FILE2,
 	LASTFILES_FILE3,
 	LASTFILES_FILE4,
+	LASTFILES_FILE5,
+	LASTFILES_FILE6,
 	LASTDIR_READ,
 	LASTDIR_WRITE,
 	MESSAGE_LEVEL,
@@ -84,7 +86,7 @@
 
 class preferences {
 	private:
-		char *internal_lastfiles[5];
+		char *internal_lastfiles[7];
 		int save_xml_to_file();
 	public:
 		preferences();

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/prefs.in
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/prefs.in	2009-12-28 12:53:35 UTC (rev 5744)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/prefs.in	2009-12-28 14:08:49 UTC (rev 5745)
@@ -65,6 +65,8 @@
 lastfiles.file2,			FILENAME,	""
 lastfiles.file3,			FILENAME,	""
 lastfiles.file4,			FILENAME,	""
+lastfiles.file5,			FILENAME,	""
+lastfiles.file6,			FILENAME,	""
 lastdir_read,				FILENAME,	""
 lastdir_write,				FILENAME,	""
 # 0 - no messages, 1 - only error messages, 2 - all messages



From gruntster at mail.berlios.de  Mon Dec 28 16:35:58 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 28 Dec 2009 16:35:58 +0100
Subject: [Avidemux-svn-commit] r5746 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: .
	ADM_libraries/ADM_utilities ADM_userInterfaces/ADM_GTK/ADM_gui2
	ADM_userInterfaces/ADM_NONE/ADM_gui2
	ADM_userInterfaces/ADM_QT4/ADM_gui ADM_userInterfaces/ADM_commonUI
Message-ID: <200912281535.nBSFZwXi026636@sheep.berlios.de>

Author: gruntster
Date: 2009-12-28 16:35:49 +0100 (Mon, 28 Dec 2009)
New Revision: 5746

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/prefs.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/gui_none.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_ui.h
   branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/gui_action.names
   branches/avidemux_2.5_branch_gruntster/avidemux/prefs.h
   branches/avidemux_2.5_branch_gruntster/avidemux/prefs.in
Log:
[qt] add a recent projects menu option to Qt interface

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/prefs.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/prefs.cpp	2009-12-28 14:08:49 UTC (rev 5745)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/prefs.cpp	2009-12-28 15:35:49 UTC (rev 5746)
@@ -107,6 +107,12 @@
 	{"lastfiles.file4",		FILENAME,"",	NULL, NULL, NULL },
 	{"lastfiles.file5",		FILENAME,"",	NULL, NULL, NULL },
 	{"lastfiles.file6",		FILENAME,"",	NULL, NULL, NULL },
+	{"lastproject.file1",		FILENAME,"",	NULL, NULL, NULL },
+	{"lastproject.file2",		FILENAME,"",	NULL, NULL, NULL },
+	{"lastproject.file3",		FILENAME,"",	NULL, NULL, NULL },
+	{"lastproject.file4",		FILENAME,"",	NULL, NULL, NULL },
+	{"lastproject.file5",		FILENAME,"",	NULL, NULL, NULL },
+	{"lastproject.file6",		FILENAME,"",	NULL, NULL, NULL },
 	{"lastdir_read",		FILENAME,"",	NULL, NULL, NULL },
 	{"lastdir_write",		FILENAME,"",	NULL, NULL, NULL },
 	{"message_level",		UINT,	"2",	NULL,	"0",	"2"	},
@@ -137,7 +143,7 @@
 	{"priority.playback",		UINT,	"0",	NULL,	"0",	"4"	}
 };
 
-int num_opts = 73;
+int num_opts = 79;
 // </prefs_gen>
 
 #ifdef USE_LIBXML2
@@ -230,10 +236,12 @@
 #include "prefs.h"
 
 preferences::preferences(){
-	internal_lastfiles[0] = internal_lastfiles[1] = NULL;
-	internal_lastfiles[2] = internal_lastfiles[3] = NULL;
-	internal_lastfiles[4] = internal_lastfiles[5] = NULL;
-	internal_lastfiles[6] = NULL;
+	for (int index = 0; index < 7; index++)
+		internal_lastfiles[index] = NULL;
+
+	for (int index = 0; index < 7; index++)
+		_lastProjects[index] = NULL;
+
 	#ifdef USE_LIBXML2
 	xdoc = NULL;
 	#endif
@@ -245,6 +253,13 @@
 		if( internal_lastfiles[idx] )
 			ADM_dealloc(internal_lastfiles[idx]);
 	}
+
+	for (int idx = 0; idx < 6; idx++)
+	{
+		if (_lastProjects[idx])
+			ADM_dealloc(_lastProjects[idx]);
+	}
+
 	#ifdef USE_LIBXML2
 	if( xdoc )
 		xmlFreeDoc(xdoc);
@@ -969,6 +984,129 @@
 #endif
 	return (const char**)internal_lastfiles;
 }
+
+const char **preferences::getLastProjects(void)
+{
+	for (int idx = 0; idx < 6; idx++)
+	{
+		if (_lastProjects[idx])
+		{
+			ADM_dealloc(_lastProjects[idx]);
+			_lastProjects[idx] = NULL;
+		}
+	}
+
+	int firstIndex = LASTPROJECT_FILE1;
+	int lastIndex = LASTPROJECT_FILE6;
+	int counter = 0;
+
+	for (int currentIndex = firstIndex; currentIndex <= lastIndex; currentIndex++)
+	{
+		if (opt_defs[currentIndex].current_val)
+			_lastProjects[counter] = ADM_strdup(opt_defs[currentIndex].current_val);
+
+		counter++;
+	}
+
+	_lastProjects[counter] = NULL;
+
+	return (const char**)_lastProjects;
+}
+
+int preferences::setLastProject(const char* file)
+{
+	if (!file)
+	{
+		fprintf(stderr, "Prefs: setLastProject(NULL) called\n");
+		return RC_FAILED;
+	}
+
+	char *internal_file = ADM_PathCanonize(file);
+
+	if (!internal_file)
+	{
+		fprintf(stderr, "Prefs: setLastProject: PathCanonize returns NULL\n");
+		return RC_FAILED;
+	}
+
+	int firstIndex = LASTPROJECT_FILE1;
+	int lastIndex = LASTPROJECT_FILE6;
+	list<char*> lastFileList;
+	int currentIndex = firstIndex;
+
+	for (int index = firstIndex; index <= lastIndex; index++)
+	{
+		if (opt_defs[index].current_val && strcmp(opt_defs[index].current_val, internal_file) != 0)
+			lastFileList.push_back(opt_defs[index].current_val);
+	}
+
+	lastFileList.push_front(ADM_strdup(internal_file));
+
+	while (!lastFileList.empty())
+	{
+		if (currentIndex <= lastIndex)
+			opt_defs[currentIndex].current_val = lastFileList.front();
+		else
+			ADM_dealloc(lastFileList.front());
+
+		lastFileList.pop_front();
+		currentIndex++;
+	}
+
+	if(!xdoc)
+	{
+		// no .avidemuxrc file or not loaded yet
+		load();          // try to load it
+
+		if (!xdoc)
+		{    // really: no .avidemuxrc file
+			save();  // generate one from internal defaults and actual changes
+
+			if(xdoc)
+				erase_blank_nodes(xdoc->children);
+		}
+	}
+
+	if (!xdoc)
+	{
+		fprintf(stderr, "Prefs: no xml document generated by load() nor save()\n");
+	}
+	else
+	{
+		// we assume a valid xml document, but maybe an older version
+		ADM_assert(xdoc->children);
+
+		xmlNodePtr p;
+		xmlNodePtr q;
+		
+		p = xdoc->children;				// ->avidemux (should be there)
+		p = goto_node_with_create(p, "lastfiles");	// ->avidemux->lastfile
+
+		q = goto_node_with_create(p, "file1");
+		xmlNodeSetContent(q, (xmlChar*)(opt_defs[LASTPROJECT_FILE1].current_val ? opt_defs[LASTPROJECT_FILE1].current_val : ""));
+
+		q = goto_node_with_create(p, "file2");
+		xmlNodeSetContent(q, (xmlChar*)(opt_defs[LASTPROJECT_FILE2].current_val ? opt_defs[LASTPROJECT_FILE2].current_val : ""));
+
+		q = goto_node_with_create(p, "file3");
+		xmlNodeSetContent(q, (xmlChar*)(opt_defs[LASTPROJECT_FILE3].current_val ? opt_defs[LASTPROJECT_FILE3].current_val : ""));
+
+		q = goto_node_with_create(p, "file4");
+		xmlNodeSetContent(q, (xmlChar*)(opt_defs[LASTPROJECT_FILE4].current_val ? opt_defs[LASTPROJECT_FILE4].current_val : ""));
+
+		q = goto_node_with_create(p, "file5");
+		xmlNodeSetContent(q, (xmlChar*)(opt_defs[LASTPROJECT_FILE5].current_val ? opt_defs[LASTPROJECT_FILE5].current_val : ""));
+
+		q = goto_node_with_create(p, "file6");
+		xmlNodeSetContent(q, (xmlChar*)(opt_defs[LASTPROJECT_FILE6].current_val ? opt_defs[LASTPROJECT_FILE6].current_val : ""));
+
+		save_xml_to_file();
+	}
+
+	delete[] internal_file;
+	return RC_OK;
+}
+
 int initPrefs(  void )
 {
   prefs = new preferences();

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2009-12-28 14:08:49 UTC (rev 5745)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2009-12-28 15:35:49 UTC (rev 5746)
@@ -1274,6 +1274,10 @@
         return 1;
 }
 
+void UI_updateRecentProjectsMenu(void)
+{
+}
+
 // Override arrow keys to quickly navigate
 uint8_t UI_arrow_enabled(void)
 {

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/gui_none.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/gui_none.cpp	2009-12-28 14:08:49 UTC (rev 5745)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/gui_none.cpp	2009-12-28 15:35:49 UTC (rev 5746)
@@ -131,6 +131,10 @@
   return 1;
 }
 
+void UI_updateRecentProjectsMenu(void)
+{
+}
+
 uint8_t UI_arrow_enabled(void)
 {
   return 1;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2009-12-28 14:08:49 UTC (rev 5745)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2009-12-28 15:35:49 UTC (rev 5746)
@@ -683,6 +683,7 @@
 QWidget *QuiMainWindows=NULL;
 QGraphicsView *drawWindow=NULL;
 uint8_t UI_updateRecentMenu( void );
+void UI_updateRecentProjectsMenu(void);
 
 void UI_refreshCustomMenu(void)
 {
@@ -767,6 +768,7 @@
 
 	UI_QT4VideoWidget(mw->ui.frame_video);  // Add the widget that will handle video display
 	UI_updateRecentMenu();
+	UI_updateRecentProjectsMenu();
 	setupMenus();
 	ADM_setCrashHook(&saveCrashProject, &FatalFunctionQt);
 	checkCrashFile();
@@ -825,6 +827,28 @@
 	}
 	return 1;
 }
+
+void UI_updateRecentProjectsMenu(void)
+{
+	const char **names = prefs->getLastProjects();
+	QAction *actions[6] = {WIDGET(actionRecentProject0), WIDGET(actionRecentProject1), WIDGET(actionRecentProject2),
+		WIDGET(actionRecentProject3), WIDGET(actionRecentProject4), WIDGET(actionRecentProject5)};
+
+	for(int index = 0; index < 6; index++)
+		actions[index]->setVisible(false);
+
+	for (int index = 0; index < 6; index++)
+	{
+		if (!names[index])
+			break;
+		else
+		{
+			actions[index]->setText(QString::fromUtf8(names[index]));
+			actions[index]->setVisible(true);
+		}
+	}
+}
+
 /** 
   \fn    setupMenus(void)
   \brief Fill in video & audio co

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui	2009-12-28 14:08:49 UTC (rev 5745)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui	2009-12-28 15:35:49 UTC (rev 5746)
@@ -1410,6 +1410,17 @@
      <addaction name="actionSave_jpeg" />
      <addaction name="actionSave_Selection" />
     </widget>
+    <widget class="QMenu" name="menuRecent_Projects" >
+     <property name="title" >
+      <string>Recent Projects</string>
+     </property>
+     <addaction name="actionRecentProject0" />
+     <addaction name="actionRecentProject1" />
+     <addaction name="actionRecentProject2" />
+     <addaction name="actionRecentProject3" />
+     <addaction name="actionRecentProject4" />
+     <addaction name="actionRecentProject5" />
+    </widget>
     <addaction name="actionOpen" />
     <addaction name="actionAppend" />
     <addaction name="menuSave" />
@@ -1427,6 +1438,7 @@
     <addaction name="actionConnect_to_AvsProxy" />
     <addaction name="separator" />
     <addaction name="menuRecent_Files" />
+    <addaction name="menuRecent_Projects" />
     <addaction name="separator" />
     <addaction name="actionQuit" />
    </widget>
@@ -2381,6 +2393,36 @@
     <string>Recent5</string>
    </property>
   </action>
+  <action name="actionRecentProject0" >
+   <property name="text" >
+    <string>RecentProject0</string>
+   </property>
+  </action>
+  <action name="actionRecentProject1" >
+   <property name="text" >
+    <string>RecentProject1</string>
+   </property>
+  </action>
+  <action name="actionRecentProject2" >
+   <property name="text" >
+    <string>RecentProject2</string>
+   </property>
+  </action>
+  <action name="actionRecentProject3" >
+   <property name="text" >
+    <string>RecentProject3</string>
+   </property>
+  </action>
+  <action name="actionRecentProject4" >
+   <property name="text" >
+    <string>RecentProject4</string>
+   </property>
+  </action>
+  <action name="actionRecentProject5" >
+   <property name="text" >
+    <string>RecentProject5</string>
+   </property>
+  </action>
  </widget>
  <customwidgets>
   <customwidget>

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h	2009-12-28 14:08:49 UTC (rev 5745)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h	2009-12-28 15:35:49 UTC (rev 5746)
@@ -63,6 +63,14 @@
 PROCESS(actionRecent1,ACT_RECENT1) \
 PROCESS(actionRecent2,ACT_RECENT2) \
 PROCESS(actionRecent3,ACT_RECENT3) \
+PROCESS(actionRecent4,ACT_RECENT4) \
+PROCESS(actionRecent5,ACT_RECENT5) \
+PROCESS(actionRecentProject0,ACT_RECENTPROJECT0) \
+PROCESS(actionRecentProject1,ACT_RECENTPROJECT1) \
+PROCESS(actionRecentProject2,ACT_RECENTPROJECT2) \
+PROCESS(actionRecentProject3,ACT_RECENTPROJECT3) \
+PROCESS(actionRecentProject4,ACT_RECENTPROJECT4) \
+PROCESS(actionRecentProject5,ACT_RECENTPROJECT5) \
 PROCESS(actionAdd_to_joblist,ACT_ADD_JOB) \
 PROCESS(actionShow_Joblist,ACT_HANDLE_JOB)  
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_ui.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_ui.h	2009-12-28 14:08:49 UTC (rev 5745)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_ui.h	2009-12-28 15:35:49 UTC (rev 5746)
@@ -44,6 +44,7 @@
 uint8_t UI_setTimeShift(int onoff,int value);
 
 uint8_t UI_updateRecentMenu( void );
+void UI_updateRecentProjectsMenu(void);
 
 uint8_t UI_arrow_enabled(void);
 uint8_t UI_arrow_disabled(void);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp	2009-12-28 14:08:49 UTC (rev 5745)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp	2009-12-28 15:35:49 UTC (rev 5746)
@@ -207,16 +207,35 @@
         case ACT_RECENT1:        
         case ACT_RECENT2:
         case ACT_RECENT3:
-                        const char **name;
-						char* fileName;
-                        int rank;
-                                name=prefs->get_lastfiles();
-                                rank=(int)action-ACT_RECENT0;
-                                ADM_assert(name[rank]);
-                                A_openAvi2 (name[rank], 0);
+		case ACT_RECENT4:
+		case ACT_RECENT5:
+		{
+			const char **name;
+			char* fileName;
+			int rank;
+			name=prefs->get_lastfiles();
+			rank=(int)action-ACT_RECENT0;
+			ADM_assert(name[rank]);
+			A_openAvi2 (name[rank], 0);
 
-                return;
-        case ACT_ViewMain: UI_toogleMain();return;
+			return;
+		}
+        case ACT_RECENTPROJECT0:
+        case ACT_RECENTPROJECT1:        
+        case ACT_RECENTPROJECT2:
+        case ACT_RECENTPROJECT3:
+		case ACT_RECENTPROJECT4:
+		case ACT_RECENTPROJECT5:
+		{
+			const char **name = prefs->getLastProjects();
+			int rank = (int)action - ACT_RECENTPROJECT0;
+
+			ADM_assert(name[rank]);
+			A_parseECMAScript(name[rank]);
+
+			return;
+		}
+		case ACT_ViewMain: UI_toogleMain();return;
         case ACT_ViewSide: UI_toogleSide();return;
         case ACT_DVB_Ocr:
         		DIA_ocrDvb();
@@ -1846,6 +1865,9 @@
       if( actual_workbench_file )
          ADM_dealloc(actual_workbench_file);
       actual_workbench_file = ADM_strdup(longname);
+
+	  prefs->setLastProject(longname);
+	  UI_updateRecentProjectsMenu();
    }
    ADM_dealloc(longname);
 }

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/gui_action.names
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/gui_action.names	2009-12-28 14:08:49 UTC (rev 5745)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/gui_action.names	2009-12-28 15:35:49 UTC (rev 5746)
@@ -138,6 +138,14 @@
 ACT(RECENT1)
 ACT(RECENT2)
 ACT(RECENT3)
+ACT(RECENT4)
+ACT(RECENT5)
+ACT(RECENTPROJECT0)
+ACT(RECENTPROJECT1)
+ACT(RECENTPROJECT2)
+ACT(RECENTPROJECT3)
+ACT(RECENTPROJECT4)
+ACT(RECENTPROJECT5)
 
 ACT(AUTO_VCD)
 ACT(AUTO_SVCD)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/prefs.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/prefs.h	2009-12-28 14:08:49 UTC (rev 5745)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/prefs.h	2009-12-28 15:35:49 UTC (rev 5746)
@@ -53,6 +53,12 @@
 	LASTFILES_FILE4,
 	LASTFILES_FILE5,
 	LASTFILES_FILE6,
+	LASTPROJECT_FILE1,
+	LASTPROJECT_FILE2,
+	LASTPROJECT_FILE3,
+	LASTPROJECT_FILE4,
+	LASTPROJECT_FILE5,
+	LASTPROJECT_FILE6,
 	LASTDIR_READ,
 	LASTDIR_WRITE,
 	MESSAGE_LEVEL,
@@ -87,6 +93,8 @@
 class preferences {
 	private:
 		char *internal_lastfiles[7];
+		char *_lastProjects[7];
+
 		int save_xml_to_file();
 	public:
 		preferences();
@@ -117,6 +125,8 @@
                 int set(options option, const ADM_filename * val);
 		int set_lastfile(const char* file);
 		const char **get_lastfiles(void);
+		const char **getLastProjects(void);
+		int setLastProject(const char* file);
 };
 
 extern preferences *prefs;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/prefs.in
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/prefs.in	2009-12-28 14:08:49 UTC (rev 5745)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/prefs.in	2009-12-28 15:35:49 UTC (rev 5746)
@@ -67,6 +67,12 @@
 lastfiles.file4,			FILENAME,	""
 lastfiles.file5,			FILENAME,	""
 lastfiles.file6,			FILENAME,	""
+lastproject.file1,			FILENAME,	""
+lastproject.file2,			FILENAME,	""
+lastproject.file3,			FILENAME,	""
+lastproject.file4,			FILENAME,	""
+lastproject.file5,			FILENAME,	""
+lastproject.file6,			FILENAME,	""
 lastdir_read,				FILENAME,	""
 lastdir_write,				FILENAME,	""
 # 0 - no messages, 1 - only error messages, 2 - all messages



From gruntster at mail.berlios.de  Mon Dec 28 17:38:41 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 28 Dec 2009 17:38:41 +0100
Subject: [Avidemux-svn-commit] r5747 - in
	branches/avidemux_2.5_branch_gruntster: platforms/windows/installer
	plugins/ADM_videoEncoder/ADM_vidEnc_avcodec
	plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml
	plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-1
Message-ID: <200912281638.nBSGcfiW030623@sheep.berlios.de>

Author: gruntster
Date: 2009-12-28 17:38:33 +0100 (Mon, 28 Dec 2009)
New Revision: 5747

Added:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-1/
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-1/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-1/Video CD.xml
Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
Log:
[mpeg-1] add Video CD configuration

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2009-12-28 15:35:49 UTC (rev 5746)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2009-12-28 16:38:33 UTC (rev 5747)
@@ -482,6 +482,10 @@
 			SetOverwrite on
 			SetOutPath $INSTDIR\plugins\videoEncoder
 			${File} plugins\videoEncoder\libADM_vidEnc_avcodec.dll
+			SetOutPath $INSTDIR\plugins\videoEncoder\avcodec
+			${File} plugins\videoEncoder\avcodec\Mpeg1Param.xsd
+			SetOutPath $INSTDIR\plugins\videoEncoder\avcodec\mpeg-1
+			${File} plugins\videoEncoder\avcodec\mpeg-1\*.xml
 		${MementoSectionEnd}
 		${MementoSection} "x264 (MPEG-4 AVC)" SecVidEncX264
 			SectionIn 1 2

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-28 15:35:49 UTC (rev 5746)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-28 16:38:33 UTC (rev 5747)
@@ -13,7 +13,7 @@
 							 mpeg1EncoderOptions.cpp)
 
 set(PLUGIN_SCHEMA_DIR "avcodec")
-set(MPEG1_PLUGIN_CONFIG_DIR "avcodec/mpeg1")
+set(MPEG1_PLUGIN_CONFIG_DIR "avcodec/mpeg-1")
 
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${LIBXML2_INCLUDE_DIR})
 ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_SCHEMA_DIR="${PLUGIN_SCHEMA_DIR}")
@@ -25,6 +25,7 @@
 set_property(TARGET ADM_libavcodec PROPERTY IMPORTED_LOCATION "${FFMPEG_INSTALL_DIR}/${LIBAVCODEC_LIB}")
 
 add_subdirectory(xvidRateCtl)
+add_subdirectory(xml)
 
 ADD_LIBRARY(ADM_vidEnc_avcodec SHARED ${ADM_vidEnc_avcodec_SRCS})
 TARGET_LINK_LIBRARIES(ADM_vidEnc_avcodec ${LIBXML2_LIBRARIES} ADM_xvidRateCtl ADM_core ADM_coreUI ADM_libavcodec)

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/CMakeLists.txt	2009-12-28 15:35:49 UTC (rev 5746)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/CMakeLists.txt	2009-12-28 16:38:33 UTC (rev 5747)
@@ -0,0 +1 @@
+add_subdirectory(mpeg-1)
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-1/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-1/CMakeLists.txt	2009-12-28 15:35:49 UTC (rev 5746)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-1/CMakeLists.txt	2009-12-28 16:38:33 UTC (rev 5747)
@@ -0,0 +1 @@
+INSTALL(DIRECTORY . DESTINATION "${VIDENC_INSTALL_DIR}${MPEG1_PLUGIN_CONFIG_DIR}" FILES_MATCHING PATTERN "*.xml" PATTERN ".svn" EXCLUDE)
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-1/Video CD.xml
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-1/Video CD.xml	2009-12-28 15:35:49 UTC (rev 5746)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-1/Video CD.xml	2009-12-28 16:38:33 UTC (rev 5747)
@@ -0,0 +1 @@
+<?xml version='1.0'?><Mpeg1Config><encodeOptions><mode>CQP</mode><parameter>4</parameter></encodeOptions><Mpeg1Options><minBitrate>600</minBitrate><maxBitrate>2200</maxBitrate><xvidRateControl>false</xvidRateControl><bufferSize>40</bufferSize><widescreen>false</widescreen><interlaced>none</interlaced><gopSize>12</gopSize></Mpeg1Options></Mpeg1Config>
\ No newline at end of file



From gruntster at mail.berlios.de  Mon Dec 28 19:58:57 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 28 Dec 2009 19:58:57 +0100
Subject: [Avidemux-svn-commit] r5748 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder:
	ADM_vidEnc_avcodec ADM_vidEnc_x264 ADM_vidEnc_x264/gtk
	ADM_vidEnc_x264/qt4 ADM_vidEnc_xvid ADM_vidEnc_xvid/qt4 common
Message-ID: <200912281858.nBSIwvUJ027642@sheep.berlios.de>

Author: gruntster
Date: 2009-12-28 19:58:49 +0100 (Mon, 28 Dec 2009)
New Revision: 5748

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/gtk/x264ConfigDialog.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.h
Log:
[vidEnc] change plugin options class so it is no longer intended as singleton

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-28 16:38:33 UTC (rev 5747)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-28 18:58:49 UTC (rev 5748)
@@ -10,7 +10,7 @@
 
 SET(ADM_vidEnc_avcodec_SRCS  interface.c  encoder.cpp  huffyuvEncoder.cpp
 							 ffvhuffEncoder.cpp  ffv1Encoder.cpp  dvEncoder.cpp  mpeg1Encoder.cpp
-							 mpeg1EncoderOptions.cpp)
+							 ../common/PluginOptions.cpp  mpeg1EncoderOptions.cpp)
 
 set(PLUGIN_SCHEMA_DIR "avcodec")
 set(MPEG1_PLUGIN_CONFIG_DIR "avcodec/mpeg-1")

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp	2009-12-28 16:38:33 UTC (rev 5747)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp	2009-12-28 18:58:49 UTC (rev 5748)
@@ -29,10 +29,9 @@
 #include "ADM_default.h"
 #include "ADM_files.h"
 
-#include "../common/PluginOptions.cpp"
 #include "mpeg1EncoderOptions.h"
 
-Mpeg1EncoderOptions::Mpeg1EncoderOptions(void) : PluginOptions("Mpeg1", "Mpeg1Param.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
+Mpeg1EncoderOptions::Mpeg1EncoderOptions(void) : PluginOptions(PLUGIN_CONFIG_DIR, "Mpeg1", "Mpeg1Param.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
 {
 	reset();
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt	2009-12-28 16:38:33 UTC (rev 5747)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt	2009-12-28 18:58:49 UTC (rev 5748)
@@ -17,7 +17,7 @@
 		INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${X264_INCLUDE_DIR} ${LIBXML2_INCLUDE_DIR} ../common)
 		ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_SCHEMA_DIR="${PLUGIN_SCHEMA_DIR}" -DPLUGIN_CONFIG_DIR="${PLUGIN_CONFIG_DIR}")
 		
-		SET(ADM_vidEnc_x264_SRCS interface.c configGuiLoader.cpp encoder.cpp guiHelper.cpp zoneOptions.cpp x264Options.cpp)
+		SET(ADM_vidEnc_x264_SRCS interface.c configGuiLoader.cpp encoder.cpp guiHelper.cpp zoneOptions.cpp x264Options.cpp ../common/PluginOptions.cpp)
 
 		CONFIGURE_FILE("${CMAKE_CURRENT_SOURCE_DIR}/config.h.cmake" "${CMAKE_CURRENT_BINARY_DIR}/config.h")
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/gtk/x264ConfigDialog.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/gtk/x264ConfigDialog.cpp	2009-12-28 16:38:33 UTC (rev 5747)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/gtk/x264ConfigDialog.cpp	2009-12-28 18:58:49 UTC (rev 5748)
@@ -40,7 +40,7 @@
 
 #define WID(x) lookup_widget(dialog, #x)
 
-typedef struct X264_AR
+struct X264_AR
 {
 	uint32_t num, den;
 	const char *symbol;

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2009-12-28 16:38:33 UTC (rev 5747)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2009-12-28 18:58:49 UTC (rev 5748)
@@ -177,7 +177,8 @@
 	bool origDisableGenericSlots = disableGenericSlots;
 	QMap<QString, int> configs;
 	QStringList filter("*.xml");
-	char* configDir = x264Options::getUserConfigDirectory();
+	x264Options options;
+	char* configDir = options.getUserConfigDirectory();
 	QStringList list = QDir(configDir).entryList(filter, QDir::Files | QDir::Readable);
 
 	delete [] configDir;
@@ -186,7 +187,7 @@
 	for (int item = 0; item < list.size(); item++)
 		configs.insert(QFileInfo(list[item]).completeBaseName(), PLUGIN_CONFIG_USER);
 
-	configDir = x264Options::getSystemConfigDirectory();
+	configDir = options.getSystemConfigDirectory();
 	list = QDir(configDir).entryList(filter, QDir::Files | QDir::Readable);
 
 	delete [] configDir;
@@ -351,7 +352,8 @@
 
 void x264ConfigDialog::deleteButton_pressed(void)
 {
-	char *configDir = x264Options::getUserConfigDirectory();
+	x264Options options;
+	char *configDir = options.getUserConfigDirectory();
 	QString configFileName = QFileInfo(QString(configDir), ui.configurationComboBox->currentText() + ".xml").filePath();
 	QFile configFile(configFileName);
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2009-12-28 16:38:33 UTC (rev 5747)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2009-12-28 18:58:49 UTC (rev 5748)
@@ -30,10 +30,9 @@
 #include "ADM_inttype.h"
 #include "ADM_files.h"
 
-#include "../common/PluginOptions.cpp"
 #include "x264Options.h"
 
-x264Options::x264Options(void) : PluginOptions("x264", "x264Param.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
+x264Options::x264Options(void) : PluginOptions(PLUGIN_CONFIG_DIR, "x264", "x264Param.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
 {
 	memset(&_param, 0, sizeof(x264_param_t));
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt	2009-12-28 16:38:33 UTC (rev 5747)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt	2009-12-28 18:58:49 UTC (rev 5748)
@@ -16,7 +16,7 @@
 		INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${XVID_INCLUDE_DIR} ${LIBXML2_INCLUDE_DIR} ../common)
 		ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_SCHEMA_DIR="${PLUGIN_SCHEMA_DIR}" -DPLUGIN_CONFIG_DIR="${PLUGIN_CONFIG_DIR}")
 
-		SET(ADM_vidEnc_xvid_SRCS interface.c  encoder.cpp  xvidOptions.cpp  configGuiLoader.cpp)
+		SET(ADM_vidEnc_xvid_SRCS interface.c  encoder.cpp  xvidOptions.cpp  configGuiLoader.cpp  ../common/PluginOptions.cpp)
 
 		CONFIGURE_FILE("${CMAKE_CURRENT_SOURCE_DIR}/config.h.cmake" "${CMAKE_CURRENT_BINARY_DIR}/config.h")
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp	2009-12-28 16:38:33 UTC (rev 5747)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/qt4/xvidConfigDialog.cpp	2009-12-28 18:58:49 UTC (rev 5748)
@@ -93,10 +93,11 @@
 
 void XvidConfigDialog::fillConfigurationComboBox(void)
 {
+	XvidOptions options;
 	bool origDisableGenericSlots = disableGenericSlots;
 	QMap<QString, int> configs;
 	QStringList filter("*.xml");
-	char* configDir = XvidOptions::getUserConfigDirectory();
+	char* configDir = options.getUserConfigDirectory();
 	QStringList list = QDir(configDir).entryList(filter, QDir::Files | QDir::Readable);
 
 	delete [] configDir;
@@ -105,7 +106,7 @@
 	for (int item = 0; item < list.size(); item++)
 		configs.insert(QFileInfo(list[item]).completeBaseName(), PLUGIN_CONFIG_USER);
 
-	configDir = XvidOptions::getSystemConfigDirectory();
+	configDir = options.getSystemConfigDirectory();
 	list = QDir(configDir).entryList(filter, QDir::Files | QDir::Readable);
 
 	delete [] configDir;
@@ -240,7 +241,8 @@
 
 void XvidConfigDialog::deleteButton_pressed(void)
 {
-	char *configDir = XvidOptions::getUserConfigDirectory();
+	XvidOptions options;
+	char *configDir = options.getUserConfigDirectory();
 	QString configFileName = QFileInfo(QString(configDir), ui.configurationComboBox->currentText() + ".xml").filePath();
 	QFile configFile(configFileName);
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp	2009-12-28 16:38:33 UTC (rev 5747)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp	2009-12-28 18:58:49 UTC (rev 5748)
@@ -28,10 +28,9 @@
 #include "ADM_inttype.h"
 #include "ADM_files.h"
 
-#include "../common/PluginOptions.cpp"
 #include "xvidOptions.h"
 
-XvidOptions::XvidOptions(void) : PluginOptions("Xvid", "XvidParam.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
+XvidOptions::XvidOptions(void) : PluginOptions(PLUGIN_CONFIG_DIR, "Xvid", "XvidParam.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
 {
 	reset();
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.cpp	2009-12-28 16:38:33 UTC (rev 5747)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.cpp	2009-12-28 18:58:49 UTC (rev 5748)
@@ -19,13 +19,18 @@
 
 #include "ADM_inttype.h"
 #include "ADM_files.h"
+#include "PluginXmlOptions.cpp"
 #include "PluginOptions.h"
-#include "PluginXmlOptions.cpp"
+
 #undef malloc
 #undef free
 #undef strdup
-PluginOptions::PluginOptions(const char* tagPrefix, const char* schemaFile, unsigned int defaultEncodeMode, int defaultEncodeModeParameter)
+PluginOptions::PluginOptions(const char* configurationDirectory, const char* tagPrefix, const char* schemaFile, 
+							 unsigned int defaultEncodeMode, int defaultEncodeModeParameter)
 {
+	_configurationDirectory = new char[strlen(configurationDirectory) + 1];
+	strcpy(_configurationDirectory, configurationDirectory);
+
 	_tagPrefix = new char[strlen(tagPrefix) + 1];
 	strcpy(_tagPrefix, tagPrefix);
 
@@ -52,6 +57,12 @@
 {
 	cleanUp();
 
+	if (_configurationDirectory)
+	{
+		delete [] _configurationDirectory;
+		_configurationDirectory = NULL;
+	}
+
 	if (_tagPrefix)
 	{
 		delete [] _tagPrefix;
@@ -376,17 +387,17 @@
 
 char* PluginOptions::getUserConfigDirectory(void)
 {
-	return ADM_getHomeRelativePath(PLUGIN_CONFIG_DIR);
+	return ADM_getHomeRelativePath(_configurationDirectory);
 }
 
 char* PluginOptions::getSystemConfigDirectory(void)
 {
 	char* pluginPath = ADM_getPluginPath();
-	char* systemConfigPath = new char[strlen(pluginPath) + strlen(PLUGIN_CONFIG_DIR) + 2];
+	char* systemConfigPath = new char[strlen(pluginPath) + strlen(_configurationDirectory) + 2];
 
 	strcpy(systemConfigPath, pluginPath);
 	strcat(systemConfigPath, "/");
-	strcat(systemConfigPath, PLUGIN_CONFIG_DIR);
+	strcat(systemConfigPath, _configurationDirectory);
 
 	delete [] pluginPath;
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.h	2009-12-28 16:38:33 UTC (rev 5747)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.h	2009-12-28 18:58:49 UTC (rev 5748)
@@ -41,7 +41,7 @@
 	int _defaultEncodeModeParameter;
 
 	char *_tagPrefix, *_configTagRoot, *_optionsTagRoot;
-	char *_schemaFile;
+	char *_configurationDirectory, *_schemaFile;
 	char *_configurationName;
 	PluginConfigType _configurationType;
 
@@ -51,7 +51,7 @@
 	virtual void parsePresetConfiguration(xmlNode *node);
 
 public:
-	PluginOptions(const char* tagPrefix, const char* schemaFile, unsigned int defaultEncodeMode, int defaultEncodeModeParameter);
+	PluginOptions(const char* configurationDirectory, const char* tagPrefix, const char* schemaFile, unsigned int defaultEncodeMode, int defaultEncodeModeParameter);
 	~PluginOptions(void);
 
 	virtual vidEncOptions* getEncodeOptions(void);
@@ -73,8 +73,8 @@
 	virtual char* toXml(PluginXmlType xmlType);
 	virtual int fromXml(const char *xml, PluginXmlType xmlType);
 
-	static char* getUserConfigDirectory(void);
-	static char* getSystemConfigDirectory(void);
+	virtual char* getUserConfigDirectory(void);
+	virtual char* getSystemConfigDirectory(void);
 };
 
 #endif	// options_h



From gruntster at mail.berlios.de  Mon Dec 28 22:20:22 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 28 Dec 2009 22:20:22 +0100
Subject: [Avidemux-svn-commit] r5749 - in
	branches/avidemux_2.5_branch_gruntster: avidemux/ADM_encoder
	avidemux/ADM_outputs/oplug_mpegFF
	plugins/ADM_videoEncoder/ADM_vidEnc_avcodec
Message-ID: <200912282120.nBSLKMEk005921@sheep.berlios.de>

Author: gruntster
Date: 2009-12-28 22:20:13 +0100 (Mon, 28 Dec 2009)
New Revision: 5749

Added:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Mpeg2Param.xsd
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.h
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.h
Log:
[mpeg2] avcodec MPEG-2 video plugin

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2009-12-28 21:20:13 UTC (rev 5749)
@@ -88,7 +88,8 @@
 CodecFamilty videoCodecGetFamily(void)
 {
 	if (currentCodecType == CodecXVCD || currentCodecType == CodecXSVCD || currentCodecType == CodecXDVD ||
-		(currentCodecType == CodecExternal && strcmp(videoCodecPluginGetGuid(), "85FC9CAC-CE6C-4aa6-9D5F-352D6349BA3E") == 0))
+		(currentCodecType == CodecExternal && strcmp(videoCodecPluginGetGuid(), "85FC9CAC-CE6C-4aa6-9D5F-352D6349BA3E") == 0) ||
+		(currentCodecType == CodecExternal && strcmp(videoCodecPluginGetGuid(), "DBAECD8B-CF29-4846-AF57-B596427FE7D3") == 0))
 		return CodecFamilyXVCD;
 	if (currentCodecType == CodecVCD || currentCodecType == CodecSVCD || currentCodecType == CodecDVD || currentCodecType == CodecRequant)
 		return CodecFamilyMpeg;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp	2009-12-28 21:20:13 UTC (rev 5749)
@@ -135,7 +135,8 @@
                 audio_encoding=hdr->encoding;
 
                 if (videoCodecGetType() == CodecXVCD || videoCodecGetType() == CodecVCD ||
-					(videoCodecGetType() == CodecExternal && strcmp(videoCodecPluginGetGuid(), "85FC9CAC-CE6C-4aa6-9D5F-352D6349BA3E") == 0))	// MPEG-1 plugin
+					(videoCodecGetType() == CodecExternal && strcmp(videoCodecPluginGetGuid(), "85FC9CAC-CE6C-4aa6-9D5F-352D6349BA3E") == 0) || // avcodec MPEG-1 plugin
+					(videoCodecGetType() == CodecExternal && strcmp(videoCodecPluginGetGuid(), "DBAECD8B-CF29-4846-AF57-B596427FE7D3") == 0)) // avcodec MPEG-2 plugin
                 {
                         if(hdr->frequency!=44100 ||  hdr->encoding != WAV_MP2)
                         {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-28 21:20:13 UTC (rev 5749)
@@ -9,15 +9,17 @@
 endif (WIN32)
 
 SET(ADM_vidEnc_avcodec_SRCS  interface.c  encoder.cpp  huffyuvEncoder.cpp
-							 ffvhuffEncoder.cpp  ffv1Encoder.cpp  dvEncoder.cpp  mpeg1Encoder.cpp
-							 ../common/PluginOptions.cpp  mpeg1EncoderOptions.cpp)
+							 ffvhuffEncoder.cpp  ffv1Encoder.cpp  dvEncoder.cpp  ../common/PluginOptions.cpp
+							 mpeg1Encoder.cpp  mpeg1EncoderOptions.cpp  mpeg2Encoder.cpp  mpeg2EncoderOptions.cpp)
 
 set(PLUGIN_SCHEMA_DIR "avcodec")
 set(MPEG1_PLUGIN_CONFIG_DIR "avcodec/mpeg-1")
+set(MPEG2_PLUGIN_CONFIG_DIR "avcodec/mpeg-2")
 
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${LIBXML2_INCLUDE_DIR})
 ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_SCHEMA_DIR="${PLUGIN_SCHEMA_DIR}")
 set_property(SOURCE mpeg1EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DPLUGIN_CONFIG_DIR=\\\"${MPEG1_PLUGIN_CONFIG_DIR}\\\")
+set_property(SOURCE mpeg2EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DPLUGIN_CONFIG_DIR=\\\"${MPEG2_PLUGIN_CONFIG_DIR}\\\")
 
 getFfmpegLibNames(${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_libraries/ffmpeg)
 
@@ -33,3 +35,4 @@
 INIT_VIDEO_ENCODER_PLUGIN(ADM_vidEnc_avcodec)
 INSTALL_VIDEO_ENCODER(ADM_vidEnc_avcodec)
 INSTALL(FILES Mpeg1Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
+INSTALL(FILES Mpeg2Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Mpeg2Param.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Mpeg2Param.xsd	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Mpeg2Param.xsd	2009-12-28 21:20:13 UTC (rev 5749)
@@ -0,0 +1,106 @@
+<?xml version="1.0" encoding="utf-8"?>
+<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified">
+  <xs:element name="Mpeg2Config">
+    <xs:complexType>
+      <xs:sequence>
+        <xs:element name="presetConfiguration" minOccurs="0">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="name" type="xs:string"/>
+              <xs:element name="type">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="default"/>
+                    <xs:enumeration value="user"/>
+                    <xs:enumeration value="system"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+        <xs:element name="encodeOptions" minOccurs="0">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="mode">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="CBR"/>
+                    <xs:enumeration value="CQP"/>
+                    <xs:enumeration value="2PASS SIZE"/>
+                    <xs:enumeration value="2PASS ABR"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="parameter" type="uint"/>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+        <xs:element name="Mpeg2Options">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="minBitrate" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="0"/>
+                    <xs:maxInclusive value="9000"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="maxBitrate" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="100"/>
+                    <xs:maxInclusive value="9000"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="xvidRateControl" type="xs:boolean" minOccurs="0"/>
+              <xs:element name="bufferSize" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="1"/>
+                    <xs:maxInclusive value="1024"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="widescreen" type="xs:boolean" minOccurs="0"/>
+              <xs:element name="interlaced" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="none"/>
+                    <xs:enumeration value="bff"/>
+                    <xs:enumeration value="tff"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="matrix" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="default"/>
+                    <xs:enumeration value="tmpgenc"/>
+                    <xs:enumeration value="anime"/>
+                    <xs:enumeration value="kvcd"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="gopSize" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="1"/>
+                    <xs:maxInclusive value="30"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+      </xs:sequence>
+    </xs:complexType>
+  </xs:element>
+  <xs:simpleType name="uint">
+    <xs:restriction base="xs:integer">
+      <xs:minInclusive value="0"/>
+    </xs:restriction>
+  </xs:simpleType>
+</xs:schema>

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2009-12-28 21:20:13 UTC (rev 5749)
@@ -21,6 +21,7 @@
 #include "ffvhuffEncoder.h"
 #include "huffyuvEncoder.h"
 #include "mpeg1Encoder.h"
+#include "mpeg2Encoder.h"
 #include "ADM_inttype.h"
 
 int uiType;
@@ -30,9 +31,10 @@
 static FFVHuffEncoder ffvhuff;
 static HuffyuvEncoder huffyuv;
 static Mpeg1Encoder mpeg1Encoder;
+static Mpeg2Encoder mpeg2Encoder;
 
-static int encoderIds[] = { 0, 1, 2, 3, 4 };
-static AvcodecEncoder* encoders[] = { &dv, &ffv1, &ffvhuff, &huffyuv, &mpeg1Encoder};
+static int encoderIds[] = { 0, 1, 2, 3, 4, 5 };
+static AvcodecEncoder* encoders[] = { &dv, &ffv1, &ffvhuff, &huffyuv, &mpeg1Encoder, &mpeg2Encoder};
 
 extern "C"
 {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-28 21:20:13 UTC (rev 5749)
@@ -71,8 +71,8 @@
 void vidEncGetEncoderVersion(int encoderId, int* major, int* minor, int* patch)
 {
 	*major = 1;
-	*minor = 0;
-	*patch = 1;
+	*minor = 1;
+	*patch = 0;
 }
 
 const char* vidEncGetEncoderGuid(int encoderId)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp	2009-12-28 21:20:13 UTC (rev 5749)
@@ -66,18 +66,18 @@
 
 	switch (_options.getMatrix())
 	{
-		case MATRIX_TMPGENC:
+		case MPEG1_MATRIX_TMPGENC:
 			printf("using custom matrix: Tmpg\n");
 			_context->intra_matrix = tmpgenc_intra;
 			_context->inter_matrix = tmpgenc_inter;
 			break;
-		case MATRIX_ANIME:
+		case MPEG1_MATRIX_ANIME:
 			printf("using custom matrix: anim\n");
 			_context->intra_matrix = anime_intra;
 			_context->inter_matrix = anime_inter;
 
 			break;
-		case MATRIX_KVCD:
+		case MPEG1_MATRIX_KVCD:
 			printf("using custom matrix: kvcd\n");
 			_context->intra_matrix = kvcd_intra;
 			_context->inter_matrix = kvcd_inter;
@@ -86,9 +86,9 @@
 
 	switch (_options.getInterlaced())
 	{
-		case INTERLACED_TFF:
+		case MPEG1_INTERLACED_TFF:
 			_frame.top_field_first = true;
-		case INTERLACED_BFF:
+		case MPEG1_INTERLACED_BFF:
 			_frame.interlaced_frame = true;
 			break;
 	}
@@ -321,8 +321,8 @@
 	options->setXvidRateControl(_useXvidRateControl);
 	options->setBufferSize(_bufferSize);
 	options->setWidescreen(_widescreen);
-	options->setInterlaced((InterlacedMode)_interlaced);
-	options->setMatrix((MatrixMode)_userMatrix);
+	options->setInterlaced((Mpeg1InterlacedMode)_interlaced);
+	options->setMatrix((Mpeg1MatrixMode)_userMatrix);
 	options->setGopSize(_gopSize);
 }
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp	2009-12-28 21:20:13 UTC (rev 5749)
@@ -45,8 +45,8 @@
 	setXvidRateControl(false);
 	setBufferSize(40);
 	setWidescreen(false);
-	setInterlaced(INTERLACED_NONE);
-	setMatrix(MATRIX_DEFAULT);
+	setInterlaced(MPEG1_INTERLACED_NONE);
+	setMatrix(MPEG1_MATRIX_DEFAULT);
 	setGopSize(12);
 }
 
@@ -103,25 +103,25 @@
 	_widescreen = widescreen;
 }
 
-InterlacedMode Mpeg1EncoderOptions::getInterlaced(void)
+Mpeg1InterlacedMode Mpeg1EncoderOptions::getInterlaced(void)
 {
 	return _interlaced;
 }
 
-void Mpeg1EncoderOptions::setInterlaced(InterlacedMode interlaced)
+void Mpeg1EncoderOptions::setInterlaced(Mpeg1InterlacedMode interlaced)
 {
-	if (interlaced == INTERLACED_NONE || interlaced == INTERLACED_BFF || interlaced == INTERLACED_TFF)
+	if (interlaced == MPEG1_INTERLACED_NONE || interlaced == MPEG1_INTERLACED_BFF || interlaced == MPEG1_INTERLACED_TFF)
 		_interlaced = interlaced;
 }
 
-MatrixMode Mpeg1EncoderOptions::getMatrix(void)
+Mpeg1MatrixMode Mpeg1EncoderOptions::getMatrix(void)
 {
 	return _matrix;
 }
 
-void Mpeg1EncoderOptions::setMatrix(MatrixMode matrix)
+void Mpeg1EncoderOptions::setMatrix(Mpeg1MatrixMode matrix)
 {
-	if (matrix == MATRIX_DEFAULT || matrix == MATRIX_TMPGENC || matrix == MATRIX_ANIME || matrix == MATRIX_KVCD)
+	if (matrix == MPEG1_MATRIX_DEFAULT || matrix == MPEG1_MATRIX_TMPGENC || matrix == MPEG1_MATRIX_ANIME || matrix == MPEG1_MATRIX_KVCD)
 		_matrix = matrix;
 }
 
@@ -151,10 +151,10 @@
 
 	switch (getInterlaced())
 	{
-		case INTERLACED_BFF:
+		case MPEG1_INTERLACED_BFF:
 			strcpy((char*)xmlBuffer, "bff");
 			break;
-		case INTERLACED_TFF:
+		case MPEG1_INTERLACED_TFF:
 			strcpy((char*)xmlBuffer, "tff");
 			break;
 		default:
@@ -166,13 +166,13 @@
 
 	switch (getMatrix())
 	{
-		case MATRIX_TMPGENC:
+		case MPEG1_MATRIX_TMPGENC:
 			strcpy((char*)xmlBuffer, "tmpgenc");
 			break;
-		case MATRIX_ANIME:
+		case MPEG1_MATRIX_ANIME:
 			strcpy((char*)xmlBuffer, "anime");
 			break;
-		case MATRIX_KVCD:
+		case MPEG1_MATRIX_KVCD:
 			strcpy((char*)xmlBuffer, "kvcd");
 			break;
 		default:
@@ -203,25 +203,25 @@
 				setWidescreen(string2Boolean(content));
 			else if (strcmp((char*)xmlChild->name, "interlaced") == 0)
 			{
-				InterlacedMode mode = INTERLACED_NONE;
+				Mpeg1InterlacedMode mode = MPEG1_INTERLACED_NONE;
 
 				if (strcmp(content, "bff") == 0)
-					mode = INTERLACED_BFF;
+					mode = MPEG1_INTERLACED_BFF;
 				else if (strcmp(content, "tff") == 0)
-					mode = INTERLACED_TFF;
+					mode = MPEG1_INTERLACED_TFF;
 
 				setInterlaced(mode);
 			}
 			else if (strcmp((char*)xmlChild->name, "matrix") == 0)
 			{
-				MatrixMode mode = MATRIX_DEFAULT;
+				Mpeg1MatrixMode mode = MPEG1_MATRIX_DEFAULT;
 
 				if (strcmp(content, "tmpgenc") == 0)
-					mode = MATRIX_TMPGENC;
+					mode = MPEG1_MATRIX_TMPGENC;
 				else if (strcmp(content, "anime") == 0)
-					mode = MATRIX_ANIME;
+					mode = MPEG1_MATRIX_ANIME;
 				else if (strcmp(content, "kvcd") == 0)
-					mode = MATRIX_KVCD;
+					mode = MPEG1_MATRIX_KVCD;
 
 				setMatrix(mode);
 			}

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.h	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.h	2009-12-28 21:20:13 UTC (rev 5749)
@@ -30,26 +30,26 @@
 
 typedef enum
 {
-	INTERLACED_NONE,
-	INTERLACED_BFF,
-	INTERLACED_TFF
-} InterlacedMode;
+	MPEG1_INTERLACED_NONE,
+	MPEG1_INTERLACED_BFF,
+	MPEG1_INTERLACED_TFF
+} Mpeg1InterlacedMode;
 
 typedef enum
 {
-	MATRIX_DEFAULT,
-	MATRIX_TMPGENC,
-	MATRIX_ANIME,
-	MATRIX_KVCD
-} MatrixMode;
+	MPEG1_MATRIX_DEFAULT,
+	MPEG1_MATRIX_TMPGENC,
+	MPEG1_MATRIX_ANIME,
+	MPEG1_MATRIX_KVCD
+} Mpeg1MatrixMode;
 
 class Mpeg1EncoderOptions : public PluginOptions
 {
 protected:
 	unsigned int _minBitrate, _maxBitrate, _bufferSize, _gopSize;
 	bool _xvidRateControl, _widescreen;
-	InterlacedMode _interlaced;
-	MatrixMode _matrix;
+	Mpeg1InterlacedMode _interlaced;
+	Mpeg1MatrixMode _matrix;
 
 	void addOptionsToXml(xmlNodePtr xmlNodeRoot);
 	void parseOptions(xmlNode *node);
@@ -73,11 +73,11 @@
 	bool getWidescreen(void);
 	void setWidescreen(bool widescreen);
 
-	InterlacedMode getInterlaced(void);
-	void setInterlaced(InterlacedMode interlaced);
+	Mpeg1InterlacedMode getInterlaced(void);
+	void setInterlaced(Mpeg1InterlacedMode interlaced);
 
-	MatrixMode getMatrix(void);
-	void setMatrix(MatrixMode matrix);
+	Mpeg1MatrixMode getMatrix(void);
+	void setMatrix(Mpeg1MatrixMode matrix);
 
 	unsigned int getGopSize(void);
 	void setGopSize(unsigned int gopSize);

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp	2009-12-28 21:20:13 UTC (rev 5749)
@@ -0,0 +1,620 @@
+/***************************************************************************
+                               mpeg2Encoder.cpp
+
+    begin                : Mon Dec 28 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include <libxml/tree.h>
+#include "ADM_inttype.h"
+#include "mpeg2Encoder.h"
+#include "mpegMatrix.h"
+
+extern int _uiType;
+static bool changedConfig(const char* fileName, ConfigMenuType configType);
+static char *serializeConfig(void);
+static Mpeg2Encoder *encoder = NULL;
+
+#ifdef __WIN32
+extern void convertPathToAnsi(const char *path, char **ansiPath);
+#endif
+
+Mpeg2Encoder::Mpeg2Encoder(void)
+{
+	encoder = this;
+
+	init(CODEC_ID_MPEG2VIDEO, ADM_CSP_YV12);
+
+	_encodeOptions.structSize = sizeof(vidEncOptions);
+	_encodeOptions.encodeMode = DEFAULT_ENCODE_MODE;
+	_encodeOptions.encodeModeParameter = DEFAULT_ENCODE_MODE_PARAMETER;
+
+	_bitrateParam.capabilities = ADM_ENC_CAP_CBR | ADM_ENC_CAP_CQ | ADM_ENC_CAP_2PASS | ADM_ENC_CAP_2PASS_BR;
+	_bitrateParam.qz = DEFAULT_ENCODE_MODE_PARAMETER;
+	_bitrateParam.avg_bitrate = 1000;
+	_bitrateParam.finalsize = 700;
+	_bitrateParam.bitrate = 1500;
+
+	_statFile = NULL;
+	_xvidRc = NULL;
+}
+
+int Mpeg2Encoder::initContext(const char* logFileName)
+{
+	AvcodecEncoder::initContext(logFileName);
+	int ret = ADM_VIDENC_ERR_SUCCESS;
+
+	_context->gop_size = _options.getGopSize();
+
+	if (_options.getWidescreen())
+	{
+		_context->sample_aspect_ratio.num = 16;
+		_context->sample_aspect_ratio.den = 9;
+	}
+	else
+	{
+		_context->sample_aspect_ratio.num = 4;
+		_context->sample_aspect_ratio.den = 3;
+	}
+
+	switch (_options.getMatrix())
+	{
+		case MPEG2_MATRIX_TMPGENC:
+			printf("using custom matrix: Tmpg\n");
+			_context->intra_matrix = tmpgenc_intra;
+			_context->inter_matrix = tmpgenc_inter;
+			break;
+		case MPEG2_MATRIX_ANIME:
+			printf("using custom matrix: anim\n");
+			_context->intra_matrix = anime_intra;
+			_context->inter_matrix = anime_inter;
+
+			break;
+		case MPEG2_MATRIX_KVCD:
+			printf("using custom matrix: kvcd\n");
+			_context->intra_matrix = kvcd_intra;
+			_context->inter_matrix = kvcd_inter;
+			break;
+	}
+
+	switch (_options.getInterlaced())
+	{
+		case MPEG2_INTERLACED_TFF:
+			_frame.top_field_first = true;
+		case MPEG2_INTERLACED_BFF:
+			_frame.interlaced_frame = true;
+			break;
+	}
+
+	int fps = (_fpsDen * 1000) / _fpsNum;
+	int fpsTarget = 23976;
+
+	if ((fps > fpsTarget - 300) && (fps < fpsTarget + 300))
+		_context->flags2 |= CODEC_FLAG2_32_PULLDOWN;
+
+	_context->i_quant_factor = 0.8;
+	_context->rc_initial_cplx = 3;
+	_context->mpeg_quant = 1;
+	_context->max_b_frames = 2;
+	_context->luma_elim_threshold = -2;
+	_context->chroma_elim_threshold = -5;
+	_context->lumi_masking = 0.05;
+	_context->me_range = 255;
+	_context->mb_decision = FF_MB_DECISION_RD;
+	_context->scenechange_threshold = 0xfffffff;
+	_context->rc_max_rate_header = _options.getMaxBitrate() * 1000;
+	_context->rc_buffer_size_header = _options.getBufferSize() * 8 * 1024;
+	_context->dark_masking = 0.01;
+	_context->rc_qsquish = 1.0;
+
+	if (_currentPass == 1)
+	{
+		if (_encodeOptions.encodeMode == ADM_ENC_CAP_CBR)
+		{
+			_context->bit_rate = _encodeOptions.encodeModeParameter * 1000;
+			_context->bit_rate_tolerance = 8000000;
+		}
+		else
+		{
+			_context->bit_rate = 0;
+			_context->bit_rate_tolerance = 1024 * 8 * 1000;
+			_context->flags |= CODEC_FLAG_QSCALE;
+		}
+
+		if (_passCount > 1)
+			_context->flags |= CODEC_FLAG_PASS1;
+	}
+	else 
+	{
+		if (_options.getXvidRateControl())
+		{
+			_context->max_qdiff = 10;
+			_context->bit_rate = 2500 * 1000 * 8;
+			_context->bit_rate_tolerance = 1024 * 8 * 1000;
+			_context->flags |= CODEC_FLAG_QSCALE;
+		}
+		else
+		{
+			_context->bit_rate_tolerance = 8000000;
+			_context->flags |= CODEC_FLAG_PASS2;
+
+			if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE)
+				_context->bit_rate = calculateBitrate(_fpsNum, _fpsDen, _frameCount, _encodeOptions.encodeModeParameter);
+			else
+				_context->bit_rate = _encodeOptions.encodeModeParameter * 1000;
+
+			if (_context->bit_rate > _options.getMaxBitrate() * 1000)
+				_context->bit_rate = _options.getMaxBitrate() * 1000;
+		}		
+	}
+
+	if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE || _encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_ABR)
+	{
+		char *log = NULL;
+
+#ifdef __WIN32
+		convertPathToAnsi(logFileName, &log);
+#else
+		log = new char[strlen(logFileName) + 1];
+		strcpy(log, logFileName);
+#endif
+
+		if (_options.getXvidRateControl())
+		{
+			_xvidRc = new ADM_newXvidRcVBV((_fpsNum * 1000) / _fpsDen, log);
+		}
+		else if (_currentPass == 1)
+		{
+			_statFile = fopen(log, "wb");
+
+			if (!_statFile)
+				ret = ADM_VIDENC_ERR_FAILED;
+		}
+		else
+		{
+			FILE *statFile = fopen(log, "rb");
+
+			if (statFile)
+			{
+				fseek(statFile, 0, SEEK_END);
+
+				long statSize = ftello(statFile);
+
+				fseek(statFile, 0, SEEK_SET);
+				_context->stats_in = new char[statSize + 1];
+				_context->stats_in[statSize] = 0;
+
+				fread(_context->stats_in, statSize, 1, statFile);
+				fclose(statFile);
+			}
+			else
+				ret = ADM_VIDENC_ERR_FAILED;
+		}
+	}
+
+	if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_CQP || _encodeOptions.encodeMode == ADM_VIDENC_MODE_CBR || 
+		(_currentPass == 2 && !_options.getXvidRateControl()))
+	{
+		_context->rc_max_rate = _context->rc_max_rate_header;
+		_context->rc_buffer_size = _context->rc_buffer_size_header;
+	}
+
+	return ret;
+}
+
+const char* Mpeg2Encoder::getEncoderType(void)
+{
+	return "MPEG-2";
+}
+
+const char* Mpeg2Encoder::getEncoderDescription(void)
+{
+	return "MPEG-2 video encoder plugin for Avidemux (c) Mean/Gruntster";
+}
+
+const char* Mpeg2Encoder::getFourCC(void)
+{
+	return "mpg2";
+}
+
+const char* Mpeg2Encoder::getEncoderGuid(void)
+{
+	return "DBAECD8B-CF29-4846-AF57-B596427FE7D3";
+}
+
+int Mpeg2Encoder::isConfigurable(void)
+{
+	return (_uiType == ADM_UI_GTK || _uiType == ADM_UI_QT4);
+}
+
+int Mpeg2Encoder::configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties)
+{
+	loadSettings(&_encodeOptions, &_options);
+
+	diaMenuEntry wideM[] = {
+		{0, "4:3"},
+		{1, "16:9"}};
+
+	diaMenuEntry matrixM[]={
+		{0, "Default"},
+		{1, "TMPGEnc"},
+		{2, "Anime"},
+		{3, "KVCD"}
+	};
+
+	diaMenuEntry interM[]={
+		{0, "Progressive"},
+		{1, "Interlaced BFF"},
+		{2, "Interlaced TFF"}
+	};
+
+	diaElemBitrate ctlBitrate(&_bitrateParam, NULL);
+	diaElemUInteger ctlMaxb(&_maxBitrate, "Ma_x. bitrate:", 100, 9000);
+	diaElemUInteger ctlMinb(&_minBitrate, "Mi_n. bitrate:", 0, 9000);
+	diaElemToggle ctlXvid(&_useXvidRateControl, "_Use Xvid rate control");
+	diaElemUInteger ctlVbv(&_bufferSize, "_Buffer size:", 1, 1024);
+	diaElemMenu ctlWidescreen(&_widescreen, "Aspect _ratio:", 2, wideM);
+	diaElemMenu ctlMatrix(&_userMatrix, "_Matrices:", 4, matrixM);
+	diaElemUInteger ctlGop(&_gopSize, "_GOP size:", 1, 30);
+	diaElemMenu ctlInterW(&_interlaced, "_Interlacing:", 3, interM);
+	diaElem *elmGeneral[9]= {&ctlBitrate, &ctlMinb, &ctlMaxb, &ctlXvid, &ctlVbv, &ctlWidescreen, &ctlInterW, &ctlMatrix, &ctlGop};
+
+	diaElemConfigMenu ctlConfigMenu(configName, &configType, _options.getUserConfigDirectory(), _options.getSystemConfigDirectory(),
+		changedConfig, serializeConfig, elmGeneral, 9);
+	diaElem *elmHeader[1] = {&ctlConfigMenu};
+
+	diaElemTabs tabGeneral("User Interface", 9, elmGeneral);
+	diaElemTabs *tabs[] = {&tabGeneral};
+
+	if (diaFactoryRunTabs("avcodec MPEG-2 Configuration", 1, elmHeader, 1, tabs))
+	{
+		saveSettings(&_encodeOptions, &_options);
+		updateEncodeProperties(&_encodeOptions);
+
+		return 1;
+	}
+
+	return 0;
+}
+
+void Mpeg2Encoder::loadSettings(vidEncOptions *encodeOptions, Mpeg2EncoderOptions *options)
+{
+	char *configurationName;
+
+	options->getPresetConfiguration(&configurationName, (PluginConfigType*)&configType);
+
+	if (configurationName)
+	{
+		strcpy(this->configName, configurationName);
+		delete [] configurationName;
+	}
+
+	if (encodeOptions)
+	{
+		_minBitrate = options->getMinBitrate();
+		_maxBitrate = options->getMaxBitrate();
+		_useXvidRateControl = options->getXvidRateControl();
+		_bufferSize = options->getBufferSize();
+		_widescreen = options->getWidescreen();
+		_interlaced = options->getInterlaced();
+		_userMatrix = options->getMatrix();
+		_gopSize = options->getGopSize();
+
+		updateEncodeProperties(encodeOptions);
+	}
+}
+
+void Mpeg2Encoder::saveSettings(vidEncOptions *encodeOptions, Mpeg2EncoderOptions *options)
+{
+	options->setPresetConfiguration(&configName[0], (PluginConfigType)configType);
+
+	switch (_bitrateParam.mode)
+	{
+		case COMPRESS_CQ:
+			encodeOptions->encodeMode = ADM_VIDENC_MODE_CQP;
+			encodeOptions->encodeModeParameter = _bitrateParam.qz;
+
+			break;
+		case COMPRESS_CBR:
+			encodeOptions->encodeMode = ADM_VIDENC_MODE_CBR;
+			encodeOptions->encodeModeParameter = _bitrateParam.bitrate;
+
+			break;
+		case COMPRESS_2PASS:
+			encodeOptions->encodeMode = ADM_VIDENC_MODE_2PASS_SIZE;
+			encodeOptions->encodeModeParameter = _bitrateParam.finalsize;
+
+			break;
+		case COMPRESS_2PASS_BITRATE:
+			encodeOptions->encodeMode = ADM_VIDENC_MODE_2PASS_ABR;
+			encodeOptions->encodeModeParameter = _bitrateParam.avg_bitrate;
+
+			break;
+	}
+
+	options->setMinBitrate(_minBitrate);
+	options->setMaxBitrate(_maxBitrate);
+	options->setXvidRateControl(_useXvidRateControl);
+	options->setBufferSize(_bufferSize);
+	options->setWidescreen(_widescreen);
+	options->setInterlaced((Mpeg2InterlacedMode)_interlaced);
+	options->setMatrix((Mpeg2MatrixMode)_userMatrix);
+	options->setGopSize(_gopSize);
+}
+
+bool changedConfig(const char* configName, ConfigMenuType configType)
+{
+	bool failure = false;
+
+	if (configType == CONFIG_MENU_DEFAULT)
+	{
+		Mpeg2EncoderOptions defaultOptions;
+		vidEncOptions *defaultEncodeOptions = defaultOptions.getEncodeOptions();
+
+		encoder->loadSettings(defaultEncodeOptions, &defaultOptions);
+
+		delete defaultEncodeOptions;
+	}
+	else
+	{
+		Mpeg2EncoderOptions options;
+
+		options.setPresetConfiguration(configName, (PluginConfigType)configType);
+
+		if (configType == CONFIG_MENU_CUSTOM)
+			encoder->loadSettings(NULL, &options);
+		else
+		{
+			vidEncOptions *encodeOptions;
+
+			if (options.loadPresetConfiguration())
+			{
+				encodeOptions = options.getEncodeOptions();
+
+				encoder->loadSettings(encodeOptions, &options);
+
+				delete encodeOptions;
+			}
+			else
+			{
+				failure = true;
+			}
+		}
+	}
+
+	return configType == CONFIG_MENU_CUSTOM | !failure;
+}
+
+char *serializeConfig(void)
+{
+	vidEncOptions encodeOptions;
+	Mpeg2EncoderOptions options;
+
+	encoder->saveSettings(&encodeOptions, &options);
+	options.setEncodeOptions(&encodeOptions);
+
+	return options.toXml(PLUGIN_XML_EXTERNAL);
+}
+
+int Mpeg2Encoder::getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize)
+{
+	char* xml = _options.toXml(PLUGIN_XML_INTERNAL);
+	int xmlLength = strlen(xml);
+
+	if (bufferSize >= xmlLength)
+	{
+		memcpy(pluginOptions, xml, xmlLength);
+		memcpy(encodeOptions, &_encodeOptions, sizeof(vidEncOptions));
+	}
+	else if (bufferSize != 0)
+		xmlLength = 0;
+
+	delete [] xml;
+
+	return xmlLength;
+}
+
+int Mpeg2Encoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+{
+	if (_opened)
+		return ADM_VIDENC_ERR_ALREADY_OPEN;
+
+	bool success = true;
+
+	if (pluginOptions)
+	{
+		success = _options.fromXml(pluginOptions, PLUGIN_XML_INTERNAL);
+
+		_options.loadPresetConfiguration();
+	}
+
+	if (encodeOptions && success)
+	{
+		memcpy(&_encodeOptions, encodeOptions, sizeof(vidEncOptions));
+		updateEncodeProperties(encodeOptions);
+	}
+
+	if (success)
+		return ADM_VIDENC_ERR_SUCCESS;
+	else
+		return ADM_VIDENC_ERR_FAILED;
+}
+
+int Mpeg2Encoder::beginPass(vidEncPassParameters *passParameters)
+{
+	int qz = 0;
+	int ret = AvcodecEncoder::beginPass(passParameters);
+
+	if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_CQP)
+		qz = _encodeOptions.encodeModeParameter;
+	else if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE || _encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_ABR)
+	{
+		if (_currentPass == 1)
+		{
+			qz = 2;
+
+			if (_options.getXvidRateControl())
+				_xvidRc->startPass1();
+		}
+		else if (_currentPass == 2 && _options.getXvidRateControl())
+		{
+			double d = _frameCount;
+			uint32_t maxBitrate = _options.getMaxBitrate() * 1000;
+			uint32_t bitrate;
+
+			if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE)
+				bitrate = calculateBitrate(_fpsNum, _fpsDen, _frameCount, _encodeOptions.encodeModeParameter);
+			else
+				bitrate = _encodeOptions.encodeModeParameter * 1000;
+
+			if (bitrate > maxBitrate)
+				bitrate = maxBitrate;
+
+			d *= 1000.;
+			d /= (_fpsNum * 1000) / _fpsDen;   // D is a duration in second
+			d *= bitrate;   // * bitrate = total bits
+			d /= 8;   // Byte
+			d /= 1024 * 1024;   // MB
+
+			_xvidRc->setVBVInfo(_options.getMaxBitrate(), _options.getMinBitrate(), _options.getBufferSize());
+			_xvidRc->startPass2((uint32_t)d, _frameCount);
+		}
+	}
+
+	if (qz)
+		_frame.quality = (int)floor(FF_QP2LAMBDA * qz + 0.5);
+
+	return ret;
+}
+
+int Mpeg2Encoder::finishPass(void)
+{
+	int ret = AvcodecEncoder::finishPass();
+
+	if (_statFile)
+	{
+		fclose(_statFile);
+		_statFile = NULL;
+	}
+
+	if (_xvidRc)
+	{
+		delete _xvidRc;
+		_xvidRc = NULL;
+	}
+
+	if (_context && _context->stats_in)
+	{
+		delete [] _context->stats_in;
+		_context->stats_in = NULL;
+	}
+
+	return ret;
+}
+
+int Mpeg2Encoder::encodeFrame(vidEncEncodeParameters *encodeParams)
+{
+	ADM_rframe rf;
+	uint32_t qz;
+
+	if (_options.getXvidRateControl() && _currentPass == 2)
+	{
+		_xvidRc->getQz(&qz, &rf);
+
+		if (qz < 2)
+			qz = 2;
+
+		if (qz > 28)
+			qz = 28;
+
+		_frame.quality = (int)floor(FF_QP2LAMBDA * qz + 0.5);
+	}
+
+	int ret = AvcodecEncoder::encodeFrame(encodeParams);
+
+	if (_context->stats_out)
+		fprintf (_statFile, "%s", _context->stats_out);
+
+	if (_options.getXvidRateControl() && encodeParams->encodedDataSize && (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE || _encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_ABR))
+	{
+		switch (encodeParams->frameType)
+		{
+			case ADM_VIDENC_FRAMETYPE_IDR:
+				rf = RF_I;
+				break;
+			case ADM_VIDENC_FRAMETYPE_B:
+				rf = RF_B;
+				break;
+			case ADM_VIDENC_FRAMETYPE_P:
+				rf = RF_P;
+				break;
+		}
+
+		if (_currentPass == 1)
+			_xvidRc->logPass1(encodeParams->quantiser, rf, encodeParams->encodedDataSize);
+		else
+			_xvidRc->logPass2(qz, rf, encodeParams->encodedDataSize);
+	}
+
+	return ret;
+}
+
+void Mpeg2Encoder::updateEncodeProperties(vidEncOptions *encodeOptions)
+{
+	switch (encodeOptions->encodeMode)
+	{
+		case ADM_VIDENC_MODE_CQP:
+			_passCount = 1;
+
+			_bitrateParam.mode = COMPRESS_CQ;
+			_bitrateParam.qz = encodeOptions->encodeModeParameter;
+
+			break;
+		case ADM_VIDENC_MODE_CBR:
+			_passCount = 1;
+
+			_bitrateParam.mode = COMPRESS_CBR;
+			_bitrateParam.bitrate = encodeOptions->encodeModeParameter;
+
+			break;
+		case ADM_VIDENC_MODE_2PASS_SIZE:
+			_passCount = 2;
+
+			_bitrateParam.mode = COMPRESS_2PASS;
+			_bitrateParam.finalsize = encodeOptions->encodeModeParameter;
+
+			break;
+		case ADM_VIDENC_MODE_2PASS_ABR:
+			_passCount = 2;
+
+			_bitrateParam.mode = COMPRESS_2PASS_BITRATE;
+			_bitrateParam.avg_bitrate = encodeOptions->encodeModeParameter;
+
+			break;
+	}
+}
+
+unsigned int Mpeg2Encoder::calculateBitrate(unsigned int fpsNum, unsigned int fpsDen, unsigned int frameCount, unsigned int sizeInMb)
+{
+	double db, ti;
+
+	db = sizeInMb;
+	db = db * 1024. * 1024. * 8.;
+	// now db is in bits
+
+	// compute duration
+	ti = frameCount;
+	ti *= fpsDen;
+	ti /= fpsNum;	// nb sec
+	db = db / ti;
+
+	return (unsigned int)floor(db);
+}

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.h	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.h	2009-12-28 21:20:13 UTC (rev 5749)
@@ -0,0 +1,67 @@
+/***************************************************************************
+                               mpeg2Encoder.h
+
+    begin                : Mon Dec 28 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef Mpeg2Encoder_h
+#define Mpeg2Encoder_h
+
+#ifdef __cplusplus
+extern "C"
+{
+	#include "ADM_vidEnc_plugin.h"
+}
+
+#include "encoder.h"
+#include "mpeg2EncoderOptions.h"
+#include "DIA_factory.h"
+#include "xvidRateCtl/xvidRateCtlVbv.h"
+
+class Mpeg2Encoder : public AvcodecEncoder
+{
+	private:
+		COMPRES_PARAMS _bitrateParam;
+		unsigned int _minBitrate, _maxBitrate, _useXvidRateControl, _bufferSize, _widescreen, _interlaced, _userMatrix, _gopSize;
+
+		char configName[PATH_MAX];
+		ConfigMenuType configType;
+
+		Mpeg2EncoderOptions _options;
+		vidEncOptions _encodeOptions;
+
+		FILE *_statFile;
+		ADM_newXvidRcVBV *_xvidRc;
+
+		void updateEncodeProperties(vidEncOptions *encodeOptions);
+		unsigned int calculateBitrate(unsigned int fpsNum, unsigned int fpsDen, unsigned int frameCount, unsigned int sizeInMb);
+
+	public:
+		Mpeg2Encoder(void);
+		int initContext(const char* logFileName);
+		const char* getEncoderType(void);
+		const char* getEncoderDescription(void);
+		const char* getFourCC(void);
+		const char* getEncoderGuid(void);
+		int isConfigurable(void);
+		int configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
+		void loadSettings(vidEncOptions *encodeOptions, Mpeg2EncoderOptions *options);
+		void saveSettings(vidEncOptions *encodeOptions, Mpeg2EncoderOptions *options);
+		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
+		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int beginPass(vidEncPassParameters *passParameters);
+		int encodeFrame(vidEncEncodeParameters *encodeParams);
+		int finishPass(void);
+};
+#endif	// __cplusplus
+#endif	// Mpeg2Encoder_h

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.cpp	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.cpp	2009-12-28 21:20:13 UTC (rev 5749)
@@ -0,0 +1,234 @@
+ /***************************************************************************
+                               Mpeg2EncoderOptions.cpp
+
+	These settings are intended for scripting and can contain a Preset 
+	Configuration block.  If this block exists then "internal" settings are
+	ignored and an external configuration file should be read instead, 
+	e.g. PlayStation Portable profile.  However, if the external file is 
+	missing, internal settings have to be used and will reflect a snapshot
+	of the external configuration file at the time the script was generated.
+
+    begin                : Mon Dec 28 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <math.h>
+#include <libxml/parser.h>
+#include <libxml/xmlschemas.h>
+#include <sstream>
+#include <string>
+#include "ADM_default.h"
+#include "ADM_files.h"
+
+#include "mpeg2EncoderOptions.h"
+
+Mpeg2EncoderOptions::Mpeg2EncoderOptions(void) : PluginOptions(PLUGIN_CONFIG_DIR, "Mpeg2", "Mpeg2Param.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
+{
+	reset();
+}
+
+void Mpeg2EncoderOptions::reset(void)
+{
+	PluginOptions::reset();
+
+	setMinBitrate(0);
+	setMaxBitrate(2400);
+	setXvidRateControl(true);
+	setBufferSize(112);
+	setWidescreen(false);
+	setInterlaced(MPEG2_INTERLACED_NONE);
+	setMatrix(MPEG2_MATRIX_DEFAULT);
+	setGopSize(12);
+}
+
+unsigned int Mpeg2EncoderOptions::getMinBitrate(void)
+{
+	return _minBitrate;
+}
+
+void Mpeg2EncoderOptions::setMinBitrate(unsigned int minBitrate)
+{
+	if (minBitrate <= 9000)
+		_minBitrate = minBitrate;
+}
+
+unsigned int Mpeg2EncoderOptions::getMaxBitrate(void)
+{
+	return _maxBitrate;
+}
+
+void Mpeg2EncoderOptions::setMaxBitrate(unsigned int maxBitrate)
+{
+	if (maxBitrate >= 100 && maxBitrate <= 9000)
+		_maxBitrate = maxBitrate;
+}
+
+bool Mpeg2EncoderOptions::getXvidRateControl(void)
+{
+	return _xvidRateControl;
+}
+
+void Mpeg2EncoderOptions::setXvidRateControl(bool xvidRateControl)
+{
+	_xvidRateControl = xvidRateControl;
+}
+
+unsigned int Mpeg2EncoderOptions::getBufferSize(void)
+{
+	return _bufferSize;
+}
+
+void Mpeg2EncoderOptions::setBufferSize(unsigned int bufferSize)
+{
+	if (bufferSize >= 1 && bufferSize <= 1024)
+		_bufferSize = bufferSize;
+}
+
+bool Mpeg2EncoderOptions::getWidescreen(void)
+{
+	return _widescreen;
+}
+
+void Mpeg2EncoderOptions::setWidescreen(bool widescreen)
+{
+	_widescreen = widescreen;
+}
+
+Mpeg2InterlacedMode Mpeg2EncoderOptions::getInterlaced(void)
+{
+	return _interlaced;
+}
+
+void Mpeg2EncoderOptions::setInterlaced(Mpeg2InterlacedMode interlaced)
+{
+	if (interlaced == MPEG2_INTERLACED_NONE || interlaced == MPEG2_INTERLACED_BFF || interlaced == MPEG2_INTERLACED_TFF)
+		_interlaced = interlaced;
+}
+
+Mpeg2MatrixMode Mpeg2EncoderOptions::getMatrix(void)
+{
+	return _matrix;
+}
+
+void Mpeg2EncoderOptions::setMatrix(Mpeg2MatrixMode matrix)
+{
+	if (matrix == MPEG2_MATRIX_DEFAULT || matrix == MPEG2_MATRIX_TMPGENC || matrix == MPEG2_MATRIX_ANIME || matrix == MPEG2_MATRIX_KVCD)
+		_matrix = matrix;
+}
+
+unsigned int Mpeg2EncoderOptions::getGopSize(void)
+{
+	return _gopSize;
+}
+
+void Mpeg2EncoderOptions::setGopSize(unsigned int gopSize)
+{
+	if (gopSize >= 1 && gopSize <= 30)
+		_gopSize = gopSize;
+}
+
+void Mpeg2EncoderOptions::addOptionsToXml(xmlNodePtr xmlNodeRoot)
+{
+	const int bufferSize = 100;
+	xmlChar xmlBuffer[bufferSize + 1];
+	xmlNodePtr xmlNodeChild, xmlNodeChild2;
+
+	xmlNodeRoot = xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)getOptionsTagRoot(), NULL);
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"minBitrate", number2String(xmlBuffer, bufferSize, getMinBitrate()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"maxBitrate", number2String(xmlBuffer, bufferSize, getMaxBitrate()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"xvidRateControl", boolean2String(xmlBuffer, bufferSize, getXvidRateControl()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"bufferSize", number2String(xmlBuffer, bufferSize, getBufferSize()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"widescreen", boolean2String(xmlBuffer, bufferSize, getWidescreen()));
+
+	switch (getInterlaced())
+	{
+		case MPEG2_INTERLACED_BFF:
+			strcpy((char*)xmlBuffer, "bff");
+			break;
+		case MPEG2_INTERLACED_TFF:
+			strcpy((char*)xmlBuffer, "tff");
+			break;
+		default:
+			strcpy((char*)xmlBuffer, "none");
+			break;
+	}
+
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"interlaced", xmlBuffer);
+
+	switch (getMatrix())
+	{
+		case MPEG2_MATRIX_TMPGENC:
+			strcpy((char*)xmlBuffer, "tmpgenc");
+			break;
+		case MPEG2_MATRIX_ANIME:
+			strcpy((char*)xmlBuffer, "anime");
+			break;
+		case MPEG2_MATRIX_KVCD:
+			strcpy((char*)xmlBuffer, "kvcd");
+			break;
+		default:
+			strcpy((char*)xmlBuffer, "default");
+			break;
+	}
+
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"gopSize", number2String(xmlBuffer, bufferSize, getGopSize()));
+}
+
+void Mpeg2EncoderOptions::parseOptions(xmlNode *node)
+{
+	for (xmlNode *xmlChild = node->children; xmlChild; xmlChild = xmlChild->next)
+	{
+		if (xmlChild->type == XML_ELEMENT_NODE)
+		{
+			char *content = (char*)xmlNodeGetContent(xmlChild);
+
+			if (strcmp((char*)xmlChild->name, "minBitrate") == 0)
+				setMinBitrate(atoi(content));
+			else if (strcmp((char*)xmlChild->name, "maxBitrate") == 0)
+				setMaxBitrate(atoi(content));
+			else if (strcmp((char*)xmlChild->name, "xvidRateControl") == 0)
+				setXvidRateControl(string2Boolean(content));
+			else if (strcmp((char*)xmlChild->name, "bufferSize") == 0)
+				setBufferSize(atoi(content));
+			else if (strcmp((char*)xmlChild->name, "widescreen") == 0)
+				setWidescreen(string2Boolean(content));
+			else if (strcmp((char*)xmlChild->name, "interlaced") == 0)
+			{
+				Mpeg2InterlacedMode mode = MPEG2_INTERLACED_NONE;
+
+				if (strcmp(content, "bff") == 0)
+					mode = MPEG2_INTERLACED_BFF;
+				else if (strcmp(content, "tff") == 0)
+					mode = MPEG2_INTERLACED_TFF;
+
+				setInterlaced(mode);
+			}
+			else if (strcmp((char*)xmlChild->name, "matrix") == 0)
+			{
+				Mpeg2MatrixMode mode = MPEG2_MATRIX_DEFAULT;
+
+				if (strcmp(content, "tmpgenc") == 0)
+					mode = MPEG2_MATRIX_TMPGENC;
+				else if (strcmp(content, "anime") == 0)
+					mode = MPEG2_MATRIX_ANIME;
+				else if (strcmp(content, "kvcd") == 0)
+					mode = MPEG2_MATRIX_KVCD;
+
+				setMatrix(mode);
+			}
+			else if (strcmp((char*)xmlChild->name, "gopSize") == 0)
+				setGopSize(atoi(content));
+
+			xmlFree(content);
+		}
+	}
+}

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.h	2009-12-28 18:58:49 UTC (rev 5748)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.h	2009-12-28 21:20:13 UTC (rev 5749)
@@ -0,0 +1,86 @@
+/***************************************************************************
+                            mpeg2EncoderOptions.h
+
+    begin                : Sat Jul 4 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef mpeg2EncoderOptions_h
+#define mpeg2EncoderOptions_h
+
+#include <vector>
+#include "../common/PluginOptions.h"
+
+extern "C"
+{
+#include "ADM_vidEnc_plugin.h"
+}
+
+#define DEFAULT_ENCODE_MODE ADM_VIDENC_MODE_CQP
+#define DEFAULT_ENCODE_MODE_PARAMETER 4
+
+typedef enum
+{
+	MPEG2_INTERLACED_NONE,
+	MPEG2_INTERLACED_BFF,
+	MPEG2_INTERLACED_TFF
+} Mpeg2InterlacedMode;
+
+typedef enum
+{
+	MPEG2_MATRIX_DEFAULT,
+	MPEG2_MATRIX_TMPGENC,
+	MPEG2_MATRIX_ANIME,
+	MPEG2_MATRIX_KVCD
+} Mpeg2MatrixMode;
+
+class Mpeg2EncoderOptions : public PluginOptions
+{
+protected:
+	unsigned int _minBitrate, _maxBitrate, _bufferSize, _gopSize;
+	bool _xvidRateControl, _widescreen;
+	Mpeg2InterlacedMode _interlaced;
+	Mpeg2MatrixMode _matrix;
+
+	void addOptionsToXml(xmlNodePtr xmlNodeRoot);
+	void parseOptions(xmlNode *node);
+
+public:
+	Mpeg2EncoderOptions(void);
+	void reset(void);
+
+	unsigned int getMinBitrate(void);
+	void setMinBitrate(unsigned int minBitrate);
+
+	unsigned int getMaxBitrate(void);
+	void setMaxBitrate(unsigned int maxBitrate);
+
+	bool getXvidRateControl(void);
+	void setXvidRateControl(bool xvidRateControl);
+
+	unsigned int getBufferSize(void);
+	void setBufferSize(unsigned int bufferSize);
+
+	bool getWidescreen(void);
+	void setWidescreen(bool widescreen);
+
+	Mpeg2InterlacedMode getInterlaced(void);
+	void setInterlaced(Mpeg2InterlacedMode interlaced);
+
+	Mpeg2MatrixMode getMatrix(void);
+	void setMatrix(Mpeg2MatrixMode matrix);
+
+	unsigned int getGopSize(void);
+	void setGopSize(unsigned int gopSize);
+};
+
+#endif	// mpeg2EncoderOptions_h



From gruntster at mail.berlios.de  Mon Dec 28 22:26:18 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 28 Dec 2009 22:26:18 +0100
Subject: [Avidemux-svn-commit] r5750 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml:
	. mpeg-2
Message-ID: <200912282126.nBSLQIi0006148@sheep.berlios.de>

Author: gruntster
Date: 2009-12-28 22:26:13 +0100 (Mon, 28 Dec 2009)
New Revision: 5750

Added:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/DVD.xml
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/Super Video CD.xml
Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/CMakeLists.txt
Log:
[mpeg-2] add SVCD and DVD configurations

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/CMakeLists.txt	2009-12-28 21:20:13 UTC (rev 5749)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/CMakeLists.txt	2009-12-28 21:26:13 UTC (rev 5750)
@@ -1 +1,2 @@
-add_subdirectory(mpeg-1)
\ No newline at end of file
+add_subdirectory(mpeg-1)
+add_subdirectory(mpeg-2)
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/CMakeLists.txt	2009-12-28 21:20:13 UTC (rev 5749)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/CMakeLists.txt	2009-12-28 21:26:13 UTC (rev 5750)
@@ -0,0 +1 @@
+INSTALL(DIRECTORY . DESTINATION "${VIDENC_INSTALL_DIR}${MPEG2_PLUGIN_CONFIG_DIR}" FILES_MATCHING PATTERN "*.xml" PATTERN ".svn" EXCLUDE)
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/DVD.xml
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/DVD.xml	2009-12-28 21:20:13 UTC (rev 5749)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/DVD.xml	2009-12-28 21:26:13 UTC (rev 5750)
@@ -0,0 +1 @@
+<?xml version='1.0'?><Mpeg2Config><encodeOptions><mode>CQP</mode><parameter>4</parameter></encodeOptions><Mpeg2Options><minBitrate>0</minBitrate><maxBitrate>8000</maxBitrate><xvidRateControl>true</xvidRateControl><bufferSize>224</bufferSize><widescreen>false</widescreen><interlaced>none</interlaced><gopSize>12</gopSize></Mpeg2Options></Mpeg2Config>
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/Super Video CD.xml
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/Super Video CD.xml	2009-12-28 21:20:13 UTC (rev 5749)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xml/mpeg-2/Super Video CD.xml	2009-12-28 21:26:13 UTC (rev 5750)
@@ -0,0 +1 @@
+<?xml version='1.0'?><Mpeg2Config><encodeOptions><mode>CQP</mode><parameter>4</parameter></encodeOptions><Mpeg2Options><minBitrate>0</minBitrate><maxBitrate>2400</maxBitrate><xvidRateControl>true</xvidRateControl><bufferSize>112</bufferSize><widescreen>false</widescreen><interlaced>none</interlaced><gopSize>12</gopSize></Mpeg2Options></Mpeg2Config>
\ No newline at end of file



From gruntster at mail.berlios.de  Mon Dec 28 22:28:39 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 28 Dec 2009 22:28:39 +0100
Subject: [Avidemux-svn-commit] r5751 - in
	branches/avidemux_2.5_branch_gruntster: avidemux
	platforms/windows/installer
Message-ID: <200912282128.nBSLSdEc006331@sheep.berlios.de>

Author: gruntster
Date: 2009-12-28 22:28:33 +0100 (Mon, 28 Dec 2009)
New Revision: 5751

Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/winInstaller/
Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
Log:
[win32] update installer to include configurations and delete old installer

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2009-12-28 21:26:13 UTC (rev 5750)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2009-12-28 21:28:33 UTC (rev 5751)
@@ -484,8 +484,11 @@
 			${File} plugins\videoEncoder\libADM_vidEnc_avcodec.dll
 			SetOutPath $INSTDIR\plugins\videoEncoder\avcodec
 			${File} plugins\videoEncoder\avcodec\Mpeg1Param.xsd
+			${File} plugins\videoEncoder\avcodec\Mpeg2Param.xsd
 			SetOutPath $INSTDIR\plugins\videoEncoder\avcodec\mpeg-1
 			${File} plugins\videoEncoder\avcodec\mpeg-1\*.xml
+			SetOutPath $INSTDIR\plugins\videoEncoder\avcodec\mpeg-2
+			${File} plugins\videoEncoder\avcodec\mpeg-2\*.xml
 		${MementoSectionEnd}
 		${MementoSection} "x264 (MPEG-4 AVC)" SecVidEncX264
 			SectionIn 1 2



From gruntster at mail.berlios.de  Mon Dec 28 22:54:05 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 28 Dec 2009 22:54:05 +0100
Subject: [Avidemux-svn-commit] r5752 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_codecs
	ADM_encoder ADM_outputs/oplug_mpegFF
Message-ID: <200912282154.nBSLs5Db009255@sheep.berlios.de>

Author: gruntster
Date: 2009-12-28 22:53:58 +0100 (Mon, 28 Dec 2009)
New Revision: 5752

Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg1.cpp
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp
Log:
[moeg] remove old avcodec mpeg-1 and mpeg-2 logic

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-28 21:28:33 UTC (rev 5751)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-28 21:53:58 UTC (rev 5752)
@@ -194,128 +194,11 @@
 
 }
 
-/*
-	This is called for mpeg1/2 initContext
-	Set some specific stuff.
-
-*/
 uint8_t
-ffmpegEncoder::gopMpeg1 (void)
-{
-  // small gop, 2 b frames allowed
-  // min bitrate 500 max bitrate 2200
-  int rate;
-
-  rate = _context->time_base.den;
-  rate = rate * 1000;
-  rate /= _context->time_base.num;
-
-  _context->me_range = 255;	// Fix motion vector for picky players (pioneer)
-
-  if (_id == FF_MPEG2)
-    {
-      if (FRAME_FILM == identMovieType (rate))
-	{
-	  printf ("[LAVCODEC]Pulldown activated...\n");
-	  _context->flags2 |= CODEC_FLAG2_32_PULLDOWN;
-	}
-    }
-#ifdef  TEST_NOB		// disable B frames
-  _context->max_b_frames = 0;
-#else
-  _context->max_b_frames = 2;
-#endif
-  printf ("[LAVCODEC]Using 2 b frames\n");
-  if (_id == FF_MPEG2)
-    {
-      _context->mpeg_quant = 1;	//1; // Should be mpeg quant 
-    }
-  else
-    {
-      _context->mpeg_quant = 0;	//1; // Should be mpeg quant 
-    }
-  if (_settingsPresence)
-    {
-      if (_settings.widescreen)
-	{
-          printf("[LAVCODEC]WideScreen\n");
-	  _context->sample_aspect_ratio.num = 16;
-	  _context->sample_aspect_ratio.den = 9;
-	}
-      else
-	{
-	  _context->sample_aspect_ratio.num = 4;
-	  _context->sample_aspect_ratio.den = 3;
-	}
-
-      _context->rc_max_rate_header = _settings.maxBitrate * 1000;//1800*1000;// 2400 max, 700 min
-      _context->rc_buffer_size_header = _settings.bufferSize * 8 * 1024;
-      // If we don't have a maxrate, don't set buffer_size
-      if (1 && !_settings.override_ratecontrol)	// FIXME
-
-	{
-	  _context->rc_buffer_size = _context->rc_buffer_size_header;
-	  _context->rc_max_rate = _context->rc_max_rate_header;
-	}
-      else
-	{
-	  _context->rc_buffer_size = 0;	// for xvid, no VBV so no ratecontrol
-	  _context->rc_max_rate = 0;
-	}
-      _context->gop_size = _settings.gop_size;
-
-    }
-  else
-    {
-      _context->rc_buffer_size = 200 * 8 * 1024;	// 40 for VCD  & 200 for SVCD
-      _context->gop_size = _settings.gop_size;
-
-    }
-  _context->rc_buffer_aggressivity = 1.0;
-  _context->rc_initial_cplx = 3;
-  _context->qmin = 2;
-  _context->qmax = 31;
-
-  _context->scenechange_threshold = 0xfffffff;	// Don't insert I frame out of order
-
-  _frame.interlaced_frame = _settings.interlaced;
-  if (_settings.interlaced)
-    _frame.top_field_first = !_settings.bff;
-
-#if defined(CODEC_FLAG_INTERLACED_DCT)
-  _context->flags |= _settings.interlaced ? CODEC_FLAG_INTERLACED_DCT : 0;
-#endif
-#if defined(CODEC_FLAG_INTERLACED_ME)
-  _context->flags |= _settings.interlaced ? CODEC_FLAG_INTERLACED_ME : 0;
-#endif
-
-  //
-  //_context->dsp_mask= FF_MM_FORCE;
-  printf ("[LAVCODEC]Mpeg12 settings:\n____________\n");
-  printf ("[LAVCODEC]FF Max rate   (header) : %lu kbps\n",
-	  (_context->rc_max_rate_header) / 1000);
-  printf ("[LAVCODEC]FF Buffer Size(header) : %lu bits / %lu kB\n",
-	  (_context->rc_buffer_size_header),
-	  _context->rc_buffer_size_header / (8 * 1024));
-  printf ("[LAVCODEC]FF Max rate   (rc) : %lu kbps\n", (_context->rc_max_rate) / 1000);
-  printf ("[LAVCODEC]FF Buffer Size(rc) : %lu bits / %lu kB\n",
-	  (_context->rc_buffer_size), _context->rc_buffer_size / (8 * 1024));
-
-  printf ("[LAVCODEC]FF GOP Size    : %lu\n", _context->gop_size);
-  printf ("[LAVCODEC]FF Bitrate    : %lu (kb/s)\n", _context->bit_rate/1000);
-  
-  return 1;
-}
-
-uint8_t
 ffmpegEncoder::initContext (void)
 {
   int res = 0;
 
-  // set a gop size close to what's requested for most
-  // player compatiblity               
-  if (_id == FF_MPEG1 || _id == FF_MPEG2)
-    gopMpeg1 ();
   // if (_id == FF_HUFF || _id == FF_FFV1)
   _context->strict_std_compliance = -1;
   
@@ -328,14 +211,6 @@
     case FF_MSMP4V3:
       WRAP_Open (CODEC_ID_MSMPEG4V3);
       break;
-    case FF_MPEG1:
-      encoderMT ();
-      WRAP_Open (CODEC_ID_MPEG1VIDEO);
-      break;
-    case FF_MPEG2:
-      encoderMT ();
-      WRAP_Open (CODEC_ID_MPEG2VIDEO);
-      break;
     case FF_H263:
       WRAP_Open (CODEC_ID_H263);
       break;
@@ -663,7 +538,7 @@
     }
   else
     {
-      if (_id == FF_MPEG1 || _id == FF_MPEG2 || _id == FF_FLV1)
+      if (_id == FF_FLV1)
 	{
 	  _context->gop_size = _settings.gop_size;
 	}

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h	2009-12-28 21:28:33 UTC (rev 5751)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h	2009-12-28 21:53:58 UTC (rev 5752)
@@ -26,11 +26,9 @@
 {
   FF_MSMP4V3 = 1,
   FF_MPEG4 = 2,
-  FF_MPEG1 = 3,
   FF_H263 = 4,
   FF_H263P = 5,
   FF_MJPEG = 8,
-  FF_MPEG2 = 9,
   FF_FLV1=13,
 } FF_CODEC_ID;
 
@@ -56,7 +54,6 @@
   FFcodecSetting _settings;
   void mplayer_init (void);
   uint8_t initContext (void);
-  uint8_t gopMpeg1 (void);
   uint32_t frameType (void);
   uint8_t encodePreamble (uint8_t * in);
   PixelFormat _targetColorSpace;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h	2009-12-28 21:28:33 UTC (rev 5751)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h	2009-12-28 21:53:58 UTC (rev 5752)
@@ -7,7 +7,6 @@
 #include "ADM_vidEncode.hxx"
 // Yv12
 extern uint8_t DIA_requant(COMPRES_PARAMS *incoming);
-#define FF_TRELLIS 0		// use treillis for mpeg1 encoding
 
 COMPRES_PARAMS yv12codec = {
   CodecYV12,
@@ -189,184 +188,6 @@
   &DIA_mjpegCodecSetting
 };
 
-//************************* FFMpeg mpeg1 **********************
-FFcodecSetting ffmpeg1Extra = {
-  ME_EPZS,			//     ME
-  0,				//          GMC
-  0,				//           _4MV;
-  0,				//           _QPEL;
-  0,				//           _TREILLIS_QUANT
-  2,				//           qmin;
-  31,				//          qmax;
-  3,				//           max_qdiff;
-  0,				//           max_b_frames;
-  1,				//          mpeg_quant;
-  1,				//
-  -2,				//                 luma_elim_threshold;
-  1,				//
-  -5,				//                 chroma_elim_threshold;
-  0.05,				//                lumi_masking;
-  1,
-  0.01,				//                dark_masking;
-  1,
-  0.5,				//         qcompress;  /* amount of qscale change between easy & hard scenes (0.0-1.0)*/
-  0.5,				//         qblur;      /* amount of qscale smoothing over time (0.0-1.0) */
-  600 ,   		// min bitrate in kB/S
-  2200 ,		// max bitrate
-  0,				// user_matrix 0->default, 1 tmpg, 2 anim?, 3 kvcd
-  12,				// Safe gop size limit
-  NULL,				// inter & intra matrix, will be set depending on user_matrix
-  NULL,
-  0,				// interlaced
-  0,				// WLA: bottom-field-first
-  0,				// wide screen
-  2,				// mb eval = distortion
-  8000,				// vratetol
-  0,
-  0.5,				// temporal masking
-  0,
-  0.5,				// spatial masking
-  0,				// NAQ
-  0,				// Use xvid ratecontrol
-  40,				// buffersize VCD like
-  0				// DUMMY                
-};
-
-COMPRES_PARAMS ffmpeg1Codec = {
-  CodecXVCD,
-  QT_TR_NOOP("VCD (lavc)"),
-  "XVCD",
-  "Lavcodec Mpeg1",
-  COMPRESS_CQ,
-  4,
-  1500,
-  700,
-  1000, // AVG
-  ADM_ENC_CAP_CQ + ADM_ENC_CAP_2PASS+ADM_ENC_CAP_2PASS_BR,
-  ADM_EXTRA_PARAM,
-  &ffmpeg1Extra,
-  sizeof (ffmpeg1Extra),
-  DIA_DVDffParam
-};
-//************ ffmpeg mpeg2 DVD **********
-
-FFcodecSetting ffmpeg2DVDExtra = {
-  ME_EPZS,			//     ME
-  0,				//          GMC
-  0,				//           _4MV;
-  0,				//           _QPEL;
-  FF_TRELLIS,			//          _TREILLIS_QUANT
-  2,				//           qmin;
-  31,				//          qmax;
-  3,				//           max_qdiff;
-  2,				//           max_b_frames;
-  1,				//          mpeg_quant;
-  1,				//
-  -2,				//                 luma_elim_threshold;
-  1,				//
-  -5,				//                 chroma_elim_threshold;
-  0.05,				//                lumi_masking;
-  1,
-  0.01,				//                dark_masking;
-  1,
-  0.5,				//         qcompress;  /* amount of qscale change between easy & hard scenes (0.0-1.0)*/
-  0.5,				//         qblur;      /* amount of qscale smoothing over time (0.0-1.0) */
-  0,				// min bitrate in kB/S
-  8000 ,		// max bitrate
-  0,				// user_matrix 0->default, 1 tmpg, 2 anim?, 3 kvcd
-  12,				// Safe gop size limit
-  NULL,				// inter & intra matrix, will be set depending on user_matrix
-  NULL,
-  0,				// interlaced
-  0,				// WLA: bottom-field-first
-  0,				// wide screen
-  2,				// mb eval = distortion
-  8000,				// vratetol
-  0,
-  0.5,				// temporal masking
-  0,
-  0.5,				// spatial masking
-  0,				// NAQ
-  1,				// Use xvid ratecontrol
-  224,				// buffersize 240 KB for Mpeg2 /
-  0				// DUMMY        
-};
-
-COMPRES_PARAMS ffmpeg2DVDCodec = {
-  CodecXDVD,
-  QT_TR_NOOP("DVD (lavc)"),
-  "XDVD",
-  "Lavcodec Mpeg2 (DVD)",
-  COMPRESS_CQ,
-  4,
-  1500,
-  700,
-  1000, // AVG
-  ADM_ENC_CAP_CQ + ADM_ENC_CAP_2PASS+ADM_ENC_CAP_2PASS_BR,
-  ADM_EXTRA_PARAM,
-  &ffmpeg2DVDExtra,
-  sizeof (ffmpeg2DVDExtra),
-  DIA_DVDffParam
-};
-//************ ffmpeg mpeg2 SVCD **********
-
-FFcodecSetting ffmpeg2SVCDExtra = {
-  ME_EPZS,			//     ME
-  0,				//          GMC
-  0,				//           _4MV;
-  0,				//           _QPEL;
-  FF_TRELLIS,			//          _TREILLIS_QUANT
-  2,				//           qmin;
-  31,				//          qmax;
-  3,				//           max_qdiff;
-  2,				//           max_b_frames;
-  1,				//          mpeg_quant;
-  1,				//
-  -2,				//                 luma_elim_threshold;
-  1,				//
-  -5,				//                 chroma_elim_threshold;
-  0.05,				//                lumi_masking;
-  1,
-  0.01,				//                dark_masking;
-  1,
-  0.5,				//         qcompress;  /* amount of qscale change between easy & hard scenes (0.0-1.0)*/
-  0.5,				//         qblur;      /* amount of qscale smoothing over time (0.0-1.0) */
-  0,				// min bitrate in kB/S
-  2400          ,		// max bitrate
-  0,				// user_matrix 0->default, 1 tmpg, 2 anim?, 3 kvcd
-  12,				// Safe gop size limit
-  NULL,				// inter & intra matrix, will be set depending on user_matrix
-  NULL,
-  0,				// interlaced
-  0,				// WLA: bottom-field-first
-  0,				// wide screen
-  2,				// mb eval = distortion
-  2400,				// vratetol
-  0,
-  0.5,				// temporal masking
-  0,
-  0.5,				// spatial masking
-  0,				// NAQ
-  1,				// Use xvid ratecontrol
-  112,				// buffersize 240 KB for Mpeg2 /
-  0				// DUMMY        
-};
-
-COMPRES_PARAMS ffmpeg2SVCDCodec = {
-  CodecXSVCD,
-  QT_TR_NOOP("SVCD (lavc)"),
-  "XSVCD",
-  "Lavcodec Mpeg2 (SVCD)",
-  COMPRESS_CQ,
-  4,
-  1500,
-  700,1000, // AVG
-  ADM_ENC_CAP_CBR + ADM_ENC_CAP_CQ + ADM_ENC_CAP_2PASS+ADM_ENC_CAP_2PASS_BR,
-  ADM_EXTRA_PARAM,
-  &ffmpeg2SVCDExtra,
-  sizeof (ffmpeg2SVCDExtra),
-  DIA_DVDffParam
-};
 #include "ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2enc.h"
 // ************ Mpeg2enc VCD *************
 Mpeg2encParam VCDExtra = {
@@ -484,9 +305,6 @@
 COMPRES_PARAMS *internalVideoCodec[] = {
   &CopyCodec,
   &ffmpegMpeg4,
-  &ffmpeg1Codec,
-  &ffmpeg2DVDCodec,
-  &ffmpeg2SVCDCodec,
   &VCDCodec,
   &SVCDCodec,
   &DVDCodec,

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx	2009-12-28 21:28:33 UTC (rev 5751)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx	2009-12-28 21:53:58 UTC (rev 5752)
@@ -27,9 +27,6 @@
   CodecVCD,
   CodecSVCD,
   CodecDVD,
-  CodecXVCD,
-  CodecXSVCD,
-  CodecXDVD,
   CodecYV12,
   CodecRequant,
   CodecFLV1,

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt	2009-12-28 21:28:33 UTC (rev 5751)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt	2009-12-28 21:53:58 UTC (rev 5752)
@@ -1,5 +1,5 @@
 SET(ADM_encoder_SRCS 
-	adm_encConfig.cpp  adm_encffmpeg1.cpp  adm_encmjpeg.cpp     adm_encoder.cpp
+	adm_encConfig.cpp  adm_encmjpeg.cpp     adm_encoder.cpp
 	adm_encCopy.cpp    adm_encffmpeg.cpp   adm_encmpeg2enc.cpp  adm_encRequant.cpp  adm_encyv12.cpp
 	ADM_pluginLoad.cpp ADM_externalEncoder.cpp)
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2009-12-28 21:28:33 UTC (rev 5751)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2009-12-28 21:53:58 UTC (rev 5752)
@@ -87,8 +87,7 @@
 }
 CodecFamilty videoCodecGetFamily(void)
 {
-	if (currentCodecType == CodecXVCD || currentCodecType == CodecXSVCD || currentCodecType == CodecXDVD ||
-		(currentCodecType == CodecExternal && strcmp(videoCodecPluginGetGuid(), "85FC9CAC-CE6C-4aa6-9D5F-352D6349BA3E") == 0) ||
+	if ((currentCodecType == CodecExternal && strcmp(videoCodecPluginGetGuid(), "85FC9CAC-CE6C-4aa6-9D5F-352D6349BA3E") == 0) ||
 		(currentCodecType == CodecExternal && strcmp(videoCodecPluginGetGuid(), "DBAECD8B-CF29-4846-AF57-B596427FE7D3") == 0))
 		return CodecFamilyXVCD;
 	if (currentCodecType == CodecVCD || currentCodecType == CodecSVCD || currentCodecType == CodecDVD || currentCodecType == CodecRequant)
@@ -614,18 +613,6 @@
 
 		e = new EncoderFFMPEG (FF_H263, desc);
 		break;
-	case CodecXVCD:
-		e=new EncoderFFMPEGMpeg1(FF_MPEG1, desc);
-		printf("\n Using ffmpeg mpeg1 encoder\n");
-		break;
-	case CodecXSVCD:
-		e=new EncoderFFMPEGMpeg1(FF_MPEG2, desc);
-		printf("\n Using ffmpeg mpeg2 encoder\n");
-		break;
-	case CodecXDVD:
-		e=new EncoderFFMPEGMpeg1(FF_MPEG2, desc);
-		printf("\n Using ffmpeg mpeg2 encoder (DVD)\n");
-		break;
 	case CodecDVD:
 		e=new EncoderMpeg2enc(MPEG2ENC_DVD, desc);
 		printf("\n Using mpeg2enc encoder (DVD)\n");

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h	2009-12-28 21:28:33 UTC (rev 5751)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h	2009-12-28 21:53:58 UTC (rev 5752)
@@ -56,34 +56,6 @@
 
 };
 
-class EncoderFFMPEGMpeg1:public EncoderFFMPEG
-{
-private:
-  uint8_t setMatrix (void);
-  uint8_t _lastQz;
-  uint32_t _lastBitrate;
-
-public:
-
-
-    uint32_t _totalframe;
-  uint32_t _pass1Done;
-  uint8_t _use_xvid_ratecontrol;
-
-public:
-    EncoderFFMPEGMpeg1 (FF_CODEC_ID id, COMPRES_PARAMS * config);
-    virtual ~ EncoderFFMPEGMpeg1 ();	// can be called twice if needed ..
-  virtual int getRequirements (void);
-  virtual uint8_t isDualPass (void);
-  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
-  virtual uint8_t encode (uint32_t frame, ADMBitstream *out);
-  virtual uint8_t setLogFile (const char *p, uint32_t fr);
-  virtual uint8_t stop (void);
-  virtual uint8_t startPass2 (void);
-  virtual uint8_t startPass1 (void);
-          uint8_t verifyLog(const char *name,uint32_t nbFrame);
-};
-
 class EncoderFFMPEGFLV1:public EncoderFFMPEG
 {
 

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg1.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg1.cpp	2009-12-28 21:28:33 UTC (rev 5751)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg1.cpp	2009-12-28 21:53:58 UTC (rev 5752)
@@ -1,511 +0,0 @@
-/***************************************************************************
-                          adm_encffmpeg.cpp  -  description
-                             -------------------
-    begin                : Tue Sep 10 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include "config.h"
-
-#include <unistd.h>
-
-#include <time.h>
-#include <sys/time.h>
-
-
-#ifdef USE_FFMPEG
-#include "ADM_lavcodec.h"
-
-#include "fourcc.h"
-#include "avi_vars.h"
-#include "DIA_coreToolkit.h"
-#include "ADM_assert.h"
-
-#include "ADM_encoder/ADM_vidEncode.hxx"
-
-#include "ADM_videoFilter.h"
-
-#include "ADM_codecs/ADM_ffmpeg.h"
-#include "ADM_encoder/adm_encoder.h"
-#include "ADM_encoder/adm_encffmpeg.h"
-
-#include "ADM_osSupport/ADM_debugID.h"
-#define MODULE_NAME MODULE_ENCODER
-#include "ADM_osSupport/ADM_debug.h"
-
-#include "adm_encffmatrix.h"
-
-#define FIRST_PASS_QUANTIZER 2
-
-
-#include "ADM_libraries/ADM_xvidratectl/ADM_ratecontrol.h"
-
-static ADM_newXvidRcVBV *_xrc = NULL;
-
-/*_________________________________________________*/
-EncoderFFMPEGMpeg1::EncoderFFMPEGMpeg1 (FF_CODEC_ID id, COMPRES_PARAMS * config):EncoderFFMPEG (id,
-	       config)
-{
-  _frametogo = 0;
-  _pass1Done = 0;
-  _lastQz = 0;
-  _lastBitrate = 0;
-  _totalframe = 0;
-
-
-  memcpy (&_param, config, sizeof (_param));
-  ADM_assert (config->extraSettingsLen == sizeof (_settings));
-  memcpy (&_settings, config->extraSettings, sizeof (_settings));
-  _use_xvid_ratecontrol = 0;
-
-};
-uint8_t     EncoderFFMPEGMpeg1::encode (uint32_t frame, ADMBitstream *out)
-{
-  uint32_t l, f;
-  ADM_assert (_codec);
-  ADM_assert (_in);
-  ADM_rframe rf;
-
-  if (!_in->getFrameNumberNoAlloc (frame, &l, _vbuffer, &f))
-    {
-      printf ("\n Error : Cannot read incoming frame !");
-      return 0;
-    }
-  switch (_state)
-    {
-    case enc_CQ:
-    case enc_CBR:
-      return _codec->encode (_vbuffer, out );
-      break;
-    case enc_Pass1:
-      // collect result
-      if (!_codec->encode (_vbuffer, out))
-	{
-	  printf ("\n codec error on 1st pass !");
-	  return 0;
-	}
-      if (_use_xvid_ratecontrol)
-	{
-	  if (!out->len)
-	    {
-	      printf ("Skipping delay\n");
-	      return 1;
-	    }
-	  switch (out->flags)
-	    {
-	    case AVI_KEY_FRAME:
-	      rf = RF_I;
-	      break;
-	    case AVI_B_FRAME:
-	      rf = RF_B;
-	      break;
-	    case 0:
-	      rf = RF_P;
-	      break;
-	    default:
-	      ADM_assert (0);
-
-	    }
-	  _xrc->logPass1 (out->out_quantizer, rf, out->len);
-
-	}
-      _frametogo++;
-      return 1;
-      break;
-    case enc_Pass2:
-      if (!_use_xvid_ratecontrol)
-	{
-	  if (!_codec->encode (_vbuffer, out))
-	    return 0;
-	  return 1;
-	}
-
-      uint32_t nq;
-      uint32_t nf;
-      ADM_rframe f;
-
-      _xrc->getQz (&nq, &f);
-
-      switch (f)
-	{
-	case RF_I:
-	  nf = AVI_KEY_FRAME;
-	  break;
-	default:
-	  nf = 0;
-	}
-
-#define MPEG1_MIN_Q 2
-#define MPEG1_MAX_Q 28
-      if (nq < MPEG1_MIN_Q)
-	nq = MPEG1_MIN_Q;
-      if (nq > MPEG1_MAX_Q)
-	nq = MPEG1_MAX_Q;
-
-      //printf("asked :%d ",nq);
-      out->in_quantizer=nq;
-      out->flags=nf;
-      if (!_codec->encode (_vbuffer, out))
-	return 0;
-      if (!out->len)
-	{
-	  printf ("Skipping delay\n");
-	  return 1;
-	}
-      {
-	switch (out->flags)
-	  {
-	  case AVI_KEY_FRAME:
-	    f = RF_I;
-	    break;
-	  case AVI_B_FRAME:
-	    f = RF_B;
-	    break;
-	  case 0:
-	    f = RF_P;
-	    break;
-	  default:
-	    ADM_assert (0);
-
-	  }
-	_xrc->logPass2 (out->out_quantizer, f, out->len);
-      }
-
-      return 1;
-
-      break;
-    default:
-      ADM_assert (0);
-      break;
-    }
-  ADM_assert (0);
-  return 0;
-
-}
-EncoderFFMPEGMpeg1::~EncoderFFMPEGMpeg1 ()
-{
-  stop ();
-};
-
-
-
-//--------------------------------
-uint8_t
-EncoderFFMPEGMpeg1::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
-{
-
-  ADM_assert (instream);
-  ADV_Info *info;
-  fd = NULL;
-
-  uint32_t flag1, flag2, flag3;
-  flag1 = flag2 = flag3 = 0;
-
-  info = instream->getInfo ();
-  _fps = info->fps1000;
-  _w = info->width;
-  _h = info->height;
-  //_vbuffer = new uint8_t[_w * _h * 3];
-  _vbuffer = new ADMImage (_w, _h);
-  ADM_assert (_vbuffer);
-  _in = instream;
-  _use_xvid_ratecontrol = _settings.use_xvid_ratecontrol;
-
-  switch (_param.mode)
-    {
-    case COMPRESS_CQ:
-      printf ("ffmpeg mpeg1 cq mode: %ld\n", _param.qz);
-      _state = enc_CQ;
-      setMatrix ();		//_settings.user_matrix,_settings.gop_size);
-      _codec = new ffmpegEncoderCQ (_w, _h, _id);
-      _settings.override_ratecontrol = 0;
-      _codec->setConfig (&_settings);
-      _codec->init (_param.qz, _fps, 0);
-      break;
-    case COMPRESS_CBR:
-      printf ("ffmpeg mpeg1 cbr mode: %ld\n", _param.bitrate);
-      _state = enc_CBR;
-      setMatrix ();
-      _codec = new ffmpegEncoderCBR (_w, _h, _id);
-      _settings.override_ratecontrol = 0;
-      _codec->setConfig (&_settings);
-      flag1 = 1;
-      _codec->init (_param.bitrate * 1000, _fps, flag1);
-
-      break;
-    case COMPRESS_2PASS:
-    case COMPRESS_2PASS_BITRATE:
-      {
-	_settings.override_ratecontrol = 1;
-	ffmpegEncoderCQ *cdec = NULL;
-	if (_use_xvid_ratecontrol)
-	  {
-	    {
-	      char dummy[strlen (_logname) + 10];
-	      strcpy (dummy, _logname);
-	      strcat (dummy, ".fake");
-
-	      cdec->setLogFile (dummy);
-	    }
-	    _xrc = new ADM_newXvidRcVBV (_fps, _logname);
-
-	    _state = enc_Pass1;
-	    printf ("\n ffmpeg dual size: %lu MB, using xvid rc",
-		    _param.finalsize >> 10);
-	    setMatrix ();
-	    cdec = new ffmpegEncoderCQ (_w, _h, _id);	// Pass1
-
-	    cdec->setConfig (&_settings);
-
-	    cdec->init (FIRST_PASS_QUANTIZER, _fps, 1);
-	    _codec = cdec;
-	  }
-	else
-	  {
-	    _state = enc_Pass1;
-	    printf ("\n ffmpeg dual size: %lu", _param.finalsize);
-	    setMatrix ();
-	    cdec = new ffmpegEncoderCQ (_w, _h, _id);	// Pass1
-
-	    cdec->setConfig (&_settings);
-	    cdec->setLogFile (_logname);
-	    cdec->init (FIRST_PASS_QUANTIZER, _fps, 1);
-	    _codec = cdec;
-	  }
-      }
-      break;
-    default:
-      ADM_assert (0);
-      break;
-
-    }
-  _in = instream;
-  printf ("\n ffmpeg Encoder , w: %lu h:%lu mode:%d", _w, _h, _state);
-  return 1;
-
-}
-uint8_t EncoderFFMPEGMpeg1::verifyLog(const char *file,uint32_t nbFrame)
-{
-  
-  if(_use_xvid_ratecontrol)
-  {
-      return ADM_newXvidRcVBV::verifyLog(file,nbFrame);
-  }else
-  {
-    return 0; // For now assume it is corrupted 
-  }
-  
-}
-
-
-uint8_t
-EncoderFFMPEGMpeg1::startPass1 (void)
-{
-  ADM_assert (_state == enc_Pass1);
-  _frametogo = 0;
-  printf ("\n Starting pass 1\n");
-  printf (" Creating logfile :%s\n", _logname);
-  _pass1Done = 1;
-  if (_use_xvid_ratecontrol)
-    {
-      printf ("Using Xvid 2 pass rate control (%s)\n", _logname);
-      _xrc->startPass1 ();
-
-    }
-  return 1;
-}
-
-int EncoderFFMPEGMpeg1::getRequirements (void) { return _codec->capabilities; }
-
-uint8_t
-EncoderFFMPEGMpeg1::isDualPass (void)
-{
-  if ((_state == enc_Pass1) || (_state == enc_Pass2))
-    {
-      return 1;
-    }
-  return 0;
-}
-
-uint8_t
-EncoderFFMPEGMpeg1::setLogFile (const char *lofile, uint32_t nbframe)
-{
-  strcpy (_logname, lofile);
-  _frametogo = nbframe;
-  _totalframe = nbframe;
-  return 1;
-
-}
-
-//_______________________________
-uint8_t
-EncoderFFMPEGMpeg1::stop (void)
-{
-  printf ("Stopping encoder\n");
-  if (_codec)
-    delete _codec;
-  _codec = NULL;
-  if (_use_xvid_ratecontrol)
-    {
-      if (_state == enc_Pass1 || _state == enc_Pass2)
-	{
-	  if (_xrc)
-	    {
-	      delete _xrc;
-	      _xrc = NULL;
-	    }
-
-	}
-    }
-
-  return 1;
-}
-//_______________________________
-extern uint32_t ADM_computeBitrate(uint32_t fps1000, uint32_t nbFrame, uint32_t sizeInMB);
-uint8_t
-EncoderFFMPEGMpeg1::startPass2 (void)
-{
-  uint32_t br,avg_bitrate;
-  double d;
-
-  ADM_assert (_state == enc_Pass1);
-  printf ("\n-------* Starting pass 2*-------------\n");
-
- if(_param.mode==COMPRESS_2PASS)
-  {
-    br=ADM_computeBitrate( _fps,_totalframe,_param.finalsize);
-    printf("[FFmpeg Mpeg1/2] Final Size: %u MB, avg bitrate %u kb/s \n",_param.finalsize,br/1000);
-  }else if(_param.mode==COMPRESS_2PASS_BITRATE)
-  {
-    br=_param.avg_bitrate*1000;
-    printf("[FFmpeg Mpeg1/2] 2pass avg bitrate %u kb/s\n",br/1000);
-  }else ADM_assert(0);
- 
-  printf("[FFmpeg Mpeg1/2] Max bitrate :%u\n", (_settings.maxBitrate));
-  avg_bitrate = br;
-  if(_param.mode==COMPRESS_2PASS)
-      printf ("\n ** Total size     : %lu MBytes \n", _param.finalsize);
-  printf (" ** Total frame    : %lu  \n", _totalframe);
-
-  printf ("\n VBR parameters computed\n");
-  _state = enc_Pass2;
-  // Delete codec and start new one
-  if (_codec)
-    {
-      delete _codec;
-      _codec = NULL;
-    }
-
-  if (!_use_xvid_ratecontrol)
-    {
-      _codec = new ffmpegEncoderVBR (_w, _h, 0, _id);	//0 -> external 1 -> internal
-      _settings.override_ratecontrol = 0;
-      _codec->setConfig (&_settings);
-
-      setMatrix ();
-      _codec->setLogFile (_logname);
-      //_codec->setLogFile("/tmp/dummylog.txt");
-      if (_settings.maxBitrate)
-	if (avg_bitrate > _settings.maxBitrate*1000)
-	  avg_bitrate = _settings.maxBitrate*1000;
-      _codec->init (avg_bitrate, _fps);
-      printf ("\n FF:ready to encode in 2pass (%s)\n", _logname);
-      _frametogo = 0;
-      return 1;
-    }
-  // ******************************************
-  // If we use Xvid...
-  // ******************************************
-    uint32_t f;
-
-   
-     f=_param.finalsize;
-  // Checking against max bitrate
-    uint32_t maxb=_settings.maxBitrate*1000;
-
-    printf("[FFmpeg1/2] : %u kbps average, %u max\n",br/1000,maxb/1000);
-    if(br>maxb)
-    {
-        printf("[FFmpeg1/2] Max bitrate exceeded, clipping\n");
-        br=maxb;
-    }
-      
-      d=_totalframe;
-      d*=1000.;
-      d/=_fps;            // D is a duration in second
-      d*=br;              // * bitrate = total bits
-      d/=8;               // Byte
-      d/=1024*1024;       // MB
-      
-      f=(uint32_t)d;
-   
-  
-  _xrc->setVBVInfo (_settings.maxBitrate, _settings.minBitrate,
-		    _settings.bufferSize);
-  printf("Average bitrate :%u finale size %u\n",br,f);
-  _xrc->startPass2 (f, _totalframe);
-
-
-  _codec = new ffmpegEncoderVBRExternal (_w, _h, _id);	//0 -> external 1 -> internal (_w, _h);
-
-  _settings.override_ratecontrol = 1;
-  _codec->setConfig (&_settings);
-
-  setMatrix ();
-  _codec->setLogFile ("/tmp/dummylog.txt");
-  _codec->init (_param.qz, _fps);
-  printf ("\n XV:ready to encode in 2pass(%s)\n", _logname);
-  _frametogo = 0;
-  return 1;
-
-
-}
-
-//
-//      Allow the user to set a custom matrix
-//     The size parameter is not used
-//
-// *intra_matrix;
-//      uint16_t *inter_matrix;
-uint8_t
-EncoderFFMPEGMpeg1::setMatrix (void)
-{
-  switch (_settings.user_matrix)
-    {
-    case ADM_MATRIX_DEFAULT:
-      break;
-    case ADM_MATRIX_TMP:
-      printf ("\n using custom matrix : Tmpg\n");
-      _settings.intra_matrix = tmpgenc_intra;
-      _settings.inter_matrix = tmpgenc_inter;
-      break;
-    case ADM_MATRIX_ANIME:
-      printf ("\n using custom matrix : anim\n");
-      _settings.intra_matrix = anime_intra;
-      _settings.inter_matrix = anime_inter;
-
-      break;
-    case ADM_MATRIX_KVCD:
-      printf ("\n using custom matrix : kvcd\n");
-      _settings.intra_matrix = kvcd_intra;
-      _settings.inter_matrix = kvcd_inter;
-      break;
-    case ADM_MATRIX_HRTMP:
-      printf ("\n using custom matrix : HR-Tmpgenc\n");
-      _settings.intra_matrix = hrtmpgenc_intra;
-      _settings.inter_matrix = hrtmpgenc_inter;
-      break;
-    }
-  return 1;
-}
-
-#endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp	2009-12-28 21:28:33 UTC (rev 5751)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp	2009-12-28 21:53:58 UTC (rev 5752)
@@ -134,7 +134,7 @@
                 WAVHeader *hdr=audio->getInfo();	
                 audio_encoding=hdr->encoding;
 
-                if (videoCodecGetType() == CodecXVCD || videoCodecGetType() == CodecVCD ||
+                if (videoCodecGetType() == CodecVCD ||
 					(videoCodecGetType() == CodecExternal && strcmp(videoCodecPluginGetGuid(), "85FC9CAC-CE6C-4aa6-9D5F-352D6349BA3E") == 0) || // avcodec MPEG-1 plugin
 					(videoCodecGetType() == CodecExternal && strcmp(videoCodecPluginGetGuid(), "DBAECD8B-CF29-4846-AF57-B596427FE7D3") == 0)) // avcodec MPEG-2 plugin
                 {
@@ -206,15 +206,6 @@
           case CodecDVD:
             encoding->setCodec(QT_TR_NOOP("libmpeg2enc DVD"));
             break;
-          case CodecXVCD:
-            encoding->setCodec(QT_TR_NOOP("FFmpeg MPEG-1 VBR"));
-            break;
-          case CodecXSVCD:
-            encoding->setCodec(QT_TR_NOOP("FFmpeg MPEG-2 SVCD VBR"));
-            break;
-          case CodecXDVD:
-            encoding->setCodec(QT_TR_NOOP("FFmpeg MPEG-2 DVD VBR"));
-            break;
           case CodecRequant:
             encoding->setCodec(QT_TR_NOOP("MPEG Requantizer"));
             break;



From gruntster at mail.berlios.de  Mon Dec 28 23:14:16 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 28 Dec 2009 23:14:16 +0100
Subject: [Avidemux-svn-commit] r5753 - in
	branches/avidemux_2.5_branch_gruntster/avidemux:
	ADM_UIs/ADM_GTK/src ADM_UIs/ADM_QT4/src ADM_codecs
Message-ID: <200912282214.nBSMEG76010546@sheep.berlios.de>

Author: gruntster
Date: 2009-12-28 23:14:09 +0100 (Mon, 28 Dec 2009)
New Revision: 5753

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/T_bitrate.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
Log:
[moeg] remove more remnants

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp	2009-12-28 21:53:58 UTC (rev 5752)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/FAC_bitrate.cpp	2009-12-28 22:14:09 UTC (rev 5753)
@@ -1,341 +1,341 @@
-/***************************************************************************
-  FAC_bitrate.cpp
-  Handle dialog factory element : Bitrate (encoding mode)
-  (C) 2006 Mean Fixounet at free.fr 
-***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include "ADM_toolkitGtk.h"
-#include "DIA_factory.h"
-namespace ADM_GtkFactory
-{
+/***************************************************************************
+  FAC_bitrate.cpp
+  Handle dialog factory element : Bitrate (encoding mode)
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "ADM_toolkitGtk.h"
+#include "DIA_factory.h"
+namespace ADM_GtkFactory
+{
 struct diaElemBitrateData
-{
-	GtkWidget *label1, *label2, *combo, *spin;
-	COMPRES_PARAMS *param;
-	unsigned int maxQ, minQ;
-};
-
-class diaElemBitrate : public diaElemBitrateBase
-{
-protected:
-public:
-  
-  diaElemBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip=NULL);
-  virtual ~diaElemBitrate() ;
-  void setMe(void *dialog, void *opaque,uint32_t line);
-  void getMe(void);
-  void setMaxQz(uint32_t qz);
-  void setMinQz(uint32_t qz);
-  void updateMe(void);
-  int getRequiredLayout(void);
-};
-
-static void cb_mod(GtkWidget *widget, gpointer *data);
-/**
- * 	\fn 	readPullDown
- * \brief 	Convert the raw read of the combox into the actual compression mode
- */
-static COMPRESSION_MODE readPulldown(COMPRES_PARAMS *copy,int rank)
-{
-	int index=0;
-	COMPRESSION_MODE mode=COMPRESS_MAX;
-	
-#undef LOOKUP
-#define LOOKUP(A,B) \
-  if(copy->capabilities & ADM_ENC_CAP_##A) \
-  { \
-	  if(rank==index) mode=COMPRESS_##B; \
-	  index++; \
-  } 
-  
-  LOOKUP(CBR,CBR);
-  LOOKUP(CQ,CQ);
-  LOOKUP(SAME,SAME);
-  LOOKUP(AQ,AQ);
-  LOOKUP(2PASS,2PASS);
-  LOOKUP(2PASS_BR,2PASS_BITRATE);
-  
-	ADM_assert(mode!=COMPRESS_MAX);
-	return mode;
-}
-
-static void updatePulldown(COMPRES_PARAMS *copy, GtkComboBox *combo)
-{
-	int index = 0, set = -1;
-
-#undef LOOKUP
-#define LOOKUP(A,B) \
-	if(copy->capabilities & ADM_ENC_CAP_##A) \
-	{ \
-		if (copy->mode == COMPRESS_##B) set = index; \
-			index++; \
-	} \
-
-	LOOKUP(CBR, CBR);
-	LOOKUP(CQ, CQ);
-	LOOKUP(SAME, SAME);
-	LOOKUP(AQ, AQ);
-	LOOKUP(2PASS, 2PASS);
-	LOOKUP(2PASS_BR, 2PASS_BITRATE);
-
-	if (set != -1)
-		gtk_combo_box_set_active(combo, set);
-}
-
- diaElemBitrate::diaElemBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip)
-  : diaElemBitrateBase()
-{
-  param=(void *)p;
-  memcpy(&copy,p,sizeof(copy));
-  paramTitle=toggleTitle;
-  this->tip=tip;
-  setSize(2);
-  minQ=2;
-  maxQ=31;
-}
-
-void diaElemBitrate::setMinQz(uint32_t qz)
-{
-  minQ=qz;
-}
-
-void diaElemBitrate::setMaxQz(uint32_t qz)
-{
-  maxQ=qz; 
-}
-diaElemBitrate::~diaElemBitrate()
-{
-	diaElemBitrateData *data = (diaElemBitrateData*)myWidget;
-
-	delete data;
-	myWidget = NULL;
-}
-/**
- * \fn setMe
- * @param dialog  Pointer to father dialog
- * @param opaque  Internal, Gtk table to attach to
- * @param line Line were the widget should be displayed
- */
-void diaElemBitrate::setMe(void *dialog, void *opaque,uint32_t line)
-{
-  GtkObject *adj;
-  GtkWidget *label1;
-  GtkWidget *label2;
-  GtkWidget *combo;
-  GtkWidget *spin;
-  
-#define PUT_ARRAY(x,y,widget)  gtk_table_attach (GTK_TABLE (opaque), widget, x, x+1, line+y, line+y+1, \
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL), \
-                    (GtkAttachOptions) (0), 0, 0);
-  
-  /* Add text -> encoding mode */
-  label1 = gtk_label_new_with_mnemonic (QT_TR_NOOP("_Encoding mode:"));
-  gtk_misc_set_alignment (GTK_MISC (label1), 0.0, 0.5);
-  gtk_widget_show(label1);
-  
-  /* put entry in hbox */
- 
-  PUT_ARRAY(0,0,label1);
-  
-  
-  /* Add text -> encoding mode */
-  label2 = gtk_label_new_with_mnemonic (QT_TR_NOOP("_Bitrate (kb/s):"));
-  gtk_misc_set_alignment (GTK_MISC (label2), 0.0, 0.5);
-  gtk_widget_show(label2);
-  /* put entry in hbox */
-  PUT_ARRAY(0,1,label2);
- 
-  /* Add encoding menu combo */
-  
-  
-  combo = gtk_combo_box_new_text ();
-  gtk_widget_show (combo);
-  
-  gtk_label_set_mnemonic_widget (GTK_LABEL(label1), combo);
-  if((copy.capabilities & ADM_ENC_CAP_CBR)) 
-	  gtk_combo_box_append_text (GTK_COMBO_BOX (combo),QT_TR_NOOP("Single pass - bitrate"));
-  if((copy.capabilities & ADM_ENC_CAP_CQ))
-	  gtk_combo_box_append_text (GTK_COMBO_BOX (combo),QT_TR_NOOP("Single pass - constant quality"));
-  if((copy.capabilities & ADM_ENC_CAP_SAME))
-	  gtk_combo_box_append_text (GTK_COMBO_BOX (combo),QT_TR_NOOP("Single pass - same qz as input"));
-  if((copy.capabilities & ADM_ENC_CAP_AQ))
-	  gtk_combo_box_append_text (GTK_COMBO_BOX (combo),QT_TR_NOOP("Single pass - Average quantizer"));
-
-  if((copy.capabilities & ADM_ENC_CAP_2PASS))
-	  gtk_combo_box_append_text (GTK_COMBO_BOX (combo),QT_TR_NOOP("Two pass - video size"));
-  if((copy.capabilities & ADM_ENC_CAP_2PASS_BR))
-	  gtk_combo_box_append_text (GTK_COMBO_BOX (combo),QT_TR_NOOP("Two pass - average bitrate"));
-  
-  /**/
-  
-   
-  
-  PUT_ARRAY(1,0,combo);
-  
-  
-  /* Now add value */
-  spin = gtk_spin_button_new_with_range(0,1,1);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON(spin),TRUE);
-  gtk_spin_button_set_digits  (GTK_SPIN_BUTTON(spin),0);
-  
-  gtk_widget_show (spin);
-  
-    PUT_ARRAY(1,1,spin);
-  /*  add button */
-   gtk_label_set_mnemonic_widget (GTK_LABEL(label1), combo);
-   gtk_label_set_mnemonic_widget (GTK_LABEL(label2), spin);
-
-   diaElemBitrateData *data = new diaElemBitrateData;
-
-   data->param = &copy;
-   data->label1 = label1;
-   data->label2 = label2;
-   data->combo = combo;
-   data->spin = spin;
-   data->maxQ = maxQ;
-   data->minQ = minQ;
-
-   myWidget = (void*)data;
-
-   gtk_signal_connect(GTK_OBJECT(data->combo), "changed",
-	   G_CALLBACK(cb_mod), (void *)data);
-
-   updatePulldown(&copy, GTK_COMBO_BOX(combo));
-}
-
-void diaElemBitrate::getMe(void)
-{
-  // Read current value
-  diaElemBitrateData *data = (diaElemBitrateData*)myWidget;
-  int rank = gtk_combo_box_get_active(GTK_COMBO_BOX(data->combo));
-  data->param->mode = readPulldown(data->param,rank);
-
-#undef P
-#undef M
-#undef S
-#define P(x) 
-#define M(x,y)
-#define S(x)   x=(uint32_t)gtk_spin_button_get_value  (GTK_SPIN_BUTTON(data->spin))
-  switch(data->param->mode)
-  {
-    case COMPRESS_CBR: //CBR
-          P(_Bitrate (kb/s):);
-          M(0,20000);
-          S(data->param->bitrate);
-          break;
-    case COMPRESS_AQ:// CQ
-          P(_Quantizer:);
-          M(2,31);
-          S(data->param->qz);
-          break;
-    case COMPRESS_CQ:// CQ
-          P(_Quantizer:);
-          M(2,31);
-          S(data->param->qz);
-          break;
-    case  COMPRESS_2PASS: // 2pass Filesize
-          P(_Video size (MB):);
-          M(1,8000);
-          S(data->param->finalsize);
-          break;
-    case COMPRESS_2PASS_BITRATE : // 2pass Avg
-          P(_Average bitrate (kb/s):);
-          M(0,20000);
-          S(data->param->avg_bitrate);
-          break;
-    case COMPRESS_SAME : // Same Qz as input
-          P(-);
-          M(0,0);
-          break;
-    default:
-		ADM_assert(0);
-  }
-
-  memcpy(param, data->param, sizeof(COMPRES_PARAMS));
-}
-
-int diaElemBitrate::getRequiredLayout(void) { return 0; }
-
-void updateCombo(diaElemBitrateData *data)
-{
-#undef M
-#undef S
-#define M(x,y) gtk_spin_button_set_range  (GTK_SPIN_BUTTON(data->spin),x,y)
-#define S(x)   gtk_spin_button_set_value  (GTK_SPIN_BUTTON(data->spin),x)
-
-  updatePulldown(data->param, GTK_COMBO_BOX(data->combo));
-
-  switch (data->param->mode)
-  {
-    case COMPRESS_CBR:
-          gtk_label_set_text_with_mnemonic(GTK_LABEL(data->label2),QT_TR_NOOP("_Bitrate (kb/s):"));
-          M(0,20000);
-          S(data->param->bitrate);
-          break; 
-    case COMPRESS_CQ:
-          gtk_label_set_text_with_mnemonic(GTK_LABEL(data->label2),QT_TR_NOOP("_Quantizer:"));
-          M(data->minQ,data->maxQ);
-          S(data->param->qz);
-          break;
-    case COMPRESS_AQ:
-          gtk_label_set_text_with_mnemonic(GTK_LABEL(data->label2),QT_TR_NOOP("A_vg Quantizer:"));
-          M(2,64);
-          S(data->param->qz);
-          break;
-    case COMPRESS_2PASS:
-          gtk_label_set_text_with_mnemonic(GTK_LABEL(data->label2),QT_TR_NOOP("_Video size (MB):"));
-          M(1,8000);
-          S(data->param->finalsize);
-          break;
-    case COMPRESS_2PASS_BITRATE:
-          gtk_label_set_text_with_mnemonic(GTK_LABEL(data->label2),QT_TR_NOOP("_Average bitrate (kb/s):"));
-          M(0,20000);
-          S(data->param->avg_bitrate);
-          break;
-    case COMPRESS_SAME : // Same Qz as input
-          gtk_label_set_text_with_mnemonic(GTK_LABEL(data->label2),QT_TR_NOOP("-"));
-          M(0,0);
-          break;
-    default:
-		ADM_assert(0);
-  }
-}
-
-void diaElemBitrate::updateMe(void)
-{
-	diaElemBitrateData *data = (diaElemBitrateData*)myWidget;
-
-	memcpy(data->param, param, sizeof(COMPRES_PARAMS));
-	updateCombo(data);
-}
-
-void cb_mod(GtkWidget *widget, gpointer *d)
-{
-	diaElemBitrateData *data = (diaElemBitrateData*)d;
-
-	data->param->mode = readPulldown(data->param, gtk_combo_box_get_active(GTK_COMBO_BOX(data->combo)));
-	updateCombo(data);
-}
-
-} // End of namespace
-//****************************Hoook*****************
-
-diaElem  *gtkCreateBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip)
-{
-	return new  ADM_GtkFactory::diaElemBitrate(p,toggleTitle,tip);
-}
-void gtkDestroyBitrate(diaElem *e)
-{
-	ADM_GtkFactory::diaElemBitrate *a=(ADM_GtkFactory::diaElemBitrate *)e;
-	delete a;
-}
-//EOF
+{
+	GtkWidget *label1, *label2, *combo, *spin;
+	COMPRES_PARAMS *param;
+	unsigned int maxQ, minQ;
+};
+
+class diaElemBitrate : public diaElemBitrateBase
+{
+protected:
+public:
+  
+  diaElemBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip=NULL);
+  virtual ~diaElemBitrate() ;
+  void setMe(void *dialog, void *opaque,uint32_t line);
+  void getMe(void);
+  void setMaxQz(uint32_t qz);
+  void setMinQz(uint32_t qz);
+  void updateMe(void);
+  int getRequiredLayout(void);
+};
+
+static void cb_mod(GtkWidget *widget, gpointer *data);
+/**
+ * 	\fn 	readPullDown
+ * \brief 	Convert the raw read of the combox into the actual compression mode
+ */
+static COMPRESSION_MODE readPulldown(COMPRES_PARAMS *copy,int rank)
+{
+	int index=0;
+	COMPRESSION_MODE mode=COMPRESS_MAX;
+	
+#undef LOOKUP
+#define LOOKUP(A,B) \
+  if(copy->capabilities & ADM_ENC_CAP_##A) \
+  { \
+	  if(rank==index) mode=COMPRESS_##B; \
+	  index++; \
+  } 
+  
+  LOOKUP(CBR,CBR);
+  LOOKUP(CQ,CQ);
+  LOOKUP(SAME,SAME);
+  LOOKUP(AQ,AQ);
+  LOOKUP(2PASS,2PASS);
+  LOOKUP(2PASS_BR,2PASS_BITRATE);
+  
+	ADM_assert(mode!=COMPRESS_MAX);
+	return mode;
+}
+
+static void updatePulldown(COMPRES_PARAMS *copy, GtkComboBox *combo)
+{
+	int index = 0, set = -1;
+
+#undef LOOKUP
+#define LOOKUP(A,B) \
+	if(copy->capabilities & ADM_ENC_CAP_##A) \
+	{ \
+		if (copy->mode == COMPRESS_##B) set = index; \
+			index++; \
+	} \
+
+	LOOKUP(CBR, CBR);
+	LOOKUP(CQ, CQ);
+	LOOKUP(SAME, SAME);
+	LOOKUP(AQ, AQ);
+	LOOKUP(2PASS, 2PASS);
+	LOOKUP(2PASS_BR, 2PASS_BITRATE);
+
+	if (set != -1)
+		gtk_combo_box_set_active(combo, set);
+}
+
+ diaElemBitrate::diaElemBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip)
+  : diaElemBitrateBase()
+{
+  param=(void *)p;
+  memcpy(&copy,p,sizeof(copy));
+  paramTitle=toggleTitle;
+  this->tip=tip;
+  setSize(2);
+  minQ=2;
+  maxQ=31;
+}
+
+void diaElemBitrate::setMinQz(uint32_t qz)
+{
+  minQ=qz;
+}
+
+void diaElemBitrate::setMaxQz(uint32_t qz)
+{
+  maxQ=qz; 
+}
+diaElemBitrate::~diaElemBitrate()
+{
+	diaElemBitrateData *data = (diaElemBitrateData*)myWidget;
+
+	delete data;
+	myWidget = NULL;
+}
+/**
+ * \fn setMe
+ * @param dialog  Pointer to father dialog
+ * @param opaque  Internal, Gtk table to attach to
+ * @param line Line were the widget should be displayed
+ */
+void diaElemBitrate::setMe(void *dialog, void *opaque,uint32_t line)
+{
+  GtkObject *adj;
+  GtkWidget *label1;
+  GtkWidget *label2;
+  GtkWidget *combo;
+  GtkWidget *spin;
+  
+#define PUT_ARRAY(x,y,widget)  gtk_table_attach (GTK_TABLE (opaque), widget, x, x+1, line+y, line+y+1, \
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL), \
+                    (GtkAttachOptions) (0), 0, 0);
+  
+  /* Add text -> encoding mode */
+  label1 = gtk_label_new_with_mnemonic (QT_TR_NOOP("_Encoding mode:"));
+  gtk_misc_set_alignment (GTK_MISC (label1), 0.0, 0.5);
+  gtk_widget_show(label1);
+  
+  /* put entry in hbox */
+ 
+  PUT_ARRAY(0,0,label1);
+  
+  
+  /* Add text -> encoding mode */
+  label2 = gtk_label_new_with_mnemonic (QT_TR_NOOP("_Bitrate (kb/s):"));
+  gtk_misc_set_alignment (GTK_MISC (label2), 0.0, 0.5);
+  gtk_widget_show(label2);
+  /* put entry in hbox */
+  PUT_ARRAY(0,1,label2);
+ 
+  /* Add encoding menu combo */
+  
+  
+  combo = gtk_combo_box_new_text ();
+  gtk_widget_show (combo);
+  
+  gtk_label_set_mnemonic_widget (GTK_LABEL(label1), combo);
+  if((copy.capabilities & ADM_ENC_CAP_CBR)) 
+	  gtk_combo_box_append_text (GTK_COMBO_BOX (combo),QT_TR_NOOP("Single pass - bitrate"));
+  if((copy.capabilities & ADM_ENC_CAP_CQ))
+	  gtk_combo_box_append_text (GTK_COMBO_BOX (combo),QT_TR_NOOP("Single pass - constant quality"));
+  if((copy.capabilities & ADM_ENC_CAP_SAME))
+	  gtk_combo_box_append_text (GTK_COMBO_BOX (combo),QT_TR_NOOP("Single pass - same qz as input"));
+  if((copy.capabilities & ADM_ENC_CAP_AQ))
+	  gtk_combo_box_append_text (GTK_COMBO_BOX (combo),QT_TR_NOOP("Single pass - Average quantiser"));
+
+  if((copy.capabilities & ADM_ENC_CAP_2PASS))
+	  gtk_combo_box_append_text (GTK_COMBO_BOX (combo),QT_TR_NOOP("Two pass - video size"));
+  if((copy.capabilities & ADM_ENC_CAP_2PASS_BR))
+	  gtk_combo_box_append_text (GTK_COMBO_BOX (combo),QT_TR_NOOP("Two pass - average bitrate"));
+  
+  /**/
+  
+   
+  
+  PUT_ARRAY(1,0,combo);
+  
+  
+  /* Now add value */
+  spin = gtk_spin_button_new_with_range(0,1,1);
+  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON(spin),TRUE);
+  gtk_spin_button_set_digits  (GTK_SPIN_BUTTON(spin),0);
+  
+  gtk_widget_show (spin);
+  
+    PUT_ARRAY(1,1,spin);
+  /*  add button */
+   gtk_label_set_mnemonic_widget (GTK_LABEL(label1), combo);
+   gtk_label_set_mnemonic_widget (GTK_LABEL(label2), spin);
+
+   diaElemBitrateData *data = new diaElemBitrateData;
+
+   data->param = &copy;
+   data->label1 = label1;
+   data->label2 = label2;
+   data->combo = combo;
+   data->spin = spin;
+   data->maxQ = maxQ;
+   data->minQ = minQ;
+
+   myWidget = (void*)data;
+
+   gtk_signal_connect(GTK_OBJECT(data->combo), "changed",
+	   G_CALLBACK(cb_mod), (void *)data);
+
+   updatePulldown(&copy, GTK_COMBO_BOX(combo));
+}
+
+void diaElemBitrate::getMe(void)
+{
+  // Read current value
+  diaElemBitrateData *data = (diaElemBitrateData*)myWidget;
+  int rank = gtk_combo_box_get_active(GTK_COMBO_BOX(data->combo));
+  data->param->mode = readPulldown(data->param,rank);
+
+#undef P
+#undef M
+#undef S
+#define P(x) 
+#define M(x,y)
+#define S(x)   x=(uint32_t)gtk_spin_button_get_value  (GTK_SPIN_BUTTON(data->spin))
+  switch(data->param->mode)
+  {
+    case COMPRESS_CBR: //CBR
+          P(_Bitrate (kb/s):);
+          M(0,20000);
+          S(data->param->bitrate);
+          break;
+    case COMPRESS_AQ:// CQ
+          P(_Quantizer:);
+          M(2,31);
+          S(data->param->qz);
+          break;
+    case COMPRESS_CQ:// CQ
+          P(_Quantizer:);
+          M(2,31);
+          S(data->param->qz);
+          break;
+    case  COMPRESS_2PASS: // 2pass Filesize
+          P(_Video size (MB):);
+          M(1,8000);
+          S(data->param->finalsize);
+          break;
+    case COMPRESS_2PASS_BITRATE : // 2pass Avg
+          P(_Average bitrate (kb/s):);
+          M(0,20000);
+          S(data->param->avg_bitrate);
+          break;
+    case COMPRESS_SAME : // Same Qz as input
+          P(-);
+          M(0,0);
+          break;
+    default:
+		ADM_assert(0);
+  }
+
+  memcpy(param, data->param, sizeof(COMPRES_PARAMS));
+}
+
+int diaElemBitrate::getRequiredLayout(void) { return 0; }
+
+void updateCombo(diaElemBitrateData *data)
+{
+#undef M
+#undef S
+#define M(x,y) gtk_spin_button_set_range  (GTK_SPIN_BUTTON(data->spin),x,y)
+#define S(x)   gtk_spin_button_set_value  (GTK_SPIN_BUTTON(data->spin),x)
+
+  updatePulldown(data->param, GTK_COMBO_BOX(data->combo));
+
+  switch (data->param->mode)
+  {
+    case COMPRESS_CBR:
+          gtk_label_set_text_with_mnemonic(GTK_LABEL(data->label2),QT_TR_NOOP("_Bitrate (kb/s):"));
+          M(0,20000);
+          S(data->param->bitrate);
+          break; 
+    case COMPRESS_CQ:
+          gtk_label_set_text_with_mnemonic(GTK_LABEL(data->label2),QT_TR_NOOP("_Quantiser:"));
+          M(data->minQ,data->maxQ);
+          S(data->param->qz);
+          break;
+    case COMPRESS_AQ:
+          gtk_label_set_text_with_mnemonic(GTK_LABEL(data->label2),QT_TR_NOOP("A_vg Quantiser:"));
+          M(2,64);
+          S(data->param->qz);
+          break;
+    case COMPRESS_2PASS:
+          gtk_label_set_text_with_mnemonic(GTK_LABEL(data->label2),QT_TR_NOOP("_Video size (MB):"));
+          M(1,8000);
+          S(data->param->finalsize);
+          break;
+    case COMPRESS_2PASS_BITRATE:
+          gtk_label_set_text_with_mnemonic(GTK_LABEL(data->label2),QT_TR_NOOP("_Average bitrate (kb/s):"));
+          M(0,20000);
+          S(data->param->avg_bitrate);
+          break;
+    case COMPRESS_SAME : // Same Qz as input
+          gtk_label_set_text_with_mnemonic(GTK_LABEL(data->label2),QT_TR_NOOP("-"));
+          M(0,0);
+          break;
+    default:
+		ADM_assert(0);
+  }
+}
+
+void diaElemBitrate::updateMe(void)
+{
+	diaElemBitrateData *data = (diaElemBitrateData*)myWidget;
+
+	memcpy(data->param, param, sizeof(COMPRES_PARAMS));
+	updateCombo(data);
+}
+
+void cb_mod(GtkWidget *widget, gpointer *d)
+{
+	diaElemBitrateData *data = (diaElemBitrateData*)d;
+
+	data->param->mode = readPulldown(data->param, gtk_combo_box_get_active(GTK_COMBO_BOX(data->combo)));
+	updateCombo(data);
+}
+
+} // End of namespace
+//****************************Hoook*****************
+
+diaElem  *gtkCreateBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip)
+{
+	return new  ADM_GtkFactory::diaElemBitrate(p,toggleTitle,tip);
+}
+void gtkDestroyBitrate(diaElem *e)
+{
+	ADM_GtkFactory::diaElemBitrate *a=(ADM_GtkFactory::diaElemBitrate *)e;
+	delete a;
+}
+//EOF

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/T_bitrate.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/T_bitrate.cpp	2009-12-28 21:53:58 UTC (rev 5752)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/T_bitrate.cpp	2009-12-28 22:14:09 UTC (rev 5753)
@@ -165,7 +165,7 @@
 			S(compress->bitrate);
 			break; 
 		case COMPRESS_CQ:// CQ
-			P(QT_TR_NOOP("Quantizer"));
+			P(QT_TR_NOOP("Quantiser"));
 			M(_minQ,maxQ);
 			S(compress->qz);
 			break;
@@ -184,7 +184,7 @@
 			M(0,0);
 			break;
 		case COMPRESS_AQ : // AQ
-			P(QT_TR_NOOP("Quantizer"));
+			P(QT_TR_NOOP("Quantiser"));
 			M(_minQ,maxQ);
 			S(compress->qz);
 			break;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-28 21:53:58 UTC (rev 5752)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-28 22:14:09 UTC (rev 5753)
@@ -384,9 +384,6 @@
   {
   1000, fps1000};
 
-  if(_id==FF_MPEG2 || _id==FF_MPEG1)
-	  _context->bit_rate = _br;
-  else
 	  _context->bit_rate = _br*1000;
 
   printf ("[LAVCODEC] Using  bitrate in context :%lu kbps",_context->bit_rate/1000);



From gruntster at mail.berlios.de  Tue Dec 29 11:48:52 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 29 Dec 2009 11:48:52 +0100
Subject: [Avidemux-svn-commit] r5754 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src
Message-ID: <200912291048.nBTAmq3G006128@sheep.berlios.de>

Author: gruntster
Date: 2009-12-29 11:48:48 +0100 (Tue, 29 Dec 2009)
New Revision: 5754

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp
Log:
[dlgFactory] initialise variable to prevent crash with GTK config menu

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp	2009-12-28 22:14:09 UTC (rev 5753)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_GTK/src/FAC_configMenu.cpp	2009-12-29 10:48:48 UTC (rev 5754)
@@ -53,7 +53,7 @@
 	{
 #define MAX_CONFIG 100
 
-		uint32_t fileCount;
+		uint32_t fileCount = 0;
 		char *files[MAX_CONFIG];
 		map<string, int> *configs = new map<string, int>();
 		bool origDisableSignals = menuData->disableSignals;
@@ -68,6 +68,7 @@
 			ADM_dealloc(files[i]);
 		}
 
+		fileCount = 0;
 		buildDirectoryContent(&fileCount, menuData->systemConfigDir, files, MAX_CONFIG, "xml");
 
 		for (int i = 0; i < fileCount; i++)



From gruntster at mail.berlios.de  Tue Dec 29 11:50:07 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 29 Dec 2009 11:50:07 +0100
Subject: [Avidemux-svn-commit] r5755 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_encoder
	ADM_userInterfaces/ADM_commonUI
Message-ID: <200912291050.nBTAo7jW006247@sheep.berlios.de>

Author: gruntster
Date: 2009-12-29 11:50:01 +0100 (Tue, 29 Dec 2009)
New Revision: 5755

Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_DVDff.cpp
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt
Log:
[moeg] remove more remnants

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h	2009-12-29 10:48:48 UTC (rev 5754)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h	2009-12-29 10:50:01 UTC (rev 5755)
@@ -1,7 +1,6 @@
 #ifndef ADM_CODEC_CONFIG_
 #define ADM_CODEC_CONFIG_
 
-uint8_t DIA_DVDffParam (COMPRES_PARAMS * incoming);
 uint8_t DIA_flv1Param(COMPRES_PARAMS *incoming);
 #define REQUANT_AS_CODE
 #include "ADM_vidEncode.hxx"

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt	2009-12-29 10:48:48 UTC (rev 5754)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt	2009-12-29 10:50:01 UTC (rev 5755)
@@ -1,7 +1,6 @@
 SET(ADM_LIB ADM_commonUI)
 
 SET(${ADM_LIB}_SRCS
-DIA_DVDff.cpp           
 DIA_mjpeg.cpp     
 DIA_resizeWiz.cpp  
 DIA_v2v.cpp

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_DVDff.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_DVDff.cpp	2009-12-29 10:48:48 UTC (rev 5754)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_DVDff.cpp	2009-12-29 10:50:01 UTC (rev 5755)
@@ -1,96 +0,0 @@
-/*
-    Dialog for lavcodec based Mpeg1/mpeg2 codec
-
-
-*/
-
-#include "config.h"
-#include "ADM_default.h"
-
-#include "ADM_lavcodec.h"
-
-
-#include "ADM_codecs/ADM_codec.h"
-#include "ADM_encoder/ADM_vidEncode.hxx"
-#include "ADM_codecs/ADM_ffmpegConfig.h"
-#include "DIA_factory.h"
-
-#warning FIXME Old : MaxBitrate in Byte/s, new entry in kb/s
-#warning FIXME Old : MaxBitrate in Byte/s, new entry in kb/s
-#warning FIXME Old : MaxBitrate in Byte/s, new entry in kb/s
-#warning FIXME Old : MaxBitrate in Byte/s new entry in kb/s
-#warning FIXME Old : MaxBitrate in Byte/s new entry in kb/s
-#warning FIXME Old : MaxBitrate in Byte/s new entry in kb/s
-
-#include "../../ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2enc.h"
-
-/**
-      \fn DIA_DVDffParam
-      \brief Dialog to set encoding options for SVCD/DVD lavcodec based
-*/
-//____________________________________________
-
-uint8_t DIA_DVDffParam(COMPRES_PARAMS *incoming)
-{
-	
-
-	int ret;
-	FFcodecSetting *conf=(FFcodecSetting *)incoming->extraSettings;
-	ADM_assert(incoming->extraSettingsLen==sizeof(FFcodecSetting));
-
-diaMenuEntry wideM[]={
-  {0,QT_TR_NOOP("4:3")},
-  {1,QT_TR_NOOP("16:9")}};
-diaMenuEntry matrixM[]={
-  {0,QT_TR_NOOP("Default")},
-  {1,QT_TR_NOOP("TMPGEnc")},
-  {2,QT_TR_NOOP("Anime")},
-  {3,QT_TR_NOOP("KVCD")}
-};
-diaMenuEntry interM[]={
-  {0,QT_TR_NOOP("Progressive")},
-  {1,QT_TR_NOOP("Interlaced TFF")},
-  {2,QT_TR_NOOP("Interlaced BFF")}
-};
-diaMenuEntry vbvM[3]=
-{
-	{40,QT_TR_NOOP("VCD 40 kB")},
-	{112,QT_TR_NOOP("SVCD 112 kB")},
-	{224,QT_TR_NOOP("DVD 224 kB")}
-};
-
-                      
-         diaElemBitrate bitrate(incoming,NULL);
-         diaElemUInteger maxb(&(conf->maxBitrate),QT_TR_NOOP("Ma_x. bitrate:"),100,9000);
-         diaElemUInteger minb(&(conf->minBitrate),QT_TR_NOOP("Mi_n. bitrate:"),0,9000);
-         diaElemToggle    xvid(&(conf->use_xvid_ratecontrol),QT_TR_NOOP("_Use Xvid rate control"));
-         
-         diaElemMenu      vbv(&(conf->bufferSize),QT_TR_NOOP("_Buffer size:"),3,vbvM);
-         
-         diaElemMenu      widescreen(&(conf->widescreen),QT_TR_NOOP("Aspect _ratio:"),2,wideM);
-         diaElemMenu      matrix(&(conf->user_matrix),QT_TR_NOOP("_Matrices:"),4,matrixM);
-         diaElemUInteger  gop(&(conf->gop_size),QT_TR_NOOP("_GOP size:"),1,30);
-         
-uint32_t inter;
-          if(!conf->interlaced) inter=0;
-            else if(conf->bff) inter=2;
-                else inter=1;
-         diaElemMenu      interW(&inter,QT_TR_NOOP("_Interlacing:"),3,interM);
-  
-      diaElem *elems[9]={&bitrate,&maxb,&minb,&xvid,&vbv,&widescreen,&interW,&matrix,&gop};
-    
-  if( diaFactoryRun(QT_TR_NOOP("libavcodec MPEG-2 Configuration"),9,elems))
-  {
-    switch(inter)
-    {
-      case 0: conf->interlaced=0;conf->bff=0;break;
-      case 1: conf->interlaced=1;conf->bff=0;break;
-      case 2: conf->interlaced=1;conf->bff=1;break;
-      default: ADM_assert(0);
-    }
-    return 1;
-  }
-  return 0;
-}	
-// EOF
-



From gruntster at mail.berlios.de  Tue Dec 29 13:13:10 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 29 Dec 2009 13:13:10 +0100
Subject: [Avidemux-svn-commit] r5756 - in
	branches/avidemux_2.5_branch_gruntster: platforms/windows/installer
	plugins/ADM_videoEncoder/ADM_vidEnc_avcodec
Message-ID: <200912291213.nBTCDAk9017945@sheep.berlios.de>

Author: gruntster
Date: 2009-12-29 13:12:45 +0100 (Tue, 29 Dec 2009)
New Revision: 5756

Added:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Flv1Param.xsd
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.h
Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.h
Log:
[flv1] avcodec FLV1 video plugin

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2009-12-29 12:12:45 UTC (rev 5756)
@@ -483,6 +483,7 @@
 			SetOutPath $INSTDIR\plugins\videoEncoder
 			${File} plugins\videoEncoder\libADM_vidEnc_avcodec.dll
 			SetOutPath $INSTDIR\plugins\videoEncoder\avcodec
+			${File} plugins\videoEncoder\avcodec\Flv1Param.xsd
 			${File} plugins\videoEncoder\avcodec\Mpeg1Param.xsd
 			${File} plugins\videoEncoder\avcodec\Mpeg2Param.xsd
 			SetOutPath $INSTDIR\plugins\videoEncoder\avcodec\mpeg-1

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-29 12:12:45 UTC (rev 5756)
@@ -10,16 +10,19 @@
 
 SET(ADM_vidEnc_avcodec_SRCS  interface.c  encoder.cpp  huffyuvEncoder.cpp
 							 ffvhuffEncoder.cpp  ffv1Encoder.cpp  dvEncoder.cpp  ../common/PluginOptions.cpp
-							 mpeg1Encoder.cpp  mpeg1EncoderOptions.cpp  mpeg2Encoder.cpp  mpeg2EncoderOptions.cpp)
+							 mpeg1Encoder.cpp  mpeg1EncoderOptions.cpp  mpeg2Encoder.cpp  mpeg2EncoderOptions.cpp
+							 flv1Encoder.cpp  flv1EncoderOptions.cpp)
 
 set(PLUGIN_SCHEMA_DIR "avcodec")
 set(MPEG1_PLUGIN_CONFIG_DIR "avcodec/mpeg-1")
 set(MPEG2_PLUGIN_CONFIG_DIR "avcodec/mpeg-2")
+set(FLV1_PLUGIN_CONFIG_DIR "avcodec/flv1")
 
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${LIBXML2_INCLUDE_DIR})
 ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_SCHEMA_DIR="${PLUGIN_SCHEMA_DIR}")
-set_property(SOURCE mpeg1EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DPLUGIN_CONFIG_DIR=\\\"${MPEG1_PLUGIN_CONFIG_DIR}\\\")
-set_property(SOURCE mpeg2EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DPLUGIN_CONFIG_DIR=\\\"${MPEG2_PLUGIN_CONFIG_DIR}\\\")
+set_property(SOURCE mpeg1EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMPEG1_PLUGIN_CONFIG_DIR=\\\"${MPEG1_PLUGIN_CONFIG_DIR}\\\")
+set_property(SOURCE mpeg2EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMPEG2_PLUGIN_CONFIG_DIR=\\\"${MPEG2_PLUGIN_CONFIG_DIR}\\\")
+set_property(SOURCE flv1EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DFLV1_PLUGIN_CONFIG_DIR=\\\"${FLV1_PLUGIN_CONFIG_DIR}\\\")
 
 getFfmpegLibNames(${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_libraries/ffmpeg)
 
@@ -36,3 +39,4 @@
 INSTALL_VIDEO_ENCODER(ADM_vidEnc_avcodec)
 INSTALL(FILES Mpeg1Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
 INSTALL(FILES Mpeg2Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
+INSTALL(FILES Flv1Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Flv1Param.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Flv1Param.xsd	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Flv1Param.xsd	2009-12-29 12:12:45 UTC (rev 5756)
@@ -0,0 +1,58 @@
+<?xml version="1.0" encoding="utf-8"?>
+<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified">
+  <xs:element name="Flv1Config">
+    <xs:complexType>
+      <xs:sequence>
+        <xs:element name="presetConfiguration" minOccurs="0">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="name" type="xs:string"/>
+              <xs:element name="type">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="default"/>
+                    <xs:enumeration value="user"/>
+                    <xs:enumeration value="system"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+        <xs:element name="encodeOptions" minOccurs="0">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="mode">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="CBR"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="parameter" type="uint"/>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+        <xs:element name="Flv1Options">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="gopSize" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="1"/>
+                    <xs:maxInclusive value="250"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+      </xs:sequence>
+    </xs:complexType>
+  </xs:element>
+  <xs:simpleType name="uint">
+    <xs:restriction base="xs:integer">
+      <xs:minInclusive value="0"/>
+    </xs:restriction>
+  </xs:simpleType>
+</xs:schema>

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2009-12-29 12:12:45 UTC (rev 5756)
@@ -17,6 +17,7 @@
 
 #include "encoder.h"
 #include "dvEncoder.h"
+#include "flv1Encoder.h"
 #include "ffv1Encoder.h"
 #include "ffvhuffEncoder.h"
 #include "huffyuvEncoder.h"
@@ -27,14 +28,15 @@
 int uiType;
 
 static DVEncoder dv;
+static FLV1Encoder flv1;
 static FFV1Encoder ffv1;
 static FFVHuffEncoder ffvhuff;
 static HuffyuvEncoder huffyuv;
-static Mpeg1Encoder mpeg1Encoder;
-static Mpeg2Encoder mpeg2Encoder;
+static Mpeg1Encoder mpeg1;
+static Mpeg2Encoder mpeg2;
 
-static int encoderIds[] = { 0, 1, 2, 3, 4, 5 };
-static AvcodecEncoder* encoders[] = { &dv, &ffv1, &ffvhuff, &huffyuv, &mpeg1Encoder, &mpeg2Encoder};
+static int encoderIds[] = { 0, 1, 2, 3, 4, 5, 6 };
+static AvcodecEncoder* encoders[] = { &dv, &flv1, &ffv1, &ffvhuff, &huffyuv, &mpeg1, &mpeg2};
 
 extern "C"
 {

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.cpp	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.cpp	2009-12-29 12:12:45 UTC (rev 5756)
@@ -0,0 +1,241 @@
+/***************************************************************************
+                               flv1Encoder.cpp
+
+    begin                : Tue Dec 29 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include <libxml/tree.h>
+#include "ADM_inttype.h"
+#include "flv1Encoder.h"
+
+extern int _uiType;
+static bool changedConfig(const char* fileName, ConfigMenuType configType);
+static char *serializeConfig(void);
+static FLV1Encoder *encoder = NULL;
+
+#ifdef __WIN32
+extern void convertPathToAnsi(const char *path, char **ansiPath);
+#endif
+
+FLV1Encoder::FLV1Encoder(void)
+{
+	encoder = this;
+
+	init(CODEC_ID_FLV1, ADM_CSP_YV12);
+
+	_encodeOptions.structSize = sizeof(vidEncOptions);
+	_encodeOptions.encodeMode = FLV1_DEFAULT_ENCODE_MODE;
+	_encodeOptions.encodeModeParameter = FLV1_DEFAULT_ENCODE_MODE_PARAMETER;
+}
+
+int FLV1Encoder::initContext(const char* logFileName)
+{
+	AvcodecEncoder::initContext(logFileName);
+
+	_context->gop_size = _options.getGopSize();
+	_context->bit_rate = _encodeOptions.encodeModeParameter * 1000;
+	_context->bit_rate_tolerance = 8000000;
+	_context->luma_elim_threshold = -2;
+	_context->chroma_elim_threshold = -5;
+	_context->lumi_masking = 0.05;
+	_context->mb_decision = FF_MB_DECISION_RD;
+	_context->rc_qsquish = 1.0;
+	_context->i_quant_factor = 0.8;
+	_context->dark_masking = 0.01;
+
+	return ADM_VIDENC_ERR_SUCCESS;
+}
+
+const char* FLV1Encoder::getEncoderType(void)
+{
+	return "FLV1";
+}
+
+const char* FLV1Encoder::getEncoderDescription(void)
+{
+	return "FLV1 video encoder plugin for Avidemux (c) Mean/Gruntster";
+}
+
+const char* FLV1Encoder::getFourCC(void)
+{
+	return "FLV1";
+}
+
+const char* FLV1Encoder::getEncoderGuid(void)
+{
+	return "134AA23B-A1FE-4d7b-AC99-85E440BA4595";
+}
+
+int FLV1Encoder::isConfigurable(void)
+{
+	return (_uiType == ADM_UI_GTK || _uiType == ADM_UI_QT4);
+}
+
+int FLV1Encoder::configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties)
+{
+	loadSettings(&_encodeOptions, &_options);
+
+	diaElemUInteger ctlBitrate(&_bitrate, "_Bitrate (kb/s):", 100, 9000);
+	diaElemUInteger ctlGop(&_gopSize, "_GOP size:", 1, 250);
+	diaElem *elmGeneral[2] = {&ctlBitrate, &ctlGop};
+
+	diaElemConfigMenu ctlConfigMenu(configName, &configType, _options.getUserConfigDirectory(), _options.getSystemConfigDirectory(),
+		changedConfig, serializeConfig, elmGeneral, 2);
+	diaElem *elmHeader[1] = {&ctlConfigMenu};
+
+	diaElemTabs tabGeneral("Settings", 2, elmGeneral);
+	diaElemTabs *tabs[] = {&tabGeneral};
+
+	if (diaFactoryRunTabs("avcodec FLV1 Configuration", 1, elmHeader, 1, tabs))
+	{
+		saveSettings(&_encodeOptions, &_options);
+		updateEncodeProperties(&_encodeOptions);
+
+		return 1;
+	}
+
+	return 0;
+}
+
+void FLV1Encoder::loadSettings(vidEncOptions *encodeOptions, FLV1EncoderOptions *options)
+{
+	char *configurationName;
+
+	options->getPresetConfiguration(&configurationName, (PluginConfigType*)&configType);
+
+	if (configurationName)
+	{
+		strcpy(this->configName, configurationName);
+		delete [] configurationName;
+	}
+
+	if (encodeOptions)
+	{
+		_gopSize = options->getGopSize();
+
+		updateEncodeProperties(encodeOptions);
+	}
+}
+
+void FLV1Encoder::saveSettings(vidEncOptions *encodeOptions, FLV1EncoderOptions *options)
+{
+	options->setPresetConfiguration(&configName[0], (PluginConfigType)configType);
+
+	encodeOptions->encodeMode = ADM_VIDENC_MODE_CBR;
+	encodeOptions->encodeModeParameter = _bitrate;
+
+	options->setGopSize(_gopSize);
+}
+
+bool changedConfig(const char* configName, ConfigMenuType configType)
+{
+	bool failure = false;
+
+	if (configType == CONFIG_MENU_DEFAULT)
+	{
+		FLV1EncoderOptions defaultOptions;
+		vidEncOptions *defaultEncodeOptions = defaultOptions.getEncodeOptions();
+
+		encoder->loadSettings(defaultEncodeOptions, &defaultOptions);
+
+		delete defaultEncodeOptions;
+	}
+	else
+	{
+		FLV1EncoderOptions options;
+
+		options.setPresetConfiguration(configName, (PluginConfigType)configType);
+
+		if (configType == CONFIG_MENU_CUSTOM)
+			encoder->loadSettings(NULL, &options);
+		else
+		{
+			vidEncOptions *encodeOptions;
+
+			if (options.loadPresetConfiguration())
+			{
+				encodeOptions = options.getEncodeOptions();
+
+				encoder->loadSettings(encodeOptions, &options);
+
+				delete encodeOptions;
+			}
+			else
+			{
+				failure = true;
+			}
+		}
+	}
+
+	return configType == CONFIG_MENU_CUSTOM | !failure;
+}
+
+char *serializeConfig(void)
+{
+	vidEncOptions encodeOptions;
+	FLV1EncoderOptions options;
+
+	encoder->saveSettings(&encodeOptions, &options);
+	options.setEncodeOptions(&encodeOptions);
+
+	return options.toXml(PLUGIN_XML_EXTERNAL);
+}
+
+int FLV1Encoder::getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize)
+{
+	char* xml = _options.toXml(PLUGIN_XML_INTERNAL);
+	int xmlLength = strlen(xml);
+
+	if (bufferSize >= xmlLength)
+	{
+		memcpy(pluginOptions, xml, xmlLength);
+		memcpy(encodeOptions, &_encodeOptions, sizeof(vidEncOptions));
+	}
+	else if (bufferSize != 0)
+		xmlLength = 0;
+
+	delete [] xml;
+
+	return xmlLength;
+}
+
+int FLV1Encoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+{
+	if (_opened)
+		return ADM_VIDENC_ERR_ALREADY_OPEN;
+
+	bool success = true;
+
+	if (pluginOptions)
+	{
+		success = _options.fromXml(pluginOptions, PLUGIN_XML_INTERNAL);
+
+		_options.loadPresetConfiguration();
+	}
+
+	if (encodeOptions && success)
+	{
+		memcpy(&_encodeOptions, encodeOptions, sizeof(vidEncOptions));
+		updateEncodeProperties(encodeOptions);
+	}
+
+	if (success)
+		return ADM_VIDENC_ERR_SUCCESS;
+	else
+		return ADM_VIDENC_ERR_FAILED;
+}
+
+void FLV1Encoder::updateEncodeProperties(vidEncOptions *encodeOptions)
+{
+	_passCount = 1;
+	_bitrate = encodeOptions->encodeModeParameter;
+}

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.h	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.h	2009-12-29 12:12:45 UTC (rev 5756)
@@ -0,0 +1,58 @@
+/***************************************************************************
+                               flv1Encoder.h
+
+    begin                : Tue Dec 29 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef FLV1Encoder_h
+#define FLV1Encoder_h
+
+#ifdef __cplusplus
+extern "C"
+{
+	#include "ADM_vidEnc_plugin.h"
+}
+
+#include "encoder.h"
+#include "flv1EncoderOptions.h"
+#include "DIA_factory.h"
+
+class FLV1Encoder : public AvcodecEncoder
+{
+	private:
+		unsigned int _bitrate, _gopSize;
+
+		char configName[PATH_MAX];
+		ConfigMenuType configType;
+
+		FLV1EncoderOptions _options;
+		vidEncOptions _encodeOptions;
+
+		void updateEncodeProperties(vidEncOptions *encodeOptions);
+
+	public:
+		FLV1Encoder(void);
+		int initContext(const char* logFileName);
+		const char* getEncoderType(void);
+		const char* getEncoderDescription(void);
+		const char* getFourCC(void);
+		const char* getEncoderGuid(void);
+		int isConfigurable(void);
+		int configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
+		void loadSettings(vidEncOptions *encodeOptions, FLV1EncoderOptions *options);
+		void saveSettings(vidEncOptions *encodeOptions, FLV1EncoderOptions *options);
+		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
+		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+};
+#endif	// __cplusplus
+#endif	// FLV1Encoder_h

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.cpp	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.cpp	2009-12-29 12:12:45 UTC (rev 5756)
@@ -0,0 +1,79 @@
+ /***************************************************************************
+                               flv1EncoderOptions.cpp
+
+	These settings are intended for scripting and can contain a Preset 
+	Configuration block.  If this block exists then "internal" settings are
+	ignored and an external configuration file should be read instead, 
+	e.g. PlayStation Portable profile.  However, if the external file is 
+	missing, internal settings have to be used and will reflect a snapshot
+	of the external configuration file at the time the script was generated.
+
+    begin                : Tue Dec 29 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <libxml/parser.h>
+#include <libxml/xmlschemas.h>
+#include <sstream>
+#include <string>
+#include "ADM_default.h"
+
+#include "flv1EncoderOptions.h"
+
+FLV1EncoderOptions::FLV1EncoderOptions(void) : PluginOptions(FLV1_PLUGIN_CONFIG_DIR, "Flv1", "Flv1Param.xsd", FLV1_DEFAULT_ENCODE_MODE, FLV1_DEFAULT_ENCODE_MODE_PARAMETER)
+{
+	reset();
+}
+
+void FLV1EncoderOptions::reset(void)
+{
+	PluginOptions::reset();
+
+	setGopSize(100);
+}
+
+unsigned int FLV1EncoderOptions::getGopSize(void)
+{
+	return _gopSize;
+}
+
+void FLV1EncoderOptions::setGopSize(unsigned int gopSize)
+{
+	if (gopSize >= 1 && gopSize <= 250)
+		_gopSize = gopSize;
+}
+
+void FLV1EncoderOptions::addOptionsToXml(xmlNodePtr xmlNodeRoot)
+{
+	const int bufferSize = 100;
+	xmlChar xmlBuffer[bufferSize + 1];
+	xmlNodePtr xmlNodeChild, xmlNodeChild2;
+
+	xmlNodeRoot = xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)getOptionsTagRoot(), NULL);
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"gopSize", number2String(xmlBuffer, bufferSize, getGopSize()));
+}
+
+void FLV1EncoderOptions::parseOptions(xmlNode *node)
+{
+	for (xmlNode *xmlChild = node->children; xmlChild; xmlChild = xmlChild->next)
+	{
+		if (xmlChild->type == XML_ELEMENT_NODE)
+		{
+			char *content = (char*)xmlNodeGetContent(xmlChild);
+
+			if (strcmp((char*)xmlChild->name, "gopSize") == 0)
+				setGopSize(atoi(content));
+
+			xmlFree(content);
+		}
+	}
+}

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.h	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.h	2009-12-29 12:12:45 UTC (rev 5756)
@@ -0,0 +1,47 @@
+/***************************************************************************
+                            flv1EncoderOptions.h
+
+    begin                : Tue Dec 29 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef FLV1EncoderOptions_h
+#define FLV1EncoderOptions_h
+
+#include <vector>
+#include "../common/PluginOptions.h"
+
+extern "C"
+{
+#include "ADM_vidEnc_plugin.h"
+}
+
+#define FLV1_DEFAULT_ENCODE_MODE ADM_VIDENC_MODE_CBR
+#define FLV1_DEFAULT_ENCODE_MODE_PARAMETER 1500
+
+class FLV1EncoderOptions : public PluginOptions
+{
+protected:
+	unsigned int _bitrate, _gopSize;
+
+	void addOptionsToXml(xmlNodePtr xmlNodeRoot);
+	void parseOptions(xmlNode *node);
+
+public:
+	FLV1EncoderOptions(void);
+	void reset(void);
+
+	unsigned int getGopSize(void);
+	void setGopSize(unsigned int gopSize);
+};
+
+#endif	// FLV1EncoderOptions_h

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-29 12:12:45 UTC (rev 5756)
@@ -71,7 +71,7 @@
 void vidEncGetEncoderVersion(int encoderId, int* major, int* minor, int* patch)
 {
 	*major = 1;
-	*minor = 1;
+	*minor = 2;
 	*patch = 0;
 }
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp	2009-12-29 12:12:45 UTC (rev 5756)
@@ -34,11 +34,11 @@
 	init(CODEC_ID_MPEG1VIDEO, ADM_CSP_YV12);
 
 	_encodeOptions.structSize = sizeof(vidEncOptions);
-	_encodeOptions.encodeMode = DEFAULT_ENCODE_MODE;
-	_encodeOptions.encodeModeParameter = DEFAULT_ENCODE_MODE_PARAMETER;
+	_encodeOptions.encodeMode = MPEG1_DEFAULT_ENCODE_MODE;
+	_encodeOptions.encodeModeParameter = MPEG1_DEFAULT_ENCODE_MODE_PARAMETER;
 
 	_bitrateParam.capabilities = ADM_ENC_CAP_CQ | ADM_ENC_CAP_2PASS | ADM_ENC_CAP_2PASS_BR;
-	_bitrateParam.qz = DEFAULT_ENCODE_MODE_PARAMETER;
+	_bitrateParam.qz = MPEG1_DEFAULT_ENCODE_MODE_PARAMETER;
 	_bitrateParam.avg_bitrate = 1000;
 	_bitrateParam.finalsize = 700;
 
@@ -252,7 +252,7 @@
 		changedConfig, serializeConfig, elmGeneral, 9);
 	diaElem *elmHeader[1] = {&ctlConfigMenu};
 
-	diaElemTabs tabGeneral("User Interface", 9, elmGeneral);
+	diaElemTabs tabGeneral("Settings", 9, elmGeneral);
 	diaElemTabs *tabs[] = {&tabGeneral};
 
 	if (diaFactoryRunTabs("avcodec MPEG-1 Configuration", 1, elmHeader, 1, tabs))

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp	2009-12-29 12:12:45 UTC (rev 5756)
@@ -31,7 +31,7 @@
 
 #include "mpeg1EncoderOptions.h"
 
-Mpeg1EncoderOptions::Mpeg1EncoderOptions(void) : PluginOptions(PLUGIN_CONFIG_DIR, "Mpeg1", "Mpeg1Param.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
+Mpeg1EncoderOptions::Mpeg1EncoderOptions(void) : PluginOptions(MPEG1_PLUGIN_CONFIG_DIR, "Mpeg1", "Mpeg1Param.xsd", MPEG1_DEFAULT_ENCODE_MODE, MPEG1_DEFAULT_ENCODE_MODE_PARAMETER)
 {
 	reset();
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.h	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.h	2009-12-29 12:12:45 UTC (rev 5756)
@@ -25,8 +25,8 @@
 #include "ADM_vidEnc_plugin.h"
 }
 
-#define DEFAULT_ENCODE_MODE ADM_VIDENC_MODE_CQP
-#define DEFAULT_ENCODE_MODE_PARAMETER 4
+#define MPEG1_DEFAULT_ENCODE_MODE ADM_VIDENC_MODE_CQP
+#define MPEG1_DEFAULT_ENCODE_MODE_PARAMETER 4
 
 typedef enum
 {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp	2009-12-29 12:12:45 UTC (rev 5756)
@@ -34,11 +34,11 @@
 	init(CODEC_ID_MPEG2VIDEO, ADM_CSP_YV12);
 
 	_encodeOptions.structSize = sizeof(vidEncOptions);
-	_encodeOptions.encodeMode = DEFAULT_ENCODE_MODE;
-	_encodeOptions.encodeModeParameter = DEFAULT_ENCODE_MODE_PARAMETER;
+	_encodeOptions.encodeMode = MPEG2_DEFAULT_ENCODE_MODE;
+	_encodeOptions.encodeModeParameter = MPEG2_DEFAULT_ENCODE_MODE_PARAMETER;
 
 	_bitrateParam.capabilities = ADM_ENC_CAP_CBR | ADM_ENC_CAP_CQ | ADM_ENC_CAP_2PASS | ADM_ENC_CAP_2PASS_BR;
-	_bitrateParam.qz = DEFAULT_ENCODE_MODE_PARAMETER;
+	_bitrateParam.qz = MPEG2_DEFAULT_ENCODE_MODE_PARAMETER;
 	_bitrateParam.avg_bitrate = 1000;
 	_bitrateParam.finalsize = 700;
 	_bitrateParam.bitrate = 1500;
@@ -97,8 +97,8 @@
 	int fps = (_fpsDen * 1000) / _fpsNum;
 	int fpsTarget = 23976;
 
-	if ((fps > fpsTarget - 300) && (fps < fpsTarget + 300))
-		_context->flags2 |= CODEC_FLAG2_32_PULLDOWN;
+	if ((fps > fpsTarget - 300) && (fps < fpsTarget + 300))
+		_context->flags2 |= CODEC_FLAG2_32_PULLDOWN;
 
 	_context->i_quant_factor = 0.8;
 	_context->rc_initial_cplx = 3;
@@ -271,7 +271,7 @@
 		changedConfig, serializeConfig, elmGeneral, 9);
 	diaElem *elmHeader[1] = {&ctlConfigMenu};
 
-	diaElemTabs tabGeneral("User Interface", 9, elmGeneral);
+	diaElemTabs tabGeneral("Settings", 9, elmGeneral);
 	diaElemTabs *tabs[] = {&tabGeneral};
 
 	if (diaFactoryRunTabs("avcodec MPEG-2 Configuration", 1, elmHeader, 1, tabs))

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.cpp	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.cpp	2009-12-29 12:12:45 UTC (rev 5756)
@@ -31,7 +31,7 @@
 
 #include "mpeg2EncoderOptions.h"
 
-Mpeg2EncoderOptions::Mpeg2EncoderOptions(void) : PluginOptions(PLUGIN_CONFIG_DIR, "Mpeg2", "Mpeg2Param.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
+Mpeg2EncoderOptions::Mpeg2EncoderOptions(void) : PluginOptions(MPEG2_PLUGIN_CONFIG_DIR, "Mpeg2", "Mpeg2Param.xsd", MPEG2_DEFAULT_ENCODE_MODE, MPEG2_DEFAULT_ENCODE_MODE_PARAMETER)
 {
 	reset();
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.h	2009-12-29 10:50:01 UTC (rev 5755)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.h	2009-12-29 12:12:45 UTC (rev 5756)
@@ -25,8 +25,8 @@
 #include "ADM_vidEnc_plugin.h"
 }
 
-#define DEFAULT_ENCODE_MODE ADM_VIDENC_MODE_CQP
-#define DEFAULT_ENCODE_MODE_PARAMETER 4
+#define MPEG2_DEFAULT_ENCODE_MODE ADM_VIDENC_MODE_CQP
+#define MPEG2_DEFAULT_ENCODE_MODE_PARAMETER 4
 
 typedef enum
 {



From gruntster at mail.berlios.de  Tue Dec 29 13:23:28 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 29 Dec 2009 13:23:28 +0100
Subject: [Avidemux-svn-commit] r5757 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_codecs
	ADM_encoder ADM_userInterfaces/ADM_commonUI
Message-ID: <200912291223.nBTCNS92000526@sheep.berlios.de>

Author: gruntster
Date: 2009-12-29 13:22:49 +0100 (Tue, 29 Dec 2009)
New Revision: 5757

Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flv1.cpp
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt
Log:
[flv1] remove old flv1 logic

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-29 12:12:45 UTC (rev 5756)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-29 12:22:49 UTC (rev 5757)
@@ -217,9 +217,6 @@
     case FF_H263P:
       WRAP_Open (CODEC_ID_H263P);
       break;
-    case FF_FLV1:
-      WRAP_Open (CODEC_ID_FLV1);
-      break;
     case FF_MJPEG:
       WRAP_Open (CODEC_ID_MJPEG);
       break;
@@ -535,14 +532,8 @@
     }
   else
     {
-      if (_id == FF_FLV1)
-	{
-	  _context->gop_size = _settings.gop_size;
-	}
-      else
-	{
 	  _context->gop_size = 250;
-	}
+
 #define SETX(x) _context->x=_settings.x; printf("[LAVCODEC]"#x" : %d\n",_settings.x);
 #define SETX_COND(x) if(_settings.is_##x) {_context->x=_settings.x; printf("[LAVCODEC]"#x" : %d\n",_settings.x);} else\
 		{ printf(#x" is not activated\n");}

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h	2009-12-29 12:12:45 UTC (rev 5756)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h	2009-12-29 12:22:49 UTC (rev 5757)
@@ -29,7 +29,6 @@
   FF_H263 = 4,
   FF_H263P = 5,
   FF_MJPEG = 8,
-  FF_FLV1=13,
 } FF_CODEC_ID;
 
 /*

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h	2009-12-29 12:12:45 UTC (rev 5756)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h	2009-12-29 12:22:49 UTC (rev 5757)
@@ -1,7 +1,6 @@
 #ifndef ADM_CODEC_CONFIG_
 #define ADM_CODEC_CONFIG_
 
-uint8_t DIA_flv1Param(COMPRES_PARAMS *incoming);
 #define REQUANT_AS_CODE
 #include "ADM_vidEncode.hxx"
 // Yv12
@@ -65,45 +64,6 @@
   0,				// NAQ
   0				// DUMMY 
 };
-FFcodecSetting ffmpeg4Extra_FLV1 = {
-  ME_EPZS,			//     ME
-  0,				//          GMC     
-  0,				// 4MV
-  0,				//           _QPEL;   
-  0,				//           _TREILLIS_QUANT
-  2,				//           qmin;
-  31,				//          qmax;
-  3,				//           max_qdiff;
-  0,				//           max_b_frames;
-  0,				//          mpeg_quant;
-  1,				//
-  -2,				//                 luma_elim_threshold;
-  1,				//
-  -5,				// chroma_elim_threshold;
-  0.05,				//lumi_masking;
-  1,				// is lumi
-  0.01,				//dark_masking; 
-  1,				// is dark
-  0.5,				// qcompress amount of qscale change between easy & hard scenes (0.0-1.0
-  0.5,				// qblur;    amount of qscale smoothing over time (0.0-1.0) 
-  0,				// min bitrate in kB/S
-  0,				// max bitrate
-  0,				// default matrix
-  100,				// no gop size
-  NULL,
-  NULL,
-  0,				// interlaced
-  0,				// WLA: bottom-field-first
-  0,				// wide screen
-  2,				// mb eval = distortion
-  8000,				// vratetol 8Meg
-  0,				// is temporal
-  0.0,				// temporal masking
-  0,				// is spatial
-  0.0,				// spatial masking
-  0,				// NAQ
-  0				// DUMMY 
-};
 
 COMPRES_PARAMS ffmpegH263Codec = {
   CodecH263,
@@ -154,23 +114,6 @@
   getFFCompressParams
 };
 
-COMPRES_PARAMS ffmpegFLV1 = {
-  CodecFLV1,
-  QT_TR_NOOP("FLV1 (lavc)"),
-  "FLV1",
-  "FLV1",
-  COMPRESS_CBR,
-  4,
-  1500,
-  700,
-  1000, // AVG
-  ADM_ENC_CAP_CBR,
-  ADM_EXTRA_PARAM,
-  &ffmpeg4Extra_FLV1,
-  sizeof (ffmpeg4Extra),
-  &DIA_flv1Param
-};
-
 static MJPEGConfig MjpegExtra = { 90, 0 };
 extern uint8_t DIA_mjpegCodecSetting (COMPRES_PARAMS * param);
 COMPRES_PARAMS MjpegCodec = {
@@ -311,7 +254,6 @@
   &yv12codec,
   &ffmpegH263Codec,
   &MjpegCodec,
-  &ffmpegFLV1,
   &DUMMYONE
 };
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx	2009-12-29 12:12:45 UTC (rev 5756)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx	2009-12-29 12:22:49 UTC (rev 5757)
@@ -29,7 +29,6 @@
   CodecDVD,
   CodecYV12,
   CodecRequant,
-  CodecFLV1,
   CodecExternal,
   CodecDummy
 }SelectCodecType;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2009-12-29 12:12:45 UTC (rev 5756)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2009-12-29 12:22:49 UTC (rev 5757)
@@ -601,9 +601,6 @@
 	case CodecMjpeg:
 		e = new EncoderMjpeg (desc);
 		break;
-	case CodecFLV1:
-		e = new EncoderFFMPEGFLV1 (desc);
-		break;
 	case CodecH263:
 		if (!((w == 128) && (h == 96)) && !((w == 176) && (h == 144)))
 		{

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp	2009-12-29 12:12:45 UTC (rev 5756)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp	2009-12-29 12:22:49 UTC (rev 5757)
@@ -46,54 +46,6 @@
   _id = id;
 };
 
-//********************* FLV1 **********************************************
-EncoderFFMPEGFLV1::EncoderFFMPEGFLV1 (COMPRES_PARAMS * config):
-EncoderFFMPEG (FF_FLV1, config)
-{
-  _id = FF_FLV1;
-  _frametogo = 0;
-
-
-}
-
-int EncoderFFMPEGFLV1::getRequirements (void) { return _codec->capabilities; }
-
-uint8_t
-EncoderFFMPEGFLV1::hasExtraHeaderData (uint32_t * l, uint8_t ** data)
-{
-  *l = 0;
-  *data = NULL;
-  return 0;
-
-}
-uint8_t
-EncoderFFMPEGFLV1::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
-{
-  ADM_assert (instream);
-  ADV_Info *info;
-
-
-
-  info = instream->getInfo ();
-  _fps = info->fps1000;
-  _w = info->width;
-  _h = info->height;
-  
-  _vbuffer = new ADMImage (_w, _h);
-  ADM_assert (_vbuffer);
-  _in = instream;
-
- 
-  _codec = new ffmpegEncoderCBR (_w, _h, _id);
-  _codec->setConfig (&_settings);
-  _codec->init (_param.bitrate, _fps, 0);
-  _state=enc_CQ;
-  return 1;
-
-
-
-}
-
 // return codec name as seen in avi header
 //
 const char *
@@ -108,10 +60,6 @@
     case FF_H263:
       return "H263";
       break;
-    case FF_FLV1:
-      return "FLV1";
-      break;
-
     default:
       ADM_assert (0);
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h	2009-12-29 12:12:45 UTC (rev 5756)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h	2009-12-29 12:22:49 UTC (rev 5757)
@@ -55,48 +55,4 @@
 
 
 };
-
-class EncoderFFMPEGFLV1:public EncoderFFMPEG
-{
-
-protected:
-
-
-public:
-	EncoderFFMPEGFLV1 (COMPRES_PARAMS * config);
-  ~EncoderFFMPEGFLV1 ()
-  {
-    stop ();
-  };				// can be called twice if needed ..
-  virtual int getRequirements (void);
-  virtual uint8_t isDualPass (void)
-  {
-    return 0;
-  };
-  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
-  virtual uint8_t setLogFile (const char *p, uint32_t fr)
-  {
-    UNUSED_ARG (p);
-    UNUSED_ARG (fr);
-    return 1;
-  };
-  virtual uint8_t startPass2 (void)
-  {
-    return 1;
-  };
-  virtual uint8_t startPass1 (void)
-  {
-    return 1;
-  };
-  virtual const char *getDisplayName (void)
-  {
-    return "FFMPEG FLV1";
-  }
-  virtual const char *getFCCHandler (void)
-  {
-    return "FLV1";
-  }
-  virtual uint8_t hasExtraHeaderData (uint32_t * l, uint8_t ** data);
-
-};
 #endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt	2009-12-29 12:12:45 UTC (rev 5756)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt	2009-12-29 12:22:49 UTC (rev 5757)
@@ -17,7 +17,6 @@
 DIA_ocr.cpp             
 DIA_tsSub.cpp        
 DIA_jobs_save.cpp
-DIA_flv1.cpp            
 DIA_plugins.cpp
 )
 

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flv1.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flv1.cpp	2009-12-29 12:12:45 UTC (rev 5756)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flv1.cpp	2009-12-29 12:22:49 UTC (rev 5757)
@@ -1,48 +0,0 @@
-/*
-    Simplified dialog for FLV1 codec
-    Only bitrate and gop size
-
-
-*/
-#include "config.h"
-
-#include "ADM_lavcodec.h"
-
-#include "ADM_default.h"
-
-#include "ADM_codecs/ADM_codec.h"
-#include "ADM_encoder/ADM_vidEncode.hxx"
-#include "ADM_codecs/ADM_ffmpegConfig.h"
-#include "DIA_factory.h"
- 
-
-#include "../../ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2enc.h"
-
-/**
-      \fn DIA_DVDffParam
-      \brief Dialog to set encoding options for SVCD/DVD lavcodec based
-*/
-//____________________________________________
-
-uint8_t DIA_flv1Param(COMPRES_PARAMS *incoming)
-{
-	
-
-	int ret;
-	FFcodecSetting *conf=(FFcodecSetting *)incoming->extraSettings;
-	ADM_assert(incoming->extraSettingsLen==sizeof(FFcodecSetting));
-
-                      
-         diaElemUInteger  bitrate(&(incoming->bitrate),QT_TR_NOOP("_Bitrate (kb/s):"),100,9000);
-         diaElemUInteger  gop(&(conf->gop_size),QT_TR_NOOP("_GOP size:"),1,250);
-
-         diaElem *elems[2]={&bitrate,&gop};
-    
-  if( diaFactoryRun(QT_TR_NOOP("FLV1 Configuration"),2,elems))
-  {
-    return 1;
-  }
-  return 0;
-}	
-// EOF
-



From mean at mail.berlios.de  Tue Dec 29 19:51:26 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 19:51:26 +0100
Subject: [Avidemux-svn-commit] r5758 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad
Message-ID: <200912291851.nBTIpQSS016465@sheep.berlios.de>

Author: mean
Date: 2009-12-29 19:51:26 +0100 (Tue, 29 Dec 2009)
New Revision: 5758

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp
Log:
[FAAD] Remap channel according to sample from http://forums.sagetv.com/forums/showthread.php?t=28974

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp	2009-12-29 12:22:49 UTC (rev 5757)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp	2009-12-29 18:51:26 UTC (rev 5758)
@@ -45,7 +45,8 @@
 
 static  ad_supportedFormat Formats[]={
         {WAV_AAC,AD_MEDIUM_QUAL},
-        {WAV_MP4,AD_MEDIUM_QUAL}
+        {WAV_MP4,AD_MEDIUM_QUAL},
+        {0x706D,AD_MEDIUM_QUAL},
 };
 DECLARE_AUDIO_DECODER(ADM_faad,						// Class
 			0,0,1, 												// Major, minor,patch
@@ -105,12 +106,17 @@
                     channelMapping[1] = ADM_CH_FRONT_RIGHT;
                     break;
             default:
-                channelMapping[0] = ADM_CH_FRONT_CENTER;
-                channelMapping[1] = ADM_CH_FRONT_LEFT;
-                channelMapping[2] = ADM_CH_FRONT_RIGHT;
-                channelMapping[3] = ADM_CH_REAR_LEFT;
-                channelMapping[4] = ADM_CH_REAR_RIGHT;
-                channelMapping[5] = ADM_CH_LFE;
+            {
+                CHANNEL_TYPE *p=channelMapping;
+                *p++ = ADM_CH_REAR_RIGHT;
+                *p++ = ADM_CH_FRONT_LEFT;
+                *p++ = ADM_CH_FRONT_CENTER;
+
+                *p++ = ADM_CH_FRONT_RIGHT;
+                *p++ = ADM_CH_REAR_LEFT;
+                
+                *p++ = ADM_CH_REAR_LEFT;
+              }
                 break;
         }
 



From mean at mail.berlios.de  Tue Dec 29 19:51:28 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 19:51:28 +0100
Subject: [Avidemux-svn-commit] r5759 -
	branches/avidemux_2.6_branch_mean/cmake
Message-ID: <200912291851.nBTIpStA016477@sheep.berlios.de>

Author: mean
Date: 2009-12-29 19:51:27 +0100 (Tue, 29 Dec 2009)
New Revision: 5759

Modified:
   branches/avidemux_2.6_branch_mean/cmake/admCheckAudioEncoderLibs.cmake
Log:
[bootstrap] Add a --debug switch, create codeblocks project

Modified: branches/avidemux_2.6_branch_mean/cmake/admCheckAudioEncoderLibs.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admCheckAudioEncoderLibs.cmake	2009-12-29 18:51:26 UTC (rev 5758)
+++ branches/avidemux_2.6_branch_mean/cmake/admCheckAudioEncoderLibs.cmake	2009-12-29 18:51:27 UTC (rev 5759)
@@ -12,25 +12,36 @@
 
 	IF (AFTEN_FOUND)
 		SET(USE_AFTEN 1)
-		
+	        SET(TMP_LIBS "${AFTEN_LIBRARY_DIR}")	
 		IF (NOT DEFINED AFTEN_TEST_RUN_RESULT)
 			TRY_RUN(AFTEN_TEST_RUN_RESULT
 				AFTEN_TEST_COMPILE_RESULT
 				${CMAKE_BINARY_DIR}
 				"${AVIDEMUX_TOP_SOURCE_DIR}/cmake_compile_check/aften_check.cpp"
-				CMAKE_FLAGS "-DINCLUDE_DIRECTORIES=${AFTEN_INCLUDE_DIR}" "-DLINK_LIBRARIES=${AFTEN_LIBRARY_DIR}")
+				CMAKE_FLAGS -DINCLUDE_DIRECTORIES:PATH=${AFTEN_INCLUDE_DIR}   -DLINK_LIBRARIES:STRING=${TMP_LIBS}
+                                OUTPUT_VARIABLE AFTEN_OUTPUT)
 		ENDIF (NOT DEFINED AFTEN_TEST_RUN_RESULT)
+                #MESSAGE(STATUS " Compile ${AFTEN_TEST_COMPILE_RESULT}, TMP_LIBS=${TMP_LIBS},OUTPUT=${AFTEN_OUTPUT}")
+                IF( AFTEN_TEST_COMPILE_RESULT )
+		        IF (AFTEN_TEST_RUN_RESULT EQUAL 8)
+			        MESSAGE(STATUS "  version: 0.0.8")
+			        SET(USE_AFTEN_08 1)
+		        ELSEIF (AFTEN_TEST_RUN_RESULT EQUAL 7)
+			        MESSAGE(STATUS "  version: 0.07")
+			        SET(USE_AFTEN_07 1)
+                        ELSEIF(AFTEN_TEST_RUN_RESULT EQUAL 99)
+                                MESSAGE(STATUS "  version: SVN")
+                                MESSAGE(WARNING "  This is a svn version of Aften. We will assume it is compatible with 0.0.8, build may fail")
+                                SET(USE_AFTEN_08 1)
+                        ELSE(AFTEN_TEST_RUN_RESULT EQUAL 8)
+                                MESSAGE(STATUS "Warning: Unable to determine Aften version - support for Aften will be turned off (result=${AFTEN_TEST_RUN_RESULT})")
+                                SET(USE_AFTEN 0)
+		        ENDIF (AFTEN_TEST_RUN_RESULT EQUAL 8)
+                ELSE( AFTEN_TEST_COMPILE_RESULT )
+			        MESSAGE(STATUS "  Cannot compile test program to determine Aften version")
+			        SET(USE_AFTEN 0)
+                ENDIF( AFTEN_TEST_COMPILE_RESULT )
 
-		IF (AFTEN_TEST_RUN_RESULT EQUAL 8)
-			MESSAGE(STATUS "  version: 0.0.8")
-			SET(USE_AFTEN_08 1)
-		ELSEIF (AFTEN_TEST_RUN_RESULT EQUAL 7)
-			MESSAGE(STATUS "  version: 0.07")
-			SET(USE_AFTEN_07 1)
-		ELSE (AFTEN_TEST_RUN_RESULT EQUAL 8)
-			MESSAGE(STATUS "Warning: Unable to determine Aften version - support for Aften will be turned off")
-			SET(USE_AFTEN 0)
-		ENDIF (AFTEN_TEST_RUN_RESULT EQUAL 8)
 	ENDIF (AFTEN_FOUND)
 ELSE (AFTEN)
 	MESSAGE("${MSG_DISABLE_OPTION}")



From mean at mail.berlios.de  Tue Dec 29 19:51:29 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 19:51:29 +0100
Subject: [Avidemux-svn-commit] r5760 -
	branches/avidemux_2.6_branch_mean/cmake
Message-ID: <200912291851.nBTIpTrb016487@sheep.berlios.de>

Author: mean
Date: 2009-12-29 19:51:29 +0100 (Tue, 29 Dec 2009)
New Revision: 5760

Added:
   branches/avidemux_2.6_branch_mean/cmake/admSummary.cmake
Modified:
   branches/avidemux_2.6_branch_mean/cmake/admPluginConfigSummary.cmake
Log:
[build] Each plugins reports its summary

Modified: branches/avidemux_2.6_branch_mean/cmake/admPluginConfigSummary.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admPluginConfigSummary.cmake	2009-12-29 18:51:27 UTC (rev 5759)
+++ branches/avidemux_2.6_branch_mean/cmake/admPluginConfigSummary.cmake	2009-12-29 18:51:29 UTC (rev 5760)
@@ -1,34 +1,7 @@
 # ARGV2 - capable flag
-MACRO(ADM_DISPLAY _name)
-	SET(PROCEED 1)
+include(admSummary)
 
-	IF (NOT ${ARGV2})
-		SET(PROCEED 0)
-	ENDIF (NOT ${ARGV2})
 
-	IF (${PROCEED})
-		IF (${ARGV1})
-			SET(s "Yes")
-		ELSE (${ARGV1})
-			SET(s "No")
-		ENDIF (${ARGV1})
-
-		MESSAGE("   ${_name}  ${s}")
-	ENDIF (${PROCEED})
-ENDMACRO(ADM_DISPLAY)
-
-MESSAGE("*********************")
-MESSAGE("***    SUMMARY    ***")
-MESSAGE("*********************")
-MESSAGE("***  Video Codec  ***")
-ADM_DISPLAY("x264      " "$ENV{ADM_HAVE_X264}")
-ADM_DISPLAY("Xvid      " "$ENV{ADM_HAVE_XVID}")
-
-MESSAGE("***  Audio Codec  ***")
-ADM_DISPLAY("amrnb     " "$ENV{ADM_HAVE_AMRNB}")
-ADM_DISPLAY("FAAD      " "$ENV{ADM_HAVE_FAAD}")
-ADM_DISPLAY("libdca    " "$ENV{ADM_HAVE_LIBDCA}")
-
 MESSAGE("*** Miscellaneous ***")
 ADM_DISPLAY("FontConfig" "$ENV{ADM_HAVE_FONTCONFIG}")
 ADM_DISPLAY("FreeType2 " "${FREETYPE2_FOUND}")

Added: branches/avidemux_2.6_branch_mean/cmake/admSummary.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admSummary.cmake	2009-12-29 18:51:27 UTC (rev 5759)
+++ branches/avidemux_2.6_branch_mean/cmake/admSummary.cmake	2009-12-29 18:51:29 UTC (rev 5760)
@@ -0,0 +1,19 @@
+# ARGV2 - capable flag
+MACRO(ADM_DISPLAY _name)
+	SET(PROCEED 1)
+
+	IF (NOT ${ARGV2})
+		SET(PROCEED 0)
+	ENDIF (NOT ${ARGV2})
+
+	IF (${PROCEED})
+		IF (${ARGV1})
+			SET(s "Yes")
+		ELSE (${ARGV1})
+			SET(s "No")
+		ENDIF (${ARGV1})
+
+		MESSAGE("   ${_name}  ${s}")
+	ENDIF (${PROCEED})
+ENDMACRO(ADM_DISPLAY)
+



From mean at mail.berlios.de  Tue Dec 29 19:51:32 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 19:51:32 +0100
Subject: [Avidemux-svn-commit] r5762 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad
Message-ID: <200912291851.nBTIpWWe016544@sheep.berlios.de>

Author: mean
Date: 2009-12-29 19:51:32 +0100 (Tue, 29 Dec 2009)
New Revision: 5762

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp
Log:
[faad] sample is borked, put back aac normal channel mapping

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp	2009-12-29 18:51:30 UTC (rev 5761)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp	2009-12-29 18:51:32 UTC (rev 5762)
@@ -108,14 +108,12 @@
             default:
             {
                 CHANNEL_TYPE *p=channelMapping;
-                *p++ = ADM_CH_REAR_RIGHT;
-                *p++ = ADM_CH_FRONT_LEFT;
                 *p++ = ADM_CH_FRONT_CENTER;
-
+                *p++ = ADM_CH_FRONT_LEFT;
                 *p++ = ADM_CH_FRONT_RIGHT;
                 *p++ = ADM_CH_REAR_LEFT;
-                
-                *p++ = ADM_CH_REAR_LEFT;
+                *p++ = ADM_CH_REAR_RIGHT;                
+                *p++ = ADM_CH_LFE;
               }
                 break;
         }



From mean at mail.berlios.de  Tue Dec 29 19:51:31 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 19:51:31 +0100
Subject: [Avidemux-svn-commit] r5761 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins:
	ADM_demuxers/Asf ADM_videoEncoder/huff
Message-ID: <200912291851.nBTIpVli016531@sheep.berlios.de>

Author: mean
Date: 2009-12-29 19:51:30 +0100 (Tue, 29 Dec 2009)
New Revision: 5761

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfChunk.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.cpp
Log:
[Mad/Asf/huff] Remove warnings

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfChunk.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfChunk.cpp	2009-12-29 18:51:29 UTC (rev 5760)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfChunk.cpp	2009-12-29 18:51:30 UTC (rev 5761)
@@ -111,7 +111,7 @@
   chunkLen<<=32;
   chunkLen+=low;
   
-  printf("Next chunk from %"LX" +%"LX" to %"LX"\n",_chunkStart,chunkLen,chunkLen+_chunkStart);
+  printf("Next chunk from %"LX" +%"LLX" to %"LLX"\n",_chunkStart,chunkLen,chunkLen+_chunkStart);
   
   return 1;
   

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2009-12-29 18:51:29 UTC (rev 5760)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2009-12-29 18:51:30 UTC (rev 5761)
@@ -132,15 +132,15 @@
             printf("Client        :");
             for(int z=0;z<16;z++) printf(":%02x",s->read8());
             printf("\n");
-            printf("File size     : %08lx\n",s->read64());
-            printf("Creation time : %08lx\n",s->read64());
-            printf("Number of pack: %08lx\n",s->read64());
-            printf("Timestamp 1   : %08lx\n",s->read64());
+            printf("File size     : %08"LLX"\n",s->read64());
+            printf("Creation time : %08"LLX"\n",s->read64());
+            printf("Number of pack: %08"LLX"\n",s->read64());
+            printf("Timestamp 1   : %08"LLX"\n",s->read64());
             _duration=s->read64();
-            printf("Timestamp 2   : %08lx\n",_duration);
-            printf("Timestamp 3   : %04x\n",s->read32());
-            printf("Preload       : %04x\n",s->read32());
-            printf("Flags         : %04x\n",s->read32());
+            printf("Timestamp 2   : %08"LLX"\n",_duration);
+            printf("Timestamp 3   : %04"LX"\n",s->read32());
+            printf("Preload       : %04"LX"\n",s->read32());
+            printf("Flags         : %04"LX"\n",s->read32());
             mx=s->read32();
             mn=s->read32();
             if(mx!=mn)
@@ -150,9 +150,9 @@
               return 0; 
             }
             _packetSize=mx;
-            printf("Min size      : %04x\n",mx);
-            printf("Max size      : %04x\n",mn);
-            printf("Uncompres.size: %04x\n",s->read32());
+            printf("Min size      : %04"LX"\n",mx);
+            printf("Max size      : %04"LX"\n",mn);
+            printf("Uncompres.size: %04"LX"\n",s->read32());
           }
           break;
       case ADM_CHUNK_STREAM_HEADER_CHUNK:
@@ -486,4 +486,4 @@
 
   return 1;
   
-}
\ No newline at end of file
+}

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2009-12-29 18:51:29 UTC (rev 5760)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2009-12-29 18:51:30 UTC (rev 5761)
@@ -218,7 +218,8 @@
             skip(10);
             a=read32();
             b=read32();
-            time2=a+(b<<32);
+            time2=b;
+            time2=a+(time2<<32);
             skip(8); 
             skip(12);
             skip(4);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.cpp	2009-12-29 18:51:29 UTC (rev 5760)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.cpp	2009-12-29 18:51:30 UTC (rev 5761)
@@ -20,7 +20,7 @@
 #include "ADM_huffEncoder.h"
 #include "DIA_factory.h"
 
-typedef enum
+enum
 {
     ADM_HUFF_YUV,
     ADM_FF_HUFF_YUV



From mean at mail.berlios.de  Tue Dec 29 19:51:33 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 19:51:33 +0100
Subject: [Avidemux-svn-commit] r5763 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav
Message-ID: <200912291851.nBTIpXYn016554@sheep.berlios.de>

Author: mean
Date: 2009-12-29 19:51:33 +0100 (Tue, 29 Dec 2009)
New Revision: 5763

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
Log:
[lav/audio] Add 0x706D as valid fourcc for aac

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp	2009-12-29 18:51:32 UTC (rev 5762)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp	2009-12-29 18:51:33 UTC (rev 5763)
@@ -53,6 +53,7 @@
         {WAV_MP2,AD_MEDIUM_QUAL},
         {WAV_AC3,AD_LOW_QUAL},   // liba52 preferred ???
         {WAV_AAC,AD_LOW_QUAL},   // liba52 preferred ???
+        {0x706D,AD_LOW_QUAL}, 
         {WAV_EAC3,AD_MEDIUM_QUAL}
   
 };
@@ -138,6 +139,7 @@
         _blockalign = 1;
         break;
       case WAV_AAC:
+      case 0x706D:
         _context->codec_id = CODEC_ID_AAC;
         _blockalign = 1;
         break;



From mean at mail.berlios.de  Tue Dec 29 19:51:35 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 19:51:35 +0100
Subject: [Avidemux-svn-commit] r5764 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_mad
Message-ID: <200912291851.nBTIpZtB016564@sheep.berlios.de>

Author: mean
Date: 2009-12-29 19:51:34 +0100 (Tue, 29 Dec 2009)
New Revision: 5764

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_mad/CMakeLists.txt
Log:
[Mad] Warning removal

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_mad/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_mad/CMakeLists.txt	2009-12-29 18:51:33 UTC (rev 5763)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_mad/CMakeLists.txt	2009-12-29 18:51:34 UTC (rev 5764)
@@ -10,6 +10,7 @@
 
 ADD_SUBDIRECTORY(ADM_libMad)
 
+ADD_DEFINITIONS("-DHAVE_ASSERT_H")
 SET(ADM_ad_Mad_SRCS ADM_ad_mad.cpp)
 
 ADD_LIBRARY(ADM_ad_Mad SHARED ${ADM_ad_Mad_SRCS})



From mean at mail.berlios.de  Tue Dec 29 19:51:36 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 19:51:36 +0100
Subject: [Avidemux-svn-commit] r5765 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins:
	ADM_audioDecoders ADM_audioDevices ADM_audioEncoders
Message-ID: <200912291851.nBTIpagn016616@sheep.berlios.de>

Author: mean
Date: 2009-12-29 19:51:36 +0100 (Tue, 29 Dec 2009)
New Revision: 5765

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/CMakeLists.txt
Log:
[Build] Plugins reports their summary

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/CMakeLists.txt	2009-12-29 18:51:34 UTC (rev 5764)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/CMakeLists.txt	2009-12-29 18:51:36 UTC (rev 5765)
@@ -1,3 +1,4 @@
+include(admSummary)
 ADD_SUBDIRECTORY(ADM_ad_ac3)
 ADD_SUBDIRECTORY(ADM_ad_faad)
 ADD_SUBDIRECTORY(ADM_ad_mad)
@@ -10,3 +11,12 @@
 ADD_SUBDIRECTORY(ADM_ad_ima_adpcm)
 ADD_SUBDIRECTORY(ADM_ad_opencore_amrwb)
 ADD_SUBDIRECTORY(ADM_ad_opencore_amrnb)
+MESSAGE(STATUS "***  Audio Decoder ***")
+ADM_DISPLAY("FAAD      " "${USE_FAAD}")
+ADM_DISPLAY("Vorbis    " "${USE_LIBVORBIS}")
+ADM_DISPLAY("FAAC      " "${USE_FAAC}")
+ADM_DISPLAY("OpenAMR-NB" "${OPENCORE_AMRNB_FOUND}")
+ADM_DISPLAY("DCA       " "${LIBDCA_FOUND}")
+MESSAGE(STATUS "***  /Audio Decoder  ***")
+
+

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/CMakeLists.txt	2009-12-29 18:51:34 UTC (rev 5764)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDevices/CMakeLists.txt	2009-12-29 18:51:36 UTC (rev 5765)
@@ -1,5 +1,5 @@
 include(admCheckAudioDeviceLibs)
-
+include(admSummary)
 if(USE_ALSA)
 ADD_SUBDIRECTORY(Alsa)
 endif(USE_ALSA)
@@ -31,4 +31,17 @@
 if(WIN32)
 ADD_SUBDIRECTORY(Win32)
 endif(WIN32)
-#
+
+MESSAGE("***  Audio Devices ***")
+ADM_DISPLAY("SDL      " "${USE_SDL}")
+ADM_DISPLAY("Pulse    " "${USE_PULSE_SIMPLE}")
+ADM_DISPLAY("ESD      " "${USE_ESD}")
+ADM_DISPLAY("OSS      " "${USE_OSS}")
+ADM_DISPLAY("Alsa     " "${USE_ALSA}")
+ADM_DISPLAY("Jack     " "${USE_JACK}")
+if(WIN32)
+ADM_DISPLAY("Win32    " "1")
+endif(WIN32)
+MESSAGE("***  /Audio Devices  ***")
+
+

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/CMakeLists.txt	2009-12-29 18:51:34 UTC (rev 5764)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/CMakeLists.txt	2009-12-29 18:51:36 UTC (rev 5765)
@@ -1,14 +1,5 @@
 #######################################
 include (admCheckAudioEncoderLibs)
-include (admConfigSummary)
-MESSAGE("***  Audio Codec  ***")
-ADM_DISPLAY("Aften     " "${USE_AFTEN}")
-ADM_DISPLAY("LAME      " "${USE_LAME}")
-ADM_DISPLAY("FAAC      " "${USE_FAAC}")
-ADM_DISPLAY("Vorbis    " "${USE_VORBIS}")
-MESSAGE("***  /Audio Codec  ***")
-
-
 ADD_SUBDIRECTORY(twolame)
 ADD_SUBDIRECTORY(pcm)
 ADD_SUBDIRECTORY(lavcodec)
@@ -18,7 +9,7 @@
 endif(USE_LAME)
 
 if(USE_AFTEN)
-# not tested ADD_SUBDIRECTORY(aften)
+ADD_SUBDIRECTORY(aften)
 endif(USE_AFTEN)
 
 if(USE_VORBIS)
@@ -28,3 +19,12 @@
 if(USE_FAAC)
 ADD_SUBDIRECTORY(faac)
 endif(USE_FAAC)
+MESSAGE("***  Audio Encoder ***")
+ADM_DISPLAY("Aften     " "${USE_AFTEN}")
+ADM_DISPLAY("LAME      " "${USE_LAME}")
+ADM_DISPLAY("FAAC      " "${USE_FAAC}")
+ADM_DISPLAY("Vorbis    " "${USE_VORBIS}")
+MESSAGE("***  /Audio Encoder  ***")
+
+
+



From mean at mail.berlios.de  Tue Dec 29 19:51:38 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 19:51:38 +0100
Subject: [Avidemux-svn-commit] r5766 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften
Message-ID: <200912291851.nBTIpcnf016626@sheep.berlios.de>

Author: mean
Date: 2009-12-29 19:51:37 +0100 (Tue, 29 Dec 2009)
New Revision: 5766

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.h
Log:
[Aften] Use new plugins scheme for aften, only supports SVN version of aften as packaged by ubuntu/debian

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp	2009-12-29 18:51:36 UTC (rev 5765)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp	2009-12-29 18:51:37 UTC (rev 5766)
@@ -25,33 +25,33 @@
 //
 extern "C"
 {
-#if defined(USE_AFTEN_06)
-	#include "aften.h"
-#else	// Aften 0.05 & 0.07 onwards
-	#include "aften/aften.h"
-#endif
+#include "aften/aften.h"
 };
-#include "audioencoder_aften_param.h"
 #include "audioencoder_aften.h"
 
 #define _HANDLE ((AftenContext *)_handle)
 
+static uint32_t aftenBitrate=128;
+/*
 static AFTEN_encoderParam aftenParam= {
   128
-  
-};
-static uint8_t configure (void);
+
+};*/
+
+static bool configure (void);
+
+
 /********************* Declare Plugin *****************************************************/
 ADM_DECLARE_AUDIO_ENCODER_PREAMBLE(AUDMEncoder_Aften);
 
-static ADM_audioEncoder encoderDesc = { 
+static ADM_audioEncoder encoderDesc = {
   ADM_AUDIO_ENCODER_API_VERSION,
   create,			// Defined by macro automatically
   destroy,			// Defined by macro automatically
   configure,		//** put your own function here**
-  "Aften",            
-  "AC3 (Aften)",      
-  "Aften AC3 encoder plugin Mean/Gruntster 2008",             
+  "Aften",
+  "AC3 (Aften)",
+  "Aften AC3 encoder plugin Mean/Gruntster 2008",
   6,                    // Max channels
   1,0,0,                // Version
   WAV_AC3,
@@ -60,13 +60,13 @@
   setConfigurationData,  // Defined by macro automatically
 
   getBitrate,           // Defined by macro automatically
-  setBitrate,            // Defined by macro automatically 
+  setBitrate,            // Defined by macro automatically
 
   NULL,         //** put your own function here**
 
   NULL
 };
-ADM_DECLARE_AUDIO_ENCODER_CONFIG(aftenParam);
+ADM_DECLARE_AUDIO_ENCODER_CONFIG(NULL,NULL,aftenBitrate);
 
 /******************* / Declare plugin*******************************************************/
 
@@ -76,20 +76,42 @@
 
 */
 
-AUDMEncoder_Aften::AUDMEncoder_Aften(AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
+AUDMEncoder_Aften::AUDMEncoder_Aften(AUDMAudioFilter * instream)  :ADM_AudioEncoder    (instream)
 {
   uint32_t channels;
+  ADM_info("[Aften] Creating aften\n");
   channels=instream->getInfo()->channels;
   _handle=(void *)new AftenContext;
   memset(_handle,0,sizeof(AftenContext));
   aften_set_defaults(_HANDLE);
-  _wavheader->encoding=WAV_AC3;
-#if defined(USE_AFTEN_05) || defined(USE_AFTEN_06)
-#elif defined(USE_AFTEN_07)
-  _HANDLE->params.n_threads=1; // MThread collides with avidemux multithreading
-#else
+  wavheader.encoding=WAV_AC3;
   _HANDLE->system.n_threads=1;
-#endif
+
+
+  switch(channels)
+  {
+    case 1:
+        outputChannelMapping[1] = ADM_CH_FRONT_LEFT;
+        break;
+    case 2:
+    	outputChannelMapping[0] = ADM_CH_FRONT_LEFT;
+    	outputChannelMapping[1] = ADM_CH_FRONT_RIGHT;
+      break;
+    default :
+
+    CHANNEL_TYPE *f=outputChannelMapping;
+
+        *f++ = ADM_CH_FRONT_LEFT;
+        *f++ = ADM_CH_FRONT_CENTER;
+        *f++ = ADM_CH_FRONT_RIGHT;
+
+        *f++ = ADM_CH_REAR_LEFT;
+        *f++ = ADM_CH_REAR_RIGHT;
+
+        *f++ = ADM_CH_LFE;
+        break;
+  }
+
 };
 
 /**
@@ -99,13 +121,11 @@
 
 AUDMEncoder_Aften::~AUDMEncoder_Aften()
 {
+    ADM_info("[Aften] Deleting aften\n");
     if(_handle)
       aften_encode_close(_HANDLE);
     delete(_HANDLE);
     _handle=NULL;
-
-    printf("[Aften] Deleting aften\n");
-    cleanup();
 };
 
 
@@ -113,25 +133,24 @@
     \fn initialize
 
 */
-uint8_t AUDMEncoder_Aften::initialize(void)
+bool AUDMEncoder_Aften::initialize(void)
 {
-
-
 int ret=0;
-
-#if defined(USE_AFTEN_05) || defined(USE_AFTEN_06)
-int mask;
-#else
 unsigned int mask;
-#endif
 
-    _wavheader->byterate=(aftenParam.bitrate*1000)/8;
+    if(FLOAT_TYPE_FLOAT!=aften_get_float_type())
+    {
+            ADM_error("Aften was configured to use double !");
+            return false;
+    }
+
+    wavheader.byterate=(aftenBitrate*1000)/8;
     _HANDLE->sample_format=A52_SAMPLE_FMT_FLT;
-    _HANDLE->channels=_wavheader->channels;
-    _HANDLE->samplerate=_wavheader->frequency;
-    
-    _HANDLE->params.bitrate=aftenParam.bitrate;
-    switch(_wavheader->channels)
+    _HANDLE->channels=wavheader.channels;
+    _HANDLE->samplerate=wavheader.frequency;
+
+    _HANDLE->params.bitrate=aftenBitrate;
+    switch(wavheader.channels)
     {
         case 1: mask = 0x04;  break;
         case 2: mask = 0x03;  break;
@@ -141,57 +160,46 @@
         case 6: mask = 0x3F;  break;
       }
 
-#if defined(USE_AFTEN_05) || defined(USE_AFTEN_06)
-	aften_wav_chmask_to_acmod(_wavheader->channels, mask, &(_HANDLE->acmod), &(_HANDLE->lfe));
-#else
-	aften_wav_channels_to_acmod(_wavheader->channels, mask, &(_HANDLE->acmod), &(_HANDLE->lfe));
-#endif
+	aften_wav_channels_to_acmod(wavheader.channels, mask, &(_HANDLE->acmod), &(_HANDLE->lfe));
 
-   //   _HANDLE->params.verbose=2;
     int er= aften_encode_init(_HANDLE);
     if(er<0)
     {
-      printf("[Aften] init error %d\n",er); 
-      return 0;
+      ADM_warning("[Aften] init error %d\n",er);
+      return false;
     }
-    _chunk=256*6*_wavheader->channels;
-    printf("[Aften] Initialized with fd %u Channels %u bitrate %u\n",_HANDLE->samplerate,
+    _chunk=256*6*wavheader.channels;
+    ADM_info("[Aften] Initialized with fd %u Channels %u bitrate %u\n",_HANDLE->samplerate,
                                                                     _HANDLE->channels,_HANDLE->params.bitrate);
-    return 1;
+    return true;
 }
 
 
 /**
-        \fn getPacket
+        \fn encode
 */
-uint8_t	AUDMEncoder_Aften::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
+bool    AUDMEncoder_Aften::encode(uint8_t *dest, uint32_t *len, uint32_t *samples)
 {
   uint32_t count=0;
   int r;
   void *ptr;
 _again:
         *len = 0;
-        _chunk=256*6*_wavheader->channels;
+        _chunk=256*6*wavheader.channels;
         if(!refillBuffer(_chunk ))
         {
-          return 0; 
+          return 0;
         }
         ptr=(void *)&(tmpbuffer[tmphead]);
         ADM_assert(tmptail>=tmphead);
-
-#ifdef USE_AFTEN_05
-		aften_remap_wav_to_a52(ptr, 256*6, _wavheader->channels, A52_SAMPLE_FMT_FLT, _HANDLE->acmod, _HANDLE->lfe);
-#else
-		aften_remap_wav_to_a52(ptr, 256*6, _wavheader->channels, A52_SAMPLE_FMT_FLT, _HANDLE->acmod);
-#endif
-
-        r=aften_encode_frame(_HANDLE, dest,(void *)ptr);
+        reorderChannels(&(tmpbuffer[tmphead]),256*6,_incoming->getChannelMapping(),outputChannelMapping);
+        r=aften_encode_frame(_HANDLE, dest,(void *)ptr,256*6);
         if(r<0)
         {
           printf("[Aften] Encoding error %d\n",r);
-          return 0; 
+          return 0;
         }
-        
+
         *samples=256*6;
         *len=r;
         tmphead+=_chunk;
@@ -201,7 +209,10 @@
 /**
     \fn configure
 */
-uint8_t configure (void)
+#define SZT(x) sizeof(x)/sizeof(diaMenuEntry )
+#define BITRATE(x) {x,QT_TR_NOOP(#x)}
+
+bool configure (void)
 {
  int ret=0;
 
@@ -217,13 +228,13 @@
                               BITRATE(224),
                               BITRATE(384)
                           };
-    diaElemMenu bitrate(&(aftenParam.bitrate),   QT_TR_NOOP("_Bitrate:"), SZT(bitrateM),bitrateM);
-  
-    
+    diaElemMenu bitrate(&(aftenBitrate),   QT_TR_NOOP("_Bitrate:"), SZT(bitrateM),bitrateM);
 
+
+
     diaElem *elems[]={&bitrate};
-    
+
     return ( diaFactoryRun(QT_TR_NOOP("Aften Configuration"),1,elems));
-    
+
 }
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.h	2009-12-29 18:51:36 UTC (rev 5765)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.h	2009-12-29 18:51:37 UTC (rev 5766)
@@ -15,17 +15,21 @@
 #ifndef AUDMaudioAften
 #define AUDMaudioAften
 
- //_____________________________________________
-class AUDMEncoder_Aften : public AUDMEncoder
+/**
+    \class AUDMEncoder_Aften
+    \brief Class wrapping aften ac3 encoder
+*/
+class AUDMEncoder_Aften : public ADM_AudioEncoder
 {
 protected:
          void           *_handle;
-         
+         uint32_t       _chunk;
+
 public:
-                uint8_t initialize(void);
-                virtual ~AUDMEncoder_Aften();
-                        AUDMEncoder_Aften(AUDMAudioFilter *instream);	
-        virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
+                bool    initialize(void);
+    virtual     bool    encode(uint8_t *dest, uint32_t *len, uint32_t *samples);
+    virtual             ~AUDMEncoder_Aften();
+                        AUDMEncoder_Aften(AUDMAudioFilter *instream);
 };
 #endif
 



From mean at mail.berlios.de  Tue Dec 29 19:51:40 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 19:51:40 +0100
Subject: [Avidemux-svn-commit] r5768 -
	branches/avidemux_2.6_branch_mean/cmake_compile_check
Message-ID: <200912291851.nBTIpeMS016655@sheep.berlios.de>

Author: mean
Date: 2009-12-29 19:51:40 +0100 (Tue, 29 Dec 2009)
New Revision: 5768

Modified:
   branches/avidemux_2.6_branch_mean/cmake_compile_check/aften_check.cpp
Log:
[aften] Verbose aften check + add the SVN case

Modified: branches/avidemux_2.6_branch_mean/cmake_compile_check/aften_check.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake_compile_check/aften_check.cpp	2009-12-29 18:51:39 UTC (rev 5767)
+++ branches/avidemux_2.6_branch_mean/cmake_compile_check/aften_check.cpp	2009-12-29 18:51:40 UTC (rev 5768)
@@ -1,14 +1,17 @@
 #include <string.h>
+#include <stdio.h>
 #include <aften/aften.h>
 
 int main(int argc, char **argv)
 {
 	const char* aftenVersion = aften_get_version();
-
+        fprintf(stderr,"Aften version = %s\n",aftenVersion);
 	if (strcmp(aftenVersion, "0.07") == 0)
 		return 7;
 	else if (strcmp(aftenVersion, "0.0.8") == 0)
 		return 8;
+	else if (strcmp(aftenVersion, "SVN") == 0)
+		return 99;
 
-	return 0;
+	return -1;
 }



From mean at mail.berlios.de  Tue Dec 29 19:51:41 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 19:51:41 +0100
Subject: [Avidemux-svn-commit] r5769 - in branches/avidemux_2.6_branch_mean:
	avidemux_plugins/ADM_audioEncoders/aften cmake
Message-ID: <200912291851.nBTIpfjl016706@sheep.berlios.de>

Author: mean
Date: 2009-12-29 19:51:41 +0100 (Tue, 29 Dec 2009)
New Revision: 5769

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp
   branches/avidemux_2.6_branch_mean/cmake/admCheckAudioEncoderLibs.cmake
Log:
[aften] Support both 0.8 and svn

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/CMakeLists.txt	2009-12-29 18:51:40 UTC (rev 5768)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/CMakeLists.txt	2009-12-29 18:51:41 UTC (rev 5769)
@@ -8,5 +8,9 @@
 
 	ADD_TARGET_CFLAGS(ADM_ae_aften "-I${AFTEN_INCLUDE_DIR}")
 
+        if(USE_AFTEN_08)
+                ADD_DEFINITIONS(-DAFTEN_08)
+        endif(USE_AFTEN_08)
+
 	INIT_AUDIO_ENCODER(ADM_ae_aften)
 	INSTALL_AUDIOENCODER(ADM_ae_aften)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp	2009-12-29 18:51:40 UTC (rev 5768)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp	2009-12-29 18:51:41 UTC (rev 5769)
@@ -193,7 +193,11 @@
         ptr=(void *)&(tmpbuffer[tmphead]);
         ADM_assert(tmptail>=tmphead);
         reorderChannels(&(tmpbuffer[tmphead]),256*6,_incoming->getChannelMapping(),outputChannelMapping);
-        r=aften_encode_frame(_HANDLE, dest,(void *)ptr,256*6);
+        r=aften_encode_frame(_HANDLE, dest,(void *)ptr
+#ifndef AFTEN_08
+      ,256*6
+#endif
+        );
         if(r<0)
         {
           printf("[Aften] Encoding error %d\n",r);

Modified: branches/avidemux_2.6_branch_mean/cmake/admCheckAudioEncoderLibs.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admCheckAudioEncoderLibs.cmake	2009-12-29 18:51:40 UTC (rev 5768)
+++ branches/avidemux_2.6_branch_mean/cmake/admCheckAudioEncoderLibs.cmake	2009-12-29 18:51:41 UTC (rev 5769)
@@ -23,20 +23,29 @@
 		ENDIF (NOT DEFINED AFTEN_TEST_RUN_RESULT)
                 #MESSAGE(STATUS " Compile ${AFTEN_TEST_COMPILE_RESULT}, TMP_LIBS=${TMP_LIBS},OUTPUT=${AFTEN_OUTPUT}")
                 IF( AFTEN_TEST_COMPILE_RESULT )
-		        IF (AFTEN_TEST_RUN_RESULT EQUAL 8)
-			        MESSAGE(STATUS "  version: 0.0.8")
-			        SET(USE_AFTEN_08 1)
-		        ELSEIF (AFTEN_TEST_RUN_RESULT EQUAL 7)
-			        MESSAGE(STATUS "  version: 0.07")
-			        SET(USE_AFTEN_07 1)
-                        ELSEIF(AFTEN_TEST_RUN_RESULT EQUAL 99)
+                        IF(AFTEN_TEST_RUN_RESULT EQUAL 99)
                                 MESSAGE(STATUS "  version: SVN")
                                 MESSAGE(WARNING "  This is a svn version of Aften. We will assume it is compatible with 0.0.8, build may fail")
-                                SET(USE_AFTEN_08 1)
-                        ELSE(AFTEN_TEST_RUN_RESULT EQUAL 8)
-                                MESSAGE(STATUS "Warning: Unable to determine Aften version - support for Aften will be turned off (result=${AFTEN_TEST_RUN_RESULT})")
-                                SET(USE_AFTEN 0)
-		        ENDIF (AFTEN_TEST_RUN_RESULT EQUAL 8)
+                                SET(USE_AFTEN 1)
+		        ELSEIF (AFTEN_TEST_RUN_RESULT EQUAL 8)
+                                MESSAGE(STATUS " This is version 0.8 of aften")
+			        SET(USE_AFTEN 1)
+			        SET(USE_AFTEN_08 1)
+                        ENDIF(AFTEN_TEST_RUN_RESULT EQUAL 99)
+		      #  IF (AFTEN_TEST_RUN_RESULT EQUAL 8)
+			        #MESSAGE(STATUS "  version: 0.0.8")
+			        #SET(USE_AFTEN_08 1)
+		        #ELSEIF (AFTEN_TEST_RUN_RESULT EQUAL 7)
+			        #MESSAGE(STATUS "  version: 0.07")
+			        #SET(USE_AFTEN_07 1)
+                        #ELSEIF(AFTEN_TEST_RUN_RESULT EQUAL 99)
+                                #MESSAGE(STATUS "  version: SVN")
+                                #MESSAGE(WARNING "  This is a svn version of Aften. We will assume it is compatible with 0.0.8, build may fail")
+                                #SET(USE_AFTEN_08 1)
+                        #ELSE(AFTEN_TEST_RUN_RESULT EQUAL 8)
+                                #MESSAGE(STATUS "Warning: Unable to determine Aften version - support for Aften will be turned off (result=${AFTEN_TEST_RUN_RESULT})")
+                                #SET(USE_AFTEN 0)
+		        #ENDIF (AFTEN_TEST_RUN_RESULT EQUAL 8)
                 ELSE( AFTEN_TEST_COMPILE_RESULT )
 			        MESSAGE(STATUS "  Cannot compile test program to determine Aften version")
 			        SET(USE_AFTEN 0)



From mean at mail.berlios.de  Tue Dec 29 19:51:39 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 19:51:39 +0100
Subject: [Avidemux-svn-commit] r5767 - branches/avidemux_2.6_branch_mean
Message-ID: <200912291851.nBTIpdL4016636@sheep.berlios.de>

Author: mean
Date: 2009-12-29 19:51:39 +0100 (Tue, 29 Dec 2009)
New Revision: 5767

Modified:
   branches/avidemux_2.6_branch_mean/bootStrap.bash
Log:
[bootstrap] Add a --debug switch, create codeblocks project

Modified: branches/avidemux_2.6_branch_mean/bootStrap.bash
===================================================================
--- branches/avidemux_2.6_branch_mean/bootStrap.bash	2009-12-29 18:51:37 UTC (rev 5766)
+++ branches/avidemux_2.6_branch_mean/bootStrap.bash	2009-12-29 18:51:39 UTC (rev 5767)
@@ -1,10 +1,14 @@
 #!/bin/bash
+# Bootstrapper to semi-automatically build avidemux deb/rpm from source
+# (c) Mean 2009
+#
 packages_ext=deb
 do_core=1
 do_cli=0
 do_gtk=1
 do_qt4=0
 do_plugins=1
+debug=0
 fail()
 {
         echo "** Failed at $1**"
@@ -16,11 +20,19 @@
         export BUILDDIR=$1
         export SOURCEDIR=$2
         export EXTRA=$3
-        echo "Building $BUILDDIR from $SOURCEDIRi with EXTRA=$EXTRA"
+        export DEBUG=""
+        BUILDER="Unix Makefiles"
+        if [ "x$debug" = "x1" ] ; then 
+                DEBUG="-DVERBOSE=1 -DCMAKE_BUILD_TYPE=Debug  "
+                BUILDDIR="${BUILDDIR}_debug"
+                BUILDER="CodeBlocks - Unix Makefiles"
+        fi
+        
+        echo "Building $BUILDDIR from $SOURCEDIR with EXTRA=<$EXTRA>, DEBUG=<$DEBUG>"
         rm -Rf ./$BUILDDIR
         mkdir $BUILDDIR || fail mkdir
         cd $BUILDDIR 
-        cmake $PKG -DCMAKE_EDIT_COMMAND=vim -DAVIDEMUX_SOURCE_DIR=$TOP -DCMAKE_INSTALL_PREFIX=/usr $EXTRA $SOURCEDIR || fail cmake
+        cmake $PKG -DCMAKE_EDIT_COMMAND=vim -DAVIDEMUX_SOURCE_DIR=$TOP -DCMAKE_INSTALL_PREFIX=/usr $EXTRA $DEBUG -G "$BUILDER" $SOURCEDIR || fail cmakeZ
         make -j 2 > /tmp/log$BUILDDIR || fail make
         fakeroot make package DESTDIR=debPack || fail package
 }
@@ -38,6 +50,10 @@
 {
         echo "Build configuration :"
         echo "******************* :"
+        echo "Build type :"
+        if [ "x$debug" = "x1" ] ; then echo   "Debug build"
+        else echo   "Release build"
+        fi
         printModule $do_core Core
         printModule $do_gtk Gtk
         printModule $do_qt4 Qt4
@@ -50,6 +66,7 @@
         echo "***********************"
         echo "  --help            : Print usage"
         echo "  --rpm             : Build rpm packages rather than deb"
+        echo "  --debug           : Switch debugging on"
         echo "  --with-core       : Build core"
         echo "  --without-core    : Dont build core"
         echo "  --with-cli        : Build cli"
@@ -70,6 +87,9 @@
              usage
              exit 1
              ;;
+         --debug)
+                debug=1
+                ;;
          --rpm)
                 packages_ext=rpm
                 PKG="$PKG -DRPM=1"



From mean at mail.berlios.de  Tue Dec 29 20:04:16 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 29 Dec 2009 20:04:16 +0100
Subject: [Avidemux-svn-commit] r5770 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <200912291904.nBTJ4GMB017788@sheep.berlios.de>

Author: mean
Date: 2009-12-29 20:04:16 +0100 (Tue, 29 Dec 2009)
New Revision: 5770

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edVideoCopy.cpp
Log:
[Editor] Allow a bit of margin in DTS check to allow rounding errors and avoid the DTS going back in time when the delta is less than frameIncrement/10

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edVideoCopy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edVideoCopy.cpp	2009-12-29 18:51:41 UTC (rev 5769)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edVideoCopy.cpp	2009-12-29 19:04:16 UTC (rev 5770)
@@ -93,7 +93,9 @@
         img->demuxerDts=_nextFrameDts;
     }else
     {
-        if(_nextFrameDts>img->demuxerDts) 
+// It means that the incoming image is earlier than the expected time.
+// we add a bit of timeIncrement to compensate for rounding
+        if(_nextFrameDts>img->demuxerDts+vid->timeIncrementInUs/10)
         {
          ADM_error("Frame %"LU" DTS is going back in time : expected : %"LLU" ms got : %"LLU" ms\n",fn,_nextFrameDts/1000,img->demuxerDts/1000);
         }
@@ -136,4 +138,4 @@
     ADM_info("Retrying for next segment\n");
     return getCompressedPicture(img);
    
-}
\ No newline at end of file
+}



From gruntster at mail.berlios.de  Tue Dec 29 21:40:33 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 29 Dec 2009 21:40:33 +0100
Subject: [Avidemux-svn-commit] r5771 - in
	branches/avidemux_2.5_branch_gruntster: platforms/windows/installer
	plugins/ADM_videoEncoder/ADM_vidEnc_avcodec
Message-ID: <200912292040.nBTKeXFi025305@sheep.berlios.de>

Author: gruntster
Date: 2009-12-29 21:40:24 +0100 (Tue, 29 Dec 2009)
New Revision: 5771

Added:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/MjpegParam.xsd
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.h
Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
Log:
[mjpeg] avcodec M-JPEG video plugin

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2009-12-29 19:04:16 UTC (rev 5770)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2009-12-29 20:40:24 UTC (rev 5771)
@@ -483,9 +483,7 @@
 			SetOutPath $INSTDIR\plugins\videoEncoder
 			${File} plugins\videoEncoder\libADM_vidEnc_avcodec.dll
 			SetOutPath $INSTDIR\plugins\videoEncoder\avcodec
-			${File} plugins\videoEncoder\avcodec\Flv1Param.xsd
-			${File} plugins\videoEncoder\avcodec\Mpeg1Param.xsd
-			${File} plugins\videoEncoder\avcodec\Mpeg2Param.xsd
+			${File} plugins\videoEncoder\avcodec\*.xsd
 			SetOutPath $INSTDIR\plugins\videoEncoder\avcodec\mpeg-1
 			${File} plugins\videoEncoder\avcodec\mpeg-1\*.xml
 			SetOutPath $INSTDIR\plugins\videoEncoder\avcodec\mpeg-2

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-29 19:04:16 UTC (rev 5770)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-29 20:40:24 UTC (rev 5771)
@@ -11,18 +11,20 @@
 SET(ADM_vidEnc_avcodec_SRCS  interface.c  encoder.cpp  huffyuvEncoder.cpp
 							 ffvhuffEncoder.cpp  ffv1Encoder.cpp  dvEncoder.cpp  ../common/PluginOptions.cpp
 							 mpeg1Encoder.cpp  mpeg1EncoderOptions.cpp  mpeg2Encoder.cpp  mpeg2EncoderOptions.cpp
-							 flv1Encoder.cpp  flv1EncoderOptions.cpp)
+							 flv1Encoder.cpp  flv1EncoderOptions.cpp  mjpegEncoder.cpp  mjpegEncoderOptions.cpp)
 
 set(PLUGIN_SCHEMA_DIR "avcodec")
 set(MPEG1_PLUGIN_CONFIG_DIR "avcodec/mpeg-1")
 set(MPEG2_PLUGIN_CONFIG_DIR "avcodec/mpeg-2")
 set(FLV1_PLUGIN_CONFIG_DIR "avcodec/flv1")
+set(MJPEG_PLUGIN_CONFIG_DIR "avcodec/mjpeg")
 
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${LIBXML2_INCLUDE_DIR})
 ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_SCHEMA_DIR="${PLUGIN_SCHEMA_DIR}")
 set_property(SOURCE mpeg1EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMPEG1_PLUGIN_CONFIG_DIR=\\\"${MPEG1_PLUGIN_CONFIG_DIR}\\\")
 set_property(SOURCE mpeg2EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMPEG2_PLUGIN_CONFIG_DIR=\\\"${MPEG2_PLUGIN_CONFIG_DIR}\\\")
 set_property(SOURCE flv1EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DFLV1_PLUGIN_CONFIG_DIR=\\\"${FLV1_PLUGIN_CONFIG_DIR}\\\")
+set_property(SOURCE mjpegEncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMJPEG_PLUGIN_CONFIG_DIR=\\\"${MJPEG_PLUGIN_CONFIG_DIR}\\\")
 
 getFfmpegLibNames(${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_libraries/ffmpeg)
 
@@ -39,4 +41,5 @@
 INSTALL_VIDEO_ENCODER(ADM_vidEnc_avcodec)
 INSTALL(FILES Mpeg1Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
 INSTALL(FILES Mpeg2Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
-INSTALL(FILES Flv1Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
\ No newline at end of file
+INSTALL(FILES Flv1Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
+INSTALL(FILES MjpegParam.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/MjpegParam.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/MjpegParam.xsd	2009-12-29 19:04:16 UTC (rev 5770)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/MjpegParam.xsd	2009-12-29 20:40:24 UTC (rev 5771)
@@ -0,0 +1,46 @@
+<?xml version="1.0" encoding="utf-8"?>
+<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified">
+  <xs:element name="MjpegConfig">
+    <xs:complexType>
+      <xs:sequence>
+        <xs:element name="presetConfiguration" minOccurs="0">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="name" type="xs:string"/>
+              <xs:element name="type">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="default"/>
+                    <xs:enumeration value="user"/>
+                    <xs:enumeration value="system"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+        <xs:element name="encodeOptions" minOccurs="0">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="mode">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="CQP"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="parameter" type="uint"/>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+        <xs:element name="MjpegOptions">
+        </xs:element>
+      </xs:sequence>
+    </xs:complexType>
+  </xs:element>
+  <xs:simpleType name="uint">
+    <xs:restriction base="xs:integer">
+      <xs:minInclusive value="0"/>
+    </xs:restriction>
+  </xs:simpleType>
+</xs:schema>

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2009-12-29 19:04:16 UTC (rev 5770)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2009-12-29 20:40:24 UTC (rev 5771)
@@ -21,6 +21,7 @@
 #include "ffv1Encoder.h"
 #include "ffvhuffEncoder.h"
 #include "huffyuvEncoder.h"
+#include "mjpegEncoder.h"
 #include "mpeg1Encoder.h"
 #include "mpeg2Encoder.h"
 #include "ADM_inttype.h"
@@ -32,11 +33,12 @@
 static FFV1Encoder ffv1;
 static FFVHuffEncoder ffvhuff;
 static HuffyuvEncoder huffyuv;
+static MjpegEncoder mjpeg;
 static Mpeg1Encoder mpeg1;
 static Mpeg2Encoder mpeg2;
 
-static int encoderIds[] = { 0, 1, 2, 3, 4, 5, 6 };
-static AvcodecEncoder* encoders[] = { &dv, &flv1, &ffv1, &ffvhuff, &huffyuv, &mpeg1, &mpeg2};
+static int encoderIds[] = { 0, 1, 2, 3, 4, 5, 6, 7 };
+static AvcodecEncoder* encoders[] = { &dv, &flv1, &ffv1, &ffvhuff, &huffyuv, &mjpeg, &mpeg1, &mpeg2};
 
 extern "C"
 {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-29 19:04:16 UTC (rev 5770)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-29 20:40:24 UTC (rev 5771)
@@ -71,7 +71,7 @@
 void vidEncGetEncoderVersion(int encoderId, int* major, int* minor, int* patch)
 {
 	*major = 1;
-	*minor = 2;
+	*minor = 3;
 	*patch = 0;
 }
 

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.cpp	2009-12-29 19:04:16 UTC (rev 5770)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.cpp	2009-12-29 20:40:24 UTC (rev 5771)
@@ -0,0 +1,249 @@
+/***************************************************************************
+                              mjpegEncoder.cpp
+
+    begin                : Tue Dec 29 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include <libxml/tree.h>
+#include "ADM_inttype.h"
+#include "mjpegEncoder.h"
+
+extern int _uiType;
+static bool changedConfig(const char* fileName, ConfigMenuType configType);
+static char *serializeConfig(void);
+static MjpegEncoder *encoder = NULL;
+
+#ifdef __WIN32
+extern void convertPathToAnsi(const char *path, char **ansiPath);
+#endif
+
+MjpegEncoder::MjpegEncoder(void)
+{
+	encoder = this;
+
+	init(CODEC_ID_MJPEG, ADM_CSP_YV12);
+
+	_encodeOptions.structSize = sizeof(vidEncOptions);
+	_encodeOptions.encodeMode = MJPEG_DEFAULT_ENCODE_MODE;
+	_encodeOptions.encodeModeParameter = MJPEG_DEFAULT_ENCODE_MODE_PARAMETER;
+}
+
+int MjpegEncoder::initContext(const char* logFileName)
+{
+	AvcodecEncoder::initContext(logFileName);
+
+	_context->pix_fmt = PIX_FMT_YUVJ420P;
+	_context->flags = CODEC_FLAG_QSCALE;
+	_context->bit_rate = 0;
+	_context->bit_rate_tolerance = 1024 * 8 * 1000;
+	_context->gop_size = 250;
+	_context->rc_qsquish = 1.0;
+	_context->i_quant_factor = 0.8;
+
+	return ADM_VIDENC_ERR_SUCCESS;
+}
+
+const char* MjpegEncoder::getEncoderType(void)
+{
+	return "M-JPEG";
+}
+
+const char* MjpegEncoder::getEncoderDescription(void)
+{
+	return "M-JPEG video encoder plugin for Avidemux (c) Mean/Gruntster";
+}
+
+const char* MjpegEncoder::getFourCC(void)
+{
+	return "MJPG";
+}
+
+const char* MjpegEncoder::getEncoderGuid(void)
+{
+	return "075E8A4E-5B3D-47c6-9F70-853D6B855106";
+}
+
+int MjpegEncoder::isConfigurable(void)
+{
+	return (_uiType == ADM_UI_GTK || _uiType == ADM_UI_QT4);
+}
+
+int MjpegEncoder::configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties)
+{
+	loadSettings(&_encodeOptions, &_options);
+
+	diaElemUInteger ctlQuantiser(&_quantiser, "_Quantiser:", 2, 31);
+	diaElem *elmGeneral[1] = {&ctlQuantiser};
+
+	diaElemConfigMenu ctlConfigMenu(configName, &configType, _options.getUserConfigDirectory(), _options.getSystemConfigDirectory(),
+		changedConfig, serializeConfig, elmGeneral, 1);
+	diaElem *elmHeader[1] = {&ctlConfigMenu};
+
+	diaElemTabs tabGeneral("Settings", 1, elmGeneral);
+	diaElemTabs *tabs[] = {&tabGeneral};
+
+	if (diaFactoryRunTabs("avcodec M-JPEG Configuration", 1, elmHeader, 1, tabs))
+	{
+		saveSettings(&_encodeOptions, &_options);
+		updateEncodeProperties(&_encodeOptions);
+
+		return 1;
+	}
+
+	return 0;
+}
+
+void MjpegEncoder::loadSettings(vidEncOptions *encodeOptions, MjpegEncoderOptions *options)
+{
+	char *configurationName;
+
+	options->getPresetConfiguration(&configurationName, (PluginConfigType*)&configType);
+
+	if (configurationName)
+	{
+		strcpy(this->configName, configurationName);
+		delete [] configurationName;
+	}
+
+	if (encodeOptions)
+		updateEncodeProperties(encodeOptions);
+}
+
+void MjpegEncoder::saveSettings(vidEncOptions *encodeOptions, MjpegEncoderOptions *options)
+{
+	options->setPresetConfiguration(&configName[0], (PluginConfigType)configType);
+
+	encodeOptions->encodeMode = ADM_VIDENC_MODE_CQP;
+	encodeOptions->encodeModeParameter = _quantiser;
+}
+
+bool changedConfig(const char* configName, ConfigMenuType configType)
+{
+	bool failure = false;
+
+	if (configType == CONFIG_MENU_DEFAULT)
+	{
+		MjpegEncoderOptions defaultOptions;
+		vidEncOptions *defaultEncodeOptions = defaultOptions.getEncodeOptions();
+
+		encoder->loadSettings(defaultEncodeOptions, &defaultOptions);
+
+		delete defaultEncodeOptions;
+	}
+	else
+	{
+		MjpegEncoderOptions options;
+
+		options.setPresetConfiguration(configName, (PluginConfigType)configType);
+
+		if (configType == CONFIG_MENU_CUSTOM)
+			encoder->loadSettings(NULL, &options);
+		else
+		{
+			vidEncOptions *encodeOptions;
+
+			if (options.loadPresetConfiguration())
+			{
+				encodeOptions = options.getEncodeOptions();
+
+				encoder->loadSettings(encodeOptions, &options);
+
+				delete encodeOptions;
+			}
+			else
+			{
+				failure = true;
+			}
+		}
+	}
+
+	return configType == CONFIG_MENU_CUSTOM | !failure;
+}
+
+char *serializeConfig(void)
+{
+	vidEncOptions encodeOptions;
+	MjpegEncoderOptions options;
+
+	encoder->saveSettings(&encodeOptions, &options);
+	options.setEncodeOptions(&encodeOptions);
+
+	return options.toXml(PLUGIN_XML_EXTERNAL);
+}
+
+int MjpegEncoder::getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize)
+{
+	char* xml = _options.toXml(PLUGIN_XML_INTERNAL);
+	int xmlLength = strlen(xml);
+
+	if (bufferSize >= xmlLength)
+	{
+		memcpy(pluginOptions, xml, xmlLength);
+		memcpy(encodeOptions, &_encodeOptions, sizeof(vidEncOptions));
+	}
+	else if (bufferSize != 0)
+		xmlLength = 0;
+
+	delete [] xml;
+
+	return xmlLength;
+}
+
+int MjpegEncoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+{
+	if (_opened)
+		return ADM_VIDENC_ERR_ALREADY_OPEN;
+
+	bool success = true;
+
+	if (pluginOptions)
+	{
+		success = _options.fromXml(pluginOptions, PLUGIN_XML_INTERNAL);
+
+		_options.loadPresetConfiguration();
+	}
+
+	if (encodeOptions && success)
+	{
+		memcpy(&_encodeOptions, encodeOptions, sizeof(vidEncOptions));
+		updateEncodeProperties(encodeOptions);
+	}
+
+	if (success)
+		return ADM_VIDENC_ERR_SUCCESS;
+	else
+		return ADM_VIDENC_ERR_FAILED;
+}
+
+int MjpegEncoder::beginPass(vidEncPassParameters *passParameters)
+{
+	int ret = AvcodecEncoder::beginPass(passParameters);
+
+	_frame.quality = (int)floor(FF_QP2LAMBDA * _encodeOptions.encodeModeParameter + 0.5);
+
+	return ret;
+}
+
+int MjpegEncoder::encodeFrame(vidEncEncodeParameters *encodeParams)
+{
+	int ret = AvcodecEncoder::encodeFrame(encodeParams);
+
+	printf("_frame.quality: %d\n", _frame.quality);
+
+	return ret;
+}
+
+void MjpegEncoder::updateEncodeProperties(vidEncOptions *encodeOptions)
+{
+	_passCount = 1;
+	_quantiser = encodeOptions->encodeModeParameter;
+}

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.h	2009-12-29 19:04:16 UTC (rev 5770)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.h	2009-12-29 20:40:24 UTC (rev 5771)
@@ -0,0 +1,60 @@
+/***************************************************************************
+                               mjpegEncoder.h
+
+    begin                : Tue Dec 29 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef MjpegEncoder_h
+#define MjpegEncoder_h
+
+#ifdef __cplusplus
+extern "C"
+{
+	#include "ADM_vidEnc_plugin.h"
+}
+
+#include "encoder.h"
+#include "mjpegEncoderOptions.h"
+#include "DIA_factory.h"
+
+class MjpegEncoder : public AvcodecEncoder
+{
+	private:
+		unsigned int _quantiser;
+
+		char configName[PATH_MAX];
+		ConfigMenuType configType;
+
+		MjpegEncoderOptions _options;
+		vidEncOptions _encodeOptions;
+
+		void updateEncodeProperties(vidEncOptions *encodeOptions);
+
+	public:
+		MjpegEncoder(void);
+		int initContext(const char* logFileName);
+		const char* getEncoderType(void);
+		const char* getEncoderDescription(void);
+		const char* getFourCC(void);
+		const char* getEncoderGuid(void);
+		int isConfigurable(void);
+		int configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
+		void loadSettings(vidEncOptions *encodeOptions, MjpegEncoderOptions *options);
+		void saveSettings(vidEncOptions *encodeOptions, MjpegEncoderOptions *options);
+		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
+		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int beginPass(vidEncPassParameters *passParameters);
+		int encodeFrame(vidEncEncodeParameters *encodeParams);
+};
+#endif	// __cplusplus
+#endif	// MjpegEncoder_h

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.cpp	2009-12-29 19:04:16 UTC (rev 5770)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.cpp	2009-12-29 20:40:24 UTC (rev 5771)
@@ -0,0 +1,39 @@
+ /***************************************************************************
+                           mjpegEncoderOptions.cpp
+
+	These settings are intended for scripting and can contain a Preset 
+	Configuration block.  If this block exists then "internal" settings are
+	ignored and an external configuration file should be read instead, 
+	e.g. PlayStation Portable profile.  However, if the external file is 
+	missing, internal settings have to be used and will reflect a snapshot
+	of the external configuration file at the time the script was generated.
+
+    begin                : Tue Dec 29 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <libxml/parser.h>
+#include <libxml/xmlschemas.h>
+#include <sstream>
+#include <string>
+#include "ADM_default.h"
+
+#include "mjpegEncoderOptions.h"
+
+MjpegEncoderOptions::MjpegEncoderOptions(void) : PluginOptions(MJPEG_PLUGIN_CONFIG_DIR, "Mjpeg", "MjpegParam.xsd", MJPEG_DEFAULT_ENCODE_MODE, MJPEG_DEFAULT_ENCODE_MODE_PARAMETER) { }
+
+void MjpegEncoderOptions::addOptionsToXml(xmlNodePtr xmlNodeRoot)
+{ 
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)getOptionsTagRoot(), NULL);
+}
+
+void MjpegEncoderOptions::parseOptions(xmlNode *node) { }
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.h	2009-12-29 19:04:16 UTC (rev 5770)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.h	2009-12-29 20:40:24 UTC (rev 5771)
@@ -0,0 +1,41 @@
+/***************************************************************************
+                           mjpeg1EncoderOptions.h
+
+    begin                : Tue Dec 29 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef MjpegEncoderOptions_h
+#define MjpegEncoderOptions_h
+
+#include <vector>
+#include "../common/PluginOptions.h"
+
+extern "C"
+{
+#include "ADM_vidEnc_plugin.h"
+}
+
+#define MJPEG_DEFAULT_ENCODE_MODE ADM_VIDENC_MODE_CQP
+#define MJPEG_DEFAULT_ENCODE_MODE_PARAMETER 4
+
+class MjpegEncoderOptions : public PluginOptions
+{
+protected:
+	void addOptionsToXml(xmlNodePtr xmlNodeRoot);
+	void parseOptions(xmlNode *node);
+
+public:
+	MjpegEncoderOptions(void);
+};
+
+#endif	// MjpegEncoderOptions_h



From gruntster at mail.berlios.de  Tue Dec 29 23:24:17 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 29 Dec 2009 23:24:17 +0100
Subject: [Avidemux-svn-commit] r5772 -
	branches/avidemux_2.5_branch_gruntster/avidemux
Message-ID: <200912292224.nBTMOHi3031372@sheep.berlios.de>

Author: gruntster
Date: 2009-12-29 23:24:13 +0100 (Tue, 29 Dec 2009)
New Revision: 5772

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp
Log:
[jpeg] use avcodec directly for jpeg instead of old mjpeg plugin

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp	2009-12-29 20:40:24 UTC (rev 5771)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp	2009-12-29 22:24:13 UTC (rev 5772)
@@ -2653,38 +2653,70 @@
 */
 uint8_t  ADMImage::saveAsJpg(const char *filename)
 {
- ffmpegEncoderFFMjpeg *codec=NULL;
-  FILE *fd;
-  uint8_t *buffer=NULL;
-  uint32_t sz;
-  
+	AVCodecContext *context = avcodec_alloc_context();
+	AVCodec *codec = NULL;
+	uint8_t success = 0;
+	
+	if (context)
+	{
+		context->width = _width;
+		context->height = _height;
+		context->pix_fmt = PIX_FMT_YUVJ420P;
+		context->time_base = (AVRational){1, 25};
+		context->flags = CODEC_FLAG_QSCALE;
 
-        sz = _width*_height*3;
-        ADMBitstream bitstream(sz);
-        buffer=new uint8_t[sz];
-        bitstream.data=buffer;
-        codec=new  ffmpegEncoderFFMjpeg(_width,_height,FF_MJPEG)  ;
-        codec->init( 95,25000);
-        if(!codec->encode(this,&bitstream))
-        {
-                GUI_Error_HIG(QT_TR_NOOP("Cannot encode the frame"), NULL);
-                delete [] buffer;
-                delete codec;
-                return 0;
-        }
-        delete codec;
-        fd=fopen(filename,"wb");
-        if(!fd)
-        {
-                GUI_Error_HIG(QT_TR_NOOP("File error"),QT_TR_NOOP( "Cannot open \"%s\" for writing."), filename);
-                delete [] buffer;
-                return 0;
-        }
-        fwrite (buffer, bitstream.len, 1, fd);
-        fclose(fd);
-        delete [] buffer;
-        return 1;
+		codec = avcodec_find_encoder(CODEC_ID_MJPEG);
+
+		if (codec && avcodec_open(context, codec) < 0)
+			codec = NULL;
+
+		if (codec)
+		{
+			AVPicture picture;
+			int bufferSize = avpicture_fill(&picture, this->data, PIX_FMT_YUV420P, _width, _height);
+			uint8_t *buffer = new uint8_t[bufferSize];
+			AVFrame frame;
+
+			frame.quality = (int)floor(FF_QP2LAMBDA * 3 + 0.5);
+			frame.data[0] = picture.data[0];
+			frame.data[1] = picture.data[2];
+			frame.data[2] = picture.data[1];
+			frame.linesize[0] = picture.linesize[0];
+			frame.linesize[1] = picture.linesize[1];
+			frame.linesize[2] = picture.linesize[2];
+
+			int size = avcodec_encode_video(context, buffer, bufferSize, &frame);
+
+			if (size > 0)
+			{
+				FILE *fd = fopen(filename,"wb");
+
+				if (fd)
+				{
+					fwrite(buffer, size, 1, fd);
+					fclose(fd);
+
+					success = 1;
+				}
+				else
+					GUI_Error_HIG(QT_TR_NOOP("File error"), QT_TR_NOOP("Cannot open \"%s\" for writing."), filename);
+			}
+			else
+				GUI_Error_HIG(QT_TR_NOOP("Cannot encode the frame"), NULL);
+
+			delete [] buffer;
+		}
+	}
+
+	if (!context || !codec)
+		GUI_Error_HIG(QT_TR_NOOP("Cannot initialise JPEG encoder"), NULL);
+
+	if (context)
+		avcodec_close(context);
+	
+	return success;
 }
+
 /**
  *      \fn UI_getPreferredRender
  *      \brief Returns to render lib the user preferred rendering method



From gruntster at mail.berlios.de  Tue Dec 29 23:25:42 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 29 Dec 2009 23:25:42 +0100
Subject: [Avidemux-svn-commit] r5773 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreUI/include
Message-ID: <200912292225.nBTMPgN9031586@sheep.berlios.de>

Author: gruntster
Date: 2009-12-29 23:25:38 +0100 (Tue, 29 Dec 2009)
New Revision: 5773

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreUI/include/DIA_factory.h
Log:
[dlgFactory] increase the number of controls the dialogFactory's frame can host

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreUI/include/DIA_factory.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreUI/include/DIA_factory.h	2009-12-29 22:24:13 UTC (rev 5772)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreUI/include/DIA_factory.h	2009-12-29 22:25:38 UTC (rev 5773)
@@ -573,7 +573,7 @@
   }
 };
 /**********************************************/
-#define DIA_MAX_FRAME 10
+#define DIA_MAX_FRAME 40
 class diaElemFrameBase :public diaElem
 {
 protected:



From gruntster at mail.berlios.de  Tue Dec 29 23:28:55 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 29 Dec 2009 23:28:55 +0100
Subject: [Avidemux-svn-commit] r5774 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: . ADM_codecs
	ADM_encoder ADM_userInterfaces/ADM_commonUI
Message-ID: <200912292228.nBTMStt2031780@sheep.berlios.de>

Author: gruntster
Date: 2009-12-29 23:28:46 +0100 (Tue, 29 Dec 2009)
New Revision: 5774

Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpegEncode.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpegEncode.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg_param.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_mjpeg.cpp
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_requant.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp
Log:
[mjpeg] remove old mjpeg logic

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-29 22:28:46 UTC (rev 5774)
@@ -217,10 +217,6 @@
     case FF_H263P:
       WRAP_Open (CODEC_ID_H263P);
       break;
-    case FF_MJPEG:
-      WRAP_Open (CODEC_ID_MJPEG);
-      break;
-
     default:
       ADM_assert (0);
     }
@@ -655,39 +651,4 @@
     return 0;
 }
 
-uint8_t
-  ffmpegEncoderFFMjpeg::init (uint32_t val, uint32_t fps1000, uint8_t vbr)
-{
-  UNUSED_ARG (val);
-  UNUSED_ARG (vbr);
-  mplayer_init ();
 
-  float f;
-
-  f = val;
-  f = 31. - (29. * f / 100.);
-
-  _qual = (uint32_t) floor (f);
-
-//   _context->frame_rate_base = 1000;
-//   _context->frame_rate = fps1000;
-  _context->time_base = (AVRational)
-  {
-  1000, fps1000};
-  _context->flags = CODEC_FLAG_QSCALE;
-  _context->bit_rate = 0;
-  _context->bit_rate_tolerance = 1024 * 8 * 1000;
-  _context->gop_size = 250;
-  printf ("[LAVCODEC]FF Mjpeg codec initializing %d %% -> q =%d...\n", val, _qual);
-  return initContext ();
-}
-
-
-
-uint8_t
-ffmpegEncoderFFMjpeg::encode (ADMImage * in, ADMBitstream * out)
-{
-  _frame.quality = (int) floor (FF_QP2LAMBDA * _qual + 0.5);
-  return ffmpegEncoder::encode(in,out);
-}
-

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h	2009-12-29 22:28:46 UTC (rev 5774)
@@ -28,7 +28,6 @@
   FF_MPEG4 = 2,
   FF_H263 = 4,
   FF_H263P = 5,
-  FF_MJPEG = 8,
 } FF_CODEC_ID;
 
 /*
@@ -149,27 +148,4 @@
   virtual uint8_t encode (ADMImage * in, ADMBitstream * out);
   virtual ~ ffmpegEncoderVBRExternal ();
 };
-
-class ffmpegEncoderFFMjpeg:public ffmpegEncoder
-{
-protected:uint32_t _qual;
-
-public:ffmpegEncoderFFMjpeg (uint32_t width, uint32_t height,FF_CODEC_ID id)
-    :ffmpegEncoder (width, height,id)
-  {
-    _qual = 4;
-  };
-
-  virtual uint8_t init (uint32_t val, uint32_t fps1000, uint8_t vbr = 0);
-  virtual uint8_t encode (ADMImage * in, ADMBitstream * out);
-  virtual ~ ffmpegEncoderFFMjpeg ()
-  {
-    stopEncoder ();
-
-  }
-};
-
-
-
-
 #endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpegEncode.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpegEncode.cpp	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpegEncode.cpp	2009-12-29 22:28:46 UTC (rev 5774)
@@ -1,129 +0,0 @@
-#if 0
-/***************************************************************************
-                          ADM_mjpegEncode.cpp  -  description
-                             -------------------
-    begin                : Tue Jul 23 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-
-#include <stdio.h>
-#include <stdlib.h>
-#include "ADM_assert.h"
-#include <string.h>
-#include <math.h>
-#include "avi_vars.h"
-#include "prototype.h"
-#include "config.h"
-
-#ifdef USE_MJPEG
-#include "ADM_codecs/ADM_codec.h"
-#include "ADM_colorspace/colorspace.h"
-
-
-extern "C"
-{
-#include "mjpegtools/jpegutils.h"
-}
-
-#include "ADM_codecs/ADM_mjpegEncode.h"
-
-//
-//      The given parameter is the compression ratio of jpeg
-//
-uint8_t
-mjpegEncoder::init (uint32_t val, uint32_t fps1000)
-{
-  UNUSED_ARG (fps1000);
-  _qual = val;
-  return 1;
-}
-uint8_t mjpegEncoder::init (uint32_t val, uint32_t fps1000, uint8_t s)
-{
-  UNUSED_ARG (fps1000);
-  _qual = val;
-  _swap = s;
-  return 1;
-}
-
-uint8_t mjpegEncoder::stopEncoder (void)
-{
-
-  return 1;
-}
- /*
-  * jpeg_data:       buffer with input / output jpeg
-  * len:             Length of jpeg buffer
-  * itype:           LAV_INTER_NONE: Not interlaced
-  *                  LAV_INTER_TOP_FIRST: Interlaced, top-field-first
-  *                  LAV_INTER_BOTTOM_FIRST: Interlaced, bottom-field-first
-  * ctype            Chroma format for decompression.
-  *                  Currently always 420 and hence ignored.
-  * raw0             buffer with input / output raw Y channel
-  * raw1             buffer with input / output raw U/Cb channel
-  * raw2             buffer with input / output raw V/Cr channel
-  * width            width of Y channel (width of U/V is width/2)
-  * height           height of Y channel (height of U/V is height/2)
-
-
-  int decode_jpeg_raw (unsigned char *jpeg_data, int len,
-  int itype, int ctype, int width, int height,
-  unsigned char *raw0, unsigned char *raw1,
-  unsigned char *raw2);
-
-  */
-
-uint8_t
-  mjpegEncoder::encode (uint8_t * in,
-			uint8_t * out, uint32_t * len, uint32_t * flags)
-{
-  uint8_t *y, *u, *v;
-  uint32_t delta;
-  int l;
-
-  //
-  delta = _w * _h;
-  // separate planes
-  y = (uint8_t *) in;
-
-  if (!_swap)
-    {
-      u = y + delta;
-      v = u + (delta >> 2);
-    }
-  else
-    {
-      v = y + delta;
-      u = v + (delta >> 2);
-    }
-
-  l = encode_jpeg_raw ((unsigned char *) out, delta,	// insize /2 , should be enough as buffering
-		       _qual,	// int quality, ??
-		       0, 0,	// ctype /i type
-		       _w, _h, y, u, v);
-  //      printf("\n size: %d",l);
-  *len = l;
-  *flags = AVI_KEY_FRAME;
-
-  return 1;
-}
-
-uint8_t mjpegEncoder::getResult (void *ress)
-{				// for dual pass only
-  ADM_assert (0);
-  UNUSED_ARG (ress);
-
-}
-
-#endif
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpegEncode.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpegEncode.h	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpegEncode.h	2009-12-29 22:28:46 UTC (rev 5774)
@@ -1,39 +0,0 @@
-/***************************************************************************
-                          ADM_mjpegEncode.h  -  description
-                             -------------------
-    begin                : Tue Jul 23 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef __MJPEG_ENC__
-#define   __MJPEG_ENC__
-
-class mjpegEncoder:public encoder
-{
-protected:uint8_t _qual;
-  uint8_t _swap;
-public:  mjpegEncoder (uint32_t width, uint32_t height):encoder (width,
-							    height)
-  {
-    _qual = 75;
-    _swap = 0;
-
-  };
-  uint8_t stopEncoder (void);
-  virtual uint8_t init (uint32_t val, uint32_t fps1000);
-  uint8_t init (uint32_t val, uint32_t fps1000, uint8_t sw);
-  virtual uint8_t encode (uint8_t * in,
-			  uint8_t * out, uint32_t * len, uint32_t * flags);
-
-};
-
-#endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/CMakeLists.txt	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/CMakeLists.txt	2009-12-29 22:28:46 UTC (rev 5774)
@@ -1,5 +1,5 @@
 SET(ADM_codecs_SRCS 
-	ADM_codecs.cpp  ADM_ffmpeg.cpp  ADM_mjpegEncode.cpp
+	ADM_codecs.cpp  ADM_ffmpeg.cpp
 	ADM_ffmp43.cpp  ADM_mjpeg.cpp   ADM_uyvy.cpp)
 
 ADD_ADM_LIB_ALL_TARGETS(ADM_codecs ${ADM_codecs_SRCS})

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h	2009-12-29 22:28:46 UTC (rev 5774)
@@ -114,22 +114,6 @@
   getFFCompressParams
 };
 
-static MJPEGConfig MjpegExtra = { 90, 0 };
-extern uint8_t DIA_mjpegCodecSetting (COMPRES_PARAMS * param);
-COMPRES_PARAMS MjpegCodec = {
-  CodecMjpeg,
-  QT_TR_NOOP("MJPEG (lavc)"),
-  "Mjpeg",
-  "Mjpeg (lavcodec)",
-  COMPRESS_CQ,
-  4, 1500, 700,1000, // AVG
-  ADM_ENC_CAP_CQ,
-  ADM_EXTRA_PARAM,
-  &MjpegExtra,
-  sizeof (MjpegExtra),
-  &DIA_mjpegCodecSetting
-};
-
 #include "ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2enc.h"
 // ************ Mpeg2enc VCD *************
 Mpeg2encParam VCDExtra = {
@@ -253,7 +237,6 @@
   &RequantCodec,
   &yv12codec,
   &ffmpegH263Codec,
-  &MjpegCodec,
   &DUMMYONE
 };
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx	2009-12-29 22:28:46 UTC (rev 5774)
@@ -21,7 +21,6 @@
 {
   CodecCopy,
   CodecFF,
-  CodecMjpeg,
   CodecH263,
   CodecH263P,
   CodecVCD,

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt	2009-12-29 22:28:46 UTC (rev 5774)
@@ -1,5 +1,5 @@
 SET(ADM_encoder_SRCS 
-	adm_encConfig.cpp  adm_encmjpeg.cpp     adm_encoder.cpp
+	adm_encConfig.cpp  adm_encoder.cpp
 	adm_encCopy.cpp    adm_encffmpeg.cpp   adm_encmpeg2enc.cpp  adm_encRequant.cpp  adm_encyv12.cpp
 	ADM_pluginLoad.cpp ADM_externalEncoder.cpp)
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2009-12-29 22:28:46 UTC (rev 5774)
@@ -51,8 +51,6 @@
 #include "ADM_codecs/ADM_ffmpeg.h"
 #include "adm_encffmpeg.h"
 
-#include "ADM_codecs/ADM_mjpegEncode.h"
-#include "adm_encmjpeg.h"
 #include "adm_encCopy.h"
 #include "adm_encyv12.h"
 #include "adm_encmpeg2enc.h"
@@ -598,9 +596,6 @@
 	case CodecFF:
 		e = new EncoderFFMPEG (FF_MPEG4, desc);
 		break;
-	case CodecMjpeg:
-		e = new EncoderMjpeg (desc);
-		break;
 	case CodecH263:
 		if (!((w == 128) && (h == 96)) && !((w == 176) && (h == 144)))
 		{

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.cpp	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.cpp	2009-12-29 22:28:46 UTC (rev 5774)
@@ -1,131 +0,0 @@
-/***************************************************************************
-                          adm_encmjpeg.cpp  -  description
-                             -------------------
-    begin                : Tue Jul 23 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include "config.h"
-
-#include <stdio.h>
-#include <stdlib.h>
-#include <math.h>
-#include <unistd.h>
-
-
-#include <time.h>
-#include <sys/time.h>
-
-#ifdef USE_FFMPEG
-#include "ADM_lavcodec.h"
-#include "fourcc.h"
-#include "avi_vars.h"
-
-#include "ADM_assert.h"
-#include "ADM_encoder/ADM_vidEncode.hxx"
-
-
-#include "ADM_videoFilter.h"
-#include "ADM_codecs/ADM_ffmpeg.h"
-
-#include "ADM_encoder/adm_encoder.h"
-
-
-
-#include "ADM_codecs/ADM_mjpegEncode.h"
-
-
-#include "ADM_encoder/adm_encmjpeg.h"
-
-extern int getMjpegCompressParams (int *qual, int *swap);
-
-/*_________________________________________________*/
-EncoderMjpeg::EncoderMjpeg (COMPRES_PARAMS * conf)
-{
-  _codec = NULL;
-  fd = NULL;
-  entries = NULL;
-  strcpy (_logname, "");
-  _frametogo = 0;
-  MJPEGConfig *cf = (MJPEGConfig *) conf->extraSettings;
-  ADM_assert (sizeof (MJPEGConfig) == conf->extraSettingsLen);
-  _q = cf->qual;
-  _swapped = cf->swapped;
-};
-//--------------------------------
-uint8_t
-EncoderMjpeg::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
-{
-  ADV_Info *info;
-//         int q,s;
-
-  ADM_assert (instream);
-  _in = instream;
-
-  info = instream->getInfo ();
-  _w = info->width;
-  _h = info->height;
-
-
-//              _vbuffer=new uint8_t[_w*_h*3];
-  _vbuffer = new ADMImage (_w, _h);
-  ADM_assert (_vbuffer);
-
-  //   _codec=new mjpegEncoder(_w,_h);
-  _codec = new ffmpegEncoderFFMjpeg (_w, _h, FF_MJPEG);
-
-  _codec->init (_q, info->fps1000, 0);
-
-  return 1;
-}
-
-int EncoderMjpeg::getRequirements (void) { return _codec->capabilities; }
-
-
-
-//______________________________
-uint8_t
-EncoderMjpeg::encode (uint32_t frame, ADMBitstream *out)
-{
-  uint32_t l, f;
-
-
-  ADM_assert (_codec);
-  ADM_assert (_in);
-
-  if (!_in->getFrameNumberNoAlloc (frame, &l, _vbuffer, &f))
-    {
-      printf ("\n Error : Cannot read incoming frame !");
-      return 0;
-    }
-  return _codec->encode (_vbuffer, out);
-}
-
-//_______________________________
-uint8_t
-EncoderMjpeg::stop (void)
-{
-  delete _codec;
-  _codec = 0;
-  return 1;
-
-}
-
-uint8_t
-EncoderMjpeg::setLogFile (const char *p, uint32_t fr)
-{				// for dual pass only
-
-  UNUSED_ARG (p);
-  UNUSED_ARG (fr);
-  return 1;
-}
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.h	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.h	2009-12-29 22:28:46 UTC (rev 5774)
@@ -1,67 +0,0 @@
-/***************************************************************************
-                          adm_encmjpeg.h  -  description
-                             -------------------
-    begin                : Tue Jul 23 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef __ADM_encoder_mjpeg__
-#define __ADM_encoder_mjpeg__
-
-#ifdef USE_FFMPEG
-#include "ADM_encoder/adm_encmjpeg_param.h"
-
-class EncoderMjpeg:public Encoder
-{
-
-protected:
-
-  ffmpegEncoderFFMjpeg * _codec;
-  uint32_t _q;
-  uint8_t _swapped;
-public:
-    EncoderMjpeg (COMPRES_PARAMS * conf);
-  virtual int getRequirements (void);
-  virtual uint8_t isDualPass (void)
-  {
-    return 0;
-  };				// mjpeg is always monopass
-  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
-  virtual uint8_t encode (uint32_t frame, ADMBitstream *out);
-  virtual uint8_t setLogFile (const char *p, uint32_t fr);	// for dual pass only
-  virtual uint8_t stop (void);
-  virtual uint8_t startPass2 (void)
-  {
-    assert (0);
-  };				// for dual pass only
-  virtual uint8_t startPass1 (void)
-  {
-    assert (0);
-  };				// for dual pass only
-  virtual const char *getCodecName (void)
-  {
-    return "MJPG";
-  }
-  virtual const char *getFCCHandler (void)
-  {
-    return "MJPG";
-  }
-  virtual const char *getDisplayName (void)
-  {
-    return QT_TR_NOOP("MJPEG");
-  }
-};
-
-
-#endif
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg_param.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg_param.h	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg_param.h	2009-12-29 22:28:46 UTC (rev 5774)
@@ -1,28 +0,0 @@
-/***************************************************************************
-                          adm_encmjpeg.h  -  description
-                             -------------------
-    begin                : Tue Jul 23 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef __ADM_encoder_mjpegP__
-#define __ADM_encoder_mjpegP__
-
-typedef struct MJPEGConfig
-{
-
-  uint32_t qual;
-  uint32_t swapped;
-} MJPEGConfig;
-
-#endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.cpp	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.cpp	2009-12-29 22:28:46 UTC (rev 5774)
@@ -14,45 +14,11 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#include "config.h"
 
-#include <time.h>
-#include <sys/time.h>
-
-#include "DIA_uiTypes.h"
-#include "gui_action.hxx"
-#ifdef USE_FFMPEG
-#include "ADM_lavcodec.h"
-#endif
-
-#include "fourcc.h"
-#include "avi_vars.h"
-
 #include "ADM_assert.h"
-
 #include "ADM_encoder/ADM_vidEncode.hxx"
-
-#include "ADM_videoFilter.h"
 #include "ADM_encoder/adm_encoder.h"
 
-#ifdef USE_FFMPEG
-#include "ADM_codecs/ADM_ffmpeg.h"
-#include "ADM_encoder/adm_encffmpeg.h"
-#endif
-
-#ifdef USE_FFMPEG
-#include "ADM_codecs/ADM_mjpegEncode.h"
-#include "ADM_encoder/adm_encmjpeg.h"
-#endif
-
-#include "ADM_encoder/adm_encCopy.h"
-
-
-static uint8_t nb_encoder = 0;
-
-
-
-//----------------------------------
 Encoder::~Encoder (void)
 {
 #define CLEAN(x) if(x) { delete [] x;x=NULL;}
@@ -64,22 +30,3 @@
   CLEAN (entries);
 
 }
-//---------------------------------
-void
-register_Encoders (void)
-{
-  printf ("\n Registering Encoders\n");
-  printf ("*********************\n");
-
-#ifdef USE_FFMPEG
-  nb_encoder++;
-  printf ("MJPEG encoder registered\n");
-#endif
-
-#ifdef USE_FFMPEG
-  nb_encoder++;
-  printf ("FFmpeg encoder registered\n");
-#endif
-
-  printf ("\n%d encoder(s) registered\n", nb_encoder);
-}

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt	2009-12-29 22:28:46 UTC (rev 5774)
@@ -1,7 +1,6 @@
 SET(ADM_LIB ADM_commonUI)
 
 SET(${ADM_LIB}_SRCS
-DIA_mjpeg.cpp     
 DIA_resizeWiz.cpp  
 DIA_v2v.cpp
 DIA_audioFilter.cpp   

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_mjpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_mjpeg.cpp	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_mjpeg.cpp	2009-12-29 22:28:46 UTC (rev 5774)
@@ -1,41 +0,0 @@
-/*
-    Dialog for lavcodec based Mpeg1/mpeg2 codec
-
-
-*/
-
-#include "config.h"
-#include "ADM_default.h"
-
-#include "ADM_lavcodec.h"
-
-
-#include "ADM_codecs/ADM_codec.h"
-#include "ADM_encoder/ADM_vidEncode.hxx"
-#include "ADM_codecs/ADM_ffmpegConfig.h"
-#include "DIA_factory.h"
-
-#include "../../ADM_encoder/adm_encmjpeg_param.h"
-
-/**
-      \fn DIA_mjpegCodecSetting
-      \brief Dialog to set encoding options for Mjpeg lavcodec based
-*/
-//____________________________________________
-uint8_t DIA_mjpegCodecSetting(COMPRES_PARAMS *param)
-{
-        MJPEGConfig *config=(MJPEGConfig *)param->extraSettings;
-        ADM_assert(sizeof(MJPEGConfig)==param->extraSettingsLen);
-        uint8_t ret=0;
-        diaElemUInteger  qual(&(config->qual),QT_TR_NOOP("_Quality:"),1,100);
-        diaElemToggle    swap(&(config->swapped),QT_TR_NOOP("_Swap U&V"));
-        diaElem *elems[2]={&qual,&swap};
-        if( diaFactoryRun(QT_TR_NOOP("MJPEG Configuration"),2,elems))
-        {
-            ret=1;
-        }
-        return ret;
-        
-}   
-// EOF
-

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_requant.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_requant.cpp	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_requant.cpp	2009-12-29 22:28:46 UTC (rev 5774)
@@ -16,7 +16,6 @@
 
   
 #include "DIA_factory.h"
-#include "../../ADM_encoder/adm_encmjpeg_param.h"
 
 /**
       \fn DIA_mjpegCodecSetting

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp	2009-12-29 22:25:38 UTC (rev 5773)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp	2009-12-29 22:28:46 UTC (rev 5774)
@@ -53,7 +53,6 @@
 
 extern void registerVideoFilters( void );
 extern void filterCleanUp( void );
-extern void register_Encoders( void )  ;
 
 extern uint8_t initGUI( void );
 extern void destroyGUI(void);
@@ -179,8 +178,6 @@
 	prefs->load();
     CpuCaps::init();
 
-	register_Encoders();
-
 #ifdef USE_SDL
 	uint32_t videoDevice = RENDER_LAST;
 



From gruntster at mail.berlios.de  Tue Dec 29 23:43:06 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 29 Dec 2009 23:43:06 +0100
Subject: [Avidemux-svn-commit] r5775 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui
Message-ID: <200912292243.nBTMh6kg032740@sheep.berlios.de>

Author: gruntster
Date: 2009-12-29 23:43:02 +0100 (Tue, 29 Dec 2009)
New Revision: 5775

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui
Log:
[qt] increase number of visible items for comboboxes on main Qt gui

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui	2009-12-29 22:28:46 UTC (rev 5774)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui	2009-12-29 22:43:02 UTC (rev 5775)
@@ -177,6 +177,9 @@
                   <verstretch>0</verstretch>
                  </sizepolicy>
                 </property>
+                <property name="maxVisibleItems" >
+                 <number>20</number>
+                </property>
                 <item>
                  <property name="text" >
                   <string>Copy</string>
@@ -338,6 +341,9 @@
                   <verstretch>0</verstretch>
                  </sizepolicy>
                 </property>
+                <property name="maxVisibleItems" >
+                 <number>20</number>
+                </property>
                 <item>
                  <property name="text" >
                   <string>Copy</string>
@@ -531,6 +537,9 @@
                 <verstretch>0</verstretch>
                </sizepolicy>
               </property>
+              <property name="maxVisibleItems" >
+               <number>20</number>
+              </property>
              </widget>
             </item>
            </layout>



From gruntster at mail.berlios.de  Wed Dec 30 14:14:31 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 30 Dec 2009 14:14:31 +0100
Subject: [Avidemux-svn-commit] r5776 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: .
	ADM_libraries/ADM_utilities ADM_userInterfaces/ADM_commonUI
Message-ID: <200912301314.nBUDEVYe028427@sheep.berlios.de>

Author: gruntster
Date: 2009-12-30 14:14:26 +0100 (Wed, 30 Dec 2009)
New Revision: 5776

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/prefs.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/prefs.h
   branches/avidemux_2.5_branch_gruntster/avidemux/prefs.in
Log:
[pref] remove unnecessary external filter options from preferences window

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/prefs.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/prefs.cpp	2009-12-29 22:43:02 UTC (rev 5775)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/prefs.cpp	2009-12-30 13:14:26 UTC (rev 5776)
@@ -133,8 +133,6 @@
 	{"feature.auto_rebuildindex",		UINT,	"0",	NULL,	"0",	"1"	},
 	{"feature.auto_unpack",		UINT,	"0",	NULL,	"0",	"1"	},
 	{"downmixing.prologic",		UINT,	"2",	NULL,	"0",	"2"	},
-	{"filters.autoload.path",		STRING,"/tmp/",NULL, NULL, NULL },
-	{"filters.autoload.active",		UINT,	"0",	NULL,	"0",	"1"	},
 	{"feature.alternate_mp3_tag",		UINT,	"1",	NULL,	"0",	"1"	},
 	{"feature.global_glyph.active",		UINT,	"1",	NULL,	"0",	"1"	},
 	{"feature.global_glyph.name",		STRING,"",	NULL, NULL, NULL },
@@ -143,7 +141,7 @@
 	{"priority.playback",		UINT,	"0",	NULL,	"0",	"4"	}
 };
 
-int num_opts = 79;
+int num_opts = 77;
 // </prefs_gen>
 
 #ifdef USE_LIBXML2

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp	2009-12-29 22:43:02 UTC (rev 5775)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp	2009-12-30 13:14:26 UTC (rev 5776)
@@ -57,9 +57,7 @@
 uint32_t downmix;
 uint32_t mpeg_no_limit=0;
 uint32_t msglevel=2;
-uint32_t activeXfilter=0;
 uint32_t mixer=0;
-char     *filterPath=NULL;
 char     *alsaDevice=NULL;
 uint32_t autovbr=0;
 uint32_t autoindex=0;
@@ -162,8 +160,6 @@
                 useNuv=0;
         // Get level of message verbosity
         prefs->get(MESSAGE_LEVEL,&msglevel);
-        // External filter
-         prefs->get(FILTERS_AUTOLOAD_ACTIVE,&activeXfilter);
         // Downmix default
         if(prefs->get(DOWNMIXING_PROLOGIC,&downmix)!=RC_OK)
         {       
@@ -306,17 +302,6 @@
      framePP.swallow(&fdring);
      framePP.swallow(&postProcStrength);
      
-        // Filter path
-        if( prefs->get(FILTERS_AUTOLOAD_PATH, &filterPath) != RC_OK )
-#ifndef __WIN32
-               filterPath = ADM_strdup("/tmp");
-#else
-               filterPath = ADM_strdup("c:\\");
-#endif
-        diaElemDirSelect  entryFilterPath(&filterPath,QT_TR_NOOP("_Filter directory:"),QT_TR_NOOP("Select filter directory"));
-		diaElemToggle loadEx(&activeXfilter,QT_TR_NOOP("_Load external filters"));
-		loadEx.link(1, &entryFilterPath);
-
 		diaElemToggle togGlobalGlyph(&useGlobalGlyph, QT_TR_NOOP("Use _Global GlyphSet"));
 		diaElemFile  entryGLyphPath(0,&globalGlyphName,QT_TR_NOOP("Gl_yphSet:"), NULL, QT_TR_NOOP("Select GlyphSet file"));
 		togGlobalGlyph.link(1, &entryGLyphPath);
@@ -369,13 +354,9 @@
         diaElem *diaGlyph[]={&togGlobalGlyph,&entryGLyphPath};
         diaElemTabs tabGlyph(QT_TR_NOOP("Global GlyphSet"),2,(diaElem **)diaGlyph);
 
-        /* Xfilter tab */
-        diaElem *diaXFilter[]={&loadEx,&entryFilterPath};
-        diaElemTabs tabXfilter(QT_TR_NOOP("External Filters"),2,(diaElem **)diaXFilter);
-                                    
 // SET
-        diaElemTabs *tabs[]={&tabUser,&tabAuto,&tabInput,&tabOutput,&tabAudio,&tabVideo,&tabCpu,&tabThreading,&tabGlyph,&tabXfilter};
-        if( diaFactoryRunTabs(QT_TR_NOOP("Preferences"),10,tabs))
+        diaElemTabs *tabs[]={&tabUser,&tabAuto,&tabInput,&tabOutput,&tabAudio,&tabVideo,&tabCpu,&tabThreading,&tabGlyph};
+        if( diaFactoryRunTabs(QT_TR_NOOP("Preferences"),9,tabs))
 	{
         	
         	// cpu caps
@@ -465,11 +446,7 @@
                 prefs->set(FEATURE_DISABLE_NUV_RESYNC, useNuv);
                 // Use tray while encoding
                 prefs->set(FEATURE_USE_SYSTRAY,useTray);
-                // Filter directory
-				prefs->set(FILTERS_AUTOLOAD_ACTIVE, activeXfilter);
 
-                if(filterPath)
-                  prefs->set(FILTERS_AUTOLOAD_PATH, filterPath);
                 // Alternate mp3 tag (haali)
                 prefs->set(FEATURE_ALTERNATE_MP3_TAG,alternate_mp3_tag);
 
@@ -484,7 +461,6 @@
             delete audioDeviceItems[i];
         }
 
-	ADM_dealloc(filterPath);
 	ADM_dealloc(globalGlyphName);
 
 	return 1;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/prefs.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/prefs.h	2009-12-29 22:43:02 UTC (rev 5775)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/prefs.h	2009-12-30 13:14:26 UTC (rev 5776)
@@ -79,8 +79,6 @@
 	FEATURE_AUTO_REBUILDINDEX,
 	FEATURE_AUTO_UNPACK,
 	DOWNMIXING_PROLOGIC,
-	FILTERS_AUTOLOAD_PATH,
-	FILTERS_AUTOLOAD_ACTIVE,
 	FEATURE_ALTERNATE_MP3_TAG,
 	FEATURE_GLOBAL_GLYPH_ACTIVE,
 	FEATURE_GLOBAL_GLYPH_NAME,

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/prefs.in
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/prefs.in	2009-12-29 22:43:02 UTC (rev 5775)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/prefs.in	2009-12-30 13:14:26 UTC (rev 5776)
@@ -96,8 +96,6 @@
 feature.auto_unpack,                    UINT,   0,      0,      1
 # prologic 1/2
 downmixing.prologic,			UINT,	2,	0,	2
-filters.autoload.path,                  STRING, "/tmp/"
-filters.autoload.active,                UINT,   0,      0,      1
 feature.alternate_mp3_tag,              UINT,   1,      0,      1
 # Global glyphset file
 feature.global_glyph.active,            UINT,   1,      0,      1



From gruntster at mail.berlios.de  Wed Dec 30 19:15:24 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 30 Dec 2009 19:15:24 +0100
Subject: [Avidemux-svn-commit] r5777 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec
Message-ID: <200912301815.nBUIFOvA018858@sheep.berlios.de>

Author: gruntster
Date: 2009-12-30 19:15:14 +0100 (Wed, 30 Dec 2009)
New Revision: 5777

Added:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/H263Param.xsd
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.h
Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
Log:
[h263] avcodec H.263 video plugin

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-30 13:14:26 UTC (rev 5776)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-30 18:15:14 UTC (rev 5777)
@@ -11,13 +11,15 @@
 SET(ADM_vidEnc_avcodec_SRCS  interface.c  encoder.cpp  huffyuvEncoder.cpp
 							 ffvhuffEncoder.cpp  ffv1Encoder.cpp  dvEncoder.cpp  ../common/PluginOptions.cpp
 							 mpeg1Encoder.cpp  mpeg1EncoderOptions.cpp  mpeg2Encoder.cpp  mpeg2EncoderOptions.cpp
-							 flv1Encoder.cpp  flv1EncoderOptions.cpp  mjpegEncoder.cpp  mjpegEncoderOptions.cpp)
+							 flv1Encoder.cpp  flv1EncoderOptions.cpp  mjpegEncoder.cpp  mjpegEncoderOptions.cpp
+							 h263Encoder.cpp  h263EncoderOptions.cpp)
 
 set(PLUGIN_SCHEMA_DIR "avcodec")
 set(MPEG1_PLUGIN_CONFIG_DIR "avcodec/mpeg-1")
 set(MPEG2_PLUGIN_CONFIG_DIR "avcodec/mpeg-2")
 set(FLV1_PLUGIN_CONFIG_DIR "avcodec/flv1")
 set(MJPEG_PLUGIN_CONFIG_DIR "avcodec/mjpeg")
+set(MJPEG_PLUGIN_CONFIG_DIR "avcodec/h263")
 
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${LIBXML2_INCLUDE_DIR})
 ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_SCHEMA_DIR="${PLUGIN_SCHEMA_DIR}")
@@ -25,6 +27,7 @@
 set_property(SOURCE mpeg2EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMPEG2_PLUGIN_CONFIG_DIR=\\\"${MPEG2_PLUGIN_CONFIG_DIR}\\\")
 set_property(SOURCE flv1EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DFLV1_PLUGIN_CONFIG_DIR=\\\"${FLV1_PLUGIN_CONFIG_DIR}\\\")
 set_property(SOURCE mjpegEncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMJPEG_PLUGIN_CONFIG_DIR=\\\"${MJPEG_PLUGIN_CONFIG_DIR}\\\")
+set_property(SOURCE h263EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DH263_PLUGIN_CONFIG_DIR=\\\"${H263_PLUGIN_CONFIG_DIR}\\\")
 
 getFfmpegLibNames(${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_libraries/ffmpeg)
 
@@ -42,4 +45,5 @@
 INSTALL(FILES Mpeg1Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
 INSTALL(FILES Mpeg2Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
 INSTALL(FILES Flv1Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
-INSTALL(FILES MjpegParam.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
\ No newline at end of file
+INSTALL(FILES MjpegParam.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
+INSTALL(FILES H263Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/H263Param.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/H263Param.xsd	2009-12-30 13:14:26 UTC (rev 5776)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/H263Param.xsd	2009-12-30 18:15:14 UTC (rev 5777)
@@ -0,0 +1,132 @@
+<?xml version="1.0" encoding="utf-8"?>
+<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified">
+  <xs:element name="H263Config">
+    <xs:complexType>
+      <xs:sequence>
+        <xs:element name="presetConfiguration" minOccurs="0">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="name" type="xs:string"/>
+              <xs:element name="type">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="default"/>
+                    <xs:enumeration value="user"/>
+                    <xs:enumeration value="system"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+        <xs:element name="encodeOptions" minOccurs="0">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="mode">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="CQP"/>
+                    <xs:enumeration value="2PASS SIZE"/>
+                    <xs:enumeration value="2PASS ABR"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="parameter" type="uint"/>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+        <xs:element name="H263Options">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="motionEstimationMethod">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="none"/>
+                    <xs:enumeration value="full"/>
+                    <xs:enumeration value="log"/>
+                    <xs:enumeration value="phods"/>
+                    <xs:enumeration value="epzs"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="fourMotionVector" type="xs:boolean" minOccurs="0"/>
+              <xs:element name="maximumBFrames" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="0"/>
+                    <xs:maxInclusive value="32"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="quarterPixel" type="xs:boolean" minOccurs="0"/>
+              <xs:element name="globalMotionCompensation" type="xs:boolean" minOccurs="0"/>
+              <xs:element name="quantisationType">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="h263"/>
+                    <xs:enumeration value="mpeg"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="macroblockDecisionMode">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="sad"/>
+                    <xs:enumeration value="fewestBits"/>
+                    <xs:enumeration value="rateDistortion"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="minimumQuantiser" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="1"/>
+                    <xs:maxInclusive value="31"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="maximumQuantiser" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="1"/>
+                    <xs:maxInclusive value="31"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="quantiserDifference" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="1"/>
+                    <xs:maxInclusive value="31"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="trellis" type="xs:boolean" minOccurs="0"/>
+              <xs:element name="quantiserCompression" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:float">
+                    <xs:minInclusive value="0"/>
+                    <xs:maxInclusive value="1"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="quantiserBlur" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:float">
+                    <xs:minInclusive value="0"/>
+                    <xs:maxInclusive value="1"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+      </xs:sequence>
+    </xs:complexType>
+  </xs:element>
+  <xs:simpleType name="uint">
+    <xs:restriction base="xs:integer">
+      <xs:minInclusive value="0"/>
+    </xs:restriction>
+  </xs:simpleType>
+</xs:schema>

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2009-12-30 13:14:26 UTC (rev 5776)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2009-12-30 18:15:14 UTC (rev 5777)
@@ -20,6 +20,7 @@
 #include "flv1Encoder.h"
 #include "ffv1Encoder.h"
 #include "ffvhuffEncoder.h"
+#include "h263Encoder.h"
 #include "huffyuvEncoder.h"
 #include "mjpegEncoder.h"
 #include "mpeg1Encoder.h"
@@ -32,13 +33,14 @@
 static FLV1Encoder flv1;
 static FFV1Encoder ffv1;
 static FFVHuffEncoder ffvhuff;
+static H263Encoder h263;
 static HuffyuvEncoder huffyuv;
 static MjpegEncoder mjpeg;
 static Mpeg1Encoder mpeg1;
 static Mpeg2Encoder mpeg2;
 
-static int encoderIds[] = { 0, 1, 2, 3, 4, 5, 6, 7 };
-static AvcodecEncoder* encoders[] = { &dv, &flv1, &ffv1, &ffvhuff, &huffyuv, &mjpeg, &mpeg1, &mpeg2};
+static int encoderIds[] = { 0, 1, 2, 3, 4, 5, 6, 7, 8 };
+static AvcodecEncoder* encoders[] = { &dv, &flv1, &ffv1, &ffvhuff, &h263, &huffyuv, &mjpeg, &mpeg1, &mpeg2};
 
 extern "C"
 {

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.cpp	2009-12-30 13:14:26 UTC (rev 5776)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.cpp	2009-12-30 18:15:14 UTC (rev 5777)
@@ -0,0 +1,580 @@
+ /***************************************************************************
+                              h263Encoder.cpp
+
+    begin                : Wed Dec 30 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+ /**************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include <sstream>
+#include <string>
+#include <libxml/tree.h>
+
+#include "ADM_inttype.h"
+#include "DIA_coreToolkit.h"
+#include "h263Encoder.h"
+
+extern int _uiType;
+static bool changedConfig(const char* fileName, ConfigMenuType configType);
+static char *serializeConfig(void);
+static H263Encoder *encoder = NULL;
+
+#ifdef __WIN32
+extern void convertPathToAnsi(const char *path, char **ansiPath);
+#endif
+
+H263Encoder::H263Encoder(void)
+{
+	encoder = this;
+
+	init(CODEC_ID_H263, ADM_CSP_YV12);
+
+	_encodeOptions.structSize = sizeof(vidEncOptions);
+	_encodeOptions.encodeMode = H263_DEFAULT_ENCODE_MODE;
+	_encodeOptions.encodeModeParameter = H263_DEFAULT_ENCODE_MODE_PARAMETER;
+
+	_bitrateParam.capabilities = ADM_ENC_CAP_CBR | ADM_ENC_CAP_CQ | ADM_ENC_CAP_2PASS | ADM_ENC_CAP_2PASS_BR;
+	_bitrateParam.qz = H263_DEFAULT_ENCODE_MODE_PARAMETER;
+	_bitrateParam.bitrate = 1500;
+	_bitrateParam.avg_bitrate = 1000;
+	_bitrateParam.finalsize = 700;
+
+	_statFile = NULL;
+}
+
+int H263Encoder::initContext(const char* logFileName)
+{
+	int ret = AvcodecEncoder::initContext(logFileName);
+
+	_context->me_method = (int)_options.getMotionEstimationMethod();
+
+	if (_options.get4MotionVector())
+		_context->flags |= CODEC_FLAG_4MV;
+
+	_context->max_b_frames = _options.getMaxBFrames();
+
+	if (_options.getQuarterPixel())
+		_context->flags |= CODEC_FLAG_QPEL;
+	
+	if (_options.getGmc())
+		_context->flags |= CODEC_FLAG_GMC;
+
+	_context->mpeg_quant = (int)_options.getQuantisationType();
+
+	switch (_options.getMbDecisionMode())
+	{
+		case H263_MBDEC_BITS:
+			_context->mb_decision = FF_MB_DECISION_BITS;
+			break;
+		case H263_MBDEC_RD:
+			_context->mb_decision = FF_MB_DECISION_RD;
+			break;
+		default:
+			_context->mb_decision = FF_MB_DECISION_SIMPLE;
+			_context->mb_cmp = FF_CMP_SAD;
+	}
+
+	_context->qmin = _options.getMinQuantiser();
+	_context->qmax = _options.getMaxQuantiser();
+	_context->max_qdiff = _options.getQuantiserDifference();
+	_context->trellis = _options.getTrellis();
+	_context->qcompress = _options.getQuantiserCompression();
+	_context->qblur = _options.getQuantiserBlur();
+
+	_context->lumi_masking = 0.05;
+	_context->dark_masking = 0.01;
+	_context->rc_qsquish = 1.0;
+	_context->luma_elim_threshold = -2;
+	_context->chroma_elim_threshold = -5;
+	_context->i_quant_factor = 0.8;
+	_context->bit_rate_tolerance = 1024 * 8 * 1000;
+	_context->gop_size = 250;
+
+	if (_currentPass == 1)
+	{
+		if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_CBR)
+			_context->bit_rate = _encodeOptions.encodeModeParameter * 1000;
+		else
+		{
+			_context->bit_rate = 0;
+			_context->flags |= CODEC_FLAG_QSCALE;
+		}
+
+		if (_passCount > 1)
+			_context->flags |= CODEC_FLAG_PASS1;
+	}
+	else
+	{
+		_context->flags |= CODEC_FLAG_PASS2;
+
+		if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE)
+			_context->bit_rate = calculateBitrate(_fpsNum, _fpsDen, _frameCount, _encodeOptions.encodeModeParameter);
+		else
+			_context->bit_rate = _encodeOptions.encodeModeParameter * 1000;
+	}
+
+	if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE || _encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_ABR)
+	{
+		char *log = NULL;
+
+#ifdef __WIN32
+		convertPathToAnsi(logFileName, &log);
+#else
+		log = new char[strlen(logFileName) + 1];
+		strcpy(log, logFileName);
+#endif
+
+		if (_currentPass == 1)
+		{
+			_statFile = fopen(log, "wb");
+
+			if (!_statFile)
+				ret = ADM_VIDENC_ERR_FAILED;
+		}
+		else
+		{
+			FILE *statFile = fopen(log, "rb");
+
+			if (statFile)
+			{
+				fseek(statFile, 0, SEEK_END);
+
+				long statSize = ftello(statFile);
+
+				fseek(statFile, 0, SEEK_SET);
+				_context->stats_in = new char[statSize + 1];
+				_context->stats_in[statSize] = 0;
+
+				fread(_context->stats_in, statSize, 1, statFile);
+				fclose(statFile);
+			}
+			else
+				ret = ADM_VIDENC_ERR_FAILED;
+		}
+	}
+
+	return ret;
+}
+
+const char* H263Encoder::getEncoderType(void)
+{
+	return "H.263";
+}
+
+const char* H263Encoder::getEncoderDescription(void)
+{
+	return "H.263 video encoder plugin for Avidemux (c) Mean/Gruntster";
+}
+
+const char* H263Encoder::getFourCC(void)
+{
+	return "H263";
+}
+
+const char* H263Encoder::getEncoderGuid(void)
+{
+	return "4279DF66-ECEF-4d3d-AFEA-1BFCCB79E219";
+}
+
+int H263Encoder::isConfigurable(void)
+{
+	return (_uiType == ADM_UI_GTK || _uiType == ADM_UI_QT4);
+}
+
+int H263Encoder::configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties)
+{
+	loadSettings(&_encodeOptions, &_options);
+
+	diaMenuEntry meE[] = {
+		{0, "None"},
+		{1, "Full"},
+		{2, "Log"},
+		{3, "Phods"},
+		{4, "EPZS"}};
+
+	diaMenuEntry qzE[] = {
+		{0, "H.263"},
+		{1, "MPEG"}};
+
+	diaMenuEntry rdE[] = {
+		{0, "Sum of Absolute Differences"},
+		{1, "Fewest Bits"},
+		{2, "Rate Distortion"}};
+
+	// Encoding mode
+	diaElemBitrate ctlBitrate(&_bitrateParam, NULL);
+		
+	diaElem *diamode[] = {&ctlBitrate};
+	diaElemTabs tabMode("Encoding Mode", 1, diamode);
+
+	// Motion Estimation
+	diaElemMenu ctlMatrices(&_motionEst, "Motion Estimation Method:", 5, meE);
+	diaElemUInteger ctlMaxBFrames(&_maxBFrames, "_Maximum Consecutive B-frames:", 0, 32);
+	diaElemToggle ctl4MV(&_4MV, "4 _Motion Vector");
+	diaElemToggle ctlQpel(&_qpel, "_Quarter Pixel");
+	diaElemToggle ctlGmc(&_gmc, "_Global Motion Compensation");
+
+	diaElem *diaME[] = {&ctlMatrices, &ctlMaxBFrames, &ctl4MV, &ctlQpel, &ctlGmc};
+	diaElemTabs tabME("Motion Estimation", 5, diaME);
+
+	// Quantisation
+	diaElemMenu ctlQuantType(&_quantType, "_Quantisation Type:", 2, qzE);
+	diaElemMenu ctlMbDecision(&_mbDecision, "_Macroblock Decision Mode:", 3, rdE);
+	diaElemUInteger ctlQuantMin(&_minQuantiser, "Mi_nimum Quantiser:", 1, 31);
+	diaElemUInteger ctlQuantMax(&_maxQuantiser, "Ma_ximum Quantiser:", 1, 31);
+	diaElemUInteger ctlQuantDiff(&_maxQuantiserDiff, "Maximum Quantiser _Difference:", 1, 31);
+	diaElemFloat ctlQuantCompression(&_quantCompression, "_Quantiser Compression:", 0, 1);
+	diaElemFloat ctlQuantBlur(&_quantBlur, "Quantiser _Blur:", 0, 1);
+	diaElemToggle ctlTrellis(&_trellis, "_Trellis Quantisation");
+
+	diaElem *diaQze[] = {&ctlQuantType, &ctlMbDecision, &ctlQuantMin, &ctlQuantMax, &ctlQuantDiff, &ctlQuantCompression, &ctlQuantBlur, &ctlTrellis};
+	diaElemTabs tabQz("Quantisation", 8, diaQze);
+
+	diaElemTabs *tabs[] = {&tabMode, &tabME, &tabQz};
+	int controlCount = 0;
+
+	for (int i = 0; i < 3; i++)
+		controlCount += tabs[i]->nbElems;
+
+	diaElem *diaAll[controlCount];
+	int controlIndex = 0;
+
+	for (int i = 0; i < 3; i++)
+	{
+		for (int j = 0; j < tabs[i]->nbElems; j++)
+		{
+			diaAll[controlIndex] = tabs[i]->dias[j];
+			controlIndex++;
+		}
+	}
+
+	diaElemConfigMenu ctlConfigMenu(configName, &configType, _options.getUserConfigDirectory(), _options.getSystemConfigDirectory(),
+		changedConfig, serializeConfig, diaAll, controlCount);
+	diaElem *elmHeader[] = {&ctlConfigMenu};
+
+	if (diaFactoryRunTabs("avcodec H.263 Configuration", 1, elmHeader, 3, tabs))
+	{
+		saveSettings(&_encodeOptions, &_options);
+		updateEncodeProperties(&_encodeOptions);
+
+		return 1;
+	}
+
+	return 0;
+}
+
+void H263Encoder::loadSettings(vidEncOptions *encodeOptions, H263EncoderOptions *options)
+{
+	char *configurationName;
+
+	options->getPresetConfiguration(&configurationName, (PluginConfigType*)&configType);
+
+	if (configurationName)
+	{
+		strcpy(this->configName, configurationName);
+		delete [] configurationName;
+	}
+
+	if (encodeOptions)
+	{
+		_motionEst = (H263MotionEstimationMethod)(options->getMotionEstimationMethod() - 1);
+		_4MV = options->get4MotionVector();
+		_maxBFrames = options->getMaxBFrames();
+		_qpel = options->getQuarterPixel();
+		_gmc = options->getGmc();
+
+		_quantType = (H263QuantisationType)options->getQuantisationType();
+		_mbDecision = (H263MacroblockDecisionMode)options->getMbDecisionMode();
+		_minQuantiser = options->getMinQuantiser();
+		_maxQuantiser = options->getMaxQuantiser();
+		_maxQuantiserDiff = options->getQuantiserDifference();
+		_trellis = options->getTrellis();
+		_quantCompression = options->getQuantiserCompression();
+		_quantBlur = options->getQuantiserBlur();
+
+		updateEncodeProperties(encodeOptions);
+	}
+}
+
+void H263Encoder::saveSettings(vidEncOptions *encodeOptions, H263EncoderOptions *options)
+{
+	options->setPresetConfiguration(&configName[0], (PluginConfigType)configType);
+
+	switch (_bitrateParam.mode)
+	{
+		case COMPRESS_CQ:
+			encodeOptions->encodeMode = ADM_VIDENC_MODE_CQP;
+			encodeOptions->encodeModeParameter = _bitrateParam.qz;
+
+			break;
+		case COMPRESS_CBR:
+			encodeOptions->encodeMode = ADM_VIDENC_MODE_CBR;
+			encodeOptions->encodeModeParameter = _bitrateParam.bitrate;
+
+			break;
+		case COMPRESS_2PASS:
+			encodeOptions->encodeMode = ADM_VIDENC_MODE_2PASS_SIZE;
+			encodeOptions->encodeModeParameter = _bitrateParam.finalsize;
+
+			break;
+		case COMPRESS_2PASS_BITRATE:
+			encodeOptions->encodeMode = ADM_VIDENC_MODE_2PASS_ABR;
+			encodeOptions->encodeModeParameter = _bitrateParam.avg_bitrate;
+
+			break;
+	}
+
+	options->setMotionEstimationMethod((H263MotionEstimationMethod)(_motionEst + 1));
+	options->set4MotionVector(_4MV);
+	options->setMaxBFrames(_maxBFrames);
+	options->setQuarterPixel(_qpel);
+	options->setGmc(_gmc);
+
+	options->setQuantisationType((H263QuantisationType)_quantType);
+	options->setMbDecisionMode((H263MacroblockDecisionMode)_mbDecision);
+	options->setMinQuantiser(_minQuantiser);
+	options->setMaxQuantiser(_maxQuantiser);
+	options->setQuantiserDifference(_maxQuantiserDiff);
+	options->setTrellis(_trellis);
+	options->setQuantiserCompression(_quantCompression);
+	options->setQuantiserBlur(_quantBlur);
+}
+
+bool changedConfig(const char* configName, ConfigMenuType configType)
+{
+	bool failure = false;
+
+	if (configType == CONFIG_MENU_DEFAULT)
+	{
+		H263EncoderOptions defaultOptions;
+		vidEncOptions *defaultEncodeOptions = defaultOptions.getEncodeOptions();
+
+		encoder->loadSettings(defaultEncodeOptions, &defaultOptions);
+
+		delete defaultEncodeOptions;
+	}
+	else
+	{
+		H263EncoderOptions options;
+
+		options.setPresetConfiguration(configName, (PluginConfigType)configType);
+
+		if (configType == CONFIG_MENU_CUSTOM)
+			encoder->loadSettings(NULL, &options);
+		else
+		{
+			vidEncOptions *encodeOptions;
+
+			if (options.loadPresetConfiguration())
+			{
+				encodeOptions = options.getEncodeOptions();
+
+				encoder->loadSettings(encodeOptions, &options);
+
+				delete encodeOptions;
+			}
+			else
+			{
+				failure = true;
+			}
+		}
+	}
+
+	return configType == CONFIG_MENU_CUSTOM | !failure;
+}
+
+char *serializeConfig(void)
+{
+	vidEncOptions encodeOptions;
+	H263EncoderOptions options;
+
+	encoder->saveSettings(&encodeOptions, &options);
+	options.setEncodeOptions(&encodeOptions);
+
+	return options.toXml(PLUGIN_XML_EXTERNAL);
+}
+
+int H263Encoder::getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize)
+{
+	char* xml = _options.toXml(PLUGIN_XML_INTERNAL);
+	int xmlLength = strlen(xml);
+
+	if (bufferSize >= xmlLength)
+	{
+		memcpy(pluginOptions, xml, xmlLength);
+		memcpy(encodeOptions, &_encodeOptions, sizeof(vidEncOptions));
+	}
+	else if (bufferSize != 0)
+		xmlLength = 0;
+
+	delete [] xml;
+
+	return xmlLength;
+}
+
+int H263Encoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+{
+	if (_opened)
+		return ADM_VIDENC_ERR_ALREADY_OPEN;
+
+	bool success = true;
+
+	if (pluginOptions)
+	{
+		success = _options.fromXml(pluginOptions, PLUGIN_XML_INTERNAL);
+
+		_options.loadPresetConfiguration();
+	}
+
+	if (encodeOptions && success)
+	{
+		memcpy(&_encodeOptions, encodeOptions, sizeof(vidEncOptions));
+		updateEncodeProperties(encodeOptions);
+	}
+
+	if (success)
+		return ADM_VIDENC_ERR_SUCCESS;
+	else
+		return ADM_VIDENC_ERR_FAILED;
+}
+
+int H263Encoder::open(vidEncVideoProperties *properties)
+{
+	int ret = AvcodecEncoder::open(properties);
+    int profileCount = sizeof(h263Profiles) / sizeof(h263Profiles[0]);
+	bool validProfile = false;
+
+	if (ret == ADM_VIDENC_ERR_SUCCESS)
+	{
+		for (int i = 0; i < profileCount; i++)
+		{
+			if (properties->height == h263Profiles[i].height && properties->width == h263Profiles[i].width)
+			{
+				validProfile = true;
+				break;
+			}
+		}
+
+		if (!validProfile)
+		{
+			std::string msg;
+			std::stringstream out;
+			
+			out << "The H.263 encoder only accepts the following resolutions:";
+
+			for (int i = 0; i < profileCount; i++)
+				out << "\n" << h263Profiles[i].width << " x " << h263Profiles[i].height;
+
+			ret = ADM_VIDENC_ERR_FAILED;
+			msg = out.str();
+
+			GUI_Error_HIG("Incompatible settings", msg.c_str());
+		}
+	}
+
+	return ret;
+}
+
+int H263Encoder::beginPass(vidEncPassParameters *passParameters)
+{
+	int qz = 0;
+	int ret = AvcodecEncoder::beginPass(passParameters);
+
+	if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_CQP)
+		qz = _encodeOptions.encodeModeParameter;
+	else if ((_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE || _encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_ABR) && _currentPass == 1)
+		qz = 2;
+
+	if (qz)
+		_frame.quality = (int)floor(FF_QP2LAMBDA * qz + 0.5);
+
+	return ret;
+}
+
+int H263Encoder::finishPass(void)
+{
+	int ret = AvcodecEncoder::finishPass();
+
+	if (_statFile)
+	{
+		fclose(_statFile);
+		_statFile = NULL;
+	}
+
+	if (_context && _context->stats_in)
+	{
+		delete [] _context->stats_in;
+		_context->stats_in = NULL;
+	}
+
+	return ret;
+}
+
+int H263Encoder::encodeFrame(vidEncEncodeParameters *encodeParams)
+{
+	int ret = AvcodecEncoder::encodeFrame(encodeParams);
+
+	if (_context->stats_out)
+		fprintf (_statFile, "%s", _context->stats_out);
+
+	return ret;
+}
+
+void H263Encoder::updateEncodeProperties(vidEncOptions *encodeOptions)
+{
+	switch (encodeOptions->encodeMode)
+	{
+		case ADM_VIDENC_MODE_CQP:
+			_passCount = 1;
+
+			_bitrateParam.mode = COMPRESS_CQ;
+			_bitrateParam.qz = encodeOptions->encodeModeParameter;
+
+			break;
+		case ADM_VIDENC_MODE_CBR:
+			_passCount = 1;
+
+			_bitrateParam.mode = COMPRESS_CBR;
+			_bitrateParam.bitrate = encodeOptions->encodeModeParameter;
+
+			break;
+		case ADM_VIDENC_MODE_2PASS_SIZE:
+			_passCount = 2;
+
+			_bitrateParam.mode = COMPRESS_2PASS;
+			_bitrateParam.finalsize = encodeOptions->encodeModeParameter;
+
+			break;
+		case ADM_VIDENC_MODE_2PASS_ABR:
+			_passCount = 2;
+
+			_bitrateParam.mode = COMPRESS_2PASS_BITRATE;
+			_bitrateParam.avg_bitrate = encodeOptions->encodeModeParameter;
+
+			break;
+	}
+}
+
+unsigned int H263Encoder::calculateBitrate(unsigned int fpsNum, unsigned int fpsDen, unsigned int frameCount, unsigned int sizeInMb)
+{
+	double db, ti;
+
+	db = sizeInMb;
+	db = db * 1024. * 1024. * 8.;
+	// now db is in bits
+
+	// compute duration
+	ti = frameCount;
+	ti *= fpsDen;
+	ti /= fpsNum;	// nb sec
+	db = db / ti;
+
+	return (unsigned int)floor(db);
+}

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.h	2009-12-30 13:14:26 UTC (rev 5776)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.h	2009-12-30 18:15:14 UTC (rev 5777)
@@ -0,0 +1,81 @@
+ /***************************************************************************
+                                h263Encoder.h
+
+    begin                : Wed Dec 30 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+ /**************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef H263Encoder_h
+#define H263Encoder_h
+
+#ifdef __cplusplus
+extern "C"
+{
+	#include "ADM_vidEnc_plugin.h"
+}
+
+#include "encoder.h"
+#include "h263EncoderOptions.h"
+#include "DIA_factory.h"
+
+typedef struct H263Profile {
+	int width;
+	int height;
+} H263Profile;
+
+static const H263Profile h263Profiles[] = {
+	{ 128, 96 },
+	{ 176, 144 },
+	{ 352, 288 },
+	{ 704, 576 },
+	{ 1408, 1152 }
+};
+
+class H263Encoder : public AvcodecEncoder
+{
+	private:
+		COMPRES_PARAMS _bitrateParam;
+		unsigned int _motionEst, _4MV, _maxBFrames, _qpel, _gmc;
+		unsigned int _quantType, _mbDecision, _minQuantiser, _maxQuantiser, _maxQuantiserDiff, _trellis;
+		float _quantCompression, _quantBlur;
+
+		char configName[PATH_MAX];
+		ConfigMenuType configType;
+
+		H263EncoderOptions _options;
+		vidEncOptions _encodeOptions;
+
+		FILE *_statFile;
+
+		void updateEncodeProperties(vidEncOptions *encodeOptions);
+		unsigned int calculateBitrate(unsigned int fpsNum, unsigned int fpsDen, unsigned int frameCount, unsigned int sizeInMb);
+
+	public:
+		H263Encoder(void);
+		int initContext(const char* logFileName);
+		const char* getEncoderType(void);
+		const char* getEncoderDescription(void);
+		const char* getFourCC(void);
+		const char* getEncoderGuid(void);
+		int isConfigurable(void);
+		int configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
+		void loadSettings(vidEncOptions *encodeOptions, H263EncoderOptions *options);
+		void saveSettings(vidEncOptions *encodeOptions, H263EncoderOptions *options);
+		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
+		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int open(vidEncVideoProperties *properties);
+		int beginPass(vidEncPassParameters *passParameters);
+		int encodeFrame(vidEncEncodeParameters *encodeParams);
+		int finishPass(void);
+};
+#endif	// __cplusplus
+#endif	// H263Encoder_h

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.cpp	2009-12-30 13:14:26 UTC (rev 5776)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.cpp	2009-12-30 18:15:14 UTC (rev 5777)
@@ -0,0 +1,328 @@
+ /***************************************************************************
+                            h263EncoderOptions.cpp
+
+	These settings are intended for scripting and can contain a Preset 
+	Configuration block.  If this block exists then "internal" settings are
+	ignored and an external configuration file should be read instead, 
+	e.g. PlayStation Portable profile.  However, if the external file is 
+	missing, internal settings have to be used and will reflect a snapshot
+	of the external configuration file at the time the script was generated.
+
+    begin                : Wed Dec 30 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <math.h>
+#include <libxml/parser.h>
+#include <libxml/xmlschemas.h>
+#include <sstream>
+#include <string>
+#include "ADM_default.h"
+#include "ADM_files.h"
+
+#include "h263EncoderOptions.h"
+
+H263EncoderOptions::H263EncoderOptions(void) : PluginOptions(H263_PLUGIN_CONFIG_DIR, "H263", "H263Param.xsd", H263_DEFAULT_ENCODE_MODE, H263_DEFAULT_ENCODE_MODE_PARAMETER)
+{
+	reset();
+}
+
+void H263EncoderOptions::reset(void)
+{
+	PluginOptions::reset();
+
+	setMotionEstimationMethod(H263_MEM_EPZS);
+	set4MotionVector(true);
+	setMaxBFrames(0);
+	setQuarterPixel(false);
+	setGmc(false);
+	setQuantisationType(H263_QUANT_H263);
+	setMbDecisionMode(H263_MBDEC_RD);
+	setMinQuantiser(2);
+	setMaxQuantiser(31);
+	setQuantiserDifference(3);
+	setTrellis(false);
+	setQuantiserCompression(0.5);
+	setQuantiserBlur(0.5);
+}
+
+H263MotionEstimationMethod H263EncoderOptions::getMotionEstimationMethod(void)
+{
+	return _motionEst;
+}
+
+void H263EncoderOptions::setMotionEstimationMethod(H263MotionEstimationMethod motionEst)
+{
+	_motionEst = motionEst;
+}
+
+bool H263EncoderOptions::get4MotionVector(void)
+{
+	return _4MV;
+}
+
+void H263EncoderOptions::set4MotionVector(bool fourMv)
+{
+	_4MV = fourMv;
+}
+
+unsigned int H263EncoderOptions::getMaxBFrames(void)
+{
+	return _maxBFrames;
+}
+
+void H263EncoderOptions::setMaxBFrames(unsigned int maxBFrames)
+{
+	if (maxBFrames <= 32)
+		_maxBFrames = maxBFrames;
+}
+
+bool H263EncoderOptions::getQuarterPixel(void)
+{
+	return _qpel;
+}
+
+void H263EncoderOptions::setQuarterPixel(bool qpel)
+{
+	_qpel = qpel;
+}
+
+bool H263EncoderOptions::getGmc(void)
+{
+	return _gmc;
+}
+
+void H263EncoderOptions::setGmc(bool gmc)
+{
+	_gmc = gmc;
+}
+
+H263QuantisationType H263EncoderOptions::getQuantisationType(void)
+{
+	return _quantType;
+}
+
+void H263EncoderOptions::setQuantisationType(H263QuantisationType quantType)
+{
+	_quantType = quantType;
+}
+
+H263MacroblockDecisionMode H263EncoderOptions::getMbDecisionMode(void)
+{
+	return _mbDecision;
+}
+
+void H263EncoderOptions::setMbDecisionMode(H263MacroblockDecisionMode mbDecision)
+{
+	_mbDecision = mbDecision;
+}
+
+unsigned int H263EncoderOptions::getMinQuantiser(void)
+{
+	return _minQuantiser;
+}
+
+void H263EncoderOptions::setMinQuantiser(unsigned int quantiser)
+{
+	if (quantiser > 0 && quantiser <= 31)
+		_minQuantiser = quantiser;
+}
+
+unsigned int H263EncoderOptions::getMaxQuantiser(void)
+{
+	return _maxQuantiser;
+}
+
+void H263EncoderOptions::setMaxQuantiser(unsigned int quantiser)
+{
+	if (quantiser > 0 && quantiser <= 31)
+		_maxQuantiser = quantiser;
+}
+
+unsigned int H263EncoderOptions::getQuantiserDifference(void)
+{
+	return _maxQuantiserDiff;
+}
+
+void H263EncoderOptions::setQuantiserDifference(unsigned int difference)
+{
+	if (difference > 0 && difference <= 31)
+		_maxQuantiserDiff = difference;
+}
+
+bool H263EncoderOptions::getTrellis(void)
+{
+	return _trellis;
+}
+
+void H263EncoderOptions::setTrellis(bool trellis)
+{
+	_trellis = trellis;
+}
+
+float H263EncoderOptions::getQuantiserCompression(void)
+{
+	return _quantCompression;
+}
+
+void H263EncoderOptions::setQuantiserCompression(float compression)
+{
+	if (compression > 0. && compression <= 1.)
+		_quantCompression = compression;
+}
+
+float H263EncoderOptions::getQuantiserBlur(void)
+{
+	return _quantBlur;
+}
+
+void H263EncoderOptions::setQuantiserBlur(float blur)
+{
+	if (blur > 0. && blur <= 1.)
+		_quantBlur = blur;
+}
+
+void H263EncoderOptions::addOptionsToXml(xmlNodePtr xmlNodeRoot)
+{
+	const int bufferSize = 100;
+	xmlChar xmlBuffer[bufferSize + 1];
+	xmlNodePtr xmlNodeChild, xmlNodeChild2;
+
+	xmlNodeRoot = xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)getOptionsTagRoot(), NULL);
+
+	switch (getMotionEstimationMethod())
+	{
+		case H263_MEM_FULL:
+			strcpy((char*)xmlBuffer, "full");
+			break;
+		case H263_MEM_LOG:
+			strcpy((char*)xmlBuffer, "log");
+			break;
+		case H263_MEM_PHODS:
+			strcpy((char*)xmlBuffer, "phods");
+			break;
+		case H263_MEM_EPZS:
+			strcpy((char*)xmlBuffer, "epzs");
+			break;
+		default:
+			strcpy((char*)xmlBuffer, "none");
+			break;
+	}
+
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"motionEstimationMethod", xmlBuffer);
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"fourMotionVector", boolean2String(xmlBuffer, bufferSize, get4MotionVector()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"maximumBFrames", number2String(xmlBuffer, bufferSize, getMaxBFrames()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"quarterPixel", boolean2String(xmlBuffer, bufferSize, getQuarterPixel()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"globalMotionCompensation", boolean2String(xmlBuffer, bufferSize, getGmc()));
+
+	switch (getQuantisationType())
+	{
+		case H263_QUANT_MPEG:
+			strcpy((char*)xmlBuffer, "mpeg");
+			break;
+		default:
+			strcpy((char*)xmlBuffer, "h263");
+			break;
+	}
+
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"quantisationType", xmlBuffer);
+
+	switch (getMbDecisionMode())
+	{
+		case H263_MBDEC_BITS:
+			strcpy((char*)xmlBuffer, "fewestBits");
+			break;
+		case H263_MBDEC_RD:
+			strcpy((char*)xmlBuffer, "rateDistortion");
+			break;
+		default:
+			strcpy((char*)xmlBuffer, "sad");
+			break;
+	}
+
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"macroblockDecisionMode", xmlBuffer);
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"minimumQuantiser", number2String(xmlBuffer, bufferSize, getMinQuantiser()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"maximumQuantiser", number2String(xmlBuffer, bufferSize, getMaxQuantiser()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"quantiserDifference", number2String(xmlBuffer, bufferSize, getQuantiserDifference()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"trellis", boolean2String(xmlBuffer, bufferSize, getTrellis()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"quantiserCompression", number2String(xmlBuffer, bufferSize, getQuantiserCompression()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"quantiserBlur", number2String(xmlBuffer, bufferSize, getQuantiserBlur()));
+}
+
+void H263EncoderOptions::parseOptions(xmlNode *node)
+{
+	for (xmlNode *xmlChild = node->children; xmlChild; xmlChild = xmlChild->next)
+	{
+		if (xmlChild->type == XML_ELEMENT_NODE)
+		{
+			char *content = (char*)xmlNodeGetContent(xmlChild);
+
+			if (strcmp((char*)xmlChild->name, "motionEstimationMethod") == 0)
+			{
+				H263MotionEstimationMethod method = H263_MEM_NONE;
+
+				if (strcmp(content, "full") == 0)
+					method = H263_MEM_FULL;
+				else if (strcmp(content, "log") == 0)
+					method = H263_MEM_LOG;
+				else if (strcmp(content, "phods") == 0)
+					method = H263_MEM_PHODS;
+				else if (strcmp(content, "epzs") == 0)
+					method = H263_MEM_EPZS;
+
+				setMotionEstimationMethod(method);
+			}
+			if (strcmp((char*)xmlChild->name, "fourMotionVector") == 0)
+				set4MotionVector(string2Boolean(content));
+			else if (strcmp((char*)xmlChild->name, "maximumBFrames") == 0)
+				setMaxBFrames(atoi(content));
+			else if (strcmp((char*)xmlChild->name, "quarterPixel") == 0)
+				setQuarterPixel(string2Boolean(content));
+			else if (strcmp((char*)xmlChild->name, "globalMotionCompensation") == 0)
+				setGmc(string2Boolean(content));
+			if (strcmp((char*)xmlChild->name, "quantisationType") == 0)
+			{
+				H263QuantisationType type = H263_QUANT_H263;
+
+				if (strcmp(content, "mpeg") == 0)
+					type = H263_QUANT_MPEG;
+
+				setQuantisationType(type);
+			}			
+			if (strcmp((char*)xmlChild->name, "macroblockDecisionMode") == 0)
+			{
+				H263MacroblockDecisionMode mode = H263_MBDEC_SAD;
+
+				if (strcmp(content, "fewestBits") == 0)
+					mode = H263_MBDEC_BITS;
+				else if (strcmp(content, "rateDistortion") == 0)
+					mode = H263_MBDEC_RD;
+
+				setMbDecisionMode(mode);
+			}
+			else if (strcmp((char*)xmlChild->name, "minimumQuantiser") == 0)
+				setMinQuantiser(atoi(content));
+			else if (strcmp((char*)xmlChild->name, "maximumQuantiser") == 0)
+				setMaxQuantiser(atoi(content));
+			else if (strcmp((char*)xmlChild->name, "quantiserDifference") == 0)
+				setQuantiserDifference(atoi(content));
+			else if (strcmp((char*)xmlChild->name, "trellis") == 0)
+				setTrellis(string2Boolean(content));
+			else if (strcmp((char*)xmlChild->name, "quantiserCompression") == 0)
+				setQuantiserCompression(string2Float(content));
+			else if (strcmp((char*)xmlChild->name, "quantiserBlur") == 0)
+				setQuantiserBlur(string2Float(content));
+
+			xmlFree(content);
+		}
+	}
+}

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.h	2009-12-30 13:14:26 UTC (rev 5776)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.h	2009-12-30 18:15:14 UTC (rev 5777)
@@ -0,0 +1,110 @@
+/***************************************************************************
+                            h263EncoderOptions.h
+
+    begin                : Wed Dec 30 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef h263EncoderOptions_h
+#define h263EncoderOptions_h
+
+#include <vector>
+#include "../common/PluginOptions.h"
+
+extern "C"
+{
+#include "ADM_vidEnc_plugin.h"
+}
+
+#define H263_DEFAULT_ENCODE_MODE ADM_VIDENC_MODE_CQP
+#define H263_DEFAULT_ENCODE_MODE_PARAMETER 4
+
+typedef enum
+{
+	H263_MEM_NONE = 1,
+	H263_MEM_FULL,
+	H263_MEM_LOG,
+	H263_MEM_PHODS,
+	H263_MEM_EPZS
+} H263MotionEstimationMethod;
+
+typedef enum
+{
+	H263_QUANT_H263 = 0,
+	H263_QUANT_MPEG
+} H263QuantisationType;
+
+typedef enum
+{
+	H263_MBDEC_SAD = 0,
+	H263_MBDEC_BITS,
+	H263_MBDEC_RD
+} H263MacroblockDecisionMode;
+
+class H263EncoderOptions : public PluginOptions
+{
+protected:
+	H263MotionEstimationMethod _motionEst;
+	unsigned int _4MV, _maxBFrames, _qpel, _gmc;
+	H263QuantisationType _quantType;
+	H263MacroblockDecisionMode _mbDecision;
+	unsigned int _minQuantiser, _maxQuantiser, _maxQuantiserDiff, _trellis;
+	float _quantCompression, _quantBlur;
+
+	void addOptionsToXml(xmlNodePtr xmlNodeRoot);
+	void parseOptions(xmlNode *node);
+
+public:
+	H263EncoderOptions(void);
+	void reset(void);
+
+	H263MotionEstimationMethod getMotionEstimationMethod(void);
+	void setMotionEstimationMethod(H263MotionEstimationMethod motionEst);
+
+	bool get4MotionVector(void);
+	void set4MotionVector(bool fourMv);
+
+	unsigned int getMaxBFrames(void);
+	void setMaxBFrames(unsigned int maxBFrames);
+
+	bool getQuarterPixel(void);
+	void setQuarterPixel(bool qpel);
+
+	bool getGmc(void);
+	void setGmc(bool gmc);
+
+	H263QuantisationType getQuantisationType(void);
+	void setQuantisationType(H263QuantisationType quantType);
+
+	H263MacroblockDecisionMode getMbDecisionMode(void);
+	void setMbDecisionMode(H263MacroblockDecisionMode mbDecision);
+
+	unsigned int getMinQuantiser(void);
+	void setMinQuantiser(unsigned int quantiser);
+
+	unsigned int getMaxQuantiser(void);
+	void setMaxQuantiser(unsigned int quantiser);
+
+	unsigned int getQuantiserDifference(void);
+	void setQuantiserDifference(unsigned int difference);
+
+	bool getTrellis(void);
+	void setTrellis(bool trellis);
+
+	float getQuantiserCompression(void);
+	void setQuantiserCompression(float compression);
+
+	float getQuantiserBlur(void);
+	void setQuantiserBlur(float blur);
+};
+
+#endif	// h263EncoderOptions_h

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-30 13:14:26 UTC (rev 5776)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-30 18:15:14 UTC (rev 5777)
@@ -71,7 +71,7 @@
 void vidEncGetEncoderVersion(int encoderId, int* major, int* minor, int* patch)
 {
 	*major = 1;
-	*minor = 3;
+	*minor = 4;
 	*patch = 0;
 }
 



From gruntster at mail.berlios.de  Wed Dec 30 19:27:01 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 30 Dec 2009 19:27:01 +0100
Subject: [Avidemux-svn-commit] r5778 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_codecs
	ADM_encoder
Message-ID: <200912301827.nBUIR1fS002301@sheep.berlios.de>

Author: gruntster
Date: 2009-12-30 19:26:52 +0100 (Wed, 30 Dec 2009)
New Revision: 5778

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp
Log:
[h263] remove old H.263 logic

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-30 18:15:14 UTC (rev 5777)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-30 18:26:52 UTC (rev 5778)
@@ -211,12 +211,6 @@
     case FF_MSMP4V3:
       WRAP_Open (CODEC_ID_MSMPEG4V3);
       break;
-    case FF_H263:
-      WRAP_Open (CODEC_ID_H263);
-      break;
-    case FF_H263P:
-      WRAP_Open (CODEC_ID_H263P);
-      break;
     default:
       ADM_assert (0);
     }
@@ -592,10 +586,7 @@
 	}
 #undef SETX
     }
-  if ((_id == FF_H263) || (_id == FF_H263P))
-    _context->bit_rate_tolerance = 4000;
-  else
-    _context->bit_rate_tolerance = 8000000;
+    _context->bit_rate_tolerance = 1024 * 8 * 1000;
 
 
   _context->b_quant_factor = 1.25;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h	2009-12-30 18:15:14 UTC (rev 5777)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h	2009-12-30 18:26:52 UTC (rev 5778)
@@ -26,8 +26,6 @@
 {
   FF_MSMP4V3 = 1,
   FF_MPEG4 = 2,
-  FF_H263 = 4,
-  FF_H263P = 5,
 } FF_CODEC_ID;
 
 /*

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h	2009-12-30 18:15:14 UTC (rev 5777)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h	2009-12-30 18:26:52 UTC (rev 5778)
@@ -65,38 +65,6 @@
   0				// DUMMY 
 };
 
-COMPRES_PARAMS ffmpegH263Codec = {
-  CodecH263,
-  QT_TR_NOOP("H.263 (lavc)"),
-  "H263",
-  "Lavcodec H263",
-  COMPRESS_CQ,
-  4,
-  1500,
-  700,
-  1000, // AVG
-  ADM_ENC_CAP_CBR + ADM_ENC_CAP_CQ + ADM_ENC_CAP_2PASS+ADM_ENC_CAP_SAME,
-  ADM_EXTRA_PARAM,
-  &ffmpeg4Extra,
-  sizeof (ffmpeg4Extra),
-  getFFCompressParams
-};
-COMPRES_PARAMS ffmpegH263PCodec = {
-  CodecH263P,
-  QT_TR_NOOP("H.263+ (lavc)"),
-  "H263P",
-  "Lavcodec H263+",
-  COMPRESS_CQ,
-  4,
-  1500,
-  700,
-  1000, // AVG
-  ADM_ENC_CAP_CBR + ADM_ENC_CAP_CQ + ADM_ENC_CAP_2PASS+ADM_ENC_CAP_SAME,
-  ADM_EXTRA_PARAM,
-  &ffmpeg4Extra,
-  sizeof (ffmpeg4Extra),
-  getFFCompressParams
-};
 COMPRES_PARAMS ffmpegMpeg4 = {
   CodecFF,
   QT_TR_NOOP("MPEG-4 ASP (lavc)"),
@@ -236,7 +204,6 @@
   &DVDCodec,
   &RequantCodec,
   &yv12codec,
-  &ffmpegH263Codec,
   &DUMMYONE
 };
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx	2009-12-30 18:15:14 UTC (rev 5777)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx	2009-12-30 18:26:52 UTC (rev 5778)
@@ -21,8 +21,6 @@
 {
   CodecCopy,
   CodecFF,
-  CodecH263,
-  CodecH263P,
   CodecVCD,
   CodecSVCD,
   CodecDVD,

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2009-12-30 18:15:14 UTC (rev 5777)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2009-12-30 18:26:52 UTC (rev 5778)
@@ -596,15 +596,6 @@
 	case CodecFF:
 		e = new EncoderFFMPEG (FF_MPEG4, desc);
 		break;
-	case CodecH263:
-		if (!((w == 128) && (h == 96)) && !((w == 176) && (h == 144)))
-		{
-			GUI_Error_HIG (QT_TR_NOOP("Only QCIF and subQCIF are allowed for H.263"), NULL);
-			return 0;
-		}
-
-		e = new EncoderFFMPEG (FF_H263, desc);
-		break;
 	case CodecDVD:
 		e=new EncoderMpeg2enc(MPEG2ENC_DVD, desc);
 		printf("\n Using mpeg2enc encoder (DVD)\n");

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp	2009-12-30 18:15:14 UTC (rev 5777)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp	2009-12-30 18:26:52 UTC (rev 5778)
@@ -56,10 +56,6 @@
     case FF_MPEG4:
       return "DX50";
       break;
-    case FF_H263P:
-    case FF_H263:
-      return "H263";
-      break;
     default:
       ADM_assert (0);
 



From mean at mail.berlios.de  Wed Dec 30 20:03:32 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 30 Dec 2009 20:03:32 +0100
Subject: [Avidemux-svn-commit] r5779 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav
Message-ID: <200912301903.nBUJ3WXk004219@sheep.berlios.de>

Author: mean
Date: 2009-12-30 20:03:32 +0100 (Wed, 30 Dec 2009)
New Revision: 5779

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
Log:
[Audio] Correct channel mapping when using lavcodec to decode AC3

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp	2009-12-30 18:26:52 UTC (rev 5778)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp	2009-12-30 19:03:32 UTC (rev 5779)
@@ -242,7 +242,7 @@
             {
             CHANNEL_TYPE *p_ch_type = channelMapping;
 #define DOIT(x,y) if(_context->channel_layout & CH_##x) *(p_ch_type++)=ADM_CH_##y;
-            if(_context->codec_id == CODEC_ID_DTS)
+            //if(_context->codec_id == CODEC_ID_DTS)
                 {
                     
                     DOIT(FRONT_LEFT,FRONT_LEFT);
@@ -253,10 +253,9 @@
                     DOIT(LOW_FREQUENCY,LFE);
                     DOIT(SIDE_LEFT,REAR_LEFT);
                     DOIT(SIDE_RIGHT,REAR_RIGHT);
-                    
-                    
- 
-                }else   
+                }
+#if 0
+else   
                 {
                     DOIT(LOW_FREQUENCY,LFE);
                     DOIT(FRONT_LEFT,FRONT_LEFT);
@@ -265,6 +264,7 @@
                     DOIT(SIDE_LEFT,REAR_LEFT);
                     DOIT(SIDE_RIGHT,REAR_RIGHT);
                 }
+#endif
             }
         
         return 1;



From mean at mail.berlios.de  Wed Dec 30 20:03:35 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 30 Dec 2009 20:03:35 +0100
Subject: [Avidemux-svn-commit] r5780 - in branches/avidemux_2.6_branch_mean:
	avidemux_core/ADM_coreAudio/src
	avidemux_core/ADM_coreAudioParser/include
	avidemux_core/ADM_coreAudioParser/src
	avidemux_plugins/ADM_demuxers/Matroska
	avidemux_plugins/ADM_demuxers/MpegPS
Message-ID: <200912301903.nBUJ3ZNY004230@sheep.berlios.de>

Author: mean
Date: 2009-12-30 20:03:34 +0100 (Wed, 30 Dec 2009)
New Revision: 5780

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStream.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioParser/include/ADM_dcainfo.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioParser/src/ADM_dcainfo.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv_audio.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegPS/ADM_psAudioProbe.cpp
Log:
[DCA] Add and use audioParser for DTS/DCA

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStream.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStream.cpp	2009-12-30 19:03:32 UTC (rev 5779)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStream.cpp	2009-12-30 19:03:34 UTC (rev 5780)
@@ -8,6 +8,7 @@
 #include "ADM_audioStreamMP3.h"
 #include "ADM_audioStreamAC3.h"
 #include "ADM_audioStreamEac3.h"
+#include "ADM_audioStreamDCA.h"
 #include "ADM_audioStreamConstantChunk.h"
 
 /**
@@ -142,6 +143,8 @@
             return new ADM_audioStreamAC3(wavheader,access);
         case WAV_MP3:
             return new ADM_audioStreamMP3(wavheader,access);
+        case WAV_DTS:
+            return new ADM_audioStreamDCA(wavheader,access);
 #if 0
         case WAV_WMA:
             return new ADM_audioStreamConstantChunk(wavheader,access);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioParser/include/ADM_dcainfo.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioParser/include/ADM_dcainfo.h	2009-12-30 19:03:32 UTC (rev 5779)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioParser/include/ADM_dcainfo.h	2009-12-30 19:03:34 UTC (rev 5780)
@@ -1,7 +1,38 @@
+/**
+    \file ADM_dcainfo
+    \brief Extracts and sync DTS/DCA frames
+    \author mean (C) 2009 fixounet at free.fr
+
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
 #ifndef ADM_DCAINFO_H
 #define ADM_DCAINFO_H
-int ADM_DCAGetInfo(uint8_t *buf, uint32_t len, uint32_t *fq, uint32_t *br, uint32_t *chan,uint32_t *syncoff,uint32_t *flags,uint32_t *nbSample);
 
+/**
+    \struct ADM_DCA_INFO
+*/
+typedef struct
+{
+    uint32_t frequency;
+    uint32_t bitrate;   // in b/s
+    uint32_t channels;
+    uint32_t frameSizeInBytes;
+    uint32_t samples;
+    uint32_t flags;
+}ADM_DCA_INFO;
+/**
+    \fn ADM_DCAGetInfo
+*/
+bool ADM_DCAGetInfo(uint8_t *buf, uint32_t len,ADM_DCA_INFO *info,uint32_t *syncoff);
+
 #define DTS_HEADER_SIZE (10)
 #endif
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioParser/src/ADM_dcainfo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioParser/src/ADM_dcainfo.cpp	2009-12-30 19:03:32 UTC (rev 5779)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioParser/src/ADM_dcainfo.cpp	2009-12-30 19:03:34 UTC (rev 5780)
@@ -6,6 +6,15 @@
         Code very derived from libdca
 
 */
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
 #include "ADM_default.h"
 #include "ADM_dcainfo.h"
 #define ADM_NO_CONFIG_H
@@ -43,10 +52,12 @@
     1, 2, 2, 2, 2, 3, 3, 4, 4, 5, 6, 6, 6, 7, 8, 8
 };
 
-/*
-    Return frame size
+/**
+    \fn ADM_DCAGetInfo
+    @param syncoff: # of dropped bytes from the begining
 */
-int  ADM_DCAGetInfo(uint8_t *buf, uint32_t len, uint32_t *fq, uint32_t *br, uint32_t *chan,uint32_t *syncoff,uint32_t *flagso,uint32_t *nbSample)
+bool ADM_DCAGetInfo(uint8_t *buf, uint32_t len,ADM_DCA_INFO *info,uint32_t *syncoff)
+//int  ADM_DCAGetInfo(uint8_t *buf, uint32_t len, uint32_t *fq, uint32_t *br, uint32_t *chan,uint32_t *syncoff,uint32_t *flagso,uint32_t *nbSample)
 {
 uint8_t *end=buf+len-4-DTS_HEADER_SIZE;
 uint8_t *cur=buf-1;
@@ -63,7 +74,7 @@
                 if(cur[3]!=0x01) continue;
                 // ok we got a starcode
                 // State :      32 bits, already got them
-                // Frame type   1 
+                // Frame type   1
                 // Sample Deficit 5
                 // CRC present  1
                 // Frame length  7
@@ -81,14 +92,14 @@
                 len2=get_bits(&s,14);
                 framesize=len2+1;
                 //
-                //  
                 //
+                //
                 flags=get_bits(&s,6);
-                *flagso=flags;
-                index=get_bits(&s,4); 
-                *fq=dts_sample_rates[index];
-                index=get_bits(&s,5); 
-                *br=dts_bit_rates[index];
+                info->flags=flags;
+                index=get_bits(&s,4);
+                info->frequency=dts_sample_rates[index];
+                index=get_bits(&s,5);
+                info->bitrate=dts_bit_rates[index];
 #if 0
                 printf("[dts]Flags  :%u\n",flags);
                 printf("[dts]Fq  :%u\n",*fq);
@@ -97,19 +108,20 @@
                 printf("[dts]len2  :%u\n",len2);
 #endif
                 *syncoff=cur-buf;
-                if(*syncoff) printf("[dts] Dropped %u bytes\n",*syncoff);
+                if(*syncoff) ADM_warning("[dts] Dropped %u bytes\n",*syncoff);
                 get_bits(&s,10);
                 int lfe=get_bits(&s,2);
                 int c;
                 c=dts_channels[flags & 0xf];
                 if(c==5 && lfe) c++; // LFE
-                *chan=c;
-                *nbSample=nbBlocks*32;
-                return framesize;
-                
-                
+                info->channels=c;
+                info->samples=nbBlocks*32;
+                info->frameSizeInBytes=framesize;
+                return true;
+
+
             }
-            printf("[DTS] Cannot find sync\n");
-	      return 0;
+            ADM_warning("[DTS] Cannot find sync\n");
+	      return false;
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv_audio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv_audio.cpp	2009-12-30 19:03:32 UTC (rev 5779)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv_audio.cpp	2009-12-30 19:03:34 UTC (rev 5780)
@@ -60,12 +60,13 @@
   {
      if( getPacket(ac3Buffer, &len, 20000,&timecode))
      {
-       uint32_t fq,br,chan,syncoff,flags,nbsample;
-        if( ADM_DCAGetInfo(ac3Buffer, len, &fq, &br, &chan,&syncoff,&flags,&nbsample) )
+       uint32_t syncoff,flags,nbsample;
+       ADM_DCA_INFO info;
+        if( true==ADM_DCAGetInfo(ac3Buffer, len,&info,&syncoff) )
         {
-            track->wavHeader.channels=chan;
-            track->wavHeader.frequency=fq;
-            track->wavHeader.byterate=br;
+            track->wavHeader.channels=info.channels;
+            track->wavHeader.frequency=info.frequency;
+            track->wavHeader.byterate=info.bitrate/8;
         }
      }
      goToBlock(0);
@@ -87,7 +88,7 @@
 */
 uint64_t  mkvAccess::getDurationInUs(void)
 {
-    
+
     uint32_t limit=_track->index.size();
     if(!limit) return 0;
     return _track->index[limit-1].Dts;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegPS/ADM_psAudioProbe.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegPS/ADM_psAudioProbe.cpp	2009-12-30 19:03:32 UTC (rev 5779)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegPS/ADM_psAudioProbe.cpp	2009-12-30 19:03:34 UTC (rev 5780)
@@ -3,7 +3,7 @@
     \brief Handle index file reading
     copyright            : (C) 2009 by mean
     email                : fixounet at free.fr
-        
+
  ***************************************************************************/
 
 /***************************************************************************
@@ -66,7 +66,7 @@
                 break;
     }
     // Now synthetize
-    for(int i=0x0;i<0xFF;i++)   
+    for(int i=0x0;i<0xFF;i++)
     {
         packetStats *stat=packet->getStat(i);
         if(stat->count)
@@ -76,7 +76,7 @@
 
          if(stat->count>=PROBE_MIN_PACKET && stat->size>PROBE_MIN_SIZE)
          {
-                packet->setPos(fileSize/2); 
+                packet->setPos(fileSize/2);
                 addAudioTrack(i,tracks,packet);
          }
 
@@ -85,9 +85,9 @@
 end:
     printf("[PsDemux] Audio probe done, found %d tracks\n",(int)tracks->size());
     delete packet;
-    
-    if(tracks->size()==0) 
-    {   
+
+    if(tracks->size()==0)
+    {
         delete tracks;
         return NULL;
     }
@@ -113,7 +113,7 @@
             ) return false;
 
         // Go back where we were
-        p->changePid(pid); 
+        p->changePid(pid);
         p->getPacketOfType(pid,PROBE_ANALYZE_SIZE, &packetSize,&pts,&dts,audioBuffer,&startAt);
         //Realign
         p->seek(startAt,0);
@@ -135,7 +135,7 @@
                             {
                                 if(! psCheckMp2Audio(&(info->header),audioBuffer,rd))
                                 {
-                                    printf("[PsProbeAudio] Failed to get info on track :%x (MP2)\n",pid);
+                                    ADM_warning("[PsProbeAudio] Failed to get info on track :%x (MP2)\n",pid);
                                     goto er;
                                 }
                             }
@@ -144,22 +144,23 @@
                             if(pid>=0x8) // DTS
                             {
                                 info->header.encoding=WAV_DTS;
-                                uint32_t flags,nbSample;
-                                if(!ADM_DCAGetInfo(audioBuffer, rd, &fq, &br, &chan,&off,&flags,&nbSample))
+                                ADM_DCA_INFO dcainfo;
+
+                                if(false==ADM_DCAGetInfo(audioBuffer, rd, &dcainfo,&off))
                                 {
-                                        printf("[PsProbeAudio] Failed to get info on track :%x\n",pid);
+                                        ADM_warning("[PsProbeAudio] Failed to get info on track :%x\n",pid);
                                         goto er;
                                 }
-                                info->header.frequency=fq;
-                                info->header.channels=chan;
-                                info->header.byterate=(br);
+                                info->header.frequency=dcainfo.frequency;
+                                info->header.channels=dcainfo.channels;
+                                info->header.byterate=dcainfo.bitrate/8;
                                 break;
                             }else // AC3
                             {
                                 info->header.encoding=WAV_AC3;
                                 if(!ADM_AC3GetInfo(audioBuffer, rd, &fq, &br, &chan,&off))
                                 {
-                                        printf("[PsProbeAudio] Failed to get info on track :%x\n",pid);
+                                        ADM_warning("[PsProbeAudio] Failed to get info on track :%x\n",pid);
                                         goto er;
                                 }
                                 info->header.frequency=fq;
@@ -167,7 +168,7 @@
                                 info->header.byterate=(br);
                                 break;
                             }
-                            
+
             default:
                         ADM_assert(0);
 



From mean at mail.berlios.de  Wed Dec 30 20:03:36 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 30 Dec 2009 20:03:36 +0100
Subject: [Avidemux-svn-commit] r5781 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio:
	include src
Message-ID: <200912301903.nBUJ3aMi004240@sheep.berlios.de>

Author: mean
Date: 2009-12-30 20:03:36 +0100 (Wed, 30 Dec 2009)
New Revision: 5781

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStreamDCA.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamDCA.cpp
Log:
[DCA] Add and use audioParser for DTS/DCA

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStreamDCA.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStreamDCA.h	2009-12-30 19:03:34 UTC (rev 5780)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStreamDCA.h	2009-12-30 19:03:36 UTC (rev 5781)
@@ -0,0 +1,45 @@
+/***************************************************************************
+                          ADM_audioStreamDCA.h  -  description
+                             -------------------
+    copyright            : (C) 2008 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_audioStreamDCA_H
+#define ADM_audioStreamDCA_H
+
+#include "ADM_audioStreamBuffered.h"
+
+
+/**
+        \fn ADM_audioStreamDCA
+        \brief Class to handle DCA/DCA streams
+
+*/
+class ADM_audioStreamDCA : public ADM_audioStreamBuffered
+{
+        protected:
+        public:
+/// Default constructor
+                       ADM_audioStreamDCA(WAVHeader *header,ADM_audioAccess *access);  
+/// Destructor
+virtual                 ~ADM_audioStreamDCA();
+///  Get a packet
+virtual uint8_t         getPacket(uint8_t *buffer,uint32_t *size, uint32_t sizeMax,
+                                uint32_t *nbSample,uint64_t *dts);
+/// Go to a given time, in microseconds
+virtual bool            goToTime(uint64_t nbUs);
+/// Returns or compute duration. If the access cannot provide it, it will be computed here
+        uint64_t        getDurationInUs(void) {return durationInUs;}
+};
+#endif
+// EOF
+

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamDCA.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamDCA.cpp	2009-12-30 19:03:34 UTC (rev 5780)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamDCA.cpp	2009-12-30 19:03:36 UTC (rev 5781)
@@ -0,0 +1,98 @@
+/**
+    \file ADM_audioStreamDCA
+    \brief DCA Handling class
+
+*/
+#include "ADM_default.h"
+#include "ADM_audioStreamDCA.h"
+#include "ADM_dcainfo.h"
+
+/**
+    \fn ADM_audioStreamDCA
+    \brief constructor
+*/
+ADM_audioStreamDCA::ADM_audioStreamDCA(WAVHeader *header,ADM_audioAccess *access) : ADM_audioStreamBuffered(header,access)
+{
+    if(access->canGetDuration()==false)
+    {
+        // We can compute the duration from the length
+        float size=access->getLength();
+              size/=header->byterate; // Result is in second
+              size*=1000;
+              size*=1000; // s->us
+              durationInUs=(uint64_t)size;
+    }
+}
+
+/**
+    \fn ADM_audioStream
+    \brief destructor
+*/
+ADM_audioStreamDCA::~ADM_audioStreamDCA()
+{
+
+}
+/**
+    \fn goToTime
+    \brief goToTime
+*/
+bool         ADM_audioStreamDCA::goToTime(uint64_t nbUs)
+{
+    if(access->canSeekTime()==true)
+    {
+        if( access->goToTime(nbUs)==true)
+        {
+           setDts(nbUs);
+           limit=start=0;
+           refill();
+           return 1;
+        }
+        return 1;
+    }
+    // If CBR we can use the default way
+    return ADM_audioStream::goToTime(nbUs);
+
+}
+/**
+        \fn getPacket
+*/
+uint8_t ADM_audioStreamDCA::getPacket(uint8_t *obuffer,uint32_t *osize, uint32_t sizeMax,uint32_t *nbSample,uint64_t *dts)
+{
+#define ADM_LOOK_AHEAD DTS_HEADER_SIZE // Need 10 bytes...
+uint8_t data[ADM_LOOK_AHEAD];
+uint32_t offset;
+int size;
+ADM_DCA_INFO info;
+    while(1)
+    {
+        // Do we have sync ?
+        if(needBytes(ADM_LOOK_AHEAD)==false) return 0;
+        // Peek
+        peek(ADM_LOOK_AHEAD,data);
+        // Search start seq
+        if(buffer[start]!=0x7F || buffer[start+1]!=0xFE)
+        {
+            read8();
+            continue;
+        }
+        if(false== ADM_DCAGetInfo(buffer+start, limit-start,&info,&offset))
+        {
+            read8();
+            continue;
+        }
+        ADM_assert(info.frameSizeInBytes<=sizeMax);
+        if(needBytes(info.frameSizeInBytes)==false)
+        {
+            return false;
+        }
+        *osize=info.frameSizeInBytes;
+        read(*osize,obuffer);
+        *nbSample=info.samples;
+        *dts=lastDts;
+        advanceDtsBySample(*nbSample);
+        return 1;
+
+    }
+}
+
+// EOF



From mean at mail.berlios.de  Wed Dec 30 20:03:38 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 30 Dec 2009 20:03:38 +0100
Subject: [Avidemux-svn-commit] r5782 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src
Message-ID: <200912301903.nBUJ3ct0004250@sheep.berlios.de>

Author: mean
Date: 2009-12-30 20:03:37 +0100 (Wed, 30 Dec 2009)
New Revision: 5782

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp
Log:
[audioEncoder] Access wrapper must fetch extradata from encoder (vorbis, aac when global headers is set)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp	2009-12-30 19:03:36 UTC (rev 5781)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp	2009-12-30 19:03:37 UTC (rev 5782)
@@ -72,15 +72,15 @@
 /**
     \fn getPos
 */
-              
+
 uint64_t  ADMAudioFilter_Access::getPos(void)
 {
     return 0;
 }
-           
+
 /**
     \fn getPacket
-*/                
+*/
 bool    ADMAudioFilter_Access::getPacket(uint8_t *buffer, uint32_t *size, uint32_t maxSize,uint64_t *dts)
 {
     uint32_t samples;
@@ -97,6 +97,14 @@
     samplesSeen+=samples;
     return true;
 }
+/**
+    \fn getExtraData
+    \brief Get extradata from encoder
+*/
+bool      ADMAudioFilter_Access::getExtraData(uint32_t *l, uint8_t **d)
+{
+        ADM_assert(encoder);
+        return encoder->extraData(l,d);
+}
 
-
 //EOF



From mean at mail.berlios.de  Wed Dec 30 20:03:40 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 30 Dec 2009 20:03:40 +0100
Subject: [Avidemux-svn-commit] r5783 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <200912301903.nBUJ3eEk004260@sheep.berlios.de>

Author: mean
Date: 2009-12-30 20:03:39 +0100 (Wed, 30 Dec 2009)
New Revision: 5783

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
Log:
[save] Handle the case where audio encoder failed its initalization

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2009-12-30 19:03:37 UTC (rev 5782)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2009-12-30 19:03:39 UTC (rev 5783)
@@ -1,7 +1,7 @@
 /***************************************************************************
            \file               gui_savenew.cpp
            \brief Save movie files
-    
+
     copyright            : (C) 2002/2009 by mean
     email                : fixounet at free.fr
  ***************************************************************************/
@@ -41,7 +41,7 @@
 #include "ADM_filterChain.h"
 #include "ADM_videoEncoderApi.h"
 /*
-    
+
 */
 ADM_muxer               *ADM_MuxerSpawnFromIndex(int index);
 extern ADM_audioStream  *audioCreateEncodingStream(uint64_t startTime,int32_t shift);
@@ -67,12 +67,12 @@
         int                  muxerIndex;
         int                  videoEncoderIndex;
         ADM_coreVideoEncoder *handleFirstPass(ADM_coreVideoEncoder *pass1);
-        
+
 public:
                 admSaver(const char *out);
                 ~admSaver();
         bool    save(void);
-        
+
 };
 /**
     \fn admSaver
@@ -99,16 +99,16 @@
 */
 admSaver::~admSaver()
 {
- if(muxer) 
+ if(muxer)
         delete muxer;
  muxer=NULL;
- if(logFileName) 
+ if(logFileName)
         delete [] logFileName;
  logFileName=NULL;
  if ( astreams[0])
         delete astreams[0];
  astreams[0]=NULL;
- if(video)   
+ if(video)
         delete video;
  video=NULL;
   if(chain)
@@ -160,7 +160,7 @@
                     return NULL;
                 }
                 ADMBitstream bitstream;
-    
+
                 uint8_t *buffer=new uint8_t[BUFFER_SIZE];
                 bitstream.data=buffer;
                 bitstream.bufferSize=BUFFER_SIZE;
@@ -190,7 +190,7 @@
                 destroyVideoFilterChain(chain);
                 chain=NULL;
                 chain=createVideoFilterChain(markerA,markerB);
-                
+
                 if(!chain)
                 {
                     printf("[Save] Cannot recreate video filter chain\n");
@@ -200,7 +200,7 @@
                 ADM_assert(sz);
                 last=(*chain)[sz-1]; // Grab last filter
                 ADM_coreVideoEncoder *pass2=createVideoEncoderFromIndex(last,videoEncoderIndex);
-                if(!pass2) 
+                if(!pass2)
                 {
                     printf("[Save] Cannot create encoder for pass 2\n");
                     return NULL;
@@ -227,7 +227,7 @@
                 printf(": Pass2 done : %d frames this time\n",nbFrames);
                 delete [] buffer;
                 delete encoding;
-                
+
 #endif
     return pass2;
 }
@@ -236,10 +236,10 @@
 */
 bool admSaver::save(void)
 {
-    int ret=1; 
+    int ret=1;
     uint64_t startAudioTime=markerA; // Actual start time (for both audio & video actually)
     printf("[A_Save] Saving..\n");
-    
+
     if(!(muxer=ADM_MuxerSpawnFromIndex(muxerIndex)))
     {
         GUI_Error_HIG("Muxer","Cannot instantiante muxer");
@@ -258,7 +258,7 @@
         audio->goToTime(startAudioTime); // Rewind audio
     }
     ADM_videoStream *video=NULL;
-    // Video Stream 
+    // Video Stream
     if(!videoEncoderIndex) // Copy
     {
         ADM_videoStreamCopy *copy=new ADM_videoStreamCopy(markerA,markerB);
@@ -271,7 +271,7 @@
     {
         // 1- create filter chain
         //******************************
-       
+
         chain=createVideoFilterChain(markerA,markerB);
         if(!chain)
         {
@@ -322,19 +322,24 @@
     {
         if(audio)
             astreams[0]=audioCreateCopyStream(startAudioTime,0,audio); //copy
-    }else    
+    }else
     {
         if(audio)   // Process
         {
             // Access..
             ADM_audioStream *access=audioCreateEncodingStream(startAudioTime,0); // FIXME LEAK
             astreams[0]=access;
+            if(!access)
+            {
+                    GUI_Error_HIG("Audio","Cannot setup audio encoder, make sure your stream is compatible with audio encoder (number of channels, bitrate, format)");
+                    return false;
+            }
         }
     }
     if(!muxer->open(fileName,video,nbAStream,astreams))
     {
         GUI_Error_HIG("Muxer","Cannot open ");
-    }else   
+    }else
     {
         muxer->save();
         muxer->close();



From mean at mail.berlios.de  Wed Dec 30 20:03:42 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 30 Dec 2009 20:03:42 +0100
Subject: [Avidemux-svn-commit] r5784 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include
Message-ID: <200912301903.nBUJ3gln004270@sheep.berlios.de>

Author: mean
Date: 2009-12-30 20:03:42 +0100 (Wed, 30 Dec 2009)
New Revision: 5784

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_access.h
Log:
[audioEncoder] Access wrapper must fetch extradata from encoder (vorbis, aac when global headers is set)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_access.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_access.h	2009-12-30 19:03:39 UTC (rev 5783)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_access.h	2009-12-30 19:03:42 UTC (rev 5784)
@@ -3,7 +3,7 @@
             \brief convert audiofilter to audioaccess (used for playback for example)
             (C) Mean 2009 fixounet at free.fr
  ***************************************************************************/
- 
+
 /***************************************************************************
  *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
@@ -47,15 +47,9 @@
                                     /// Get position in bytes
                 virtual uint64_t  getPos(void);
                                     /// Grab extra data
-                virtual bool      getExtraData(uint32_t *l, uint8_t **d)
-                                    {
-                                            *l=extraDataLen;    
-                                            *d=extraData;
-                                            return true;
-                                    };
+                virtual bool      getExtraData(uint32_t *l, uint8_t **d);
 
-                
-                virtual bool    getPacket(uint8_t *buffer, uint32_t *size, uint32_t maxSize,uint64_t *dts);    
+                virtual bool    getPacket(uint8_t *buffer, uint32_t *size, uint32_t maxSize,uint64_t *dts);
                 virtual bool    isCBR(void);
 };
 



From mean at mail.berlios.de  Wed Dec 30 20:03:44 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 30 Dec 2009 20:03:44 +0100
Subject: [Avidemux-svn-commit] r5785 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src
Message-ID: <200912301903.nBUJ3iXk004280@sheep.berlios.de>

Author: mean
Date: 2009-12-30 20:03:43 +0100 (Wed, 30 Dec 2009)
New Revision: 5785

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
Log:
[coreMuxerFFmpeg] Handle DTS case

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2009-12-30 19:03:42 UTC (rev 5784)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2009-12-30 19:03:43 UTC (rev 5785)
@@ -2,10 +2,10 @@
             \file            muxerFFmpeg
             \brief           Base class for ffmpeg based muxer
                              -------------------
-    
+
     copyright            : (C) 2009 by mean
     email                : fixounet at free.fr
-        
+
  ***************************************************************************/
 
 /***************************************************************************
@@ -91,7 +91,7 @@
 	snprintf(oc->filename,1000,"file://%s",filename);
     // probably a memeleak here
     char *foo=ADM_strdup(filename);
-    
+
     strcpy(oc->title,ADM_GetFileName(foo));
     strcpy(oc->author,"Avidemux");
     printf("[FF] Muxer opened\n");
@@ -124,7 +124,7 @@
                 c->extradata=videoExtraData;
                 c->extradata_size= videoExtraDataSize;
         }
-        
+
         c->rc_buffer_size=8*1024*224;
         c->rc_max_rate=9500*1000;
         c->rc_min_rate=0;
@@ -141,7 +141,7 @@
                 {
                     c->has_b_frames=1; // in doubt...
                     c->max_b_frames=2;
-                }else   
+                }else
                 {
                     c->has_b_frames=0; // No PTS=cannot handle CTS...
                     c->max_b_frames=0;
@@ -238,7 +238,7 @@
     {
           uint32_t audioextraSize;
           uint8_t  *audioextraData;
-          
+
           audio[i]->getExtraData(&audioextraSize,&audioextraData);
 
           audio_st = av_new_stream(oc, 1);
@@ -255,11 +255,12 @@
           c->sample_rate = audioheader->frequency;
           switch(audioheader->encoding)
           {
-                  case WAV_OGG_VORBIS: 
+                  case WAV_OGG_VORBIS:
                                 c->codec_id = CODEC_ID_VORBIS;c->frame_size=6*256;
                                 c->extradata=audioextraData;
                                 c->extradata_size= audioextraSize;
                                 break;
+                  case WAV_DTS: c->codec_id = CODEC_ID_DTS;c->frame_size=1024;break;
                   case WAV_AC3: c->codec_id = CODEC_ID_AC3;c->frame_size=6*256;break;
                   case WAV_MP2: c->codec_id = CODEC_ID_MP2;c->frame_size=1152;break;
                   case WAV_MP3:
@@ -279,7 +280,7 @@
                                   break;
                   default:
                                  printf("[FF]: Unsupported audio\n");
-                                 return false; 
+                                 return false;
                           break;
           }
           c->codec_type = CODEC_TYPE_AUDIO;
@@ -332,7 +333,7 @@
     ADM_info("avg fps=%u\n",vStream->getAvgFps1000());
     AVRational *scale=&(video_st->codec->time_base);
     uint64_t videoDuration=vStream->getVideoDuration();
-    
+
     encoding=createWorking(title);
 
     MuxAudioPacket audioPackets[nbAStreams];
@@ -348,9 +349,9 @@
                     p/=videoDuration;
                     p=p*100;
             }
-            
+
             encoding->update((uint32_t)p);
-            if(!encoding->isAlive()) 
+            if(!encoding->isAlive())
             {
                 result=false;
                 break;
@@ -404,14 +405,14 @@
                 MuxAudioPacket *audioTrack=&(audioPackets[audio]);
                 ADM_audioStream*a=aStreams[audio];
                 uint32_t fq=a->getInfo()->frequency;
-            
+
                 while(1)
                 {
                     if(audioTrack->eof==true) break; // no more packet for this track
                     if(audioTrack->present==false)
                     {
                         if(false==a->getPacket(audioTrack->buffer,
-                                                &(audioTrack->size), 
+                                                &(audioTrack->size),
                                                 AUDIO_BUFFER_SIZE,
                                                 &(audioTrack->samples),
                                                 &(audioTrack->dts)))
@@ -435,7 +436,7 @@
                    //printf("[FF] A: Video frame  %d, audio Dts :%"LLU" size :%"LU" nbSample : %"LU" rescaled:%"LLU"\n",
                      //               written,audioTrack->dts,audioTrack->size,audioTrack->samples,rescaledDts);
                     av_init_packet(&pkt);
-                    
+
                     pkt.dts=rescaledDts;
                     pkt.pts=rescaledDts;
                     pkt.stream_index=1+audio;



From mean at mail.berlios.de  Wed Dec 30 20:03:46 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 30 Dec 2009 20:03:46 +0100
Subject: [Avidemux-svn-commit] r5787 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <200912301903.nBUJ3kUR004300@sheep.berlios.de>

Author: mean
Date: 2009-12-30 20:03:46 +0100 (Wed, 30 Dec 2009)
New Revision: 5787

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
Log:
[save] Remove unneeded commented lines (cosmetic)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2009-12-30 19:03:45 UTC (rev 5786)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2009-12-30 19:03:46 UTC (rev 5787)
@@ -23,9 +23,6 @@
 #include "DIA_coreToolkit.h"
 #include "DIA_enter.h"
 #include "ADM_coreAudio.h"
-
-//#include "ADM_videoFilter.h"
-//#include "ADM_videoFilter_internal.h"
 #include "ADM_encoderConf.h"
 
 #include "ADM_encoderConf.h"



From mean at mail.berlios.de  Wed Dec 30 20:03:45 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 30 Dec 2009 20:03:45 +0100
Subject: [Avidemux-svn-commit] r5786 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src
Message-ID: <200912301903.nBUJ3jd8004290@sheep.berlios.de>

Author: mean
Date: 2009-12-30 20:03:45 +0100 (Wed, 30 Dec 2009)
New Revision: 5786

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/CMakeLists.txt
Log:
[DCA] Add parser to cmakelists.txt

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/CMakeLists.txt	2009-12-30 19:03:43 UTC (rev 5785)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/CMakeLists.txt	2009-12-30 19:03:45 UTC (rev 5786)
@@ -6,6 +6,7 @@
 ADM_audioStreamMP3.cpp
 ADM_audioStreamAC3.cpp
 ADM_audioStreamEac3.cpp
+ADM_audioStreamDCA.cpp
 ADM_audioStreamConstantChunk.cpp
 )	
 #*************************************************



From mean at mail.berlios.de  Wed Dec 30 20:03:47 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 30 Dec 2009 20:03:47 +0100
Subject: [Avidemux-svn-commit] r5788 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav
Message-ID: <200912301903.nBUJ3l4r004312@sheep.berlios.de>

Author: mean
Date: 2009-12-30 20:03:47 +0100 (Wed, 30 Dec 2009)
New Revision: 5788

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
Log:
[lav/audioDecoder] simplify channel mapping

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp	2009-12-30 19:03:46 UTC (rev 5787)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp	2009-12-30 19:03:47 UTC (rev 5788)
@@ -242,29 +242,13 @@
             {
             CHANNEL_TYPE *p_ch_type = channelMapping;
 #define DOIT(x,y) if(_context->channel_layout & CH_##x) *(p_ch_type++)=ADM_CH_##y;
-            //if(_context->codec_id == CODEC_ID_DTS)
-                {
                     
                     DOIT(FRONT_LEFT,FRONT_LEFT);
                     DOIT(FRONT_RIGHT,FRONT_RIGHT);
-                    DOIT(FRONT_CENTER,FRONT_CENTER);
-
-                    
+                    DOIT(FRONT_CENTER,FRONT_CENTER);                    
                     DOIT(LOW_FREQUENCY,LFE);
                     DOIT(SIDE_LEFT,REAR_LEFT);
                     DOIT(SIDE_RIGHT,REAR_RIGHT);
-                }
-#if 0
-else   
-                {
-                    DOIT(LOW_FREQUENCY,LFE);
-                    DOIT(FRONT_LEFT,FRONT_LEFT);
-                    DOIT(FRONT_CENTER,FRONT_CENTER);
-                    DOIT(FRONT_RIGHT,FRONT_RIGHT);
-                    DOIT(SIDE_LEFT,REAR_LEFT);
-                    DOIT(SIDE_RIGHT,REAR_RIGHT);
-                }
-#endif
             }
         
         return 1;



From mean at mail.berlios.de  Wed Dec 30 20:03:49 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 30 Dec 2009 20:03:49 +0100
Subject: [Avidemux-svn-commit] r5789 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src
Message-ID: <200912301903.nBUJ3n5v004326@sheep.berlios.de>

Author: mean
Date: 2009-12-30 20:03:48 +0100 (Wed, 30 Dec 2009)
New Revision: 5789

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp
Log:
[encoding] Silence end of stream warning (display it only once)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp	2009-12-30 19:03:47 UTC (rev 5788)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp	2009-12-30 19:03:48 UTC (rev 5789)
@@ -83,11 +83,16 @@
 */
 bool    ADMAudioFilter_Access::getPacket(uint8_t *buffer, uint32_t *size, uint32_t maxSize,uint64_t *dts)
 {
+static bool endMet=false;
     uint32_t samples;
     bool r=encoder->encode(buffer,size,&samples);
     if(false==r)
     {
-        printf("[Access] getpacket failed for encoding\n");
+        if(endMet==false)
+        {
+            ADM_warning("[Access] getpacket failed for encoding\n");
+            endMet=true;
+        }
         return false;
     }
 
@@ -95,6 +100,7 @@
     d*=1000*1000;
     *dts=startTimeUs+(uint64_t)d;
     samplesSeen+=samples;
+    endMet=false;
     return true;
 }
 /**



From mean at mail.berlios.de  Wed Dec 30 20:03:51 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 30 Dec 2009 20:03:51 +0100
Subject: [Avidemux-svn-commit] r5790 - in
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2:
	include src
Message-ID: <200912301903.nBUJ3ppa004336@sheep.berlios.de>

Author: mean
Date: 2009-12-30 20:03:50 +0100 (Wed, 30 Dec 2009)
New Revision: 5790

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsEditor.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.idl
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
Log:
[JS] Add editor class to offer some internals about avidemux (debug purpose)

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsEditor.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsEditor.h	2009-12-30 19:03:48 UTC (rev 5789)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsEditor.h	2009-12-30 19:03:50 UTC (rev 5790)
@@ -0,0 +1,27 @@
+/**
+    \file ADM_jsAvidemux
+    \brief Standard includes and defines
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_JS_EDITOR_H
+#define ADM_JS_EDITOR_H
+#include "ADM_inttype.h"
+#include "jsapi.h"
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+int jsPrintTiming(int framenumber );
+#ifdef __cplusplus
+};
+#endif
+
+#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2009-12-30 19:03:48 UTC (rev 5789)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2009-12-30 19:03:50 UTC (rev 5790)
@@ -68,41 +68,8 @@
         f++;
     }
 }
+
 /**
-    \fn help
-    \brief dump avidemux specific functions
-*/
-JSBool help(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-#if 0
-        if(!argc)
-        {
-            jsLog(JS_LOG_NORMAL,"help(\"class\"); or help(\"video\"); or help(\"audio\"); or help(\"debug\"); or debug(\"functions\"");
-            return JS_TRUE;
-        }
-        if(argc != 1)
-        {
-          jsLog(JS_LOG_ERROR,"help accepts only one arg, type help() to get them\n");
-          return JS_FALSE;
-        } 
-        JSFunctionSpec *table=NULL;
-        char *f=JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        
-#define DUMPTABLE(x,y) if(!strcasecmp(f,#x)) table=y();
-        if(f)
-        {
-            DUMPTABLE(audio,ADM_JsAudioGetFunctions);
-            DUMPTABLE(video,ADM_JsVideoGetFunctions);
-            DUMPTABLE(debug,ADM_JsDebugGetFunctions);
-            DUMPTABLE(functions,ADM_JsFunctionGetFunctions);
-            DUMPTABLE(class,ADM_JsClassGetFunctions);
-        }
-        if(table) dumpFunc(table);
-        else jsLog(JS_LOG_ERROR,"%s not found",f);
-#endif  
-  return JS_TRUE;
-}
-/**
     \fn dumpEditing
     \brief dump segment, video & all
 */

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor.cpp	2009-12-30 19:03:48 UTC (rev 5789)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor.cpp	2009-12-30 19:03:50 UTC (rev 5790)
@@ -0,0 +1,26 @@
+/**
+    \file ADM_JSif.cpp
+    \brief interface to js
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "ADM_js.h"
+#include <stdarg.h>
+#include <vector>
+#include "ADM_jsEditor.h"
+/**
+    \fn jsPrintTiming
+*/
+int jsPrintTiming(int framenumber )
+{
+    return 0;
+}
+// EOF

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.c	2009-12-30 19:03:48 UTC (rev 5789)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.c	2009-12-30 19:03:50 UTC (rev 5790)
@@ -0,0 +1,192 @@
+/*
+--- DO NOT EDIT THIS FILE !!! ---
+
+This file has been generated automatically with 'jsapigen'.
+
+jsapigen is a glue-code generator for SpiderMonkey. It is distributed
+under the conditions of version 3 of the GNU General Public License.
+Please have a look at http://jsapigen.sourceforge.net.
+
+This file is NOT part of jsapigen and is NOT necessarily covered by
+jsapigen's license. For licensing information regarding this file,
+please refer to the software package which it is part of.
+
+*/
+
+#include "stdio.h"
+#include "ADM_jsEditor.h"
+void jsEditor(void)
+{
+        printf("Constructor invoked\n");
+}
+
+#include <string.h>
+#include <wchar.h>
+#include <jsapi.h>
+#ifndef JS_THREADSAFE
+#if JS_VERSION <= 170
+#define jsrefcount int
+#define JS_BeginRequest(cx)
+#define JS_EndRequest(cx)
+#define JS_SuspendRequest(cx)
+#define JS_ResumeRequest(cx, saveDepth)
+#endif
+#endif
+#ifndef JS_FS
+#define JS_FS(name, call, nargs, flags, extra) {name, call, nargs, flags, extra}
+#endif
+#ifndef JS_FS_END
+#define JS_FS_END {NULL, NULL, 0, 0, 0}
+#endif
+static JSPropertySpec jj_static_ps[] = {
+    {NULL, 0, 0, NULL, NULL}
+};
+static JSPropertySpec jj_ps[] = {
+    {NULL, 0, 0, NULL, NULL}
+};
+static JSFunctionSpec jj_static_fs[] = {
+    JS_FS_END
+};
+static JSFunctionSpec jj_fs[] = {
+    JS_FS_END
+};
+static JSBool
+jjeditorprintTiming(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var2;
+    int var7;
+    int var3;
+    int var6;
+    int var8;
+    jsval var9;
+    int32 var10;
+    jsval var11;
+    JSBool var1;
+    var2 = NULL;
+    var7 = 0;
+    var3 = 0;
+    var6 = 0;
+    var8 = 0;
+    var9 = JSVAL_NULL;
+    var10 = 0;
+    var11 = JSVAL_NULL;
+    var1 = JS_FALSE;
+    var2 = obj;
+    var6 = argc;
+    var8 = 0;
+    var8 = var8 < var6;
+    if (var8) {
+    var9 = argv[0];
+    if (JS_ValueToInt32(cx, var9, &var10) != JS_TRUE) {
+        goto do_return;
+    }
+    var7 = (int)var10;
+    }
+    var3 = jsPrintTiming(var7);
+    if (JS_NewNumberValue(cx, var3, &var11) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+0] = var11;
+    if (rval) {
+        *rval = var11;
+    }
+    var1 = JS_TRUE;
+    do_return:
+    return var1;
+}
+static JSBool
+jjeditor__construct__(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var13;
+    int var17;
+    JSBool var12;
+    var13 = NULL;
+    var17 = 0;
+    var12 = JS_FALSE;
+    var13 = obj;
+    var17 = argc;
+    jsEditor();
+    var12 = JS_TRUE;
+    return var12;
+}
+static JSPropertySpec jjeditor_static_ps[] = {
+    {NULL, 0, 0, NULL, NULL}
+};
+static JSPropertySpec jjeditor_ps[] = {
+    {NULL, 0, 0, NULL, NULL}
+};
+static JSFunctionSpec jjeditor_static_fs[] = {
+    JS_FS("printTiming", jjeditorprintTiming, 1, 0, 1),
+    JS_FS_END
+};
+static JSFunctionSpec jjeditor_fs[] = {
+    JS_FS_END
+};
+static JSClass jjeditor_class = {
+    "editor",
+    0,
+    JS_PropertyStub,
+    JS_PropertyStub,
+    JS_PropertyStub,
+    JS_PropertyStub,
+    JS_EnumerateStub,
+    JS_ResolveStub,
+    JS_ConvertStub,
+    JS_FinalizeStub,
+    NULL,
+    NULL,
+    NULL,
+    jjeditor__construct__,
+    NULL,
+    NULL,
+    NULL,
+    NULL
+};
+static JSObject *
+jjeditor_init(JSContext *cx, JSObject *obj)
+{
+    JSObject *parent_proto, *proto;
+    JSClass *class;
+    if (!cx || !obj) {
+        JS_ReportError(cx, "invalid parameter");
+        return NULL;
+    }
+    if (!JS_EnterLocalRootScope(cx)) {
+        JS_ReportError(cx, "JS_EnterLocalRootScope failed");
+        return NULL;
+    }
+    parent_proto = NULL;
+    proto = NULL;
+    parent_proto = JS_NewObject(cx, NULL, NULL, NULL);
+    if (!parent_proto) {
+        JS_LeaveLocalRootScope(cx);
+        JS_ReportError(cx, "failed to create prototype");
+        return NULL;
+    }
+    class = &jjeditor_class;
+    proto = JS_InitClass(cx, obj, parent_proto, class, jjeditor__construct__, 0, jjeditor_ps, jjeditor_fs, jjeditor_static_ps, jjeditor_static_fs);
+    if (!proto) {
+        JS_LeaveLocalRootScope(cx);
+        JS_ReportError(cx, "failed to init class");
+        return NULL;
+    }
+    JS_LeaveLocalRootScope(cx);
+    return proto;
+}
+
+
+JSObject *jsEditorInit(JSContext *cx,JSObject *obj)
+{
+          if (JS_DefineFunctions(cx, obj, jj_static_fs) != JS_TRUE) 
+          {
+                return NULL;
+          }
+          return jjeditor_init(cx,obj);
+}
+
+JSFunctionSpec  *jsGetEditFunctions(void)
+{
+        return jjeditor_static_fs;
+}
+
+

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.idl	2009-12-30 19:03:48 UTC (rev 5789)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.idl	2009-12-30 19:03:50 UTC (rev 5790)
@@ -0,0 +1,35 @@
+%{
+#include "stdio.h"
+#include "ADM_jsEditor.h"
+void jsEditor(void)
+{
+        printf("Constructor invoked\n");
+}
+%}
+        /*            JSFUNC      C FUNC  PARAM     */
+class editor
+{
+        /*            JSFUNC                 C FUNC           PARAM     */
+        function int printTiming     : jsPrintTiming(int ) <static>;
+        /*            JSFUNC                 C FUNC           PARAM     */
+        
+        construct                          : jsEditor  ( ) <static>     ; 
+};
+
+%<
+
+JSObject *jsEditorInit(JSContext *cx,JSObject *obj)
+{
+          if (JS_DefineFunctions(cx, obj, jj_static_fs) != JS_TRUE) 
+          {
+                return NULL;
+          }
+          return jjeditor_init(cx,obj);
+}
+
+JSFunctionSpec  *jsGetEditFunctions(void)
+{
+        return jjeditor_static_fs;
+}
+
+%>

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-30 19:03:48 UTC (rev 5789)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsIf.cpp	2009-12-30 19:03:50 UTC (rev 5790)
@@ -147,6 +147,8 @@
 extern "C" JSFunctionSpec  *jsGetIfFunctions(void);
 extern "C" JSFunctionSpec  *jsGetTestFunctions(void);
 extern "C" JSFunctionSpec  *jsGetAdmFunctions(void);
+extern "C" JSFunctionSpec  *jsGetEditFunctions(void);
+extern "C" JSObject *jsEditorInit(JSContext *cx,JSObject *obj);
 extern "C" JSObject *jsAvidemuxInit(JSContext *cx,JSObject *obj);
 static bool registerOne(const char *name,const char *text,JSFunctionSpec *s,JSContext *cx,JSObject *obj)
 {
@@ -210,12 +212,19 @@
 ADM_JS_HOOK h;
         registerOne("Debug","",   jsGetIfFunctions(),    cx,obj);
         registerOne("Test","", jsGetTestFunctions(),  cx,obj);
+        
         // Register also our class (for  help() )
             h.name="adm";
             h.text="Please prefix this with adm.";
             h.jsFunctions=jsGetAdmFunctions();
             jsHooks.push_back(h);
             jsAvidemuxInit(cx,obj);
+        // Register also edit
+            h.name="editor";
+            h.text="Please prefix this with editor.";
+            h.jsFunctions=jsGetEditFunctions();
+            jsHooks.push_back(h);
+            jsEditorInit(cx,obj);
             return true;
 }
 /**

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2009-12-30 19:03:48 UTC (rev 5789)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2009-12-30 19:03:50 UTC (rev 5790)
@@ -10,7 +10,11 @@
 # Load segment
         ADM_jsAvidemux.cpp
         ADM_jsAvidemux_js.c
-#
+# Debug / editor class
+        ADM_jsEditor.cpp
+        ADM_jsEditor_js.c
+
+# 
         ADM_jsVideo.cpp
 #
         ADM_jsAudio.cpp



From gruntster at mail.berlios.de  Wed Dec 30 20:08:24 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 30 Dec 2009 20:08:24 +0100
Subject: [Avidemux-svn-commit] r5791 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec
Message-ID: <200912301908.nBUJ8Oj2005712@sheep.berlios.de>

Author: gruntster
Date: 2009-12-30 20:08:15 +0100 (Wed, 30 Dec 2009)
New Revision: 5791

Added:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Mpeg4aspParam.xsd
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.h
Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
Log:
[mpeg4] avcodec MPEG-4 ASP video plugin

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-30 19:03:50 UTC (rev 5790)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-30 19:08:15 UTC (rev 5791)
@@ -12,14 +12,15 @@
 							 ffvhuffEncoder.cpp  ffv1Encoder.cpp  dvEncoder.cpp  ../common/PluginOptions.cpp
 							 mpeg1Encoder.cpp  mpeg1EncoderOptions.cpp  mpeg2Encoder.cpp  mpeg2EncoderOptions.cpp
 							 flv1Encoder.cpp  flv1EncoderOptions.cpp  mjpegEncoder.cpp  mjpegEncoderOptions.cpp
-							 h263Encoder.cpp  h263EncoderOptions.cpp)
+							 h263Encoder.cpp  h263EncoderOptions.cpp  mpeg4aspEncoder.cpp  mpeg4aspEncoderOptions.cpp)
 
 set(PLUGIN_SCHEMA_DIR "avcodec")
 set(MPEG1_PLUGIN_CONFIG_DIR "avcodec/mpeg-1")
 set(MPEG2_PLUGIN_CONFIG_DIR "avcodec/mpeg-2")
 set(FLV1_PLUGIN_CONFIG_DIR "avcodec/flv1")
 set(MJPEG_PLUGIN_CONFIG_DIR "avcodec/mjpeg")
-set(MJPEG_PLUGIN_CONFIG_DIR "avcodec/h263")
+set(H263_PLUGIN_CONFIG_DIR "avcodec/h263")
+set(MPEG4ASP_PLUGIN_CONFIG_DIR "avcodec/mpeg4asp")
 
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${LIBXML2_INCLUDE_DIR})
 ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_SCHEMA_DIR="${PLUGIN_SCHEMA_DIR}")
@@ -28,6 +29,7 @@
 set_property(SOURCE flv1EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DFLV1_PLUGIN_CONFIG_DIR=\\\"${FLV1_PLUGIN_CONFIG_DIR}\\\")
 set_property(SOURCE mjpegEncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMJPEG_PLUGIN_CONFIG_DIR=\\\"${MJPEG_PLUGIN_CONFIG_DIR}\\\")
 set_property(SOURCE h263EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DH263_PLUGIN_CONFIG_DIR=\\\"${H263_PLUGIN_CONFIG_DIR}\\\")
+set_property(SOURCE mpeg4aspEncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMPEG4ASP_PLUGIN_CONFIG_DIR=\\\"${MPEG4ASP_PLUGIN_CONFIG_DIR}\\\")
 
 getFfmpegLibNames(${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_libraries/ffmpeg)
 
@@ -46,4 +48,5 @@
 INSTALL(FILES Mpeg2Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
 INSTALL(FILES Flv1Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
 INSTALL(FILES MjpegParam.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
-INSTALL(FILES H263Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
\ No newline at end of file
+INSTALL(FILES H263Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
+INSTALL(FILES Mpeg4aspParam.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Mpeg4aspParam.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Mpeg4aspParam.xsd	2009-12-30 19:03:50 UTC (rev 5790)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Mpeg4aspParam.xsd	2009-12-30 19:08:15 UTC (rev 5791)
@@ -0,0 +1,132 @@
+<?xml version="1.0" encoding="utf-8"?>
+<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified">
+  <xs:element name="H263Config">
+    <xs:complexType>
+      <xs:sequence>
+        <xs:element name="presetConfiguration" minOccurs="0">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="name" type="xs:string"/>
+              <xs:element name="type">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="default"/>
+                    <xs:enumeration value="user"/>
+                    <xs:enumeration value="system"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+        <xs:element name="encodeOptions" minOccurs="0">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="mode">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="CQP"/>
+                    <xs:enumeration value="2PASS SIZE"/>
+                    <xs:enumeration value="2PASS ABR"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="parameter" type="uint"/>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+        <xs:element name="H263Options">
+          <xs:complexType>
+            <xs:sequence>
+              <xs:element name="motionEstimationMethod">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="none"/>
+                    <xs:enumeration value="full"/>
+                    <xs:enumeration value="log"/>
+                    <xs:enumeration value="phods"/>
+                    <xs:enumeration value="epzs"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="fourMotionVector" type="xs:boolean" minOccurs="0"/>
+              <xs:element name="maximumBFrames" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="0"/>
+                    <xs:maxInclusive value="32"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="quarterPixel" type="xs:boolean" minOccurs="0"/>
+              <xs:element name="globalMotionCompensation" type="xs:boolean" minOccurs="0"/>
+              <xs:element name="quantisationType">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="h263"/>
+                    <xs:enumeration value="mpeg"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="macroblockDecisionMode">
+                <xs:simpleType>
+                  <xs:restriction base="xs:string">
+                    <xs:enumeration value="sad"/>
+                    <xs:enumeration value="fewestBits"/>
+                    <xs:enumeration value="rateDistortion"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="minimumQuantiser" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="1"/>
+                    <xs:maxInclusive value="31"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="maximumQuantiser" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="1"/>
+                    <xs:maxInclusive value="31"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="quantiserDifference" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:integer">
+                    <xs:minInclusive value="1"/>
+                    <xs:maxInclusive value="31"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="trellis" type="xs:boolean" minOccurs="0"/>
+              <xs:element name="quantiserCompression" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:float">
+                    <xs:minInclusive value="0"/>
+                    <xs:maxInclusive value="1"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+              <xs:element name="quantiserBlur" minOccurs="0">
+                <xs:simpleType>
+                  <xs:restriction base="xs:float">
+                    <xs:minInclusive value="0"/>
+                    <xs:maxInclusive value="1"/>
+                  </xs:restriction>
+                </xs:simpleType>
+              </xs:element>
+            </xs:sequence>
+          </xs:complexType>
+        </xs:element>
+      </xs:sequence>
+    </xs:complexType>
+  </xs:element>
+  <xs:simpleType name="uint">
+    <xs:restriction base="xs:integer">
+      <xs:minInclusive value="0"/>
+    </xs:restriction>
+  </xs:simpleType>
+</xs:schema>

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2009-12-30 19:03:50 UTC (rev 5790)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2009-12-30 19:08:15 UTC (rev 5791)
@@ -25,6 +25,7 @@
 #include "mjpegEncoder.h"
 #include "mpeg1Encoder.h"
 #include "mpeg2Encoder.h"
+#include "mpeg4aspEncoder.h"
 #include "ADM_inttype.h"
 
 int uiType;
@@ -38,9 +39,10 @@
 static MjpegEncoder mjpeg;
 static Mpeg1Encoder mpeg1;
 static Mpeg2Encoder mpeg2;
+static Mpeg4aspEncoder mpeg4asp;
 
-static int encoderIds[] = { 0, 1, 2, 3, 4, 5, 6, 7, 8 };
-static AvcodecEncoder* encoders[] = { &dv, &flv1, &ffv1, &ffvhuff, &h263, &huffyuv, &mjpeg, &mpeg1, &mpeg2};
+static int encoderIds[] = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 };
+static AvcodecEncoder* encoders[] = { &dv, &flv1, &ffv1, &ffvhuff, &h263, &huffyuv, &mjpeg, &mpeg1, &mpeg2, &mpeg4asp};
 
 extern "C"
 {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-30 19:03:50 UTC (rev 5790)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-30 19:08:15 UTC (rev 5791)
@@ -71,7 +71,7 @@
 void vidEncGetEncoderVersion(int encoderId, int* major, int* minor, int* patch)
 {
 	*major = 1;
-	*minor = 4;
+	*minor = 5;
 	*patch = 0;
 }
 

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.cpp	2009-12-30 19:03:50 UTC (rev 5790)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.cpp	2009-12-30 19:08:15 UTC (rev 5791)
@@ -0,0 +1,543 @@
+ /***************************************************************************
+                             mpeg4aspEncoder.cpp
+
+    begin                : Wed Dec 30 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+ /**************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include <sstream>
+#include <string>
+#include <libxml/tree.h>
+
+#include "ADM_inttype.h"
+#include "DIA_coreToolkit.h"
+#include "mpeg4aspEncoder.h"
+
+extern int _uiType;
+static bool changedConfig(const char* fileName, ConfigMenuType configType);
+static char *serializeConfig(void);
+static Mpeg4aspEncoder *encoder = NULL;
+
+#ifdef __WIN32
+extern void convertPathToAnsi(const char *path, char **ansiPath);
+#endif
+
+Mpeg4aspEncoder::Mpeg4aspEncoder(void)
+{
+	encoder = this;
+
+	init(CODEC_ID_MPEG4, ADM_CSP_YV12);
+
+	_encodeOptions.structSize = sizeof(vidEncOptions);
+	_encodeOptions.encodeMode = MPEG4ASP_DEFAULT_ENCODE_MODE;
+	_encodeOptions.encodeModeParameter = MPEG4ASP_DEFAULT_ENCODE_MODE_PARAMETER;
+
+	_bitrateParam.capabilities = ADM_ENC_CAP_CBR | ADM_ENC_CAP_CQ | ADM_ENC_CAP_2PASS | ADM_ENC_CAP_2PASS_BR;
+	_bitrateParam.qz = MPEG4ASP_DEFAULT_ENCODE_MODE_PARAMETER;
+	_bitrateParam.bitrate = 1500;
+	_bitrateParam.avg_bitrate = 1000;
+	_bitrateParam.finalsize = 700;
+
+	_statFile = NULL;
+}
+
+int Mpeg4aspEncoder::initContext(const char* logFileName)
+{
+	int ret = AvcodecEncoder::initContext(logFileName);
+
+	_context->me_method = (int)_options.getMotionEstimationMethod();
+
+	if (_options.get4MotionVector())
+		_context->flags |= CODEC_FLAG_4MV;
+
+	_context->max_b_frames = _options.getMaxBFrames();
+
+	if (_options.getQuarterPixel())
+		_context->flags |= CODEC_FLAG_QPEL;
+	
+	if (_options.getGmc())
+		_context->flags |= CODEC_FLAG_GMC;
+
+	_context->mpeg_quant = (int)_options.getQuantisationType();
+
+	switch (_options.getMbDecisionMode())
+	{
+		case MPEG4ASP_MBDEC_BITS:
+			_context->mb_decision = FF_MB_DECISION_BITS;
+			break;
+		case MPEG4ASP_MBDEC_RD:
+			_context->mb_decision = FF_MB_DECISION_RD;
+			break;
+		default:
+			_context->mb_decision = FF_MB_DECISION_SIMPLE;
+			_context->mb_cmp = FF_CMP_SAD;
+	}
+
+	_context->qmin = _options.getMinQuantiser();
+	_context->qmax = _options.getMaxQuantiser();
+	_context->max_qdiff = _options.getQuantiserDifference();
+	_context->trellis = _options.getTrellis();
+	_context->qcompress = _options.getQuantiserCompression();
+	_context->qblur = _options.getQuantiserBlur();
+
+	_context->lumi_masking = 0.05;
+	_context->dark_masking = 0.01;
+	_context->rc_qsquish = 1.0;
+	_context->luma_elim_threshold = -2;
+	_context->chroma_elim_threshold = -5;
+	_context->i_quant_factor = 0.8;
+	_context->bit_rate_tolerance = 1024 * 8 * 1000;
+	_context->gop_size = 250;
+
+	if (_currentPass == 1)
+	{
+		if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_CBR)
+			_context->bit_rate = _encodeOptions.encodeModeParameter * 1000;
+		else
+		{
+			_context->bit_rate = 0;
+			_context->flags |= CODEC_FLAG_QSCALE;
+		}
+
+		if (_passCount > 1)
+			_context->flags |= CODEC_FLAG_PASS1;
+	}
+	else
+	{
+		_context->flags |= CODEC_FLAG_PASS2;
+
+		if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE)
+			_context->bit_rate = calculateBitrate(_fpsNum, _fpsDen, _frameCount, _encodeOptions.encodeModeParameter);
+		else
+			_context->bit_rate = _encodeOptions.encodeModeParameter * 1000;
+	}
+
+	if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE || _encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_ABR)
+	{
+		char *log = NULL;
+
+#ifdef __WIN32
+		convertPathToAnsi(logFileName, &log);
+#else
+		log = new char[strlen(logFileName) + 1];
+		strcpy(log, logFileName);
+#endif
+
+		if (_currentPass == 1)
+		{
+			_statFile = fopen(log, "wb");
+
+			if (!_statFile)
+				ret = ADM_VIDENC_ERR_FAILED;
+		}
+		else
+		{
+			FILE *statFile = fopen(log, "rb");
+
+			if (statFile)
+			{
+				fseek(statFile, 0, SEEK_END);
+
+				long statSize = ftello(statFile);
+
+				fseek(statFile, 0, SEEK_SET);
+				_context->stats_in = new char[statSize + 1];
+				_context->stats_in[statSize] = 0;
+
+				fread(_context->stats_in, statSize, 1, statFile);
+				fclose(statFile);
+			}
+			else
+				ret = ADM_VIDENC_ERR_FAILED;
+		}
+	}
+
+	return ret;
+}
+
+const char* Mpeg4aspEncoder::getEncoderType(void)
+{
+	return "MPEG-4 ASP";
+}
+
+const char* Mpeg4aspEncoder::getEncoderDescription(void)
+{
+	return "MPEG-4 ASP video encoder plugin for Avidemux (c) Mean/Gruntster";
+}
+
+const char* Mpeg4aspEncoder::getFourCC(void)
+{
+	return "DX50";
+}
+
+const char* Mpeg4aspEncoder::getEncoderGuid(void)
+{
+	return "0E7C20E3-FF92-4bb2-A9A9-55B7F713C45A";
+}
+
+int Mpeg4aspEncoder::isConfigurable(void)
+{
+	return (_uiType == ADM_UI_GTK || _uiType == ADM_UI_QT4);
+}
+
+int Mpeg4aspEncoder::configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties)
+{
+	loadSettings(&_encodeOptions, &_options);
+
+	diaMenuEntry meE[] = {
+		{0, "None"},
+		{1, "Full"},
+		{2, "Log"},
+		{3, "Phods"},
+		{4, "EPZS"}};
+
+	diaMenuEntry qzE[] = {
+		{0, "H.263"},
+		{1, "MPEG"}};
+
+	diaMenuEntry rdE[] = {
+		{0, "Sum of Absolute Differences"},
+		{1, "Fewest Bits"},
+		{2, "Rate Distortion"}};
+
+	// Encoding mode
+	diaElemBitrate ctlBitrate(&_bitrateParam, NULL);
+		
+	diaElem *diamode[] = {&ctlBitrate};
+	diaElemTabs tabMode("Encoding Mode", 1, diamode);
+
+	// Motion Estimation
+	diaElemMenu ctlMatrices(&_motionEst, "Motion Estimation Method:", 5, meE);
+	diaElemUInteger ctlMaxBFrames(&_maxBFrames, "_Maximum Consecutive B-frames:", 0, 32);
+	diaElemToggle ctl4MV(&_4MV, "4 _Motion Vector");
+	diaElemToggle ctlQpel(&_qpel, "_Quarter Pixel");
+	diaElemToggle ctlGmc(&_gmc, "_Global Motion Compensation");
+
+	diaElem *diaME[] = {&ctlMatrices, &ctlMaxBFrames, &ctl4MV, &ctlQpel, &ctlGmc};
+	diaElemTabs tabME("Motion Estimation", 5, diaME);
+
+	// Quantisation
+	diaElemMenu ctlQuantType(&_quantType, "_Quantisation Type:", 2, qzE);
+	diaElemMenu ctlMbDecision(&_mbDecision, "_Macroblock Decision Mode:", 3, rdE);
+	diaElemUInteger ctlQuantMin(&_minQuantiser, "Mi_nimum Quantiser:", 1, 31);
+	diaElemUInteger ctlQuantMax(&_maxQuantiser, "Ma_ximum Quantiser:", 1, 31);
+	diaElemUInteger ctlQuantDiff(&_maxQuantiserDiff, "Maximum Quantiser _Difference:", 1, 31);
+	diaElemFloat ctlQuantCompression(&_quantCompression, "_Quantiser Compression:", 0, 1);
+	diaElemFloat ctlQuantBlur(&_quantBlur, "Quantiser _Blur:", 0, 1);
+	diaElemToggle ctlTrellis(&_trellis, "_Trellis Quantisation");
+
+	diaElem *diaQze[] = {&ctlQuantType, &ctlMbDecision, &ctlQuantMin, &ctlQuantMax, &ctlQuantDiff, &ctlQuantCompression, &ctlQuantBlur, &ctlTrellis};
+	diaElemTabs tabQz("Quantisation", 8, diaQze);
+
+	diaElemTabs *tabs[] = {&tabMode, &tabME, &tabQz};
+	int controlCount = 0;
+
+	for (int i = 0; i < 3; i++)
+		controlCount += tabs[i]->nbElems;
+
+	diaElem *diaAll[controlCount];
+	int controlIndex = 0;
+
+	for (int i = 0; i < 3; i++)
+	{
+		for (int j = 0; j < tabs[i]->nbElems; j++)
+		{
+			diaAll[controlIndex] = tabs[i]->dias[j];
+			controlIndex++;
+		}
+	}
+
+	diaElemConfigMenu ctlConfigMenu(configName, &configType, _options.getUserConfigDirectory(), _options.getSystemConfigDirectory(),
+		changedConfig, serializeConfig, diaAll, controlCount);
+	diaElem *elmHeader[] = {&ctlConfigMenu};
+
+	if (diaFactoryRunTabs("avcodec H.263 Configuration", 1, elmHeader, 3, tabs))
+	{
+		saveSettings(&_encodeOptions, &_options);
+		updateEncodeProperties(&_encodeOptions);
+
+		return 1;
+	}
+
+	return 0;
+}
+
+void Mpeg4aspEncoder::loadSettings(vidEncOptions *encodeOptions, Mpeg4aspEncoderOptions *options)
+{
+	char *configurationName;
+
+	options->getPresetConfiguration(&configurationName, (PluginConfigType*)&configType);
+
+	if (configurationName)
+	{
+		strcpy(this->configName, configurationName);
+		delete [] configurationName;
+	}
+
+	if (encodeOptions)
+	{
+		_motionEst = (Mpeg4aspMotionEstimationMethod)(options->getMotionEstimationMethod() - 1);
+		_4MV = options->get4MotionVector();
+		_maxBFrames = options->getMaxBFrames();
+		_qpel = options->getQuarterPixel();
+		_gmc = options->getGmc();
+
+		_quantType = (Mpeg4aspQuantisationType)options->getQuantisationType();
+		_mbDecision = (Mpeg4aspMacroblockDecisionMode)options->getMbDecisionMode();
+		_minQuantiser = options->getMinQuantiser();
+		_maxQuantiser = options->getMaxQuantiser();
+		_maxQuantiserDiff = options->getQuantiserDifference();
+		_trellis = options->getTrellis();
+		_quantCompression = options->getQuantiserCompression();
+		_quantBlur = options->getQuantiserBlur();
+
+		updateEncodeProperties(encodeOptions);
+	}
+}
+
+void Mpeg4aspEncoder::saveSettings(vidEncOptions *encodeOptions, Mpeg4aspEncoderOptions *options)
+{
+	options->setPresetConfiguration(&configName[0], (PluginConfigType)configType);
+
+	switch (_bitrateParam.mode)
+	{
+		case COMPRESS_CQ:
+			encodeOptions->encodeMode = ADM_VIDENC_MODE_CQP;
+			encodeOptions->encodeModeParameter = _bitrateParam.qz;
+
+			break;
+		case COMPRESS_CBR:
+			encodeOptions->encodeMode = ADM_VIDENC_MODE_CBR;
+			encodeOptions->encodeModeParameter = _bitrateParam.bitrate;
+
+			break;
+		case COMPRESS_2PASS:
+			encodeOptions->encodeMode = ADM_VIDENC_MODE_2PASS_SIZE;
+			encodeOptions->encodeModeParameter = _bitrateParam.finalsize;
+
+			break;
+		case COMPRESS_2PASS_BITRATE:
+			encodeOptions->encodeMode = ADM_VIDENC_MODE_2PASS_ABR;
+			encodeOptions->encodeModeParameter = _bitrateParam.avg_bitrate;
+
+			break;
+	}
+
+	options->setMotionEstimationMethod((Mpeg4aspMotionEstimationMethod)(_motionEst + 1));
+	options->set4MotionVector(_4MV);
+	options->setMaxBFrames(_maxBFrames);
+	options->setQuarterPixel(_qpel);
+	options->setGmc(_gmc);
+
+	options->setQuantisationType((Mpeg4aspQuantisationType)_quantType);
+	options->setMbDecisionMode((Mpeg4aspMacroblockDecisionMode)_mbDecision);
+	options->setMinQuantiser(_minQuantiser);
+	options->setMaxQuantiser(_maxQuantiser);
+	options->setQuantiserDifference(_maxQuantiserDiff);
+	options->setTrellis(_trellis);
+	options->setQuantiserCompression(_quantCompression);
+	options->setQuantiserBlur(_quantBlur);
+}
+
+bool changedConfig(const char* configName, ConfigMenuType configType)
+{
+	bool failure = false;
+
+	if (configType == CONFIG_MENU_DEFAULT)
+	{
+		Mpeg4aspEncoderOptions defaultOptions;
+		vidEncOptions *defaultEncodeOptions = defaultOptions.getEncodeOptions();
+
+		encoder->loadSettings(defaultEncodeOptions, &defaultOptions);
+
+		delete defaultEncodeOptions;
+	}
+	else
+	{
+		Mpeg4aspEncoderOptions options;
+
+		options.setPresetConfiguration(configName, (PluginConfigType)configType);
+
+		if (configType == CONFIG_MENU_CUSTOM)
+			encoder->loadSettings(NULL, &options);
+		else
+		{
+			vidEncOptions *encodeOptions;
+
+			if (options.loadPresetConfiguration())
+			{
+				encodeOptions = options.getEncodeOptions();
+
+				encoder->loadSettings(encodeOptions, &options);
+
+				delete encodeOptions;
+			}
+			else
+			{
+				failure = true;
+			}
+		}
+	}
+
+	return configType == CONFIG_MENU_CUSTOM | !failure;
+}
+
+char *serializeConfig(void)
+{
+	vidEncOptions encodeOptions;
+	Mpeg4aspEncoderOptions options;
+
+	encoder->saveSettings(&encodeOptions, &options);
+	options.setEncodeOptions(&encodeOptions);
+
+	return options.toXml(PLUGIN_XML_EXTERNAL);
+}
+
+int Mpeg4aspEncoder::getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize)
+{
+	char* xml = _options.toXml(PLUGIN_XML_INTERNAL);
+	int xmlLength = strlen(xml);
+
+	if (bufferSize >= xmlLength)
+	{
+		memcpy(pluginOptions, xml, xmlLength);
+		memcpy(encodeOptions, &_encodeOptions, sizeof(vidEncOptions));
+	}
+	else if (bufferSize != 0)
+		xmlLength = 0;
+
+	delete [] xml;
+
+	return xmlLength;
+}
+
+int Mpeg4aspEncoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+{
+	if (_opened)
+		return ADM_VIDENC_ERR_ALREADY_OPEN;
+
+	bool success = true;
+
+	if (pluginOptions)
+	{
+		success = _options.fromXml(pluginOptions, PLUGIN_XML_INTERNAL);
+
+		_options.loadPresetConfiguration();
+	}
+
+	if (encodeOptions && success)
+	{
+		memcpy(&_encodeOptions, encodeOptions, sizeof(vidEncOptions));
+		updateEncodeProperties(encodeOptions);
+	}
+
+	if (success)
+		return ADM_VIDENC_ERR_SUCCESS;
+	else
+		return ADM_VIDENC_ERR_FAILED;
+}
+
+int Mpeg4aspEncoder::beginPass(vidEncPassParameters *passParameters)
+{
+	int qz = 0;
+	int ret = AvcodecEncoder::beginPass(passParameters);
+
+	if (_encodeOptions.encodeMode == ADM_VIDENC_MODE_CQP)
+		qz = _encodeOptions.encodeModeParameter;
+	else if ((_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE || _encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_ABR) && _currentPass == 1)
+		qz = 2;
+
+	if (qz)
+		_frame.quality = (int)floor(FF_QP2LAMBDA * qz + 0.5);
+
+	return ret;
+}
+
+int Mpeg4aspEncoder::finishPass(void)
+{
+	int ret = AvcodecEncoder::finishPass();
+
+	if (_statFile)
+	{
+		fclose(_statFile);
+		_statFile = NULL;
+	}
+
+	if (_context && _context->stats_in)
+	{
+		delete [] _context->stats_in;
+		_context->stats_in = NULL;
+	}
+
+	return ret;
+}
+
+int Mpeg4aspEncoder::encodeFrame(vidEncEncodeParameters *encodeParams)
+{
+	int ret = AvcodecEncoder::encodeFrame(encodeParams);
+
+	if (_context->stats_out)
+		fprintf (_statFile, "%s", _context->stats_out);
+
+	return ret;
+}
+
+void Mpeg4aspEncoder::updateEncodeProperties(vidEncOptions *encodeOptions)
+{
+	switch (encodeOptions->encodeMode)
+	{
+		case ADM_VIDENC_MODE_CQP:
+			_passCount = 1;
+
+			_bitrateParam.mode = COMPRESS_CQ;
+			_bitrateParam.qz = encodeOptions->encodeModeParameter;
+
+			break;
+		case ADM_VIDENC_MODE_CBR:
+			_passCount = 1;
+
+			_bitrateParam.mode = COMPRESS_CBR;
+			_bitrateParam.bitrate = encodeOptions->encodeModeParameter;
+
+			break;
+		case ADM_VIDENC_MODE_2PASS_SIZE:
+			_passCount = 2;
+
+			_bitrateParam.mode = COMPRESS_2PASS;
+			_bitrateParam.finalsize = encodeOptions->encodeModeParameter;
+
+			break;
+		case ADM_VIDENC_MODE_2PASS_ABR:
+			_passCount = 2;
+
+			_bitrateParam.mode = COMPRESS_2PASS_BITRATE;
+			_bitrateParam.avg_bitrate = encodeOptions->encodeModeParameter;
+
+			break;
+	}
+}
+
+unsigned int Mpeg4aspEncoder::calculateBitrate(unsigned int fpsNum, unsigned int fpsDen, unsigned int frameCount, unsigned int sizeInMb)
+{
+	double db, ti;
+
+	db = sizeInMb;
+	db = db * 1024. * 1024. * 8.;
+	// now db is in bits
+
+	// compute duration
+	ti = frameCount;
+	ti *= fpsDen;
+	ti /= fpsNum;	// nb sec
+	db = db / ti;
+
+	return (unsigned int)floor(db);
+}

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.h	2009-12-30 19:03:50 UTC (rev 5790)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.h	2009-12-30 19:08:15 UTC (rev 5791)
@@ -0,0 +1,67 @@
+ /***************************************************************************
+                              mpeg4aspEncoder.h
+
+    begin                : Wed Dec 30 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+ /**************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef Mpeg4aspEncoder_h
+#define Mpeg4aspEncoder_h
+
+#ifdef __cplusplus
+extern "C"
+{
+	#include "ADM_vidEnc_plugin.h"
+}
+
+#include "encoder.h"
+#include "mpeg4aspEncoderOptions.h"
+#include "DIA_factory.h"
+
+class Mpeg4aspEncoder : public AvcodecEncoder
+{
+	private:
+		COMPRES_PARAMS _bitrateParam;
+		unsigned int _motionEst, _4MV, _maxBFrames, _qpel, _gmc;
+		unsigned int _quantType, _mbDecision, _minQuantiser, _maxQuantiser, _maxQuantiserDiff, _trellis;
+		float _quantCompression, _quantBlur;
+
+		char configName[PATH_MAX];
+		ConfigMenuType configType;
+
+		Mpeg4aspEncoderOptions _options;
+		vidEncOptions _encodeOptions;
+
+		FILE *_statFile;
+
+		void updateEncodeProperties(vidEncOptions *encodeOptions);
+		unsigned int calculateBitrate(unsigned int fpsNum, unsigned int fpsDen, unsigned int frameCount, unsigned int sizeInMb);
+
+	public:
+		Mpeg4aspEncoder(void);
+		int initContext(const char* logFileName);
+		const char* getEncoderType(void);
+		const char* getEncoderDescription(void);
+		const char* getFourCC(void);
+		const char* getEncoderGuid(void);
+		int isConfigurable(void);
+		int configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
+		void loadSettings(vidEncOptions *encodeOptions, Mpeg4aspEncoderOptions *options);
+		void saveSettings(vidEncOptions *encodeOptions, Mpeg4aspEncoderOptions *options);
+		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
+		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int beginPass(vidEncPassParameters *passParameters);
+		int encodeFrame(vidEncEncodeParameters *encodeParams);
+		int finishPass(void);
+};
+#endif	// __cplusplus
+#endif	// Mpeg4asp

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.cpp	2009-12-30 19:03:50 UTC (rev 5790)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.cpp	2009-12-30 19:08:15 UTC (rev 5791)
@@ -0,0 +1,328 @@
+ /***************************************************************************
+                          mpeg4aspEncoderOptions.cpp
+
+	These settings are intended for scripting and can contain a Preset 
+	Configuration block.  If this block exists then "internal" settings are
+	ignored and an external configuration file should be read instead, 
+	e.g. PlayStation Portable profile.  However, if the external file is 
+	missing, internal settings have to be used and will reflect a snapshot
+	of the external configuration file at the time the script was generated.
+
+    begin                : Wed Dec 30 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <math.h>
+#include <libxml/parser.h>
+#include <libxml/xmlschemas.h>
+#include <sstream>
+#include <string>
+#include "ADM_default.h"
+#include "ADM_files.h"
+
+#include "mpeg4aspEncoderOptions.h"
+
+Mpeg4aspEncoderOptions::Mpeg4aspEncoderOptions(void) : PluginOptions(MPEG4ASP_PLUGIN_CONFIG_DIR, "Mpeg4asp", "Mpeg4aspParam.xsd", MPEG4ASP_DEFAULT_ENCODE_MODE, MPEG4ASP_DEFAULT_ENCODE_MODE_PARAMETER)
+{
+	reset();
+}
+
+void Mpeg4aspEncoderOptions::reset(void)
+{
+	PluginOptions::reset();
+
+	setMotionEstimationMethod(MPEG4ASP_MEM_EPZS);
+	set4MotionVector(true);
+	setMaxBFrames(0);
+	setQuarterPixel(false);
+	setGmc(false);
+	setQuantisationType(MPEG4ASP_QUANT_H263);
+	setMbDecisionMode(MPEG4ASP_MBDEC_RD);
+	setMinQuantiser(2);
+	setMaxQuantiser(31);
+	setQuantiserDifference(3);
+	setTrellis(false);
+	setQuantiserCompression(0.5);
+	setQuantiserBlur(0.5);
+}
+
+Mpeg4aspMotionEstimationMethod Mpeg4aspEncoderOptions::getMotionEstimationMethod(void)
+{
+	return _motionEst;
+}
+
+void Mpeg4aspEncoderOptions::setMotionEstimationMethod(Mpeg4aspMotionEstimationMethod motionEst)
+{
+	_motionEst = motionEst;
+}
+
+bool Mpeg4aspEncoderOptions::get4MotionVector(void)
+{
+	return _4MV;
+}
+
+void Mpeg4aspEncoderOptions::set4MotionVector(bool fourMv)
+{
+	_4MV = fourMv;
+}
+
+unsigned int Mpeg4aspEncoderOptions::getMaxBFrames(void)
+{
+	return _maxBFrames;
+}
+
+void Mpeg4aspEncoderOptions::setMaxBFrames(unsigned int maxBFrames)
+{
+	if (maxBFrames <= 32)
+		_maxBFrames = maxBFrames;
+}
+
+bool Mpeg4aspEncoderOptions::getQuarterPixel(void)
+{
+	return _qpel;
+}
+
+void Mpeg4aspEncoderOptions::setQuarterPixel(bool qpel)
+{
+	_qpel = qpel;
+}
+
+bool Mpeg4aspEncoderOptions::getGmc(void)
+{
+	return _gmc;
+}
+
+void Mpeg4aspEncoderOptions::setGmc(bool gmc)
+{
+	_gmc = gmc;
+}
+
+Mpeg4aspQuantisationType Mpeg4aspEncoderOptions::getQuantisationType(void)
+{
+	return _quantType;
+}
+
+void Mpeg4aspEncoderOptions::setQuantisationType(Mpeg4aspQuantisationType quantType)
+{
+	_quantType = quantType;
+}
+
+Mpeg4aspMacroblockDecisionMode Mpeg4aspEncoderOptions::getMbDecisionMode(void)
+{
+	return _mbDecision;
+}
+
+void Mpeg4aspEncoderOptions::setMbDecisionMode(Mpeg4aspMacroblockDecisionMode mbDecision)
+{
+	_mbDecision = mbDecision;
+}
+
+unsigned int Mpeg4aspEncoderOptions::getMinQuantiser(void)
+{
+	return _minQuantiser;
+}
+
+void Mpeg4aspEncoderOptions::setMinQuantiser(unsigned int quantiser)
+{
+	if (quantiser > 0 && quantiser <= 31)
+		_minQuantiser = quantiser;
+}
+
+unsigned int Mpeg4aspEncoderOptions::getMaxQuantiser(void)
+{
+	return _maxQuantiser;
+}
+
+void Mpeg4aspEncoderOptions::setMaxQuantiser(unsigned int quantiser)
+{
+	if (quantiser > 0 && quantiser <= 31)
+		_maxQuantiser = quantiser;
+}
+
+unsigned int Mpeg4aspEncoderOptions::getQuantiserDifference(void)
+{
+	return _maxQuantiserDiff;
+}
+
+void Mpeg4aspEncoderOptions::setQuantiserDifference(unsigned int difference)
+{
+	if (difference > 0 && difference <= 31)
+		_maxQuantiserDiff = difference;
+}
+
+bool Mpeg4aspEncoderOptions::getTrellis(void)
+{
+	return _trellis;
+}
+
+void Mpeg4aspEncoderOptions::setTrellis(bool trellis)
+{
+	_trellis = trellis;
+}
+
+float Mpeg4aspEncoderOptions::getQuantiserCompression(void)
+{
+	return _quantCompression;
+}
+
+void Mpeg4aspEncoderOptions::setQuantiserCompression(float compression)
+{
+	if (compression > 0. && compression <= 1.)
+		_quantCompression = compression;
+}
+
+float Mpeg4aspEncoderOptions::getQuantiserBlur(void)
+{
+	return _quantBlur;
+}
+
+void Mpeg4aspEncoderOptions::setQuantiserBlur(float blur)
+{
+	if (blur > 0. && blur <= 1.)
+		_quantBlur = blur;
+}
+
+void Mpeg4aspEncoderOptions::addOptionsToXml(xmlNodePtr xmlNodeRoot)
+{
+	const int bufferSize = 100;
+	xmlChar xmlBuffer[bufferSize + 1];
+	xmlNodePtr xmlNodeChild, xmlNodeChild2;
+
+	xmlNodeRoot = xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)getOptionsTagRoot(), NULL);
+
+	switch (getMotionEstimationMethod())
+	{
+		case MPEG4ASP_MEM_FULL:
+			strcpy((char*)xmlBuffer, "full");
+			break;
+		case MPEG4ASP_MEM_LOG:
+			strcpy((char*)xmlBuffer, "log");
+			break;
+		case MPEG4ASP_MEM_PHODS:
+			strcpy((char*)xmlBuffer, "phods");
+			break;
+		case MPEG4ASP_MEM_EPZS:
+			strcpy((char*)xmlBuffer, "epzs");
+			break;
+		default:
+			strcpy((char*)xmlBuffer, "none");
+			break;
+	}
+
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"motionEstimationMethod", xmlBuffer);
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"fourMotionVector", boolean2String(xmlBuffer, bufferSize, get4MotionVector()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"maximumBFrames", number2String(xmlBuffer, bufferSize, getMaxBFrames()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"quarterPixel", boolean2String(xmlBuffer, bufferSize, getQuarterPixel()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"globalMotionCompensation", boolean2String(xmlBuffer, bufferSize, getGmc()));
+
+	switch (getQuantisationType())
+	{
+		case MPEG4ASP_QUANT_MPEG:
+			strcpy((char*)xmlBuffer, "mpeg");
+			break;
+		default:
+			strcpy((char*)xmlBuffer, "h263");
+			break;
+	}
+
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"quantisationType", xmlBuffer);
+
+	switch (getMbDecisionMode())
+	{
+		case MPEG4ASP_MBDEC_BITS:
+			strcpy((char*)xmlBuffer, "fewestBits");
+			break;
+		case MPEG4ASP_MBDEC_RD:
+			strcpy((char*)xmlBuffer, "rateDistortion");
+			break;
+		default:
+			strcpy((char*)xmlBuffer, "sad");
+			break;
+	}
+
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"macroblockDecisionMode", xmlBuffer);
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"minimumQuantiser", number2String(xmlBuffer, bufferSize, getMinQuantiser()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"maximumQuantiser", number2String(xmlBuffer, bufferSize, getMaxQuantiser()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"quantiserDifference", number2String(xmlBuffer, bufferSize, getQuantiserDifference()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"trellis", boolean2String(xmlBuffer, bufferSize, getTrellis()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"quantiserCompression", number2String(xmlBuffer, bufferSize, getQuantiserCompression()));
+	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"quantiserBlur", number2String(xmlBuffer, bufferSize, getQuantiserBlur()));
+}
+
+void Mpeg4aspEncoderOptions::parseOptions(xmlNode *node)
+{
+	for (xmlNode *xmlChild = node->children; xmlChild; xmlChild = xmlChild->next)
+	{
+		if (xmlChild->type == XML_ELEMENT_NODE)
+		{
+			char *content = (char*)xmlNodeGetContent(xmlChild);
+
+			if (strcmp((char*)xmlChild->name, "motionEstimationMethod") == 0)
+			{
+				Mpeg4aspMotionEstimationMethod method = MPEG4ASP_MEM_NONE;
+
+				if (strcmp(content, "full") == 0)
+					method = MPEG4ASP_MEM_FULL;
+				else if (strcmp(content, "log") == 0)
+					method = MPEG4ASP_MEM_LOG;
+				else if (strcmp(content, "phods") == 0)
+					method = MPEG4ASP_MEM_PHODS;
+				else if (strcmp(content, "epzs") == 0)
+					method = MPEG4ASP_MEM_EPZS;
+
+				setMotionEstimationMethod(method);
+			}
+			if (strcmp((char*)xmlChild->name, "fourMotionVector") == 0)
+				set4MotionVector(string2Boolean(content));
+			else if (strcmp((char*)xmlChild->name, "maximumBFrames") == 0)
+				setMaxBFrames(atoi(content));
+			else if (strcmp((char*)xmlChild->name, "quarterPixel") == 0)
+				setQuarterPixel(string2Boolean(content));
+			else if (strcmp((char*)xmlChild->name, "globalMotionCompensation") == 0)
+				setGmc(string2Boolean(content));
+			if (strcmp((char*)xmlChild->name, "quantisationType") == 0)
+			{
+				Mpeg4aspQuantisationType type = MPEG4ASP_QUANT_H263;
+
+				if (strcmp(content, "mpeg") == 0)
+					type = MPEG4ASP_QUANT_MPEG;
+
+				setQuantisationType(type);
+			}			
+			if (strcmp((char*)xmlChild->name, "macroblockDecisionMode") == 0)
+			{
+				Mpeg4aspMacroblockDecisionMode mode = MPEG4ASP_MBDEC_SAD;
+
+				if (strcmp(content, "fewestBits") == 0)
+					mode = MPEG4ASP_MBDEC_BITS;
+				else if (strcmp(content, "rateDistortion") == 0)
+					mode = MPEG4ASP_MBDEC_RD;
+
+				setMbDecisionMode(mode);
+			}
+			else if (strcmp((char*)xmlChild->name, "minimumQuantiser") == 0)
+				setMinQuantiser(atoi(content));
+			else if (strcmp((char*)xmlChild->name, "maximumQuantiser") == 0)
+				setMaxQuantiser(atoi(content));
+			else if (strcmp((char*)xmlChild->name, "quantiserDifference") == 0)
+				setQuantiserDifference(atoi(content));
+			else if (strcmp((char*)xmlChild->name, "trellis") == 0)
+				setTrellis(string2Boolean(content));
+			else if (strcmp((char*)xmlChild->name, "quantiserCompression") == 0)
+				setQuantiserCompression(string2Float(content));
+			else if (strcmp((char*)xmlChild->name, "quantiserBlur") == 0)
+				setQuantiserBlur(string2Float(content));
+
+			xmlFree(content);
+		}
+	}
+}

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.h	2009-12-30 19:03:50 UTC (rev 5790)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.h	2009-12-30 19:08:15 UTC (rev 5791)
@@ -0,0 +1,110 @@
+/***************************************************************************
+                          mpeg4aspEncoderOptions.h
+
+    begin                : Wed Dec 30 2009
+    copyright            : (C) 2009 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef mpeg4aspEncoderOptions_h
+#define mpeg4aspEncoderOptions_h
+
+#include <vector>
+#include "../common/PluginOptions.h"
+
+extern "C"
+{
+#include "ADM_vidEnc_plugin.h"
+}
+
+#define MPEG4ASP_DEFAULT_ENCODE_MODE ADM_VIDENC_MODE_CQP
+#define MPEG4ASP_DEFAULT_ENCODE_MODE_PARAMETER 4
+
+typedef enum
+{
+	MPEG4ASP_MEM_NONE = 1,
+	MPEG4ASP_MEM_FULL,
+	MPEG4ASP_MEM_LOG,
+	MPEG4ASP_MEM_PHODS,
+	MPEG4ASP_MEM_EPZS
+} Mpeg4aspMotionEstimationMethod;
+
+typedef enum
+{
+	MPEG4ASP_QUANT_H263 = 0,
+	MPEG4ASP_QUANT_MPEG
+} Mpeg4aspQuantisationType;
+
+typedef enum
+{
+	MPEG4ASP_MBDEC_SAD = 0,
+	MPEG4ASP_MBDEC_BITS,
+	MPEG4ASP_MBDEC_RD
+} Mpeg4aspMacroblockDecisionMode;
+
+class Mpeg4aspEncoderOptions : public PluginOptions
+{
+protected:
+	Mpeg4aspMotionEstimationMethod _motionEst;
+	unsigned int _4MV, _maxBFrames, _qpel, _gmc;
+	Mpeg4aspQuantisationType _quantType;
+	Mpeg4aspMacroblockDecisionMode _mbDecision;
+	unsigned int _minQuantiser, _maxQuantiser, _maxQuantiserDiff, _trellis;
+	float _quantCompression, _quantBlur;
+
+	void addOptionsToXml(xmlNodePtr xmlNodeRoot);
+	void parseOptions(xmlNode *node);
+
+public:
+	Mpeg4aspEncoderOptions(void);
+	void reset(void);
+
+	Mpeg4aspMotionEstimationMethod getMotionEstimationMethod(void);
+	void setMotionEstimationMethod(Mpeg4aspMotionEstimationMethod motionEst);
+
+	bool get4MotionVector(void);
+	void set4MotionVector(bool fourMv);
+
+	unsigned int getMaxBFrames(void);
+	void setMaxBFrames(unsigned int maxBFrames);
+
+	bool getQuarterPixel(void);
+	void setQuarterPixel(bool qpel);
+
+	bool getGmc(void);
+	void setGmc(bool gmc);
+
+	Mpeg4aspQuantisationType getQuantisationType(void);
+	void setQuantisationType(Mpeg4aspQuantisationType quantType);
+
+	Mpeg4aspMacroblockDecisionMode getMbDecisionMode(void);
+	void setMbDecisionMode(Mpeg4aspMacroblockDecisionMode mbDecision);
+
+	unsigned int getMinQuantiser(void);
+	void setMinQuantiser(unsigned int quantiser);
+
+	unsigned int getMaxQuantiser(void);
+	void setMaxQuantiser(unsigned int quantiser);
+
+	unsigned int getQuantiserDifference(void);
+	void setQuantiserDifference(unsigned int difference);
+
+	bool getTrellis(void);
+	void setTrellis(bool trellis);
+
+	float getQuantiserCompression(void);
+	void setQuantiserCompression(float compression);
+
+	float getQuantiserBlur(void);
+	void setQuantiserBlur(float blur);
+};
+
+#endif	// mpeg4aspEncoderOptions_h



From gruntster at mail.berlios.de  Thu Dec 31 01:29:08 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu, 31 Dec 2009 01:29:08 +0100
Subject: [Avidemux-svn-commit] r5792 - in
	branches/avidemux_2.5_branch_gruntster: avidemux
	avidemux/ADM_codecs avidemux/ADM_coreImage/src
	avidemux/ADM_encoder avidemux/ADM_outputs/oplug_avi
	avidemux/ADM_outputs/oplug_dummy
	avidemux/ADM_outputs/oplug_flv avidemux/ADM_outputs/oplug_mp4
	avidemux/ADM_outputs/oplug_mpegFF avidemux/ADM_outputs/oplug_ogm
	avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog
	avidemux/ADM_userInterfaces/ADM_commonUI
	plugins/ADM_videoEncoder/ADM_vidEnc_avcodec
Message-ID: <200912310029.nBV0T8J0009183@sheep.berlios.de>

Author: gruntster
Date: 2009-12-31 01:28:35 +0100 (Thu, 31 Dec 2009)
New Revision: 5792

Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpegConfig.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpeg.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpeg.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_lavcodec.cpp
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_codecs.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_imageUtils.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.hxx
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_dummy/oplug_dummy.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mp4/oplug_mp4.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_ogm/op_ogsaveprocess.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_requant.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Mpeg4aspParam.xsd
Log:
[mpeg4] remove old avcodec mpeg4 logic, change over smart copy and remove remaining ffmpeg plumbing

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_codecs.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_codecs.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_codecs.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -31,10 +31,7 @@
 #undef BIG_ENDIAN
 #endif
 
-//#include "ADM_colorspace/colorspace.h"
-
 #include "ADM_codecs/ADM_codec.h"
-#include "ADM_codecs/ADM_mjpeg.h"
 #include "ADM_codecs/ADM_codecNull.h"
 #include "ADM_codecs/ADM_uyvy.h"
 
@@ -44,15 +41,6 @@
 #include "ADM_codecs/ADM_ffmp43.h"
 #endif
 
-#ifdef USE_DIVX
-#include "ADM_codecs/ADM_divx4.h"
-#endif
-
-#ifdef USE_THEORA
-#include "ADM_codecs/ADM_theora_dec.h"
-#endif
-
-
 #include "ADM_assert.h"
 #include "prefs.h"
 

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -1,645 +0,0 @@
-/***************************************************************************
-                          ADM_ffmpeg.cpp  -  description
-                             -------------------
-
-	Encoder for ffmpeg
-	Reverse enginereed from mplayer & transcode
-		
-
-    begin                : Tue Sep 10 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include "config.h"
-
-
-
-#define __STDC_CONSTANT_MACROS // Lavcodec crap
-
-#include <stdio.h>
-#include <stdlib.h>
-#include <string.h>
-#include <math.h>
-
-#include "ADM_lavcodec.h"
-#include "avi_vars.h"
-#include "DIA_coreToolkit.h"
-#include "ADM_assert.h"
-#include "ADM_codecs/ADM_ffmpeg.h"
-
-#include "prefs.h"
-
-#include "ADM_video/ADM_vidMisc.h"
-//#define TEST_NOB 1
-
-extern int ADM_cpu_num_processors(void);
-static char LogName[500];
-
-#define WRAP_Open(x) \
-{\
-AVCodec *codec=avcodec_find_encoder(x);\
-if(!codec) {GUI_Error_HIG("Codec",QT_TR_NOOP("Internal error opening codec"#x));ADM_assert(0);} \
-  capabilities = codec->capabilities & CODEC_CAP_DELAY ? ADM_ENC_REQ_NULL_FLUSH : 0; \
-  res=avcodec_open(_context, codec); \
-  if(res<0) {GUI_Error_HIG("Codec",QT_TR_NOOP("Internal error with context for  codec"#x".\n Did you use too low / too high target for 2 pass ?"));return 0;} \
-}
-/*****************************************/
-uint8_t ffmpegEncoder::stopEncoder(void)
-{
-    printf("[lavc] stopEncoder (%x)\n",_context);
-    if (_context)
-    {
-        avcodec_close (_context);
-        av_free(_context);
-        _context = NULL;
-    }
-    return 1;
-}
-/*****************************************/
-ffmpegEncoderCQ::~ffmpegEncoderCQ ()
-  {
-    printf("[LAVCODEC]Deleting ffmpegCQencoder\n");
-    //stopEncoder ();
-    if (_statfile)
-      {
-        fflush(_statfile);
-	fclose (_statfile);
-      }
-  }
-/*****************************************/
-void ffmpegEncoder::postAmble (ADMBitstream * out, uint32_t sz)
-{
-  out->ptsFrame = _context->coded_frame->display_picture_number; //real_pict_num;;
- //printf("Out : %u\n",out->ptsFrame);
-  out->len = (uint32_t) sz;
-  out->flags = frameType ();;
-  if(!_context->coded_frame->quality)
-      out->out_quantizer=(int) floor (_frame.quality / (float) FF_QP2LAMBDA);
-  else
-      out->out_quantizer =(int) floor (_context->coded_frame->quality / (float) FF_QP2LAMBDA);
-
-}
-//static myENC_RESULT res;
-/*****************************************/
-ffmpegEncoder::ffmpegEncoder (uint32_t width, uint32_t height, FF_CODEC_ID id,PixelFormat format):encoder (width,
-	 height)
-{
-  printf ("[LAVCODEC]Build: %d, colorspace :%x\n", LIBAVCODEC_BUILD,format);
-  _targetColorSpace=format;//PIX_FMT_YUV420P
-  _id = id;
-  _swap = 0;
-  _context = NULL;
-  _settingsPresence = 0;
-
-  _context = avcodec_alloc_context ();
-
-  ADM_assert (_context);
-  memset (&_frame, 0, sizeof (_frame));
-  _frame.pts = AV_NOPTS_VALUE;
-  _context->width = _w;
-  _context->height = _h;
-
-  _isMT = 0;
-  encodePreamble(NULL);
-
-};
-/*****************************************/
-uint8_t   ffmpegEncoder::encode(ADMImage *in,ADMBitstream *out)
-{
-    int32_t sz = 0;
-    ADM_assert(out->bufferSize);
-	encodePreamble (in ? in->data : NULL);
-    if ((sz = avcodec_encode_video (_context, out->data, out->bufferSize, &_frame)) < 0)
-        return 0;
-    postAmble(out,sz);
-    return 1;
-}
-/*****************************************/
-ffmpegEncoder::~ffmpegEncoder ()
-{
-  printf ("[lavc] encoder destroying..\n");
-  if (_isMT && _context)
-    {
-      printf ("[lavc] killing threads\n");
-      avcodec_thread_free (_context);
-      _isMT = 0;
-    }
-  stopEncoder ();
-}
-
-/*
-   	Initialize codec in Q mode
-
-*/
-
-uint8_t
-ffmpegEncoder::encodePreamble (uint8_t * in)
-{
-  _frame.key_frame = 0;
-  _frame.pict_type = 0;
-
-  if (in)
-  {
-	  switch(_targetColorSpace)
-	  {
-		case PIX_FMT_YUV420P:
-			_frame.linesize[0] = _w;
-			_frame.linesize[1] = _w >> 1;
-			_frame.linesize[2] = _w >> 1;
-			_frame.data[0] = in;
-			_frame.data[2] = in + _w * _h;
-			_frame.data[1] = in + _w * _h + ((_w * _h) >> 2);
-			break;
-	 case PIX_FMT_YUV422P:
-			_frame.linesize[0] = _w;
-			_frame.linesize[1] = _w >> 1;
-			_frame.linesize[2] = _w >> 1;
-			_frame.data[0] = in;
-			_frame.data[2] = in + _w * _h;
-			_frame.data[1] = in + _w * _h + ((_w * _h) >> 1);
-	      
-			break;
-		default:
-		  ADM_assert(0);
-	  }
-  }
-
-  return 1;
-}
-
-uint32_t
-ffmpegEncoder::frameType (void)
-{
-  int k, t;
-
-  k = _context->coded_frame->key_frame;
-  t = _context->coded_frame->pict_type;
-
-  //printf(" Kf: %d type :%d \n",k,t);
-  if (k == 1)
-    return AVI_KEY_FRAME;
-  if (t == FF_B_TYPE)
-    return AVI_B_FRAME;
-  //if(t==FF_I_TYPE) return AVI_KEY_FRAME;
-  return 0;
-
-}
-
-uint8_t
-ffmpegEncoder::initContext (void)
-{
-  int res = 0;
-
-  // if (_id == FF_HUFF || _id == FF_FFV1)
-  _context->strict_std_compliance = -1;
-  
-  switch (_id)
-    {
-    case FF_MPEG4:
-      encoderMT ();
-      WRAP_Open (CODEC_ID_MPEG4);
-      break;
-    case FF_MSMP4V3:
-      WRAP_Open (CODEC_ID_MSMPEG4V3);
-      break;
-    default:
-      ADM_assert (0);
-    }
-
-  if (res < 0)
-    {
-      printf ("[lavc] Problem opening codec\n");
-      return 0;
-    }
-  return 1;
-
-}
-
-void ffmpegEncoder::encoderMT (void)
-{
-  uint32_t threads = 0;
-
-  prefs->get(FEATURE_THREADING_LAVC, &threads);
-
-  if (threads == 0)
-	  threads = ADM_cpu_num_processors();
-
-  if (threads == 1)
-	  threads = 0;
-
-  if (threads)
-  {
-      printf ("[lavc] Enabling MT encoder with %u threads\n", threads);
-
-      if (avcodec_thread_init (_context, threads) == -1)
-	      printf ("[lavc] Failed!!\n");
-	  else
-          _isMT = 1;
-  }
-}
-
-/*
-		Set user selected matrices.
-
-*/
-uint8_t
-ffmpegEncoder::setCustomMatrices (uint16_t * intra, uint16_t * inter)
-{
-  _context->intra_matrix = intra;
-  _context->inter_matrix = inter;
-  return 1;
-}
-
-uint8_t
-ffmpegEncoder::setGopSize (uint32_t size)
-{
-
-  _context->gop_size = size;
-  printf ("[LAVCODEC]Gop size is now %d\n", _context->gop_size);
-  return 1;
-
-}
-
-uint8_t
-ffmpegEncoder::setLogFile (const char *name)
-{
-  strcpy (LogName, name);
-  return 1;
-
-}
-
-uint8_t
-ffmpegEncoder::setConfig (FFcodecSetting * set)
-{
-  memcpy (&_settings, set, sizeof (_settings));
-  _settingsPresence = 1;
-  return 1;
-
-}
-
-uint8_t
-ffmpegEncoderCQ::init (uint32_t val, uint32_t fps1000, uint8_t vbr)
-{
-  printf ("[LAVCODEC] Using Q=%u\n",val); 
-  mplayer_init ();
-  _qual = val;
-  _vbr = vbr;
-  _context->flags |= CODEC_FLAG_QSCALE;
-
-  if (_vbr)
-    {
-      _context->flags |= CODEC_FLAG_PASS1;
-      _statfile = NULL;
-
-    }
-  _context->time_base = (AVRational)  {  1000, fps1000};
-/*
-  _context->frame_rate_base = 1000;
-  _context->frame_rate = fps1000;
-*/
-  _context->bit_rate = 0;
-  _context->bit_rate_tolerance = 1024 * 8 * 1000;
-
-  return initContext ();
-}
-
-uint32_t ffmpegEncoder::getCodedFrame (void)
-{
-  return _last_coded_frame;
-}
-
-uint8_t ffmpegEncoderCQ::encode (ADMImage * in, ADMBitstream * out)
-{
-  int32_t    sz = 0;
-  uint32_t    f;
-  uint8_t    r=0;
-  
-  _frame.quality = (int) floor (FF_QP2LAMBDA * _qual + 0.5);
-  r=ffmpegEncoder::encode(in,out);
-  out->out_quantizer=_qual;
-  if (_vbr)			// update for lavcodec internal
-    {
-      if (!_statfile)
-	{
-	  printf ("[lavc] using %s as log file\n", LogName);
-	  _statfile = fopen (LogName, "wb");
-	}
-
-      if (!_statfile)
-	{
-	  printf
-	    ("[lavc] cannot open log file for writing! (%s)\n",
-	     LogName);
-	  return 0;
-	}
-      if (_context->stats_out)
-	fprintf (_statfile, "%s", _context->stats_out);
-    }
-
-  return 1;
-
-}
-
-/*
-_____________________________________________
-*/
-/*
-   	Initialize codec in CBR mode
-
-*/
-
-uint8_t ffmpegEncoderCBR::init (uint32_t val, uint32_t fps1000)
-{
-//       mpeg4_encoder
-  //
-//              now init our stuff
-//
-  _br = val;
-  mplayer_init ();
-/*  _context->frame_rate_base = 1000;
-  _context->frame_rate = fps1000;*/
-  _context->time_base = (AVRational)
-  {
-  1000, fps1000};
-
-	  _context->bit_rate = _br*1000;
-
-  printf ("[LAVCODEC] Using  bitrate in context :%lu kbps",_context->bit_rate/1000);
-
-  return initContext ();
-
-}
-
-
-//------------------------------------------------------------------------------
-//              VBR
-//------------------------------------------------------------------------------
-uint8_t ffmpegEncoderVBR::encode (ADMImage * in, ADMBitstream * out)
-{
-    uint16_t q;
-    uint8_t kf;
-
-    q=out->in_quantizer;
-    _frame.quality = (int) floor (FF_QP2LAMBDA * q + 0.5);
-    return ffmpegEncoder::encode(in,out);
-
-}
-/*
-   			val is the average bitrate wanted, else it is useless
-*/
-uint8_t
-ffmpegEncoderVBR::init (uint32_t val, uint32_t fps1000)
-{
-  uint32_t statSize;
-  FILE *_statfile;
-
-  printf ("[lavc] initializing in VBR mode\n");
-  _qual = val;
-  mplayer_init ();
-
-//   _context->frame_rate_base = 1000;
-//   _context->frame_rate = fps1000;
-
-  _context->time_base = (AVRational)  {  1000, fps1000};
-
-  /* If internal 2 passes mode is selected ... */
-  _context->flags |= CODEC_FLAG_PASS2;
-
-  _statfile = fopen (LogName, "rb");
-  if (!_statfile)
-    {
-      printf ("internal file does not exists ?\n");
-      return 0;
-    }
-
-  fseek (_statfile, 0, SEEK_END);
-  statSize = ftello (_statfile);
-  fseek (_statfile, 0, SEEK_SET);
-  _context->stats_in = (char *) ADM_alloc (statSize + 1);
-  _context->stats_in[statSize] = 0;
-  fread (_context->stats_in, statSize, 1, _statfile);
-  fclose(_statfile);
-
-  _context->bit_rate = val;	// bitrate
-
-  return initContext ();
-
-}
-
-ffmpegEncoderVBR::~ffmpegEncoderVBR ()
-{
-
-
-  ADM_dealloc (_context->stats_in);
-
-}
-
-//--------------------- FFmpeg VBR, external Qzation engine ------------------
-uint8_t
-ffmpegEncoderVBRExternal::encode (ADMImage * in, ADMBitstream * out)
-{
-    uint8_t r;
-    uint32_t q;
-  q=out->in_quantizer;
-  _frame.quality = (int) floor (FF_QP2LAMBDA * q + 0.5);
-  r= ffmpegEncoder::encode(in,out);
-  out->out_quantizer=q;
-  return r;
-}
-
-
-/**
-	This is used only for Mpeg1, so it is a bit tuned for it
-*/
-uint8_t
-ffmpegEncoderVBRExternal::init (uint32_t val, uint32_t fps1000)
-{
-
-  printf ("[lavc] initializing in VBRExternal mode\n");
-  _qual = val;
-  mplayer_init ();
-
-/*  _context->frame_rate_base = 1000;
-  _context->frame_rate = fps1000;*/
-  _context->time_base = (AVRational) {  1000, fps1000};
-  _context->flags |= CODEC_FLAG_QSCALE;;
-  _context->bit_rate = 0;
-  _context->bit_rate_tolerance = 1024 * 8 * 1000;
-  _context->max_qdiff = 10;
-
-  // since this is used only for mpeg1 ...
-  // PAL ?
-  _context->bit_rate = 2500 * 1000 * 8;
-  _context->sample_aspect_ratio.num = 4;
-  _context->sample_aspect_ratio.den = 3;
-
-  return initContext ();;
-}
-
-ffmpegEncoderVBRExternal::~ffmpegEncoderVBRExternal ()
-{
-
-
-
-}
-
-//--------------------- FFmpeg VBR, external Qzation engine ------------------
-
-void
-ffmpegEncoder::mplayer_init (void)
-{
-  /*
-     default values : Copy/past from mplayer
-   */
-  _context->pix_fmt = _targetColorSpace;
-
-  if (!_settingsPresence)
-    {
-      printf ("[lavc] using default encode settings \n");
-      _context->qmin = 2;
-      _context->qmax = 31;
-      _context->max_b_frames = 0;
-      _context->mpeg_quant = 0;
-      _context->me_method = ME_EPZS;
-      _context->flags = 0;
-      _context->max_qdiff = 3;
-      _context->luma_elim_threshold = 0;
-      _context->chroma_elim_threshold = 0;
-      _context->lumi_masking = 0.0;;
-      _context->dark_masking = 0.0;
-      _context->qcompress = 0.5;
-      _context->qblur = 0.5;
-      _context->gop_size = 250;
-    }
-  else
-    {
-	  _context->gop_size = 250;
-
-#define SETX(x) _context->x=_settings.x; printf("[LAVCODEC]"#x" : %d\n",_settings.x);
-#define SETX_COND(x) if(_settings.is_##x) {_context->x=_settings.x; printf("[LAVCODEC]"#x" : %d\n",_settings.x);} else\
-		{ printf(#x" is not activated\n");}
-      SETX (me_method);
-      SETX (qmin);
-      SETX (qmax);
-      SETX (max_b_frames);
-      SETX (mpeg_quant);
-      SETX (max_qdiff);
-      SETX_COND (luma_elim_threshold);
-      SETX_COND (chroma_elim_threshold);
-
-#undef SETX
-#undef SETX_COND
-
-#define SETX(x)  _context->x=_settings.x; printf("[LAVCODEC]"#x" : %f\n",_settings.x);
-#define SETX_COND(x)  if(_settings.is_##x) {_context->x=_settings.x; printf("[LAVCODEC]"#x" : %f\n",_settings.x);} else  \
-									{printf("[LAVCODEC]"#x" No activated\n");}
-      SETX_COND (lumi_masking);
-      SETX_COND (dark_masking);
-      SETX (qcompress);
-      SETX (qblur);
-      SETX_COND (temporal_cplx_masking);
-      SETX_COND (spatial_cplx_masking);
-
-#undef SETX
-#undef SETX_COND
-
-#define SETX(x) if(_settings.x){ _context->flags|=CODEC_FLAG##x;printf("[LAVCODEC]"#x" is set\n");}
-      SETX (_GMC);
-
-
-      switch (_settings.mb_eval)
-	{
-	case 0:
-	  _context->mb_decision = FF_MB_DECISION_SIMPLE;
-	  break;
-	case 1:
-	  _context->mb_decision = FF_MB_DECISION_BITS;
-	  break;
-	case 2:
-	  _context->mb_decision = FF_MB_DECISION_RD;
-	  break;
-	default:
-	  ADM_assert (0);
-
-
-	}
-      //SETX(_HQ);
-      SETX (_4MV);
-      SETX (_QPEL);
-      SETX (_NORMALIZE_AQP);
-
-      if (_settings.widescreen)
-	{
-	  _context->sample_aspect_ratio.num = 16;
-	  _context->sample_aspect_ratio.den = 9;
-	  printf ("[LAVCODEC]16/9 aspect ratio is set.\n");
-
-	}
-#undef SETX
-    }
-    _context->bit_rate_tolerance = 1024 * 8 * 1000;
-
-
-  _context->b_quant_factor = 1.25;
-  _context->rc_strategy = 2;
-  _context->b_frame_strategy = 0;
-  _context->b_quant_offset = 1.25;
-  _context->rtp_payload_size = 0;
-  _context->strict_std_compliance = 0;
-  _context->i_quant_factor = 0.8;
-  _context->i_quant_offset = 0.0;
-  _context->rc_qsquish = 1.0;
-  _context->rc_qmod_amp = 0;
-  _context->rc_qmod_freq = 0;
-  _context->rc_eq = const_cast < char *>("tex^qComp");
-  _context->rc_max_rate = 000;
-  _context->rc_min_rate = 000;
-  _context->rc_buffer_size = 000;
-  _context->rc_buffer_aggressivity = 1.0;
-  _context->rc_initial_cplx = 0;
-  _context->dct_algo = 0;
-  _context->idct_algo = 0;
-  _context->p_masking = 0.0;
-
-  _context->bit_rate = 0;
-
-}
-
-uint8_t
-ffmpegEncoder::init (uint32_t val, uint32_t fps1000)
-{
-  UNUSED_ARG (val);
-  UNUSED_ARG (fps1000);
-  return 0;
-}
-
-uint8_t
-ffmpegEncoder::init (uint32_t val, uint32_t fps1000, uint8_t sw)
-{
-  UNUSED_ARG (sw);
-  return init (val, fps1000);
-}
-
-uint8_t
-ffmpegEncoder::getExtraData (uint32_t * l, uint8_t ** d)
-{
-  *d = (uint8_t *) _context->extradata;
-  *l = _context->extradata_size;
-  printf ("[LAVCODEC]We got some extra data: %lu\n", *l);
-  if (*l)
-    return 1;
-
-  else
-    return 0;
-}
-
-

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpeg.h	2009-12-31 00:28:35 UTC (rev 5792)
@@ -1,149 +0,0 @@
-/***************************************************************************
-                          ADM_ffmpeg.h  -  description
-                             -------------------
-                             
-                             
-	Mpeg4 ****encoder******** using ffmpeg
-	                             
-    begin                : Tue Sep 10 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef __FFMPEG_ENC__
-#define   __FFMPEG_ENC__
-#include "ADM_colorspace.h"
-typedef enum
-{
-  FF_MSMP4V3 = 1,
-  FF_MPEG4 = 2,
-} FF_CODEC_ID;
-
-/*
-	Some of FFmpeg internal options as encoder
-	User tunable
-*/
-
-#include "ADM_codecs/ADM_ffmpegConfig.h"
-
-class ffmpegEncoder:public encoder
-{
-protected:
-  void postAmble (ADMBitstream * out, uint32_t sz);
-  uint8_t _init;
-  uint8_t _swap;
-  AVCodecContext *_context;
-  AVFrame _frame;
-  FF_CODEC_ID _id;
-  uint32_t _last_coded_frame;
-  uint8_t _settingsPresence;
-  uint8_t _isMT;
-  FFcodecSetting _settings;
-  void mplayer_init (void);
-  uint8_t initContext (void);
-  uint32_t frameType (void);
-  uint8_t encodePreamble (uint8_t * in);
-  PixelFormat _targetColorSpace;
-
-public:
-	int capabilities;
-
-    uint8_t setConfig (FFcodecSetting * set);
-  uint8_t setLogFile (const char *name);
-  void encoderMT (void);
-    ffmpegEncoder (uint32_t width, uint32_t height, FF_CODEC_ID id,PixelFormat format=PIX_FMT_YUV420P);
-   virtual ~ffmpegEncoder ();
-
-  virtual uint8_t stopEncoder (void);
-  
-  virtual uint8_t init (uint32_t val, uint32_t fps1000);
-  virtual uint8_t init (uint32_t val, uint32_t fps1000, uint8_t sw);
-  virtual uint8_t encode (ADMImage * in, ADMBitstream * out);
-  virtual uint8_t getExtraData (uint32_t * l, uint8_t ** d);
-  virtual uint8_t setCustomMatrices (uint16_t * intra, uint16_t * inter);
-  virtual uint8_t setGopSize (uint32_t size);	// !!! IT DOES NOT WORK, DONE TOO LATE!!!!
-  uint32_t getCodedFrame (void);
-};
-
-class ffmpegEncoderCQ:public ffmpegEncoder
-{
-protected:uint32_t _qual;
-  uint8_t _vbr;
-  FILE *_statfile;
-
-public:  ffmpegEncoderCQ (uint32_t width, uint32_t height,
-		     FF_CODEC_ID id):ffmpegEncoder (width, height, id)
-  {
-    _qual = 3;
-    _vbr = 0;
-    _statfile = NULL;
-  };
-
-  virtual uint8_t init (uint32_t val, uint32_t fps1000, uint8_t vbr = 0);
-  virtual uint8_t encode (ADMImage * in, ADMBitstream * out);
-  virtual ~ ffmpegEncoderCQ ();
-  
-};
-
-
-class ffmpegEncoderCBR:public ffmpegEncoder
-{
-protected:uint32_t _br;
-public:ffmpegEncoderCBR (uint32_t width, uint32_t height,
-		    FF_CODEC_ID id):ffmpegEncoder (width, height, id)
-  {
-    _br = 1000;
-  };
-
-  virtual ~ ffmpegEncoderCBR ()
-  {
-    stopEncoder ();
-  }
-  virtual uint8_t init (uint32_t val, uint32_t fps1000);
-
-
-};
-
-class ffmpegEncoderVBR:public ffmpegEncoderCQ
-{
-protected:
-    uint8_t _internal;
-
-public:  virtual uint8_t init (uint32_t val, uint32_t fps1000);
-    ffmpegEncoderVBR (uint32_t width, uint32_t height,
-		      FF_CODEC_ID id):ffmpegEncoderCQ (width, height, id)
-  {
-    _internal = 1;
-  }
-  ffmpegEncoderVBR (uint32_t width, uint32_t height, uint8_t inter,
-		    FF_CODEC_ID id):ffmpegEncoderCQ (width, height, id)
-  {
-    _internal = inter;
-  }
-  virtual uint8_t encode (ADMImage * in, ADMBitstream * out);
-  virtual ~ ffmpegEncoderVBR ();
-};
-
-
-class ffmpegEncoderVBRExternal:public ffmpegEncoderCQ
-{
-protected:
-public:
-        virtual uint8_t init (uint32_t val, uint32_t fps1000);
-                        ffmpegEncoderVBRExternal(uint32_t width,uint32_t height,FF_CODEC_ID id):
-                                ffmpegEncoderCQ (width, height,id)
-  {
-  }
-  virtual uint8_t encode (ADMImage * in, ADMBitstream * out);
-  virtual ~ ffmpegEncoderVBRExternal ();
-};
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpegConfig.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpegConfig.h	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_ffmpegConfig.h	2009-12-31 00:28:35 UTC (rev 5792)
@@ -1,78 +0,0 @@
-/***************************************************************************
-                          ADM_ffmpegConfig -  description
-                             -------------------
-	Fine tuning for lavcodec encoder			     
-			     
-    begin                : 19-01-2003
-    copyright            : (C) 2003 by mean
-    email                : fixounet at free.fr
-
-   
-
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef ADM_FFCONFIG
-#define ADM_FFCONFIG
-typedef struct FFcodecSetting
-{
-  Motion_Est_ID me_method;
-  uint32_t _GMC;
-  uint32_t _4MV;
-  uint32_t _QPEL;
-  uint32_t _TRELLIS_QUANT;
-  uint32_t qmin;			// 2-31
-  uint32_t qmax;			// 2-31
-  uint32_t max_qdiff;		// 1-31
-  uint32_t max_b_frames;		// 0-1
-  uint32_t mpeg_quant;		// 0-1
-  uint32_t is_luma_elim_threshold;
-  uint32_t luma_elim_threshold;	// -99--99
-  uint32_t is_chroma_elim_threshold;	// -99--99           
-  uint32_t chroma_elim_threshold;	// -99--99      
-
-  float lumi_masking;		// -1--1        
-  int32_t is_lumi_masking;		// -1--1
-  float dark_masking;		// -1--1        
-  int32_t is_dark_masking;		// -1--1
-  float qcompress;		// 0.0--1.0
-  float qblur;			// 0.0--1.0
-  uint32_t minBitrate;          // In kBits/s
-  uint32_t maxBitrate;          // In kBits/s
-  uint32_t user_matrix;		// 0 normal / 1 tmpgenc / 2 anime / 3 kvcd / 4 hr-tmpgenc
-  uint32_t gop_size;			// For mpeg1/2 , 12 is good
-  uint16_t *intra_matrix;
-  uint16_t *inter_matrix;
-  uint32_t interlaced;
-  uint32_t bff;			// WLA: bottom field first flag
-  uint32_t widescreen;          //0 4/3  1 16/9
-
-  // new stuff from jakub ui
-  uint32_t mb_eval;			// Replace hq 0..2
-  uint32_t vratetol;			// filesize tolerance in kb
-
-  uint32_t is_temporal_cplx_masking;	// temporal masking 0--1        
-  float temporal_cplx_masking;	// temporal masking 0--1
-
-  uint32_t is_spatial_cplx_masking;	// spatial masking 0--1
-  float spatial_cplx_masking;	// spatial masking 0--1
-  uint32_t _NORMALIZE_AQP;		// normalize adap quantiz
-
-  //
-  uint32_t use_xvid_ratecontrol;
-  uint32_t bufferSize;		// in KBYTES !!!!
-  uint32_t override_ratecontrol;
-  uint32_t dummy;
-
-} FFcodecSetting;
-
-
-
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpeg.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpeg.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -1,115 +0,0 @@
-#if 0
-/***************************************************************************
-                          ADM_mjpeg.cpp  -  description
-                             -------------------
-          I think i could use plain jpeg instead but....
-
-
-    begin                : Fri Apr 12 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include <stdio.h>
-#include <stdlib.h>
-#include "ADM_assert.h"
-#include <string.h>
-#include <math.h>
-#include "ADM_default.h"
-#include "config.h"
-#ifdef USE_MJPEG
-#include "ADM_colorspace/colorspace.h"
-
-#include "ADM_codecs/ADM_codec.h"
-#include "ADM_codecs/ADM_mjpeg.h"
-extern "C"
-{
-#include "mjpegtools/jpegutils.h"
-}
-#include "ADM_gui/GUI_decodersettings.h"
- /*
-  * jpeg_data:       buffer with input / output jpeg
-  * len:             Length of jpeg buffer
-  * itype:           LAV_INTER_NONE: Not interlaced
-  *                  LAV_INTER_TOP_FIRST: Interlaced, top-field-first
-  *                  LAV_INTER_BOTTOM_FIRST: Interlaced, bottom-field-first
-  * ctype            Chroma format for decompression.
-  *                  Currently always 420 and hence ignored.
-  * raw0             buffer with input / output raw Y channel
-  * raw1             buffer with input / output raw U/Cb channel
-  * raw2             buffer with input / output raw V/Cr channel
-  * width            width of Y channel (width of U/V is width/2)
-  * height           height of Y channel (height of U/V is height/2)
-
-
-  int decode_jpeg_raw (unsigned char *jpeg_data, int len,
-  int itype, int ctype, int width, int height,
-  unsigned char *raw0, unsigned char *raw1,
-  unsigned char *raw2);
-
-  */
-void
-decoderMjpeg::setParam (void)
-{
-  int param;
-
-  param = _swap;
-  if (1 == getMjpegParams (&param))
-    {
-      _swap = param;
-    }
-
-}
-//________________________________________________
-
-uint8_t
-  decoderMjpeg::uncompress (uint8_t * in, uint8_t * out, uint32_t len,
-			    uint32_t * flagz)
-{
-  //
-  uint32_t delta;
-  uint8_t *outu, *outv;
-  //
-  UNUSED_ARG (flagz);
-
-
-  delta = _w * _h;
-
-  outu = out + delta;
-  outv = outu + (delta >> 2);
-  if (!_swap)
-
-    decode_jpeg_raw (in, len, 1, 0, _w, _h, out, outu, outv);
-
-  else
-    decode_jpeg_raw (in, len, 1, 0, _w, _h, out, outv, outu);
-
-  return 1;
-
-
-}
-
-//_____________________________________________________
-
-decoderMjpeg::~decoderMjpeg ()
-{
-
-
-}
-// constructor for mjpeg, init encoder and stuff
-decoderMjpeg::decoderMjpeg (uint32_t w, uint32_t h):decoders (w, h)
-{
-  // some mjpeg are encoded with u & v inverted
-  _swap = 0;
-
-}
-#endif
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpeg.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpeg.h	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/ADM_mjpeg.h	2009-12-31 00:28:35 UTC (rev 5792)
@@ -1,29 +0,0 @@
-/***************************************************************************
-                          ADM_mjpeg.h  -  description
-                             -------------------
-    begin                : Sat Apr 13 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-class decoderMjpeg:decoders
-{
-protected:
-  uint8_t _swap;
-
-public:
-  decoderMjpeg (uint32_t w, uint32_t h);
-  virtual ~ decoderMjpeg ();
-  virtual void setParam (void);
-  virtual uint8_t uncompress (uint8_t * in, uint8_t * out, uint32_t len,
-			      uint32_t * flag = NULL);
-};

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/CMakeLists.txt	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs/CMakeLists.txt	2009-12-31 00:28:35 UTC (rev 5792)
@@ -1,6 +1,5 @@
 SET(ADM_codecs_SRCS 
-	ADM_codecs.cpp  ADM_ffmpeg.cpp
-	ADM_ffmp43.cpp  ADM_mjpeg.cpp   ADM_uyvy.cpp)
+	ADM_codecs.cpp  ADM_ffmp43.cpp  ADM_uyvy.cpp)
 
 ADD_ADM_LIB_ALL_TARGETS(ADM_codecs ${ADM_codecs_SRCS})
 REMOVE_DEFINITIONS(-DHAVE_CONFIG_H)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_imageUtils.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_imageUtils.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_imageUtils.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -27,7 +27,7 @@
 
 #include "ADM_codecs/ADM_codec.h"
 #include "ADM_lavcodec.h"
-#include "ADM_codecs/ADM_ffmpeg.h"
+
 #define QT_TR_NOOP(x) x // No translation in core*
 static uint8_t tinyAverage(uint8_t *dst, uint8_t *src1, uint8_t *src2,uint32_t l)
 {

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_encCodecDesc.h	2009-12-31 00:28:35 UTC (rev 5792)
@@ -22,66 +22,7 @@
   0,
   NULL
 };
-/********************** FFMPEG MPEG4*************************/
-uint8_t getFFCompressParams (COMPRES_PARAMS * incoming);
 
-FFcodecSetting ffmpeg4Extra = {
-  ME_EPZS,			//     ME
-  0,				//          GMC     
-  1,				// 4MV
-  0,				//           _QPEL;   
-  0,				//           _TREILLIS_QUANT
-  2,				//           qmin;
-  31,				//          qmax;
-  3,				//           max_qdiff;
-  0,				//           max_b_frames;
-  0,				//          mpeg_quant;
-  1,				//
-  -2,				//                 luma_elim_threshold;
-  1,				//
-  -5,				// chroma_elim_threshold;
-  0.05,				//lumi_masking;
-  1,				// is lumi
-  0.01,				//dark_masking; 
-  1,				// is dark
-  0.5,				// qcompress amount of qscale change between easy & hard scenes (0.0-1.0
-  0.5,				// qblur;    amount of qscale smoothing over time (0.0-1.0) 
-  0,				// min bitrate in kB/S
-  0,				// max bitrate
-  0,				// default matrix
-  0,				// no gop size
-  NULL,
-  NULL,
-  0,				// interlaced
-  0,				// WLA: bottom-field-first
-  0,				// wide screen
-  2,				// mb eval = distortion
-  8000,				// vratetol 8Meg
-  0,				// is temporal
-  0.0,				// temporal masking
-  0,				// is spatial
-  0.0,				// spatial masking
-  0,				// NAQ
-  0				// DUMMY 
-};
-
-COMPRES_PARAMS ffmpegMpeg4 = {
-  CodecFF,
-  QT_TR_NOOP("MPEG-4 ASP (lavc)"),
-  "FFMpeg4",
-  "Lavcodec Mpeg4",
-  COMPRESS_CQ,
-  4,
-  1500,
-  700,
-  1000, // AVG
-  ADM_ENC_CAP_CBR + ADM_ENC_CAP_CQ + ADM_ENC_CAP_2PASS+ADM_ENC_CAP_2PASS_BR+ADM_ENC_CAP_SAME,
-  ADM_EXTRA_PARAM,
-  &ffmpeg4Extra,
-  sizeof (ffmpeg4Extra),
-  getFFCompressParams
-};
-
 #include "ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2enc.h"
 // ************ Mpeg2enc VCD *************
 Mpeg2encParam VCDExtra = {
@@ -198,7 +139,6 @@
 
 COMPRES_PARAMS *internalVideoCodec[] = {
   &CopyCodec,
-  &ffmpegMpeg4,
   &VCDCodec,
   &SVCDCodec,
   &DVDCodec,

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_vidEncode.hxx	2009-12-31 00:28:35 UTC (rev 5792)
@@ -20,7 +20,6 @@
 typedef enum 
 {
   CodecCopy,
-  CodecFF,
   CodecVCD,
   CodecSVCD,
   CodecDVD,

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt	2009-12-31 00:28:35 UTC (rev 5792)
@@ -1,6 +1,6 @@
 SET(ADM_encoder_SRCS 
 	adm_encConfig.cpp  adm_encoder.cpp
-	adm_encCopy.cpp    adm_encffmpeg.cpp   adm_encmpeg2enc.cpp  adm_encRequant.cpp  adm_encyv12.cpp
+	adm_encCopy.cpp    adm_encmpeg2enc.cpp  adm_encRequant.cpp  adm_encyv12.cpp
 	ADM_pluginLoad.cpp ADM_externalEncoder.cpp)
 
 ADD_ADM_LIB_ALL_TARGETS(ADM_encoder ${ADM_encoder_SRCS})

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -47,10 +47,6 @@
 
 #include "adm_encConfig.h"
 #include "adm_encoder.h"
-
-#include "ADM_codecs/ADM_ffmpeg.h"
-#include "adm_encffmpeg.h"
-
 #include "adm_encCopy.h"
 #include "adm_encyv12.h"
 #include "adm_encmpeg2enc.h"
@@ -363,6 +359,16 @@
 
 int videoCodecPluginSelectByGuid(const char *guid)
 {
+	int index = videoCodecPluginGetIndexByGuid(guid);
+
+	if (index != -1)
+		videoCodecSetCodec(index);
+
+	return (index != -1);
+}
+
+int videoCodecPluginGetIndexByGuid(const char *guid)
+{
 	int encoderCount = encoderGetEncoderCount();
 
 	for (int i = 0; i < encoderCount; i++)
@@ -375,14 +381,13 @@
 			if (strcmp(encoderGuid, guid) == 0)
 			{
 				printf ("Codec plugin %s (%s) found\n", plugin->getEncoderName(plugin->encoderId), encoderGuid);
-				videoCodecSetCodec(i);
-
-				return 1;
+				
+				return i;
 			}
 		}
 	}
 
-	return 0;
+	return -1;
 }
 
 const char* videoCodecPluginGetGuid(void)
@@ -580,7 +585,7 @@
 	}
 }
 
-Encoder *getVideoEncoder(uint32_t w, uint32_t h, uint32_t globalHeaderFlag)
+Encoder *getVideoEncoder(uint32_t globalHeaderFlag)
 {
 	Encoder *e = NULL;
 	COMPRES_PARAMS *desc=getCodecParamFromTag(currentCodecType);
@@ -593,9 +598,6 @@
 	case CodecYV12:
 		e = new EncoderYV12 ();
 		break;
-	case CodecFF:
-		e = new EncoderFFMPEG (FF_MPEG4, desc);
-		break;
 	case CodecDVD:
 		e=new EncoderMpeg2enc(MPEG2ENC_DVD, desc);
 		printf("\n Using mpeg2enc encoder (DVD)\n");

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.h	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.h	2009-12-31 00:28:35 UTC (rev 5792)
@@ -10,6 +10,7 @@
 const char *videoCodecGetName(void);
 int videoCodecSelectByName (const char *name);
 int videoCodecPluginSelectByGuid(const char *guid);
+int videoCodecPluginGetIndexByGuid(const char *guid);
 
 SelectCodecType videoCodecGetType(void);
 const char* videoCodecPluginGetGuid(void);

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -1,313 +0,0 @@
-/***************************************************************************
-                          adm_encffmpeg.cpp  -  description
-                             -------------------
-    begin                : Tue Sep 10 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#define __STDC_LIMIT_MACROS
-
-#include "config.h"
-#include "ADM_lavcodec.h"
-
-
-#include "fourcc.h"
-#include "avi_vars.h"
-#include "DIA_coreToolkit.h"
-#include "ADM_default.h"
-#include "ADM_encoder/ADM_vidEncode.hxx"
-
-#include "ADM_videoFilter.h"
-#include "ADM_codecs/ADM_ffmpeg.h"
-#include "ADM_encoder/adm_encoder.h"
-#include "ADM_encoder/adm_encffmpeg.h"
-
-uint32_t ADM_computeBitrate(uint32_t fps1000, uint32_t nbFrame, uint32_t sizeInMB);
-
-/*_________________________________________________*/
-EncoderFFMPEG::EncoderFFMPEG (FF_CODEC_ID id, COMPRES_PARAMS * config)
-{
-  _codec = NULL;
-  fd = NULL;
-  strcpy (_logname, "");
-  _frametogo = 0;
-  memcpy (&_param, config, sizeof (_param));
-  ADM_assert (sizeof (_settings) == config->extraSettingsLen);
-  memcpy (&_settings, config->extraSettings, sizeof (_settings));
-  _id = id;
-};
-
-// return codec name as seen in avi header
-//
-const char *
-EncoderFFMPEG::getCodecName (void)
-{
-  switch (_id)
-    {
-    case FF_MPEG4:
-      return "DX50";
-      break;
-    default:
-      ADM_assert (0);
-
-    }
-  return NULL;
-}
-//--------------------------------
-uint8_t EncoderFFMPEG::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
-{
-
-  ADM_assert (instream);
-  ADV_Info *
-    info;
-
-  uint32_t
-    flag1,
-    flag2,
-    flag3;
-  flag1 = flag2 = flag3 = 0;
-
-  info = instream->getInfo ();
-  _fps = info->fps1000;
-  _w = info->width;
-  _h = info->height;
-
-  _vbuffer = new ADMImage (_w, _h);
-  ADM_assert (_vbuffer);
-  _in = instream;
-
-
-  switch (_param.mode)
-    {
-    case COMPRESS_SAME:
-      printf ("FFmpeg in follow quant mode\n");
-      _state = enc_Same;
-      _codec = new ffmpegEncoderVBRExternal (_w, _h, _id);
-      _codec->setConfig (&_settings);
-      _codec->init (2, _fps, 0);
-      break;
-
-    case COMPRESS_CQ:
-      printf ("ffmpeg cq mode: %ld\n", _param.qz);
-      _state = enc_CQ;
-      _codec = new ffmpegEncoderCQ (_w, _h, _id);
-      _codec->setConfig (&_settings);
-      _codec->init (_param.qz, _fps, 0);
-      break;
-    case COMPRESS_CBR:
-      printf ("ffmpeg cbr mode: %ld\n", _param.bitrate);
-      _state = enc_CBR;
-      _codec = new ffmpegEncoderCBR (_w, _h, _id);
-      _codec->setConfig (&_settings);
-      _codec->init (_param.bitrate, _fps, flag1);
-      break;
-    case COMPRESS_2PASS:
-    case COMPRESS_2PASS_BITRATE:
-      ffmpegEncoderCQ * cdec;
-      if(_param.mode==COMPRESS_2PASS)
-        printf ("\n ffmpeg dual size: %lu", _param.finalsize);
-      else
-        printf ("\n ffmpeg dual bitrate: %lu", _param.avg_bitrate);
-      _state = enc_Pass1;
-      cdec = new ffmpegEncoderCQ (_w, _h, _id);	// Pass1
-      cdec->setConfig (&_settings);
-      // 1+  VBR stats required
-      // no stats
-      // force internal
-      cdec->setLogFile (_logname);
-      cdec->init (2, _fps, 1);
-
-      _codec = cdec;
-      if (flag1)
-	_internal = 0;
-      else
-	_internal = 1;
-      break;
-
-      break;
-    default:
-      ADM_assert (0);
-
-    }
-  _in = instream;
-  printf ("\n ffmpeg Encoder , w: %lu h:%lu mode:%d", _w, _h, _state);
-  return 1;
-
-}
-
-
-
-uint8_t EncoderFFMPEG::startPass1 (void)
-{
-  ADM_assert (_state == enc_Pass1);
-  _frametogo = 0;
-  printf ("\n Starting pass 1\n");
-  printf (" Creating logfile :<%s>\n", _logname);
-  return 1;
-}
-
-int EncoderFFMPEG::getRequirements (void) { return _codec->capabilities; }
-
-uint8_t EncoderFFMPEG::isDualPass (void)
-{
-  if ((_state == enc_Pass1) || (_state == enc_Pass2))
-    {
-      return 1;
-    }
-  return 0;
-}
-
-uint8_t EncoderFFMPEG::setLogFile (const char *lofile, uint32_t nbframe)
-{
-  strcpy (_logname, lofile);
-  _frametogo = nbframe;
-  printf("EncoderFF : using <%s> as logfile, for %u frames\n",lofile,nbframe);
-  return 1;
-
-}
-
-//______________________________
-uint8_t EncoderFFMPEG::encode (uint32_t frame, ADMBitstream *out)
-{
-  uint32_t l, f;
-  //ENC_RESULT enc;
-
-  ADM_assert (_codec);
-  ADM_assert (_in);
-
-  if (frame != UINT32_MAX)
-  {
-	  if (!_in->getFrameNumberNoAlloc (frame, &l, _vbuffer, &f))
-	  {
-		  printf ("\n Error : Cannot read incoming frame !");
-		  return 0;
-	  }
-  }
-
-  switch (_state)
-    {
-    case enc_CBR:
-    case enc_CQ:
-      return _codec->encode (frame == UINT32_MAX ? NULL : _vbuffer, out );
-      break;
-    case enc_Same:
-      {
-		  if (frame != UINT32_MAX)
-		  {
-			  if (_vbuffer->flags & AVI_KEY_FRAME)
-				  out->flags = AVI_KEY_FRAME;
-			  else
-				  out->flags = 0;
-
-			  int inq = _vbuffer->_Qp;
-
-			  if (inq > 31)
-				  inq = 31;
-
-			  if (inq < 2)
-				  inq = 2;
-
-			  out->in_quantizer = inq;
-		  }
-
-	if (!_codec->encode (frame == UINT32_MAX ? NULL : _vbuffer, out ))
-	  {
-	    printf ("\n codec error on 1st pass !");
-	    return 0;
-	  }
-	//printf("Inq:%lu outq:%lu\n",inq,enc.out_quantizer);                       
-	_frametogo++;
-	return 1;
-	break;
-      }
-    case enc_Pass1:
-
-      //              ADM_assert(fd);
-      if (!_codec->encode (frame == UINT32_MAX ? NULL : _vbuffer, out ))
-	{
-	  printf ("\n codec error on 1st pass !");
-	  return 0;
-	}
-      _frametogo++;
-      return 1;
-      break;
-    case enc_Pass2:
-      // Encode it !
-      if (!_codec->encode (frame == UINT32_MAX ? NULL : _vbuffer, out ))
-            return 0;
-      return 1;
-      break;
-
-    default:
-      ADM_assert (0);
-    }
-  return 0;
-}
-
-//_______________________________
-uint8_t EncoderFFMPEG::stop (void)
-{
-  if (_codec)
-    delete
-      _codec;
-  _codec = NULL;
-  return 1;
-
-}
-
-uint8_t EncoderFFMPEG::startPass2 (void)
-{
-
-  ADM_assert (_state = enc_Pass1);
-  printf ("\n Starting pass 2\n");
-
-
-  printf ("\n VBR paramaters computed\n");
-  _state = enc_Pass2;
-  // Delete codec and start new one
-  if (_codec)
-    {
-      delete _codec;
-      _codec = NULL;
-    }
-  _codec = new ffmpegEncoderVBR (_w, _h, _internal, _id);	//0 -> external 1 -> internal
-  _codec->setConfig (&_settings);
-  printf ("\n ready to encode in 2pass : %s\n", _logname);
-  uint32_t    vbr = 0;
-  switch(_param.mode)
-  {
-    case COMPRESS_2PASS:          
-          // compute average bitrate
-            vbr= ADM_computeBitrate(_fps, _frametogo,_param.finalsize);
-            break;
-    case COMPRESS_2PASS_BITRATE:
-            vbr=_param.avg_bitrate*1000; // in b/s
-            break;
-    default:
-          ADM_assert(0);
-  }
-
-  _codec->setLogFile (_logname);
-  if(!_codec->init (vbr, _fps))
-  {
-    printf("2 pass start failed!\n");
-    return 0;
-  }
-
-  printf ("\n ** Total size     : %lu MBytes \n", _param.finalsize);
-//  printf(" ** Total frame    : %lu  \n",_totalframe);   
-  printf (" (using avg bitrate of %lu kbps", vbr / 1000);
-  return 1;
-}
-//-----------------------ffmpegEncoderHuff
-
-

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h	2009-12-31 00:28:35 UTC (rev 5792)
@@ -1,58 +0,0 @@
-/***************************************************************************
-                          adm_encffmpeg.h  -  description
-                             -------------------
-    begin                : Tue Sep 10 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef __ADM_encoder_ff__
-#define __ADM_encoder_ff__
-
-
-
-class EncoderFFMPEG:public Encoder
-{
-
-protected:
-
-  ffmpegEncoder * _codec;
-  uint8_t _internal;
-  FF_CODEC_ID _id;
-  uint32_t _fps;
-  FFcodecSetting _settings;
-public:
-    EncoderFFMPEG (FF_CODEC_ID id, COMPRES_PARAMS * codecParam);
-   ~EncoderFFMPEG ()
-  {
-    stop ();
-  };				// can be called twice if needed ..
-  virtual int getRequirements (void);
-  virtual uint8_t isDualPass (void);
-  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
-  virtual uint8_t encode (uint32_t frame,ADMBitstream *out);
-  virtual uint8_t setLogFile (const char *p, uint32_t fr);
-  virtual uint8_t stop (void);
-  virtual uint8_t startPass2 (void);
-  virtual uint8_t startPass1 (void);
-  virtual const char *getDisplayName (void)
-  {
-    return QT_TR_NOOP("LavCodec");
-  }
-  virtual const char *getCodecName (void);	//{return "DX50";}
-  virtual const char *getFCCHandler (void)
-  {
-    return "divx";
-  }
-
-
-};
-#endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.h	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.h	2009-12-31 00:28:35 UTC (rev 5792)
@@ -101,9 +101,8 @@
 
 
 };
-Encoder *getVideoEncoder (uint32_t w, uint32_t h, uint32_t globalHeader = 0);
+Encoder *getVideoEncoder (uint32_t globalHeader = 0);
 
-
 typedef enum
 {
   CodecFamilyAVI,

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -69,7 +69,7 @@
 
 		}
 
-  _encode = getVideoEncoder (_incoming->getInfo()->width,_incoming->getInfo()->height);
+  _encode = getVideoEncoder();
   if (!_encode)
     return 0;
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -15,6 +15,9 @@
  *                                                                         *
  ***************************************************************************/
 
+#include <sstream>
+#include <string>
+
 #include "config.h"
 #include "ADM_default.h"
 #include "ADM_threads.h"
@@ -37,26 +40,25 @@
 #include "ADM_videoFilter_internal.h"
 
 #include "ADM_encoder/ADM_vidEncode.hxx"
+#include "ADM_encoder/adm_encConfig.h"
+#include "ADM_encoder/ADM_externalEncoder.h"
 
 #include "op_aviwrite.hxx"
 #include "op_avisave.h"
 #include "op_savesmart.hxx"
 
-#ifdef USE_FFMPEG		
-#include "ADM_codecs/ADM_ffmpeg.h"		
-#endif
-
 #include "ADM_osSupport/ADM_debugID.h"
 #define MODULE_NAME MODULE_SAVE_AVI
 #include "ADM_osSupport/ADM_debug.h"
 
+extern struct COMPRES_PARAMS *AllVideoCodec;
+
 GenericAviSaveSmart::GenericAviSaveSmart(uint32_t qf) : GenericAviSave()
 {
 	_cqReenc=qf;
 	ADM_assert(qf>=2 && qf<32);
 	_nextip=0;
-	encoderReady=0;
-        _hasBframe=0;
+    _hasBframe=0;
 }
 uint8_t	GenericAviSaveSmart::setupVideo (char *name)
 {
@@ -89,9 +91,7 @@
       return 0;
     }
   compEngaged = 0;
-  encoderReady = 0;
   _encoder = NULL;
-  aImage=new ADMImage(_mainaviheader.dwWidth,_mainaviheader.dwHeight);
   _incoming = getFirstVideoFilter (frameStart,frameEnd-frameStart);
   encoding_gui->setFps(_incoming->getInfo()->fps1000);
   encoding_gui->setPhasis(QT_TR_NOOP("Smart Copy"));
@@ -113,17 +113,7 @@
 GenericAviSaveSmart::~GenericAviSaveSmart ()
 {
   cleanupAudio();
-  if (encoderReady && _encoder)
-    {
-      _encoder->stopEncoder ();
-    }
-  if (_encoder)
-    delete      _encoder;
- if(aImage)
- {
- 	delete aImage;
-	aImage=NULL;
- }
+  deleteEncoder();
 }
 
 // copy mode
@@ -152,22 +142,18 @@
 	  aprintf("Smart: Stopping encoder\n");
 	  // It is a kf, go back to copy mode
 	  compEngaged = 0;
-	  stopEncoder ();	// Tobias F
-	  delete	    _encoder;
-	  _encoder = NULL;
+	  deleteEncoder();
+
 	  return writeVideoChunk_copy(frame,1);
 	}
 	// Else encode it ....
-	//1-Read it
-	if (! video_body->getUncompressedFrame (frame, aImage))
-		return -1;
-	// 2-encode it
+	// 1-encode it
         bitstream.data=vbuffer;
         bitstream.cleanup(frame);
-        if (!_encoder->encode (aImage, &bitstream))//vbuffer, &len, &_videoFlag))
+	    if (!_encoder->encode(frame, &bitstream))
 		return -1;
         _videoFlag=bitstream.flags;
-	// 3-write it
+	// 2-write it
         encoding_gui->setFrame(frame-frameStart,bitstream.len,bitstream.out_quantizer,frametogo);
 	if (writter->saveVideoFrame (bitstream.len, _videoFlag, vbuffer))
 		return bitstream.len;
@@ -344,104 +330,70 @@
 	}
 	return 0;
 }
- //
- //
-uint8_t
-GenericAviSaveSmart::initEncoder (uint32_t qz)
+
+uint8_t GenericAviSaveSmart::initEncoder (uint32_t qz)
 {
-  aviInfo
-    info;
-  video_body->getVideoInfo (&info);
-  ADM_assert (0 == encoderReady);
-  encoderReady = 1;
-  uint8_t ret=0;
-  FFcodecSetting myConfig=
-	 {
-	 ME_EPZS,//	ME
-	 0, // 		GMC	
-	 0,	// 4MV
-	 0,//		_QPEL;	 
-	 0,//		_TREILLIS_QUANT
-	 2,//		qmin;
-	 31,//		qmax;
-	 3,//		max_qdiff;
-	 1,//		max_b_frames;
-	 0, //		mpeg_quant;
-	 1, //
-	 -2, // 		luma_elim_threshold;
-	 1,//
-	 -5, 		// chroma_elim_threshold;
-	 0.05,		//lumi_masking;
-	 1,		// is lumi
-	 0.01,		//dark_masking; 
-	 1,		// is dark
- 	 0.5,		// qcompress amount of qscale change between easy & hard scenes (0.0-1.0
-    	 0.5,		// qblur;    amount of qscale smoothing over time (0.0-1.0) 
-	0,		// min bitrate in kB/S
-	0,		// max bitrate
-	0, 		// default matrix
-	0, 		// no gop size
-	NULL,
-	NULL,
-	0,		// interlaced
-	0,		// WLA: bottom-field-first
-	0,		// wide screen
-	2,		// mb eval = distortion
-	8000,		// vratetol 8Meg
-	0,		// is temporal
-	0.0,		// temporal masking
-	0,		// is spatial
-	0.0,		// spatial masking
-	0,		// NAQ
-	0		// DUMMY 
- 	} ;
+	aviInfo info;
 
+	video_body->getVideoInfo (&info);
 
-  if(  isMpeg4Compatible(info.fcc) )
-  	{
-// 	uint8_t				setConfig(FFcodecSetting *set);	
-			ffmpegEncoderCQ *tmp;		
-			tmp = new ffmpegEncoderCQ (info.width, info.height,FF_MPEG4);					
-			myConfig.max_b_frames=_hasBframe; // In fact does the original have b frame ?
-			tmp->setConfig(&myConfig);
-			printf("\n init qz %ld\n",qz);
-	    		ret= tmp->init (qz,25000);
-			_encoder=tmp;
-		
-#warning 25 fps hardcoded
+	if (_encoder)
+		deleteEncoder();
 
-		 }
-		 else
-		 {
-#ifdef USE_FFMPEG			 
-			 if(isMSMpeg4Compatible(info.fcc) ) // DIV3
-			 {
-				 ffmpegEncoderCQ *tmp;
-				  tmp = new ffmpegEncoderCQ (info.width, info.height,FF_MSMP4V3);
-                                  myConfig.max_b_frames=0;
-				  tmp->setConfig(&myConfig);
-			    	  ret= tmp->init (qz,25000);
-			    	  _encoder=tmp;
-				}
-				else
-					{
-				       ADM_assert(0);
-					}			
-			}
-#else
-			ADM_assert(0);
-			}			
-#endif
+	if (isMpeg4Compatible(info.fcc))
+	{
+		std::stringstream out;
 
-		return ret;
+		out << "<?xml version='1.0'?><Mpeg4aspConfig><Mpeg4aspOptions><motionEstimationMethod>epzs</motionEstimationMethod><fourMotionVector>false</fourMotionVector><maximumBFrames>";
+		out << _hasBframe;
+		out << "</maximumBFrames><quarterPixel>false</quarterPixel><globalMotionCompensation>false</globalMotionCompensation><quantisationType>h263</quantisationType><macroblockDecisionMode>rateDistortion</macroblockDecisionMode><minimumQuantiser>2</minimumQuantiser><maximumQuantiser>31</maximumQuantiser><quantiserDifference>3</quantiserDifference><trellis>false</trellis><quantiserCompression>0.5</quantiserCompression><quantiserBlur>0.5</quantiserBlur></Mpeg4aspOptions></Mpeg4aspConfig>";
+		_encoderIndex = videoCodecPluginGetIndexByGuid("0E7C20E3-FF92-4bb2-A9A9-55B7F713C45A");
+
+		std::string settings = out.str();
+		COMPRES_PARAMS *param = &AllVideoCodec[_encoderIndex];
+		ADM_vidEnc_plugin *plugin = getVideoEncoderPlugin(param->extra_param);
+		int length = plugin->getOptions(plugin->encoderId, NULL, NULL, 0);
+		vidEncOptions options;
+
+		options.structSize = sizeof(vidEncOptions);
+		options.encodeMode = ADM_VIDENC_MODE_CQP;
+		options.encodeModeParameter = qz;
+
+		_origSettings = new char[length + 1];
+		plugin->getOptions(plugin->encoderId, &_origOptions, _origSettings, length);
+		plugin->setOptions(plugin->encoderId, &options, (char*)settings.c_str());
+
+		if (_encoderIndex > -1)
+		{
+			_encoder = new externalEncoder(param, 0);
+			_encoder->configure(_incoming, false);
+		}
+
+		return (_encoderIndex != -1);
+	}
+
+	return 1;
 }
 
+void GenericAviSaveSmart::deleteEncoder(void)
+{
+	if (_encoder)
+	{
+		COMPRES_PARAMS *param = &AllVideoCodec[_encoderIndex];
+		ADM_vidEnc_plugin *plugin = getVideoEncoderPlugin(param->extra_param);
+
+		delete [] _origSettings;
+		delete _encoder;
+		_encoder = NULL;
+
+		plugin->setOptions(plugin->encoderId, &_origOptions, _origSettings);
+	}
+}
+
 uint8_t
 GenericAviSaveSmart::stopEncoder (void)
 {
-  ADM_assert (1 == encoderReady);
-  encoderReady = 0;
-  return (_encoder->stopEncoder ());
+	return 1;
 }
 
 #endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.hxx
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.hxx	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.hxx	2009-12-31 00:28:35 UTC (rev 5792)
@@ -17,24 +17,29 @@
  #ifndef __AVI_SAVESMT__
  #define   __AVI_SAVESMT__
 
+#include "ADM_encoder/ADM_pluginLoad.h"
+
  class GenericAviSaveSmart : public   GenericAviSave
  {
      protected :
                                 uint32_t        _hasBframe;
-     #warning HARDCODED MAX IMAGE SIZE
-     				
-				ADMImage	*aImage;
 				uint32_t	_nextip;
 				uint8_t 	initEncoder(uint32_t qz );
 				uint8_t 	stopEncoder(void  );
-       				uint32_t 	encoderReady;
               			uint32_t 	compEngaged;
 	virtual 		uint8_t 	setupVideo( char *name  );
  	virtual 		int 	writeVideoChunk(uint32_t frame );
 				int		 writeVideoChunk_recode (uint32_t frame);
 				int		 writeVideoChunk_copy (uint32_t frame,uint32_t first=0);
-              			encoder 	*_encoder;
               			uint8_t 	_cqReenc          ;
+
+		Encoder *_encoder;
+		int _encoderIndex;
+
+		vidEncOptions _origOptions;
+		char *_origSettings;
+		
+		void deleteEncoder(void);
 				
      public:
      							

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_dummy/oplug_dummy.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_dummy/oplug_dummy.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_dummy/oplug_dummy.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -29,7 +29,6 @@
 };
 
 #include "ADM_editor/ADM_Video.h"
-//#include "ADM_colorspace/colorspace.h"
 #include "DIA_coreToolkit.h"
 #include "ADM_videoFilter.h"
 #include "ADM_videoFilter_internal.h"
@@ -37,9 +36,6 @@
 #include "ADM_encoder/ADM_vidEncode.hxx"
 #include "ADM_codecs/ADM_codec.h"
 #include "ADM_encoder/adm_encoder.h"
-
-#include "ADM_codecs/ADM_ffmpeg.h"
-#include "ADM_encoder/adm_encffmpeg.h"
 #include "../oplug_mpegFF/oplug_vcdff.h"
 
 #include "ADM_userInterfaces/ADM_commonUI/DIA_encoding.h"
@@ -116,7 +112,7 @@
 
            videoBuffer=new uint8_t[_incoming->getInfo()->width*_incoming->getInfo()->height*3];
                 // Set global header encoding, needed for H264
-           _encode = getVideoEncoder (_incoming->getInfo()->width,  _incoming->getInfo()->height,1);
+           _encode = getVideoEncoder(1);
            total= _incoming->getInfo()->nb_frames;
 
            info.fcc=*(uint32_t *)_encode->getCodecName(); //FIXME

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -37,8 +37,6 @@
 #include "ADM_codecs/ADM_codec.h"
 #include "ADM_encoder/adm_encoder.h"
 
-#include "ADM_codecs/ADM_ffmpeg.h"
-#include "ADM_encoder/adm_encffmpeg.h"
 #include "../oplug_mpegFF/oplug_vcdff.h"
 
 #include "ADM_userInterfaces/ADM_commonUI/DIA_encoding.h"
@@ -123,7 +121,7 @@
 
            videoBuffer=new uint8_t[_incoming->getInfo()->width*_incoming->getInfo()->height*3];
                 // Set global header encoding, needed for H264
-           _encode = getVideoEncoder (_incoming->getInfo()->width,  _incoming->getInfo()->height,1);
+           _encode = getVideoEncoder(1);
            total= _incoming->getInfo()->nb_frames;
 
            info.fcc=*(uint32_t *)_encode->getCodecName(); //FIXME

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mp4/oplug_mp4.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mp4/oplug_mp4.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mp4/oplug_mp4.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -40,8 +40,6 @@
 #include "ADM_encoder/ADM_vidEncode.hxx"
 #include "ADM_encoder/adm_encoder.h"
 
-#include "ADM_codecs/ADM_ffmpeg.h"
-#include "ADM_encoder/adm_encffmpeg.h"
 #include "../oplug_mpegFF/oplug_vcdff.h"
 
 #include "ADM_userInterfaces/ADM_commonUI/DIA_encoding.h"
@@ -132,8 +130,7 @@
 
            videoBuffer=new uint8_t[_incoming->getInfo()->width*_incoming->getInfo()->height*3];
                 // Set global header encoding, needed for H264
-           _encode = getVideoEncoder (_incoming->getInfo()->width,
-                        _incoming->getInfo()->height,1);
+           _encode = getVideoEncoder(1);
            total= _incoming->getInfo()->nb_frames;
 
            encoding_gui=new DIA_encoding(_incoming->getInfo()->fps1000);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -170,7 +170,7 @@
             }
          }        
         // Create muxer
-       encoder = getVideoEncoder(_w, _h, 0);
+       encoder = getVideoEncoder(0);
 
 	   if (encoder == NULL)
 		   return 0;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_ogm/op_ogsaveprocess.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_ogm/op_ogsaveprocess.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_ogm/op_ogsaveprocess.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -55,7 +55,7 @@
         _prestoring=1;
 	_incoming = getLastVideoFilter (frameStart,frameEnd-frameStart);
  	_togo=_incoming->getInfo()->nb_frames;
-  	_encode = getVideoEncoder (_incoming->getInfo()->width,_incoming->getInfo()->height);
+  	_encode = getVideoEncoder();
 	if (!_encode)
     		return 0;
  	

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -36,7 +36,6 @@
 #include "ADM_encoder/ADM_vidEncode.hxx"
 #include "ADM_coreAudio/include/audioencoder.h"
 #include "ADM_lavcodec.h"
-#include "ADM_codecs/ADM_ffmpegConfig.h"
 
 #include "ADM_ocr/ADM_ocr.h"
 #include "ADM_ocr/ADM_ocrInternal.h"
@@ -48,24 +47,8 @@
 
 int SliderIsShifted = 0;
 
-
-
-
-#ifdef USE_XX_XVID 
-#include "xvid.h"
-int  DIA_getXvidCompressParams(COMPRESSION_MODE * mode, uint32_t * qz,
-		      uint32_t * br,uint32_t *fsize,xvidEncParam *param) {return 0;}
-#endif
-
-
-
-
-
 uint8_t DIA_getPartial(PARTIAL_CONFIG *param,AVDMGenericVideoStream *son,AVDMGenericVideoStream *previous) {return 0;}
-uint8_t DIA_pipe(char **cmd,char **param) {return 0;}
 uint8_t DIA_vobsub(vobSubParam *param) {return 0;}
-uint8_t DIA_XVCDParam(char *title,COMPRESSION_MODE * mode, uint32_t * qz,
-		   				   uint32_t * br,uint32_t *fsize,FFcodecSetting *conf) {return 0;}
 uint8_t DIA_quota(char *) {return 0;}
 const char * GUI_getCustomScript(uint32_t nb) {return 0;}
 uint8_t DIA_RecentFiles( char **name ) {return 0;}
@@ -78,14 +61,8 @@
 uint8_t DIA_job(uint32_t nb,char **name) {return 0;}
 uint8_t DIA_resize(uint32_t *width,uint32_t *height,uint32_t *algo,uint32_t originalw, 
                         uint32_t originalh,uint32_t fps) {return 0;}
-uint8_t DIA_d3d(double *luma,double *chroma,double *temporal) {return 0;}
-uint8_t DIA_kerneldeint(uint32_t *order, uint32_t *threshold, uint32_t *sharp, 
-                          uint32_t *twoway, uint32_t *map) {return 0;}
-uint8_t DIA_4entries(char *title,uint32_t *left,uint32_t *right,uint32_t *top,uint32_t *bottom) {return 0;}
 uint8_t DIA_videoCodec(int *codecIndex) {return 0;}
 uint8_t DIA_audioCodec( int *codec ) {return 0;}
-uint8_t DIA_dnr(uint32_t *llock,uint32_t *lthresh, uint32_t *clock,
-			uint32_t *cthresh, uint32_t *scene) {return 0;}
 uint8_t DIA_glyphEdit(void) {return 0;}
 struct THRESHOLD_PARAM;
 struct ADMVideoThreshold;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt	2009-12-31 00:28:35 UTC (rev 5792)
@@ -7,7 +7,6 @@
 DIA_gototime.cpp    
 DIA_postproc.cpp  
 DIA_bitrateHisto.cpp  
-DIA_lavcodec.cpp    
 DIA_prefs.cpp     
 DIA_SVCD.cpp       
 DIA_builtin.cpp       

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_lavcodec.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_lavcodec.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_lavcodec.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -1,113 +0,0 @@
-//
-// C++ Implementation: ADM_vidForcedPP
-//
-// Description: 
-//
-//	Force postprocessing assuming constant quant & image type
-//	Uselefull on some badly authored DVD for example
-//
-// Author: mean <fixounet at free.fr>, (C) 2004
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-
-#include "config.h"
-#include "ADM_default.h"
-
-
-#include "DIA_factory.h"
-#include "ADM_lavcodec.h"
-#include "ADM_codecs/ADM_ffmpegConfig.h"
-#include "ADM_encoder/ADM_vidEncode.hxx"
-/**
-      \fn getFFCompressParams
-      \brief Dialog for lavcodec mpeg4/... codec settings
-*/
-uint8_t getFFCompressParams(COMPRES_PARAMS *incoming)
-{
-int ret=0;	
-	FFcodecSetting *conf=(FFcodecSetting *)incoming->extraSettings;
-	ADM_assert(incoming->extraSettingsLen==sizeof(FFcodecSetting));
-#define PX(x) &(conf->x)
-         
-         
-         
-diaMenuEntry meE[]={
-  {1,QT_TR_NOOP("None")},
-  {2,QT_TR_NOOP("Full")},
-  {3,QT_TR_NOOP("Log")},
-  {4,QT_TR_NOOP("Phods")},
-  {5,QT_TR_NOOP("EPZS")},
-  {6,QT_TR_NOOP("X1")}
-};       
-
-diaMenuEntry qzE[]={
-  {0,QT_TR_NOOP("H.263")},
-  {1,QT_TR_NOOP("MPEG")}
-};       
-
-diaMenuEntry rdE[]={
-  {0,QT_TR_NOOP("MB comparison")},
-  {1,QT_TR_NOOP("Fewest bits (vhq)")},
-  {2,QT_TR_NOOP("Rate distortion")}
-};     
-
-uint32_t me=(uint32_t)conf->me_method;  
-
-         diaElemBitrate bitrate(incoming,NULL);
-         diaElemMenu      meM(&me,QT_TR_NOOP("Matrices"),4,meE);
-         diaElemUInteger  qminM(PX(qmin),QT_TR_NOOP("Mi_n. quantizer:"),1,31);
-         diaElemUInteger  qmaxM(PX(qmax),QT_TR_NOOP("Ma_x. quantizer:"),1,31);
-         diaElemUInteger  qdiffM(PX(max_qdiff),QT_TR_NOOP("Max. quantizer _difference:"),1,31);
-         
-         diaElemToggle    fourMv(PX(_4MV),QT_TR_NOOP("4_MV"));
-         diaElemToggle    trellis(PX(_TRELLIS_QUANT),QT_TR_NOOP("_Trellis quantization"));
-         
-         diaElemToggle    qpel(PX(_QPEL),QT_TR_NOOP("_Quarter pixel"));
-         diaElemToggle    gmc(PX(_GMC),QT_TR_NOOP("_GMC"));
-
-         
-         diaElemUInteger  max_b_frames(PX(max_b_frames),QT_TR_NOOP("_Number of B frames:"),0,32);
-         diaElemMenu     qzM(PX(mpeg_quant),QT_TR_NOOP("_Quantization type:"),2,qzE);
-         
-         diaElemMenu     rdM(PX(mb_eval),QT_TR_NOOP("_Macroblock decision:"),3,rdE);
-         
-         diaElemUInteger filetol(PX(vratetol),QT_TR_NOOP("_Filesize tolerance (kb):"),0,100000);
-         
-         diaElemFloat    qzComp(PX(qcompress),QT_TR_NOOP("_Quantizer compression:"),0,1);
-         diaElemFloat    qzBlur(PX(qblur),QT_TR_NOOP("Quantizer _blur:"),0,1);
-         
-         
-          /* First Tab : encoding mode */
-        diaElem *diamode[]={&bitrate};
-        diaElemTabs tabMode(QT_TR_NOOP("User Interface"),1,diamode);
-        
-        /* 2nd Tab : ME */
-        diaElemFrame frameMe(QT_TR_NOOP("Advanced Simple Profile"));
-        
-        frameMe.swallow(&max_b_frames);
-        frameMe.swallow(&qpel);
-        frameMe.swallow(&gmc);
-        
-        diaElem *diaME[]={&fourMv,&frameMe};
-        diaElemTabs tabME(QT_TR_NOOP("Motion Estimation"),2,diaME);
-        /* 3nd Tab : Qz */
-        
-         diaElem *diaQze[]={&qzM,&rdM,&qminM,&qmaxM,&qdiffM,&trellis};
-        diaElemTabs tabQz(QT_TR_NOOP("Quantization"),6,diaQze);
-        
-        /* 4th Tab : RControl */
-        
-         diaElem *diaRC[]={&filetol,&qzComp,&qzBlur};
-        diaElemTabs tabRC(QT_TR_NOOP("Rate Control"),3,diaRC);
-        
-         diaElemTabs *tabs[]={&tabMode,&tabME,&tabQz,&tabRC};
-        if( diaFactoryRunTabs(QT_TR_NOOP("libavcodec MPEG-4 configuration"),4,tabs))
-	{
-          conf->me_method=(Motion_Est_ID)me;
-          return 1;
-        }
-         return 0;
-}
-// EOF

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_requant.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_requant.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_requant.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -12,7 +12,6 @@
 
 #include "ADM_codecs/ADM_codec.h"
 #include "ADM_encoder/ADM_vidEncode.hxx"
-#include "ADM_codecs/ADM_ffmpegConfig.h"
 
   
 #include "DIA_factory.h"

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp	2009-12-31 00:28:35 UTC (rev 5792)
@@ -57,7 +57,6 @@
 #include "ADM_videoFilter.h"
 #include "ADM_videoFilter_internal.h"
 #include "ADM_encoder/ADM_vidEncode.hxx"
-#include "ADM_codecs/ADM_ffmpeg.h"
 #include "ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2enc.h"
 #include "ADM_video/ADM_vidMisc.h"
 #include "ADM_preview.h"

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Mpeg4aspParam.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Mpeg4aspParam.xsd	2009-12-30 19:08:15 UTC (rev 5791)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/Mpeg4aspParam.xsd	2009-12-31 00:28:35 UTC (rev 5792)
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="utf-8"?>
 <xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified">
-  <xs:element name="H263Config">
+  <xs:element name="Mpeg4aspConfig">
     <xs:complexType>
       <xs:sequence>
         <xs:element name="presetConfiguration" minOccurs="0">
@@ -35,7 +35,7 @@
             </xs:sequence>
           </xs:complexType>
         </xs:element>
-        <xs:element name="H263Options">
+        <xs:element name="Mpeg4aspOptions">
           <xs:complexType>
             <xs:sequence>
               <xs:element name="motionEstimationMethod">



From gruntster at mail.berlios.de  Thu Dec 31 01:45:55 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu, 31 Dec 2009 01:45:55 +0100
Subject: [Avidemux-svn-commit] r5793 - in
	branches/avidemux_2.5_branch_gruntster: avidemux/ADM_encoder
	avidemux/ADM_outputs/oplug_avi avidemux/ADM_plugin
	plugins/ADM_videoEncoder/ADM_vidEnc_avcodec
	plugins/ADM_videoEncoder/ADM_vidEnc_x264
	plugins/ADM_videoEncoder/ADM_vidEnc_xvid
Message-ID: <200912310045.nBV0jtw1006944@sheep.berlios.de>

Author: gruntster
Date: 2009-12-31 01:45:42 +0100 (Thu, 31 Dec 2009)
New Revision: 5793

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_plugin/ADM_vidEnc_plugin.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/dvEncoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/dvEncoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffv1Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffv1Encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffvhuffEncoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffvhuffEncoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/huffyuvEncoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/huffyuvEncoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/interface.c
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/interface.c
Log:
[vidEnc] tweak API so char is const for setOptions

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -34,7 +34,7 @@
 typedef int _vidEncIsConfigurable(int encoderId);
 typedef int _vidEncConfigure(int encoderId, vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
 typedef int _vidEncGetOptions(int encoderId, vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-typedef int _vidEncSetOptions(int encoderId, vidEncOptions *encodeOptions, char *pluginOptions);
+typedef int _vidEncSetOptions(int encoderId, vidEncOptions *encodeOptions, const char *pluginOptions);
 
 typedef int _vidEncGetPassCount(int encoderId);
 typedef int _vidEncGetCurrentPass(int encoderId);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -361,7 +361,7 @@
 
 		_origSettings = new char[length + 1];
 		plugin->getOptions(plugin->encoderId, &_origOptions, _origSettings, length);
-		plugin->setOptions(plugin->encoderId, &options, (char*)settings.c_str());
+		plugin->setOptions(plugin->encoderId, &options, settings.c_str());
 
 		if (_encoderIndex > -1)
 		{

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_plugin/ADM_vidEnc_plugin.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_plugin/ADM_vidEnc_plugin.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_plugin/ADM_vidEnc_plugin.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -125,7 +125,7 @@
 int vidEncIsConfigurable(int encoderId);
 int vidEncConfigure(int encoderId, vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
 int vidEncGetOptions(int encoderId, vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-int vidEncSetOptions(int encoderId, vidEncOptions *encodeOptions, char *pluginOptions);
+int vidEncSetOptions(int encoderId, vidEncOptions *encodeOptions, const char *pluginOptions);
 
 int vidEncGetPassCount(int encoderId);
 int vidEncGetCurrentPass(int encoderId);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/dvEncoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/dvEncoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/dvEncoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -100,7 +100,7 @@
 	return 0;
 }
 
-int DVEncoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+int DVEncoder::setOptions(vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	return 0;
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/dvEncoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/dvEncoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/dvEncoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -50,7 +50,7 @@
 		const char* getFourCC(void);
 		const char* getEncoderGuid(void);
 		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 		int open(vidEncVideoProperties *properties);
 };
 #endif	// __cplusplus

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -108,7 +108,7 @@
 		return encoder->getOptions(encodeOptions, pluginOptions, bufferSize);
 	}
 
-	int avcodecEncoder_setOptions(int encoderId, vidEncOptions *encodeOptions, char *pluginOptions)
+	int avcodecEncoder_setOptions(int encoderId, vidEncOptions *encodeOptions, const char *pluginOptions)
 	{
 		AvcodecEncoder *encoder = encoders[encoderId];
 		return encoder->setOptions(encodeOptions, pluginOptions);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/encoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -66,7 +66,7 @@
 		virtual int isConfigurable(void);
 		virtual int configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
 		virtual int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize) = 0;
-		virtual int setOptions(vidEncOptions *encodeOptions, char *pluginOptions) = 0;
+		virtual int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions) = 0;
 		virtual int getCurrentPass(void);
 		virtual int getPassCount(void);
 		virtual int open(vidEncVideoProperties *properties);
@@ -86,7 +86,7 @@
 	int avcodecEncoder_isConfigurable(int encoderId);
 	int avcodecEncoder_configure(int encoderId, vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
 	int avcodecEncoder_getOptions(int encoderId, vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-	int avcodecEncoder_setOptions(int encoderId, vidEncOptions *encodeOptions, char *pluginOptions);
+	int avcodecEncoder_setOptions(int encoderId, vidEncOptions *encodeOptions, const char *pluginOptions);
 	int avcodecEncoder_getPassCount(int encoderId);
 	int avcodecEncoder_getCurrentPass(int encoderId);
 	int avcodecEncoder_open(int encoderId, vidEncVideoProperties *properties);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffv1Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffv1Encoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffv1Encoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -53,7 +53,7 @@
 	return 0;
 }
 
-int FFV1Encoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+int FFV1Encoder::setOptions(vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	return 0;
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffv1Encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffv1Encoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffv1Encoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -34,7 +34,7 @@
 		const char* getFourCC(void);
 		const char* getEncoderGuid(void);
 		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 };
 #endif	// __cplusplus
 #endif	// ffv1Encoder_h

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffvhuffEncoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffvhuffEncoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffvhuffEncoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -53,7 +53,7 @@
 	return 0;
 }
 
-int FFVHuffEncoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+int FFVHuffEncoder::setOptions(vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	return 0;
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffvhuffEncoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffvhuffEncoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/ffvhuffEncoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -34,7 +34,7 @@
 		const char* getFourCC(void);
 		const char* getEncoderGuid(void);
 		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 };
 #endif	// __cplusplus
 #endif	// ffvhuffEncoder_h

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -57,12 +57,12 @@
 
 const char* FLV1Encoder::getEncoderType(void)
 {
-	return "FLV1";
+	return "Sorenson Spark";
 }
 
 const char* FLV1Encoder::getEncoderDescription(void)
 {
-	return "FLV1 video encoder plugin for Avidemux (c) Mean/Gruntster";
+	return "Sorenson Spark video encoder plugin for Avidemux (c) Mean/Gruntster";
 }
 
 const char* FLV1Encoder::getFourCC(void)
@@ -95,7 +95,7 @@
 	diaElemTabs tabGeneral("Settings", 2, elmGeneral);
 	diaElemTabs *tabs[] = {&tabGeneral};
 
-	if (diaFactoryRunTabs("avcodec FLV1 Configuration", 1, elmHeader, 1, tabs))
+	if (diaFactoryRunTabs("avcodec Sorenson Spark Configuration", 1, elmHeader, 1, tabs))
 	{
 		saveSettings(&_encodeOptions, &_options);
 		updateEncodeProperties(&_encodeOptions);
@@ -208,7 +208,7 @@
 	return xmlLength;
 }
 
-int FLV1Encoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+int FLV1Encoder::setOptions(vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	if (_opened)
 		return ADM_VIDENC_ERR_ALREADY_OPEN;

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1Encoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -52,7 +52,7 @@
 		void loadSettings(vidEncOptions *encodeOptions, FLV1EncoderOptions *options);
 		void saveSettings(vidEncOptions *encodeOptions, FLV1EncoderOptions *options);
 		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 };
 #endif	// __cplusplus
 #endif	// FLV1Encoder_h

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -419,7 +419,7 @@
 	return xmlLength;
 }
 
-int H263Encoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+int H263Encoder::setOptions(vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	if (_opened)
 		return ADM_VIDENC_ERR_ALREADY_OPEN;

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263Encoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -71,7 +71,7 @@
 		void loadSettings(vidEncOptions *encodeOptions, H263EncoderOptions *options);
 		void saveSettings(vidEncOptions *encodeOptions, H263EncoderOptions *options);
 		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 		int open(vidEncVideoProperties *properties);
 		int beginPass(vidEncPassParameters *passParameters);
 		int encodeFrame(vidEncEncodeParameters *encodeParams);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/huffyuvEncoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/huffyuvEncoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/huffyuvEncoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -53,7 +53,7 @@
 	return 0;
 }
 
-int HuffyuvEncoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+int HuffyuvEncoder::setOptions(vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	return 0;
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/huffyuvEncoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/huffyuvEncoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/huffyuvEncoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -34,7 +34,7 @@
 		const char* getFourCC(void);
 		const char* getEncoderGuid(void);
 		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 };
 #endif	// __cplusplus
 #endif	// HuffyuvEncoder_h

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/interface.c	2009-12-31 00:45:42 UTC (rev 5793)
@@ -95,7 +95,7 @@
 	return avcodecEncoder_getOptions(encoderId, encodeOptions, pluginOptions, bufferSize);
 }
 
-int vidEncSetOptions(int encoderId, vidEncOptions *encodeOptions, char *pluginOptions)
+int vidEncSetOptions(int encoderId, vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	return avcodecEncoder_setOptions(encoderId, encodeOptions, pluginOptions);
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -198,7 +198,7 @@
 	return xmlLength;
 }
 
-int MjpegEncoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+int MjpegEncoder::setOptions(vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	if (_opened)
 		return ADM_VIDENC_ERR_ALREADY_OPEN;

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -52,7 +52,7 @@
 		void loadSettings(vidEncOptions *encodeOptions, MjpegEncoderOptions *options);
 		void saveSettings(vidEncOptions *encodeOptions, MjpegEncoderOptions *options);
 		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 		int beginPass(vidEncPassParameters *passParameters);
 		int encodeFrame(vidEncEncodeParameters *encodeParams);
 };

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -398,7 +398,7 @@
 	return xmlLength;
 }
 
-int Mpeg1Encoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+int Mpeg1Encoder::setOptions(vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	if (_opened)
 		return ADM_VIDENC_ERR_ALREADY_OPEN;

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -58,7 +58,7 @@
 		void loadSettings(vidEncOptions *encodeOptions, Mpeg1EncoderOptions *options);
 		void saveSettings(vidEncOptions *encodeOptions, Mpeg1EncoderOptions *options);
 		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 		int beginPass(vidEncPassParameters *passParameters);
 		int encodeFrame(vidEncEncodeParameters *encodeParams);
 		int finishPass(void);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -422,7 +422,7 @@
 	return xmlLength;
 }
 
-int Mpeg2Encoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+int Mpeg2Encoder::setOptions(vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	if (_opened)
 		return ADM_VIDENC_ERR_ALREADY_OPEN;

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -58,7 +58,7 @@
 		void loadSettings(vidEncOptions *encodeOptions, Mpeg2EncoderOptions *options);
 		void saveSettings(vidEncOptions *encodeOptions, Mpeg2EncoderOptions *options);
 		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 		int beginPass(vidEncPassParameters *passParameters);
 		int encodeFrame(vidEncEncodeParameters *encodeParams);
 		int finishPass(void);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -419,7 +419,7 @@
 	return xmlLength;
 }
 
-int Mpeg4aspEncoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+int Mpeg4aspEncoder::setOptions(vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	if (_opened)
 		return ADM_VIDENC_ERR_ALREADY_OPEN;

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -58,7 +58,7 @@
 		void loadSettings(vidEncOptions *encodeOptions, Mpeg4aspEncoderOptions *options);
 		void saveSettings(vidEncOptions *encodeOptions, Mpeg4aspEncoderOptions *options);
 		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 		int beginPass(vidEncPassParameters *passParameters);
 		int encodeFrame(vidEncEncodeParameters *encodeParams);
 		int finishPass(void);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -32,7 +32,7 @@
 	int x264Encoder_isConfigurable(void) { return encoder.isConfigurable(); }
 	int x264Encoder_configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties) { return encoder.configure(configParameters, properties); }
 	int x264Encoder_getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize) { return encoder.getOptions(encodeOptions, pluginOptions, bufferSize); };
-	int x264Encoder_setOptions(vidEncOptions *encodeOptions, char *pluginOptions) { return encoder.setOptions(encodeOptions, pluginOptions); };
+	int x264Encoder_setOptions(vidEncOptions *encodeOptions, const char *pluginOptions) { return encoder.setOptions(encodeOptions, pluginOptions); };
 	int x264Encoder_getPassCount(void) { return encoder.getPassCount(); }
 	int x264Encoder_getCurrentPass(void) { return encoder.getCurrentPass(); }
 	int x264Encoder_open(vidEncVideoProperties *properties) { return encoder.open(properties); }
@@ -152,7 +152,7 @@
 	return xmlLength;
 }
 
-int x264Encoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+int x264Encoder::setOptions(vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	if (_opened)
 		return ADM_VIDENC_ERR_ALREADY_OPEN;

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -73,7 +73,7 @@
 		int isConfigurable(void);
 		int configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
 		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 		int getCurrentPass(void);
 		int getPassCount(void);
 		int open(vidEncVideoProperties *properties);
@@ -87,7 +87,7 @@
 	int x264Encoder_isConfigurable(void);
 	int x264Encoder_configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
 	int x264Encoder_getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-	int x264Encoder_setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+	int x264Encoder_setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 	int x264Encoder_getPassCount(void);
 	int x264Encoder_getCurrentPass(void);
 	int x264Encoder_open(vidEncVideoProperties *properties);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/interface.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/interface.c	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/interface.c	2009-12-31 00:45:42 UTC (rev 5793)
@@ -89,7 +89,7 @@
 	return x264Encoder_getOptions(encodeOptions, pluginOptions, bufferSize);
 }
 
-int vidEncSetOptions(int encoderId, vidEncOptions *encodeOptions, char *pluginOptions)
+int vidEncSetOptions(int encoderId, vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	return x264Encoder_setOptions(encodeOptions, pluginOptions);
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/encoder.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/encoder.cpp	2009-12-31 00:45:42 UTC (rev 5793)
@@ -33,7 +33,7 @@
 	int XvidEncoder_isConfigurable(void) { return encoder.isConfigurable(); }
 	int XvidEncoder_configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties) { return encoder.configure(configParameters, properties); }
 	int XvidEncoder_getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize) { return encoder.getOptions(encodeOptions, pluginOptions, bufferSize); };
-	int XvidEncoder_setOptions(vidEncOptions *encodeOptions, char *pluginOptions) { return encoder.setOptions(encodeOptions, pluginOptions); };
+	int XvidEncoder_setOptions(vidEncOptions *encodeOptions, const char *pluginOptions) { return encoder.setOptions(encodeOptions, pluginOptions); };
 	int XvidEncoder_getPassCount(void) { return encoder.getPassCount(); }
 	int XvidEncoder_getCurrentPass(void) { return encoder.getCurrentPass(); }
 	int XvidEncoder_open(vidEncVideoProperties *properties) { return encoder.open(properties); }
@@ -178,7 +178,7 @@
 	return xmlLength;
 }
 
-int XvidEncoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
+int XvidEncoder::setOptions(vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	if (_opened)
 		return ADM_VIDENC_ERR_ALREADY_OPEN;

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/encoder.h	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/encoder.h	2009-12-31 00:45:42 UTC (rev 5793)
@@ -70,7 +70,7 @@
 		int isConfigurable(void);
 		int configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
 		int getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-		int setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+		int setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 		int getCurrentPass(void);
 		int getPassCount(void);
 		int open(vidEncVideoProperties *properties);
@@ -85,7 +85,7 @@
 	int XvidEncoder_isConfigurable(void);
 	int XvidEncoder_configure(vidEncConfigParameters *configParameters, vidEncVideoProperties *properties);
 	int XvidEncoder_getOptions(vidEncOptions *encodeOptions, char *pluginOptions, int bufferSize);
-	int XvidEncoder_setOptions(vidEncOptions *encodeOptions, char *pluginOptions);
+	int XvidEncoder_setOptions(vidEncOptions *encodeOptions, const char *pluginOptions);
 	int XvidEncoder_getPassCount(void);
 	int XvidEncoder_getCurrentPass(void);
 	int XvidEncoder_open(vidEncVideoProperties *properties);

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/interface.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/interface.c	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/interface.c	2009-12-31 00:45:42 UTC (rev 5793)
@@ -89,7 +89,7 @@
 	return XvidEncoder_getOptions(encodeOptions, pluginOptions, bufferSize);
 }
 
-int vidEncSetOptions(int encoderId, vidEncOptions *encodeOptions, char *pluginOptions)
+int vidEncSetOptions(int encoderId, vidEncOptions *encodeOptions, const char *pluginOptions)
 {
 	return XvidEncoder_setOptions(encodeOptions, pluginOptions);
 }



From mean at mail.berlios.de  Thu Dec 31 07:36:10 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 31 Dec 2009 07:36:10 +0100
Subject: [Avidemux-svn-commit] r5794 - in
	branches/avidemux_2.6_branch_mean/avidemux/common: ADM_editor
	ADM_script2/src
Message-ID: <200912310636.nBV6aAWo022288@sheep.berlios.de>

Author: mean
Date: 2009-12-31 07:36:08 +0100 (Thu, 31 Dec 2009)
New Revision: 5794

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor.cpp
Log:
[Editor] Add editor.printTiming function

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2009-12-31 00:45:42 UTC (rev 5793)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2009-12-31 06:36:08 UTC (rev 5794)
@@ -609,5 +609,24 @@
     }
     return true;
 }
+/**
+     \fn getVideoPtsDts
+*/
+bool                ADM_Composer::getVideoPtsDts(uint32_t frame, uint32_t *flags,uint64_t *pts, uint64_t *dts)
+{
+    if(!_segments.getNbRefVideos()) return true;
+    _VIDEOS *v=_segments.getRefVideo(0);
+   
+    aviInfo info;
+    v->_aviheader->getVideoInfo(&info);
+    int nb=info.nb_frames;
+    if(frame>=nb) 
+    {
+        return false;
+    }
+    v->_aviheader->getFlags(frame,flags);
+    v->_aviheader->getPtsDts(frame,pts,dts);
+    return true;
+}
 //
 //

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx	2009-12-31 00:45:42 UTC (rev 5793)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx	2009-12-31 06:36:08 UTC (rev 5794)
@@ -208,8 +208,10 @@
                     bool                remove(uint64_t start,uint64_t end);
                     bool                addSegment(uint32_t ref, uint64_t startRef, uint64_t duration);
                     bool                clearSegment(void);
+// For js
                     bool                dumpEditing(void);
                     bool                dumpTiming(void);
+                    bool                getVideoPtsDts(uint32_t frame, uint32_t *flags,uint64_t *pts, uint64_t *dts);
 /******************************* /Editing **********************************/										
 /******************************* Misc ************************************/				
                     uint8_t             setEnv(_ENV_EDITOR_FLAGS newflag);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor.cpp	2009-12-31 00:45:42 UTC (rev 5793)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor.cpp	2009-12-31 06:36:08 UTC (rev 5794)
@@ -16,11 +16,23 @@
 #include <stdarg.h>
 #include <vector>
 #include "ADM_jsEditor.h"
+#include "ADM_editor/ADM_edit.hxx"
+extern ADM_Composer *video_body;
+
 /**
     \fn jsPrintTiming
 */
 int jsPrintTiming(int framenumber )
 {
+    uint32_t flags;
+    uint64_t pts,dts;
+    if(true==video_body->getVideoPtsDts(framenumber, &flags,&pts,&dts))
+    {
+        jsLog(JS_LOG_NORMAL,"Frame %"LU" : Flags 0x%"LX" pts=%"LLD" dts=%"LLD"\n",framenumber,flags,pts,dts);
+    }else
+    {
+        jsLog(JS_LOG_NORMAL,"Cannot get info for frame %"LU,framenumber);
+    }
     return 0;
 }
 // EOF



From gruntster at mail.berlios.de  Thu Dec 31 13:32:52 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu, 31 Dec 2009 13:32:52 +0100
Subject: [Avidemux-svn-commit] r5795 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder
Message-ID: <200912311232.nBVCWqFb031060@sheep.berlios.de>

Author: gruntster
Date: 2009-12-31 13:32:45 +0100 (Thu, 31 Dec 2009)
New Revision: 5795

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.cpp
Log:
[vidEnc] sort video encoder list and only include library name if codec type exists multiple times

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.cpp	2009-12-31 06:36:08 UTC (rev 5794)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.cpp	2009-12-31 12:32:45 UTC (rev 5795)
@@ -16,7 +16,7 @@
 
 #include "config.h"
 #include "ADM_default.h"
-#include <vector>
+#include <list>
 
 #include "DIA_fileSel.h"
 #include "ADM_pluginLoad.h"
@@ -60,7 +60,7 @@
 		&close, "vidEncClose"));
 }
 
-std::vector<ADM_vidEnc_plugin *> ADM_videoEncoderPlugins;
+std::list<ADM_vidEnc_plugin *> ADM_videoEncoderPlugins;
 /**
     \fn ADM_ve_getNbEncoders
     \brief get the number of encoder plugin loaded
@@ -83,7 +83,7 @@
 {
 	ADM_assert(filter >= 0 && filter < ADM_videoEncoderPlugins.size());
 
-	ADM_vidEnc_plugin *plugin = ADM_videoEncoderPlugins[filter];
+	ADM_vidEnc_plugin *plugin = getVideoEncoderPlugin(filter);
 	int ma, mi, pa;
 
 	plugin->getEncoderVersion(0, &ma, &mi, &pa);
@@ -96,7 +96,7 @@
 	return true;
 }
 
-static int loadVideoEncoderPlugin(int uiType, const char *file)
+static int loadVideoEncoderPlugin(std::list<ADM_vidEnc_plugin*>* pluginList, int uiType, const char *file)
 {
 	ADM_vidEnc_plugin *plugin = new ADM_vidEnc_plugin(file);
 	int* encoderIds;
@@ -127,7 +127,7 @@
 
 				printf("[ADM_vidEnc_plugin] Plugin loaded version %d.%d.%d, filename %s, desc: %s\n", major, minor, patch, plugin->fileName, plugin->getEncoderDescription(encoderId));
 
-				ADM_videoEncoderPlugins.push_back(plugin);
+				pluginList->push_back(plugin);
 
 				plugin = NULL;
 				success = true;
@@ -160,6 +160,35 @@
         delete [] pluginDir;
 }
 
+static bool comparePlugins(ADM_vidEnc_plugin* plugin1, ADM_vidEnc_plugin* plugin2)
+{
+	int firstLen = strlen(plugin1->getEncoderType(plugin1->encoderId)) + strlen(plugin1->getEncoderName(plugin1->encoderId));
+	int secondLen = strlen(plugin2->getEncoderType(plugin2->encoderId)) + strlen(plugin2->getEncoderName(plugin2->encoderId));
+	char first[firstLen];
+	char second[secondLen];
+	int i = 0;
+
+	strcpy(first, plugin1->getEncoderType(plugin1->encoderId));
+	strcat(first, plugin1->getEncoderName(plugin1->encoderId));
+	strcpy(second, plugin2->getEncoderType(plugin2->encoderId));
+	strcat(second, plugin2->getEncoderName(plugin2->encoderId));
+
+	while ((i < firstLen) && (i < secondLen))
+	{
+		if (tolower(first[i]) < tolower(second[i]))
+			return true;
+		else if (tolower(first[i]) > tolower(second[i]))
+			return false;
+
+		i++;
+	}
+
+	if (firstLen < secondLen)
+		return true;
+	else
+		return false;
+}
+
 /**
  * 	\fn ADM_vidEnc_loadPlugins
  *  \brief load all audio plugins
@@ -187,7 +216,7 @@
 
 	for (int i = 0; i < nbFile; i++)
 	{
-		loadVideoEncoderPlugin(uiType, files[i]);
+		loadVideoEncoderPlugin(&ADM_videoEncoderPlugins, uiType, files[i]);
 		ADM_dealloc(files[i]);
 	}
 
@@ -203,23 +232,56 @@
 		memcpy(&AllVideoCodec[i], internalVideoCodec[i], sizeof(COMPRES_PARAMS));
 
 	// Add external codecs
-	for (int i = 0; i < ADM_videoEncoderPlugins.size(); i++)
+	int counter = 0;
+
+	ADM_videoEncoderPlugins.sort(comparePlugins);
+
+	for (std::list<ADM_vidEnc_plugin*>::iterator it = ADM_videoEncoderPlugins.begin(); it != ADM_videoEncoderPlugins.end(); it++)
 	{
-		ADM_vidEnc_plugin *plugin = ADM_videoEncoderPlugins[i];
+		ADM_vidEnc_plugin *plugin = *it;
 		ADM_assert(plugin);
 
 		const char* codecName = plugin->getEncoderName(plugin->encoderId);
 		const char* codecType = plugin->getEncoderType(plugin->encoderId);
-		char* displayName = new char[strlen(codecName) + strlen(codecType) + 4];
+		char* displayName;
+		const char *prevType, *nextType;
 
-		sprintf(displayName, "%s (%s)", codecType, codecName);
+		if (it == ADM_videoEncoderPlugins.begin())
+			prevType = NULL;
+		else
+		{
+			*it--;
+			prevType = (*it)->getEncoderType((*it)->encoderId);
+			*it++;
+		}
 
-		COMPRES_PARAMS *param = &AllVideoCodec[internalCodecCount + i];
+		*it++;
 
+		if (it == ADM_videoEncoderPlugins.end())
+			nextType = NULL;
+		else
+			nextType = (*it)->getEncoderType((*it)->encoderId);
+
+		*it--;
+
+		if ((prevType != NULL && strcmp(prevType, codecType) == 0) ||
+			(nextType != NULL && strcmp(nextType, codecType) == 0))
+		{
+			displayName = new char[strlen(codecName) + strlen(codecType) + 4];
+			sprintf(displayName, "%s (%s)", codecType, codecName);
+		}
+		else
+		{
+			displayName = new char[strlen(codecType) + 1];
+			sprintf(displayName, "%s", codecType);
+		}
+
+		COMPRES_PARAMS *param = &AllVideoCodec[internalCodecCount + counter];
+
 		param->codec = CodecExternal;
 		param->menuName = displayName;
 		param->tagName = codecName;
-		param->extra_param = i;
+		param->extra_param = counter;
 		param->extraSettings = NULL;
 		param->extraSettingsLen = 0;
 
@@ -231,6 +293,7 @@
 		pluginOptions[length] = 0;
 
 		updateCompressionParameters(param, encodeOptions.encodeMode, encodeOptions.encodeModeParameter, pluginOptions, length);
+		counter++;
 	}
 
 	return 1;
@@ -330,5 +393,10 @@
 {
 	ADM_assert(index < ADM_videoEncoderPlugins.size());
 
-	return ADM_videoEncoderPlugins[index];
+	std::list<ADM_vidEnc_plugin*>::iterator it = ADM_videoEncoderPlugins.begin();
+
+	if (index > 0)
+		advance(it, index);
+
+	return *it;
 }



From gruntster at mail.berlios.de  Thu Dec 31 13:46:18 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu, 31 Dec 2009 13:46:18 +0100
Subject: [Avidemux-svn-commit] r5796 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder
Message-ID: <200912311246.nBVCkIMU021571@sheep.berlios.de>

Author: gruntster
Date: 2009-12-31 13:46:13 +0100 (Thu, 31 Dec 2009)
New Revision: 5796

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.cpp
Log:
[vidEnc] unix compilation fix

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.cpp	2009-12-31 12:32:45 UTC (rev 5795)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.cpp	2009-12-31 12:46:13 UTC (rev 5796)
@@ -17,6 +17,7 @@
 #include "config.h"
 #include "ADM_default.h"
 #include <list>
+#include <locale>
 
 #include "DIA_fileSel.h"
 #include "ADM_pluginLoad.h"



From gruntster at mail.berlios.de  Thu Dec 31 15:08:03 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu, 31 Dec 2009 15:08:03 +0100
Subject: [Avidemux-svn-commit] r5797 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder:
	. ADM_vidEnc_avcodec ADM_vidEnc_x264 ADM_vidEnc_xvid common
	common/pluginOptions
Message-ID: <200912311408.nBVE83tN028751@sheep.berlios.de>

Author: gruntster
Date: 2009-12-31 15:07:50 +0100 (Thu, 31 Dec 2009)
New Revision: 5797

Added:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginOptions.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.h
Removed:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginXmlOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginXmlOptions.h
Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/CMakeLists.txt
Log:
[vidEnc] make plugin options helper a static library

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-31 14:07:50 UTC (rev 5797)
@@ -9,12 +9,11 @@
 endif (WIN32)
 
 SET(ADM_vidEnc_avcodec_SRCS  interface.c  encoder.cpp  huffyuvEncoder.cpp
-							 ffvhuffEncoder.cpp  ffv1Encoder.cpp  dvEncoder.cpp  ../common/PluginOptions.cpp
+							 ffvhuffEncoder.cpp  ffv1Encoder.cpp  dvEncoder.cpp
 							 mpeg1Encoder.cpp  mpeg1EncoderOptions.cpp  mpeg2Encoder.cpp  mpeg2EncoderOptions.cpp
 							 flv1Encoder.cpp  flv1EncoderOptions.cpp  mjpegEncoder.cpp  mjpegEncoderOptions.cpp
 							 h263Encoder.cpp  h263EncoderOptions.cpp  mpeg4aspEncoder.cpp  mpeg4aspEncoderOptions.cpp)
 
-set(PLUGIN_SCHEMA_DIR "avcodec")
 set(MPEG1_PLUGIN_CONFIG_DIR "avcodec/mpeg-1")
 set(MPEG2_PLUGIN_CONFIG_DIR "avcodec/mpeg-2")
 set(FLV1_PLUGIN_CONFIG_DIR "avcodec/flv1")
@@ -22,8 +21,8 @@
 set(H263_PLUGIN_CONFIG_DIR "avcodec/h263")
 set(MPEG4ASP_PLUGIN_CONFIG_DIR "avcodec/mpeg4asp")
 
-INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${LIBXML2_INCLUDE_DIR})
-ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_SCHEMA_DIR="${PLUGIN_SCHEMA_DIR}")
+INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${LIBXML2_INCLUDE_DIR} ../common/pluginOptions)
+ADD_DEFINITIONS(${LIBXML2_DEFINITIONS})
 set_property(SOURCE mpeg1EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMPEG1_PLUGIN_CONFIG_DIR=\\\"${MPEG1_PLUGIN_CONFIG_DIR}\\\")
 set_property(SOURCE mpeg2EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMPEG2_PLUGIN_CONFIG_DIR=\\\"${MPEG2_PLUGIN_CONFIG_DIR}\\\")
 set_property(SOURCE flv1EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DFLV1_PLUGIN_CONFIG_DIR=\\\"${FLV1_PLUGIN_CONFIG_DIR}\\\")
@@ -40,7 +39,7 @@
 add_subdirectory(xml)
 
 ADD_LIBRARY(ADM_vidEnc_avcodec SHARED ${ADM_vidEnc_avcodec_SRCS})
-TARGET_LINK_LIBRARIES(ADM_vidEnc_avcodec ${LIBXML2_LIBRARIES} ADM_xvidRateCtl ADM_core ADM_coreUI ADM_libavcodec)
+TARGET_LINK_LIBRARIES(ADM_vidEnc_avcodec ${LIBXML2_LIBRARIES} ADM_xvidRateCtl ADM_core ADM_coreUI ADM_libavcodec ADM_vidEnc_pluginOptions)
 
 INIT_VIDEO_ENCODER_PLUGIN(ADM_vidEnc_avcodec)
 INSTALL_VIDEO_ENCODER(ADM_vidEnc_avcodec)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.cpp	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.cpp	2009-12-31 14:07:50 UTC (rev 5797)
@@ -29,7 +29,7 @@
 
 #include "flv1EncoderOptions.h"
 
-FLV1EncoderOptions::FLV1EncoderOptions(void) : PluginOptions(FLV1_PLUGIN_CONFIG_DIR, "Flv1", "Flv1Param.xsd", FLV1_DEFAULT_ENCODE_MODE, FLV1_DEFAULT_ENCODE_MODE_PARAMETER)
+FLV1EncoderOptions::FLV1EncoderOptions(void) : PluginOptions(FLV1_PLUGIN_CONFIG_DIR, "Flv1", "avcodec/Flv1Param.xsd", FLV1_DEFAULT_ENCODE_MODE, FLV1_DEFAULT_ENCODE_MODE_PARAMETER)
 {
 	reset();
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.h	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/flv1EncoderOptions.h	2009-12-31 14:07:50 UTC (rev 5797)
@@ -18,7 +18,7 @@
 #define FLV1EncoderOptions_h
 
 #include <vector>
-#include "../common/PluginOptions.h"
+#include "PluginOptions.h"
 
 extern "C"
 {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.cpp	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.cpp	2009-12-31 14:07:50 UTC (rev 5797)
@@ -31,7 +31,7 @@
 
 #include "h263EncoderOptions.h"
 
-H263EncoderOptions::H263EncoderOptions(void) : PluginOptions(H263_PLUGIN_CONFIG_DIR, "H263", "H263Param.xsd", H263_DEFAULT_ENCODE_MODE, H263_DEFAULT_ENCODE_MODE_PARAMETER)
+H263EncoderOptions::H263EncoderOptions(void) : PluginOptions(H263_PLUGIN_CONFIG_DIR, "H263", "avcodec/H263Param.xsd", H263_DEFAULT_ENCODE_MODE, H263_DEFAULT_ENCODE_MODE_PARAMETER)
 {
 	reset();
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.h	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/h263EncoderOptions.h	2009-12-31 14:07:50 UTC (rev 5797)
@@ -18,7 +18,7 @@
 #define h263EncoderOptions_h
 
 #include <vector>
-#include "../common/PluginOptions.h"
+#include "PluginOptions.h"
 
 extern "C"
 {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.cpp	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.cpp	2009-12-31 14:07:50 UTC (rev 5797)
@@ -29,11 +29,11 @@
 
 #include "mjpegEncoderOptions.h"
 
-MjpegEncoderOptions::MjpegEncoderOptions(void) : PluginOptions(MJPEG_PLUGIN_CONFIG_DIR, "Mjpeg", "MjpegParam.xsd", MJPEG_DEFAULT_ENCODE_MODE, MJPEG_DEFAULT_ENCODE_MODE_PARAMETER) { }
+MjpegEncoderOptions::MjpegEncoderOptions(void) : PluginOptions(MJPEG_PLUGIN_CONFIG_DIR, "Mjpeg", "avcodec/MjpegParam.xsd", MJPEG_DEFAULT_ENCODE_MODE, MJPEG_DEFAULT_ENCODE_MODE_PARAMETER) { }
 
 void MjpegEncoderOptions::addOptionsToXml(xmlNodePtr xmlNodeRoot)
 { 
 	xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)getOptionsTagRoot(), NULL);
 }
 
-void MjpegEncoderOptions::parseOptions(xmlNode *node) { }
\ No newline at end of file
+void MjpegEncoderOptions::parseOptions(xmlNode *node) { }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.h	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mjpegEncoderOptions.h	2009-12-31 14:07:50 UTC (rev 5797)
@@ -18,7 +18,7 @@
 #define MjpegEncoderOptions_h
 
 #include <vector>
-#include "../common/PluginOptions.h"
+#include "PluginOptions.h"
 
 extern "C"
 {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.cpp	2009-12-31 14:07:50 UTC (rev 5797)
@@ -31,7 +31,7 @@
 
 #include "mpeg1EncoderOptions.h"
 
-Mpeg1EncoderOptions::Mpeg1EncoderOptions(void) : PluginOptions(MPEG1_PLUGIN_CONFIG_DIR, "Mpeg1", "Mpeg1Param.xsd", MPEG1_DEFAULT_ENCODE_MODE, MPEG1_DEFAULT_ENCODE_MODE_PARAMETER)
+Mpeg1EncoderOptions::Mpeg1EncoderOptions(void) : PluginOptions(MPEG1_PLUGIN_CONFIG_DIR, "Mpeg1", "avcodec/Mpeg1Param.xsd", MPEG1_DEFAULT_ENCODE_MODE, MPEG1_DEFAULT_ENCODE_MODE_PARAMETER)
 {
 	reset();
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.h	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1EncoderOptions.h	2009-12-31 14:07:50 UTC (rev 5797)
@@ -18,7 +18,7 @@
 #define mpeg1EncoderOptions_h
 
 #include <vector>
-#include "../common/PluginOptions.h"
+#include "PluginOptions.h"
 
 extern "C"
 {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.cpp	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.cpp	2009-12-31 14:07:50 UTC (rev 5797)
@@ -31,7 +31,7 @@
 
 #include "mpeg2EncoderOptions.h"
 
-Mpeg2EncoderOptions::Mpeg2EncoderOptions(void) : PluginOptions(MPEG2_PLUGIN_CONFIG_DIR, "Mpeg2", "Mpeg2Param.xsd", MPEG2_DEFAULT_ENCODE_MODE, MPEG2_DEFAULT_ENCODE_MODE_PARAMETER)
+Mpeg2EncoderOptions::Mpeg2EncoderOptions(void) : PluginOptions(MPEG2_PLUGIN_CONFIG_DIR, "Mpeg2", "avcodec/Mpeg2Param.xsd", MPEG2_DEFAULT_ENCODE_MODE, MPEG2_DEFAULT_ENCODE_MODE_PARAMETER)
 {
 	reset();
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.h	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2EncoderOptions.h	2009-12-31 14:07:50 UTC (rev 5797)
@@ -18,7 +18,7 @@
 #define mpeg2EncoderOptions_h
 
 #include <vector>
-#include "../common/PluginOptions.h"
+#include "PluginOptions.h"
 
 extern "C"
 {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.cpp	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.cpp	2009-12-31 14:07:50 UTC (rev 5797)
@@ -31,7 +31,7 @@
 
 #include "mpeg4aspEncoderOptions.h"
 
-Mpeg4aspEncoderOptions::Mpeg4aspEncoderOptions(void) : PluginOptions(MPEG4ASP_PLUGIN_CONFIG_DIR, "Mpeg4asp", "Mpeg4aspParam.xsd", MPEG4ASP_DEFAULT_ENCODE_MODE, MPEG4ASP_DEFAULT_ENCODE_MODE_PARAMETER)
+Mpeg4aspEncoderOptions::Mpeg4aspEncoderOptions(void) : PluginOptions(MPEG4ASP_PLUGIN_CONFIG_DIR, "Mpeg4asp", "avcodec/Mpeg4aspParam.xsd", MPEG4ASP_DEFAULT_ENCODE_MODE, MPEG4ASP_DEFAULT_ENCODE_MODE_PARAMETER)
 {
 	reset();
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.h	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg4aspEncoderOptions.h	2009-12-31 14:07:50 UTC (rev 5797)
@@ -18,7 +18,7 @@
 #define mpeg4aspEncoderOptions_h
 
 #include <vector>
-#include "../common/PluginOptions.h"
+#include "PluginOptions.h"
 
 extern "C"
 {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt	2009-12-31 14:07:50 UTC (rev 5797)
@@ -11,13 +11,12 @@
 		SET(QT_PLUGIN_NAME "ADM_vidEnc_x264_Qt")
 		SET(GTK_PLUGIN_NAME "ADM_vidEnc_x264_Gtk")
 		
-		SET(PLUGIN_SCHEMA_DIR "x264")
 		SET(PLUGIN_CONFIG_DIR "x264")
 		
-		INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${X264_INCLUDE_DIR} ${LIBXML2_INCLUDE_DIR} ../common)
-		ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_SCHEMA_DIR="${PLUGIN_SCHEMA_DIR}" -DPLUGIN_CONFIG_DIR="${PLUGIN_CONFIG_DIR}")
+		INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${X264_INCLUDE_DIR} ${LIBXML2_INCLUDE_DIR} ../common/pluginOptions)
+		ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_CONFIG_DIR="${PLUGIN_CONFIG_DIR}")
 		
-		SET(ADM_vidEnc_x264_SRCS interface.c configGuiLoader.cpp encoder.cpp guiHelper.cpp zoneOptions.cpp x264Options.cpp ../common/PluginOptions.cpp)
+		SET(ADM_vidEnc_x264_SRCS interface.c configGuiLoader.cpp encoder.cpp guiHelper.cpp zoneOptions.cpp x264Options.cpp)
 
 		CONFIGURE_FILE("${CMAKE_CURRENT_SOURCE_DIR}/config.h.cmake" "${CMAKE_CURRENT_BINARY_DIR}/config.h")
 
@@ -25,7 +24,7 @@
 		ADD_SUBDIRECTORY(qt4)
 		ADD_SUBDIRECTORY(xml)
 		ADD_LIBRARY(ADM_vidEnc_x264 SHARED ${ADM_vidEnc_x264_SRCS})
-		TARGET_LINK_LIBRARIES(ADM_vidEnc_x264 ADM_core ${X264_LIBRARY_DIR} ${LIBXML2_LIBRARIES})
+		TARGET_LINK_LIBRARIES(ADM_vidEnc_x264 ADM_core ${X264_LIBRARY_DIR} ${LIBXML2_LIBRARIES} ADM_vidEnc_pluginOptions)
 
 		INIT_VIDEO_ENCODER_PLUGIN(ADM_vidEnc_x264)
 		INSTALL_VIDEO_ENCODER(ADM_vidEnc_x264)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2009-12-31 14:07:50 UTC (rev 5797)
@@ -32,7 +32,7 @@
 
 #include "x264Options.h"
 
-x264Options::x264Options(void) : PluginOptions(PLUGIN_CONFIG_DIR, "x264", "x264Param.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
+x264Options::x264Options(void) : PluginOptions(PLUGIN_CONFIG_DIR, "x264", "x264/x264Param.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
 {
 	memset(&_param, 0, sizeof(x264_param_t));
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt	2009-12-31 14:07:50 UTC (rev 5797)
@@ -10,20 +10,19 @@
 		SET(QT_PLUGIN_NAME "ADM_vidEnc_Xvid_Qt")
 		SET(GTK_PLUGIN_NAME "ADM_vidEnc_Xvid_Gtk")
 		
-		SET(PLUGIN_SCHEMA_DIR "xvid")
 		SET(PLUGIN_CONFIG_DIR "xvid")
 
-		INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${XVID_INCLUDE_DIR} ${LIBXML2_INCLUDE_DIR} ../common)
-		ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_SCHEMA_DIR="${PLUGIN_SCHEMA_DIR}" -DPLUGIN_CONFIG_DIR="${PLUGIN_CONFIG_DIR}")
+		INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${XVID_INCLUDE_DIR} ${LIBXML2_INCLUDE_DIR} ../common/pluginOptions)
+		ADD_DEFINITIONS(${LIBXML2_DEFINITIONS} -DPLUGIN_CONFIG_DIR="${PLUGIN_CONFIG_DIR}")
 
-		SET(ADM_vidEnc_xvid_SRCS interface.c  encoder.cpp  xvidOptions.cpp  configGuiLoader.cpp  ../common/PluginOptions.cpp)
+		SET(ADM_vidEnc_xvid_SRCS interface.c  encoder.cpp  xvidOptions.cpp  configGuiLoader.cpp)
 
 		CONFIGURE_FILE("${CMAKE_CURRENT_SOURCE_DIR}/config.h.cmake" "${CMAKE_CURRENT_BINARY_DIR}/config.h")
 
 		ADD_SUBDIRECTORY(gtk)
 		ADD_SUBDIRECTORY(qt4)
 		ADD_LIBRARY(ADM_vidEnc_xvid SHARED ${ADM_vidEnc_xvid_SRCS})
-		TARGET_LINK_LIBRARIES(ADM_vidEnc_xvid ADM_core ${XVID_LIBRARY_DIR} ${LIBXML2_LIBRARIES})
+		TARGET_LINK_LIBRARIES(ADM_vidEnc_xvid ADM_core ${XVID_LIBRARY_DIR} ${LIBXML2_LIBRARIES} ADM_vidEnc_pluginOptions)
 
 		INIT_VIDEO_ENCODER_PLUGIN(ADM_vidEnc_xvid)
 		INSTALL_VIDEO_ENCODER(ADM_vidEnc_xvid)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/xvidOptions.cpp	2009-12-31 14:07:50 UTC (rev 5797)
@@ -30,7 +30,7 @@
 
 #include "xvidOptions.h"
 
-XvidOptions::XvidOptions(void) : PluginOptions(PLUGIN_CONFIG_DIR, "Xvid", "XvidParam.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
+XvidOptions::XvidOptions(void) : PluginOptions(PLUGIN_CONFIG_DIR, "Xvid", "xvid/XvidParam.xsd", DEFAULT_ENCODE_MODE, DEFAULT_ENCODE_MODE_PARAMETER)
 {
 	reset();
 }

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/CMakeLists.txt	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/CMakeLists.txt	2009-12-31 14:07:50 UTC (rev 5797)
@@ -1,3 +1,4 @@
+add_subdirectory(common)
 ADD_SUBDIRECTORY(ADM_vidEnc_avcodec)
 ADD_SUBDIRECTORY(ADM_vidEnc_x264)
 ADD_SUBDIRECTORY(ADM_vidEnc_xvid)
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/CMakeLists.txt	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/CMakeLists.txt	2009-12-31 14:07:50 UTC (rev 5797)
@@ -0,0 +1 @@
+add_subdirectory(pluginOptions)

Deleted: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.cpp	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.cpp	2009-12-31 14:07:50 UTC (rev 5797)
@@ -1,405 +0,0 @@
- /***************************************************************************
-                              PluginOptions.cpp
-
-    begin                : Mon Apr 21 2008
-    copyright            : (C) 2008 by gruntster
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include <sstream>
-#include <string>
-
-#include "ADM_inttype.h"
-#include "ADM_files.h"
-#include "PluginXmlOptions.cpp"
-#include "PluginOptions.h"
-
-#undef malloc
-#undef free
-#undef strdup
-PluginOptions::PluginOptions(const char* configurationDirectory, const char* tagPrefix, const char* schemaFile, 
-							 unsigned int defaultEncodeMode, int defaultEncodeModeParameter)
-{
-	_configurationDirectory = new char[strlen(configurationDirectory) + 1];
-	strcpy(_configurationDirectory, configurationDirectory);
-
-	_tagPrefix = new char[strlen(tagPrefix) + 1];
-	strcpy(_tagPrefix, tagPrefix);
-
-	_schemaFile = new char[strlen(schemaFile) + 1];
-	strcpy(_schemaFile, schemaFile);
-
-	_configTagRoot = new char[strlen(tagPrefix) + 7];
-	strcpy(_configTagRoot, tagPrefix);
-	strcat(_configTagRoot, "Config");
-
-	_optionsTagRoot = new char[strlen(tagPrefix) + 8];
-	strcpy(_optionsTagRoot, tagPrefix);
-	strcat(_optionsTagRoot, "Options");
-
-	_configurationName = NULL;
-	_defaultEncodeMode = defaultEncodeMode;
-	_defaultEncodeModeParameter = defaultEncodeModeParameter;
-	setEncodeOptionsToDefaults();
-
-	reset();
-}
-
-PluginOptions::~PluginOptions(void)
-{
-	cleanUp();
-
-	if (_configurationDirectory)
-	{
-		delete [] _configurationDirectory;
-		_configurationDirectory = NULL;
-	}
-
-	if (_tagPrefix)
-	{
-		delete [] _tagPrefix;
-		_tagPrefix = NULL;
-	}
-
-	if (_schemaFile)
-	{
-		delete [] _schemaFile;
-		_schemaFile = NULL;
-	}
-
-	if (_configTagRoot)
-	{
-		delete [] _configTagRoot;
-		_configTagRoot = NULL;
-	}
-
-	if (_optionsTagRoot)
-	{
-		delete [] _optionsTagRoot;
-		_optionsTagRoot = NULL;
-	}
-}
-
-void PluginOptions::cleanUp(void)
-{
-	if (_configurationName)
-	{
-		free(_configurationName);
-		_configurationName = NULL;
-	}
-}
-
-void PluginOptions::reset(void)
-{
-	cleanUp();
-
-	setPresetConfiguration("<default>", PLUGIN_CONFIG_DEFAULT);
-}
-
-const char* PluginOptions::getSchemaFile()
-{
-	return _schemaFile;
-}
-
-const char* PluginOptions::getConfigTagRoot()
-{
-	return _configTagRoot;
-}
-
-const char* PluginOptions::getOptionsTagRoot()
-{
-	return _optionsTagRoot;
-}
-
-void PluginOptions::getPresetConfiguration(char** configurationName, PluginConfigType *configurationType)
-{
-	if (_configurationName)
-	{
-		*configurationName = new char[strlen(_configurationName) + 1];
-		strcpy(*configurationName, _configurationName);
-	}
-	else
-		*configurationName = NULL;
-
-	*configurationType = _configurationType;
-}
-
-void PluginOptions::setPresetConfiguration(const char* configurationName, PluginConfigType configurationType)
-{
-	clearPresetConfiguration();
-
-	_configurationName = strdup(configurationName);
-	_configurationType = configurationType;
-}
-
-void PluginOptions::clearPresetConfiguration(void)
-{
-	if (_configurationName)
-		free(_configurationName);
-
-	_configurationName = strdup("<custom>");
-	_configurationType = PLUGIN_CONFIG_CUSTOM;
-}
-
-bool PluginOptions::loadPresetConfiguration(void)
-{
-	char *dir = NULL;
-	bool success = false;
-	PluginConfigType configurationType = _configurationType;
-	char configurationName[strlen(_configurationName) + 1];
-
-	strcpy(configurationName, _configurationName);
-
-	if (configurationType == PLUGIN_CONFIG_USER)
-		dir = getUserConfigDirectory();
-	else if (configurationType == PLUGIN_CONFIG_SYSTEM)
-		dir = getSystemConfigDirectory();
-
-	if (dir)
-	{
-		char presetConfigFile[strlen(dir) + strlen(configurationName) + 6];
-
-		strcpy(presetConfigFile, dir);
-		strcat(presetConfigFile, "/");
-		strcat(presetConfigFile, configurationName);
-		strcat(presetConfigFile, ".xml");
-
-		delete [] dir;
-		FILE *file = fopen(presetConfigFile, "r");
-
-		if (file)
-		{
-			fseek(file, 0, SEEK_END);
-
-			long size = ftell(file);
-			char presetXml[size];
-
-			fseek(file, 0, SEEK_SET);
-			size = fread(presetXml, 1, size, file);
-			presetXml[size] = 0;
-			fclose(file);
-
-			success = fromXml(presetXml, PLUGIN_XML_EXTERNAL);
-			setPresetConfiguration(configurationName, configurationType);
-		}
-		else
-			printf("Error - Unable to open or read %s\n", presetConfigFile);
-	}
-
-	return success;
-}
-
-void PluginOptions::setEncodeOptionsToDefaults(void)
-{
-	_encodeOptions.encodeMode = _defaultEncodeMode;
-	_encodeOptions.encodeModeParameter = _defaultEncodeModeParameter;
-}
-
-vidEncOptions* PluginOptions::getEncodeOptions(void)
-{
-	vidEncOptions *encodeOptions = new vidEncOptions;
-
-	memcpy(encodeOptions, &_encodeOptions, sizeof(vidEncOptions));
-
-	return encodeOptions;
-}
-
-void PluginOptions::setEncodeOptions(vidEncOptions* encodeOptions)
-{
-	memcpy(&_encodeOptions, encodeOptions, sizeof(vidEncOptions));
-}
-
-char* PluginOptions::toXml(PluginXmlType xmlType)
-{
-	xmlDocPtr xmlDoc = xmlNewDoc((const xmlChar*)"1.0");
-	xmlNodePtr xmlNodeRoot, xmlNodeChild;
-	const int bufferSize = 100;
-	xmlChar xmlBuffer[bufferSize + 1];
-	char *xml = NULL;
-
-	while (true)
-	{
-		if (!xmlDoc)
-			break;
-
-		if (!(xmlNodeRoot = xmlNewDocNode(xmlDoc, NULL, (xmlChar*)getConfigTagRoot(), NULL)))
-			break;
-
-		xmlDocSetRootElement(xmlDoc, xmlNodeRoot);
-
-		if (xmlType == PLUGIN_XML_INTERNAL)
-		{
-			if (_configurationType != PLUGIN_CONFIG_CUSTOM)
-			{
-				xmlNodeChild = xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"presetConfiguration", NULL);
-
-				xmlNewChild(xmlNodeChild, NULL, (xmlChar*)"name", (xmlChar*)_configurationName);
-
-				if (_configurationType == PLUGIN_CONFIG_USER)
-					strcpy((char*)xmlBuffer, "user");
-				else if (_configurationType == PLUGIN_CONFIG_SYSTEM)
-					strcpy((char*)xmlBuffer, "system");
-				else
-					strcpy((char*)xmlBuffer, "default");
-
-				xmlNewChild(xmlNodeChild, NULL, (xmlChar*)"type", xmlBuffer);
-			}
-		}
-		else
-		{
-			xmlNodeChild = xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)"encodeOptions", NULL);
-
-			switch (_encodeOptions.encodeMode)
-			{
-			case ADM_VIDENC_MODE_CBR:
-				strcpy((char*)xmlBuffer, "CBR");
-				break;
-			case ADM_VIDENC_MODE_CQP:
-				strcpy((char*)xmlBuffer, "CQP");
-				break;
-			case ADM_VIDENC_MODE_AQP:
-				strcpy((char*)xmlBuffer, "AQP");
-				break;
-			case ADM_VIDENC_MODE_2PASS_SIZE:
-				strcpy((char*)xmlBuffer, "2PASS SIZE");
-				break;
-			case ADM_VIDENC_MODE_2PASS_ABR:
-				strcpy((char*)xmlBuffer, "2PASS ABR");
-				break;
-			}
-
-			xmlNewChild(xmlNodeChild, NULL, (xmlChar*)"mode", xmlBuffer);
-			xmlNewChild(xmlNodeChild, NULL, (xmlChar*)"parameter", number2String(xmlBuffer, bufferSize, _encodeOptions.encodeModeParameter));
-		}
-
-		addOptionsToXml(xmlNodeRoot);
-		xml = dumpXmlDocToMemory(xmlDoc);
-		xmlFreeDoc(xmlDoc);
-
-		break;
-	}
-
-	return xml;
-}
-
-int PluginOptions::fromXml(const char *xml, PluginXmlType xmlType)
-{
-	clearPresetConfiguration();
-
-	bool success = false;
-
-	xmlDocPtr doc = xmlReadMemory(xml, strlen(xml), "options.xml", NULL, 0);
-
-	if (success = validateXml(doc, getSchemaFile()))
-	{
-		xmlNode *xmlNodeRoot = xmlDocGetRootElement(doc);
-
-		for (xmlNode *xmlChild = xmlNodeRoot->children; xmlChild; xmlChild = xmlChild->next)
-		{
-			if (xmlChild->type == XML_ELEMENT_NODE)
-			{
-				char *content = (char*)xmlNodeGetContent(xmlChild);
-
-				if (xmlType == PLUGIN_XML_EXTERNAL && strcmp((char*)xmlChild->name, "encodeOptions") == 0)
-					parseEncodeOptions(xmlChild, &_encodeOptions);
-				else if (xmlType == PLUGIN_XML_INTERNAL && strcmp((char*)xmlChild->name, "presetConfiguration") == 0)
-					parsePresetConfiguration(xmlChild);
-				else if (strcmp((char*)xmlChild->name, getOptionsTagRoot()) == 0)
-					parseOptions(xmlChild);
-
-				xmlFree(content);
-			}
-		}
-	}
-
-	xmlFreeDoc(doc);
-
-	return success;
-}
-
-void PluginOptions::parseEncodeOptions(xmlNode *node, vidEncOptions *encodeOptions)
-{
-	for (xmlNode *xmlChild = node->children; xmlChild; xmlChild = xmlChild->next)
-	{
-		if (xmlChild->type == XML_ELEMENT_NODE)
-		{
-			char *content = (char*)xmlNodeGetContent(xmlChild);
-
-			if (strcmp((char*)xmlChild->name, "mode") == 0)
-			{
-				if (strcmp(content, "CBR") == 0)
-					encodeOptions->encodeMode = ADM_VIDENC_MODE_CBR;
-				else if (strcmp(content, "CQP") == 0)
-					encodeOptions->encodeMode = ADM_VIDENC_MODE_CQP;
-				else if (strcmp(content, "AQP") == 0)
-					encodeOptions->encodeMode = ADM_VIDENC_MODE_AQP;
-				else if (strcmp(content, "2PASS SIZE") == 0)
-					encodeOptions->encodeMode = ADM_VIDENC_MODE_2PASS_SIZE;
-				else if (strcmp(content, "2PASS ABR") == 0)
-					encodeOptions->encodeMode = ADM_VIDENC_MODE_2PASS_ABR;
-			}
-			else if (strcmp((char*)xmlChild->name, "parameter") == 0)
-				encodeOptions->encodeModeParameter = atoi(content);
-
-			xmlFree(content);
-		}
-	}
-}
-
-void PluginOptions::parsePresetConfiguration(xmlNode *node)
-{
-	char* name = NULL;
-	PluginConfigType type = PLUGIN_CONFIG_CUSTOM;
-
-	for (xmlNode *xmlChild = node->children; xmlChild; xmlChild = xmlChild->next)
-	{
-		if (xmlChild->type == XML_ELEMENT_NODE)
-		{
-			char *content = (char*)xmlNodeGetContent(xmlChild);
-
-			if (strcmp((char*)xmlChild->name, "name") == 0)
-				name = strdup((char*)content);
-			else if (strcmp((char*)xmlChild->name, "type") == 0)
-			{
-				if (strcmp(content, "user") == 0)
-					type = PLUGIN_CONFIG_USER;
-				else if (strcmp(content, "system") == 0)
-					type = PLUGIN_CONFIG_SYSTEM;
-				else
-					type = PLUGIN_CONFIG_DEFAULT;
-			}
-
-			xmlFree(content);
-		}
-	}
-
-	setPresetConfiguration(name, type);
-	free(name);
-}
-
-char* PluginOptions::getUserConfigDirectory(void)
-{
-	return ADM_getHomeRelativePath(_configurationDirectory);
-}
-
-char* PluginOptions::getSystemConfigDirectory(void)
-{
-	char* pluginPath = ADM_getPluginPath();
-	char* systemConfigPath = new char[strlen(pluginPath) + strlen(_configurationDirectory) + 2];
-
-	strcpy(systemConfigPath, pluginPath);
-	strcat(systemConfigPath, "/");
-	strcat(systemConfigPath, _configurationDirectory);
-
-	delete [] pluginPath;
-
-	return systemConfigPath;
-}

Deleted: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.h	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.h	2009-12-31 14:07:50 UTC (rev 5797)
@@ -1,80 +0,0 @@
-/***************************************************************************
-                              PluginOptions.h
-
-    begin                : Mon Apr 21 2008
-    copyright            : (C) 2008 by gruntster
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef PluginOptions_h
-#define PluginOptions_h
-
-
-extern "C"
-{
-#include "ADM_vidEnc_plugin.h"
-}
-
-#include "PluginXmlOptions.h"
-
-typedef enum
-{
-	PLUGIN_CONFIG_CUSTOM,
-	PLUGIN_CONFIG_DEFAULT,
-	PLUGIN_CONFIG_USER,
-	PLUGIN_CONFIG_SYSTEM
-} PluginConfigType;
-
-class PluginOptions : public PluginXmlOptions
-{
-protected:
-	vidEncOptions _encodeOptions;
-	unsigned int _defaultEncodeMode;
-	int _defaultEncodeModeParameter;
-
-	char *_tagPrefix, *_configTagRoot, *_optionsTagRoot;
-	char *_configurationDirectory, *_schemaFile;
-	char *_configurationName;
-	PluginConfigType _configurationType;
-
-	virtual void cleanUp(void);
-	virtual void setEncodeOptionsToDefaults(void);
-	virtual void parseEncodeOptions(xmlNode *node, vidEncOptions *encodeOptions);
-	virtual void parsePresetConfiguration(xmlNode *node);
-
-public:
-	PluginOptions(const char* configurationDirectory, const char* tagPrefix, const char* schemaFile, unsigned int defaultEncodeMode, int defaultEncodeModeParameter);
-	~PluginOptions(void);
-
-	virtual vidEncOptions* getEncodeOptions(void);
-	virtual void setEncodeOptions(vidEncOptions* encodeOptions);
-
-	virtual void reset(void);
-	virtual const char* getSchemaFile();
-	virtual const char* getConfigTagRoot();
-	virtual const char* getOptionsTagRoot();
-
-	virtual void getPresetConfiguration(char** configurationName, PluginConfigType *configurationType);
-	virtual void setPresetConfiguration(const char* configurationName, PluginConfigType configurationType);
-	virtual void clearPresetConfiguration(void);
-	virtual bool loadPresetConfiguration(void);
-
-	virtual void addOptionsToXml(xmlNodePtr xmlNodeRoot) = 0;
-	virtual void parseOptions(xmlNode *node) = 0;
-
-	virtual char* toXml(PluginXmlType xmlType);
-	virtual int fromXml(const char *xml, PluginXmlType xmlType);
-
-	virtual char* getUserConfigDirectory(void);
-	virtual char* getSystemConfigDirectory(void);
-};
-
-#endif	// options_h

Deleted: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginXmlOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginXmlOptions.cpp	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginXmlOptions.cpp	2009-12-31 14:07:50 UTC (rev 5797)
@@ -1,150 +0,0 @@
-/***************************************************************************
-                            PluginXmlOptions.cpp
-
-    begin                : Mon Apr 21 2008
-    copyright            : (C) 2008 by gruntster
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include <sstream>
-#include <libxml/parser.h>
-#include <libxml/xmlschemas.h>
-
-#include "PluginXmlOptions.h"
-#include "ADM_files.h"
-
-xmlChar* PluginXmlOptions::number2String(xmlChar *buffer, size_t size, int number)
-{
-	std::ostringstream stream;
-
-	stream.imbue(std::locale::classic());
-	stream << number;
-	std::string string = stream.str();
-
-	strncpy((char*)buffer, string.c_str(), size);
-
-	return buffer;
-}
-
-xmlChar* PluginXmlOptions::number2String(xmlChar *buffer, size_t size, unsigned int number)
-{
-	std::ostringstream stream;
-
-	stream.imbue(std::locale::classic());
-	stream << number;
-	std::string string = stream.str();
-
-	strncpy((char*)buffer, string.c_str(), size);
-
-	return buffer;
-}
-
-xmlChar* PluginXmlOptions::number2String(xmlChar *buffer, size_t size, float number)
-{
-	std::ostringstream stream;
-
-	stream.imbue(std::locale::classic());
-	stream << number;
-	std::string string = stream.str();
-
-	strncpy((char*)buffer, string.c_str(), size);
-
-	return buffer;
-}
-
-xmlChar* PluginXmlOptions::boolean2String(xmlChar *buffer, size_t size, bool boolean)
-{
-	if (boolean)
-		strncpy((char*)buffer, "true", size);
-	else
-		strncpy((char*)buffer, "false", size);
-
-	return buffer;
-}
-
-bool PluginXmlOptions::string2Boolean(const char *buffer)
-{
-	return (strcmp(buffer, "true") == 0);
-}
-
-float PluginXmlOptions::string2Float(const char *buffer)
-{
-	std::istringstream stream(buffer);
-	float value;
-
-	stream >> value;
-
-	return value;
-}
-
-char* PluginXmlOptions::dumpXmlDocToMemory(xmlDocPtr xmlDoc)
-{
-	xmlChar *tempBuffer;
-	int tempBufferSize;
-	char *xml = NULL;
-
-	xmlDocDumpMemory(xmlDoc, &tempBuffer, &tempBufferSize);
-
-	// remove carriage returns (even though libxml was instructed not to format the XML)
-	xmlChar* bufferChar = tempBuffer;
-	int bufferCharIndex = 0;
-
-	while (*bufferChar != '\0')
-	{
-		if (*bufferChar == '\n')
-		{
-			memmove(bufferChar, bufferChar + 1, tempBufferSize - bufferCharIndex);
-			tempBufferSize--;
-		}
-		else if (*bufferChar == '\"')
-			*bufferChar = '\'';
-
-		bufferChar++;
-		bufferCharIndex++;
-	}
-
-	xml = new char[tempBufferSize + 1];
-	memcpy(xml, tempBuffer, tempBufferSize);
-	xml[tempBufferSize] = 0;
-
-	return xml;
-}
-
-bool PluginXmlOptions::validateXml(xmlDocPtr doc, const char *schemaFile)
-{
-	char *pluginDir = ADM_getPluginPath();
-	char schemaPath[strlen(pluginDir) + strlen(PLUGIN_SCHEMA_DIR) + 1 + strlen(schemaFile) + 1];
-	bool success = false;
-
-	strcpy(schemaPath, pluginDir);
-	strcat(schemaPath, PLUGIN_SCHEMA_DIR);
-	strcat(schemaPath, "/");
-	strcat(schemaPath, schemaFile);
-	delete [] pluginDir;
-
-	xmlSchemaParserCtxtPtr xmlSchemaParserCtxt = xmlSchemaNewParserCtxt(schemaPath);
-	xmlSchemaPtr xmlSchema = xmlSchemaParse(xmlSchemaParserCtxt);
-
- 	xmlSchemaFreeParserCtxt(xmlSchemaParserCtxt);
-
- 	xmlSchemaValidCtxtPtr xmlSchemaValidCtxt = xmlSchemaNewValidCtxt(xmlSchema);
-
- 	if (xmlSchemaValidCtxt)
-	{
- 		success = !xmlSchemaValidateDoc(xmlSchemaValidCtxt, doc);
-	 	xmlSchemaFree(xmlSchema);
-		xmlSchemaFreeValidCtxt(xmlSchemaValidCtxt);
- 	}
-	else
- 		xmlSchemaFree(xmlSchema);
-
-	return success;
-}

Deleted: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginXmlOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginXmlOptions.h	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginXmlOptions.h	2009-12-31 14:07:50 UTC (rev 5797)
@@ -1,46 +0,0 @@
-/***************************************************************************
-                             PluginXmlOptions.h
-
-    begin                : Mon Apr 21 2008
-    copyright            : (C) 2008 by gruntster
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef PluginXmlOptions_h
-#define PluginXmlOptions_h
-
-
-typedef enum
-{
-	PLUGIN_XML_INTERNAL,
-	PLUGIN_XML_EXTERNAL,
-} PluginXmlType;
-
-class PluginXmlOptions
-{
-protected:
-	xmlChar* number2String(xmlChar *buffer, size_t size, int number);
-	xmlChar* number2String(xmlChar *buffer, size_t size, unsigned int number);
-	xmlChar* number2String(xmlChar *buffer, size_t size, float number);
-	xmlChar* boolean2String(xmlChar *buffer, size_t size, bool boolean);
-	
-	bool string2Boolean(const char *buffer);
-	float string2Float(const char *buffer);
-
-	virtual char* dumpXmlDocToMemory(xmlDocPtr xmlDoc);
-	virtual bool validateXml(xmlDocPtr doc, const char* schemaFile);
-
-public:
-	virtual char* toXml(PluginXmlType xmlType) = 0;
-	virtual int fromXml(const char *xml, PluginXmlType xmlType) = 0;
-};
-
-#endif	// PluginXmlOptions_h

Added: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/CMakeLists.txt	2009-12-31 12:46:13 UTC (rev 5796)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/CMakeLists.txt	2009-12-31 14:07:50 UTC (rev 5797)
@@ -0,0 +1,10 @@
+include(admCheckLibxml2)
+
+set(ADM_vidEnc_pluginOptions_SRCS  PluginOptions.cpp  PluginXmlOptions.cpp)
+
+include_directories("${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_core/include"
+					"${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_coreUI/include"
+					"${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_plugin")
+
+add_library(ADM_vidEnc_pluginOptions ${ADM_vidEnc_pluginOptions_SRCS})
+target_link_libraries(ADM_vidEnc_pluginOptions ${LIBXML2_LIBRARIES} ADM_core)
\ No newline at end of file

Copied: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginOptions.cpp (from rev 5792, branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.cpp)

Copied: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginOptions.h (from rev 5792, branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginOptions.h)

Copied: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.cpp (from rev 5792, branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginXmlOptions.cpp)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginXmlOptions.cpp	2009-12-31 00:28:35 UTC (rev 5792)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.cpp	2009-12-31 14:07:50 UTC (rev 5797)
@@ -0,0 +1,148 @@
+/***************************************************************************
+                            PluginXmlOptions.cpp
+
+    begin                : Mon Apr 21 2008
+    copyright            : (C) 2008 by gruntster
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <sstream>
+#include <libxml/parser.h>
+#include <libxml/xmlschemas.h>
+
+#include "PluginXmlOptions.h"
+#include "ADM_files.h"
+
+xmlChar* PluginXmlOptions::number2String(xmlChar *buffer, size_t size, int number)
+{
+	std::ostringstream stream;
+
+	stream.imbue(std::locale::classic());
+	stream << number;
+	std::string string = stream.str();
+
+	strncpy((char*)buffer, string.c_str(), size);
+
+	return buffer;
+}
+
+xmlChar* PluginXmlOptions::number2String(xmlChar *buffer, size_t size, unsigned int number)
+{
+	std::ostringstream stream;
+
+	stream.imbue(std::locale::classic());
+	stream << number;
+	std::string string = stream.str();
+
+	strncpy((char*)buffer, string.c_str(), size);
+
+	return buffer;
+}
+
+xmlChar* PluginXmlOptions::number2String(xmlChar *buffer, size_t size, float number)
+{
+	std::ostringstream stream;
+
+	stream.imbue(std::locale::classic());
+	stream << number;
+	std::string string = stream.str();
+
+	strncpy((char*)buffer, string.c_str(), size);
+
+	return buffer;
+}
+
+xmlChar* PluginXmlOptions::boolean2String(xmlChar *buffer, size_t size, bool boolean)
+{
+	if (boolean)
+		strncpy((char*)buffer, "true", size);
+	else
+		strncpy((char*)buffer, "false", size);
+
+	return buffer;
+}
+
+bool PluginXmlOptions::string2Boolean(const char *buffer)
+{
+	return (strcmp(buffer, "true") == 0);
+}
+
+float PluginXmlOptions::string2Float(const char *buffer)
+{
+	std::istringstream stream(buffer);
+	float value;
+
+	stream >> value;
+
+	return value;
+}
+
+char* PluginXmlOptions::dumpXmlDocToMemory(xmlDocPtr xmlDoc)
+{
+	xmlChar *tempBuffer;
+	int tempBufferSize;
+	char *xml = NULL;
+
+	xmlDocDumpMemory(xmlDoc, &tempBuffer, &tempBufferSize);
+
+	// remove carriage returns (even though libxml was instructed not to format the XML)
+	xmlChar* bufferChar = tempBuffer;
+	int bufferCharIndex = 0;
+
+	while (*bufferChar != '\0')
+	{
+		if (*bufferChar == '\n')
+		{
+			memmove(bufferChar, bufferChar + 1, tempBufferSize - bufferCharIndex);
+			tempBufferSize--;
+		}
+		else if (*bufferChar == '\"')
+			*bufferChar = '\'';
+
+		bufferChar++;
+		bufferCharIndex++;
+	}
+
+	xml = new char[tempBufferSize + 1];
+	memcpy(xml, tempBuffer, tempBufferSize);
+	xml[tempBufferSize] = 0;
+
+	return xml;
+}
+
+bool PluginXmlOptions::validateXml(xmlDocPtr doc, const char *schemaFile)
+{
+	char *pluginDir = ADM_getPluginPath();
+	char schemaPath[strlen(pluginDir) + strlen(schemaFile) + 1];
+	bool success = false;
+
+	strcpy(schemaPath, pluginDir);
+		strcat(schemaPath, schemaFile);
+	delete [] pluginDir;
+
+	xmlSchemaParserCtxtPtr xmlSchemaParserCtxt = xmlSchemaNewParserCtxt(schemaPath);
+	xmlSchemaPtr xmlSchema = xmlSchemaParse(xmlSchemaParserCtxt);
+
+ 	xmlSchemaFreeParserCtxt(xmlSchemaParserCtxt);
+
+ 	xmlSchemaValidCtxtPtr xmlSchemaValidCtxt = xmlSchemaNewValidCtxt(xmlSchema);
+
+ 	if (xmlSchemaValidCtxt)
+	{
+ 		success = !xmlSchemaValidateDoc(xmlSchemaValidCtxt, doc);
+	 	xmlSchemaFree(xmlSchema);
+		xmlSchemaFreeValidCtxt(xmlSchemaValidCtxt);
+ 	}
+	else
+ 		xmlSchemaFree(xmlSchema);
+
+	return success;
+}

Copied: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.h (from rev 5792, branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/PluginXmlOptions.h)



From gruntster at mail.berlios.de  Thu Dec 31 15:18:43 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu, 31 Dec 2009 15:18:43 +0100
Subject: [Avidemux-svn-commit] r5798 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder:
	ADM_vidEnc_avcodec common
Message-ID: <200912311418.nBVEIhvF029235@sheep.berlios.de>

Author: gruntster
Date: 2009-12-31 15:18:34 +0100 (Thu, 31 Dec 2009)
New Revision: 5798

Added:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/xvidRateCtl/
Removed:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl/
Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.h
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/CMakeLists.txt
Log:
[vidEnc] move xvid rate control library to common area

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-31 14:07:50 UTC (rev 5797)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-31 14:18:34 UTC (rev 5798)
@@ -21,7 +21,7 @@
 set(H263_PLUGIN_CONFIG_DIR "avcodec/h263")
 set(MPEG4ASP_PLUGIN_CONFIG_DIR "avcodec/mpeg4asp")
 
-INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${LIBXML2_INCLUDE_DIR} ../common/pluginOptions)
+INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${LIBXML2_INCLUDE_DIR} ../common/pluginOptions ../common/xvidRateCtl)
 ADD_DEFINITIONS(${LIBXML2_DEFINITIONS})
 set_property(SOURCE mpeg1EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMPEG1_PLUGIN_CONFIG_DIR=\\\"${MPEG1_PLUGIN_CONFIG_DIR}\\\")
 set_property(SOURCE mpeg2EncoderOptions.cpp PROPERTY COMPILE_FLAGS -DMPEG2_PLUGIN_CONFIG_DIR=\\\"${MPEG2_PLUGIN_CONFIG_DIR}\\\")
@@ -35,7 +35,6 @@
 add_library(ADM_libavcodec UNKNOWN IMPORTED)
 set_property(TARGET ADM_libavcodec PROPERTY IMPORTED_LOCATION "${FFMPEG_INSTALL_DIR}/${LIBAVCODEC_LIB}")
 
-add_subdirectory(xvidRateCtl)
 add_subdirectory(xml)
 
 ADD_LIBRARY(ADM_vidEnc_avcodec SHARED ${ADM_vidEnc_avcodec_SRCS})

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.h	2009-12-31 14:07:50 UTC (rev 5797)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.h	2009-12-31 14:18:34 UTC (rev 5798)
@@ -26,7 +26,7 @@
 #include "encoder.h"
 #include "mpeg1EncoderOptions.h"
 #include "DIA_factory.h"
-#include "xvidRateCtl/xvidRateCtlVbv.h"
+#include "xvidRateCtlVbv.h"
 
 class Mpeg1Encoder : public AvcodecEncoder
 {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.h	2009-12-31 14:07:50 UTC (rev 5797)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.h	2009-12-31 14:18:34 UTC (rev 5798)
@@ -26,7 +26,7 @@
 #include "encoder.h"
 #include "mpeg2EncoderOptions.h"
 #include "DIA_factory.h"
-#include "xvidRateCtl/xvidRateCtlVbv.h"
+#include "xvidRateCtlVbv.h"
 
 class Mpeg2Encoder : public AvcodecEncoder
 {

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/CMakeLists.txt	2009-12-31 14:07:50 UTC (rev 5797)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/CMakeLists.txt	2009-12-31 14:18:34 UTC (rev 5798)
@@ -1 +1,2 @@
 add_subdirectory(pluginOptions)
+add_subdirectory(xvidRateCtl)
\ No newline at end of file

Copied: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/xvidRateCtl (from rev 5792, branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/xvidRateCtl)



From gruntster at mail.berlios.de  Thu Dec 31 15:36:33 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu, 31 Dec 2009 15:36:33 +0100
Subject: [Avidemux-svn-commit] r5799 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions
Message-ID: <200912311436.nBVEaXQY030064@sheep.berlios.de>

Author: gruntster
Date: 2009-12-31 15:36:28 +0100 (Thu, 31 Dec 2009)
New Revision: 5799

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.h
Log:
[vidEnc] unix compilation fixes

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/CMakeLists.txt	2009-12-31 14:18:34 UTC (rev 5798)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/CMakeLists.txt	2009-12-31 14:36:28 UTC (rev 5799)
@@ -4,7 +4,13 @@
 
 include_directories("${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_core/include"
 					"${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_coreUI/include"
-					"${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_plugin")
+					"${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_plugin"
+					"${LIBXML2_INCLUDE_DIR}")
 
+add_definitions(${LIBXML2_DEFINITIONS})
 add_library(ADM_vidEnc_pluginOptions ${ADM_vidEnc_pluginOptions_SRCS})
-target_link_libraries(ADM_vidEnc_pluginOptions ${LIBXML2_LIBRARIES} ADM_core)
\ No newline at end of file
+target_link_libraries(ADM_vidEnc_pluginOptions ${LIBXML2_LIBRARIES} ADM_core)
+
+if (UNIX)
+	add_target_cflags(ADM_vidEnc_pluginOptions -fPIC)
+endif (UNIX)
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginOptions.cpp	2009-12-31 14:18:34 UTC (rev 5798)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginOptions.cpp	2009-12-31 14:36:28 UTC (rev 5799)
@@ -19,7 +19,6 @@
 
 #include "ADM_inttype.h"
 #include "ADM_files.h"
-#include "PluginXmlOptions.cpp"
 #include "PluginOptions.h"
 
 #undef malloc

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.cpp	2009-12-31 14:18:34 UTC (rev 5798)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.cpp	2009-12-31 14:36:28 UTC (rev 5799)
@@ -15,10 +15,9 @@
  ***************************************************************************/
 
 #include <sstream>
-#include <libxml/parser.h>
-#include <libxml/xmlschemas.h>
 
 #include "PluginXmlOptions.h"
+#include "ADM_inttype.h"
 #include "ADM_files.h"
 
 xmlChar* PluginXmlOptions::number2String(xmlChar *buffer, size_t size, int number)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.h	2009-12-31 14:18:34 UTC (rev 5798)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/common/pluginOptions/PluginXmlOptions.h	2009-12-31 14:36:28 UTC (rev 5799)
@@ -17,6 +17,8 @@
 #ifndef PluginXmlOptions_h
 #define PluginXmlOptions_h
 
+#include <libxml/parser.h>
+#include <libxml/xmlschemas.h>
 
 typedef enum
 {



From gruntster at mail.berlios.de  Thu Dec 31 16:32:49 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu, 31 Dec 2009 16:32:49 +0100
Subject: [Avidemux-svn-commit] r5800 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder:
	ADM_vidEnc_avcodec ADM_vidEnc_x264 ADM_vidEnc_xvid
Message-ID: <200912311532.nBVFWnGb002231@sheep.berlios.de>

Author: gruntster
Date: 2009-12-31 16:32:44 +0100 (Thu, 31 Dec 2009)
New Revision: 5800

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt
Log:
[vidEnc] fix installation of xsd files

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-31 14:36:28 UTC (rev 5799)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/CMakeLists.txt	2009-12-31 15:32:44 UTC (rev 5800)
@@ -14,6 +14,7 @@
 							 flv1Encoder.cpp  flv1EncoderOptions.cpp  mjpegEncoder.cpp  mjpegEncoderOptions.cpp
 							 h263Encoder.cpp  h263EncoderOptions.cpp  mpeg4aspEncoder.cpp  mpeg4aspEncoderOptions.cpp)
 
+set(PLUGIN_SCHEMA_DIR "avcodec")
 set(MPEG1_PLUGIN_CONFIG_DIR "avcodec/mpeg-1")
 set(MPEG2_PLUGIN_CONFIG_DIR "avcodec/mpeg-2")
 set(FLV1_PLUGIN_CONFIG_DIR "avcodec/flv1")

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt	2009-12-31 14:36:28 UTC (rev 5799)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt	2009-12-31 15:32:44 UTC (rev 5800)
@@ -28,6 +28,6 @@
 
 		INIT_VIDEO_ENCODER_PLUGIN(ADM_vidEnc_x264)
 		INSTALL_VIDEO_ENCODER(ADM_vidEnc_x264)
-		INSTALL(FILES x264Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
+		INSTALL(FILES x264Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}x264")
 	ENDIF (LIBXML2_FOUND)
 ENDIF (X264_FOUND)
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt	2009-12-31 14:36:28 UTC (rev 5799)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt	2009-12-31 15:32:44 UTC (rev 5800)
@@ -26,6 +26,6 @@
 
 		INIT_VIDEO_ENCODER_PLUGIN(ADM_vidEnc_xvid)
 		INSTALL_VIDEO_ENCODER(ADM_vidEnc_xvid)
-		INSTALL(FILES XvidParam.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
+		INSTALL(FILES XvidParam.xsd DESTINATION "${VIDENC_INSTALL_DIR}xvid")
 	ENDIF (LIBXML2_FOUND)
 ENDIF (XVID_FOUND)
\ No newline at end of file



From gruntster at mail.berlios.de  Thu Dec 31 17:21:34 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu, 31 Dec 2009 17:21:34 +0100
Subject: [Avidemux-svn-commit] r5801 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder:
	ADM_vidEnc_x264 ADM_vidEnc_xvid
Message-ID: <200912311621.nBVGLYGN005088@sheep.berlios.de>

Author: gruntster
Date: 2009-12-31 17:21:29 +0100 (Thu, 31 Dec 2009)
New Revision: 5801

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt
Log:
[vidEnc] fix installation of UI libraries

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt	2009-12-31 15:32:44 UTC (rev 5800)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/CMakeLists.txt	2009-12-31 16:21:29 UTC (rev 5801)
@@ -11,6 +11,7 @@
 		SET(QT_PLUGIN_NAME "ADM_vidEnc_x264_Qt")
 		SET(GTK_PLUGIN_NAME "ADM_vidEnc_x264_Gtk")
 		
+		SET(PLUGIN_SCHEMA_DIR "x264")
 		SET(PLUGIN_CONFIG_DIR "x264")
 		
 		INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${X264_INCLUDE_DIR} ${LIBXML2_INCLUDE_DIR} ../common/pluginOptions)
@@ -28,6 +29,6 @@
 
 		INIT_VIDEO_ENCODER_PLUGIN(ADM_vidEnc_x264)
 		INSTALL_VIDEO_ENCODER(ADM_vidEnc_x264)
-		INSTALL(FILES x264Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}x264")
+		INSTALL(FILES x264Param.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
 	ENDIF (LIBXML2_FOUND)
 ENDIF (X264_FOUND)
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt	2009-12-31 15:32:44 UTC (rev 5800)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_xvid/CMakeLists.txt	2009-12-31 16:21:29 UTC (rev 5801)
@@ -10,6 +10,7 @@
 		SET(QT_PLUGIN_NAME "ADM_vidEnc_Xvid_Qt")
 		SET(GTK_PLUGIN_NAME "ADM_vidEnc_Xvid_Gtk")
 		
+		SET(PLUGIN_SCHEMA_DIR "xvid")
 		SET(PLUGIN_CONFIG_DIR "xvid")
 
 		INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${XVID_INCLUDE_DIR} ${LIBXML2_INCLUDE_DIR} ../common/pluginOptions)
@@ -26,6 +27,6 @@
 
 		INIT_VIDEO_ENCODER_PLUGIN(ADM_vidEnc_xvid)
 		INSTALL_VIDEO_ENCODER(ADM_vidEnc_xvid)
-		INSTALL(FILES XvidParam.xsd DESTINATION "${VIDENC_INSTALL_DIR}xvid")
+		INSTALL(FILES XvidParam.xsd DESTINATION "${VIDENC_INSTALL_DIR}${PLUGIN_SCHEMA_DIR}")
 	ENDIF (LIBXML2_FOUND)
 ENDIF (XVID_FOUND)
\ No newline at end of file



From mean at mail.berlios.de  Thu Dec 31 18:52:28 2009
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 31 Dec 2009 18:52:28 +0100
Subject: [Avidemux-svn-commit] r5802 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska
Message-ID: <200912311752.nBVHqSit023329@sheep.berlios.de>

Author: mean
Date: 2009-12-31 18:52:20 +0100 (Thu, 31 Dec 2009)
New Revision: 5802

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkv.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkvIndexer.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/mkv_tagenum.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/mkv_tags.cpp
Log:
[mkv] Ignore CRC and other tags when present, fixes #70

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkv.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkv.h	2009-12-31 16:21:29 UTC (rev 5801)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkv.h	2009-12-31 17:52:20 UTC (rev 5802)
@@ -53,7 +53,7 @@
   uint32_t  _defaultFrameDuration; // Duration of ONE frame in us!
 }mkvTrak;
 
-#define MKV_MAX_LACES 20 // ?
+#define MKV_MAX_LACES 31 // ?
 //**********************************************
 class mkvAudio : public AVDMGenericAudioStream
 {

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkvIndexer.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkvIndexer.cpp	2009-12-31 16:21:29 UTC (rev 5801)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/ADM_mkvIndexer.cpp	2009-12-31 17:52:20 UTC (rev 5802)
@@ -102,7 +102,7 @@
                                 //printf(">%s\n",ss);
                                 switch(id)
                                 {
-                                  default: blockGroup.skip(len);
+                                  default: blockGroup.skip(len);break;
                                   case MKV_BLOCK :
                                   case MKV_SIMPLE_BLOCK:
                                   {
@@ -475,7 +475,20 @@
      _clusters[_nbClusters].size=alen;
 
      // Normally the timecode is the 1st one following
+tryAgain:
        segment.readElemId(&id,&len);
+
+       switch(id)
+        {
+            case MKV_CRC32:
+            case MKV_PREV_SIZE:
+            case MKV_POSITION:
+                segment.skip(len);
+                goto tryAgain;
+            default:break;
+        }
+
+
        int seekme=_nbClusters;
        if(id!=MKV_TIMECODE)
        {

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/mkv_tagenum.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/mkv_tagenum.h	2009-12-31 16:21:29 UTC (rev 5801)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/mkv_tagenum.h	2009-12-31 17:52:20 UTC (rev 5802)
@@ -126,6 +126,9 @@
    MKTAG(MKV_DISPLAY_HEIGHT,0x54BA,ADM_MKV_TYPE_UINTEGER),
    MKTAG(MKV_FLAG_INTERLACED,0x9A,ADM_MKV_TYPE_UINTEGER),
 
+   MKTAG(MKV_CRC32,0xBF,ADM_MKV_TYPE_BINARY),
+   MKTAG(MKV_PREV_SIZE,0xAB,ADM_MKV_TYPE_UINTEGER),
+   MKTAG(MKV_POSITION,0xA7,ADM_MKV_TYPE_UINTEGER),
 
          //*************************
    MKTAG(MKV_MAX,0xFFFF,ADM_MKV_TYPE_UNKNOWN)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/mkv_tags.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/mkv_tags.cpp	2009-12-31 16:21:29 UTC (rev 5801)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska/mkv_tags.cpp	2009-12-31 17:52:20 UTC (rev 5802)
@@ -55,6 +55,8 @@
     }
     
   }
+  *asString="??";
+  *type=ADM_MKV_TYPE_UNKNOWN;
   return 0;
 }
 /**



From gruntster at mail.berlios.de  Thu Dec 31 20:01:11 2009
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu, 31 Dec 2009 20:01:11 +0100
Subject: [Avidemux-svn-commit] r5803 -
	branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux
Message-ID: <200912311901.nBVJ1BfU001196@sheep.berlios.de>

Author: gruntster
Date: 2009-12-31 20:01:06 +0100 (Thu, 31 Dec 2009)
New Revision: 5803

Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2. Create Packages.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2b. Package Build.bat
Log:
[win32] update scripts to package 32 & 64-bit

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2. Create Packages.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2. Create Packages.bat	2009-12-31 17:52:20 UTC (rev 5802)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2. Create Packages.bat	2009-12-31 19:01:06 UTC (rev 5803)
@@ -1,5 +1,21 @@
 @echo off
 
+echo Package Avidemux
+echo ================
+echo 1. 32-bit package
+echo 2. 64-bit package
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto end
+
+verify >nul
+echo.
+
 call "2a. Update Notes.bat"
 
 if errorlevel 1 goto error

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2b. Package Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2b. Package Build.bat	2009-12-31 17:52:20 UTC (rev 5802)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2b. Package Build.bat	2009-12-31 19:01:06 UTC (rev 5803)
@@ -7,7 +7,7 @@
 cd ..
 
 set curDir=%CD%
-set zipFile=avidemux_2.5_r%revisionNo%_full_win32.zip
+set zipFile=avidemux_2.5_r%revisionNo%_full_win%BuildBits%.zip
 set packageDir=%CD%\%revisionNo%
 
 echo %packageDir%
@@ -24,8 +24,8 @@
 
 cd %buildDir%
 echo -- Generating GTK+ Installer --
-"%nsisDir%\makensis" /V2 /NOCD /DINST_GTK /DNSIDIR="%curDir%\..\..\installer" /DEXEDIR="%packageDir%" "%curDir%\..\..\installer\avidemux.nsi"
+"%nsisDir%\makensis" /V2 /NOCD /DINST_GTK /DBUILD_BITS=%BuildBits% /DNSIDIR="%curDir%\..\..\installer" /DEXEDIR="%packageDir%" "%curDir%\..\..\installer\avidemux.nsi"
 echo -- Generating Qt Installer --
-"%nsisDir%\makensis" /V2 /NOCD /DINST_QT /DNSIDIR="%curDir%\..\..\installer" /DEXEDIR="%packageDir%" "%curDir%\..\..\installer\avidemux.nsi"
+"%nsisDir%\makensis" /V2 /NOCD /DINST_QT /DBUILD_BITS=%BuildBits% /DNSIDIR="%curDir%\..\..\installer" /DEXEDIR="%packageDir%" "%curDir%\..\..\installer\avidemux.nsi"
 
 pause



