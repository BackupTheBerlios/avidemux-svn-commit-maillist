From mean at mail.berlios.de  Mon Feb  1 07:36:51 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 1 Feb 2010 07:36:51 +0100
Subject: [Avidemux-svn-commit] r5886 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <201002010636.o116apCJ001818@sheep.berlios.de>

Author: mean
Date: 2010-02-01 07:36:49 +0100 (Mon, 01 Feb 2010)
New Revision: 5886

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp
Log:
[Editor] Fix 1st PTS only when we are at the very 1st frame

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp	2010-01-31 19:10:15 UTC (rev 5885)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp	2010-02-01 06:36:49 UTC (rev 5886)
@@ -163,7 +163,7 @@
     // Try to seek...
     _SEGMENT *s=_segments.getSegment(seg);
     _VIDEOS *v=_segments.getRefVideo(s->_reference);
-    if(!s->_reference && !segTime)
+    if(!s->_reference && !segTime && s->_refStartTimeUs<v->firstFramePts)
     {
         segTime=v->firstFramePts;
         ADM_warning("Fixating start time to %"LLU" ms\n",segTime/1000);



From mean at mail.berlios.de  Mon Feb  1 07:36:54 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 1 Feb 2010 07:36:54 +0100
Subject: [Avidemux-svn-commit] r5887 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src
Message-ID: <201002010636.o116aspL002056@sheep.berlios.de>

Author: mean
Date: 2010-02-01 07:36:53 +0100 (Mon, 01 Feb 2010)
New Revision: 5887

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
Log:
[VideoEncoder] Pre compensate for encoding delay rather than post-compensate

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-01 06:36:49 UTC (rev 5886)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-01 06:36:53 UTC (rev 5887)
@@ -214,9 +214,10 @@
 
     double p=image->Pts;
     nextDts=image->Pts;
+    p+=getEncoderDelay();
     _frame.pts= floor(p / (1000000.*av_q2d(_context->time_base) + 0.5));    //
     if(!_frame.pts) _frame.pts=AV_NOPTS_VALUE;
-    //printf("[PTS] :%"LU" num:%"LU" den:%"LU"\n",_frame.pts,_context->time_base.num,_context->time_base.den);
+    //printf("--->>[PTS] :%"LLU", raw %"LLU" num:%"LU" den:%"LU"\n",_frame.pts,image->Pts,_context->time_base.num,_context->time_base.den);
     //
     switch(targetColorSpace)
     {
@@ -366,8 +367,7 @@
     
     // Update PTS/Dts
 
-    out->pts=getEncoderDelay();
-    out->pts+= _context->coded_frame->pts * 1000000.*av_q2d(_context->time_base);
+    out->pts= _context->coded_frame->pts * 1000000.*av_q2d(_context->time_base);
     out->dts=nextDts; // FIXME
     aprintf("Out pts=%"LLU" us\n",out->pts);    
 



From mean at mail.berlios.de  Wed Feb  3 07:43:57 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 3 Feb 2010 07:43:57 +0100
Subject: [Avidemux-svn-commit] r5888 - in branches/avidemux_2.6_branch_mean:
	avidemux/common/ADM_audioFilter/include
	avidemux/common/ADM_audioFilter/src
	avidemux_core/ADM_coreAudioFilter/include
Message-ID: <201002030643.o136hvJO009889@sheep.berlios.de>

Author: mean
Date: 2010-02-03 07:43:50 +0100 (Wed, 03 Feb 2010)
New Revision: 5888

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/include/audiofilter_access.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/include/audiofilter_thread.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_thread.cpp
Removed:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_access.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_encoder.cpp
Log:
[audioEncoding] Do the audio encoding in its own thread, very naive thead synchronization

Copied: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/include/audiofilter_access.h (from rev 5887, branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_access.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_access.h	2010-02-01 06:36:53 UTC (rev 5887)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/include/audiofilter_access.h	2010-02-03 06:43:50 UTC (rev 5888)
@@ -0,0 +1,58 @@
+/***************************************************************************
+            \file audiofilter_access.h
+            \brief convert audiofilter to audioaccess (used for playback for example)
+            (C) Mean 2009 fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef AUDM_ACCESS_H
+#define AUDM_ACCESS_H
+
+#include "ADM_audioStream.h"
+#include "audioencoder.h"
+/**
+    \class ADMAudioFilter_Access
+    \brief Bridge audioFilter->Access
+
+*/
+class ADMAudioFilter_Access : public ADM_audioAccess
+{
+  protected:
+    uint64_t            startTimeUs; /*< Starting time in us */
+    AUDMAudioFilter     *filter;
+    uint64_t            samplesSeen;
+    ADM_AudioEncoder    *encoder;
+  public:
+                WAVHeader         *getWavHeader(void) {return encoder->getInfo();}
+
+                                    ADMAudioFilter_Access(AUDMAudioFilter *incoming,ADM_AudioEncoder *encoder,uint64_t timeUs) ;
+                virtual           ~ADMAudioFilter_Access();
+                                    /// Return true if the demuxer can seek in time
+                virtual bool      canSeekTime(void) {return false;};
+                                    /// Return true if the demuxer can seek by offser
+                virtual bool      canSeekOffset(void) {return true;};
+                                    /// Return true if we can have the audio duration
+                virtual bool      canGetDuration(void) {return false;};
+                                    /// Returns length in bytes of the audio stream
+                virtual uint32_t  getLength(void){return 0;}
+                                    /// Set position in bytes
+                virtual bool      setPos(uint64_t pos);
+                                    /// Get position in bytes
+                virtual uint64_t  getPos(void);
+                                    /// Grab extra data
+                virtual bool      getExtraData(uint32_t *l, uint8_t **d);
+
+                virtual bool    getPacket(uint8_t *buffer, uint32_t *size, uint32_t maxSize,uint64_t *dts);
+                virtual bool    isCBR(void);
+};
+
+
+#endif
+

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/include/audiofilter_thread.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/include/audiofilter_thread.h	2010-02-01 06:36:53 UTC (rev 5887)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/include/audiofilter_thread.h	2010-02-03 06:43:50 UTC (rev 5888)
@@ -0,0 +1,86 @@
+/***************************************************************************
+            \file audiofilter_thread.h
+            \brief Wrap an audio access inside its own thread
+            \author (C) Mean 2010 fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef AUDM_ACCESS_THREAD_H
+#define AUDM_ACCESS_THREAD_H
+
+#include "ADM_audioStream.h"
+#include "ADM_threads.h"
+using std::vector;
+#include <vector>
+
+
+
+/**
+    \struct ADM_audioPacket
+*/
+typedef struct
+{
+    uint8_t *data;
+    uint32_t dataLen;
+    uint64_t dts;
+}ADM_audioPacket;
+typedef  vector <ADM_audioPacket> ListOfAudioPacket;
+
+typedef enum
+{
+    RunStateIdle,
+    RunStateRunning,
+    RunStateStopOrder,
+    RunStateStopped
+}RunState;
+
+/**
+    \class ADM_audioAccess_thread
+    \brief Wrap ADM_audioAccess inside a thread
+
+*/
+class ADM_audioAccess_thread : public ADM_audioAccess
+{
+  protected:
+                ADM_audioAccess   *son;
+                ListOfAudioPacket list;
+                admMutex          *mutex;
+                admCond           *cond;
+                bool              started;
+volatile        RunState          threadState;
+                pthread_t         myThread;
+  public:
+
+
+                                    ADM_audioAccess_thread(ADM_audioAccess *son) ;
+                virtual           ~ADM_audioAccess_thread();
+                                    /// Return true if the demuxer can seek in time
+                virtual bool      canSeekTime(void) {return son->canSeekTime();};
+                                    /// Return true if the demuxer can seek by offser
+                virtual bool      canSeekOffset(void) {return son->canSeekOffset();};
+                                    /// Return true if we can have the audio duration
+                virtual bool      canGetDuration(void) {return son->canGetDuration();};
+                                    /// Returns length in bytes of the audio stream
+                virtual uint32_t  getLength(void){return son->getLength();}
+                                    /// Set position in bytes
+                virtual bool      setPos(uint64_t pos) ;
+                                    /// Get position in bytes
+                virtual uint64_t  getPos(void);
+                                    /// Grab extra data
+                virtual bool      getExtraData(uint32_t *l, uint8_t **d);
+
+                virtual bool    getPacket(uint8_t *buffer, uint32_t *size, uint32_t maxSize,uint64_t *dts);
+                virtual bool    isCBR(void) {return son->isCBR();};
+                void            run(void);
+};
+
+
+#endif
+

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/CMakeLists.txt	2010-02-01 06:36:53 UTC (rev 5887)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/CMakeLists.txt	2010-02-03 06:43:50 UTC (rev 5888)
@@ -16,6 +16,7 @@
 audiocopy.cpp
 ADM_audioResample.cpp
 audiofilter.cpp
+audiofilter_thread.cpp
 ADM_libsamplerate/samplerate.c  
 ADM_libsamplerate/src_linear.c  
 ADM_libsamplerate/src_sinc.c  

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_encoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_encoder.cpp	2010-02-01 06:36:53 UTC (rev 5887)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_encoder.cpp	2010-02-03 06:43:50 UTC (rev 5888)
@@ -31,6 +31,8 @@
 //
  extern bool ADM_buildFilterChain(VectorOfAudioFilter *vec,ADM_AUDIOFILTER_CONFIG *config);
  extern bool ADM_emptyFilterChain(VectorOfAudioFilter *vec);
+
+extern ADM_audioAccess *ADM_threadifyAudioAccess(ADM_audioAccess *son);
 /**
         \fn createPlaybackFilter
         \brief Create a float output filter for playback
@@ -99,12 +101,14 @@
         destroyEncodingFilter();
         return NULL;
     }
+    // 3b create threaded version
+    ADM_audioAccess *threaded=ADM_threadifyAudioAccess(access);
     // 4- Create Stream // MEMLEAK!!!!
-    ADM_audioStream *stream=ADM_audioCreateStream(encoder->getInfo(), access);
+    ADM_audioStream *stream=ADM_audioCreateStream(encoder->getInfo(), threaded);
     if(!stream)
     {
         printf("[Access] Cannot create stream\n");
-        delete access; // Access will destroy filter & encoder
+        delete threaded; // Access will destroy filter & encoder
         return NULL;
     }
     return stream;

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_thread.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_thread.cpp	2010-02-01 06:36:53 UTC (rev 5887)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_thread.cpp	2010-02-03 06:43:50 UTC (rev 5888)
@@ -0,0 +1,214 @@
+/***************************************************************************
+            \file audiofilter_thread.cpp
+            \brief Wrap an access class into its own thread so that it can be parallelized
+              (c) 2006 Mean , fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+
+#include "ADM_default.h"
+#include "ADM_editor/ADM_edit.hxx"
+#include "audiofilter_thread.h"
+#include <math.h>
+
+#define MAX_CHUNK_IN_QUEUE 50
+
+static void *boomerang(void *x)
+{
+    ADM_audioAccess_thread *a=(ADM_audioAccess_thread *)x;
+    a->run();
+}
+
+/**
+    \fn ADM_audioAccess_thread
+    \brief
+*/
+ADM_audioAccess_thread::ADM_audioAccess_thread(ADM_audioAccess *son)
+{
+    this->son=son;
+    ADM_info("Swallowing audio access into a thread\n");
+    mutex=new admMutex("audioAccess");
+    cond=new admCond(mutex);
+    threadState=RunStateIdle;
+    started=false;
+    
+}
+/**
+    \fn ~ADM_audioAccess_thread
+    \brief
+*/
+
+ADM_audioAccess_thread::~ADM_audioAccess_thread()
+{
+    ADM_info("Killing audio thread and son\n");
+    // ask the thread to stop
+    
+    if(started)
+    {
+        mutex->lock();
+        if(threadState==RunStateRunning)
+        {   
+            ADM_info("Asking the thread to stop\n");
+            threadState=RunStateStopOrder;
+            mutex->unlock();
+            int count=100;
+            while(count)
+            {
+                if(threadState==RunStateStopped) break;
+                ADM_usleep(1000*100); // Slep 100 ms
+            }
+        }else mutex->unlock();
+    }
+    // Empty the list...
+    int nb=list.size();
+    for(int i=0;i<nb;i++)
+    {
+        ADM_audioPacket *pkt=&(list[i]);
+        if(pkt->data) delete [] pkt->data;
+        pkt->data=NULL;
+    }
+    list.clear();
+    // Thread stopped, we can kill the son
+    delete son;
+}
+
+/**
+    \fn setPos
+    \brief
+*/
+
+bool      ADM_audioAccess_thread::setPos(uint64_t pos) 
+{
+    return false;
+}
+/**
+    \fn getPos
+    \brief
+*/
+
+uint64_t  ADM_audioAccess_thread::getPos(void)
+{
+    return 0;
+}
+/**
+    \fn    getExtraData
+    \brief
+*/
+                                    
+bool      ADM_audioAccess_thread::getExtraData(uint32_t *l, uint8_t **d)
+{
+    return son->getExtraData(l,d);
+}
+/**
+    \fn    getPacket
+    \brief
+*/
+
+bool    ADM_audioAccess_thread::getPacket(uint8_t *buffer, uint32_t *size, uint32_t maxSize,uint64_t *dts)
+{
+    if(false==started)
+    {
+        ADM_info("Starting thread...\n");
+        if(pthread_create(&myThread,NULL, boomerang, this))
+        {
+            ADM_error("ERROR CREATING THREAD\n");
+            ADM_assert(0);
+        }
+        while(threadState==RunStateIdle)
+        {
+            ADM_usleep(10000);
+        }
+        ADM_info("Thread created and started\n");
+        started=true;
+    }
+    while(1)
+    {
+        mutex->lock();
+        if(list.size())
+        {
+            // Dequeue one item
+            ADM_audioPacket *pkt=&(list[0]);
+            ADM_assert(pkt->data);
+            ADM_assert(pkt->dataLen<maxSize);
+            memcpy(buffer,pkt->data,pkt->dataLen);
+            *dts=pkt->dts;
+            *size=pkt->dataLen;
+            delete [] pkt->data;
+            pkt->data=NULL;
+            list.erase(list.begin());
+            mutex->unlock();
+            return true;
+        }
+        // If no item, thread still alive ?
+        if(threadState==RunStateStopped)
+        {
+            ADM_info("Audio thread stopped, no more data\n");
+            mutex->unlock();
+            return false;
+        }
+        mutex->unlock();
+        ADM_usleep(10*1000); // wait 10 ms
+    }
+    return false;
+}
+/**
+    \fn run
+    \brief entry point for thread
+*/
+void ADM_audioAccess_thread::run(void)
+{
+    #define CHUNK_SIZE (48000*sizeof(float)*6)
+    threadState=RunStateRunning;
+    uint8_t *buffer=new uint8_t[CHUNK_SIZE];
+    uint32_t size;
+    uint64_t dts;
+    while(1)
+    {
+        if(false==son->getPacket(buffer,&size,CHUNK_SIZE,&dts))
+        {
+            ADM_info("Audio Thread, no more data\n");
+            goto theEnd;
+        }
+        ADM_audioPacket p;
+        p.data=new uint8_t[size];
+        memcpy(p.data,buffer,size);
+        p.dataLen=size;
+        p.dts=dts;
+        mutex->lock();
+        list.push_back(p);
+        mutex->unlock();
+        if(threadState==RunStateStopOrder)  
+        {
+            ADM_info("Audio Thread, received stop order\n");
+            goto theEnd;
+        }
+        while(1)
+        {
+            int n=list.size();
+            if(n<MAX_CHUNK_IN_QUEUE) break;
+            ADM_usleep(20*1000); // Fixme: replace by thread signals
+        }
+            
+    }
+
+theEnd:
+    delete [] buffer;
+    threadState=RunStateStopped;
+}
+/**
+    \fn ADM_threadifyAudioAccess
+*/
+ADM_audioAccess *ADM_threadifyAudioAccess(ADM_audioAccess *son)
+{
+    return new ADM_audioAccess_thread(son);
+}
+
+// EOF

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_access.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_access.h	2010-02-01 06:36:53 UTC (rev 5887)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_access.h	2010-02-03 06:43:50 UTC (rev 5888)
@@ -1,58 +0,0 @@
-/***************************************************************************
-            \file audiofilter_access.h
-            \brief convert audiofilter to audioaccess (used for playback for example)
-            (C) Mean 2009 fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef AUDM_ACCESS_H
-#define AUDM_ACCESS_H
-
-#include "ADM_audioStream.h"
-#include "audioencoder.h"
-/**
-    \class ADMAudioFilter_Access
-    \brief Bridge audioFilter->Access
-
-*/
-class ADMAudioFilter_Access : public ADM_audioAccess
-{
-  protected:
-    uint64_t            startTimeUs; /*< Starting time in us */
-    AUDMAudioFilter     *filter;
-    uint64_t            samplesSeen;
-    ADM_AudioEncoder    *encoder;
-  public:
-                WAVHeader         *getWavHeader(void) {return encoder->getInfo();}
-
-                                    ADMAudioFilter_Access(AUDMAudioFilter *incoming,ADM_AudioEncoder *encoder,uint64_t timeUs) ;
-                virtual           ~ADMAudioFilter_Access();
-                                    /// Return true if the demuxer can seek in time
-                virtual bool      canSeekTime(void) {return false;};
-                                    /// Return true if the demuxer can seek by offser
-                virtual bool      canSeekOffset(void) {return true;};
-                                    /// Return true if we can have the audio duration
-                virtual bool      canGetDuration(void) {return false;};
-                                    /// Returns length in bytes of the audio stream
-                virtual uint32_t  getLength(void){return 0;}
-                                    /// Set position in bytes
-                virtual bool      setPos(uint64_t pos);
-                                    /// Get position in bytes
-                virtual uint64_t  getPos(void);
-                                    /// Grab extra data
-                virtual bool      getExtraData(uint32_t *l, uint8_t **d);
-
-                virtual bool    getPacket(uint8_t *buffer, uint32_t *size, uint32_t maxSize,uint64_t *dts);
-                virtual bool    isCBR(void);
-};
-
-
-#endif
-



From mean at mail.berlios.de  Thu Feb  4 07:42:10 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 4 Feb 2010 07:42:10 +0100
Subject: [Avidemux-svn-commit] r5889 - in branches/avidemux_2.6_branch_mean:
 avidemux/common avidemux/common/ADM_audioFilter/src
 avidemux/common/ADM_videoEncoder/include
 avidemux/common/ADM_videoEncoder/src
 avidemux_core/ADM_coreAudioEncoder/include
 avidemux_core/ADM_coreAudioFilter/include
 avidemux_core/ADM_coreMuxer/include
 avidemux_core/ADM_coreVideoEncoder/include
 avidemux_core/ADM_coreVideoEncoder/src
 avidemux_plugins/ADM_audioEncoders/aften
 avidemux_plugins/ADM_audioEncoders/faac
 avidemux_plugins/ADM_audioEncoders/lame
 avidemux_plugins/ADM_audioEncoders/lavcodec
 avidemux_plugins/ADM_audioEncoders/pcm
 avidemux_plugins/ADM_audioEncoders/twolame
 avidemux_plugins/ADM_audioEncoders/vorbis
 avidemux_plugins/ADM_muxers/muxerMp4
 avidemux_plugins/ADM_videoEncoder/ffFlv1
 avidemux_plugins/ADM_videoEncoder/ffMpeg4
 avidemux_plugins/ADM_videoEncoder/ffMsMpeg4
 avidemux_plugins/ADM_videoEncoder/huff
 avidemux_plugins/ADM_videoEncoder/jpeg
 avidemux_plugins/ADM_videoEncoder/png avidemux_plugins/ADM_videoEncode!
 r/yv12
Message-ID: <201002040642.o146gAwU007702@sheep.berlios.de>

Author: mean
Date: 2010-02-04 07:42:04 +0100 (Thu, 04 Feb 2010)
New Revision: 5889

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audio_encoderPlugin.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_encoder.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoEncoder/include/ADM_videoEncoderApi.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoEncoder/src/ADM_dynVideoEncoder.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoderInternal.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audioEncoderApi.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_muxer.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_muxerInternal.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderInternal.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/pcm/audioencoder_pcm.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/pcm/audioencoder_pcm.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/twolame/audioencoder_twolame.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/vorbis/audioencoder_vorbis.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/vorbis/audioencoder_vorbis.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffFlv1/ADM_ffFlv1.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffFlv1/ADM_ffFlv1.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg4/ADM_ffMpeg4.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg4/ADM_ffMpeg4.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMsMpeg4/ADM_ffMsMp4.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMsMpeg4/ADM_ffMsMp4.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/jpeg/ADM_jpegEncoder.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/jpeg/ADM_jpegEncoder.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/png/ADM_pngEncoder.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/png/ADM_pngEncoder.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/yv12/ADM_yv12Encoder.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/yv12/ADM_yv12Encoder.h
Log:
[encoder] New flag to check if the muxer needs global headers

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audio_encoderPlugin.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audio_encoderPlugin.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audio_encoderPlugin.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -336,11 +336,11 @@
         \fn audioEncoderCreate
         \brief Spawn an audio encoder
 */
-ADM_AudioEncoder *audioEncoderCreate(AUDMAudioFilter *filter)
+ADM_AudioEncoder *audioEncoderCreate(AUDMAudioFilter *filter,bool globalHeader)
 {
       ADM_assert(currentEncoder<ListOfAudioEncoder.size());
       ADM_audioEncoder *enc=ListOfAudioEncoder[currentEncoder];
-     return enc->create(filter);
+     return enc->create(filter,globalHeader);
 }
 /**
         \fn getAudioExtraConf

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_encoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_encoder.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_encoder.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -66,7 +66,7 @@
 /**
     \fn createEncodingAccess
 */
-ADM_audioStream *audioCreateEncodingStream(uint64_t startTime,int32_t shift)
+ADM_audioStream *audioCreateEncodingStream(bool globalHeader,uint64_t startTime,int32_t shift)
 {
     printf("[AccessFilter] Creating access filter\n");
     // 1-Create access filter
@@ -78,7 +78,7 @@
     }
 
     // 2- spawn encoder
-    ADM_AudioEncoder *encoder=audioEncoderCreate(filter);
+    ADM_AudioEncoder *encoder=audioEncoderCreate(filter,globalHeader);
     if(!encoder) 
     {
         printf("[Access] Cannot create audio encoder\n");

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoEncoder/include/ADM_videoEncoderApi.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoEncoder/include/ADM_videoEncoderApi.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoEncoder/include/ADM_videoEncoderApi.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -21,7 +21,7 @@
 class ADM_coreVideoFilter;
 class CONFcouple;
 // Spawn a new encoder using the index from the menu = the index in the vector
-ADM_coreVideoEncoder *createVideoEncoderFromIndex(ADM_coreVideoFilter *chain,int index);
+//ADM_coreVideoEncoder *createVideoEncoderFromIndex(ADM_coreVideoFilter *chain,int index);
 
 bool                  videoEncoder6SelectByName(const char *name);
 bool                  videoEncoder6Configure(void);
@@ -35,6 +35,6 @@
 bool                  videoEncoder6_SetConfiguration(CONFcouple *c);
 bool                  videoEncoder6_GetConfiguration(CONFcouple **c);
 
-ADM_coreVideoEncoder *createVideoEncoderFromIndex(ADM_coreVideoFilter *chain,int index);
+ADM_coreVideoEncoder *createVideoEncoderFromIndex(ADM_coreVideoFilter *chain,int index,bool globalHeader);
 
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoEncoder/src/ADM_dynVideoEncoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoEncoder/src/ADM_dynVideoEncoder.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoEncoder/src/ADM_dynVideoEncoder.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -191,14 +191,14 @@
 /**
     \fn createVideoEncoder
 */
-ADM_coreVideoEncoder *createVideoEncoderFromIndex(ADM_coreVideoFilter *chain,int index)
+ADM_coreVideoEncoder *createVideoEncoderFromIndex(ADM_coreVideoFilter *chain,int index,bool globalHeader)
 {
     int nb=ListOfEncoders.size();
 	ADM_assert(index < nb);
     ADM_assert(index); // 0 is for copy, should not get it through here
     ADM_videoEncoder6 *plugin=ListOfEncoders[index];
 
-    ADM_coreVideoEncoder *enc=plugin->desc->create(chain);
+    ADM_coreVideoEncoder *enc=plugin->desc->create(chain,globalHeader);
     return enc;
 }
 /**

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -41,7 +41,7 @@
 
 */
 ADM_muxer               *ADM_MuxerSpawnFromIndex(int index);
-extern ADM_audioStream  *audioCreateEncodingStream(uint64_t startTime,int32_t shift);
+extern ADM_audioStream  *audioCreateEncodingStream(bool globalHeader,uint64_t startTime,int32_t shift);
 extern ADM_audioStream  *audioCreateCopyStream(uint64_t startTime,int32_t shift,ADM_audioStream *input);
 extern ADM_videoStream  *createVideoStream(ADM_coreVideoEncoder *encoder);
 extern int              ADM_MuxerIndexFromName(const char *name);
@@ -196,7 +196,7 @@
                 int sz=chain->size();
                 ADM_assert(sz);
                 last=(*chain)[sz-1]; // Grab last filter
-                ADM_coreVideoEncoder *pass2=createVideoEncoderFromIndex(last,videoEncoderIndex);
+                ADM_coreVideoEncoder *pass2=createVideoEncoderFromIndex(last,videoEncoderIndex,muxer->useGlobalHeader()); 
                 if(!pass2)
                 {
                     printf("[Save] Cannot create encoder for pass 2\n");
@@ -281,7 +281,7 @@
         ADM_assert(sz);
         ADM_coreVideoFilter  *last;
         last=(*chain)[sz-1]; // Grab last filter
-        ADM_coreVideoEncoder *encoder=createVideoEncoderFromIndex(last,videoEncoderIndex);
+        ADM_coreVideoEncoder *encoder=createVideoEncoderFromIndex(last,videoEncoderIndex,muxer->useGlobalHeader()); // FIXME GLOBAL HEADERS
         if(!encoder)
         {
            GUI_Error_HIG("Video","Cannot create encoder");
@@ -324,7 +324,7 @@
         if(audio)   // Process
         {
             // Access..
-            ADM_audioStream *access=audioCreateEncodingStream(startAudioTime,0); // FIXME LEAK
+            ADM_audioStream *access=audioCreateEncodingStream(startAudioTime,0,muxer->useGlobalHeader()); // FIXME LEAK FIXME 
             astreams[0]=access;
             if(!access)
             {

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoderInternal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoderInternal.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoderInternal.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -15,7 +15,7 @@
 #ifndef AUDIOENCODERINTERNAL_H
 #define AUDIOENCODERINTERNAL_H
 
-#define ADM_AUDIO_ENCODER_API_VERSION 3
+#define ADM_AUDIO_ENCODER_API_VERSION 4
 #include "stddef.h"
 #include "audioencoder.h"
 #include "ADM_paramList.h"
@@ -34,7 +34,7 @@
 typedef struct
 {
     uint32_t     apiVersion;            // const
-    ADM_AudioEncoder *(*create)(AUDMAudioFilter *head);  
+    ADM_AudioEncoder *(*create)(AUDMAudioFilter *head, bool globalHeader);
     void         (*destroy)(ADM_AudioEncoder *codec);
     bool         (*configure)(void);    
     const char   *codecName;        // Internal name (tag)
@@ -63,9 +63,9 @@
 static uint32_t     getBitrate(void); \
 static void         setBitrate(uint32_t br); \
 \
-static ADM_AudioEncoder * create (AUDMAudioFilter * head) \
+static ADM_AudioEncoder * create (AUDMAudioFilter * head,bool globalHeader) \
 { \
-  return new Class (head); \
+  return new Class (head,globalHeader); \
 } \
 static void destroy (ADM_AudioEncoder * in) \
 {\

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audioEncoderApi.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audioEncoderApi.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audioEncoderApi.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -17,7 +17,7 @@
 /// Directly set the codec, *only to be used
 uint8_t audioCodecSetByIndex(int i);
 /// Spawn a new encoder
-ADM_AudioEncoder *audioEncoderCreate(AUDMAudioFilter *filter);
+ADM_AudioEncoder *audioEncoderCreate(AUDMAudioFilter *filter,bool globalHeader);
 /// Select a encoder by its name e.g. "lame", used only by JS. Update UI as well
 uint8_t audioCodecSetByName( const char *name);
 /// Returns the name of the currently selected codec

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_muxer.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_muxer.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_muxer.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -70,6 +70,7 @@
         virtual  bool     initUI(const char *title);
         virtual  bool     updateUI(uint64_t time);
         virtual  bool     closeUI(void);
+        virtual  bool     useGlobalHeader(void) {return false;}
 
 };
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_muxerInternal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_muxerInternal.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_muxerInternal.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -16,7 +16,7 @@
 #ifndef  ADM_muxerInternal_H
 #define  ADM_muxerInternal_H
 
-#define ADM_MUXER_API_VERSION 3
+#define ADM_MUXER_API_VERSION 4
 #include <stddef.h>
 #include "ADM_dynamicLoading.h"
 #include "ADM_muxer.h"

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -42,6 +42,7 @@
                int              pass;   // Pass number = 1 or 2, valid only if we use 2 pass mode
                bool             _isMT; // True if multithreaded
                uint64_t         nextDts;
+               bool             _globalHeader;
 protected:
     virtual               bool             prolog(void); 
     virtual               bool             preEncode(void); 
@@ -53,7 +54,7 @@
                           bool             setupPass(void);  
                           bool             encoderMT (void);
 public:
-                                            ADM_coreVideoEncoderFFmpeg(ADM_coreVideoFilter *src,FFcodecSettings *settings=NULL);
+                                            ADM_coreVideoEncoderFFmpeg(ADM_coreVideoFilter *src,FFcodecSettings *settings=NULL,bool globalHeader=false);
 virtual                                     ~ADM_coreVideoEncoderFFmpeg();
 
 };

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderInternal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderInternal.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderInternal.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -15,7 +15,7 @@
 #ifndef VIDEOENCODERINTERNAL_H
 #define VIDEOENCODERINTERNAL_H
 
-#define ADM_VIDEO_ENCODER_API_VERSION 3
+#define ADM_VIDEO_ENCODER_API_VERSION 4
 #include "ADM_coreVideoEncoder.h"
 #include "DIA_uiTypes.h"
 #include "ADM_paramList.h"
@@ -34,7 +34,7 @@
     const char   *description;      // Short description
 
     uint32_t     apiVersion;            // const
-    ADM_coreVideoEncoder *(*create)(ADM_coreVideoFilter *head);  
+    ADM_coreVideoEncoder *(*create)(ADM_coreVideoFilter *head,bool globalHeader);  
     void         (*destroy)(ADM_coreVideoEncoder *codec);
     bool         (*configure)(void);                                // Call UI to set it up
     bool         (*getConfigurationData)(CONFcouple **c); // Get the encoder private conf
@@ -52,9 +52,9 @@
 static bool getConfigurationData (CONFcouple **c); \
 static bool setConfigurationData (CONFcouple *c);\
 \
-static ADM_coreVideoEncoder * create (ADM_coreVideoFilter * head) \
+static ADM_coreVideoEncoder * create (ADM_coreVideoFilter * head,bool globalHeader) \
 { \
-  return new Class (head); \
+  return new Class (head,globalHeader); \
 } \
 static void destroy (ADM_coreVideoEncoder * in) \
 {\

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -89,7 +89,7 @@
 
 */
 
-ADM_coreVideoEncoderFFmpeg::ADM_coreVideoEncoderFFmpeg(ADM_coreVideoFilter *src,FFcodecSettings *set) 
+ADM_coreVideoEncoderFFmpeg::ADM_coreVideoEncoderFFmpeg(ADM_coreVideoFilter *src,FFcodecSettings *set,bool globalHeader) 
                     : ADM_coreVideoEncoder(src)
 {
 uint32_t w,h;
@@ -111,6 +111,7 @@
     pass=0;
     statFileName=NULL;
     statFile=NULL;
+    _globalHeader=globalHeader;
     _isMT=false;
     encoderDelay=source->getInfo()->frameIncrement*LAVS(max_b_frames);
     ADM_info("[Lavcodec] Using a video encoder delay of %d ms\n",(int)(encoderDelay/1000));

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -76,7 +76,7 @@
 
 */
 
-AUDMEncoder_Aften::AUDMEncoder_Aften(AUDMAudioFilter * instream)  :ADM_AudioEncoder    (instream)
+AUDMEncoder_Aften::AUDMEncoder_Aften(AUDMAudioFilter * instream,bool globalHeader)  :ADM_AudioEncoder    (instream)
 {
   uint32_t channels;
   ADM_info("[Aften] Creating aften\n");
@@ -86,6 +86,7 @@
   aften_set_defaults(_HANDLE);
   wavheader.encoding=WAV_AC3;
   _HANDLE->system.n_threads=1;
+  _globalHeader= globalHeader;
 
 
   switch(channels)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/aften/audioencoder_aften.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -24,12 +24,13 @@
 protected:
          void           *_handle;
          uint32_t       _chunk;
+         bool           _globalHeader;
 
 public:
                 bool    initialize(void);
     virtual     bool    encode(uint8_t *dest, uint32_t *len, uint32_t *samples);
     virtual             ~AUDMEncoder_Aften();
-                        AUDMEncoder_Aften(AUDMAudioFilter *instream);
+                        AUDMEncoder_Aften(AUDMAudioFilter *instream,bool globalHeader);
 };
 #endif
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -59,10 +59,11 @@
 
 /******************* / Declare plugin*******************************************************/
 
-AUDMEncoder_Faac::AUDMEncoder_Faac(AUDMAudioFilter * instream)  :ADM_AudioEncoder    (instream)
+AUDMEncoder_Faac::AUDMEncoder_Faac(AUDMAudioFilter * instream,bool globalHeader)  :ADM_AudioEncoder    (instream)
 {
   uint32_t channels;
   channels=instream->getInfo()->channels;
+  _globalHeader=globalHeader;
   switch(channels)
   {
     case 1:outputChannelMapping[1] = ADM_CH_FRONT_LEFT;break;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -22,10 +22,11 @@
          void           *_handle;
          uint32_t        _chunk;
          uint8_t        refillBuffer(int minimum);
+         bool           _globalHeader;
 public:
                  bool   initialize(void);
     virtual             ~AUDMEncoder_Faac();
-                        AUDMEncoder_Faac(AUDMAudioFilter *instream);	
+                        AUDMEncoder_Faac(AUDMAudioFilter *instream,bool globalHeader);
     virtual bool	    encode(uint8_t *dest, uint32_t *len, uint32_t *samples);
 };
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -67,7 +67,7 @@
     \fn AUDMEncoder_Lame Constructor
     \brief
 */
-AUDMEncoder_Lame::AUDMEncoder_Lame (AUDMAudioFilter * instream):ADM_AudioEncoder  (instream)
+AUDMEncoder_Lame::AUDMEncoder_Lame (AUDMAudioFilter * instream,bool globalHeader):ADM_AudioEncoder  (instream)
 {
   printf ("[Lame] Creating lame\n");
   lameFlags = NULL;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -29,7 +29,7 @@
          
   public:
     virtual             ~AUDMEncoder_Lame();
-                        AUDMEncoder_Lame(AUDMAudioFilter *instream);	
+                        AUDMEncoder_Lame(AUDMAudioFilter *instream,bool globalHeader);	
             bool	    isVBR(void );
             
    virtual bool         encode(uint8_t *dest, uint32_t *len, uint32_t *samples);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -67,10 +67,11 @@
 /**
     \fn AUDMEncoder_Lavcodec
 */
-AUDMEncoder_Lavcodec::AUDMEncoder_Lavcodec(AUDMAudioFilter * instream)  :ADM_AudioEncoder    (instream)
+AUDMEncoder_Lavcodec::AUDMEncoder_Lavcodec(AUDMAudioFilter * instream,bool globalHeader)  :ADM_AudioEncoder    (instream)
 {
   
   _context=NULL;
+  _globalHeader=globalHeader;
    printf("[Lavcodec] Creating Lavcodec audio encoder (0x%x)\n",makeName(WAV));
 
   wavheader.encoding=makeName(WAV);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -21,12 +21,13 @@
    
     void              *_context;
     uint32_t            _chunk;
+    bool               _globalHeader;
     
          
   public:
             bool        initialize(void);
    virtual             ~AUDMEncoder_Lavcodec();
-                        AUDMEncoder_Lavcodec(AUDMAudioFilter *instream);	
+                        AUDMEncoder_Lavcodec(AUDMAudioFilter *instream,bool globalHeader);
    virtual bool  	    encode(uint8_t *dest, uint32_t *len, uint32_t *samples);
 };
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/pcm/audioencoder_pcm.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/pcm/audioencoder_pcm.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/pcm/audioencoder_pcm.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -61,7 +61,7 @@
 // Ctor: Duplicate
 //__________
 
-AUDMEncoder_PCM::AUDMEncoder_PCM(AUDMAudioFilter * instream)  :ADM_AudioEncoder    (instream)
+AUDMEncoder_PCM::AUDMEncoder_PCM(AUDMAudioFilter * instream,bool globalHeader)  :ADM_AudioEncoder    (instream)
 {
   printf("[PCM] Creating PCM\n");
   wavheader.encoding=WAV_PCM;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/pcm/audioencoder_pcm.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/pcm/audioencoder_pcm.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/pcm/audioencoder_pcm.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -29,7 +29,7 @@
                         /*! \param reverted : Should the endianness be reverted compared to system  
                             \param fourCC   : FourCC to use (WAV_PCM/WAV_LPCM)
                         */
-                         AUDMEncoder_PCM(AUDMAudioFilter * instream);
+                         AUDMEncoder_PCM(AUDMAudioFilter * instream,bool globalHeader);
    virtual bool         encode(uint8_t *dest, uint32_t *len, uint32_t *samples);
    virtual bool         initialize(void);
 };

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -62,7 +62,7 @@
 /**
 
 */
-AUDMEncoder_Twolame::AUDMEncoder_Twolame(AUDMAudioFilter * instream)  :ADM_AudioEncoder    (instream)
+AUDMEncoder_Twolame::AUDMEncoder_Twolame(AUDMAudioFilter * instream,bool globalHeader)  :ADM_AudioEncoder    (instream)
 {
   printf("[TwoLame] Creating Twolame\n");
   _twolameOptions=NULL;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/twolame/audioencoder_twolame.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/twolame/audioencoder_twolame.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/twolame/audioencoder_twolame.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -25,7 +25,7 @@
   public:
             bool     initialize(void);
     virtual             ~AUDMEncoder_Twolame();
-                        AUDMEncoder_Twolame(AUDMAudioFilter *instream);	
+                        AUDMEncoder_Twolame(AUDMAudioFilter *instream,bool globalHeader);
     virtual bool    encode(uint8_t *dest, uint32_t *len, uint32_t *samples);
     virtual bool    isVBR(void) {return false;}
 };

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/vorbis/audioencoder_vorbis.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/vorbis/audioencoder_vorbis.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/vorbis/audioencoder_vorbis.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -92,7 +92,7 @@
 
 //__________
 
-AUDMEncoder_Vorbis::AUDMEncoder_Vorbis(AUDMAudioFilter * instream)  :ADM_AudioEncoder    (instream)
+AUDMEncoder_Vorbis::AUDMEncoder_Vorbis(AUDMAudioFilter * instream,bool globalHeader)  :ADM_AudioEncoder    (instream)
 {
   printf("[Vorbis] Creating Vorbis\n");
   _handle=NULL;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/vorbis/audioencoder_vorbis.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/vorbis/audioencoder_vorbis.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/vorbis/audioencoder_vorbis.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -31,7 +31,7 @@
   public:
                     bool     initialize(void);
         virtual     ~AUDMEncoder_Vorbis();
-                    AUDMEncoder_Vorbis(AUDMAudioFilter *instream);	
+                    AUDMEncoder_Vorbis(AUDMAudioFilter *instream,bool globalHeader);
             
         virtual bool	encode(uint8_t *dest, uint32_t *len, uint32_t *samples);
 };

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -37,6 +37,7 @@
         virtual bool open(const char *file, ADM_videoStream *s,uint32_t nbAudioTrack,ADM_audioStream **a);
         virtual bool save(void) ;
         virtual bool close(void) ;
+        virtual     bool     useGlobalHeader(void) {return true;}
 
 };
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffFlv1/ADM_ffFlv1.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffFlv1/ADM_ffFlv1.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffFlv1/ADM_ffFlv1.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -83,7 +83,7 @@
 /**
         \fn ADM_ffFlv1Encoder
 */
-ADM_ffFlv1Encoder::ADM_ffFlv1Encoder(ADM_coreVideoFilter *src) : ADM_coreVideoEncoderFFmpeg(src,&Flv1Settings)
+ADM_ffFlv1Encoder::ADM_ffFlv1Encoder(ADM_coreVideoFilter *src,bool globalHeader) : ADM_coreVideoEncoderFFmpeg(src,&Flv1Settings,false)
 {
     printf("[ffFlv1] Creating.\n");
    

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffFlv1/ADM_ffFlv1.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffFlv1/ADM_ffFlv1.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffFlv1/ADM_ffFlv1.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -34,7 +34,7 @@
                
 public:
 
-                           ADM_ffFlv1Encoder(ADM_coreVideoFilter *src);
+                           ADM_ffFlv1Encoder(ADM_coreVideoFilter *src,bool globalHeader);
 virtual                    ~ADM_ffFlv1Encoder();
 virtual        bool        setup(void); 
 virtual        bool        encode (ADMBitstream * out);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg4/ADM_ffMpeg4.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg4/ADM_ffMpeg4.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg4/ADM_ffMpeg4.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -82,7 +82,7 @@
 /**
         \fn ADM_ffMpeg4Encoder
 */
-ADM_ffMpeg4Encoder::ADM_ffMpeg4Encoder(ADM_coreVideoFilter *src) : ADM_coreVideoEncoderFFmpeg(src,&Mp4Settings)
+ADM_ffMpeg4Encoder::ADM_ffMpeg4Encoder(ADM_coreVideoFilter *src,bool globalHeader) : ADM_coreVideoEncoderFFmpeg(src,&Mp4Settings,globalHeader)
 {
     printf("[ffMpeg4Encoder] Creating.\n");
    

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg4/ADM_ffMpeg4.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg4/ADM_ffMpeg4.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg4/ADM_ffMpeg4.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -34,7 +34,7 @@
                
 public:
 
-                           ADM_ffMpeg4Encoder(ADM_coreVideoFilter *src);
+                           ADM_ffMpeg4Encoder(ADM_coreVideoFilter *src,bool globalHeader);
 virtual                    ~ADM_ffMpeg4Encoder();
 virtual        bool        setup(void); 
 virtual        bool        encode (ADMBitstream * out);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMsMpeg4/ADM_ffMsMp4.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMsMpeg4/ADM_ffMsMp4.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMsMpeg4/ADM_ffMsMp4.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -83,7 +83,7 @@
 /**
         \fn ADM_ffMsMp4Encoder
 */
-ADM_ffMsMp4Encoder::ADM_ffMsMp4Encoder(ADM_coreVideoFilter *src) : ADM_coreVideoEncoderFFmpeg(src,&MsMp4Settings)
+ADM_ffMsMp4Encoder::ADM_ffMsMp4Encoder(ADM_coreVideoFilter *src,bool globalHeader) : ADM_coreVideoEncoderFFmpeg(src,&MsMp4Settings)
 {
     printf("[ffMsMP4] Creating.\n");
    

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMsMpeg4/ADM_ffMsMp4.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMsMpeg4/ADM_ffMsMp4.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMsMpeg4/ADM_ffMsMp4.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -34,7 +34,7 @@
                
 public:
 
-                           ADM_ffMsMp4Encoder(ADM_coreVideoFilter *src);
+                           ADM_ffMsMp4Encoder(ADM_coreVideoFilter *src,bool globalHeader);
 virtual                    ~ADM_ffMsMp4Encoder();
 virtual        bool        setup(void); 
 virtual        bool        encode (ADMBitstream * out);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -30,7 +30,7 @@
 /**
         \fn ADM_huffEncoder
 */
-ADM_huffEncoder::ADM_huffEncoder(ADM_coreVideoFilter *src) : ADM_coreVideoEncoderFFmpeg(src)
+ADM_huffEncoder::ADM_huffEncoder(ADM_coreVideoFilter *src,bool globalHeader) : ADM_coreVideoEncoderFFmpeg(src)
 {
     printf("[huffEncoder] Creating.\n");
     if(huffType.encoderType==ADM_HUFF_YUV)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -31,7 +31,7 @@
                int              plane;
 public:
 
-                           ADM_huffEncoder(ADM_coreVideoFilter *src);
+                           ADM_huffEncoder(ADM_coreVideoFilter *src,bool globalHeader);
                            ~ADM_huffEncoder();
 virtual        bool        setup(void); 
 virtual        bool        encode (ADMBitstream * out);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/jpeg/ADM_jpegEncoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/jpeg/ADM_jpegEncoder.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/jpeg/ADM_jpegEncoder.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -23,7 +23,7 @@
 /**
         \fn ADM_jpegEncoder
 */
-ADM_jpegEncoder::ADM_jpegEncoder(ADM_coreVideoFilter *src) : ADM_coreVideoEncoderFFmpeg(src)
+ADM_jpegEncoder::ADM_jpegEncoder(ADM_coreVideoFilter *src,bool globalHeader) : ADM_coreVideoEncoderFFmpeg(src)
 {
     printf("[jpegEncoder] Creating.\n");
     targetColorSpace=(ADM_colorspace)jpegConf.colorSpace;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/jpeg/ADM_jpegEncoder.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/jpeg/ADM_jpegEncoder.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/jpeg/ADM_jpegEncoder.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -31,7 +31,7 @@
                int              plane;
 public:
 
-                           ADM_jpegEncoder(ADM_coreVideoFilter *src);
+                           ADM_jpegEncoder(ADM_coreVideoFilter *src,bool globalHeader);
                            ~ADM_jpegEncoder();
 virtual        bool        setup(void); 
 virtual        bool        encode (ADMBitstream * out);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/png/ADM_pngEncoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/png/ADM_pngEncoder.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/png/ADM_pngEncoder.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -21,7 +21,7 @@
 /**
         \fn ADM_pngEncoder
 */
-ADM_pngEncoder::ADM_pngEncoder(ADM_coreVideoFilter *src) : ADM_coreVideoEncoder(src)
+ADM_pngEncoder::ADM_pngEncoder(ADM_coreVideoFilter *src,bool globalHeader) : ADM_coreVideoEncoder(src)
 {
     printf("[YV12Encoder] Creating.\n");
     int w,h;
@@ -58,4 +58,4 @@
     return true;
 }
 
-// EOF
\ No newline at end of file
+// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/png/ADM_pngEncoder.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/png/ADM_pngEncoder.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/png/ADM_pngEncoder.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -31,11 +31,11 @@
                int plane;
 public:
 
-                            ADM_pngEncoder(ADM_coreVideoFilter *src);
+                            ADM_pngEncoder(ADM_coreVideoFilter *src,bool globalHeader);
                             ~ADM_pngEncoder();
 virtual        bool         encode (ADMBitstream * out);
 virtual const  char         *getFourcc(void) {return "png ";}
 };
 
 
-#endif
\ No newline at end of file
+#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/yv12/ADM_yv12Encoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/yv12/ADM_yv12Encoder.cpp	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/yv12/ADM_yv12Encoder.cpp	2010-02-04 06:42:04 UTC (rev 5889)
@@ -21,7 +21,7 @@
 /**
         \fn ADM_yv12Encoder
 */
-ADM_yv12Encoder::ADM_yv12Encoder(ADM_coreVideoFilter *src) : ADM_coreVideoEncoder(src)
+ADM_yv12Encoder::ADM_yv12Encoder(ADM_coreVideoFilter *src,bool globalHeader) : ADM_coreVideoEncoder(src)
 {
     printf("[YV12Encoder] Creating.\n");
     int w,h;
@@ -58,4 +58,4 @@
     return true;
 }
 
-// EOF
\ No newline at end of file
+// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/yv12/ADM_yv12Encoder.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/yv12/ADM_yv12Encoder.h	2010-02-03 06:43:50 UTC (rev 5888)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/yv12/ADM_yv12Encoder.h	2010-02-04 06:42:04 UTC (rev 5889)
@@ -31,11 +31,11 @@
                int plane;
 public:
 
-                            ADM_yv12Encoder(ADM_coreVideoFilter *src);
+                            ADM_yv12Encoder(ADM_coreVideoFilter *src,bool globalHeader);
                             ~ADM_yv12Encoder();
 virtual        bool         encode (ADMBitstream * out);
 virtual const  char         *getFourcc(void) {return "YV12";}
 };
 
 
-#endif
\ No newline at end of file
+#endif



From mean at mail.berlios.de  Thu Feb  4 07:42:14 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 4 Feb 2010 07:42:14 +0100
Subject: [Avidemux-svn-commit] r5890 - in branches/avidemux_2.6_branch_mean:
	avidemux_core/ADM_coreMuxer/src
	avidemux_core/ADM_coreVideoEncoder/src
	avidemux_plugins/ADM_audioEncoders/lavcodec
Message-ID: <201002040642.o146gExg007950@sheep.berlios.de>

Author: mean
Date: 2010-02-04 07:42:13 +0100 (Thu, 04 Feb 2010)
New Revision: 5890

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/ADM_lav_aac.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
Log:
[encoder] Activate global header, incomplete

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-04 06:42:04 UTC (rev 5889)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-04 06:42:13 UTC (rev 5890)
@@ -134,6 +134,7 @@
         c->width = stream->getWidth();
         c->height =stream->getHeight();
         uint32_t fcc=stream->getFCC();
+        
         if(isMpeg4Compatible(fcc))
         {
                 c->codec_id = CODEC_ID_MPEG4;
@@ -216,8 +217,18 @@
                         }
                 }
         }
+        if(useGlobalHeader()==true)
+        {
+            if(videoExtraDataSize)
+            {
+                ADM_info("Video has extradata and muxer requires globalHeader, assuming it is done so.\n");
+                c->flags|=CODEC_FLAG_GLOBAL_HEADER;
+            }else       
+            {
+                ADM_warning("Video has no extradata but muxer requires globalHeader.\n");
+            }
+        }
 
-
         printf("[FF] Video initialized\n");
 
     return true;
@@ -287,7 +298,17 @@
           c->bit_rate = audioheader->byterate*8;
           c->rc_buffer_size=(c->bit_rate/(2*8)); // 500 ms worth
           c->channels = audioheader->channels;
-
+          if(useGlobalHeader()==true)
+          {
+            if(audioextraSize)
+            {
+                ADM_info("Audio has extradata and muxer requires globalHeader, assuming it is done so.\n");
+                c->flags|=CODEC_FLAG_GLOBAL_HEADER;
+            }else       
+            {
+                ADM_warning("Audio has no extradata but muxer requires globalHeader.\n");
+            }
+          }
         }
         printf("[FF] Audio initialized\n");
         return true;

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-04 06:42:04 UTC (rev 5889)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-04 06:42:13 UTC (rev 5890)
@@ -115,6 +115,11 @@
     _isMT=false;
     encoderDelay=source->getInfo()->frameIncrement*LAVS(max_b_frames);
     ADM_info("[Lavcodec] Using a video encoder delay of %d ms\n",(int)(encoderDelay/1000));
+    if(_globalHeader)
+    {
+                ADM_info("Codec configured to use global header\n");
+                _context->flags|=CODEC_FLAG_GLOBAL_HEADER;
+    }
 }
 /**
     \fn ADM_coreVideoEncoderFFmpeg

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/ADM_lav_aac.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/ADM_lav_aac.h	2010-02-04 06:42:04 UTC (rev 5889)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/ADM_lav_aac.h	2010-02-04 06:42:13 UTC (rev 5890)
@@ -8,3 +8,5 @@
 #define ADM_LAV_MAX_CHANNEL 6
 #define ADM_LAV_SAMPLE_PER_P 1024
 
+#define ADM_LAV_GLOBAL_HEADER 1
+

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2010-02-04 06:42:04 UTC (rev 5889)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2010-02-04 06:42:13 UTC (rev 5890)
@@ -73,6 +73,12 @@
   _context=NULL;
   _globalHeader=globalHeader;
    printf("[Lavcodec] Creating Lavcodec audio encoder (0x%x)\n",makeName(WAV));
+#if defined(ADM_LAV_GLOBAL_HEADER) // Only AAC ?
+    if(globalHeader)
+        _globalHeader=true;
+    else
+#endif
+    _globalHeader=false;
 
   wavheader.encoding=makeName(WAV);
   
@@ -110,15 +116,21 @@
   }
   wavheader.byterate=(lavBitrate*1000)>>3;         
       
-    _chunk = ADM_LAV_SAMPLE_PER_P*wavheader.channels; // AC3
+  _chunk = ADM_LAV_SAMPLE_PER_P*wavheader.channels; // AC3
   printf("[Lavcodec]Incoming : fq : %"LU", channel : %"LU" bitrate: %"LU" \n",
-         wavheader.frequency,wavheader.channels,lavBitrate);
+  wavheader.frequency,wavheader.channels,lavBitrate);
   
   
   CONTEXT->channels     =  wavheader.channels;
   CONTEXT->sample_rate  =  wavheader.frequency;
   CONTEXT->bit_rate     = (lavBitrate*1000); // bits -> kbits
 
+  if(true==_globalHeader)
+  {
+    ADM_info("Configuring audio codec to use global headers\n");
+    CONTEXT->flags|=CODEC_FLAG_GLOBAL_HEADER;
+  }
+
   AVCodec *codec;
   CodecID codecID;
 



From mean at mail.berlios.de  Thu Feb  4 19:22:33 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 4 Feb 2010 19:22:33 +0100
Subject: [Avidemux-svn-commit] r5891 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src
Message-ID: <201002041822.o14IMX0p027539@sheep.berlios.de>

Author: mean
Date: 2010-02-04 19:22:31 +0100 (Thu, 04 Feb 2010)
New Revision: 5891

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_bridge.cpp
Log:
[Bridge] Handle repeat (negative time offset) more gracelfully

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_bridge.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_bridge.cpp	2010-02-04 06:42:13 UTC (rev 5890)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_bridge.cpp	2010-02-04 18:22:31 UTC (rev 5891)
@@ -130,16 +130,6 @@
     {
       // don't ask too much front.
       asked = (3*AUD_PROCESS_BUFFER_SIZE)/4-_tail;
-      if(_hold)
-      {
-        int32_t sam;
-         
-        sam=_hold/_wavHeader.channels;
-        sam++;
-        sam*=_wavHeader.channels;
-        if(asked>sam) asked=sam;
-        
-      }
       asked/=_wavHeader.channels; // float->samples
       _incoming->getPCMPacket(&(_incomingBuffer[_tail]), asked, &got,&dts);
       got*=_wavHeader.channels; // sample->float
@@ -160,8 +150,9 @@
         if(_hold<=0)
         {
           printf("[Bridge] Looping\n");
+          _hold=-_hold;
+          _tail-=_hold;
           rewind();
-          //_tail=_head=0;
           _hold=0;
         }
       }



From mean at mail.berlios.de  Thu Feb  4 19:22:37 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 4 Feb 2010 19:22:37 +0100
Subject: [Avidemux-svn-commit] r5892 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src
Message-ID: <201002041822.o14IMbbb027603@sheep.berlios.de>

Author: mean
Date: 2010-02-04 19:22:37 +0100 (Thu, 04 Feb 2010)
New Revision: 5892

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
Log:
[ffVideoEncoder] Free codec only if it has been allocated

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-04 18:22:31 UTC (rev 5891)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-04 18:22:37 UTC (rev 5892)
@@ -61,26 +61,12 @@
             return true;
         }
     }
-    // Else try to squish it to low value..
-    int base=1000000; // value is in us
-    while(!( useconds % 9)&& useconds)
-    {
-        base/=10;
-        useconds/=10;
-    }
-    // Then try 2 and 5
-    while(!( useconds &1)&& useconds)
-    {
-        base/=2;
-        useconds/=2;
-    }
-    while(!( useconds %5)&& useconds)
-    {
-        base/=5;
-        useconds/=5;
-    }
-    *n=useconds;
-    *d=base;
+    int nn,dd;
+    av_reduce(&nn,&dd, useconds, 1000000, 0xFFF0); // mpeg4 allows a maximum of 1<<16-1 as time base, should be enough for most case
+    ADM_info("%"LLU" us -> %d / %d (old)\n",useconds,nn,dd);
+    *n=nn;
+    *d=dd;
+
     return true;
 }
 /**
@@ -135,6 +121,7 @@
           avcodec_thread_free (_context);
           _isMT = false;
         }
+        if(_context->codec)
         avcodec_close (_context);
         ADM_dealloc (_context);
         _context = NULL;



From mean at mail.berlios.de  Thu Feb  4 19:22:42 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 4 Feb 2010 19:22:42 +0100
Subject: [Avidemux-svn-commit] r5893 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <201002041822.o14IMgYY027622@sheep.berlios.de>

Author: mean
Date: 2010-02-04 19:22:41 +0100 (Thu, 04 Feb 2010)
New Revision: 5893

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp
Log:
[editor] Use our new js syntax to save audio filters

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp	2010-02-04 18:22:37 UTC (rev 5892)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edLoadSave.cpp	2010-02-04 18:22:41 UTC (rev 5893)
@@ -205,7 +205,7 @@
 
 
     uint32_t x=audioFilterGetResample();
-    if(x) qfprintf(fd,"app.audioResample=%u;\n",audioFilterGetResample());
+    if(x) qfprintf(fd,"adm.audioResample=%u;\n",audioFilterGetResample());
 
     
 //   qfprintf(fd,"app.audio.normalizeMode=%d;\n",audioGetNormalizeMode());
@@ -213,7 +213,7 @@
 //   qfprintf(fd,"app.audio.delay=%d;\n",audioGetDelay());
 // if (audioGetDrc()) qfprintf(fd,"app.audio.drc=true;\n");
    if(CHANNEL_INVALID!=audioFilterGetMixer())
-        qfprintf(fd,"app.audioMixer(\"%s\");\n",AudioMixerIdToString(audioFilterGetMixer()));
+        qfprintf(fd,"adm.audioMixer(\"%s\");\n",AudioMixerIdToString(audioFilterGetMixer()));
 
    
 
@@ -221,8 +221,8 @@
         switch(audioFilterGetFrameRate())
         {
                 case FILMCONV_NONE:      ;break;
-                case FILMCONV_PAL2FILM:  qfprintf(fd,"app.audioPal2film=1;\n");break;
-                case FILMCONV_FILM2PAL:  qfprintf(fd,"app.audioFilm2pal=1;\n");break;
+                case FILMCONV_PAL2FILM:  qfprintf(fd,"adm.audioPal2film=1;\n");break;
+                case FILMCONV_FILM2PAL:  qfprintf(fd,"adm.audioFilm2pal=1;\n");break;
                 default:ADM_assert(0);
         }
    
@@ -243,7 +243,7 @@
   if(outputname)
   {
         char *o=ADM_cleanupPath(outputname);
-        qfprintf(fd,"setSuccess(app.save(\"%s\"));\n",o);
+        qfprintf(fd,"setSuccess(adm.save(\"%s\"));\n",o);
         ADM_dealloc(o);
   }
   else
@@ -251,7 +251,7 @@
         qfprintf(fd,"setSuccess(%d);\n",1);
   }
 
-  qfprintf(fd,"//app.Exit();\n");
+  qfprintf(fd,"//adm.Exit();\n");
   qfprintf(fd,"\n//End of script\n");
   // All done
   qfclose (fd);



From mean at mail.berlios.de  Sat Feb  6 11:03:17 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 6 Feb 2010 11:03:17 +0100
Subject: [Avidemux-svn-commit] r5894 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src
Message-ID: <201002061003.o16A3HXa001780@sheep.berlios.de>

Author: mean
Date: 2010-02-06 11:03:17 +0100 (Sat, 06 Feb 2010)
New Revision: 5894

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
Log:
[lavc] Fix extradata for mpeg4, will crash else

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2010-02-04 18:22:41 UTC (rev 5893)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2010-02-06 10:03:17 UTC (rev 5894)
@@ -340,7 +340,16 @@
     _context->reordered_opaque=in->demuxerPts;
   //_frame.opaque=(void *)out->Pts;
   //printf("Incoming Pts :%"LLD"\n",out->Pts);
-  ret = avcodec_decode_video (_context, &_frame, &got_picture, in->data, in->dataLength);
+  AVPacket pkt;
+  av_init_packet(&pkt);
+  pkt.data=in->data;
+  pkt.size=in->dataLength;
+  if(in->flags&AVI_KEY_FRAME)
+    pkt.flags=AV_PKT_FLAG_KEY;
+  else
+    pkt.flags=0;
+  
+  ret = avcodec_decode_video2 (_context, &_frame, &got_picture, &pkt);
   if(!bFramePossible())
   {
     // No delay, the value is sure, no need to hide it in opaque
@@ -458,8 +467,8 @@
   ADM_info ("[lavc] Using %d bytes of extradata for MPEG4 decoder\n", (int)extraDataLen);
   
   _refCopy = 1;			// YUV420 only
-  _context->extradata = (uint8_t *) extraDataLen;
-  _context->extradata_size = (int) extraDataLen;
+  _context->extradata = (uint8_t *) extraData;
+  _context->extradata_size = (int)extraDataLen  ;
   _context->codec_tag=fcc;
   _context->stream_codec_tag=fcc;
   decoderMultiThread ();



From mean at mail.berlios.de  Sat Feb  6 11:03:19 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 6 Feb 2010 11:03:19 +0100
Subject: [Avidemux-svn-commit] r5895 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include
Message-ID: <201002061003.o16A3JXx001790@sheep.berlios.de>

Author: mean
Date: 2010-02-06 11:03:18 +0100 (Sat, 06 Feb 2010)
New Revision: 5895

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoProcess.h
Log:
[videoEncoding] When we encode, we always have a valid PTS

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoProcess.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoProcess.h	2010-02-06 10:03:17 UTC (rev 5894)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/include/ADM_videoProcess.h	2010-02-06 10:03:18 UTC (rev 5895)
@@ -40,7 +40,7 @@
 virtual     bool     getPacket(uint32_t *len, uint8_t *data, uint32_t maxLen,uint64_t *pts,uint64_t *dts,
                                     uint32_t *flags);
 virtual     bool     getExtraData(uint32_t *extraLen, uint8_t **extraData) ;
-virtual     bool     providePts(void) {return false;}
+virtual     bool     providePts(void) {return true;}
 virtual     uint64_t getVideoDuration(void);
 virtual     bool     isDualPass(void) { ADM_assert(encoder);return encoder->isDualPass();}
 ADM_coreVideoEncoder *getEncoder(void) {return encoder;}



From mean at mail.berlios.de  Sat Feb  6 11:03:20 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 6 Feb 2010 11:03:20 +0100
Subject: [Avidemux-svn-commit] r5896 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src
Message-ID: <201002061003.o16A3KqE001800@sheep.berlios.de>

Author: mean
Date: 2010-02-06 11:03:19 +0100 (Sat, 06 Feb 2010)
New Revision: 5896

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
Log:
[ffMuxer] Warn if we dont have PTS

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-06 10:03:18 UTC (rev 5895)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-06 10:03:19 UTC (rev 5896)
@@ -144,6 +144,7 @@
                     c->max_b_frames=2;
                 }else
                 {
+                    ADM_warning("Incoming stream does not provide PTS \n");
                     c->has_b_frames=0; // No PTS=cannot handle CTS...
                     c->max_b_frames=0;
                 }



From mean at mail.berlios.de  Sat Feb  6 11:03:21 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 6 Feb 2010 11:03:21 +0100
Subject: [Avidemux-svn-commit] r5897 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder:
	include src
Message-ID: <201002061003.o16A3LQe001812@sheep.berlios.de>

Author: mean
Date: 2010-02-06 11:03:21 +0100 (Sat, 06 Feb 2010)
New Revision: 5897

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
Log:
[lavVideoEncoder] Try to compute a valid dts/pts pair when encoding using ffmpeg, subooptimal

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h	2010-02-06 10:03:19 UTC (rev 5896)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h	2010-02-06 10:03:21 UTC (rev 5897)
@@ -43,6 +43,7 @@
                bool             _isMT; // True if multithreaded
                uint64_t         nextDts;
                bool             _globalHeader;
+               float            timeScaler;
 protected:
     virtual               bool             prolog(void); 
     virtual               bool             preEncode(void); 
@@ -53,6 +54,8 @@
     virtual               bool             setPassAndLogFile(int pass,const char *name); // Call this before setup if needed !
                           bool             setupPass(void);  
                           bool             encoderMT (void);
+                          int64_t          timingToLav(uint64_t val);
+                          uint64_t         lavToTiming(int64_t val);
 public:
                                             ADM_coreVideoEncoderFFmpeg(ADM_coreVideoFilter *src,FFcodecSettings *settings=NULL,bool globalHeader=false);
 virtual                                     ~ADM_coreVideoEncoderFFmpeg();

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-06 10:03:19 UTC (rev 5896)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-06 10:03:21 UTC (rev 5897)
@@ -187,10 +187,27 @@
     _context->time_base.num=n;
     _context->time_base.den=d;
 #endif
-    
+    timeScaler=1000000.*av_q2d(_context->time_base); // Optimize, can be computed once
     return true;
 }
 /**
+    \fn ADM_coreVideoEncoderFFmpeg
+*/
+int64_t          ADM_coreVideoEncoderFFmpeg::timingToLav(uint64_t val)
+{
+  int64_t v= floor( ((float)val+timeScaler/2.) /timeScaler);    
+  return v;
+}
+/**
+    \fn lavToTiming
+*/
+uint64_t         ADM_coreVideoEncoderFFmpeg::lavToTiming(int64_t val)
+{
+    float v=(float)val;
+    return floor(v*timeScaler);
+}
+
+/**
     \fn pre-encoder
     
 */
@@ -205,11 +222,12 @@
     }
     prolog();
 
-    double p=image->Pts;
+    uint64_t p=image->Pts;
     nextDts=image->Pts;
     p+=getEncoderDelay();
-    _frame.pts= floor(p / (1000000.*av_q2d(_context->time_base) + 0.5));    //
+    _frame.pts= timingToLav(p);    //
     if(!_frame.pts) _frame.pts=AV_NOPTS_VALUE;
+    aprintf("Codec> incoming pts=%"LLU"\n",image->Pts);
     //printf("--->>[PTS] :%"LLU", raw %"LLU" num:%"LU" den:%"LU"\n",_frame.pts,image->Pts,_context->time_base.num,_context->time_base.den);
     //
     switch(targetColorSpace)
@@ -360,9 +378,27 @@
     
     // Update PTS/Dts
 
-    out->pts= _context->coded_frame->pts * 1000000.*av_q2d(_context->time_base);
-    out->dts=nextDts; // FIXME
-    aprintf("Out pts=%"LLU" us\n",out->pts);    
+    out->pts= lavToTiming(_context->coded_frame->pts);
+// Since we will buffer frame, we have to minus that from dts
+// which is in fact the pts of the currently encoded frame
+    uint64_t preDts;
+    uint64_t preDtsScaled;
+    if(nextDts>=getEncoderDelay())
+    {
+        preDts=nextDts-getEncoderDelay(); 
+     }
+    else                                    
+    {
+        preDts=0;
+    }
+#warning simplify
+    float scale=1000000.*av_q2d(_context->time_base);
+    printf("PreDts=%"LLU"\n",preDts);
+    preDtsScaled=timingToLav(preDts);
+    preDts=lavToTiming(preDtsScaled);
+    printf("preDtsScaled=%"LLU"\n",(uint64_t)preDtsScaled);
+    out->dts=(uint64_t)preDts;
+    printf("Codec>Out pts=%"LLU" us, out Dts=%"LLU"\n",out->pts,out->dts);    
 
     // Update quant
     if(!_context->coded_frame->quality)



From mean at mail.berlios.de  Sat Feb  6 11:03:24 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 6 Feb 2010 11:03:24 +0100
Subject: [Avidemux-svn-commit] r5899 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src
Message-ID: <201002061003.o16A3Om8001837@sheep.berlios.de>

Author: mean
Date: 2010-02-06 11:03:24 +0100 (Sat, 06 Feb 2010)
New Revision: 5899

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_paramList.cpp
Log:
[paramList] Fix buffer overflow

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_paramList.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_paramList.cpp	2010-02-06 10:03:22 UTC (rev 5898)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_paramList.cpp	2010-02-06 10:03:24 UTC (rev 5899)
@@ -58,12 +58,12 @@
     {
         if(*s!=':')
         {
-            ADM_error("Bad split :%s insteald of ':'\n",s);
+            ADM_error("Bad split :%s instead of ':'\n",s);
             delete [] couples;
             return false;
         }
         n=s+1;
-        while(*n!=':') n++;
+        while(*n!=':' && *n) n++;
         n--;
         memcpy(tmp,s+1,n-s);
         tmp[n-s]=0;       



From mean at mail.berlios.de  Sat Feb  6 11:03:23 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 6 Feb 2010 11:03:23 +0100
Subject: [Avidemux-svn-commit] r5898 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder:
	include src
Message-ID: <201002061003.o16A3Naq001825@sheep.berlios.de>

Author: mean
Date: 2010-02-06 11:03:22 +0100 (Sat, 06 Feb 2010)
New Revision: 5898

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
Log:
[ffVideoEncoder] More accurate PTS/DTS

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h	2010-02-06 10:03:21 UTC (rev 5897)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h	2010-02-06 10:03:22 UTC (rev 5898)
@@ -23,6 +23,15 @@
 #include "ADM_encoderConf.h"
 #include "ADM_coreVideoEncoderFFmpeg_param.h"
 #include "FFcodecSettings.h"
+
+#include <vector>
+using std::vector;
+typedef struct
+{
+    uint64_t lavTS;
+    uint64_t realTS;
+}ADM_timeMapping;
+
 /**
     \class ADM_coreVideoEncoderFFmpeg
     \brief base class for VideoEncoder based on libavcodec
@@ -44,6 +53,8 @@
                uint64_t         nextDts;
                bool             _globalHeader;
                float            timeScaler;
+               vector <ADM_timeMapping>mapper;
+               uint64_t         getRealPtsFromLav(uint64_t val);
 protected:
     virtual               bool             prolog(void); 
     virtual               bool             preEncode(void); 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-06 10:03:21 UTC (rev 5897)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-06 10:03:22 UTC (rev 5898)
@@ -227,6 +227,12 @@
     p+=getEncoderDelay();
     _frame.pts= timingToLav(p);    //
     if(!_frame.pts) _frame.pts=AV_NOPTS_VALUE;
+
+    ADM_timeMapping map; // Store real PTS <->lav value mapping
+    map.realTS=p;
+    map.lavTS=_frame.pts;
+    mapper.push_back(map);
+
     aprintf("Codec> incoming pts=%"LLU"\n",image->Pts);
     //printf("--->>[PTS] :%"LLU", raw %"LLU" num:%"LU" den:%"LU"\n",_frame.pts,image->Pts,_context->time_base.num,_context->time_base.den);
     //
@@ -356,6 +362,27 @@
   return true;
 }
 /**
+    \fn getRealPtsFromLav
+    \brief Lookup in the stored value to get the exact pts from the truncated one from lav
+*/
+uint64_t ADM_coreVideoEncoderFFmpeg::getRealPtsFromLav(uint64_t val)
+{
+    int n=mapper.size();
+    for(int i=0;i<n;i++)
+    {
+        if(mapper[i].lavTS==val)
+        {
+            uint64_t r=mapper[i].realTS;
+            mapper.erase(mapper.begin()+i);
+            return r;
+        }
+    }
+    ADM_warning("Cannot find PTS : %"LLU"\n",val);  
+    for(int i=0;i<n;i++) ADM_warning("%d : %"LLU"\n",i,mapper[i].lavTS);
+    ADM_assert(0);
+
+}
+/**
         \fn postEncode
         \brief update bitstream info from output of lavcodec
 */
@@ -378,11 +405,10 @@
     
     // Update PTS/Dts
 
-    out->pts= lavToTiming(_context->coded_frame->pts);
+    out->pts= getRealPtsFromLav(_context->coded_frame->pts);
 // Since we will buffer frame, we have to minus that from dts
 // which is in fact the pts of the currently encoded frame
     uint64_t preDts;
-    uint64_t preDtsScaled;
     if(nextDts>=getEncoderDelay())
     {
         preDts=nextDts-getEncoderDelay(); 
@@ -392,13 +418,8 @@
         preDts=0;
     }
 #warning simplify
-    float scale=1000000.*av_q2d(_context->time_base);
-    printf("PreDts=%"LLU"\n",preDts);
-    preDtsScaled=timingToLav(preDts);
-    preDts=lavToTiming(preDtsScaled);
-    printf("preDtsScaled=%"LLU"\n",(uint64_t)preDtsScaled);
-    out->dts=(uint64_t)preDts;
-    printf("Codec>Out pts=%"LLU" us, out Dts=%"LLU"\n",out->pts,out->dts);    
+    out->dts=preDts;
+    aprintf("Codec>Out pts=%"LLU" us, out Dts=%"LLU"\n",out->pts,out->dts);    
 
     // Update quant
     if(!_context->coded_frame->quality)



From mean at mail.berlios.de  Sat Feb  6 11:03:25 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 6 Feb 2010 11:03:25 +0100
Subject: [Avidemux-svn-commit] r5900 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src
Message-ID: <201002061003.o16A3Put001847@sheep.berlios.de>

Author: mean
Date: 2010-02-06 11:03:25 +0100 (Sat, 06 Feb 2010)
New Revision: 5900

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter.cpp
Log:
[audioFilter] Speed up deletion

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter.cpp	2010-02-06 10:03:24 UTC (rev 5899)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter.cpp	2010-02-06 10:03:25 UTC (rev 5900)
@@ -154,11 +154,13 @@
 */
 bool ADM_emptyFilterChain(VectorOfAudioFilter *vec)
 {
-   while(vec->size())
+    int nb=vec->size();
+    for(int i=0;i<nb;i++) 
     {
-        delete (*vec)[0];
-        vec->erase(vec->begin());
+        delete (*vec)[i];
+        (*vec)[i]=NULL;
     }
+    vec->clear();
     return true;
 }
 /**



From mean at mail.berlios.de  Sat Feb  6 11:03:28 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 6 Feb 2010 11:03:28 +0100
Subject: [Avidemux-svn-commit] r5901 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <201002061003.o16A3SkP001857@sheep.berlios.de>

Author: mean
Date: 2010-02-06 11:03:27 +0100 (Sat, 06 Feb 2010)
New Revision: 5901

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
Log:
[save] Cleanup, delete audio and video. Audio is not completly deleted

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2010-02-06 10:03:25 UTC (rev 5900)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2010-02-06 10:03:27 UTC (rev 5901)
@@ -341,6 +341,13 @@
         muxer->save();
         muxer->close();
     }
+    delete video;
+    video=NULL;
+    for(int i=0;i<nbAStream;i++)
+    {
+        delete astreams[i];
+        astreams[i]=NULL;
+    }
     return true;
 }
 //EOF



From mean at mail.berlios.de  Sat Feb  6 15:00:46 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 6 Feb 2010 15:00:46 +0100
Subject: [Avidemux-svn-commit] r5902 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src
Message-ID: <201002061400.o16E0kBQ005145@sheep.berlios.de>

Author: mean
Date: 2010-02-06 15:00:46 +0100 (Sat, 06 Feb 2010)
New Revision: 5902

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_thread.cpp
Log:
[audioThread] Avoid deadlock when stopping encoding thread

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_thread.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_thread.cpp	2010-02-06 10:03:27 UTC (rev 5901)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_thread.cpp	2010-02-06 14:00:46 UTC (rev 5902)
@@ -195,6 +195,7 @@
             int n=list.size();
             if(n<MAX_CHUNK_IN_QUEUE) break;
             ADM_usleep(20*1000); // Fixme: replace by thread signals
+            if(threadState==RunStateStopOrder) goto theEnd;
         }
             
     }



From mean at mail.berlios.de  Sat Feb  6 15:00:48 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 6 Feb 2010 15:00:48 +0100
Subject: [Avidemux-svn-commit] r5903 - in branches/avidemux_2.6_branch_mean:
	avidemux/common/ADM_audioFilter/src
	avidemux_core/ADM_coreAudio/include
Message-ID: <201002061400.o16E0m6v005155@sheep.berlios.de>

Author: mean
Date: 2010-02-06 15:00:47 +0100 (Sat, 06 Feb 2010)
New Revision: 5903

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_encoder.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStream.h
Log:
[audioChain] Fix 2 memleak

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_encoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_encoder.cpp	2010-02-06 14:00:46 UTC (rev 5902)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_encoder.cpp	2010-02-06 14:00:47 UTC (rev 5903)
@@ -31,7 +31,40 @@
 //
  extern bool ADM_buildFilterChain(VectorOfAudioFilter *vec,ADM_AUDIOFILTER_CONFIG *config);
  extern bool ADM_emptyFilterChain(VectorOfAudioFilter *vec);
-
+/**
+    \class ADM_audioStream_autoDelete
+*/
+class ADM_audioStream_autoDelete: public ADM_audioStream
+{
+    protected:
+                        ADM_audioStream *son;
+                        ADM_audioAccess *access;
+        public:
+                        ADM_audioStream_autoDelete(ADM_audioStream *s,ADM_audioAccess *access)
+                        :    ADM_audioStream(s->getInfo(),access)
+                        {
+                                this->access=access;
+                                son=s;
+                        }
+                        ~ADM_audioStream_autoDelete()
+                        {
+                                ADM_info("Killing son audioStream\n");
+                                delete son;
+                                son=NULL;
+                                ADM_info("Killing son audioAccess\n");
+                                delete access;
+                                access=NULL;
+                        }
+virtual                 WAVHeader                *getInfo(void) {return son->getInfo();}
+virtual uint8_t         getPacket(uint8_t *buffer,uint32_t *size, uint32_t sizeMax,uint32_t *nbSample,uint64_t *dts)
+                        {
+                                return son->getPacket(buffer,size,sizeMax,nbSample,dts);
+                        }
+virtual bool            goToTime(uint64_t nbUs) {return son->goToTime(nbUs);};
+virtual bool            getExtraData(uint32_t *l, uint8_t **d) {return son->getExtraData(l,d);};
+        uint64_t        getDurationInUs(void) {return son->getDurationInUs();}
+};
+//************************************************
 extern ADM_audioAccess *ADM_threadifyAudioAccess(ADM_audioAccess *son);
 /**
         \fn createPlaybackFilter
@@ -103,7 +136,7 @@
     }
     // 3b create threaded version
     ADM_audioAccess *threaded=ADM_threadifyAudioAccess(access);
-    // 4- Create Stream // MEMLEAK!!!!
+    // 4- Create Stream 
     ADM_audioStream *stream=ADM_audioCreateStream(encoder->getInfo(), threaded);
     if(!stream)
     {
@@ -111,6 +144,7 @@
         delete threaded; // Access will destroy filter & encoder
         return NULL;
     }
-    return stream;
+    ADM_audioStream_autoDelete *autoDelete=new ADM_audioStream_autoDelete(stream, threaded);
+    return autoDelete;
 }
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStream.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStream.h	2010-02-06 14:00:46 UTC (rev 5902)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStream.h	2010-02-06 14:00:47 UTC (rev 5903)
@@ -87,6 +87,7 @@
         public:
 /// Default constructor
                        ADM_audioStream(WAVHeader *header,ADM_audioAccess *access);  
+              virtual  ~ADM_audioStream() {}
 /// Returns wavheader
 virtual                 WAVHeader                *getInfo(void) {return &wavHeader;}
 ///  Get a packet



From mean at mail.berlios.de  Sun Feb  7 09:58:59 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 09:58:59 +0100
Subject: [Avidemux-svn-commit] r5904 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer:
	include src
Message-ID: <201002070858.o178wxKQ027143@sheep.berlios.de>

Author: mean
Date: 2010-02-07 09:58:57 +0100 (Sun, 07 Feb 2010)
New Revision: 5904

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
Log:
[muxer] Handle video encoding delay for lavformat derivated muxers

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h	2010-02-06 14:00:47 UTC (rev 5903)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h	2010-02-07 08:58:57 UTC (rev 5904)
@@ -54,6 +54,8 @@
         {
             return muxerRescaleVideoTime(time);
         }
+        uint64_t audioDelay; // since video decoder can cause a delay, we have to delay also all audio tracks
+                             // by this value. It will be 0 for copy or 0 bframe codec.
 protected:
         bool saveLoop(const char *title);
 protected:

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-06 14:00:47 UTC (rev 5903)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-07 08:58:57 UTC (rev 5904)
@@ -36,6 +36,7 @@
     oc=NULL;
     audio_st=NULL;
     video_st=NULL;
+    audioDelay=0;
 }
 /**
     \fn closeMuxer
@@ -103,6 +104,7 @@
 */
 bool muxerFFmpeg::initVideo(ADM_videoStream *stream)
 {
+    audioDelay=stream->getVideoDelay();
     video_st = av_new_stream(oc, 0);
 	if (!video_st)
 	{
@@ -445,6 +447,8 @@
                         }
                        // printf("Track %d , new audio packet DTS=%"LLD" size=%"LU"\n",audioTrack->dts,audioTrack->size);
                         audioTrack->present=true;
+                        // Delay audio by the delay induce by encoder
+                        if(audioTrack->dts!=ADM_NO_PTS) audioTrack->dts+=audioDelay;
                     }
                     if(audioTrack->dts!=ADM_NO_PTS)
                     {



From mean at mail.berlios.de  Sun Feb  7 09:59:00 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 09:59:00 +0100
Subject: [Avidemux-svn-commit] r5905 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi
Message-ID: <201002070859.o178x0e3027155@sheep.berlios.de>

Author: mean
Date: 2010-02-07 09:59:00 +0100 (Sun, 07 Feb 2010)
New Revision: 5905

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.h
Log:
[muxer] Handle video encoding delay for avi muxer (incomplete)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp	2010-02-07 08:58:57 UTC (rev 5904)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp	2010-02-07 08:59:00 UTC (rev 5905)
@@ -71,7 +71,7 @@
 
 bool muxerAvi::open(const char *file, ADM_videoStream *s,uint32_t nbAudioTrack,ADM_audioStream **a)
 {
-
+        audioDelay=s->getVideoDelay();
         if(!writter.saveBegin (
              file,
 		     s,
@@ -88,7 +88,7 @@
         clocks=new audioClock*[nbAStreams];
         for(int i=0;i<nbAStreams;i++)
             clocks[i]=new audioClock(a[i]->getInfo()->frequency);
-
+        
         return true;
 }
 /**
@@ -109,6 +109,7 @@
 
                 while(a->getPacket(audioBuffer,&audioSize, AUDIO_BUFFER_SIZE,&nbSample,&audioDts))
                 {
+                    if(audioDts!=ADM_NO_DTS) audioDts+=audioDelay;
                     aprintf("[Audio] Packet size %"LU" sample:%"LU" dts:%"LLU" target :%"LLU"\n",audioSize,nbSample,audioDts,targetDts);
                     if(audioDts!=ADM_NO_PTS)
                         if( abs(audioDts-clk->getTimeUs())>32000)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.h	2010-02-07 08:58:57 UTC (rev 5904)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.h	2010-02-07 08:59:00 UTC (rev 5905)
@@ -38,6 +38,7 @@
         uint8_t   *audioBuffer;
         uint8_t   *videoBuffer;
         audioClock **clocks;
+        uint64_t   audioDelay;
 public:
                 muxerAvi();
         virtual ~muxerAvi();



From mean at mail.berlios.de  Sun Feb  7 09:59:02 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 09:59:02 +0100
Subject: [Avidemux-svn-commit] r5906 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat
Message-ID: <201002070859.o178x295027165@sheep.berlios.de>

Author: mean
Date: 2010-02-07 09:59:01 +0100 (Sun, 07 Feb 2010)
New Revision: 5906

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat/matroskaenc.c
Log:
[matroskaMuxer] Silence spam

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat/matroskaenc.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat/matroskaenc.c	2010-02-07 08:59:00 UTC (rev 5905)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat/matroskaenc.c	2010-02-07 08:59:01 UTC (rev 5906)
@@ -783,10 +783,11 @@
                      s->streams[pkt->stream_index]->nb_frames++, layer);
         size = FFMIN(i+size, sizeof(buffer));
         memcpy(buffer+i, start, size-i);
-
+#if 0 // MEANX
         av_log(s, AV_LOG_DEBUG, "Writing block at offset %" PRIu64 ", size %d, "
                "pts %" PRId64 ", duration %d\n",
                url_ftell(pb), size, pkt->pts, duration);
+#endif
         blockgroup = start_ebml_master(pb, MATROSKA_ID_BLOCKGROUP, mkv_blockgroup_size(size));
         put_ebml_id(pb, MATROSKA_ID_BLOCK);
         put_ebml_num(pb, size+4, 0);
@@ -811,10 +812,11 @@
     AVCodecContext *codec = s->streams[pkt->stream_index]->codec;
     uint8_t *data = NULL;
     int size = pkt->size;
-
-    av_log(s, AV_LOG_DEBUG, "Writing block at offset %" PRIu64 ", size %d, "
-           "pts %" PRId64 ", dts %" PRId64 ", duration %d, flags %d\n",
+#if 0 // MEANX
+    av_log(s, AV_LOG_DEBUG, "%u Writing block at offset %" PRIu64 ", size %d, "
+           "pts %" PRId64 ", dts %" PRId64 ", duration %d, flags %d\n",blockid,
            url_ftell(pb), pkt->size, pkt->pts, pkt->dts, pkt->duration, flags);
+#endif
     if (codec->codec_id == CODEC_ID_H264 && codec->extradata_size > 0 &&
         (AV_RB24(codec->extradata) == 1 || AV_RB32(codec->extradata) == 1))
         ff_avc_parse_nal_units_buf(pkt->data, &data, &size);



From mean at mail.berlios.de  Sun Feb  7 09:59:03 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 09:59:03 +0100
Subject: [Avidemux-svn-commit] r5907 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi
Message-ID: <201002070859.o178x3dW027178@sheep.berlios.de>

Author: mean
Date: 2010-02-07 09:59:03 +0100 (Sun, 07 Feb 2010)
New Revision: 5907

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp
Log:
[Avi] Buggy support for video encoder delay

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp	2010-02-07 08:59:01 UTC (rev 5906)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/muxerAvi.cpp	2010-02-07 08:59:03 UTC (rev 5907)
@@ -109,7 +109,7 @@
 
                 while(a->getPacket(audioBuffer,&audioSize, AUDIO_BUFFER_SIZE,&nbSample,&audioDts))
                 {
-                    if(audioDts!=ADM_NO_DTS) audioDts+=audioDelay;
+                    if(audioDts!=ADM_NO_PTS) audioDts+=audioDelay;
                     aprintf("[Audio] Packet size %"LU" sample:%"LU" dts:%"LLU" target :%"LLU"\n",audioSize,nbSample,audioDts,targetDts);
                     if(audioDts!=ADM_NO_PTS)
                         if( abs(audioDts-clk->getTimeUs())>32000)



From mean at mail.berlios.de  Sun Feb  7 09:59:04 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 09:59:04 +0100
Subject: [Avidemux-svn-commit] r5908 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder:
	. ffMpeg2
Message-ID: <201002070859.o178x4UK027190@sheep.berlios.de>

Author: mean
Date: 2010-02-07 09:59:04 +0100 (Sun, 07 Feb 2010)
New Revision: 5908

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ffMpeg2Plugin.cpp
Log:
[videoEncoder] Simple import of mpeg2 encoder based on ffmpeg

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp	2010-02-07 08:59:03 UTC (rev 5907)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp	2010-02-07 08:59:04 UTC (rev 5908)
@@ -0,0 +1,313 @@
+/***************************************************************************
+                          \fn ADM_ffMpeg2
+                          \brief Front end for libavcodec Mpeg2 asp encoder
+                             -------------------
+    
+    copyright            : (C) 2002/2009 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_lavcodec.h"
+#include "ADM_default.h"
+#include "ADM_ffMpeg2.h"
+#undef ADM_MINIMAL_UI_INTERFACE // we need the full UI
+#include "DIA_factory.h"
+
+#if 1
+#define aprintf(...) {}
+#else
+#define aprintf printf
+#endif
+
+FFcodecSettings Mp2Settings=
+{
+    {
+    COMPRESS_CQ, //COMPRESSION_MODE  mode;
+    2,              // uint32_t          qz;           /// Quantizer
+    1500,           //uint32_t          bitrate;      /// In kb/s 
+    700,            //uint32_t          finalsize;    /// In ?
+    1500,           //uint32_t          avg_bitrate;  /// avg_bitrate is in kb/s!!
+    ADM_ENC_CAP_CBR+ADM_ENC_CAP_CQ+ADM_ENC_CAP_2PASS+ADM_ENC_CAP_2PASS_BR+ADM_ENC_CAP_GLOBAL+ADM_ENC_CAP_SAME
+    },
+    {
+        ADM_AVCODEC_SETTING_VERSION,
+        2, // Multithreaded
+          ME_EPZS,			// ME
+          0,				// GMC     
+          0,				// 4MV
+          0,				// _QPEL;   
+          1,				// _TREILLIS_QUANT
+          2,				// qmin;
+          31,				// qmax;
+          3,				// max_qdiff;
+          2,				// max_b_frames;
+          1,				// mpeg_quant;
+          1,				// is_luma_elim_threshold
+          -2,				// luma_elim_threshold;
+          1,				// is_chroma_elim_threshold
+          -5,				// chroma_elim_threshold;
+          0.05,				//lumi_masking;
+          1,				// is lumi
+          0.01,				//dark_masking; 
+          1,				// is dark
+          0.5,				// qcompress amount of qscale change between easy & hard scenes (0.0-1.0
+          0.5,				// qblur;    amount of qscale smoothing over time (0.0-1.0) 
+          0,   		        // min bitrate in kB/S
+          10000,			// max bitrate
+          0,				// default matrix
+          18,				// no gop size
+          NULL,             // intra_matrix
+          NULL,             // intra_matrix
+          0,				// interlaced
+          0,				// WLA: bottom-field-first
+          0,				// wide screen
+          2,				// mb eval = distortion
+          8000,				// vratetol 8Meg
+          0,				// is temporal
+          0.0,				// temporal masking
+          0,				// is spatial
+          0.0,				// spatial masking
+          0,				// NAQ
+          0				    // DUMMY 
+    }
+};
+/**
+        \fn ADM_ffMpeg2Encoder
+*/
+ADM_ffMpeg2Encoder::ADM_ffMpeg2Encoder(ADM_coreVideoFilter *src,bool globalHeader) : ADM_coreVideoEncoderFFmpeg(src,&Mp2Settings,globalHeader)
+{
+    printf("[ffMpeg2Encoder] Creating.\n");
+   
+
+}
+
+/**
+    \fn setup
+*/
+bool ADM_ffMpeg2Encoder::setup(void)
+{
+    
+    switch(Settings.params.mode)
+    {
+      case COMPRESS_2PASS:
+      case COMPRESS_2PASS_BITRATE:
+           if(false==setupPass())
+            {
+                printf("[ffmpeg] Multipass setup failed\n");
+                return false;
+            }
+            break;
+      case COMPRESS_SAME:
+      case COMPRESS_CQ:
+            _context->flags |= CODEC_FLAG_QSCALE;
+            _context->bit_rate = 0;
+            break;
+      case COMPRESS_CBR:
+              _context->bit_rate=Settings.params.bitrate*1000; // kb->b;
+            break;
+     default:
+            return false;
+    }
+    presetContext(&Settings);
+    if(false== ADM_coreVideoEncoderFFmpeg::setup(CODEC_ID_MPEG2VIDEO))
+        return false;
+
+    printf("[ffMpeg] Setup ok\n");
+    return true;
+}
+
+
+/** 
+    \fn ~ADM_ffMpeg2Encoder
+*/
+ADM_ffMpeg2Encoder::~ADM_ffMpeg2Encoder()
+{
+    printf("[ffMpeg2Encoder] Destroying.\n");
+   
+    
+}
+
+/**
+    \fn encode
+*/
+bool         ADM_ffMpeg2Encoder::encode (ADMBitstream * out)
+{
+int sz,q;
+again:
+    sz=0;
+    if(false==preEncode()) // Pop - out the frames stored in the queue due to B-frames
+    {
+        if ((sz = avcodec_encode_video (_context, out->data, out->bufferSize, NULL)) <= 0)
+        {
+            printf("[ffMpeg2] Error %d encoding video\n",sz);
+            return false;
+        }
+        printf("[ffMpeg2] Popping delayed bframes (%d)\n",sz);
+        goto link;
+        return false;
+    }
+    q=image->_Qp;
+    
+    if(!q) q=2;
+    switch(Settings.params.mode)
+    {
+      case COMPRESS_SAME:
+                // Keep same frame type & same Qz as the incoming frame...
+            _frame.quality = (int) floor (FF_QP2LAMBDA * q+ 0.5);
+
+            if(image->flags & AVI_KEY_FRAME)    _frame.pict_type=FF_I_TYPE;
+            else if(image->flags & AVI_B_FRAME) _frame.pict_type=FF_B_TYPE;
+            else                                _frame.pict_type=FF_P_TYPE;
+
+            break;
+      case COMPRESS_2PASS:
+      case COMPRESS_2PASS_BITRATE:
+            switch(pass)
+            {
+                case 1: 
+                        break;
+                case 2: 
+                        break; // Get Qz for this frame...
+            }
+      case COMPRESS_CQ:
+            _frame.quality = (int) floor (FF_QP2LAMBDA * Settings.params.qz+ 0.5);
+            break;
+      case COMPRESS_CBR:
+            break;
+     default:
+            printf("[ffMpeg2] Unsupported encoding mode\n");
+            return false;
+    }
+    aprintf("[CODEC] Flags = 0x%x, QSCALE=%x, bit_rate=%d, quality=%d qz=%d incoming qz=%d\n",_context->flags,CODEC_FLAG_QSCALE,
+                                     _context->bit_rate,  _frame.quality, _frame.quality/ FF_QP2LAMBDA,q);     
+    
+    _frame.reordered_opaque=image->Pts;
+    if ((sz = avcodec_encode_video (_context, out->data, out->bufferSize, &_frame)) < 0)
+    {
+        printf("[ffMpeg2] Error %d encoding video\n",sz);
+        return false;
+    }
+    
+    if(sz==0) // no pic, probably pre filling, try again
+        goto again;
+link:
+    postEncode(out,sz);
+   
+    return true;
+}
+
+/**
+    \fn isDualPass
+
+*/
+bool         ADM_ffMpeg2Encoder::isDualPass(void) 
+{
+    if(Settings.params.mode==COMPRESS_2PASS || Settings.params.mode==COMPRESS_2PASS_BITRATE ) return true;
+    return false;
+
+}
+
+/**
+    \fn jpegConfigure
+    \brief UI configuration for jpeg encoder
+*/
+
+bool         ffMpeg2Configure(void)
+{         
+diaMenuEntry meE[]={
+  {1,QT_TR_NOOP("None")},
+  {2,QT_TR_NOOP("Full")},
+  {3,QT_TR_NOOP("Log")},
+  {4,QT_TR_NOOP("Phods")},
+  {5,QT_TR_NOOP("EPZS")},
+  {6,QT_TR_NOOP("X1")}
+};       
+
+diaMenuEntry qzE[]={
+  {0,QT_TR_NOOP("H.263")},
+  {1,QT_TR_NOOP("MPEG")}
+};       
+
+diaMenuEntry rdE[]={
+  {0,QT_TR_NOOP("MB comparison")},
+  {1,QT_TR_NOOP("Fewest bits (vhq)")},
+  {2,QT_TR_NOOP("Rate distortion")}
+};     
+diaMenuEntry threads[]={
+  {0,QT_TR_NOOP("One thread")},
+  {2,QT_TR_NOOP("Two threads)")},
+  {3,QT_TR_NOOP("Three threads")},
+  {99,QT_TR_NOOP("Auto (#cpu)")}
+};     
+
+
+        FFcodecSettings *conf=&Mp2Settings;
+
+uint32_t me=(uint32_t)conf->lavcSettings.me_method;  
+#define PX(x) &(conf->lavcSettings.x)
+
+         diaElemBitrate   bitrate(&(Mp2Settings.params),NULL);
+         diaElemMenu      meM(&me,QT_TR_NOOP("Matrices"),4,meE);
+         diaElemMenu      threadM(PX(MultiThreaded),QT_TR_NOOP("Threading"),4,threads);
+         diaElemUInteger  qminM(PX(qmin),QT_TR_NOOP("Mi_n. quantizer:"),1,31);
+         diaElemUInteger  qmaxM(PX(qmax),QT_TR_NOOP("Ma_x. quantizer:"),1,31);
+         diaElemUInteger  qdiffM(PX(max_qdiff),QT_TR_NOOP("Max. quantizer _difference:"),1,31);
+         
+         diaElemToggle    fourMv(PX(_4MV),QT_TR_NOOP("4_MV"));
+         diaElemToggle    trellis(PX(_TRELLIS_QUANT),QT_TR_NOOP("_Trellis quantization"));
+         
+         diaElemToggle    qpel(PX(_QPEL),QT_TR_NOOP("_Quarter pixel"));
+         diaElemToggle    gmc(PX(_GMC),QT_TR_NOOP("_GMC"));
+
+         
+         diaElemUInteger  max_b_frames(PX(max_b_frames),QT_TR_NOOP("_Number of B frames:"),0,32);
+         diaElemMenu     qzM(PX(mpeg_quant),QT_TR_NOOP("_Quantization type:"),2,qzE);
+         
+         diaElemMenu     rdM(PX(mb_eval),QT_TR_NOOP("_Macroblock decision:"),3,rdE);
+         
+         diaElemUInteger filetol(PX(vratetol),QT_TR_NOOP("_Filesize tolerance (kb):"),0,100000);
+         
+         diaElemFloat    qzComp(PX(qcompress),QT_TR_NOOP("_Quantizer compression:"),0,1);
+         diaElemFloat    qzBlur(PX(qblur),QT_TR_NOOP("Quantizer _blur:"),0,1);
+         
+        diaElemUInteger GopSize(PX(gop_size),QT_TR_NOOP("_Gop Size:"),1,500); 
+          /* First Tab : encoding mode */
+        diaElem *diamode[]={&GopSize,&threadM,&bitrate};
+        diaElemTabs tabMode(QT_TR_NOOP("User Interface"),3,diamode);
+        
+        /* 2nd Tab : ME */
+        diaElemFrame frameMe(QT_TR_NOOP("Advanced Simple Profile"));
+        
+        frameMe.swallow(&max_b_frames);
+        frameMe.swallow(&qpel);
+        frameMe.swallow(&gmc);
+        
+        diaElem *diaME[]={&fourMv,&frameMe};
+        diaElemTabs tabME(QT_TR_NOOP("Motion Estimation"),2,diaME);
+        /* 3nd Tab : Qz */
+        
+         diaElem *diaQze[]={&qzM,&rdM,&qminM,&qmaxM,&qdiffM,&trellis};
+        diaElemTabs tabQz(QT_TR_NOOP("Quantization"),6,diaQze);
+        
+        /* 4th Tab : RControl */
+        
+         diaElem *diaRC[]={&filetol,&qzComp,&qzBlur};
+        diaElemTabs tabRC(QT_TR_NOOP("Rate Control"),3,diaRC);
+        
+         diaElemTabs *tabs[]={&tabMode,&tabME,&tabQz,&tabRC};
+        if( diaFactoryRunTabs(QT_TR_NOOP("libavcodec MPEG-4 configuration"),4,tabs))
+        {
+          conf->lavcSettings.me_method=(Motion_Est_ID)me;
+          return true;
+        }
+         return false;
+}
+// EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h	2010-02-07 08:59:03 UTC (rev 5907)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h	2010-02-07 08:59:04 UTC (rev 5908)
@@ -0,0 +1,47 @@
+/***************************************************************************
+                          \fn ADM_VideoEncoders
+                          \brief Internal handling of video encoders
+                             -------------------
+    
+    copyright            : (C) 2002/2009 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_ffMpeg2_ENCODER_H
+#define ADM_ffMpeg2_ENCODER_H
+#include "ADM_coreVideoEncoderFFmpeg.h"
+
+
+/**
+        \class ADM_ffMpeg2Encoder
+        \brief Dummy encoder that does nothing
+
+*/
+class ADM_ffMpeg2Encoder : public ADM_coreVideoEncoderFFmpeg
+{
+protected:
+               
+           
+               int             plane;
+               
+public:
+
+                           ADM_ffMpeg2Encoder(ADM_coreVideoFilter *src,bool globalHeader);
+virtual                    ~ADM_ffMpeg2Encoder();
+virtual        bool        setup(void); 
+virtual        bool        encode (ADMBitstream * out);
+virtual const  char        *getFourcc(void) {return "MPEG";}
+
+virtual        bool         isDualPass(void) ;
+
+};
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/CMakeLists.txt	2010-02-07 08:59:03 UTC (rev 5907)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/CMakeLists.txt	2010-02-07 08:59:04 UTC (rev 5908)
@@ -0,0 +1,15 @@
+INCLUDE(ve_plugin)
+
+SET(ffMpeg2_SRCS 
+        ffMpeg2Plugin.cpp
+        ADM_ffMpeg2.cpp
+)
+INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})
+
+ADD_LIBRARY(ADM_ve_ffMpeg2 SHARED ${ffMpeg2_SRCS})
+
+INIT_VIDEO_ENCODER(ADM_ve_ffMpeg2)
+INSTALL_VIDEO_ENCODER(ADM_ve_ffMpeg2)
+TARGET_LINK_LIBRARIES(ADM_ve_ffMpeg2 ADM_libavcodec6 ADM_libavutil6)
+INCLUDE_DIRECTORIES("${AVIDEMUX_SOURCE_DIR}/avidemux/")
+INCLUDE_DIRECTORIES("${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_libraries/ADM_ffmpeg")

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ffMpeg2Plugin.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ffMpeg2Plugin.cpp	2010-02-07 08:59:03 UTC (rev 5907)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ffMpeg2Plugin.cpp	2010-02-07 08:59:04 UTC (rev 5908)
@@ -0,0 +1,33 @@
+/***************************************************************************
+                          \fn     jpegPlugin
+                          \brief  Plugin for jpeg dummy encoder
+                             -------------------
+    
+    copyright            : (C) 2002/2009 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_default.h"
+#include "ADM_ffMpeg2.h"
+#include "ADM_coreVideoEncoderInternal.h"
+#include "../src/FFcodecSettings_desc.cpp"
+extern bool         ffMpeg2Configure(void);
+extern FFcodecSettings Mp2Settings;
+ADM_DECLARE_VIDEO_ENCODER_PREAMBLE(ADM_ffMpeg2Encoder);
+ADM_DECLARE_VIDEO_ENCODER_MAIN("ffMpeg2",
+                               "Mpeg2 (ff)",
+                               "Simple ffmpeg based Mpeg2 Encoder (c) 2009 Mean",
+                                ffMpeg2Configure, // No configuration
+                                ADM_UI_ALL,
+                                1,0,0,
+                                FFcodecSettings_param, // conf template
+                                &Mp2Settings // conf var
+);



From mean at mail.berlios.de  Sun Feb  7 09:59:05 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 09:59:05 +0100
Subject: [Avidemux-svn-commit] r5909 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder
Message-ID: <201002070859.o178x5ar027200@sheep.berlios.de>

Author: mean
Date: 2010-02-07 09:59:05 +0100 (Sun, 07 Feb 2010)
New Revision: 5909

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/CMakeLists.txt
Log:
[encoder] Add mpeg2

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/CMakeLists.txt	2010-02-07 08:59:04 UTC (rev 5908)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/CMakeLists.txt	2010-02-07 08:59:05 UTC (rev 5909)
@@ -6,5 +6,6 @@
 ADD_SUBDIRECTORY(jpeg)
 ADD_SUBDIRECTORY(huff)
 ADD_SUBDIRECTORY(ffMpeg4)
+ADD_SUBDIRECTORY(ffMpeg2)
 ADD_SUBDIRECTORY(ffMsMpeg4)
 ADD_SUBDIRECTORY(ffFlv1)



From mean at mail.berlios.de  Sun Feb  7 09:59:07 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 09:59:07 +0100
Subject: [Avidemux-svn-commit] r5910 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2
Message-ID: <201002070859.o178x79i027210@sheep.berlios.de>

Author: mean
Date: 2010-02-07 09:59:06 +0100 (Sun, 07 Feb 2010)
New Revision: 5910

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp
Log:
[mpeg2] Remove unused parameters from mpeg2 dialog

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp	2010-02-07 08:59:05 UTC (rev 5909)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp	2010-02-07 08:59:06 UTC (rev 5910)
@@ -231,10 +231,6 @@
   {6,QT_TR_NOOP("X1")}
 };       
 
-diaMenuEntry qzE[]={
-  {0,QT_TR_NOOP("H.263")},
-  {1,QT_TR_NOOP("MPEG")}
-};       
 
 diaMenuEntry rdE[]={
   {0,QT_TR_NOOP("MB comparison")},
@@ -255,21 +251,15 @@
 #define PX(x) &(conf->lavcSettings.x)
 
          diaElemBitrate   bitrate(&(Mp2Settings.params),NULL);
-         diaElemMenu      meM(&me,QT_TR_NOOP("Matrices"),4,meE);
+
          diaElemMenu      threadM(PX(MultiThreaded),QT_TR_NOOP("Threading"),4,threads);
          diaElemUInteger  qminM(PX(qmin),QT_TR_NOOP("Mi_n. quantizer:"),1,31);
          diaElemUInteger  qmaxM(PX(qmax),QT_TR_NOOP("Ma_x. quantizer:"),1,31);
          diaElemUInteger  qdiffM(PX(max_qdiff),QT_TR_NOOP("Max. quantizer _difference:"),1,31);
          
-         diaElemToggle    fourMv(PX(_4MV),QT_TR_NOOP("4_MV"));
          diaElemToggle    trellis(PX(_TRELLIS_QUANT),QT_TR_NOOP("_Trellis quantization"));
          
-         diaElemToggle    qpel(PX(_QPEL),QT_TR_NOOP("_Quarter pixel"));
-         diaElemToggle    gmc(PX(_GMC),QT_TR_NOOP("_GMC"));
-
-         
          diaElemUInteger  max_b_frames(PX(max_b_frames),QT_TR_NOOP("_Number of B frames:"),0,32);
-         diaElemMenu     qzM(PX(mpeg_quant),QT_TR_NOOP("_Quantization type:"),2,qzE);
          
          diaElemMenu     rdM(PX(mb_eval),QT_TR_NOOP("_Macroblock decision:"),3,rdE);
          
@@ -278,32 +268,24 @@
          diaElemFloat    qzComp(PX(qcompress),QT_TR_NOOP("_Quantizer compression:"),0,1);
          diaElemFloat    qzBlur(PX(qblur),QT_TR_NOOP("Quantizer _blur:"),0,1);
          
-        diaElemUInteger GopSize(PX(gop_size),QT_TR_NOOP("_Gop Size:"),1,500); 
+        diaElemUInteger GopSize(PX(gop_size),QT_TR_NOOP("_Gop Size:"),1,30); 
           /* First Tab : encoding mode */
-        diaElem *diamode[]={&GopSize,&threadM,&bitrate};
-        diaElemTabs tabMode(QT_TR_NOOP("User Interface"),3,diamode);
+        diaElem *diamode[]={&GopSize,&threadM,&max_b_frames,&bitrate};
+        diaElemTabs tabMode(QT_TR_NOOP("User Interface"),4,diamode);
         
         /* 2nd Tab : ME */
-        diaElemFrame frameMe(QT_TR_NOOP("Advanced Simple Profile"));
-        
-        frameMe.swallow(&max_b_frames);
-        frameMe.swallow(&qpel);
-        frameMe.swallow(&gmc);
-        
-        diaElem *diaME[]={&fourMv,&frameMe};
-        diaElemTabs tabME(QT_TR_NOOP("Motion Estimation"),2,diaME);
         /* 3nd Tab : Qz */
         
-         diaElem *diaQze[]={&qzM,&rdM,&qminM,&qmaxM,&qdiffM,&trellis};
-        diaElemTabs tabQz(QT_TR_NOOP("Quantization"),6,diaQze);
+        diaElem *diaQze[]={&rdM,&qminM,&qmaxM,&qdiffM,&trellis};
+        diaElemTabs tabQz(QT_TR_NOOP("Quantization"),5,diaQze);
         
         /* 4th Tab : RControl */
         
          diaElem *diaRC[]={&filetol,&qzComp,&qzBlur};
         diaElemTabs tabRC(QT_TR_NOOP("Rate Control"),3,diaRC);
         
-         diaElemTabs *tabs[]={&tabMode,&tabME,&tabQz,&tabRC};
-        if( diaFactoryRunTabs(QT_TR_NOOP("libavcodec MPEG-4 configuration"),4,tabs))
+         diaElemTabs *tabs[]={&tabMode,&tabQz,&tabRC};
+        if( diaFactoryRunTabs(QT_TR_NOOP("libavcodec MPEG-2 configuration"),3,tabs))
         {
           conf->lavcSettings.me_method=(Motion_Est_ID)me;
           return true;



From mean at mail.berlios.de  Sun Feb  7 09:59:08 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 09:59:08 +0100
Subject: [Avidemux-svn-commit] r5911 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2
Message-ID: <201002070859.o178x8pf027220@sheep.berlios.de>

Author: mean
Date: 2010-02-07 09:59:08 +0100 (Sun, 07 Feb 2010)
New Revision: 5911

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpeg2_encoder.conf
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpeg2_encoder.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpeg2_encoder_desc.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ffMpeg2Plugin.cpp
Log:
[mpeg2] add custom parameters...

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp	2010-02-07 08:59:06 UTC (rev 5910)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp	2010-02-07 08:59:08 UTC (rev 5911)
@@ -27,7 +27,7 @@
 #define aprintf printf
 #endif
 
-FFcodecSettings Mp2Settings=
+mpeg2_encoder Mp2Settings=
 {
     {
     COMPRESS_CQ, //COMPRESSION_MODE  mode;
@@ -77,12 +77,15 @@
           0.0,				// spatial masking
           0,				// NAQ
           0				    // DUMMY 
-    }
+    },
+    0   // Matrix
 };
 /**
         \fn ADM_ffMpeg2Encoder
 */
-ADM_ffMpeg2Encoder::ADM_ffMpeg2Encoder(ADM_coreVideoFilter *src,bool globalHeader) : ADM_coreVideoEncoderFFmpeg(src,&Mp2Settings,globalHeader)
+// It works because mpeg2_encoder.h is the same as FFCodecSettings + additional fields!
+ADM_ffMpeg2Encoder::ADM_ffMpeg2Encoder(ADM_coreVideoFilter *src,bool globalHeader) : 
+        ADM_coreVideoEncoderFFmpeg(src,(FFcodecSettings *)&(Mp2Settings),false)
 {
     printf("[ffMpeg2Encoder] Creating.\n");
    
@@ -245,7 +248,7 @@
 };     
 
 
-        FFcodecSettings *conf=&Mp2Settings;
+        mpeg2_encoder *conf=&Mp2Settings;
 
 uint32_t me=(uint32_t)conf->lavcSettings.me_method;  
 #define PX(x) &(conf->lavcSettings.x)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h	2010-02-07 08:59:06 UTC (rev 5910)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h	2010-02-07 08:59:08 UTC (rev 5911)
@@ -18,8 +18,8 @@
 #ifndef ADM_ffMpeg2_ENCODER_H
 #define ADM_ffMpeg2_ENCODER_H
 #include "ADM_coreVideoEncoderFFmpeg.h"
+#include "mpeg2_encoder.h"
 
-
 /**
         \class ADM_ffMpeg2Encoder
         \brief Dummy encoder that does nothing
@@ -28,10 +28,8 @@
 class ADM_ffMpeg2Encoder : public ADM_coreVideoEncoderFFmpeg
 {
 protected:
-               
-           
                int             plane;
-               
+               mpeg2_encoder   settings;
 public:
 
                            ADM_ffMpeg2Encoder(ADM_coreVideoFilter *src,bool globalHeader);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ffMpeg2Plugin.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ffMpeg2Plugin.cpp	2010-02-07 08:59:06 UTC (rev 5910)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ffMpeg2Plugin.cpp	2010-02-07 08:59:08 UTC (rev 5911)
@@ -18,9 +18,9 @@
 #include "ADM_default.h"
 #include "ADM_ffMpeg2.h"
 #include "ADM_coreVideoEncoderInternal.h"
-#include "../src/FFcodecSettings_desc.cpp"
+#include "mpeg2_encoder_desc.cpp"
+extern mpeg2_encoder Mp2Settings;
 extern bool         ffMpeg2Configure(void);
-extern FFcodecSettings Mp2Settings;
 ADM_DECLARE_VIDEO_ENCODER_PREAMBLE(ADM_ffMpeg2Encoder);
 ADM_DECLARE_VIDEO_ENCODER_MAIN("ffMpeg2",
                                "Mpeg2 (ff)",
@@ -28,6 +28,6 @@
                                 ffMpeg2Configure, // No configuration
                                 ADM_UI_ALL,
                                 1,0,0,
-                                FFcodecSettings_param, // conf template
+                                mpeg2_encoder_param, // conf template
                                 &Mp2Settings // conf var
 );

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpeg2_encoder.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpeg2_encoder.conf	2010-02-07 08:59:06 UTC (rev 5910)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpeg2_encoder.conf	2010-02-07 08:59:08 UTC (rev 5911)
@@ -0,0 +1,3 @@
+video_encode:params
+lavcodec_context:lavcSettings
+uint32_t:matrix

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpeg2_encoder.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpeg2_encoder.h	2010-02-07 08:59:06 UTC (rev 5910)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpeg2_encoder.h	2010-02-07 08:59:08 UTC (rev 5911)
@@ -0,0 +1,10 @@
+// Automatically generated, do not edit!
+#ifndef ADM_mpeg2_encoder_CONF_H
+#define ADM_mpeg2_encoder_CONF_H
+typedef struct {
+   COMPRES_PARAMS params;
+   FFcodecContext lavcSettings;
+   uint32_t matrix;
+}mpeg2_encoder;
+#endif //mpeg2_encoder
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpeg2_encoder_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpeg2_encoder_desc.cpp	2010-02-07 08:59:06 UTC (rev 5910)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpeg2_encoder_desc.cpp	2010-02-07 08:59:08 UTC (rev 5911)
@@ -0,0 +1,7 @@
+// Automatically generated, do not edit!
+const ADM_paramList mpeg2_encoder_param[]={
+ {"params",offsetof( mpeg2_encoder,params),"COMPRES_PARAMS",ADM_param_video_encode},
+ {"lavcSettings",offsetof( mpeg2_encoder,lavcSettings),"FFcodecContext",ADM_param_lavcodec_context},
+ {"matrix",offsetof( mpeg2_encoder,matrix),"uint32_t",ADM_param_uint32_t},
+{NULL,0,NULL}
+};



From mean at mail.berlios.de  Sun Feb  7 09:59:10 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 09:59:10 +0100
Subject: [Avidemux-svn-commit] r5912 - in branches/avidemux_2.6_branch_mean:
	avidemux_core/ADM_coreVideoEncoder/src
	avidemux_plugins/ADM_videoEncoder/ffMpeg2
	avidemux_plugins/ADM_videoEncoder/ffMpeg4
	avidemux_plugins/ADM_videoEncoder/ffMsMpeg4
Message-ID: <201002070859.o178xAYO027230@sheep.berlios.de>

Author: mean
Date: 2010-02-07 09:59:09 +0100 (Sun, 07 Feb 2010)
New Revision: 5912

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpegMatrix.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg4/ADM_ffMpeg4.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMsMpeg4/ADM_ffMsMp4.cpp
Log:
[Mpeg2] Add some additional glue, incomplete

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-07 08:59:08 UTC (rev 5911)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-07 08:59:09 UTC (rev 5912)
@@ -443,7 +443,7 @@
 */
 bool ADM_coreVideoEncoderFFmpeg::presetContext(FFcodecSettings *set)
 {
-	  _context->gop_size = 250;
+	  //_context->gop_size = 250;
 	
 #define SETX(x) _context->x=set->lavcSettings.x; printf("[LAVCODEC]"#x" : %d\n",set->lavcSettings.x);
 #define SETX_COND(x) if(set->lavcSettings.is_##x) {_context->x=set->lavcSettings.x; printf("[LAVCODEC]"#x" : %d\n",set->lavcSettings.x);} else\
@@ -454,6 +454,7 @@
       SETX (max_b_frames);
       SETX (mpeg_quant);
       SETX (max_qdiff);
+      SETX (gop_size);
       SETX_COND (luma_elim_threshold);
       SETX_COND (chroma_elim_threshold);
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp	2010-02-07 08:59:08 UTC (rev 5911)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp	2010-02-07 08:59:09 UTC (rev 5912)
@@ -26,7 +26,7 @@
 #else
 #define aprintf printf
 #endif
-
+#include "mpegMatrix.h"
 mpeg2_encoder Mp2Settings=
 {
     {
@@ -62,10 +62,8 @@
           0.5,				// qblur;    amount of qscale smoothing over time (0.0-1.0) 
           0,   		        // min bitrate in kB/S
           10000,			// max bitrate
-          0,				// default matrix
-          18,				// no gop size
-          NULL,             // intra_matrix
-          NULL,             // intra_matrix
+          0,				// user matrix
+          18,				// gop size
           0,				// interlaced
           0,				// WLA: bottom-field-first
           0,				// wide screen
@@ -75,8 +73,11 @@
           0.0,				// temporal masking
           0,				// is spatial
           0.0,				// spatial masking
-          0,				// NAQ
-          0				    // DUMMY 
+          0,				// Normalize aqp 
+          0,                // Xvid rate control
+          112,              // Buffer size (kbits)
+          0,                // Override ratecontrol
+          0,    		    // DUMMY 
     },
     0   // Matrix
 };
@@ -120,9 +121,26 @@
             return false;
     }
     presetContext(&Settings);
+    // Override some parameters specific to this codec
+    // Set matrix if any...
+#define MX(a,b,c) case a: _context->intra_matrix=b,_context->inter_matrix=c;break;
+    switch(Mp2Settings.matrix)
+    {
+        MX(MPEG2_MATRIX_DEFAULT,NULL,NULL);
+        MX(MPEG2_MATRIX_TMPGENC,tmpgenc_intra,tmpgenc_inter);
+        MX(MPEG2_MATRIX_ANIME,anime_intra,anime_inter);
+        MX(MPEG2_MATRIX_KVCD,kvcd_intra,kvcd_inter);
+        default:
+                ADM_error("unknown matrix type : %d\n",(int)Mp2Settings.matrix);
+                ADM_assert(0);
+                break;
+    }
+    _context->rc_buffer_size=Mp2Settings.lavcSettings.bufferSize*1000;
+    _context->rc_buffer_size_header=Mp2Settings.lavcSettings.bufferSize=1000;
+    // /Override some parameters specific to this codec
+
     if(false== ADM_coreVideoEncoderFFmpeg::setup(CODEC_ID_MPEG2VIDEO))
         return false;
-
     printf("[ffMpeg] Setup ok\n");
     return true;
 }
@@ -224,17 +242,22 @@
 */
 
 bool         ffMpeg2Configure(void)
-{         
-diaMenuEntry meE[]={
-  {1,QT_TR_NOOP("None")},
-  {2,QT_TR_NOOP("Full")},
-  {3,QT_TR_NOOP("Log")},
-  {4,QT_TR_NOOP("Phods")},
-  {5,QT_TR_NOOP("EPZS")},
-  {6,QT_TR_NOOP("X1")}
-};       
+{   
 
-
+diaMenuEntry  arE[]=
+{
+    {0,QT_TR_NOOP("Normal (4:3)")},
+    {1,QT_TR_NOOP("Wide (16:9)")}
+};
+      
+diaMenuEntry  matrixE[]=
+{
+    {MPEG2_MATRIX_DEFAULT,QT_TR_NOOP("Default")},
+    {MPEG2_MATRIX_TMPGENC,QT_TR_NOOP("Tmpgenc")},
+    {MPEG2_MATRIX_ANIME,QT_TR_NOOP("Animes")},
+    {MPEG2_MATRIX_KVCD,QT_TR_NOOP("KVCD")},
+};
+      
 diaMenuEntry rdE[]={
   {0,QT_TR_NOOP("MB comparison")},
   {1,QT_TR_NOOP("Fewest bits (vhq)")},
@@ -259,13 +282,15 @@
          diaElemUInteger  qminM(PX(qmin),QT_TR_NOOP("Mi_n. quantizer:"),1,31);
          diaElemUInteger  qmaxM(PX(qmax),QT_TR_NOOP("Ma_x. quantizer:"),1,31);
          diaElemUInteger  qdiffM(PX(max_qdiff),QT_TR_NOOP("Max. quantizer _difference:"),1,31);
+         diaElemUInteger  bufferS(PX(bufferSize),QT_TR_NOOP("VBV Buffer Size:"),1,1024);
          
          diaElemToggle    trellis(PX(_TRELLIS_QUANT),QT_TR_NOOP("_Trellis quantization"));
          
          diaElemUInteger  max_b_frames(PX(max_b_frames),QT_TR_NOOP("_Number of B frames:"),0,32);
          
          diaElemMenu     rdM(PX(mb_eval),QT_TR_NOOP("_Macroblock decision:"),3,rdE);
-         
+         diaElemMenu     arM(PX(widescreen),QT_TR_NOOP("Aspect ratio:"),2,arE);
+         diaElemMenu     matrixM(&(Mp2Settings.matrix),QT_TR_NOOP("Matrices:"),MPEG2_MATRIX_LAST,matrixE);
          diaElemUInteger filetol(PX(vratetol),QT_TR_NOOP("_Filesize tolerance (kb):"),0,100000);
          
          diaElemFloat    qzComp(PX(qcompress),QT_TR_NOOP("_Quantizer compression:"),0,1);
@@ -273,10 +298,13 @@
          
         diaElemUInteger GopSize(PX(gop_size),QT_TR_NOOP("_Gop Size:"),1,30); 
           /* First Tab : encoding mode */
-        diaElem *diamode[]={&GopSize,&threadM,&max_b_frames,&bitrate};
-        diaElemTabs tabMode(QT_TR_NOOP("User Interface"),4,diamode);
+        diaElem *diamode[]={&arM,&threadM,&bitrate};
+        diaElemTabs tabMode(QT_TR_NOOP("Basic Settings"),3,diamode);
         
-        /* 2nd Tab : ME */
+        /* 2nd Tab : advanced*/
+        diaElem *diaAdv[]={&bufferS,&matrixM,&max_b_frames,&GopSize};
+        diaElemTabs tabAdv(QT_TR_NOOP("Adv. Settings"),4,diaAdv);
+
         /* 3nd Tab : Qz */
         
         diaElem *diaQze[]={&rdM,&qminM,&qmaxM,&qdiffM,&trellis};
@@ -287,8 +315,8 @@
          diaElem *diaRC[]={&filetol,&qzComp,&qzBlur};
         diaElemTabs tabRC(QT_TR_NOOP("Rate Control"),3,diaRC);
         
-         diaElemTabs *tabs[]={&tabMode,&tabQz,&tabRC};
-        if( diaFactoryRunTabs(QT_TR_NOOP("libavcodec MPEG-2 configuration"),3,tabs))
+         diaElemTabs *tabs[]={&tabMode,&tabAdv,&tabQz,&tabRC};
+        if( diaFactoryRunTabs(QT_TR_NOOP("libavcodec MPEG-2 configuration"),4,tabs))
         {
           conf->lavcSettings.me_method=(Motion_Est_ID)me;
           return true;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h	2010-02-07 08:59:08 UTC (rev 5911)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h	2010-02-07 08:59:09 UTC (rev 5912)
@@ -20,6 +20,15 @@
 #include "ADM_coreVideoEncoderFFmpeg.h"
 #include "mpeg2_encoder.h"
 
+typedef enum
+{
+        MPEG2_MATRIX_DEFAULT,
+        MPEG2_MATRIX_TMPGENC,
+        MPEG2_MATRIX_ANIME,
+        MPEG2_MATRIX_KVCD,
+        MPEG2_MATRIX_LAST
+} ;
+
 /**
         \class ADM_ffMpeg2Encoder
         \brief Dummy encoder that does nothing

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpegMatrix.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpegMatrix.h	2010-02-07 08:59:08 UTC (rev 5911)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/mpegMatrix.h	2010-02-07 08:59:09 UTC (rev 5912)
@@ -0,0 +1,82 @@
+/***************************************************************************
+                        mpegMatrix.h  -  description
+                        ----------------------------
+
+	Defined mpeg1/2 custom matrices
+
+    begin                : Tue Sep 1 2003
+    copyright            : (C) 2002 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+static uint16_t tmpgenc_intra[64] = {
+  8, 16, 19, 22, 26, 27, 29, 34,
+  16, 16, 22, 24, 27, 29, 34, 37,
+  19, 22, 26, 27, 29, 34, 34, 38,
+  22, 22, 26, 27, 29, 34, 37, 40,
+  22, 26, 27, 29, 32, 35, 40, 48,
+  26, 27, 29, 32, 35, 40, 48, 58,
+  26, 27, 29, 34, 38, 46, 56, 69,
+  27, 29, 35, 38, 46, 56, 69, 83
+};
+static uint16_t tmpgenc_inter[64] = {
+  16, 17, 18, 19, 20, 21, 22, 23,	//0
+  17, 18, 19, 20, 21, 22, 23, 24,
+  18, 19, 20, 21, 22, 23, 24, 25,
+  19, 20, 21, 22, 23, 24, 26, 27,
+  20, 21, 22, 23, 25, 26, 27, 28,	//4
+  21, 22, 23, 24, 26, 27, 28, 30,
+  22, 23, 24, 26, 27, 28, 30, 31,
+  23, 24, 25, 27, 28, 30, 31, 33
+};
+static uint16_t anime_intra[64] = {
+  8, 32, 32, 32, 32, 32, 32, 32,	//0
+  32, 32, 32, 32, 32, 32, 32, 32,
+  32, 32, 32, 32, 32, 32, 32, 32,
+  32, 32, 32, 32, 32, 32, 32, 32,
+  32, 32, 32, 32, 32, 32, 32, 32,	//4
+  32, 32, 32, 32, 32, 32, 32, 32,
+  32, 32, 32, 32, 32, 32, 32, 32,
+  32, 32, 32, 32, 32, 32, 32, 32
+};
+static uint16_t anime_inter[64] = {
+  16, 16, 16, 16, 16, 16, 16, 16,	//0
+  16, 16, 16, 16, 16, 16, 16, 16,
+  16, 16, 16, 16, 16, 16, 16, 16,
+  16, 16, 16, 16, 16, 16, 16, 16,
+  16, 16, 16, 16, 16, 16, 16, 16,	//4
+  16, 16, 16, 16, 16, 16, 16, 16,
+  16, 16, 16, 16, 16, 16, 16, 16,
+  16, 16, 16, 16, 16, 16, 16, 16,
+};
+//----------------------------------------------
+static uint16_t kvcd_intra[64] = {
+  8, 9, 12, 22, 26, 27, 29, 34,	//0
+  9, 10, 14, 26, 27, 29, 37, 37,
+  12, 14, 18, 27, 29, 34, 37, 38,
+  22, 26, 27, 31, 36, 37, 38, 40,
+
+  26, 27, 29, 36, 39, 38, 40, 48,	//4
+  27, 29, 34, 37, 38, 40, 48, 58,
+  29, 34, 37, 38, 40, 48, 58, 69,
+  34, 37, 38, 40, 48, 58, 69, 79
+};
+static uint16_t kvcd_inter[64] = {
+  16, 18, 20, 22, 24, 26, 28, 30,	//0
+  18, 20, 22, 24, 26, 28, 30, 32,	//0
+  20, 22, 24, 26, 28, 30, 32, 34,	//0
+  22, 24, 26, 28, 30, 32, 34, 36,	//0
+
+  24, 26, 28, 30, 32, 34, 36, 38,	//0
+  26, 28, 30, 32, 34, 36, 38, 40,	//0
+  28, 30, 32, 34, 36, 38, 40, 42,	//0
+  30, 32, 34, 36, 38, 40, 42, 44	//0
+};

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg4/ADM_ffMpeg4.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg4/ADM_ffMpeg4.cpp	2010-02-07 08:59:08 UTC (rev 5911)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg4/ADM_ffMpeg4.cpp	2010-02-07 08:59:09 UTC (rev 5912)
@@ -62,10 +62,8 @@
           0.5,				// qblur;    amount of qscale smoothing over time (0.0-1.0) 
           0,				// min bitrate in kB/S
           0,				// max bitrate
-          0,				// default matrix
-          250,				// no gop size
-          NULL,             // intra_matrix
-          NULL,             // intra_matrix
+          0,				// user matrix
+          250,				// gop size
           0,				// interlaced
           0,				// WLA: bottom-field-first
           0,				// wide screen
@@ -76,6 +74,9 @@
           0,				// is spatial
           0.0,				// spatial masking
           0,				// NAQ
+          0,                // xvid rc
+          0,                // buffersize
+          0,                // override ratecontrol
           0				    // DUMMY 
     }
 };

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMsMpeg4/ADM_ffMsMp4.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMsMpeg4/ADM_ffMsMp4.cpp	2010-02-07 08:59:08 UTC (rev 5911)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMsMpeg4/ADM_ffMsMp4.cpp	2010-02-07 08:59:09 UTC (rev 5912)
@@ -63,10 +63,8 @@
           0.5,				// qblur;    amount of qscale smoothing over time (0.0-1.0) 
           0,				// min bitrate in kB/S
           0,				// max bitrate
-          0,				// default matrix
+          0,				// user matrix
           250,				// no gop size
-          NULL,             // intra_matrix
-          NULL,             // intra_matrix
           0,				// interlaced
           0,				// WLA: bottom-field-first
           0,				// wide screen
@@ -77,6 +75,9 @@
           0,				// is spatial
           0.0,				// spatial masking
           0,				// NAQ
+          0,                // xvid rc
+          0,                // buffersize
+          0,                // override ratecontrol
           0				    // DUMMY 
     }
 };



From mean at mail.berlios.de  Sun Feb  7 09:59:11 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 09:59:11 +0100
Subject: [Avidemux-svn-commit] r5913 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2
Message-ID: <201002070859.o178xBUr027240@sheep.berlios.de>

Author: mean
Date: 2010-02-07 09:59:11 +0100 (Sun, 07 Feb 2010)
New Revision: 5913

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h
Log:
[Mpeg2] Slightly better mpeg2 encoder

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp	2010-02-07 08:59:09 UTC (rev 5912)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.cpp	2010-02-07 08:59:11 UTC (rev 5913)
@@ -61,8 +61,8 @@
           0.5,				// qcompress amount of qscale change between easy & hard scenes (0.0-1.0
           0.5,				// qblur;    amount of qscale smoothing over time (0.0-1.0) 
           0,   		        // min bitrate in kB/S
-          10000,			// max bitrate
-          0,				// user matrix
+          9500,  			// max bitrate
+          1,				// user matrix
           18,				// gop size
           0,				// interlaced
           0,				// WLA: bottom-field-first
@@ -75,7 +75,7 @@
           0.0,				// spatial masking
           0,				// Normalize aqp 
           0,                // Xvid rate control
-          112,              // Buffer size (kbits)
+          224,              // Buffer size (kbits)
           0,                // Override ratecontrol
           0,    		    // DUMMY 
     },
@@ -135,8 +135,11 @@
                 ADM_assert(0);
                 break;
     }
-    _context->rc_buffer_size=Mp2Settings.lavcSettings.bufferSize*1000;
-    _context->rc_buffer_size_header=Mp2Settings.lavcSettings.bufferSize=1000;
+    _context->rc_buffer_size=Mp2Settings.lavcSettings.bufferSize*8*1024;
+    _context->rc_buffer_size_header=Mp2Settings.lavcSettings.bufferSize*8*1024;
+    _context->rc_initial_buffer_occupancy=_context->rc_buffer_size;
+    _context->rc_max_rate=Mp2Settings.lavcSettings.maxBitrate*1000;
+    _context->rc_max_rate_header=Mp2Settings.lavcSettings.maxBitrate*1000;
     // /Override some parameters specific to this codec
 
     if(false== ADM_coreVideoEncoderFFmpeg::setup(CODEC_ID_MPEG2VIDEO))
@@ -269,8 +272,16 @@
   {3,QT_TR_NOOP("Three threads")},
   {99,QT_TR_NOOP("Auto (#cpu)")}
 };     
+   
+diaMenuEntry interE[]={
+  {0,QT_TR_NOOP("Progressive")},
+  {1,QT_TR_NOOP("Interlaced")},
+};     
+diaMenuEntry foE[]={
+  {0,QT_TR_NOOP("Top Field First")},
+  {1,QT_TR_NOOP("Bottom Field First")},
+};     
 
-
         mpeg2_encoder *conf=&Mp2Settings;
 
 uint32_t me=(uint32_t)conf->lavcSettings.me_method;  
@@ -283,6 +294,7 @@
          diaElemUInteger  qmaxM(PX(qmax),QT_TR_NOOP("Ma_x. quantizer:"),1,31);
          diaElemUInteger  qdiffM(PX(max_qdiff),QT_TR_NOOP("Max. quantizer _difference:"),1,31);
          diaElemUInteger  bufferS(PX(bufferSize),QT_TR_NOOP("VBV Buffer Size:"),1,1024);
+         diaElemUInteger  maxBitrate(PX(maxBitrate),QT_TR_NOOP("Max bitrate (kb/s):"),1,50000);
          
          diaElemToggle    trellis(PX(_TRELLIS_QUANT),QT_TR_NOOP("_Trellis quantization"));
          
@@ -297,14 +309,22 @@
          diaElemFloat    qzBlur(PX(qblur),QT_TR_NOOP("Quantizer _blur:"),0,1);
          
         diaElemUInteger GopSize(PX(gop_size),QT_TR_NOOP("_Gop Size:"),1,30); 
+
+        diaElemMenu     interlaced(PX(interlaced),QT_TR_NOOP("_Interlaced:"),2,interE);
+        diaElemMenu     fieldOrder(PX(bff),QT_TR_NOOP("Field Order:"),2,foE);
+
           /* First Tab : encoding mode */
         diaElem *diamode[]={&arM,&threadM,&bitrate};
         diaElemTabs tabMode(QT_TR_NOOP("Basic Settings"),3,diamode);
         
         /* 2nd Tab : advanced*/
-        diaElem *diaAdv[]={&bufferS,&matrixM,&max_b_frames,&GopSize};
-        diaElemTabs tabAdv(QT_TR_NOOP("Adv. Settings"),4,diaAdv);
+        diaElem *diaAdv[]={&bufferS,&matrixM,&max_b_frames,&GopSize,&maxBitrate};
+        diaElemTabs tabAdv(QT_TR_NOOP("Adv. Settings"),5,diaAdv);
 
+        /* 2ndb Tab : interlacing*/
+        diaElem *diaInter[]={&interlaced,&fieldOrder};
+        diaElemTabs tabInter(QT_TR_NOOP("Interlacing"),2,diaInter);
+
         /* 3nd Tab : Qz */
         
         diaElem *diaQze[]={&rdM,&qminM,&qmaxM,&qdiffM,&trellis};
@@ -315,8 +335,8 @@
          diaElem *diaRC[]={&filetol,&qzComp,&qzBlur};
         diaElemTabs tabRC(QT_TR_NOOP("Rate Control"),3,diaRC);
         
-         diaElemTabs *tabs[]={&tabMode,&tabAdv,&tabQz,&tabRC};
-        if( diaFactoryRunTabs(QT_TR_NOOP("libavcodec MPEG-2 configuration"),4,tabs))
+         diaElemTabs *tabs[]={&tabMode,&tabAdv,&tabInter,&tabQz,&tabRC};
+        if( diaFactoryRunTabs(QT_TR_NOOP("libavcodec MPEG-2 configuration"),5,tabs))
         {
           conf->lavcSettings.me_method=(Motion_Est_ID)me;
           return true;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h	2010-02-07 08:59:09 UTC (rev 5912)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/ffMpeg2/ADM_ffMpeg2.h	2010-02-07 08:59:11 UTC (rev 5913)
@@ -20,7 +20,7 @@
 #include "ADM_coreVideoEncoderFFmpeg.h"
 #include "mpeg2_encoder.h"
 
-typedef enum
+enum
 {
         MPEG2_MATRIX_DEFAULT,
         MPEG2_MATRIX_TMPGENC,



From mean at mail.berlios.de  Sun Feb  7 19:38:43 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 19:38:43 +0100
Subject: [Avidemux-svn-commit] r5914 - in branches/avidemux_2.6_branch_mean:
	avidemux_core/ADM_coreMuxer/include avidemux_core/ADM_coreMuxer/src
	avidemux_plugins/ADM_muxers/muxerFlv
	avidemux_plugins/ADM_muxers/muxerMkv
	avidemux_plugins/ADM_muxers/muxerMp4
	avidemux_plugins/ADM_muxers/muxerffPS
	avidemux_plugins/ADM_muxers/muxerffTS
Message-ID: <201002071838.o17Ich1t023631@sheep.berlios.de>

Author: mean
Date: 2010-02-07 19:38:41 +0100 (Sun, 07 Feb 2010)
New Revision: 5914

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv/muxerFlv.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffPS/muxerffPS.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp
Log:
[muxer(ff)] Mark initialization of muxer as done, so that we know what must be deleted on exit

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h	2010-02-07 08:59:11 UTC (rev 5913)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h	2010-02-07 18:38:41 UTC (rev 5914)
@@ -69,6 +69,7 @@
         bool setupMuxer(const char *format,const char *filename);
         bool initVideo(ADM_videoStream *stream);
         bool initAudio(uint32_t nbAudioTrack,ADM_audioStream **audio);
+        bool initialized;
 public:
                 muxerFFmpeg();
         virtual ~muxerFFmpeg();

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-07 08:59:11 UTC (rev 5913)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-07 18:38:41 UTC (rev 5914)
@@ -37,6 +37,7 @@
     audio_st=NULL;
     video_st=NULL;
     audioDelay=0;
+    initialized=false;
 }
 /**
     \fn closeMuxer
@@ -45,8 +46,11 @@
 {
     if(oc)
     {
-        av_write_trailer(oc);
-        url_fclose((oc->pb));
+        if(initialized==true)
+        {
+            av_write_trailer(oc);
+            url_fclose((oc->pb));
+        }
     }
     if(audio_st)
     {

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv/muxerFlv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv/muxerFlv.cpp	2010-02-07 08:59:11 UTC (rev 5913)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv/muxerFlv.cpp	2010-02-07 18:38:41 UTC (rev 5914)
@@ -130,8 +130,9 @@
         {
             printf("[Flv Muxer] Muxer rejected the parameters\n");
             r=false;
-            
+            goto finish;
         }
+        initialized=true;
 finish:
         vStream=s;
         aStreams=a;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.cpp	2010-02-07 08:59:11 UTC (rev 5913)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.cpp	2010-02-07 18:38:41 UTC (rev 5914)
@@ -56,7 +56,7 @@
     /* All seems fine, open stuff */
     if(false==setupMuxer("matroska",file))
     {
-        printf("[Mkv] Failed to open muxer\n");
+        printf("[Mkv] Failed to open muxer (setup)\n");
         return false;
     }
  
@@ -97,6 +97,7 @@
         vStream=s;
         aStreams=a;
         nbAStreams=nbAudioTrack;
+        initialized=true;
         return true;
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.cpp	2010-02-07 08:59:11 UTC (rev 5913)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.cpp	2010-02-07 18:38:41 UTC (rev 5914)
@@ -119,6 +119,7 @@
         vStream=s;
         aStreams=a;
         nbAStreams=nbAudioTrack;
+        initialized=true;
         return true;
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffPS/muxerffPS.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffPS/muxerffPS.cpp	2010-02-07 08:59:11 UTC (rev 5913)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffPS/muxerffPS.cpp	2010-02-07 18:38:41 UTC (rev 5914)
@@ -131,6 +131,7 @@
         vStream=s;
         aStreams=a;
         nbAStreams=nbAudioTrack;
+        initialized=true;
         return true;
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp	2010-02-07 08:59:11 UTC (rev 5913)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffTS/muxerffTS.cpp	2010-02-07 18:38:41 UTC (rev 5914)
@@ -123,6 +123,7 @@
         vStream=s;
         aStreams=a;
         nbAStreams=nbAudioTrack;
+        initialized=true;
         return true;
 }
 



From mean at mail.berlios.de  Sun Feb  7 19:38:46 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 19:38:46 +0100
Subject: [Avidemux-svn-commit] r5916 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff
Message-ID: <201002071838.o17IckqA023682@sheep.berlios.de>

Author: mean
Date: 2010-02-07 19:38:46 +0100 (Sun, 07 Feb 2010)
New Revision: 5916

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.cpp
Log:
[huff] pure cosmetic

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.cpp	2010-02-07 18:38:44 UTC (rev 5915)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/huff/ADM_huffEncoder.cpp	2010-02-07 18:38:46 UTC (rev 5916)
@@ -73,7 +73,7 @@
 bool         ADM_huffEncoder::getExtraData(uint32_t *l,uint8_t **d)
 {
      *l=_context->extradata_size;
-     *d=_context-> extradata;
+     *d=_context->extradata;
      return true;
 };
 /**



From mean at mail.berlios.de  Sun Feb  7 19:38:44 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 19:38:44 +0100
Subject: [Avidemux-svn-commit] r5915 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska
Message-ID: <201002071838.o17Icim0023658@sheep.berlios.de>

Author: mean
Date: 2010-02-07 19:38:44 +0100 (Sun, 07 Feb 2010)
New Revision: 5915

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv.h
Log:
[mv] Better detect bframe and compute dts accordingly

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv.cpp	2010-02-07 18:38:41 UTC (rev 5914)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv.cpp	2010-02-07 18:38:44 UTC (rev 5915)
@@ -94,30 +94,42 @@
 
   // Delay frames + recompute frame duration
 // now that we have a good frameduration and max pts dts difference, we can set a proper DTS for all video frame
-  uint64_t ptsdtsdelta=delayFrameIfBFrames();
+    uint32_t ptsdtsdelta, mindelta;
+    bool hasBframe;
+  ComputeDeltaAndCheckBFrames(&mindelta, &ptsdtsdelta,&hasBframe);
   
+  
   int last=_tracks[0].index.size();
   uint64_t increment=_tracks[0]._defaultFrameDuration;
   uint64_t lastDts=0;
   _tracks[0].index[0].Dts=0;
   mkvTrak                 *vid=_tracks;
-  for(int i=1;i<last;i++)
-  {
-        uint64_t pts,dts;
-        pts=vid->index[i].Pts;
-        lastDts+=increment; // This frame dts with no correction
-        if(pts==ADM_NO_PTS)
-        {
+  if(hasBframe==true) // Try to compute a sane DTS knowing the PTS and the DTS/PTS delay
+    {
+      for(int i=1;i<last;i++)
+      {
+            uint64_t pts,dts;
+            pts=vid->index[i].Pts;
+            lastDts+=increment; // This frame dts with no correction
+            if(pts==ADM_NO_PTS)
+            {
+                vid->index[i].Dts=lastDts;
+                continue;
+            }
+            uint64_t limitDts=vid->index[i].Pts-ptsdtsdelta;
+            if(  lastDts<limitDts)
+            {
+                lastDts=limitDts;
+            }
             vid->index[i].Dts=lastDts;
-            continue;
-        }
-        uint64_t limitDts=vid->index[i].Pts-ptsdtsdelta;
-        if(  lastDts<limitDts)
-        {
-            lastDts=limitDts;
-        }
-        vid->index[i].Dts=lastDts;
-  }
+      }
+    }else
+    {       // No bframe, DTS=PTS
+      for(int i=0;i<last;i++)
+      {
+            vid->index[i].Dts=vid->index[i].Pts;
+      }
+    }
 
 
   if(last)
@@ -169,15 +181,40 @@
     we dont want a negative dts.
     \return maxdelta in us
 */
-uint32_t mkvHeader::delayFrameIfBFrames(void)
+bool mkvHeader::ComputeDeltaAndCheckBFrames(uint32_t *minDeltaX, uint32_t *maxDeltaX, bool *bFramePresent)
 {
     mkvTrak *track=_tracks;
     int nb=track->index.size();
     int nbBFrame=0;
     int64_t delta,maxDelta=0;
     int64_t minDelta=100000000;
+    *bFramePresent=false;
     if(nb>1)
     {
+        bool monotone=true;
+        uint64_t pts=track->index[0].Pts;
+        for(int i=1;i<nb;i++)
+        {
+            if(track->index[i].Pts<pts) 
+            {
+                monotone=false;
+                break;
+            }
+            pts=track->index[i].Pts;
+        }
+        if(monotone==true)
+        {
+            ADM_info("PTS is monotonous, probably no bframe\n");        
+            *bFramePresent=false;
+        }else
+        {
+            ADM_info("PTS is monotonous, probably no bframe\n");
+            *bFramePresent=true;
+        }
+    }
+
+    if(nb>1)
+    {
         // Search minimum and maximum between 2 frames
         // the minimum will give us the maximum fps
         // the maximum will give us the max PTS-DTS delta so that we can compute DTS
@@ -191,6 +228,7 @@
             //printf("\/=%"LLD" Min %"LLD" MAX %"LLD"\n",delta,minDelta,maxDelta);
         }
     }
+    if(nbBFrame) *bFramePresent=true;
     ADM_info("Minimum delta found %"LLD" us\n",minDelta);
     ADM_info("Maximum delta found %"LLD" us\n",maxDelta);
     if(minDelta)
@@ -227,7 +265,9 @@
         for(int i=0;i<_nbAudioTrack+1;i++)
             delayTrack(&(_tracks[i]),adj);
     }
-    return (uint32_t)maxDelta;
+    *maxDeltaX=maxDelta;
+    *minDeltaX=minDelta;
+    return true;
 }
 /**
     \fn rescaleTrack

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv.h	2010-02-07 18:38:41 UTC (rev 5914)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv.h	2010-02-07 18:38:44 UTC (rev 5915)
@@ -146,7 +146,8 @@
     uint8_t                 rescaleTrack(mkvTrak *track,uint32_t durationMs);
 
     bool                    delayTrack(mkvTrak *track, uint64_t value);
-    uint32_t                delayFrameIfBFrames(void);
+    
+    bool                    ComputeDeltaAndCheckBFrames(uint32_t *minDeltaX, uint32_t *maxDeltaX, bool *bFramePresent);
 
   public:
 



From mean at mail.berlios.de  Sun Feb  7 19:38:47 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 7 Feb 2010 19:38:47 +0100
Subject: [Avidemux-svn-commit] r5917 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src
Message-ID: <201002071838.o17IclNS023705@sheep.berlios.de>

Author: mean
Date: 2010-02-07 19:38:47 +0100 (Sun, 07 Feb 2010)
New Revision: 5917

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
Log:
[ffmuxer] support more video codec, need to be merged with tables from videoEncoderFF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-07 18:38:46 UTC (rev 5916)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-07 18:38:47 UTC (rev 5917)
@@ -27,7 +27,32 @@
 #define aprintf printf
 #endif
 
+typedef struct
+{
+    CodecID id;
+    const char *fcc;
+}lavCodecMapper;
+
+static const lavCodecMapper mapper[]={
+    {CODEC_ID_FFVHUFF,"FFVH"},
+    {CODEC_ID_HUFFYUV,"HFYU"},
+    {CODEC_ID_NONE,   "XXXX"},
+};
+
 /**
+    \fn ADM_codecIdFindByFourcc
+*/
+static CodecID ADM_codecIdFindByFourcc(const char *fcc)
+{
+    int nb=sizeof(mapper)/sizeof(lavCodecMapper);
+    for(int i=0;i<nb;i++)
+    {
+        if(!strcmp(fcc,mapper[i].fcc)) return mapper[i].id;
+    }
+    return CODEC_ID_NONE;
+}
+
+/**
     \fn muxerFFmpeg
 */
 muxerFFmpeg::muxerFFmpeg()
@@ -217,8 +242,15 @@
                                                 c->codec_id=CODEC_ID_MPEG2VIDEO;
                                             }else
                                             {
-                                                printf("[FF] Unknown video codec\n");
-                                                return false;
+                                                uint32_t id=stream->getFCC();
+            
+                                                CodecID cid=ADM_codecIdFindByFourcc(fourCC::tostring(id));
+                                                if(cid==CODEC_ID_NONE)
+                                                {
+                                                    printf("[FF] Unknown video codec\n");
+                                                    return false;
+                                                }
+                                                c->codec_id=cid;
                                             }
                                         }
                         }



From mean at mail.berlios.de  Tue Feb  9 07:40:24 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 9 Feb 2010 07:40:24 +0100
Subject: [Avidemux-svn-commit] r5918 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska
Message-ID: <201002090640.o196eOGl006791@sheep.berlios.de>

Author: mean
Date: 2010-02-09 07:40:22 +0100 (Tue, 09 Feb 2010)
New Revision: 5918

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp
Log:
[mkv] Partial fix for VFW-type codec inside mkv which have extra data

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp	2010-02-07 18:38:47 UTC (rev 5917)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp	2010-02-09 06:40:22 UTC (rev 5918)
@@ -58,6 +58,7 @@
           printf("==>Video\n");
           PRINT(extraDataLen);
           PRINT(fcc);
+          printf("%s\n",fourCC::tostring(fcc));
           PRINT(w);
           PRINT(h);
           PRINT(fps);
@@ -124,21 +125,33 @@
         // if it is vfw...
         if(fourCC::check(entry.fcc,(uint8_t *)"VFWX") && entry.extraData && entry.extraDataLen>=sizeof(ADM_BITMAPINFOHEADER))
         {
+          ADM_info("VFW compatibility header, data=%d bytes\n",(int)entry.extraDataLen);
           memcpy(& _video_bih,entry.extraData,sizeof(ADM_BITMAPINFOHEADER));
-          delete [] _tracks[0].extraData;
-          entry.extraData=NULL;
-          entry.extraDataLen=0;
 
           _videostream.fccHandler=_video_bih.biCompression;
           _mainaviheader.dwWidth=  _video_bih.biWidth;
           _mainaviheader.dwHeight= _video_bih.biHeight;
+          if(entry.extraDataLen>sizeof(ADM_BITMAPINFOHEADER))
+          {
+                int l=entry.extraDataLen-sizeof(ADM_BITMAPINFOHEADER);
+                _tracks[0].extraData=new uint8_t[l];
+                _tracks[0].extraDataLen=l;
+                memcpy(_tracks[0].extraData,entry.extraData +sizeof(ADM_BITMAPINFOHEADER),l);
+                ADM_info("VFW Header+%d bytes of extradata\n",l);   
+                mixDump(_tracks[0].extraData,l);
+                printf("\n");
+          }
+          delete [] _tracks[0].extraData;
+          entry.extraData=NULL;
+          entry.extraDataLen=0;
 
-        } // FIXME there can be real extradata after bitmapinfoheader
-
-        _tracks[0].extraData=entry.extraData;
-        _tracks[0].extraDataLen=entry.extraDataLen;
+        } 
+        else
+        {
+            _tracks[0].extraData=entry.extraData;
+            _tracks[0].extraDataLen=entry.extraDataLen;
+        }
         _tracks[0].streamIndex=entry.trackNo;
-
         return 1;
       }
       if(entry.trackType==2 && _nbAudioTrack<ADM_MKV_MAX_TRACKS)



From mean at mail.berlios.de  Tue Feb  9 19:47:39 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 9 Feb 2010 19:47:39 +0100
Subject: [Avidemux-svn-commit] r5919 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska
Message-ID: <201002091847.o19Ildn6030582@sheep.berlios.de>

Author: mean
Date: 2010-02-09 19:47:38 +0100 (Tue, 09 Feb 2010)
New Revision: 5919

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp
Log:
[mkv] Fix extradata when vfw mode is used (the end)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp	2010-02-09 06:40:22 UTC (rev 5918)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp	2010-02-09 18:47:38 UTC (rev 5919)
@@ -141,7 +141,7 @@
                 mixDump(_tracks[0].extraData,l);
                 printf("\n");
           }
-          delete [] _tracks[0].extraData;
+          delete [] entry.extraData;
           entry.extraData=NULL;
           entry.extraDataLen=0;
 



From mean at mail.berlios.de  Tue Feb  9 19:47:42 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 9 Feb 2010 19:47:42 +0100
Subject: [Avidemux-svn-commit] r5920 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska
Message-ID: <201002091847.o19IlgxW030610@sheep.berlios.de>

Author: mean
Date: 2010-02-09 19:47:41 +0100 (Tue, 09 Feb 2010)
New Revision: 5920

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv_audio.cpp
Log:
[mkv/audio] Fix crash when no seek points are present

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv_audio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv_audio.cpp	2010-02-09 18:47:38 UTC (rev 5919)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv_audio.cpp	2010-02-09 18:47:41 UTC (rev 5920)
@@ -126,11 +126,16 @@
 bool      mkvAccess::goToTime(uint64_t timeUs)
 {
 uint64_t targetUs=timeUs;
-
+int      clus=-1;
     uint32_t limit=_track->index.size();
+    if(!limit)
+    {
+        ADM_warning("No audio index, cannot seek\n");
+        return false;
+    }
     mkvListOfIndex *dex=&(_track->index);
       // First identify the cluster...
-      int clus=-1;
+
             if(timeUs<(*dex)[0].Dts)
             {
                 clus=0;



From mean at mail.berlios.de  Wed Feb 10 07:43:08 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 10 Feb 2010 07:43:08 +0100
Subject: [Avidemux-svn-commit] r5921 - in
	branches/avidemux_2.6_branch_mean/avidemux_core:
	ADM_coreMuxer/src ADM_coreUtils/include ADM_coreUtils/src
	ADM_coreVideoCodec/src
Message-ID: <201002100643.o1A6h8P7017679@sheep.berlios.de>

Author: mean
Date: 2010-02-10 07:43:08 +0100 (Wed, 10 Feb 2010)
New Revision: 5921

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_coreCodecMapping.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_coreCodecMapping.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_codecFFsimple.cpp
Log:
[Codec] Merge the table doing the fourcc/lavcodec codec id mapping

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-09 18:47:41 UTC (rev 5920)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-10 06:43:08 UTC (rev 5921)
@@ -20,39 +20,15 @@
 #include "fourcc.h"
 #include "ADM_coreMuxerFfmpeg.h"
 #include "ADM_muxerUtils.h"
-
+#include "ADM_coreCodecMapping.h"
 #if 1
 #define aprintf(...) {}
 #else
 #define aprintf printf
 #endif
 
-typedef struct
-{
-    CodecID id;
-    const char *fcc;
-}lavCodecMapper;
 
-static const lavCodecMapper mapper[]={
-    {CODEC_ID_FFVHUFF,"FFVH"},
-    {CODEC_ID_HUFFYUV,"HFYU"},
-    {CODEC_ID_NONE,   "XXXX"},
-};
-
 /**
-    \fn ADM_codecIdFindByFourcc
-*/
-static CodecID ADM_codecIdFindByFourcc(const char *fcc)
-{
-    int nb=sizeof(mapper)/sizeof(lavCodecMapper);
-    for(int i=0;i<nb;i++)
-    {
-        if(!strcmp(fcc,mapper[i].fcc)) return mapper[i].id;
-    }
-    return CODEC_ID_NONE;
-}
-
-/**
     \fn muxerFFmpeg
 */
 muxerFFmpeg::muxerFFmpeg()

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_coreCodecMapping.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_coreCodecMapping.h	2010-02-09 18:47:41 UTC (rev 5920)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_coreCodecMapping.h	2010-02-10 06:43:08 UTC (rev 5921)
@@ -0,0 +1,37 @@
+/***************************************************************************
+                          \fn ADM_coreVideoEncoder
+                          \brief Base class for video encoder plugin
+                             -------------------
+    
+    copyright            : (C) 2002/2009 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_CORE_CODEC_MAPPING_H
+#define ADM_CORE_CODEC_MAPPING_H
+extern "C" {
+#include "ADM_lavcodec.h"
+}
+
+typedef struct
+{
+    const char *string;
+    CodecID    codecId;
+    bool       extraData;
+    bool       refCopy;
+}ffVideoCodec;
+
+/**
+    \fn getCodecIdFromFourcc
+*/
+const ffVideoCodec *getCodecIdFromFourcc(uint32_t fcc);
+CodecID ADM_codecIdFindByFourcc(const char *fcc);
+#endif

Copied: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_coreCodecMapping.cpp (from rev 5920, branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_codecFFsimple.cpp)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_codecFFsimple.cpp	2010-02-09 18:47:41 UTC (rev 5920)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_coreCodecMapping.cpp	2010-02-10 06:43:08 UTC (rev 5921)
@@ -0,0 +1,84 @@
+/***************************************************************************
+                          \fn ADM_coreCodecMapping
+                          \brief Map lavcodec id to fourcc as uint32_t /string
+                          \author mean fixounet at free.fr (c) 2010
+    
+    copyright            : (C) 2002/2009 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "ADM_default.h"
+#include "ADM_coreCodecMapping.h"
+#include "fourcc.h"
+const ffVideoCodec ffCodec[]=
+{
+
+  {"SNOW",  CODEC_ID_SNOW,      false, false},
+  {"cvid",  CODEC_ID_CINEPAK,   false, false},
+  {"CRAM",  CODEC_ID_MSVIDEO1,  false, false},
+  {"VP6F",  CODEC_ID_VP6F,      false, false},
+  {"VP6A",  CODEC_ID_VP6A,      false, false},
+  {"SVQ1",  CODEC_ID_SVQ1,      false, false},
+  {"FLV1",  CODEC_ID_FLV1,      false, false},
+  {"AMV",   CODEC_ID_AMV,       false, false},
+  {"MJPG",  CODEC_ID_MJPEG,     false, false},
+  {"mjpa",  CODEC_ID_MJPEG,     false, false},
+  {"MJPB",  CODEC_ID_MJPEGB,    false, false},
+  {"FPS1",  CODEC_ID_FRAPS,     false, false},
+  {"cvid",  CODEC_ID_CINEPAK,   false, false},
+// Need extradata
+  {"WMV2", CODEC_ID_WMV2,       true, false},
+  {"WMV1", CODEC_ID_WMV1,       true, false},
+  {"WMV3", CODEC_ID_WMV3,       true, false},
+  {"WVC1", CODEC_ID_VC1,        true, false},
+  {"WMVA", CODEC_ID_VC1,        true, false},
+
+  {"WMVA", CODEC_ID_DVVIDEO,    true, false},
+// RefCopy
+  {"FFV1", CODEC_ID_FFV1,       true, true},
+  {"H263", CODEC_ID_H263,       false, true},
+  {"MP42", CODEC_ID_MSMPEG4V2,  true, true},
+  {"SVQ3", CODEC_ID_SVQ3,       true, true},
+
+
+  //{"MJPB", CODEC_ID_CYUV,       true},
+ // {"MJPB", CODEC_ID_THEORA),    true}
+
+};
+
+/**
+    \fn getCodecIdFromFourcc
+*/
+const ffVideoCodec *getCodecIdFromFourcc(uint32_t fcc)
+{
+    uint32_t n=sizeof(ffCodec)/sizeof(ffVideoCodec);
+    for(int i=0;i<n;i++)
+    {
+        const ffVideoCodec *c=ffCodec+i;
+        if(fourCC::check(fcc,(const uint8_t*)c->string))
+            return c;
+    }
+    return NULL;
+}
+
+/**
+    \fn ADM_codecIdFindByFourcc
+*/
+CodecID ADM_codecIdFindByFourcc(const char *fcc)
+{
+    uint32_t nb=sizeof(ffCodec)/sizeof(ffVideoCodec);
+    for(int i=0;i<nb;i++)
+    {
+        if(!strcmp(fcc,ffCodec[i].string)) return ffCodec[i].codecId;
+    }
+    return CODEC_ID_NONE;
+}

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/CMakeLists.txt	2010-02-09 18:47:41 UTC (rev 5920)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/CMakeLists.txt	2010-02-10 06:43:08 UTC (rev 5921)
@@ -9,6 +9,7 @@
 ADM_codecType.cpp
 ADM_file.cpp
 ADM_paramList.cpp
+ADM_coreCodecMapping.cpp
 prefs.cpp)
 
 ADD_LIBRARY(ADM_coreUtils6 SHARED ${ADM_coreUtils_SRCS})

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_codecFFsimple.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_codecFFsimple.cpp	2010-02-09 18:47:41 UTC (rev 5920)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_codecFFsimple.cpp	2010-02-10 06:43:08 UTC (rev 5921)
@@ -16,65 +16,9 @@
 #include "ADM_codecFFsimple.h"
 #include "fourcc.h"
 #include "DIA_coreToolkit.h"
-typedef struct
-{
-    const char *string;
-    CodecID    codecId;
-    bool       extraData;
-    bool       refCopy;
-}ffVideoCodec;
+#include "ADM_coreCodecMapping.h"
 
-const ffVideoCodec ffCodec[]=
-{
-
-  {"SNOW",  CODEC_ID_SNOW,      false, false},
-  {"cvid",  CODEC_ID_CINEPAK,   false, false},
-  {"CRAM",  CODEC_ID_MSVIDEO1,  false, false},
-  {"VP6F",  CODEC_ID_VP6F,      false, false},
-  {"VP6A",  CODEC_ID_VP6A,      false, false},
-  {"SVQ1",  CODEC_ID_SVQ1,      false, false},
-  {"FLV1",  CODEC_ID_FLV1,      false, false},
-  {"AMV",   CODEC_ID_AMV,       false, false},
-  {"MJPG",  CODEC_ID_MJPEG,     false, false},
-  {"mjpa",  CODEC_ID_MJPEG,     false, false},
-  {"MJPB",  CODEC_ID_MJPEGB,    false, false},
-  {"FPS1",  CODEC_ID_FRAPS,     false, false},
-  {"cvid",  CODEC_ID_CINEPAK,   false, false},
-// Need extradata
-  {"WMV2", CODEC_ID_WMV2,       true, false},
-  {"WMV1", CODEC_ID_WMV1,       true, false},
-  {"WMV3", CODEC_ID_WMV3,       true, false},
-  {"WVC1", CODEC_ID_VC1,        true, false},
-  {"WMVA", CODEC_ID_VC1,        true, false},
-
-  {"WMVA", CODEC_ID_DVVIDEO,    true, false},
-// RefCopy
-  {"FFV1", CODEC_ID_FFV1,       true, true},
-  {"H263", CODEC_ID_H263,       false, true},
-  {"MP42", CODEC_ID_MSMPEG4V2,  true, true},
-  {"SVQ3", CODEC_ID_SVQ3,       true, true},
-
-
-  //{"MJPB", CODEC_ID_CYUV,       true},
- // {"MJPB", CODEC_ID_THEORA),    true}
-
-};
 /**
-    \fn getCodecIdFromFourcc
-*/
-static const ffVideoCodec *getCodecIdFromFourcc(uint32_t fcc)
-{
-    uint32_t n=sizeof(ffCodec)/sizeof(ffVideoCodec);
-    for(int i=0;i<n;i++)
-    {
-        const ffVideoCodec *c=ffCodec+i;
-        if(fourCC::check(fcc,(const uint8_t*)c->string))
-            return c;
-    }
-    return NULL;
-}
-
-/**
     \fn decoderFFSimple
 */
 decoderFFSimple::decoderFFSimple (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp)



From mean at mail.berlios.de  Thu Feb 11 07:36:14 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 11 Feb 2010 07:36:14 +0100
Subject: [Avidemux-svn-commit] r5922 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src
Message-ID: <201002110636.o1B6aE3L005037@sheep.berlios.de>

Author: mean
Date: 2010-02-11 07:36:02 +0100 (Thu, 11 Feb 2010)
New Revision: 5922

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_coreCodecMapping.cpp
Log:
[codecmapping ] Add huffs

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_coreCodecMapping.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_coreCodecMapping.cpp	2010-02-10 06:43:08 UTC (rev 5921)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_coreCodecMapping.cpp	2010-02-11 06:36:02 UTC (rev 5922)
@@ -48,11 +48,14 @@
   {"H263", CODEC_ID_H263,       false, true},
   {"MP42", CODEC_ID_MSMPEG4V2,  true, true},
   {"SVQ3", CODEC_ID_SVQ3,       true, true},
+  {"FFVH", CODEC_ID_FFVHUFF,    true, true},
+  {"HFYU", CODEC_ID_HUFFYUV,    true, true},
 
-
+ //{CODEC_ID_FFVHUFF,"FFVH"},
+//    {CODEC_ID_HUFFYUV,"HFYU"},
   //{"MJPB", CODEC_ID_CYUV,       true},
  // {"MJPB", CODEC_ID_THEORA),    true}
-
+  {"xxxx", CODEC_ID_NONE, false,false}
 };
 
 /**



From mean at mail.berlios.de  Thu Feb 11 07:36:19 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 11 Feb 2010 07:36:19 +0100
Subject: [Avidemux-svn-commit] r5923 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer:
	include src
Message-ID: <201002110636.o1B6aJiW005101@sheep.berlios.de>

Author: mean
Date: 2010-02-11 07:36:17 +0100 (Thu, 11 Feb 2010)
New Revision: 5923

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
Log:
[ffcoremuxer] Add some hooks to ease debug of muxer

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h	2010-02-11 06:36:02 UTC (rev 5922)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h	2010-02-11 06:36:17 UTC (rev 5923)
@@ -36,6 +36,7 @@
 class muxerFFmpeg : public ADM_muxer
 {
 protected:
+        bool    writePacket(AVPacket *pkt);
         virtual bool muxerRescaleVideoTime(uint64_t *time)
         {
              AVRational *scale=&(video_st->time_base);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-11 06:36:02 UTC (rev 5922)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-11 06:36:17 UTC (rev 5923)
@@ -26,8 +26,21 @@
 #else
 #define aprintf printf
 #endif
+/**
+    \fn writePacket
+*/
+bool muxerFFmpeg::writePacket(AVPacket *pkt)
+{
+#if 0
+        printf("Track :%d size :%d PTS:%"LLD" DTS:%"LLD"\n",
+                    pkt->stream_index,pkt->size,pkt->pts,pkt->dts);
+#endif
+    int ret =av_write_frame(oc, pkt);
+    if(ret)
+        return false;
+    return true;
+}
 
-
 /**
     \fn muxerFFmpeg
 */
@@ -427,9 +440,9 @@
             pkt.size= len;
             if(flags & 0x10) // FIXME AVI_KEY_FRAME
                         pkt.flags |= PKT_FLAG_KEY;
-            ret =av_write_frame(oc, &pkt);
+            ret =writePacket( &pkt);
             aprintf("[FF]Frame:%u, DTS=%08lu PTS=%08lu\n",written,dts,pts);
-            if(ret)
+            if(false==ret)
             {
                 printf("[FF]Error writing video packet\n");
                 break;
@@ -464,6 +477,7 @@
                     }
                     if(audioTrack->dts!=ADM_NO_PTS)
                     {
+                        //printf("Audio PTS:%"LLD", limit=%"LLD"\n",audioTrack->dts,lastVideoDts+videoIncrement);
                         if(audioTrack->dts>lastVideoDts+videoIncrement) break; // This packet is in the future
                     }
                     // Write...
@@ -481,9 +495,9 @@
                     pkt.data= audioTrack->buffer;
                     pkt.size= audioTrack->size;
                     pkt.flags |= PKT_FLAG_KEY; // Assume all audio are keyframe, which is slightly wrong
-                    ret =av_write_frame(oc, &pkt);
+                    ret =writePacket( &pkt);
                     audioTrack->present=false; // consumed
-                    if(ret)
+                    if(false==ret)
                     {
                         ADM_warning("[FF]Error writing audio packet\n");
                         break;



From mean at mail.berlios.de  Sat Feb 13 21:10:42 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 13 Feb 2010 21:10:42 +0100
Subject: [Avidemux-svn-commit] r5924 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame
Message-ID: <201002132010.o1DKAgYi005530@sheep.berlios.de>

Author: mean
Date: 2010-02-13 21:10:42 +0100 (Sat, 13 Feb 2010)
New Revision: 5924

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp
Log:
[lame] Fill in the # of sample in the packet, it is not an accurate value and can be off by one packet

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp	2010-02-11 06:36:17 UTC (rev 5923)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp	2010-02-13 20:10:42 UTC (rev 5924)
@@ -244,6 +244,8 @@
   *len = nbout;
   if (!*len)
     *samples = 0;
+  else
+    *samples=BLOCK_SIZE;
   return true;
 }
 /**



From mean at mail.berlios.de  Sat Feb 13 21:10:44 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 13 Feb 2010 21:10:44 +0100
Subject: [Avidemux-svn-commit] r5925 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src
Message-ID: <201002132010.o1DKAiTw005543@sheep.berlios.de>

Author: mean
Date: 2010-02-13 21:10:44 +0100 (Sat, 13 Feb 2010)
New Revision: 5925

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp
Log:
[access] cosmetic

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp	2010-02-13 20:10:42 UTC (rev 5924)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp	2010-02-13 20:10:44 UTC (rev 5925)
@@ -96,9 +96,10 @@
         return false;
     }
 
-    float d=(float)samplesSeen/(float)(filter->getInfo()->frequency);
-    d*=1000*1000;
+    float d=(float)samplesSeen*1000.*1000.;
+    d/=(float)(filter->getInfo()->frequency);
     *dts=startTimeUs+(uint64_t)d;
+    //printf("EncoderAccess: dts=%"LLD"\n",*dts);
     samplesSeen+=samples;
     endMet=false;
     return true;



From mean at mail.berlios.de  Sat Feb 13 21:10:45 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 13 Feb 2010 21:10:45 +0100
Subject: [Avidemux-svn-commit] r5926 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src
Message-ID: <201002132010.o1DKAjgD005553@sheep.berlios.de>

Author: mean
Date: 2010-02-13 21:10:45 +0100 (Sat, 13 Feb 2010)
New Revision: 5926

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamBuffered.cpp
Log:
[audio] Increase acceptable skew for DTS to allow lame to work as it makes +1/-1 packet

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamBuffered.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamBuffered.cpp	2010-02-13 20:10:44 UTC (rev 5925)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamBuffered.cpp	2010-02-13 20:10:45 UTC (rev 5926)
@@ -6,7 +6,7 @@
 #include "ADM_default.h"
 #include "ADM_audioStreamBuffered.h"
 
-#define ADM_MAX_SKEW 10000
+#define ADM_MAX_SKEW 40000
 
 /**
     \fn ADM_audioStreamBuffered



From mean at mail.berlios.de  Sat Feb 13 21:10:47 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 13 Feb 2010 21:10:47 +0100
Subject: [Avidemux-svn-commit] r5927 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src
Message-ID: <201002132010.o1DKAlhl005563@sheep.berlios.de>

Author: mean
Date: 2010-02-13 21:10:46 +0100 (Sat, 13 Feb 2010)
New Revision: 5927

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_bridge.cpp
Log:
[audioBridge] Add some debug code (commented out)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_bridge.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_bridge.cpp	2010-02-13 20:10:45 UTC (rev 5926)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_bridge.cpp	2010-02-13 20:10:46 UTC (rev 5927)
@@ -143,6 +143,7 @@
         break;
       }
       endMet=false;
+      //printf("Bridge : Packet width DTS=%"LLD"\n",dts);
       _tail+=got;
       if(_hold>0)
       {



From mean at mail.berlios.de  Sat Feb 13 21:10:48 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 13 Feb 2010 21:10:48 +0100
Subject: [Avidemux-svn-commit] r5928 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src
Message-ID: <201002132010.o1DKAmAx005574@sheep.berlios.de>

Author: mean
Date: 2010-02-13 21:10:47 +0100 (Sat, 13 Feb 2010)
New Revision: 5928

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_thread.cpp
Log:
[audioFilter_thread] Add some debug code, commented out

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_thread.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_thread.cpp	2010-02-13 20:10:46 UTC (rev 5927)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_thread.cpp	2010-02-13 20:10:47 UTC (rev 5928)
@@ -134,12 +134,14 @@
         mutex->lock();
         if(list.size())
         {
+            //
             // Dequeue one item
             ADM_audioPacket *pkt=&(list[0]);
             ADM_assert(pkt->data);
             ADM_assert(pkt->dataLen<maxSize);
             memcpy(buffer,pkt->data,pkt->dataLen);
             *dts=pkt->dts;
+            //printf("popping Packet with DTS=%"LLD", size=%d\n",*dts,(int)pkt->dataLen);
             *size=pkt->dataLen;
             delete [] pkt->data;
             pkt->data=NULL;
@@ -184,6 +186,7 @@
         p.dts=dts;
         mutex->lock();
         list.push_back(p);
+        //printf("Pushing Packet with DTS=%"LLD",size=%d\n",dts,(int)size);
         mutex->unlock();
         if(threadState==RunStateStopOrder)  
         {



From mean at mail.berlios.de  Sat Feb 13 21:10:52 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 13 Feb 2010 21:10:52 +0100
Subject: [Avidemux-svn-commit] r5930 - in branches/avidemux_2.6_branch_mean:
	avidemux/common/ADM_audioFilter/src
	avidemux_core/ADM_coreAudioEncoder/include
	avidemux_plugins/ADM_audioEncoders/lame
Message-ID: <201002132010.o1DKAq4R005594@sheep.berlios.de>

Author: mean
Date: 2010-02-13 21:10:52 +0100 (Sat, 13 Feb 2010)
New Revision: 5930

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoder.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoderInternal.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.h
Log:
[audioEncoder] Handle case here audio encoder does not provide accurate sample per packet count, in that case rely entirely on the audio parser (.e.g lame when bitrate reservoir is on

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp	2010-02-13 20:10:49 UTC (rev 5929)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_access.cpp	2010-02-13 20:10:52 UTC (rev 5930)
@@ -98,7 +98,16 @@
 
     float d=(float)samplesSeen*1000.*1000.;
     d/=(float)(filter->getInfo()->frequency);
-    *dts=startTimeUs+(uint64_t)d;
+    if(false==encoder->provideAccurateSample())
+    {
+        if(!samplesSeen) 
+            *dts=startTimeUs;
+         else 
+            *dts=ADM_AUDIO_NO_DTS;  // rely on the parser to get exact DTS
+    }else   
+    {
+        *dts=startTimeUs+(uint64_t)d;
+    }
     //printf("EncoderAccess: dts=%"LLD"\n",*dts);
     samplesSeen+=samples;
     endMet=false;

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoder.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoder.h	2010-02-13 20:10:49 UTC (rev 5929)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoder.h	2010-02-13 20:10:52 UTC (rev 5930)
@@ -67,5 +67,7 @@
     virtual bool    isVBR(void) {return true;}
     virtual bool    initialize(void)=0; /// Returns true if init ok, false if encoding is impossible
     virtual bool    encode(uint8_t *dest, uint32_t *len, uint32_t *samples)=0; /// returns false if eof met
+    virtual bool    provideAccurateSample(void) {return true;} /// Some encoder does not provide samples, in that case
+                                                                /// Return false, but the matching parser must exist!
 };
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoderInternal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoderInternal.h	2010-02-13 20:10:49 UTC (rev 5929)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoderInternal.h	2010-02-13 20:10:52 UTC (rev 5930)
@@ -15,7 +15,7 @@
 #ifndef AUDIOENCODERINTERNAL_H
 #define AUDIOENCODERINTERNAL_H
 
-#define ADM_AUDIO_ENCODER_API_VERSION 4
+#define ADM_AUDIO_ENCODER_API_VERSION 5
 #include "stddef.h"
 #include "audioencoder.h"
 #include "ADM_paramList.h"

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.h	2010-02-13 20:10:49 UTC (rev 5929)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.h	2010-02-13 20:10:52 UTC (rev 5930)
@@ -34,6 +34,7 @@
             
    virtual bool         encode(uint8_t *dest, uint32_t *len, uint32_t *samples);
    virtual bool         initialize(void);
+           bool         provideAccurateSample(void) {return false;} 
 };
 
 #endif



From mean at mail.berlios.de  Sat Feb 13 21:10:50 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 13 Feb 2010 21:10:50 +0100
Subject: [Avidemux-svn-commit] r5929 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src
Message-ID: <201002132010.o1DKAoka005584@sheep.berlios.de>

Author: mean
Date: 2010-02-13 21:10:49 +0100 (Sat, 13 Feb 2010)
New Revision: 5929

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamMP3.cpp
Log:
[audioMp3] Add some debug code, commented out

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamMP3.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamMP3.cpp	2010-02-13 20:10:47 UTC (rev 5928)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamMP3.cpp	2010-02-13 20:10:49 UTC (rev 5929)
@@ -114,7 +114,9 @@
                 *nbSample=info.samples;
                 //if(info.samples!=1152) ADM_assert(0);
                 *dts=lastDts;
+            //    printf("MP3 DTS =%"LLD" ->",*dts);
                 advanceDtsBySample(*nbSample);
+                //printf("%"LLD" , size=%d\n",*dts,*size);
                 return 1;
             }
             



From mean at mail.berlios.de  Sat Feb 13 21:10:53 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 13 Feb 2010 21:10:53 +0100
Subject: [Avidemux-svn-commit] r5931 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src
Message-ID: <201002132010.o1DKArln005604@sheep.berlios.de>

Author: mean
Date: 2010-02-13 21:10:53 +0100 (Sat, 13 Feb 2010)
New Revision: 5931

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_coreCodecMapping.cpp
Log:
[codecId] More complete mapping between codec fourcc and lavcodec internal type

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_coreCodecMapping.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_coreCodecMapping.cpp	2010-02-13 20:10:52 UTC (rev 5930)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_coreCodecMapping.cpp	2010-02-13 20:10:53 UTC (rev 5931)
@@ -18,6 +18,7 @@
 
 #include "ADM_default.h"
 #include "ADM_coreCodecMapping.h"
+#include "ADM_codecType.h"
 #include "fourcc.h"
 const ffVideoCodec ffCodec[]=
 {
@@ -60,6 +61,7 @@
 
 /**
     \fn getCodecIdFromFourcc
+    \brief get fourcc and encoder settings from fourcc (used by encoder)
 */
 const ffVideoCodec *getCodecIdFromFourcc(uint32_t fcc)
 {
@@ -75,9 +77,29 @@
 
 /**
     \fn ADM_codecIdFindByFourcc
+    \brief get lav codec if from fourcc (used by muxer)
 */
 CodecID ADM_codecIdFindByFourcc(const char *fcc)
 {
+    uint32_t fid=fourCC::get((uint8_t *)fcc);
+    // Special cases
+ if (isMSMpeg4Compatible (fid) == 1)
+    {
+      return CODEC_ID_MSMPEG4V3;
+    }
+  if (isDVCompatible(fid))//"CDVC"))
+    {
+      return CODEC_ID_DVVIDEO;
+    }
+  if (isH264Compatible (fid))
+    {
+        return CODEC_ID_H264;
+    }
+  if (isMpeg4Compatible (fid) == 1)
+    {
+      return CODEC_ID_MPEG4;
+    }
+
     uint32_t nb=sizeof(ffCodec)/sizeof(ffVideoCodec);
     for(int i=0;i<nb;i++)
     {



From mean at mail.berlios.de  Mon Feb 15 19:06:52 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 15 Feb 2010 19:06:52 +0100
Subject: [Avidemux-svn-commit] r5932 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script
Message-ID: <201002151806.o1FI6qW8028071@sheep.berlios.de>

Author: mean
Date: 2010-02-15 19:06:49 +0100 (Mon, 15 Feb 2010)
New Revision: 5932

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemuxAudio.cpp
Log:
[script] pal2film != pal2Film, fixes #78

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemuxAudio.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemuxAudio.cpp	2010-02-13 20:10:53 UTC (rev 5931)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemuxAudio.cpp	2010-02-15 18:06:49 UTC (rev 5932)
@@ -33,8 +33,8 @@
         { "process", audioprocess_prop, JSPROP_ENUMERATE },        // process audio when saving
         { "resample", resample_prop, JSPROP_ENUMERATE },	// resample
         { "delay", delay_prop, JSPROP_ENUMERATE },	// set audio delay
-        { "film2Pal", film2pal_prop, JSPROP_ENUMERATE },	// convert film to pal
-        { "pal2Film", pal2film_prop, JSPROP_ENUMERATE },	// convert pal to film
+        { "film2pal", film2pal_prop, JSPROP_ENUMERATE },	// convert film to pal
+        { "pal2film", pal2film_prop, JSPROP_ENUMERATE },	// convert pal to film
         { "normalizeMode", normalizemode_prop, JSPROP_ENUMERATE },	//
         { "drc", drc_prop, JSPROP_ENUMERATE },	//
         { "normalizeValue", normalizevalue_prop, JSPROP_ENUMERATE },	//



From mean at mail.berlios.de  Mon Feb 15 19:37:47 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 15 Feb 2010 19:37:47 +0100
Subject: [Avidemux-svn-commit] r5933 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec
Message-ID: <201002151837.o1FIblRG016067@sheep.berlios.de>

Author: mean
Date: 2010-02-15 19:37:47 +0100 (Mon, 15 Feb 2010)
New Revision: 5933

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/dvEncoder.cpp
Log:
[encoder] Cannot use context->pix_fmt in open as context is not allocated yet. it does not crash anymore, not sure it is 100% what was wanted, ref #77

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/dvEncoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/dvEncoder.cpp	2010-02-15 18:06:49 UTC (rev 5932)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/dvEncoder.cpp	2010-02-15 18:37:47 UTC (rev 5933)
@@ -58,8 +58,9 @@
 		{
 			if (properties->height == dvProfiles[i].height && properties->width == dvProfiles[i].width && 
 				((int)(properties->fpsNum * 1000.0 / properties->fpsDen) == (int)(dvProfiles[i].timeBase.num * 1000.0 / dvProfiles[i].timeBase.den)))
-			{
-				_context->pix_fmt = getAvCodecColourSpace(dvProfiles[i].pixFmt);
+			{
+#warning not sure it fixes all
+				//_context->pix_fmt = getAvCodecColourSpace(dvProfiles[i].pixFmt);
 				_supportedCsps[0] = dvProfiles[i].pixFmt;
 				validProfile = true;
 				break;



From gruntster at mail.berlios.de  Mon Feb 15 22:27:16 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 15 Feb 2010 22:27:16 +0100
Subject: [Avidemux-svn-commit] r5934 - in
	branches/avidemux_2.5_branch_gruntster/cmake: . patches
Message-ID: <201002152127.o1FLRGfC001257@sheep.berlios.de>

Author: gruntster
Date: 2010-02-15 22:27:08 +0100 (Mon, 15 Feb 2010)
New Revision: 5934

Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
Log:
[ffmpeg] update FFmpeg to r21837 & libswscale to r30589

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2010-02-15 18:37:47 UTC (rev 5933)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2010-02-15 21:27:08 UTC (rev 5934)
@@ -1,7 +1,7 @@
 include(admFFmpegUtil)
 
-set(FFMPEG_VERSION 21394)	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=42e589b65e001e0888fd3e676ebf7bb8c44e9b36;sf=tgz
-set(SWSCALE_VERSION 30400)	# http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=281ba1ce52f8df13ec9da3cc6c913a804251918c;sf=tgz
+set(FFMPEG_VERSION 21837)	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=0b7f4c254edd1c4ef6a2538dff236d5a853c360d;sf=tgz
+set(SWSCALE_VERSION 30589)	# http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=12beb744c2c61620d3259fc832ff1853cef9a9c0;sf=tgz
 
 set(LIBRARY_SOURCE_DIR "${CMAKE_SOURCE_DIR}/avidemux/ADM_libraries")
 set(FFMPEG_SOURCE_DIR "${LIBRARY_SOURCE_DIR}/ffmpeg")

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2010-02-15 18:37:47 UTC (rev 5933)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2010-02-15 21:27:08 UTC (rev 5934)
@@ -1,8 +1,8 @@
-*** libavcodec/avcodec.h.old	Sat Jan 23 11:31:04 2010
---- libavcodec/avcodec.h	Sat Jan 23 11:31:05 2010
+*** libavcodec/avcodec.h.old	Mon Feb 15 19:01:58 2010
+--- libavcodec/avcodec.h	Mon Feb 15 19:01:58 2010
 ***************
-*** 584,589 ****
---- 584,591 ----
+*** 589,594 ****
+--- 589,596 ----
   #define CODEC_FLAG2_NON_LINEAR_QUANT 0x00010000 ///< Use MPEG-2 nonlinear quantizer.
   #define CODEC_FLAG2_BIT_RESERVOIR 0x00020000 ///< Use a bit reservoir when encoding if possible
   #define CODEC_FLAG2_MBTREE        0x00040000 ///< Use macroblock tree ratecontrol (x264 only)
@@ -12,8 +12,8 @@
   /* Unsupported options :
    *              Syntax Arithmetic coding (SAC)
 ***************
-*** 1450,1455 ****
---- 1452,1458 ----
+*** 1457,1462 ****
+--- 1459,1465 ----
        * - decoding: unused
        */
       int rc_max_rate;
@@ -22,8 +22,8 @@
       /**
        * minimum bitrate
 ***************
-*** 1464,1469 ****
---- 1467,1474 ----
+*** 1471,1476 ****
+--- 1474,1481 ----
        * - decoding: unused
        */
       int rc_buffer_size;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2010-02-15 18:37:47 UTC (rev 5933)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2010-02-15 21:27:08 UTC (rev 5934)
@@ -1,8 +1,8 @@
-*** libavcodec/h264.c.old	Tue Jan 19 19:20:51 2010
---- libavcodec/h264.c	Tue Jan 19 19:20:52 2010
+*** libavcodec/h264.c.old	Mon Feb 15 19:02:02 2010
+--- libavcodec/h264.c	Mon Feb 15 19:02:02 2010
 ***************
-*** 3113,3118 ****
---- 3113,3129 ----
+*** 3111,3116 ****
+--- 3111,3127 ----
       return 0;
   }
   

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2010-02-15 18:37:47 UTC (rev 5933)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2010-02-15 21:27:08 UTC (rev 5934)
@@ -1,8 +1,8 @@
-*** libavcodec/utils.c.old	Thu Jan  7 19:26:08 2010
---- libavcodec/utils.c	Thu Jan  7 19:26:09 2010
+*** libavcodec/utils.c.old	Mon Feb 15 19:02:16 2010
+--- libavcodec/utils.c	Mon Feb 15 19:02:16 2010
 ***************
-*** 616,625 ****
---- 616,627 ----
+*** 618,627 ****
+--- 618,629 ----
   
       if((avctx->codec->capabilities & CODEC_CAP_DELAY) || avpkt->size){
           //FIXME remove the check below _after_ ensuring that all audio check that the available space is enough
@@ -16,7 +16,7 @@
           *frame_size_ptr < avctx->channels * avctx->frame_size * sizeof(int16_t)){
               av_log(avctx, AV_LOG_ERROR, "buffer %d too small\n", *frame_size_ptr);
 ***************
-*** 1056,1062 ****
+*** 1058,1064 ****
           return -1;
       }
   #if !HAVE_MKSTEMP
@@ -24,7 +24,7 @@
   #else
       snprintf(*filename, len, "/tmp/%sXXXXXX", prefix);
       fd = mkstemp(*filename);
---- 1058,1064 ----
+--- 1060,1066 ----
           return -1;
       }
   #if !HAVE_MKSTEMP



From gruntster at mail.berlios.de  Mon Feb 15 22:32:44 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Mon, 15 Feb 2010 22:32:44 +0100
Subject: [Avidemux-svn-commit] r5935 - in
	branches/avidemux_2.5_branch_gruntster/platforms/windows:
	build_scripts build_scripts/avidemux installer
Message-ID: <201002152132.o1FLWib0001920@sheep.berlios.de>

Author: gruntster
Date: 2010-02-15 22:32:37 +0100 (Mon, 15 Feb 2010)
New Revision: 5935

Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
Log:
[win32] update build scripts with latest dependencies

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat	2010-02-15 21:27:08 UTC (rev 5934)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat	2010-02-15 21:32:37 UTC (rev 5935)
@@ -7,7 +7,7 @@
 set devDir=E:\Dev
 
 if "%BuildBits%" == "32" (
-	set mingwDir=%devDir%\MinGW
+	set mingwDir=%devDir%\MinGW32
 	set msysDir=E:/Dev/MSYS
 	set qtDir=%devDir%\Qt
 	goto :setVars )
@@ -27,10 +27,16 @@
 set CMAKE_LIBRARY_PATH=%usrLocalDir%/lib
 set PKG_CONFIG_PATH=%usrLocalDir%\lib\pkgconfig
 set SDLDIR=%usrLocalDir%
-set CFLAGS=-I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH% -I%mingwDir:\=/%/i686-w64-mingw32/include/directx
+set CFLAGS=-I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
 set CXXFLAGS=-I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
 set LDFLAGS=-L%CMAKE_LIBRARY_PATH%
 
+if "%BuildBits%" == "32" (
+	set CFLAGS=%CFLAGS% -I%mingwDir:\=/%/i686-w64-mingw32/include/directx )
+
+if "%BuildBits%" == "64" (
+	set CFLAGS=%CFLAGS% -I%mingwDir:\=/%/x86_64-w64-mingw32/include/directx )
+
 if exist "%qtDir%" (
 	for /f %%d in ('dir /b /ad /on %qtDir%') do set qtVer=%%d
 ) else (

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml	2010-02-15 21:27:08 UTC (rev 5934)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml	2010-02-15 21:32:37 UTC (rev 5935)
@@ -1,5 +1,29 @@
 <?xml version="1.0"?>
 <log>
+  <buildentry revision="5869" date="2010-01-23">
+    <comment>Updated GLib to version 2.22.4-1.</comment>
+    <comment>Updated Qt to version 4.6.1.</comment>
+    <comment>Updated x264 to r1400.</comment>
+  </buildentry>
+  <buildentry revision="5830" date="2010-01-07">
+    <comment>Compiled with GCC 4.4.3 pre-release (r155431).</comment>
+  </buildentry>
+  <buildentry revision="5810" date="2010-01-02">
+  </buildentry>
+  <buildentry revision="5801" date="2009-12-31">
+  </buildentry>
+  <buildentry revision="5775" date="2009-12-29">
+  </buildentry>
+  <buildentry revision="5747" date="2009-12-28">
+  </buildentry>
+  <buildentry revision="5676" date="2009-12-20">
+    <comment>Packaged using NSIS 2.46.</comment>
+    <comment>Updated GTK+ to version 2.18.5-1.</comment>
+    <comment>Updated libpng to version 1.2.40-1.</comment>
+    <comment>Updated Pango to version 1.26.1-1.</comment>
+    <comment>Updated Qt to version 4.6.0.</comment>
+    <comment>Updated x264 to r1376.</comment>
+  </buildentry>
   <buildentry revision="5660 [2.5.2 Final]" date="2009-12-19">
   </buildentry>
   <buildentry revision="5636 [2.5.2 RC1]" date="2009-12-12">

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2010-02-15 21:27:08 UTC (rev 5934)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2010-02-15 21:32:37 UTC (rev 5935)
@@ -15,7 +15,14 @@
 ##########################
 # Defines
 ##########################
+!define DISPLAYNAME "Avidemux 2.5"
+
+!if BUILD_BITS == 64
+!define INTERNALNAME "Avidemux 2.5 (64-bit)"
+!else
 !define INTERNALNAME "Avidemux 2.5"
+!endif
+
 !define REGKEY "SOFTWARE\${INTERNALNAME}"
 !define UNINST_REGKEY "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${INTERNALNAME}"
 !define VERSION 2.5.2.${REVISION}
@@ -36,13 +43,13 @@
 !endif
 
 !ifdef INST_BOTH
-OutFile ${EXEDIR}\avidemux_2.5_r${REVISION}_full_win32.exe
+OutFile ${EXEDIR}\avidemux_2.5_r${REVISION}_full_win${BUILD_BITS}.exe
 Name "Avidemux 2.5.2 Full beta r${REVISION}"
 !else ifdef INST_QT
-OutFile ${EXEDIR}\avidemux_2.5_r${REVISION}_win32.exe
+OutFile ${EXEDIR}\avidemux_2.5_r${REVISION}_win${BUILD_BITS}.exe
 Name "Avidemux 2.5.2 beta r${REVISION}"
 !else ifdef INST_GTK
-OutFile ${EXEDIR}\avidemux_2.5_r${REVISION}_gtk_win32.exe
+OutFile ${EXEDIR}\avidemux_2.5_r${REVISION}_gtk_win${BUILD_BITS}.exe
 Name "Avidemux 2.5.2 GTK+ beta r${REVISION}"
 !endif
 
@@ -108,7 +115,7 @@
 !insertmacro MUI_PAGE_INSTFILES
 !define MUI_FINISHPAGE_RUN
 !define MUI_FINISHPAGE_RUN_FUNCTION RunAvidemux
-!define MUI_FINISHPAGE_RUN_TEXT "Run ${INTERNALNAME} now"
+!define MUI_FINISHPAGE_RUN_TEXT "Run ${DISPLAYNAME} now"
 !define MUI_FINISHPAGE_SHOWREADME "$INSTDIR\Change Log.html"
 !define MUI_FINISHPAGE_SHOWREADME_TEXT "View Change Log now"
 !define MUI_FINISHPAGE_LINK "Visit the Avidemux Builds for Windows website"
@@ -130,7 +137,7 @@
 ##########################
 # Installer attributes
 ##########################
-InstallDir "$PROGRAMFILES\${INTERNALNAME}"
+InstallDir "$PROGRAMFILES\${DISPLAYNAME}"
 CRCCheck on
 XPStyle on
 ShowInstDetails nevershow
@@ -263,16 +270,27 @@
     ${File} "Build Info.txt"
     ${File} "Change Log.html"
     ${File} zlib1.dll
+    
+!if BUILD_BITS == 32
     ${File} freetype6.dll
+    ${File} libnspr4.dll
+    ${File} libstdc++.dll
+!endif
+
+!if BUILD_BITS == 64
+	${File} libfreetype-6.dll
+	${File} libstdc++-6.dll
+!endif
+
+	${File} libgcc_s_sjlj-1.dll
+	${File} libogg-0.dll
     ${File} libjs.dll
-    ${File} libnspr4.dll
     ${File} libADM_core.dll
     ${File} libADM_coreAudio.dll
     ${File} libADM_coreImage.dll
     ${File} libADM_coreUI.dll
     ${File} libaften.dll
     ${File} libxml2-*.dll
-    ${File} ogg.dll
     ${File} pthreadGC2.dll
     ${File} SDL.dll
     ${File} AUTHORS.
@@ -283,8 +301,6 @@
     ${File} avutil-*.dll
     ${File} postproc-*.dll
     ${File} swscale-*.dll
-    ${File} libgcc_s_sjlj-*.dll
-    ${File} libstdc++.dll
     SetOutPath $INSTDIR\scripts
     ${Folder} scripts
 SectionEnd
@@ -335,7 +351,7 @@
         ${File} libpangocairo-1.0-0.dll
         ${File} libpangoft2-1.0-0.dll
         ${File} libpangowin32-1.0-0.dll
-        ${File} libpng12-0.dll
+        ${File} libpng14-14.dll
     ${MementoSectionEnd}
 !endif
 
@@ -459,8 +475,8 @@
 			SetOutPath $INSTDIR\plugins\audioEncoders
 			${File} plugins\audioEncoders\libADM_ae_vorbis.dll
 			SetOutPath $INSTDIR
-			${File} vorbis.dll
-			${File} vorbisenc.dll
+			${File} libvorbis-0.dll
+			${File} libvorbisenc-2.dll
 		${MementoSectionEnd}
 		${MementoSection} "PCM" SecAudEncPcm
 			SectionIn 1 2
@@ -1302,7 +1318,7 @@
     CreateDirectory $SMPROGRAMS\$StartMenuGroup
     !insertmacro MUI_STARTMENU_WRITE_BEGIN Application
     SetOutPath $INSTDIR
-    CreateShortcut "$SMPROGRAMS\$StartMenuGroup\${INTERNALNAME} GTK+.lnk" $INSTDIR\avidemux2_gtk.exe
+    CreateShortcut "$SMPROGRAMS\$StartMenuGroup\${DISPLAYNAME} GTK+.lnk" $INSTDIR\avidemux2_gtk.exe
     !insertmacro MUI_STARTMENU_WRITE_END
 !endif
 ${MementoSectionEnd}
@@ -1312,7 +1328,7 @@
     CreateDirectory $SMPROGRAMS\$StartMenuGroup
     !insertmacro MUI_STARTMENU_WRITE_BEGIN Application
     SetOutPath $INSTDIR
-    CreateShortcut "$SMPROGRAMS\$StartMenuGroup\${INTERNALNAME}.lnk" $INSTDIR\avidemux2_qt4.exe
+    CreateShortcut "$SMPROGRAMS\$StartMenuGroup\${DISPLAYNAME}.lnk" $INSTDIR\avidemux2_qt4.exe
     !insertmacro MUI_STARTMENU_WRITE_END
 !endif
 ${MementoSectionEnd}
@@ -1328,28 +1344,28 @@
 ${MementoSection} "-Quick Launch GTK+" SecQuickLaunchGtk
 !ifdef INST_GTK
     SetOutPath $INSTDIR
-    CreateShortcut "$QUICKLAUNCH\${INTERNALNAME} GTK+.lnk" $INSTDIR\avidemux2_gtk.exe
+    CreateShortcut "$QUICKLAUNCH\${DISPLAYNAME} GTK+.lnk" $INSTDIR\avidemux2_gtk.exe
 !endif
 ${MementoSectionEnd}
 
 ${MementoSection} "-Quick Launch Qt" SecQuickLaunchQt
 !ifdef INST_QT
     SetOutPath $INSTDIR
-    CreateShortcut "$QUICKLAUNCH\${INTERNALNAME}.lnk" $INSTDIR\avidemux2_qt4.exe
+    CreateShortcut "$QUICKLAUNCH\${DISPLAYNAME}.lnk" $INSTDIR\avidemux2_qt4.exe
 !endif
 ${MementoSectionEnd}
 
 ${MementoSection} "-Desktop GTK+" SecDesktopGtk
 !ifdef INST_GTK
     SetOutPath $INSTDIR
-    CreateShortcut "$DESKTOP\${INTERNALNAME} GTK+.lnk" $INSTDIR\avidemux2_gtk.exe
+    CreateShortcut "$DESKTOP\${DISPLAYNAME} GTK+.lnk" $INSTDIR\avidemux2_gtk.exe
 !endif
 ${MementoSectionEnd}
 
 ${MementoSection} "-Desktop Qt" SecDesktopQt
 !ifdef INST_QT
     SetOutPath $INSTDIR
-    CreateShortcut "$DESKTOP\${INTERNALNAME}.lnk" $INSTDIR\avidemux2_qt4.exe
+    CreateShortcut "$DESKTOP\${DISPLAYNAME}.lnk" $INSTDIR\avidemux2_qt4.exe
 !endif
 ${MementoSectionEnd}
 
@@ -1361,7 +1377,7 @@
     WriteRegStr HKLM "${REGKEY}" Version ${VERSION}
     SetOutPath $INSTDIR
     WriteUninstaller $INSTDIR\uninstall.exe
-    WriteRegStr HKLM "${UNINST_REGKEY}" DisplayName "${INTERNALNAME}"
+    WriteRegStr HKLM "${UNINST_REGKEY}" DisplayName "${DISPLAYNAME}"
     WriteRegStr HKLM "${UNINST_REGKEY}" DisplayVersion "${VERSION}"
     WriteRegStr HKLM "${UNINST_REGKEY}" DisplayIcon $INSTDIR\uninstall.exe
     WriteRegStr HKLM "${UNINST_REGKEY}" UninstallString $INSTDIR\uninstall.exe
@@ -1378,15 +1394,15 @@
 	!insertmacro MUI_STARTMENU_GETFOLDER Application $StartMenuGroup	
 
 !ifdef INST_GTK
-	Delete /REBOOTOK "$QUICKLAUNCH\${INTERNALNAME} GTK+.lnk"
-    Delete /REBOOTOK "$DESKTOP\${INTERNALNAME} GTK+.lnk"
-    Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\${INTERNALNAME} GTK+.lnk"
+	Delete /REBOOTOK "$QUICKLAUNCH\${DISPLAYNAME} GTK+.lnk"
+    Delete /REBOOTOK "$DESKTOP\${DISPLAYNAME} GTK+.lnk"
+    Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\${DISPLAYNAME} GTK+.lnk"
 !endif
 
 !ifdef INST_QT
-    Delete /REBOOTOK "$QUICKLAUNCH\${INTERNALNAME}.lnk"
-    Delete /REBOOTOK "$DESKTOP\${INTERNALNAME}.lnk"
-    Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\${INTERNALNAME}.lnk"
+    Delete /REBOOTOK "$QUICKLAUNCH\${DISPLAYNAME}.lnk"
+    Delete /REBOOTOK "$DESKTOP\${DISPLAYNAME}.lnk"
+    Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\${DISPLAYNAME}.lnk"
 !endif
 
 	Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\Change Log.lnk"
@@ -1714,7 +1730,7 @@
 	Pop $0
 
 	${If} $PreviousVersionState == 1
-		!insertmacro MUI_HEADER_TEXT "Already Installed" "Choose how you want to install ${INTERNALNAME}."
+		!insertmacro MUI_HEADER_TEXT "Already Installed" "Choose how you want to install ${DISPLAYNAME}."
 		nsDialogs::CreateItem /NOUNLOAD STATIC ${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS} 0 0 0 100% 40 "An older version of Avidemux is installed on your system.  Select the operation you want to perform and click Next to continue."
 		Pop $R0
 		nsDialogs::CreateItem /NOUNLOAD BUTTON ${BS_AUTORADIOBUTTON}|${BS_VCENTER}|${BS_MULTILINE}|${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS}|${WS_GROUP}|${WS_TABSTOP} 0 10 55 100% 30 "Upgrade Avidemux using previous settings (recommended)"
@@ -1726,7 +1742,7 @@
 			StrCpy $ReinstallUninstall 1
 		${EndIf}
 	${ElseIf} $PreviousVersionState == 2
-		!insertmacro MUI_HEADER_TEXT "Already Installed" "Choose how you want to install ${INTERNALNAME}."
+		!insertmacro MUI_HEADER_TEXT "Already Installed" "Choose how you want to install ${DISPLAYNAME}."
 		nsDialogs::CreateItem /NOUNLOAD STATIC ${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS} 0 0 0 100% 40 "A newer version of Avidemux is already installed! It is not recommended that you downgrade to an older version. Select the operation you want to perform and click Next to continue."
 		Pop $R0
 		nsDialogs::CreateItem /NOUNLOAD BUTTON ${BS_AUTORADIOBUTTON}|${BS_VCENTER}|${BS_MULTILINE}|${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS}|${WS_GROUP}|${WS_TABSTOP} 0 10 55 100% 30 "Downgrade Avidemux using previous settings (recommended)"



From mean at mail.berlios.de  Tue Feb 16 07:43:58 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 16 Feb 2010 07:43:58 +0100
Subject: [Avidemux-svn-commit] r5936 - in branches/avidemux_2.6_branch_mean:
	avidemux_core/ADM_coreAudioEncoder/include
	avidemux_core/ADM_coreAudioEncoder/src
	avidemux_plugins/ADM_audioEncoders/faac
	avidemux_plugins/ADM_audioEncoders/lame
	avidemux_plugins/ADM_audioEncoders/lavcodec
Message-ID: <201002160643.o1G6hwS9006511@sheep.berlios.de>

Author: mean
Date: 2010-02-16 07:43:55 +0100 (Tue, 16 Feb 2010)
New Revision: 5936

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoder.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoderInternal.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/src/audioencoder.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
Log:
[audioEncoder] flush buffer when no more data available (maybe incomplete)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoder.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoder.h	2010-02-15 21:32:37 UTC (rev 5935)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoder.h	2010-02-16 06:43:55 UTC (rev 5936)
@@ -25,7 +25,12 @@
 
 
 typedef int AUDIOENCODER;
-
+typedef enum
+{
+    AudioEncoderRunning,
+    AudioEncoderNoInput,
+    AudioEncoderStopped
+}AudioEncoderState;
 /**
     \class AUDMEncoder
     \brief audio encoder base class. Combined with the audioaccess class it makes the exact opposite
@@ -37,7 +42,7 @@
 {
   protected:
 
-    bool            eof_met;    // True if cannot encode anymore
+    AudioEncoderState _state;    // True if cannot encode anymore
     //
     uint8_t         *_extraData;
     uint32_t        _extraSize;

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoderInternal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoderInternal.h	2010-02-15 21:32:37 UTC (rev 5935)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/include/audioencoderInternal.h	2010-02-16 06:43:55 UTC (rev 5936)
@@ -15,7 +15,7 @@
 #ifndef AUDIOENCODERINTERNAL_H
 #define AUDIOENCODERINTERNAL_H
 
-#define ADM_AUDIO_ENCODER_API_VERSION 5
+#define ADM_AUDIO_ENCODER_API_VERSION 6
 #include "stddef.h"
 #include "audioencoder.h"
 #include "ADM_paramList.h"

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/src/audioencoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/src/audioencoder.cpp	2010-02-15 21:32:37 UTC (rev 5935)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioEncoder/src/audioencoder.cpp	2010-02-16 06:43:55 UTC (rev 5936)
@@ -30,7 +30,7 @@
     _extraData=NULL;
     _extraSize=0;
     ADM_assert(in);
-    eof_met=false;
+    _state=AudioEncoderRunning;
     _incoming=in;
     memset(&wavheader,0,sizeof(wavheader));
     tmphead=tmptail=0;
@@ -59,7 +59,7 @@
     uint32_t filler=wavheader.frequency*wavheader.channels;
   uint32_t nb;
   AUD_Status status;
-  if(eof_met) return 0;
+  if(AudioEncoderRunning!=_state) return false;
   while(1)
   {
     ADM_assert(tmptail>=tmphead); 
@@ -81,7 +81,7 @@
       {
         memset(&tmpbuffer[tmptail],0,sizeof(float)*(minimum-(tmptail-tmphead)));
         tmptail=tmphead+minimum;
-        eof_met=1;  
+        _state=AudioEncoderNoInput;  
         return true;
       }
       else continue;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp	2010-02-15 21:32:37 UTC (rev 5935)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/faac/audioencoder_faac.cpp	2010-02-16 06:43:55 UTC (rev 5936)
@@ -187,7 +187,7 @@
   uint32_t filler=wavheader.frequency*wavheader.channels;
   uint32_t nb;
   AUD_Status status;
-  if(eof_met) return 0;
+  if(AudioEncoderRunning!=_state) return 0;
   while(1)
   {
     ADM_assert(tmptail>=tmphead);
@@ -209,7 +209,7 @@
       {
         memset(&tmpbuffer[tmptail],0,sizeof(float)*(minimum-(tmptail-tmphead)));
         tmptail=tmphead+minimum;
-        eof_met=1;  
+        _state=AudioEncoderNoInput;  
         return minimum;
       }
       else continue;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp	2010-02-15 21:32:37 UTC (rev 5935)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp	2010-02-16 06:43:55 UTC (rev 5936)
@@ -193,6 +193,32 @@
 
 }
 /**
+    \fn send
+    \brief Encode a block
+*/
+int AUDMEncoder_Lame::send(uint32_t nbSample, uint8_t *dest)
+{
+  int nbout;
+  dither16 (&(tmpbuffer[tmphead]), nbSample, wavheader.channels);
+  ADM_assert (tmptail >= tmphead);
+  int16_t *sample16=(int16_t *)& (tmpbuffer[tmphead]);
+  if (wavheader.channels == 1)
+    {
+      nbout =	lame_encode_buffer (MYFLAGS, 
+                sample16,
+			    sample16, nbSample, dest,
+			    16 * 1024);
+
+    }
+  else
+    {
+      nbout =	lame_encode_buffer_interleaved (MYFLAGS,
+					sample16,
+					nbSample / 2, dest, 16 * 1024);
+    }
+    return nbout;
+}
+/**
     \fn encode
     \brief Get an encoded mp3 packet
     @param dest [in] Where to write datas
@@ -208,34 +234,40 @@
 
   *samples = BLOCK_SIZE;	//FIXME
   *len = 0;
+  if(AudioEncoderStopped==_state)
+        return false;
 
-  if (!refillBuffer (_chunk))
+    refillBuffer (_chunk);
+    if(AudioEncoderNoInput==_state)
     {
-      return false;
+        int left=tmptail-tmphead;
+        if (left < _chunk)
+        {
+            if(left)
+            {
+                nbout=send(left,dest);
+                tmphead=tmptail;
+                ADM_info("[lame]Sending last packet\n");
+                goto cont;
+            }
+              // Flush
+              _state=AudioEncoderStopped;
+              nbout=lame_encode_flush(MYFLAGS,dest,16*1024);
+              if(nbout<0) 
+              {
+                    ADM_warning("Error while flushing lame\n");
+                    return false;   
+              }
+                    
+              *len=nbout;
+              *samples=BLOCK_SIZE;  
+              ADM_info("[Lame] Flushing, last block is %d bytes\n",nbout);
+              return true;
     }
-
-  if (tmptail - tmphead < _chunk)
-    {
-      return false;
-    }
-  dither16 (&(tmpbuffer[tmphead]), _chunk, wavheader.channels);
-  ADM_assert (tmptail >= tmphead);
-  int16_t *sample16=(int16_t *)& (tmpbuffer[tmphead]);
-  if (wavheader.channels == 1)
-    {
-      nbout =	lame_encode_buffer (MYFLAGS, 
-                sample16,
-			    sample16, _chunk, dest,
-			    16 * 1024);
-
-    }
-  else
-    {
-      nbout =	lame_encode_buffer_interleaved (MYFLAGS,
-					sample16,
-					_chunk / 2, dest, 16 * 1024);
-    }
+  }
+  nbout=send(_chunk,dest);
   tmphead += _chunk;
+cont:
   if (nbout < 0)
     {
       printf ("[Lame] Error !!! : %"LD"\n", nbout);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.h	2010-02-15 21:32:37 UTC (rev 5935)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lame/audioencoder_lame.h	2010-02-16 06:43:55 UTC (rev 5936)
@@ -26,7 +26,7 @@
    
     void              *lameFlags;
     uint32_t          _chunk; // Nb of float we encode each time
-         
+                      int send(uint32_t nbSample, uint8_t *dest);
   public:
     virtual             ~AUDMEncoder_Lame();
                         AUDMEncoder_Lame(AUDMAudioFilter *instream,bool globalHeader);	

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2010-02-15 21:32:37 UTC (rev 5935)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2010-02-16 06:43:55 UTC (rev 5936)
@@ -159,23 +159,59 @@
   int channels=wavheader.channels;
   *samples = _chunk/channels; //FIXME
   *len = 0;
+  if(AudioEncoderStopped==_state)
+        return false;
 
-  if(!refillBuffer(_chunk ))
-  {
-    return 0; 
-  }
-        
-  if(tmptail-tmphead<_chunk)
-  {
-    return 0; 
-  }
+   refillBuffer (_chunk);
+   if(AudioEncoderNoInput==_state)
+    {
+        int left=tmptail-tmphead;
+        if (left < _chunk)
+        {
+            if(left) // Last block
+            {
+               dither16(&(tmpbuffer[tmphead]),left,channels);
+               ADM_assert(tmptail>=tmphead);
+#warning buffer overread
+               nbout = avcodec_encode_audio(CONTEXT, dest, 5000, (short *) &(tmpbuffer[tmphead]));
+               tmphead=tmptail;
+               *samples = left/channels; 
+               *len=nbout;
+               ADM_info("[Lav] Last audio block\n");
+               goto cnt;
+            }
+              // Flush
+               ADM_info("[Lav] Flush\n");
+              _state=AudioEncoderStopped;
+              if(CONTEXT->codec->capabilities & CODEC_CAP_DELAY)
+              {
+                  nbout=avcodec_encode_audio(CONTEXT, dest, 5000,NULL);
+                  if(nbout<0) 
+                  {
+                        ADM_warning("Error while flushing lame\n");
+                        return false;   
+                  }
+                        
+                  *len=nbout;
+                  *samples=_chunk/channels;  
+                  ADM_info("[Lav] Flushing, last block is %d bytes\n",nbout);
+                  return true;
+              }else
+              {
+              }
+              ADM_info("[Lav] No data to flush\n",nbout);
+              return true;
+        }
+    }
 
+
   dither16(&(tmpbuffer[tmphead]),_chunk,channels);
 
   ADM_assert(tmptail>=tmphead);
   nbout = avcodec_encode_audio(CONTEXT, dest, 5000, (short *) &(tmpbuffer[tmphead]));
 
   tmphead+=_chunk;
+cnt:
   if (nbout < 0) 
   {
     printf("[Lavcodec] Error !!! : %"LD"\n", nbout);



From mean at mail.berlios.de  Thu Feb 18 07:18:48 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 18 Feb 2010 07:18:48 +0100
Subject: [Avidemux-svn-commit] r5937 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat
Message-ID: <201002180618.o1I6Im8H016074@sheep.berlios.de>

Author: mean
Date: 2010-02-18 07:18:37 +0100 (Thu, 18 Feb 2010)
New Revision: 5937

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat/utils.c
Log:
[muxer] Verbose pts/dts error in lavmuxer

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat/utils.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat/utils.c	2010-02-16 06:43:55 UTC (rev 5936)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat/utils.c	2010-02-18 06:18:37 UTC (rev 5937)
@@ -2602,7 +2602,7 @@
         return -1;
     }
     if(pkt->dts != AV_NOPTS_VALUE && pkt->pts != AV_NOPTS_VALUE && pkt->pts < pkt->dts){
-        av_log(st->codec, AV_LOG_ERROR, "error, pts < dts\n");
+        av_log(st->codec, AV_LOG_ERROR, "error, pts < dts (%d/%d)\n",(int)pkt->pts,(int)pkt->dts);
         return -1;
     }
 



From mean at mail.berlios.de  Thu Feb 18 07:18:55 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 18 Feb 2010 07:18:55 +0100
Subject: [Avidemux-svn-commit] r5938 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder:
	include src
Message-ID: <201002180618.o1I6ItE1016241@sheep.berlios.de>

Author: mean
Date: 2010-02-18 07:18:53 +0100 (Thu, 18 Feb 2010)
New Revision: 5938

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
Log:
[encoder(lav)] Simpler & much better PTS/DTS computation, workaroung delay when dealing with field based source

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h	2010-02-18 06:18:37 UTC (rev 5937)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/include/ADM_coreVideoEncoderFFmpeg.h	2010-02-18 06:18:53 UTC (rev 5938)
@@ -50,11 +50,11 @@
                FILE             *statFile;
                int              pass;   // Pass number = 1 or 2, valid only if we use 2 pass mode
                bool             _isMT; // True if multithreaded
-               uint64_t         nextDts;
                bool             _globalHeader;
                float            timeScaler;
                vector <ADM_timeMapping>mapper;
-               uint64_t         getRealPtsFromLav(uint64_t val);
+               bool             getRealPtsFromLav(uint64_t val,uint64_t *dts,uint64_t *pts);
+               vector <uint64_t>queueOfDts;
 protected:
     virtual               bool             prolog(void); 
     virtual               bool             preEncode(void); 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-18 06:18:37 UTC (rev 5937)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-18 06:18:53 UTC (rev 5938)
@@ -99,13 +99,21 @@
     statFile=NULL;
     _globalHeader=globalHeader;
     _isMT=false;
-    encoderDelay=source->getInfo()->frameIncrement*LAVS(max_b_frames);
+
+    uint64_t inc=source->getInfo()->frameIncrement;
+    if(inc<30000) // Less than 30 ms , fps > 30 fps it is probably field
+     {
+            inc*=2;
+            ADM_warning("It is probably field encoded, doubling increment\n");
+     }
+    encoderDelay=inc*LAVS(max_b_frames);
     ADM_info("[Lavcodec] Using a video encoder delay of %d ms\n",(int)(encoderDelay/1000));
     if(_globalHeader)
     {
                 ADM_info("Codec configured to use global header\n");
                 _context->flags|=CODEC_FLAG_GLOBAL_HEADER;
     }
+    
 }
 /**
     \fn ADM_coreVideoEncoderFFmpeg
@@ -182,6 +190,7 @@
 #else
 
     int n,d;
+    
     usSecondsToFrac(f,&n,&d);
  //   printf("[ff] Converted a time increment of %d ms to %d /%d seconds\n",f/1000,n,d);
     _context->time_base.num=n;
@@ -223,7 +232,8 @@
     prolog();
 
     uint64_t p=image->Pts;
-    nextDts=image->Pts;
+    queueOfDts.push_back(p);
+    aprintf("Incoming frame PTS=%"LLU", delay=%"LLU"\n",p,getEncoderDelay());
     p+=getEncoderDelay();
     _frame.pts= timingToLav(p);    //
     if(!_frame.pts) _frame.pts=AV_NOPTS_VALUE;
@@ -365,21 +375,26 @@
     \fn getRealPtsFromLav
     \brief Lookup in the stored value to get the exact pts from the truncated one from lav
 */
-uint64_t ADM_coreVideoEncoderFFmpeg::getRealPtsFromLav(uint64_t val)
+bool ADM_coreVideoEncoderFFmpeg::getRealPtsFromLav(uint64_t val,uint64_t *dts,uint64_t *pts)
 {
     int n=mapper.size();
     for(int i=0;i<n;i++)
     {
         if(mapper[i].lavTS==val)
         {
-            uint64_t r=mapper[i].realTS;
+            *pts=mapper[i].realTS;
             mapper.erase(mapper.begin()+i);
-            return r;
+            // Now get DTS, it is min (lastDTS+inc, PTS-delay)
+            ADM_assert(queueOfDts.size());
+            *dts=queueOfDts[0];
+            queueOfDts.erase(queueOfDts.begin());
+            return true;
         }
     }
     ADM_warning("Cannot find PTS : %"LLU"\n",val);  
     for(int i=0;i<n;i++) ADM_warning("%d : %"LLU"\n",i,mapper[i].lavTS);
     ADM_assert(0);
+    return false;
 
 }
 /**
@@ -394,6 +409,11 @@
     {
         pict_type=_context->coded_frame->pict_type;
         keyframe=_context->coded_frame->key_frame;
+    }else
+    {
+        out->len=0;
+        ADM_warning("No picture...\n");
+        return false;
     }
     aprintf("[ffMpeg4] Out Quant :%d, pic type %d keyf %d\n",out->out_quantizer,pict_type,keyframe);
     out->len=size;
@@ -401,24 +421,12 @@
     if(keyframe) 
         out->flags=AVI_KEY_FRAME;
     else if(pict_type==FF_B_TYPE)
-            out->flags=AVI_B_FRAME;
+        out->flags=AVI_B_FRAME;
     
     // Update PTS/Dts
-
-    out->pts= getRealPtsFromLav(_context->coded_frame->pts);
-// Since we will buffer frame, we have to minus that from dts
-// which is in fact the pts of the currently encoded frame
-    uint64_t preDts;
-    if(nextDts>=getEncoderDelay())
-    {
-        preDts=nextDts-getEncoderDelay(); 
-     }
-    else                                    
-    {
-        preDts=0;
-    }
-#warning simplify
-    out->dts=preDts;
+    getRealPtsFromLav(_context->coded_frame->pts,&(out->dts),&(out->pts));
+    
+    
     aprintf("Codec>Out pts=%"LLU" us, out Dts=%"LLU"\n",out->pts,out->dts);    
 
     // Update quant
@@ -427,6 +435,8 @@
     else
       out->out_quantizer =(int) floor (_context->coded_frame->quality / (float) FF_QP2LAMBDA);
 
+    
+
     // Update stats
     if(Settings.params.mode==COMPRESS_2PASS   || Settings.params.mode==COMPRESS_2PASS_BITRATE)
     {



From mean at mail.berlios.de  Sat Feb 20 08:52:23 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 20 Feb 2010 08:52:23 +0100
Subject: [Avidemux-svn-commit] r5939 - in
	branches/avidemux_2.6_branch_mean/avidemux: common
	common/ADM_editor common/ADM_script
	common/ADM_script2/include common/ADM_script2/src
	qt4/ADM_userInterfaces/ADM_shell
Message-ID: <201002200752.o1K7qNLT017316@sheep.berlios.de>

Author: mean
Date: 2010-02-20 08:52:21 +0100 (Sat, 20 Feb 2010)
New Revision: 5939

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_JSif.h
Removed:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxAudio.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxAudio.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxVideo.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxVideo.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemux.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemux.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxAudio.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxAudio.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDirectorySearch.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDirectorySearch.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDirectorySearch.h.orig
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp.orig
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctionsNonRegFactory.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_container.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/DirectorySearch.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/DirectorySearch.cpp.orig
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/DirectorySearch.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/StdFile.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/adm_scanner.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/CMakeLists.txt
Log:
[script] Remove old ADM_script folder, replaced by ADM_script2 using jsapigen

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -23,7 +23,7 @@
 #include "ADM_colorspace.h"
 #include "ADM_vidMisc.h"
 #include "ADM_audiocodec/ADM_audiocodec.h"
-#include "ADM_script/ADM_JSif.h"
+#include "ADM_script2/include/ADM_JSif.h"
 #include "ADM_codec.h"
 
 ADM_EditorSegment::ADM_EditorSegment(void)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,82 +0,0 @@
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#define JSDECLARE
-#include "ADM_Avidemux.h"
-
-ADM_Avidemux::ADM_Avidemux(void) :  m_pAudio(NULL), m_pVideo(NULL), m_pContainer(NULL), m_nCurrentFrame(0), m_dFPS(0)
-{// begin ADM_Avidemux
-
-	// initialize audio property
-	JSObject *pTempObject = ADM_JSAvidemuxAudio::JSInit(g_pCx,g_pObject);
-	ADM_JSAvidemuxAudio *pAudio = new ADM_JSAvidemuxAudio();
-	pAudio->setObject(new ADM_AvidemuxAudio());
-	JS_SetPrivate(g_pCx,pTempObject,pAudio);
-	m_pAudio = pTempObject;
-
-	// initialize video property
-	pTempObject = ADM_JSAvidemuxVideo::JSInit(g_pCx,g_pObject);
-	ADM_JSAvidemuxVideo *pVideo = new ADM_JSAvidemuxVideo();
-	pVideo->setObject(new ADM_AvidemuxVideo());
-	JS_SetPrivate(g_pCx,pTempObject,pVideo);
-	m_pVideo = pTempObject;
-}// end ADM_Avidemux
-
-ADM_Avidemux::~ADM_Avidemux()
-{// begin ~ADM_Avidemux
-
-}// end ~ADM_Avidemux
-/******************************************/
-JSPropertySpec *ADM_JsAudioGetProperties(void);
-JSFunctionSpec *ADM_JsAudioGetFunctions(void);
-JSPropertySpec *ADM_JsVideoGetProperties(void);
-JSFunctionSpec *ADM_JsVideoGetFunctions(void);
-JSPropertySpec *ADM_JsClassGetProperties(void);
-JSFunctionSpec *ADM_JsClassGetFunctions(void);
-JSFunctionSpec *ADM_JsDebugGetFunctions(void);
-
-static void dumpFunc(JSFunctionSpec *f)
-{
-    while(f->name)
-    {
-        jsLog(JS_LOG_NORMAL,"     %s(..)",f->name);
-        f++;
-    }
-}
-static void dumpProps(JSPropertySpec *f)
-{
-    while(f->name)
-    {
-        jsLog(JS_LOG_NORMAL,"     %s=xxx",f->name);
-        f++;
-    }
-}
-/**
-    \fn ADM_dumpJSHooks
-    \brief Printf the additional avidemux functions/properties
-*/
-void ADM_dumpJSHooks(void)
-{
-    jsLog(JS_LOG_NORMAL,"Dumping JS interface");
-    jsLog(JS_LOG_NORMAL,"********************");
-    jsLog(JS_LOG_NORMAL,"Debug functions :");
-    dumpFunc(ADM_JsDebugGetFunctions());
-    jsLog(JS_LOG_NORMAL,"app.");
-    dumpFunc(ADM_JsClassGetFunctions());
-    dumpProps(ADM_JsClassGetProperties());
-    jsLog(JS_LOG_NORMAL,"app.video");
-    dumpFunc(ADM_JsVideoGetFunctions());
-    dumpProps(ADM_JsVideoGetProperties());
-    jsLog(JS_LOG_NORMAL,"app.audio");
-    dumpFunc(ADM_JsAudioGetFunctions());
-    dumpProps(ADM_JsAudioGetProperties());
-    jsLog(JS_LOG_NORMAL,"Done");
-    jsLog(JS_LOG_NORMAL,"****");
-
-}
\ No newline at end of file

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_Avidemux.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,31 +0,0 @@
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef _ADM_AVIDEMUX_H
-#define _ADM_AVIDEMUX_H
-#include "ADM_JSGlobal.h"
-#include "ADM_JSAvidemuxAudio.h"
-#include "ADM_JSAvidemuxVideo.h"
-
-class ADM_Avidemux
-{
-public:
-	ADM_Avidemux(void);
-	virtual ~ADM_Avidemux(void);
-
-	// member variables
-	JSObject *m_pAudio;
-	JSObject *m_pVideo;
-	JSString *m_pContainer;
-	int m_nCurrentFrame;
-	double m_dFPS;
-
-};
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxAudio.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxAudio.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,6 +0,0 @@
-#include "ADM_AvidemuxAudio.h"
-
-ADM_AvidemuxAudio::~ADM_AvidemuxAudio()
-{// begin ~ADM_AvidemuxAudio
-
-}// end ~ADM_AvidemuxAudio

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxAudio.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxAudio.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxAudio.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,12 +0,0 @@
-#ifndef _ADM_AVIDEMUXAUDIO_H
-#define _ADM_AVIDEMUXAUDIO_H
-
-
-class ADM_AvidemuxAudio
-{
-public:
-	ADM_AvidemuxAudio(void){}
-	virtual ~ADM_AvidemuxAudio(void);
-};
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxVideo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxVideo.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxVideo.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,6 +0,0 @@
-#include "ADM_AvidemuxVideo.h"
-
-ADM_AvidemuxVideo::~ADM_AvidemuxVideo()
-{// begin ~ADM_AvidemuxVideo
-
-}// end ~ADM_AvidemuxVideo

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxVideo.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxVideo.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_AvidemuxVideo.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,14 +0,0 @@
-#ifndef _ADM_AVIDEMUXVIDEO_H
-#define _ADM_AVIDEMUXVIDEO_H
-
-class ADM_AvidemuxVideo
-{
-public:
-	ADM_AvidemuxVideo(void) {}
-	virtual ~ADM_AvidemuxVideo(void);
-
-	// member variables
-        bool m_bVideoProcess;
-};
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemux.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemux.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemux.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,588 +0,0 @@
-/**
-    \file ADM_JSAvidemux
-    \brief SpiderMonkey<->Avidemux interface for avidemux class
-    \author Anish Mistry, modified by mean & gruntster also
-
-*/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include <math.h>
-
-#include "ADM_default.h"
-#include "ADM_JSAvidemux.h"
-#include "avi_vars.h"
-#include "DIA_coreToolkit.h"
-#include "ADM_commonUI/GUI_ui.h"
-#include "ADM_muxerProto.h"
-#include "ADM_confCouple.h"
-#include "ADM_debugID.h"
-#define MODULE_NAME MODULE_SCRIPT
-#include "ADM_debug.h"
-#include "ADM_JSDebug.h"
-#include "ADM_jsUtils.h"
-
-extern int A_openAvi (const char *name);
-extern int A_Save (const char *name);
-extern int A_appendAvi (const char *name);
-extern uint8_t ogmSave(char *name);
-extern int GUI_GoToFrame(uint32_t frame);
-extern int filterLoadXml(const char *docname,uint8_t silent);
-extern int A_delete(uint32_t start, uint32_t end);
-
-extern uint8_t A_ListAllBlackFrames( char *file );
-extern uint8_t A_jumpToTime(uint32_t hh,uint32_t mm,uint32_t ss,uint32_t ms);
-extern uint8_t addFile(char *name);
-
-bool           A_setContainer(const char *cont);
-
-
-bool jsArgToConfCouple(int nb,CONFcouple **conf,  jsval *argv);
-
-JSPropertySpec ADM_JSAvidemux::avidemux_properties[] = 
-{ 
-
-	{ "markerA", markerA_prop, JSPROP_ENUMERATE },	// set marker A
-	{ "markerB", markerB_prop, JSPROP_ENUMERATE },	// set marker B
-	{ "audio", audio_prop, JSPROP_ENUMERATE },	// audio object
-	{ "video", video_prop, JSPROP_ENUMERATE },	// video object
-	{ "container", container_prop, JSPROP_ENUMERATE },	// set container type
-	{ "currentFrame", currentframe_prop, JSPROP_ENUMERATE },	// set current frame
-	{ "fps", fps_prop, JSPROP_ENUMERATE },	// set movie frame rate
-	{ 0 }
-};
-
-JSFunctionSpec ADM_JSAvidemux::avidemux_methods[] = 
-{
-	{ "append", Append, 1, 0, 0 },	// append video
-	{ "delete", Delete, 2, 0, 0 },	// delete section
-	{ "exit", Exit, 0, 0, 0 },	// exit Avidemux
-	{ "load", Load, 1, 0, 0 },	// Load movie
-	{ "loadFilters", LoadFilters, 1, 0, 0 },	// Load filters from file
-	{ "save", Save, 1, 0, 0 },	// Save movie
-    { "clearSegments", ClearSegments ,0,0,0}, // Clear all segments
-    { "addSegment", AddSegment ,3,0,0}, // Clear all segments
-	{ "goToTime", GoToTime, 3, 0, 0 },	// more current frame to time index
-	{ "forceUnpack", forceUnpack, 0, 0, 0 },
-    { "smartCopyMode", smartcopyMode, 0, 0, 0 },
-    { "setContainer", setContainer, 1, 0, 0 },
-    { "rebuildIndex", rebuildIndex, 0, 0, 0 },
-
-	{ 0 }
-};
-/*******************************************/
-JSPropertySpec *ADM_JsClassGetProperties(void)
-{
-    return ADM_JSAvidemux::avidemux_properties;
-}
-JSFunctionSpec *ADM_JsClassGetFunctions(void)
-{
-    return ADM_JSAvidemux::avidemux_methods;
-}
-/*******************************************/
-JSClass ADM_JSAvidemux::m_classAvidemux = 
-{
-	"Avidemux", JSCLASS_HAS_PRIVATE,
-	JS_PropertyStub, JS_PropertyStub,
-	ADM_JSAvidemux::JSGetProperty, ADM_JSAvidemux::JSSetProperty,
-	JS_EnumerateStub, JS_ResolveStub, 
-	JS_ConvertStub, ADM_JSAvidemux::JSDestructor
-};
-
-ADM_JSAvidemux::~ADM_JSAvidemux(void)
-{
-	if(m_pObject != NULL)
-		delete m_pObject;
-	m_pObject = NULL;
-}
-
-void ADM_JSAvidemux::setObject(ADM_Avidemux *pObject)
-{
-	m_pObject = pObject; 
-}
-	
-ADM_Avidemux *ADM_JSAvidemux::getObject()
-{
-	return m_pObject; 
-}
-
-JSObject *ADM_JSAvidemux::JSInit(JSContext *cx, JSObject *obj, JSObject *proto)
-{
-	JSObject *newObj = JS_InitClass(cx, obj, proto, &m_classAvidemux, 
-									ADM_JSAvidemux::JSConstructor, 0,
-									ADM_JSAvidemux::avidemux_properties, ADM_JSAvidemux::avidemux_methods,
-									NULL, NULL);
-	return newObj;
-}
-
-JSBool ADM_JSAvidemux::JSConstructor(JSContext *cx, JSObject *obj, uintN argc, 
-								 jsval *argv, jsval *rval)
-{
-	if(argc != 0)
-		return JS_FALSE;
-	ADM_JSAvidemux *p = new ADM_JSAvidemux();
-	ADM_Avidemux *pObject = new ADM_Avidemux();
-	p->setObject(pObject);
-	if ( ! JS_SetPrivate(cx, obj, p) )
-		return JS_FALSE;
-	*rval = OBJECT_TO_JSVAL(obj);
-	return JS_TRUE;
-}
-
-void ADM_JSAvidemux::JSDestructor(JSContext *cx, JSObject *obj)
-{
-	ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-	if(p != NULL)
-		delete p;
-	p = NULL;
-}
-
-JSBool ADM_JSAvidemux::JSGetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp)
-{
-        if (JSVAL_IS_INT(id)) 
-        {
-                ADM_JSAvidemux *priv = (ADM_JSAvidemux *) JS_GetPrivate(cx, obj);
-                switch(JSVAL_TO_INT(id))
-                {
-
-                        case markerA_prop:
-                                *vp = INT_TO_JSVAL(video_body->getMarkerAPts());
-                                break;
-                        case markerB_prop:
-                                *vp = INT_TO_JSVAL(video_body->getMarkerBPts());
-                                break;
-                        case audio_prop:
-                                *vp = OBJECT_TO_JSVAL(priv->getObject()->m_pAudio);
-                                break;
-                        case video_prop:
-                                *vp = OBJECT_TO_JSVAL(priv->getObject()->m_pVideo);
-                                break;
-                        case container_prop:
-                                *vp = STRING_TO_JSVAL(priv->getObject()->m_pContainer);
-                                break;
-                        case currentframe_prop:
-                                *vp = INT_TO_JSVAL(priv->getObject()->m_nCurrentFrame);
-                                break;
-                        case fps_prop:
-                                {
-                                        aviInfo info;
-
-                                        if (avifileinfo)
-                                        {
-                                                enterLock();
-                                                video_body->getVideoInfo(&info);
-                                                priv->getObject()->m_dFPS = info.fps1000/1000.0; 
-                                                video_body->updateVideoInfo (&info);
-                                                video_body->getVideoInfo (avifileinfo);
-                                                leaveLock();
-                                        } 
-                                        else 
-                                        {
-                                                return JS_FALSE;
-                                        }
-                                        *vp = DOUBLE_TO_JSVAL(priv->getObject()->m_dFPS);
-                                }
-                                break;
-                }
-        }
-        return JS_TRUE;
-}
-
-JSBool ADM_JSAvidemux::JSSetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp)
-{
-	if (JSVAL_IS_INT(id)) 
-	{
-		ADM_JSAvidemux *priv = (ADM_JSAvidemux *) JS_GetPrivate(cx, obj);
-		switch(JSVAL_TO_INT(id))
-		{
-			case markerA_prop:
-				if(JSVAL_IS_INT(*vp) == false)
-					break;
-				{
-					int f=JSVAL_TO_INT(*vp);
-					if (!avifileinfo)
-					{
-						return JS_FALSE;
-					} 
-                    video_body->setMarkerAPts(f);
-				}
-				break;
-			case markerB_prop:
-				if(JSVAL_IS_INT(*vp) == false)
-					break;
-				{
-					int f=JSVAL_TO_INT(*vp);
-					if (!avifileinfo)
-					{
-						return JS_FALSE;
-					} 
-                    video_body->setMarkerBPts(f);
-				}
-				break;
-			case audio_prop:
-				return JS_FALSE;
-				break;
-			case video_prop:
-				return JS_FALSE;
-				break;
-			case container_prop:
-				if(JSVAL_IS_STRING(*vp) == false)
-					break;
-				{
-					priv->getObject()->m_pContainer = JSVAL_TO_STRING(*vp);
-					char *pContainer = JS_GetStringBytes(priv->getObject()->m_pContainer);
-					aprintf("Setting container format \"%s\"\n",pContainer);
-                                        if(A_setContainer(pContainer))
-                                                return JS_TRUE;
-                                        return JS_FALSE;
-					return JS_FALSE;
-				}
-				break;
-			case currentframe_prop:
-				if(JSVAL_IS_INT(*vp) == false)
-					break;
-				{
-					int frameno;
-					if (!avifileinfo)
-						return JS_FALSE;
-					
-					frameno = JSVAL_TO_INT(*vp);
-					if( frameno<0)
-					{
-						aviInfo info;
-						video_body->getVideoInfo(&info);
-						frameno=-frameno;
-						if(frameno>info.nb_frames)
-							return JS_FALSE;
-						
-						frameno = info.nb_frames-frameno;
-					}
-                                        enterLock();
-					if(GUI_GoToFrame( frameno ))
-					{
-						leaveLock();
-						return JS_TRUE;
-					}
-					leaveLock();
-					return JS_FALSE;
-				}
-				break;
-			case fps_prop:
-				if(JSVAL_IS_DOUBLE(*vp) == false)
-					break;
-				{
-					priv->getObject()->m_dFPS = *JSVAL_TO_DOUBLE(*vp);
-					aviInfo info;
-
-					if (avifileinfo)
-					{
-						video_body->getVideoInfo(&info);				
-						info.fps1000 = (uint32_t)floor(priv->getObject()->m_dFPS*1000.f);
-						video_body->updateVideoInfo (&info);
-						video_body->getVideoInfo (avifileinfo);
-						return JS_TRUE;
-					} else 
-					{
-						return JS_FALSE;
-					}
-				}
-				break;
-		}
-	}
-	return JS_TRUE;
-}
-
-JSBool ADM_JSAvidemux::Load(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin Load
-        JSBool ret=JS_FALSE;
-        ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 1)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false)
-                return JS_FALSE;
-        char *pTempStr = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        printf("Loading \"%s\"\n",pTempStr);
-        // Do a failure instead of returing ko
-        *rval = BOOLEAN_TO_JSVAL(JS_TRUE);
-        enterLock();
-        if(!A_openAvi(pTempStr)) 
-        {
-          ret= JS_FALSE;	
-        }else 
-        {
-          ret=JS_TRUE;
-        }
-        leaveLock();
-	return ret;
-}// end Load
-
-JSBool ADM_JSAvidemux::LoadFilters(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin LoadFilters
-#if 0
-        ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 1)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false)
-                return JS_FALSE;
-        char *pTempStr = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        printf("Loading Filters \"%s\"\n",pTempStr);
-        enterLock();
-        *rval = BOOLEAN_TO_JSVAL(filterLoadXml(pTempStr,0));
-        leaveLock();
-#endif
-	return JS_TRUE;
-}// end LoadFilters
-
-
-JSBool ADM_JSAvidemux::Append(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin Append
-        ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 1)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false)
-                return JS_FALSE;
-        char *pTempStr = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        printf("Appending \"%s\"\n",pTempStr);
-        enterLock();
-        *rval = BOOLEAN_TO_JSVAL(A_appendAvi(pTempStr));
-        leaveLock();
-	return JS_TRUE;
-}// end Append
-
-JSBool ADM_JSAvidemux::Delete(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin Delete
-        ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 2)
-                return JS_FALSE;
-        if(JSVAL_IS_INT(argv[0]) == false || JSVAL_IS_INT(argv[1]) == false)
-                return JS_FALSE;
-        int a = JSVAL_TO_INT(argv[0]);
-        int b = JSVAL_TO_INT(argv[1]);
-        aprintf("Deleting %d-%d\n",a,b);
-        enterLock();
-        *rval = BOOLEAN_TO_JSVAL(A_delete(a,b));
-        leaveLock();
-        return JS_TRUE;
-}// end Delete
-
-JSBool ADM_JSAvidemux::Save(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin Save
-        ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 1)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false)
-                return JS_FALSE;
-        char *pTempStr = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        printf("Saving \"%s\"\n",pTempStr);
-        enterLock();
-        *rval = BOOLEAN_TO_JSVAL(A_Save(pTempStr));
-        leaveLock();
-        return JS_TRUE;
-}// end Save
-
-static void updateAll(void)
-{
-        if(!avifileinfo) return;
-        if (!video_body->updateVideoInfo (avifileinfo))
-        {
-                GUI_Error_HIG ("OOPS","Something bad happened when executing that script");
-        }
-        frameStart=0;
-        if(avifileinfo->nb_frames)
-                frameEnd=avifileinfo->nb_frames-1;
-        else
-                frameEnd=0;
-}
-/**
-    \fn ClearSegments
-    \brief empty the segment list
-*/
-JSBool ADM_JSAvidemux::ClearSegments(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin ClearSegments
-        ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 0)
-                return JS_FALSE;
-        printf("clearing segments \n");
-        enterLock();
-        *rval = BOOLEAN_TO_JSVAL(video_body->clearSegment());
-        leaveLock();
-        updateAll();
-        return JS_TRUE;
-}// end ClearSegments
-/**
-    \fn AddSegment
-    \brief add a segment. addsegment(ref video,refStartTime, duration) 
-    
-*/
-JSBool ADM_JSAvidemux::AddSegment(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin AddSegment
-        ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        //
-        uint32_t ref=0;
-        uint64_t duration=0,start=0;
-        ADM_PARAM_LIST params[3]={{ADM_JS_UINT32_T,&ref},{ADM_JS_UINT64_T,&start},{ADM_JS_UINT64_T,&duration}};
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(false==ADM_jsArg2Vars(cx, obj, argc, argv, 3, params))
-        {
-            jsLog(JS_LOG_ERROR,"wrong arguments to AddSegment");
-            return JS_FALSE;
-        }
-        ADM_info("adding segment :%d %d %d\n",ref,start,duration);
-        enterLock();
-        *rval = BOOLEAN_TO_JSVAL( video_body->addSegment(ref,start,duration));
-        leaveLock();
-        updateAll();
-        return JS_TRUE;
-}// end AddSegment
-
-
-JSBool ADM_JSAvidemux::Exit(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin Exit
-	ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-	// default return value
-	*rval = BOOLEAN_TO_JSVAL(false);
-	if(argc != 0)
-		return JS_FALSE;
-	exit(0);
-	*rval = INT_TO_JSVAL(1);
-	return JS_TRUE;
-}// end Exit
-
-JSBool ADM_JSAvidemux::GoToTime(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin GoToTime
-	ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-	// default return value
-	*rval = BOOLEAN_TO_JSVAL(false);
-	if(argc != 3)
-		return JS_FALSE;
-	if(JSVAL_IS_INT(argv[0]) == false || JSVAL_IS_INT(argv[1]) == false || JSVAL_IS_INT(argv[2]) == false)
-		return JS_FALSE;
-        enterLock();
-	*rval = INT_TO_JSVAL(A_jumpToTime(JSVAL_TO_INT(argv[0]),JSVAL_TO_INT(argv[1]),JSVAL_TO_INT(argv[2]), 0));
-	leaveLock();
-	return JS_TRUE;
-}// end GoToTime
-
-JSBool ADM_JSAvidemux::forceUnpack(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin GoToTime
-        ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 0)
-                return JS_FALSE;
-        enterLock();
-        video_body->setEnv(ENV_EDITOR_PVOP);
-        leaveLock();
-        *rval = INT_TO_JSVAL(1);
-        return JS_TRUE;
-}// end GoToTime
-JSBool ADM_JSAvidemux::rebuildIndex(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin GoToTime
-        ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 0)
-                return JS_FALSE;
-        enterLock();
-//        if(!video_body->isReordered(0)) // already done
-        {
-          //video_body->rebuildFrameType();
-        }
- 	leaveLock();
-       return JS_TRUE;
-}// end GoToTime
-
-JSBool ADM_JSAvidemux::smartcopyMode(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-
-ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        // default return value
-        printf("[JS]Setting smart copy mode(1)\n");
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 0)
-                return JS_FALSE;
-        printf("[JS]Setting smart copy mode (2)\n");
-        enterLock();
-        video_body->setEnv(ENV_EDITOR_SMART);
-        *rval = BOOLEAN_TO_JSVAL( true);
-        leaveLock();
-        return JS_TRUE;
-}
-/**
-    \fn setContainer
-bool jsArgToConfCouple(int nb,CONFcouple **conf,  jsval *argv);
-*/
-JSBool ADM_JSAvidemux::setContainer(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-
-        ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc < 1)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false)
-                return JS_FALSE;
-        char *str = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        enterLock();
-        if(A_setContainer(str))
-        {
-            CONFcouple *c;
-            jsArgToConfCouple(argc-1,&c,argv+1);
-            int idx=ADM_MuxerIndexFromName(str);
-            if(idx!=-1)
-            {
-                *rval = BOOLEAN_TO_JSVAL( ADM_mx_setExtraConf(idx,c));
-            }
-            if(c) delete c;
-        }
-        /* Now lockup extra params....*/
-        
-        leaveLock();
-        return JS_TRUE;
-}
-/**
-    \fn ADM_JSAvidemux
-    \brief Select the current container from a string
-*/
-bool A_setContainer(const char *cont)
-{
-    int idx=ADM_MuxerIndexFromName(cont);
-    if(idx==-1)
-    {
-        ADM_error("Cannot find muxer for format=%s\n",cont);
-        return false;
-    }
-    UI_SetCurrentFormat(idx);
-    return true;
-}
-//EOF

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemux.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemux.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemux.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,63 +0,0 @@
-#ifndef _ADM_JSAVIDEMUX_H
-#define _ADM_JSAVIDEMUX_H
-
-#pragma once
-
-
-// Spidermonkey
-#include "ADM_smjs/jsapi.h"
-#include "ADM_Avidemux.h"
-class ADM_JSAvidemux
-{
-public:
-	ADM_JSAvidemux(void) : m_pObject(NULL) {}
-	virtual ~ADM_JSAvidemux(void);
-
-	static JSBool JSGetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp);
-	static JSBool JSSetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp);
-	static JSBool JSConstructor(JSContext *cx, JSObject *obj, uintN argc, 
-								jsval *argv, jsval *rval);
-	static void JSDestructor(JSContext *cx, JSObject *obj);
-	static JSObject *JSInit(JSContext *cx, JSObject *obj, JSObject *proto = NULL);
-	static JSBool Load(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Append(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Delete(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Save(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Exit(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-/*	static JSBool SaveDVD(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool SaveOGM(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);*/
-	static JSBool GoToTime(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool LoadFilters(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-        static JSBool ClearSegments(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-        static JSBool AddSegment(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-        static JSBool forceUnpack(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-        static JSBool setContainer(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-        static JSBool rebuildIndex(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-        static JSBool smartcopyMode(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-        
-
-	static JSPropertySpec avidemux_properties[];
-	static JSFunctionSpec avidemux_methods[];
-	enum
-	{
-		markerA_prop,
-		markerB_prop,
-		video_prop,
-		audio_prop,
-		container_prop,
-		currentframe_prop,
-		fps_prop
-	};
-	static JSClass m_classAvidemux;
-
-//protected:
-	void setObject(ADM_Avidemux *pObject);
-	ADM_Avidemux *getObject();
-
-private:
-	ADM_Avidemux *m_pObject;
-
-};
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxAudio.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxAudio.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,588 +0,0 @@
-// C++ Interface: Spider Monkey interface
-//
-// Description: 
-//
-//
-// Author: Anish Mistry
-//      Some modification by mean
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-
-#include "ADM_default.h"
-
-#include "ADM_JSGlobal.h"
-#include "ADM_JSAvidemuxAudio.h"
-
-#include "ADM_commonUI/GUI_ui.h"
-#include "avi_vars.h"
-#include "gui_action.hxx"
-
-#include "ADM_editor/ADM_outputfmt.h"
-#include "ADM_script/ADM_container.h"
-#include "ADM_audioFilter/include/ADM_audioFilterInterface.h"
-#include "audioEncoderApi.h"
-
-
-
-extern int A_audioSave(char *name);
-extern int A_loadAC3 (char *name);
-extern int A_loadMP3 (char *name);
-extern int A_loadWave (char *name);
-extern void HandleAction(Action act);
-
-bool jsArgToConfCouple(int nb,CONFcouple **conf,  jsval *argv);
-
-JSPropertySpec ADM_JSAvidemuxAudio::avidemuxaudio_properties[] = 
-{ 
-
-        { "resample", resample_prop, JSPROP_ENUMERATE },	// resample
-        { "delay", delay_prop, JSPROP_ENUMERATE },	// set audio delay
-        { "film2pal", film2pal_prop, JSPROP_ENUMERATE },	// convert film to pal
-        { "pal2film", pal2film_prop, JSPROP_ENUMERATE },	// convert pal to film
-        { "normalizeMode", normalizemode_prop, JSPROP_ENUMERATE },	//
-        { "drc", drc_prop, JSPROP_ENUMERATE },	//
-        { "normalizeValue", normalizevalue_prop, JSPROP_ENUMERATE },	//
-        { 0 }
-};
-
-JSFunctionSpec ADM_JSAvidemuxAudio::avidemuxaudio_methods[] = 
-{
-        { "save", Save, 1, 0, 0 },	// save audio stream
-        { "load", Load, 2, 0, 0 },	// load audio stream
-        { "reset", Reset, 0, 0, 0 },	// reset audio stream
-        { "codec", Codec, 4, 0, 0 },	// set output codec
-        { "getNbTracks", getNbTracks, 0, 0, 0 },    // set output codec
-        { "setTrack", setTrack, 1, 0, 0 },    // set output codec
-        { "secondAudioTrack", secondAudioTrack, 2, 0, 0 },    // set audio track
-        { "mixer", mixer, 1, 0, 0 },    // set mixer configuration
-        { "getNbChannels", getNbChannels, 1, 0, 0 },
-        { "getBitrate", getBitrate, 1, 0, 0 },
-        { 0 }
-};
-//*******************************
-JSPropertySpec *ADM_JsAudioGetProperties(void)
-{
-    return ADM_JSAvidemuxAudio::avidemuxaudio_properties;
-}
-JSFunctionSpec *ADM_JsAudioGetFunctions(void)
-{
-    return ADM_JSAvidemuxAudio::avidemuxaudio_methods;
-}
-//*******************************
-JSClass ADM_JSAvidemuxAudio::m_classAvidemuxAudio = 
-{
-        "AvidemuxAudio", JSCLASS_HAS_PRIVATE,
-        JS_PropertyStub, JS_PropertyStub,
-        ADM_JSAvidemuxAudio::JSGetProperty, ADM_JSAvidemuxAudio::JSSetProperty,
-        JS_EnumerateStub, JS_ResolveStub, 
-        JS_ConvertStub, ADM_JSAvidemuxAudio::JSDestructor
-};
-
-ADM_JSAvidemuxAudio::~ADM_JSAvidemuxAudio(void)
-{
-        if(m_pObject != NULL)
-                delete m_pObject;
-        m_pObject = NULL;
-}
-
-void ADM_JSAvidemuxAudio::setObject(ADM_AvidemuxAudio *pObject)
-{
-        m_pObject = pObject; 
-}
-        
-ADM_AvidemuxAudio *ADM_JSAvidemuxAudio::getObject()
-{
-        return m_pObject; 
-}
-
-JSObject *ADM_JSAvidemuxAudio::JSInit(JSContext *cx, JSObject *obj, JSObject *proto)
-{
-        JSObject *newObj = JS_InitClass(cx, obj, proto, &m_classAvidemuxAudio, 
-                                                                        ADM_JSAvidemuxAudio::JSConstructor, 0,
-                                                                        ADM_JSAvidemuxAudio::avidemuxaudio_properties, ADM_JSAvidemuxAudio::avidemuxaudio_methods,
-                                                                        NULL, NULL);
-        return newObj;
-}
-
-JSBool ADM_JSAvidemuxAudio::JSConstructor(JSContext *cx, JSObject *obj, uintN argc, 
-                                                                jsval *argv, jsval *rval)
-{
-        if(argc != 0)
-                return JS_FALSE;
-        ADM_JSAvidemuxAudio *p = new ADM_JSAvidemuxAudio();
-        ADM_AvidemuxAudio *pObject = new ADM_AvidemuxAudio();
-        p->setObject(pObject);
-        if ( ! JS_SetPrivate(cx, obj, p) )
-                return JS_FALSE;
-        *rval = OBJECT_TO_JSVAL(obj);
-        return JS_TRUE;
-}
-
-void ADM_JSAvidemuxAudio::JSDestructor(JSContext *cx, JSObject *obj)
-{
-        ADM_JSAvidemuxAudio *p = (ADM_JSAvidemuxAudio *)JS_GetPrivate(cx, obj);
-        if(p != NULL)
-                delete p;
-        p = NULL;
-}
-
-JSBool ADM_JSAvidemuxAudio::JSGetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp)
-{
-        if (JSVAL_IS_INT(id)) 
-        {
-                ADM_JSAvidemuxAudio *priv = (ADM_JSAvidemuxAudio *) JS_GetPrivate(cx, obj);
-                switch(JSVAL_TO_INT(id))
-                {
-                        case resample_prop:
-                                *vp=INT_TO_JSVAL(audioFilterGetResample());
-                                break;
-                        case delay_prop:
-//                                *vp = INT_TO_JSVAL(priv->getObject()->m_nDelay);
-                                break;
-                        case film2pal_prop:
-//                                *vp = BOOLEAN_TO_JSVAL(priv->getObject()->m_bFilm2PAL);
-                                break;
-                        case pal2film_prop:
-//                                *vp = BOOLEAN_TO_JSVAL(priv->getObject()->m_bPAL2Film);
-                                break;
-                        case normalizemode_prop:
-//                              *vp = BOOLEAN_TO_JSVAL(priv->getObject()->m_nNormalizeMode);
-                              break;
-                        case normalizevalue_prop:
-//                          *vp = BOOLEAN_TO_JSVAL(priv->getObject()->m_nNormalizeValue);
-                          break;
-                        case drc_prop:
-//                            *vp = BOOLEAN_TO_JSVAL(priv->getObject()->m_bDRC);
-                            break;
-/*
-                        case audio_prop:
-                                *vp = OBJECT_TO_JSVAL(priv->getObject()->m_pAudio);
-                                break;
-*/
-                }
-        }
-        return JS_TRUE;
-}
-
-JSBool ADM_JSAvidemuxAudio::JSSetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp)
-{
-        if (JSVAL_IS_INT(id)) 
-        {
-                
-                ADM_JSAvidemuxAudio *priv = (ADM_JSAvidemuxAudio *) JS_GetPrivate(cx, obj);
-                switch(JSVAL_TO_INT(id))
-                {
-#if 0                     
-                        case drc_prop:
-                        {
-                                if(JSVAL_IS_BOOLEAN(*vp) == false)
-                                        break;
-                                priv->getObject()->m_bDRC = JSVAL_TO_BOOLEAN(*vp);
-                                enterLock();
-                                audioFilterDrc(priv->getObject()->m_bDRC);
-                                leaveLock();
-                                break;
-                        }
-                       
-                        case delay_prop:
-                        {
-                                if(JSVAL_IS_INT(*vp) == false)
-                                        break;
-                                priv->getObject()->m_nDelay = JSVAL_TO_INT(*vp);
-                                //audioFilterDelay(priv->getObject()->m_nDelay);
-                                enterLock();
-                                //UI_setTimeShift(1, priv->getObject()->m_nDelay); 
-                                leaveLock();
-                                break;
-                        }
-                        case film2pal_prop:
-                        {
-                                if(JSVAL_IS_BOOLEAN(*vp) == false)
-                                        break;
-                                priv->getObject()->m_bFilm2PAL = JSVAL_TO_BOOLEAN(*vp);
-                                enterLock();
-                                audioFilterFilm2Pal(priv->getObject()->m_bFilm2PAL);
-                                leaveLock();
-                                break;
-                        }
-                        case pal2film_prop:
-                        {
-                                if(JSVAL_IS_BOOLEAN(*vp) == false)
-                                        break;
-                                priv->getObject()->m_bPAL2Film = JSVAL_TO_BOOLEAN(*vp);
-                                enterLock();
-                                audioFilterPal2Film(priv->getObject()->m_bPAL2Film);
-                                leaveLock();
-                                break;
-                        }
-                        case normalizemode_prop:
-                        {
-                                  enterLock();
-                                  priv->getObject()->m_nNormalizeMode = JSVAL_TO_INT(*vp);
-                                  audioFilterNormalizeMode(priv->getObject()->m_nNormalizeMode);
-                                  leaveLock();
-                                  break;
-                        }
-                        case normalizevalue_prop:
-                        {
-                                  priv->getObject()->m_nNormalizeValue = JSVAL_TO_INT(*vp);
-                                  enterLock();
-                                  audioFilterNormalizeValue(priv->getObject()->m_nNormalizeValue);
-                                  leaveLock();
-                                  break;
-                        }
-#endif
-
-                        case film2pal_prop:
-                        {
-                                if(JSVAL_IS_BOOLEAN(*vp) == false)
-                                        break;
-                                enterLock();
-                                if(JSVAL_TO_BOOLEAN(*vp)) 
-                                    audioFilterSetFrameRate(FILMCONV_FILM2PAL);
-                                else
-                                    audioFilterSetFrameRate(FILMCONV_NONE);
-                                leaveLock();
-                                break;
-                        }
-                        case pal2film_prop:
-                        {
-                                if(JSVAL_IS_BOOLEAN(*vp) == false)
-                                        break;
-                                enterLock();
-                                if(JSVAL_TO_BOOLEAN(*vp)) 
-                                    audioFilterSetFrameRate(FILMCONV_PAL2FILM);
-                                else
-                                    audioFilterSetFrameRate(FILMCONV_NONE);
-                                leaveLock();
-                                break;
-                        }
-                    case resample_prop:
-                        {
-                                if(JSVAL_IS_INT(*vp) == false)
-                                        break;
-                                enterLock();
-                                audioFilterSetResample(JSVAL_TO_INT(*vp));
-                                leaveLock();
-                                break;
-                        }
-                        default : printf("UNKNOWN AUDIO PROP\n");
-                        return JS_FALSE;
-                }
-        }
-
-        return JS_TRUE;
-}
-
-
-JSBool ADM_JSAvidemuxAudio::Save(JSContext *cx, JSObject *obj, uintN argc, 
-                                      jsval *argv, jsval *rval)
-{// begin Save
-        ADM_JSAvidemuxAudio *p = (ADM_JSAvidemuxAudio *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 1)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false)
-                return JS_FALSE;
-        char *pTempStr = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        printf("Saving Audio \"%s\"\n",pTempStr);
-        enterLock();
-        *rval = INT_TO_JSVAL(A_audioSave(pTempStr));
-        leaveLock();
-        return JS_TRUE;
-}// end Save
-
-JSBool ADM_JSAvidemuxAudio::Load(JSContext *cx, JSObject *obj, uintN argc, 
-                                      jsval *argv, jsval *rval)
-{// begin Load
-#if 0
-        ADM_JSAvidemuxAudio *p = (ADM_JSAvidemuxAudio *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 2)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false || JSVAL_IS_STRING(argv[1]) == false)
-                return JS_FALSE;
-        char *pTempStr = JS_GetStringBytes(JSVAL_TO_STRING(argv[1]));
-        char *pArg0 = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        printf("Loading Audio \"%s\"\n",pTempStr);
-
-        // 1st arg is type
-        AudioSource src;
-        int result=0;
-        
-        src=audioSourceFromString(pArg0);
-        if(!src) {printf("[Script]Invalid audiosource type\n");return JS_FALSE;}
-        enterLock();
-        switch(src)
-        {
-                case AudioAvi:
-                        result = A_changeAudioStream (aviaudiostream, AudioAvi,NULL);
-                        break;
-                case AudioMP3:
-                        result = A_loadMP3(pTempStr);
-                        break;
-                case AudioWav:
-                        result = A_loadWave(pTempStr);
-                        break;
-                case AudioAC3:
-                        result = A_loadAC3(pTempStr);
-                        break;
-                case AudioNone:
-                        result = A_changeAudioStream(NULL,AudioNone,NULL);
-                        break;
-                default:
-                        ADM_assert(0);
-                        break;
-        }
-        leaveLock()
-        printf("[script] ");
-        
-        if(!result)
-                printf("failed :");
-        else
-                printf("succeed :");
-        printf(" external source %d (%s) \n", src,pTempStr);
-
-        *rval = INT_TO_JSVAL(result);
-#endif
-        return JS_TRUE;
-}// end Load
-
-JSBool ADM_JSAvidemuxAudio::Reset(JSContext *cx, JSObject *obj, uintN argc, 
-                                      jsval *argv, jsval *rval)
-{// begin Reset
-        ADM_JSAvidemuxAudio *p = (ADM_JSAvidemuxAudio *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 0)
-                return JS_FALSE;
-        enterLock();
-        audioFilterReset();
-        leaveLock()
-        *rval = BOOLEAN_TO_JSVAL(true);
-        return JS_TRUE;
-}// end Reset
-// app.audio.codec("lame",128,8,"00 00 00 00 01 00 00 00 ");
-extern uint8_t mk_hex (uint8_t a, uint8_t b);
-/**
-    \fn Codec
-*/
-JSBool ADM_JSAvidemuxAudio::Codec(JSContext *cx, JSObject *obj, uintN argc, 
-                                      jsval *argv, jsval *rval)
-{// begin Codec
-        ADM_JSAvidemuxAudio *p = (ADM_JSAvidemuxAudio *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc < 2)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false || JSVAL_IS_INT(argv[1]) == false )            return JS_FALSE;
-        for(int i=2;i<argc;i++)  if(JSVAL_IS_STRING(argv[i]) == false) return JS_FALSE;
-
-        // Get Codec...
-        char *name = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        ADM_LowerCase(name);
-        enterLock();
-        // First search the codec by its name
-        if(!audioCodecSetByName(name))
-        {
-                *rval = BOOLEAN_TO_JSVAL(false);
-                ADM_error("Cannot set audio codec %s\n",name);
-        }
-        else
-        {
-            // begin set bitrate
-            uint32_t bitrate=JSVAL_TO_INT(argv[1]);
-            // Construct couples
-            CONFcouple *c=NULL;
-            if(argc>2)
-            {
-                int nb=argc-2;
-                jsArgToConfCouple( nb,&c,  argv+2);
-            }
-            *rval = BOOLEAN_TO_JSVAL(setAudioExtraConf(bitrate,c));
-            if(c) delete c;
-        }
-
-        // end set bitrate
-        leaveLock();
-        return JS_TRUE;
-}// end Codec
-/**
-    \fn jsArgToConfCouple
-    \brief Convert js args to confcouple
-
-*/
-bool jsArgToConfCouple(int nb,CONFcouple **conf,  jsval *argv)
-{
-  *conf=NULL;
-  if(!nb) return true;
-  CONFcouple *c=new CONFcouple(nb);
-  *conf=c;
-    for(int i=0;i<nb;i++)
-    {
-        char *param = JS_GetStringBytes(JSVAL_TO_STRING(argv[i]));
-        char *dupe=   ADM_strdup(param);
-        char *name,*value;
-        // dupe is in the form name=value
-        name=dupe;
-        value=name;
-        char *tail=dupe+strlen(dupe);
-        while(value<tail)
-        {
-            if(*value=='=') 
-                {
-                    *value=0;
-                    value++;
-                    break;
-                }
-            value++;
-        }
-        c->setInternalName(name,value);
-        //printf("%s -> [%s,%s]\n",param,name,value);
-        ADM_dezalloc(dupe);
-    }
-    return true;
-}
-
-JSBool ADM_JSAvidemuxAudio::getNbTracks(JSContext *cx, JSObject *obj, uintN argc, 
-                                      jsval *argv, jsval *rval)
-{
-uint32_t nb=0;
-audioInfo *infos=NULL;
-        // default return value
-        ADM_JSAvidemuxAudio *p = (ADM_JSAvidemuxAudio *)JS_GetPrivate(cx, obj);
-        if(argc != 0)
-                return JS_FALSE;
-        // default return value
-      
-        enterLock();
-        video_body->getAudioStreamsInfo(0,&nb, &infos);
-        leaveLock();
-        if(infos)
-                delete [] infos;
-        *rval = INT_TO_JSVAL(nb);
-        return JS_TRUE;
-}// end Codec
-JSBool ADM_JSAvidemuxAudio::setTrack(JSContext *cx, JSObject *obj, uintN argc, 
-                                      jsval *argv, jsval *rval)
-{
-uint32_t nb=0,nw=0;
-audioInfo *infos=NULL;
-        // default return value
-        ADM_JSAvidemuxAudio *p = (ADM_JSAvidemuxAudio *)JS_GetPrivate(cx, obj);
-
-        // default return value
-      if(argc != 1)
-                return JS_FALSE;
-        if(JSVAL_IS_INT(argv[0]) == false)
-                return JS_FALSE;
-        video_body->getAudioStreamsInfo(0,&nb, &infos);
-        delete [] infos;
-        nw=(JSVAL_TO_INT(argv[0]));
-        if(nw>nb) return JS_FALSE;
-        enterLock();
-        video_body->changeAudioStream(0,nw);
-        leaveLock();
-        return JS_TRUE;
-}// end Codec
-JSBool ADM_JSAvidemuxAudio::secondAudioTrack(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-#if 0
-        ADM_JSAvidemuxAudio *p = (ADM_JSAvidemuxAudio *)JS_GetPrivate(cx, obj);
-        if(argc != 2)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false || JSVAL_IS_STRING(argv[1]) == false)
-                return JS_FALSE;
-        // First arg is MP3 etc...
-        char *name = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        ADM_LowerCase(name);
-        // First search the codec by its name
-        AudioSource source;
-        if(AudioInvalid==(source=audioSourceFromString(name)))
-                return JS_FALSE;
-        // Now get the name
-        name = JS_GetStringBytes(JSVAL_TO_STRING(argv[1]));
-        enterLock();
-        if(A_setSecondAudioTrack(source,name))
-        {
-                leaveLock();
-                return JS_TRUE;
-        }
-        leaveLock();
-#endif
-      return JS_FALSE;
-}
-JSBool ADM_JSAvidemuxAudio::mixer(JSContext *cx, JSObject *obj, uintN argc, 
-                                      jsval *argv, jsval *rval)
-{
-uint32_t nb=0,nw=0;
-uint32_t *infos=NULL;
-        // default return value
-        ADM_JSAvidemuxAudio *p = (ADM_JSAvidemuxAudio *)JS_GetPrivate(cx, obj);
-
-        // default return value
-        if(argc != 1)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false) 
-                return JS_FALSE;
-        char *pArg0 = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        enterLock();
-        CHANNEL_CONF c=AudioMuxerStringToId(pArg0);
-        *rval=BOOLEAN_TO_JSVAL(audioFilterSetMixer(c));
-        leaveLock();
-        return JS_TRUE;
-
-}// end Codec
-
-JSBool ADM_JSAvidemuxAudio::getNbChannels(JSContext *cx, JSObject *obj, uintN argc, 
-                                      jsval *argv, jsval *rval)
-{
-uint32_t nb=0, nw=0;
-audioInfo *infos=NULL;
-        // default return value
-        ADM_JSAvidemuxAudio *p = (ADM_JSAvidemuxAudio *)JS_GetPrivate(cx, obj);
-        if(argc != 1)
-                return JS_FALSE;
-        // default return value
-      
-        if(JSVAL_IS_INT(argv[0]) == false)
-                return JS_FALSE;
-        enterLock();
-        video_body->getAudioStreamsInfo(0,&nb, &infos);
-        leaveLock()
-        nw=(JSVAL_TO_INT(argv[0]));
-        if(nw>nb)
-                return JS_FALSE;
-        *rval = INT_TO_JSVAL(infos[nw].channels);
-        delete [] infos;
-        return JS_TRUE;
-}// end Codec
-
-JSBool ADM_JSAvidemuxAudio::getBitrate(JSContext *cx, JSObject *obj, uintN argc, 
-                                      jsval *argv, jsval *rval)
-{
-uint32_t nb=0, nw=0;
-audioInfo *infos=NULL;
-        // default return value
-        ADM_JSAvidemuxAudio *p = (ADM_JSAvidemuxAudio *)JS_GetPrivate(cx, obj);
-        if(argc != 1)
-                return JS_FALSE;
-        // default return value
-      
-        if(JSVAL_IS_INT(argv[0]) == false)
-                return JS_FALSE;
-        enterLock();
-        video_body->getAudioStreamsInfo(0,&nb, &infos);
-        leaveLock()
-        nw=(JSVAL_TO_INT(argv[0]));
-        if(nw>nb)
-                return JS_FALSE;
-        *rval = INT_TO_JSVAL(infos[nw].bitrate);
-        delete [] infos;
-        return JS_TRUE;
-}// end Codec
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxAudio.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxAudio.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxAudio.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,62 +0,0 @@
-#ifndef _ADM_JSAVIDEMUXAUDIO_H
-#define _ADM_JSAVIDEMUXAUDIO_H
-
-#pragma once
-
-
-
-// Spidermonkey
-#include "ADM_smjs/jsapi.h"
-#include "ADM_AvidemuxAudio.h"
-
-class ADM_JSAvidemuxAudio
-{
-public:
-	ADM_JSAvidemuxAudio(void) : m_pObject(NULL) {}
-	virtual ~ADM_JSAvidemuxAudio(void);
-
-	static JSBool JSGetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp);
-	static JSBool JSSetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp);
-	static JSBool JSConstructor(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static void JSDestructor(JSContext *cx, JSObject *obj);
-	static JSObject *JSInit(JSContext *cx, JSObject *obj, JSObject *proto = NULL);
-	static JSBool ScanVBR(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Save(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Load(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Reset(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Codec(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-    static JSBool getNbTracks(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-    static JSBool setTrack(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-    static JSBool lamePreset(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-    static JSBool mixer(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-    static JSBool secondAudioTrack(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-    static JSBool getNbChannels(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-    static JSBool getBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-	static JSPropertySpec avidemuxaudio_properties[];
-	static JSFunctionSpec avidemuxaudio_methods[];
-	enum
-	{
-        audioprocess_prop,
-		resample_prop,
-		delay_prop,
-		film2pal_prop,
-		pal2film_prop,
-        normalizemode_prop,
-        normalizevalue_prop,
-        drc_prop
-	};
-	static JSClass m_classAvidemuxAudio;
-        
-
-
-//protected:
-	void setObject(ADM_AvidemuxAudio *pObject);
-	ADM_AvidemuxAudio *getObject();
-
-private:
-	ADM_AvidemuxAudio *m_pObject;
-
-};
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,579 +0,0 @@
-//
-// C++ Interface: Spider Monkey interface
-//
-// Description: 
-//
-//
-// Author: Anish Mistry
-//      Some modification by mean
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-#include "ADM_default.h"
-
-#include "ADM_JSAvidemuxVideo.h"
-#include "ADM_JSGlobal.h"
-
-
-#include "ADM_commonUI/GUI_ui.h"
-#include "avi_vars.h"
-#include "gui_action.hxx"
-
-
-#include "ADM_editor/ADM_outputfmt.h"
-#include "ADM_commonUI/GUI_ui.h"
-#include "ADM_script/ADM_container.h"
-#include "ADM_videoEncoderApi.h"
-#include "ADM_videoFilterApi.h"
-#include "ADM_videoFilters.h"
-#include "ADM_confCouple.h"
-extern uint8_t A_ListAllBlackFrames( char *file );
-extern uint8_t ADM_saveRaw (const char *name);
-extern int A_saveJpg (char *name);
-extern void filterCleanUp( void );
-extern bool jsArgToConfCouple(int nb,CONFcouple **conf,  jsval *argv);
-bool A_setVideoCodec(const char *nm);
-
-
-JSPropertySpec ADM_JSAvidemuxVideo::avidemuxvideo_properties[] = 
-{ 
-       
-	{ 0 }
-};
-
-JSFunctionSpec ADM_JSAvidemuxVideo::avidemuxvideo_methods[] = 
-{
-	{ "clear", Clear, 0, 0, 0 },	// clear
-    { "clearFilters", ClearFilters, 0, 0, 0 }, // Delete all filters
-	{ "addFilter", AddFilter, 10, 0, 0 },	// Add filter to filter chain
-	{ "codec", Codec, 1, 0, 0 },	// Set the video codec
-	{ "save", Save, 1, 0, 0 },	// save video portion of the stream
-	{ "saveJpeg", SaveJPEG, 1, 0, 0 },	// save the current frame as a JPEG
-	{ "listBlackFrames", ListBlackFrames, 1, 0, 0 },	// output a list of the black frame to a file
-	{ "setPostProc", PostProcess, 3, 0, 0 },	// Postprocess
-    { "setFps1000", SetFps1000, 1, 0, 0 },        // Postprocess
-    { "getFps1000", GetFps1000, 0, 0, 0 },        // Postprocess
-    { "getNbFrames", GetNbFrames, 0, 0, 0 },        // Postprocess
-    { "getWidth", GetWidth, 0, 0, 0 },        // Postprocess
-    { "getHeight", GetHeight, 0, 0, 0 },        // Postprocess
-    { "getFCC", GetFCC, 0, 0, 0 },        // Postprocess
-    { "isVopPacked", isVopPacked, 0, 0, 0 },        // Postprocess
-    { "hasQpel", hasQpel, 0, 0, 0 },        // Postprocess
-    { "hasGmc", hasGmc, 0, 0, 0 },        // Postprocess
-    { "frameSize", getFrameSize, 1, 0, 0 },        // FrameSize
-    { "frameType", getFrameType, 1, 0, 0 },        // Postprocess
-	{ 0 }
-};
-/*********************************/
-JSPropertySpec *ADM_JsVideoGetProperties(void)
-{
-    return ADM_JSAvidemuxVideo::avidemuxvideo_properties;
-}
-JSFunctionSpec *ADM_JsVideoGetFunctions(void)
-{
-    return ADM_JSAvidemuxVideo::avidemuxvideo_methods;
-}
-/*********************************/
-JSClass ADM_JSAvidemuxVideo::m_classAvidemuxVideo = 
-{
-	"AvidemuxVideo", JSCLASS_HAS_PRIVATE,
-	JS_PropertyStub, JS_PropertyStub,
-	ADM_JSAvidemuxVideo::JSGetProperty, ADM_JSAvidemuxVideo::JSSetProperty,
-	JS_EnumerateStub, JS_ResolveStub, 
-	JS_ConvertStub, ADM_JSAvidemuxVideo::JSDestructor
-};
-
-ADM_JSAvidemuxVideo::~ADM_JSAvidemuxVideo(void)
-{
-	if(m_pObject != NULL)
-		delete m_pObject;
-	m_pObject = NULL;
-}
-
-void ADM_JSAvidemuxVideo::setObject(ADM_AvidemuxVideo *pObject)
-{
-	m_pObject = pObject; 
-}
-	
-ADM_AvidemuxVideo *ADM_JSAvidemuxVideo::getObject()
-{
-	return m_pObject; 
-}
-
-JSObject *ADM_JSAvidemuxVideo::JSInit(JSContext *cx, JSObject *obj, JSObject *proto)
-{
-        JSObject *newObj = JS_InitClass(cx, obj, proto, &m_classAvidemuxVideo, 
-                                        ADM_JSAvidemuxVideo::JSConstructor, 0,
-                                        ADM_JSAvidemuxVideo::avidemuxvideo_properties, ADM_JSAvidemuxVideo::avidemuxvideo_methods,
-                                        NULL, NULL);
-	return newObj;
-}
-
-JSBool ADM_JSAvidemuxVideo::JSConstructor(JSContext *cx, JSObject *obj, uintN argc, 
-								 jsval *argv, jsval *rval)
-{
-        if(argc != 0)
-                return JS_FALSE;
-        ADM_JSAvidemuxVideo *p = new ADM_JSAvidemuxVideo();
-        ADM_AvidemuxVideo *pObject = new ADM_AvidemuxVideo();
-        p->setObject(pObject);
-        if ( ! JS_SetPrivate(cx, obj, p) )
-                return JS_FALSE;
-        *rval = OBJECT_TO_JSVAL(obj);
-        return JS_TRUE;
-}
-
-void ADM_JSAvidemuxVideo::JSDestructor(JSContext *cx, JSObject *obj)
-{
-        ADM_JSAvidemuxVideo *p = (ADM_JSAvidemuxVideo *)JS_GetPrivate(cx, obj);
-        if(p != NULL)
-                delete p;
-        p = NULL;
-}
-
-JSBool ADM_JSAvidemuxVideo::JSGetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp)
-{
-        if (JSVAL_IS_INT(id)) 
-        {
-                ADM_JSAvidemuxVideo *priv = (ADM_JSAvidemuxVideo *) JS_GetPrivate(cx, obj);
-                switch(JSVAL_TO_INT(id))
-                {
-                        case videoprocess_prop:
-                                *vp = BOOLEAN_TO_JSVAL(priv->getObject()->m_bVideoProcess);
-                                break;
-                }
-        }
-        return JS_TRUE;
-}
-
-JSBool ADM_JSAvidemuxVideo::JSSetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp)
-{
-        if (JSVAL_IS_INT(id)) 
-        {
-                ADM_JSAvidemuxVideo *priv = (ADM_JSAvidemuxVideo *) JS_GetPrivate(cx, obj);
-                switch(JSVAL_TO_INT(id))
-                {
-                        case videoprocess_prop:
-                                if(JSVAL_IS_BOOLEAN(*vp) == false)
-                                        break;
-                                priv->getObject()->m_bVideoProcess = JSVAL_TO_BOOLEAN(*vp);
-                                UI_setVProcessToggleStatus(priv->getObject()->m_bVideoProcess);
-                                break;
-                }
-        }
-        return JS_TRUE;
-}
-
-JSBool ADM_JSAvidemuxVideo::Clear(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin Clear
-        ADM_JSAvidemuxVideo *p = (ADM_JSAvidemuxVideo *)JS_GetPrivate(cx, obj);
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 0)
-                return JS_FALSE;
-        printf("Clearing Video... \n");
-        enterLock();
-//        *rval = BOOLEAN_TO_JSVAL(video_body->deleteAllSegments());
-        leaveLock();
-        return JS_TRUE;
-}// end Clear
-
-
-JSBool ADM_JSAvidemuxVideo::ClearFilters(JSContext *cx, JSObject *obj, uintN argc,
-                                       jsval *argv, jsval *rval)
-{// begin Clear
-//	filterCleanUp();
-        return JS_TRUE;
-}// end Clear
-
-/**
-    \fn AddFilter
-*/
-JSBool ADM_JSAvidemuxVideo::AddFilter(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin AddFilter
-
-        uint32_t filterTag;
-
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc == 0)
-                return JS_FALSE;
-        char *filterName=JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        filterTag = ADM_vf_getTagFromInternalName(filterName);
-        ADM_info("Adding Filter %s -> %"LU"... \n",filterName,filterTag);
-
-        enterLock();
-        CONFcouple *c=NULL;
-        if(argc)
-            jsArgToConfCouple(argc-1,&c,argv+1);
-        *rval=BOOLEAN_TO_JSVAL(  ADM_vf_addFilterFromTag(filterTag,c,false));
-        if(c) delete c;
-        leaveLock();
-        return JS_TRUE;
-}// end AddFilter
-/**
-    \fn Codec
-*/
-JSBool ADM_JSAvidemuxVideo::Codec(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin Codec
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc <1)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false )
-        {
-                ADM_error("Cannot set codec\n");
-                return JS_FALSE;
-        }
-        char *codec=JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        // Set codec.
-        enterLock();
-        if(A_setVideoCodec(codec)==false)
-        {
-            ADM_error("Could not select codec %s\n",codec);
-            leaveLock();
-            return JS_FALSE;
-        }
-        CONFcouple *c;
-        jsArgToConfCouple(argc-1,&c,argv+1);
-        *rval = BOOLEAN_TO_JSVAL( videoEncoder6_SetConfiguration(c));
-        ADM_info("Selected codec %s\n",codec);
-        if(c) delete c;
-        leaveLock();
-
-        return JS_TRUE;
-}// end Codec
-
-/**
-    \fn Save
-*/
-JSBool ADM_JSAvidemuxVideo::Save(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin Save
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-#if 0
-        if(argc != 1)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false)
-                return JS_FALSE;
-        char *pTempStr = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        printf("Saving Video \"%s\"\n",pTempStr);
-        enterLock();
-        *rval = INT_TO_JSVAL(ADM_saveRaw(pTempStr));
-        leaveLock();
-#endif
-        return JS_TRUE;
-}// end Save
-/**
-    \fn saveJpeg
-*/
-JSBool ADM_JSAvidemuxVideo::SaveJPEG(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin SaveJPG
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-#if 0
-        if(argc != 1)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false)
-                return JS_FALSE;
-        char *pTempStr = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        printf("Saving JPEG \"%s\"\n",pTempStr);
-        enterLock();
-        *rval = INT_TO_JSVAL(A_saveJpg(pTempStr));
-        leaveLock();
-#endif
-        return JS_TRUE;
-}// end SaveJPG
-/**
-    \fn ListBlackFrames
-*/
-JSBool ADM_JSAvidemuxVideo::ListBlackFrames(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin ListBlackFrames
-        
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-#if 0
-        if(argc != 1)
-          return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false)
-          return JS_FALSE;
-        
-        enterLock();
-        A_ListAllBlackFrames(JS_GetStringBytes(JSVAL_TO_STRING(argv[0])));
-        leaveLock();
-        *rval = BOOLEAN_TO_JSVAL(true);
-#endif
-        return JS_TRUE;
-}// end ListBlackFrames
-/**
-    \fn PostProcess
-*/
-JSBool ADM_JSAvidemuxVideo::PostProcess(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-        // default return value
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 3)
-                return JS_FALSE;
-        if(JSVAL_IS_INT(argv[0]) == false || JSVAL_IS_INT(argv[1]) == false || JSVAL_IS_INT(argv[2]) == false)
-                return JS_FALSE;
-        
-        enterLock();
-        int rtn =video_body->setPostProc(
-            JSVAL_TO_INT(argv[0]),JSVAL_TO_INT(argv[1]),JSVAL_TO_INT(argv[2]));
-        leaveLock();
-        *rval = BOOLEAN_TO_JSVAL(rtn);
-        return JS_TRUE;
-}// end PostProcess
-/**
-    \fn GetFps1000
-*/
-JSBool ADM_JSAvidemuxVideo::GetFps1000(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-aviInfo info;
-        if(argc != 0)
-          return JS_FALSE;
-        
-        enterLock();
-        video_body->getVideoInfo(&info);
-        leaveLock();
-        
-        *rval = INT_TO_JSVAL(info.fps1000);
-        return JS_TRUE;
-}// end PostProcess
-/**
-    \fn GetNbFrames
-*/
-JSBool ADM_JSAvidemuxVideo::GetNbFrames(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-aviInfo info;
-        if(argc != 0)
-          return JS_FALSE;
-        
-        enterLock();
-        video_body->getVideoInfo(&info);
-        leaveLock();
-        
-        *rval = INT_TO_JSVAL(info.nb_frames);
-        return JS_TRUE;
-}// end PostProcess
-/**
-    \fn SetFps1000
-*/
-JSBool ADM_JSAvidemuxVideo::SetFps1000(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-int fps;
-aviInfo info;
-
-        if(argc != 1)
-          return JS_FALSE;
-        if(JSVAL_IS_INT(argv[0]) == false)
-          return JS_FALSE;
-
-        enterLock();
-        video_body->getVideoInfo(&info);
-        video_body->getVideoInfo (avifileinfo);
-
-
-        // default return value
-        fps=JSVAL_TO_INT(argv[0]);
-        if(fps>100000 || fps<2000)
-        {      
-                printf("Fps too low\n");
-                leaveLock();
-                return JS_FALSE;
-        }       
- 	
-       info.fps1000=fps;
-        video_body->updateVideoInfo(&info);
-        video_body->getVideoInfo (avifileinfo);
-        
-	leaveLock();
-        return JS_TRUE;
-}// end PostProcess
-
-/**
-    \fn GetWidth
-*/
-JSBool ADM_JSAvidemuxVideo::GetWidth(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-aviInfo info;
-        if(argc != 0)
-          return JS_FALSE;
-
-
-        enterLock();
-        video_body->getVideoInfo(&info);
-        leaveLock();
-        
-        *rval = INT_TO_JSVAL(info.width);
-        return JS_TRUE;
-}// end PostProcess
-/**
-    \fn SetFps1000
-*/
-JSBool ADM_JSAvidemuxVideo::GetHeight(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-aviInfo info;
-        if(argc != 0)
-          return JS_FALSE;
-
-        enterLock();
-        video_body->getVideoInfo(&info);
-        leaveLock();
-        
-        *rval = INT_TO_JSVAL(info.height);
-        return JS_TRUE;
-}// end PostProcess
-/**
-    \fn GetFCC
-*/
-
-JSBool ADM_JSAvidemuxVideo::GetFCC(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-aviInfo info;
-
-        if(argc != 0)
-          return JS_FALSE;
-
-        enterLock();
-        video_body->getVideoInfo(&info);
-        leaveLock();
-        
-        *rval = STRING_TO_JSVAL(JS_NewStringCopyZ(cx, fourCC::tostring(info.fcc)));
-        return JS_TRUE;
-}// end PostProcess
-/**
-    \fn SetFps1000
-*/
-
-JSBool ADM_JSAvidemuxVideo::isVopPacked(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-int32_t info;
-        if(argc != 0)
-          return JS_FALSE;
-
-      enterLock();
-       info=video_body->getSpecificMpeg4Info();
-       leaveLock();
-         
-        // default return value
-        *rval=JS_FALSE;
-        //if(info & ADM_VOP_ON) *rval=JS_TRUE;
-        return JS_TRUE;
-}// end PostProcess
-/**
-    \fn hasGmc
-*/
-
-JSBool ADM_JSAvidemuxVideo::hasGmc(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-uint32_t info;
-        if(argc != 0)
-          return JS_FALSE;
-
-       enterLock();
-       info=video_body->getSpecificMpeg4Info();
-       leaveLock(); 
-        
-        // default return value
-        *rval=JS_FALSE;
-        //if(info & ADM_GMC_ON) *rval=JS_TRUE;
-        return JS_TRUE;
-}// end PostProcess
-/**
-    \fn hasQpel
-*/
-
-JSBool ADM_JSAvidemuxVideo::hasQpel(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-uint32_t info;
-        if(argc != 0)
-          return JS_FALSE;
-        
-        enterLock();
-        info=video_body->getSpecificMpeg4Info();
-        leaveLock(); 
-        
-        *rval=JS_FALSE;
-        //if(info & ADM_QPEL_ON) *rval=JS_TRUE;
-        return JS_TRUE;
-}// end PostProcess
-
-/**
-    \fn getFrameSize
-*/
-
-JSBool ADM_JSAvidemuxVideo::getFrameSize(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-uint32_t info;
-uint32_t frame;
-uint32_t sz;
-        if(argc != 1)
-          return JS_FALSE;
-#if 0        
-        enterLock();
-        frame=JSVAL_TO_INT(argv[0]);
-        if(!video_body->getFrameSize(frame,&sz)) return JS_FALSE;
-        leaveLock(); 
-        
-        *rval=INT_TO_JSVAL(sz);
-#endif
-        return JS_TRUE;
-}// end PostProcess
-/**
-    \fn getFrameType
-*/
-
-JSBool ADM_JSAvidemuxVideo::getFrameType(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-uint32_t info;
-uint32_t frame;
-uint32_t sz;
-        if(argc != 1)
-          return JS_FALSE;
-#if 0        
-        enterLock();
-        frame=JSVAL_TO_INT(argv[0]);
-        if(!video_body->getFlags(frame,&sz)) return JS_FALSE;
-        leaveLock(); 
-        
-        *rval=INT_TO_JSVAL(sz);
-#endif
-        return JS_TRUE;
-}// end PostProcess
-
-/**
-    \fn A_setVideoCodec
-*/
-bool A_setVideoCodec(const char *nm)
-{
-    int idx=videoEncoder6_GetIndexFromName(nm);
-    if(idx==-1)
-    {
-        ADM_error("No such encoder :%s\n",nm);
-    }
-    // Select by index
-    videoEncoder6_SetCurrentEncoder(idx);
-    UI_setVideoCodec(idx);
-    return true;
-}
-
-/* EOF */

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSAvidemuxVideo.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,68 +0,0 @@
-#ifndef _ADM_JSAVIDEMUXVIDEO_H
-#define _ADM_JSAVIDEMUXVIDEO_H
-
-#pragma once
-
-// Spidermonkey
-#include "ADM_smjs/jsapi.h"
-#include "ADM_AvidemuxVideo.h"
-
-class ADM_JSAvidemuxVideo
-{
-public:
-	ADM_JSAvidemuxVideo(void) : m_pObject(NULL) {}
-	virtual ~ADM_JSAvidemuxVideo(void);
-
-	static JSBool JSGetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp);
-	static JSBool JSSetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp);
-	static JSBool JSConstructor(JSContext *cx, JSObject *obj, uintN argc, 
-								jsval *argv, jsval *rval);
-	static void JSDestructor(JSContext *cx, JSObject *obj);
-	static JSObject *JSInit(JSContext *cx, JSObject *obj, JSObject *proto = NULL);
-	static JSBool Clear(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool ClearFilters(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool AddFilter(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool IndexMPEG(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Codec(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool codecPlugin(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool CodecConf(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Save(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool SaveJPEG(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool ListBlackFrames(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool PostProcess(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool RebuildIBFrames(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-	static JSBool SetFps1000(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool GetFps1000(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-        static JSBool GetNbFrames(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool GetWidth(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool GetHeight(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool GetFCC(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-	static JSBool isVopPacked(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool hasGmc(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool hasQpel(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-        static JSBool getFrameSize(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool getFrameType(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool dumpEditing(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool dumpTiming(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-
-	static JSPropertySpec avidemuxvideo_properties[];
-	static JSFunctionSpec avidemuxvideo_methods[];
-	enum
-	{
-                videoprocess_prop,
-	};
-	static JSClass m_classAvidemuxVideo;
-
-//protected:
-	void setObject(ADM_AvidemuxVideo *pObject);
-	ADM_AvidemuxVideo *getObject();
-
-private:
-	ADM_AvidemuxVideo *m_pObject;
-
-};
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,231 +0,0 @@
-/**
-    \file ADM_JSDebug.cpp
-    \brief Debug oriented functions for avidemux JS/JS shell
-    \author mean (c) 2009 fixounet at free.fr
-
-
-*/
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include "ADM_default.h"
-#include <string.h>
-#include <pthread.h>
-#include "DIA_coreToolkit.h"
-
-#include "ADM_JSGlobal.h"
-#include "ADM_JSDebug.h"
-#include "ADM_JSif.h"
-#include "ADM_editor/ADM_edit.hxx"
-/**/
-
-JS_PROTOTYPE displayError;
-JS_PROTOTYPE displayInfo;
-JS_PROTOTYPE print;
-JS_PROTOTYPE displayInfo;
-JS_PROTOTYPE assertTest;
-JS_PROTOTYPE crashTest;
-JS_PROTOTYPE help;
-JS_PROTOTYPE dumpEditing;
-JS_PROTOTYPE dumpTiming;
-/**/
-
-extern JSFunctionSpec *ADM_JsAudioGetFunctions(void);
-extern JSFunctionSpec *ADM_JsVideoGetFunctions(void);
-extern JSFunctionSpec *ADM_JsClassGetFunctions(void);
-extern JSFunctionSpec *ADM_JsDebugGetFunctions(void);
-extern JSFunctionSpec *ADM_JsFunctionGetFunctions(void);
-
-/**/
-static JSFunctionSpec adm_debug_functions[] = {
-  /*    name          native          nargs    */
-  {"displayError",  displayError,       1},
-  {"displayInfo",   displayInfo,        1},
-  {"print",         print,              1},
-  {"assert",        assertTest,         0},
-  {"crashTest",     crashTest,          0},
-  {"help",          help,               0},
-  {"dumpEditing",   dumpEditing,        0},
-  {"dumpTiming",    dumpTiming,         0},
-  {0}
-};
-extern ADM_Composer *video_body;
-void ADM_dumpJSHooks(void);
-/**
-    \fn JS_AvidemuxRegisterDebugFunction
-*/
-bool JS_AvidemuxRegisterDebugFunction(JSContext *cx,JSObject *global)
-{
-	if(JS_DefineFunctions(cx, global, adm_debug_functions) == true)
-		return true;
-
-	ADM_warning("Unable to define functions\n");
-	return false;
-}
-/**
-    \fn ADM_JsDebugGetFunctions
-
-*/
-JSFunctionSpec *ADM_JsDebugGetFunctions(void)
-{
-    return adm_debug_functions;
-}
-
-/**
-    \fn displayError
-    \brief error popup
-*/
-JSBool displayError(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin displayError
-	// default return value
-	if(argc != 1)
-		return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-	char  *stringa = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-	GUI_Verbose();
-	GUI_Error_HIG("Error",stringa);
-	GUI_Quiet();
-
-	return JS_TRUE;
-}// end displayError
-/**
-    \fn displayInfo
-    \brief info popup
-*/
-
-JSBool displayInfo(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin displayInfo
-	// default return value
-	if(argc != 1)
-		return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-	char  *stringa = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-	GUI_Verbose();
-	GUI_Info_HIG(ADM_LOG_IMPORTANT,"Info",stringa);
-	GUI_Quiet();
-	return JS_TRUE;
-}// end displayInfo
- /**
-    \fn print
-*/
-JSBool print(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin print
-        if(argc != 1)
-                return JS_FALSE;
-        char *out=JS_GetStringBytes(JS_ValueToString(cx, argv[0]));
-        jsLog(JS_LOG_NORMAL,"%s",out);
-        return JS_TRUE;
-}// end print
-/**
-    \fn crashTest
-    \brief Force a crash
-*/
-JSBool crashTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  
-  int *foobar=NULL;
-  *foobar=0; // CRASH!
-  return JS_TRUE;
-}
-/**
-    \fn assertTest
-    \brief Force a crash
-*/
-JSBool assertTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  
-  ADM_assert(0);
-  return JS_TRUE;
-}
-
-static void dumpFunc(JSFunctionSpec *f)
-{
-    while(f->name)
-    {
-        jsLog(JS_LOG_NORMAL,"     %s(..)",f->name);
-        f++;
-    }
-}
-/**
-    \fn help
-    \brief dump avidemux specific functions
-*/
-JSBool help(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-        if(!argc)
-        {
-            jsLog(JS_LOG_NORMAL,"help(\"class\"); or help(\"video\"); or help(\"audio\"); or help(\"debug\"); or debug(\"functions\"");
-            return JS_TRUE;
-        }
-        if(argc != 1)
-        {
-          jsLog(JS_LOG_ERROR,"help accepts only one arg, type help() to get them\n");
-          return JS_FALSE;
-        } 
-        JSFunctionSpec *table=NULL;
-        char *f=JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        
-#define DUMPTABLE(x,y) if(!strcasecmp(f,#x)) table=y();
-        if(f)
-        {
-            DUMPTABLE(audio,ADM_JsAudioGetFunctions);
-            DUMPTABLE(video,ADM_JsVideoGetFunctions);
-            DUMPTABLE(debug,ADM_JsDebugGetFunctions);
-            DUMPTABLE(functions,ADM_JsFunctionGetFunctions);
-            DUMPTABLE(class,ADM_JsClassGetFunctions);
-        }
-        if(table) dumpFunc(table);
-        else jsLog(JS_LOG_ERROR,"%s not found",f);
-  
-  return JS_TRUE;
-}
-/**
-    \fn dumpEditing
-    \brief dump segment, video & all
-*/
-JSBool dumpEditing(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-uint32_t info;
-uint32_t frame;
-uint32_t sz;
-        if(argc)
-        {
-            return JS_FALSE;
-        }
-        enterLock();
-        video_body->dumpEditing();
-        leaveLock(); 
-        
-        return JS_TRUE;
-}// end PostProcess
-/**
-    \fn dumpTiming
-    \brief dump segment, video & all
-*/
-JSBool dumpTiming(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-uint32_t info;
-uint32_t frame;
-uint32_t sz;
-        if(argc != 0)
-          return JS_FALSE;
-  
-        enterLock();
-        video_body->dumpTiming();
-        leaveLock(); 
-        
-        return JS_TRUE;
-}// end PostProcess
-// EOF
\ No newline at end of file

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDebug.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,22 +0,0 @@
-/**
-    \file ADM_JSDebug.h
-    \brief Debug oriented functions for avidemux JS/JS shell
-    \author mean (c) 2009 fixounet at free.fr
-
-
-*/
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef ADMJS_DEBUG_H
-#define ADMJS_DEBUG_H
-
-
-
-#endif
\ No newline at end of file

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDirectorySearch.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDirectorySearch.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDirectorySearch.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,249 +0,0 @@
-// C++ Interface: Spider Monkey interface
-//
-// Description: 
-//
-//
-// Author: Anish Mistry
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-
-#include "ADM_JSDirectorySearch.h"
-#include "DirectorySearch.h"
-
-JSPropertySpec ADM_JSDirectorySearch::directorysearch_properties[] = 
-{ 
-	{ "isDoubleDot", is_double_dot_prop, JSPROP_ENUMERATE },	// .
-	{ "isSingleDot", is_single_dot_prop, JSPROP_ENUMERATE },	// ..
-	{ "isHidden", is_hidden_prop, JSPROP_ENUMERATE },	// hidden file
-	{ "isArchive", is_archive_prop, JSPROP_ENUMERATE },	// archived file
-	{ "isDirectory", is_directory_prop, JSPROP_ENUMERATE },	// directory
-	{ "isNotFile", is_not_file_prop, JSPROP_ENUMERATE },	// not a file
-	{ 0 }
-};
-
-JSFunctionSpec ADM_JSDirectorySearch::directorysearch_methods[] =
-{
-	{ "Init", Init, 1, 0, 0 },	// Initialize search
-	{ "Close", Close, 0, 0, 0 },	// Close the search
-	{ "GetFileName", GetFileName, 0, 0, 0 },	// return the current file name
-	{ "GetFileDirectory", GetFileDirectory, 0, 0, 0 },	// returns the directory of the file
-	{ "GetFilePath", GetFilePath, 0, 0, 0 },	// returns the full path of the file
-	{ "NextFile", NextFile, 0, 0, 0 },	// Advance search to the next file
-	{ "GetFileSize", GetFileSize, 0, 0, 0 },	// Returns the size of the file in bytes
-	{ "GetExtension", GetExtension, 0, 0, 0 },	// Returns the extension of the current file
-	{ "IsExtension", IsExtension, 1, 0, 0 },	// Compares the first argument string with the current extension and returns true on a match, false otherwise
-	{ 0 }
-};
-
-JSClass ADM_JSDirectorySearch::m_classDirectorySearch =
-{
-	"DirectorySearch", JSCLASS_HAS_PRIVATE,
-	JS_PropertyStub, JS_PropertyStub,
-	ADM_JSDirectorySearch::JSGetProperty, ADM_JSDirectorySearch::JSSetProperty,
-	JS_EnumerateStub, JS_ResolveStub,
-	JS_ConvertStub, ADM_JSDirectorySearch::JSDestructor
-};
-
-ADM_JSDirectorySearch::~ADM_JSDirectorySearch(void)
-{
-	if(m_pObject != NULL)
-		delete m_pObject;
-	m_pObject = NULL;
-}
-
-void ADM_JSDirectorySearch::setObject(CDirectorySearch *pObject)
-{
-	m_pObject = pObject; 
-}
-	
-CDirectorySearch *ADM_JSDirectorySearch::getObject()
-{
-	return m_pObject; 
-}
-
-JSObject *ADM_JSDirectorySearch::JSInit(JSContext *cx, JSObject *obj, JSObject *proto)
-{
-	JSObject *newObj = JS_InitClass(cx, obj, proto, &m_classDirectorySearch, 
-									ADM_JSDirectorySearch::JSConstructor, 0,
-									ADM_JSDirectorySearch::directorysearch_properties, ADM_JSDirectorySearch::directorysearch_methods,
-									NULL, NULL);
-	return newObj;
-}
-
-JSBool ADM_JSDirectorySearch::JSConstructor(JSContext *cx, JSObject *obj, uintN argc, 
-								 jsval *argv, jsval *rval)
-{
-	if(argc != 0)
-		return JS_FALSE;
-	ADM_JSDirectorySearch *p = new ADM_JSDirectorySearch();
-	CDirectorySearch *pObject = new CDirectorySearch();
-	p->setObject(pObject);
-	if ( ! JS_SetPrivate(cx, obj, p) )
-		return JS_FALSE;
-	*rval = OBJECT_TO_JSVAL(obj);
-	return JS_TRUE;
-}
-
-void ADM_JSDirectorySearch::JSDestructor(JSContext *cx, JSObject *obj)
-{
-	ADM_JSDirectorySearch *p = (ADM_JSDirectorySearch *)JS_GetPrivate(cx, obj);
-	if(p != NULL)
-		delete p;
-	p = NULL;
-}
-
-JSBool ADM_JSDirectorySearch::JSGetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp)
-{
-	if (JSVAL_IS_INT(id)) 
-	{
-		ADM_JSDirectorySearch *priv = (ADM_JSDirectorySearch *) JS_GetPrivate(cx, obj);
-		switch(JSVAL_TO_INT(id))
-		{
-			case is_double_dot_prop:
-				*vp = INT_TO_JSVAL(priv->getObject()->IsDoubleDot());
-				break;
-			case is_single_dot_prop:
-				*vp = INT_TO_JSVAL(priv->getObject()->IsSingleDot());
-				break;
-			case is_hidden_prop:
-				*vp = INT_TO_JSVAL(priv->getObject()->IsHidden());
-				break;
-			case is_archive_prop:
-				*vp = INT_TO_JSVAL(priv->getObject()->IsArchive());
-				break;
-			case is_directory_prop:
-				*vp = INT_TO_JSVAL(priv->getObject()->IsDirectory());
-				break;
-			case is_not_file_prop:
-				*vp = INT_TO_JSVAL(priv->getObject()->IsNotFile());
-				break;
-		}
-	}
-	return JS_TRUE;
-}
-
-JSBool ADM_JSDirectorySearch::JSSetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp)
-{
-	if (JSVAL_IS_INT(id)) 
-	{
-		ADM_JSDirectorySearch *priv = (ADM_JSDirectorySearch *) JS_GetPrivate(cx, obj);
-		switch(JSVAL_TO_INT(id))
-		{
-			case is_double_dot_prop:
-			case is_single_dot_prop:
-			case is_hidden_prop:
-			case is_archive_prop:
-			case is_directory_prop:
-			case is_not_file_prop:
-				return JS_FALSE;
-				break;
-		}
-	}
-	return JS_TRUE;
-}
-
-JSBool ADM_JSDirectorySearch::GetExtension(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin GetExtension
-	ADM_JSDirectorySearch *p = (ADM_JSDirectorySearch *)JS_GetPrivate(cx, obj);
-	// default return value
-	*rval = BOOLEAN_TO_JSVAL(false);
-	if(argc != 0)
-		return JS_FALSE;
-	*rval = STRING_TO_JSVAL(JS_NewStringCopyZ(cx,p->getObject()->GetExtension()));
-	return JS_TRUE;
-}// end GetExtension
-
-JSBool ADM_JSDirectorySearch::IsExtension(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin IsExtension
-	ADM_JSDirectorySearch *p = (ADM_JSDirectorySearch *)JS_GetPrivate(cx, obj);
-	// default return value
-	*rval = BOOLEAN_TO_JSVAL(false);
-	if(argc != 1)
-		return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-	*rval = BOOLEAN_TO_JSVAL(p->getObject()->IsExtension(JS_GetStringBytes(JSVAL_TO_STRING(argv[0]))));
-	return JS_TRUE;
-}// end IsExtension
-
-JSBool ADM_JSDirectorySearch::NextFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin NextFile
-	ADM_JSDirectorySearch *p = (ADM_JSDirectorySearch *)JS_GetPrivate(cx, obj);
-	// default return value
-	*rval = BOOLEAN_TO_JSVAL(false);
-	if(argc != 0)
-		return JS_FALSE;
-	*rval = BOOLEAN_TO_JSVAL(p->getObject()->NextFile());
-	return JS_TRUE;
-}// end NextFile
-
-JSBool ADM_JSDirectorySearch::Init(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin Init
-	ADM_JSDirectorySearch *p = (ADM_JSDirectorySearch *)JS_GetPrivate(cx, obj);
-	// default return value
-	*rval = BOOLEAN_TO_JSVAL(false);
-	if(argc != 1)
-		return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-	*rval = BOOLEAN_TO_JSVAL(p->getObject()->Init(JS_GetStringBytes(JSVAL_TO_STRING(argv[0]))));
-	return JS_TRUE;
-}// end Init
-
-
-JSBool ADM_JSDirectorySearch::GetFileSize(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin GetFileSize
-	ADM_JSDirectorySearch *p = (ADM_JSDirectorySearch *)JS_GetPrivate(cx, obj);
-	// default return value
-	*rval = INT_TO_JSVAL(0);
-	if(argc != 0)
-		return JS_FALSE;
-	*rval = INT_TO_JSVAL(p->getObject()->GetFileSize());
-	return JS_TRUE;
-}// end GetFileSize
-
-JSBool ADM_JSDirectorySearch::GetFileDirectory(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin GetFileDirectory
-	ADM_JSDirectorySearch *p = (ADM_JSDirectorySearch *)JS_GetPrivate(cx, obj);
-	// default return value
-	*rval = BOOLEAN_TO_JSVAL(false);
-	if(argc != 0)
-		return JS_FALSE;
-	*rval = STRING_TO_JSVAL(JS_NewStringCopyZ(cx,p->getObject()->GetFileDirectory().c_str()));
-	return JS_TRUE;
-}// end GetFileDirectory
-
-JSBool ADM_JSDirectorySearch::GetFilePath(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin GetFilePath
-	ADM_JSDirectorySearch *p = (ADM_JSDirectorySearch *)JS_GetPrivate(cx, obj);
-	// default return value
-	*rval = BOOLEAN_TO_JSVAL(false);
-	if(argc != 0)
-		return JS_FALSE;
-	*rval = STRING_TO_JSVAL(JS_NewStringCopyZ(cx,p->getObject()->GetFilePath().c_str()));
-	return JS_TRUE;
-}// end GetFilePath
-
-JSBool ADM_JSDirectorySearch::GetFileName(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin GetFileName
-	ADM_JSDirectorySearch *p = (ADM_JSDirectorySearch *)JS_GetPrivate(cx, obj);
-	// default return value
-	*rval = BOOLEAN_TO_JSVAL(false);
-	if(argc != 0)
-		return JS_FALSE;
-	*rval = STRING_TO_JSVAL(JS_NewStringCopyZ(cx,p->getObject()->GetFileName()));
-	return JS_TRUE;
-}// end GetFileName
-
-JSBool ADM_JSDirectorySearch::Close(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin Close
-	ADM_JSDirectorySearch *p = (ADM_JSDirectorySearch *)JS_GetPrivate(cx, obj);
-	// default return value
-	*rval = BOOLEAN_TO_JSVAL(false);
-	if(argc != 0)
-		return JS_FALSE;
-	*rval = BOOLEAN_TO_JSVAL(p->getObject()->Close());
-	return JS_TRUE;
-}// end Close

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDirectorySearch.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDirectorySearch.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDirectorySearch.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,57 +0,0 @@
-#ifndef _ADM_JSDIRECTORYSEARCH_H
-#define _ADM_JSDIRECTORYSEARCH_H
-
-#pragma once
-
-
-
-// Spidermonkey
-#include "ADM_smjs/jsapi.h"
-#include <string.h>
-#include "DirectorySearch.h"
-
-class ADM_JSDirectorySearch
-{
-public:
-	ADM_JSDirectorySearch(void) : m_pObject(NULL) {}
-	virtual ~ADM_JSDirectorySearch(void);
-
-	static JSBool JSGetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp);
-	static JSBool JSSetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp);
-	static JSBool JSConstructor(JSContext *cx, JSObject *obj, uintN argc, 
-								jsval *argv, jsval *rval);
-	static void JSDestructor(JSContext *cx, JSObject *obj);
-	static JSObject *JSInit(JSContext *cx, JSObject *obj, JSObject *proto = NULL);
-	static JSBool GetExtension(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool IsExtension(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool NextFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Init(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool GetFileSize(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool GetFileDirectory(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool GetFilePath(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool GetFileName(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Close(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-
-	static JSPropertySpec directorysearch_properties[];
-	static JSFunctionSpec directorysearch_methods[];
-	enum
-	{
-		is_double_dot_prop,
-		is_single_dot_prop,
-		is_hidden_prop,
-		is_archive_prop,
-		is_directory_prop,
-		is_not_file_prop
-	};
-	static JSClass m_classDirectorySearch;
-
-	void setObject(CDirectorySearch *pObject);
-	CDirectorySearch *getObject();
-
-private:
-	CDirectorySearch *m_pObject;
-
-};
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDirectorySearch.h.orig
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDirectorySearch.h.orig	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSDirectorySearch.h.orig	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,56 +0,0 @@
-#ifndef _ADM_JSDIRECTORYSEARCH_H
-#define _ADM_JSDIRECTORYSEARCH_H
-
-#pragma once
-
-#include "config.h"
-
-// Spidermonkey
-#include "ADM_libraries/ADM_smjs/jsapi.h"
-#include <string.h>
-#include "DirectorySearch.h"
-
-class ADM_JSDirectorySearch
-{
-public:
-	ADM_JSDirectorySearch(void) : m_pObject(NULL) {}
-	virtual ~ADM_JSDirectorySearch(void);
-
-	static JSBool JSGetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp);
-	static JSBool JSSetProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp);
-	static JSBool JSConstructor(JSContext *cx, JSObject *obj, uintN argc, 
-								jsval *argv, jsval *rval);
-	static void JSDestructor(JSContext *cx, JSObject *obj);
-	static JSObject *JSInit(JSContext *cx, JSObject *obj, JSObject *proto = NULL);
-	static JSBool GetExtension(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool IsExtension(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool NextFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Init(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool GetFileSize(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool GetFileDirectory(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool GetFileName(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-	static JSBool Close(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-
-	static JSPropertySpec directorysearch_properties[];
-	static JSFunctionSpec directorysearch_methods[];
-	enum
-	{
-		is_double_dot_prop,
-		is_single_dot_prop,
-		is_hidden_prop,
-		is_archive_prop,
-		is_directory_prop,
-		is_not_file_prop
-	};
-	static JSClass m_classDirectorySearch;
-
-	void setObject(CDirectorySearch *pObject);
-	CDirectorySearch *getObject();
-
-private:
-	CDirectorySearch *m_pObject;
-
-};
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,459 +0,0 @@
-// C++ Interface: Spider Monkey interface
-//
-// Description: 
-//
-//
-// Author: Anish Mistry
-//      Some modification by mean
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-#include <string>
-#include "ADM_default.h"
-#include <sys/types.h>
-#include <sys/stat.h>
-#if defined( ADM_WIN32 ) || defined(__MINGW32__)
-#define ADM_JS_WIN32
-#endif
-
-#ifndef ADM_JS_WIN32
-#include <sys/wait.h>
-#include <sys/param.h>
-#endif
-#include <errno.h>
-#include <dirent.h>
-#include <limits.h>
-#include <math.h>
-#include <vector>
-#include "ADM_JSAvidemux.h"
-#include "ADM_JSGlobal.h"
-#include "ADM_default.h"
-#include "DIA_coreToolkit.h"
-#include "ADM_editor/ADM_outputfmt.h"
-#include "adm_scanner.h" 
-#include "avi_vars.h"
-#include "gui_action.hxx"
-//#include "ADM_videoFilter.h"
-#include "ADM_editor/ADM_outputfmt.h"
-
-#include "ADM_script/ADM_container.h"
-
-#include "ADM_JSGlobal.h"
-#include "DIA_fileSel.h"
-
-#include "DIA_factory.h"
-
-std::vector <std::string> g_vIncludes;
-extern char **environ;
-extern char *script_getVar(char *in, int *r);
-
-
-JSBool fileWriteSelect(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool dirSelect(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool fileReadSelect(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-JSBool allFilesFrom(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool nextFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool setSuccess(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval);
-JSBool getVar(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval);
-JSBool systemExecute(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool systemInclude(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool pathOnly(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-JSBool facInt(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facFloat(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facToggle(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facMenu(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facBar(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facRoText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facTab(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facFrame(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facHex(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facDirSel(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facButton(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facMatrix(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facNotch(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facThreadCount(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facSlider(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-
-static JSFunctionSpec adm_functions[] = {
-  /*    name          native          nargs    */
-  {"fileReadSelect",    fileReadSelect,        0},
-  {"fileWriteSelect",   fileWriteSelect,        0},
-  {"dirSelect",         dirSelect,        0},
-  {"allFilesFrom",      allFilesFrom,        0},
-  {"nextFile",          nextFile,        0},
-  {"setSuccess",          setSuccess,        1},
-  {"getVar",          getVar,        1},
-  {"exec",          systemExecute,        3},
-  {"include",          systemInclude,        1},
-  {"pathOnly",          pathOnly,        1},
-  {"dialogFactoryInt",          facInt,           0},
-  {"dialogFactoryFloat",        facFloat,         0},
-  {"dialogFactoryToggle",       facToggle,        0},
-  {"dialogFactoryMenu",         facMenu,          0},
-  {"dialogFactoryFileSel",      facFile,          0},
-  {"dialogFactoryBitrate",      facBitrate,       0},
-  {"dialogFactoryBar",        facBar,             0},
-  {"dialogFactoryRoText",     facRoText,          0},
-  {"dialogFactoryText",       facText,            0},
-  {"dialogFactoryTabs",       facTab,             0},
-  {"dialogFactoryDirSel",       facDirSel,        0},
-  {"dialogFactoryFrame",       facFrame,          0},
-  {"dialogFactoryHex",       facHex,              0},
-  {"dialogFactoryButton",       facButton,        0},
-  {"dialogFactorySlider",       facSlider,        0},
-  {"dialogFactoryMatrix",       facMatrix,        0},
-  {"dialogFactoryNotch",       facNotch,		  0},
-  {"dialogFactoryThreadCount", facThreadCount,		  0},
-  {0}
-};
-JSFunctionSpec *ADM_JsFunctionGetFunctions(void)
-{
-    return adm_functions;
-}
-
-uint8_t JS_AvidemuxFunction(JSContext *cx,JSObject *global)
-{
-	if(JS_DefineFunctions(cx, global, adm_functions) == true)
-		return 1;
-
-	printf("JSAvidemuxFunction: Unable to define functions\n");
-	return 0;
-}
-
-JSBool getVar(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin getVar
-        int out=0;
-        char *dupe=NULL;
-
-        // default return value
-        if(argc != 1)
-                return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-	char  *stringa = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-	dupe=script_getVar(stringa ,&out);
-
-	if(!dupe)
-		return JS_FALSE;
-	// if out=1 it is a string else a number
-	if(out)
-		*rval = STRING_TO_JSVAL(JS_NewStringCopyZ(cx,dupe));
-	else
-		*rval = INT_TO_JSVAL(atoi(dupe));
-	return JS_TRUE;
-}// end getVar
-
-JSBool setSuccess(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin setSuccess
-	bool Jscript_succeed = false;
-	// default return value
-	if(argc != 1)
-		return JS_FALSE;
-	if(JSVAL_IS_BOOLEAN(argv[0]) == false)
-		return JS_FALSE;
-	Jscript_succeed = JSVAL_TO_BOOLEAN(argv[0]);
-	JS_setSuccess(Jscript_succeed);
-
-	return JS_TRUE;
-}// end setSuccess
-
-JSBool fileReadSelect(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin fileReadSelect
-        char *name;
-        // default return value
-        if(argc != 0)
-                return JS_FALSE;
-        if(!name) return JS_FALSE;
-        GUI_FileSelRead("Open file (Read mode)", &name);
-        *rval=STRING_TO_JSVAL(JS_NewStringCopyZ(cx,name));
-        ADM_dealloc(name);
-        return JS_TRUE;
-}// end fileReadSelect
-
-JSBool fileWriteSelect(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin fileWriteSelect
-        char *name;
-        // default return value
-        if(argc != 0)
-                return JS_FALSE;
-        GUI_FileSelWrite("Open file (Write mode)", &name);
-        if(!name) return JS_FALSE;
-        *rval=STRING_TO_JSVAL(JS_NewStringCopyZ(cx,name));
-        ADM_dealloc(name);
-        return JS_TRUE;
-}// end fileWriteSelect
-JSBool dirSelect(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{
-        char name[1024];
-        // default return value
-        if(argc != 0)
-                return JS_FALSE;
-        if(!FileSel_SelectDir(QT_TR_NOOP("Select a directory"),name,1023, NULL))
-         return JS_FALSE;
-        *rval=STRING_TO_JSVAL(JS_NewStringCopyZ(cx,name));
-        return JS_TRUE;
-}
-/*****************************************************
-        To process a whole directiry at a time
-*******************************************************/
-#define ADM_MAX_DIR 1024
-static char *dirs[ADM_MAX_DIR];
-static int dirmax=0;
-static int curdir=0;
-static void cleanup( void );
-void cleanup( void )
-{
-        for(int i=0;i<dirmax;i++)
-                ADM_dealloc(dirs[i]);
-        dirmax=0;
-        curdir=0;
-}
-JSBool allFilesFrom(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-char *str;
-DIR *dir;
-struct dirent *direntry;
-       // ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        cleanup();
-        // default return value
-        if(argc != 1)
-                return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-
-        str=JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        dir=opendir(str);
-        if(!dir)
-        {
-                *rval=INT_TO_JSVAL(0); // No files
-                return JS_TRUE;
-        }
-        while((direntry=readdir(dir)) && dirmax<ADM_MAX_DIR-1)
-        {
-                dirs[dirmax]=(char *)ADM_alloc(strlen(str)+strlen(direntry->d_name)+2);
-                strcpy(dirs[dirmax],str);
-                strcat(dirs[dirmax],direntry->d_name);
-                //printf("File:<%s>\n",dirs[dirmax]);
-                dirmax++;
-        }
-        closedir(dir);
-        *rval=INT_TO_JSVAL(dirmax);
-        return JS_TRUE;
-}
-
-JSBool nextFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-char *n;
-        if(argc != 0)
-                return JS_FALSE;
-
-        if(curdir==dirmax)
-        {
-                n="";
-        }
-        else
-        {
-                n=dirs[curdir++];
-        }
-        *rval=STRING_TO_JSVAL(JS_NewStringCopyZ(cx,n));
-        return JS_TRUE;
-}
-
-JSBool systemExecute(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin systemExecute
-	// default return value
-	*rval = INT_TO_JSVAL(-1);
-
-	if(argc != 3)
-		return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false || JSVAL_IS_OBJECT(argv[1]) == false || JSVAL_IS_BOOLEAN(argv[2]) == false)
-		return JS_FALSE;
-
-	char *pExecutable = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-	JSObject *pArgs = JSVAL_TO_OBJECT(argv[1]);
-	bool bWait = JSVAL_TO_BOOLEAN(argv[2]);
-	int status = 0;
-	jsuint nArgsLength = 0;
-	jsval jsValue;
-	struct stat sbFileInfo;
-
-	if(JS_IsArrayObject(cx, pArgs) == false)
-		return JS_FALSE;
-
-	JS_GetArrayLength(cx,pArgs,&nArgsLength);
-	char **args = new char *[nArgsLength + 2];
-	args[0] = pExecutable;
-	args[nArgsLength + 1] = NULL;
-
-	for(int i = 0; i < nArgsLength; i++)
-	{
-		if(JS_GetElement(cx, pArgs, i, &jsValue) == JS_FALSE)
-		{// begin failure to get item
-			JS_ReportError(cx, "exec() JS_GetElement failed to get an array item.");
-			return JS_FALSE;
-		}// end failure to get item
-		args[i + 1] = JS_GetStringBytes(JSVAL_TO_STRING(jsValue));
-	}
-
-#ifndef ADM_JS_WIN32
-	if(getuid() == 0)
-	{// begin running as root
-		JS_ReportError(cx, "exec() disallowed while running as root.");
-		return JS_FALSE;
-	}// end running as root
-	if(stat(pExecutable , &sbFileInfo) != 0)
-	{// begin can't stat file
-		JS_ReportError(cx, "exec() Can't stat \"%s\" errno(%i).", pExecutable, errno);
-		return JS_FALSE;
-	}// end can't stat file
-	if((sbFileInfo.st_mode & S_ISUID) == S_ISUID || (sbFileInfo.st_mode & S_ISGID) == S_ISGID)
-	{// begin setuid/setgid files disallowed
-		JS_ReportError(cx, "exec() disallowed execution of \"%s\" since it is a setuid/setgid file.", pExecutable);
-		return JS_FALSE;
-	}// end setuid/setgid files disallowed
-#endif
-
-        enterLock();
-	// clear file descriptor table of forked process and fork
-#if defined( __linux__) || defined(__macosx__) || defined(__APPLE__) || defined(__CYGWIN__)
-	pid_t pidRtn = fork();
-#elif defined(__FreeBSD__) || defined(__OpenBSD__)
-	pid_t pidRtn = rfork(RFPROC|RFCFDG);
-#endif
-
-#ifdef ADM_JS_WIN32
-	intptr_t pidRtn = spawnvpe(bWait ? P_WAIT : P_NOWAIT, pExecutable, args, environ);
-	#define WEXITSTATUS
-#else
-	if(pidRtn == 0)
-	{// begin child process
-#if defined( __linux__) || defined(__macosx__) || defined(__APPLE__) || defined(__CYGWIN__)
-		close(STDIN_FILENO);
-		close(STDOUT_FILENO);
-		close(STDERR_FILENO);
-#endif
-		char **pEnv = environ;
-		//char *pEnv[] = {NULL};
-		execve(pExecutable,args,pEnv);
-		printf("Error: execve failure errno(%d)\n",errno);
-		_exit(errno);
-	}// end child process
-	else if(bWait && pidRtn != -1)
-	{// begin wait for execution to finish
-		printf("Waiting on pid %d...",pidRtn);
-		do
-		{// begin wait for child
-			waitpid(pidRtn,&status,WUNTRACED);
-		}// end wait for child
-		while(WIFEXITED(status) == false && WIFSIGNALED(status) == false);
-		printf("Done...\n");
-	}// end wait for execution to finish
-	else if(pidRtn == -1)
-	{// begin rfork failure
-		printf("Error: execve failure errno(%d)\n",errno);
-	}// end rfork failure
-#endif
-
-        leaveLock();
-
-	// cleanup
-	delete []args;
-	if(pidRtn != -1)
-		*rval = INT_TO_JSVAL(WEXITSTATUS(status));	// success return child's exit status
-	else
-		*rval = INT_TO_JSVAL(-1);	// failure
-	return JS_TRUE;
-}// end systemExecute
-JSBool systemInclude(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin systemInclude
-	// default return value
-	*rval = BOOLEAN_TO_JSVAL(false);
-	if(argc != 1)
-		return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-
-	struct stat sbFileInfo;
-	const char *pIncludeFile = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-	// make sure we haven't included this already to avoid a recursive
-	// dependency loop
-	char *pTempStr = new char[PATH_MAX+1];
- #ifdef __MINGW32__
- 	if(_fullpath(pTempStr,pIncludeFile,PATH_MAX) == NULL)
- #else
-	if(realpath(pIncludeFile,pTempStr) == NULL)
-#endif
-	{// begin can't resolve path
-		JS_ReportError(cx, "include() can't resolve the path of \"%s\".", pIncludeFile);
-		return JS_FALSE;
-	}// end can't resolve path
-
-	std::string sRealPath = pTempStr;
-	if(stat(sRealPath.c_str() , &sbFileInfo) != 0)
-	{// begin can't stat file
-		JS_ReportError(cx, "include() Can't stat \"%s\" errno(%i).", sRealPath.c_str(), errno);
-		return JS_FALSE;
-	}// end can't stat file
-
-	for(int i = 0;i < g_vIncludes.size();i++)
-	{// begin check previous includes
-		if(g_vIncludes[i] == sRealPath)
-		{// begin found
-			printf("include() Warning: Duplicated include of \"%s\"...ignoring.\n",sRealPath.c_str());
-			return JS_TRUE;
-		}// end found
-	}// end check previous includes
-	g_vIncludes.push_back(sRealPath);
-
-	JSScript *pJSScript = JS_CompileFile(cx, obj, sRealPath.c_str());
-	jsval lastRval;
-	if(pJSScript != NULL)
-	{// begin execute external file
-		JSBool ok = JS_ExecuteScript(cx, obj, pJSScript, &lastRval);
-		JS_DestroyScript(cx,pJSScript);
-		*rval = BOOLEAN_TO_JSVAL(ok);
-	}// end execute external file
-	else
-	{// begin error including
-		JS_ReportError(cx, "include() Cannot compile file \"%s\"", pIncludeFile);
-		return JS_FALSE;
-	}// end error including
-	return JS_TRUE;
-}// end systemInclude
-
-/********************** Extract Path from a filename **************/
-JSBool pathOnly(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin systemExecute
-	// default return value
-  *rval = INT_TO_JSVAL(-1);
-
-  if(argc != 1)
-    return JS_FALSE;
-  if(JSVAL_IS_STRING(argv[0]) == false )
-    return JS_FALSE;
-  char *name=NULL;
-  char *orgName = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-  ADM_PathStripName(orgName);
-  /* Remove last / or last \ */
-  int l=strlen(orgName);
-  if(l) orgName[l-1]=0;
-  *rval=STRING_TO_JSVAL(JS_NewStringCopyZ(cx,orgName));
-  return JS_TRUE;
-}// end systemExecute
-
-
-//EOF 

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp.orig
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp.orig	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctions.cpp.orig	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,882 +0,0 @@
-// C++ Interface: Spider Monkey interface
-//
-// Description: 
-//
-//
-// Author: Anish Mistry
-//      Some modification by mean
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-#include "config.h"
-#include <stdlib.h>
-#include <unistd.h>
-#include <sys/types.h>
-#include <sys/stat.h>
-#ifndef ADM_WIN32
-#include <sys/wait.h>
-#include <sys/param.h>
-#endif
-#include <errno.h>
-#include <dirent.h>
-#include <limits.h>
-#include <math.h>
-#include <vector>
-#include <string>
-#include "ADM_JSAvidemux.h"
-#include "ADM_JSGlobal.h"
-#include "ADM_default.h"
-#include "DIA_coreToolkit.h"
-#include "ADM_editor/ADM_outputfmt.h"
-#include "audioeng_buildfilters.h"
-#include "adm_scanner.h" 
-#include "avi_vars.h"
-#include "gui_action.hxx"
-#include "ADM_encoder/ADM_vidEncode.hxx"
-#include "ADM_videoFilter.h"
-#include "ADM_encoder/adm_encoder.h"
-#include "ADM_encoder/adm_encConfig.h"
-#include "ADM_editor/ADM_outputfmt.h"
-
-#include "ADM_script/ADM_container.h"
-
-#include "ADM_JSGlobal.h"
-#include "DIA_fileSel.h"
-
-#include "DIA_factory.h"
-
-std::vector <std::string> g_vIncludes;
-extern char **environ;
-extern char *script_getVar(char *in, int *r);
-
-JSBool displayError(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool displayInfo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool fileWriteSelect(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool dirSelect(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool fileReadSelect(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool print(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-JSBool allFilesFrom(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool nextFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool setSuccess(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval);
-JSBool getVar(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval);
-JSBool systemExecute(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool systemInclude(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool pathOnly(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-JSBool facInt(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facFloat(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facToggle(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facMenu(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facBar(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facRoText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facTab(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facFrame(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facHex(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facDirSel(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facButton(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facMatrix(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facNotch(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facThreadCount(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facSlider(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool crashTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool assertTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-
-static JSFunctionSpec adm_functions[] = {
-  /*    name          native          nargs    */
-  {"displayError",      displayError,         1},
-  {"displayInfo",       displayInfo,        1},
-  {"fileReadSelect",    fileReadSelect,        0},
-  {"fileWriteSelect",   fileWriteSelect,        0},
-  {"dirSelect",         dirSelect,        0},
-  {"print",             print,        1},
-  {"allFilesFrom",      allFilesFrom,        0},
-  {"nextFile",          nextFile,        0},
-  {"setSuccess",          setSuccess,        1},
-  {"getVar",          getVar,        1},
-  {"exec",          systemExecute,        3},
-  {"include",          systemInclude,        1},
-  {"pathOnly",          pathOnly,        1},
-  {"dialogFactoryInt",          facInt,           0},
-  {"dialogFactoryFloat",        facFloat,         0},
-  {"dialogFactoryToggle",       facToggle,        0},
-  {"dialogFactoryMenu",         facMenu,          0},
-  {"dialogFactoryFileSel",      facFile,          0},
-  {"dialogFactoryBitrate",      facBitrate,       0},
-  {"dialogFactoryBar",        facBar,             0},
-  {"dialogFactoryRoText",     facRoText,          0},
-  {"dialogFactoryText",       facText,            0},
-  {"dialogFactoryTabs",       facTab,             0},
-  {"dialogFactoryDirSel",       facDirSel,        0},
-  {"dialogFactoryFrame",       facFrame,          0},
-  {"dialogFactoryHex",       facHex,              0},
-  {"dialogFactoryButton",       facButton,        0},
-  {"dialogFactorySlider",       facSlider,        0},
-  {"dialogFactoryMatrix",       facMatrix,        0},
-  {"dialogFactoryNotch",       facNotch,		  0},
-  {"dialogFactoryThreadCount", facThreadCount,		  0},
-  {"crashTest",               crashTest,          0},
-  {"assertTest",               assertTest,        0},
-  {0}
-};
-
-uint8_t JS_AvidemuxFunction(JSContext *cx,JSObject *global)
-{
-	if(JS_DefineFunctions(cx, global, adm_functions) == true)
-		return 1;
-
-	printf("JSAvidemuxFunction: Unable to define functions\n");
-	return 0;
-}
-
-JSBool getVar(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin getVar
-        int out=0;
-        char *dupe=NULL;
-
-        // default return value
-        if(argc != 1)
-                return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-	char  *stringa = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-	dupe=script_getVar(stringa ,&out);
-
-	if(!dupe)
-		return JS_FALSE;
-	// if out=1 it is a string else a number
-	if(out)
-		*rval = STRING_TO_JSVAL(JS_NewStringCopyZ(cx,dupe));
-	else
-		*rval = INT_TO_JSVAL(atoi(dupe));
-	return JS_TRUE;
-}// end getVar
-
-JSBool setSuccess(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin setSuccess
-	bool Jscript_succeed = false;
-	// default return value
-	if(argc != 1)
-		return JS_FALSE;
-	if(JSVAL_IS_BOOLEAN(argv[0]) == false)
-		return JS_FALSE;
-	Jscript_succeed = JSVAL_TO_BOOLEAN(argv[0]);
-	JS_setSuccess(Jscript_succeed);
-
-	return JS_TRUE;
-}// end setSuccess
-
-JSBool displayError(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin displayError
-	// default return value
-	if(argc != 1)
-		return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-	char  *stringa = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-	GUI_Verbose();
-	GUI_Error_HIG("Error",stringa);
-	GUI_Quiet();
-
-	return JS_TRUE;
-}// end displayError
-JSBool displayInfo(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin displayInfo
-	// default return value
-	if(argc != 1)
-		return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-	char  *stringa = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-	GUI_Verbose();
-	GUI_Info_HIG(ADM_LOG_IMPORTANT,"Info",stringa);
-	GUI_Quiet();
-	return JS_TRUE;
-}// end displayInfo
-
-JSBool fileReadSelect(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin fileReadSelect
-        char *name;
-        // default return value
-        if(argc != 0)
-                return JS_FALSE;
-        if(!name) return JS_FALSE;
-        GUI_FileSelRead("Open file (Read mode)", &name);
-        *rval=STRING_TO_JSVAL(JS_NewStringCopyZ(cx,name));
-        ADM_dealloc(name);
-        return JS_TRUE;
-}// end fileReadSelect
-
-JSBool fileWriteSelect(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin fileWriteSelect
-        char *name;
-        // default return value
-        if(argc != 0)
-                return JS_FALSE;
-        GUI_FileSelWrite("Open file (Write mode)", &name);
-        if(!name) return JS_FALSE;
-        *rval=STRING_TO_JSVAL(JS_NewStringCopyZ(cx,name));
-        ADM_dealloc(name);
-        return JS_TRUE;
-}// end fileWriteSelect
-JSBool dirSelect(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{
-        char name[1024];
-        // default return value
-        if(argc != 0)
-                return JS_FALSE;
-        if(!FileSel_SelectDir(QT_TR_NOOP("Select a directory"),name,1023, NULL))
-         return JS_FALSE;
-        *rval=STRING_TO_JSVAL(JS_NewStringCopyZ(cx,name));
-        return JS_TRUE;
-}
-JSBool print(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin print
-        if(argc != 1)
-                return JS_FALSE;
-	fprintf(stderr,"JSConsole: %s\n", JS_GetStringBytes(JS_ValueToString(cx, argv[0])));
-        return JS_TRUE;
-}// end print
-/*****************************************************
-        To process a whole directiry at a time
-*******************************************************/
-#define ADM_MAX_DIR 1024
-static char *dirs[ADM_MAX_DIR];
-static int dirmax=0;
-static int curdir=0;
-static void cleanup( void );
-void cleanup( void )
-{
-        for(int i=0;i<dirmax;i++)
-                ADM_dealloc(dirs[i]);
-        dirmax=0;
-        curdir=0;
-}
-JSBool allFilesFrom(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-char *str;
-DIR *dir;
-struct dirent *direntry;
-       // ADM_JSAvidemux *p = (ADM_JSAvidemux *)JS_GetPrivate(cx, obj);
-        cleanup();
-        // default return value
-        if(argc != 1)
-                return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-
-        str=JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        dir=opendir(str);
-        if(!dir)
-        {
-                *rval=INT_TO_JSVAL(0); // No files
-                return JS_TRUE;
-        }
-        while((direntry=readdir(dir)) && dirmax<ADM_MAX_DIR-1)
-        {
-                dirs[dirmax]=(char *)ADM_alloc(strlen(str)+strlen(direntry->d_name)+2);
-                strcpy(dirs[dirmax],str);
-                strcat(dirs[dirmax],direntry->d_name);
-                //printf("File:<%s>\n",dirs[dirmax]);
-                dirmax++;
-        }
-        closedir(dir);
-        *rval=INT_TO_JSVAL(dirmax);
-        return JS_TRUE;
-}
-
-JSBool nextFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-char *n;
-        if(argc != 0)
-                return JS_FALSE;
-
-        if(curdir==dirmax)
-        {
-                n="";
-        }
-        else
-        {
-                n=dirs[curdir++];
-        }
-        *rval=STRING_TO_JSVAL(JS_NewStringCopyZ(cx,n));
-        return JS_TRUE;
-}
-
-JSBool systemExecute(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin systemExecute
-	// default return value
-	*rval = INT_TO_JSVAL(-1);
-
-	if(argc != 3)
-		return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false || JSVAL_IS_OBJECT(argv[1]) == false || JSVAL_IS_BOOLEAN(argv[2]) == false)
-		return JS_FALSE;
-
-	char *pExecutable = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-	JSObject *pArgs = JSVAL_TO_OBJECT(argv[1]);
-	bool bWait = JSVAL_TO_BOOLEAN(argv[2]);
-	int status = 0;
-	jsuint nArgsLength = 0;
-	jsval jsValue;
-	struct stat sbFileInfo;
-
-	if(JS_IsArrayObject(cx, pArgs) == false)
-		return JS_FALSE;
-
-	JS_GetArrayLength(cx,pArgs,&nArgsLength);
-	char **args = new char *[JSVAL_TO_INT(nArgsLength)+2];
-	args[0] = pExecutable;
-	args[JSVAL_TO_INT(nArgsLength)+1] = NULL;
-
-	for(jsuint i = 1;i <= nArgsLength;i++)
-	{
-		if(JS_GetElement(cx, pArgs, i, &jsValue) == JS_FALSE)
-		{// begin failure to get item
-			JS_ReportError(cx, "exec() JS_GetElement failed to get an array item.");
-			return JS_FALSE;
-		}// end failure to get item
-		args[JSVAL_TO_INT(i)] = JS_GetStringBytes(JSVAL_TO_STRING(jsValue));
-	}
-
-#ifndef ADM_WIN32
-	if(getuid() == 0)
-	{// begin running as root
-		JS_ReportError(cx, "exec() disallowed while running as root.");
-		return JS_FALSE;
-	}// end running as root
-	if(stat(pExecutable , &sbFileInfo) != 0)
-	{// begin can't stat file
-		JS_ReportError(cx, "exec() Can't stat \"%s\" errno(%i).", pExecutable, errno);
-		return JS_FALSE;
-	}// end can't stat file
-	if((sbFileInfo.st_mode & S_ISUID) == S_ISUID || (sbFileInfo.st_mode & S_ISGID) == S_ISGID)
-	{// begin setuid/setgid files disallowed
-		JS_ReportError(cx, "exec() disallowed execution of \"%s\" since it is a setuid/setgid file.", pExecutable);
-		return JS_FALSE;
-	}// end setuid/setgid files disallowed
-#endif
-
-        enterLock();
-	// clear file descriptor table of forked process and fork
-#if defined( __linux__) || defined(__macosx__) || defined(__APPLE__) || defined(__CYGWIN__)
-	pid_t pidRtn = fork();
-#elif defined(__FreeBSD__) || defined(__OpenBSD__)
-	pid_t pidRtn = rfork(RFPROC|RFCFDG);
-#endif
-
-#ifdef ADM_WIN32
-	intptr_t pidRtn = spawnvpe(bWait ? P_WAIT : P_NOWAIT, pExecutable, args, environ);
-	#define WEXITSTATUS
-#else
-	if(pidRtn == 0)
-	{// begin child process
-#if defined( __linux__) || defined(__macosx__) || defined(__APPLE__) || defined(__CYGWIN__)
-		close(STDIN_FILENO);
-		close(STDOUT_FILENO);
-		close(STDERR_FILENO);
-#endif
-		char **pEnv = environ;
-		//char *pEnv[] = {NULL};
-		execve(pExecutable,args,pEnv);
-		printf("Error: execve failure errno(%d)\n",errno);
-		_exit(errno);
-	}// end child process
-	else if(bWait && pidRtn != -1)
-	{// begin wait for execution to finish
-		printf("Waiting on pid %d...",pidRtn);
-		do
-		{// begin wait for child
-			waitpid(pidRtn,&status,WUNTRACED);
-		}// end wait for child
-		while(WIFEXITED(status) == false && WIFSIGNALED(status) == false);
-		printf("Done...\n");
-	}// end wait for execution to finish
-	else if(pidRtn == -1)
-	{// begin rfork failure
-		printf("Error: execve failure errno(%d)\n",errno);
-	}// end rfork failure
-#endif
-
-        leaveLock();
-
-	// cleanup
-	delete []args;
-	if(pidRtn != -1)
-		*rval = INT_TO_JSVAL(WEXITSTATUS(status));	// success return child's exit status
-	else
-		*rval = INT_TO_JSVAL(-1);	// failure
-	return JS_TRUE;
-}// end systemExecute
-#ifdef ADM_WIN32
-
-JSBool systemInclude(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-		return JS_FALSE;
-}
-#else
-
-JSBool systemInclude(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin systemInclude
-	// default return value
-	*rval = BOOLEAN_TO_JSVAL(false);
-	if(argc != 1)
-		return JS_FALSE;
-	if(JSVAL_IS_STRING(argv[0]) == false)
-		return JS_FALSE;
-
-	struct stat sbFileInfo;
-	const char *pIncludeFile = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-	// make sure we haven't included this already to avoid a recursive
-	// dependency loop
-	char *pTempStr = new char[PATH_MAX+1];
-	if(realpath(pIncludeFile,pTempStr) == NULL)
-	{// begin can't resolve path
-		JS_ReportError(cx, "include() can't resolve the path of \"%s\".", pIncludeFile);
-		return JS_FALSE;
-	}// end can't resolve path
-
-	std::string sRealPath = pTempStr;
-	if(stat(sRealPath.c_str() , &sbFileInfo) != 0)
-	{// begin can't stat file
-		JS_ReportError(cx, "include() Can't stat \"%s\" errno(%i).", sRealPath.c_str(), errno);
-		return JS_FALSE;
-	}// end can't stat file
-
-	for(int i = 0;i < g_vIncludes.size();i++)
-	{// begin check previous includes
-		if(g_vIncludes[i] == sRealPath)
-		{// begin found
-			printf("include() Warning: Duplicated include of \"%s\"...ignoring.\n",sRealPath.c_str());
-			return JS_TRUE;
-		}// end found
-	}// end check previous includes
-	g_vIncludes.push_back(sRealPath);
-
-	JSScript *pJSScript = JS_CompileFile(cx, obj, sRealPath.c_str());
-	jsval lastRval;
-	if(pJSScript != NULL)
-	{// begin execute external file
-		JSBool ok = JS_ExecuteScript(cx, obj, pJSScript, &lastRval);
-		JS_DestroyScript(cx,pJSScript);
-		*rval = BOOLEAN_TO_JSVAL(ok);
-	}// end execute external file
-	else
-	{// begin error including
-		JS_ReportError(cx, "include() Cannot compile file \"%s\"", pIncludeFile);
-		return JS_FALSE;
-	}// end error including
-	return JS_TRUE;
-}// end systemInclude
-#endif
-
-/********************** Extract Path from a filename **************/
-JSBool pathOnly(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{// begin systemExecute
-	// default return value
-  *rval = INT_TO_JSVAL(-1);
-
-  if(argc != 1)
-    return JS_FALSE;
-  if(JSVAL_IS_STRING(argv[0]) == false )
-    return JS_FALSE;
-  char *name=NULL;
-  char *orgName = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-  ADM_PathStripName(orgName);
-  /* Remove last / or last \ */
-  int l=strlen(orgName);
-  if(l) orgName[l-1]=0;
-  *rval=STRING_TO_JSVAL(JS_NewStringCopyZ(cx,orgName));
-  return JS_TRUE;
-}// end systemExecute
-
-JSBool facInt(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  uint32_t tog=0;
-   diaElemUInteger blend(&tog,QT_TR_NOOP("Uinteger"),0,255);
-    diaElem *elems[]={&blend   };
-    
-  if(diaFactoryRun(QT_TR_NOOP("Test uinteger"),1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    printf("Value : %u\n",tog);
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-JSBool facFloat(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  ELEM_TYPE_FLOAT tog=0;
-   diaElemFloat blend(&tog,QT_TR_NOOP("Float"),0,255);
-    diaElem *elems[]={&blend   };
-    
-  if(diaFactoryRun("Test float",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    printf("Value : %f\n",(float)tog);
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  
-  return JS_TRUE;
-}
-
-JSBool facToggle(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  uint32_t tog=0;
-  uint32_t test=0;
-   diaElemToggle blend(&tog,QT_TR_NOOP("Toggle"));
-    diaElemUInteger     bt(&test,"Entry",0,10);
-    diaElemUInteger     bt2(&test,"Entry",0,10);
-    diaElem *elems[]={&blend,&bt,&bt2   };
-    blend.link(1,&bt);
-    blend.link(0,&bt2);
-    
-  if(diaFactoryRun("Test Toggle",3,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    printf("Value : %u\n",tog);
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  return JS_TRUE;
-}
-
-JSBool facMenu(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-   uint32_t tog=4;
-   ELEM_TYPE_FLOAT f=1; 
-   
-    diaMenuEntry menu[]={
-                             {2,   QT_TR_NOOP("No Strategy"),NULL},
-                             {4,     QT_TR_NOOP("3:2 Pulldown"),NULL},
-                             {6,     QT_TR_NOOP("Pal/Secam"),NULL},
-                             {7,  QT_TR_NOOP("NTSC converted from PAL"),NULL}
-                          };
-   diaElemMenu blend(&tog,QT_TR_NOOP("menu"),4,menu);
-    
-    // Link it to another
-    diaElemFloat toggle(&f,"Linked float",1,2);
-    blend.link(&(menu[1]),1,&toggle);
-    //
-diaElem *elems[]={&blend,&toggle   };
-  if(diaFactoryRun("Test Menu",2,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    printf("Value : %u\n",tog);
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  return JS_TRUE;
-}
-JSBool facFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-   uint32_t tog=0;
-   char *test=ADM_strdup("Entry test1");
-    
-      diaElemFile fread(0,&test,"Entry");
-      diaElem *elems[]={&fread   };
-  if(diaFactoryRun("Test FileRead",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    printf("Value : <%s>\n",test);
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  if(test) ADM_dealloc(test);
-  return JS_TRUE;
-}
-JSBool facDirSel(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-   uint32_t tog=0;
-   char *test=ADM_strdup("Entry test1");
-    
-      diaElemDirSelect fread(&test,"Entry");
-      diaElem *elems[]={&fread   };
-  if(diaFactoryRun("Test DirSel",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    printf("Value : <%s>\n",test);
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  if(test) ADM_dealloc(test);
-  return JS_TRUE;
-}
-
-JSBool facBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-   COMPRES_PARAMS test={
-  CodecYV12,
-  "YV12 (raw)",
-  "YV12",
-  "YV12",
-  COMPRESS_CQ,
-  1,
-  1500,
-  700,
-  1000,
-  ADM_ENC_CAP_CQ,
-  0,
-  NULL,
-  0,
-  NULL
-};
-    
-      diaElemBitrate bt(&test,"Entry");
-      diaElem *elems[]={&bt   };
-  if(diaFactoryRun("Test FileRead",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-JSBool facBar(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      diaElemBar bar1(25,"25");
-      diaElemBar bar2(65,"65");
-      diaElem *elems[]={&bar1,&bar2   };
-  if(diaFactoryRun("Test FileRead",2,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-void clickMe(void *cookie)
-{
-  GUI_Error_HIG("Button","Button pressed!"); 
-}
-JSBool facButton(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      diaElemButton bar1("Button",clickMe,NULL);
-      diaElem *elems[]={&bar1   };
-  if(diaFactoryRun("Test Button",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-JSBool facSlider(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  int32_t val=4;
-      diaElemSlider slide(&val,"foo", 0,10);
-      
-      diaElem *elems[]={&slide   };
-  if(diaFactoryRun("Test Slider",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-JSBool facRoText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      diaElemReadOnlyText txt("blah blah","Value:");
-      
-      diaElem *elems[]={&txt   };
-  if(diaFactoryRun("Test FileRead",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-JSBool facText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      char *foo=ADM_strdup("blah");
-      diaElemText txt(&foo,"Text",NULL);
-      
-      diaElem *elems[]={&txt   };
-  if(diaFactoryRun("Test FileRead",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-
-JSBool facTab(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      uint32_t test,test2;
-      
-      diaElemReadOnlyText txt("blah blah","Value:");
-      diaElemUInteger     bt(&test,"Entry",0,10);
-      diaElemUInteger     bt2(&test2,"Entry",0,10);
-      
-      
-      diaElem *elems1[]={&txt   };
-      diaElem *elems2[]={&bt,&bt2   };
-      
-      diaElemTabs tab1("T1",1,(diaElem **)elems1);
-      diaElemTabs tab2("T2",2,(diaElem **)elems2);
-      
-      diaElemTabs *tabs[2]={&tab1,&tab2};
-          
-      
-  if(diaFactoryRunTabs("Test FileRead",2,tabs))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-JSBool facFrame(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      uint32_t test,test2;
-      
-      diaElemReadOnlyText align("*****","Value:");
-      diaElemReadOnlyText txt("blah blah","Value:");
-      diaElemUInteger     bt(&test,"Entry1",0,10);
-      diaElemUInteger     bt2(&test2,"Entry2",0,10);
-      diaElemFrame        frm("Frame1");
-      
-      frm.swallow(&txt);
-      frm.swallow(&bt);
-      frm.swallow(&bt2);
-      
-         diaElem *elems[]={&align,&frm   };
-  if(diaFactoryRun("Test frame",2,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-      
-      
-}
-
-
-JSBool facHex(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      uint8_t data[100];
-      for(int i=0;i<100;i++) data[i]=i;
-      
-      diaElemHex binhex("*****",100,data);
-      
-      
-         diaElem *elems[]={&binhex   };
-  if(diaFactoryRun("Test binHex",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-      
-      
-}
-JSBool facMatrix(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      uint8_t data[16];
-      for(int i=0;i<100;i++) data[i]=i;
-      
-      diaElemMatrix Matrix(data,"Matrix",4);
-      
-      
-         diaElem *elems[]={&Matrix   };
-  if(diaFactoryRun("Test Matrix",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  for(int x=0;x<4*4;x++)
-  {
-	  if(x && !(x&3)) printf("\n");
-	  printf("%02x ",data[x]);
-	  
-  }
-  
-  return JS_TRUE;
-      
-      
-}
-JSBool facThreadCount(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-	uint32_t val=1;
-	diaElemThreadCount threadcount(&val,"ThreadCount");
-      
-    diaElem *elems[]={&threadcount   };
-    
-  if(diaFactoryRun("Test ThreadCount",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  return JS_TRUE;
-      
-}
-JSBool facNotch(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-	diaElemNotch notch(1,"Notch");
-      
-         diaElem *elems[]={&notch   };
-  if(diaFactoryRun("Test Notch",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  return JS_TRUE;
-      
-      
-}
-
-JSBool crashTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  
-  int *foobar=NULL;
-  *foobar=0; // CRASH!
-  return JS_TRUE;
-}
-JSBool assertTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  
-  ADM_assert(0);
-  return JS_TRUE;
-}
-
-//EOF 

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctionsNonRegFactory.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctionsNonRegFactory.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSFunctionsNonRegFactory.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,427 +0,0 @@
-// C++ Interface: Spider Monkey interface
-//
-// Description: 
-//
-//
-// Author: Anish Mistry
-//      Some modification by mean
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-#include <string>
-#include "ADM_default.h"
-#include <sys/types.h>
-#include <sys/stat.h>
-#if defined( ADM_WIN32 ) || defined(__MINGW32__)
-#define ADM_JS_WIN32
-#endif
-
-#ifndef ADM_JS_WIN32
-#include <sys/wait.h>
-#include <sys/param.h>
-#endif
-#include <errno.h>
-#include <dirent.h>
-#include <limits.h>
-#include <math.h>
-#include <vector>
-#include "ADM_JSAvidemux.h"
-#include "ADM_JSGlobal.h"
-#include "ADM_default.h"
-#include "DIA_coreToolkit.h"
-#include "ADM_editor/ADM_outputfmt.h"
-#include "adm_scanner.h" 
-#include "avi_vars.h"
-#include "gui_action.hxx"
-
-//#include "ADM_videoFilter.h"
-#include "ADM_editor/ADM_outputfmt.h"
-
-#include "ADM_script/ADM_container.h"
-
-#include "ADM_JSGlobal.h"
-#include "DIA_fileSel.h"
-
-#include "DIA_factory.h"
-
-
-extern char **environ;
-extern char *script_getVar(char *in, int *r);
-
-JSBool facInt(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facFloat(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facToggle(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facMenu(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facBar(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facRoText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facTab(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facFrame(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facHex(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facDirSel(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facButton(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facMatrix(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facNotch(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facThreadCount(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool facSlider(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool crashTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-JSBool assertTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-JSBool facInt(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  uint32_t tog=0;
-   diaElemUInteger blend(&tog,QT_TR_NOOP("Uinteger"),0,255);
-    diaElem *elems[]={&blend   };
-    
-  if(diaFactoryRun(QT_TR_NOOP("Test uinteger"),1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    printf("Value : %u\n",tog);
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-JSBool facFloat(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  ELEM_TYPE_FLOAT tog=0;
-   diaElemFloat blend(&tog,QT_TR_NOOP("Float"),0,255);
-    diaElem *elems[]={&blend   };
-    
-  if(diaFactoryRun("Test float",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    printf("Value : %f\n",(float)tog);
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  
-  return JS_TRUE;
-}
-
-JSBool facToggle(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  uint32_t tog=0;
-  uint32_t test=0;
-   diaElemToggle blend(&tog,QT_TR_NOOP("Toggle"));
-    diaElemUInteger     bt(&test,"Entry",0,10);
-    diaElemUInteger     bt2(&test,"Entry",0,10);
-    diaElem *elems[]={&blend,&bt,&bt2   };
-    blend.link(1,&bt);
-    blend.link(0,&bt2);
-    
-  if(diaFactoryRun("Test Toggle",3,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    printf("Value : %u\n",tog);
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  return JS_TRUE;
-}
-
-JSBool facMenu(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-   uint32_t tog=4;
-   ELEM_TYPE_FLOAT f=1; 
-   
-    diaMenuEntry menu[]={
-                             {2,   QT_TR_NOOP("No Strategy"),NULL},
-                             {4,     QT_TR_NOOP("3:2 Pulldown"),NULL},
-                             {6,     QT_TR_NOOP("Pal/Secam"),NULL},
-                             {7,  QT_TR_NOOP("NTSC converted from PAL"),NULL}
-                          };
-   diaElemMenu blend(&tog,QT_TR_NOOP("menu"),4,menu);
-    
-    // Link it to another
-    diaElemFloat toggle(&f,"Linked float",1,2);
-    blend.link(&(menu[1]),1,&toggle);
-    //
-diaElem *elems[]={&blend,&toggle   };
-  if(diaFactoryRun("Test Menu",2,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    printf("Value : %u\n",tog);
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  return JS_TRUE;
-}
-JSBool facFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-   uint32_t tog=0;
-   char *test=ADM_strdup("Entry test1");
-    
-      diaElemFile fread(0,&test,"Entry");
-      diaElem *elems[]={&fread   };
-  if(diaFactoryRun("Test FileRead",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    printf("Value : <%s>\n",test);
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  if(test) ADM_dealloc(test);
-  return JS_TRUE;
-}
-JSBool facDirSel(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-   uint32_t tog=0;
-   char *test=ADM_strdup("Entry test1");
-    
-      diaElemDirSelect fread(&test,"Entry");
-      diaElem *elems[]={&fread   };
-  if(diaFactoryRun("Test DirSel",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    printf("Value : <%s>\n",test);
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  if(test) ADM_dealloc(test);
-  return JS_TRUE;
-}
-
-JSBool facBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-
-   COMPRES_PARAMS test={
-  COMPRESS_CQ,
-  1,
-  1500,
-  700,
-  1000,
-  ADM_ENC_CAP_CQ+ADM_ENC_CAP_2PASS+ADM_ENC_CAP_CBR+ADM_ENC_CAP_SAME
-  };
-    
-      diaElemBitrate bt(&test,"Entry");
-      diaElem *elems[]={&bt   };
-  if(diaFactoryRun("Test BitRate",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  return JS_TRUE;
-}
-
-JSBool facBar(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      diaElemBar bar1(25,"25");
-      diaElemBar bar2(65,"65");
-      diaElem *elems[]={&bar1,&bar2   };
-  if(diaFactoryRun("Test FileRead",2,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-
-void clickMe(void *cookie)
-{
-  GUI_Error_HIG("Button","Button pressed!"); 
-}
-JSBool facButton(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      diaElemButton bar1("Button",clickMe,NULL);
-      diaElem *elems[]={&bar1   };
-  if(diaFactoryRun("Test Button",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-JSBool facSlider(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-  int32_t val=4;
-      diaElemSlider slide(&val,"foo", 0,10);
-      
-      diaElem *elems[]={&slide   };
-  if(diaFactoryRun("Test Slider",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-JSBool facRoText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      diaElemReadOnlyText txt("blah blah","Value:");
-      
-      diaElem *elems[]={&txt   };
-  if(diaFactoryRun("Test FileRead",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-JSBool facText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      char *foo=ADM_strdup("blah");
-      diaElemText txt(&foo,"Text",NULL);
-      
-      diaElem *elems[]={&txt   };
-  if(diaFactoryRun("Test FileRead",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-
-JSBool facTab(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      uint32_t test,test2;
-      
-      diaElemReadOnlyText txt("blah blah","Value:");
-      diaElemUInteger     bt(&test,"Entry",0,10);
-      diaElemUInteger     bt2(&test2,"Entry",0,10);
-      
-      
-      diaElem *elems1[]={&txt   };
-      diaElem *elems2[]={&bt,&bt2   };
-      
-      diaElemTabs tab1("T1",1,(diaElem **)elems1);
-      diaElemTabs tab2("T2",2,(diaElem **)elems2);
-      
-      diaElemTabs *tabs[2]={&tab1,&tab2};
-          
-      
-  if(diaFactoryRunTabs("Test FileRead",2,tabs))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-}
-JSBool facFrame(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      uint32_t test,test2;
-      
-      diaElemReadOnlyText align("*****","Value:");
-      diaElemReadOnlyText txt("blah blah","Value:");
-      diaElemUInteger     bt(&test,"Entry1",0,10);
-      diaElemUInteger     bt2(&test2,"Entry2",0,10);
-      diaElemFrame        frm("Frame1");
-      
-      frm.swallow(&txt);
-      frm.swallow(&bt);
-      frm.swallow(&bt2);
-      
-         diaElem *elems[]={&align,&frm   };
-  if(diaFactoryRun("Test frame",2,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-      
-      
-}
-
-
-JSBool facHex(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      uint8_t data[100];
-      for(int i=0;i<100;i++) data[i]=i;
-      
-      diaElemHex binhex("*****",100,data);
-      
-      
-         diaElem *elems[]={&binhex   };
-  if(diaFactoryRun("Test binHex",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  return JS_TRUE;
-      
-      
-}
-JSBool facMatrix(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-      uint8_t data[16];
-      for(int i=0;i<100;i++) data[i]=i;
-      
-      diaElemMatrix Matrix(data,"Matrix",4);
-      
-      
-         diaElem *elems[]={&Matrix   };
-  if(diaFactoryRun("Test Matrix",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  
-  for(int x=0;x<4*4;x++)
-  {
-	  if(x && !(x&3)) printf("\n");
-	  printf("%02x ",data[x]);
-	  
-  }
-  
-  return JS_TRUE;
-      
-      
-}
-JSBool facThreadCount(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-	uint32_t val=1;
-	diaElemThreadCount threadcount(&val,"ThreadCount");
-      
-    diaElem *elems[]={&threadcount   };
-    
-  if(diaFactoryRun("Test ThreadCount",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  return JS_TRUE;
-      
-}
-JSBool facNotch(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    
-	diaElemNotch notch(1,"Notch");
-      
-         diaElem *elems[]={&notch   };
-  if(diaFactoryRun("Test Notch",1,elems))
-  {
-    *rval = BOOLEAN_TO_JSVAL(1);
-    
-  }else
-    *rval = BOOLEAN_TO_JSVAL(0);
-  return JS_TRUE;
-      
-      
-}
-
-//EOF 

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,153 +0,0 @@
-/**
- * 
- * 
- */
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include "ADM_default.h"
-#include <string.h>
-#include <pthread.h>
-#include "DIA_coreToolkit.h"
-#include "ADM_JSGlobal.h"
-#include "ADM_JSAvidemux.h"
-#include "ADM_JSDirectorySearch.h"
-#include "ADM_jsShell.h"
-#include <stdarg.h>
-extern uint8_t JS_AvidemuxFunction(JSContext *cx,JSObject *global);
-extern bool JS_AvidemuxRegisterDebugFunction(JSContext *cx,JSObject *global);
-extern void A_Resync(void);
-extern bool isJsLogRedirected(void);
-extern char * actual_workbench_file;
-/**
-    \fn printJSError
-*/
-void  printJSError(JSContext *cx, const char *message, JSErrorReport *report)
-{// begin printJSError
-int quiet=GUI_isQuiet();
-char buf[4];
-FILE *fd = ADM_fopen(report->filename,"rb");
-    if(quiet)
-            GUI_Verbose();
-	if( fd )
-    {
-		fread(buf,1,4,fd);
-		fclose(fd);
-	}
-	if( strncmp(buf,"//AD",4) )
-    {
-            if (report->filename || report->lineno)
-                jsLog(JS_LOG_ERROR,"%s: line %d:\nMsg: %s\n"
-                              "Not an ECMAScript file. Try open it with 'File' -> 'Open...'",
-                              report->filename,
-                              report->lineno,
-                              message);
-            else
-                jsLog(JS_LOG_ERROR,"Not an ECMAScript file. Try open it with 'File' -> 'Open...'");
-    
-	}else
-    {
-            jsLog(JS_LOG_ERROR,"%s: line %d:\nMsg: %s\n",report->filename,report->lineno,message);
-	}
-       
-    if(quiet)
-            GUI_Quiet();
-
-}// end printJSError
-
-bool SpidermonkeyInit()
-{// begin SpidermonkeyInit
-	// setup JS
-	g_pCx = NULL;
-	g_pObject = NULL;
-	g_pRt = NULL;
-	JSRuntime *rt = JS_NewRuntime(1000000L);
-	g_pRt = rt;
-	if ( rt == NULL )
-	{
-		// Do some error reporting
-		printf("Spidermonkey failed to initialize runtime!\n");
-	}
-	else
-	{// begin runtime created
-		JSContext *cx = JS_NewContext(rt, 8192);
-		g_pCx = cx;
-		if ( cx == NULL )
-		{
-			// Do some error reporting
-			printf("Spidermonkey failed to initialize context!\n");
-		}
-		else
-		{// begin context created
-
-			JSObject *global = JS_NewObject(cx, &g_globalClass, 0, 0);
-			g_pObject = global;
-			JS_InitStandardClasses(cx, global);
-			// load our custom JS class objects
-			JSObject *obj = ADM_JSAvidemux::JSInit(cx, global);
-			JSObject *dsObj = ADM_JSDirectorySearch::JSInit(cx, global);
-			// register error handler
-			JS_SetErrorReporter(cx, printJSError);
-            JS_AvidemuxFunction(cx,global);
-            JS_AvidemuxRegisterDebugFunction(cx,global);
-			return true;
-		}// end context created
-	}// end runtime created
-	return false;
-}// end SpidermonkeyInit
-
-void SpidermonkeyDestroy()
-{// begin SpidermonkeyDestroy
-#ifdef ADM_JS_THREADSAFE
-	JS_SetContextThread(g_pCx);	
-#endif
-	JS_DestroyContext(g_pCx);
-	JS_DestroyRuntime(g_pRt);
-}// end SpidermonkeyDestroy
-
-void *StartThreadSpidermonkey(void *pData)
-{// begin StartThreadSpidermonkey
-        pthread_mutex_lock(&g_pSpiderMonkeyMutex);
-        /*
-        The following mailling list post describes how to CORRECTLY use
-        the threading API support with Spidermonkey
-        "Thread from SpiderMonkey newsgroup"
-        http://archive.gingerall.cz/archives/public/sablot2004/msg00117.html
-        */
-        // Notify the Spidermonkey that we'll be processing in a thread
-#ifdef ADM_JS_THREADSAFE
-        JS_SetContextThread(g_pCx);
-        JS_BeginRequest(g_pCx);
-#endif
-        bool ret = false;
-        const char *pScriptFile = static_cast<const char *>(pData);
-        ret = parseECMAScript(pScriptFile);
-        if(ret == false)
-        {
-                if( actual_workbench_file )
-                        ADM_dealloc(actual_workbench_file);
-                actual_workbench_file = ADM_strdup(pScriptFile);
-        }
-        // Notify Spidermonkey that our thread processing has finished
-#ifdef ADM_JS_THREADSAFE
-        JS_EndRequest(g_pCx);
-        JS_ClearContextThread(g_pCx);
-#endif
-        pthread_mutex_unlock(&g_pSpiderMonkeyMutex);
-
-        return NULL;
-}// end StartThreadSpidermonkey
-
-void JS_setSuccess(bool bSuccess)
-{// begin JS_setSuccess
-	g_bJSSuccess = bSuccess;
-	printf("[ECMA] success : %d\n", g_bJSSuccess);
-}// end JS_setSuccess
-
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSGlobal.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,59 +0,0 @@
-#ifndef _ADM_JSGLOBAL_H
-#define _ADM_JSGLOBAL_H
-
-// Spidermonkey
-
-#include "ADM_smjs/jsapi.h"
-#include <pthread.h>
-#include "ADM_JSif.h"
-bool jsLog(JS_LOG_TYPE type, const char *fmt,...);
-
-// javscript debugging helper
-void printJSError(JSContext *cx, const char *message, JSErrorReport *report);
-bool SpidermonkeyInit();
-void SpidermonkeyDestroy();
-void JS_setSuccess(bool bSuccess);
-void *StartThreadSpidermonkey(void *pData);
-
-
-typedef JSBool JS_PROTOTYPE(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
-
-#ifdef JSDECLARE
-#define JSVAR(a,b,c) a b=c
-#else
-#define JSVAR(a,b,c) extern a b
-#endif
-#if defined( __MINGW32__) && defined(JSDECLARE)
- pthread_t g_pThreadSpidermonkey ;
-#else
-JSVAR( pthread_t, g_pThreadSpidermonkey , 0);
-#endif
-JSVAR( pthread_mutex_t, g_pSpiderMonkeyMutex , PTHREAD_MUTEX_INITIALIZER);
-// expose our main javascript context to the entire program
-JSVAR( bool, g_bJSSuccess , 0);
-JSVAR( JSObject, *g_pObject,NULL);
-JSVAR( JSContext, *g_pCx,NULL);
-JSVAR( JSRuntime, *g_pRt,NULL);
-
-
-JSVAR( JSClass, g_globalClass,)
-#ifdef JSDECLARE
-{ 
-        "Global", 0, 
-        JS_PropertyStub,  JS_PropertyStub, 
-        JS_PropertyStub, JS_PropertyStub, 
-        JS_EnumerateStub, JS_ResolveStub, 
-        JS_ConvertStub,  JS_FinalizeStub }
-#endif
-        ;
-#if !defined(ADM_JS_THREADSAFE)
-#define enterLock() {}
-#define leaveLock() {}
-#else
-#define enterLock() jsrefcount nRefCount = JS_SuspendRequest(cx)
-#define leaveLock() {JS_ResumeRequest(cx,nRefCount); }
-
-#endif
-#endif
-//EOF
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,120 +0,0 @@
-/**
-    \file ADM_JSif.cpp
-    \brief interface to js
-*/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include "ADM_default.h"
-#include <string.h>
-#include <pthread.h>
-#include "DIA_coreToolkit.h"
-#include "ADM_JSGlobal.h"
-#include "ADM_JSAvidemux.h"
-#include "ADM_jsShell.h"
-#include "ADM_JSif.h"
-#include <stdarg.h>
-
-void    A_Resync(void);
-static jsLoggerFunc *jsLogger=NULL;
-static void *jsLoggerCookie=NULL;
-
-/**
-    \fn parseECMAScript
-    \brief Compile & execute ecma script
-*/
-bool parseECMAScript(const char *name)
-{// begin parseECMAScript
-	jsval rval;
-	uintN lineno = 0;
-	g_bJSSuccess = 0;
-	printf("Spidermonkey compiling \"%s\"...",name);
-	JSScript *pJSScript = JS_CompileFile(g_pCx, g_pObject, name);
-	printf("Done.\n");
-	if(pJSScript != NULL)
-	{// begin execute external file
-		printf("Spidermonkey executing \"%s\"...",name);
-		JSBool ok = JS_ExecuteScript(g_pCx, g_pObject, pJSScript, &rval);
-		JS_DestroyScript(g_pCx,pJSScript);
-		printf("Done.\n");
-	}// end execute external file
-        // Run garbage collector now, it is safe
-    JS_GC(g_pCx);
-	A_Resync();
-	return g_bJSSuccess;
-}// end parseECMAScript
-/**
-    \fn jsLogger
-*/
-bool isJsLogRedirected(void)
-{
-    if(jsLogger) return true;
-    return false;
-}
-/**
-    \fn jsEvaluate
-*/
-static bool jsEvaluate(const char *str)
-{
-jsval rval;
-   JS_EvaluateScript(g_pCx,g_pObject,str,strlen(str),"dummy",1,&rval);
-   return true; 
-}
-/**
-    \fn    interactiveECMAScript
-    \brief interprete & execute ecma script (interactive)
-*/
-bool interactiveECMAScript(const char *name)
-{
-    ADM_startShell(jsEvaluate);
-    JS_GC(g_pCx);
-	A_Resync();
-    ADM_info("Ending JS shell...\n");
-	return true;
-}
-/**
-    \fn jsLog
-*/
-bool jsLog(JS_LOG_TYPE type, const char *prf,...)
-{
- static char print_buffer[1024];
-  	
-		va_list 	list;
-		va_start(list,	prf);
-		vsnprintf(print_buffer,1023,prf,list);
-		va_end(list);
-		print_buffer[1023]=0; // ensure the string is terminated
-        if(true==isJsLogRedirected())
-            jsLogger(jsLoggerCookie,type,print_buffer);
-        else
-        {
-            if(type==JS_LOG_ERROR)
-                GUI_Error_HIG("Spidermonkey ECMAScript Error","%s",print_buffer);
-            else
-                ADM_warning("[JS]%s\n",print_buffer);
-        }
-        return true;
-}
-/**
-    \fn ADM_jsRegisterLogger
-*/
-bool ADM_jsRegisterLogger(void *cookie,jsLoggerFunc *fun)
-{
-    jsLoggerCookie=cookie;
-    jsLogger=fun;
-    return true;
-}
-/**
-    \fn ADM_jsUnregisterLogger
-*/
-bool ADM_jsUnregisterLogger(void)
-{
-    jsLogger=NULL;
-    return true;
-}

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,51 +0,0 @@
-/**
-    \file ADM_JSif.cpp
-    \brief interface to js
-*/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef ADM_JS_IF_H
-#define ADM_JS_IF_H
-
-/**
-    \enum JS_LOG_TYPE
-*/
-typedef enum
-{
-    JS_LOG_NORMAL,
-    JS_LOG_ERROR
-}JS_LOG_TYPE;
-/**
-    \typedef jsLoggerFunc
-*/
-typedef bool (jsLoggerFunc)(void *cookie,JS_LOG_TYPE type,const char *);
-/*
-
-*/
-bool ADM_jsRegisterLogger(void *cookie,jsLoggerFunc *fun);
-bool ADM_jsUnregisterLogger(void);
-
-/**
-    \fn parseECMAScript
-    \brief Compile & execute ecma script
-*/
-bool parseECMAScript(const char *name);
-
-/**
-    \fn    interactiveECMAScript
-    \brief interprete & execute ecma script (interactive)
-*/
-bool interactiveECMAScript(const char *name);
-/**
-    \fn jsLog
-
-*/
-bool jsLog(JS_LOG_TYPE type, const char *fmt,...);
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_container.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_container.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_container.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,35 +0,0 @@
-//____________________________________________________________________
-//
-//
-// Author: mean <fixounet at free.fr>, (C) 2003-2005
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-//____________________________________________________________________
-#ifndef ADM_CTNER_
-#define ADM_CTNER_
-typedef struct ADM_CONTAINER
-{
-    ADM_OUT_FORMAT type;
-    const char     *name;
-}ADM_CONTAINER;
-#define MK_CONT(x) {ADM_##x,#x}
-
-const ADM_CONTAINER container[]=
-{
-  MK_CONT(AVI),
-  MK_CONT(OGM),
-  MK_CONT(ES),
-  MK_CONT(PS),
-  MK_CONT(TS),
-  MK_CONT(AVI_DUAL),
-  MK_CONT(AVI_UNP),
-  MK_CONT(MP4),
-  MK_CONT(PSP),
-  MK_CONT(FLV),
-  MK_CONT(DUMMY),
-  MK_CONT(MATROSKA)  
-};
-#define NB_CONT (sizeof(container)/sizeof(ADM_CONTAINER))
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsShell.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,23 +0,0 @@
-/**
-    \file ADM_jsShell.h
-    \brief Base class for js interactive shell
-    \author mean, fixounet at free.fr
-*/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef ADM_JS_SHELL_H
-#define ADM_JS_SHELL_H
-#include "ADM_JSif.h"
-typedef bool (jsShellEvaluate)(const char *str);
-bool ADM_startShell(jsShellEvaluate *eval);
-
-
-#endif // ADM_JS_SHELL_H
\ No newline at end of file

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,99 +0,0 @@
-/**
-    \file ADM_jsUtils
-    \brief Simple param -> type utilities
-    \author mean fixounet at free.fr 2009
-*/
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include "ADM_default.h"
-#include <string.h>
-#include <pthread.h>
-#include "DIA_coreToolkit.h"
-
-#include "ADM_JSGlobal.h"
-#include "ADM_JSDebug.h"
-#include "ADM_JSif.h"
-#include "ADM_jsUtils.h"
-/**
-    \fn ADM_jsArg2Vars  
-    \brief convert jsvals to native type with checking
-*/
-bool ADM_jsArg2Vars(JSContext *cx, JSObject *obj, int argc, jsval *argv, int paramNumber, ADM_PARAM_LIST *param)
-{
-    if(paramNumber!=argc)
-    {
-        ADM_warning("Wrong number of parameters : %d vs %d\n",argc,paramNumber);
-        return false;
-    }
-    for(int i=0;i<argc;i++)
-    {
-        jsval j=argv[i];
-        ADM_PARAM_LIST *p=param+i;
-        switch(p->type)
-        {
-            case ADM_JS_UINT64_T:
-            case ADM_JS_UINT32_T:
-            case ADM_JS_INT64_T:
-            case ADM_JS_INT32_T:
-                {
-                        if(!JSVAL_IS_NUMBER(j))
-                        {
-                            ADM_warning("Expected number and got %d\n",j);
-                            return false;
-                        }
-                        // If it is an int...
-                        double v=0;
-                        if(JSVAL_IS_INT(j)) 
-                        {
-                            v=(int64_t)JSVAL_TO_INT(j);
-                            //ADM_warning("Value is int :%"LLD"\n",JSVAL_TO_INT(j));
-                        }
-                        if(JSVAL_IS_DOUBLE(j)) 
-                        {
-                            v=(int64_t)*(JSVAL_TO_DOUBLE(j));
-                            //ADM_warning("Value is float :%f\n",(float)*(JSVAL_TO_DOUBLE(j)));
-                        }
-                        // 
-                        //ADM_warning("%f\n",(float)v);
-                        // Affect
-                        switch(p->type)
-                        {
-                            case ADM_JS_UINT64_T: *(uint64_t *)p->value=(uint64_t)v;break;
-                            case ADM_JS_UINT32_T: *(uint32_t *)p->value=(uint32_t)v;break;
-                            case ADM_JS_INT64_T:  *(int64_t *)p->value=(int64_t)v;break;
-                            case ADM_JS_INT32_T:  *(int32_t *)p->value=(int32_t)v;break;
-                            default: ADM_assert(0);break;
-                        }
-                 }
-                        break;
-            case  ADM_JS_STRING:
-                        if(!JSVAL_IS_STRING(j))
-                        {
-                            ADM_warning("Expected string and got %d\n",j);
-                            return false;
-                        }
-                        p->value=(void *)(JSVAL_TO_STRING(j));
-                        break;
-            case  ADM_JS_BOOL:
-                        if(!JSVAL_IS_BOOLEAN(j))
-                        {
-                            ADM_warning("Expected boolean and got %d\n",j);
-                            return false;
-                        }
-                        *(bool *)p->value=JSVAL_TO_BOOLEAN(j);
-                        break;
-            default:
-                    ADM_assert(0);
-                    break;
-        }
-
-    }
-    return true;
-}
-// EOF

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_jsUtils.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,39 +0,0 @@
-/**
-    \file ADM_jsUtils
-    \brief Simple param -> type utilities
-    \author mean fixounet at free.fr 2009
-*/
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef ADM_JS_UTILS_H
-#define ADM_JS_UTILS_H
-
-typedef enum
-{
-    ADM_JS_INVALID=0,
-    ADM_JS_UINT32_T=1,
-    ADM_JS_INT32_T,
-    ADM_JS_UINT64_T,
-    ADM_JS_INT64_T,
-    ADM_JS_STRING,
-    ADM_JS_BOOL,
-    ADM_JS_MAX
-}ADM_PARAM_TYPE;
-
-typedef struct
-{
-    ADM_PARAM_TYPE type;
-    void           *value;
-
-}ADM_PARAM_LIST;
-
-bool ADM_jsArg2Vars(JSContext *cx, JSObject *obj, int argc, jsval *argv, int paramNumber, ADM_PARAM_LIST *param);
-
-
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/CMakeLists.txt	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,10 +0,0 @@
-SET(ADM_script_SRCS
-	ADM_AvidemuxAudio.cpp  ADM_AvidemuxVideo.cpp    ADM_JSAvidemux.cpp       ADM_JSDirectorySearch.cpp  ADM_JSGlobal.cpp
-	ADM_Avidemux.cpp       ADM_JSAvidemuxAudio.cpp  ADM_JSAvidemuxVideo.cpp  ADM_JSFunctions.cpp        DirectorySearch.cpp
-        ADM_JSFunctionsNonRegFactory.cpp
-        ADM_JSif.cpp ADM_JSDebug.cpp
-        ADM_jsUtils.cpp
-)
-
-ADD_LIBRARY(ADM_script6 STATIC ${ADM_script_SRCS})
-ADD_TARGET_CFLAGS(ADM_script6 "-DJS_THREADSAFE -DXP_UNIX")

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/DirectorySearch.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/DirectorySearch.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/DirectorySearch.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,224 +0,0 @@
-// DirectorySearch.cpp: implementation of the CDirectorySearch class.
-//
-//////////////////////////////////////////////////////////////////////
-/*
-Copyright 2001-2005 Anish Mistry. All rights reserved.
-
-Note:  This file is available under a BSD license.  Contact the author
-at amistry at am-productions.biz
-*/
-#include <string.h>
-#include "ADM_default.h"
-#include "DirectorySearch.h"
-
-//////////////////////////////////////////////////////////////////////
-// Construction/Destruction
-//////////////////////////////////////////////////////////////////////
-
-#if defined(__unix__) || defined(__APPLE__)
-int CDirectorySearch::_findnext(unsigned long int hDir,_finddata_t *pfdData)
-{// begin _findnext
-	if(!hDir || hDir == 0xFFFFFFFF)
-		return -1; // need to call opendir first
-	struct stat stInfo;
-	struct dirent *pEntry;
-	pEntry = readdir((DIR *)hDir);
-	if(!pEntry)
-		return -1;
-	std::string sFilePath = "";
-#if defined( __linux__) || defined(__macosx__) || defined(__MINGW32__)
-	strncpy(pfdData->name,pEntry->d_name,pEntry->d_reclen);
-	// append NULL terminator
-	pfdData->name[pEntry->d_reclen] = '\0';
-#elif defined(__FreeBSD__) || defined(__OpenBSD__)
-	strncpy(pfdData->name,pEntry->d_name,pEntry->d_namlen);
-	// append NULL terminator
-	pfdData->name[pEntry->d_namlen] = '\0';
-#endif
-	sFilePath += m_sDirectory;
-	sFilePath += DIRECTORY_DELIMITOR;
-	sFilePath += pfdData->name;
-	stat(sFilePath.c_str(),&stInfo);
-	pfdData->time_access = stInfo.st_atime;
-	pfdData->time_create = stInfo.st_ctime;
-	pfdData->time_write = stInfo.st_mtime;
-	pfdData->size = stInfo.st_size;
-	// assign the modes
-	pfdData->attrib = 0;
-	if(S_ISREG(stInfo.st_mode))
-		pfdData->attrib = _A_NORMAL;
-	if(S_ISDIR(stInfo.st_mode))
-		pfdData->attrib |= _A_SUBDIR;
-	if(S_ISCHR(stInfo.st_mode) ||
-	S_ISBLK(stInfo.st_mode) ||
-#if !defined(__WIN32)	
-	S_ISLNK(stInfo.st_mode) ||
-	S_ISSOCK(stInfo.st_mode) ||
-#endif
-	S_ISFIFO(stInfo.st_mode))
-		pfdData->attrib = _A_NONFILE;
-	return 0;
-}// end _findnext
-
-int CDirectorySearch::_findfirst(const char *path,_finddata_t *pfdData)
-{// begin _findfirst
-	unsigned long int hDir = (unsigned long int)opendir(path);
-	if(!hDir)
-		return -1;
-	if(_findnext(hDir,pfdData) == -1)
-		return -1;
-	return hDir;
-}// end _findfirst
-
-int CDirectorySearch::_findclose(unsigned long int hDir)
-{// begin _findclose
-	if(hDir == 0xFFFFFFFF)
-		return -1;
-	return closedir((DIR *)hDir);
-}// end _findclose
-#endif
-
-CDirectorySearch::CDirectorySearch()
-{
-	m_hSearch = 0;
-	m_sDirectory.clear();
-}
-
-CDirectorySearch::~CDirectorySearch()
-{
-	Close();
-}
-
-bool CDirectorySearch::Init(std::string sDirectory)
-{// begin Init
-char *s;
-	// check for no search query
-	if(sDirectory[sDirectory.length()-1] == DIRECTORY_DELIMITOR)
-	{
-		printf("End with directory delimitor\n");
-		return false;
-	}
-	const char *old=sDirectory.c_str();
-	s=new char[strlen(old)+10];
-	strcpy(s,old);
-#ifdef __WIN32	
-	strcat(s,"\\*");
-#endif
-	
-	printf(">%s<\n",s);
-	m_hSearch = _findfirst(s,&m_fdData);
-	delete [] s;	
-	if(m_hSearch == -1)
-	{
-		printf("Find first failed\n");
-		return false;
-	}
-	m_sDirectory = sDirectory;
-	return true;
-}// end Init
-
-bool CDirectorySearch::Close()
-{// begin Close
-	bool bRtn = false;
-	// clean up directory string
-	m_sDirectory.clear();
-	if(m_hSearch != 0)
-	{
-		bRtn = (bool)_findclose(m_hSearch);
-		m_hSearch = 0;
-	}
-	return bRtn;
-}// end Close
-
-std::string CDirectorySearch::GetFilePath()
-{// begin GetFilePath
-	std::string sBuffer = "";
-	sBuffer = m_sDirectory;
-	if(sBuffer[sBuffer.length()-1] != DIRECTORY_DELIMITOR && m_fdData.name[0] != DIRECTORY_DELIMITOR)
-		sBuffer += DIRECTORY_DELIMITOR;
-	sBuffer += m_fdData.name;
-	return sBuffer;
-}// end GetFilePath
-
-std::string CDirectorySearch::GetFileDirectory(std::string sFilePath) const
-{// begin GetFileDirectory
-	std::string sCurrentDirectory = "";
-	for(int i = sFilePath.length()-1;i >= 0;i--)
-		if(sFilePath[i] == DIRECTORY_DELIMITOR)
-		{// begin copy directory name into buffer
-#ifdef __WIN32
-			if(sFilePath[0] == DIRECTORY_DELIMITOR)
-			{
-				sFilePath.erase(0,1);
-				i--;
-			}
-#endif
-			sCurrentDirectory = sFilePath.substr(0,i+1);
-			break;
-		}// end copy directory name into buffer
-	return sCurrentDirectory;
-}// end GetFileDirectory
-
-std::string CDirectorySearch::GetFileDirectory()
-{// begin GetFileDirectory
-	return m_sDirectory;
-}// end GetFileDirectory
-
-bool CDirectorySearch::IsSingleDot()
-{// begin IsSingleDot
-	if(IsDirectory())
-		if(strcmp(".",m_fdData.name) == 0)
-			return true;
-	return false;
-}// end IsSingleDot
-
-bool CDirectorySearch::IsDoubleDot()
-{// begin IsDoubleDot
-	if(IsDirectory())
-		if(strcmp("..",m_fdData.name) == 0)
-			return true;
-	return false;
-}// end IsDoubleDot
-
-bool CDirectorySearch::IsExtension(const char *pExtension)
-{// begin IsExtension
-	int nExtLen = strlen(pExtension);
-	char *pTempBuffer = new char[nExtLen+1];
-	const char *pFileExt = GetExtension();
-	strcpy(pTempBuffer,pExtension);
-	for(int i = 0,nCurrExtLen = 0;i < nExtLen;i++,nCurrExtLen++)
-	{
-		if(pTempBuffer[i+1] == '\0')
-		{
-			nCurrExtLen++;
-			i++;
-			pTempBuffer[i] = ';';
-		}
-		if(pTempBuffer[i] == ';' && nCurrExtLen)
-		{
-			pTempBuffer[i] = '\0';
-			if(pTempBuffer[i-nCurrExtLen] == '*' || pTempBuffer[i-nCurrExtLen] == '?' 
-				|| (pFileExt && strcmp(&pTempBuffer[i-nCurrExtLen],pFileExt) == 0))
-			{
-				// free the buffer
-				delete []pTempBuffer;
-				return true;
-			}
-			nCurrExtLen = -1;
-		}
-	}
-	// free the buffer
-	delete []pTempBuffer;
-	return false;
-}// end IsExtension
-
-const char * CDirectorySearch::GetExtension()
-{// begin GetExtension
-	for(int i = strlen(m_fdData.name)-1;i >= 0;i--)
-	{// begin search
-		if(m_fdData.name[i] == '.')
-			return &m_fdData.name[i+1];
-	}// end search
-	return NULL;
-}// end GetExtension
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/DirectorySearch.cpp.orig
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/DirectorySearch.cpp.orig	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/DirectorySearch.cpp.orig	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,228 +0,0 @@
-// DirectorySearch.cpp: implementation of the CDirectorySearch class.
-//
-//////////////////////////////////////////////////////////////////////
-/*
-Copyright 2001-2005 Anish Mistry. All rights reserved.
-
-Note:  This file is available under a BSD license.  Contact the author
-at amistry at am-productions.biz
-*/
-#include <string.h>
-#include "config.h"
-#include "DirectorySearch.h"
-
-//////////////////////////////////////////////////////////////////////
-// Construction/Destruction
-//////////////////////////////////////////////////////////////////////
-
-#if defined(__unix__) || defined(__APPLE__)
-int CDirectorySearch::_findnext(unsigned long int hDir,_finddata_t *pfdData)
-{// begin _findnext
-	if(!hDir || hDir == 0xFFFFFFFF)
-		return -1; // need to call opendir first
-	struct stat stInfo;
-	struct dirent *pEntry;
-	pEntry = readdir((DIR *)hDir);
-	if(!pEntry)
-		return -1;
-	std::string sFilePath = "";
-#if defined( __linux__) || defined(__macosx__) || defined(__MINGW32__)
-	strncpy(pfdData->name,pEntry->d_name,pEntry->d_reclen);
-	// append NULL terminator
-	pfdData->name[pEntry->d_reclen] = '\0';
-#elif defined(__FreeBSD__) || defined(__OpenBSD__)
-	strncpy(pfdData->name,pEntry->d_name,pEntry->d_namlen);
-	// append NULL terminator
-	pfdData->name[pEntry->d_namlen] = '\0';
-#endif
-	sFilePath += m_sDirectory;
-	sFilePath += DIRECTORY_DELIMITOR;
-	sFilePath += pfdData->name;
-	stat(sFilePath.c_str(),&stInfo);
-	pfdData->time_access = stInfo.st_atime;
-	pfdData->time_create = stInfo.st_ctime;
-	pfdData->time_write = stInfo.st_mtime;
-	pfdData->size = stInfo.st_size;
-	// assign the modes
-	pfdData->attrib = 0;
-	if(S_ISREG(stInfo.st_mode))
-		pfdData->attrib = _A_NORMAL;
-	if(S_ISDIR(stInfo.st_mode))
-		pfdData->attrib |= _A_SUBDIR;
-	if(S_ISCHR(stInfo.st_mode) ||
-	S_ISBLK(stInfo.st_mode) ||
-#if !defined(__WIN32)	
-	S_ISLNK(stInfo.st_mode) ||
-	S_ISSOCK(stInfo.st_mode) ||
-#endif
-	S_ISFIFO(stInfo.st_mode))
-		pfdData->attrib = _A_NONFILE;
-	return 0;
-}// end _findnext
-
-int CDirectorySearch::_findfirst(const char *path,_finddata_t *pfdData)
-{// begin _findfirst
-	unsigned long int hDir = (unsigned long int)opendir(path);
-	if(!hDir)
-		return -1;
-	if(_findnext(hDir,pfdData) == -1)
-		return -1;
-	return hDir;
-}// end _findfirst
-
-int CDirectorySearch::_findclose(unsigned long int hDir)
-{// begin _findclose
-	if(hDir == 0xFFFFFFFF)
-		return -1;
-	return closedir((DIR *)hDir);
-}// end _findclose
-#endif
-
-CDirectorySearch::CDirectorySearch()
-{
-	m_hSearch = 0;
-	m_sDirectory.clear();
-}
-
-CDirectorySearch::~CDirectorySearch()
-{
-	Close();
-}
-
-bool CDirectorySearch::Init(std::string sDirectory)
-{// begin Init
-char *s;
-	// check for no search query
-	if(sDirectory[sDirectory.length()-1] == DIRECTORY_DELIMITOR)
-	{
-		printf("End with directory delimitor\n");
-		return false;
-	}
-	const char *old=sDirectory.c_str();
-	s=new char[strlen(old)+10];
-	strcpy(s,old);
-#ifdef __WIN32	
-	strcat(s,"\\*");
-#endif
-	
-	printf(">%s<\n",s);
-	m_hSearch = _findfirst(s,&m_fdData);
-	delete [] s;	
-	if(m_hSearch == -1)
-	{
-		printf("Find first failed\n");
-		return false;
-	}
-#ifdef __WIN32   //ndef __unix__
-	m_sDirectory = GetFileDirectory(sDirectory);
-#else
-	m_sDirectory = sDirectory;
-#endif
-	return true;
-}// end Init
-
-bool CDirectorySearch::Close()
-{// begin Close
-	bool bRtn = false;
-	// clean up directory string
-	m_sDirectory.clear();
-	if(m_hSearch != 0)
-	{
-		bRtn = (bool)_findclose(m_hSearch);
-		m_hSearch = 0;
-	}
-	return bRtn;
-}// end Close
-
-std::string CDirectorySearch::GetFilePath()
-{// begin GetFilePath
-	std::string sBuffer = "";
-	sBuffer = m_sDirectory;
-	if(sBuffer[sBuffer.length()-1] != DIRECTORY_DELIMITOR && m_fdData.name[0] != DIRECTORY_DELIMITOR)
-		sBuffer += DIRECTORY_DELIMITOR;
-	sBuffer += m_fdData.name;
-	return sBuffer;
-}// end GetFilePath
-
-std::string CDirectorySearch::GetFileDirectory(std::string sFilePath) const
-{// begin GetFileDirectory
-	std::string sCurrentDirectory = "";
-	for(int i = sFilePath.length()-1;i >= 0;i--)
-		if(sFilePath[i] == DIRECTORY_DELIMITOR)
-		{// begin copy directory name into buffer
-#ifdef __WIN32
-			if(sFilePath[0] == DIRECTORY_DELIMITOR)
-			{
-				sFilePath.erase(0,1);
-				i--;
-			}
-#endif
-			sCurrentDirectory = sFilePath.substr(0,i+1);
-			break;
-		}// end copy directory name into buffer
-	return sCurrentDirectory;
-}// end GetFileDirectory
-
-std::string CDirectorySearch::GetFileDirectory()
-{// begin GetFileDirectory
-	return m_sDirectory;
-}// end GetFileDirectory
-
-bool CDirectorySearch::IsSingleDot()
-{// begin IsSingleDot
-	if(IsDirectory())
-		if(strcmp(".",m_fdData.name) == 0)
-			return true;
-	return false;
-}// end IsSingleDot
-
-bool CDirectorySearch::IsDoubleDot()
-{// begin IsDoubleDot
-	if(IsDirectory())
-		if(strcmp("..",m_fdData.name) == 0)
-			return true;
-	return false;
-}// end IsDoubleDot
-
-bool CDirectorySearch::IsExtension(const char *pExtension)
-{// begin IsExtension
-	int nExtLen = strlen(pExtension);
-	char *pTempBuffer = new char[nExtLen+1];
-	const char *pFileExt = GetExtension();
-	strcpy(pTempBuffer,pExtension);
-	for(int i = 0,nCurrExtLen = 0;i < nExtLen;i++,nCurrExtLen++)
-	{
-		if(pTempBuffer[i+1] == '\0')
-		{
-			nCurrExtLen++;
-			i++;
-			pTempBuffer[i] = ';';
-		}
-		if(pTempBuffer[i] == ';' && nCurrExtLen)
-		{
-			pTempBuffer[i] = '\0';
-			if(pTempBuffer[i-nCurrExtLen] == '*' || pTempBuffer[i-nCurrExtLen] == '?' 
-				|| (pFileExt && strcmp(&pTempBuffer[i-nCurrExtLen],pFileExt) == 0))
-			{
-				// free the buffer
-				delete []pTempBuffer;
-				return true;
-			}
-			nCurrExtLen = -1;
-		}
-	}
-	// free the buffer
-	delete []pTempBuffer;
-	return false;
-}// end IsExtension
-
-const char * CDirectorySearch::GetExtension()
-{// begin GetExtension
-	for(int i = strlen(m_fdData.name)-1;i >= 0;i--)
-	{// begin search
-		if(m_fdData.name[i] == '.')
-			return &m_fdData.name[i+1];
-	}// end search
-	return NULL;
-}// end GetExtension
-

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/DirectorySearch.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/DirectorySearch.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/DirectorySearch.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,117 +0,0 @@
-// DirectorySearch.h: interface for the CDirectorySearch class.
-//
-//////////////////////////////////////////////////////////////////////
-/*
-Copyright 2001-2005 Anish Mistry. All rights reserved.
-
-Note:  This file is available under a BSD license.  Contact the author
-at amistry at am-productions.biz
-*/
-
-#ifndef _DIRECTORYSEARCH_H
-#define _DIRECTORYSEARCH_H
-
-#if _MSC_VER > 1000
-#pragma once
-#endif // _MSC_VER > 1000
-#ifdef __MINGW32__
-#include <io.h>
-#include <sys/stat.h>
-#else
-#include <sys/types.h>
-#include <sys/stat.h>
-#include <dirent.h>
-#include <string.h>
-#endif
-#include <cstring>
-#include "StdFile.h"
-
-// create a non file bit for unix
-#define _A_NONFILE	0x03
-
-#if defined( __unix__) || defined(__APPLE__)
-
-// wrap the file mode bits
-#define _A_NORMAL	0x00
-#define _A_HIDDEN	0x02
-#define _A_ARCH		0x20
-#define _A_SUBDIR	0x10
-
-// we need to emulate the windows style directory searching
-struct _finddata_t {
-	unsigned    attrib;
-	time_t      time_create;    /* -1 for FAT file systems */
-	time_t      time_access;    /* -1 for FAT file systems */
-	time_t      time_write;
-	int64_t     size;
-	char        name[260];
-	_finddata_t() : attrib(0), time_create(0), time_access(0), time_write(0), size(0) {name[0] = 0;}
-};
-
-#endif
-
-
-class CDirectorySearch
-{
-public:
-	const char * GetExtension();
-	bool IsExtension(const char *pExtension);
-	inline bool NextFile()
-	{// begin NextFile
-		if(_findnext(m_hSearch,&m_fdData) == -1)
-			return false;
-		return true;
-	}// end NextFile
-	bool Init(std::string sDirectory);
-	bool IsDoubleDot();
-	bool IsSingleDot();
-	inline unsigned long int GetFileSize()
-	// returns the file size in bytes
-	{// begin GetFileSize
-		return m_fdData.size;
-	}// end GetFileSize
-	inline bool IsHidden()
-	{// begin IsHidden
-		return (bool)(m_fdData.attrib & _A_HIDDEN);
-	}// end IsHidden
-	inline bool IsArchive()
-	{// begin IsArchive
-		return (bool)(m_fdData.attrib & _A_ARCH);
-	}// end IsArchive
-	inline bool IsDirectory()
-	{// begin IsDirectory
-		return (bool)(m_fdData.attrib & _A_SUBDIR);
-	}// end IsDirectory
-	inline bool IsNotFile()
-	{// begin IsNotFile
-		return (bool)(m_fdData.attrib & _A_NONFILE);
-	}// end IsNotFile
-	std::string GetFileDirectory();
-	inline char * GetFileName(char *pBuffer)
-	{// begin GetFileName
-		return strcpy(pBuffer,m_fdData.name);
-	}// end GetFileName
-	inline const char * GetFileName()
-	{// begin GetFileName
-		return (const char *)m_fdData.name;
-	}// end GetFileName
-	std::string GetFilePath();
-	bool Close();
-	CDirectorySearch();
-	virtual ~CDirectorySearch();
-
-protected:
-	std::string GetFileDirectory(std::string sFilePath) const;
-	long m_hSearch;
-	_finddata_t m_fdData;
-	std::string m_sDirectory;
-private:
-#if defined(__unix__) || defined(__APPLE__)
-	// prototypes
-	int _findfirst(const char *path,_finddata_t *pfdData);
-	int _findnext(unsigned long int hDir,_finddata_t *pfdData);
-	int _findclose(unsigned long int hDir);
-#endif
-};
-
-#endif // !defined(_DIRECTORYSEARCH_H)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/StdFile.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/StdFile.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/StdFile.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,63 +0,0 @@
-// StdFile.h: interface for the CStdFile class.
-//
-//////////////////////////////////////////////////////////////////////
-/*
-Copyright 2001-2005 Anish Mistry. All rights reserved.
-
-Note:  This file is available under a BSD license.  Contact the author
-at amistry at am-productions.biz
-*/
-
-#if !defined(AFX_STDFILE_H__44214218_8F1A_4792_8D4D_8147F50E168D__INCLUDED_)
-#define AFX_STDFILE_H__44214218_8F1A_4792_8D4D_8147F50E168D__INCLUDED_
-
-#if _MSC_VER > 1000
-#pragma once
-#endif // _MSC_VER > 1000
-
-#include <iostream>
-#include <iomanip>
-#include <fstream>
-#include <stdlib.h>
-#include <string>
-
-using namespace std;
-
-#ifdef __WIN32
-	const char DIRECTORY_DELIMITOR = '\\';
-#else
-	const char DIRECTORY_DELIMITOR = '/';
-	#define _MAX_PATH 1024
-#endif
-
-class CStdFile
-{
-public:
-	char Peek();
-	int WriteString(const char *pBuffer);
-	char * ReadString(char *pBuffer, int nMaxLen,char cDelim = ' ');
-	unsigned long int GetPos();
-	unsigned long int Seek(unsigned long int pos,ios::seekdir start);
-	unsigned long int GetLength();
-	unsigned long int Write(const char *buffer, unsigned long int bytesToWrite);
-	unsigned long int Read(char *buffer, unsigned long int bytesToRead);
-	const char * GetFilePath();
-	const char * GetFileName();
-	CStdFile(void);
-	virtual ~CStdFile(void);
-//	static bool Copy(const char *source,const char *dest, bool bOverwrite);
-	static int Rename(const char *source,const char *dest);
-	static int Delete(const char *fileName);
-	virtual bool Open(const char *filename, ios::openmode accessFlags);
-	unsigned long int WriteLine(const char *);
-	unsigned long int ReadLine(char *bufferOut);
-	virtual bool Close();
-
-protected:
-	void GetName(const char *fileString,char *fileBufferOut);
-	char *m_pPath;
-	char *m_pName;
-	fstream m_fsFile;
-};
-
-#endif // !defined(AFX_STDFILE_H__44214218_8F1A_4792_8D4D_8147F50E168D__INCLUDED_)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/adm_scanner.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/adm_scanner.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/adm_scanner.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -1,26 +0,0 @@
-/*
-	Type used by scanner
-
-*/
-#ifndef ADMSCANNER
-#define ADMSCANNER
-
-#define ADM_MAX_VAR 50
-//#include "ADM_videoFilter_iface.h"
-
-typedef enum
-{
-	ASC_OK,
-	ASC_UNKNOWN_FUNC,
-	ASC_BAD_NUM_PARAM,
-	ASC_BAD_PARAM,
-	ASC_EXEC_FAILED
-}ASC_ERROR;
-
-//int PushParam(APM_TYPE, char *value);
-int Call(char *string);
-
-
-#endif
-//END
-

Copied: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_JSif.h (from rev 5938, branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script/ADM_JSif.h	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_JSif.h	2010-02-20 07:52:21 UTC (rev 5939)
@@ -0,0 +1,51 @@
+/**
+    \file ADM_JSif.cpp
+    \brief interface to js
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_JS_IF_H
+#define ADM_JS_IF_H
+
+/**
+    \enum JS_LOG_TYPE
+*/
+typedef enum
+{
+    JS_LOG_NORMAL,
+    JS_LOG_ERROR
+}JS_LOG_TYPE;
+/**
+    \typedef jsLoggerFunc
+*/
+typedef bool (jsLoggerFunc)(void *cookie,JS_LOG_TYPE type,const char *);
+/*
+
+*/
+bool ADM_jsRegisterLogger(void *cookie,jsLoggerFunc *fun);
+bool ADM_jsUnregisterLogger(void);
+
+/**
+    \fn parseECMAScript
+    \brief Compile & execute ecma script
+*/
+bool parseECMAScript(const char *name);
+
+/**
+    \fn    interactiveECMAScript
+    \brief interprete & execute ecma script (interactive)
+*/
+bool interactiveECMAScript(const char *name);
+/**
+    \fn jsLog
+
+*/
+bool jsLog(JS_LOG_TYPE type, const char *fmt,...);
+#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2010-02-20 07:52:21 UTC (rev 5939)
@@ -23,5 +23,5 @@
 
 ADD_LIBRARY(ADM_script26 STATIC ${ADM_script_SRCS})
 ADD_DEFINITIONS("-DJS_THREADSAFE -DXP_UNIX")
-include_directories(${CMAKE_CURRENT_SOURCE_DIR}/../include)
+include_directories(${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/common/ADM_script2/include)
 include_directories(${AVIDEMUX_TOP_SOURCE_DIR}/avidemux_core/ADM_smjs)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/CMakeLists.txt	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/CMakeLists.txt	2010-02-20 07:52:21 UTC (rev 5939)
@@ -14,7 +14,7 @@
 #ADD_SUBDIRECTORY(ADM_plugin)
 ADD_SUBDIRECTORY(ADM_render)
 ADD_SUBDIRECTORY(ADM_requant)
-ADD_SUBDIRECTORY(ADM_script)
+#ADD_SUBDIRECTORY(ADM_script)
 ADD_SUBDIRECTORY(ADM_script2)
 ADD_SUBDIRECTORY(ADM_toolkit)
 #ADD_SUBDIRECTORY(ADM_video)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-02-20 07:52:21 UTC (rev 5939)
@@ -40,7 +40,7 @@
 
 #include "avi_vars.h"
 #include "prototype.h" // FIXME
-#include "ADM_script/ADM_JSif.h"
+#include "ADM_script2/include/ADM_JSif.h"
 char * actual_workbench_file;
 renderZoom currentZoom=ZOOM_1_1;
 //***********************************

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/CMakeLists.txt	2010-02-18 06:18:53 UTC (rev 5938)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/CMakeLists.txt	2010-02-20 07:52:21 UTC (rev 5939)
@@ -18,5 +18,5 @@
 
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})
 INCLUDE_DIRECTORIES("${CMAKE_SOURCE_DIR}/avidemux/ADM_UIs/ADM_QT4/include")
-INCLUDE_DIRECTORIES("${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/common/ADM_script/")
+INCLUDE_DIRECTORIES("${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/common/ADM_script2/include/")
 ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})



From mean at mail.berlios.de  Sat Feb 20 08:52:26 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 20 Feb 2010 08:52:26 +0100
Subject: [Avidemux-svn-commit] r5940 - in
	branches/avidemux_2.6_branch_mean/avidemux:
	cli/ADM_userInterfaces/ADM_shell gtk/ADM_userInterfaces/ADM_shell
Message-ID: <201002200752.o1K7qQ5t017326@sheep.berlios.de>

Author: mean
Date: 2010-02-20 08:52:26 +0100 (Sat, 20 Feb 2010)
New Revision: 5940

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/CMakeLists.txt
Log:
[script] Removal of ADM_script, update cli & gtk

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/CMakeLists.txt	2010-02-20 07:52:21 UTC (rev 5939)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/ADM_userInterfaces/ADM_shell/CMakeLists.txt	2010-02-20 07:52:26 UTC (rev 5940)
@@ -4,5 +4,5 @@
         cliShell.cpp
 )
 
-INCLUDE_DIRECTORIES("${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/common/ADM_script/")
+INCLUDE_DIRECTORIES("${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/common/ADM_script2/include/")
 ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/CMakeLists.txt	2010-02-20 07:52:21 UTC (rev 5939)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_shell/CMakeLists.txt	2010-02-20 07:52:26 UTC (rev 5940)
@@ -4,5 +4,5 @@
         gtkShell.cpp
 )
 
-INCLUDE_DIRECTORIES("${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/common/ADM_script/")
+INCLUDE_DIRECTORIES("${AVIDEMUX_TOP_SOURCE_DIR}/avidemux/common/ADM_script2/include/")
 ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})



From mean at mail.berlios.de  Sat Feb 20 08:52:28 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 20 Feb 2010 08:52:28 +0100
Subject: [Avidemux-svn-commit] r5941 - in
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2:
	include src
Message-ID: <201002200752.o1K7qSSB017336@sheep.berlios.de>

Author: mean
Date: 2010-02-20 08:52:27 +0100 (Sat, 20 Feb 2010)
New Revision: 5941

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsEditor.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.c
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.idl
Log:
[script] Add dumpSegment command to js

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsEditor.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsEditor.h	2010-02-20 07:52:26 UTC (rev 5940)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_jsEditor.h	2010-02-20 07:52:27 UTC (rev 5941)
@@ -20,6 +20,7 @@
 #endif
 
 int jsPrintTiming(int framenumber );
+int jsDumpSegments (void);
 #ifdef __cplusplus
 };
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp	2010-02-20 07:52:26 UTC (rev 5940)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsAvidemux.cpp	2010-02-20 07:52:27 UTC (rev 5941)
@@ -80,7 +80,15 @@
 */
 int  jsAddSegment(int ref, double start, double duration)
 {
-    if(true==video_body->addSegment(ref,(uint64_t)start,(uint64_t)duration)) return 1;
+    if(true==video_body->addSegment(ref,(uint64_t)start,(uint64_t)duration)) 
+    {
+        if(1==video_body->getNbSegment()) // We just added our first seg...
+        {
+                ADM_info("First segment, refreshing screen\n");
+                A_Rewind();
+        }
+        return 1;
+    }
     return 0;
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2010-02-20 07:52:26 UTC (rev 5940)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsDebug.cpp	2010-02-20 07:52:27 UTC (rev 5941)
@@ -70,45 +70,6 @@
 }
 
 /**
-    \fn dumpEditing
-    \brief dump segment, video & all
-*/
-JSBool dumpEditing(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-uint32_t info;
-uint32_t frame;
-uint32_t sz;
-        if(argc)
-        {
-            return JS_FALSE;
-        }
-        enterLock();
-        video_body->dumpEditing();
-        leaveLock(); 
-        
-        return JS_TRUE;
-}// end PostProcess
-/**
-    \fn dumpTiming
-    \brief dump segment, video & all
-*/
-JSBool dumpTiming(JSContext *cx, JSObject *obj, uintN argc, 
-                                       jsval *argv, jsval *rval)
-{// begin PostProcess
-uint32_t info;
-uint32_t frame;
-uint32_t sz;
-        if(argc != 0)
-          return JS_FALSE;
-  
-        enterLock();
-        video_body->dumpTiming();
-        leaveLock(); 
-        
-        return JS_TRUE;
-}// end PostProcess
-/**
     \fn printJSError
 */
 void  printJSError(JSContext *cx, const char *message, JSErrorReport *report)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor.cpp	2010-02-20 07:52:26 UTC (rev 5940)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor.cpp	2010-02-20 07:52:27 UTC (rev 5941)
@@ -37,4 +37,30 @@
     }
     return 0;
 }
+
+/**
+    \fn    jsDumpSegments
+    \brief dump segment, video & all
+*/
+int jsDumpSegments (void)
+{// begin PostProcess
+        enterLock();
+        video_body->dumpEditing();
+        leaveLock(); 
+        return 0;
+}// end PostProcess
+/**
+    \fn dumpTiming
+    \brief dump segment, video & all
+*/
+JSBool dumpTiming(void)
+{// begin PostProcess
+        
+  
+        enterLock();
+        video_body->dumpTiming();
+        leaveLock(); 
+        
+        return 0;
+}// end PostProcess
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.c	2010-02-20 07:52:26 UTC (rev 5940)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.c	2010-02-20 07:52:27 UTC (rev 5941)
@@ -95,20 +95,47 @@
     return var1;
 }
 static JSBool
-jjeditor__construct__(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+jjeditordumpSegment(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSObject *var13;
+    int var14;
     int var17;
+    jsval var18;
     JSBool var12;
     var13 = NULL;
+    var14 = 0;
     var17 = 0;
+    var18 = JSVAL_NULL;
     var12 = JS_FALSE;
     var13 = obj;
     var17 = argc;
-    jsEditor();
+    var14 = jsDumpSegments();
+    if (JS_NewNumberValue(cx, var14, &var18) != JS_TRUE) {
+        goto do_return;
+    }
+    argv[argc+0] = var18;
+    if (rval) {
+        *rval = var18;
+    }
     var12 = JS_TRUE;
+    do_return:
     return var12;
 }
+static JSBool
+jjeditor__construct__(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    JSObject *var20;
+    int var24;
+    JSBool var19;
+    var20 = NULL;
+    var24 = 0;
+    var19 = JS_FALSE;
+    var20 = obj;
+    var24 = argc;
+    jsEditor();
+    var19 = JS_TRUE;
+    return var19;
+}
 static JSPropertySpec jjeditor_static_ps[] = {
     {NULL, 0, 0, NULL, NULL}
 };
@@ -117,6 +144,7 @@
 };
 static JSFunctionSpec jjeditor_static_fs[] = {
     JS_FS("printTiming", jjeditorprintTiming, 1, 0, 1),
+    JS_FS("dumpSegment", jjeditordumpSegment, 0, 0, 1),
     JS_FS_END
 };
 static JSFunctionSpec jjeditor_fs[] = {

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.idl
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.idl	2010-02-20 07:52:26 UTC (rev 5940)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_jsEditor_js.idl	2010-02-20 07:52:27 UTC (rev 5941)
@@ -11,6 +11,7 @@
 {
         /*            JSFUNC                 C FUNC           PARAM     */
         function int printTiming     : jsPrintTiming(int ) <static>;
+        function int dumpSegment     : jsDumpSegments()    <static>;
         /*            JSFUNC                 C FUNC           PARAM     */
         
         construct                          : jsEditor  ( ) <static>     ; 



From mean at mail.berlios.de  Sat Feb 20 08:52:30 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 20 Feb 2010 08:52:30 +0100
Subject: [Avidemux-svn-commit] r5942 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <201002200752.o1K7qUmB017346@sheep.berlios.de>

Author: mean
Date: 2010-02-20 08:52:29 +0100 (Sat, 20 Feb 2010)
New Revision: 5942

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp
Log:
[editor] Fix loading a .js file where the video does not start at first frame (display pts vs video dts)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp	2010-02-20 07:52:27 UTC (rev 5941)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp	2010-02-20 07:52:29 UTC (rev 5942)
@@ -562,8 +562,12 @@
 {
         ADM_info("Rewinding\n");
         if(switchToSegment(0)==false) return false;
-        _VIDEOS *vid=_segments.getRefVideo(_segments.getSegment(0)->_reference);
-        SET_CURRENT_PTS(vid->lastDecodedPts);
+        _SEGMENT *seg=_segments.getSegment(0);
+        _VIDEOS *vid=_segments.getRefVideo(seg->_reference);
+        uint64_t pts=vid->lastDecodedPts;
+        pts=pts+seg->_startTimeUs;
+        pts-=seg->_refStartTimeUs;
+        SET_CURRENT_PTS(pts);
         return true;
 }
 /**



From mean at mail.berlios.de  Sat Feb 20 08:52:31 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 20 Feb 2010 08:52:31 +0100
Subject: [Avidemux-svn-commit] r5943 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <201002200752.o1K7qVur017356@sheep.berlios.de>

Author: mean
Date: 2010-02-20 08:52:31 +0100 (Sat, 20 Feb 2010)
New Revision: 5943

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx
Log:
[editor] Add getNbSegment utility function

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx	2010-02-20 07:52:29 UTC (rev 5942)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx	2010-02-20 07:52:31 UTC (rev 5943)
@@ -212,6 +212,10 @@
                     bool                remove(uint64_t start,uint64_t end);
                     bool                addSegment(uint32_t ref, uint64_t startRef, uint64_t duration);
                     bool                clearSegment(void);
+                    uint32_t            getNbSegment(void)
+                                        {
+                                            return _segments.getNbSegments();
+                                        }
 // For js
                     bool                dumpEditing(void);
                     bool                dumpTiming(void);



From mean at mail.berlios.de  Sat Feb 20 18:59:04 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 20 Feb 2010 18:59:04 +0100
Subject: [Avidemux-svn-commit] r5944 - in branches/avidemux_2.6_branch_mean:
	avidemux_core avidemux_core/ADM_ffmpeg
	avidemux_core/ADM_ffmpeg/ffmpeg_config
	avidemux_core/ADM_ffmpeg/libavcodec cmake
Message-ID: <201002201759.o1KHx4YT023927@sheep.berlios.de>

Author: mean
Date: 2010-02-20 18:59:01 +0100 (Sat, 20 Feb 2010)
New Revision: 5944

Added:
   branches/avidemux_2.6_branch_mean/cmake/FindYasm.cmake
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/fft.c
   branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/cmake/ADM_coreConfig.h.cmake
   branches/avidemux_2.6_branch_mean/cmake/admConfigSummary.cmake
Log:
[build] Preliminary support for yasm (broken)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/CMakeLists.txt	2010-02-20 07:52:31 UTC (rev 5943)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/CMakeLists.txt	2010-02-20 17:59:01 UTC (rev 5944)
@@ -1,8 +1,8 @@
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR})
 
+ADD_DEFINITIONS(-DHAVE_AV_CONFIG_H -fomit-frame-pointer -fno-math-errno)
 # Compiler flags
-ADD_DEFINITIONS(-DHAVE_AV_CONFIG_H -fomit-frame-pointer -fno-math-errno)
-
+###########################""
 IF (UNIX)
 	# CMake automatically adds -fPIC so remove it
 	STRING(REPLACE "-fPIC" "" CMAKE_SHARED_LIBRARY_C_FLAGS ${CMAKE_SHARED_LIBRARY_C_FLAGS})

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h	2010-02-20 07:52:31 UTC (rev 5943)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h	2010-02-20 17:59:01 UTC (rev 5944)
@@ -479,6 +479,9 @@
 #	define ENABLE_BSWAP 1
 #ifndef ADM_MINIMAL_INCLUDE
 #	define HAVE_MMX 1
+#	define HAVE_SSE 1
+#	define HAVE_AMD3DNOW 1
+#	define HAVE_AMD3DNOWEXT 1
 #	define ENABLE_MMX 1
 #endif //ADM_MINIMAL_INCLUDE
 #	define HAVE_FAST_UNALIGNED 1
@@ -486,6 +489,9 @@
 #	define HAVE_EBX_AVAILABLE 1
 #else
 #	define ENABLE_MMX 0
+#	define HAVE_SSE 0
+#	define HAVE_AMD3DNOW 0
+#	define HAVE_AMD3DNOWEXT 0
 #endif
 #ifdef ARCH_X86_64
 #	define HAVE_FAST_64BIT 1
@@ -493,7 +499,13 @@
 #ifdef ADM_BIG_ENDIAN
 #	define WORDS_BIGENDIAN 1
 #endif
+#ifdef USE_YASM
+#define ENABLE_YASM      1
+#define HAVE_YASM      1
+#else // USE_YASM
 #define ENABLE_YASM      0
+#undef HAVE_YASM      
+#endif // USE_YASM
 #define ENABLE_ARM      0
 #define ENABLE_PPC      0
 #define ENABLE_THREADS 1

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c	2010-02-20 07:52:31 UTC (rev 5943)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c	2010-02-20 17:59:01 UTC (rev 5944)
@@ -549,15 +549,21 @@
 
 	printf("#ifdef ARCH_X86\n");
 	printf("#	define ENABLE_BSWAP 1\n");
-printf("#ifndef ADM_MINIMAL_INCLUDE\n");
+        printf("#ifndef ADM_MINIMAL_INCLUDE\n");
 	printf("#	define HAVE_MMX 1\n");
+	printf("#	define HAVE_SSE 1\n");
+	printf("#	define HAVE_AMD3DNOW 1\n");
+	printf("#	define HAVE_AMD3DNOWEXT 1\n");
 	printf("#	define ENABLE_MMX 1\n");
-printf("#endif //ADM_MINIMAL_INCLUDE\n");
+        printf("#endif //ADM_MINIMAL_INCLUDE\n");
 	printf("#	define HAVE_FAST_UNALIGNED 1\n");
 	printf("#	define HAVE_EBP_AVAILABLE 1\n");
 	printf("#	define HAVE_EBX_AVAILABLE 1\n");
 	printf("#else\n");
 	printf("#	define ENABLE_MMX 0\n");
+	printf("#	define HAVE_SSE 0\n");
+	printf("#	define HAVE_AMD3DNOW 0\n");
+	printf("#	define HAVE_AMD3DNOWEXT 0\n");
 	printf("#endif\n");
 
 	printf("#ifdef ARCH_X86_64\n");
@@ -568,7 +574,14 @@
 	printf("#	define WORDS_BIGENDIAN 1\n");
 	printf("#endif\n");
 
+        printf("#ifdef USE_YASM\n");
+        printf("#define ENABLE_YASM      1\n");
+        printf("#define HAVE_YASM      1\n");
+        printf("#else // USE_YASM\n");
         printf("#define ENABLE_YASM      0\n");
+        printf("#undef HAVE_YASM      \n");
+        printf("#endif // USE_YASM\n");
+
         printf("#define ENABLE_ARM      0\n");
         printf("#define ENABLE_PPC      0\n");
 	printf("#define ENABLE_THREADS 1\n");

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt	2010-02-20 07:52:31 UTC (rev 5943)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt	2010-02-20 17:59:01 UTC (rev 5944)
@@ -10,9 +10,7 @@
 	xan.c  rpza.c  msrle.c  msrledec.c msvideo1.c  cinepak.c  vqavideo.c  idcinvideo.c  smc.c
 	flicvideo.c  interplayvideo.c  dpcm.c  8bps.c  vmdav.c  truemotion1.c  flac.c
 	g726.c  qtrle.c  
-        #lcl.c  
         snow.c  rangecoder.c  bitstream.c  h264idct.c  h261.c
-	#amr.c  
         rdft.c
         vc1dec.c vc1data.c vc1dsp.c vc1_parser.c
         avpacket.c
@@ -52,6 +50,22 @@
                 #x86/fft_3dn2.c
 		#x86/fft_3dn.c  
                 x86/dsputilenc_mmx.c  x86/vc1dsp_mmx.c  x86/idct_mmx.c)
+        IF(USE_YASM)
+                SET(YASM_SOURCE
+                                x86/dsputil_yasm.asm
+                                x86/fft_mmx.asm
+                                x86/h264_deblock_sse2.asm
+                                x86/h264_idct_sse2.asm)
+                SET(YASM_DEP x86/fft_3dn2.c  x86/fft_3dn.c   x86/fft_sse.c)
+                 FOREACH(yasm_files ${YASM_SOURCE})
+                        SET(tgt ${CMAKE_CURRENT_BINARY_DIR}/${yasm_files}.o)
+                        YASM_COMPILE(${CMAKE_CURRENT_SOURCE_DIR}/${yasm_files} ${tgt} ${CMAKE_CURRENT_SOURCE_DIR}/x86)
+                        SET(YASM_OBJ ${YASM_OBJ} ${tgt})
+                 ENDFOREACH(yasm_files)
+
+
+	        SET(${ADM_LIB}_SRCS  ${${ADM_LIB}_SRCS} ${YASM_OBJ} ${YASM_DEP})
+        ENDIF(USE_YASM)
 ENDIF(ADM_CPU_X86)
 
 IF (ADM_CPU_ALTIVEC)
@@ -71,7 +85,7 @@
 	ADD_SOURCE_CFLAGS(x86/dsputil_mmx.c -O2)
 	ADD_SOURCE_CFLAGS(x86/snowdsp_mmx.c -O2)
 ENDIF (ADM_DEBUG AND ADM_CPU_X86_32)
-
+ADD_DEPENDENCIES(${ADM_LIB} ${YASM_OBJ})
 TARGET_LINK_LIBRARIES(${ADM_LIB} ADM_core6 ADM_libavutil6 ${ZLIB_LIBRARY})
 
 ADM_INSTALL_LIB(${ADM_LIB} )

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/fft.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/fft.c	2010-02-20 07:52:31 UTC (rev 5943)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/fft.c	2010-02-20 17:59:01 UTC (rev 5944)
@@ -27,7 +27,7 @@
  */
 
 #include "dsputil.h"
-
+#include "config.h" // MEANX ????
 /* cos(2*pi*x/n) for 0<=x<=n/4, followed by its reverse */
 DECLARE_ALIGNED_16(FFTSample, ff_cos_16[8]);
 DECLARE_ALIGNED_16(FFTSample, ff_cos_32[16]);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-02-20 07:52:31 UTC (rev 5943)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-02-20 17:59:01 UTC (rev 5944)
@@ -24,6 +24,11 @@
 checkVDPAU()
 ENDIF(NOT CROSS)
 ########################################
+# YASM
+########################################
+include(FindYasm)
+admFindYasm()
+#########################################
 # Debug Summary
 ########################################
 IF (VERBOSE)

Modified: branches/avidemux_2.6_branch_mean/cmake/ADM_coreConfig.h.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/ADM_coreConfig.h.cmake	2010-02-20 07:52:31 UTC (rev 5943)
+++ branches/avidemux_2.6_branch_mean/cmake/ADM_coreConfig.h.cmake	2010-02-20 17:59:01 UTC (rev 5944)
@@ -20,6 +20,8 @@
 
 // use vdpau h264 hw decoding 
 #cmakedefine USE_VDPAU
+// use yasm
+#cmakedefine USE_YASM
 
 // 'gettimeofday' function is present
 #cmakedefine HAVE_GETTIMEOFDAY

Added: branches/avidemux_2.6_branch_mean/cmake/FindYasm.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/FindYasm.cmake	2010-02-20 07:52:31 UTC (rev 5943)
+++ branches/avidemux_2.6_branch_mean/cmake/FindYasm.cmake	2010-02-20 17:59:01 UTC (rev 5944)
@@ -0,0 +1,38 @@
+# - Extract information from a subversion working copy
+MACRO(admFindYasm )
+
+FIND_PROGRAM(YASM_EXECUTABLE yasm
+  DOC "yasm command line assembler")
+MARK_AS_ADVANCED(YASM_EXECUTABLE)
+
+IF(YASM_EXECUTABLE)
+        
+        SET(EXE  "cd ${_dir}&& ${GIT_EXECUTABLE} svn log | head -2  | grep '^r' | sed 's/ .*$//g'" )
+        MESSAGE(STATUS "Found yasm")
+        SET(USE_YASM 1)
+        IF(WIN32)
+                SET(YASM_FLAGS -f coff)
+        ELSE(WIN32)
+                SET(YASM_FLAGS -f elf -DPIC -g dwarf2)
+        ENDIF(WIN32)
+        IF(ADM_CPU_X86_64)
+                SET(YASM_FLAGS ${YASM_FLAGS} -DARCH_X86_64 -m amd64)
+        ELSE(ADM_CPU_X86_64)
+                SET(YASM_FLAGS ${YASM_FLAGS} -DARCH_X86_32)
+        ENDIF(ADM_CPU_X86_64)
+        MESSAGE(STATUS "Found yasm, flags ${YASM_FLAGS}")
+MACRO(YASM_COMPILE _in _out _inc)
+        ADD_CUSTOM_COMMAND(
+                OUTPUT ${_out}
+                COMMAND ${CMAKE_COMMAND} -E echo "Generating" ${_out} "from" ${_in}
+                COMMAND ${YASM_EXECUTABLE} -i ${_inc}  ${YASM_FLAGS} ${_in} -o ${_out}
+                DEPENDS ${_in}
+                VERBATIM
+                )
+ENDMACRO(YASM_COMPILE)
+
+ENDIF(YASM_EXECUTABLE)
+
+ENDMACRO(admFindYasm )
+
+# 

Modified: branches/avidemux_2.6_branch_mean/cmake/admConfigSummary.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admConfigSummary.cmake	2010-02-20 07:52:31 UTC (rev 5943)
+++ branches/avidemux_2.6_branch_mean/cmake/admConfigSummary.cmake	2010-02-20 17:59:01 UTC (rev 5944)
@@ -40,6 +40,7 @@
 ADM_DISPLAY("SDL       " "${USE_SDL}")
 ADM_DISPLAY("XVideo    " "${USE_XV}" "${XVIDEO_CAPABLE}")
 ADM_DISPLAY("VDPAU     " "${USE_VDPAU}" )
+ADM_DISPLAY("YASM      " "${USE_YASM}" )
 
 MESSAGE("*********************")
 



From mean at mail.berlios.de  Sat Feb 20 18:59:08 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 20 Feb 2010 18:59:08 +0100
Subject: [Avidemux-svn-commit] r5945 - in
	branches/avidemux_2.6_branch_mean/avidemux_core: ADM_core/src
	ADM_ffmpeg/ffmpeg_config ADM_ffmpeg/libpostproc
Message-ID: <201002201759.o1KHx8Xv023971@sheep.berlios.de>

Author: mean
Date: 2010-02-20 18:59:07 +0100 (Sat, 20 Feb 2010)
New Revision: 5945

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_cpuCap.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libpostproc/CMakeLists.txt
Log:
[core/ffmpeg] Fix runtime cpu detect

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_cpuCap.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_cpuCap.cpp	2010-02-20 17:59:01 UTC (rev 5944)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_cpuCap.cpp	2010-02-20 17:59:07 UTC (rev 5945)
@@ -131,6 +131,7 @@
 											if(!(myCpuMask&ADM_CPUCAP_##x)) printf("  but disabled");printf("\n");}
 	CHECK(MMX);
 	CHECK(3DNOW);
+    CHECK(3DNOWEXT);
 	CHECK(MMXEXT);
 	CHECK(SSE);
 	CHECK(SSE2);
@@ -138,7 +139,7 @@
 	CHECK(SSSE3);
 
 #endif // X86
-	printf("[cpuCaps]End of CPU capabilities check (cpuMask :%x)\n",myCpuMask);
+	printf("[cpuCaps]End of CPU capabilities check (cpuMask :%x, cpuCaps :%x)\n",myCpuMask,myCpuCaps);
 	return ;
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h	2010-02-20 17:59:01 UTC (rev 5944)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/config.h	2010-02-20 17:59:07 UTC (rev 5945)
@@ -522,6 +522,7 @@
 #define HAVE_ROUNDF 1
 #define HAVE_THREADS 1
 #define RUNTIME_CPUDETECT 1
+#define CONFIG_RUNTIME_CPUDETECT 1
 #ifdef __MINGW32__
 #define EXTERN_PREFIX "_"
 #else // __MINGW32__

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c	2010-02-20 17:59:01 UTC (rev 5944)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config/ffconf.c	2010-02-20 17:59:07 UTC (rev 5945)
@@ -598,6 +598,7 @@
 	printf("#define HAVE_ROUNDF 1\n");
 	printf("#define HAVE_THREADS 1\n");
 	printf("#define RUNTIME_CPUDETECT 1\n");
+	printf("#define CONFIG_RUNTIME_CPUDETECT 1\n");
     printf("#ifdef __MINGW32__\n");
         printf("#define EXTERN_PREFIX \"_\"\n");
     printf("#else // __MINGW32__\n");

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libpostproc/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libpostproc/CMakeLists.txt	2010-02-20 17:59:01 UTC (rev 5944)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libpostproc/CMakeLists.txt	2010-02-20 17:59:07 UTC (rev 5945)
@@ -9,5 +9,5 @@
 ENDIF (ADM_DEBUG AND ADM_CPU_X86_32)
 
 TARGET_LINK_LIBRARIES(${ADM_LIB} ADM_core6 ADM_libavutil6)
-
+ADD_DEFINITIONS(-DADM_MINIMAL_INCLUDE)
 ADM_INSTALL_LIB(${ADM_LIB} )



From mean at mail.berlios.de  Sat Feb 20 18:59:10 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 20 Feb 2010 18:59:10 +0100
Subject: [Avidemux-svn-commit] r5946 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec
Message-ID: <201002201759.o1KHxAAM023988@sheep.berlios.de>

Author: mean
Date: 2010-02-20 18:59:09 +0100 (Sat, 20 Feb 2010)
New Revision: 5946

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt
Log:
[build] Better yasm build rules

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt	2010-02-20 17:59:07 UTC (rev 5945)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt	2010-02-20 17:59:09 UTC (rev 5946)
@@ -58,7 +58,8 @@
                                 x86/h264_idct_sse2.asm)
                 SET(YASM_DEP x86/fft_3dn2.c  x86/fft_3dn.c   x86/fft_sse.c)
                  FOREACH(yasm_files ${YASM_SOURCE})
-                        SET(tgt ${CMAKE_CURRENT_BINARY_DIR}/${yasm_files}.o)
+                        SET(tgt1 ${CMAKE_CURRENT_BINARY_DIR}/${yasm_files}.o)
+                        STRING(REGEX REPLACE "libavcodec/x86/" "libavcodec/x86_" tgt "${tgt1}")
                         YASM_COMPILE(${CMAKE_CURRENT_SOURCE_DIR}/${yasm_files} ${tgt} ${CMAKE_CURRENT_SOURCE_DIR}/x86)
                         SET(YASM_OBJ ${YASM_OBJ} ${tgt})
                  ENDFOREACH(yasm_files)



From mean at mail.berlios.de  Sun Feb 21 09:30:33 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 21 Feb 2010 09:30:33 +0100
Subject: [Avidemux-svn-commit] r5947 - in branches/avidemux_2.6_branch_mean:
	avidemux/common avidemux/common/ADM_audiocodec
	avidemux/common/ADM_editor avidemux/common/ADM_render
	avidemux/qt4/ADM_userInterfaces/ADM_gui
	avidemux_core/ADM_ffmpeg/libavcodec
Message-ID: <201002210830.o1L8UXue019017@sheep.berlios.de>

Author: mean
Date: 2010-02-21 09:30:31 +0100 (Sun, 21 Feb 2010)
New Revision: 5947

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec/ADM_pluginLoad.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt
Log:
[libavcodec/yasm] add yasm deps if yasm is present

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec/ADM_pluginLoad.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec/ADM_pluginLoad.cpp	2010-02-20 17:59:09 UTC (rev 5946)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec/ADM_pluginLoad.cpp	2010-02-21 08:30:31 UTC (rev 5947)
@@ -183,5 +183,18 @@
     }
 	return NULL;
 }
-
+/**
+    \fn ADM_ad_cleanup
+*/
+bool ADM_ad_cleanup(void)
+{
+    ADM_info("Purging audio decoder\n");
+    for(int i=0;i<ADM_audioPlugins.size();i++)
+    {
+        ADM_ad_plugin *a=ADM_audioPlugins[i];
+        delete a;
+        ADM_audioPlugins[i]=NULL;
+    }
+    ADM_audioPlugins.clear();
+}   
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2010-02-20 17:59:09 UTC (rev 5946)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2010-02-21 08:30:31 UTC (rev 5947)
@@ -109,6 +109,8 @@
 {
 	_segments.deleteAll();
 	deletePostProc(&_pp);
+    if(_imageBuffer) delete  _imageBuffer;
+    _imageBuffer=NULL;
 }
 
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.cpp	2010-02-20 17:59:09 UTC (rev 5946)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.cpp	2010-02-21 08:30:31 UTC (rev 5947)
@@ -19,7 +19,7 @@
  ***************************************************************************/
 
 #include "config.h"
-#include "ADM_assert.h"
+#include "ADM_default.h"
 #include "GUI_render.h"
 #include "GUI_renderInternal.h"
 #include "GUI_accelRender.h"
@@ -130,6 +130,7 @@
 
 void renderDestroy(void)
 {
+    ADM_info("Cleaning up Render\n");
 	if(screenBuffer) 
 	{
 		delete[] screenBuffer;

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-02-20 17:59:09 UTC (rev 5946)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-02-21 08:30:31 UTC (rev 5947)
@@ -79,6 +79,9 @@
 extern uint8_t ADM_dm_loadPlugins(const char *path);
 extern uint8_t ADM_mx_loadPlugins(const char *path);
 extern uint8_t ADM_ve6_loadPlugins(const char *path);
+
+extern bool ADM_ad_cleanup(void);
+
 extern bool vdpauProbe(void);
 extern void loadPlugins(void);
 extern void InitFactory(void);
@@ -329,10 +332,13 @@
 
 	destroyGUI();
     destroyPrefs();
+    renderDestroy();
+    ADM_ad_cleanup();
     printf("End of cleanup\n");
     ADMImage_stat();
     ADM_memStat();
     ADM_memStatEnd();
+    
     ADM_info("\nGoodbye...\n\n");
 
 #if defined(ADM_DEBUG) && defined(FIND_LEAKS)

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-02-20 17:59:09 UTC (rev 5946)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-02-21 08:30:31 UTC (rev 5947)
@@ -660,7 +660,8 @@
 
 	destroyTranslator();
     delete myApplication;
-    myApplication=NULL;
+    myApplication=NULL;
+    
 }
 /**
     \fn searchTranslationTable(const char *name))

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt	2010-02-20 17:59:09 UTC (rev 5946)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt	2010-02-21 08:30:31 UTC (rev 5947)
@@ -86,7 +86,9 @@
 	ADD_SOURCE_CFLAGS(x86/dsputil_mmx.c -O2)
 	ADD_SOURCE_CFLAGS(x86/snowdsp_mmx.c -O2)
 ENDIF (ADM_DEBUG AND ADM_CPU_X86_32)
-ADD_DEPENDENCIES(${ADM_LIB} ${YASM_OBJ})
+IF(USE_YASM)
+  ADD_DEPENDENCIES(${ADM_LIB} ${YASM_OBJ})
+ENDIF(USE_YASM)
 TARGET_LINK_LIBRARIES(${ADM_LIB} ADM_core6 ADM_libavutil6 ${ZLIB_LIBRARY})
 
 ADM_INSTALL_LIB(${ADM_LIB} )



From mean at mail.berlios.de  Sun Feb 21 10:08:45 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 21 Feb 2010 10:08:45 +0100
Subject: [Avidemux-svn-commit] r5948 - in branches/avidemux_2.6_branch_mean:
	avidemux/common avidemux/common/ADM_audioFilter/src
	avidemux/common/ADM_videoFilter2/src
	avidemux_core/ADM_coreDemuxer/src avidemux_core/ADM_coreMuxer/src
Message-ID: <201002210908.o1L98jNQ020678@sheep.berlios.de>

Author: mean
Date: 2010-02-21 10:08:44 +0100 (Sun, 21 Feb 2010)
New Revision: 5948

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audio_encoderPlugin.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_pluginLoad.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreDemuxer/src/ADM_dynaDemuxer.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_dynaMuxer.cpp
Log:
[All] Fixes some memleaks

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audio_encoderPlugin.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audio_encoderPlugin.cpp	2010-02-21 08:30:31 UTC (rev 5947)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audio_encoderPlugin.cpp	2010-02-21 09:08:44 UTC (rev 5948)
@@ -157,6 +157,20 @@
 	return 1;
 }
 /**
+    \fn ADM_ae_cleanup
+*/
+bool ADM_ae_cleanup(void)
+{
+    for(uint32_t i=1;i<ListOfAudioEncoder.size();i++)
+	{
+		ADM_audioEncoder *a=ListOfAudioEncoder[i];
+        delete a;
+        ListOfAudioEncoder[i]=NULL;
+	}
+    ListOfAudioEncoder.clear();
+    return true;
+}
+/**
     \fn audioPrintCurrentCodec
     \brief updates the UI with the current selected audio encoder
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.cpp	2010-02-21 08:30:31 UTC (rev 5947)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.cpp	2010-02-21 09:08:44 UTC (rev 5948)
@@ -778,6 +778,15 @@
 {
 	admPreview::stop();
 
+	destroy();
+}
+/**
+    \fn cleanUp
+    \brief do the cleanup, what else ?
+*/
+void admPreview::destroy(void)
+{
+    ADM_info("Destroying preview\n");
 	if(rdrImage)
 	{
 		delete rdrImage;

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.h	2010-02-21 08:30:31 UTC (rev 5947)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.h	2010-02-21 09:08:44 UTC (rev 5948)
@@ -39,5 +39,6 @@
       static bool nextKeyFrame(void);
       static bool previousKeyFrame(void);
       static bool previousFrame(void);
+      static void destroy(void);
 };
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_pluginLoad.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_pluginLoad.cpp	2010-02-21 08:30:31 UTC (rev 5947)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_pluginLoad.cpp	2010-02-21 09:08:44 UTC (rev 5948)
@@ -209,6 +209,25 @@
 	return 1;
 }
 /**
+    \fn ADM_vf_cleanup
+*/
+bool ADM_vf_cleanup(void)
+{
+    ADM_info("Destroying video filter list\n");
+    for(int cat=0;cat<VF_MAX;cat++)
+    {
+        int nb=ADM_videoFilterPluginsList[cat].size();
+        for(int i=0;i<nb;i++)
+        {
+            ADM_vf_plugin *a=ADM_videoFilterPluginsList[cat][i];
+            delete a;
+            ADM_videoFilterPluginsList[cat][i]=NULL;
+        }
+        ADM_videoFilterPluginsList[cat].clear();
+    }
+    return true;
+}
+/**
     \fn ADM_vf_getPluginFromTag
     \brief 
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-02-21 08:30:31 UTC (rev 5947)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-02-21 09:08:44 UTC (rev 5948)
@@ -26,7 +26,7 @@
 #include "ADM_default.h"
 #include "ADM_threads.h"
 #include "DIA_uiTypes.h"
-
+#include "ADM_preview.h"
 #define __DECLARE__
 #include "avi_vars.h"
 
@@ -81,6 +81,10 @@
 extern uint8_t ADM_ve6_loadPlugins(const char *path);
 
 extern bool ADM_ad_cleanup(void);
+extern bool ADM_ae_cleanup(void);
+extern bool ADM_mx_cleanup(void);
+extern bool ADM_vf_cleanup(void);
+extern bool ADM_dm_cleanup(void);
 
 extern bool vdpauProbe(void);
 extern void loadPlugins(void);
@@ -103,6 +107,7 @@
 
 extern int UI_Init(int nargc,char **nargv);
 extern int UI_RunApp(void);
+extern void renderDestroy(void);
 
 // Spidermonkey/Scripting stuff  
 #if defined(ADM_DEBUG) && defined(FIND_LEAKS)
@@ -332,9 +337,17 @@
 
 	destroyGUI();
     destroyPrefs();
+    
+    admPreview::destroy();
     renderDestroy();
+
     ADM_ad_cleanup();
-    printf("End of cleanup\n");
+    ADM_ae_cleanup();
+    ADM_mx_cleanup();
+    ADM_vf_cleanup();
+    ADM_dm_cleanup();
+
+    printf("--End of cleanup--\n");
     ADMImage_stat();
     ADM_memStat();
     ADM_memStatEnd();

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreDemuxer/src/ADM_dynaDemuxer.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreDemuxer/src/ADM_dynaDemuxer.cpp	2010-02-21 08:30:31 UTC (rev 5947)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreDemuxer/src/ADM_dynaDemuxer.cpp	2010-02-21 09:08:44 UTC (rev 5948)
@@ -16,7 +16,7 @@
 #include <vector>
 #include "ADM_default.h"
 #include "ADM_demuxerInternal.h"
-
+bool ADM_dm_cleanup(void);
 void ADM_demuxersCleanup(void);
 vidHeader *ADM_demuxerSpawn(uint32_t magic,const char *name);
 
@@ -92,6 +92,14 @@
 	return 1;
 }
 /**
+    \fn ADM_dm_destroy
+*/
+bool ADM_dm_cleanup(void)
+{
+    ADM_demuxersCleanup();
+    return true;
+}
+/**
         \fn AVDM_cleanup
         \brief Current device is no longer used, delete
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_dynaMuxer.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_dynaMuxer.cpp	2010-02-21 08:30:31 UTC (rev 5947)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_dynaMuxer.cpp	2010-02-21 09:08:44 UTC (rev 5948)
@@ -17,8 +17,8 @@
 #include "ADM_default.h"
 #include "ADM_muxerInternal.h"
 #include "ADM_muxerProto.h"
+void ADM_MuxersCleanup(void);
 
-void ADM_muxersCleanup(void);
 ADM_muxer *ADM_muxerSpawn(uint32_t magic,const char *name);
 
 std::vector <ADM_dynMuxer *> ListOfMuxers;
@@ -120,6 +120,14 @@
 	return 1;
 }
 /**
+    \fn ADM_mx_cleanup
+*/
+bool ADM_mx_cleanup(void) 
+{
+    ADM_MuxersCleanup();
+    return true;
+}
+/**
     \fn ADM_mx_getExtraConf
     \brief Retrieve extra configuration from current muxer
 */



From mean at mail.berlios.de  Sun Feb 21 17:39:52 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 21 Feb 2010 17:39:52 +0100
Subject: [Avidemux-svn-commit] r5949 -
	branches/avidemux_2.6_branch_mean/cmake
Message-ID: <201002211639.o1LGdq8A006471@sheep.berlios.de>

Author: mean
Date: 2010-02-21 17:39:52 +0100 (Sun, 21 Feb 2010)
New Revision: 5949

Modified:
   branches/avidemux_2.6_branch_mean/cmake/FindYasm.cmake
Log:
[Yasm] Fix win32 compile flags for yasm

Modified: branches/avidemux_2.6_branch_mean/cmake/FindYasm.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/FindYasm.cmake	2010-02-21 09:08:44 UTC (rev 5948)
+++ branches/avidemux_2.6_branch_mean/cmake/FindYasm.cmake	2010-02-21 16:39:52 UTC (rev 5949)
@@ -11,7 +11,7 @@
         MESSAGE(STATUS "Found yasm")
         SET(USE_YASM 1)
         IF(WIN32)
-                SET(YASM_FLAGS -f coff)
+                SET(YASM_FLAGS -f coff -DPREFIX)
         ELSE(WIN32)
                 SET(YASM_FLAGS -f elf -DPIC -g dwarf2)
         ENDIF(WIN32)



From mean at mail.berlios.de  Tue Feb 23 07:45:38 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 23 Feb 2010 07:45:38 +0100
Subject: [Avidemux-svn-commit] r5950 - in
	branches/avidemux_2.6_branch_mean/avidemux/common: ADM_editor
	ADM_muxerGate/src
Message-ID: <201002230645.o1N6jc9V018314@sheep.berlios.de>

Author: mean
Date: 2010-02-23 07:45:36 +0100 (Tue, 23 Feb 2010)
New Revision: 5950

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edSearch.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edVideoCopy.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopy.cpp
Log:
[editor] Add delay to copymode + compute DTS in a signed way as it might be <0 at startup of video. It is still incomplete to properly handle copy mode (for example ts->ts)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp	2010-02-21 16:39:52 UTC (rev 5949)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp	2010-02-23 06:45:36 UTC (rev 5950)
@@ -30,6 +30,19 @@
 #include "ADM_pp.h"
 
 /**
+    \fn recalibrateSigned
+    \brief Same as below, but can return negative number
+*/
+void ADM_Composer::recalibrateSigned(int64_t *time,_SEGMENT *seg)
+{
+int64_t t=(int64_t)*time;
+        if(*time==ADM_NO_PTS) return;
+
+        t-=seg->_refStartTimeUs;
+        t+=seg->_startTimeUs;
+        *time=(int64_t )t;
+}
+/**
     \fn recalibrate
     \brief Convert time given in time from absolute ref video to linear time
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edSearch.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edSearch.cpp	2010-02-21 16:39:52 UTC (rev 5949)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edSearch.cpp	2010-02-23 06:45:36 UTC (rev 5950)
@@ -131,6 +131,46 @@
     return true;
 }
 /**
+    \fn getPtsDtsDelta
+*/
+
+bool			ADM_Composer::getPtsDtsDelta(uint64_t *frameTime)
+{
+uint64_t refTime,nkTime,segTime;
+int lastSeg=_segments.getNbSegments();
+uint32_t seg;
+bool r;
+    // 1- Convert frameTime to segments
+    if(false== _segments.convertLinearTimeToSeg(  *frameTime, &seg, &segTime))
+    {
+        ADM_warning(" Cannot find seg for time %"LLD"\n",*frameTime);
+        return false;
+    }   
+    // 
+    _SEGMENT *s=_segments.getSegment(seg);
+    int64_t delta=*frameTime-s->_startTimeUs; // Delta compared to the beginning of this seg
+    
+    delta+=s->_refStartTimeUs;
+    if(delta<0)
+    {
+        ADM_error("Time is negative\n");
+        return false;
+    }
+    // Delta is now the absolute PTS  time in reference video
+    uint32_t ref=s->_reference;
+    refTime=delta;
+    uint64_t dts;
+    if(false==_segments.dtsFromPts(ref,refTime,&dts))
+    {
+        ADM_error("Cannot get dtsFromDts for time %"LLU"\n",refTime);
+        *frameTime=0;
+        return false;
+    }
+    // Ok we have PTS and DTS, returns difference
+    *frameTime=refTime-dts;
+    return true;
+}
+/**
     \fn searchNextKeyFrameInRef
     \brief Search next key frame in ref video ref
     @param ref: # of ref video

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edVideoCopy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edVideoCopy.cpp	2010-02-21 16:39:52 UTC (rev 5949)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edVideoCopy.cpp	2010-02-23 06:45:36 UTC (rev 5950)
@@ -36,14 +36,16 @@
 
 
 */
-bool        ADM_Composer::getCompressedPicture(ADMCompressedImage *img)
+bool        ADM_Composer::getCompressedPicture(uint64_t videoDelay,ADMCompressedImage *img)
 {
     uint64_t tail;
     //
+    int64_t signedPts;
+    int64_t signedDts;
+
 againGet:
     static uint32_t fn;
     fn++;
-
     _SEGMENT *seg=_segments.getSegment(_currentSegment);
     ADM_assert(seg);
     _VIDEOS *vid=_segments.getRefVideo(seg->_reference);
@@ -78,28 +80,44 @@
     // Need to switch seg ?
     tail=seg->_refStartTimeUs+seg->_durationUs;
     // Guess DTS
-
+    //
    // ADM_info("Frame : Flags :%X, DTS:%"LLD" PTS=%"LLD" tail=%"LLD"\n",img->flags,img->demuxerDts/1000,img->demuxerPts/1000,tail);
     if(img->demuxerDts!= ADM_NO_PTS && img->demuxerDts>=tail) goto nextSeg;
     if(img->demuxerPts!= ADM_NO_PTS && img->demuxerPts>=tail) goto nextSeg;
+    
+    // Since we rely on PTS for seeking, frame 0 might be at PTS 0, in that case the matching dts would be <0
+    // so the caller can delay everything but recalibrate will clamp the value
+    // so we use correctedDts so that the value is ok
+    if(img->demuxerDts==ADM_NO_PTS)
+            signedDts=ADM_NO_PTS;
+    else
     {
-        // Recalibrate PTS & DTS...
-        recalibrate(&(img->demuxerPts),seg);
-        recalibrate(&(img->demuxerDts),seg);
+            signedDts=(int64_t)img->demuxerDts;
+            recalibrateSigned(&(signedDts),seg);
     }
+
+    if(img->demuxerPts==ADM_NO_PTS)
+            signedPts=ADM_NO_PTS;
+    else
+    {
+            signedPts=(int64_t)img->demuxerPts;
+            recalibrateSigned(&(signedPts),seg);
+    }
+    
     // From here we are in linear time...
     if(img->demuxerDts==ADM_NO_PTS)
     {
         img->demuxerDts=_nextFrameDts;
+        signedDts=_nextFrameDts;
     }else
     {
 // It means that the incoming image is earlier than the expected time.
 // we add a bit of timeIncrement to compensate for rounding
         if(_nextFrameDts>img->demuxerDts+vid->timeIncrementInUs/10)
         {
-         ADM_error("Frame %"LU" DTS is going back in time : expected : %"LLU" ms got : %"LLU" ms\n",fn,_nextFrameDts/1000,img->demuxerDts/1000);
+            ADM_error("Frame %"LU" DTS is going back in time : expected : %"LLU" ms got : %"LLU" ms\n",fn,_nextFrameDts/1000,img->demuxerDts/1000);
         }
-        _nextFrameDts=img->demuxerDts;
+        _nextFrameDts=signedDts;
     }
     // Increase for next one
     _nextFrameDts+=vid->timeIncrementInUs;
@@ -124,6 +142,8 @@
 
     }
    // ADM_info("Frame after RECAL: Flags :%X, DTS:%"LLD" PTS=%"LLD" tail=%"LLD"\n",img->flags,img->demuxerDts/1000,img->demuxerPts/1000,tail);
+    img->demuxerDts=signedDts+videoDelay;
+    img->demuxerPts=signedPts+videoDelay;
     return true;
 
 nextSeg:
@@ -136,6 +156,6 @@
     _SEGMENT *thisseg=_segments.getSegment(_currentSegment);
     thisseg->_dropBframes=1;
     ADM_info("Retrying for next segment\n");
-    return getCompressedPicture(img);
+    return getCompressedPicture(videoDelay,img);
    
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx	2010-02-21 16:39:52 UTC (rev 5949)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx	2010-02-23 06:45:36 UTC (rev 5950)
@@ -74,6 +74,7 @@
                     bool        seektoTime(uint32_t ref,uint64_t timeToSeek,bool dontdecode=false);
                     // Some useful functions...
                     void        recalibrate(uint64_t *time,_SEGMENT *seg);
+                    void        recalibrateSigned(int64_t *time,_SEGMENT *seg);
                     bool        updateImageTiming(_SEGMENT *seg,ADMImage *image);
                     // Need to get the image just before targetPts
                     bool        decodeTillPictureAtPts(uint64_t targetPts,ADMImage *image);
@@ -92,9 +93,9 @@
 
                     bool        searchNextKeyFrameInRef(int ref,uint64_t refTime,uint64_t *nkTime);
                     bool        searchPreviousKeyFrameInRef(int ref,uint64_t refTime,uint64_t *nkTime);
+                                
+                    
 
-
-
 //******************************************************************************************
   private:
                     ADM_EditorSegment _segments;
@@ -104,7 +105,7 @@
                     ADMImage	*_imageBuffer;   // Temp buffer used for decoding
                     uint64_t    _currentPts;        // Current image PTS
                     uint32_t    _currentSegment;    // Current video segment
-                    uint64_t    _nextFrameDts;      // COPYMODE Used in copy mode to fill the missing timestamp
+                    int64_t     _nextFrameDts;      // COPYMODE Used in copy mode to fill the missing timestamp
                                                     // Warning, it is actually the DTS of the NEXT frame to fetch
 //****************************** Audio **********************************
                     // _audiooffset points to the offset / the total segment
@@ -159,7 +160,7 @@
                     bool        rewind(void);
 // Used for stream copy
                     bool        GoToIntraTime_noDecoding(uint64_t time,uint32_t *toframe=NULL);
-                    bool        getCompressedPicture(ADMCompressedImage *img);     //COPYMODE                
+                    bool        getCompressedPicture(uint64_t delay,ADMCompressedImage *img);     //COPYMODE                
 public:
                     uint8_t	    updateVideoInfo(aviInfo *info);
                     uint32_t 	getSpecificMpeg4Info( void );
@@ -204,6 +205,8 @@
                     bool                getNKFramePTS(uint64_t *frameTime);
                     bool                getPKFramePTS(uint64_t *frameTime);
                     bool                getDtsFromPts(uint64_t *time);
+                                        /// Returns pts-dts for given frame
+                    bool		        getPtsDtsDelta(uint64_t *frameTime);
 /******************************* Post Processing ************************************/
                     uint8_t             setPostProc( uint32_t type, uint32_t strength,	uint32_t swapuv);
                     uint8_t             getPostProc( uint32_t *type, uint32_t *strength,uint32_t *swapuv);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopy.cpp	2010-02-21 16:39:52 UTC (rev 5949)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_muxerGate/src/ADM_videoCopy.cpp	2010-02-23 06:45:36 UTC (rev 5950)
@@ -40,16 +40,20 @@
         ptsStart=dtsStart=startTime;
     }else   
     {
-        // Now search the DTS associated with it...
-        dtsStart=ptsStart;
-        if(false==video_body->getDtsFromPts(&dtsStart))
+        uint64_t delta=ptsStart;
+        video_body->getPtsDtsDelta(&delta);
+        ADM_info("PTS/DTS delta=%"LLU" us\n",delta);
+        //videoDelay
+        if(delta>ptsStart)
         {
-                ADM_warning("Cannot get DTS for PTS=%"LLU" ms, expect problems\n",ptsStart/1000);
-                dtsStart=ptsStart;
+            videoDelay=delta-ptsStart;
+            dtsStart=0;
+            ADM_info("Dts is too early, delaying everything by %"LLU" ms\n",videoDelay/1000);
         }else
         {
-            ADM_info("Using %"LLU" ms as startTime\n",dtsStart/1000);
+            dtsStart=ptsStart-delta;
         }
+        // Now search the DTS associated with it...
     }
     eofMet=false;
 
@@ -103,7 +107,7 @@
     if(true==eofMet) return false;
 again:
     image.data=data;
-    if(false==video_body->getCompressedPicture(&image))
+    if(false==video_body->getCompressedPicture(videoDelay,&image))
     {
             ADM_warning(" Get packet failed ");
             return false;



From mean at mail.berlios.de  Tue Feb 23 07:45:43 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 23 Feb 2010 07:45:43 +0100
Subject: [Avidemux-svn-commit] r5951 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <201002230645.o1N6jhoD018343@sheep.berlios.de>

Author: mean
Date: 2010-02-23 07:45:40 +0100 (Tue, 23 Feb 2010)
New Revision: 5951

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edVideoCopy.cpp
Log:
[Editor] Better stream copy when first dts<0 & first pts=0

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp	2010-02-23 06:45:36 UTC (rev 5950)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edRender.cpp	2010-02-23 06:45:40 UTC (rev 5951)
@@ -40,6 +40,8 @@
 
         t-=seg->_refStartTimeUs;
         t+=seg->_startTimeUs;
+        if(t==ADM_NO_PTS)
+                t=ADM_NO_PTS-1;
         *time=(int64_t )t;
 }
 /**

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edVideoCopy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edVideoCopy.cpp	2010-02-23 06:45:36 UTC (rev 5950)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edVideoCopy.cpp	2010-02-23 06:45:40 UTC (rev 5951)
@@ -113,14 +113,19 @@
     {
 // It means that the incoming image is earlier than the expected time.
 // we add a bit of timeIncrement to compensate for rounding
-        if(_nextFrameDts>img->demuxerDts+vid->timeIncrementInUs/10)
+        if(_nextFrameDts!=ADM_NO_PTS)
         {
-            ADM_error("Frame %"LU" DTS is going back in time : expected : %"LLU" ms got : %"LLU" ms\n",fn,_nextFrameDts/1000,img->demuxerDts/1000);
+            if(_nextFrameDts>signedDts+vid->timeIncrementInUs/10)
+            {
+                ADM_error("Frame %"LU" DTS is going back in time : expected : %"LLD" ms got : %"LLD" ms\n",
+                                                fn,_nextFrameDts/1000,signedDts/1000);
+            }
         }
         _nextFrameDts=signedDts;
     }
     // Increase for next one
-    _nextFrameDts+=vid->timeIncrementInUs;
+    if(ADM_NO_PTS!=_nextFrameDts)
+        _nextFrameDts+=vid->timeIncrementInUs;
     // Check the DTS is not too late compared to next seg beginning...
     if(_currentSegment+1<_segments.getNbSegments() && img->demuxerDts!=ADM_NO_PTS)
     {
@@ -132,7 +137,7 @@
         }else       
         {
             nextDts-=nextSeg->_refStartTimeUs;
-            if(img->demuxerDts>=nextDts)
+            if(signedDts>=nextDts)
             {
                 ADM_warning("%"LU" have to switch segment, DTS limit reached %"LLU" %"LLU"\n",fn,img->demuxerDts/1000,nextDts/1000);
                 goto nextSeg;



From mean at mail.berlios.de  Tue Feb 23 19:21:01 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 23 Feb 2010 19:21:01 +0100
Subject: [Avidemux-svn-commit] r5952 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec
Message-ID: <201002231821.o1NIL1hS005559@sheep.berlios.de>

Author: mean
Date: 2010-02-23 19:20:57 +0100 (Tue, 23 Feb 2010)
New Revision: 5952

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp
Log:
[mpeg1/2-lavcodec] Fix crash when encoding single pass

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp	2010-02-23 06:45:40 UTC (rev 5951)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg1Encoder.cpp	2010-02-23 18:20:57 UTC (rev 5952)
@@ -516,7 +516,7 @@
 
 	int ret = AvcodecEncoder::encodeFrame(encodeParams);
 
-	if (_context->stats_out)
+	if (_context->stats_out && _statFile)
 		fprintf (_statFile, "%s", _context->stats_out);
 
 	if (_options.getXvidRateControl() && encodeParams->encodedDataSize && (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE || _encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_ABR))

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp	2010-02-23 06:45:40 UTC (rev 5951)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_avcodec/mpeg2Encoder.cpp	2010-02-23 18:20:57 UTC (rev 5952)
@@ -540,7 +540,7 @@
 
 	int ret = AvcodecEncoder::encodeFrame(encodeParams);
 
-	if (_context->stats_out)
+	if (_context->stats_out && _statFile)
 		fprintf (_statFile, "%s", _context->stats_out);
 
 	if (_options.getXvidRateControl() && encodeParams->encodedDataSize && (_encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_SIZE || _encodeOptions.encodeMode == ADM_VIDENC_MODE_2PASS_ABR))



From mean at mail.berlios.de  Tue Feb 23 19:21:12 2010
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 23 Feb 2010 19:21:12 +0100
Subject: [Avidemux-svn-commit] r5953 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/lavcodec
Message-ID: <201002231821.o1NILCZX005752@sheep.berlios.de>

Author: mean
Date: 2010-02-23 19:21:06 +0100 (Tue, 23 Feb 2010)
New Revision: 5953

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
Log:
[audio-lavcodec] Fix crash when deleting encoder

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2010-02-23 18:20:57 UTC (rev 5952)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2010-02-23 18:21:06 UTC (rev 5953)
@@ -112,7 +112,7 @@
   if(_context)
   {
     avcodec_close(CONTEXT);
-    ADM_dealloc(_context);
+    av_free(_context);
   }
   _context=NULL;
   cleanup();



From gruntster at mail.berlios.de  Sun Feb 28 21:32:40 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 28 Feb 2010 21:32:40 +0100
Subject: [Avidemux-svn-commit] r5954 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/lavcodec
Message-ID: <201002282032.o1SKWeCm002057@sheep.berlios.de>

Author: gruntster
Date: 2010-02-28 21:32:28 +0100 (Sun, 28 Feb 2010)
New Revision: 5954

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/lavcodec/CMakeLists.txt
Log:
[lavc audio] fix undefined references

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/lavcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/lavcodec/CMakeLists.txt	2010-02-23 18:21:06 UTC (rev 5953)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioEncoders/lavcodec/CMakeLists.txt	2010-02-28 20:32:28 UTC (rev 5954)
@@ -9,10 +9,12 @@
 	
 	add_library(ADM_libavcodec UNKNOWN IMPORTED)
 	set_property(TARGET ADM_libavcodec PROPERTY IMPORTED_LOCATION "${FFMPEG_LIB_DIR}/${LIBAVCODEC_LIB}")	
+	add_library(ADM_libavutil UNKNOWN IMPORTED)
+	set_property(TARGET ADM_libavutil PROPERTY IMPORTED_LOCATION "${FFMPEG_LIB_DIR}/${LIBAVUTIL_LIB}")	
 
 	ADD_LIBRARY(ADM_ae_lav_mp2 SHARED ${ADM_ae_lav_mp2_SRCS})
 	ADD_TARGET_CFLAGS(ADM_ae_lav_mp2 "-DADM_LAV_MP2")
-	TARGET_LINK_LIBRARIES(ADM_ae_lav_mp2 ADM_core ADM_coreAudio ADM_coreUI ADM_libavcodec)
+	TARGET_LINK_LIBRARIES(ADM_ae_lav_mp2 ADM_core ADM_coreAudio ADM_coreUI ADM_libavcodec ADM_libavutil)
 
 	INIT_AUDIO_ENCODER(ADM_ae_lav_mp2)
 	INSTALL_AUDIOENCODER(ADM_ae_lav_mp2)
@@ -21,7 +23,7 @@
 
 	ADD_LIBRARY(ADM_ae_lav_ac3 SHARED ${ADM_ae_lav_ac3_SRCS})
 	ADD_TARGET_CFLAGS(ADM_ae_lav_ac3 "-DADM_LAV_AC3")
-	TARGET_LINK_LIBRARIES(ADM_ae_lav_ac3 ADM_core ADM_coreAudio ADM_coreUI ADM_libavcodec)
+	TARGET_LINK_LIBRARIES(ADM_ae_lav_ac3 ADM_core ADM_coreAudio ADM_coreUI ADM_libavcodec ADM_libavutil)
 
 	INIT_AUDIO_ENCODER(ADM_ae_lav_ac3)
 	INSTALL_AUDIOENCODER(ADM_ae_lav_ac3)



From gruntster at mail.berlios.de  Sun Feb 28 21:50:36 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 28 Feb 2010 21:50:36 +0100
Subject: [Avidemux-svn-commit] r5955 - in
	branches/avidemux_2.5_branch_gruntster: avidemux/ADM_audio
	avidemux/ADM_coreImage/include avidemux/ADM_infoExtractor
	avidemux/ADM_outputs/oplug_avi cmake cmake/patches
Message-ID: <201002282050.o1SKoaT1002898@sheep.berlios.de>

Author: gruntster
Date: 2010-02-28 21:50:24 +0100 (Sun, 28 Feb 2010)
New Revision: 5955

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_a52info.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_dcainfo.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audio_packetizer.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audioac3ex.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audiomp3ex.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/include/ADM_image.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_infoExtractor/ADM_infoextractor.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_infoExtractor/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisave.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavedual.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.cpp
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
Log:
[ffmpeg] update FFmpeg to r22111 & libswscale to r30800

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_a52info.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_a52info.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_a52info.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -10,7 +10,6 @@
 //
 //
 
-#include "config.h"
 #include <stdio.h>
 #include "ADM_default.h"
 #include "ADM_assert.h"

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_dcainfo.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_dcainfo.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_dcainfo.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -10,15 +10,15 @@
 //
 //
 
-#include "config.h"
 #include <stdio.h>
 #include "ADM_default.h"
 #include "ADM_audio/ADM_dcainfo.h"
 
 extern "C"
 {
-#define INT_BIT (CHAR_BIT * sizeof(int))
+#include "ADM_libraries/ffmpeg/config.h"
 #include "libavcodec/get_bits.h"
+#undef printf
 }
 
 #include "ADM_assert.h"

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/CMakeLists.txt	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/CMakeLists.txt	2010-02-28 20:50:24 UTC (rev 5955)
@@ -2,3 +2,4 @@
 	ADM_aacinfo.cpp  ADM_mp3info.cpp  audiogen.cpp    audio_mpegidentify.cpp  audiosource_ext.cpp   audiowavex.cpp)
 	
 ADD_ADM_LIB_ALL_TARGETS(ADM_audio ${ADM_audio_SRCS})
+ADD_SOURCE_CFLAGS(ADM_dcainfo.cpp "-I${CMAKE_BINARY_DIR}/avidemux -DHAVE_AV_CONFIG_H")
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audio_packetizer.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audio_packetizer.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audio_packetizer.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -17,8 +17,6 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#include "config.h"
-
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audioac3ex.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audioac3ex.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audioac3ex.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -23,7 +23,6 @@
 #include "ADM_assert.h"
 #include <math.h>
 
-#include "config.h"
 #include "avifmt.h"
 #include "aviaudio.hxx"
 #include "ADM_audio/audioex.h"

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audiomp3ex.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audiomp3ex.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audiomp3ex.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -21,7 +21,6 @@
 //#include <stream.h>
 #include "ADM_assert.h"
 #include <math.h>
-#include "config.h"
 
 #include "avifmt.h"
 #include "aviaudio.hxx"

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/include/ADM_image.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/include/ADM_image.h	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/include/ADM_image.h	2010-02-28 20:50:24 UTC (rev 5955)
@@ -26,7 +26,7 @@
 #include "ADM_rgb.h"
 
 extern "C" {
-#include "libavutil/avutil.h"
+#include "libavutil/pixfmt.h"
 }
 
 typedef enum 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_infoExtractor/ADM_infoextractor.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_infoExtractor/ADM_infoextractor.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_infoExtractor/ADM_infoextractor.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -11,8 +11,6 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#include "config.h"
-
 #include "ADM_default.h"
 #include "ADM_editor/ADM_Video.h"
 
@@ -26,9 +24,10 @@
 
 extern "C"
 {
-#define INT_BIT (CHAR_BIT * sizeof(int))
+#include "ADM_libraries/ffmpeg/config.h"
 #include "libavcodec/get_bits.h"
 #include "libavcodec/golomb.h"
+#undef printf
 }
 
 #include "ADM_infoExtractor/ADM_h264_tag.h"

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_infoExtractor/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_infoExtractor/CMakeLists.txt	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_infoExtractor/CMakeLists.txt	2010-02-28 20:50:24 UTC (rev 5955)
@@ -1,4 +1,5 @@
 SET(ADM_infoExtractor_SRCS 
 	ADM_infoextractor.cpp)
 
-ADD_ADM_LIB_ALL_TARGETS(ADM_infoExtractor ${ADM_infoExtractor_SRCS})
\ No newline at end of file
+ADD_ADM_LIB_ALL_TARGETS(ADM_infoExtractor ${ADM_infoExtractor_SRCS})
+ADD_SOURCE_CFLAGS(ADM_infoextractor.cpp "-I${CMAKE_BINARY_DIR}/avidemux -DHAVE_AV_CONFIG_H")
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/CMakeLists.txt	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/CMakeLists.txt	2010-02-28 20:50:24 UTC (rev 5955)
@@ -5,3 +5,4 @@
 include_directories("${PTHREAD_INCLUDE_DIR}")
 
 ADD_ADM_LIB_ALL_TARGETS(oplug_avi ${ADM_oplug_avi_SRCS})
+ADD_SOURCE_CFLAGS(op_avisavecopy_pack.cpp "-I${CMAKE_BINARY_DIR}/avidemux -DHAVE_AV_CONFIG_H")
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisave.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisave.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisave.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -20,7 +20,6 @@
 */
  
 
-#include "config.h"
 #include "ADM_default.h"
 #include "ADM_threads.h"
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -20,7 +20,6 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#include "config.h"
 #include "ADM_default.h"
 #include "ADM_threads.h"
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -16,12 +16,18 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-
 #include "config.h"
+
+extern "C"
+{
+#include "ADM_libraries/ffmpeg/config.h"
+#include "libavcodec/put_bits.h"
+#undef printf
+}
+
 #include "ADM_default.h"
 #include "ADM_threads.h"
 
-
 #include "fourcc.h"
 #include "avi_vars.h"
 #include "DIA_coreToolkit.h"
@@ -330,13 +336,6 @@
         1*0 : Vop coded
 
 */
-extern "C"
-{
-#undef av_always_inline
-#define av_always_inline inline
-#define INT_BIT (CHAR_BIT * sizeof(int))
-#include "libavcodec/put_bits.h"
-}
 void putNvop(ADMBitstream *data,uint32_t timebits, uint32_t timeincval)
 {
   ADM_assert(data->data[0]==0);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -20,7 +20,6 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#include "config.h"
 #include "ADM_default.h"
 #include "ADM_threads.h"
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavedual.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavedual.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavedual.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -18,7 +18,6 @@
  *                                                                         *
  ***************************************************************************/
 #include <math.h>
-#include "config.h"
 #include "ADM_default.h"
 #include "ADM_threads.h"
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -19,7 +19,6 @@
  *                                                                         *
  ***************************************************************************/
 #define __STDC_LIMIT_MACROS
-#include "config.h"
 #include "ADM_default.h"
 #include "ADM_threads.h"
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.cpp	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_savesmart.cpp	2010-02-28 20:50:24 UTC (rev 5955)
@@ -18,21 +18,15 @@
 #include <sstream>
 #include <string>
 
-#include "config.h"
 #include "ADM_default.h"
 #include "ADM_threads.h"
 
-#ifdef USE_FFMPEG
 extern "C" {
 	#include "ADM_lavcodec.h"
-};
-#endif
+}
 
 #include "fourcc.h"
 #include "avi_vars.h"
-#ifdef HAVE_ENCODER
-
-
 #include "ADM_audio/aviaudio.hxx"
 #include "ADM_audiofilter/audioprocess.hxx"
 
@@ -396,4 +390,3 @@
 	return 1;
 }
 
-#endif

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2010-02-28 20:50:24 UTC (rev 5955)
@@ -1,7 +1,7 @@
 include(admFFmpegUtil)
 
-set(FFMPEG_VERSION 21837)	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=0b7f4c254edd1c4ef6a2538dff236d5a853c360d;sf=tgz
-set(SWSCALE_VERSION 30589)	# http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=12beb744c2c61620d3259fc832ff1853cef9a9c0;sf=tgz
+set(FFMPEG_VERSION 22111)	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=35b04ac6a5ed6d7e4c7db1945dae4d061ca5000b;sf=tgz
+set(SWSCALE_VERSION 30800)	# http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=9f92a66140e3ecd928be9f3359a4560c491c5047;sf=tgz
 
 set(LIBRARY_SOURCE_DIR "${CMAKE_SOURCE_DIR}/avidemux/ADM_libraries")
 set(FFMPEG_SOURCE_DIR "${LIBRARY_SOURCE_DIR}/ffmpeg")

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2010-02-28 20:50:24 UTC (rev 5955)
@@ -1,5 +1,5 @@
-*** libavcodec/avcodec.h.old	Mon Feb 15 19:01:58 2010
---- libavcodec/avcodec.h	Mon Feb 15 19:01:58 2010
+*** libavcodec/avcodec.h.old	Sun Feb 28 18:41:01 2010
+--- libavcodec/avcodec.h	Sun Feb 28 18:41:01 2010
 ***************
 *** 589,594 ****
 --- 589,596 ----
@@ -12,8 +12,8 @@
   /* Unsupported options :
    *              Syntax Arithmetic coding (SAC)
 ***************
-*** 1457,1462 ****
---- 1459,1465 ----
+*** 1458,1463 ****
+--- 1460,1466 ----
        * - decoding: unused
        */
       int rc_max_rate;
@@ -22,8 +22,8 @@
       /**
        * minimum bitrate
 ***************
-*** 1471,1476 ****
---- 1474,1481 ----
+*** 1472,1477 ****
+--- 1475,1482 ----
        * - decoding: unused
        */
       int rc_buffer_size;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2010-02-28 20:50:24 UTC (rev 5955)
@@ -1,8 +1,8 @@
-*** libavcodec/h264.c.old	Mon Feb 15 19:02:02 2010
---- libavcodec/h264.c	Mon Feb 15 19:02:02 2010
+*** libavcodec/h264.c.old	Sun Feb 28 18:41:04 2010
+--- libavcodec/h264.c	Sun Feb 28 18:41:04 2010
 ***************
-*** 3111,3116 ****
---- 3111,3127 ----
+*** 3117,3122 ****
+--- 3117,3133 ----
       return 0;
   }
   

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2010-02-28 20:32:28 UTC (rev 5954)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2010-02-28 20:50:24 UTC (rev 5955)
@@ -1,8 +1,8 @@
-*** libavcodec/utils.c.old	Mon Feb 15 19:02:16 2010
---- libavcodec/utils.c	Mon Feb 15 19:02:16 2010
+*** libavcodec/utils.c.old	Sun Feb 28 18:41:09 2010
+--- libavcodec/utils.c	Sun Feb 28 18:41:09 2010
 ***************
-*** 618,627 ****
---- 618,629 ----
+*** 637,646 ****
+--- 637,648 ----
   
       if((avctx->codec->capabilities & CODEC_CAP_DELAY) || avpkt->size){
           //FIXME remove the check below _after_ ensuring that all audio check that the available space is enough
@@ -16,7 +16,7 @@
           *frame_size_ptr < avctx->channels * avctx->frame_size * sizeof(int16_t)){
               av_log(avctx, AV_LOG_ERROR, "buffer %d too small\n", *frame_size_ptr);
 ***************
-*** 1058,1064 ****
+*** 1079,1085 ****
           return -1;
       }
   #if !HAVE_MKSTEMP
@@ -24,7 +24,7 @@
   #else
       snprintf(*filename, len, "/tmp/%sXXXXXX", prefix);
       fd = mkstemp(*filename);
---- 1060,1066 ----
+--- 1081,1087 ----
           return -1;
       }
   #if !HAVE_MKSTEMP



