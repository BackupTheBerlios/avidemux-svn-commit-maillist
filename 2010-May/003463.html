<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r6268 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_script2/include	avidemux/common/ADM_script2/js avidemux/common/ADM_script2/py	avidemux/common/ADM_script2/src avidemux_core/ADM_coreTinyPy/include	avidemux_core/ADM_coreTinyPy/src avidemux_core/ADM_coreUtils/include	avidemux_core/ADM_coreUtils/src cmake
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2010-May/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6268%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common/ADM_script2/include%0A%09avidemux/common/ADM_script2/js%20avidemux/common/ADM_script2/py%0A%09avidemux/common/ADM_script2/src%20avidemux_core/ADM_coreTinyPy/include%0A%09avidemux_core/ADM_coreTinyPy/src%20avidemux_core/ADM_coreUtils/include%0A%09avidemux_core/ADM_coreUtils/src%20cmake&In-Reply-To=%3C201005291542.o4TFgbZn019498%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003462.html">
   <LINK REL="Next"  HREF="003464.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r6268 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_script2/include	avidemux/common/ADM_script2/js avidemux/common/ADM_script2/py	avidemux/common/ADM_script2/src avidemux_core/ADM_coreTinyPy/include	avidemux_core/ADM_coreTinyPy/src avidemux_core/ADM_coreUtils/include	avidemux_core/ADM_coreUtils/src cmake</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6268%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common/ADM_script2/include%0A%09avidemux/common/ADM_script2/js%20avidemux/common/ADM_script2/py%0A%09avidemux/common/ADM_script2/src%20avidemux_core/ADM_coreTinyPy/include%0A%09avidemux_core/ADM_coreTinyPy/src%20avidemux_core/ADM_coreUtils/include%0A%09avidemux_core/ADM_coreUtils/src%20cmake&In-Reply-To=%3C201005291542.o4TFgbZn019498%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r6268 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_script2/include	avidemux/common/ADM_script2/js avidemux/common/ADM_script2/py	avidemux/common/ADM_script2/src avidemux_core/ADM_coreTinyPy/include	avidemux_core/ADM_coreTinyPy/src avidemux_core/ADM_coreUtils/include	avidemux_core/ADM_coreUtils/src cmake">mean at mail.berlios.de
       </A><BR>
    <I>Sat May 29 17:42:37 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="003462.html">[Avidemux-svn-commit] r6267 -	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config
</A></li>
        <LI>Next message: <A HREF="003464.html">[Avidemux-svn-commit] r6269 - in	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2:	include js py src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3463">[ date ]</a>
              <a href="thread.html#3463">[ thread ]</a>
              <a href="subject.html#3463">[ subject ]</a>
              <a href="author.html#3463">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2010-05-29 17:42:36 +0200 (Sat, 29 May 2010)
New Revision: 6268

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptAudio.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptUtils.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptUtils.cpp
   branches/avidemux_2.6_branch_mean/cmake/admPyClass.pl
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptVideo.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsAudio.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsUtils.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsVideo.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/ADM_pyAdm.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm.admPyClass
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptAudio.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptVideo.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/include/ADM_tinypy.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_confCouple.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_confCouple.cpp
Log:
[py] Add video and audio codec, merge it with js

Copied: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptAudio.h (from rev 6267, branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptVideo.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptVideo.h	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptAudio.h	2010-05-29 15:42:36 UTC (rev 6268)
@@ -0,0 +1,27 @@
+
+/**
+    \file  ADM_scriptAudio
+    \brief Audio codec etc..
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_SCRIPT_AUDIO_H
+#define ADM_SCRIPT_AUDIO_H
+
+#include &quot;ADM_confCouple.h&quot;
+#ifdef __cplusplus
+extern &quot;C&quot; {
+#endif
+int     scriptSetAudioCodec(const char *codec,int bitrate,CONFcouple *c);
+#ifdef __cplusplus
+};
+#endif
+
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptUtils.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptUtils.h	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptUtils.h	2010-05-29 15:42:36 UTC (rev 6268)
@@ -0,0 +1,4 @@
+/**
+
+*/
+

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptVideo.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptVideo.h	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptVideo.h	2010-05-29 15:42:36 UTC (rev 6268)
@@ -13,14 +13,15 @@
  ***************************************************************************/
 #ifndef ADM_JS_VIDEO_H
 #define ADM_JS_VIDEO_H
-
+#include &quot;ADM_confCouple.h&quot;
 #ifdef __cplusplus
 extern &quot;C&quot; {
 #endif
 
-int jsVideoCodec(const char *codec,const char **p);
-int jsSetPostProc (int a,int b, int c);
 
+int     jsSetPostProc (int a,int b, int c);
+int     scriptSetVideoCodec(const char *codec,CONFcouple *c);
+
 #ifdef __cplusplus
 };
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsAudio.cpp	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsAudio.cpp	2010-05-29 15:42:36 UTC (rev 6268)
@@ -24,10 +24,10 @@
 #include &quot;GUI_ui.h&quot;
 #include &quot;ADM_audioFilterInterface.h&quot;
 #include &quot;audioEncoderApi.h&quot;
-extern ADM_Composer *video_body;
+#include &quot;ADM_scriptAudio.h&quot;
 
 /**
-    \fn 
+    \fn jsAudioCodec
 */  
 extern &quot;C&quot; int   jsAudioCodec(const char *a,const char **b) {return 0;}
 JSBool jsAdmaudioCodec(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
@@ -40,32 +40,17 @@
         for(int i=2;i&lt;argc;i++)  if(JSVAL_IS_STRING(argv[i]) == false) return JS_FALSE;
 
         // Get Codec...
-        char *name = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        ADM_LowerCase(name);
-        
-        // First search the codec by its name
-        if(!audioCodecSetByName(name))
-        {
-                *rval = BOOLEAN_TO_JSVAL(false);
-                jsLogError(&quot;Cannot set audio codec %s\n&quot;,name);
-        }
-        else
-        {
-            // begin set bitrate
-            uint32_t bitrate=JSVAL_TO_INT(argv[1]);
-            // Construct couples
-            CONFcouple *c=NULL;
-            if(argc&gt;2)
+        char *name = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));     
+        // begin set bitrate
+        uint32_t bitrate=JSVAL_TO_INT(argv[1]);
+        // Construct couples
+        CONFcouple *c=NULL;
+        if(argc&gt;2)
             {
                 int nb=argc-2;
                 jsArgToConfCouple( nb,&amp;c,  argv+2);
             }
-            *rval = BOOLEAN_TO_JSVAL(setAudioExtraConf(bitrate,c));
-            if(c) delete c;
-        }
-
-        // end set bitrate
-        
+        *rval = BOOLEAN_TO_JSVAL(scriptSetAudioCodec(name,bitrate,c));        
         return JS_TRUE;
 }
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsUtils.cpp	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsUtils.cpp	2010-05-29 15:42:36 UTC (rev 6268)
@@ -93,42 +93,6 @@
     return true;
 }
 /**
-    \fn stringsToConfCouple
-    \brief Convert js args to confcouple
-
-*/
-bool stringsToConfCouple(int nb,CONFcouple **conf,  const char **argv)
-{
-  *conf=NULL;
-  if(!nb) return true;
-  CONFcouple *c=new CONFcouple(nb);
-  *conf=c;
-    for(int i=0;i&lt;nb;i++)
-    {
-        
-        char *dupe=   ADM_strdup(argv[i]);
-        char *name,*value;
-        // dupe is in the form name=value
-        name=dupe;
-        value=name;
-        char *tail=dupe+strlen(dupe);
-        while(value&lt;tail)
-        {
-            if(*value=='=') 
-                {
-                    *value=0;
-                    value++;
-                    break;
-                }
-            value++;
-        }
-        c-&gt;setInternalName(name,value);
-        //printf(&quot;%s -&gt; [%s,%s]\n&quot;,param,name,value);
-        ADM_dezalloc(dupe);
-    }
-    return true;
-}
-/**
     \fn jsArgToConfCouple
     \brief Convert js args to confcouple
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsVideo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsVideo.cpp	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsVideo.cpp	2010-05-29 15:42:36 UTC (rev 6268)
@@ -45,18 +45,9 @@
                 return JS_FALSE;
         }
         char *codec=JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        // Set codec.
-        
-        if(A_setVideoCodec(codec)==false)
-        {
-            jsLog(&quot;Could not select codec %s\n&quot;,codec);
-            return JS_FALSE;
-        }
         CONFcouple *c;
         jsArgToConfCouple(argc-1,&amp;c,argv+1);
-        *rval = BOOLEAN_TO_JSVAL( videoEncoder6_SetConfiguration(c));
-        jsLog(&quot;Selected codec %s\n&quot;,codec);
-        if(c) delete c;
+        *rval = BOOLEAN_TO_JSVAL( scriptSetVideoCodec(codec,c));
         return JS_TRUE;
 }// end Codec
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/ADM_pyAdm.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/ADM_pyAdm.cpp	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/ADM_pyAdm.cpp	2010-05-29 15:42:36 UTC (rev 6268)
@@ -22,6 +22,7 @@
 #include &quot;A_functions.h&quot;
 #include &quot;ADM_scriptCommon.h&quot;
 #include &quot;ADM_scriptVideo.h&quot;
+#include &quot;ADM_scriptAudio.h&quot;
 #include &quot;ADM_scriptEditor.h&quot;
 
 #include &quot;adm_gen.cpp&quot;

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm.admPyClass
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm.admPyClass	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm.admPyClass	2010-05-29 15:42:36 UTC (rev 6268)
@@ -12,4 +12,8 @@
 /* FUNC */ int jsAudioReset:audioReset        (void) 
 /* FUNC */ int jsAudioMixer:audioMixer        (const char * ) 
 /* FUNC */ int jsClearVideoFilters:clearVideoFilters   (void) 
-
+#
+#
+#              cname:pyname
+/* FUNC */ int scriptSetVideoCodec:videoCodec(const char *,couples) 
+/* FUNC */ int scriptSetAudioCodec:audioCodec(const char *,int,couples) 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp	2010-05-29 15:42:36 UTC (rev 6268)
@@ -85,6 +85,27 @@
 int r=jsClearVideoFilters(); 
 return tp_number(r);
 }
+//int  scriptSetVideoCodec &lt;const char * couples&gt;
+tp_obj zzpy_videoCodec(TP)
+{
+tinyParams pm(tp);
+const char * p0=pm.asString();
+CONFcouple *p1=NULL;
+pm.makeCouples(&amp;p1);
+int r=scriptSetVideoCodec(p0,p1); 
+return tp_number(r);
+}
+//int  scriptSetAudioCodec &lt;const char * int couples&gt;
+tp_obj zzpy_audioCodec(TP)
+{
+tinyParams pm(tp);
+const char * p0=pm.asString();
+int p1=pm.asDouble();
+CONFcouple *p2=NULL;
+pm.makeCouples(&amp;p2);
+int r=scriptSetAudioCodec(p0,p1,p2); 
+return tp_number(r);
+}
 static tp_obj myCtorpyAdm(tp_vm *vm)
 {
 }
@@ -104,5 +125,7 @@
  tp_set(vm,myClass,tp_string(&quot;audioReset&quot;),tp_fnc(vm,zzpy_audioReset));
  tp_set(vm,myClass,tp_string(&quot;audioMixer&quot;),tp_fnc(vm,zzpy_audioMixer));
  tp_set(vm,myClass,tp_string(&quot;clearVideoFilters&quot;),tp_fnc(vm,zzpy_clearVideoFilters));
+ tp_set(vm,myClass,tp_string(&quot;videoCodec&quot;),tp_fnc(vm,zzpy_videoCodec));
+ tp_set(vm,myClass,tp_string(&quot;audioCodec&quot;),tp_fnc(vm,zzpy_audioCodec));
  return myClass;
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.h	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.h	2010-05-29 15:42:36 UTC (rev 6268)
@@ -10,3 +10,5 @@
 int  audioReset (void);
 int  audioMixer (const char * );
 int  clearVideoFilters (void);
+int  videoCodec (const char *,couples);
+int  audioCodec (const char *,int,couples);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptAudio.cpp	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptAudio.cpp	2010-05-29 15:42:36 UTC (rev 6268)
@@ -24,7 +24,7 @@
 #include &quot;ADM_audioFilterInterface.h&quot;
 #include &quot;audioEncoderApi.h&quot;
 #include &quot;ADM_scriptCommon.h&quot;
-extern ADM_Composer *video_body;
+#include &quot;ADM_scriptAudio.h&quot;
 /**
     \fn int jsAudioReset(void);
 */
@@ -55,4 +55,27 @@
 {
 
 }
+/**
+
+*/
+/**
+    \fn scriptSetAudioCodec
+*/
+int     scriptSetAudioCodec(const char *codec,int bitrate,CONFcouple *c)
+{ 
+        int r=true;        
+        // First search the codec by its name
+        if(!audioCodecSetByName(codec))
+        {
+                r=false;
+                jsLogError(&quot;Cannot set audio codec %s\n&quot;,codec);
+        }
+        else
+        {
+            r=setAudioExtraConf(bitrate,c);
+            
+        }
+        if(c) delete c;
+        return r;
+}
 //EOF
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptUtils.cpp	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptUtils.cpp	2010-05-29 15:42:36 UTC (rev 6268)
@@ -0,0 +1,3 @@
+/**
+
+*/
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptVideo.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptVideo.cpp	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptVideo.cpp	2010-05-29 15:42:36 UTC (rev 6268)
@@ -27,6 +27,7 @@
 #include &quot;ADM_videoFilters.h&quot;
 #include &quot;GUI_ui.h&quot;
 #include &quot;ADM_scriptCommon.h&quot;
+#include &quot;ADM_scriptIf.h&quot;
 extern ADM_Composer *video_body;
 bool A_setVideoCodec(const char *nm);
 /**
@@ -44,8 +45,28 @@
     UI_setVideoCodec(idx);
     return true;
 }
-
 /**
+    \fn scriptSetVideoCodec
+*/
+int     scriptSetVideoCodec(const char *codec,CONFcouple *c)
+{       
+        bool r=true;
+        if(A_setVideoCodec(codec)==false)
+        {
+            jsLog(&quot;Could not select codec %s\n&quot;,codec);
+            r=false;
+        }else
+        {        
+            if(c)
+            {
+                r=videoEncoder6_SetConfiguration(c);
+            }
+        }
+        if(c)
+            delete c;
+        return r;
+}
+/**
     \fn jsSetPostProc
 */
 int jsSetPostProc (int a,int b, int c)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/CMakeLists.txt	2010-05-29 15:42:36 UTC (rev 6268)
@@ -4,6 +4,7 @@
         ADM_scriptAvidemux.cpp
         ADM_scriptAvidemuxInfo.cpp
         ADM_scriptAudio.cpp
+        ADM_scriptUtils.cpp
 )
 
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/include/ADM_tinypy.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/include/ADM_tinypy.h	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/include/ADM_tinypy.h	2010-05-29 15:42:36 UTC (rev 6268)
@@ -16,6 +16,7 @@
 #ifndef ADM_TINYPY_H
 #define ADM_TINYPY_H
 #include &quot;tinypy.h&quot;
+#include &quot;ADM_confCouple.h&quot;
 /**
     \struct tyFunc
 */
@@ -33,7 +34,8 @@
 class tinyPy 
 {
 protected:
-        void *instance;
+        void    *instance;
+        
 public:
                 tinyPy(void);
         bool    init(void);
@@ -46,6 +48,8 @@
 static  bool    registerLogger(pyLoggerFunc func);
 static  bool    unregisterLogger(void);
         bool    dumpBuiltin(void);
+       
+        
 };
 
 /**
@@ -55,6 +59,7 @@
 {
 protected:
         tp_vm *tp;
+        int     nbParamsLeft(void) {return tp-&gt;params.list.val-&gt;len;}
 public:
         tinyParams(tp_vm *i) {tp=i;}
         int    asInt(void);
@@ -64,5 +69,6 @@
         int    nbParam(void);
         void   raise(const char *fmt,...);
         const char *typeAsString(int type);
+        bool   makeCouples(CONFcouple **c);
 };
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp	2010-05-29 15:42:36 UTC (rev 6268)
@@ -211,7 +211,7 @@
     return (int)obj.number.val;
 }
 /**
-   \fn  asInt
+   \fn  asFloat
 */
 float    tinyParams::asFloat(void)
 {
@@ -219,7 +219,7 @@
     return (float)obj.number.val;
 }
 /**
-   \fn  asInt
+   \fn  asDouble
 */
 
 double tinyParams::asDouble(void)
@@ -228,7 +228,7 @@
     return (double)obj.number.val;
 }
 /**
-   \fn  asInt
+   \fn  asString
 */
 
 const char *tinyParams::asString(void)
@@ -237,7 +237,8 @@
     return obj.string.val;
 }
 /**
-   \fn  asInt
+   \fn  typeAsString
+    \brief return the type given as a string
 */
 
 const char *tinyParams::typeAsString(int type)
@@ -254,7 +255,8 @@
     return &quot;???&quot;;
 }
 /**
-
+    \fn raise
+    \brief raise an exception
 */
 void tinyParams::raise(const char *fmt,...)
 {
@@ -267,5 +269,20 @@
     ADM_error(&quot;%s&quot;,print_buffer);
     _tp_raise(tp,tp_None);
 }
-
+/**
+    \fn makeCouples
+    \brief convert couples into char *first and *couples c, c can be null
+*/
+bool    tinyParams::makeCouples(CONFcouple **c)
+{
+    int nb=nbParamsLeft();
+    if(!nb)
+    {
+        *c=NULL;
+        return true;
+    }
+    const char *s[nb];
+    for(int i=0;i&lt;nb;i++) s[i]=asString();
+    return stringsToConfCouple(nb,c,s);
+}
 // EOF
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_confCouple.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_confCouple.h	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/ADM_confCouple.h	2010-05-29 15:42:36 UTC (rev 6268)
@@ -54,4 +54,5 @@
 			void dump(void );
 
 };
+bool stringsToConfCouple(int nb,CONFcouple **conf,  const char **argv);
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_confCouple.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_confCouple.cpp	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/ADM_confCouple.cpp	2010-05-29 15:42:36 UTC (rev 6268)
@@ -195,4 +195,41 @@
     *nm=name[n];
     *val=value[n];
     return true;
-};
\ No newline at end of file
+};
+
+/**
+    \fn stringsToConfCouple
+    \brief Convert js args to confcouple
+
+*/
+bool stringsToConfCouple(int nb,CONFcouple **conf,  const char **argv)
+{
+  *conf=NULL;
+  if(!nb) return true;
+  CONFcouple *c=new CONFcouple(nb);
+  *conf=c;
+    for(int i=0;i&lt;nb;i++)
+    {
+        
+        char *dupe=   ADM_strdup(argv[i]);
+        char *name,*value;
+        // dupe is in the form name=value
+        name=dupe;
+        value=name;
+        char *tail=dupe+strlen(dupe);
+        while(value&lt;tail)
+        {
+            if(*value=='=') 
+                {
+                    *value=0;
+                    value++;
+                    break;
+                }
+            value++;
+        }
+        c-&gt;setInternalName(name,value);
+        //printf(&quot;%s -&gt; [%s,%s]\n&quot;,param,name,value);
+        ADM_dezalloc(dupe);
+    }
+    return true;
+}

Added: branches/avidemux_2.6_branch_mean/cmake/admPyClass.pl
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admPyClass.pl	2010-05-28 17:32:56 UTC (rev 6267)
+++ branches/avidemux_2.6_branch_mean/cmake/admPyClass.pl	2010-05-29 15:42:36 UTC (rev 6268)
@@ -0,0 +1,278 @@
+#
+# Generate glue to hook C functions to tinyPy static classes
+# returnvalue FUNC param
+#       param [int, float, void, str, couples]
+#                        str = const char *
+#                        couples =  confCouple *c
+#
+
+
+use strict;
+my $input;
+my $output;
+my $headerFile;
+my $line;
+my $glueprefix=&quot;zzpy_&quot;;
+my $functionPrefix=&quot;&quot;;
+my @allFuncs;
+my $className;
+my $cookieName;
+my $staticClass=0;
+my $nbCouples=0;
+#
+#
+#
+sub genReturn
+{
+        my $retType=shift;
+        if($retType=~m/int/)
+        {
+                return &quot;return tp_number(r);&quot;;
+        }
+        if($retType=~m/float/)
+        {
+                return &quot;return tp_number(r);&quot;;
+        }
+        if($retType=~m/void/)
+        {
+                return &quot;&quot;;
+        }
+         if($retType=~m/str/)
+        {
+                return &quot;return tp_string(r);&quot;;
+        }
+return &quot;???? $retType&quot;;
+}
+#
+#
+#
+sub castFrom
+{
+        my $type=shift;
+        if($type=~m/^const char/)
+        {
+                return &quot;pm.asString()&quot;;
+        }
+        if($type=~m/^int/)
+        {
+                return &quot;pm.asDouble()&quot;;
+        }
+        if($type=~m/^float/)
+        {
+                return &quot;pm.asFloat()&quot;;
+        }
+        print &quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; &lt;$type&gt; unknown\n&quot;;
+        return &quot;????&quot;;
+
+}
+#
+# Generate the locals / wrapping for the parameters
+#
+sub genParam
+{
+        my $num=shift;
+        my $type=shift;
+        my $r=1;
+        if($type=~m/couples/)
+        {
+                print OUTPUT &quot;CONFcouple *p&quot;.$num.&quot;=NULL;\n&quot;;
+                print OUTPUT &quot;pm.makeCouples(&amp;p&quot;.$num.&quot;);\n&quot;;
+                $r=0;
+        }else
+        {
+                print OUTPUT &quot;$type p&quot;.$num.&quot;=&quot;;
+                print OUTPUT castFrom($type);
+                print OUTPUT &quot;;\n&quot;; 
+        } 
+        return $r;
+}
+sub processClass
+{
+        my $proto=shift;
+        
+        $proto=~s%.*\*/%%g;
+        $proto=~s/ //g;
+        #print &quot;**$proto**\n&quot;;
+        ($className,$cookieName)=split &quot;:&quot;,$proto; 
+        print &quot;Processing class $className (with cookie=$cookieName)\n&quot;; 
+        if($cookieName=~m/void/)
+        {
+                $staticClass=1;
+        }
+        else
+        {
+                $staticClass=0;
+        }
+
+}
+#
+# Process a function declaration and write the glue code to do tinypy&lt;-&gt;function call
+#
+sub processFunc
+{
+        my $proto=shift;
+        my $args=$proto;
+        my @params;
+        my $retType=$proto;;
+        my $func=$proto;;
+        my $cfunc;
+        $args=~s/^.*\(//g;
+        $args=~s/\).*$//g;
+        #print &quot;args =&gt; $args\n&quot;;
+        @params=split &quot;,&quot;,$args;
+        #print &quot;params -&gt; @params\n&quot;;
+        # Get return type...
+        $retType=~s/^ *//g;
+        $retType=~s/ .*$//g;
+        # get functioName
+        $func=~s/ *\(.*$//g;
+        $func=~s/^.* //g;
+        ($cfunc,$func)=split &quot;:&quot;,$func;
+        print OUTPUT &quot;//$retType  $cfunc &lt;@params&gt;\n&quot;;
+        # Write glue code
+        print OUTPUT &quot;tp_obj &quot;.$glueprefix.$func.&quot;(TP)\n&quot;;
+        push(@allFuncs,$func);
+        print OUTPUT &quot;{\n&quot;;
+        my $nb=scalar(@params);
+        my $i;
+
+
+        for($i=0;$i&lt;$nb;$i++)
+        {
+                $params[$i]=~s/^ *//g; # Remove &quot; &quot; at the beginning if any
+                $params[$i]=~s/ *$//g; # Remove &quot; &quot; at the end if any
+        }
+        if($params[0]=~m/^void$/)
+        {
+                $nb=0;
+        }
+        print &quot; New function : $retType,$func,&lt;@params&gt;\n&quot;;
+        print HEADER &quot;$retType  $functionPrefix&quot;.$func.&quot; ($args);\n&quot;;
+        #
+        if($nb)
+        {
+                print OUTPUT &quot;tinyParams pm(tp);\n&quot;;
+                #print OUTPUT &quot;if(pm.getNbParams()!=$nb) pm.raise(\&quot;&quot;.$func.&quot;Bad number of parameters, wanted &quot;.$nb.&quot; and got %d\&quot;,pm.getNbParams());\n&quot;;
+        }
+
+        for($i=0;$i&lt;$nb;$i++)
+        {
+                if(!genParam($i,$params[$i]))  # all params consumed
+                {
+                        #$i=$nb;
+                }
+        }
+        # Call real function
+        if(!($retType=~m/^void$/))
+        {
+                if($retType=~m/str/)
+                {
+                print OUTPUT &quot;char *r=&quot;;
+                }else
+                {
+                print OUTPUT $retType.&quot; r=&quot;;
+                }
+        }
+        print OUTPUT $functionPrefix.$cfunc.&quot;(&quot;;
+        for($i=0;$i&lt;$nb;$i++)
+        {
+                if($i)
+                {
+                        print OUTPUT &quot;,&quot;;
+                }
+                print OUTPUT &quot;p&quot;.$i;
+        } 
+        print OUTPUT &quot;); \n&quot;;
+        # Cast r to pyobj
+        print OUTPUT genReturn($retType);
+        print OUTPUT &quot;\n}\n&quot;;
+
+
+}
+
+
+if(scalar(@ARGV)!=1)
+{
+        die(&quot;admPy inputfile\n&quot;);
+}
+$input=$ARGV[0];
+$output=$input;
+$output=~s/\..*$//g;
+my $thisfile=$output;
+$thisfile=~s/^.*\///g;
+$headerFile=$output.&quot;_gen.h&quot;;
+$output=$output.&quot;_gen.cpp&quot;;
+print &quot;Processing $input=&gt;$output\n&quot;;
+open(OUTPUT,&quot;&gt;$output&quot;) or die(&quot;Cannot open $output&quot;);
+print OUTPUT &quot;// Generated by admPyClass.pl do not edit !\n&quot;;
+##
+## Main Loop
+##
+# 1 grab all functions
+open(INPUT,$input) or die(&quot;Cannot open $input&quot;);
+close(INPUT);
+# Process them
+open(INPUT,$input) or die(&quot;Cannot open $input&quot;);
+open(HEADER,&quot;&gt;$headerFile&quot;) or die(&quot;Cannot open $headerFile&quot;);
+while($line=&lt;INPUT&gt;)
+{
+        chomp($line);
+        if($line=~m/^#/)
+        {
+        }
+        else
+        {
+            if($line=~m/\* FUNC \*/)
+            {
+                my $proto=$line;
+                # Remove header...
+                # Remove tail
+                $line=~s/^.*\*\///g;
+                $line=~s/\/\/.*$//g;
+                processFunc($line);
+
+            } elsif($line =~m/\/* CLASS \*/)
+                {
+                        processClass($line);
+                }
+        }
+}
+# gen class array
+
+
+# gen class xctor
+        print OUTPUT &quot;static tp_obj myCtor&quot;.$className.&quot;(tp_vm *vm)\n&quot;;
+        print OUTPUT &quot;{\n&quot;;
+        if($staticClass==0)
+        {
+                #todo allocate cookie
+        }
+        print OUTPUT &quot;}\n&quot;;
+  
+#
+my $nbFunc=scalar(@allFuncs);
+my $i;
+        print OUTPUT &quot;tp_obj initClass&quot;.$className.&quot;(tp_vm *vm)\n&quot;;
+        print OUTPUT &quot;{\n&quot;;
+        print OUTPUT &quot; tp_obj myClass=tp_class(vm);\n&quot;;
+        print OUTPUT &quot; tp_set(vm,myClass,tp_string(\&quot;__init__\&quot;),tp_fnc(vm,myCtor&quot;.$className.&quot;));\n&quot;;
+        for($i=0;$i&lt;$nbFunc;$i++)
+        {
+                my $line=$allFuncs[$i];
+                #print &quot;Function : $line\n&quot;;
+                my $funcName;
+                my $funcProto;
+                $funcName=&quot;\&quot;&quot;.$line.&quot;\&quot;&quot;;
+                $funcProto=$glueprefix.$line;
+
+                print OUTPUT &quot; tp_set(vm,myClass,tp_string($funcName),tp_fnc(vm,$funcProto));\n&quot;;
+        }
+        print OUTPUT &quot; return myClass;\n&quot;;
+        print OUTPUT &quot;}\n&quot;;
+        #print OUTPUT &quot;{$funcName,$funcProto},\n&quot;;
+
+
+close(INPUT);
+close(OUTPUT);
+close(HEADER);
+print &quot;done\n.&quot;;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003462.html">[Avidemux-svn-commit] r6267 -	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/ffmpeg_config
</A></li>
	<LI>Next message: <A HREF="003464.html">[Avidemux-svn-commit] r6269 - in	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2:	include js py src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3463">[ date ]</a>
              <a href="thread.html#3463">[ thread ]</a>
              <a href="subject.html#3463">[ subject ]</a>
              <a href="author.html#3463">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
