<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r3578 - in	branches/avidemux_2.4_branch/avidemux:	ADM_userInterfaces/ADM_GTK/ADM_dialogFactory	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_dialogFactory	ADM_userInterfaces/ADM_QT4/ADM_dialogFactory	ADM_userInterfaces/ADM_commonUI ADM_videoFilter
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2007-September/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3578%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%0A%09ADM_userInterfaces/ADM_GTK/ADM_dialogFactory%0A%09ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk%0A%09ADM_userInterfaces/ADM_NONE/ADM_dialogFactory%0A%09ADM_userInterfaces/ADM_QT4/ADM_dialogFactory%0A%09ADM_userInterfaces/ADM_commonUI%20ADM_videoFilter&In-Reply-To=%3C200709041725.l84HPoS3021287%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000851.html">
   <LINK REL="Next"  HREF="000853.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r3578 - in	branches/avidemux_2.4_branch/avidemux:	ADM_userInterfaces/ADM_GTK/ADM_dialogFactory	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_dialogFactory	ADM_userInterfaces/ADM_QT4/ADM_dialogFactory	ADM_userInterfaces/ADM_commonUI ADM_videoFilter</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3578%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%0A%09ADM_userInterfaces/ADM_GTK/ADM_dialogFactory%0A%09ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk%0A%09ADM_userInterfaces/ADM_NONE/ADM_dialogFactory%0A%09ADM_userInterfaces/ADM_QT4/ADM_dialogFactory%0A%09ADM_userInterfaces/ADM_commonUI%20ADM_videoFilter&In-Reply-To=%3C200709041725.l84HPoS3021287%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r3578 - in	branches/avidemux_2.4_branch/avidemux:	ADM_userInterfaces/ADM_GTK/ADM_dialogFactory	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_dialogFactory	ADM_userInterfaces/ADM_QT4/ADM_dialogFactory	ADM_userInterfaces/ADM_commonUI ADM_videoFilter">mean at mail.berlios.de
       </A><BR>
    <I>Tue Sep  4 19:25:50 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000851.html">[Avidemux-svn-commit] r3577 -	branches/avidemux_2.4_branch/avidemux/ADM_script
</A></li>
        <LI>Next message: <A HREF="000853.html">[Avidemux-svn-commit] r3579 -	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#852">[ date ]</a>
              <a href="thread.html#852">[ thread ]</a>
              <a href="subject.html#852">[ subject ]</a>
              <a href="author.html#852">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2007-09-04 19:25:48 +0200 (Tue, 04 Sep 2007)
New Revision: 3578

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_filesel.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_integer.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/TLK_filesel.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/CMakeLists.txt
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_integer.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_filesel.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidComputeAverage.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidParticle.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidThreshold.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidThreshold.h
Log:
[DialogFactory+Fileselector] Chris Mac Gregor : Fix for default suffix + fix for slider

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_filesel.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_filesel.cpp	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_filesel.cpp	2007-09-04 17:25:48 UTC (rev 3578)
@@ -30,9 +30,13 @@
 static void fileRead(void *w,void *p);
 static void dirSel(void *w,void *p);
 
+#include &quot;prefs.h&quot;
 
-diaElemFile::diaElemFile(uint32_t writemode,char **filename,const char *toggleTitle,const char *tip)
-  : diaElem(ELEM_FILE_READ)
+diaElemFile::diaElemFile(uint32_t writemode,char **filename,const char *toggleTitle,
+                         const char * defaultSuffix,const char *tip)
+  : diaElem(ELEM_FILE_READ),
+    defaultSuffix (defaultSuffix)
+
 {
   param=(void *)filename;
   paramTitle=toggleTitle;
@@ -128,8 +132,37 @@
   const char *txt;
   txt =gtk_entry_get_text (GTK_ENTRY (widget));
   
-  if(_write) t=FileSel_SelectWrite(paramTitle,buffer,MAX_SEL,txt);
-      else t= t=FileSel_SelectRead(paramTitle,buffer,MAX_SEL,txt);
+  if(_write)
+  {
+      char newname [1024];
+      if (!*txt &amp;&amp; defaultSuffix)
+      {
+          const char * lastfilename;
+          if (prefs-&gt;get(LASTFILES_FILE1,(ADM_filename **)&amp;lastfilename))
+          {
+              strcpy (newname, lastfilename);
+              char * cptr = newname + strlen (newname);
+              while (cptr &gt; newname)
+              {
+                  if (*cptr == '.')
+                  {
+                      strcpy (cptr + 1, defaultSuffix);
+                      txt = newname;
+                      printf (&quot;Default output filename is %s based on &quot;
+                              &quot;%s + %s\n&quot;,
+                              txt, lastfilename, defaultSuffix);
+                      break;
+                  }
+                  --cptr;
+              }
+          }
+      }
+      t = FileSel_SelectWrite(paramTitle,buffer,MAX_SEL,txt);
+  }
+  else
+  {
+      t = FileSel_SelectRead(paramTitle,buffer,MAX_SEL,txt);
+  }
   if(t)
   {
     char **name=(char **)param;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_integer.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_integer.cpp	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_integer.cpp	2007-09-04 17:25:48 UTC (rev 3578)
@@ -1,6 +1,6 @@
 /***************************************************************************
-  FAC_toggle.cpp
-  Handle dialog factory element : Toggle
+  FAC_integer.cpp
+  Handle dialog factory elements : Integer, Slider, and variations thereupon
   (C) 2006 Mean <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">Fixounet at free.fr</A> 
 ***************************************************************************/
 
@@ -170,12 +170,37 @@
 }
 
 //****************************************************
-template &lt;class T&gt;
+
+template &lt;typename T&gt;
+static
+uint32_t diaElemSliderDigitsDefault (T incr)
+{
+    return 0; // used for int types; a specialization overrides this for float
+}
+
+template &lt;&gt;  // specialization of above...
+uint32_t diaElemSliderDigitsDefault (ELEM_TYPE_FLOAT incr) // ...for float
+{
+    char tmp [32];
+    uint32_t digits = 3;
+    sprintf (tmp, &quot;%.*f&quot;, digits, incr);
+    const char * cptr = tmp + strlen (tmp);
+    while (*--cptr == '0')
+        --digits;
+
+    if (digits &lt; 1)
+        return 1;
+    else
+        return digits;
+}
+
+template &lt;typename T&gt;
 diaElemGenericSlider&lt;T&gt;::diaElemGenericSlider(T *value,const char *toggleTitle, T min,T max,T incr,const char *tip)
     : diaElem(ELEM_SLIDER),
       min (min),
       max (max),
-      incr (incr)
+      incr (incr),
+      digits (diaElemSliderDigitsDefault (incr))
 {
     param = (void *)value;
     paramTitle = toggleTitle;
@@ -183,12 +208,12 @@
     size = 2;
 }
 
-template &lt;class T&gt;
+template &lt;typename T&gt;
 diaElemGenericSlider&lt;T&gt;::~diaElemGenericSlider()
 {
 }
 
-template &lt;class T&gt;
+template &lt;typename T&gt;
 void diaElemGenericSlider&lt;T&gt;::setMe(void *dialog, void *opaque,uint32_t line)
 {
   GtkWidget *label = gtk_label_new_with_mnemonic (paramTitle);
@@ -200,30 +225,45 @@
                     (GtkAttachOptions) (0), 0, 0);
   
   T val=*(T *)param;
-  GtkWidget *widget
-      = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (val, min, max, incr, incr, 0)));
-  gtk_scale_set_value_pos (GTK_SCALE (widget), GTK_POS_LEFT);
-  gtk_scale_set_digits (GTK_SCALE (widget), 0);
+
+  GtkAdjustment * adj = (GtkAdjustment *) gtk_adjustment_new (val, min, max, incr, incr, 0);
+
+  GtkWidget *spinner = gtk_spin_button_new (adj, 1, 0);
+  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON(spinner), TRUE);
+  gtk_spin_button_set_digits  (GTK_SPIN_BUTTON(spinner), digits);
   
-  gtk_widget_show (widget);
+  GtkWidget *slider = gtk_hscale_new (adj);
+  gtk_scale_set_draw_value (GTK_SCALE (slider), FALSE);
+  gtk_scale_set_digits (GTK_SCALE (slider), digits);
   
-  gtk_table_attach (GTK_TABLE (opaque), widget, 0, 2, line+1, line+2,
+  GtkWidget *hbox = gtk_hbox_new (FALSE, 5);
+  gtk_box_pack_start (GTK_BOX (hbox), slider, TRUE, TRUE, 0);
+  gtk_box_pack_start (GTK_BOX (hbox), spinner, FALSE, FALSE, 0);
+
+  gtk_table_attach (GTK_TABLE (opaque), hbox, 0, 2, line+1, line+2,
                     (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
                     (GtkAttachOptions) (0), 0, 0);
   
-  gtk_label_set_mnemonic_widget (GTK_LABEL(label), widget);
+  gtk_label_set_mnemonic_widget (GTK_LABEL(label), hbox);
+  gtk_widget_show (hbox);
+  gtk_widget_show (spinner);
+  gtk_widget_show (slider);
   
-  myWidget=(void *)widget;
+  myWidget=(void *)slider;
   if(readOnly)
-    gtk_widget_set_sensitive(widget,0);
-   if(tip)
-   {
-     GtkTooltips *tooltips= gtk_tooltips_new ();
-      gtk_tooltips_set_tip (tooltips, widget, tip, NULL);
-   }
+  {
+    gtk_widget_set_sensitive(spinner,0);
+    gtk_widget_set_sensitive(slider,0);
+  }
+  if(tip)
+  {
+      GtkTooltips *tooltips= gtk_tooltips_new ();
+      gtk_tooltips_set_tip (tooltips, spinner, tip, NULL);
+      gtk_tooltips_set_tip (tooltips, slider, tip, NULL);
+  }
 }
 
-template &lt;class T&gt;
+template &lt;typename T&gt;
 void diaElemGenericSlider&lt;T&gt;::getMe(void)
 {
   GtkWidget *widget=(GtkWidget *)myWidget;
@@ -235,7 +275,7 @@
   if(*val&gt;max) *val=max;
 }
 
-template &lt;class T&gt;
+template &lt;typename T&gt;
 void diaElemGenericSlider&lt;T&gt;::enable(uint32_t onoff)
 {
   GtkWidget *widget=(GtkWidget *)myWidget;
@@ -244,5 +284,6 @@
 
 template class diaElemGenericSlider &lt;int32_t&gt;;
 template class diaElemGenericSlider &lt;uint32_t&gt;;
+template class diaElemGenericSlider &lt;ELEM_TYPE_FLOAT&gt;;
 
 //EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/TLK_filesel.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/TLK_filesel.cpp	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/TLK_filesel.cpp	2007-09-04 17:25:48 UTC (rev 3578)
@@ -81,33 +81,15 @@
         setFilter(dialog);
         gtk_register_dialog(dialog);
 //	gtk_transient(dialog);
-	if(source)
+	if (source &amp;&amp; *source)
 	{
-		dupe=PathCanonize(source);
-		PathStripName(dupe);
-		if( (dir=opendir(dupe)) )
-			{
-				closedir(dir);
-				gtk_file_chooser_set_filename(GTK_FILE_CHOOSER(dialog),(gchar *)source);
-			}
-		delete [] dupe;
-	
+		gtk_file_chooser_set_filename(GTK_FILE_CHOOSER(dialog),(gchar *)source);
 	}
 	else	//use pref
 	{
 		if( prefs-&gt;get(LASTDIR_READ,(ADM_filename **)&amp;tmpname))
 		{
-			
-	
-			dupe=PathCanonize(tmpname);
-			PathStripName(dupe);
-
-			if( (dir=opendir(dupe)) )
-			{
-				closedir(dir);
-				gtk_file_chooser_set_filename(GTK_FILE_CHOOSER(dialog),(gchar *)dupe);
-			}
-			delete [] dupe;
+			gtk_file_chooser_set_current_folder(GTK_FILE_CHOOSER(dialog),(gchar *)tmpname);
 		}
 	}
 	if(gtk_dialog_run(GTK_DIALOG(dialog))==GTK_RESPONSE_ACCEPT)
@@ -160,7 +142,7 @@
 char *dupe=NULL,*tmpname=NULL;
 DIR *dir=NULL;
 	
-	dialog = gtk_file_chooser_dialog_new (&quot;Open File&quot;,
+	dialog = gtk_file_chooser_dialog_new (&quot;Write to File&quot;,
                                       NULL,
                                       GTK_FILE_CHOOSER_ACTION_SAVE,
                                       GTK_STOCK_CANCEL, GTK_RESPONSE_CANCEL,
@@ -171,16 +153,29 @@
         setFilter(dialog);
         gtk_register_dialog(dialog);
 //	gtk_transient(dialog);
-	if(source)
+	if (source &amp;&amp; *source)
 	{
-		dupe=PathCanonize(source);
-		PathStripName(dupe);
-		if( (dir=opendir(dupe)) )
-			{
-				closedir(dir);
-				gtk_file_chooser_set_filename(GTK_FILE_CHOOSER(dialog),(gchar *)source);
-			}
-		delete [] dupe;
+#if 0
+// well, this is what they say to do, but then you can't easily edit the
+// name...
+
+                // the following sequence is per GTK docs for gtk_file_chooser_set_filename()
+                if (access (source, W_OK) == 0) // if file exists
+                {
+                    gtk_file_chooser_set_filename(GTK_FILE_CHOOSER(dialog),(gchar *)source);
+                    // printf (&quot;FileSel_SelectWrite: existing %s\n&quot;, source);
+                }
+                else // new file
+#endif
+                {
+                    dupe=PathCanonize(source);
+                    PathStripName(dupe);
+                    gtk_file_chooser_set_current_folder(GTK_FILE_CHOOSER(dialog),(gchar *)dupe);
+                    gtk_file_chooser_set_current_name(GTK_FILE_CHOOSER(dialog),
+                                                      (gchar *)(source + strlen(dupe)));
+                    // printf (&quot;FileSel_SelectWrite: folder %s, name %s\n&quot;, dupe, source + strlen(dupe));
+                    delete [] dupe;
+                }
 	
 	}
 	else	//use pref
@@ -188,14 +183,12 @@
 		if( prefs-&gt;get(LASTDIR_WRITE,(ADM_filename **)&amp;tmpname))
 		{
 			
-	
 			dupe=PathCanonize(tmpname);
-			PathStripName(dupe);
 
 			if( (dir=opendir(dupe)) )
 			{
 				closedir(dir);
-				gtk_file_chooser_set_filename(GTK_FILE_CHOOSER(dialog),(gchar *)dupe);
+				gtk_file_chooser_set_current_folder(GTK_FILE_CHOOSER(dialog),(gchar *)tmpname);
 			}
 			delete [] dupe;
 		}

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp	2007-09-04 17:25:48 UTC (rev 3578)
@@ -164,7 +164,8 @@
 { 
 }
 //*****************
-diaElemFile::diaElemFile(uint32_t write,char **filename,const char *toggleTitle,const char *tip)
+diaElemFile::diaElemFile(uint32_t write,char **filename,const char *toggleTitle,
+                         const char *defaultSuffix, const char *tip)
   : diaElem(ELEM_FILE_READ)
 {
  
@@ -393,37 +394,35 @@
 }
 //***
  
- template &lt;class T&gt;
+ template &lt;typename T&gt;
  diaElemGenericSlider&lt;T&gt;::diaElemGenericSlider(T *value,const char *toggleTitle, T min,T max,T incr,const char *tip)
-     : diaElem(ELEM_SLIDER),
-       min (min),
-       max (max),
-       incr (incr)
+     : diaElem(ELEM_SLIDER)
   {
  }
   
- template &lt;class T&gt;
+ template &lt;typename T&gt;
  diaElemGenericSlider&lt;T&gt;::~diaElemGenericSlider()
   {
   }
  
- template &lt;class T&gt;
+ template &lt;typename T&gt;
  void diaElemGenericSlider&lt;T&gt;::setMe(void *dialog, void *opaque,uint32_t line)
   {
   }
  
- template &lt;class T&gt;
+ template &lt;typename T&gt;
  void diaElemGenericSlider&lt;T&gt;::getMe(void)
   {
   }
   
- template &lt;class T&gt;
+ template &lt;typename T&gt;
  void diaElemGenericSlider&lt;T&gt;::enable(uint32_t onoff) 
   {
   }
   
  template class diaElemGenericSlider &lt;int32_t&gt;;
  template class diaElemGenericSlider &lt;uint32_t&gt;;
+ template class diaElemGenericSlider &lt;ELEM_TYPE_FLOAT&gt;;
 //****
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/CMakeLists.txt
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/CMakeLists.txt	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/CMakeLists.txt	2007-09-04 17:25:48 UTC (rev 3578)
@@ -12,6 +12,7 @@
 menu
 toggle
 threadCount
+slider
 )
 
 SET(${ADM_LIB}_SRCS

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_integer.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_integer.cpp	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_integer.cpp	2007-09-04 17:25:48 UTC (rev 3578)
@@ -144,76 +144,6 @@
     box-&gt;setDisabled(1);
 }
 //********************************************
-#define MYSLIDERTYPE  QSlider
 
-
-template &lt;class T&gt;
-diaElemGenericSlider&lt;T&gt;::diaElemGenericSlider(T *value,const char *toggleTitle, T min,T max,T incr,const char *tip)
-  : diaElem(ELEM_SLIDER)
-{
-  param=(void *)value;
-  paramTitle=shortkey(toggleTitle);
-  this-&gt;min=min;
-  this-&gt;max=max;
-  this-&gt;incr=incr;
-  this-&gt;tip=tip;
-  
- }
- 
-
-template &lt;class T&gt;
-diaElemGenericSlider&lt;T&gt;::~diaElemGenericSlider()
-{ 
-  if(paramTitle)
-    delete paramTitle;
-}
-template &lt;class T&gt;
-void diaElemGenericSlider&lt;T&gt;::setMe(void *dialog, void *opaque,uint32_t line)
-{
-  MYSLIDERTYPE *box=new MYSLIDERTYPE((QWidget *)dialog);
-  box-&gt;setOrientation ( Qt::Horizontal );
-  
-  QGridLayout *layout=(QGridLayout*) opaque;
- myWidget=(void *)box; 
-   
- box-&gt;setMinimum(min);
- box-&gt;setMaximum(max);
- box-&gt;setValue(*(T *)param);
-#ifdef ADM_TEST_ADM_SLIDER
-  box-&gt;setNbFrames(max); 
-  box-&gt;setA(max/3);
-  box-&gt;setB((max*2)/3);
-#endif
- box-&gt;show();
- 
- QLabel *text=new QLabel( this-&gt;paramTitle,(QWidget *)dialog);
- text-&gt;setBuddy(box);
- layout-&gt;addWidget(text,line,0);
- layout-&gt;addWidget(box,line,1);
-}
-template &lt;class T&gt;
-void diaElemGenericSlider&lt;T&gt;::getMe(void)
-{
- MYSLIDERTYPE *box=(MYSLIDERTYPE *)myWidget;
- T val=box-&gt;value();
- if(val&lt;min) val=min;
- if(val&gt;max) val=max;
- *(T *)param=val;
-}
-
-template &lt;class T&gt;
-void diaElemGenericSlider&lt;T&gt;::enable(uint32_t onoff) 
-{
-  MYSLIDERTYPE *box=(MYSLIDERTYPE *)myWidget;
-  ADM_assert(box);
-  if(onoff)
-    box-&gt;setEnabled(1);
-  else
-    box-&gt;setDisabled(1);
-}
-
-template class diaElemGenericSlider &lt;int32_t&gt;;
-template class diaElemGenericSlider &lt;uint32_t&gt;;
-
 //EOF
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-09-04 17:25:48 UTC (rev 3578)
@@ -6,6 +6,7 @@
 libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp AT_toggle.cpp FAC_integer.cpp AT_menu.cpp FAC_float.cpp \
 AT_filesel.cpp AT_bitrate.cpp AT_threadCount.cpp \
 AT_button.cpp \
+AT_slider.cpp \
 FAC_bar.cpp FAC_readOnlyText.cpp FAC_notch.cpp FAC_frame.cpp FAC_hex.cpp FAC_matrix.cpp
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_filesel.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_filesel.cpp	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_filesel.cpp	2007-09-04 17:25:48 UTC (rev 3578)
@@ -1,6 +1,6 @@
 /***************************************************************************
-  FAC_toggle.cpp
-  Handle dialog factory element : Toggle
+  FAC_filesel.cpp
+  Handle dialog factory element : Filesel
   (C) 2006 Mean <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">Fixounet at free.fr</A> 
 ***************************************************************************/
 
@@ -29,6 +29,7 @@
 #include &lt;QDialogButtonBox&gt;
 
 #include &quot;default.h&quot;
+#include &quot;prefs.h&quot;
 #include &quot;ADM_commonUI/DIA_factory.h&quot;
 #include &quot;ADM_assert.h&quot;
 #include &quot;ADM_toolkit/filesel.h&quot;
@@ -62,6 +63,28 @@
                 r=FileSel_SelectRead(_(&quot;Select File to Read&quot;),buffer,MAX_SEL,txt);
                 break;
             case ADM_FILEMODE_WRITE:
+                if (defaultSuffix)
+                {
+                    const char * lastfilename;
+                    if (prefs-&gt;get(LASTFILES_FILE1,(ADM_filename **)&amp;lastfilename))
+                    {
+                        strcpy (buffer, lastfilename);
+                        char * cptr = buffer + strlen (buffer);
+                        while (cptr &gt; buffer)
+                        {
+                            if (*cptr == '.')
+                            {
+                                strcpy (cptr + 1, defaultSuffix);
+                                txt = buffer;
+                                printf (&quot;Default output filename is %s based on &quot;
+                                        &quot;%s + %s\n&quot;,
+                                        txt, lastfilename, defaultSuffix);
+                                break;
+                            }
+                            --cptr;
+                        }
+                    }
+                }
                 r=FileSel_SelectWrite(_(&quot;Select File to Write&quot;),buffer,MAX_SEL,txt);
                 break;
 
@@ -80,8 +103,11 @@
         QDialogButtonBox *button;
         QLabel *text;
         ADM_fileMode fileMode;
+        const char * defaultSuffix;
             
-        ADM_Qfilesel(QWidget *z,const char *title,char *entry,QGridLayout *layout,int line, ADM_fileMode mode) : QWidget(z) 
+        ADM_Qfilesel(QWidget *z,const char *title,char *entry,QGridLayout *layout,int line, ADM_fileMode mode, const char * defaultSuffix)
+            : QWidget(z),
+              defaultSuffix (defaultSuffix)
         {
           
           fileMode=mode;
@@ -113,8 +139,10 @@
 };
 
 
-diaElemFile::diaElemFile(uint32_t writemode,char **filename,const char *toggleTitle,const char *tip)
-  : diaElem(ELEM_FILE_READ)
+diaElemFile::diaElemFile(uint32_t writemode,char **filename,const char *toggleTitle,
+                         const char *defaultSuffix,const char *tip)
+  : diaElem(ELEM_FILE_READ),
+    defaultSuffix (defaultSuffix)
 {
   param=(void *)filename;
   paramTitle=shortkey(toggleTitle);
@@ -132,9 +160,9 @@
  QGridLayout *layout=(QGridLayout*) opaque;
  ADM_Qfilesel *fs;
   if(_write)
-      fs=new ADM_Qfilesel((QWidget *)dialog,paramTitle,*(char **)param,layout, line,ADM_FILEMODE_WRITE);
+      fs=new ADM_Qfilesel((QWidget *)dialog,paramTitle,*(char **)param,layout, line,ADM_FILEMODE_WRITE, defaultSuffix);
   else
-      fs=new ADM_Qfilesel((QWidget *)dialog,paramTitle,*(char **)param,layout, line,ADM_FILEMODE_READ);
+      fs=new ADM_Qfilesel((QWidget *)dialog,paramTitle,*(char **)param,layout, line,ADM_FILEMODE_READ, 0);
   myWidget=(void *)fs; 
 }
 void diaElemFile::getMe(void)
@@ -168,7 +196,7 @@
 {
  QGridLayout *layout=(QGridLayout*) opaque;
   
-  ADM_Qfilesel *fs=new ADM_Qfilesel((QWidget *)dialog,paramTitle,*(char **)param,layout, line,ADM_FILEMODE_DIR);
+  ADM_Qfilesel *fs=new ADM_Qfilesel((QWidget *)dialog,paramTitle,*(char **)param,layout, line,ADM_FILEMODE_DIR, 0);
   myWidget=(void *)fs; 
 }
 void diaElemDirSelect::getMe(void) 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-09-04 17:25:48 UTC (rev 3578)
@@ -44,6 +44,9 @@
   ELEM_MAX=ELEM_COUNT-1
 }elemEnum;
 typedef void ADM_FAC_CALLBACK(void *cookie);
+
+#define ELEM_TYPE_FLOAT float
+
 /*********************************************/
 class diaElem
 {
@@ -107,22 +110,26 @@
   void      enable(uint32_t onoff) ;
 };
 /************************************/
-template &lt;class T&gt;
+template &lt;typename T&gt;
 class diaElemGenericSlider : public diaElem
 {
   protected:
     
     T min,max,incr;
+    uint32_t digits;
 public:
     diaElemGenericSlider(T *value,const char *toggleTitle, T min,T max,T incr = 1, const char *tip=NULL);
   virtual   ~diaElemGenericSlider() ;
   void      setMe(void *dialog, void *opaque,uint32_t line);
   void      getMe(void);
   void      enable(uint32_t onoff) ;
+  void      setDigits(uint32_t digits) { this-&gt;digits = digits; }
 };
 typedef diaElemGenericSlider &lt;int32_t&gt; diaElemSlider;
 /* Same but unsigned */
 typedef diaElemGenericSlider &lt;uint32_t&gt; diaElemUSlider;
+/* Same but float */
+typedef diaElemGenericSlider &lt;ELEM_TYPE_FLOAT&gt; diaElemFSlider;
 
 /*********************************************/
 class diaElemToggle : public diaElem
@@ -208,7 +215,6 @@
 };
 
 /*********************************************/
-#define ELEM_TYPE_FLOAT float
 class diaElemFloat : public diaElem
 {
 
@@ -322,9 +328,12 @@
 class diaElemFile : public diaElem
 {
 
+protected:
+    const char * defaultSuffix;
 public:
   
-  diaElemFile(uint32_t writeMode,char **filename,const char *toggleTitle,const char *tip=NULL);
+  diaElemFile(uint32_t writeMode,char **filename,const char *toggleTitle,
+              const char *defaultSuffix = 0,const char *tip=NULL);
   virtual ~diaElemFile() ;
   void setMe(void *dialog, void *opaque,uint32_t line);
   void getMe(void);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidComputeAverage.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidComputeAverage.cpp	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidComputeAverage.cpp	2007-09-04 17:25:48 UTC (rev 3578)
@@ -191,7 +191,8 @@
          _(&quot;_End Frame (last frame # to include), -1 = last:&quot;),
          -1000000, 0x7fffffff);
     diaElemFile output_file
-        (1, const_cast&lt;char **&gt;(&amp;(_param-&gt;output_file)), _(&quot;_Output File:&quot;));
+        (1, const_cast&lt;char **&gt;(&amp;(_param-&gt;output_file)),
+         _(&quot;_Output File:&quot;), &quot;avg&quot;);
     diaElemSlider bias
         (&amp;(_param-&gt;bias),
          _(&quot;_Bias (only for display; use 0 for &quot;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidParticle.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidParticle.cpp	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidParticle.cpp	2007-09-04 17:25:48 UTC (rev 3578)
@@ -156,7 +156,8 @@
          sizeof (tOutputFmt) / sizeof (diaMenuEntry), tOutputFmt);
 
     diaElemFile output_file
-        (1, const_cast&lt;char **&gt;(&amp;(_param-&gt;output_file)), _(&quot;_Output File:&quot;));
+        (1, const_cast&lt;char **&gt;(&amp;(_param-&gt;output_file)),
+         _(&quot;_Output File:&quot;), &quot;pts&quot;);
 
     diaElemUInteger camera_number
         (&amp;(_param-&gt;camera_number), _(&quot;_Camera number:&quot;), 1, 0x7fffffff);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidThreshold.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidThreshold.cpp	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidThreshold.cpp	2007-09-04 17:25:48 UTC (rev 3578)
@@ -40,7 +40,7 @@
 
 // #define THRESHOLD_HISTO 1
 
-static FILTER_PARAM thresholdParam={3,{&quot;min&quot;, &quot;max&quot;, &quot;debug&quot;}};
+static FILTER_PARAM thresholdParam={4,{&quot;min&quot;, &quot;max&quot;, &quot;in_range_is_white&quot;, &quot;debug&quot;}};
 
 SCRIPT_CREATE(threshold_script,ADMVideoThreshold,thresholdParam);
 
@@ -60,25 +60,67 @@
     {
         GET(min);
         GET(max);
+        GET(in_range_is_white);
         GET(debug);
     }
     else
     {
         _param-&gt;min = 100;
         _param-&gt;max = 200;
+        _param-&gt;in_range_is_white = 1;
         _param-&gt;debug = 0;
     }
+
+    computeLookupTable();
 }
 
+void ADMVideoThreshold::computeLookupTable ()
+{
+    if (_param-&gt;min &gt; _param-&gt;max)
+    {
+        uint32_t tmp = _param-&gt;min;
+        _param-&gt;min = _param-&gt;max;
+        _param-&gt;max = tmp;
+        _param-&gt;in_range_is_white = !_param-&gt;in_range_is_white;
+    }
+
+    uint32_t min = _param-&gt;min;
+    uint32_t max = _param-&gt;max;
+    ADM_assert (min &lt;= max);
+
+    uint8_t in_range_value;
+    uint8_t out_of_range_value;
+
+    if (_param-&gt;in_range_is_white)
+    {
+        in_range_value = 255;
+        out_of_range_value = 0;
+    }
+    else
+    {
+        in_range_value = 0;
+        out_of_range_value = 255;
+    }
+
+    for (uint32_t i = 0; i &lt;= 255; i++)
+    {
+        if (i &lt; min || i &gt; max)
+            lookup_table [i] = out_of_range_value;
+        else
+            lookup_table [i] = in_range_value;
+    }
+}
+
 uint8_t	ADMVideoThreshold::getCoupledConf( CONFcouple **couples)
 {
 
     ADM_assert(_param);
-    *couples=new CONFcouple(3);
+    *couples = new CONFcouple(thresholdParam.nb);
 
 #define CSET(x)  (*couples)-&gt;setCouple((char *)#x,(_param-&gt;x))
     CSET(min);
     CSET(max);
+    CSET(in_range_is_white);
     CSET(debug);
 
     return 1;
@@ -89,13 +131,30 @@
 {
     UNUSED_ARG(in);
 
-    diaElemUSlider minslide(&amp;(_param-&gt;min), _(&quot;Mi_nimum value to be non-zero in output:&quot;), 0, 255);
-    diaElemUSlider maxslide(&amp;(_param-&gt;max), _(&quot;Ma_ximum value to be non-zero in output:&quot;), 0, 255);
+    diaElemUSlider minslide(&amp;(_param-&gt;min), _(&quot;Mi_nimum value to be in-range:&quot;), 0, 255);
+    diaElemUSlider maxslide(&amp;(_param-&gt;max), _(&quot;Ma_ximum value to be in-range:&quot;), 0, 255);
+
+    diaMenuEntry tInRangeIsWhite [] = {
+        { 1, _(&quot;In-range values go white, out-of-range go black&quot;), NULL },
+        { 0, _(&quot;In-range values go black, out-of-range go white&quot;), NULL },
+    };
+
+    diaElemMenu in_range_is_white
+        (&amp;(_param-&gt;in_range_is_white),
+         _(&quot;Output values:&quot;),
+         sizeof (tInRangeIsWhite) / sizeof (diaMenuEntry), tInRangeIsWhite);
+
     diaElemUInteger debug(&amp;(_param-&gt;debug), _(&quot;_Debugging settings (bits):&quot;),
                           0, 0x7fffffff);
-    diaElem * elems[] = { &amp;minslide, &amp;maxslide, &amp;debug };
+    diaElem * elems[] = { &amp;minslide, &amp;maxslide, &amp;in_range_is_white, &amp;debug };
 
     uint8_t ret = diaFactoryRun(&quot;Threshold&quot;, sizeof (elems) / sizeof (diaElem *), elems);
+
+    if (ret) // 0 = cancel
+    {
+        computeLookupTable();
+    }
+
     return ret;
 }
 
@@ -107,15 +166,22 @@
     _uncompressed=NULL;
 }
 
-char	*ADMVideoThreshold::printConf( void) 
+char *ADMVideoThreshold::printConf (void) 
 {
-    static char conf[100];
+    const int CONF_LEN = 100;
+    static char conf[CONF_LEN];
+    char * cptr = conf;
+    cptr += snprintf (conf, CONF_LEN, &quot;Threshold: In-range values (%u - %u) &quot;
+                      &quot;go %s, others %s&quot;,
+                      _param-&gt;min, _param-&gt;max,
+                      _param-&gt;in_range_is_white ? &quot;white&quot; : &quot;black&quot;,
+                      _param-&gt;in_range_is_white ? &quot;black&quot; : &quot;white&quot;);
+    if (_param-&gt;debug)
+        snprintf (cptr, CONF_LEN - (cptr - conf), &quot;; debug=0x%x&quot;, _param-&gt;debug);
 
-    sprintf(conf,&quot;Threshold: Min = %3u  Max = %3u  Debug=0x%06x&quot;,
-            _param-&gt;min, _param-&gt;max, _param-&gt;debug);
     return conf;
-	
 }
+
 uint8_t ADMVideoThreshold::getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
           			ADMImage *data,uint32_t *flags)
 {
@@ -152,25 +218,6 @@
     memset (histo_after, 0, 256 * sizeof (uint32_t));
 #endif
 
-    uint32_t min = _param-&gt;min;
-    uint32_t max = _param-&gt;max;
-
-    uint8_t in_range_value;
-    uint8_t out_of_range_value;
-    if (min &lt;= max)
-    {
-        in_range_value = 255;
-        out_of_range_value = 0;
-    }
-    else
-    {
-        in_range_value = 0;
-        out_of_range_value = 255;
-        uint32_t tmp = min;
-        min = max;
-        max = tmp;
-    }
-
 #ifdef DUMP_FRAME_DATA
     FILE * fp = fopen (&quot;/tmp/framedump.new.out&quot;, &quot;a&quot;);
     ADM_assert(fp);
@@ -188,10 +235,7 @@
         fprintf (fp, &quot;%x\n&quot;, curr);
 #endif
 
-        if (curr &lt; min || curr &gt; max)
-            *--destp = out_of_range_value;
-        else
-            *--destp = in_range_value;
+        *--destp = lookup_table [curr];
 
 #ifdef THRESHOLD_HISTO
         histo_after [*destp]++;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidThreshold.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidThreshold.h	2007-09-03 18:33:42 UTC (rev 3577)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidThreshold.h	2007-09-04 17:25:48 UTC (rev 3578)
@@ -22,6 +22,7 @@
 
     uint32_t min;
     uint32_t max;
+    uint32_t in_range_is_white;
     uint32_t debug;
 
 } THRESHOLD_PARAM;
@@ -32,6 +33,7 @@
  protected:
     	
      THRESHOLD_PARAM *  _param;
+     uint8_t lookup_table [256];
 
  public:
  		
@@ -46,6 +48,6 @@
      virtual uint8_t 	configure( AVDMGenericVideoStream *instream);
      virtual char 		   *printConf(void);
      virtual uint8_t 	getCoupledConf( CONFcouple **couples);
-							
+     void computeLookupTable();
  };
 #endif


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000851.html">[Avidemux-svn-commit] r3577 -	branches/avidemux_2.4_branch/avidemux/ADM_script
</A></li>
	<LI>Next message: <A HREF="000853.html">[Avidemux-svn-commit] r3579 -	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#852">[ date ]</a>
              <a href="thread.html#852">[ thread ]</a>
              <a href="subject.html#852">[ subject ]</a>
              <a href="author.html#852">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
