From mean at mail.berlios.de  Thu Feb  1 20:44:23 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 1 Feb 2007 20:44:23 +0100
Subject: [Avidemux-svn-commit] r2788 - in
	branches/avidemux_2.4_branch/avidemux: . ADM_editor
	ADM_filter ADM_userInterfaces/ADM_GTK/ADM_dialog
	ADM_userInterfaces/ADM_GTK/ADM_gui2
	ADM_userInterfaces/ADM_NONE/ADM_gui2
	ADM_userInterfaces/ADM_QT4/ADM_gui ADM_userInterfaces/ADM_commonUI
Message-ID: <200702011944.l11JiNp3002639@sheep.berlios.de>

Author: mean
Date: 2007-02-01 20:44:22 +0100 (Thu, 01 Feb 2007)
New Revision: 2788

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.hxx
   branches/avidemux_2.4_branch/avidemux/ADM_filter/filter.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_preview.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_menumap.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/gui_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_ui.h
   branches/avidemux_2.4_branch/avidemux/gui_navigate.cpp
   branches/avidemux_2.4_branch/avidemux/prototype.h
Log:
new preview stuff, not 100% done

Modified: branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.cpp	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.cpp	2007-02-01 19:44:22 UTC (rev 2788)
@@ -94,7 +94,6 @@
   _audioSample=0;
   _lastseg = 99;
   _lastframe = 99;
-  _cached = 1;
   _nb_clipboard=0;
   _haveMarkers=0; // only edl have markers
   // Initialize a default postprocessing (dummy)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.hxx
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.hxx	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.hxx	2007-02-01 19:44:22 UTC (rev 2788)
@@ -125,7 +125,6 @@
   					uint32_t  _audioseg;
 					int64_t  _audioSample;
   					uint32_t  _audiooffset;
-       					uint8_t    _cached;
 					uint8_t	   _haveMarkers; // used for load/save edl
 
        					uint32_t _lastseg,_lastframe,_lastlen;
@@ -159,9 +158,6 @@
                                                 uint8_t hasVBRVideos(void);
                                                 uint8_t addSegment(uint32_t source,uint32_t start, uint32_t nb);
                                                 uint8_t deleteAllSegments(void);
-  						uint8_t	activateCache( void ){ _cached=1;_lastseg=0xffffff;return 1;}
-						uint8_t	flushCache( void ){ _lastseg=0xffffff;return 1;}
-						uint8_t	desactivateCache( void ){ _cached=0;return 1;}
   						uint8_t 	getExtraHeaderData(uint32_t *len, uint8_t **data);
                                                 uint32_t getPARWidth(void);
                                                 uint32_t getPARHeight(void);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_filter/filter.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_filter/filter.cpp	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_filter/filter.cpp	2007-02-01 19:44:22 UTC (rev 2788)
@@ -29,14 +29,13 @@
 #include "ADM_video/ADM_genvideo.hxx"
 #include "ADM_filter/video_filters.h"
 #include "ADM_video/ADM_vidPartial.h"
-#include "avi_vars.h"
 
+
 #include "ADM_osSupport/ADM_debugID.h"
 #define MODULE_NAME MODULE_PREVIEW
 #include "ADM_osSupport/ADM_debug.h"
 #include "ADM_osSupport/ADM_quota.h"
 //
-void updateVideoFilters( void );
 // exported vars
 uint32_t nb_video_filter=0;
 uint32_t nb_active_filter=0;
@@ -49,10 +48,12 @@
 extern AVDMGenericVideoStream *filterCreateFromTag(VF_FILTERS tag,CONFcouple *conf, AVDMGenericVideoStream *in) ;
 extern char *ADM_escape(const ADM_filename *incoming);
 //
-static   AVDMGenericVideoStream *preview=NULL;
+
+static  void updateVideoFilters(void);
+
 // Ugly should be dynamically allocated
 #warning HARDCODEC IMAGE SIZE
-static ADMImage *unpackd;
+
 // dummy constructor used to register the filter
 //____________________________________
 AVDMVideo_FilterDec::AVDMVideo_FilterDec(char *name,
@@ -75,7 +76,6 @@
              videofilters[i].filter=NULL;  		
 	}
    nb_active_filter=0;
-   preview=NULL;
 }
 void filterListAll( void )
 {
@@ -168,7 +168,6 @@
   	if(nb_active_filter==0)
   		{
   		 		nb_active_filter=1;
-  		 		preview=videofilters[0].filter=  new AVDMVideoStreamNull(video_body,0,info.nb_frames);
 				aprintf("--preview filter 0\n");
 				return videofilters[  nb_active_filter-1].filter;
   		}
@@ -243,7 +242,6 @@
   		if(nb_active_filter<=1)
   		{
   		 	nb_active_filter=1;
-			preview=videofilters[0].filter;
 			aprintf("--preview filter %d\n",nb_active_filter-1);
   		 	return;
   		}
@@ -261,7 +259,6 @@
 
                           delete old;
             	}
-		preview=videofilters[nb_active_filter-1].filter;
 		aprintf("--preview filter %d\n",nb_active_filter-1);
 }
 //
@@ -329,61 +326,7 @@
 
 /*---------------------------------------*/	 
 
-/* if refresh=1 we use the current full filter list
-	else we rebuild a new one */
-void 	editorReignitPreview( void )
-{
-		aprintf("--killing\n");
-            GUI_PreviewEnd();
 
-	    	getFirstVideoFilter();
-	   
-	    preview=videofilters[  nb_active_filter-1].filter;
-	    aprintf("--spawning\n");
-	    if(unpackd)
-	    {
-	    	delete unpackd;
-		unpackd=NULL;		
-	    }
-	    unpackd=new ADMImage(preview->getInfo()->width,preview->getInfo()->height);
-            GUI_PreviewInit(preview->getInfo()->width,preview->getInfo()->height,0);
-}
-
-
-void editorKillPreview( void )
-{
-      GUI_PreviewEnd();
-      if(unpackd)
-      	delete unpackd;
-      unpackd=NULL;
-}
-
-
-
-
-void editorUpdatePreview(uint32_t framenum)
-{
-//
-//
-//
-	uint32_t fl,len;	
- 	ADM_assert(preview);
-	ADM_assert(unpackd);
-
-  if( GUI_StillAlive())
-  {
-  		aprintf("Preview: Ask for frame %lu\n",framenum);
-		if(framenum<=preview->getInfo()->nb_frames-1)
-		{
-			preview->getFrameNumberNoAlloc(framenum,&len,unpackd,&fl);
-			GUI_PreviewUpdate(unpackd->data);
-		}
-  }
-
-//   virtual uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-//          																				uint8_t *data,uint32_t *flags)=0;
-
-}
 //______________________________________________________
 // Check and build a confCouple from the args
 // the filter_param arg is a template for that filter

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_preview.cpp	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_preview.cpp	2007-02-01 19:44:22 UTC (rev 2788)
@@ -61,7 +61,6 @@
 int 			lock;
 uint8_t		needDestroy=0;
 static int      needResponse=0;
-extern void UI_setPreviewToggleStatus(uint8_t s);
 static ColYuvRgb    rgbConv(100,100);
 
 
@@ -103,7 +102,7 @@
 // It is a independant window, so we cannot use gtk_dialog_run
 //
 //*************************************************************
-uint8_t GUI_StillAlive( void )
+uint8_t GUI_PreviewStillAlive( void )
 {
  	if(dialog==NULL) return 0;
   	return 1;
@@ -242,8 +241,6 @@
 		//printf(">\n");
 		needDestroy=0;
     		GUI_PreviewEnd();
-		//printf("<\n");
-       		UI_setPreviewToggleStatus( 0);
                 printf("Destroyed\n");
                 
     }

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2007-02-01 19:44:22 UTC (rev 2788)
@@ -66,8 +66,6 @@
 static GtkWidget *guiCurTime=NULL;
 static GtkWidget *guiTotalTime=NULL;
 
-static GtkWidget *guiPreviewToggle=NULL;
-static GtkWidget *guiOutputToggle=NULL;
 static GtkWidget *guiAudioToggle=NULL;
 static GtkWidget *guiVideoToggle=NULL;
 static GdkCursor *guiCursorBusy=NULL;
@@ -86,6 +84,7 @@
 
 static void on_audio_change(void);
 static void on_video_change(void);
+static void on_preview_change(void);
 static int update_ui=0;
 
 static void GUI_initCustom(void);
@@ -96,6 +95,7 @@
 #define AUDIO_WIDGET "comboboxAudio"
 #define VIDEO_WIDGET "comboboxVideo"
 #define FORMAT_WIDGET "comboboxFormat"
+#define PREVIEW_WIDGET "comboboxPreview"
 //
 enum 
 {
@@ -117,7 +117,14 @@
 };
 // CYB 2005.02.22: DND (END)
 
-
+static char *previewText[]=
+{
+    "Input",
+    "Output",
+    "Side",
+    "Top",
+    "Separate"
+};
 static void DNDDataReceived( GtkWidget *widget, GdkDragContext *dc,
                              gint x, gint y, GtkSelectionData *selection_data, guint info, guint t);
 
@@ -191,9 +198,6 @@
 	{"buttonGotoB"			,"clicked"		,ACT_GotoMarkB},	
 	{"toolbuttonCalc"		,"clicked"		,ACT_Bitrate},	
 
-	{"toggletoolbuttonPreview"	,"toggled"		,ACT_PreviewToggle},
-	{"toggletoolbuttonOutput"      ,"toggled"		,ACT_OuputToggle},
-
 	{"boxCurFrame"			,"editing_done"		,ACT_JumpToFrame},
 	{"boxCurFrame"			,"activate"		,ACT_JumpToFrame},
 	{"boxCurTime"			,"editing_done"		,ACT_TimeChanged},
@@ -265,10 +269,10 @@
 	
 	ADM_LOOKUP(guiCurTime,boxCurTime);
 	ADM_LOOKUP(guiTotalTime,labelTotalTime);
-
+#if 0
 	ADM_LOOKUP(guiPreviewToggle,toggletoolbuttonPreview);
 	ADM_LOOKUP(guiOutputToggle,toggletoolbuttonOutput);
-#if 0
+
 	ADM_LOOKUP(guiAudioToggle,togglebuttonAudio);
 	ADM_LOOKUP(guiVideoToggle,togglebuttonVideo);
 #endif
@@ -391,6 +395,17 @@
                 }
         gtk_combo_box_set_active(combo_box,0);
 	on_audio_change();
+        
+        /* File in preview mode combobox */
+
+                combo_box=GTK_COMBO_BOX(lookup_widget(guiRootWindow,PREVIEW_WIDGET));
+                gtk_combo_box_remove_text(combo_box,0);
+                for(uint32_t i=0;i<sizeof(previewText)/sizeof(char*);i++)
+                {
+                        name=previewText[i];
+                        gtk_combo_box_append_text      (combo_box,_(name));	
+                }
+        gtk_combo_box_set_active(combo_box,0);
         // Format
                  gtk_combo_box_set_active(GTK_COMBO_BOX(lookup_widget(guiRootWindow,FORMAT_WIDGET)),0);
 
@@ -401,6 +416,9 @@
         gtk_signal_connect(GTK_OBJECT(lookup_widget(guiRootWindow,AUDIO_WIDGET)), "changed",
                        GTK_SIGNAL_FUNC(on_audio_change),
                        NULL);
+        gtk_signal_connect(GTK_OBJECT(lookup_widget(guiRootWindow,PREVIEW_WIDGET)), "changed",
+                       GTK_SIGNAL_FUNC(on_preview_change),
+                       NULL);
         
         // Add initial recent files
         UI_updateRecentMenu(  );
@@ -679,63 +697,7 @@
 		sprintf(string," %06lu",b);
         	gtk_label_set_text(GTK_LABEL(guiMarkB),string);
 }
-///
-///	Return status of preview button toggle
-///	1-> Activated
-/// 	0-> deActivated
 
-uint8_t UI_getPreviewToggleStatus( void )
-{                         //gtk_toggle_button_get_active
-
-	if(TRUE==gtk_toggle_tool_button_get_active(GTK_TOGGLE_TOOL_BUTTON(guiPreviewToggle))  )
- 		return 1;
-   	else
-    	return 0;
-}
-///
-///	Update the preview button toggle
-///
-uint8_t UI_setPreviewToggleStatus( uint8_t status )
-{
-gint b;
-        update_ui=1;
-	 if(status) b=TRUE;
-  	else			b=FALSE;
-     gtk_toggle_tool_button_set_active (GTK_TOGGLE_TOOL_BUTTON(guiPreviewToggle),b);
-        // Update checkbox
-     gtk_check_menu_item_set_active(GTK_CHECK_MENU_ITEM(WOD(preview1)),status);
-        update_ui=0;
-
-}
-///
-///     Return status of preview button toggle
-///     1-> Activated
-///     0-> deActivated
-
-uint8_t UI_getOutputToggleStatus( void )
-{                         //gtk_toggle_button_get_active
-
-        if(TRUE==gtk_toggle_tool_button_get_active(GTK_TOGGLE_TOOL_BUTTON(guiOutputToggle))  )
-                return 1;
-        else
-        return 0;
-}
-///
-///     Update the preview button toggle
-///
-uint8_t UI_setOutputToggleStatus( uint8_t status )
-{
-gint b;
-        update_ui=1;
-         if(status) b=TRUE;
-        else                    b=FALSE;
-     gtk_toggle_tool_button_set_active (GTK_TOGGLE_TOOL_BUTTON(guiOutputToggle),b);
-        // Update checkbox
-     gtk_check_menu_item_set_active(GTK_CHECK_MENU_ITEM(WOD(display_output1)),status);
-        update_ui=0;
-
-}
-
 /**
 	Set/unset the toggle button audio process
 */
@@ -867,6 +829,27 @@
         HandleAction(ACT_AudioCodecChanged);
 
 }
+void on_preview_change(void)
+{
+int enable;
+       if(update_ui) return;
+        HandleAction(ACT_PreviewChanged);
+
+}
+
+int  UI_getCurrentPreview(void)
+ {
+       
+        return gtk_combo_box_get_active(GTK_COMBO_BOX(lookup_widget(guiRootWindow,PREVIEW_WIDGET)));
+ 
+ }
+void   UI_setCurrentPreview(int ne)
+ {
+       
+        gtk_combo_box_set_active(GTK_COMBO_BOX(lookup_widget(guiRootWindow,PREVIEW_WIDGET)),ne);
+ 
+ }
+
  int 	UI_getCurrentACodec(void)
  {
         //return getRangeInMenu(lookup_widget(guiRootWindow,AUDIO_WIDGET));

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp	2007-02-01 19:44:22 UTC (rev 2788)
@@ -14,13 +14,13 @@
 
 #include <gdk/gdkkeysyms.h>
 #include <gtk/gtk.h>
-/*
+#if 0
 #include "callbacks.h"
 #include "interface.h"
 #include "support.h"
-*/
-#include "ADM_toolkit_gtk/ADM_gladeSupport.h"
-
+#else
+#include "../ADM_toolkit_gtk/ADM_gladeSupport.h"
+#endif
 #define GLADE_HOOKUP_OBJECT(component,widget,name) \
   g_object_set_data_full (G_OBJECT (component), name, \
     gtk_widget_ref (widget), (GDestroyNotify) gtk_widget_unref)
@@ -176,8 +176,8 @@
   GtkWidget *tmp_image;
   GtkWidget *toolbuttonCalc;
   GtkWidget *separatortoolitem2;
-  GtkWidget *toggletoolbuttonPreview;
-  GtkWidget *toggletoolbuttonOutput;
+  GtkWidget *toolitem12;
+  GtkWidget *comboboxPreview;
   GtkWidget *vbox10;
   GtkWidget *hbox14;
   GtkWidget *alignment19;
@@ -964,23 +964,13 @@
   gtk_widget_show (separatortoolitem2);
   gtk_container_add (GTK_CONTAINER (toolbar2), separatortoolitem2);
 
-  toggletoolbuttonPreview = (GtkWidget*) gtk_toggle_tool_button_new ();
-  gtk_tool_button_set_label (GTK_TOOL_BUTTON (toggletoolbuttonPreview), _("Preview"));
-  tmp_image = create_pixmap (mainWindow, "preview.png");
-  gtk_widget_show (tmp_image);
-  gtk_tool_button_set_icon_widget (GTK_TOOL_BUTTON (toggletoolbuttonPreview), tmp_image);
-  gtk_widget_show (toggletoolbuttonPreview);
-  gtk_container_add (GTK_CONTAINER (toolbar2), toggletoolbuttonPreview);
-  gtk_tool_item_set_tooltip (GTK_TOOL_ITEM (toggletoolbuttonPreview), tooltips, _("Preview filtered video in a new window"), NULL);
+  toolitem12 = (GtkWidget*) gtk_tool_item_new ();
+  gtk_widget_show (toolitem12);
+  gtk_container_add (GTK_CONTAINER (toolbar2), toolitem12);
 
-  toggletoolbuttonOutput = (GtkWidget*) gtk_toggle_tool_button_new ();
-  gtk_tool_button_set_label (GTK_TOOL_BUTTON (toggletoolbuttonOutput), _("Output"));
-  tmp_image = create_pixmap (mainWindow, "output.png");
-  gtk_widget_show (tmp_image);
-  gtk_tool_button_set_icon_widget (GTK_TOOL_BUTTON (toggletoolbuttonOutput), tmp_image);
-  gtk_widget_show (toggletoolbuttonOutput);
-  gtk_container_add (GTK_CONTAINER (toolbar2), toggletoolbuttonOutput);
-  gtk_tool_item_set_tooltip (GTK_TOOL_ITEM (toggletoolbuttonOutput), tooltips, _("Display filtered output in the main window"), NULL);
+  comboboxPreview = gtk_combo_box_new_text ();
+  gtk_widget_show (comboboxPreview);
+  gtk_container_add (GTK_CONTAINER (toolitem12), comboboxPreview);
 
   vbox10 = gtk_vbox_new (FALSE, 3);
   gtk_widget_show (vbox10);
@@ -1428,10 +1418,6 @@
   GTK_WIDGET_SET_FLAGS (labelFrameType, GTK_CAN_FOCUS);
   gtk_label_set_selectable (GTK_LABEL (labelFrameType), TRUE);
 
-//   g_signal_connect ((gpointer) psp__h264_1, "activate",
-//                     G_CALLBACK (on_psp_h264_activate),
-//                     NULL);
-
   /* Store pointers to all widgets, for use by lookup_widget(). */
   GLADE_HOOKUP_OBJECT_NO_REF (mainWindow, mainWindow, "mainWindow");
   GLADE_HOOKUP_OBJECT (mainWindow, vbox1, "vbox1");
@@ -1575,8 +1561,8 @@
   GLADE_HOOKUP_OBJECT (mainWindow, separatortoolitem1, "separatortoolitem1");
   GLADE_HOOKUP_OBJECT (mainWindow, toolbuttonCalc, "toolbuttonCalc");
   GLADE_HOOKUP_OBJECT (mainWindow, separatortoolitem2, "separatortoolitem2");
-  GLADE_HOOKUP_OBJECT (mainWindow, toggletoolbuttonPreview, "toggletoolbuttonPreview");
-  GLADE_HOOKUP_OBJECT (mainWindow, toggletoolbuttonOutput, "toggletoolbuttonOutput");
+  GLADE_HOOKUP_OBJECT (mainWindow, toolitem12, "toolitem12");
+  GLADE_HOOKUP_OBJECT (mainWindow, comboboxPreview, "comboboxPreview");
   GLADE_HOOKUP_OBJECT (mainWindow, vbox10, "vbox10");
   GLADE_HOOKUP_OBJECT (mainWindow, hbox14, "hbox14");
   GLADE_HOOKUP_OBJECT (mainWindow, alignment19, "alignment19");

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_menumap.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_menumap.h	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_menumap.h	2007-02-01 19:44:22 UTC (rev 2788)
@@ -75,8 +75,8 @@
 CALLBACK(filters1                              ,ACT_VideoParameter);
 CALLBACK(toolbar1                              ,ACT_ViewMain);
 CALLBACK(sidebar1                              ,ACT_ViewSide);
-CALLBACK(preview1                              ,ACT_PreviewToggle);
-CALLBACK(display_output1                       ,ACT_OuputToggle);
+//CALLBACK(preview1                              ,ACT_PreviewToggle);
+//CALLBACK(display_output1                       ,ACT_OuputToggle);
 CALLBACK(second_audio_track1                   ,ACT_SecondAudioTrack);
 
 CALLBACK(vcd1                                   ,ACT_AUTO_VCD);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-02-01 19:44:22 UTC (rev 2788)
@@ -60,7 +60,7 @@
 
 static uint8_t	updateWindowSize(GtkWidget * win, uint32_t w, uint32_t h);
 static uint8_t GUI_ConvertRGB(uint8_t * in, uint8_t * out, uint32_t w, uint32_t h);
-
+static uint8_t GUI_ConvertRGBBlit(uint8_t * in, uint8_t * out,uint32_t totalW,uint32_t totalH, uint32_t startx,uint32_t starty,uint32_t w, uint32_t h);
 uint8_t  GUI_InitRender (GtkWidget *g, uint32_t w,uint32_t h);
 static renderZoom zoom=ZOOM_1_1;
 
@@ -172,6 +172,22 @@
 
 }
 /**
+      \fn renderUpdateImageBlit
+      \brief Blit the source into destination
+
+*/
+uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h)
+{
+
+        ADM_assert(screenBuffer);
+        lastImage=NULL;
+        if(!accel_mode)
+                GUI_ConvertRGBBlit(ptr,screenBuffer, renderW,renderH,startx,starty,w,h);
+        renderRefresh();
+        return 1;
+}
+
+/**
 	Refresh the image from internal buffer / last image
 	Used for example as call back for X11 events
 
@@ -179,20 +195,21 @@
 //_______________________________________________
 uint8_t renderRefresh(void)
 {
-	if(!screenBuffer)
-	{
-		if(accel_mode) ADM_assert(0);
-		return 0;
-	}
+      if(!screenBuffer)
+      {
+              if(accel_mode) ADM_assert(0);
+              return 0;
+      }
 
-	if(accel_mode)
-	{
-		accel_mode->display(lastImage, renderW, renderH);
-		//GUI_XvRedraw();
-   	}
-    	else
-		GUI_RGBDisplay(screenBuffer, renderW, renderH,draw);
-    return 1;
+      if(accel_mode)
+      {
+          if(lastImage)
+              accel_mode->display(lastImage, renderW, renderH);
+              //GUI_XvRedraw();
+      }
+      else
+              GUI_RGBDisplay(screenBuffer, renderW, renderH,draw);
+  return 1;
 }
 
 uint8_t renderExpose(void)
@@ -206,6 +223,7 @@
 
     if ( accel_mode)
     {	
+        if(lastImage)
 		accel_mode->display(lastImage,renderW,renderH);
     }
     else
@@ -329,16 +347,22 @@
      UI_purge();
      */
     gtk_widget_set_usize(win, w, h);
+    rgbConverter.reset(w,h);
     return 1;
 }
 
 uint8_t GUI_ConvertRGB(uint8_t * in, uint8_t * out, uint32_t w, uint32_t h)
 {
-    //COL_yv12rgb (w, h,in, out);
     rgbConverter.reset(w,h);
     rgbConverter.scale(in,out);
     return 1;
 }
+uint8_t GUI_ConvertRGBBlit(uint8_t * in, uint8_t * out,uint32_t totalW,uint32_t totalH, uint32_t startx,uint32_t starty,uint32_t w, uint32_t h)
+{
+    rgbConverter.reset(w,h);
+    rgbConverter.scale(in,out,startx,starty,w,h,renderW,renderH);
+    return 1;
+}
 
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/gui_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/gui_none.cpp	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/gui_none.cpp	2007-02-01 19:44:22 UTC (rev 2788)
@@ -52,6 +52,14 @@
 {}
 void UI_setVProcessToggleStatus( uint8_t status )
 {}
+//**************************************************
+int    UI_getCurrentPreview(void)
+{
+  return 0; 
+}
+void   UI_setCurrentPreview(int ne)
+{
+}
 
 //**************************************************
 void UI_updateFrameCount(uint32_t curFrame)
@@ -78,15 +86,7 @@
 {}
 
 
-uint8_t UI_getPreviewToggleStatus( void )
-{}
-uint8_t UI_setPreviewToggleStatus( uint8_t status )
-{}
 
-uint8_t UI_getOutputToggleStatus( void )
-{}
-uint8_t UI_setOutputToggleStatus( uint8_t status )
-{}
 
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp	2007-02-01 19:44:22 UTC (rev 2788)
@@ -26,7 +26,7 @@
 {
   return 1;
 }
-uint8_t GUI_StillAlive( void )
+uint8_t GUI_PreviewStillAlive( void )
 {
   return 1;
 }
@@ -54,7 +54,10 @@
 {
   return 1;
 }
-
+uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h)
+{
+  return 1; 
+}
 uint8_t renderStartPlaying( void )
 {
   return 1;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2007-02-01 19:44:22 UTC (rev 2788)
@@ -73,7 +73,7 @@
   return 1;
 }
 //****************************************************************************************************
-uint8_t GUI_StillAlive( void )
+uint8_t GUI_PreviewStillAlive( void )
 {
   return 1;
 }
@@ -212,6 +212,11 @@
   }
   return 1;
 }
+uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h)
+{
+  return 1; 
+}
+
 /**
     \fn renderStartPlaying( void )
     \brief Start playing, create an alternate renderer (preferably hw accelerated such as Xv or SDL)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp	2007-02-01 19:44:22 UTC (rev 2788)
@@ -20,6 +20,13 @@
 static int videoCodec=0;
 //**************************************************
 //**************************************************
+int    UI_getCurrentPreview(void)
+{
+  return 0; 
+}
+void   UI_setCurrentPreview(int ne)
+{
+}
 
 //**************************************************
 //**************************************************
@@ -31,20 +38,6 @@
 //**************************************************
 
 
-
-
-uint8_t UI_getPreviewToggleStatus( void )
-{}
-uint8_t UI_setPreviewToggleStatus( uint8_t status )
-{}
-
-uint8_t UI_getOutputToggleStatus( void )
-{}
-uint8_t UI_setOutputToggleStatus( uint8_t status )
-{}
-
-
-
 void UI_iconify( void )
 {}
 void UI_deiconify( void )

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h	2007-02-01 19:44:22 UTC (rev 2788)
@@ -16,6 +16,33 @@
 #ifndef GUI_RENDER_H
 #define GUI_RENDER_H
 
+
+#include "ADM_image.h"
+
+typedef enum ADM_PREVIEW_MODE
+{
+    ADM_PREVIEW_NONE, 
+    ADM_PREVIEW_OUTPUT,
+    ADM_PREVIEW_SIDE,
+    ADM_PREVIEW_TOP,
+    ADM_PREVIEW_SEPARATE
+};
+
+ADM_PREVIEW_MODE getPreviewMode(void);
+void             setPreviewMode(ADM_PREVIEW_MODE preview);
+
+class admPreview
+{
+  public:
+      static void update(uint32_t framenum,ADMImage *image);
+      static void start(void);
+      static void stop(void);
+      static void setMainDimension(uint32_t, uint32_t );
+  
+};
+
+
+
 typedef enum renderZoom
 {
         ZOOM_1_4,
@@ -32,6 +59,7 @@
 uint8_t renderRefresh(void);
 uint8_t renderExpose(void);
 uint8_t renderUpdateImage(uint8_t *ptr);
+uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t);
 
 uint8_t renderStartPlaying( void );
 uint8_t renderStopPlaying( void );

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_ui.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_ui.h	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_ui.h	2007-02-01 19:44:22 UTC (rev 2788)
@@ -1,5 +1,5 @@
-#ifndef ADM_GUI
-#define ADM_GUI
+#ifndef ADM_GUI_UI_H
+#define ADM_GUI_UI_H
 
 #include "ADM_editor/ADM_outputfmt.h"
 
@@ -16,13 +16,6 @@
 void 	UI_setTitle(char *name);
 
 
-uint8_t UI_getPreviewToggleStatus( void );
-uint8_t UI_setPreviewToggleStatus( uint8_t status );
-
-uint8_t UI_getOutputToggleStatus( void );
-uint8_t UI_setOutputToggleStatus( uint8_t status );
-
-
 void UI_setAProcessToggleStatus( uint8_t status );
 void UI_setVProcessToggleStatus( uint8_t status );
 
@@ -32,6 +25,9 @@
 uint32_t UI_readCurFrame( void );
 void UI_JumpDone(void);
 
+int    UI_getCurrentPreview(void);
+void   UI_setCurrentPreview(int ne);
+
 int 	UI_getCurrentACodec(void);
 int 	UI_getCurrentVCodec(void);
 void UI_setAudioCodec( int i);

Modified: branches/avidemux_2.4_branch/avidemux/gui_navigate.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gui_navigate.cpp	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/gui_navigate.cpp	2007-02-01 19:44:22 UTC (rev 2788)
@@ -44,7 +44,8 @@
 #include "ADM_video/ADM_genvideo.hxx"
 #include "ADM_filter/video_filters.h"
     
-    extern void    UI_purge(void );
+extern void    UI_purge(void );
+extern ADMImage *rdr_decomp_buffer;
 //____________________________________
 
 uint8_t GUI_getFrame(uint32_t frameno, ADMImage *image, uint32_t *flags)
@@ -75,16 +76,13 @@
                   GUI_Error_HIG(_("Decompressing error"),_( "Cannot decode next frame."));
            	}
            else
-           {
-		curframe++;
-               	if(mode_preview)
-          			editorUpdatePreview( curframe) ;
-						
-		renderUpdateImage(rdr_decomp_buffer->data);
-     		 update_status_bar(rdr_decomp_buffer);
-
-		UI_purge();
-	  	}
+            {
+                  curframe++;
+                  admPreview::update( curframe,rdr_decomp_buffer) ;
+                  update_status_bar(rdr_decomp_buffer);
+  
+                UI_purge();
+            }
      }
 }
 
@@ -110,18 +108,15 @@
            	}
 		else
 		{
-			curframe=f;
-			if( !GUI_getFrame(curframe,rdr_decomp_buffer,&flags))
-        		{
+                        curframe=f;
+                        if( !GUI_getFrame(curframe,rdr_decomp_buffer,&flags))
+                        {
                           GUI_Error_HIG(_("Decompressing error"),_( "Cannot decode keyframe."));
-			}
-			
-			renderUpdateImage(rdr_decomp_buffer->data);
-			if(mode_preview)
-         				editorUpdatePreview( curframe)     ;
-
-			update_status_bar(rdr_decomp_buffer);
-			UI_purge();
+                        }
+                        
+                        admPreview::update( curframe,rdr_decomp_buffer) ;
+                        update_status_bar(rdr_decomp_buffer);
+                        UI_purge();
 		}
 		
   	}
@@ -267,10 +262,8 @@
       curframe=orgFrame;
       video_body->getUncompressedFrame(orgFrame ,rdr_decomp_buffer);
    }
-   renderUpdateImage(rdr_decomp_buffer->data);
-   if(mode_preview)
-	 editorUpdatePreview( curframe)     ;
-   update_status_bar(rdr_decomp_buffer);
+    admPreview::update( curframe,rdr_decomp_buffer) ;
+    update_status_bar(rdr_decomp_buffer);
 
    return ;
 }
@@ -342,10 +335,8 @@
         curframe=0;
         video_body->getUncompressedFrame(0,rdr_decomp_buffer);
     }
-    renderUpdateImage(rdr_decomp_buffer->data);
-    if ( mode_preview )
-        editorUpdatePreview( curframe );
-    update_status_bar(rdr_decomp_buffer);
+     admPreview::update( curframe,rdr_decomp_buffer) ;
+     update_status_bar(rdr_decomp_buffer);
 
     return 1;
 }
@@ -358,18 +349,16 @@
 void GUI_GoToKFrame(uint32_t frame)
 {
    uint32_t old=curframe;
-//  uint32_t flags;
 
-        if (playing)
-				return;
 
-	if (avifileinfo)
-	{
-		// curframe=frame;
-		//
-		curframe=frame;
-		GUI_PreviousKeyFrame();	
-     	}
+    if (playing)
+            return;
+
+    if (avifileinfo)
+    {
+            curframe=frame;
+            GUI_PreviousKeyFrame();	
+    }
 }
 
 //_____________________________________________________________
@@ -377,30 +366,25 @@
 {
 uint32_t flags;
 
-	if (playing)
-		return 0;
+      if (playing)
+              return 0;
 
-      if (!avifileinfo)
-      		return 0;
-      
+    if (!avifileinfo)
+              return 0;
+    
 
-	if( !GUI_getFrame(frame ,rdr_decomp_buffer,&flags))
-	{
-          GUI_Error_HIG(_("Decompressing error"),_( "Cannot decode the frame."));
-		return 0;
-	}
+      if( !GUI_getFrame(frame ,rdr_decomp_buffer,&flags))
+      {
+        GUI_Error_HIG(_("Decompressing error"),_( "Cannot decode the frame."));
+              return 0;
+      }
 
-	curframe = frame;
-	renderUpdateImage(rdr_decomp_buffer->data);
-
-	if(mode_preview)
-		editorUpdatePreview( curframe);
-
-	update_status_bar(rdr_decomp_buffer);
-	UI_purge();
-	
-    	return 1;
-
+      curframe = frame;
+      admPreview::update( curframe,rdr_decomp_buffer) ;
+      update_status_bar(rdr_decomp_buffer);
+      UI_purge();
+      
+      return 1;
 }
 
 
@@ -418,27 +402,24 @@
     f=curframe;
     if (avifileinfo)
       {
-		if(!video_body->getPKFrame(&f)&&curframe)
-		//if( !GUI_getFrameNKF(&f ,rdr_decomp_buffer))
-        	{
-            //	GUI_Error_HIG("Decompressing error", NULL);
-           	}
-		else
-		{
-			curframe=f;
-			if( !GUI_getFrame(curframe,rdr_decomp_buffer,&flags))
-        		{
-                          GUI_Error_HIG(_("Decompressing error"),_( "Cannot decode keyframe."));
-			}
-			
-			renderUpdateImage(rdr_decomp_buffer->data);
-			if(mode_preview)
-         				editorUpdatePreview( curframe)     ;
+            if(!video_body->getPKFrame(&f)&&curframe)
+            {
+                  return;
+            }
+            else
+            {
+                    curframe=f;
+                    if( !GUI_getFrame(curframe,rdr_decomp_buffer,&flags))
+                    {
+                      GUI_Error_HIG(_("Decompressing error"),_( "Cannot decode keyframe."));
+                    }
+                    
+                    admPreview::update( curframe,rdr_decomp_buffer) ;
 
-			update_status_bar(rdr_decomp_buffer);
-			UI_purge();
-		}
-		
+                    update_status_bar(rdr_decomp_buffer);
+                    UI_purge();
+            }
+              
   	}
 };
 

Modified: branches/avidemux_2.4_branch/avidemux/prototype.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/prototype.h	2007-01-31 18:09:29 UTC (rev 2787)
+++ branches/avidemux_2.4_branch/avidemux/prototype.h	2007-02-01 19:44:22 UTC (rev 2788)
@@ -14,7 +14,7 @@
 int GUI_GoToFrame(uint32_t frame);
 // not in callback.h to avoid importing COMPRESSION MODE in interface.cpp
 
- void updateVideoFilters(void);
+
  //
  //
  //



From mean at mail.berlios.de  Thu Feb  1 20:45:27 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 1 Feb 2007 20:45:27 +0100
Subject: [Avidemux-svn-commit] r2789 - in
	branches/avidemux_2.4_branch/avidemux: . ADM_colorspace ADM_video
Message-ID: <200702011945.l11JjRnk002757@sheep.berlios.de>

Author: mean
Date: 2007-02-01 20:45:25 +0100 (Thu, 01 Feb 2007)
New Revision: 2789

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_colorspace/ADM_rgb.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_colorspace/ADM_rgb.h
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_genvideo.hxx
   branches/avidemux_2.4_branch/avidemux/Makefile.am
   branches/avidemux_2.4_branch/avidemux/avi_vars.h
   branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
   branches/avidemux_2.4_branch/avidemux/gui_action.hxx
   branches/avidemux_2.4_branch/avidemux/guiplay.cpp
Log:
new preview stuff, not 100% done

Modified: branches/avidemux_2.4_branch/avidemux/ADM_colorspace/ADM_rgb.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_colorspace/ADM_rgb.cpp	2007-02-01 19:44:22 UTC (rev 2788)
+++ branches/avidemux_2.4_branch/avidemux/ADM_colorspace/ADM_rgb.cpp	2007-02-01 19:45:25 UTC (rev 2789)
@@ -189,6 +189,98 @@
         return 1;
  }
 
+/**
+      \fn scale
+      \brief Change colorspace but and put result in the target image , which is bigger
+
+*/
+ uint8_t ColYuvRgb::scale(uint8_t *src, uint8_t *target,uint32_t startx,uint32_t starty, uint32_t tw,uint32_t th,uint32_t totalW,uint32_t totalH)
+ {
+    uint8_t *srd[3];
+    uint8_t *dst[3];
+    int ssrc[3];
+    int ddst[3];
+
+    ADM_assert(_context);
+    
+    uint32_t page;
+
+    page=tw*th;
+    srd[0]=src;
+    srd[1]=src+page;
+    srd[2]=src+((page*5)>>2);
+
+    ssrc[0]=tw;
+    ssrc[1]=ssrc[2]=tw>>1;
+
+    
+    dst[0]=target+(startx*4)+starty*totalW*4;
+    dst[1]=NULL;
+    dst[2]=NULL;
+    ddst[0]=totalW*4;
+    ddst[1]=ddst[2]=0;
+
+    sws_scale((SwsContext *)_context,srd,ssrc,0,th,dst,ddst);
+
+    if(_inverted)
+    {
+#if (defined( ARCH_X86)  || defined(ARCH_X86_64))
+            if( 0 && CpuCaps::hasMMX())
+            {
+            }
+            else
+#endif
+            {
+                uint8_t r,g,b,a;
+                uint8_t *ptr=NULL;
+                int pel=th;
+                for(int yy=0;yy<th;yy++)
+                {
+                  ptr=target+(startx*4)+(starty+yy)*totalW*4;;
+                  for(int xx=0;xx<tw;xx++)
+                  {
+                      r=ptr[0];
+                      g=ptr[1];
+                      b=ptr[2];
+                      a=ptr[3];
+                      ptr[0]=b;
+                      ptr[1]=g;
+                      ptr[2]=r;
+                      ptr[3]=a;
+                      ptr+=4;
+                  }
+                }
+            }
+          
+          
+        }
+#if  defined( ADM_BIG_ENDIAN)
+        uint8_t r,g,b,a;
+        uint8_t *ptr=target;
+        int pel=h*w;
+        for(int yy=0;yy<th;yy++)
+                {
+                  *ptr=target+(startx*4)+(starty+yy)*totalW*4;;
+                  for(int xx=0;xx<tw;xx++)
+                  {
+                      r=ptr[0];
+                      g=ptr[1];
+                      b=ptr[2];
+                      a=ptr[3];
+                      ptr[0]=a;
+                      ptr[1]=b;
+                      ptr[2]=g;
+                      ptr[3]=r;
+                      ptr+=4;
+                  }
+                }
+        
+#endif
+  return 1;
+ }
+
+ 
+ 
 //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 uint8_t ColYv12Rgb24::reset(uint32_t ww, uint32_t hh)
  {

Modified: branches/avidemux_2.4_branch/avidemux/ADM_colorspace/ADM_rgb.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_colorspace/ADM_rgb.h	2007-02-01 19:44:22 UTC (rev 2788)
+++ branches/avidemux_2.4_branch/avidemux/ADM_colorspace/ADM_rgb.h	2007-02-01 19:45:25 UTC (rev 2789)
@@ -58,7 +58,8 @@
                 ColYuvRgb(uint32_t w, uint32_t h,uint32_t inv=0): ColBase(w,h) {_inverted=inv;};
                 ~ColYuvRgb(){clean();};
       virtual  uint8_t reset(uint32_t neww, uint32_t newh);
-      virtual  uint8_t scale(uint8_t *src, uint8_t *target);  
+      virtual  uint8_t scale(uint8_t *src, uint8_t *target);
+      virtual  uint8_t scale(uint8_t *src, uint8_t *target,uint32_t startx,uint32_t starty, uint32_t w,uint32_t h,uint32_t totalW,uint32_t totalH);    
  };
  //********************************************
 

Added: branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp	2007-02-01 19:44:22 UTC (rev 2788)
+++ branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp	2007-02-01 19:45:25 UTC (rev 2789)
@@ -0,0 +1,233 @@
+/***************************************************************************
+    
+    Handle preview mode
+    
+    It is displayed in 3 layers
+    
+    
+    Engine : Call setPreviewMode and amdPreview depending on the actions
+            previewMode is the **current** preview mode
+    
+    admPreview : 
+          Allocate/desallocate ressources
+          Build preview window
+          Call display properly to display it
+          
+    GUI_PreviewXXXX
+          UI toolkit to actually display the window
+          See GUI_ui.h to see them
+                 
+    
+    
+    copyright            : (C) 2007 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include <ADM_assert.h>
+#include <ADM_assert.h>
+#include "config.h"
+
+#include "default.h"
+
+#include "ADM_toolkit/toolkit.hxx"
+#include "ADM_editor/ADM_edit.hxx"
+#include "ADM_video/ADM_genvideo.hxx"
+#include "ADM_filter/video_filters.h"
+
+
+#include "GUI_render.h"
+
+#include "ADM_osSupport/ADM_debugID.h"
+#define MODULE_NAME MODULE_PREVIEW
+#include "ADM_osSupport/ADM_debug.h"
+
+
+#include "GUI_ui.h"
+#define MAX(a,b) ( (a)>(b) ? (a) : (b) )
+
+extern FILTER  videofilters[MAX_FILTER];
+extern uint32_t nb_active_filter;
+
+static   AVDMGenericVideoStream *preview=NULL;
+static ADMImage *previewImage;
+static ADM_PREVIEW_MODE previewMode=ADM_PREVIEW_NONE;
+static uint32_t _mainW=0,_mainH=0;
+static uint32_t _displayW=0,_displayH=0;
+/**
+      \fn getPreviewMode
+      \brief returns current preview mode
+      @return current preview mode
+
+*/
+
+ADM_PREVIEW_MODE getPreviewMode(void)
+{
+  return previewMode; 
+}
+/**
+      \fn setPreviewMode
+      \brief set current preview mode an update UI
+      @param mode  new preview mode
+
+*/
+
+ void setPreviewMode(ADM_PREVIEW_MODE mode)
+{
+  previewMode=mode; 
+  UI_setCurrentPreview( (int)mode);
+}
+
+
+/**
+      \fn admPreview::start
+      \brief start preview
+
+*/
+
+void 	admPreview::start( void )
+{
+            aprintf("--killing\n");
+            getFirstVideoFilter();
+            
+            preview=videofilters[  nb_active_filter-1].filter;
+            aprintf("--spawning\n");
+            ADM_assert(!previewImage)
+                
+            previewImage=new ADMImage(preview->getInfo()->width,preview->getInfo()->height);
+            
+            
+            switch(previewMode)
+            {
+              case  ADM_PREVIEW_SEPARATE:
+                  GUI_PreviewInit(preview->getInfo()->width,preview->getInfo()->height,0);
+                  
+                  /* no break here, not a mistake */
+              case  ADM_PREVIEW_NONE:
+              
+                  _displayW=_mainW;
+                  _displayH=_mainH;
+                  break;
+              case  ADM_PREVIEW_OUTPUT:
+                  _displayW=preview->getInfo()->width;
+                  _displayH=preview->getInfo()->height;
+                  break;
+              case  ADM_PREVIEW_SIDE:
+              {
+                  
+                  _displayH=MAX(_mainH,preview->getInfo()->height);
+                  _displayW=_mainW+preview->getInfo()->width;
+                  break;
+              }
+              case  ADM_PREVIEW_TOP:
+              {
+                  
+                  _displayW=MAX(_mainW,preview->getInfo()->width);
+                  _displayH=_mainH+preview->getInfo()->height;
+                  break;
+              }
+              default: ADM_assert(0);
+            }
+            renderResize(_displayW,_displayH,ZOOM_1_1);
+}
+/**
+      \fn admPreview::stop
+      \brief kill preview window and associated datas
+*/
+
+void admPreview::stop( void )
+{
+      if(previewMode==ADM_PREVIEW_SEPARATE)
+                GUI_PreviewEnd();
+      if(previewMode!=ADM_PREVIEW_NONE)
+      {
+          if(previewImage)
+            delete previewImage;
+          previewImage=NULL;
+      }
+      renderResize(_mainW,_mainH,ZOOM_1_1);
+}
+/**
+      \fn admPreview::setMainDimension
+      \brief Update width & height of input video
+      @param w : width
+      @param h : height
+*/
+
+void admPreview::setMainDimension(uint32_t w, uint32_t h)
+{
+  _mainW=w;
+  _mainH=h;
+  _displayW=w;
+  _displayH=h;
+  renderResize(w,h,ZOOM_1_1);
+  
+}
+/**
+      \fn admPreview::update
+      \brief display data associated with framenum image
+      @param image : current main image (input)
+      @param framenum, framenumber
+*/
+
+void admPreview::update(uint32_t framenum,ADMImage *image)
+{
+    uint32_t fl,len;	
+
+    switch(previewMode)
+    {
+      case ADM_PREVIEW_NONE:
+        if(image) renderUpdateImage(image->data);
+        break;
+      case ADM_PREVIEW_OUTPUT:
+            if(framenum<=preview->getInfo()->nb_frames-1)
+                  {
+                          preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
+                          renderUpdateImage(previewImage->data);
+                  }
+            break;
+      case ADM_PREVIEW_SEPARATE:
+            ADM_assert(preview);
+            ADM_assert(previewImage);
+
+          if(image) renderUpdateImage(image->data);
+          if( GUI_PreviewStillAlive())
+          {
+                  aprintf("Preview: Ask for frame %lu\n",framenum);
+                  if(framenum<=preview->getInfo()->nb_frames-1)
+                  {
+                          preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
+                          GUI_PreviewUpdate(previewImage->data);
+                  }
+          }
+          break;
+      case ADM_PREVIEW_SIDE:
+              ADM_assert(preview);
+              ADM_assert(previewImage);
+  
+              renderUpdateImageBlit(image->data,0,0,_mainW,_mainH); // Main
+              preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
+              renderUpdateImageBlit(previewImage->data,_mainW,0,previewImage->_width,previewImage->_height);
+              break;
+        
+      case ADM_PREVIEW_TOP:
+              ADM_assert(preview);
+              ADM_assert(previewImage);
+  
+              renderUpdateImageBlit(image->data,0,0,_mainW,_mainH); // Main
+              preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
+              renderUpdateImageBlit(previewImage->data,0,_mainH,previewImage->_width,previewImage->_height);
+              break;
+      default: ADM_assert(0);
+    }
+}

Modified: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_genvideo.hxx
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_genvideo.hxx	2007-02-01 19:44:22 UTC (rev 2788)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_genvideo.hxx	2007-02-01 19:45:25 UTC (rev 2789)
@@ -41,12 +41,12 @@
 #include "ADM_image.h"
 
 
-void GUI_PreviewInit(uint32_t w , uint32_t h, uint32_t modal);
-uint8_t 	GUI_PreviewUpdate(uint8_t *data);
-void 	GUI_PreviewEnd( void);
-uint8_t  	GUI_PreviewRun(uint8_t *data);
-uint8_t GUI_StillAlive( void );
-void GUI_PreviewShow(uint32_t w, uint32_t h, uint8_t *data);
+void     GUI_PreviewInit(uint32_t w , uint32_t h, uint32_t modal);
+uint8_t  GUI_PreviewUpdate(uint8_t *data);
+void 	 GUI_PreviewEnd( void);
+uint8_t  GUI_PreviewRun(uint8_t *data);
+uint8_t  GUI_PreviewStillAlive( void );
+void     GUI_PreviewShow(uint32_t w, uint32_t h, uint8_t *data);
 #define Pixel uint8_t
 typedef struct
  {

Modified: branches/avidemux_2.4_branch/avidemux/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/Makefile.am	2007-02-01 19:44:22 UTC (rev 2788)
+++ branches/avidemux_2.4_branch/avidemux/Makefile.am	2007-02-01 19:45:25 UTC (rev 2789)
@@ -41,7 +41,7 @@
 adm_src =   guiplay.cpp  \
 	gui_savenew.cpp  gui_navigate.cpp gtk_gui.cpp   \
 	main.cpp   \
-	gui_autodrive.cpp GUI_jobs.cpp
+	gui_autodrive.cpp GUI_jobs.cpp ADM_preview.cpp
 
 
 avidemux2_cli_SOURCES=$(adm_src)

Modified: branches/avidemux_2.4_branch/avidemux/avi_vars.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/avi_vars.h	2007-02-01 19:44:22 UTC (rev 2788)
+++ branches/avidemux_2.4_branch/avidemux/avi_vars.h	2007-02-01 19:45:25 UTC (rev 2789)
@@ -52,27 +52,8 @@
 =0
 #endif
 ;
-EXTERN uint8_t 	mode_preview
-#ifdef __DECLARE__
-=0
-#endif
-;
 
-;
 
-/**
-	This buffer is share for GUI display
-	It leads to the buffer where the last displayed frame has been uncompressed
-
-*/
-EXTERN ADMImage *rdr_decomp_buffer
-#ifdef __DECLARE__
-=NULL
-#endif
-;
-
-
-
 EXTERN AVDMGenericAudioStream *aviaudiostream;
 EXTERN AVDMGenericAudioStream *currentaudiostream
 #ifdef __DECLARE__
@@ -97,16 +78,6 @@
 #endif
 ;
 /**
-	Output mode : 
-		If 0 display incoming video_body	
-		if 1, display filtered video
-*/
-EXTERN uint8_t guiOutputDisplay
-#ifdef __DECLARE__
-=0
-#endif
-;
-/**
 	If set to 1, means video is in process mode_preview
 	If set to 0, copy mode
 */

Modified: branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2007-02-01 19:44:22 UTC (rev 2788)
+++ branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2007-02-01 19:45:25 UTC (rev 2789)
@@ -25,11 +25,7 @@
 #include <sys/time.h>
 #include <fcntl.h>	/* O_RDONLY */
 #include <errno.h>
-#warning FIXME : Don't include GLIB!
-#warning FIXME : Don't include GLIB!
 #include <glib.h>
-#warning FIXME : Don't include GLIB!
-#warning FIXME : Don't include GLIB!
 
     
 #include "ADM_lavcodec.h"
@@ -99,13 +95,10 @@
 int A_audioSave(char *name);
 static void ReSync (void);
 static void cleanUp (void);
-extern uint8_t getPreviewToggleStatus (void);
-extern void getPreviewToggleStatus (uint8_t y);
 extern void GUI_setName (char *n);
 extern void DIA_properties( void);
 extern uint8_t DIA_Preferences(void);
 extern void  GUI_displayBitrate( void );
-//uint8_t GUI_InitRender (GtkWidget * g, uint32_t w, uint32_t h);
 void test_mpeg (char *name);
 uint8_t GUI_getDoubleValue (double *valye, float min, float max,
 			    const char *title);
@@ -170,6 +163,11 @@
 uint8_t Util_saveJpg (char *name,uint32_t w, uint32_t,ADMImage *image);
 extern const char * GUI_getCustomScript(uint32_t nb);
 extern gboolean SliderIsShifted;
+
+ADMImage *rdr_decomp_buffer=NULL;
+
+
+
 //___________________________________________
 // serialization of user event throught gui
 //
@@ -295,12 +293,6 @@
       ADM_aviUISetMuxer();
       return;
       break;
-    case ACT_OuputToggle:
-        guiOutputDisplay ^= 1;
-        UI_setOutputToggleStatus (guiOutputDisplay);
-        printf ("\n Ouput is now : %d", guiOutputDisplay);
-      return;
-
 #ifdef HAVE_AUDIO      
     	case ACT_SelectDevOSS:
 				   AVDM_switch (DEVICE_OSS);
@@ -466,12 +458,12 @@
         case ACT_ZOOM_1_1:
         case ACT_ZOOM_2_1:
         case ACT_ZOOM_4_1:
-
+#if 0
                 currentZoom=(renderZoom)((action-ACT_ZOOM_1_4)+ZOOM_1_4);
                 renderResize (avifileinfo->width, avifileinfo->height,currentZoom);
                 renderUpdateImage (rdr_decomp_buffer->data);
                 renderRefresh ();
-
+#endif
                 break;
 
 
@@ -638,25 +630,21 @@
 	}
 //        printf("\n new frame : %lu",nf);
       break;
-    case ACT_PreviewToggle:
-      mode_preview^=1;
-      UI_setPreviewToggleStatus (mode_preview);
-
-      printf ("\n Preview is now : %d", mode_preview);
-      if (mode_preview)
-	{
-
-	  editorReignitPreview ();
-	  video_body->activateCache();
-	  editorUpdatePreview (curframe);
-
-	}
-      else
-      {
-	editorKillPreview ();
-	//video_body->desactivateCache();
+#define TOGGLE_PREVIEW ADM_PREVIEW_OUTPUT
+    case ACT_PreviewChanged:
+    {
+        ADM_PREVIEW_MODE oldpreview=getPreviewMode(),newpreview=(ADM_PREVIEW_MODE)UI_getCurrentPreview();
+          printf("Old preview %d, New preview mode : %d\n",oldpreview,newpreview);
+          
+          if(oldpreview==newpreview)
+          {
+            return;
+          }
+            admPreview::stop();
+            setPreviewMode(newpreview);
+            admPreview::start();
+            admPreview::update(curframe,rdr_decomp_buffer);
       }
-
       break;
     case ACT_StopAvi:
       if (playing)
@@ -894,21 +882,19 @@
       break;
     case ACT_VideoParameter:
       // first remove current viewer
-      if (mode_preview)
+      if (getPreviewMode()!=ADM_PREVIEW_NONE)
         {
-                
-	        editorKillPreview ();
+	         admPreview::stop();
         }
       GUI_handleVFilter();
       if( getLastVideoFilter()->getInfo()->width % 8 ){
         GUI_Error_HIG(_("Width is not a multiple of 8"),
                       _("This will make trouble for avi files."));
       }
-      if (mode_preview)
+      if (getPreviewMode()!=ADM_PREVIEW_NONE)
       {
-        editorReignitPreview();
-	editorUpdatePreview (curframe);
-        UI_setPreviewToggleStatus( 1);
+         admPreview::start();
+         admPreview::update (curframe,rdr_decomp_buffer);
       }
       break;
 
@@ -982,8 +968,11 @@
   if (avifileinfo)		// already opened ?
     {				// delete everything
       // if preview is on
-      if (mode_preview)
-	GUI_PreviewEnd ();
+      if(getPreviewMode()!=ADM_PREVIEW_NONE)
+      {
+	admPreview::stop();
+        setPreviewMode(ADM_PREVIEW_NONE);
+      }
       delete avifileinfo;
       //delete wavinfo;
       wavinfo = (WAVHeader *) NULL;
@@ -1118,7 +1107,6 @@
 
   curframe = 0;
   getFirstVideoFilter(); // reinit first filter
-  video_body->flushCache();
   ADM_assert (rdr_decomp_buffer =new ADMImage(avifileinfo->width,avifileinfo->height));
 
   //frameStart = 0;
@@ -1169,7 +1157,7 @@
     }
 
   // Init renderer
-  renderResize (avifileinfo->width, avifileinfo->height,currentZoom);
+    admPreview::setMainDimension(avifileinfo->width, avifileinfo->height);
   curframe = 0;
   
 
@@ -1182,8 +1170,7 @@
     }
   else
     {
-      renderUpdateImage (rdr_decomp_buffer->data);
-      renderRefresh ();
+      admPreview::update (curframe,rdr_decomp_buffer);
       update_status_bar(rdr_decomp_buffer);
     }
    

Modified: branches/avidemux_2.4_branch/avidemux/gui_action.hxx
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gui_action.hxx	2007-02-01 19:44:22 UTC (rev 2788)
+++ branches/avidemux_2.4_branch/avidemux/gui_action.hxx	2007-02-01 19:45:25 UTC (rev 2789)
@@ -159,6 +159,7 @@
 ACT_RunScript,
 ACT_AudioCodecChanged,
 ACT_VideoCodecChanged,
+ACT_PreviewChanged,
 ACT_Bitrate,
 ACT_Ocr,
 ACT_SelectTrack1,

Modified: branches/avidemux_2.4_branch/avidemux/guiplay.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/guiplay.cpp	2007-02-01 19:44:22 UTC (rev 2788)
+++ branches/avidemux_2.4_branch/avidemux/guiplay.cpp	2007-02-01 19:45:25 UTC (rev 2789)
@@ -60,8 +60,8 @@
 
 #define EVEN(x) (x&0xffffffe)
 
+ extern ADMImage *rdr_decomp_buffer;
 
- extern void  UI_setPreviewToggleStatus( uint8_t status );
  extern uint8_t GUI_getFrame(uint32_t frameno, ADMImage *image, uint32_t *flags);
 //___________________________________
 uint8_t stop_req;
@@ -109,15 +109,9 @@
   uint32_t remaining=avifileinfo->nb_frames-curframe;
 
 
-    if(guiOutputDisplay)
+    if(getPreviewMode()==ADM_PREVIEW_OUTPUT)
     {
                 filter=getLastVideoFilter(curframe,remaining);
-                if(mode_preview)
-                {
-                      editorKillPreview ();
-                      UI_setPreviewToggleStatus( 0 );
-                      mode_preview=0;
-                }
     }
     else
     {
@@ -155,11 +149,7 @@
     do
     {
         vids++;
-        renderUpdateImage(buffer->data);
-        if(mode_preview&&!guiOutputDisplay)
-        {	
-            editorUpdatePreview(played_frame);
-        }
+        admPreview::update(played_frame,buffer);;
         update_status_bar(buffer);
         if (time_a == 0)
             time_a = getTime(0);
@@ -213,7 +203,7 @@
 	    }
      	//
             UI_purge();
-            if(mode_preview)
+            if(getPreviewMode()==ADM_PREVIEW_SIDE || getPreviewMode()==ADM_PREVIEW_TOP)
             {
               UI_purge();
               UI_purge(); 
@@ -234,13 +224,8 @@
 	   getFirstVideoFilter( );
 	   //video_body->getUncompressedFrame(curframe, rdr_decomp_buffer,&flags);
 	   GUI_getFrame(curframe, rdr_decomp_buffer, &flags);
-	   renderUpdateImage(rdr_decomp_buffer->data);
-	   renderRefresh();
+           admPreview::update(curframe,rdr_decomp_buffer);
      	   update_status_bar(rdr_decomp_buffer);
-	   if(mode_preview)
-	   {
-		editorUpdatePreview(curframe);
-	   }
 #ifdef HAVE_AUDIO
     if (currentaudiostream)
       {
@@ -398,8 +383,6 @@
     audio_available = 1;
 }
 
-//
-// Build audio filters
 
 #endif
 // EOF



From mean at mail.berlios.de  Fri Feb  2 08:57:41 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 2 Feb 2007 08:57:41 +0100
Subject: [Avidemux-svn-commit] r2790 - in
	branches/avidemux_2.4_branch/avidemux: .
	ADM_userInterfaces/ADM_GTK/ADM_gui2
	ADM_userInterfaces/ADM_NONE/ADM_gui2
	ADM_userInterfaces/ADM_QT4/ADM_gui ADM_userInterfaces/ADM_commonUI
Message-ID: <200702020757.l127vfqJ009707@sheep.berlios.de>

Author: mean
Date: 2007-02-02 08:57:40 +0100 (Fri, 02 Feb 2007)
New Revision: 2790

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h
   branches/avidemux_2.4_branch/avidemux/guiplay.cpp
Log:
improve preview, not 100% ok yet

Modified: branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp	2007-02-01 19:45:25 UTC (rev 2789)
+++ branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp	2007-02-02 07:57:40 UTC (rev 2790)
@@ -156,6 +156,11 @@
           previewImage=NULL;
       }
       renderResize(_mainW,_mainH,ZOOM_1_1);
+      if(previewImage)
+      {
+        delete  previewImage; 
+        previewImage=NULL;
+      }
 }
 /**
       \fn admPreview::setMainDimension
@@ -215,18 +220,18 @@
               ADM_assert(preview);
               ADM_assert(previewImage);
   
-              renderUpdateImageBlit(image->data,0,0,_mainW,_mainH); // Main
+              renderUpdateImageBlit(image->data,0,0,_mainW,_mainH,0); // Main
               preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
-              renderUpdateImageBlit(previewImage->data,_mainW,0,previewImage->_width,previewImage->_height);
+              renderUpdateImageBlit(previewImage->data,_mainW,0,previewImage->_width,previewImage->_height,1);
               break;
         
       case ADM_PREVIEW_TOP:
               ADM_assert(preview);
               ADM_assert(previewImage);
   
-              renderUpdateImageBlit(image->data,0,0,_mainW,_mainH); // Main
+              renderUpdateImageBlit(image->data,0,0,_mainW,_mainH,0); // Main
               preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
-              renderUpdateImageBlit(previewImage->data,0,_mainH,previewImage->_width,previewImage->_height);
+              renderUpdateImageBlit(previewImage->data,0,_mainH,previewImage->_width,previewImage->_height,1);
               break;
       default: ADM_assert(0);
     }

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-02-01 19:45:25 UTC (rev 2789)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-02-02 07:57:40 UTC (rev 2790)
@@ -60,11 +60,12 @@
 
 static uint8_t	updateWindowSize(GtkWidget * win, uint32_t w, uint32_t h);
 static uint8_t GUI_ConvertRGB(uint8_t * in, uint8_t * out, uint32_t w, uint32_t h);
-static uint8_t GUI_ConvertRGBBlit(uint8_t * in, uint8_t * out,uint32_t totalW,uint32_t totalH, uint32_t startx,uint32_t starty,uint32_t w, uint32_t h);
+static uint8_t GUI_ConvertRGBBlit(uint8_t * in, uint8_t * out,uint32_t totalW,uint32_t totalH, uint32_t startx,uint32_t starty,uint32_t w, uint32_t h,uint32_t primary);
 uint8_t  GUI_InitRender (GtkWidget *g, uint32_t w,uint32_t h);
 static renderZoom zoom=ZOOM_1_1;
 
 static ColYuvRgb rgbConverter(640,480);
+static ColYuvRgb rgbConverter2(640,480);
 
 extern GtkWidget *getDrawWidget( void );
 extern uint8_t UI_shrink(uint32_t w,uint32_t h);
@@ -176,13 +177,13 @@
       \brief Blit the source into destination
 
 */
-uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h)
+uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h,uint32_t primary)
 {
 
         ADM_assert(screenBuffer);
         lastImage=NULL;
         if(!accel_mode)
-                GUI_ConvertRGBBlit(ptr,screenBuffer, renderW,renderH,startx,starty,w,h);
+                GUI_ConvertRGBBlit(ptr,screenBuffer, renderW,renderH,startx,starty,w,h,primary);
         renderRefresh();
         return 1;
 }
@@ -357,10 +358,17 @@
     rgbConverter.scale(in,out);
     return 1;
 }
-uint8_t GUI_ConvertRGBBlit(uint8_t * in, uint8_t * out,uint32_t totalW,uint32_t totalH, uint32_t startx,uint32_t starty,uint32_t w, uint32_t h)
+uint8_t GUI_ConvertRGBBlit(uint8_t * in, uint8_t * out,uint32_t totalW,uint32_t totalH, uint32_t startx,uint32_t starty,uint32_t w, uint32_t h,uint32_t primary)
 {
+  if(!primary)
+  {
     rgbConverter.reset(w,h);
     rgbConverter.scale(in,out,startx,starty,w,h,renderW,renderH);
+  }else
+  {
+    rgbConverter2.reset(w,h);
+    rgbConverter2.scale(in,out,startx,starty,w,h,renderW,renderH);
+  }
     return 1;
 }
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp	2007-02-01 19:45:25 UTC (rev 2789)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp	2007-02-02 07:57:40 UTC (rev 2790)
@@ -54,7 +54,7 @@
 {
   return 1;
 }
-uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h)
+uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h,uint32_t primary)
 {
   return 1; 
 }

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2007-02-01 19:45:25 UTC (rev 2789)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2007-02-02 07:57:40 UTC (rev 2790)
@@ -212,7 +212,7 @@
   }
   return 1;
 }
-uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h)
+uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h,uint32_t primary)
 {
   return 1; 
 }

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h	2007-02-01 19:45:25 UTC (rev 2789)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h	2007-02-02 07:57:40 UTC (rev 2790)
@@ -59,7 +59,7 @@
 uint8_t renderRefresh(void);
 uint8_t renderExpose(void);
 uint8_t renderUpdateImage(uint8_t *ptr);
-uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t);
+uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t,uint32_t primary);
 
 uint8_t renderStartPlaying( void );
 uint8_t renderStopPlaying( void );

Modified: branches/avidemux_2.4_branch/avidemux/guiplay.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/guiplay.cpp	2007-02-01 19:45:25 UTC (rev 2789)
+++ branches/avidemux_2.4_branch/avidemux/guiplay.cpp	2007-02-02 07:57:40 UTC (rev 2790)
@@ -108,10 +108,12 @@
   uint32_t played_frame=0;
   uint32_t remaining=avifileinfo->nb_frames-curframe;
 
-
+    admPreview::stop();
+    admPreview::start();
+    
     if(getPreviewMode()==ADM_PREVIEW_OUTPUT)
     {
-                filter=getLastVideoFilter(curframe,remaining);
+            filter=getLastVideoFilter(curframe,remaining);
     }
     else
     {
@@ -142,8 +144,9 @@
 #ifdef HAVE_AUDIO
     ComputePreload();
 #endif
-     renderResize(filter->getInfo()->width,filter->getInfo()->height,currentZoom);
-     renderStartPlaying();
+    
+     
+     //renderStartPlaying();
 // reset timer reference
     resetTime();
     do
@@ -203,7 +206,7 @@
 	    }
      	//
             UI_purge();
-            if(getPreviewMode()==ADM_PREVIEW_SIDE || getPreviewMode()==ADM_PREVIEW_TOP)
+            if(getPreviewMode()==ADM_PREVIEW_SEPARATE )
             {
               UI_purge();
               UI_purge(); 
@@ -219,8 +222,9 @@
     playing = 0;
 	  delete  buffer;
 
-	   renderStopPlaying();
-	   renderResize(avifileinfo->width ,  avifileinfo->height,currentZoom);
+	  // renderStopPlaying();
+	     admPreview::stop();
+             admPreview::start();
 	   getFirstVideoFilter( );
 	   //video_body->getUncompressedFrame(curframe, rdr_decomp_buffer,&flags);
 	   GUI_getFrame(curframe, rdr_decomp_buffer, &flags);



From mean at mail.berlios.de  Fri Feb  2 20:29:18 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 2 Feb 2007 20:29:18 +0100
Subject: [Avidemux-svn-commit] r2791 - in
	branches/avidemux_2.4_branch/avidemux: . ADM_filter
	ADM_userInterfaces/ADM_NONE/ADM_gui2 ADM_userInterfaces/ADM_commonUI
Message-ID: <200702021929.l12JTIUU008201@sheep.berlios.de>

Author: mean
Date: 2007-02-02 20:29:16 +0100 (Fri, 02 Feb 2007)
New Revision: 2791

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_filter/filter.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h
   branches/avidemux_2.4_branch/avidemux/guiplay.cpp
Log:
fix unaccelerated playback

Modified: branches/avidemux_2.4_branch/avidemux/ADM_filter/filter.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_filter/filter.cpp	2007-02-02 07:57:40 UTC (rev 2790)
+++ branches/avidemux_2.4_branch/avidemux/ADM_filter/filter.cpp	2007-02-02 19:29:16 UTC (rev 2791)
@@ -29,8 +29,8 @@
 #include "ADM_video/ADM_genvideo.hxx"
 #include "ADM_filter/video_filters.h"
 #include "ADM_video/ADM_vidPartial.h"
+#include "ADM_userInterfaces/ADM_commonUI/GUI_render.h"
 
-
 #include "ADM_osSupport/ADM_debugID.h"
 #define MODULE_NAME MODULE_PREVIEW
 #include "ADM_osSupport/ADM_debug.h"
@@ -243,23 +243,25 @@
   		{
   		 	nb_active_filter=1;
 			aprintf("--preview filter %d\n",nb_active_filter-1);
+                        admPreview::updateFilters(videofilters[0].filter,videofilters[nb_active_filter-1].filter);
   		 	return;
   		}
   		// Rebuild other filters
-  		    for(uint32_t i=1;i<nb_active_filter;i++)
-						{
-                   		VF_FILTERS tag;
-                    		AVDMGenericVideoStream *old;
-                   			old= videofilters[i].filter;
-                  			tag=videofilters[i].tag;
-
-                      	videofilters[i].filter=filterCreateFromTag(tag,
-                            			videofilters[i].conf,
-                               			videofilters[i-1].filter);
-
+                for(uint32_t i=1;i<nb_active_filter;i++)
+                {
+                    VF_FILTERS tag;
+                    AVDMGenericVideoStream *old;
+                            old= videofilters[i].filter;
+                            tag=videofilters[i].tag;
+  
+                            videofilters[i].filter=filterCreateFromTag(tag,
+                                                videofilters[i].conf,
+                                                videofilters[i-1].filter);
                           delete old;
-            	}
+                }
 		aprintf("--preview filter %d\n",nb_active_filter-1);
+                ADM_assert(nb_active_filter);
+                admPreview::updateFilters(videofilters[0].filter,videofilters[nb_active_filter-1].filter);
 }
 //
 //	Create a filter from : its tag, its config and an input stream

Modified: branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp	2007-02-02 07:57:40 UTC (rev 2790)
+++ branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp	2007-02-02 19:29:16 UTC (rev 2791)
@@ -64,6 +64,7 @@
 static ADM_PREVIEW_MODE previewMode=ADM_PREVIEW_NONE;
 static uint32_t _mainW=0,_mainH=0;
 static uint32_t _displayW=0,_displayH=0;
+static uint32_t defered_display=0;
 /**
       \fn getPreviewMode
       \brief returns current preview mode
@@ -75,6 +76,9 @@
 {
   return previewMode; 
 }
+
+
+
 /**
       \fn setPreviewMode
       \brief set current preview mode an update UI
@@ -87,8 +91,16 @@
   previewMode=mode; 
   UI_setCurrentPreview( (int)mode);
 }
+/**
+      \fn deferDisplay
+      \brief Enable or disable defered display
 
-
+*/
+void admPreview::deferDisplay(uint32_t onoff)
+{
+      defered_display=onoff;
+  
+}
 /**
       \fn admPreview::start
       \brief start preview
@@ -163,6 +175,43 @@
       }
 }
 /**
+      \fn admPreview::updateFilters
+      \brief Signal from filter that the filter chain has been updated
+      @param w : width
+      @param h : height
+*/
+
+void admPreview::updateFilters(AVDMGenericVideoStream *first,AVDMGenericVideoStream *last)
+{
+   switch(previewMode)
+            {
+              case  ADM_PREVIEW_SEPARATE:
+                  preview=last;
+                  break;
+                  /* no break here, not a mistake */
+              case  ADM_PREVIEW_NONE:
+                  break;
+              case  ADM_PREVIEW_OUTPUT:
+                preview=last;
+                break;
+              case  ADM_PREVIEW_SIDE:
+              {
+                  
+                  preview=last;
+                  break;
+              }
+              case  ADM_PREVIEW_TOP:
+              {
+                  
+                  preview=last;
+                  break;
+              }
+              default: ADM_assert(0);
+            }
+  
+}
+
+/**
       \fn admPreview::setMainDimension
       \brief Update width & height of input video
       @param w : width
@@ -192,27 +241,27 @@
     switch(previewMode)
     {
       case ADM_PREVIEW_NONE:
-        if(image) renderUpdateImage(image->data);
+        if(image && !defered_display) renderUpdateImage(image->data);
         break;
       case ADM_PREVIEW_OUTPUT:
             if(framenum<=preview->getInfo()->nb_frames-1)
                   {
                           preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
-                          renderUpdateImage(previewImage->data);
+                          if(!defered_display) renderUpdateImage(previewImage->data);
                   }
             break;
       case ADM_PREVIEW_SEPARATE:
             ADM_assert(preview);
             ADM_assert(previewImage);
 
-          if(image) renderUpdateImage(image->data);
+          if(image && !defered_display) renderUpdateImage(image->data);
           if( GUI_PreviewStillAlive())
           {
                   aprintf("Preview: Ask for frame %lu\n",framenum);
                   if(framenum<=preview->getInfo()->nb_frames-1)
                   {
                           preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
-                          GUI_PreviewUpdate(previewImage->data);
+                          if(!defered_display) GUI_PreviewUpdate(previewImage->data);
                   }
           }
           break;
@@ -220,8 +269,52 @@
               ADM_assert(preview);
               ADM_assert(previewImage);
   
+              if(!defered_display) renderUpdateImageBlit(image->data,0,0,_mainW,_mainH,0); // Main
+              preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
+              if(!defered_display) 
+                  renderUpdateImageBlit(previewImage->data,_mainW,0,previewImage->_width,previewImage->_height,1);
+              break;
+        
+      case ADM_PREVIEW_TOP:
+              ADM_assert(preview);
+              ADM_assert(previewImage);
+  
+              if(!defered_display) renderUpdateImageBlit(image->data,0,0,_mainW,_mainH,0); // Main
+              preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
+              if(!defered_display)
+                  renderUpdateImageBlit(previewImage->data,0,_mainH,previewImage->_width,previewImage->_height,1);
+              break;
+      default: ADM_assert(0);
+    }
+}
+/**
+      \fn displayNow
+      \brief display on screen immediately
+*/
+
+void admPreview::displayNow(uint32_t framenum,ADMImage *image)
+{
+    uint32_t fl,len;	
+
+    switch(previewMode)
+    {
+      case ADM_PREVIEW_NONE:
+        if(image ) renderUpdateImage(image->data);
+        break;
+      case ADM_PREVIEW_OUTPUT:
+            renderUpdateImage(previewImage->data);
+            break;
+      case ADM_PREVIEW_SEPARATE:
+          if(image) renderUpdateImage(image->data);
+          if( GUI_PreviewStillAlive())
+          {
+              GUI_PreviewUpdate(previewImage->data);
+          }
+          break;
+      case ADM_PREVIEW_SIDE:
+              ADM_assert(preview);
+              ADM_assert(previewImage);
               renderUpdateImageBlit(image->data,0,0,_mainW,_mainH,0); // Main
-              preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
               renderUpdateImageBlit(previewImage->data,_mainW,0,previewImage->_width,previewImage->_height,1);
               break;
         
@@ -230,7 +323,6 @@
               ADM_assert(previewImage);
   
               renderUpdateImageBlit(image->data,0,0,_mainW,_mainH,0); // Main
-              preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
               renderUpdateImageBlit(previewImage->data,0,_mainH,previewImage->_width,previewImage->_height,1);
               break;
       default: ADM_assert(0);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp	2007-02-02 07:57:40 UTC (rev 2790)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp	2007-02-02 19:29:16 UTC (rev 2791)
@@ -7,13 +7,16 @@
 #include <time.h>
 #include <sys/time.h>
 
-#include "config.h"
+#include <ADM_assert.h>
 #include "fourcc.h"
 #include "avio.hxx"
+#include "ADM_editor/ADM_edit.hxx"
+#include "ADM_video/ADM_genvideo.hxx"
 
-#include <ADM_assert.h>
 #include "GUI_render.h"
 
+
+
 void GUI_PreviewInit(uint32_t w , uint32_t h, uint32_t modal)
 {}
 uint8_t 	GUI_PreviewUpdate(uint8_t *data)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h	2007-02-02 07:57:40 UTC (rev 2790)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h	2007-02-02 19:29:16 UTC (rev 2791)
@@ -19,6 +19,8 @@
 
 #include "ADM_image.h"
 
+class AVDMGenericVideoStream;
+
 typedef enum ADM_PREVIEW_MODE
 {
     ADM_PREVIEW_NONE, 
@@ -38,6 +40,9 @@
       static void start(void);
       static void stop(void);
       static void setMainDimension(uint32_t, uint32_t );
+      static void updateFilters(AVDMGenericVideoStream *first,AVDMGenericVideoStream *last);
+      static void deferDisplay(uint32_t onoff);
+      static void displayNow(uint32_t framenum,ADMImage *image);
   
 };
 

Modified: branches/avidemux_2.4_branch/avidemux/guiplay.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/guiplay.cpp	2007-02-02 07:57:40 UTC (rev 2790)
+++ branches/avidemux_2.4_branch/avidemux/guiplay.cpp	2007-02-02 19:29:16 UTC (rev 2791)
@@ -108,8 +108,6 @@
   uint32_t played_frame=0;
   uint32_t remaining=avifileinfo->nb_frames-curframe;
 
-    admPreview::stop();
-    admPreview::start();
     
     if(getPreviewMode()==ADM_PREVIEW_OUTPUT)
     {
@@ -119,6 +117,7 @@
     {
             filter=getFirstVideoFilter(curframe,remaining );
     }
+    
     max=filter->getInfo()->nb_frames;
 
     // compute how much a frame lasts in ms
@@ -149,10 +148,11 @@
      //renderStartPlaying();
 // reset timer reference
     resetTime();
+    admPreview::deferDisplay(1);
     do
     {
         vids++;
-        admPreview::update(played_frame,buffer);;
+        admPreview::displayNow(played_frame,buffer);;
         update_status_bar(buffer);
         if (time_a == 0)
             time_a = getTime(0);
@@ -170,6 +170,7 @@
             printf("\n cannot read frame!\n");
             goto abort_play;
         }
+        admPreview::update(played_frame+1,buffer);;
 	curframe++;
 	played_frame++;
 
@@ -221,13 +222,10 @@
     //____________________________________
     playing = 0;
 	  delete  buffer;
-
-	  // renderStopPlaying();
-	     admPreview::stop();
-             admPreview::start();
+          
 	   getFirstVideoFilter( );
-	   //video_body->getUncompressedFrame(curframe, rdr_decomp_buffer,&flags);
 	   GUI_getFrame(curframe, rdr_decomp_buffer, &flags);
+           admPreview::deferDisplay(0);
            admPreview::update(curframe,rdr_decomp_buffer);
      	   update_status_bar(rdr_decomp_buffer);
 #ifdef HAVE_AUDIO



From mean at mail.berlios.de  Fri Feb  2 21:00:39 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 2 Feb 2007 21:00:39 +0100
Subject: [Avidemux-svn-commit] r2792 - in
	branches/avidemux_2.4_branch/avidemux: .
	ADM_userInterfaces/ADM_GTK/ADM_gui2
Message-ID: <200702022000.l12K0d2E010839@sheep.berlios.de>

Author: mean
Date: 2007-02-02 21:00:39 +0100 (Fri, 02 Feb 2007)
New Revision: 2792

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp
   branches/avidemux_2.4_branch/avidemux/guiplay.cpp
Log:
mostly fix acclerated playback

Modified: branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp	2007-02-02 19:29:16 UTC (rev 2791)
+++ branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp	2007-02-02 20:00:39 UTC (rev 2792)
@@ -98,7 +98,17 @@
 */
 void admPreview::deferDisplay(uint32_t onoff)
 {
-      defered_display=onoff;
+      
+      if(onoff)
+      {
+        renderStartPlaying();
+        defered_display=1;
+      }
+      else
+      {
+        renderStopPlaying();
+        defered_display=0;
+      }
   
 }
 /**

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-02-02 19:29:16 UTC (rev 2791)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-02-02 20:00:39 UTC (rev 2792)
@@ -62,6 +62,9 @@
 static uint8_t GUI_ConvertRGB(uint8_t * in, uint8_t * out, uint32_t w, uint32_t h);
 static uint8_t GUI_ConvertRGBBlit(uint8_t * in, uint8_t * out,uint32_t totalW,uint32_t totalH, uint32_t startx,uint32_t starty,uint32_t w, uint32_t h,uint32_t primary);
 uint8_t  GUI_InitRender (GtkWidget *g, uint32_t w,uint32_t h);
+uint8_t BitBlit(uint8_t *dst, uint32_t pitchDest,uint8_t *src,uint32_t pitchSrc,uint32_t width, uint32_t height);
+
+
 static renderZoom zoom=ZOOM_1_1;
 
 static ColYuvRgb rgbConverter(640,480);
@@ -70,6 +73,7 @@
 extern GtkWidget *getDrawWidget( void );
 extern uint8_t UI_shrink(uint32_t w,uint32_t h);
 static AccelRender *accel_mode=NULL;
+static uint8_t *accelSurface=NULL;
 //_______________________________________
 
 static uint8_t 	        *screenBuffer=NULL;
@@ -177,14 +181,31 @@
       \brief Blit the source into destination
 
 */
+
 uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h,uint32_t primary)
 {
 
         ADM_assert(screenBuffer);
         lastImage=NULL;
         if(!accel_mode)
+        {
                 GUI_ConvertRGBBlit(ptr,screenBuffer, renderW,renderH,startx,starty,w,h,primary);
-        renderRefresh();
+                if(primary) renderRefresh();
+        }
+        else
+        { /* Accel mode, in that case we need to blit our part of the image inside the big image
+              It is assumed the accel render part can work with YV12
+          */
+          /* Luma */
+          uint32_t pageR=(renderW*renderH);
+          uint32_t pageS=(w*h);
+          BitBlit(accelSurface+startx+starty*renderW,renderW,ptr,w,w,h);
+          BitBlit(accelSurface+pageR+(startx>>1)+(starty>>1)*(renderW>>1),renderW>>1,ptr+pageS,w>>1,w>>1,h>>1);
+          BitBlit(accelSurface+(pageR*5)/4+(startx>>1)+(starty>>1)*(renderW>>1),renderW>>1,ptr+(pageS*5)/4,w>>1,w>>1,h>>1);
+
+          lastImage=accelSurface;
+          if(primary) renderRefresh();
+        }
         return 1;
 }
 
@@ -206,7 +227,6 @@
       {
           if(lastImage)
               accel_mode->display(lastImage, renderW, renderH);
-              //GUI_XvRedraw();
       }
       else
               GUI_RGBDisplay(screenBuffer, renderW, renderH,draw);
@@ -312,6 +332,12 @@
                 rgbConverter.reset(renderW,renderH);
                 printf("No accel used for rendering\n");
         }
+        else
+        {
+           ADM_assert(!accelSurface);
+           accelSurface=new uint8_t[ (renderW*renderH*3)>>1];
+          
+        }
 	
 	return 1;
 }
@@ -322,7 +348,10 @@
 	if(accel_mode)
 	{
 		accel_mode->end();
-		delete accel_mode;				
+		delete accel_mode;
+                if(accelSurface) delete [] accelSurface;
+                accelSurface=NULL;
+				
 	}
 	accel_mode=NULL;	
 	return 1;

Modified: branches/avidemux_2.4_branch/avidemux/guiplay.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/guiplay.cpp	2007-02-02 19:29:16 UTC (rev 2791)
+++ branches/avidemux_2.4_branch/avidemux/guiplay.cpp	2007-02-02 20:00:39 UTC (rev 2792)
@@ -149,6 +149,7 @@
 // reset timer reference
     resetTime();
     admPreview::deferDisplay(1);
+    admPreview::update(played_frame,buffer);
     do
     {
         vids++;



From mean at mail.berlios.de  Sat Feb  3 09:52:51 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 3 Feb 2007 09:52:51 +0100
Subject: [Avidemux-svn-commit] r2793 -
	branches/avidemux_2.4_branch/avidemux/ADM_script
Message-ID: <200702030852.l138qp9L021424@sheep.berlios.de>

Author: mean
Date: 2007-02-03 09:52:51 +0100 (Sat, 03 Feb 2007)
New Revision: 2793

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSGlobal.cpp
Log:
fix ? crash-at-exit

Modified: branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSGlobal.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSGlobal.cpp	2007-02-02 20:00:39 UTC (rev 2792)
+++ branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSGlobal.cpp	2007-02-03 08:52:51 UTC (rev 2793)
@@ -85,8 +85,8 @@
 {// begin SpidermonkeyDestroy
 #ifdef ADM_JS_THREADSAFE
 	JS_SetContextThread(g_pCx);
+	JS_DestroyContext(g_pCx);
 #endif
-	JS_DestroyContext(g_pCx);
 	JS_DestroyRuntime(g_pRt);
 }// end SpidermonkeyDestroy
 
@@ -117,8 +117,9 @@
 #ifdef ADM_JS_THREADSAFE
         JS_EndRequest(g_pCx);
         JS_ClearContextThread(g_pCx);
+#endif
         pthread_mutex_unlock(&g_pSpiderMonkeyMutex);
-#endif
+
         return NULL;
 }// end StartThreadSpidermonkey
 



From mean at mail.berlios.de  Sat Feb  3 10:11:53 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 3 Feb 2007 10:11:53 +0100
Subject: [Avidemux-svn-commit] r2794 - in
	branches/avidemux_2.4_branch/avidemux: . ADM_editor
	ADM_inputs/ADM_mpegdemuxer ADM_inputs/ADM_ogm
	ADM_libraries/ADM_utilities ADM_osSupport
	ADM_userInterfaces/ADM_GTK/ADM_gui2
	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk
	ADM_userInterfaces/ADM_NONE/ADM_dialog
	ADM_userInterfaces/ADM_QT4/ADM_filters
	ADM_userInterfaces/ADM_QT4/ADM_gui ADM_userInterfaces/ADM_commonUI
Message-ID: <200702030911.l139BrNx022395@sheep.berlios.de>

Author: mean
Date: 2007-02-03 10:11:51 +0100 (Sat, 03 Feb 2007)
New Revision: 2794

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_Video.h
   branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.hxx
   branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_indexer.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_indexer_mpeg2.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_probe.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_probeTS.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_video.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_ogm/ADM_ogm.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/ADM_image.h
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/avifmt2.h
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/prefs.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_debug.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_misc.h
   branches/avidemux_2.4_branch/avidemux/ADM_osSupport/win32.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_keymap.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/ADM_gladeSupport.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_busy.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_ui.h
   branches/avidemux_2.4_branch/avidemux/Makefile.am
Log:
grunster: mingw+path patch

Modified: branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_Video.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_Video.h	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_Video.h	2007-02-03 09:11:51 UTC (rev 2794)
@@ -24,7 +24,7 @@
 #include "avifmt.h"
 #include "avifmt2.h"
 
-#include "ADM_audio/aviaudio.hxx"
+#include "../ADM_audio/aviaudio.hxx"
 #include "ADM_compressedImage.h"
 typedef struct audioInfo
 {

Modified: branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.hxx
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.hxx	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.hxx	2007-02-03 09:11:51 UTC (rev 2794)
@@ -29,10 +29,10 @@
  ***************************************************************************/
  #ifndef __ADM_composer__
  #define __ADM_composer__
- #include "ADM_editor/ADM_Video.h"
- #include "ADM_codecs/ADM_codec.h"
+ #include "../ADM_editor/ADM_Video.h"
+ #include "../ADM_codecs/ADM_codec.h"
  #include "ADM_image.h"
- #include "ADM_editor/ADM_edCache.h"
+ #include "../ADM_editor/ADM_edCache.h"
  #include "ADM_pp.h"
  
 #define MAX_SEG  	100 // Should be enougth

Modified: branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_indexer.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_indexer.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_indexer.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -28,7 +28,7 @@
 #include "ADM_toolkit/toolkit.hxx"
 #include "ADM_toolkit/filesel.h"
 #include "ADM_osSupport/ADM_quota.h"
-#include "DIA_idx_pg.h"
+#include "ADM_userInterfaces/ADM_commonUI/DIA_idx_pg.h"
 
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_indexer_mpeg2.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_indexer_mpeg2.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_indexer_mpeg2.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -28,7 +28,7 @@
 #include "ADM_toolkit/toolkit.hxx"
 #include "ADM_toolkit/filesel.h"
 #include "ADM_osSupport/ADM_quota.h"
-#include "DIA_idx_pg.h"
+#include "ADM_userInterfaces/ADM_commonUI/DIA_idx_pg.h"
 
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_probe.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_probe.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_probe.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -28,7 +28,7 @@
 #include "ADM_toolkit/toolkit.hxx"
 #include "ADM_toolkit/filesel.h"
 #include "fourcc.h"
-#include "DIA_working.h"
+#include "ADM_userInterfaces/ADM_commonUI/DIA_working.h"
 
 
 
@@ -40,7 +40,7 @@
 #include "dmx_demuxerTS.h"
 #include "dmx_identify.h"
 #include "dmx_probe.h"
-#include "DIA_busy.h"
+#include "ADM_userInterfaces/ADM_commonUI/DIA_busy.h"
 #include "ADM_audio/ADM_mp3info.h"
 #include "ADM_audio/ADM_a52info.h"
 #include "ADM_audio/ADM_dcainfo.h"

Modified: branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_probeTS.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_probeTS.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_probeTS.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -28,7 +28,7 @@
 #include "ADM_toolkit/toolkit.hxx"
 #include "ADM_toolkit/filesel.h"
 #include "fourcc.h"
-#include "DIA_working.h"
+#include "ADM_userInterfaces/ADM_commonUI/DIA_working.h"
 
 
 
@@ -40,7 +40,7 @@
 #include "dmx_demuxerTS.h"
 #include "dmx_identify.h"
 #include "dmx_probe.h"
-#include "DIA_busy.h"
+#include "ADM_userInterfaces/ADM_commonUI/DIA_busy.h"
 #include "ADM_audio/ADM_mp3info.h"
 #include "ADM_audio/ADM_a52info.h"
 #include "ADM_audio/ADM_dcainfo.h"

Modified: branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_video.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_video.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_video.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -34,7 +34,7 @@
 
 
 #include "ADM_toolkit/toolkit.hxx"
-#include "DIA_working.h"
+#include "ADM_userInterfaces/ADM_commonUI/DIA_working.h"
 
 
 #include "dmx_demuxerEs.h"

Modified: branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_ogm/ADM_ogm.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_ogm/ADM_ogm.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_ogm/ADM_ogm.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -44,7 +44,7 @@
 #include "fourcc.h"
 #include "ADM_ogm.h"
 #include "ADM_ogmpages.h"
-#include "DIA_working.h"
+#include "ADM_userInterfaces/ADM_commonUI/DIA_working.h"
 #include "ADM_toolkit/toolkit.hxx"
 
 #include "ADM_osSupport/ADM_debugID.h"

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/ADM_image.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/ADM_image.h	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/ADM_image.h	2007-02-03 09:11:51 UTC (rev 2794)
@@ -22,8 +22,8 @@
 //
 #ifndef ADM_IMAGE
 #define ADM_IMAGE
-#include "ADM_assert.h"
-#include "ADM_colorspace/ADM_rgb.h"
+#include "../ADM_assert.h"
+#include "../ADM_colorspace/ADM_rgb.h"
 
 typedef enum ADM_ASPECT
 {

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/avifmt2.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/avifmt2.h	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/avifmt2.h	2007-02-03 09:11:51 UTC (rev 2794)
@@ -72,7 +72,7 @@
  #define AVI_B_FRAME		 0x4000	 // hopefully it is not used..
 #endif
 
-#include "ADM_audio/ADM_audiodef.h"
+#include "../ADM_audio/ADM_audiodef.h"
 
 void Endian_AviMainHeader(MainAVIHeader *m);
 void Endian_BitMapInfo( BITMAPINFOHEADER *b);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/prefs.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/prefs.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/prefs.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -1,3 +1,18 @@
+
+/***************************************************************************
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+
+#include "config.h"
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>

Modified: branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_debug.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_debug.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_debug.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -31,7 +31,7 @@
 
 // put here the module you want to be verbose (MODULE_xxx + MODULE_yyyy+  ....)
 #ifndef masked
-#define masked  (0) //+MODULE_3GP) //(MODULE_AUDIO_EDITOR) MODULE_OGM_AUDIO MODULE_REQUANT MODULE_CODEC
+#define masked  (0*MODULE_LAVFORMAT) //+MODULE_3GP) //(MODULE_AUDIO_EDITOR) MODULE_OGM_AUDIO MODULE_REQUANT MODULE_CODEC
 #endif
 
 // If the entitty is in masked we actually print the string

Modified: branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_misc.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_misc.h	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_misc.h	2007-02-03 09:11:51 UTC (rev 2794)
@@ -52,25 +52,25 @@
 void 		ADM_usleep(unsigned long us);
 uint8_t         ADM_fileExist(char *name);
 
-#ifdef CYG_MANGLING
-#ifndef HAVE_STRUCT_TIMESPEC
-#define HAVE_STRUCT_TIMESPEC
-extern "C"
-{
-	typedef struct timespec
+#ifdef HAVE_GETTIMEOFDAY
+	#define TIMZ struct timezone
+#else
+	#ifndef HAVE_STRUCT_TIMESPEC
+	#define HAVE_STRUCT_TIMESPEC
+	extern "C"
 	{
-		time_t tv_sec;
-		long int tv_nsec;
-	};
+		typedef struct timespec
+		{
+			time_t tv_sec;
+			long int tv_nsec;
+		};
 
-	void gettimeofday(struct timeval *p, void *tz);
-	};
-	#define timezone int
-	#define TIMZ int
+		void gettimeofday(struct timeval *p, void *tz);
+		};
+		#define timezone int
+		#define TIMZ int
+	#endif
 #endif
-#else
-	#define TIMZ struct timezone
-#endif
 
 #define FRAME_PAL 1
 #define FRAME_FILM 2

Modified: branches/avidemux_2.4_branch/avidemux/ADM_osSupport/win32.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_osSupport/win32.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_osSupport/win32.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -32,6 +32,8 @@
 		printf("WinSock ok\n");
 		return 1;
 }
+
+#ifndef HAVE_GETTIMEOFDAY
 void gettimeofday(struct timeval *p, void *tz)
 {
 unsigned long int sec;
@@ -47,6 +49,8 @@
   
 	
 }
+#endif
+
 uint64_t ftello_adm(FILE *f)
 {
 	fpos_t pos;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -26,26 +26,26 @@
 #include <gdk/gdkkeysyms.h>
 #include <gtk/gtk.h>
 
-#include <ADM_assert.h>
+#include <../ADM_assert.h>
 
 #include "math.h"
 #include "default.h"
 #include "ADM_commonUI/GUI_render.h"
-#include "gui_action.hxx"
+#include "../gui_action.hxx"
 
-#include "ADM_osSupport/ADM_debugID.h"
+#include "../ADM_osSupport/ADM_debugID.h"
 #define MODULE_NAME MODULE_UI
-#include "ADM_osSupport/ADM_debug.h"
-#include "ADM_toolkit_gtk/toolkit_gtk.h"
-#include "ADM_toolkit_gtk/ADM_gladeSupport.h"
+#include "../ADM_osSupport/ADM_debug.h"
+#include "../ADM_toolkit_gtk/toolkit_gtk.h"
+#include "../ADM_toolkit_gtk/ADM_gladeSupport.h"
 
-#include "ADM_codecs/ADM_codec.h"
+#include "../ADM_codecs/ADM_codec.h"
 #include "ADM_commonUI/GUI_ui.h"
 
-#include "ADM_toolkit/filesel.h"
-#include "ADM_editor/ADM_Video.h"
-#include "ADM_osSupport/ADM_misc.h"
-#include "prefs.h"
+#include "../ADM_toolkit/filesel.h"
+#include "../ADM_editor/ADM_Video.h"
+#include "../ADM_osSupport/ADM_misc.h"
+#include "../prefs.h"
 
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_keymap.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_keymap.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_keymap.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -35,7 +35,7 @@
 #include "math.h"
 #include "default.h"
 
-#include "gui_action.hxx"
+#include "../gui_action.hxx"
 extern void HandleAction(Action act);  
 // when keys are pressed
 // We have to duplicate the ALT ... shortcut

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -32,10 +32,10 @@
 #include <sys/time.h>
 
 
-#include "avi_vars.h"
-#include <ADM_assert.h>
+#include "../avi_vars.h"
+#include <../ADM_assert.h>
 
-#include "prototype.h"
+#include "../prototype.h"
 //#include "ADM_colorspace/colorspace.h"
 //#include "ADM_gui/GUI_vars.h"
 
@@ -52,10 +52,10 @@
 
 #include "ADM_toolkit_gtk/toolkit_gtk.h"
 
-#include "prefs.h"
+#include "../prefs.h"
 #include "../../../ADM_colorspace/ADM_rgb.h"
 #include "../../../ADM_libraries/ADM_libswscale/ADM_mp.h"
-#include "gtkgui.h"
+#include "../gtkgui.h"
 
 
 static uint8_t	updateWindowSize(GtkWidget * win, uint32_t w, uint32_t h);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/ADM_gladeSupport.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/ADM_gladeSupport.h	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/ADM_gladeSupport.h	2007-02-03 09:11:51 UTC (rev 2794)
@@ -67,4 +67,4 @@
 
  extern void guiCallback(GtkMenuItem *men, gpointer user_data);
  
- #include "gui_action.hxx"
+ //#include "..\gui_action.hxx"

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_busy.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_busy.cpp	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_busy.cpp	2007-02-03 09:11:51 UTC (rev 2794)
@@ -17,7 +17,7 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-
+#include "config.h"
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <unistd.h>

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Makefile.am	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Makefile.am	2007-02-03 09:11:51 UTC (rev 2794)
@@ -12,7 +12,7 @@
 
 include ../Makefile.adm
 filter_rsc.cpp : filter.qrc
-	rcc  $< -o $@   -name filter
+	$(RCC)  $< -o $@   -name filter
 
 
 EXTRA_DIST =  

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Makefile.am	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Makefile.am	2007-02-03 09:11:51 UTC (rev 2794)
@@ -15,6 +15,6 @@
 include ../Makefile.adm
 
 avidemux_rsc.cpp : avidemux.qrc
-	rcc  $< -o $@	-name avidemux
+	$(RCC)  $< -o $@	-name avidemux
 EXTRA_DIST =
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_ui.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_ui.h	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_ui.h	2007-02-03 09:11:51 UTC (rev 2794)
@@ -1,7 +1,7 @@
 #ifndef ADM_GUI_UI_H
 #define ADM_GUI_UI_H
 
-#include "ADM_editor/ADM_outputfmt.h"
+#include "../ADM_editor/ADM_outputfmt.h"
 
 void UI_updateFrameCount(uint32_t curFrame);
 void UI_setFrameCount(uint32_t curFrame,uint32_t total);

Modified: branches/avidemux_2.4_branch/avidemux/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/Makefile.am	2007-02-03 08:52:51 UTC (rev 2793)
+++ branches/avidemux_2.4_branch/avidemux/Makefile.am	2007-02-03 09:11:51 UTC (rev 2794)
@@ -17,6 +17,10 @@
 libmpeg2enc_Altivec = ./mpeg2enc/altivec/libaltivec.la
 endif
 
+if HAVE_CYGWIN
+win32_icon = ./xpm/adm.o
+endif
+
 user_interface_gtk = ./ADM_userInterfaces/ADM_GTK/ADM_gui2/libADM_gui2.a	\
 		./ADM_userInterfaces/ADM_GTK/libADM_GTK.a \
 		./ADM_userInterfaces/ADM_GTK/ADM_dialog/libADM_dialog.a	\
@@ -125,7 +129,9 @@
 ./ADM_osSupport/libADM_ossupport.a			\
 ./ADM_libraries/ADM_libswscale/libswscale.a		\
 ./ADM_ocr/libADM_ocr.a					\
-$(libmpeg2enc_Altivec)
+$(libmpeg2enc_Altivec) \
+$(win32_icon)
+
 if ADM_UI_GTK
 avidemux2_gtk_LDADD=$(adm_lib) $(user_interface_gtk) $(adm_postlib) $(all_libraries)  $(SDL_LIBS) $(GTK_LIBS) $(FREETYPE_LIBS) $(FC_LIBS) $(ARTS_LIBS) $(XML_LIBS) $(GLIB_LIBS)
 endif



From mean at mail.berlios.de  Sat Feb  3 10:12:56 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 3 Feb 2007 10:12:56 +0100
Subject: [Avidemux-svn-commit] r2795 - in
	branches/avidemux_2.4_branch/avidemux: ADM_audio
	ADM_libraries/ADM_lavcodec/libpostproc
Message-ID: <200702030912.l139CuCY022446@sheep.berlios.de>

Author: mean
Date: 2007-02-03 10:12:54 +0100 (Sat, 03 Feb 2007)
New Revision: 2795

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_audio/aviaudio.hxx
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/libpostproc/postprocess.c
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/libpostproc/postprocess_internal.h
Log:
grunster: mingw+path patch

Modified: branches/avidemux_2.4_branch/avidemux/ADM_audio/aviaudio.hxx
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_audio/aviaudio.hxx	2007-02-03 09:11:51 UTC (rev 2794)
+++ branches/avidemux_2.4_branch/avidemux/ADM_audio/aviaudio.hxx	2007-02-03 09:12:54 UTC (rev 2795)
@@ -22,7 +22,7 @@
 class AviList;
 
 
-#include "ADM_audio/ADM_audiodef.h"
+#include "../ADM_audio/ADM_audiodef.h"
 typedef struct
 {
 	uint16_t	encoding;	
@@ -66,7 +66,7 @@
 #define WAV_QDM2 	58
 #define WAV_IMAADPCM    17
 #define WAV_UNKNOWN     9999
-#include "ADM_audiocodec/ADM_audiocodec.h"
+#include "../ADM_audiocodec/ADM_audiocodec.h"
 #include "ADM_fileio.h"
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/libpostproc/postprocess.c
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/libpostproc/postprocess.c	2007-02-03 09:11:51 UTC (rev 2794)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/libpostproc/postprocess.c	2007-02-03 09:12:54 UTC (rev 2795)
@@ -74,7 +74,7 @@
 //Changelog: use the Subversion log
 
 #include "config.h"
-#include "avutil.h"
+#include "../../ADM_lavutil/avutil.h"
 #include <inttypes.h>
 #include <stdio.h>
 #include <stdlib.h>

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/libpostproc/postprocess_internal.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/libpostproc/postprocess_internal.h	2007-02-03 09:11:51 UTC (rev 2794)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/libpostproc/postprocess_internal.h	2007-02-03 09:12:54 UTC (rev 2795)
@@ -23,7 +23,7 @@
  * internal api header.
  */
 
-#include "avutil.h"
+#include "../../ADM_lavutil/avutil.h"
 
 #define V_DEBLOCK       0x01
 #define H_DEBLOCK       0x02



From mean at mail.berlios.de  Sat Feb  3 10:19:06 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 3 Feb 2007 10:19:06 +0100
Subject: [Avidemux-svn-commit] r2796 - branches/avidemux_2.4_branch
Message-ID: <200702030919.l139J6kx022734@sheep.berlios.de>

Author: mean
Date: 2007-02-03 10:19:06 +0100 (Sat, 03 Feb 2007)
New Revision: 2796

Modified:
   branches/avidemux_2.4_branch/configure.in.in
Log:
grunster: win32

Modified: branches/avidemux_2.4_branch/configure.in.in
===================================================================
--- branches/avidemux_2.4_branch/configure.in.in	2007-02-03 09:12:54 UTC (rev 2795)
+++ branches/avidemux_2.4_branch/configure.in.in	2007-02-03 09:19:06 UTC (rev 2796)
@@ -41,8 +41,11 @@
 AM_INIT_AUTOMAKE(avidemux,"2.4.0")
 ADM_SUBVERSION="0"
 if [[ -f .svn/entries ]]; then
-   rev=`svnversion . | sed 's/^.*://g' | sed 's/M$//g'`
-   ADM_SUBVERSION="\"$rev\""
+	AC_PATH_PROG(SVNVERSION, svnversion, no)
+	if test "$SVNVERSION" != "no" ; then
+		rev=`svnversion . | sed 's/^.*://g' | sed 's/M$//g'`
+		ADM_SUBVERSION="\"$rev\""
+	fi
 fi
 dnl almost the same like KDE_SET_PEFIX but the path is /usr/local
 dnl
@@ -232,6 +235,7 @@
     QTLIBS="-L$QTEXTRALIB -lopengl32 -lglu32 -lgdi32 -luser32 -lmingw32 -lqtmain -lQtOpenGL4 -lQtGui4 -lQtCore4 -mthreads -Wl,-enable-stdcall-fixup -Wl,-enable-auto-import -Wl,-enable-runtime-pseudo-reloc -Wl,-s -Wl,-s -Wl,-subsystem,windows"
     QTINC="-I$QTDIR/include -I$QTDIR/include/QtCore -I$QTDIR/include/QtGui -I$QTDIR/include/QtOpenGL -DUNICODE -DQT_LARGEFILE_SUPPORT -DQT_DLL -DQT_NO_DEBUG -DQT_OPENGL_LIB -DQT_GUI_LIB -DQT_CORE_LIB -DQT_THREAD_SUPPORT -DQT_NEEDS_QMAIN -frtti -fexceptions -I$QTEXTRAINC"
     QTBIN="$QTDIR/bin"
+	QTPOSTFIX=""
     ;;
   *)
     AC_MSG_NOTICE(I'm assuming this is Linux)
@@ -250,6 +254,13 @@
 ADM_QTINCLUDES="$QTINC"
 ADM_QTCFLAGS="$QTINC"
 
+MOC="$QTBIN/moc$QTPOSTFIX"
+UIC="$QTBIN/uic$QTPOSTFIX"
+RCC="$QTBIN/rcc"
+AC_SUBST(MOC)
+AC_SUBST(UIC)
+AC_SUBST(RCC)
+
 # Now we check whether we can actually build a Qt app.
 cat > myqt.h << EOF
 #include <QObject>
@@ -278,7 +289,7 @@
 EOF
 
 AC_MSG_CHECKING(does moc work?)
-bnv_try_1="moc$QTPOSTFIX myqt.h -o moc_myqt.cpp"
+bnv_try_1="$MOC myqt.h -o moc_myqt.cpp"
 AC_TRY_EVAL(bnv_try_1)
 if test x"$ac_status" != x0; then
    AC_MSG_WARN(moc doesn't work)
@@ -318,10 +329,7 @@
 fi
 AC_MSG_RESULT(yes)
 rm -f moc_myqt.cpp myqt.h myqt.cpp myqt.o myqt moc_myqt.o
-MOC="moc$QTPOSTFIX"
-UIC="uic$QTPOSTFIX"
-AC_SUBST(MOC)
-AC_SUBST(UIC)
+
 echo " ------------------- End of UI probe ------------------"
     
 dnl 
@@ -413,46 +421,61 @@
 ])
 
 AC_MSG_RESULT($use_cygwin)
+AM_CONDITIONAL(HAVE_CYGWIN, test "x$use_cygwin" = "xyes")
 
+dnl _________ gettimeofday _________
+AC_CHECK_FUNCS(gettimeofday, AC_DEFINE(HAVE_GETTIMEOFDAY,1,"[Use native gettimeofday function]"))
+
 dnl _____________ needed for multithreaded x264 and for mplex_________
 if test "x$use_cygwin" = "xyes"; then
-        LDFLAGS="$LDFLAGS -lpthreadGC1 "
+        LIBS="$LIBS -lpthreadGC1"
 else
         LDFLAGS="$LDFLAGS -lpthread -lX11 -lXext -L/usr/X11R6/lib"
 fi
+
 dnl _________________ malloc.h ___________________
 
 AC_CHECK_HEADERS(malloc.h,have_malloc_h=yes)
 AC_CHECK_HEADERS(malloc/malloc.h,have_malloc_h=yes)
 if test "x$have_malloc_h" = "xyes"; then
 	CPPFLAGS="$CPPFLAGS -I/usr/include/malloc"
-	AC_DEFINE(HAVE_MALLOC_H,1,[have malloc.h])
-	
+	AC_DEFINE(HAVE_MALLOC_H,1,[have malloc.h])	
 fi
 
 dnl ______________ libxml2 _____________
 AC_PATH_PROG(XML_CONFIG, xml2-config, no)
- if test "XML_CONFIG" = "no" ; then
-	   	XML_LIBS=""
-    		XML_CFLAGS=""
-      		have_xml2=no
-	else
+if test "$XML_CONFIG" = "no" ; then
+ 	XML_LIBS=""
+	XML_CFLAGS=""
+	
+	if test "x$use_cygwin" = "xno"; then
+		have_xml2=no
+	fi
+fi
 
- 		XML_CFLAGS=`$XML_CONFIG  --cflags`
- 		XML_LIBS=`$XML_CONFIG  --libs`
-    old_flags=$CPPFLAGS
-    CPPFLAGS="$CPPFLAGS $XML_CFLAGS"
-    AC_CHECK_HEADERS(libxml/parser.h,,have_xml2=no)
-    if test "x$have_xml2" = "xno"; then
-    	AC_MSG_WARN(no parser.h valid header found for xml2)
-    fi
- fi
 if test "x$have_xml2" = "xyes"; then
-AC_DEFINE(USE_LIBXML2,1,[LibXML2 is available])
+	if test "$XML_CONFIG" = "no" ; then
+		XML_LIBS="-L${libdir} -llibxml2 -lz -liconv -lws2_32"
+		XML_CFLAGS="-I${includedir}/libxml2"
+ 	else
+		XML_CFLAGS=`$XML_CONFIG  --cflags`
+		XML_LIBS=`$XML_CONFIG  --libs`
+	fi
+
+	old_flags=$CPPFLAGS
+	CPPFLAGS="$CPPFLAGS $XML_CFLAGS"
+
+	AC_CHECK_HEADERS(libxml/parser.h,,have_xml2=no)
+	
+	if test "x$have_xml2" = "xyes"; then
+		AC_DEFINE(USE_LIBXML2,1,[LibXML2 is available])		
+	else
+		AC_MSG_WARN(no parser.h valid header found for xml2)
+	fi
 fi
-dnl __________________divx______________
-dnl __________________Aften ______________
 
+dnl __________________Aften______________
+
 AC_ARG_WITH([aften],
  AC_HELP_STRING([--without-aften], [Force compilation without aften (default: test)]),
  [with_aften=${withval}], [with_aften=test])
@@ -475,8 +498,6 @@
 AC_DEFINE(USE_AFTEN,1,[use aften ac3 encoder])
 fi
 
-
-dnl __________________/aften ______________
 dnl __________________x264_________________
 AC_MSG_CHECKING(for x264 codec )
 AC_CHECK_HEADER(x264.h,,have_x264=no)
@@ -487,7 +508,7 @@
 	AC_DEFINE(USE_X264,1,[use x264 encoder])
 fi
 
-dnl __________________xvid 0.9 ______________
+dnl __________________xvid 0.9______________
 AC_MSG_CHECKING(for xvid codec 0.9)
 AC_CHECK_HEADER(xvid.h,,have_xx_xvid=no)
 
@@ -515,7 +536,8 @@
  if test "x$have_xx_xvid" = "xyes"; then
  	AC_DEFINE(USE_XX_XVID,1,[use xvid api])
  fi
-dnl __________________libpng  ______________
+
+dnl __________________libpng______________
 AC_MSG_CHECKING(for libpng )
 have_png=yes
 AC_CHECK_HEADER(png.h,,have_png=no)
@@ -524,7 +546,8 @@
 if test "x$have_png" = "xyes"; then
 	AC_DEFINE(USE_PNG,1,[Png is available])
 fi
-dnl __________________xvid 1.0 ______________
+
+dnl __________________xvid 1.0______________
 AC_MSG_CHECKING(for xvid codec 1.0)
 AC_CHECK_HEADER(xvid.h,,have_xvid4=no)
 



From mean at mail.berlios.de  Sat Feb  3 19:50:48 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 3 Feb 2007 19:50:48 +0100
Subject: [Avidemux-svn-commit] r2797 -
	branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer
Message-ID: <200702031850.l13IomWs022421@sheep.berlios.de>

Author: mean
Date: 2007-02-03 19:50:48 +0100 (Sat, 03 Feb 2007)
New Revision: 2797

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_indexer.cpp
Log:
fix type that broke TS indexing

Modified: branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_indexer.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_indexer.cpp	2007-02-03 09:19:06 UTC (rev 2796)
+++ branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mpegdemuxer/dmx_indexer.cpp	2007-02-03 18:50:48 UTC (rev 2797)
@@ -107,14 +107,15 @@
                                 demuxer=dmx;
                                 mpegTypeChar='T';
                                 switch(tracks[0].streamType)
-                                {
-                                  case ADM_STREAM_H264:       payloadType=DMX_PAYLOAD_H264;break;
-                                  case ADM_STREAM_MPEG4:      payloadType=DMX_PAYLOAD_MPEG4;break;
-                                  case ADM_STREAM_MPEG_VIDEO: payloadType=DMX_PAYLOAD_MPEG2;break;
-                                default: ADM_assert(0);
+                                  {
+                                    case ADM_STREAM_H264:       payloadType=DMX_PAYLOAD_H264;break;
+                                    case ADM_STREAM_MPEG4:      payloadType=DMX_PAYLOAD_MPEG4;break;
+                                    case ADM_STREAM_MPEG_VIDEO: payloadType=DMX_PAYLOAD_MPEG2;break;
+                                  default: ADM_assert(0);
+  
+                                  }
                                 break;
                                 }
-                                }
                 case DMX_MPG_ES:
                                 demuxer=new dmx_demuxerES;
                                 mpegTypeChar='E';



From mean at mail.berlios.de  Sat Feb  3 22:09:07 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 3 Feb 2007 22:09:07 +0100
Subject: [Avidemux-svn-commit] r2798 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog
Message-ID: <200702032109.l13L97O8019921@sheep.berlios.de>

Author: mean
Date: 2007-02-03 22:09:06 +0100 (Sat, 03 Feb 2007)
New Revision: 2798

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_busy.cpp
Log:
oops

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_busy.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_busy.cpp	2007-02-03 18:50:48 UTC (rev 2797)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_busy.cpp	2007-02-03 21:09:06 UTC (rev 2798)
@@ -17,7 +17,7 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-
+#include "config.h"
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <unistd.h>



From mean at mail.berlios.de  Sun Feb  4 20:39:25 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 4 Feb 2007 20:39:25 +0100
Subject: [Avidemux-svn-commit] r2799 - in
	branches/avidemux_2.4_branch/avidemux: ADM_encoder
	ADM_libraries/ADM_xvidratectl ADM_outputs/oplug_mpegFF
Message-ID: <200702041939.l14JdP40006715@sheep.berlios.de>

Author: mean
Date: 2007-02-04 20:39:24 +0100 (Sun, 04 Feb 2007)
New Revision: 2799

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encffmpeg.h
   branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encffmpeg1.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encmpeg2enc.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encmpeg2enc.h
   branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encoder.h
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_ratecontrol.h
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_xvidratectlVBV.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp
Log:
try to detected corrupted 1st pass log file

Modified: branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encffmpeg.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encffmpeg.h	2007-02-03 21:09:06 UTC (rev 2798)
+++ branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encffmpeg.h	2007-02-04 19:39:24 UTC (rev 2799)
@@ -208,6 +208,7 @@
   virtual uint8_t stop (void);
   virtual uint8_t startPass2 (void);
   virtual uint8_t startPass1 (void);
+          uint8_t verifyLog(const char *name,uint32_t nbFrame);
 };
 
 class EncodeFFMPEGSNow:public EncoderFFMPEG

Modified: branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encffmpeg1.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encffmpeg1.cpp	2007-02-03 21:09:06 UTC (rev 2798)
+++ branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encffmpeg1.cpp	2007-02-04 19:39:24 UTC (rev 2799)
@@ -296,9 +296,20 @@
   return 1;
 
 }
+uint8_t EncoderFFMPEGMpeg1::verifyLog(const char *file,uint32_t nbFrame)
+{
+  
+  if(_use_xvid_ratecontrol)
+  {
+      return ADM_newXvidRcVBV::verifyLog(file,nbFrame);
+  }else
+  {
+    return 0; // For now assume it is corrupted 
+  }
+  
+}
 
 
-
 uint8_t
 EncoderFFMPEGMpeg1::startPass1 (void)
 {

Modified: branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encmpeg2enc.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encmpeg2enc.cpp	2007-02-03 21:09:06 UTC (rev 2798)
+++ branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encmpeg2enc.cpp	2007-02-04 19:39:24 UTC (rev 2799)
@@ -75,8 +75,18 @@
 static ADM_newXvidRcVBV *_xrc = NULL;
 extern uint32_t ADM_computeBitrate(uint32_t fps1000, uint32_t nbFrame, uint32_t sizeInMB);
 
+/**
+      \fn verifyLog
+      \brief Ask the RC if the 2pass log file is correct
+      @param file filename
+      @param nb nbFrames expected to be present
+      @return 1 if file is ok, 0 is corrupted
 
-
+*/
+uint8_t EncoderMpeg2enc::verifyLog(const char *file,uint32_t nbFrame)
+{
+      return ADM_newXvidRcVBV::verifyLog(file,nbFrame+2);
+}
 /*_________________________________________________*/
 EncoderMpeg2enc::EncoderMpeg2enc (MPEG2ENC_ID id, COMPRES_PARAMS * config)
 {

Modified: branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encmpeg2enc.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encmpeg2enc.h	2007-02-03 21:09:06 UTC (rev 2798)
+++ branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encmpeg2enc.h	2007-02-04 19:39:24 UTC (rev 2799)
@@ -55,6 +55,7 @@
     virtual const char *getCodecName (void) {return "MPEG";};
     virtual const char *getFCCHandler (void) {return "MPEG";};
     virtual const char *getDisplayName (void) {return "MPEG";}; // FIXME
+            uint8_t verifyLog(const char *name,uint32_t nbFrame);
 
 };
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encoder.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encoder.h	2007-02-03 21:09:06 UTC (rev 2798)
+++ branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encoder.h	2007-02-04 19:39:24 UTC (rev 2799)
@@ -95,6 +95,7 @@
   virtual const char *getCodecName (void) = 0;
   virtual const char *getFCCHandler (void) = 0;
   virtual const char *getDisplayName (void) = 0;
+  virtual uint8_t verifyLog(const char *,uint32_t nb) { return 1;} // Verify 1st pass log file..
 
 
 };

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_ratecontrol.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_ratecontrol.h	2007-02-03 21:09:06 UTC (rev 2798)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_ratecontrol.h	2007-02-04 19:39:24 UTC (rev 2799)
@@ -119,7 +119,7 @@
 	virtual		uint8_t startPass2( uint32_t size,uint32_t nbFrame );
 	virtual		uint8_t getQz( uint32_t *qz, ADM_rframe *type );
 	virtual		uint8_t logPass2( uint32_t qz, ADM_rframe ftype,uint32_t size);
-
+        static          uint8_t verifyLog(const char *file,uint32_t nbFrame);
 };
 
 #endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_xvidratectlVBV.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_xvidratectlVBV.cpp	2007-02-03 21:09:06 UTC (rev 2798)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_xvidratectlVBV.cpp	2007-02-04 19:39:24 UTC (rev 2799)
@@ -160,6 +160,35 @@
 	
 	return 1;
 }
+
+/**
+      \fn ADM_newXvidRcVBV::verifyLog
+      \brief Verify the file is correct and not corrupted as far as 2pass is concerned
+      @return 1 on success (file not corrupted), 0 else.
+
+  A note of warning, the actual nbFrame can depend on the encoder/codec as there might be some
+  encoder-delay that is more or less ignored
+  Normally nbFrame should be actual nb frame +2 (to compensate for the 2 comment lines in xvid rc file)
+  but as it is, when you use lavc based mpeg codec, the whole process will eat up 2 frames.
+
+*/
+uint8_t ADM_newXvidRcVBV::verifyLog(const char *file,uint32_t nbFrame)
+{
+  FILE *in;
+  char oneLine[1024];
+  uint32_t nb=0;
+        in=fopen(file,"rt");
+        if(!in) return 0;
+        while(fgets(oneLine,1023,in)) nb++;
+        fclose(in);
+        if(nbFrame+1==nb) 
+        {
+            printf("[XvidRC]Logfile Seems ok\n");
+            return 1;
+        }
+        printf("[XvidRC]Logfile Seems corrupted (%u/%u)\n",nb,nbFrame);
+        return 0;
+}
 //
 // Return 1 if the frame and Qz fails the sanity check
 //

Modified: branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp	2007-02-03 21:09:06 UTC (rev 2798)
+++ branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp	2007-02-04 19:39:24 UTC (rev 2799)
@@ -316,19 +316,17 @@
 
 
         // pass 1
-        if(encoder->isDualPass())
+        if(encoder->isDualPass()) //Cannot be requant
         {
                         FILE *fd;
                         uint8_t reuse=0;
-                        fd=fopen(twoPass,"rt");
-                        if(fd)
-                        {
+                        
+                        printf("Verifying log file\n");
+                        if(encoder->verifyLog(twoPass,total))
                           if(GUI_Question(_("Reuse log file ?")))
                                 {
                                         reuse=1;
                                 }
-                                fclose(fd);
-                        }
                         if(!reuse)
                         {
                                 encoding->setPhasis ("Pass 1/2");



From mean at mail.berlios.de  Mon Feb  5 08:09:21 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 5 Feb 2007 08:09:21 +0100
Subject: [Avidemux-svn-commit] r2800 - in
	branches/avidemux_2.4_branch/avidemux: .
	ADM_userInterfaces/ADM_GTK/ADM_gui2
	ADM_userInterfaces/ADM_NONE/ADM_gui2 ADM_userInterfaces/ADM_commonUI
Message-ID: <200702050709.l1579L0L002613@sheep.berlios.de>

Author: mean
Date: 2007-02-05 08:09:20 +0100 (Mon, 05 Feb 2007)
New Revision: 2800

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_accelRender.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am
   branches/avidemux_2.4_branch/avidemux/Makefile.am
Log:
factorize display code (part I)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-02-04 19:39:24 UTC (rev 2799)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-02-05 07:09:20 UTC (rev 2800)
@@ -1,12 +1,9 @@
 /***************************************************************************
-                          gui_render.cpp  -  description
-
-	The final render a frame. The external interface is the same
-	whatever the mean (RGB/YUV/Xv)
+    Hook to Gfx toolkit concerning display (RGB or accel)
                              -------------------
-    begin                : Thu Jan 3 2002
-    copyright            : (C) 2002 by mean
-    email                : fixounet at free.fr
+    
+    copyright            : (C) 2007 by mean
+    email                : Mean/fixounet at free.fr
  ***************************************************************************/
 
 /***************************************************************************
@@ -35,9 +32,6 @@
 #include "../avi_vars.h"
 #include <../ADM_assert.h>
 
-#include "../prototype.h"
-//#include "ADM_colorspace/colorspace.h"
-//#include "ADM_gui/GUI_vars.h"
 
 
 #include "ADM_commonUI/GUI_render.h"
@@ -58,366 +52,54 @@
 #include "../gtkgui.h"
 
 
-static uint8_t	updateWindowSize(GtkWidget * win, uint32_t w, uint32_t h);
-static uint8_t GUI_ConvertRGB(uint8_t * in, uint8_t * out, uint32_t w, uint32_t h);
-static uint8_t GUI_ConvertRGBBlit(uint8_t * in, uint8_t * out,uint32_t totalW,uint32_t totalH, uint32_t startx,uint32_t starty,uint32_t w, uint32_t h,uint32_t primary);
-uint8_t  GUI_InitRender (GtkWidget *g, uint32_t w,uint32_t h);
-uint8_t BitBlit(uint8_t *dst, uint32_t pitchDest,uint8_t *src,uint32_t pitchSrc,uint32_t width, uint32_t height);
-
-
-static renderZoom zoom=ZOOM_1_1;
-
-static ColYuvRgb rgbConverter(640,480);
-static ColYuvRgb rgbConverter2(640,480);
-
 extern GtkWidget *getDrawWidget( void );
-extern uint8_t UI_shrink(uint32_t w,uint32_t h);
-static AccelRender *accel_mode=NULL;
-static uint8_t *accelSurface=NULL;
-//_______________________________________
 
-static uint8_t 	        *screenBuffer=NULL;
-static ADMImage                 *resized=NULL;
-static ADM_MplayerResize         *resizer=NULL;
-static uint8_t		 *lastImage=NULL;
-static GtkWidget 	*draw=NULL;
-static uint32_t 	renderW=0,renderH=0;
-
-//_______________________________________
 /**
-	Render init, initialize internals. Constuctor like function
-
+    \brief return pointer to the drawing widget that displays video
 */
-uint8_t renderInit( void )
+void *UI_getDrawWidget(void)
 {
-	draw=getDrawWidget(  );
-	return 1;
+  return (void *) getDrawWidget();
 }
-
 /**
-	Warn the renderer that the display size is changing
-
+    \brief Display to widget in RGB32
 */
-//----------------------------------------
-uint8_t renderResize(uint32_t w, uint32_t h,renderZoom newzoom)
+void UI_rgbDraw(void *widg,uint32_t w, uint32_t h,uint8_t *ptr)
 {
-int mul,xx,yy;
+    GtkWidget *widget;
+    widget = (GtkWidget *)widg; 
 
-	if(screenBuffer) 
-		{
-			delete  [] screenBuffer;
-			screenBuffer=NULL;
-		}
-        if(resized)
-        {
-                        delete resized;
-                        resized=NULL;
-        }
-        if(resizer)
-        {
-                delete resizer;
-                resizer=NULL;
-        }
-        zoom=newzoom;
-        switch(zoom)
-        {
-                case ZOOM_1_4: mul=1;break;
-                case ZOOM_1_2: mul=2;break;
-                case ZOOM_1_1: mul=4;break;
-                case ZOOM_2:   mul=8;break;
-                case ZOOM_4:   mul=16;break;
-                default : ADM_assert(0);
 
-        }
-        xx=(w*mul+3)/4;
-        yy=(h*mul+3)/4;
-
-        if(xx&1) xx++;
-        if(yy&1) yy++;
-
-        screenBuffer=new uint8_t[xx*yy*4];
-
-        if(zoom!=ZOOM_1_1)
-        {
-                 resizer=new ADM_MplayerResize(w,h,xx,yy);
-                 resized=new ADMImage(xx,yy);
-        }
-
-	updateWindowSize( draw,xx,yy);
-	UI_purge();
-	return 1;
-
+    gdk_draw_rgb_32_image(widget->window, widget->style->fg_gc[GTK_STATE_NORMAL], 0,    // X
+                       0,       // y
+                       w,       //width
+                       h,       //h*2, // heigth
+                       GDK_RGB_DITHER_NONE,
+                       //GDK_RGB_DITHER_MAX,  // dithering
+                       (guchar *) ptr,  // buffer
+                       w * 4);
 }
 /**
-	Update the image and render it
-	The width and hiehgt must NOT have changed
-
+      \brief Resize the window
 */
-//----------------------------------------
-uint8_t renderUpdateImage(uint8_t *ptr)
+void  UI_updateDrawWindowSize(void *win,uint32_t w,uint32_t h)
 {
-	
-        ADM_assert(screenBuffer);
-        if(zoom!=ZOOM_1_1)
-        {
-                ADM_assert(resizer);
-                ADM_assert(resized);
-                resizer->resize(ptr,resized->data);
-                lastImage=resized->data;
-                ptr=lastImage;
-        }
-        else
-        {
-                lastImage=ptr;
-        }
-	if(!accel_mode)
-	 	GUI_ConvertRGB(ptr,screenBuffer, renderW,renderH);
-	renderRefresh();
-	return 1;
-
+    gtk_widget_set_usize((GtkWidget *)win, w, h);
 }
 /**
-      \fn renderUpdateImageBlit
-      \brief Blit the source into destination
-
+      \brief Retrieve info from window, needed for accel layer
 */
-
-uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h,uint32_t primary)
+void UI_getWindowInfo(void *draw, GUI_WindowInfo *xinfo)
 {
-
-        ADM_assert(screenBuffer);
-        lastImage=NULL;
-        if(!accel_mode)
-        {
-                GUI_ConvertRGBBlit(ptr,screenBuffer, renderW,renderH,startx,starty,w,h,primary);
-                if(primary) renderRefresh();
-        }
-        else
-        { /* Accel mode, in that case we need to blit our part of the image inside the big image
-              It is assumed the accel render part can work with YV12
-          */
-          /* Luma */
-          uint32_t pageR=(renderW*renderH);
-          uint32_t pageS=(w*h);
-          BitBlit(accelSurface+startx+starty*renderW,renderW,ptr,w,w,h);
-          BitBlit(accelSurface+pageR+(startx>>1)+(starty>>1)*(renderW>>1),renderW>>1,ptr+pageS,w>>1,w>>1,h>>1);
-          BitBlit(accelSurface+(pageR*5)/4+(startx>>1)+(starty>>1)*(renderW>>1),renderW>>1,ptr+(pageS*5)/4,w>>1,w>>1,h>>1);
-
-          lastImage=accelSurface;
-          if(primary) renderRefresh();
-        }
-        return 1;
-}
-
-/**
-	Refresh the image from internal buffer / last image
-	Used for example as call back for X11 events
-
-*/
-//_______________________________________________
-uint8_t renderRefresh(void)
-{
-      if(!screenBuffer)
-      {
-              if(accel_mode) ADM_assert(0);
-              return 0;
-      }
-
-      if(accel_mode)
-      {
-          if(lastImage)
-              accel_mode->display(lastImage, renderW, renderH);
-      }
-      else
-              GUI_RGBDisplay(screenBuffer, renderW, renderH,draw);
-  return 1;
-}
-
-uint8_t renderExpose(void)
-{
-	if(!screenBuffer)
-	{
-		if(accel_mode) ADM_assert(0);
-		return 0;
-	}
-
-
-    if ( accel_mode)
-    {	
-        if(lastImage)
-		accel_mode->display(lastImage,renderW,renderH);
-    }
-    else
-	GUI_RGBDisplay(screenBuffer, renderW, renderH,draw);
-    return 1;
-
-}
-uint8_t renderStartPlaying( void )
-{
-char *displ;
-unsigned int renderI;
-ADM_RENDER_TYPE render;
-	ADM_assert(!accel_mode);
-	// First check if local
-	// We do it in a very wrong way : If DISPLAY!=:0.0 we assume remote display
-	// in that case we do not even try to use accel
-	
-	// Win32 does not have display
-#ifndef CYG_MANGLING	
-	displ=getenv("DISPLAY");
-	if(!displ)
-	{
-		return 0;
-	}
-	if(strcmp(displ,":0") && strcmp(displ,":0.0"))
-	{
-		printf("Looks like remote display, no Xv :%s\n",displ);
-		return 1;
-	}
-#endif	
- 
-        if(prefs->get(DEVICE_VIDEODEVICE,&renderI)!=RC_OK)
-        {       
-                render=RENDER_GTK;
-        }else
-        {
-                render=(ADM_RENDER_TYPE)renderI;
-        }
-        GUI_Info xinfo;
         GdkWindow *win;
+        GtkWidget *widget=(GtkWidget *)draw;
           
-        win = gtk_widget_get_parent_window(draw);
+        win = gtk_widget_get_parent_window(widget);
 #ifndef CYG_MANGLING
-        xinfo.window=	GDK_WINDOW_XWINDOW(draw->window);
-        xinfo.display= GDK_WINDOW_XDISPLAY(win);
+        xinfo->window=	GDK_WINDOW_XWINDOW(widget->window);
+        xinfo->display= GDK_WINDOW_XDISPLAY(win);
 #endif
-        switch(render)
-        {
-        
-#if defined(USE_XV)
-	       case RENDER_XV:
-		accel_mode=new XvAccelRender();
-		if(!accel_mode->init(&xinfo,renderW,renderH))
-		{
-			delete accel_mode;
-			accel_mode=NULL;
-			printf("Xv init failed\n");
-		}
-		else
-		{
-			printf("Xv init ok\n");
-		}
-                break;
-#endif
-#if defined(USE_SDL)
-              case RENDER_SDL:
-		printf("Trying SDL\n");
-		accel_mode=new sdlAccelRender();
-		if(!accel_mode->init(&xinfo,renderW,renderH))
-		{
-			delete accel_mode;
-			accel_mode=NULL;
-			printf("sdl init failed\n");
-		}
-		else
-		{
-			printf("SDL init ok\n");
-		}
-                break;
-#endif
-                default:break;
-        }
-        if(!accel_mode)
-        {
-                rgbConverter.reset(renderW,renderH);
-                printf("No accel used for rendering\n");
-        }
-        else
-        {
-           ADM_assert(!accelSurface);
-           accelSurface=new uint8_t[ (renderW*renderH*3)>>1];
-          
-        }
-	
-	return 1;
 }
-
-
-uint8_t renderStopPlaying( void )
-{
-	if(accel_mode)
-	{
-		accel_mode->end();
-		delete accel_mode;
-                if(accelSurface) delete [] accelSurface;
-                accelSurface=NULL;
-				
-	}
-	accel_mode=NULL;	
-	return 1;
-}
-
-
-//___________________________________________________________________________
-//
-//
-uint8_t	updateWindowSize(GtkWidget * win, uint32_t w, uint32_t h)
-{
-    ADM_assert(screenBuffer);
-    renderW = w;
-    renderH = h;
-
-    // Shrink the main window
-    // so that we do not leave blanks everywhere
-    
-    //***
-  
-     /*UI_purge();
-     UI_shrink(w,h);
-     UI_purge();
-     */
-    gtk_widget_set_usize(win, w, h);
-    rgbConverter.reset(w,h);
-    return 1;
-}
-
-uint8_t GUI_ConvertRGB(uint8_t * in, uint8_t * out, uint32_t w, uint32_t h)
-{
-    rgbConverter.reset(w,h);
-    rgbConverter.scale(in,out);
-    return 1;
-}
-uint8_t GUI_ConvertRGBBlit(uint8_t * in, uint8_t * out,uint32_t totalW,uint32_t totalH, uint32_t startx,uint32_t starty,uint32_t w, uint32_t h,uint32_t primary)
-{
-  if(!primary)
-  {
-    rgbConverter.reset(w,h);
-    rgbConverter.scale(in,out,startx,starty,w,h,renderW,renderH);
-  }else
-  {
-    rgbConverter2.reset(w,h);
-    rgbConverter2.scale(in,out,startx,starty,w,h,renderW,renderH);
-  }
-    return 1;
-}
-
-
-
-void GUI_RGBDisplay(uint8_t * dis, uint32_t w, uint32_t h, void *widg)
-{
-    GtkWidget *widget;
-    widget = (GtkWidget *)widg; 
-    //return;
-
-
-    gdk_draw_rgb_32_image(widget->window, widget->style->fg_gc[GTK_STATE_NORMAL], 0,    // X
-                       0,       // y
-                       w,       //width
-                       h,       //h*2, // heigth
-                       GDK_RGB_DITHER_NONE,
-                       //GDK_RGB_DITHER_MAX,  // dithering
-                       (guchar *) dis,  // buffer
-                       w * 4);
-
-
-}
+#if 0
+#endif
+// EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp	2007-02-04 19:39:24 UTC (rev 2799)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/preview_none.cpp	2007-02-05 07:09:20 UTC (rev 2800)
@@ -15,8 +15,11 @@
 
 #include "GUI_render.h"
 
+void UI_rgbDraw(void *widg,uint32_t w, uint32_t h,uint8_t *ptr) {}
+void UI_updateDrawWindowSize(void *win,uint32_t w,uint32_t h) {}
+void UI_getWindowInfo(void *draw, GUI_WindowInfo *xinfo) {}
+void *UI_getDrawWidget(void ) {return NULL;}
 
-
 void GUI_PreviewInit(uint32_t w , uint32_t h, uint32_t modal)
 {}
 uint8_t 	GUI_PreviewUpdate(uint8_t *data)
@@ -37,36 +40,3 @@
 {
 }
 
-uint8_t renderInit( void )
-{
-  return 1;
-}
-uint8_t renderResize(uint32_t w, uint32_t h,renderZoom newzoom)
-{
-  return 1;
-}
-uint8_t renderRefresh(void)
-{
-  return 1;
-}
-uint8_t renderExpose(void)
-{
-  return 1;
-}
-uint8_t renderUpdateImage(uint8_t *ptr)
-{
-  return 1;
-}
-uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h,uint32_t primary)
-{
-  return 1; 
-}
-uint8_t renderStartPlaying( void )
-{
-  return 1;
-}
-uint8_t renderStopPlaying( void )
-{
-  return 1;
-}
-

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_accelRender.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_accelRender.h	2007-02-04 19:39:24 UTC (rev 2799)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_accelRender.h	2007-02-05 07:09:20 UTC (rev 2800)
@@ -11,17 +11,11 @@
 //
 #ifndef GUI_ACCELRENDER_H
 #define GUI_ACCELRENDER_H
-typedef struct
-{
-    void *display;
-    int  window;
-  
-}GUI_Info;
 class AccelRender
 {
       public:
                               AccelRender( void) {};
-              virtual	uint8_t init(GUI_Info * window, uint32_t w, uint32_t h)=0;
+              virtual	uint8_t init(GUI_WindowInfo * window, uint32_t w, uint32_t h)=0;
               virtual	uint8_t end(void)=0;
               virtual uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h)=0;
               

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp (from rev 2794, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-02-03 09:11:51 UTC (rev 2794)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp	2007-02-05 07:09:20 UTC (rev 2800)
@@ -0,0 +1,393 @@
+/***************************************************************************
+                          gui_render.cpp  -  description
+
+	The final render a frame. The external interface is the same
+	whatever the mean (RGB/YUV/Xv)
+                             -------------------
+    begin                : Thu Jan 3 2002
+    copyright            : (C) 2002 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "config.h"
+
+#include <stdio.h>         
+#include <stdlib.h>
+#include <math.h>
+#include <unistd.h>
+#include <string.h>
+
+
+#include <sys/time.h>
+
+
+#include <../ADM_assert.h>
+
+#include "default.h"
+
+
+#include "ADM_commonUI/GUI_render.h"
+
+#include "ADM_commonUI/GUI_accelRender.h"
+#ifdef USE_XV
+#include "ADM_commonUI/GUI_xvRender.h"
+#endif
+#ifdef USE_SDL
+#include "ADM_commonUI/GUI_sdlRender.h"
+#endif
+
+
+#include "../prefs.h"
+#include "../../ADM_colorspace/ADM_rgb.h"
+#include "../../ADM_libraries/ADM_libswscale/ADM_mp.h"
+
+extern uint8_t BitBlit(uint8_t *dst, uint32_t pitchDest,uint8_t *src,uint32_t pitchSrc,uint32_t width, uint32_t height);
+extern void UI_purge(void);
+
+
+static uint8_t	updateWindowSize(void * win, uint32_t w, uint32_t h);
+void GUI_RGBDisplay(uint8_t * dis, uint32_t w, uint32_t h, void *widg);
+static uint8_t  GUI_ConvertRGB(uint8_t * in, uint8_t * out, uint32_t w, uint32_t h);
+static uint8_t  GUI_ConvertRGBBlit(uint8_t * in, uint8_t * out,uint32_t totalW,uint32_t totalH, 
+                                  uint32_t startx,uint32_t starty,uint32_t w, uint32_t h,uint32_t primary);
+
+
+extern uint8_t UI_shrink(uint32_t w,uint32_t h);
+//_____________________________________
+static renderZoom zoom=ZOOM_1_1;
+
+static ColYuvRgb rgbConverter(640,480);
+static ColYuvRgb rgbConverter2(640,480);
+
+//_____________________________________
+static AccelRender    *accel_mode=NULL;
+static uint8_t        *accelSurface=NULL;
+//_______________________________________
+
+static uint8_t 	            *screenBuffer=NULL;
+static ADMImage             *resized=NULL;
+static ADM_MplayerResize    *resizer=NULL;
+static uint8_t		    *lastImage=NULL;
+static void                 *draw=NULL;
+static uint32_t 	     renderW=0,renderH=0;
+
+//_______________________________________
+/**
+	Render init, initialize internals. Constuctor like function
+
+*/
+uint8_t renderInit( void )
+{
+	draw=UI_getDrawWidget(  );
+	return 1;
+}
+
+/**
+	Warn the renderer that the display size is changing
+
+*/
+//----------------------------------------
+uint8_t renderResize(uint32_t w, uint32_t h,renderZoom newzoom)
+{
+int mul,xx,yy;
+
+	if(screenBuffer) 
+		{
+			delete  [] screenBuffer;
+			screenBuffer=NULL;
+		}
+        if(resized)
+        {
+                        delete resized;
+                        resized=NULL;
+        }
+        if(resizer)
+        {
+                delete resizer;
+                resizer=NULL;
+        }
+        zoom=newzoom;
+        switch(zoom)
+        {
+                case ZOOM_1_4: mul=1;break;
+                case ZOOM_1_2: mul=2;break;
+                case ZOOM_1_1: mul=4;break;
+                case ZOOM_2:   mul=8;break;
+                case ZOOM_4:   mul=16;break;
+                default : ADM_assert(0);
+
+        }
+        xx=(w*mul+3)/4;
+        yy=(h*mul+3)/4;
+
+        if(xx&1) xx++;
+        if(yy&1) yy++;
+
+        screenBuffer=new uint8_t[xx*yy*4];
+
+        if(zoom!=ZOOM_1_1)
+        {
+                 resizer=new ADM_MplayerResize(w,h,xx,yy);
+                 resized=new ADMImage(xx,yy);
+        }
+
+	updateWindowSize( draw,xx,yy);
+	UI_purge();
+	return 1;
+
+}
+/**
+	Update the image and render it
+	The width and hiehgt must NOT have changed
+
+*/
+//----------------------------------------
+uint8_t renderUpdateImage(uint8_t *ptr)
+{
+	
+        ADM_assert(screenBuffer);
+        if(zoom!=ZOOM_1_1)
+        {
+                ADM_assert(resizer);
+                ADM_assert(resized);
+                resizer->resize(ptr,resized->data);
+                lastImage=resized->data;
+                ptr=lastImage;
+        }
+        else
+        {
+                lastImage=ptr;
+        }
+	if(!accel_mode)
+	 	GUI_ConvertRGB(ptr,screenBuffer, renderW,renderH);
+	renderRefresh();
+	return 1;
+
+}
+/**
+      \fn renderUpdateImageBlit
+      \brief Blit the source into destination
+
+*/
+
+uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h,uint32_t primary)
+{
+
+        ADM_assert(screenBuffer);
+        lastImage=NULL;
+        if(!accel_mode)
+        {
+                GUI_ConvertRGBBlit(ptr,screenBuffer, renderW,renderH,startx,starty,w,h,primary);
+                if(primary) renderRefresh();
+        }
+        else
+        { /* Accel mode, in that case we need to blit our part of the image inside the big image
+              It is assumed the accel render part can work with YV12
+          */
+          /* Luma */
+          uint32_t pageR=(renderW*renderH);
+          uint32_t pageS=(w*h);
+          BitBlit(accelSurface+startx+starty*renderW,renderW,ptr,w,w,h);
+          BitBlit(accelSurface+pageR+(startx>>1)+(starty>>1)*(renderW>>1),renderW>>1,ptr+pageS,w>>1,w>>1,h>>1);
+          BitBlit(accelSurface+(pageR*5)/4+(startx>>1)+(starty>>1)*(renderW>>1),renderW>>1,ptr+(pageS*5)/4,w>>1,w>>1,h>>1);
+
+          lastImage=accelSurface;
+          if(primary) renderRefresh();
+        }
+        return 1;
+}
+
+/**
+	Refresh the image from internal buffer / last image
+	Used for example as call back for X11 events
+
+*/
+//_______________________________________________
+uint8_t renderRefresh(void)
+{
+      if(!screenBuffer)
+      {
+              if(accel_mode) ADM_assert(0);
+              return 0;
+      }
+
+      if(accel_mode)
+      {
+          if(lastImage)
+              accel_mode->display(lastImage, renderW, renderH);
+      }
+      else
+              GUI_RGBDisplay(screenBuffer, renderW, renderH,draw);
+  return 1;
+}
+
+uint8_t renderExpose(void)
+{
+	if(!screenBuffer)
+	{
+		if(accel_mode) ADM_assert(0);
+		return 0;
+	}
+
+
+    if ( accel_mode)
+    {	
+        if(lastImage)
+		accel_mode->display(lastImage,renderW,renderH);
+    }
+    else
+	GUI_RGBDisplay(screenBuffer, renderW, renderH,draw);
+    return 1;
+
+}
+uint8_t renderStartPlaying( void )
+{
+char *displ;
+unsigned int renderI;
+ADM_RENDER_TYPE render;
+	ADM_assert(!accel_mode);
+	// First check if local
+	// We do it in a very wrong way : If DISPLAY!=:0.0 we assume remote display
+	// in that case we do not even try to use accel
+	
+	// Win32 does not have display
+#ifndef CYG_MANGLING	
+	displ=getenv("DISPLAY");
+	if(!displ)
+	{
+		return 0;
+	}
+	if(strcmp(displ,":0") && strcmp(displ,":0.0"))
+	{
+		printf("Looks like remote display, no Xv :%s\n",displ);
+		return 1;
+	}
+#endif	
+ 
+        if(prefs->get(DEVICE_VIDEODEVICE,&renderI)!=RC_OK)
+        {       
+                render=RENDER_GTK;
+        }else
+        {
+                render=(ADM_RENDER_TYPE)renderI;
+        }
+        GUI_WindowInfo xinfo;
+        UI_getWindowInfo(draw, &xinfo);
+        switch(render)
+        {
+        
+#if defined(USE_XV)
+	       case RENDER_XV:
+		accel_mode=new XvAccelRender();
+		if(!accel_mode->init(&xinfo,renderW,renderH))
+		{
+			delete accel_mode;
+			accel_mode=NULL;
+			printf("Xv init failed\n");
+		}
+		else
+		{
+			printf("Xv init ok\n");
+		}
+                break;
+#endif
+#if defined(USE_SDL)
+              case RENDER_SDL:
+		printf("Trying SDL\n");
+		accel_mode=new sdlAccelRender();
+		if(!accel_mode->init(&xinfo,renderW,renderH))
+		{
+			delete accel_mode;
+			accel_mode=NULL;
+			printf("sdl init failed\n");
+		}
+		else
+		{
+			printf("SDL init ok\n");
+		}
+                break;
+#endif
+                default:break;
+        }
+        if(!accel_mode)
+        {
+                rgbConverter.reset(renderW,renderH);
+                printf("No accel used for rendering\n");
+        }
+        else
+        {
+           ADM_assert(!accelSurface);
+           accelSurface=new uint8_t[ (renderW*renderH*3)>>1];
+          
+        }
+	
+	return 1;
+}
+
+
+uint8_t renderStopPlaying( void )
+{
+	if(accel_mode)
+	{
+		accel_mode->end();
+		delete accel_mode;
+                if(accelSurface) delete [] accelSurface;
+                accelSurface=NULL;
+				
+	}
+	accel_mode=NULL;	
+	return 1;
+}
+
+
+//___________________________________________________________________________
+//
+//
+uint8_t	updateWindowSize(void * win, uint32_t w, uint32_t h)
+{
+    ADM_assert(screenBuffer);
+    renderW = w;
+    renderH = h;
+
+    UI_updateDrawWindowSize(win,w,h);
+    //gtk_widget_set_usize(win, w, h);
+    rgbConverter.reset(w,h);
+    return 1;
+}
+
+uint8_t GUI_ConvertRGB(uint8_t * in, uint8_t * out, uint32_t w, uint32_t h)
+{
+    rgbConverter.reset(w,h);
+    rgbConverter.scale(in,out);
+    return 1;
+}
+uint8_t GUI_ConvertRGBBlit(uint8_t * in, uint8_t * out,uint32_t totalW,uint32_t totalH, uint32_t startx,uint32_t starty,uint32_t w, uint32_t h,uint32_t primary)
+{
+  if(!primary)
+  {
+    rgbConverter.reset(w,h);
+    rgbConverter.scale(in,out,startx,starty,w,h,renderW,renderH);
+  }else
+  {
+    rgbConverter2.reset(w,h);
+    rgbConverter2.scale(in,out,startx,starty,w,h,renderW,renderH);
+  }
+    return 1;
+}
+
+
+
+void GUI_RGBDisplay(uint8_t * dis, uint32_t w, uint32_t h, void *widg)
+{
+    
+    UI_rgbDraw(widg,w,h,dis);
+
+}

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h	2007-02-04 19:39:24 UTC (rev 2799)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h	2007-02-05 07:09:20 UTC (rev 2800)
@@ -20,6 +20,12 @@
 #include "ADM_image.h"
 
 class AVDMGenericVideoStream;
+typedef struct
+{
+    void *display;
+    int  window;
+  
+}GUI_WindowInfo;
 
 typedef enum ADM_PREVIEW_MODE
 {
@@ -70,6 +76,11 @@
 uint8_t renderStopPlaying( void );
 
 
+void *UI_getDrawWidget(void);
+void UI_rgbDraw(void *widg,uint32_t w, uint32_t h,uint8_t *ptr);
+void UI_updateDrawWindowSize(void *win,uint32_t w,uint32_t h);
+void UI_getWindowInfo(void *draw, GUI_WindowInfo *xinfo);
+
 typedef enum ADM_RENDER_TYPE
 {
         RENDER_GTK=0,

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp	2007-02-04 19:39:24 UTC (rev 2799)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp	2007-02-05 07:09:20 UTC (rev 2800)
@@ -83,7 +83,7 @@
         
         
 }
-uint8_t sdlAccelRender::init( GUI_Info * window, uint32_t w, uint32_t h)
+uint8_t sdlAccelRender::init( GUI_WindowInfo * window, uint32_t w, uint32_t h)
 {
 int bpp;
 int flags;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.h	2007-02-04 19:39:24 UTC (rev 2799)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.h	2007-02-05 07:09:20 UTC (rev 2800)
@@ -21,7 +21,7 @@
               uint8_t *decoded;
       public:
                                 sdlAccelRender( void ) ;
-              virtual	uint8_t init( GUI_Info * window, uint32_t w, uint32_t h);
+              virtual	uint8_t init( GUI_WindowInfo * window, uint32_t w, uint32_t h);
               virtual	uint8_t end(void);
               virtual   uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h);
 };

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.cpp	2007-02-04 19:39:24 UTC (rev 2799)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.cpp	2007-02-05 07:09:20 UTC (rev 2800)
@@ -47,7 +47,7 @@
 #include "ADM_assert.h"
 
 static uint8_t 	GUI_XvList(Display * dis, uint32_t port, uint32_t * fmt);
-static uint8_t 	GUI_XvInit(GUI_Info * window, uint32_t w, uint32_t h);
+static uint8_t 	GUI_XvInit(GUI_WindowInfo * window, uint32_t w, uint32_t h);
 static void 	GUI_XvEnd( void );
 static uint8_t 	GUI_XvDisplay(uint8_t * src, uint32_t w, uint32_t h);
 static uint8_t 	GUI_XvSync(void);
@@ -58,7 +58,7 @@
 {
 
 }
-uint8_t XvAccelRender::init( GUI_Info * window, uint32_t w, uint32_t h)
+uint8_t XvAccelRender::init( GUI_WindowInfo * window, uint32_t w, uint32_t h)
 {
 	printf("Xv start\n");
 	return  GUI_XvInit( window,  w,  h);
@@ -153,7 +153,7 @@
 //------------------------------------
 //
 //------------------------------------
-uint8_t GUI_XvInit(GUI_Info * window, uint32_t w, uint32_t h)
+uint8_t GUI_XvInit(GUI_WindowInfo * window, uint32_t w, uint32_t h)
 {
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.h	2007-02-04 19:39:24 UTC (rev 2799)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.h	2007-02-05 07:09:20 UTC (rev 2800)
@@ -21,7 +21,7 @@
 {
       public:
                               XvAccelRender( void ) ;
-              virtual	uint8_t init( GUI_Info *  window, uint32_t w, uint32_t h);
+              virtual	uint8_t init( GUI_WindowInfo *  window, uint32_t w, uint32_t h);
               virtual	uint8_t end(void);				
               virtual uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h);
 };

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am	2007-02-04 19:39:24 UTC (rev 2799)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am	2007-02-05 07:09:20 UTC (rev 2800)
@@ -2,7 +2,7 @@
 libADM_CommonUI_a_METASOURCES = AUTO
 libADM_CommonUI_a_SOURCES = GUI_sdlRender.cpp  GUI_xvRender.cpp  \
 DIA_resizeWiz.cpp DIA_builtin.cpp DIA_postproc.cpp DIA_enter.cpp \
-DIA_audioconfig.cpp
+DIA_audioconfig.cpp GUI_render.cpp
 
 
 INCLUDES = $(all_includes) $(GTK_CFLAGS) $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \

Modified: branches/avidemux_2.4_branch/avidemux/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/Makefile.am	2007-02-04 19:39:24 UTC (rev 2799)
+++ branches/avidemux_2.4_branch/avidemux/Makefile.am	2007-02-05 07:09:20 UTC (rev 2800)
@@ -21,25 +21,31 @@
 win32_icon = ./xpm/adm.o
 endif
 
-user_interface_gtk = ./ADM_userInterfaces/ADM_GTK/ADM_gui2/libADM_gui2.a	\
+user_interface_gtk = \
+		./ADM_userInterfaces/ADM_GTK/ADM_gui2/libADM_gui2.a	\
 		./ADM_userInterfaces/ADM_GTK/libADM_GTK.a \
 		./ADM_userInterfaces/ADM_GTK/ADM_dialog/libADM_dialog.a	\
 		./ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/libADM_dialogFactory.a	\
 		./ADM_userInterfaces/ADM_commonUI/libADM_CommonUI.a	\
+		./ADM_userInterfaces/ADM_GTK/ADM_gui2/libADM_gui2.a	\
 		./ADM_userInterfaces/ADM_GTK/ADM_filters/libADM_filters.a \
 		./ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/libADM_toolkit_gtk.a	
 		
-user_interface_cli = ./ADM_userInterfaces/ADM_NONE/ADM_gui2/libADM_gui2.a	\
+user_interface_cli = \
+		./ADM_userInterfaces/ADM_NONE/ADM_gui2/libADM_gui2.a	\
 		./ADM_userInterfaces/ADM_NONE/ADM_dialog/libADM_dialog.a	\
 		./ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/libADM_dialogFactory.a	\
 		./ADM_userInterfaces/ADM_commonUI/libADM_CommonUI.a	\
+		./ADM_userInterfaces/ADM_NONE/ADM_gui2/libADM_gui2.a	\
 		./ADM_userInterfaces/ADM_NONE/ADM_filters/libADM_filters.a 
 		
 		
-user_interface_qt4 = 	./ADM_userInterfaces/ADM_QT4/ADM_gui/libADM_gui2.a	\
+user_interface_qt4 = \
+			./ADM_userInterfaces/ADM_QT4/ADM_gui/libADM_gui2.a	\
 			./ADM_userInterfaces/ADM_QT4/ADM_dialog/libADM_dialog.a	\
 			./ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/libADM_dialogFactory.a	\
 			./ADM_userInterfaces/ADM_commonUI/libADM_CommonUI.a	\
+			./ADM_userInterfaces/ADM_QT4/ADM_gui/libADM_gui2.a	\
 			./ADM_userInterfaces/ADM_QT4/ADM_filters/libADM_filters.a 
 
 adm_src =   guiplay.cpp  \



From mean at mail.berlios.de  Mon Feb  5 08:11:49 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 5 Feb 2007 08:11:49 +0100
Subject: [Avidemux-svn-commit] r2801 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2
Message-ID: <200702050711.l157Bnug002772@sheep.berlios.de>

Author: mean
Date: 2007-02-05 08:11:49 +0100 (Mon, 05 Feb 2007)
New Revision: 2801

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
Removed:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/Makefile.am
Log:
rename to avoid duplicate files

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp (from rev 2800, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp)

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-02-05 07:09:20 UTC (rev 2800)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_render.cpp	2007-02-05 07:11:49 UTC (rev 2801)
@@ -1,105 +0,0 @@
-/***************************************************************************
-    Hook to Gfx toolkit concerning display (RGB or accel)
-                             -------------------
-    
-    copyright            : (C) 2007 by mean
-    email                : Mean/fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include "config.h"
-
-#include <stdio.h>         
-#include <stdlib.h>
-#include <math.h>
-#include <unistd.h>
-
-#include <gtk/gtk.h>
-#ifndef CYG_MANGLING
-#include <gdk/gdkx.h>
-#endif
-#include <time.h>
-#include <sys/time.h>
-
-
-#include "../avi_vars.h"
-#include <../ADM_assert.h>
-
-
-
-#include "ADM_commonUI/GUI_render.h"
-
-#include "ADM_commonUI/GUI_accelRender.h"
-#ifdef USE_XV
-#include "ADM_commonUI/GUI_xvRender.h"
-#endif
-#ifdef USE_SDL
-#include "ADM_commonUI/GUI_sdlRender.h"
-#endif
-
-#include "ADM_toolkit_gtk/toolkit_gtk.h"
-
-#include "../prefs.h"
-#include "../../../ADM_colorspace/ADM_rgb.h"
-#include "../../../ADM_libraries/ADM_libswscale/ADM_mp.h"
-#include "../gtkgui.h"
-
-
-extern GtkWidget *getDrawWidget( void );
-
-/**
-    \brief return pointer to the drawing widget that displays video
-*/
-void *UI_getDrawWidget(void)
-{
-  return (void *) getDrawWidget();
-}
-/**
-    \brief Display to widget in RGB32
-*/
-void UI_rgbDraw(void *widg,uint32_t w, uint32_t h,uint8_t *ptr)
-{
-    GtkWidget *widget;
-    widget = (GtkWidget *)widg; 
-
-
-    gdk_draw_rgb_32_image(widget->window, widget->style->fg_gc[GTK_STATE_NORMAL], 0,    // X
-                       0,       // y
-                       w,       //width
-                       h,       //h*2, // heigth
-                       GDK_RGB_DITHER_NONE,
-                       //GDK_RGB_DITHER_MAX,  // dithering
-                       (guchar *) ptr,  // buffer
-                       w * 4);
-}
-/**
-      \brief Resize the window
-*/
-void  UI_updateDrawWindowSize(void *win,uint32_t w,uint32_t h)
-{
-    gtk_widget_set_usize((GtkWidget *)win, w, h);
-}
-/**
-      \brief Retrieve info from window, needed for accel layer
-*/
-void UI_getWindowInfo(void *draw, GUI_WindowInfo *xinfo)
-{
-        GdkWindow *win;
-        GtkWidget *widget=(GtkWidget *)draw;
-          
-        win = gtk_widget_get_parent_window(widget);
-#ifndef CYG_MANGLING
-        xinfo->window=	GDK_WINDOW_XWINDOW(widget->window);
-        xinfo->display= GDK_WINDOW_XDISPLAY(win);
-#endif
-}
-#if 0
-#endif
-// EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/Makefile.am	2007-02-05 07:09:20 UTC (rev 2800)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/Makefile.am	2007-02-05 07:11:49 UTC (rev 2801)
@@ -5,13 +5,13 @@
 
 libADM_gui2_a_METASOURCES = AUTO
 
-libADM_gui2_a_SOURCES = GUI_main2.cpp GUI_bindings.cpp GUI_render.cpp  GUI_render.h GUI_ui.h GUI_keymap.cpp GUI_xvDraw.h GUI_menumap.h 
+libADM_gui2_a_SOURCES = GUI_main2.cpp GUI_bindings.cpp GUI_gtkRender.cpp   GUI_ui.h GUI_keymap.cpp GUI_xvDraw.h GUI_menumap.h 
 
 
-EXTRA_DIST =   GUI_main2.cpp   GUI_render.h  \
+EXTRA_DIST =   GUI_main2.cpp     \
 GUI_ui.h         \
 GUI_bindings.cpp   GUI_menumap.h      \
-GUI_keymap.cpp     GUI_render.cpp  
+GUI_keymap.cpp     GUI_gtkRender.cpp  
 
 
 ####### kdevelop will overwrite this part!!! (end)############



From mean at mail.berlios.de  Mon Feb  5 08:26:38 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 5 Feb 2007 08:26:38 +0100
Subject: [Avidemux-svn-commit] r2802 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui
Message-ID: <200702050726.l157QccI003333@sheep.berlios.de>

Author: mean
Date: 2007-02-05 08:26:37 +0100 (Mon, 05 Feb 2007)
New Revision: 2802

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
Log:
factorize display code (part II)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2007-02-05 07:11:49 UTC (rev 2801)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2007-02-05 07:26:37 UTC (rev 2802)
@@ -90,8 +90,6 @@
 */
 static uint8_t *rgbDataBuffer=NULL;
 static uint32_t displayW=0,displayH=0;
-static ColYuvRgb rgbConverter(640,480,1);
-static uint8_t GUI_ConvertRGB(uint8_t * in, uint8_t * out, uint32_t w, uint32_t h);
 //****************************************************************************************************
 /*
   This is the class that will display the video images.
@@ -150,177 +148,53 @@
    videoWindow->show();
    
 }
-uint8_t renderInit( void )
+//*************************
+/**
+    \brief return pointer to the drawing widget that displays video
+*/
+void *UI_getDrawWidget(void)
 {
-  return 1;
+  return (void *) videoWindow;
 }
-//****************************************************************************************************
-uint8_t renderResize(uint32_t w, uint32_t h,renderZoom newzoom)
+/**
+    \brief Display to widget in RGB32
+*/
+void UI_rgbDraw(void *widg,uint32_t w, uint32_t h,uint8_t *ptr)
 {
-  if(displayW==w && displayH==h && rgbDataBuffer) return 1;
+      memcpy(rgbDataBuffer,ptr,w*h*4);
+      videoWindow->paintEvent(NULL);
+    
+}
+/**
+      \brief Resize the window
+*/
+void  UI_updateDrawWindowSize(void *win,uint32_t w,uint32_t h)
+{
+  if(displayW==w && displayH==h && rgbDataBuffer) return ;
   if(rgbDataBuffer) delete [] rgbDataBuffer;
   rgbDataBuffer=NULL;
   rgbDataBuffer=new uint8_t [w*h*4]; // 32 bits / color
   displayW=w;
   displayH=h;
-  rgbConverter.reset(w,h);
   hostFrame->resize(displayW,displayH);
   videoWindow->resize(displayW,displayH);
   printf("[RDR] Resizing to %u x %u\n",displayW,displayH);
-  return 1;
+  return ;
 }
 /**
-    \fn renderRefresh(void)
-    \brief Force a redraw of the screen
+      \brief Retrieve info from window, needed for accel layer
 */
-uint8_t renderRefresh(void)
+void UI_getWindowInfo(void *draw, GUI_WindowInfo *xinfo)
 {
-  
-        if(accelRender)
-        {
-            if(lastImage)
-                accelRender->display(lastImage, displayW, displayH);
-        }
-        else
-        {
-                renderExpose();
-        }
-  return 1;
-}
-//****************************************************************************************************
-uint8_t renderExpose(void)
-{
-// TODO   if(videoWindow)
-  if(!accelRender)
-     videoWindow->repaint();
-  return 1;
-}
-/**
-      \fn renderUpdateImage(uint8_t *ptr)
-      \brief Update display with the content of the pointer given as arg
-*/
-uint8_t renderUpdateImage(uint8_t *ptr)
-{
-  if(!accelRender) // Only needed for unaccelerated display
-  {
-      rgbConverter.scale(ptr,rgbDataBuffer);
-      renderExpose();
-  }else
-  {
-      accelRender->display(ptr,displayW,displayH);
-      lastImage=ptr;
-  }
-  return 1;
-}
-uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h,uint32_t primary)
-{
-  return 1; 
-}
-
-/**
-    \fn renderStartPlaying( void )
-    \brief Start playing, create an alternate renderer (preferably hw accelerated such as Xv or SDL)
-*/
-  uint8_t renderStartPlaying( void )
-{
-char *displ;
-unsigned int renderI;
-ADM_RENDER_TYPE render;
-        ADM_assert(!accelRender);
-        // First check if local
-        // We do it in a very wrong way : If DISPLAY!=:0.0 we assume remote display
-        // in that case we do not even try to use accel
-        
-        // Win32 does not have display
-#ifndef CYG_MANGLING	
-        displ=getenv("DISPLAY");
-        if(!displ)
-        {
-                return 0;
-        }
-        if(strcmp(displ,":0") && strcmp(displ,":0.0"))
-        {
-                printf("Looks like remote display, no Xv :%s\n",displ);
-                return 1;
-        }
-#endif	
- 
-        if(prefs->get(DEVICE_VIDEODEVICE,&renderI)!=RC_OK)
-        {       
-                render=RENDER_GTK;
-        }else
-        {
-                render=(ADM_RENDER_TYPE)renderI;
-        }
-        GUI_Info xinfo;
 #ifndef CYG_MANGLING
         const QX11Info &info=videoWindow->x11Info();
-        xinfo.display=info.display();
-        xinfo.window=videoWindow->winId();
+        xinfo->display=info.display();
+        xinfo->window=videoWindow->winId();
          
 #endif 
-        switch(render)
-        {
-        
-#if defined(USE_XV)
-              case RENDER_XV:
-                accelRender=new XvAccelRender();
-                if(!accelRender->init(&xinfo,displayW,displayH))
-                {
-                        delete accelRender;
-                        accelRender=NULL;
-                        printf("Xv init failed\n");
-                }
-                else
-                {
-                        printf("Xv init ok\n");
-                }
-                break;
-#endif
-#if defined(USE_SDL)
-              case RENDER_SDL:
-                printf("Trying SDL\n");
-                accelRender=new sdlAccelRender();
-                if(!accelRender->init(&xinfo,displayW,displayH))
-                {
-                        delete accelRender;
-                        accelRender=NULL;
-                        printf("sdl init failed\n");
-                }
-                else
-                {
-                        printf("SDL init ok\n");
-                }
-                break;
-#endif
-                default:break;
-        }
-        if(!accelRender)
-        {
-                rgbConverter.reset(displayW,displayH);
-                printf("No accel used for rendering\n");
-        }
-	else printf("Using accelerated rendering\n");
-	return 1;
-}
 
-/**
-    \fn renderStopPlaying(void)
-    \brief Switch back to regular slow display, destroy accelerated renderer if exists
-*/
-uint8_t renderStopPlaying( void )
-{
-      if(accelRender)
-      {
-            accelRender->end();
-              delete accelRender;
-      }
-      accelRender=NULL;
-      lastImage=NULL;
-      return 1;
 }
 
 
-
 //****************************************************************************************************
 //EOF 



From mean at mail.berlios.de  Mon Feb  5 20:53:37 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 5 Feb 2007 20:53:37 +0100
Subject: [Avidemux-svn-commit] r2803 - in
	branches/avidemux_2.4_branch/avidemux: .
	ADM_userInterfaces/ADM_QT4/ADM_gui ADM_userInterfaces/ADM_commonUI
Message-ID: <200702051953.l15JrbjH004775@sheep.berlios.de>

Author: mean
Date: 2007-02-05 20:53:37 +0100 (Mon, 05 Feb 2007)
New Revision: 2803

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h
   branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
Log:
fix zoom, not optimal

Modified: branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp	2007-02-05 07:26:37 UTC (rev 2802)
+++ branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp	2007-02-05 19:53:37 UTC (rev 2803)
@@ -51,20 +51,27 @@
 #include "ADM_osSupport/ADM_debugID.h"
 #define MODULE_NAME MODULE_PREVIEW
 #include "ADM_osSupport/ADM_debug.h"
+#include "ADM_libraries/ADM_libswscale/ADM_mp.h"
 
-
 #include "GUI_ui.h"
 #define MAX(a,b) ( (a)>(b) ? (a) : (b) )
 
 extern FILTER  videofilters[MAX_FILTER];
 extern uint32_t nb_active_filter;
 
+static void previewBlit(ADMImage *from,ADMImage *to,uint32_t startx,uint32_t starty);
+
 static   AVDMGenericVideoStream *preview=NULL;
 static ADMImage *previewImage;
 static ADM_PREVIEW_MODE previewMode=ADM_PREVIEW_NONE;
 static uint32_t _mainW=0,_mainH=0;
 static uint32_t _displayW=0,_displayH=0;
 static uint32_t defered_display=0;
+static renderZoom zoom=ZOOM_1_1;
+static ADMImage             *resized=NULL;
+static ADM_MplayerResize    *resizer=NULL;
+static ADMImage             *original=NULL;
+static uint32_t _resizedW=0,_resizedH=0;
 /**
       \fn getPreviewMode
       \brief returns current preview mode
@@ -77,8 +84,14 @@
   return previewMode; 
 }
 
+void changePreviewZoom(renderZoom nzoom)
+{
+    admPreview::stop();
+    zoom=nzoom;
+    admPreview::start();
+  
+}
 
-
 /**
       \fn setPreviewMode
       \brief set current preview mode an update UI
@@ -128,7 +141,7 @@
                 
             previewImage=new ADMImage(preview->getInfo()->width,preview->getInfo()->height);
             
-            
+            ADM_assert(!original);
             switch(previewMode)
             {
               case  ADM_PREVIEW_SEPARATE:
@@ -149,6 +162,7 @@
                   
                   _displayH=MAX(_mainH,preview->getInfo()->height);
                   _displayW=_mainW+preview->getInfo()->width;
+                  original=new ADMImage(_displayW,_displayH);
                   break;
               }
               case  ADM_PREVIEW_TOP:
@@ -156,11 +170,38 @@
                   
                   _displayW=MAX(_mainW,preview->getInfo()->width);
                   _displayH=_mainH+preview->getInfo()->height;
+                  original=new ADMImage(_displayW,_displayH);
                   break;
               }
               default: ADM_assert(0);
             }
-            renderResize(_displayW,_displayH,ZOOM_1_1);
+        if(zoom!=ZOOM_1_1)
+        {
+            int mul;
+            switch(zoom)
+            {
+                    case ZOOM_1_4: mul=1;break;
+                    case ZOOM_1_2: mul=2;break;
+                    case ZOOM_1_1: mul=4;break;
+                    case ZOOM_2:   mul=8;break;
+                    case ZOOM_4:   mul=16;break;
+                    default : ADM_assert(0);
+    
+            }
+            _resizedW=(_displayW*mul+3)/4;
+            _resizedH=(_displayH*mul+3)/4;
+    
+            if(_resizedW&1) _resizedW++;
+            if(_resizedH&1) _resizedH++;
+            ADM_assert(!resized);
+            resized=new ADMImage(_resizedW,_resizedH);
+            ADM_assert(!resizer);
+            resizer=new  ADM_MplayerResize(_displayW,_displayH,_resizedW,_resizedH);
+            renderResize(_resizedW,_resizedH);
+        }else
+        {
+             renderResize(_displayW,_displayH);
+        }
 }
 /**
       \fn admPreview::stop
@@ -171,18 +212,26 @@
 {
       if(previewMode==ADM_PREVIEW_SEPARATE)
                 GUI_PreviewEnd();
-      if(previewMode!=ADM_PREVIEW_NONE)
+      if(  previewMode==ADM_PREVIEW_SIDE || previewMode==ADM_PREVIEW_TOP)
       {
-          if(previewImage)
-            delete previewImage;
-          previewImage=NULL;
+        ADM_assert(original);
+        original=NULL; 
       }
-      renderResize(_mainW,_mainH,ZOOM_1_1);
+      renderResize(_mainW,_mainH);
       if(previewImage)
       {
         delete  previewImage; 
         previewImage=NULL;
       }
+      if(zoom!=ZOOM_1_1)
+      {
+          ADM_assert(resized);
+          ADM_assert(resizer);
+          delete resized;
+          delete resizer;
+          resized=NULL;
+          resizer=NULL;
+      }
 }
 /**
       \fn admPreview::updateFilters
@@ -234,7 +283,7 @@
   _mainH=h;
   _displayW=w;
   _displayH=h;
-  renderResize(w,h,ZOOM_1_1);
+  renderResize(w,h);
   
 }
 /**
@@ -251,20 +300,52 @@
     switch(previewMode)
     {
       case ADM_PREVIEW_NONE:
-        if(image && !defered_display) renderUpdateImage(image->data);
+        if(image)
+        {
+            if(zoom==ZOOM_1_1 )
+            {
+               if(!defered_display) 
+                  renderUpdateImage(image->data);
+            }else
+            {
+                ADM_assert(resizer);
+                ADM_assert(resized);
+                resizer->resize(image->data,resized->data);
+                if(!defered_display) 
+                  renderUpdateImage(resized->data);
+            }
+        }
         break;
       case ADM_PREVIEW_OUTPUT:
             if(framenum<=preview->getInfo()->nb_frames-1)
                   {
-                          preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
-                          if(!defered_display) renderUpdateImage(previewImage->data);
+                          if(!preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl)) return;
+                          if(zoom==ZOOM_1_1)
+                          {
+                            if(!defered_display) renderUpdateImage(previewImage->data);
+                          }
+                          else
+                          {
+                             resizer->resize(previewImage->data,resized->data);
+                             if(!defered_display) 
+                                  renderUpdateImage(resized->data);
+                          }
                   }
             break;
       case ADM_PREVIEW_SEPARATE:
             ADM_assert(preview);
             ADM_assert(previewImage);
-
-          if(image && !defered_display) renderUpdateImage(image->data);
+            if(zoom==ZOOM_1_1)
+            {
+              if(image && !defered_display) renderUpdateImage(image->data);
+            }else
+            {
+                ADM_assert(resizer);
+                ADM_assert(resized);
+                resizer->resize(image->data,resized->data);
+                if(!defered_display) 
+                  renderUpdateImage(resized->data);
+            }
           if( GUI_PreviewStillAlive())
           {
                   aprintf("Preview: Ask for frame %lu\n",framenum);
@@ -278,26 +359,62 @@
       case ADM_PREVIEW_SIDE:
               ADM_assert(preview);
               ADM_assert(previewImage);
-  
-              if(!defered_display) renderUpdateImageBlit(image->data,0,0,_mainW,_mainH,0); // Main
-              preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
-              if(!defered_display) 
-                  renderUpdateImageBlit(previewImage->data,_mainW,0,previewImage->_width,previewImage->_height,1);
+              ADM_assert(original);
+              
+              
+              previewBlit(image,original,0,0);
+              if(preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl))
+              {
+                previewBlit(previewImage,original,_mainW,0);
+              }
+              if(zoom==ZOOM_1_1)
+              {
+                if(!defered_display)
+                  renderUpdateImage(original->data);
+              }else
+              {
+                resizer->resize(original->data,resized->data);
+                if(!defered_display) 
+                  renderUpdateImage(resized->data);
+              }
               break;
         
       case ADM_PREVIEW_TOP:
               ADM_assert(preview);
               ADM_assert(previewImage);
-  
-              if(!defered_display) renderUpdateImageBlit(image->data,0,0,_mainW,_mainH,0); // Main
-              preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl);
-              if(!defered_display)
-                  renderUpdateImageBlit(previewImage->data,0,_mainH,previewImage->_width,previewImage->_height,1);
+              ADM_assert(original);
+              
+              previewBlit(image,original,0,0);
+              if(preview->getFrameNumberNoAlloc(framenum,&len,previewImage,&fl))
+              {
+                previewBlit(previewImage,original,0,_mainH);
+              }
+              if(zoom==ZOOM_1_1)
+              {
+                if(!defered_display)
+                  renderUpdateImage(original->data);
+              }else
+              {
+                resizer->resize(original->data,resized->data);
+                if(!defered_display) 
+                  renderUpdateImage(resized->data);
+              }
               break;
       default: ADM_assert(0);
     }
 }
 /**
+      \fn previewBlit(ADMImage *from,ADMImage *to,uint32_t startx,uint32_t starty)
+      \brief Blit "from" to "to" at position startx,starty
+*/
+
+void previewBlit(ADMImage *from,ADMImage *to,uint32_t startx,uint32_t starty)
+{
+  
+  from->copyTo(to,startx,starty);
+  
+}
+/**
       \fn displayNow
       \brief display on screen immediately
 */
@@ -309,31 +426,49 @@
     switch(previewMode)
     {
       case ADM_PREVIEW_NONE:
-        if(image ) renderUpdateImage(image->data);
+           
+           if(zoom==ZOOM_1_1 )
+            {
+                renderUpdateImage(image->data);
+            }else
+            {
+                ADM_assert(resized);
+                renderUpdateImage(resized->data);
+            }
         break;
       case ADM_PREVIEW_OUTPUT:
-            renderUpdateImage(previewImage->data);
+            if(zoom==ZOOM_1_1 )
+            {
+                renderUpdateImage(previewImage->data);
+            }else
+            {
+                ADM_assert(resized);
+                renderUpdateImage(resized->data);
+            }
             break;
       case ADM_PREVIEW_SEPARATE:
-          if(image) renderUpdateImage(image->data);
-          if( GUI_PreviewStillAlive())
-          {
-              GUI_PreviewUpdate(previewImage->data);
-          }
+            if(zoom==ZOOM_1_1 )
+            {
+                renderUpdateImage(image->data);
+            }else{
+                ADM_assert(resized);
+                renderUpdateImage(resized->data);
+            }
+            if( GUI_PreviewStillAlive())
+            {
+                GUI_PreviewUpdate(previewImage->data);
+            }
           break;
       case ADM_PREVIEW_SIDE:
-              ADM_assert(preview);
-              ADM_assert(previewImage);
-              renderUpdateImageBlit(image->data,0,0,_mainW,_mainH,0); // Main
-              renderUpdateImageBlit(previewImage->data,_mainW,0,previewImage->_width,previewImage->_height,1);
-              break;
-        
       case ADM_PREVIEW_TOP:
-              ADM_assert(preview);
-              ADM_assert(previewImage);
-  
-              renderUpdateImageBlit(image->data,0,0,_mainW,_mainH,0); // Main
-              renderUpdateImageBlit(previewImage->data,0,_mainH,previewImage->_width,previewImage->_height,1);
+            if(zoom==ZOOM_1_1)
+            {
+               renderUpdateImage(original->data);
+            }else
+            {
+              ADM_assert(resized);
+              renderUpdateImage(resized->data);
+            }
               break;
       default: ADM_assert(0);
     }

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2007-02-05 07:26:37 UTC (rev 2802)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2007-02-05 19:53:37 UTC (rev 2803)
@@ -162,7 +162,7 @@
 void UI_rgbDraw(void *widg,uint32_t w, uint32_t h,uint8_t *ptr)
 {
       memcpy(rgbDataBuffer,ptr,w*h*4);
-      videoWindow->paintEvent(NULL);
+      videoWindow->repaint();
     
 }
 /**

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp	2007-02-05 07:26:37 UTC (rev 2802)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp	2007-02-05 19:53:37 UTC (rev 2803)
@@ -47,8 +47,8 @@
 
 #include "../prefs.h"
 #include "../../ADM_colorspace/ADM_rgb.h"
-#include "../../ADM_libraries/ADM_libswscale/ADM_mp.h"
 
+
 extern uint8_t BitBlit(uint8_t *dst, uint32_t pitchDest,uint8_t *src,uint32_t pitchSrc,uint32_t width, uint32_t height);
 extern void UI_purge(void);
 
@@ -62,8 +62,8 @@
 
 extern uint8_t UI_shrink(uint32_t w,uint32_t h);
 //_____________________________________
-static renderZoom zoom=ZOOM_1_1;
 
+
 static ColYuvRgb rgbConverter(640,480);
 static ColYuvRgb rgbConverter2(640,480);
 
@@ -73,8 +73,6 @@
 //_______________________________________
 
 static uint8_t 	            *screenBuffer=NULL;
-static ADMImage             *resized=NULL;
-static ADM_MplayerResize    *resizer=NULL;
 static uint8_t		    *lastImage=NULL;
 static void                 *draw=NULL;
 static uint32_t 	     renderW=0,renderH=0;
@@ -95,7 +93,7 @@
 
 */
 //----------------------------------------
-uint8_t renderResize(uint32_t w, uint32_t h,renderZoom newzoom)
+uint8_t renderResize(uint32_t w, uint32_t h)
 {
 int mul,xx,yy;
 
@@ -104,42 +102,9 @@
 			delete  [] screenBuffer;
 			screenBuffer=NULL;
 		}
-        if(resized)
-        {
-                        delete resized;
-                        resized=NULL;
-        }
-        if(resizer)
-        {
-                delete resizer;
-                resizer=NULL;
-        }
-        zoom=newzoom;
-        switch(zoom)
-        {
-                case ZOOM_1_4: mul=1;break;
-                case ZOOM_1_2: mul=2;break;
-                case ZOOM_1_1: mul=4;break;
-                case ZOOM_2:   mul=8;break;
-                case ZOOM_4:   mul=16;break;
-                default : ADM_assert(0);
+        screenBuffer=new uint8_t[w*h*4];
 
-        }
-        xx=(w*mul+3)/4;
-        yy=(h*mul+3)/4;
-
-        if(xx&1) xx++;
-        if(yy&1) yy++;
-
-        screenBuffer=new uint8_t[xx*yy*4];
-
-        if(zoom!=ZOOM_1_1)
-        {
-                 resizer=new ADM_MplayerResize(w,h,xx,yy);
-                 resized=new ADMImage(xx,yy);
-        }
-
-	updateWindowSize( draw,xx,yy);
+	updateWindowSize( draw,w,h);
 	UI_purge();
 	return 1;
 
@@ -154,18 +119,8 @@
 {
 	
         ADM_assert(screenBuffer);
-        if(zoom!=ZOOM_1_1)
-        {
-                ADM_assert(resizer);
-                ADM_assert(resized);
-                resizer->resize(ptr,resized->data);
-                lastImage=resized->data;
-                ptr=lastImage;
-        }
-        else
-        {
-                lastImage=ptr;
-        }
+        lastImage=ptr;
+
 	if(!accel_mode)
 	 	GUI_ConvertRGB(ptr,screenBuffer, renderW,renderH);
 	renderRefresh();

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h	2007-02-05 07:26:37 UTC (rev 2802)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h	2007-02-05 19:53:37 UTC (rev 2803)
@@ -36,8 +36,20 @@
     ADM_PREVIEW_SEPARATE
 };
 
+typedef enum renderZoom
+{
+        ZOOM_1_4,
+        ZOOM_1_2,
+        ZOOM_1_1,
+        ZOOM_2,
+        ZOOM_4,
+        ZOOM_INVALID
+};
+
+
 ADM_PREVIEW_MODE getPreviewMode(void);
 void             setPreviewMode(ADM_PREVIEW_MODE preview);
+void changePreviewZoom(renderZoom nzoom);
 
 class admPreview
 {
@@ -54,19 +66,10 @@
 
 
 
-typedef enum renderZoom
-{
-        ZOOM_1_4,
-        ZOOM_1_2,
-        ZOOM_1_1,
-        ZOOM_2,
-        ZOOM_4,
-        ZOOM_INVALID
-};
 
 
 uint8_t renderInit( void );
-uint8_t renderResize(uint32_t w, uint32_t h,renderZoom newzoom);
+uint8_t renderResize(uint32_t w, uint32_t h);
 uint8_t renderRefresh(void);
 uint8_t renderExpose(void);
 uint8_t renderUpdateImage(uint8_t *ptr);

Modified: branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2007-02-05 07:26:37 UTC (rev 2802)
+++ branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2007-02-05 19:53:37 UTC (rev 2803)
@@ -458,12 +458,8 @@
         case ACT_ZOOM_1_1:
         case ACT_ZOOM_2_1:
         case ACT_ZOOM_4_1:
-#if 0
                 currentZoom=(renderZoom)((action-ACT_ZOOM_1_4)+ZOOM_1_4);
-                renderResize (avifileinfo->width, avifileinfo->height,currentZoom);
-                renderUpdateImage (rdr_decomp_buffer->data);
-                renderRefresh ();
-#endif
+                changePreviewZoom(currentZoom);
                 break;
 
 



From mean at mail.berlios.de  Mon Feb  5 21:00:56 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 5 Feb 2007 21:00:56 +0100
Subject: [Avidemux-svn-commit] r2804 - branches/avidemux_2.4_branch/avidemux
Message-ID: <200702052000.l15K0uk0005431@sheep.berlios.de>

Author: mean
Date: 2007-02-05 21:00:56 +0100 (Mon, 05 Feb 2007)
New Revision: 2804

Modified:
   branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
Log:
refresh when zoom changes

Modified: branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2007-02-05 19:53:37 UTC (rev 2803)
+++ branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2007-02-05 20:00:56 UTC (rev 2804)
@@ -460,6 +460,7 @@
         case ACT_ZOOM_4_1:
                 currentZoom=(renderZoom)((action-ACT_ZOOM_1_4)+ZOOM_1_4);
                 changePreviewZoom(currentZoom);
+                admPreview::update(curframe,rdr_decomp_buffer);
                 break;
 
 



From mean at mail.berlios.de  Tue Feb  6 08:28:17 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 6 Feb 2007 08:28:17 +0100
Subject: [Avidemux-svn-commit] r2805 - in
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces:
	ADM_GTK/ADM_gui2 ADM_NONE/ADM_gui2 ADM_QT4/ADM_gui ADM_commonUI
Message-ID: <200702060728.l167SHtP005987@sheep.berlios.de>

Author: mean
Date: 2007-02-06 08:28:16 +0100 (Tue, 06 Feb 2007)
New Revision: 2805

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/gui_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp
Log:
sync QT4 ui with recent preview stuff

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp	2007-02-05 20:00:56 UTC (rev 2804)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp	2007-02-06 07:28:16 UTC (rev 2805)
@@ -53,6 +53,8 @@
 
 
 extern GtkWidget *getDrawWidget( void );
+ ColYuvRgb rgbConverter(640,480);
+ ColYuvRgb rgbConverter2(640,480);
 
 /**
     \brief return pointer to the drawing widget that displays video

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/gui_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/gui_none.cpp	2007-02-05 20:00:56 UTC (rev 2804)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/gui_none.cpp	2007-02-06 07:28:16 UTC (rev 2805)
@@ -14,10 +14,12 @@
 #include "default.h"
 #include "ADM_toolkit/toolkit.hxx"
 #include "GUI_ui.h"
-
+#include "ADM_colorspace/ADM_rgb.h"
 static ADM_OUT_FORMAT format=ADM_AVI;
 static int audioCodec=0;
 static int videoCodec=0;
+ ColYuvRgb rgbConverter(640,480);
+ ColYuvRgb rgbConverter2(640,480);
 //**************************************************
 int 	UI_getCurrentACodec(void)
 {

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2007-02-05 20:00:56 UTC (rev 2804)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2007-02-06 07:28:16 UTC (rev 2805)
@@ -122,6 +122,10 @@
           ui.pushButtonAudioConf->setEnabled(b);
           ui.pushButtonAudioFilter->setEnabled(b);
           HandleAction (ACT_AudioCodecChanged) ;
+        }else
+        if(!strcmp(source,"comboBoxPreview"))  
+        {
+          HandleAction (ACT_PreviewChanged) ;
         }
         
 
@@ -158,6 +162,7 @@
          //ACT_VideoCodecChanged
          connect( ui.comboBoxVideo,SIGNAL(activated(int)),this,SLOT(comboChanged(int)));
          connect( ui.comboBoxAudio,SIGNAL(activated(int)),this,SLOT(comboChanged(int)));
+         connect( ui.comboBoxPreview,SIGNAL(activated(int)),this,SLOT(comboChanged(int)));
      // Slider
           slider=ui.horizontalSlider;
           slider->setMinimum(0);
@@ -228,7 +233,28 @@
 QWidget *QuiMainWindows=NULL;
 QGraphicsView *drawWindow=NULL;
 uint8_t UI_updateRecentMenu( void );
+
 /**
+    \fn UI_getCurrentPreview(void)
+    \brief Read previewmode from comboxbox 
+*/
+
+int    UI_getCurrentPreview(void)
+{
+  return WIDGET(comboBoxPreview)->currentIndex(); 
+}
+/**
+    \fn UI_setCurrentPreview(int ne)
+    \brief Update comboxbox with previewmode
+*/
+
+void   UI_setCurrentPreview(int ne)
+{
+    WIDGET(comboBoxPreview)->setCurrentIndex(ne); 
+}
+
+
+/**
     \fn UI_RunApp(void)
     \brief Main entry point for the GUI application
 */

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2007-02-05 20:00:56 UTC (rev 2804)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/T_preview.cpp	2007-02-06 07:28:16 UTC (rev 2805)
@@ -56,6 +56,10 @@
 static QFrame *hostFrame=NULL;
 static AccelRender *accelRender=NULL;
 static uint8_t *lastImage=NULL;
+
+ ColYuvRgb rgbConverter(640,480,1);
+ ColYuvRgb rgbConverter2(640,480,1);
+
 //****************************************************************************************************
 void GUI_PreviewInit(uint32_t w , uint32_t h, uint32_t modal)
 {}

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui	2007-02-05 20:00:56 UTC (rev 2804)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui	2007-02-06 07:28:16 UTC (rev 2805)
@@ -302,6 +302,35 @@
             </property>
            </widget>
           </item>
+          <item>
+           <widget class="QComboBox" name="comboBoxPreview" >
+            <item>
+             <property name="text" >
+              <string>Input</string>
+             </property>
+            </item>
+            <item>
+             <property name="text" >
+              <string>Output</string>
+             </property>
+            </item>
+            <item>
+             <property name="text" >
+              <string>Side</string>
+             </property>
+            </item>
+            <item>
+             <property name="text" >
+              <string>Top</string>
+             </property>
+            </item>
+            <item>
+             <property name="text" >
+              <string>Separate</string>
+             </property>
+            </item>
+           </widget>
+          </item>
          </layout>
         </item>
        </layout>

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp	2007-02-05 20:00:56 UTC (rev 2804)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp	2007-02-06 07:28:16 UTC (rev 2805)
@@ -20,13 +20,6 @@
 static int videoCodec=0;
 //**************************************************
 //**************************************************
-int    UI_getCurrentPreview(void)
-{
-  return 0; 
-}
-void   UI_setCurrentPreview(int ne)
-{
-}
 
 //**************************************************
 //**************************************************

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp	2007-02-05 20:00:56 UTC (rev 2804)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp	2007-02-06 07:28:16 UTC (rev 2805)
@@ -64,8 +64,8 @@
 //_____________________________________
 
 
-static ColYuvRgb rgbConverter(640,480);
-static ColYuvRgb rgbConverter2(640,480);
+extern ColYuvRgb rgbConverter;
+extern ColYuvRgb rgbConverter2;
 
 //_____________________________________
 static AccelRender    *accel_mode=NULL;



From mean at mail.berlios.de  Wed Feb  7 20:36:34 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 7 Feb 2007 20:36:34 +0100
Subject: [Avidemux-svn-commit] r2806 - in
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4:
	ADM_filters ADM_filters/icons ADM_gui
Message-ID: <200702071936.l17JaYwQ026448@sheep.berlios.de>

Author: mean
Date: 2007-02-07 20:36:34 +0100 (Wed, 07 Feb 2007)
New Revision: 2806

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/down.png
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/up.png
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/filter.qrc
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/mainfilter.ui
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h
Log:
improve filter/QT4 look

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp	2007-02-06 07:28:16 UTC (rev 2805)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp	2007-02-07 19:36:34 UTC (rev 2806)
@@ -48,6 +48,7 @@
 #include "ADM_editor/ADM_edit.hxx"
 #include "ADM_video/ADM_genvideo.hxx"
 #include "ADM_filter/video_filters.h"
+#include "ADM_video/ADM_vidPartial.h"
 /*******************************************************/
 #define NB_TREE 7
 static int startFilter[NB_TREE];
@@ -296,13 +297,52 @@
     add(0);
 }
 /**
-
+        \fn     filtermainWindow::partial( bool b)
+        \brief  Partialize one filter
 */
 void filtermainWindow::partial( bool b)
 {
   printf("partial\n"); 
+   QListWidgetItem *item=activeList->currentItem();
+   if(!item)
+   {
+      printf("No selection\n");
+      return;
+   }
+    
+     int itag=item->type();
+     ADM_assert(itag>ACTIVE_FILTER_BASE);
+     itag-=ACTIVE_FILTER_BASE;
+     /* Filter 0 is the decoder ...*/
+      printf("Rank : %d\n",itag); 
+      ADM_assert(itag);
+     
+        AVDMGenericVideoStream *replace;
+        CONFcouple *conf;
+        conf = videofilters[itag].conf;
+        if (videofilters[itag].tag == VF_PARTIAL)	// cannot recurse
+        {
+            GUI_Error_HIG (_("The filter is already partial"), NULL);
+            return;
+        }
+        replace =new ADMVideoPartial (videofilters[itag - 1].
+                                      filter,
+                                      videofilters[itag].tag,
+                                      conf);
+        if(replace->configure (videofilters[itag - 1].filter))
+        {
+            delete videofilters[itag].filter;
+            if (conf) delete conf;
+            videofilters[itag].filter = replace;
+            replace->getCoupledConf (&conf);
+            videofilters[itag].conf = conf;
+            videofilters[itag].tag = VF_PARTIAL;
+            getFirstVideoFilter ();
+            buildActiveFilterList ();   
+        }
+        else delete replace;
 }
-
+#define myBg 0xF0
 /**
         \fn     buildAvailableFilterList(void)
         \brief  build the internal datas needed to handle the list. Need to be called only once.
@@ -313,19 +353,22 @@
   int current_raw=0;;
   
   max=0;
+  QColor colorGrey;
+  colorGrey.setRgb(myBg,myBg,myBg);
+  QBrush brush(colorGrey);
+  QSize sz;
+  
   for (uint32_t i = 0; i < nb_video_filter; i++)
     {
       if (allfilters[i].viewable==1)
         {
           QString str; //="<b>";
           str+=allfilters[i].name;
-          str+=":";//"</b><br>";
-//           str+="<b>";
-          str+=allfilters[i].description; // Mem leak ?
-//           str+="</b>";
           max++;
           
           QListWidgetItem *item=new QListWidgetItem(str,allList[current_tree],ALL_FILTER_BASE+i);
+          item->setToolTip(allfilters[i].description);
+          if(i&1) item->setBackground(brush);
           allList[current_tree]->addItem(item);
           current_raw++;
           
@@ -353,6 +396,10 @@
 {
   VF_FILTERS fil;
   activeList->clear();
+  QColor colorGrey;
+  colorGrey.setRgb(myBg,myBg,myBg);
+  QBrush brush(colorGrey);
+
   for (uint32_t i = 1; i < nb_active_filter; i++)
     {
                 QString str;
@@ -361,6 +408,7 @@
                  str =filterGetNameFromTag(fil);
                  str+= videofilters[i].filter->printConf ();
                  QListWidgetItem *item=new QListWidgetItem(str,activeList,ACTIVE_FILTER_BASE+i);
+                 if(i&1) item->setBackground(brush);
                  activeList->addItem(item);
     }
     
@@ -400,6 +448,8 @@
     connect((ui.toolButtonUp),SIGNAL(clicked(bool)),this,SLOT(up(bool)));
     connect((ui.toolButtonDown),SIGNAL(clicked(bool)),this,SLOT(down(bool)));
     connect(ui.buttonClose, SIGNAL(clicked(bool)), this, SLOT(accept()));
+    connect(ui.toolButtonPartial, SIGNAL(clicked(bool)), this, SLOT(partial(bool)));
+    
  }
 /*******************************************************/
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/filter.qrc
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/filter.qrc	2007-02-06 07:28:16 UTC (rev 2805)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/filter.qrc	2007-02-07 19:36:34 UTC (rev 2806)
@@ -7,5 +7,7 @@
         <file>icons/5.png</file>
         <file>icons/6.png</file>
         <file>icons/7.png</file>
+        <file>icons/down.png</file>
+        <file>icons/up.png</file>
     </qresource>
 </RCC>

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/down.png
===================================================================
(Binary files differ)


Property changes on: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/down.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/up.png
===================================================================
(Binary files differ)


Property changes on: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/up.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/mainfilter.ui
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/mainfilter.ui	2007-02-06 07:28:16 UTC (rev 2805)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/mainfilter.ui	2007-02-07 19:36:34 UTC (rev 2806)
@@ -138,7 +138,7 @@
       </widget>
      </item>
      <item>
-      <widget class="QPushButton" name="pushButtonRemove" >
+      <widget class="QToolButton" name="pushButtonRemove" >
        <property name="text" >
         <string>Remove</string>
        </property>
@@ -156,6 +156,9 @@
        <property name="text" >
         <string>Up</string>
        </property>
+       <property name="icon" >
+        <iconset resource="filter.qrc" >:/new/prefix1/icons/up.png</iconset>
+       </property>
       </widget>
      </item>
      <item>
@@ -163,6 +166,9 @@
        <property name="text" >
         <string>Down</string>
        </property>
+       <property name="icon" >
+        <iconset resource="filter.qrc" >:/new/prefix1/icons/down.png</iconset>
+       </property>
       </widget>
      </item>
     </layout>

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h	2007-02-06 07:28:16 UTC (rev 2805)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h	2007-02-07 19:36:34 UTC (rev 2806)
@@ -70,6 +70,7 @@
 PROCESS(setMarkerB ,ACT_MarkB )  \
 PROCESS(pushButtonVideoConf ,ACT_VideoConfigure )  \
 PROCESS(pushButtonVideoFilter , ACT_VideoParameter  ) \
-PROCESS(pushButtonAudioConf ,ACT_AudioConfigure ) \
-PROCESS(pushButtonAudioFilter ,ACT_AudioFilters )  
+PROCESS(pushButtonAudioConf ,ACT_AudioCodec ) \
+PROCESS(pushButtonAudioFilter ,ACT_AudioFilters ) 
 
+



From mean at mail.berlios.de  Thu Feb  8 20:36:14 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 8 Feb 2007 20:36:14 +0100
Subject: [Avidemux-svn-commit] r2807 - in
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4:
	ADM_dialogFactory ADM_filters
Message-ID: <200702081936.l18JaEhX028224@sheep.berlios.de>

Author: mean
Date: 2007-02-08 20:36:13 +0100 (Thu, 08 Feb 2007)
New Revision: 2807

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_float.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_integer.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_menu.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_toggle.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_dialogFactory.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp
Log:
nicer looking QT4

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_float.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_float.cpp	2007-02-07 19:36:34 UTC (rev 2806)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_float.cpp	2007-02-08 19:36:13 UTC (rev 2807)
@@ -30,15 +30,15 @@
 #include "ADM_commonUI/DIA_factory.h"
 #include "ADM_assert.h"
 
+extern const char *shortkey(const char *);
 
 
-
 //********************************************************************
 diaElemFloat::diaElemFloat(ELEM_TYPE_FLOAT *intValue,const char *toggleTitle, ELEM_TYPE_FLOAT min, ELEM_TYPE_FLOAT max,const char *tip)
   : diaElem(ELEM_TOGGLE)
 {
   param=(void *)intValue;
-  paramTitle=toggleTitle;
+  paramTitle=shortkey(toggleTitle);
   this->min=min;
   this->max=max;
   this->tip=tip;
@@ -46,6 +46,8 @@
 
 diaElemFloat::~diaElemFloat()
 {
+  if(paramTitle)
+    delete paramTitle;
 }
 void diaElemFloat::setMe(void *dialog, void *opaque,uint32_t line)
 {
@@ -60,7 +62,7 @@
  box->show();
  
  QLabel *text=new QLabel( this->paramTitle,(QWidget *)dialog);
- 
+ text->setBuddy(box);
  layout->addWidget(text,line,0);
  layout->addWidget(box,line,1);
  

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_integer.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_integer.cpp	2007-02-07 19:36:34 UTC (rev 2806)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_integer.cpp	2007-02-08 19:36:13 UTC (rev 2807)
@@ -31,16 +31,16 @@
 #include "ADM_assert.h"
 
 
+extern const char *shortkey(const char *);
 
 
 
-
 //********************************************************************
 diaElemInteger::diaElemInteger(int32_t *intValue,const char *toggleTitle, int32_t min, int32_t max,const char *tip)
   : diaElem(ELEM_TOGGLE)
 {
   param=(void *)intValue;
-  paramTitle=toggleTitle;
+  paramTitle=shortkey(toggleTitle);
   this->min=min;
   this->max=max;
   this->tip=tip;
@@ -48,6 +48,8 @@
 
 diaElemInteger::~diaElemInteger()
 {
+  if(paramTitle)
+    delete paramTitle;
 }
 void diaElemInteger::setMe(void *dialog, void *opaque,uint32_t line)
 {
@@ -62,7 +64,7 @@
  box->show();
  
  QLabel *text=new QLabel( this->paramTitle,(QWidget *)dialog);
- 
+ text->setBuddy(box);
  layout->addWidget(text,line,0);
  layout->addWidget(box,line,1);
  
@@ -82,7 +84,7 @@
   : diaElem(ELEM_TOGGLE)
 {
   param=(void *)intValue;
-  paramTitle=toggleTitle;
+  paramTitle=shortkey(toggleTitle);
   this->min=min;
   this->max=max;
   this->tip=tip;
@@ -91,7 +93,8 @@
 
 diaElemUInteger::~diaElemUInteger()
 {
-  
+  if(paramTitle)
+    delete paramTitle;
 }
 void diaElemUInteger::setMe(void *dialog, void *opaque,uint32_t line)
 {
@@ -106,7 +109,7 @@
  box->show();
  
  QLabel *text=new QLabel( this->paramTitle,(QWidget *)dialog);
- 
+ text->setBuddy(box);
  layout->addWidget(text,line,0);
  layout->addWidget(box,line,1);
 }

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_menu.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_menu.cpp	2007-02-07 19:36:34 UTC (rev 2806)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_menu.cpp	2007-02-08 19:36:13 UTC (rev 2807)
@@ -33,14 +33,14 @@
 #include <QCheckBox>
 
 
+extern const char *shortkey(const char *);
 
-
 diaElemMenu::diaElemMenu(uint32_t *intValue,const char *itle, uint32_t nb, 
                const diaMenuEntry *menu,const char *tip)
   : diaElem(ELEM_MENU)
 {
   param=(void *)intValue;
-  paramTitle=itle;
+  paramTitle=shortkey(itle);
   this->tip=tip;
   this->menu=menu;
   this->nbMenu=nb;
@@ -48,7 +48,8 @@
 
 diaElemMenu::~diaElemMenu()
 {
-  
+  if(paramTitle)
+    delete paramTitle;
 }
 void diaElemMenu::setMe(void *dialog, void *opaque,uint32_t line)
 {
@@ -67,6 +68,7 @@
     if( *(uint32_t *)param==entries[i].val) mem=i;
   }
    combo->setCurrentIndex(mem);
+   text->setBuddy(combo);
    layout->addWidget(text,line,0);
    layout->addWidget(combo,line,1);
 }

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_toggle.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_toggle.cpp	2007-02-07 19:36:34 UTC (rev 2806)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_toggle.cpp	2007-02-08 19:36:13 UTC (rev 2807)
@@ -30,12 +30,13 @@
 #include "ADM_commonUI/DIA_factory.h"
 #include "ADM_assert.h"
 
+extern const char *shortkey(const char *);
 
 diaElemToggle::diaElemToggle(uint32_t *toggleValue,const char *toggleTitle, const char *tip)
   : diaElem(ELEM_TOGGLE)
 {
   param=(void *)toggleValue;
-  paramTitle=toggleTitle;
+  paramTitle=shortkey(toggleTitle);
   this->tip=tip;
   myWidget=NULL;
 }
@@ -45,6 +46,8 @@
   QCheckBox *box=(QCheckBox *)myWidget;
  // if(box) delete box;
   myWidget=NULL;
+  if(paramTitle)
+    delete paramTitle;
 }
 void diaElemToggle::setMe(void *dialog, void *opaque,uint32_t l)
 {

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_dialogFactory.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_dialogFactory.cpp	2007-02-07 19:36:34 UTC (rev 2806)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_dialogFactory.cpp	2007-02-08 19:36:13 UTC (rev 2807)
@@ -96,7 +96,18 @@
   return 0;
   
 }
+/**
+    \fn shortkey(const char *in)
+    \brief translate gtk like accelerator (_) to QT4 like accelerator (&)
+*/
+const char *shortkey(const char *in)
+{
+ char *t=ADM_strdup(in);
+ for(int i=0;i<strlen(t);i++)
+ {
+    if(t[i]=='_') t[i]='&'; 
+ }
+  return t;
+}
 
-
-
 //EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp	2007-02-07 19:36:34 UTC (rev 2806)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp	2007-02-08 19:36:13 UTC (rev 2807)
@@ -96,7 +96,17 @@
         void allDoubleClick( QListWidgetItem  *item);
  private slots:
  private:
+        void setSelected(int sel);
 };
+/**
+        \fn     void setSelected(int sel)
+        \brief  Set the sel line as selected in the active filter window
+*/
+void filtermainWindow::setSelected( int sel)
+{
+  if(!sel) return;
+  activeList->setCurrentRow(sel-1);
+}
 
 /**
         \fn     add( bool b)
@@ -137,6 +147,7 @@
         videofilters[nb_active_filter].tag = tag;
         videofilters[nb_active_filter].conf = coup;
         nb_active_filter++;
+        setSelected(nb_active_filter);
         buildActiveFilterList();
    }
 }
@@ -182,6 +193,13 @@
             videofilters[nb_active_filter - 1].filter = NULL;
             nb_active_filter--;
             buildActiveFilterList ();
+            if(nb_active_filter>1)
+            {
+              if(itag<nb_active_filter-1)
+                  setSelected(itag);
+              else
+                  setSelected(nb_active_filter-1);
+            }
   
 }
 /**
@@ -243,7 +261,8 @@
             &videofilters[itag], sizeof (FILTER));
         memcpy (&videofilters[itag], &tmp, sizeof (FILTER));
         getFirstVideoFilter ();
-        buildActiveFilterList ();   
+        buildActiveFilterList ();
+        setSelected(itag-1);
 }
 /**
         \fn     down( bool b)
@@ -274,7 +293,8 @@
                         &videofilters[itag], sizeof (FILTER));
             memcpy (&videofilters[itag], &tmp, sizeof (FILTER));
             getFirstVideoFilter ();
-             buildActiveFilterList ();   
+            buildActiveFilterList ();
+            setSelected(itag+1);
         }
 }
 
@@ -450,6 +470,8 @@
     connect(ui.buttonClose, SIGNAL(clicked(bool)), this, SLOT(accept()));
     connect(ui.toolButtonPartial, SIGNAL(clicked(bool)), this, SLOT(partial(bool)));
     
+    ui.tabWidgetSubtitles->setCurrentIndex(0);
+    
  }
 /*******************************************************/
 



From mean at mail.berlios.de  Sat Feb 10 10:37:37 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 10 Feb 2007 10:37:37 +0100
Subject: [Avidemux-svn-commit] r2808 - in branches/avidemux_2.4_branch:
	autononreg/dialogFactory avidemux/ADM_script
	avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory
	avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory
	avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory
	avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui
	avidemux/ADM_userInterfaces/ADM_commonUI
Message-ID: <200702100937.l1A9bbpK025126@sheep.berlios.de>

Author: mean
Date: 2007-02-10 10:37:34 +0100 (Sat, 10 Feb 2007)
New Revision: 2808

Added:
   branches/avidemux_2.4_branch/autononreg/dialogFactory/fileread.js
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_filesel.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
Log:
add file+fileselector to dialogFactory widgets

Added: branches/avidemux_2.4_branch/autononreg/dialogFactory/fileread.js
===================================================================
--- branches/avidemux_2.4_branch/autononreg/dialogFactory/fileread.js	2007-02-08 19:36:13 UTC (rev 2807)
+++ branches/avidemux_2.4_branch/autononreg/dialogFactory/fileread.js	2007-02-10 09:37:34 UTC (rev 2808)
@@ -0,0 +1,10 @@
+//AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
+var app = new Avidemux();
+var file="/work/samples/2mn.avi";
+var goodfcc="DIV3";
+var fps;
+
+	dialogFactoryFileSel();
+
+/* End of test
+*/

Modified: branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp	2007-02-08 19:36:13 UTC (rev 2807)
+++ branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp	2007-02-10 09:37:34 UTC (rev 2808)
@@ -71,6 +71,7 @@
 JSBool facFloat(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool facToggle(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool facMenu(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
+JSBool facFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 
 
 static JSFunctionSpec adm_functions[] = {
@@ -92,6 +93,7 @@
   {"dialogFactoryFloat",        facFloat,        0},
   {"dialogFactoryToggle",       facToggle,        0},
   {"dialogFactoryMenu",         facMenu,        0},
+  {"dialogFactoryFileSel",      facFile,        0},
   {0}
 };
 
@@ -538,3 +540,20 @@
     *rval = BOOLEAN_TO_JSVAL(0);
   return JS_TRUE;
 }
+JSBool facFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+   uint32_t tog=0;
+   char *test=ADM_strdup("Entry test1");
+    
+      diaElemFileRead fread(&test,"Entry");
+      diaElem *elems[]={&fread   };
+  if(diaFactoryRun("Test FileRead",1,elems))
+  {
+    *rval = BOOLEAN_TO_JSVAL(1);
+    printf("Value : <%s>\n",test);
+  }else
+    *rval = BOOLEAN_TO_JSVAL(0);
+  if(test) ADM_dealloc(test);
+  return JS_TRUE;
+}
+//EOF 

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_filesel.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_filesel.cpp	2007-02-08 19:36:13 UTC (rev 2807)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_filesel.cpp	2007-02-10 09:37:34 UTC (rev 2808)
@@ -0,0 +1,137 @@
+/***************************************************************************
+  FAC_float.cpp
+  Handle dialog factory element : Toggle
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <config.h>
+
+
+#include <string.h>
+#include <stdio.h>
+#include <math.h>
+
+#include "default.h"
+#include "ADM_toolkit_gtk/ADM_gladeSupport.h"
+#include "ADM_toolkit_gtk/toolkit_gtk.h"
+#include "ADM_toolkit_gtk/toolkit_gtk_include.h"
+#include "ADM_commonUI/DIA_factory.h"
+#include "ADM_assert.h"
+#include "ADM_toolkit/filesel.h"
+static void fileRead(void *w,void *p);
+
+
+diaElemFileRead::diaElemFileRead(char **filename,const char *toggleTitle,const char *tip)
+  : diaElem(ELEM_FILE_READ)
+{
+  param=(void *)filename;
+  paramTitle=toggleTitle;
+  this->tip=tip;
+}
+
+diaElemFileRead::~diaElemFileRead()
+{
+  
+}
+void diaElemFileRead::setMe(void *dialog, void *opaque,uint32_t line)
+{
+  GtkObject *adj;
+  GtkWidget *label;
+  GtkWidget *entry;
+  GtkWidget *hbox1;
+  GtkWidget *button;
+  
+  label = gtk_label_new_with_mnemonic (paramTitle);
+  gtk_misc_set_alignment (GTK_MISC (label), 0.0, 0.5);
+  gtk_widget_show(label);
+  
+  gtk_table_attach (GTK_TABLE (opaque), label, 0, 1, line, line+1,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  
+  /**/
+  
+  hbox1 = gtk_hbox_new (FALSE, 2);
+  gtk_container_set_border_width (GTK_CONTAINER (hbox1), 6);
+  gtk_widget_show (hbox1);
+  
+  entry = gtk_entry_new ();
+  gtk_widget_show (entry);
+  if(param)
+  {
+      char **val=(char **)param;
+      gtk_entry_set_text (GTK_ENTRY (entry), *val);
+  }
+  gtk_label_set_mnemonic_widget (GTK_LABEL(label), entry);
+  
+  /* put entry in hbox */
+  gtk_box_pack_start (GTK_BOX (hbox1), entry, TRUE, TRUE, 0); /* expand fill padding */
+  
+  /*  add button */
+  
+  button = gtk_button_new_from_stock ("gtk-open");
+  gtk_widget_show (button);
+  gtk_box_pack_start (GTK_BOX (hbox1), button, FALSE, FALSE, 0);
+
+  
+  /**/
+  gtk_table_attach (GTK_TABLE (opaque), hbox1, 1, 2, line, line+1,
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  
+  
+  /**/
+  
+  /* Add callback ...*/
+  g_signal_connect(GTK_OBJECT(button), "clicked",
+                    GTK_SIGNAL_FUNC(fileRead),  this);
+
+  
+  myWidget=(void *)entry;
+  
+}
+void diaElemFileRead::getMe(void)
+{
+  GtkWidget *widget=(GtkWidget *)myWidget;
+  char **name=(char **)param;
+  if(*name) delete [] *name;
+  *name=NULL;
+  *name =ADM_strdup(gtk_entry_get_text (GTK_ENTRY (myWidget)));
+}
+
+void diaElemFileRead::changeFile(void)
+{
+#define MAX_SEL 200
+  char buffer[MAX_SEL+1];
+  
+  GtkWidget *widget=(GtkWidget *)myWidget;
+  const char *txt;
+  txt =gtk_entry_get_text (GTK_ENTRY (myWidget));
+  
+  if(FileSel_SelectRead(paramTitle,buffer,MAX_SEL,txt))
+  {
+    char **name=(char **)param;
+    if(*name) delete [] *name;
+    *name=NULL;
+    *name =ADM_strdup(buffer);
+     gtk_entry_set_text (GTK_ENTRY (myWidget), *name);
+  }
+  
+}
+
+void fileRead(void *w,void *p)
+{
+  diaElemFileRead *me=(diaElemFileRead *)p;
+  me->changeFile();
+}
+
+//EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-02-08 19:36:13 UTC (rev 2807)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-02-10 09:37:34 UTC (rev 2808)
@@ -8,6 +8,7 @@
 
 libADM_dialogFactory_a_METASOURCES = AUTO
 
-libADM_dialogFactory_a_SOURCES = DIA_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_float.cpp FAC_menu.cpp
+libADM_dialogFactory_a_SOURCES = DIA_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_float.cpp FAC_menu.cpp \
+				DIA_filesel.cpp
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp	2007-02-08 19:36:13 UTC (rev 2807)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp	2007-02-10 09:37:34 UTC (rev 2808)
@@ -123,6 +123,25 @@
  
 }
 
+diaElemFileRead::diaElemFileRead(char **filename,const char *toggleTitle,const char *tip)
+  : diaElem(ELEM_FILE_READ)
+{
+ 
+}
 
+diaElemFileRead::~diaElemFileRead()
+{
+  
+}
+void diaElemFileRead::setMe(void *dialog, void *opaque,uint32_t line)
+{
+ 
+  
+}
+void diaElemFileRead::getMe(void)
+{
+ 
+}
+
 //******************************************************
 //EOF

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp	2007-02-08 19:36:13 UTC (rev 2807)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp	2007-02-10 09:37:34 UTC (rev 2808)
@@ -0,0 +1,55 @@
+/***************************************************************************
+  FAC_toggle.cpp
+  Handle dialog factory element : Toggle
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <config.h>
+
+
+#include <string.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <math.h>
+
+#include <QDialog>
+#include <QMessageBox>
+#include <QGridLayout>
+#include <QCheckBox>
+
+#include "default.h"
+#include "ADM_commonUI/DIA_factory.h"
+#include "ADM_assert.h"
+
+
+diaElemFileRead::diaElemFileRead(char **filename,const char *toggleTitle,const char *tip)
+  : diaElem(ELEM_FILE_READ)
+{
+ 
+}
+
+diaElemFileRead::~diaElemFileRead()
+{
+  
+}
+void diaElemFileRead::setMe(void *dialog, void *opaque,uint32_t line)
+{
+ 
+  
+}
+void diaElemFileRead::getMe(void)
+{
+ 
+}
+
+//EOF
+

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-08 19:36:13 UTC (rev 2807)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-10 09:37:34 UTC (rev 2808)
@@ -3,7 +3,7 @@
 
 libADM_dialogFactory_a_METASOURCES = AUTO
 
-libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp
+libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp FAC_filesel.cpp
 
 
 INCLUDES = $(all_includes)  $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h	2007-02-08 19:36:13 UTC (rev 2807)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h	2007-02-10 09:37:34 UTC (rev 2808)
@@ -66,8 +66,8 @@
 
 
 #define LIST_OF_BUTTONS     \
-PROCESS(setMarkerA , ACT_MarkA  ) \
-PROCESS(setMarkerB ,ACT_MarkB )  \
+PROCESS(setMarkerA , ACT_GotoMarkA  ) \
+PROCESS(setMarkerB ,ACT_GotoMarkB )  \
 PROCESS(pushButtonVideoConf ,ACT_VideoConfigure )  \
 PROCESS(pushButtonVideoFilter , ACT_VideoParameter  ) \
 PROCESS(pushButtonAudioConf ,ACT_AudioCodec ) \

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-08 19:36:13 UTC (rev 2807)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-10 09:37:34 UTC (rev 2808)
@@ -23,6 +23,7 @@
   ELEM_INTEGER,
   ELEM_FLOAT,
   ELEM_MENU,
+  ELEM_FILE_READ,
   ELEM_MAX=ELEM_TOGGLE
 };
 /*********************************************/
@@ -110,6 +111,18 @@
 };
 
 /*************************************************/
+class diaElemFileRead : public diaElem
+{
+
+public:
+  
+  diaElemFileRead(char **filename,const char *toggleTitle,const char *tip=NULL);
+  virtual ~diaElemFileRead() ;
+  void setMe(void *dialog, void *opaque,uint32_t line);
+  void getMe(void);
+  
+  void changeFile(void);
+};
 /*********************************************/
 uint8_t diaFactoryRun(const char *title,uint32_t nb,diaElem **elems);
 



From mean at mail.berlios.de  Sat Feb 10 11:35:51 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 10 Feb 2007 11:35:51 +0100
Subject: [Avidemux-svn-commit] r2809 - in
	branches/avidemux_2.4_branch/avidemux:
	ADM_userInterfaces/ADM_GTK/ADM_dialog
	ADM_userInterfaces/ADM_NONE/ADM_dialog
	ADM_userInterfaces/ADM_QT4/ADM_dialog ADM_video ADM_videoFilter
Message-ID: <200702101035.l1AAZpZK026931@sheep.berlios.de>

Author: mean
Date: 2007-02-10 11:35:49 +0100 (Sat, 10 Feb 2007)
New Revision: 2809

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidASS.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidASS.h
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidAss_Params.h
Removed:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_ass.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidASS.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidASS.h
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidAss_Params.h
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_video/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidDenoise.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/Makefile.am
Log:
dialogFactoy-cation of Ass

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_ass.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_ass.cpp	2007-02-10 09:37:34 UTC (rev 2808)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_ass.cpp	2007-02-10 10:35:49 UTC (rev 2809)
@@ -1,262 +0,0 @@
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include <config.h>
-
-
-#include <string.h>
-#include <stdio.h>
-
-# include <math.h>
-
-#include "default.h"
-#ifdef USE_FREETYPE
-
-#include "ADM_toolkit/toolkit.hxx"
-#include "ADM_toolkit/filesel.h"
-
-#include "ADM_video/ADM_vidAss_Params.h"
-#include "ADM_toolkit_gtk/ADM_gladeSupport.h"
-#include "ADM_toolkit_gtk/toolkit_gtk.h"
-#include "ADM_toolkit_gtk/toolkit_gtk_include.h"
-#include "ADM_assert.h"
-
-#define SPIN_GETI(x,y){param->y=gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(WID(x))) ;}
-#define SPIN_GET(x,y){param->y=gtk_spin_button_get_value(GTK_SPIN_BUTTON(WID(x))) ;}
-#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(x)),(gfloat)param->y) ;}
-#define ASSOCIATE(x,y)   gtk_dialog_add_action_widget (GTK_DIALOG (dialog), WID(x),y)
-
-#define   LOADSUB 17   
-     
-static GtkWidget *    create_dialog1 (void);
-uint8_t DIA_ass(ASSParams *param)
-{
-  uint8_t r=0;
-  GtkWidget *dialog=create_dialog1();
-  gtk_register_dialog(dialog);
-  
-  SPIN_SET(spinbuttonScale,font_scale);
-  SPIN_SET(spinbuttonSpacing,line_spacing); 
-  SPIN_SET(spinbuttonTop,top_margin);
-  SPIN_SET(spinbuttonBottom,bottom_margin);
-  if(param->subfile)
-  {
-    int r;
-    char *s=(char *)(param->subfile);
-    gtk_editable_delete_text(GTK_EDITABLE(WID(entrySub)), 0,-1);
-    gtk_editable_insert_text(GTK_EDITABLE(WID(entrySub)), s, strlen(s), &r);
-  }
-  ASSOCIATE(button1,LOADSUB);
-  /* Upload */
-  int x=0,d;
-  while(!x)
-  {
-      d=gtk_dialog_run(GTK_DIALOG(dialog));
-      switch(d)
-      {
-        case LOADSUB:
-          {
-            char *name=NULL;
-            GUI_FileSelRead("Select ASS/SSA file",&name);
-            if(name)
-            {
-                int r;
-                gtk_editable_delete_text(GTK_EDITABLE(WID(entrySub)), 0,-1);
-                gtk_editable_insert_text(GTK_EDITABLE(WID(entrySub)), name, strlen(name), &r);
-                ADM_dealloc(name);
-            }
-          }
-            break;
-        case GTK_RESPONSE_OK:
-        case GTK_RESPONSE_APPLY:
-              {
-                SPIN_GET(spinbuttonScale,font_scale);
-                SPIN_GET(spinbuttonSpacing,line_spacing); 
-                SPIN_GETI(spinbuttonTop,top_margin);
-                SPIN_GETI(spinbuttonBottom,bottom_margin);
-                char *n;
-                if(param->subfile)
-                {
-                  ADM_dealloc(param->subfile);
-                  param->subfile=NULL;
-                }
-                n=gtk_editable_get_chars(GTK_EDITABLE (WID(entrySub)), 0, -1);
-                printf("Name :%s\n",n);
-                param->subfile=(ADM_filename *)ADM_strdup(n);
-                r=1;
-                x=1;
-                break;
-              }
-        default:
-                r=0;
-                x=1;
-                break;
-      }
-  }
-  gtk_unregister_dialog(dialog);
-  gtk_widget_destroy(dialog);
-  return r; 
-}
-
-GtkWidget *    create_dialog1 (void)
-{
-  GtkWidget *dialog1;
-  GtkWidget *dialog_vbox1;
-  GtkWidget *table1;
-  GtkWidget *label1;
-  GtkWidget *label2;
-  GtkWidget *label3;
-  GtkWidget *label4;
-  GtkWidget *label5;
-  GtkWidget *hbox1;
-  GtkWidget *entrySub;
-  GtkWidget *button1;
-  GtkObject *spinbuttonScale_adj;
-  GtkWidget *spinbuttonScale;
-  GtkObject *spinbuttonSpacing_adj;
-  GtkWidget *spinbuttonSpacing;
-  GtkObject *spinbuttonTop_adj;
-  GtkWidget *spinbuttonTop;
-  GtkObject *spinbuttonBottom_adj;
-  GtkWidget *spinbuttonBottom;
-  GtkWidget *dialog_action_area1;
-  GtkWidget *cancelbutton1;
-  GtkWidget *okbutton1;
-
-  dialog1 = gtk_dialog_new ();
-  gtk_window_set_title (GTK_WINDOW (dialog1), _("ASS/SSA Subtitle"));
-  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
-
-  dialog_vbox1 = GTK_DIALOG (dialog1)->vbox;
-  gtk_widget_show (dialog_vbox1);
-
-  table1 = gtk_table_new (5, 2, FALSE);
-  gtk_widget_show (table1);
-  gtk_box_pack_start (GTK_BOX (dialog_vbox1), table1, TRUE, TRUE, 0);
-
-  label1 = gtk_label_new (_("Subtitle file (ass/ssa) :"));
-  gtk_widget_show (label1);
-  gtk_table_attach (GTK_TABLE (table1), label1, 0, 1, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label1), 0, 0.5);
-
-  label2 = gtk_label_new (_("Font scale :"));
-  gtk_widget_show (label2);
-  gtk_table_attach (GTK_TABLE (table1), label2, 0, 1, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label2), 0, 0.5);
-
-  label3 = gtk_label_new (_("Line spacing"));
-  gtk_widget_show (label3);
-  gtk_table_attach (GTK_TABLE (table1), label3, 0, 1, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label3), 0, 0.5);
-
-  label4 = gtk_label_new (_("Top margin"));
-  gtk_widget_show (label4);
-  gtk_table_attach (GTK_TABLE (table1), label4, 0, 1, 3, 4,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label4), 0, 0.5);
-
-  label5 = gtk_label_new (_("Bottom margin"));
-  gtk_widget_show (label5);
-  gtk_table_attach (GTK_TABLE (table1), label5, 0, 1, 4, 5,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label5), 0, 0.5);
-
-  hbox1 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox1);
-  gtk_table_attach (GTK_TABLE (table1), hbox1, 1, 2, 0, 1,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (GTK_FILL), 0, 0);
-
-  entrySub = gtk_entry_new ();
-  gtk_widget_show (entrySub);
-  gtk_box_pack_start (GTK_BOX (hbox1), entrySub, TRUE, TRUE, 0);
-
-  button1 = gtk_button_new_from_stock ("gtk-open");
-  gtk_widget_show (button1);
-  gtk_box_pack_start (GTK_BOX (hbox1), button1, FALSE, FALSE, 0);
-
-  spinbuttonScale_adj = gtk_adjustment_new (1, 0.10000000149, 10, 1, 1, 1);
-  spinbuttonScale = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonScale_adj), 1, 2);
-  gtk_widget_show (spinbuttonScale);
-  gtk_table_attach (GTK_TABLE (table1), spinbuttonScale, 1, 2, 1, 2,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbuttonScale), TRUE);
-
-  spinbuttonSpacing_adj = gtk_adjustment_new (1, 0.10000000149, 10, 1, 1, 1);
-  spinbuttonSpacing = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonSpacing_adj), 1, 2);
-  gtk_widget_show (spinbuttonSpacing);
-  gtk_table_attach (GTK_TABLE (table1), spinbuttonSpacing, 1, 2, 2, 3,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbuttonSpacing), TRUE);
-
-  spinbuttonTop_adj = gtk_adjustment_new (0, 0, 200, 1, 10, 10);
-  spinbuttonTop = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonTop_adj), 1, 0);
-  gtk_widget_show (spinbuttonTop);
-  gtk_table_attach (GTK_TABLE (table1), spinbuttonTop, 1, 2, 3, 4,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbuttonTop), TRUE);
-
-  spinbuttonBottom_adj = gtk_adjustment_new (0, 0, 200, 1, 10, 10);
-  spinbuttonBottom = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonBottom_adj), 1, 0);
-  gtk_widget_show (spinbuttonBottom);
-  gtk_table_attach (GTK_TABLE (table1), spinbuttonBottom, 1, 2, 4, 5,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbuttonBottom), TRUE);
-
-  dialog_action_area1 = GTK_DIALOG (dialog1)->action_area;
-  gtk_widget_show (dialog_action_area1);
-  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
-
-  cancelbutton1 = gtk_button_new_from_stock ("gtk-cancel");
-  gtk_widget_show (cancelbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
-  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
-
-  okbutton1 = gtk_button_new_from_stock ("gtk-ok");
-  gtk_widget_show (okbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
-  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
-
-  /* Store pointers to all widgets, for use by lookup_widget(). */
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, "dialog1");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, "dialog_vbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, table1, "table1");
-  GLADE_HOOKUP_OBJECT (dialog1, label1, "label1");
-  GLADE_HOOKUP_OBJECT (dialog1, label2, "label2");
-  GLADE_HOOKUP_OBJECT (dialog1, label3, "label3");
-  GLADE_HOOKUP_OBJECT (dialog1, label4, "label4");
-  GLADE_HOOKUP_OBJECT (dialog1, label5, "label5");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox1, "hbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, entrySub, "entrySub");
-  GLADE_HOOKUP_OBJECT (dialog1, button1, "button1");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonScale, "spinbuttonScale");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonSpacing, "spinbuttonSpacing");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonTop, "spinbuttonTop");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonBottom, "spinbuttonBottom");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, "dialog_action_area1");
-  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, "cancelbutton1");
-  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, "okbutton1");
-
-  return dialog1;
-}
-
-
-
-#endif /* USE_FREETYPE */

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am	2007-02-10 09:37:34 UTC (rev 2808)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am	2007-02-10 10:35:49 UTC (rev 2809)
@@ -31,7 +31,7 @@
 	DIA_quota.cpp \
 	DIA_animated.cpp \
 	DIA_partial.cpp \
-	DIA_ass.cpp DIA_bitrateHisto.cpp
+	DIA_bitrateHisto.cpp
 
 
 
@@ -54,6 +54,6 @@
 DIA_busy.cpp         DIA_properties.cpp  DIA_xvid.cpp \
 DIA_busy.h           DIA_lavcodec.cpp     DIA_quota.cpp       DIA_xvid4.cpp \
 DIA_calculator.cpp   DIA_encoding.cpp      DIA_lavdecoder.cpp   DIA_recent.cpp \
-DIA_chromaShift.cpp  DIA_encoding.h        DIA_lavpp_deint.cpp  DIA_requant.cpp DIA_ass.cpp
+DIA_chromaShift.cpp  DIA_encoding.h        DIA_lavpp_deint.cpp  DIA_requant.cpp 
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2007-02-10 09:37:34 UTC (rev 2808)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2007-02-10 10:35:49 UTC (rev 2809)
@@ -80,10 +80,6 @@
 		      uint32_t * br,uint32_t *fsize,xvidEncParam *param){return 0;}
 #endif
 uint8_t DIA_animated(ANIMATED_PARAM *param){return 0;}
-#ifdef USE_FREETYPE
-#include "ADM_video/ADM_vidAss_Params.h"
-uint8_t DIA_ass(ASSParams *param){return 0;}
-#endif
 uint8_t DIA_rotate(AVDMGenericVideoStream *astream,ROTATE_PARAM *param){return 0;}
 uint8_t DIA_cnr2(CNR2Param *param){return 0;}
 uint8_t DIA_DVDffParam(COMPRES_PARAMS *incoming){return 0;}

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-02-10 09:37:34 UTC (rev 2808)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-02-10 10:35:49 UTC (rev 2809)
@@ -80,10 +80,6 @@
 		      uint32_t * br,uint32_t *fsize,xvidEncParam *param){return 0;}
 #endif
 uint8_t DIA_animated(ANIMATED_PARAM *param){return 0;}
-#ifdef USE_FREETYPE
-#include "ADM_video/ADM_vidAss_Params.h"
-uint8_t DIA_ass(ASSParams *param){return 0;}
-#endif
 uint8_t DIA_rotate(AVDMGenericVideoStream *astream,ROTATE_PARAM *param){return 0;}
 uint8_t DIA_cnr2(CNR2Param *param){return 0;}
 uint8_t DIA_DVDffParam(COMPRES_PARAMS *incoming){return 0;}

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidASS.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidASS.cpp	2007-02-10 09:37:34 UTC (rev 2808)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidASS.cpp	2007-02-10 10:35:49 UTC (rev 2809)
@@ -1,350 +0,0 @@
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-/*
-  Initial port from MPlayer by Moonz
-
-*/
-#include <stdio.h>
-#include <stdlib.h>
-#include <string.h>
-#include "ADM_assert.h"
-
-#include "config.h"
-#include "fourcc.h"
-#include "avio.hxx"
-#include "avi_vars.h"
-#ifdef HAVE_ENCODER
-
-#include "ADM_toolkit/toolkit.hxx"
-#include "ADM_editor/ADM_edit.hxx"
-#include "ADM_video/ADM_genvideo.hxx"
-#include "ADM_video/ADM_vidCommonFilter.h"
-#include "ADM_video/ADM_vidASS.h"
-#include "ADM_filter/video_filters.h"
-#include "ADM_colorspace/ADM_rgb.h"
-
-#ifdef USE_FREETYPE
-
-#ifndef DIR_SEP
-# ifdef WIN32
-#   define DIR_SEP '\\'
-# else
-#   define DIR_SEP '/'
-# endif
-#endif
-
-static FILTER_PARAM assParam={7,
-        { /* float */ "font_scale",
-          /*float*/ "line_spacing",
-          /* int */ "top_margin",
-          /* int */ "bottom_margin",
-          /* bool */ "extract_embedded_fonts",
-          /* ADM_filename */ "fonts_dir",
-          /* ADM_filename */ "subfile" }};
-
-SCRIPT_CREATE(ass_script,ADMVideoSubASS,assParam);
-BUILD_CREATE(ass_create,ADMVideoSubASS);
-
-char *ADMVideoSubASS::printConf() 
-{
-      static char buf[50];
-      sprintf((char *)buf," ASS/SSA Subtitles: ");
-      
-      char *filename = (char*)_params->subfile;
-      if(filename)
-      {
-          if(strrchr(filename, DIR_SEP) != NULL && *(strrchr(filename, DIR_SEP) + 1) != 0)
-              filename = strrchr(filename, DIR_SEP) + 1;
-          strncat(buf, filename, 49-strlen(buf));
-          buf[49] = 0;
-      }else
-      {
-        strcat(buf," (no sub)");       
-      }
-      return buf;
-}
-
-//_______________________________________________________________
-
-ADMVideoSubASS::ADMVideoSubASS(AVDMGenericVideoStream *in, CONFcouple *conf) 
-{
-        _in=in;		
-        memcpy(&_info,_in->getInfo(),sizeof(_info));
-        _params = new ASSParams;
-        ADM_assert(_params);
-        
-        
-        if(conf) {
-                #define _COUPLE_GET(x) conf->getCouple(#x, &(_params->x));
-                _COUPLE_GET(font_scale)
-                _COUPLE_GET(line_spacing)
-                _COUPLE_GET(top_margin)
-                _COUPLE_GET(bottom_margin)
-                _COUPLE_GET(subfile)
-                _COUPLE_GET(fonts_dir)
-                _COUPLE_GET(extract_embedded_fonts)
-        }	
-        else {
-                _params->font_scale = 1.;
-                _params->line_spacing = _params->top_margin = _params->bottom_margin = 0;
-                _params->subfile = NULL;
-                _params->fonts_dir = (ADM_filename*)ADM_alloc(6*sizeof(ADM_filename));
-                strcpy((char*)_params->fonts_dir, "/tmp/");
-                _params->extract_embedded_fonts = 1;
-        }
-
-        _uncompressed=new ADMImage(_in->getInfo()->width,_in->getInfo()->height);
-        ADM_assert(_uncompressed);
-        _info.encoding=1;
-
-        /* ASS initialization */
-        _ass_lib = ass_library_init();
-        _ass_track = NULL;
-        _ass_rend = NULL;
-        ADM_assert(_ass_lib);
-        if(_params->subfile)
-        {
-              if(!init())
-              {
-                GUI_Error_HIG("Format ?","Are you sure this is an ass file ?"); 
-              }
-        }
-
-}
-// **********************************
-uint8_t ADMVideoSubASS::init(void)
-{
-bool use_margins = ( _params->top_margin | _params->bottom_margin ) != 0;
-
-        memcpy(&_info,_in->getInfo(),sizeof(_info));
-        _info.height += _params->top_margin + _params->bottom_margin;
-
-        ass_set_fonts_dir(_ass_lib, (const char*)_params->fonts_dir);
-        ass_set_extract_fonts(_ass_lib, _params->extract_embedded_fonts);
-        ass_set_style_overrides(_ass_lib, NULL);
-#if ASS_HAS_GLOBAL
-         if(_ass_rend) 
-        {
-              ass_renderer_done(_ass_rend);
-              _ass_rend = NULL;
-         }
-#endif
-        _ass_rend = ass_renderer_init(_ass_lib);
-
-        ADM_assert(_ass_rend);
- 
-        ass_set_frame_size(_ass_rend, _info.width, _info.height);
-        ass_set_margins(_ass_rend, _params->top_margin, _params->bottom_margin, 0, 0);
-        ass_set_use_margins(_ass_rend, use_margins);
-        ass_set_font_scale(_ass_rend, _params->font_scale);
-        ass_set_fonts(_ass_rend, NULL, "Sans");
-        //~ ass_set_aspect_ratio(_ass_rend, ((double)_info.width) / ((double)_info.height));
-#if ASS_HAS_GLOBAL
-        if(_ass_track) 
-        {
-              ass_free_track(_ass_track);
-              _ass_track = NULL;
-        }
-#endif
-       _ass_track = ass_read_file(_ass_lib, (char*)_params->subfile, NULL);
-
-        ADM_assert(_ass_track);
-        return 1;
-} 
-
-//*******************************************
-ADMVideoSubASS::~ADMVideoSubASS() 
-{
-      if(_uncompressed) DELETE(_uncompressed);
-      
-      if(_params) 
-      {
-        DELETE(_params->subfile);
-        DELETE( _params->fonts_dir);
-        DELETE(_params);
-      }
-#if ASS_HAS_GLOBAL
-        if(_ass_rend) 
-        {
-              ass_renderer_done(_ass_rend);
-              _ass_rend = NULL;
-         }
-
-        if(_ass_track) 
-        {
-              ass_free_track(_ass_track);
-              _ass_track = NULL;
-        }
-        if(_ass_lib) 
-        {
-              ass_library_done(_ass_lib);
-              _ass_lib = NULL;
-        }
-#endif
-}
-//*******************************************
-#define _r(c)  ((c)>>24)
-#define _g(c)  (((c)>>16)&0xFF)
-#define _b(c)  (((c)>>8)&0xFF)
-#define _a(c)  ((c)&0xFF)
-#define rgba2y(c)  ( (( 263*_r(c)  + 516*_g(c) + 100*_b(c)) >> 10) + 16  )
-#define rgba2u(c)  ( (( 450*_r(c) - 376*_g(c) -  73*_b(c)) >> 10) + 128 )
-#define rgba2v(c)  ( ((-152*_r(c) - 298*_g(c) + 450*_b(c)) >> 10) + 128 )
-
-uint8_t ADMVideoSubASS::getFrameNumberNoAlloc(uint32_t frame, uint32_t *len, ADMImage *data, uint32_t *flags) 
-{
-        uint32_t  i, j, k, l, val;
-        uint8_t y, u, v, opacity;
-        int32_t orig_u, orig_v,klong,newu,newv;
-        uint8_t orig_y;
-        uint8_t *bitmap, *ydata, *udata, *vdata;
-
-        if(frame>=_info.nb_frames)
-        {
-          printf("[SubAss] out of bound %u/%u\n",frame,_info.nb_frames); 
-        }
-        ADM_assert(_params);
-
-        int64_t  where = (int64_t)(_info.orgFrame + frame) * 1000000LL /
-                          (int64_t)_info.fps1000;
-
-        if(!_in->getFrameNumberNoAlloc(frame, len, _uncompressed, flags))
-                return 0;
-
-        /* Add black borders top / bottom*/
-
-        uint32_t page=_info.width*_info.height;
-        uint32_t top, bottom;
-        top=_info.width * (_params->top_margin &0xfffe);
-        if(top>page) top=0;
-        
-        if(top)
-        {
-            memset(YPLANE(data),16,top);
-            memset(UPLANE(data),128,top>>2);
-            memset(VPLANE(data),128,top>>2);
-        }
-        memcpy(YPLANE(data) + top, YPLANE(_uncompressed),page-top);
-        memcpy(UPLANE(data) + (top>>2), UPLANE(_uncompressed), (page-top)>>2);
-        memcpy(VPLANE(data) + (top>>2), VPLANE(_uncompressed), (page-top)>>2);
-
-        // Now do bottom
-        top=_info.width * (_params->bottom_margin&0xfffe);
-        if(top>page) top=0;
-        if(top)
-        {
-            memset(YPLANE(data)+page-top,16,top);
-            memset(UPLANE(data)+((page-top)>>2),128,top>>2);
-            memset(VPLANE(data)+((page-top)>>2),128,top>>2);
-        }
-        // Do we have something to render ?
-        if(!_ass_rend || !_ass_track)
-        {
-          printf("[Ass] No sub to render\n");
-          return 1; 
-        }
-
-        ass_image_t *img = ass_render_frame(_ass_rend, _ass_track, where);
-        
-
-        while(img) {
-                  y = rgba2y(img->color);
-                  u = rgba2u(img->color);
-                  v = rgba2v(img->color);
-
-                  opacity = 255 - _a(img->color);
-
-                  bitmap = img->bitmap;
-
-                  uint32_t offset=img->dst_y * _info.width +img->dst_x;
-                  uint32_t offset2=(img->dst_y>>1) * (_info.width>>1)+(img->dst_x >> 1); 
-
-                  ydata = YPLANE(data) + offset ;
-                  udata = UPLANE(data) + offset2 ;
-                  vdata = VPLANE(data) + offset2 ;
-
-                  for(i = 0; i < img->h; ++i) 
-                  {
-                          for(j = 0; j < img->w; ++j) 
-                          {
-                                  k = *(bitmap+j) * opacity / 255;
-                                  orig_y = *(ydata+j);
-                                  *(ydata+j) = (k*y + (255-k)*orig_y) / 255;
-                          }
-
-                          bitmap += img->stride;
-                          ydata += _info.width;
-                  }
-
-                  bitmap = img->bitmap;
-                  
-                  newu=u-128;
-                  newv=v-128;
-
-                  for(i = 0; i < img->h; i += 2) 
-                  {
-                          for(j = 0, l = 0; j < img->w; j += 2, ++l) 
-                          {
-                                  val = 0;
-                                  val += *(bitmap + j);
-                                  val += *(bitmap + j + 1);
-                                  val += *(bitmap + img->stride + j);
-                                  val += *(bitmap + img->stride + j + 1);
-                                  val >>= 2;
-
-                                  k = val * opacity / 255;
-                                  orig_u = *(udata+l);
-                                  orig_v = *(vdata+l);
-
-                                  orig_u=( k*u+(255-k)*orig_u)/255;
-                                  orig_v=( k*v+(255-k)*orig_v)/255;
-                                  *(udata+l) = orig_u;
-                                  *(vdata+l) = orig_v;
-                          }
-
-                          bitmap += img->stride << 1;
-                          udata += _info.width >> 1;
-                          vdata += _info.width >> 1;
-                  }
-
-                  img = img->next;
-        }
-
-        return 1;
-}
-
-uint8_t	ADMVideoSubASS::getCoupledConf(CONFcouple **conf) 
-{
-        *conf=new CONFcouple(7);
-
-#define _COUPLE_SET(x) (*conf)->setCouple(#x, _params->x);
-        _COUPLE_SET(font_scale)
-        _COUPLE_SET(line_spacing)
-        _COUPLE_SET(top_margin)
-        _COUPLE_SET(bottom_margin)
-        _COUPLE_SET(subfile)
-        _COUPLE_SET(fonts_dir)
-        _COUPLE_SET(extract_embedded_fonts)
-
-        return 1;
-}
-/************************************************/
-extern uint8_t DIA_ass(ASSParams *param);
-uint8_t ADMVideoSubASS::configure(AVDMGenericVideoStream *instream) 
-{
-  _in=instream;
-  if( DIA_ass(_params))
-  {
-    init();
-    return 1; 
-  }
-  return 0;
-}
-#endif /* HAVE_ENCODER */
-#endif /* USE_FREETYPE */

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidASS.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidASS.h	2007-02-10 09:37:34 UTC (rev 2808)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidASS.h	2007-02-10 10:35:49 UTC (rev 2809)
@@ -1,34 +0,0 @@
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef _ADM_ASS_H
-#define _ADM_ASS_H
-
-#ifdef USE_FREETYPE
-#include "ADM_libass/ass.h"
-
-#include "ADM_vidAss_Params.h" 
-class ADMVideoSubASS : public AVDMGenericVideoStream 
-{
-protected:
-        virtual char* printConf(void);
-        ASSParams* _params;
-        ass_library_t *_ass_lib;
-        ass_renderer_t *_ass_rend;
-        ass_track_t *_ass_track;
-        uint8_t init(void);
-public:
-        ADMVideoSubASS(AVDMGenericVideoStream *in, CONFcouple *conf);
-        virtual ~ADMVideoSubASS();
-        virtual uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len, ADMImage *data,uint32_t *flags);
-        uint8_t configure(AVDMGenericVideoStream *instream);
-        uint8_t	getCoupledConf(CONFcouple **conf);
-};
-#endif /* USE_FREETYPE */
-#endif

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidAss_Params.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidAss_Params.h	2007-02-10 09:37:34 UTC (rev 2808)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidAss_Params.h	2007-02-10 10:35:49 UTC (rev 2809)
@@ -1,12 +0,0 @@
-#ifndef ADM_VID_ASS_PARAM_H
-#define ADM_VID_ASS_PARAM_H
-
-typedef struct 
-{
-        float         font_scale, line_spacing;
-        uint32_t      top_margin, bottom_margin;
-        ADM_filename  *subfile, *fonts_dir;
-        uint32_t      extract_embedded_fonts;
-} ASSParams;
-
-#endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_video/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/Makefile.am	2007-02-10 09:37:34 UTC (rev 2808)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/Makefile.am	2007-02-10 10:35:49 UTC (rev 2809)
@@ -49,8 +49,7 @@
  ADM_vidMPdelogo.cpp \
  ADM_vidColorYuv.cpp  \
  ADM_guiResize.cpp \
- ADM_vidAnimated.cpp \
- ADM_vidASS.cpp
+ ADM_vidAnimated.cpp 
 
 				
 
@@ -100,8 +99,7 @@
 ADM_vobsubinfo.cpp \
 ADM_vidCrop.cpp  ADM_vobsubinfo.h \
 swscale_internal.h \
-ADM_vidTdeint_util.txt ADM_vidASS.h ADM_vidASS.cpp \
-ADM_vidAss_Params.h mmx_macros.h
+ADM_vidTdeint_util.txt mmx_macros.h
 
 ####### kdevelop will overwrite this part!!! (end)############
 INCLUDES = $(all_includes) -I../ADM_libraries -I../ADM_libraries/ADM_utilities -I../ADM_libraries/ADM_lavutil \
@@ -109,4 +107,4 @@
 noinst_HEADERS = ADM_mpdetc.h \
   ADM_cache.h \
 ADM_vidEqualizer.h ADM_vobsubinfo.h ADM_vidVobSub.h \
-ADM_vidEq2.h ADM_vidASS.h
+ADM_vidEq2.h 

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidASS.cpp (from rev 2666, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidASS.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidASS.cpp	2006-12-29 12:11:05 UTC (rev 2666)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidASS.cpp	2007-02-10 10:35:49 UTC (rev 2809)
@@ -0,0 +1,371 @@
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+/*
+  Initial port from MPlayer by Moonz
+
+*/
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include "ADM_assert.h"
+
+#include "config.h"
+#include "fourcc.h"
+#include "avio.hxx"
+#include "avi_vars.h"
+#ifdef HAVE_ENCODER
+
+#include "ADM_toolkit/toolkit.hxx"
+#include "ADM_editor/ADM_edit.hxx"
+#include "ADM_video/ADM_genvideo.hxx"
+#include "ADM_video/ADM_vidCommonFilter.h"
+#include "ADM_vidASS.h"
+#include "ADM_filter/video_filters.h"
+#include "ADM_colorspace/ADM_rgb.h"
+#include "ADM_userInterfaces/ADM_commonUI/DIA_factory.h"
+#ifdef USE_FREETYPE
+
+#ifndef DIR_SEP
+# ifdef WIN32
+#   define DIR_SEP '\\'
+# else
+#   define DIR_SEP '/'
+# endif
+#endif
+
+static FILTER_PARAM assParam={7,
+        { /* float */ "font_scale",
+          /*float*/ "line_spacing",
+          /* int */ "top_margin",
+          /* int */ "bottom_margin",
+          /* bool */ "extract_embedded_fonts",
+          /* ADM_filename */ "fonts_dir",
+          /* ADM_filename */ "subfile" }};
+
+SCRIPT_CREATE(ass_script,ADMVideoSubASS,assParam);
+BUILD_CREATE(ass_create,ADMVideoSubASS);
+
+char *ADMVideoSubASS::printConf() 
+{
+      static char buf[50];
+      sprintf((char *)buf," ASS/SSA Subtitles: ");
+      
+      char *filename = (char*)_params->subfile;
+      if(filename)
+      {
+          if(strrchr(filename, DIR_SEP) != NULL && *(strrchr(filename, DIR_SEP) + 1) != 0)
+              filename = strrchr(filename, DIR_SEP) + 1;
+          strncat(buf, filename, 49-strlen(buf));
+          buf[49] = 0;
+      }else
+      {
+        strcat(buf," (no sub)");       
+      }
+      return buf;
+}
+
+
+uint8_t ADMVideoSubASS::configure(AVDMGenericVideoStream * instream)
+{
+  UNUSED_ARG(instream);
+  
+#define PX(x) &(_params->x)
+#define MKME(x,y) x=(ELEM_TYPE_FLOAT)_params->y
+  ELEM_TYPE_FLOAT scale,spacing;
+  
+    MKME(scale,font_scale);
+    MKME(spacing,line_spacing);
+    
+    diaElemFileRead   file((char **)PX(subfile),_("_Subtitle file (ass/ssa)"));
+    diaElemFloat      dSpacing(&spacing,_("_Line spacing"),0.10,10.0);
+    diaElemFloat      dScale(&scale,_("_Font scale"),0.10,10.0);
+    diaElemUInteger   dTop(PX(top_margin),_("_Top margin"),0,200);
+    diaElemUInteger   dBottom(PX(bottom_margin),_("_Bottom margin"),0,200);
+    
+       diaElem *elems[5]={&file,&dSpacing,&dScale,&dTop,&dBottom};
+  
+   if( diaFactoryRun("Denoise",5,elems))
+   {
+#undef MKME
+#define MKME(x,y) _params->y=(float)x
+    MKME(scale,font_scale);
+    MKME(spacing,line_spacing);
+
+     return 1;
+   }
+   return 0;
+}
+
+//_______________________________________________________________
+
+ADMVideoSubASS::ADMVideoSubASS(AVDMGenericVideoStream *in, CONFcouple *conf) 
+{
+        _in=in;		
+        memcpy(&_info,_in->getInfo(),sizeof(_info));
+        _params = new ASSParams;
+        ADM_assert(_params);
+        
+        
+        if(conf) {
+                #define _COUPLE_GET(x) conf->getCouple(#x, &(_params->x));
+                _COUPLE_GET(font_scale)
+                _COUPLE_GET(line_spacing)
+                _COUPLE_GET(top_margin)
+                _COUPLE_GET(bottom_margin)
+                _COUPLE_GET(subfile)
+                _COUPLE_GET(fonts_dir)
+                _COUPLE_GET(extract_embedded_fonts)
+        }	
+        else {
+                _params->font_scale = 1.;
+                _params->line_spacing = _params->top_margin = _params->bottom_margin = 0;
+                _params->subfile = NULL;
+                _params->fonts_dir = (ADM_filename*)ADM_alloc(6*sizeof(ADM_filename));
+                strcpy((char*)_params->fonts_dir, "/tmp/");
+                _params->extract_embedded_fonts = 1;
+        }
+
+        _uncompressed=new ADMImage(_in->getInfo()->width,_in->getInfo()->height);
+        ADM_assert(_uncompressed);
+        _info.encoding=1;
+
+        /* ASS initialization */
+        _ass_lib = ass_library_init();
+        _ass_track = NULL;
+        _ass_rend = NULL;
+        ADM_assert(_ass_lib);
+        if(_params->subfile)
+        {
+              if(!init())
+              {
+                GUI_Error_HIG("Format ?","Are you sure this is an ass file ?"); 
+              }
+        }
+
+}
+// **********************************
+uint8_t ADMVideoSubASS::init(void)
+{
+bool use_margins = ( _params->top_margin | _params->bottom_margin ) != 0;
+
+        memcpy(&_info,_in->getInfo(),sizeof(_info));
+        _info.height += _params->top_margin + _params->bottom_margin;
+
+        ass_set_fonts_dir(_ass_lib, (const char*)_params->fonts_dir);
+        ass_set_extract_fonts(_ass_lib, _params->extract_embedded_fonts);
+        ass_set_style_overrides(_ass_lib, NULL);
+#if ASS_HAS_GLOBAL
+         if(_ass_rend) 
+        {
+              ass_renderer_done(_ass_rend);
+              _ass_rend = NULL;
+         }
+#endif
+        _ass_rend = ass_renderer_init(_ass_lib);
+
+        ADM_assert(_ass_rend);
+ 
+        ass_set_frame_size(_ass_rend, _info.width, _info.height);
+        ass_set_margins(_ass_rend, _params->top_margin, _params->bottom_margin, 0, 0);
+        ass_set_use_margins(_ass_rend, use_margins);
+        ass_set_font_scale(_ass_rend, _params->font_scale);
+        ass_set_fonts(_ass_rend, NULL, "Sans");
+        //~ ass_set_aspect_ratio(_ass_rend, ((double)_info.width) / ((double)_info.height));
+#if ASS_HAS_GLOBAL
+        if(_ass_track) 
+        {
+              ass_free_track(_ass_track);
+              _ass_track = NULL;
+        }
+#endif
+       _ass_track = ass_read_file(_ass_lib, (char*)_params->subfile, NULL);
+
+        ADM_assert(_ass_track);
+        return 1;
+} 
+
+//*******************************************
+ADMVideoSubASS::~ADMVideoSubASS() 
+{
+      if(_uncompressed) DELETE(_uncompressed);
+      
+      if(_params) 
+      {
+        DELETE(_params->subfile);
+        DELETE( _params->fonts_dir);
+        DELETE(_params);
+      }
+#if ASS_HAS_GLOBAL
+        if(_ass_rend) 
+        {
+              ass_renderer_done(_ass_rend);
+              _ass_rend = NULL;
+         }
+
+        if(_ass_track) 
+        {
+              ass_free_track(_ass_track);
+              _ass_track = NULL;
+        }
+        if(_ass_lib) 
+        {
+              ass_library_done(_ass_lib);
+              _ass_lib = NULL;
+        }
+#endif
+}
+//*******************************************
+#define _r(c)  ((c)>>24)
+#define _g(c)  (((c)>>16)&0xFF)
+#define _b(c)  (((c)>>8)&0xFF)
+#define _a(c)  ((c)&0xFF)
+#define rgba2y(c)  ( (( 263*_r(c)  + 516*_g(c) + 100*_b(c)) >> 10) + 16  )
+#define rgba2u(c)  ( (( 450*_r(c) - 376*_g(c) -  73*_b(c)) >> 10) + 128 )
+#define rgba2v(c)  ( ((-152*_r(c) - 298*_g(c) + 450*_b(c)) >> 10) + 128 )
+
+uint8_t ADMVideoSubASS::getFrameNumberNoAlloc(uint32_t frame, uint32_t *len, ADMImage *data, uint32_t *flags) 
+{
+        uint32_t  i, j, k, l, val;
+        uint8_t y, u, v, opacity;
+        int32_t orig_u, orig_v,klong,newu,newv;
+        uint8_t orig_y;
+        uint8_t *bitmap, *ydata, *udata, *vdata;
+
+        if(frame>=_info.nb_frames)
+        {
+          printf("[SubAss] out of bound %u/%u\n",frame,_info.nb_frames); 
+        }
+        ADM_assert(_params);
+
+        int64_t  where = (int64_t)(_info.orgFrame + frame) * 1000000LL /
+                          (int64_t)_info.fps1000;
+
+        if(!_in->getFrameNumberNoAlloc(frame, len, _uncompressed, flags))
+                return 0;
+
+        /* Add black borders top / bottom*/
+
+        uint32_t page=_info.width*_info.height;
+        uint32_t top, bottom;
+        top=_info.width * (_params->top_margin &0xfffe);
+        if(top>page) top=0;
+        
+        if(top)
+        {
+            memset(YPLANE(data),16,top);
+            memset(UPLANE(data),128,top>>2);
+            memset(VPLANE(data),128,top>>2);
+        }
+        memcpy(YPLANE(data) + top, YPLANE(_uncompressed),page-top);
+        memcpy(UPLANE(data) + (top>>2), UPLANE(_uncompressed), (page-top)>>2);
+        memcpy(VPLANE(data) + (top>>2), VPLANE(_uncompressed), (page-top)>>2);
+
+        // Now do bottom
+        top=_info.width * (_params->bottom_margin&0xfffe);
+        if(top>page) top=0;
+        if(top)
+        {
+            memset(YPLANE(data)+page-top,16,top);
+            memset(UPLANE(data)+((page-top)>>2),128,top>>2);
+            memset(VPLANE(data)+((page-top)>>2),128,top>>2);
+        }
+        // Do we have something to render ?
+        if(!_ass_rend || !_ass_track)
+        {
+          printf("[Ass] No sub to render\n");
+          return 1; 
+        }
+
+        ass_image_t *img = ass_render_frame(_ass_rend, _ass_track, where);
+        
+
+        while(img) {
+                  y = rgba2y(img->color);
+                  u = rgba2u(img->color);
+                  v = rgba2v(img->color);
+
+                  opacity = 255 - _a(img->color);
+
+                  bitmap = img->bitmap;
+
+                  uint32_t offset=img->dst_y * _info.width +img->dst_x;
+                  uint32_t offset2=(img->dst_y>>1) * (_info.width>>1)+(img->dst_x >> 1); 
+
+                  ydata = YPLANE(data) + offset ;
+                  udata = UPLANE(data) + offset2 ;
+                  vdata = VPLANE(data) + offset2 ;
+
+                  for(i = 0; i < img->h; ++i) 
+                  {
+                          for(j = 0; j < img->w; ++j) 
+                          {
+                                  k = *(bitmap+j) * opacity / 255;
+                                  orig_y = *(ydata+j);
+                                  *(ydata+j) = (k*y + (255-k)*orig_y) / 255;
+                          }
+
+                          bitmap += img->stride;
+                          ydata += _info.width;
+                  }
+
+                  bitmap = img->bitmap;
+                  
+                  newu=u-128;
+                  newv=v-128;
+
+                  for(i = 0; i < img->h; i += 2) 
+                  {
+                          for(j = 0, l = 0; j < img->w; j += 2, ++l) 
+                          {
+                                  val = 0;
+                                  val += *(bitmap + j);
+                                  val += *(bitmap + j + 1);
+                                  val += *(bitmap + img->stride + j);
+                                  val += *(bitmap + img->stride + j + 1);
+                                  val >>= 2;
+
+                                  k = val * opacity / 255;
+                                  orig_u = *(udata+l);
+                                  orig_v = *(vdata+l);
+
+                                  orig_u=( k*u+(255-k)*orig_u)/255;
+                                  orig_v=( k*v+(255-k)*orig_v)/255;
+                                  *(udata+l) = orig_u;
+                                  *(vdata+l) = orig_v;
+                          }
+
+                          bitmap += img->stride << 1;
+                          udata += _info.width >> 1;
+                          vdata += _info.width >> 1;
+                  }
+
+                  img = img->next;
+        }
+
+        return 1;
+}
+
+uint8_t	ADMVideoSubASS::getCoupledConf(CONFcouple **conf) 
+{
+        *conf=new CONFcouple(7);
+
+#define _COUPLE_SET(x) (*conf)->setCouple(#x, _params->x);
+        _COUPLE_SET(font_scale)
+        _COUPLE_SET(line_spacing)
+        _COUPLE_SET(top_margin)
+        _COUPLE_SET(bottom_margin)
+        _COUPLE_SET(subfile)
+        _COUPLE_SET(fonts_dir)
+        _COUPLE_SET(extract_embedded_fonts)
+
+        return 1;
+}
+/************************************************/
+#endif /* HAVE_ENCODER */
+#endif /* USE_FREETYPE */

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidASS.h (from rev 2666, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidASS.h)

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidAss_Params.h (from rev 2489, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidAss_Params.h)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidDenoise.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidDenoise.cpp	2007-02-10 09:37:34 UTC (rev 2808)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidDenoise.cpp	2007-02-10 10:35:49 UTC (rev 2809)
@@ -375,8 +375,6 @@
 			return 0;
 	
 }
-extern uint8_t DIA_dnr(uint32_t *llock,uint32_t *lthresh, uint32_t *clock,
-			uint32_t *cthresh, uint32_t *scene);
 
 
 uint8_t ADMVideoDenoise::configure(AVDMGenericVideoStream * instream)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/Makefile.am	2007-02-10 09:37:34 UTC (rev 2808)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/Makefile.am	2007-02-10 10:35:49 UTC (rev 2809)
@@ -7,6 +7,7 @@
 #INCLUDES = $(all_includes) 
 
 libADM_videoFilter_a_SOURCES =  \
+ ADM_vidASS.cpp \
  ADM_vidBlend.cpp \
  ADM_vidDeintASM.cpp \
  ADM_vidDecDec.cpp \



From mean at mail.berlios.de  Sun Feb 11 09:02:33 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 11 Feb 2007 09:02:33 +0100
Subject: [Avidemux-svn-commit] r2810 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI
Message-ID: <200702110802.l1B82XmU029341@sheep.berlios.de>

Author: mean
Date: 2007-02-11 09:02:32 +0100 (Sun, 11 Feb 2007)
New Revision: 2810

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp
Log:
try to have SDL behaving better

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp	2007-02-10 10:35:49 UTC (rev 2809)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp	2007-02-11 08:02:32 UTC (rev 2810)
@@ -48,7 +48,9 @@
 static SDL_Overlay *sdl_overlay=NULL;
 static SDL_Surface *sdl_display=NULL;
 static SDL_Rect disp;
-
+#ifdef CYG_MANGLING
+HWND sdlWin32;
+#endif
 static ColBase *color=NULL;
 
 sdlAccelRender::sdlAccelRender( void)
@@ -126,6 +128,13 @@
         
         }
         SDL_LockSurface(sdl_display);
+#ifdef CYG_MANGLING
+       if(-1 != SDL_GetWMInfo(&wmInfo))
+       {
+          sdlWin32 = wmInfo.window;
+          SetParent(sdlWin32,(HWND) window->window);
+       }
+#endif
         int cspace;
         
         if(useYV12) cspace=SDL_YV12_OVERLAY;



From mean at mail.berlios.de  Sun Feb 11 11:02:06 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 11 Feb 2007 11:02:06 +0100
Subject: [Avidemux-svn-commit] r2811 - in
	branches/avidemux_2.4_branch/avidemux: ADM_osSupport
	ADM_userInterfaces/ADM_GTK/ADM_gui2 ADM_userInterfaces/ADM_commonUI
Message-ID: <200702111002.l1BA26NB000887@sheep.berlios.de>

Author: mean
Date: 2007-02-11 11:02:06 +0100 (Sun, 11 Feb 2007)
New Revision: 2811

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_misc.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp
Log:
win32 : Set SDL window at its proper place when starting

Modified: branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_misc.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_misc.h	2007-02-11 08:02:32 UTC (rev 2810)
+++ branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_misc.h	2007-02-11 10:02:06 UTC (rev 2811)
@@ -15,7 +15,7 @@
 
 #ifndef __ADM_MISC__
 #define __ADM_MISC__
-#include "time.h"
+//#include "time.h"
 
 typedef enum ADM_LOG_LEVEL
 {

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp	2007-02-11 08:02:32 UTC (rev 2810)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp	2007-02-11 10:02:06 UTC (rev 2811)
@@ -24,16 +24,19 @@
 #include <gtk/gtk.h>
 #ifndef CYG_MANGLING
 #include <gdk/gdkx.h>
+#else
+#include <gdk/gdkwin32.h>
 #endif
 #include <time.h>
 #include <sys/time.h>
 
 
-#include "../avi_vars.h"
+//#include "../avi_vars.h"
 #include <../ADM_assert.h>
+#define WIN32_CLASH
+#include "default.h"
+#include "ADM_osSupport/ADM_misc.h"
 
-
-
 #include "ADM_commonUI/GUI_render.h"
 
 #include "ADM_commonUI/GUI_accelRender.h"
@@ -100,6 +103,8 @@
 #ifndef CYG_MANGLING
         xinfo->window=	GDK_WINDOW_XWINDOW(widget->window);
         xinfo->display= GDK_WINDOW_XDISPLAY(win);
+#else
+        xinfo->display=	(void*)GDK_WINDOW_HWND(widget->window);
 #endif
 }
 #if 0

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp	2007-02-11 08:02:32 UTC (rev 2810)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp	2007-02-11 10:02:06 UTC (rev 2811)
@@ -129,11 +129,18 @@
         }
         SDL_LockSurface(sdl_display);
 #ifdef CYG_MANGLING
+	struct SDL_SysWMinfo wmInfo;
+	SDL_VERSION(&wmInfo.version);
        if(-1 != SDL_GetWMInfo(&wmInfo))
        {
           sdlWin32 = wmInfo.window;
-          SetParent(sdlWin32,(HWND) window->window);
+          SetParent(sdlWin32,(HWND) window->display);
+	  MoveWindow(sdlWin32,0,0,w,h,0);
        }
+       else
+       {
+		printf("[SDL] reparenting failed\n");
+       }
 #endif
         int cspace;
         



From mean at mail.berlios.de  Sun Feb 11 18:17:07 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 11 Feb 2007 18:17:07 +0100
Subject: [Avidemux-svn-commit] r2812 -
	branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec
Message-ID: <200702111717.l1BHH7u0030932@sheep.berlios.de>

Author: mean
Date: 2007-02-11 18:17:06 +0100 (Sun, 11 Feb 2007)
New Revision: 2812

Removed:
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/imgresample.c
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/Makefile.am
Log:
remove duplicate swscale

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/Makefile.am	2007-02-11 10:02:06 UTC (rev 2811)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/Makefile.am	2007-02-11 17:17:06 UTC (rev 2812)
@@ -48,7 +48,7 @@
 libavcodec_a_SOURCES = $(EXTEND_PPC) $(EXTEND_MMX) ac3enc.c $(EXTEND_AMR) \
 		adpcm.c 	allcodecs.c 	cyuv.c 	dsputil.c 	dv.c \
 		error_resilience.c 		fdctref.c 	fft.c 	h263.c 	h263dec.c 	huffyuv.c 	imgconvert.c \
-		imgresample.c 	jfdctfst.c 	jfdctint.c 	jrevdct.c 	mace.c 	mdct.c 	 	mjpeg.c \
+		jfdctfst.c 	jfdctint.c 	jrevdct.c 	mace.c 	mdct.c 	 	mjpeg.c \
 		motion_est.c 	mpeg12.c 	mpegaudio.c 	mpegaudiodec.c 	mpegvideo.c 	msmpeg4.c 	 \
 		pcm.c 	ratecontrol.c 	raw.c 	resample.c 	rv10.c 	simple_idct.c 	svq1.c \
 		utils.c 	wmadec.c 	indeo3.c 	vp3.c 	vp3dsp.c 	h264.c 	ffv1.c 	ra144.c 	ra288.c \
@@ -57,7 +57,7 @@
 		idcinvideo.c 	smc.c 	flicvideo.c 	interplayvideo.c 	dpcm.c 	8bps.c vmdav.c \
 		truemotion1.c flac.c g726.c 	qtrle.c lcl.c 	snow.c  \
 		rangecoder.c bitstream.c h264idct.c h261.c amr.c tscc.c \
-		resample2.c imgresample.c pthread.c qdm2.c bitstream_filter.c eval.c \
+		resample2.c pthread.c qdm2.c bitstream_filter.c eval.c \
 		vc1.c vc1dsp.c vp56.c vp56data.c vp6.c vp5.c indeo2.c indeo3.c  smacker.c  opt.c
 	
 
@@ -101,7 +101,7 @@
 cyuv.c      huffyuv.c     msrle.c      smc.c \
 dct-test.c    idcinvideo.c    msvideo1.c     snow.c \
 dpcm.c      imgconvert.c    nuv.c      sonic.c \
-dsputil.c     imgresample.c   oggtheora.c    svq1.c \
+dsputil.c      oggtheora.c    svq1.c \
 vc1dsp.c \
 amr_float i386 libpostproc ppc 
 

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/imgresample.c
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/imgresample.c	2007-02-11 10:02:06 UTC (rev 2811)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/imgresample.c	2007-02-11 17:17:06 UTC (rev 2812)
@@ -1,949 +0,0 @@
-/*
- * High quality image resampling with polyphase filters
- * Copyright (c) 2001 Fabrice Bellard.
- *
- * This file is part of FFmpeg.
- *
- * FFmpeg is free software; you can redistribute it and/or
- * modify it under the terms of the GNU Lesser General Public
- * License as published by the Free Software Foundation; either
- * version 2.1 of the License, or (at your option) any later version.
- *
- * FFmpeg is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
- * Lesser General Public License for more details.
- *
- * You should have received a copy of the GNU Lesser General Public
- * License along with FFmpeg; if not, write to the Free Software
- * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
- */
-
-/**
- * @file imgresample.c
- * High quality image resampling with polyphase filters .
- */
-
-#include "avcodec.h"
-#include "swscale.h"
-#include "dsputil.h"
-
-#ifdef USE_FASTMEMCPY
-#include "libvo/fastmemcpy.h"
-#endif
-
-#define NB_COMPONENTS 3
-
-#define PHASE_BITS 4
-#define NB_PHASES  (1 << PHASE_BITS)
-#define NB_TAPS    4
-#define FCENTER    1  /* index of the center of the filter */
-//#define TEST    1  /* Test it */
-
-#define POS_FRAC_BITS 16
-#define POS_FRAC      (1 << POS_FRAC_BITS)
-/* 6 bits precision is needed for MMX */
-#define FILTER_BITS   8
-
-#define LINE_BUF_HEIGHT (NB_TAPS * 4)
-#if 0 //MEANX
-struct SwsContext {
-    struct ImgReSampleContext *resampling_ctx;
-    enum PixelFormat src_pix_fmt, dst_pix_fmt;
-};
-#endif
-struct ImgReSampleContext {
-    int iwidth, iheight, owidth, oheight;
-    int topBand, bottomBand, leftBand, rightBand;
-    int padtop, padbottom, padleft, padright;
-    int pad_owidth, pad_oheight;
-    int h_incr, v_incr;
-    DECLARE_ALIGNED_8(int16_t, h_filters[NB_PHASES][NB_TAPS]); /* horizontal filters */
-    DECLARE_ALIGNED_8(int16_t, v_filters[NB_PHASES][NB_TAPS]); /* vertical filters */
-    uint8_t *line_buf;
-};
-
-void av_build_filter(int16_t *filter, double factor, int tap_count, int phase_count, int scale, int type);
-
-static inline int get_phase(int pos)
-{
-    return ((pos) >> (POS_FRAC_BITS - PHASE_BITS)) & ((1 << PHASE_BITS) - 1);
-}
-
-/* This function must be optimized */
-static void h_resample_fast(uint8_t *dst, int dst_width, const uint8_t *src,
-                            int src_width, int src_start, int src_incr,
-                            int16_t *filters)
-{
-    int src_pos, phase, sum, i;
-    const uint8_t *s;
-    int16_t *filter;
-
-    src_pos = src_start;
-    for(i=0;i<dst_width;i++) {
-#ifdef TEST
-        /* test */
-        if ((src_pos >> POS_FRAC_BITS) < 0 ||
-            (src_pos >> POS_FRAC_BITS) > (src_width - NB_TAPS))
-            av_abort();
-#endif
-        s = src + (src_pos >> POS_FRAC_BITS);
-        phase = get_phase(src_pos);
-        filter = filters + phase * NB_TAPS;
-#if NB_TAPS == 4
-        sum = s[0] * filter[0] +
-            s[1] * filter[1] +
-            s[2] * filter[2] +
-            s[3] * filter[3];
-#else
-        {
-            int j;
-            sum = 0;
-            for(j=0;j<NB_TAPS;j++)
-                sum += s[j] * filter[j];
-        }
-#endif
-        sum = sum >> FILTER_BITS;
-        if (sum < 0)
-            sum = 0;
-        else if (sum > 255)
-            sum = 255;
-        dst[0] = sum;
-        src_pos += src_incr;
-        dst++;
-    }
-}
-
-/* This function must be optimized */
-static void v_resample(uint8_t *dst, int dst_width, const uint8_t *src,
-                       int wrap, int16_t *filter)
-{
-    int sum, i;
-    const uint8_t *s;
-
-    s = src;
-    for(i=0;i<dst_width;i++) {
-#if NB_TAPS == 4
-        sum = s[0 * wrap] * filter[0] +
-            s[1 * wrap] * filter[1] +
-            s[2 * wrap] * filter[2] +
-            s[3 * wrap] * filter[3];
-#else
-        {
-            int j;
-            uint8_t *s1 = s;
-
-            sum = 0;
-            for(j=0;j<NB_TAPS;j++) {
-                sum += s1[0] * filter[j];
-                s1 += wrap;
-            }
-        }
-#endif
-        sum = sum >> FILTER_BITS;
-        if (sum < 0)
-            sum = 0;
-        else if (sum > 255)
-            sum = 255;
-        dst[0] = sum;
-        dst++;
-        s++;
-    }
-}
-
-#ifdef HAVE_MMX
-
-#include "i386/mmx.h"
-
-#define FILTER4(reg) \
-{\
-        s = src + (src_pos >> POS_FRAC_BITS);\
-        phase = get_phase(src_pos);\
-        filter = filters + phase * NB_TAPS;\
-        movq_m2r(*s, reg);\
-        punpcklbw_r2r(mm7, reg);\
-        movq_m2r(*filter, mm6);\
-        pmaddwd_r2r(reg, mm6);\
-        movq_r2r(mm6, reg);\
-        psrlq_i2r(32, reg);\
-        paddd_r2r(mm6, reg);\
-        psrad_i2r(FILTER_BITS, reg);\
-        src_pos += src_incr;\
-}
-
-#define DUMP(reg) movq_r2m(reg, tmp); printf(#reg "=%016"PRIx64"\n", tmp.uq);
-
-/* XXX: do four pixels at a time */
-static void h_resample_fast4_mmx(uint8_t *dst, int dst_width,
-                                 const uint8_t *src, int src_width,
-                                 int src_start, int src_incr, int16_t *filters)
-{
-    int src_pos, phase;
-    const uint8_t *s;
-    int16_t *filter;
-    mmx_t tmp;
-
-    src_pos = src_start;
-    pxor_r2r(mm7, mm7);
-
-    while (dst_width >= 4) {
-
-        FILTER4(mm0);
-        FILTER4(mm1);
-        FILTER4(mm2);
-        FILTER4(mm3);
-
-        packuswb_r2r(mm7, mm0);
-        packuswb_r2r(mm7, mm1);
-        packuswb_r2r(mm7, mm3);
-        packuswb_r2r(mm7, mm2);
-        movq_r2m(mm0, tmp);
-        dst[0] = tmp.ub[0];
-        movq_r2m(mm1, tmp);
-        dst[1] = tmp.ub[0];
-        movq_r2m(mm2, tmp);
-        dst[2] = tmp.ub[0];
-        movq_r2m(mm3, tmp);
-        dst[3] = tmp.ub[0];
-        dst += 4;
-        dst_width -= 4;
-    }
-    while (dst_width > 0) {
-        FILTER4(mm0);
-        packuswb_r2r(mm7, mm0);
-        movq_r2m(mm0, tmp);
-        dst[0] = tmp.ub[0];
-        dst++;
-        dst_width--;
-    }
-    emms();
-}
-
-static void v_resample4_mmx(uint8_t *dst, int dst_width, const uint8_t *src,
-                            int wrap, int16_t *filter)
-{
-    int sum, i, v;
-    const uint8_t *s;
-    mmx_t tmp;
-    mmx_t coefs[4];
-
-    for(i=0;i<4;i++) {
-        v = filter[i];
-        coefs[i].uw[0] = v;
-        coefs[i].uw[1] = v;
-        coefs[i].uw[2] = v;
-        coefs[i].uw[3] = v;
-    }
-
-    pxor_r2r(mm7, mm7);
-    s = src;
-    while (dst_width >= 4) {
-        movq_m2r(s[0 * wrap], mm0);
-        punpcklbw_r2r(mm7, mm0);
-        movq_m2r(s[1 * wrap], mm1);
-        punpcklbw_r2r(mm7, mm1);
-        movq_m2r(s[2 * wrap], mm2);
-        punpcklbw_r2r(mm7, mm2);
-        movq_m2r(s[3 * wrap], mm3);
-        punpcklbw_r2r(mm7, mm3);
-
-        pmullw_m2r(coefs[0], mm0);
-        pmullw_m2r(coefs[1], mm1);
-        pmullw_m2r(coefs[2], mm2);
-        pmullw_m2r(coefs[3], mm3);
-
-        paddw_r2r(mm1, mm0);
-        paddw_r2r(mm3, mm2);
-        paddw_r2r(mm2, mm0);
-        psraw_i2r(FILTER_BITS, mm0);
-
-        packuswb_r2r(mm7, mm0);
-        movq_r2m(mm0, tmp);
-
-        *(uint32_t *)dst = tmp.ud[0];
-        dst += 4;
-        s += 4;
-        dst_width -= 4;
-    }
-    while (dst_width > 0) {
-        sum = s[0 * wrap] * filter[0] +
-            s[1 * wrap] * filter[1] +
-            s[2 * wrap] * filter[2] +
-            s[3 * wrap] * filter[3];
-        sum = sum >> FILTER_BITS;
-        if (sum < 0)
-            sum = 0;
-        else if (sum > 255)
-            sum = 255;
-        dst[0] = sum;
-        dst++;
-        s++;
-        dst_width--;
-    }
-    emms();
-}
-#endif
-
-#ifdef HAVE_ALTIVEC
-typedef         union {
-    vector unsigned char v;
-    unsigned char c[16];
-} vec_uc_t;
-
-typedef         union {
-    vector signed short v;
-    signed short s[8];
-} vec_ss_t;
-
-void v_resample16_altivec(uint8_t *dst, int dst_width, const uint8_t *src,
-                          int wrap, int16_t *filter)
-{
-    int sum, i;
-    const uint8_t *s;
-    vector unsigned char *tv, tmp, dstv, zero;
-    vec_ss_t srchv[4], srclv[4], fv[4];
-    vector signed short zeros, sumhv, sumlv;
-    s = src;
-
-    for(i=0;i<4;i++)
-    {
-        /*
-           The vec_madds later on does an implicit >>15 on the result.
-           Since FILTER_BITS is 8, and we have 15 bits of magnitude in
-           a signed short, we have just enough bits to pre-shift our
-           filter constants <<7 to compensate for vec_madds.
-        */
-        fv[i].s[0] = filter[i] << (15-FILTER_BITS);
-        fv[i].v = vec_splat(fv[i].v, 0);
-    }
-
-    zero = vec_splat_u8(0);
-    zeros = vec_splat_s16(0);
-
-
-    /*
-       When we're resampling, we'd ideally like both our input buffers,
-       and output buffers to be 16-byte aligned, so we can do both aligned
-       reads and writes. Sadly we can't always have this at the moment, so
-       we opt for aligned writes, as unaligned writes have a huge overhead.
-       To do this, do enough scalar resamples to get dst 16-byte aligned.
-    */
-    i = (-(int)dst) & 0xf;
-    while(i>0) {
-        sum = s[0 * wrap] * filter[0] +
-        s[1 * wrap] * filter[1] +
-        s[2 * wrap] * filter[2] +
-        s[3 * wrap] * filter[3];
-        sum = sum >> FILTER_BITS;
-        if (sum<0) sum = 0; else if (sum>255) sum=255;
-        dst[0] = sum;
-        dst++;
-        s++;
-        dst_width--;
-        i--;
-    }
-
-    /* Do our altivec resampling on 16 pixels at once. */
-    while(dst_width>=16) {
-        /*
-           Read 16 (potentially unaligned) bytes from each of
-           4 lines into 4 vectors, and split them into shorts.
-           Interleave the multipy/accumulate for the resample
-           filter with the loads to hide the 3 cycle latency
-           the vec_madds have.
-        */
-        tv = (vector unsigned char *) &s[0 * wrap];
-        tmp = vec_perm(tv[0], tv[1], vec_lvsl(0, &s[i * wrap]));
-        srchv[0].v = (vector signed short) vec_mergeh(zero, tmp);
-        srclv[0].v = (vector signed short) vec_mergel(zero, tmp);
-        sumhv = vec_madds(srchv[0].v, fv[0].v, zeros);
-        sumlv = vec_madds(srclv[0].v, fv[0].v, zeros);
-
-        tv = (vector unsigned char *) &s[1 * wrap];
-        tmp = vec_perm(tv[0], tv[1], vec_lvsl(0, &s[1 * wrap]));
-        srchv[1].v = (vector signed short) vec_mergeh(zero, tmp);
-        srclv[1].v = (vector signed short) vec_mergel(zero, tmp);
-        sumhv = vec_madds(srchv[1].v, fv[1].v, sumhv);
-        sumlv = vec_madds(srclv[1].v, fv[1].v, sumlv);
-
-        tv = (vector unsigned char *) &s[2 * wrap];
-        tmp = vec_perm(tv[0], tv[1], vec_lvsl(0, &s[2 * wrap]));
-        srchv[2].v = (vector signed short) vec_mergeh(zero, tmp);
-        srclv[2].v = (vector signed short) vec_mergel(zero, tmp);
-        sumhv = vec_madds(srchv[2].v, fv[2].v, sumhv);
-        sumlv = vec_madds(srclv[2].v, fv[2].v, sumlv);
-
-        tv = (vector unsigned char *) &s[3 * wrap];
-        tmp = vec_perm(tv[0], tv[1], vec_lvsl(0, &s[3 * wrap]));
-        srchv[3].v = (vector signed short) vec_mergeh(zero, tmp);
-        srclv[3].v = (vector signed short) vec_mergel(zero, tmp);
-        sumhv = vec_madds(srchv[3].v, fv[3].v, sumhv);
-        sumlv = vec_madds(srclv[3].v, fv[3].v, sumlv);
-
-        /*
-           Pack the results into our destination vector,
-           and do an aligned write of that back to memory.
-        */
-        dstv = vec_packsu(sumhv, sumlv) ;
-        vec_st(dstv, 0, (vector unsigned char *) dst);
-
-        dst+=16;
-        s+=16;
-        dst_width-=16;
-    }
-
-    /*
-       If there are any leftover pixels, resample them
-       with the slow scalar method.
-    */
-    while(dst_width>0) {
-        sum = s[0 * wrap] * filter[0] +
-        s[1 * wrap] * filter[1] +
-        s[2 * wrap] * filter[2] +
-        s[3 * wrap] * filter[3];
-        sum = sum >> FILTER_BITS;
-        if (sum<0) sum = 0; else if (sum>255) sum=255;
-        dst[0] = sum;
-        dst++;
-        s++;
-        dst_width--;
-    }
-}
-#endif
-
-/* slow version to handle limit cases. Does not need optimisation */
-static void h_resample_slow(uint8_t *dst, int dst_width,
-                            const uint8_t *src, int src_width,
-                            int src_start, int src_incr, int16_t *filters)
-{
-    int src_pos, phase, sum, j, v, i;
-    const uint8_t *s, *src_end;
-    int16_t *filter;
-
-    src_end = src + src_width;
-    src_pos = src_start;
-    for(i=0;i<dst_width;i++) {
-        s = src + (src_pos >> POS_FRAC_BITS);
-        phase = get_phase(src_pos);
-        filter = filters + phase * NB_TAPS;
-        sum = 0;
-        for(j=0;j<NB_TAPS;j++) {
-            if (s < src)
-                v = src[0];
-            else if (s >= src_end)
-                v = src_end[-1];
-            else
-                v = s[0];
-            sum += v * filter[j];
-            s++;
-        }
-        sum = sum >> FILTER_BITS;
-        if (sum < 0)
-            sum = 0;
-        else if (sum > 255)
-            sum = 255;
-        dst[0] = sum;
-        src_pos += src_incr;
-        dst++;
-    }
-}
-
-static void h_resample(uint8_t *dst, int dst_width, const uint8_t *src,
-                       int src_width, int src_start, int src_incr,
-                       int16_t *filters)
-{
-    int n, src_end;
-
-    if (src_start < 0) {
-        n = (0 - src_start + src_incr - 1) / src_incr;
-        h_resample_slow(dst, n, src, src_width, src_start, src_incr, filters);
-        dst += n;
-        dst_width -= n;
-        src_start += n * src_incr;
-    }
-    src_end = src_start + dst_width * src_incr;
-    if (src_end > ((src_width - NB_TAPS) << POS_FRAC_BITS)) {
-        n = (((src_width - NB_TAPS + 1) << POS_FRAC_BITS) - 1 - src_start) /
-            src_incr;
-    } else {
-        n = dst_width;
-    }
-#ifdef HAVE_MMX
-    if ((mm_flags & MM_MMX) && NB_TAPS == 4)
-        h_resample_fast4_mmx(dst, n,
-                             src, src_width, src_start, src_incr, filters);
-    else
-#endif
-        h_resample_fast(dst, n,
-                        src, src_width, src_start, src_incr, filters);
-    if (n < dst_width) {
-        dst += n;
-        dst_width -= n;
-        src_start += n * src_incr;
-        h_resample_slow(dst, dst_width,
-                        src, src_width, src_start, src_incr, filters);
-    }
-}
-
-static void component_resample(ImgReSampleContext *s,
-                               uint8_t *output, int owrap, int owidth, int oheight,
-                               uint8_t *input, int iwrap, int iwidth, int iheight)
-{
-    int src_y, src_y1, last_src_y, ring_y, phase_y, y1, y;
-    uint8_t *new_line, *src_line;
-
-    last_src_y = - FCENTER - 1;
-    /* position of the bottom of the filter in the source image */
-    src_y = (last_src_y + NB_TAPS) * POS_FRAC;
-    ring_y = NB_TAPS; /* position in ring buffer */
-    for(y=0;y<oheight;y++) {
-        /* apply horizontal filter on new lines from input if needed */
-        src_y1 = src_y >> POS_FRAC_BITS;
-        while (last_src_y < src_y1) {
-            if (++ring_y >= LINE_BUF_HEIGHT + NB_TAPS)
-                ring_y = NB_TAPS;
-            last_src_y++;
-            /* handle limit conditions : replicate line (slightly
-               inefficient because we filter multiple times) */
-            y1 = last_src_y;
-            if (y1 < 0) {
-                y1 = 0;
-            } else if (y1 >= iheight) {
-                y1 = iheight - 1;
-            }
-            src_line = input + y1 * iwrap;
-            new_line = s->line_buf + ring_y * owidth;
-            /* apply filter and handle limit cases correctly */
-            h_resample(new_line, owidth,
-                       src_line, iwidth, - FCENTER * POS_FRAC, s->h_incr,
-                       &s->h_filters[0][0]);
-            /* handle ring buffer wraping */
-            if (ring_y >= LINE_BUF_HEIGHT) {
-                memcpy(s->line_buf + (ring_y - LINE_BUF_HEIGHT) * owidth,
-                       new_line, owidth);
-            }
-        }
-        /* apply vertical filter */
-        phase_y = get_phase(src_y);
-#ifdef HAVE_MMX
-        /* desactivated MMX because loss of precision */
-        if ((mm_flags & MM_MMX) && NB_TAPS == 4 && 0)
-            v_resample4_mmx(output, owidth,
-                            s->line_buf + (ring_y - NB_TAPS + 1) * owidth, owidth,
-                            &s->v_filters[phase_y][0]);
-        else
-#endif
-#ifdef HAVE_ALTIVEC
-            if ((mm_flags & MM_ALTIVEC) && NB_TAPS == 4 && FILTER_BITS <= 6)
-                v_resample16_altivec(output, owidth,
-                                s->line_buf + (ring_y - NB_TAPS + 1) * owidth, owidth,
-                                &s->v_filters[phase_y][0]);
-        else
-#endif
-            v_resample(output, owidth,
-                       s->line_buf + (ring_y - NB_TAPS + 1) * owidth, owidth,
-                       &s->v_filters[phase_y][0]);
-
-        src_y += s->v_incr;
-
-        output += owrap;
-    }
-}
-
-ImgReSampleContext *img_resample_init(int owidth, int oheight,
-                                      int iwidth, int iheight)
-{
-    return img_resample_full_init(owidth, oheight, iwidth, iheight,
-            0, 0, 0, 0, 0, 0, 0, 0);
-}
-
-ImgReSampleContext *img_resample_full_init(int owidth, int oheight,
-                                      int iwidth, int iheight,
-                                      int topBand, int bottomBand,
-        int leftBand, int rightBand,
-        int padtop, int padbottom,
-        int padleft, int padright)
-{
-    ImgReSampleContext *s;
-
-    if (!owidth || !oheight || !iwidth || !iheight)
-        return NULL;
-
-    s = av_mallocz(sizeof(ImgReSampleContext));
-    if (!s)
-        return NULL;
-    if((unsigned)owidth >= UINT_MAX / (LINE_BUF_HEIGHT + NB_TAPS))
-        return NULL;
-    s->line_buf = av_mallocz(owidth * (LINE_BUF_HEIGHT + NB_TAPS));
-    if (!s->line_buf)
-        goto fail;
-
-    s->owidth = owidth;
-    s->oheight = oheight;
-    s->iwidth = iwidth;
-    s->iheight = iheight;
-
-    s->topBand = topBand;
-    s->bottomBand = bottomBand;
-    s->leftBand = leftBand;
-    s->rightBand = rightBand;
-
-    s->padtop = padtop;
-    s->padbottom = padbottom;
-    s->padleft = padleft;
-    s->padright = padright;
-
-    s->pad_owidth = owidth - (padleft + padright);
-    s->pad_oheight = oheight - (padtop + padbottom);
-
-    s->h_incr = ((iwidth - leftBand - rightBand) * POS_FRAC) / s->pad_owidth;
-    s->v_incr = ((iheight - topBand - bottomBand) * POS_FRAC) / s->pad_oheight;
-
-    av_build_filter(&s->h_filters[0][0], (float) s->pad_owidth  /
-            (float) (iwidth - leftBand - rightBand), NB_TAPS, NB_PHASES, 1<<FILTER_BITS, 0);
-    av_build_filter(&s->v_filters[0][0], (float) s->pad_oheight /
-            (float) (iheight - topBand - bottomBand), NB_TAPS, NB_PHASES, 1<<FILTER_BITS, 0);
-
-    return s;
-fail:
-    av_free(s);
-    return NULL;
-}
-
-void img_resample(ImgReSampleContext *s,
-                  AVPicture *output, const AVPicture *input)
-{
-    int i, shift;
-    uint8_t* optr;
-
-    for (i=0;i<3;i++) {
-        shift = (i == 0) ? 0 : 1;
-
-        optr = output->data[i] + (((output->linesize[i] *
-                        s->padtop) + s->padleft) >> shift);
-
-        component_resample(s, optr, output->linesize[i],
-                s->pad_owidth >> shift, s->pad_oheight >> shift,
-                input->data[i] + (input->linesize[i] *
-                    (s->topBand >> shift)) + (s->leftBand >> shift),
-                input->linesize[i], ((s->iwidth - s->leftBand -
-                        s->rightBand) >> shift),
-                           (s->iheight - s->topBand - s->bottomBand) >> shift);
-    }
-}
-
-void img_resample_close(ImgReSampleContext *s)
-{
-    av_free(s->line_buf);
-    av_free(s);
-}
-
-struct SwsContext *sws_getContext(int srcW, int srcH, int srcFormat,
-                                  int dstW, int dstH, int dstFormat,
-                                  int flags, SwsFilter *srcFilter,
-                                  SwsFilter *dstFilter, double *param)
-{
-    struct SwsContext *ctx;
-
-    ctx = av_malloc(sizeof(struct SwsContext));
-    if (ctx == NULL) {
-        av_log(NULL, AV_LOG_ERROR, "Cannot allocate a resampling context!\n");
-
-        return NULL;
-    }
-
-    if ((srcH != dstH) || (srcW != dstW)) {
-        if ((srcFormat != PIX_FMT_YUV420P) || (dstFormat != PIX_FMT_YUV420P)) {
-            av_log(NULL, AV_LOG_INFO, "PIX_FMT_YUV420P will be used as an intermediate format for rescaling\n");
-        }
-        ctx->resampling_ctx = img_resample_init(dstW, dstH, srcW, srcH);
-    } else {
-        ctx->resampling_ctx = av_malloc(sizeof(ImgReSampleContext));
-        ctx->resampling_ctx->iheight = srcH;
-        ctx->resampling_ctx->iwidth = srcW;
-        ctx->resampling_ctx->oheight = dstH;
-        ctx->resampling_ctx->owidth = dstW;
-    }
-    ctx->src_pix_fmt = srcFormat;
-    ctx->dst_pix_fmt = dstFormat;
-
-    return ctx;
-}
-
-void sws_freeContext(struct SwsContext *ctx)
-{
-    if (!ctx)
-        return;
-    if ((ctx->resampling_ctx->iwidth != ctx->resampling_ctx->owidth) ||
-        (ctx->resampling_ctx->iheight != ctx->resampling_ctx->oheight)) {
-        img_resample_close(ctx->resampling_ctx);
-    } else {
-        av_free(ctx->resampling_ctx);
-    }
-    av_free(ctx);
-}
-
-
-/**
- * Checks if context is valid or reallocs a new one instead.
- * If context is NULL, just calls sws_getContext() to get a new one.
- * Otherwise, checks if the parameters are the same already saved in context.
- * If that is the case, returns the current context.
- * Otherwise, frees context and gets a new one.
- *
- * Be warned that srcFilter, dstFilter are not checked, they are
- * asumed to remain valid.
- */
-struct SwsContext *sws_getCachedContext(struct SwsContext *ctx,
-                        int srcW, int srcH, int srcFormat,
-                        int dstW, int dstH, int dstFormat, int flags,
-                        SwsFilter *srcFilter, SwsFilter *dstFilter, double *param)
-{
-    if (ctx != NULL) {
-        if ((ctx->resampling_ctx->iwidth != srcW) ||
-                        (ctx->resampling_ctx->iheight != srcH) ||
-                        (ctx->src_pix_fmt != srcFormat) ||
-                        (ctx->resampling_ctx->owidth != dstW) ||
-                        (ctx->resampling_ctx->oheight != dstH) ||
-                        (ctx->dst_pix_fmt != dstFormat))
-        {
-            sws_freeContext(ctx);
-            ctx = NULL;
-        }
-    }
-    if (ctx == NULL) {
-        return sws_getContext(srcW, srcH, srcFormat,
-                        dstW, dstH, dstFormat, flags,
-                        srcFilter, dstFilter, param);
-    }
-    return ctx;
-}
-
-int sws_scale(struct SwsContext *ctx, uint8_t* src[], int srcStride[],
-              int srcSliceY, int srcSliceH, uint8_t* dst[], int dstStride[])
-{
-    AVPicture src_pict, dst_pict;
-    int i, res = 0;
-    AVPicture picture_format_temp;
-    AVPicture picture_resample_temp, *formatted_picture, *resampled_picture;
-    uint8_t *buf1 = NULL, *buf2 = NULL;
-    enum PixelFormat current_pix_fmt;
-
-    for (i = 0; i < 4; i++) {
-        src_pict.data[i] = src[i];
-        src_pict.linesize[i] = srcStride[i];
-        dst_pict.data[i] = dst[i];
-        dst_pict.linesize[i] = dstStride[i];
-    }
-    if ((ctx->resampling_ctx->iwidth != ctx->resampling_ctx->owidth) ||
-        (ctx->resampling_ctx->iheight != ctx->resampling_ctx->oheight)) {
-        /* We have to rescale the picture, but only YUV420P rescaling is supported... */
-
-        if (ctx->src_pix_fmt != PIX_FMT_YUV420P) {
-            int size;
-
-            /* create temporary picture for rescaling input*/
-            size = avpicture_get_size(PIX_FMT_YUV420P, ctx->resampling_ctx->iwidth, ctx->resampling_ctx->iheight);
-            buf1 = av_malloc(size);
-            if (!buf1) {
-                res = -1;
-                goto the_end;
-            }
-            formatted_picture = &picture_format_temp;
-            avpicture_fill((AVPicture*)formatted_picture, buf1,
-                           PIX_FMT_YUV420P, ctx->resampling_ctx->iwidth, ctx->resampling_ctx->iheight);
-
-            if (img_convert((AVPicture*)formatted_picture, PIX_FMT_YUV420P,
-                            &src_pict, ctx->src_pix_fmt,
-                            ctx->resampling_ctx->iwidth, ctx->resampling_ctx->iheight) < 0) {
-
-                av_log(NULL, AV_LOG_ERROR, "pixel format conversion not handled\n");
-                res = -1;
-                goto the_end;
-            }
-        } else {
-            formatted_picture = &src_pict;
-        }
-
-        if (ctx->dst_pix_fmt != PIX_FMT_YUV420P) {
-            int size;
-
-            /* create temporary picture for rescaling output*/
-            size = avpicture_get_size(PIX_FMT_YUV420P, ctx->resampling_ctx->owidth, ctx->resampling_ctx->oheight);
-            buf2 = av_malloc(size);
-            if (!buf2) {
-                res = -1;
-                goto the_end;
-            }
-            resampled_picture = &picture_resample_temp;
-            avpicture_fill((AVPicture*)resampled_picture, buf2,
-                           PIX_FMT_YUV420P, ctx->resampling_ctx->owidth, ctx->resampling_ctx->oheight);
-
-        } else {
-            resampled_picture = &dst_pict;
-        }
-
-        /* ...and finally rescale!!! */
-        img_resample(ctx->resampling_ctx, resampled_picture, formatted_picture);
-        current_pix_fmt = PIX_FMT_YUV420P;
-    } else {
-        resampled_picture = &src_pict;
-        current_pix_fmt = ctx->src_pix_fmt;
-    }
-
-    if (current_pix_fmt != ctx->dst_pix_fmt) {
-        if (img_convert(&dst_pict, ctx->dst_pix_fmt,
-                        resampled_picture, current_pix_fmt,
-                        ctx->resampling_ctx->owidth, ctx->resampling_ctx->oheight) < 0) {
-
-            av_log(NULL, AV_LOG_ERROR, "pixel format conversion not handled\n");
-
-            res = -1;
-            goto the_end;
-        }
-    } else if (resampled_picture != &dst_pict) {
-        img_copy(&dst_pict, resampled_picture, current_pix_fmt,
-                        ctx->resampling_ctx->owidth, ctx->resampling_ctx->oheight);
-    }
-
-the_end:
-    av_free(buf1);
-    av_free(buf2);
-    return res;
-}
-
-
-#ifdef TEST
-#include <stdio.h>
-
-/* input */
-#define XSIZE 256
-#define YSIZE 256
-uint8_t img[XSIZE * YSIZE];
-
-/* output */
-#define XSIZE1 512
-#define YSIZE1 512
-uint8_t img1[XSIZE1 * YSIZE1];
-uint8_t img2[XSIZE1 * YSIZE1];
-
-void save_pgm(const char *filename, uint8_t *img, int xsize, int ysize)
-{
-#undef fprintf
-    FILE *f;
-    f=fopen(filename,"w");
-    fprintf(f,"P5\n%d %d\n%d\n", xsize, ysize, 255);
-    fwrite(img,1, xsize * ysize,f);
-    fclose(f);
-#define fprintf please_use_av_log
-}
-
-static void dump_filter(int16_t *filter)
-{
-    int i, ph;
-
-    for(ph=0;ph<NB_PHASES;ph++) {
-        av_log(NULL, AV_LOG_INFO, "%2d: ", ph);
-        for(i=0;i<NB_TAPS;i++) {
-            av_log(NULL, AV_LOG_INFO, " %5.2f", filter[ph * NB_TAPS + i] / 256.0);
-        }
-        av_log(NULL, AV_LOG_INFO, "\n");
-    }
-}
-
-#ifdef HAVE_MMX
-int mm_flags;
-#endif
-
-int main(int argc, char **argv)
-{
-    int x, y, v, i, xsize, ysize;
-    ImgReSampleContext *s;
-    float fact, factors[] = { 1/2.0, 3.0/4.0, 1.0, 4.0/3.0, 16.0/9.0, 2.0 };
-    char buf[256];
-
-    /* build test image */
-    for(y=0;y<YSIZE;y++) {
-        for(x=0;x<XSIZE;x++) {
-            if (x < XSIZE/2 && y < YSIZE/2) {
-                if (x < XSIZE/4 && y < YSIZE/4) {
-                    if ((x % 10) <= 6 &&
-                        (y % 10) <= 6)
-                        v = 0xff;
-                    else
-                        v = 0x00;
-                } else if (x < XSIZE/4) {
-                    if (x & 1)
-                        v = 0xff;
-                    else
-                        v = 0;
-                } else if (y < XSIZE/4) {
-                    if (y & 1)
-                        v = 0xff;
-                    else
-                        v = 0;
-                } else {
-                    if (y < YSIZE*3/8) {
-                        if ((y+x) & 1)
-                            v = 0xff;
-                        else
-                            v = 0;
-                    } else {
-                        if (((x+3) % 4) <= 1 &&
-                            ((y+3) % 4) <= 1)
-                            v = 0xff;
-                        else
-                            v = 0x00;
-                    }
-                }
-            } else if (x < XSIZE/2) {
-                v = ((x - (XSIZE/2)) * 255) / (XSIZE/2);
-            } else if (y < XSIZE/2) {
-                v = ((y - (XSIZE/2)) * 255) / (XSIZE/2);
-            } else {
-                v = ((x + y - XSIZE) * 255) / XSIZE;
-            }
-            img[(YSIZE - y) * XSIZE + (XSIZE - x)] = v;
-        }
-    }
-    save_pgm("/tmp/in.pgm", img, XSIZE, YSIZE);
-    for(i=0;i<sizeof(factors)/sizeof(float);i++) {
-        fact = factors[i];
-        xsize = (int)(XSIZE * fact);
-        ysize = (int)((YSIZE - 100) * fact);
-        s = img_resample_full_init(xsize, ysize, XSIZE, YSIZE, 50 ,50, 0, 0, 0, 0, 0, 0);
-        av_log(NULL, AV_LOG_INFO, "Factor=%0.2f\n", fact);
-        dump_filter(&s->h_filters[0][0]);
-        component_resample(s, img1, xsize, xsize, ysize,
-                           img + 50 * XSIZE, XSIZE, XSIZE, YSIZE - 100);
-        img_resample_close(s);
-
-        snprintf(buf, sizeof(buf), "/tmp/out%d.pgm", i);
-        save_pgm(buf, img1, xsize, ysize);
-    }
-
-    /* mmx test */
-#ifdef HAVE_MMX
-    av_log(NULL, AV_LOG_INFO, "MMX test\n");
-    fact = 0.72;
-    xsize = (int)(XSIZE * fact);
-    ysize = (int)(YSIZE * fact);
-    mm_flags = MM_MMX;
-    s = img_resample_init(xsize, ysize, XSIZE, YSIZE);
-    component_resample(s, img1, xsize, xsize, ysize,
-                       img, XSIZE, XSIZE, YSIZE);
-
-    mm_flags = 0;
-    s = img_resample_init(xsize, ysize, XSIZE, YSIZE);
-    component_resample(s, img2, xsize, xsize, ysize,
-                       img, XSIZE, XSIZE, YSIZE);
-    if (memcmp(img1, img2, xsize * ysize) != 0) {
-        av_log(NULL, AV_LOG_ERROR, "mmx error\n");
-        exit(1);
-    }
-    av_log(NULL, AV_LOG_INFO, "MMX OK\n");
-#endif
-    return 0;
-}
-
-#endif



From mean at mail.berlios.de  Sun Feb 11 21:51:22 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 11 Feb 2007 21:51:22 +0100
Subject: [Avidemux-svn-commit] r2813 -
	branches/avidemux_2.4_branch/avidemux/ADM_editor
Message-ID: <200702112051.l1BKpMTV020604@sheep.berlios.de>

Author: mean
Date: 2007-02-11 21:51:21 +0100 (Sun, 11 Feb 2007)
New Revision: 2813

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edSearch.cpp
Log:
guido: Fix bug in searchPreviousK

Modified: branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edSearch.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edSearch.cpp	2007-02-11 17:17:06 UTC (rev 2812)
+++ branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edSearch.cpp	2007-02-11 20:51:21 UTC (rev 2813)
@@ -126,7 +126,10 @@
 	{
 	  relframe--;
 	  if (!_videos[ref]._aviheader->getFlags (relframe, &flags))
+          {
 	    relframe = 0xffffffff;
+            break;
+          }
 	}
       // verify it is within the segment
 



From mean at mail.berlios.de  Sun Feb 11 22:24:40 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 11 Feb 2007 22:24:40 +0100
Subject: [Avidemux-svn-commit] r2814 -
	branches/avidemux_2.4_branch/avidemux/ADM_videoFilter
Message-ID: <200702112124.l1BLOeCb022729@sheep.berlios.de>

Author: mean
Date: 2007-02-11 22:24:40 +0100 (Sun, 11 Feb 2007)
New Revision: 2814

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidLargeMedian.cpp
Log:
configure for large median

Modified: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidLargeMedian.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidLargeMedian.cpp	2007-02-11 20:51:21 UTC (rev 2813)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidLargeMedian.cpp	2007-02-11 21:24:40 UTC (rev 2814)
@@ -38,8 +38,8 @@
 
 #include"ADM_vidLargeMedian.h"
 #include "ADM_filter/video_filters.h"
+#include "ADM_userInterfaces/ADM_commonUI/DIA_factory.h"
 
-
 static FILTER_PARAM nullParam={2,{"chroma","luma"}};
 
 
@@ -301,7 +301,13 @@
 
 uint8_t ADMVideoLargeMedian::configure(AVDMGenericVideoStream * instream)
 {
-  return 1; 
+  diaElemToggle luma(&(_param->luma),"_Process luma","Process luma plane");
+  diaElemToggle chroma(&(_param->chroma),"P_rocess chroma");
+  
+  diaElem *elems[2]={&luma,&chroma};
+  
+  return diaFactoryRun("Large Median 5x5",2,elems);
+  
 }
 
 



From mean at mail.berlios.de  Tue Feb 13 20:16:54 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 13 Feb 2007 20:16:54 +0100
Subject: [Avidemux-svn-commit] r2818 - in
	branches/avidemux_2.4_branch/avidemux: ADM_audiofilter
	ADM_inputs/ADM_3gp
Message-ID: <200702131916.l1DJGsui018969@sheep.berlios.de>

Author: mean
Date: 2007-02-13 20:16:54 +0100 (Tue, 13 Feb 2007)
New Revision: 2818

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_audiofilter/audio_raw.h
   branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_3gp.cpp
Log:
fix extradata when copying

Modified: branches/avidemux_2.4_branch/avidemux/ADM_audiofilter/audio_raw.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_audiofilter/audio_raw.h	2007-02-13 10:01:22 UTC (rev 2817)
+++ branches/avidemux_2.4_branch/avidemux/ADM_audiofilter/audio_raw.h	2007-02-13 19:16:54 UTC (rev 2818)
@@ -39,7 +39,11 @@
     //
             uint32_t read(uint32_t len,float *buffer) {ADM_assert(0);return 0;}
             uint32_t grab(uint8_t *outbuffer) {ADM_assert(0);return 0;}
-    
+    virtual uint8_t  extraData(uint32_t *l,uint8_t **d)
+    {
+      ADM_assert(_instream);
+      return _instream->extraData(l,d);
+    }
 };
 #endif
 //EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_3gp.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_3gp.cpp	2007-02-13 10:01:22 UTC (rev 2817)
+++ branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_3gp.cpp	2007-02-13 19:16:54 UTC (rev 2818)
@@ -1091,6 +1091,7 @@
 						switch(tag)
 						{
 							case Tag_ES_Desc:
+                                                                printf("\t ES_Desc\n");
 								tom.skipBytes(3);
 								break;
 							case Tag_DecConfigDesc:
@@ -1113,6 +1114,7 @@
 								break;
                                                         }
 							case Tag_DecSpecificInfo:
+                                                                printf("\t DecSpecicInfo\n");
                                                                 switch(current)
                                                                 {
                                                                     case 1: // Video



From mean at mail.berlios.de  Tue Feb 13 21:29:57 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 13 Feb 2007 21:29:57 +0100
Subject: [Avidemux-svn-commit] r2820 - branches/avidemux_2.4_branch
Message-ID: <200702132029.l1DKTviN024391@sheep.berlios.de>

Author: mean
Date: 2007-02-13 21:29:57 +0100 (Tue, 13 Feb 2007)
New Revision: 2820

Modified:
   branches/avidemux_2.4_branch/configure.in.in
Log:
remove openGL deps / qt4

Modified: branches/avidemux_2.4_branch/configure.in.in
===================================================================
--- branches/avidemux_2.4_branch/configure.in.in	2007-02-13 20:29:26 UTC (rev 2819)
+++ branches/avidemux_2.4_branch/configure.in.in	2007-02-13 20:29:57 UTC (rev 2820)
@@ -240,7 +240,7 @@
   *)
     AC_MSG_NOTICE(I'm assuming this is Linux)
     AC_PATH_XTRA
-    QTLIBS="-Wl,-rpath,$QTEXTRALIB -L$QTEXTRALIB -lQtGui -lQtOpenGL -lQtCore $X_LIBS -lX11 -lXext -lXmu -lXt -lXi $X_EXTRA_LIBS -lGLU -lGL -lpthread"
+    QTLIBS="-Wl,-rpath,$QTEXTRALIB -L$QTEXTRALIB -lQtGui  -lQtCore $X_LIBS -lX11 -lXext -lXmu -lXt -lXi $X_EXTRA_LIBS  -lpthread"
     QTINC="-I$QTEXTRAINC -I$QTEXTRAINC/QtGui -I$QTEXTRAINC/QtCore -I$QTEXTRAINC/QtOpenGL $X_CFLAGS -DQT_OPENGL_LIB -DQT_GUI_LIB -DQT_CORE_LIB -DQT_SHARED -I$QTEXTRAINC"
     QTBIN="$QTDIR/bin"
     ;;



From mean at mail.berlios.de  Wed Feb 14 21:46:45 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 14 Feb 2007 21:46:45 +0100
Subject: [Avidemux-svn-commit] r2822 - in branches/avidemux_2.4_branch:
	autononreg/dialogFactory avidemux/ADM_script
	avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory
	avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory
	avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory
	avidemux/ADM_userInterfaces/ADM_commonUI
Message-ID: <200702142046.l1EKkjUM004437@sheep.berlios.de>

Author: mean
Date: 2007-02-14 21:46:44 +0100 (Wed, 14 Feb 2007)
New Revision: 2822

Added:
   branches/avidemux_2.4_branch/autononreg/dialogFactory/bitrate.js
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bitrate.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bitrate.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
Log:
bitrate entry for dialogFactory

Added: branches/avidemux_2.4_branch/autononreg/dialogFactory/bitrate.js
===================================================================
--- branches/avidemux_2.4_branch/autononreg/dialogFactory/bitrate.js	2007-02-14 07:48:16 UTC (rev 2821)
+++ branches/avidemux_2.4_branch/autononreg/dialogFactory/bitrate.js	2007-02-14 20:46:44 UTC (rev 2822)
@@ -0,0 +1,10 @@
+//AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
+var app = new Avidemux();
+var file="/work/samples/2mn.avi";
+var goodfcc="DIV3";
+var fps;
+
+	dialogFactoryBitrate();
+
+/* End of test
+*/

Modified: branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp	2007-02-14 07:48:16 UTC (rev 2821)
+++ branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp	2007-02-14 20:46:44 UTC (rev 2822)
@@ -72,6 +72,7 @@
 JSBool facToggle(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool facMenu(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool facFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
+JSBool facBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 
 
 static JSFunctionSpec adm_functions[] = {
@@ -94,6 +95,7 @@
   {"dialogFactoryToggle",       facToggle,        0},
   {"dialogFactoryMenu",         facMenu,        0},
   {"dialogFactoryFileSel",      facFile,        0},
+  {"dialogFactoryBitrate",      facBitrate,        0},
   {0}
 };
 
@@ -556,4 +558,35 @@
   if(test) ADM_dealloc(test);
   return JS_TRUE;
 }
+JSBool facBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+   COMPRES_PARAMS test={
+  CodecYV12,
+  "YV12 (raw)",
+  "YV12",
+  "YV12",
+  COMPRESS_CQ,
+  1,
+  1500,
+  700,
+  1000,
+  ADM_ENC_CAP_CQ,
+  0,
+  NULL,
+  0,
+  NULL
+};
+    
+      diaElemBitrate bt(&test,"Entry");
+      diaElem *elems[]={&bt   };
+  if(diaFactoryRun("Test FileRead",1,elems))
+  {
+    *rval = BOOLEAN_TO_JSVAL(1);
+    
+  }else
+    *rval = BOOLEAN_TO_JSVAL(0);
+  
+  return JS_TRUE;
+}
+
 //EOF 

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bitrate.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bitrate.cpp	2007-02-14 07:48:16 UTC (rev 2821)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bitrate.cpp	2007-02-14 20:46:44 UTC (rev 2822)
@@ -0,0 +1,253 @@
+/***************************************************************************
+  FAC_bitrate.cpp
+  Handle dialog factory element : Bitrate (encoding mode)
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <config.h>
+
+
+#include <string.h>
+#include <stdio.h>
+#include <math.h>
+
+#include "default.h"
+#include "ADM_toolkit_gtk/ADM_gladeSupport.h"
+#include "ADM_toolkit_gtk/toolkit_gtk.h"
+#include "ADM_toolkit_gtk/toolkit_gtk_include.h"
+#include "ADM_commonUI/DIA_factory.h"
+#include "ADM_assert.h"
+
+static void cb_mod(void *w,void *p);
+
+
+ diaElemBitrate::diaElemBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip)
+  : diaElem(ELEM_BITRATE)
+{
+  param=(void *)p;
+  memcpy(&copy,p,sizeof(copy));
+  paramTitle=toggleTitle;
+  this->tip=tip;
+}
+
+diaElemBitrate::~diaElemBitrate()
+{
+  GtkWidget *w=(GtkWidget *)myWidget;
+  delete [] w;
+  myWidget=NULL;
+}
+/**
+ * \fn setMe
+ * @param dialog  Pointer to father dialog
+ * @param opaque  Internal, Gtk table to attach to
+ * @param line Line were the widget should be displayed
+ */
+void diaElemBitrate::setMe(void *dialog, void *opaque,uint32_t line)
+{
+  GtkWidget *widget;
+  GtkObject *adj;
+  GtkWidget *vbox1;
+  GtkWidget *vbox2;
+  GtkWidget *label1;
+  GtkWidget *label2;
+  GtkWidget *combo;
+  GtkWidget *spin;
+  
+  
+  vbox1 = gtk_vbox_new (FALSE, 2);
+  gtk_container_set_border_width (GTK_CONTAINER (vbox1), 6);
+  gtk_widget_show (vbox1);
+  
+  /* Add text -> encoding mode */
+  label1 = gtk_label_new_with_mnemonic ("Encoding mode");
+  gtk_misc_set_alignment (GTK_MISC (label1), 0.0, 0.5);
+  gtk_widget_show(label1);
+  
+  /* put entry in hbox */
+  gtk_box_pack_start (GTK_BOX (vbox1), label1, TRUE, TRUE, 0); /* expand fill padding */
+  /* Add text -> encoding mode */
+  label2 = gtk_label_new_with_mnemonic ("Bitrate (kb/s)");
+  gtk_misc_set_alignment (GTK_MISC (label2), 0.0, 0.5);
+  gtk_widget_show(label2);
+  /* put entry in hbox */
+  gtk_box_pack_start (GTK_BOX (vbox1), label2, TRUE, TRUE, 0); /* expand fill padding */
+  
+ 
+  /* Add encoding menu combo */
+  vbox2 = gtk_vbox_new (FALSE, 2);
+  gtk_container_set_border_width (GTK_CONTAINER (vbox2), 6);
+  gtk_widget_show (vbox2);
+  
+  combo = gtk_combo_box_new_text ();
+  gtk_widget_show (combo);
+  
+  
+  gtk_label_set_mnemonic_widget (GTK_LABEL(label1), combo);
+  
+#define add(x) gtk_combo_box_append_text (GTK_COMBO_BOX (combo),_(#x));
+  
+  add(Constant Bitrate);
+  add(Constant Quality);
+  add(Two pass-filesize);
+  add(Two pass-Avg bitrate);
+  
+  gtk_box_pack_start (GTK_BOX (vbox2), combo, TRUE, TRUE, 0); /* expand fill padding */
+  
+  /* Now add value */
+   spin = gtk_spin_button_new_with_range(0,10000,1);
+  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON(spin),TRUE);
+  gtk_spin_button_set_digits  (GTK_SPIN_BUTTON(spin),0);
+  //gtk_spin_button_set_value (GTK_SPIN_BUTTON(spin),val);
+  
+  gtk_widget_show (spin);
+  
+  gtk_box_pack_start (GTK_BOX (vbox2), spin, TRUE, TRUE, 0); /* expand fill padding */
+  
+  gtk_label_set_mnemonic_widget (GTK_LABEL(label2), spin);
+  
+  
+  /*  add button */
+   gtk_label_set_mnemonic_widget (GTK_LABEL(label1), combo);
+   
+   gtk_table_attach (GTK_TABLE (opaque), vbox1, 0, 1, line, line+1,
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+    gtk_table_attach (GTK_TABLE (opaque), vbox2, 1, 2, line, line+1,
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  
+  
+  gtk_signal_connect(GTK_OBJECT(combo), "changed",
+                      GTK_SIGNAL_FUNC(cb_mod),
+                      (void *) this);
+  
+  GtkWidget **w;
+  w=new GtkWidget*[4];
+  w[0]=label1;
+  w[1]=label2;
+  w[2]=combo;
+  w[3]=spin;
+  myWidget=(void *)w;
+  int i=0;
+  switch(copy.mode)
+  {
+    case  COMPRESS_CQ: i=1;break;
+    case  COMPRESS_CBR:i=0;break;
+    case  COMPRESS_2PASS:i=2;break;
+    case  COMPRESS_SAME:i=4;break;
+    case  COMPRESS_2PASS_BITRATE:i=3;break;
+    default: ADM_assert(0);
+  }
+  gtk_combo_box_set_active(GTK_COMBO_BOX(combo),i);
+}
+
+
+void diaElemBitrate::getMe(void)
+{
+  
+  
+  // Read current value
+  GtkWidget **w=(GtkWidget **)myWidget;
+  GtkComboBox *combo=(GtkComboBox *)w[2];
+  GtkSpinButton *spin=(GtkSpinButton*)w[3];
+  GtkLabel *label=(GtkLabel*)w[1];
+  int rank=gtk_combo_box_get_active(GTK_COMBO_BOX(combo));
+#undef P
+#undef M
+#undef S
+#define P(x) 
+#define M(x,y)
+#define S(x)   x=gtk_spin_button_get_value  (GTK_SPIN_BUTTON(spin))
+  switch(rank)
+  {
+    case 0: //CBR
+          P(Bitrate (kb/s));
+          M(0,20000);
+          S(copy.bitrate);
+          copy.mode=COMPRESS_CBR;
+          break; 
+    case 1:// CQ
+          P(Quantizer);
+          M(2,31);
+          S(copy.qz);
+          copy.mode=COMPRESS_CQ;
+          break;
+    case 2 : // 2pass Filesize
+          P(FileSize (MB));
+          M(1,8000);
+          S(copy.finalsize);
+          copy.mode=COMPRESS_2PASS;
+          break;
+    case 3 : // 2pass Avg
+          P(Average Br (kb/s));
+          M(0,20000);
+          S(copy.avg_bitrate);
+          copy.mode=COMPRESS_2PASS_BITRATE;
+          break;
+    case 4 : // Same Qz as input
+          P(-);
+          M(0,0);
+          copy.mode=COMPRESS_SAME;
+          break;
+    default:ADM_assert(0);
+  }
+  memcpy(param,&copy,sizeof(copy));
+}
+void diaElemBitrate::updateMe(void)
+{
+  // Read current value
+  GtkWidget **w=(GtkWidget **)myWidget;
+  GtkComboBox *combo=(GtkComboBox *)w[2];
+  GtkSpinButton *spin=(GtkSpinButton*)w[3];
+  GtkLabel *label=(GtkLabel*)w[1];
+  int rank=gtk_combo_box_get_active(GTK_COMBO_BOX(combo));
+#define P(x) gtk_label_set_text(GTK_LABEL(label),_(#x));
+#define M(x,y) gtk_spin_button_set_range  (GTK_SPIN_BUTTON(spin),x,y)
+#define S(x)   gtk_spin_button_set_value  (GTK_SPIN_BUTTON(spin),x)
+  switch(rank)
+  {
+    case 0: //CBR
+          P(Bitrate (kb/s));
+          M(0,20000);
+          S(copy.bitrate);
+          break; 
+    case 1:// CQ
+          P(Quantizer);
+          M(2,31);
+          S(copy.qz);
+          break;
+    case 2 : // 2pass Filesize
+          P(FileSize (MB));
+          M(1,8000);
+          S(copy.finalsize);
+          break;
+    case 3 : // 2pass Avg
+          P(Average Br (kb/s));
+          M(0,20000);
+          S(copy.avg_bitrate);
+          break;
+    case 4 : // Same Qz as input
+          P(-);
+          M(0,0);
+          break;
+    default:ADM_assert(0);
+  }
+}
+
+void cb_mod(void *w,void *p)
+{
+  diaElemBitrate *me=(diaElemBitrate *)p;
+  me->updateMe();
+}
+
+
+//EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-02-14 07:48:16 UTC (rev 2821)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-02-14 20:46:44 UTC (rev 2822)
@@ -9,6 +9,6 @@
 libADM_dialogFactory_a_METASOURCES = AUTO
 
 libADM_dialogFactory_a_SOURCES = DIA_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_float.cpp FAC_menu.cpp \
-				DIA_filesel.cpp
+				DIA_filesel.cpp FAC_bitrate.cpp
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp	2007-02-14 07:48:16 UTC (rev 2821)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp	2007-02-14 20:46:44 UTC (rev 2822)
@@ -143,5 +143,25 @@
  
 }
 
+#include "ADM_encoder/ADM_vidEncode.hxx"
+  diaElemBitrate::diaElemBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip)
+  : diaElem(ELEM_BITRATE)
+{
+  
+}
+diaElemBitrate::~diaElemBitrate()
+{
+  
+}
+void diaElemBitrate::setMe(void *dialog, void *opaque,uint32_t line)
+{
+ 
+  
+}
+void diaElemBitrate::getMe(void)
+{
+ 
+}
+             
 //******************************************************
 //EOF

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bitrate.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bitrate.cpp	2007-02-14 07:48:16 UTC (rev 2821)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bitrate.cpp	2007-02-14 20:46:44 UTC (rev 2822)
@@ -0,0 +1,55 @@
+/***************************************************************************
+  FAC_toggle.cpp
+  Handle dialog factory element : Toggle
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <config.h>
+
+
+#include <string.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <math.h>
+
+#include <QDialog>
+#include <QMessageBox>
+#include <QGridLayout>
+#include <QCheckBox>
+
+#include "default.h"
+#include "ADM_commonUI/DIA_factory.h"
+#include "ADM_assert.h"
+
+
+diaElemBitrate::diaElemBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip)
+  : diaElem(ELEM_BITRATE)
+{
+ 
+}
+
+diaElemBitrate::~diaElemBitrate()
+{
+  
+}
+void diaElemBitrate::setMe(void *dialog, void *opaque,uint32_t line)
+{
+ 
+  
+}
+void diaElemBitrate::getMe(void)
+{
+ 
+}
+
+//EOF
+

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-14 07:48:16 UTC (rev 2821)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-14 20:46:44 UTC (rev 2822)
@@ -3,7 +3,7 @@
 
 libADM_dialogFactory_a_METASOURCES = AUTO
 
-libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp FAC_filesel.cpp
+libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp FAC_filesel.cpp FAC_bitrate.cpp
 
 
 INCLUDES = $(all_includes)  $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-14 07:48:16 UTC (rev 2821)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-14 20:46:44 UTC (rev 2822)
@@ -24,6 +24,7 @@
   ELEM_FLOAT,
   ELEM_MENU,
   ELEM_FILE_READ,
+  ELEM_BITRATE,
   ELEM_MAX=ELEM_TOGGLE
 };
 /*********************************************/
@@ -109,7 +110,23 @@
   void setMe(void *dialog, void *opaque,uint32_t line);
   void getMe(void);
 };
+/*************************************************/
+#include "ADM_encoder/ADM_vidEncode.hxx"
 
+class diaElemBitrate : public diaElem
+{
+  protected:
+    COMPRES_PARAMS    copy;
+public:
+  
+  diaElemBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip=NULL);
+  virtual ~diaElemBitrate() ;
+  void setMe(void *dialog, void *opaque,uint32_t line);
+  void getMe(void);
+  
+  void updateMe(void);
+};
+
 /*************************************************/
 class diaElemFileRead : public diaElem
 {



From mean at mail.berlios.de  Thu Feb 15 08:27:36 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 15 Feb 2007 08:27:36 +0100
Subject: [Avidemux-svn-commit] r2823 - in
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces:
	ADM_GTK/ADM_dialogFactory ADM_commonUI
Message-ID: <200702150727.l1F7RaOW003534@sheep.berlios.de>

Author: mean
Date: 2007-02-15 08:27:35 +0100 (Thu, 15 Feb 2007)
New Revision: 2823

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_dialogFactory.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bitrate.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
Log:
improve bitrate widget

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_dialogFactory.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_dialogFactory.cpp	2007-02-14 20:46:44 UTC (rev 2822)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_dialogFactory.cpp	2007-02-15 07:27:35 UTC (rev 2823)
@@ -76,16 +76,23 @@
   gtk_box_set_spacing (GTK_BOX(dialog_vbox1), 12);
   gtk_widget_show (dialog_vbox1);
   
-  table1 = gtk_table_new (nb, 2, FALSE);
+  int vsize=0;
+  for(int i=0;i<nb;i++)
+      vsize+=elems[i]->getSize();
+  
+  
+  table1 = gtk_table_new (vsize, 2, FALSE);
   gtk_table_set_col_spacings (GTK_TABLE (table1), 12);
   gtk_table_set_row_spacings (GTK_TABLE (table1), 6);
   gtk_container_set_border_width (GTK_CONTAINER (table1), 6);
   gtk_widget_show (table1);
   gtk_box_pack_start (GTK_BOX (dialog_vbox1), table1, TRUE, TRUE, 0);
   
+  int line=0;
   for(int i=0;i<nb;i++)
   {
-    addLine(elems[i],dialog,table1,i);
+    addLine(elems[i],dialog,table1,line);
+    line+=elems[i]->getSize();
     
   }
   // Add a Close button

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bitrate.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bitrate.cpp	2007-02-14 20:46:44 UTC (rev 2822)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bitrate.cpp	2007-02-15 07:27:35 UTC (rev 2823)
@@ -37,6 +37,7 @@
   memcpy(&copy,p,sizeof(copy));
   paramTitle=toggleTitle;
   this->tip=tip;
+  setSize(2);
 }
 
 diaElemBitrate::~diaElemBitrate()
@@ -55,38 +56,35 @@
 {
   GtkWidget *widget;
   GtkObject *adj;
-  GtkWidget *vbox1;
-  GtkWidget *vbox2;
   GtkWidget *label1;
   GtkWidget *label2;
   GtkWidget *combo;
   GtkWidget *spin;
   
+#define PUT_ARRAY(x,y,widget)  gtk_table_attach (GTK_TABLE (opaque), widget, x, x+1, line+y, line+y+1, \
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL), \
+                    (GtkAttachOptions) (0), 0, 0);
   
-  vbox1 = gtk_vbox_new (FALSE, 2);
-  gtk_container_set_border_width (GTK_CONTAINER (vbox1), 6);
-  gtk_widget_show (vbox1);
-  
   /* Add text -> encoding mode */
   label1 = gtk_label_new_with_mnemonic ("Encoding mode");
   gtk_misc_set_alignment (GTK_MISC (label1), 0.0, 0.5);
   gtk_widget_show(label1);
   
   /* put entry in hbox */
-  gtk_box_pack_start (GTK_BOX (vbox1), label1, TRUE, TRUE, 0); /* expand fill padding */
+ 
+  PUT_ARRAY(0,0,label1);
+  
+  
   /* Add text -> encoding mode */
   label2 = gtk_label_new_with_mnemonic ("Bitrate (kb/s)");
   gtk_misc_set_alignment (GTK_MISC (label2), 0.0, 0.5);
   gtk_widget_show(label2);
   /* put entry in hbox */
-  gtk_box_pack_start (GTK_BOX (vbox1), label2, TRUE, TRUE, 0); /* expand fill padding */
-  
+  PUT_ARRAY(0,1,label2);
  
   /* Add encoding menu combo */
-  vbox2 = gtk_vbox_new (FALSE, 2);
-  gtk_container_set_border_width (GTK_CONTAINER (vbox2), 6);
-  gtk_widget_show (vbox2);
   
+  
   combo = gtk_combo_box_new_text ();
   gtk_widget_show (combo);
   
@@ -100,32 +98,21 @@
   add(Two pass-filesize);
   add(Two pass-Avg bitrate);
   
-  gtk_box_pack_start (GTK_BOX (vbox2), combo, TRUE, TRUE, 0); /* expand fill padding */
+  PUT_ARRAY(1,0,combo);
   
+  
   /* Now add value */
-   spin = gtk_spin_button_new_with_range(0,10000,1);
+  spin = gtk_spin_button_new_with_range(0,1,1);
   gtk_spin_button_set_numeric (GTK_SPIN_BUTTON(spin),TRUE);
   gtk_spin_button_set_digits  (GTK_SPIN_BUTTON(spin),0);
-  //gtk_spin_button_set_value (GTK_SPIN_BUTTON(spin),val);
   
   gtk_widget_show (spin);
   
-  gtk_box_pack_start (GTK_BOX (vbox2), spin, TRUE, TRUE, 0); /* expand fill padding */
-  
-  gtk_label_set_mnemonic_widget (GTK_LABEL(label2), spin);
-  
-  
+    PUT_ARRAY(1,1,spin);
   /*  add button */
    gtk_label_set_mnemonic_widget (GTK_LABEL(label1), combo);
+   gtk_label_set_mnemonic_widget (GTK_LABEL(label2), spin); 
    
-   gtk_table_attach (GTK_TABLE (opaque), vbox1, 0, 1, line, line+1,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-    gtk_table_attach (GTK_TABLE (opaque), vbox2, 1, 2, line, line+1,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  
-  
   gtk_signal_connect(GTK_OBJECT(combo), "changed",
                       GTK_SIGNAL_FUNC(cb_mod),
                       (void *) this);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-14 20:46:44 UTC (rev 2822)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-15 07:27:35 UTC (rev 2823)
@@ -30,15 +30,18 @@
 /*********************************************/
 class diaElem
 {
-
+  protected:
+    void    setSize(int z) {size=z;};
 public:
   void *param;
   void *myWidget;
   const char *paramTitle;
   const char *tip;
   elemEnum mySelf;
+  int       size; // Size of the widget in line
 
-  diaElem(elemEnum num) {param=NULL;mySelf=num;myWidget=NULL;};
+  diaElem(elemEnum num) {param=NULL;mySelf=num;myWidget=NULL;size=1;};
+  int getSize(void) {return size;};
   virtual ~diaElem() {};
   virtual void setMe(void *dialog, void *opaque,uint32_t line)=0;
   virtual void getMe(void)=0;



From mean at mail.berlios.de  Thu Feb 15 09:00:14 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Thu, 15 Feb 2007 09:00:14 +0100
Subject: [Avidemux-svn-commit] r2824 - in
	branches/avidemux_2.4_branch/avidemux: ADM_libraries/ADM_libmpeg2enc
	ADM_userInterfaces/ADM_GTK/ADM_dialog
	ADM_userInterfaces/ADM_commonUI
Message-ID: <200702150800.l1F80E8D005939@sheep.berlios.de>

Author: mean
Date: 2007-02-15 09:00:13 +0100 (Thu, 15 Feb 2007)
New Revision: 2824

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_SVCD.cpp
Removed:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_SVCD.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2Param.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am
Log:
use new bitrate widge to redo SVCD/DVD dialog (mpeg2enc based)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2Param.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2Param.h	2007-02-15 07:27:35 UTC (rev 2823)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2Param.h	2007-02-15 08:00:13 UTC (rev 2824)
@@ -6,12 +6,12 @@
 
 typedef struct Mpeg2encParam
 {	
-	unsigned int	maxBitrate;
-	unsigned int	gop_size;	
-	unsigned int	widescreen;
-	unsigned int	user_matrix;
-	unsigned int	interlaced;
-	unsigned int	bff;
+	uint32_t	maxBitrate;
+	uint32_t        gop_size;	
+	uint32_t        widescreen;
+	uint32_t        user_matrix;
+	uint32_t        interlaced;
+	uint32_t        bff;
 
 }Mpeg2encParam;
 

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_SVCD.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_SVCD.cpp	2007-02-15 07:27:35 UTC (rev 2823)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_SVCD.cpp	2007-02-15 08:00:13 UTC (rev 2824)
@@ -1,570 +0,0 @@
-//
-//
-// C++ Implementation: DIA_SVCD
-//
-// Description: 
-//
-//
-// Author: mean <fixounet at free.fr>, (C) 2003
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-
-#include <config.h>
-#include "ADM_lavcodec.h"
-
-
-#include <string.h>
-#include <stdio.h>
-
-#include <gdk/gdkkeysyms.h>
-#include <gtk/gtk.h>
-
-
-
-#include <gdk/gdkkeysyms.h>
-#include <gtk/gtk.h>
-# include <math.h>
-
-#include "default.h"
-
-#include "ADM_toolkit_gtk/toolkit_gtk.h"
-#include "ADM_toolkit_gtk/toolkit_gtk_include.h"
-
-
-
-#include "ADM_toolkit/toolkit.hxx"
-#include "ADM_encoder/ADM_vidEncode.hxx"
-#include "ADM_assert.h" 
-
-#include "../../../ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2enc.h"
-//#include "ADM_toolkit/toolkit.hxx"
-
-static GtkWidget	*create_dialog1 (void);
-static void 		updateMode( void );
-static int 		cb_mod(GtkObject * object, gpointer user_data);
-static void 		upload(GtkWidget *dialog, Mpeg2encParam *conf);
-static void 		download(GtkWidget *dialog, Mpeg2encParam *conf);
-
-static GtkWidget 	*dialog=NULL;		      
-static uint32_t 	mQ,mB,mS;
-static COMPRESSION_MODE mMode;
-
-
-uint8_t DIA_SVCDParam(COMPRES_PARAMS *incoming)
-{	
-	int ret=0;
-	gint b;
-
-Mpeg2encParam *conf=(Mpeg2encParam *)incoming->extraSettings;
-ADM_assert(incoming->extraSettingsLen==sizeof(Mpeg2encParam));
-
-#define WID(x) lookup_widget(dialog,#x)
-
-
-#define SPIN_GETF(x,y) {conf->y= gtk_spin_button_get_value(GTK_SPIN_BUTTON(WID(x))) ;\
-				printf(#x":%d\n",conf->y);}
-#define SPIN_GET(x,y) {conf->y= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(WID(x))) ;\
-				printf(#x":%d\n",conf->y);}
-
-#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(x)),(gfloat)conf->y) ; \
-				printf(#x":%d\n",conf->y);}
-
-#define MENU_SET(x,y) { gtk_option_menu_set_history (GTK_OPTION_MENU(WID(x)),conf->y);}
-#define MENU_GET(x,y) { conf->y	= getRangeInMenu(WID(x));}
-#define TOGGLE_SET(x,y) {gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(WID(x)),conf->y);}
-#define TOGGLE_GET(x,y) {conf->y=gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(WID(x)));\
-				printf(#y":%d\n",conf->y);}
-				
-#define ENTRY_SET(x,y) {gtk_write_entry(WID(x),(int)conf->y);}
-#define ENTRY_GET(x,y) {localParam.y=gtk_read_entry(WID(x));\
-				printf(#y":%d\n",conf->y);}
-
-#define CHECK_GET(x,y) {conf->y=gtk_toggle_button_get_active( GTK_TOGGLE_BUTTON(WID(x)));}
-#define CHECK_SET(x,y) {gtk_toggle_button_set_active( GTK_TOGGLE_BUTTON(WID(x)),conf->y);}	
-
-#define HIST_SET(x) gtk_option_menu_set_history(GTK_OPTION_MENU(WID(optionmenuType)), x)
-#define VAL_SET(x) gtk_write_entry(WID(entryBitrate), x)
-
-
-	dialog=create_dialog1();
-	gtk_register_dialog(dialog);
-  	gtk_window_set_title (GTK_WINDOW (dialog), incoming->descriptor);
-	
-	mQ=incoming->qz;
-	mB=incoming->bitrate;
-	mS=incoming->finalsize;	
-	mMode=incoming->mode;
-
-	updateMode();	
-	
-	gtk_signal_connect(GTK_OBJECT(WID(optionmenuType)), "changed",
-                      GTK_SIGNAL_FUNC(cb_mod),                   (void *) 0);
-	
-
-	upload(dialog,conf);
-	
-	ret=0;
-	if(gtk_dialog_run(GTK_DIALOG(dialog))==GTK_RESPONSE_OK)
-	{
-		int r=-1,value=-1;
-		
-		ret=1;
-		download(dialog,conf);	
-		r=getRangeInMenu(WID(optionmenuType));				
-		switch(r)
-			{
-				case 0:
-					incoming->mode = COMPRESS_CBR;				      
-		      			value = (uint32_t) gtk_read_entry(WID(entryBitrate));
-			    		incoming->bitrate = value * 1000;
-					break;
-				case 1:
-					incoming->mode = COMPRESS_CQ;		      			
-					value = (uint32_t) gtk_spin_button_get_value_as_int(
-								GTK_SPIN_BUTTON(WID(spinbuttonQz)));
-			    		incoming->qz = value;
-		      			break;
-
-				case 2:
-		     			incoming->mode = COMPRESS_2PASS;	
-					value = (uint32_t)
-						gtk_read_entry(WID(entryBitrate));
-       					incoming->finalsize=value;	
-            				break;
-		  		default:
-		      			ADM_assert(0);
-				}
-		
-	}
-	gtk_unregister_dialog(dialog);
-	gtk_widget_destroy(dialog);
-
-	return ret;
-}	
-
-
-void upload(GtkWidget *dialog, Mpeg2encParam *conf)
-{
- 	gtk_option_menu_set_history (GTK_OPTION_MENU (WID(optionmenu2)),conf->user_matrix);
-// 	gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(spinbutton1)),(float)conf->gop_size) ;
-	SPIN_SET(spinbuttonGop,gop_size);
-	if(conf->interlaced)
-	{
-		if(conf->bff)
-			RADIO_SET(radiobutton3,1);
-		else
-			RADIO_SET(radiobutton2,1);			
-			
-	}
-	if(conf->widescreen)
-		RADIO_SET(radiobutton5,1);			
-	gtk_write_entry(WID(entryMax),(conf->maxBitrate*8)/1000);
-	
-}
-void download(GtkWidget *dialog, Mpeg2encParam *conf)
-{
-	SPIN_GET(spinbuttonGop,gop_size);
-	conf->user_matrix=getRangeInMenu(WID(optionmenu2));
-	
-	
-	if(RADIO_GET(radiobutton1))
-		{
-			conf->interlaced=0;
-			conf->bff=0;
-		}
-	else if(RADIO_GET(radiobutton2))
-		{
-			conf->interlaced=1;
-			conf->bff=0;
-		}
-	else if(RADIO_GET(radiobutton3))
-		{
-			conf->interlaced=1;
-			conf->bff=1;
-		}
-	if(RADIO_GET(radiobutton5))
-	{
-		conf->widescreen=1;
-	}
-	else	conf->widescreen=0;
- 	
-	conf->maxBitrate=(gtk_read_entry(WID(entryMax))/8)*1000;
-}
-
-int cb_mod(GtkObject * object, gpointer user_data)
-{
-int r;
-	r=getRangeInMenu(WID(optionmenuType));
-	switch(r)
-	{
-		case 0: mMode=COMPRESS_CBR ;break;
-		case 1: mMode=COMPRESS_CQ ;break;
-		case 2: mMode=COMPRESS_2PASS ;break;
-	
-	}
-	updateMode();
-
-}
-
-/**
-
-*/	 
-void updateMode( void )
-{
-uint32_t b;
-		// set the right select button
- 	switch (mMode)
-	    {
-	    	case COMPRESS_CBR:
-			HIST_SET(0);			
-			b=mB/1000;
-			VAL_SET(b);
-			gtk_widget_set_sensitive(WID(spinbuttonQz),0);
-			gtk_widget_set_sensitive(WID(entryBitrate),1);
-			gtk_label_set_text(GTK_LABEL(WID(labelBitrate)),"Bitrate (kb/s):");
-			break;
-
-		case COMPRESS_2PASS:
-			HIST_SET(2);
-			VAL_SET(mS);
-			gtk_widget_set_sensitive(WID(spinbuttonQz),0);
-			gtk_widget_set_sensitive(WID(entryBitrate),1);
-			gtk_label_set_text(GTK_LABEL(WID(labelBitrate)),"Size (MBytes):");
-			break;
-
-	    	case COMPRESS_CQ:
-			HIST_SET(1);
-			gtk_widget_set_sensitive(WID(entryBitrate),0);
-			gtk_widget_set_sensitive(WID(spinbuttonQz),1);
-			gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(spinbuttonQz)),(gfloat)mQ);
-			break;
-		}
-}
-
-
-GtkWidget*
-create_dialog1 (void)
-{
-  GtkWidget *dialog1;
-  GtkWidget *dialog_vbox1;
-  GtkWidget *vbox1;
-  GtkWidget *frame1;
-  GtkWidget *vbox2;
-  GtkWidget *hbox1;
-  GtkWidget *label2;
-  GtkWidget *optionmenuType;
-  GtkWidget *menu1;
-  GtkWidget *single_pass___constant_quantizer1;
-  GtkWidget *single_pass___constant_bitrate1;
-  GtkWidget *two_pass1;
-  GtkWidget *hbox2;
-  GtkWidget *labelBitrate;
-  GtkWidget *entryBitrate;
-  GtkWidget *hbox3;
-  GtkWidget *label4;
-  GtkObject *spinbuttonQz_adj;
-  GtkWidget *spinbuttonQz;
-  GtkWidget *label1;
-  GtkWidget *frame2;
-  GtkWidget *hbox4;
-  GtkWidget *radiobutton1;
-  GSList *radiobutton1_group = NULL;
-  GtkWidget *radiobutton2;
-  GtkWidget *radiobutton3;
-  GtkWidget *label5;
-  GtkWidget *hbox5;
-  GtkWidget *frame3;
-  GtkWidget *hbox6;
-  GtkWidget *radiobutton4;
-  GSList *radiobutton4_group = NULL;
-  GtkWidget *radiobutton5;
-  GtkWidget *label6;
-  GtkWidget *frame4;
-  GtkWidget *optionmenu2;
-  GtkWidget *menu2;
-  GtkWidget *default1;
-  GtkWidget *tmpgenc1;
-  GtkWidget *anime1;
-  GtkWidget *kvcd1;
-  GtkWidget *label7;
-  GtkWidget *hbox7;
-  GtkWidget *label8;
-  GtkObject *spinbuttonGop_adj;
-  GtkWidget *spinbuttonGop;
-  GtkWidget *hbox8;
-  GtkWidget *label9;
-  GtkWidget *entryMax;
-  GtkWidget *dialog_action_area1;
-  GtkWidget *cancelbutton1;
-  GtkWidget *okbutton1;
-
-  dialog1 = gtk_dialog_new ();
-  gtk_window_set_title (GTK_WINDOW (dialog1), _("DVD Parameters"));
-
-  dialog_vbox1 = GTK_DIALOG (dialog1)->vbox;
-  gtk_widget_show (dialog_vbox1);
-
-  vbox1 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox1);
-  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
-
-  frame1 = gtk_frame_new (NULL);
-  gtk_widget_show (frame1);
-  gtk_box_pack_start (GTK_BOX (vbox1), frame1, TRUE, TRUE, 0);
-
-  vbox2 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox2);
-  gtk_container_add (GTK_CONTAINER (frame1), vbox2);
-
-  hbox1 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox1);
-  gtk_box_pack_start (GTK_BOX (vbox2), hbox1, TRUE, TRUE, 0);
-
-  label2 = gtk_label_new (_("Encoding Type:"));
-  gtk_widget_show (label2);
-  gtk_box_pack_start (GTK_BOX (hbox1), label2, FALSE, FALSE, 0);
-  gtk_widget_set_size_request (label2, 100, -1);
-
-  optionmenuType = gtk_option_menu_new ();
-  gtk_widget_show (optionmenuType);
-  gtk_box_pack_start (GTK_BOX (hbox1), optionmenuType, FALSE, FALSE, 0);
-
-  menu1 = gtk_menu_new ();
-
-  single_pass___constant_quantizer1 = gtk_menu_item_new_with_mnemonic (_("Single pass:Bitrate"));
-  gtk_widget_show (single_pass___constant_quantizer1);
-  gtk_container_add (GTK_CONTAINER (menu1), single_pass___constant_quantizer1);
-
-  single_pass___constant_bitrate1 = gtk_menu_item_new_with_mnemonic (_("Single pass:Quantizer"));
-  gtk_widget_show (single_pass___constant_bitrate1);
-  gtk_container_add (GTK_CONTAINER (menu1), single_pass___constant_bitrate1);
-
-  two_pass1 = gtk_menu_item_new_with_mnemonic (_("Two pass"));
-  gtk_widget_show (two_pass1);
-  gtk_container_add (GTK_CONTAINER (menu1), two_pass1);
-
-  gtk_option_menu_set_menu (GTK_OPTION_MENU (optionmenuType), menu1);
-
-  hbox2 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox2);
-  gtk_box_pack_start (GTK_BOX (vbox2), hbox2, TRUE, TRUE, 0);
-
-  labelBitrate = gtk_label_new (_("Bitrate (kb/s)"));
-  gtk_widget_show (labelBitrate);
-  gtk_box_pack_start (GTK_BOX (hbox2), labelBitrate, FALSE, FALSE, 0);
-  gtk_widget_set_size_request (labelBitrate, 100, -1);
-
-  entryBitrate = gtk_entry_new ();
-  gtk_widget_show (entryBitrate);
-  gtk_box_pack_start (GTK_BOX (hbox2), entryBitrate, FALSE, TRUE, 0);
-  gtk_widget_set_size_request (entryBitrate, 100, -1);
-
-  hbox3 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox3);
-  gtk_box_pack_start (GTK_BOX (vbox2), hbox3, TRUE, TRUE, 0);
-
-  label4 = gtk_label_new (_("Quantizer:"));
-  gtk_widget_show (label4);
-  gtk_box_pack_start (GTK_BOX (hbox3), label4, FALSE, TRUE, 0);
-  gtk_widget_set_size_request (label4, 100, -1);
-
-  spinbuttonQz_adj = gtk_adjustment_new (4, 2, 31, 1, 10, 10);
-  spinbuttonQz = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonQz_adj), 1, 0);
-  gtk_widget_show (spinbuttonQz);
-  gtk_box_pack_start (GTK_BOX (hbox3), spinbuttonQz, FALSE, TRUE, 0);
-  gtk_widget_set_size_request (spinbuttonQz, 100, -1);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbuttonQz), TRUE);
-
-  label1 = gtk_label_new (_("Encoding mode"));
-  gtk_widget_show (label1);
-  gtk_frame_set_label_widget (GTK_FRAME (frame1), label1);
-
-  frame2 = gtk_frame_new (NULL);
-  gtk_widget_show (frame2);
-  gtk_box_pack_start (GTK_BOX (vbox1), frame2, TRUE, TRUE, 0);
-
-  hbox4 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox4);
-  gtk_container_add (GTK_CONTAINER (frame2), hbox4);
-
-  radiobutton1 = gtk_radio_button_new_with_mnemonic (NULL, _("Progressive"));
-  gtk_widget_show (radiobutton1);
-  gtk_box_pack_start (GTK_BOX (hbox4), radiobutton1, FALSE, FALSE, 0);
-  gtk_radio_button_set_group (GTK_RADIO_BUTTON (radiobutton1), radiobutton1_group);
-  radiobutton1_group = gtk_radio_button_get_group (GTK_RADIO_BUTTON (radiobutton1));
-
-  radiobutton2 = gtk_radio_button_new_with_mnemonic (NULL, _("Interlaced TFF"));
-  gtk_widget_show (radiobutton2);
-  gtk_box_pack_start (GTK_BOX (hbox4), radiobutton2, FALSE, FALSE, 0);
-  gtk_radio_button_set_group (GTK_RADIO_BUTTON (radiobutton2), radiobutton1_group);
-  radiobutton1_group = gtk_radio_button_get_group (GTK_RADIO_BUTTON (radiobutton2));
-
-  radiobutton3 = gtk_radio_button_new_with_mnemonic (NULL, _("Interlaced BFF"));
-  gtk_widget_show (radiobutton3);
-  gtk_box_pack_start (GTK_BOX (hbox4), radiobutton3, FALSE, FALSE, 0);
-  gtk_radio_button_set_group (GTK_RADIO_BUTTON (radiobutton3), radiobutton1_group);
-  radiobutton1_group = gtk_radio_button_get_group (GTK_RADIO_BUTTON (radiobutton3));
-
-  label5 = gtk_label_new (_("Interlacing"));
-  gtk_widget_show (label5);
-  gtk_frame_set_label_widget (GTK_FRAME (frame2), label5);
-
-  hbox5 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox5);
-  gtk_box_pack_start (GTK_BOX (vbox1), hbox5, TRUE, TRUE, 0);
-
-  frame3 = gtk_frame_new (NULL);
-  gtk_widget_show (frame3);
-  gtk_box_pack_start (GTK_BOX (hbox5), frame3, FALSE, TRUE, 0);
-
-  hbox6 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox6);
-  gtk_container_add (GTK_CONTAINER (frame3), hbox6);
-
-  radiobutton4 = gtk_radio_button_new_with_mnemonic (NULL, _("4:3"));
-  gtk_widget_show (radiobutton4);
-  gtk_box_pack_start (GTK_BOX (hbox6), radiobutton4, FALSE, FALSE, 0);
-  gtk_radio_button_set_group (GTK_RADIO_BUTTON (radiobutton4), radiobutton4_group);
-  radiobutton4_group = gtk_radio_button_get_group (GTK_RADIO_BUTTON (radiobutton4));
-
-  radiobutton5 = gtk_radio_button_new_with_mnemonic (NULL, _("16:9"));
-  gtk_widget_show (radiobutton5);
-  gtk_box_pack_start (GTK_BOX (hbox6), radiobutton5, FALSE, FALSE, 0);
-  gtk_radio_button_set_group (GTK_RADIO_BUTTON (radiobutton5), radiobutton4_group);
-  radiobutton4_group = gtk_radio_button_get_group (GTK_RADIO_BUTTON (radiobutton5));
-
-  label6 = gtk_label_new (_("Aspect Ratio"));
-  gtk_widget_show (label6);
-  gtk_frame_set_label_widget (GTK_FRAME (frame3), label6);
-
-  frame4 = gtk_frame_new (NULL);
-  gtk_widget_show (frame4);
-  gtk_box_pack_start (GTK_BOX (hbox5), frame4, TRUE, TRUE, 0);
-
-  optionmenu2 = gtk_option_menu_new ();
-  gtk_widget_show (optionmenu2);
-  gtk_container_add (GTK_CONTAINER (frame4), optionmenu2);
-
-  menu2 = gtk_menu_new ();
-
-  default1 = gtk_menu_item_new_with_mnemonic (_("Default"));
-  gtk_widget_show (default1);
-  gtk_container_add (GTK_CONTAINER (menu2), default1);
-
-  tmpgenc1 = gtk_menu_item_new_with_mnemonic (_("Tmpgenc"));
-  gtk_widget_show (tmpgenc1);
-  gtk_container_add (GTK_CONTAINER (menu2), tmpgenc1);
-
-  anime1 = gtk_menu_item_new_with_mnemonic (_("Anime"));
-  gtk_widget_show (anime1);
-  gtk_container_add (GTK_CONTAINER (menu2), anime1);
-
-  kvcd1 = gtk_menu_item_new_with_mnemonic (_("KVCD"));
-  gtk_widget_show (kvcd1);
-  gtk_container_add (GTK_CONTAINER (menu2), kvcd1);
-
-  gtk_option_menu_set_menu (GTK_OPTION_MENU (optionmenu2), menu2);
-
-  label7 = gtk_label_new (_("Matrix"));
-  gtk_widget_show (label7);
-  gtk_frame_set_label_widget (GTK_FRAME (frame4), label7);
-
-  hbox7 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox7);
-  gtk_box_pack_start (GTK_BOX (vbox1), hbox7, TRUE, TRUE, 0);
-
-  label8 = gtk_label_new (_("Gop Size:"));
-  gtk_widget_show (label8);
-  gtk_box_pack_start (GTK_BOX (hbox7), label8, FALSE, FALSE, 0);
-  gtk_widget_set_size_request (label8, 100, -1);
-
-  spinbuttonGop_adj = gtk_adjustment_new (1, 1, 25, 1, 10, 10);
-  spinbuttonGop = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonGop_adj), 1, 0);
-  gtk_widget_show (spinbuttonGop);
-  gtk_box_pack_start (GTK_BOX (hbox7), spinbuttonGop, FALSE, FALSE, 0);
-  gtk_widget_set_size_request (spinbuttonGop, 100, -1);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbuttonGop), TRUE);
-
-  hbox8 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox8);
-  gtk_box_pack_start (GTK_BOX (vbox1), hbox8, TRUE, TRUE, 0);
-
-  label9 = gtk_label_new (_("Max Bitrate:"));
-  gtk_widget_show (label9);
-  gtk_box_pack_start (GTK_BOX (hbox8), label9, FALSE, FALSE, 0);
-  gtk_widget_set_size_request (label9, 100, -1);
-
-  entryMax = gtk_entry_new ();
-  gtk_widget_show (entryMax);
-  gtk_box_pack_start (GTK_BOX (hbox8), entryMax, FALSE, TRUE, 0);
-  gtk_widget_set_size_request (entryMax, 100, -1);
-
-  dialog_action_area1 = GTK_DIALOG (dialog1)->action_area;
-  gtk_widget_show (dialog_action_area1);
-  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
-
-  cancelbutton1 = gtk_button_new_from_stock ("gtk-cancel");
-  gtk_widget_show (cancelbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
-  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
-
-  okbutton1 = gtk_button_new_from_stock ("gtk-ok");
-  gtk_widget_show (okbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
-  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
-
-  /* Store pointers to all widgets, for use by lookup_widget(). */
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, "dialog1");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, "dialog_vbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, vbox1, "vbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, frame1, "frame1");
-  GLADE_HOOKUP_OBJECT (dialog1, vbox2, "vbox2");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox1, "hbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, label2, "label2");
-  GLADE_HOOKUP_OBJECT (dialog1, optionmenuType, "optionmenuType");
-  GLADE_HOOKUP_OBJECT (dialog1, menu1, "menu1");
-  GLADE_HOOKUP_OBJECT (dialog1, single_pass___constant_quantizer1, "single_pass___constant_quantizer1");
-  GLADE_HOOKUP_OBJECT (dialog1, single_pass___constant_bitrate1, "single_pass___constant_bitrate1");
-  GLADE_HOOKUP_OBJECT (dialog1, two_pass1, "two_pass1");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox2, "hbox2");
-  GLADE_HOOKUP_OBJECT (dialog1, labelBitrate, "labelBitrate");
-  GLADE_HOOKUP_OBJECT (dialog1, entryBitrate, "entryBitrate");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox3, "hbox3");
-  GLADE_HOOKUP_OBJECT (dialog1, label4, "label4");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonQz, "spinbuttonQz");
-  GLADE_HOOKUP_OBJECT (dialog1, label1, "label1");
-  GLADE_HOOKUP_OBJECT (dialog1, frame2, "frame2");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox4, "hbox4");
-  GLADE_HOOKUP_OBJECT (dialog1, radiobutton1, "radiobutton1");
-  GLADE_HOOKUP_OBJECT (dialog1, radiobutton2, "radiobutton2");
-  GLADE_HOOKUP_OBJECT (dialog1, radiobutton3, "radiobutton3");
-  GLADE_HOOKUP_OBJECT (dialog1, label5, "label5");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox5, "hbox5");
-  GLADE_HOOKUP_OBJECT (dialog1, frame3, "frame3");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox6, "hbox6");
-  GLADE_HOOKUP_OBJECT (dialog1, radiobutton4, "radiobutton4");
-  GLADE_HOOKUP_OBJECT (dialog1, radiobutton5, "radiobutton5");
-  GLADE_HOOKUP_OBJECT (dialog1, label6, "label6");
-  GLADE_HOOKUP_OBJECT (dialog1, frame4, "frame4");
-  GLADE_HOOKUP_OBJECT (dialog1, optionmenu2, "optionmenu2");
-  GLADE_HOOKUP_OBJECT (dialog1, menu2, "menu2");
-  GLADE_HOOKUP_OBJECT (dialog1, default1, "default1");
-  GLADE_HOOKUP_OBJECT (dialog1, tmpgenc1, "tmpgenc1");
-  GLADE_HOOKUP_OBJECT (dialog1, anime1, "anime1");
-  GLADE_HOOKUP_OBJECT (dialog1, kvcd1, "kvcd1");
-  GLADE_HOOKUP_OBJECT (dialog1, label7, "label7");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox7, "hbox7");
-  GLADE_HOOKUP_OBJECT (dialog1, label8, "label8");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonGop, "spinbuttonGop");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox8, "hbox8");
-  GLADE_HOOKUP_OBJECT (dialog1, label9, "label9");
-  GLADE_HOOKUP_OBJECT (dialog1, entryMax, "entryMax");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, "dialog_action_area1");
-  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, "cancelbutton1");
-  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, "okbutton1");
-
-  return dialog1;
-}
-

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am	2007-02-15 07:27:35 UTC (rev 2823)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am	2007-02-15 08:00:13 UTC (rev 2824)
@@ -13,7 +13,7 @@
 	DIA_resize.cpp DIA_working.cpp \
 	DIA_working.h DIA_busy.cpp DIA_busy.h DIA_exLame.cpp DIA_pipe.cpp DIA_mpeg2opt.cpp \
 	DIA_xvcd.cpp DIA_muxer.cpp \
-	DIA_xvid.cpp DIA_crop.cpp DIA_color.cpp DIA_encoding.cpp DIA_SVCD.cpp DIA_prefs.cpp \
+	DIA_xvid.cpp DIA_crop.cpp DIA_color.cpp DIA_encoding.cpp  DIA_prefs.cpp \
 	DIA_requant.cpp DIA_xvid4.cpp DIA_lavcodec.cpp \
 	DIA_pause.cpp \
 	DIA_DVDff.cpp DIA_lavdecoder.cpp DIA_calculator.cpp DIA_equalizer.cpp \
@@ -41,7 +41,7 @@
 DIA_cnr2.cpp          DIA_mjpeg.cpp       \
 DIA_DVDff.cpp        DIA_color.cpp         DIA_eq2.cpp          \
 DIA_coloryuv.cpp      DIA_equalizer.cpp    DIA_mpdelogo.cpp    DIA_rotate.cpp \
-DIA_SVCD.cpp         DIA_contrast.cpp      DIA_exLame.cpp       DIA_mpeg2opt.cpp    DIA_srt.cpp \
+DIA_contrast.cpp      DIA_exLame.cpp       DIA_mpeg2opt.cpp    DIA_srt.cpp \
 DIA_about.cpp        DIA_tdeint.cpp \
 DIA_acodec.cpp       DIA_crop.cpp          DIA_gototime.cpp     DIA_muxer.cpp       DIA_v2v.cpp \
 DIA_animated.cpp     DIA_hue.cpp          DIA_ocr.cpp         DIA_vcodec.cpp \

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_SVCD.cpp (from rev 2818, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_SVCD.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_SVCD.cpp	2007-02-13 19:16:54 UTC (rev 2818)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_SVCD.cpp	2007-02-15 08:00:13 UTC (rev 2824)
@@ -0,0 +1,83 @@
+//
+//
+// C++ Implementation: DIA_SVCD
+//
+// Description: 
+//
+//
+// Author: mean <fixounet at free.fr>, (C) 2003
+//
+// Copyright: See COPYING file that comes with this distribution
+//
+//
+
+#include <config.h>
+//#include "ADM_lavcodec.h"
+
+
+#include <string.h>
+#include <stdio.h>
+
+# include <math.h>
+
+#include "default.h"
+
+#include "ADM_codecs/ADM_codec.h"
+#include "ADM_encoder/ADM_vidEncode.hxx"
+#include "ADM_assert.h" 
+#include "DIA_factory.h"
+#include "../../ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2enc.h"
+
+/**
+      \fn DIA_SVCDParam
+      \brief Dialog to set encoding options for SVCD/DVD mpeg2enc based
+*/
+uint8_t DIA_SVCDParam(COMPRES_PARAMS *incoming)
+{	
+
+Mpeg2encParam *conf=(Mpeg2encParam *)incoming->extraSettings;
+ADM_assert(incoming->extraSettingsLen==sizeof(Mpeg2encParam));
+
+diaMenuEntry wideM[]={
+  {0,_("4:3")},
+  {1,_("16:9")}};
+diaMenuEntry matrixM[]={
+  {0,_("Default")},
+  {1,_("Tmpgenc")},
+  {2,_("Anime")},
+  {3,_("KVCD")}
+};
+diaMenuEntry interM[]={
+  {0,_("Progressive")},
+  {1,_("Int. TFF")},
+  {2,_("Int. BFF")}
+};
+                      
+         diaElemBitrate bitrate(incoming,NULL);
+         diaElemMenu      widescreen(&(conf->widescreen),_("Aspect Ratio"),2,wideM);
+         diaElemMenu      matrix(&(conf->user_matrix),_("Matrices"),4,matrixM);
+         diaElemUInteger gop(&(conf->gop_size),_("Gop Size"),1,30);
+         diaElemUInteger maxb(&(conf->maxBitrate),_("Max Bitrate"),100,9000);
+
+uint32_t inter;
+          if(!conf->interlaced) inter=0;
+            else if(conf->bff) inter=2;
+                else inter=1;
+         diaElemMenu      interW(&inter,_("Interlacing"),3,interM);
+  
+      diaElem *elems[6]={&bitrate,&widescreen,&interW,&matrix,&gop,&maxb};
+    
+  if( diaFactoryRun("Mpeg2 Encoding",6,elems))
+  {
+    switch(inter)
+    {
+      case 0: conf->interlaced=0;conf->bff=0;break;
+      case 1: conf->interlaced=1;conf->bff=0;break;
+      case 2: conf->interlaced=1;conf->bff=1;break;
+      default: ADM_assert(0);
+    }
+    return 1;
+  }
+  return 0;
+}	
+// EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am	2007-02-15 07:27:35 UTC (rev 2823)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am	2007-02-15 08:00:13 UTC (rev 2824)
@@ -2,7 +2,7 @@
 libADM_CommonUI_a_METASOURCES = AUTO
 libADM_CommonUI_a_SOURCES = GUI_sdlRender.cpp  GUI_xvRender.cpp  \
 DIA_resizeWiz.cpp DIA_builtin.cpp DIA_postproc.cpp DIA_enter.cpp \
-DIA_audioconfig.cpp GUI_render.cpp
+DIA_audioconfig.cpp GUI_render.cpp DIA_SVCD.cpp
 
 
 INCLUDES = $(all_includes) $(GTK_CFLAGS) $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \



From mean at mail.berlios.de  Fri Feb 16 18:44:04 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Fri, 16 Feb 2007 18:44:04 +0100
Subject: [Avidemux-svn-commit] r2825 - in
	branches/avidemux_2.4_branch/avidemux: ADM_codecs ADM_encoder
	ADM_libraries/ADM_xvidratectl ADM_userInterfaces/ADM_GTK/ADM_dialog
	ADM_userInterfaces/ADM_commonUI
Message-ID: <200702161744.l1GHi4Xw014611@sheep.berlios.de>

Author: mean
Date: 2007-02-16 18:44:01 +0100 (Fri, 16 Feb 2007)
New Revision: 2825

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_DVDff.cpp
Removed:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_DVDff.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_codecs/ADM_ffmpeg.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_codecs/ADM_ffmpegConfig.h
   branches/avidemux_2.4_branch/avidemux/ADM_encoder/ADM_encCodecDesc.h
   branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encffmpeg1.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encmpeg2enc.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_ratecontrol.h
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_xvidratectlVBV.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am
Log:
cleanup part 2

Modified: branches/avidemux_2.4_branch/avidemux/ADM_codecs/ADM_ffmpeg.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2007-02-15 08:00:13 UTC (rev 2824)
+++ branches/avidemux_2.4_branch/avidemux/ADM_codecs/ADM_ffmpeg.cpp	2007-02-16 17:44:01 UTC (rev 2825)
@@ -237,7 +237,7 @@
 	  _context->sample_aspect_ratio.den = 3;
 	}
 
-      _context->rc_max_rate_header = _settings.maxBitrate * 8;	//1800*1000;// 2400 max, 700 min
+      _context->rc_max_rate_header = _settings.maxBitrate * 1000;//1800*1000;// 2400 max, 700 min
       _context->rc_buffer_size_header = _settings.bufferSize * 8 * 1024;
       // If we don't have a maxrate, don't set buffer_size
       if (1 && !_settings.override_ratecontrol)	// FIXME

Modified: branches/avidemux_2.4_branch/avidemux/ADM_codecs/ADM_ffmpegConfig.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_codecs/ADM_ffmpegConfig.h	2007-02-15 08:00:13 UTC (rev 2824)
+++ branches/avidemux_2.4_branch/avidemux/ADM_codecs/ADM_ffmpegConfig.h	2007-02-16 17:44:01 UTC (rev 2825)
@@ -44,15 +44,15 @@
   int is_dark_masking;		// -1--1
   float qcompress;		// 0.0--1.0
   float qblur;			// 0.0--1.0
-  int minBitrate;
-  int maxBitrate;
-  int user_matrix;		// 0 normal / 1 tmpgenc / 2 anime / 3 kvcd / 4 hr-tmpgenc
-  int gop_size;			// For mpeg1/2 , 12 is good
+  uint32_t minBitrate;          // In kBits/s
+  uint32_t maxBitrate;          // In kBits/s
+  uint32_t user_matrix;		// 0 normal / 1 tmpgenc / 2 anime / 3 kvcd / 4 hr-tmpgenc
+  uint32_t gop_size;			// For mpeg1/2 , 12 is good
   uint16_t *intra_matrix;
   uint16_t *inter_matrix;
-  uint8_t interlaced;
-  uint8_t bff;			// WLA: bottom field first flag
-  uint8_t widescreen;
+  uint32_t interlaced;
+  uint32_t bff;			// WLA: bottom field first flag
+  uint32_t widescreen;          //0 4/3  1 16/9
 
   // new stuff from jakub ui
   int mb_eval;			// Replace hq 0..2
@@ -66,10 +66,10 @@
   int _NORMALIZE_AQP;		// normalize adap quantiz
 
   //
-  int use_xvid_ratecontrol;
-  int bufferSize;		// in KBYTES !!!!
-  int override_ratecontrol;
-  int dummy;
+  uint32_t use_xvid_ratecontrol;
+  uint32_t bufferSize;		// in KBYTES !!!!
+  uint32_t override_ratecontrol;
+  uint32_t dummy;
 
 } FFcodecSetting;
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_encoder/ADM_encCodecDesc.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_encoder/ADM_encCodecDesc.h	2007-02-15 08:00:13 UTC (rev 2824)
+++ branches/avidemux_2.4_branch/avidemux/ADM_encoder/ADM_encCodecDesc.h	2007-02-16 17:44:01 UTC (rev 2825)
@@ -233,8 +233,8 @@
   1,
   0.5,				//         qcompress;  /* amount of qscale change between easy & hard scenes (0.0-1.0)*/
   0.5,				//         qblur;      /* amount of qscale smoothing over time (0.0-1.0) */
-  (600 * 1000 >> 3),		// min bitrate in kB/S
-  (2200 * 1000) >> 3,		// max bitrate
+  600 ,   		// min bitrate in kB/S
+  2200 ,		// max bitrate
   0,				// user_matrix 0->default, 1 tmpg, 2 anim?, 3 kvcd
   12,				// Safe gop size limit
   NULL,				// inter & intra matrix, will be set depending on user_matrix
@@ -294,7 +294,7 @@
   0.5,				//         qcompress;  /* amount of qscale change between easy & hard scenes (0.0-1.0)*/
   0.5,				//         qblur;      /* amount of qscale smoothing over time (0.0-1.0) */
   0,				// min bitrate in kB/S
-  (8000 * 1000) >> 3,		// max bitrate
+  8000 ,		// max bitrate
   0,				// user_matrix 0->default, 1 tmpg, 2 anim?, 3 kvcd
   12,				// Safe gop size limit
   NULL,				// inter & intra matrix, will be set depending on user_matrix
@@ -310,7 +310,7 @@
   0.5,				// spatial masking
   0,				// NAQ
   1,				// Use xvid ratecontrol
-  240,				// buffersize 240 KB for Mpeg2 /
+  224,				// buffersize 240 KB for Mpeg2 /
   0				// DUMMY        
 };
 
@@ -354,7 +354,7 @@
   0.5,				//         qcompress;  /* amount of qscale change between easy & hard scenes (0.0-1.0)*/
   0.5,				//         qblur;      /* amount of qscale smoothing over time (0.0-1.0) */
   0,				// min bitrate in kB/S
-  (2400 * 1000) >> 3,		// max bitrate
+  2400          ,		// max bitrate
   0,				// user_matrix 0->default, 1 tmpg, 2 anim?, 3 kvcd
   12,				// Safe gop size limit
   NULL,				// inter & intra matrix, will be set depending on user_matrix

Modified: branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encffmpeg1.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encffmpeg1.cpp	2007-02-15 08:00:13 UTC (rev 2824)
+++ branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encffmpeg1.cpp	2007-02-16 17:44:01 UTC (rev 2825)
@@ -392,7 +392,7 @@
     printf("[FFmpeg Mpeg1/2] 2pass avg bitrate %u kb/s\n",br/1000);
   }else ADM_assert(0);
  
-  printf("[FFmpeg Mpeg1/2] Max bitrate :%u\n", (_settings.maxBitrate*8)/1000);
+  printf("[FFmpeg Mpeg1/2] Max bitrate :%u\n", (_settings.maxBitrate));
   avg_bitrate = br;
   if(_param.mode==COMPRESS_2PASS)
       printf ("\n ** Total size     : %lu MBytes \n", _param.finalsize);
@@ -417,8 +417,8 @@
       _codec->setLogFile (_logname);
       //_codec->setLogFile("/tmp/dummylog.txt");
       if (_settings.maxBitrate)
-	if (avg_bitrate > _settings.maxBitrate)
-	  avg_bitrate = _settings.maxBitrate;
+	if (avg_bitrate > _settings.maxBitrate*1000)
+	  avg_bitrate = _settings.maxBitrate*1000;
       _codec->init (avg_bitrate, _fps);
       printf ("\n FF:ready to encode in 2pass (%s)\n", _logname);
       _frametogo = 0;
@@ -432,7 +432,7 @@
    
      f=_param.finalsize;
   // Checking against max bitrate
-    uint32_t maxb=_settings.maxBitrate*8;
+    uint32_t maxb=_settings.maxBitrate*1000;
 
     printf("[FFmpeg1/2] : %u kbps average, %u max\n",br/1000,maxb/1000);
     if(br>maxb)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encmpeg2enc.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encmpeg2enc.cpp	2007-02-15 08:00:13 UTC (rev 2824)
+++ branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encmpeg2enc.cpp	2007-02-16 17:44:01 UTC (rev 2825)
@@ -241,12 +241,12 @@
   {
     case COMPRESS_CQ:
           qz=_param.qz;
-          br=8*_settings.maxBitrate;
+          br=_settings.maxBitrate*1000;
           _state = enc_CQ;
       break;
     case COMPRESS_CBR:
           qz=0;
-          br=8*_param.bitrate;
+          br=_param.bitrate*1000;
           _state = enc_CBR;
           break;
     case COMPRESS_2PASS:
@@ -359,7 +359,7 @@
 
   if(_param.mode==COMPRESS_2PASS)
   {
-    br=8*ADM_computeBitrate( _fps1000,_totalframe,_param.finalsize);
+    br=ADM_computeBitrate( _fps1000,_totalframe,_param.finalsize);
     size=_param.finalsize;
     printf("[Mpeg2enc] Final Size: %u MB, avg bitrate %u kb/s \n",size,br/1000);
   }else if(_param.mode==COMPRESS_2PASS_BITRATE)
@@ -368,17 +368,17 @@
     br=_param.avg_bitrate;
     d=_totalframe;
     d/=_fps1000;
-    d*=_param.avg_bitrate*1000;
-    d/=(8*1024*1024);
+    d*=_param.avg_bitrate*1000*1000;
+    d/=(1024*1024);
     size=(uint32_t )d;
-    br*=8;
-    printf("[Mpeg2enc]  Final Size: %u MB 2pass avg bitrate %u kb/s\n",size,br/1000);
+
+    printf("[Mpeg2enc]  Final Size: %u MB 2pass avg bitrate %u kb/s\n",size,br);
     
   }else ADM_assert(0);
 
   uint32_t maxbr;
 
-  maxbr=_settings.maxBitrate*8; // B/s
+  maxbr=_settings.maxBitrate*1000; // B/s
 
   printf("[Mpeg2enc] Max bitrate %u kbps\n",maxbr/1000);
   /* Check Max bitrate */

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_ratecontrol.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_ratecontrol.h	2007-02-15 08:00:13 UTC (rev 2824)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_ratecontrol.h	2007-02-16 17:44:01 UTC (rev 2825)
@@ -53,72 +53,55 @@
 	virtual		uint8_t logPass2( uint32_t qz, ADM_rframe ftype,uint32_t size)FORBIDDEN;
 
 };
-#if 0
-class ADM_oldXvidRc : public ADM_ratecontrol
-{
-protected:
-public:
-			ADM_oldXvidRc(uint32_t fps1000, char *logname);
-	virtual 	~ADM_oldXvidRc() ;
-	/** Maxbr & minbr in kbps, vbvsize in kBytes); Default is none */
-	virtual 	uint8_t setVBVInfo(uint32_t maxbr,uint32_t minbr, uint32_t vbvsize);
-	virtual		uint8_t startPass1( void );
-	virtual		uint8_t logPass1(uint32_t qz, ADM_rframe ftype,uint32_t size);
-	virtual		uint8_t startPass2( uint32_t size,uint32_t nbFrame );
-	virtual		uint8_t getQz( uint32_t *qz, ADM_rframe *type );
-	virtual		uint8_t logPass2( uint32_t qz, ADM_rframe ftype,uint32_t size);
 
-};
-#endif
-
 class ADM_newXvidRc :public ADM_ratecontrol
 {
 protected:
-			uint32_t _totalFrame;
+                        uint32_t _totalFrame;
 public:
-			ADM_newXvidRc(uint32_t fps1000, char *logname);
-	virtual 	~ADM_newXvidRc() ;
-	/** Maxbr & minbr in kbps, vbvsize in kBytes); Default is none */
-	virtual 	uint8_t setVBVInfo(uint32_t maxbr,uint32_t minbr, uint32_t vbvsize);
-	virtual		uint8_t startPass1( void );
-	virtual		uint8_t logPass1(uint32_t qz, ADM_rframe ftype,uint32_t size);
-	virtual		uint8_t startPass2( uint32_t size,uint32_t nbFrame );
-	virtual		uint8_t getQz( uint32_t *qz, ADM_rframe *type );
-	virtual		uint8_t logPass2( uint32_t qz, ADM_rframe ftype,uint32_t size);
-			// Used for VBV
-			uint8_t getInfo(uint32_t framenum, uint32_t *qz, uint32_t *size,ADM_rframe *type );
+                        ADM_newXvidRc(uint32_t fps1000, char *logname);
+        virtual 	~ADM_newXvidRc() ;
+                        /** Maxbr & minbr in kbps, vbvsize in kBytes); Default is none */
+        virtual 	uint8_t setVBVInfo(uint32_t maxbr,uint32_t minbr, uint32_t vbvsize);
+        virtual		uint8_t startPass1( void );
+        virtual		uint8_t logPass1(uint32_t qz, ADM_rframe ftype,uint32_t size);
+        virtual		uint8_t startPass2( uint32_t size,uint32_t nbFrame );
+        virtual		uint8_t getQz( uint32_t *qz, ADM_rframe *type );
+        virtual		uint8_t logPass2( uint32_t qz, ADM_rframe ftype,uint32_t size);
+                        // Used for VBV
+                        uint8_t getInfo(uint32_t framenum, uint32_t *qz, uint32_t *size,ADM_rframe *type );
 
 };
 #define AVG_LOOKUP 5
 class ADM_newXvidRcVBV :public ADM_ratecontrol
 {
 protected:
-			ADM_newXvidRc	*rc;
-			uint32_t	_minbr,_maxbr,_vbvsize;
-			ADM_pass_stat  *_stat;
-			uint32_t	*_lastSize;
-			uint32_t	_roundup;
-			uint32_t	_frame;
-			uint32_t	_vbv_fullness;
-			uint32_t	_byte_per_image;
-			double		_compr[3][AVG_LOOKUP];  
-			uint32_t   _idxI,_idxP,_idxB;
+                        ADM_newXvidRc	*rc;
+                        uint32_t	_minbr,_maxbr,_vbvsize;
+                        ADM_pass_stat  *_stat;
+                        uint32_t	*_lastSize;
+                        uint32_t	_roundup;
+                        uint32_t	_frame;
+                        uint32_t	_vbv_fullness;
+                        uint32_t	_byte_per_image;
+                        double		_compr[3][AVG_LOOKUP];  
+                        uint32_t   _idxI,_idxP,_idxB;
+                        
+                        uint8_t 	project(uint32_t framenum, uint32_t q, ADM_rframe frame);
+                        uint8_t 	checkVBV(uint32_t framenum, uint32_t q, ADM_rframe frame);
+                        float 		getRatio(uint32_t newq, uint32_t oldq, float alpha);
+                        float 		getComp(int oldbits, int qporg, int newbits, int qpused);
 			
-			uint8_t 	project(uint32_t framenum, uint32_t q, ADM_rframe frame);
-			uint8_t 	checkVBV(uint32_t framenum, uint32_t q, ADM_rframe frame);
-			float 		getRatio(uint32_t newq, uint32_t oldq, float alpha);
-			float 		getComp(int oldbits, int qporg, int newbits, int qpused);
-			
 public:
-			ADM_newXvidRcVBV(uint32_t fps1000, char *logname);
-	virtual 	~ADM_newXvidRcVBV() ;
-	/** Maxbr & minbr in kbps, vbvsize in kBytes); Default is none */
-	virtual 	uint8_t setVBVInfo(uint32_t maxbr,uint32_t minbr, uint32_t vbvsize);
-	virtual		uint8_t startPass1( void );
-	virtual		uint8_t logPass1(uint32_t qz, ADM_rframe ftype,uint32_t size);
-	virtual		uint8_t startPass2( uint32_t size,uint32_t nbFrame );
-	virtual		uint8_t getQz( uint32_t *qz, ADM_rframe *type );
-	virtual		uint8_t logPass2( uint32_t qz, ADM_rframe ftype,uint32_t size);
+                        ADM_newXvidRcVBV(uint32_t fps1000, char *logname);
+        virtual 	~ADM_newXvidRcVBV() ;
+        /** Maxbr & minbr in kbps, vbvsize in kBytes); Default is none */
+        virtual 	uint8_t setVBVInfo(uint32_t maxbr,uint32_t minbr, uint32_t vbvsize);
+        virtual		uint8_t startPass1( void );
+        virtual		uint8_t logPass1(uint32_t qz, ADM_rframe ftype,uint32_t size);
+        virtual		uint8_t startPass2( uint32_t size,uint32_t nbFrame );
+        virtual		uint8_t getQz( uint32_t *qz, ADM_rframe *type );
+        virtual		uint8_t logPass2( uint32_t qz, ADM_rframe ftype,uint32_t size);
         static          uint8_t verifyLog(const char *file,uint32_t nbFrame);
 };
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_xvidratectlVBV.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_xvidratectlVBV.cpp	2007-02-15 08:00:13 UTC (rev 2824)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_xvidratectlVBV.cpp	2007-02-16 17:44:01 UTC (rev 2825)
@@ -32,7 +32,7 @@
 	rc=new ADM_newXvidRc(fps1000,logname);
 	_state=RS_IDLE; 
 	_minbr=0;
-	_maxbr=2*9*1000*1000/8; // ~ 9MB*2
+	_maxbr=2*9*1000*1000; // ~ 9MB*2
 	_vbvsize=5*224*1024;	// 1MB vbv buffer size
 	_stat=NULL;
 	_lastSize=NULL;
@@ -53,12 +53,12 @@
 }
 uint8_t ADM_newXvidRcVBV::setVBVInfo(uint32_t maxbr,uint32_t minbr, uint32_t vbvsize)
 {
-	_maxbr=maxbr;
-	_minbr=minbr;
+	_maxbr=maxbr*1000; // in b/s
+	_minbr=minbr*1000;
 	_vbvsize=vbvsize*1024;
 	printf("RC: Initializing vbv buffer \n");
-	printf("RC: with min br= %lu kbps\n",(minbr*8)/1000);
-	printf("RC:      max br= %lu kbps\n",(maxbr*8)/1000);
+	printf("RC: with min br= %lu kbps\n",(minbr)/1000);
+	printf("RC:      max br= %lu kbps\n",(maxbr)/1000);
 	printf("Rc:      VBV   = %lu kB\n",_vbvsize/1024);
 
 	return 1;
@@ -88,7 +88,7 @@
 	_roundup=(uint32_t )floor((_fps1000+500)/1000);
 	// Do so check
 	_vbv_fullness=(_vbvsize*8)/10; // Buffer starts 80% full
-	_byte_per_image=_maxbr/_roundup;
+	_byte_per_image=(_maxbr>>3)/_roundup;
 	_lastSize=new uint32_t[_roundup];
 	memset(_lastSize,0,_roundup*sizeof(uint32_t));
 	_frame=0;

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_DVDff.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_DVDff.cpp	2007-02-15 08:00:13 UTC (rev 2824)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_DVDff.cpp	2007-02-16 17:44:01 UTC (rev 2825)
@@ -1,741 +0,0 @@
-#include <config.h>
-
-#include <stdio.h>
-#include <stdlib.h>
-
-#include "ADM_lavcodec.h"
-
-#include "default.h"
-#include "ADM_toolkit_gtk/toolkit_gtk_include.h"
-#include "ADM_toolkit_gtk/ADM_gladeSupport.h"
-#include "ADM_toolkit_gtk/toolkit_gtk.h"
-
-
-#include "ADM_toolkit/toolkit.hxx"
-#include "ADM_encoder/ADM_vidEncode.hxx"
-
-
-#include "ADM_codecs/ADM_ffmpegConfig.h"
-#include "ADM_assert.h" 
-static GtkWidget	*create_dialog1 (void);
-
-				
-#define ENTRY_SET(x,y) {gtk_write_entry(WID(x),(int)conf->y);}
-#define ENTRY_GET(x,y) {localSettings.y=gtk_read_entry(WID(x));}
-
-
-#define HIST_SET(x) 	gtk_option_menu_set_history(GTK_OPTION_MENU(WID(optionmenu_mode)), x)
-#define VAL_SET(x) 	gtk_write_entry(WID(entry_bitrate), x)
-
-static GtkWidget 	*dialog=NULL;		      
-static uint32_t 	mQ,mB,mS,mA;
-static COMPRESSION_MODE mMode;
-static FFcodecSetting localSettings;
-
-static void 		updateMode( void );
-static int 		cb_mod(GtkObject * object, gpointer user_data);
-static void 		upload(GtkWidget *dialog, FFcodecSetting *conf);
-static void 		download(GtkWidget *dialog, FFcodecSetting *conf);
-
-typedef struct bufferSize
-{
-	int num;
-	int size;
-}bufferSize;
-
-bufferSize myBuffer[3]=
-{
-	{0,40},
-	{1,112},
-	{2,224}
-};
-//____________________________________________
-
-uint8_t DIA_DVDffParam(COMPRES_PARAMS *incoming)
-{
-	
-
-	int ret;
-	FFcodecSetting *conf=(FFcodecSetting *)incoming->extraSettings;
-	ADM_assert(incoming->extraSettingsLen==sizeof(FFcodecSetting));
-	
-	gint r,b;
-
-	dialog=create_dialog1();
-	gtk_register_dialog(dialog);
-	
-	mQ=incoming->qz;
-	mB=incoming->bitrate;
-	mS=incoming->finalsize;	
-	mA=incoming->avg_bitrate;	
-	mMode=incoming->mode;
-
-	memcpy(&localSettings,conf,sizeof(localSettings));
-	
-	updateMode();	
-	
-	gtk_signal_connect(GTK_OBJECT(WID(optionmenu_mode)), "changed",
-                      GTK_SIGNAL_FUNC(cb_mod),                   (void *) 0);
-	
-
-	upload(dialog,conf);
-	
-	ret=0;
-	if(gtk_dialog_run(GTK_DIALOG(dialog))==GTK_RESPONSE_OK)
-	{
-		int r=-1,value=-1;
-		
-		ret=1;
-		download(dialog,conf);	
-		r=getRangeInMenu(WID(optionmenu_mode));				
-		switch(r)
-			{
-				case 0:
-					incoming->mode = COMPRESS_CBR;				      
-		      			value = (uint32_t) gtk_read_entry(WID(entry_bitrate));
-					// validate against max/min bitrate
-					if( value > conf->maxBitrate * 8 / 1000 ){
-                                          GUI_Info_HIG(ADM_LOG_IMPORTANT,_("Bitrate out of range"),_("choosing maxBitrate instead"));
-						value = conf->maxBitrate * 8 / 1000;
-					}
-					if( value < conf->minBitrate * 8 / 1000 ){
-                                          GUI_Info_HIG(ADM_LOG_IMPORTANT,_("Bitrate out of range"),_("choosing minBitrate instead"));
-						value = conf->minBitrate * 8 / 1000;
-					}
-					// validate against some fixed values - min/maxBitrate may be also out of range
-		      			if (value > 16 && value < 9900)
-					{
-			    			incoming->bitrate = value;
-			    			ret = 1;
-		      			}
-					break;
-				case 1:
-					incoming->mode = COMPRESS_CQ;		      			
-					value = (uint32_t) gtk_spin_button_get_value_as_int(
-								GTK_SPIN_BUTTON(WID(spinbutton_quant)));
-		      			if (value >= 2 && value <= 32)
-					{
-			    			incoming->qz = value;
-		      			}
-		      			break;
-
-				case 2:
-		     			incoming->mode = COMPRESS_2PASS;	
-					value = (uint32_t)
-						gtk_read_entry(WID(entry_bitrate));
-        				if((value>0)&&(value<8200)) // enough for DL DVDs
-          				{
-       						incoming->finalsize=value;	
-           				}
-            				break;
-                                case 3:
-                                    incoming->mode = COMPRESS_2PASS_BITRATE;	
-                                    value = (uint32_t)gtk_read_entry(WID(entry_bitrate));
-                                    incoming->avg_bitrate=value;	
-                                    break;
-		  		default:
-		      			ADM_assert(0);
-				}
-		
-	}
-	gtk_unregister_dialog(dialog);
-	gtk_widget_destroy(dialog);
-
-	return ret;
-}	
-
-
-void upload(GtkWidget *dialog, FFcodecSetting *conf)
-{
- 	gtk_option_menu_set_history (GTK_OPTION_MENU (WID(optionmenu_matrix)),conf->user_matrix);
-// 	gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(spinbutton1)),(float)conf->gop_size) ;
-	ENTRY_SET(entry_gopsize,gop_size);
-	
-	if(conf->interlaced)
-	{
-		if(conf->bff)
-			RADIO_SET(radiobutton_bff,1);
-		else
-			RADIO_SET(radiobutton_tff,1);			
-			
-	}
-	if(conf->widescreen)
-		RADIO_SET(radiobutton_ar169,1);			
-	gtk_write_entry(WID(entry_maxbitrate),(conf->maxBitrate*8)/1000);
-	gtk_write_entry(WID(entry_minbitrate),(conf->minBitrate*8)/1000);
-	gtk_toggle_button_set_active( GTK_TOGGLE_BUTTON(WID(checkbutton_xvid)),conf->use_xvid_ratecontrol);
-	// Search closer 
-	int h;
-	int vbv=conf->bufferSize;
-	
-	printf("incoming vbv:%d\n",vbv);
-	if(vbv>(myBuffer[2].size+myBuffer[1].size)/2) h=2;
-	else
-		if(vbv>(myBuffer[1].size+myBuffer[0].size)/2) h=1;
-		else
-			h=0;
-	gtk_option_menu_set_history(GTK_OPTION_MENU(WID(optionmenu1)),h);
-	
-}
-void download(GtkWidget *dialog, FFcodecSetting *conf)
-{
-	ENTRY_GET(entry_gopsize,gop_size);
-	conf->user_matrix=getRangeInMenu(WID(optionmenu_matrix));
-	
-	
-	
-	if(RADIO_GET(radiobutton_progr))
-	{
-		conf->interlaced=0;
-		conf->bff=0;
-	}
-	else if(RADIO_GET(radiobutton_tff))
-	{
-		conf->interlaced=1;
-		conf->bff=0;
-	}
-	else if(RADIO_GET(radiobutton_bff))
-	{
-		conf->interlaced=1;
-		conf->bff=1;
-	}
-
-	if(RADIO_GET(radiobutton_ar169))
-	{
-		conf->widescreen=1;
-	}
-	else	conf->widescreen=0;
- 	
-	conf->maxBitrate=(gtk_read_entry(WID(entry_maxbitrate))/8)*1000;
-	conf->minBitrate=(gtk_read_entry(WID(entry_minbitrate))/8)*1000;
-	conf->gop_size=(gtk_read_entry(WID(entry_gopsize)));
-	conf->use_xvid_ratecontrol=gtk_toggle_button_get_active( GTK_TOGGLE_BUTTON(WID(checkbutton_xvid)));
-	
-	conf->bufferSize=myBuffer[getRangeInMenu((WID(optionmenu1)))].size;
-}
-
-int cb_mod(GtkObject * object, gpointer user_data)
-{
-int r;
-	r=getRangeInMenu(WID(optionmenu_mode));
-	switch(r)
-	{
-		case 0: mMode=COMPRESS_CBR ;break;
-		case 1: mMode=COMPRESS_CQ ;break;
-		case 2: mMode=COMPRESS_2PASS ;break;
-                case 3: mMode=COMPRESS_2PASS_BITRATE ;break;
-	
-	}
-	updateMode();
-
-}
-
-/**
-
-*/	 
-void updateMode( void )
-{
-uint32_t b;
-		// set the right select button
- 	switch (mMode)
-	    {
-	    	case COMPRESS_CBR:
-			HIST_SET(0);			
-			b=mB;
-			VAL_SET(b);
-			gtk_widget_set_sensitive(WID(spinbutton_quant),0);
-			gtk_widget_set_sensitive(WID(entry_bitrate),1);
-			gtk_label_set_text(GTK_LABEL(WID(label3)),"Bitrate (kb/s):");
-			break;
-
-		case COMPRESS_2PASS:
-			HIST_SET(2);
-			VAL_SET(mS);
-			gtk_widget_set_sensitive(WID(spinbutton_quant),0);
-			gtk_widget_set_sensitive(WID(entry_bitrate),1);
-			gtk_label_set_text(GTK_LABEL(WID(label3)),"Size (MBytes):");
-			break;
-		case COMPRESS_2PASS_BITRATE:
-			HIST_SET(3);
-			VAL_SET(mA);
-			gtk_widget_set_sensitive(WID(spinbutton_quant),0);
-			gtk_widget_set_sensitive(WID(entry_bitrate),1);
-			gtk_label_set_text(GTK_LABEL(WID(label3)),"Average bitrate (kb/s):");
-			break;
-
-	    	case COMPRESS_CQ:
-			HIST_SET(1);
-			gtk_widget_set_sensitive(WID(entry_bitrate),0);
-			gtk_widget_set_sensitive(WID(spinbutton_quant),1);
-			gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(spinbutton_quant)),(gfloat)mQ);
-			break;
-		}
-}
-
-//
-
-GtkWidget*
-create_dialog1 (void)
-{
-  GtkWidget *dialog1;
-  GtkWidget *dialog_vbox1;
-  GtkWidget *vbox1;
-  GtkWidget *frame1;
-  GtkWidget *table1;
-  GtkWidget *label2;
-  GtkWidget *label3;
-  GtkWidget *label4;
-  GtkWidget *optionmenu_mode;
-  GtkWidget *menu1;
-  GtkWidget *single_pass___bitrate1;
-  GtkWidget *single_pass___quantizer1;
-  GtkWidget *two_pass__1;
-  GtkWidget *two_pass__2;
-  GtkWidget *entry_bitrate;
-  GtkObject *spinbutton_quant_adj;
-  GtkWidget *spinbutton_quant;
-  GtkWidget *label1;
-  GtkWidget *frame2;
-  GtkWidget *table2;
-  GtkWidget *label6;
-  GtkWidget *label7;
-  GtkWidget *entry_minbitrate;
-  GtkWidget *entry_maxbitrate;
-  GtkWidget *label8;
-  GtkWidget *checkbutton_xvid;
-  GtkWidget *label14;
-  GtkWidget *optionmenu1;
-  GtkWidget *menu3;
-  GtkWidget *vcd;
-  GtkWidget *svcd;
-  GtkWidget *dvd;
-  GtkWidget *label5;
-  GtkWidget *frame6;
-  GtkWidget *hbox5;
-  GtkWidget *radiobutton_progr;
-  GSList *radiobutton_progr_group = NULL;
-  GtkWidget *radiobutton_tff;
-  GtkWidget *radiobutton_bff;
-  GtkWidget *label15;
-  GtkWidget *hbox1;
-  GtkWidget *frame3;
-  GtkWidget *hbox2;
-  GtkWidget *radiobutton_ar43;
-  GSList *radiobutton_ar43_group = NULL;
-  GtkWidget *radiobutton_ar169;
-  GtkWidget *label9;
-  GtkWidget *frame4;
-  GtkWidget *optionmenu_matrix;
-  GtkWidget *menu2;
-  GtkWidget *default1;
-  GtkWidget *tmpgenc1;
-  GtkWidget *anime1;
-  GtkWidget *kvcd1;
-  GtkWidget *hrtmpgenc1;
-  GtkWidget *label10;
-  GtkWidget *hbox3;
-  GtkWidget *label11;
-  GtkWidget *entry_gopsize;
-  GtkWidget *frame5;
-  GtkWidget *hbox4;
-  GtkWidget *label13;
-  GtkWidget *label_audiosize;
-  GtkWidget *label12;
-  GtkWidget *dialog_action_area1;
-  GtkWidget *cancelbutton1;
-  GtkWidget *okbutton1;
-
-  dialog1 = gtk_dialog_new ();
-  gtk_window_set_title (GTK_WINDOW (dialog1), _("DVD FFmpeg codec settings"));
-
-  dialog_vbox1 = GTK_DIALOG (dialog1)->vbox;
-  gtk_widget_show (dialog_vbox1);
-
-  vbox1 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox1);
-  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
-
-  frame1 = gtk_frame_new (NULL);
-  gtk_widget_show (frame1);
-  gtk_box_pack_start (GTK_BOX (vbox1), frame1, TRUE, TRUE, 0);
-
-  table1 = gtk_table_new (3, 2, FALSE);
-  gtk_widget_show (table1);
-  gtk_container_add (GTK_CONTAINER (frame1), table1);
-
-  label2 = gtk_label_new (_("Encoding Type"));
-  gtk_widget_show (label2);
-  gtk_table_attach (GTK_TABLE (table1), label2, 0, 1, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (label2), GTK_JUSTIFY_LEFT);
-  gtk_misc_set_alignment (GTK_MISC (label2), 0, 0.5);
-
-  label3 = gtk_label_new (_("Target Bitrate (kb/s)   "));
-  gtk_widget_show (label3);
-  gtk_table_attach (GTK_TABLE (table1), label3, 0, 1, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (label3), GTK_JUSTIFY_LEFT);
-  gtk_misc_set_alignment (GTK_MISC (label3), 0, 0.5);
-
-  label4 = gtk_label_new (_("Quantizer"));
-  gtk_widget_show (label4);
-  gtk_table_attach (GTK_TABLE (table1), label4, 0, 1, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (label4), GTK_JUSTIFY_LEFT);
-  gtk_misc_set_alignment (GTK_MISC (label4), 0, 0.5);
-
-  optionmenu_mode = gtk_option_menu_new ();
-  gtk_widget_show (optionmenu_mode);
-  gtk_table_attach (GTK_TABLE (table1), optionmenu_mode, 1, 2, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  menu1 = gtk_menu_new ();
-
-  single_pass___bitrate1 = gtk_menu_item_new_with_mnemonic (_("Single Pass - Bitrate"));
-  gtk_widget_show (single_pass___bitrate1);
-  gtk_container_add (GTK_CONTAINER (menu1), single_pass___bitrate1);
-
-  single_pass___quantizer1 = gtk_menu_item_new_with_mnemonic (_("Single Pass - Quantizer"));
-  gtk_widget_show (single_pass___quantizer1);
-  gtk_container_add (GTK_CONTAINER (menu1), single_pass___quantizer1);
-
-  two_pass__1 = gtk_menu_item_new_with_mnemonic (_("Two Pass (filesize) "));
-  gtk_widget_show (two_pass__1);
-  gtk_container_add (GTK_CONTAINER (menu1), two_pass__1);
-
-  two_pass__2 = gtk_menu_item_new_with_mnemonic (_("Two Pass (bitrate) "));
-  gtk_widget_show (two_pass__2);
-  gtk_container_add (GTK_CONTAINER (menu1), two_pass__2);
-
-
-  gtk_option_menu_set_menu (GTK_OPTION_MENU (optionmenu_mode), menu1);
-
-  entry_bitrate = gtk_entry_new ();
-  gtk_widget_show (entry_bitrate);
-  gtk_table_attach (GTK_TABLE (table1), entry_bitrate, 1, 2, 1, 2,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  spinbutton_quant_adj = gtk_adjustment_new (2, 2, 32, 1, 10, 10);
-  spinbutton_quant = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton_quant_adj), 1, 0);
-  gtk_widget_show (spinbutton_quant);
-  gtk_table_attach (GTK_TABLE (table1), spinbutton_quant, 1, 2, 2, 3,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton_quant), TRUE);
-
-  label1 = gtk_label_new (_("<b>Encoding mode </b>"));
-  gtk_widget_show (label1);
-  gtk_frame_set_label_widget (GTK_FRAME (frame1), label1);
-  gtk_label_set_use_markup (GTK_LABEL (label1), TRUE);
-  gtk_label_set_justify (GTK_LABEL (label1), GTK_JUSTIFY_LEFT);
-
-  frame2 = gtk_frame_new (NULL);
-  gtk_widget_show (frame2);
-  gtk_box_pack_start (GTK_BOX (vbox1), frame2, TRUE, TRUE, 0);
-
-  table2 = gtk_table_new (4, 2, FALSE);
-  gtk_widget_show (table2);
-  gtk_container_add (GTK_CONTAINER (frame2), table2);
-
-  label6 = gtk_label_new (_("Minimum Bitrate (kb/s) "));
-  gtk_widget_show (label6);
-  gtk_table_attach (GTK_TABLE (table2), label6, 0, 1, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (label6), GTK_JUSTIFY_LEFT);
-  gtk_misc_set_alignment (GTK_MISC (label6), 0, 0.5);
-
-  label7 = gtk_label_new (_("Maximum Bitrate (kb/s)"));
-  gtk_widget_show (label7);
-  gtk_table_attach (GTK_TABLE (table2), label7, 0, 1, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (label7), GTK_JUSTIFY_LEFT);
-  gtk_misc_set_alignment (GTK_MISC (label7), 0, 0.5);
-
-  entry_minbitrate = gtk_entry_new ();
-  gtk_widget_show (entry_minbitrate);
-  gtk_table_attach (GTK_TABLE (table2), entry_minbitrate, 1, 2, 0, 1,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  entry_maxbitrate = gtk_entry_new ();
-  gtk_widget_show (entry_maxbitrate);
-  gtk_table_attach (GTK_TABLE (table2), entry_maxbitrate, 1, 2, 1, 2,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  label8 = gtk_label_new (_("Use Xvid Ratecontrol"));
-  gtk_widget_show (label8);
-  gtk_table_attach (GTK_TABLE (table2), label8, 0, 1, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (label8), GTK_JUSTIFY_LEFT);
-  gtk_misc_set_alignment (GTK_MISC (label8), 0, 0.5);
-
-  checkbutton_xvid = gtk_check_button_new_with_mnemonic ("");
-  gtk_widget_show (checkbutton_xvid);
-  gtk_table_attach (GTK_TABLE (table2), checkbutton_xvid, 1, 2, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  label14 = gtk_label_new (_("VBV buffer size"));
-  gtk_widget_show (label14);
-  gtk_table_attach (GTK_TABLE (table2), label14, 0, 1, 3, 4,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (label14), GTK_JUSTIFY_LEFT);
-  gtk_misc_set_alignment (GTK_MISC (label14), 0, 0.5);
-
-  optionmenu1 = gtk_option_menu_new ();
-  gtk_widget_show (optionmenu1);
-  gtk_table_attach (GTK_TABLE (table2), optionmenu1, 1, 2, 3, 4,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  menu3 = gtk_menu_new ();
-
-  vcd = gtk_menu_item_new_with_mnemonic (_("VCD: 40 kB"));
-  gtk_widget_show (vcd);
-  gtk_container_add (GTK_CONTAINER (menu3), vcd);
-
-  svcd = gtk_menu_item_new_with_mnemonic (_("SVCD: 112 kB"));
-  gtk_widget_show (svcd);
-  gtk_container_add (GTK_CONTAINER (menu3), svcd);
-
-  dvd = gtk_menu_item_new_with_mnemonic (_("DVD: 224 kB"));
-  gtk_widget_show (dvd);
-  gtk_container_add (GTK_CONTAINER (menu3), dvd);
-
-  gtk_option_menu_set_menu (GTK_OPTION_MENU (optionmenu1), menu3);
-
-  label5 = gtk_label_new (_("<b>RateControl</b>"));
-  gtk_widget_show (label5);
-  gtk_frame_set_label_widget (GTK_FRAME (frame2), label5);
-  gtk_label_set_use_markup (GTK_LABEL (label5), TRUE);
-  gtk_label_set_justify (GTK_LABEL (label5), GTK_JUSTIFY_LEFT);
-
-  frame6 = gtk_frame_new (NULL);
-  gtk_widget_show (frame6);
-  gtk_box_pack_start (GTK_BOX (vbox1), frame6, TRUE, TRUE, 0);
-
-  hbox5 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox5);
-  gtk_container_add (GTK_CONTAINER (frame6), hbox5);
-
-  radiobutton_progr = gtk_radio_button_new_with_mnemonic (NULL, _("Progressive"));
-  gtk_widget_show (radiobutton_progr);
-  gtk_box_pack_start (GTK_BOX (hbox5), radiobutton_progr, FALSE, FALSE, 0);
-  gtk_radio_button_set_group (GTK_RADIO_BUTTON (radiobutton_progr), radiobutton_progr_group);
-  radiobutton_progr_group = gtk_radio_button_get_group (GTK_RADIO_BUTTON (radiobutton_progr));
-
-  radiobutton_tff = gtk_radio_button_new_with_mnemonic (NULL, _("Interlaced TFF"));
-  gtk_widget_show (radiobutton_tff);
-  gtk_box_pack_start (GTK_BOX (hbox5), radiobutton_tff, FALSE, FALSE, 0);
-  gtk_radio_button_set_group (GTK_RADIO_BUTTON (radiobutton_tff), radiobutton_progr_group);
-  radiobutton_progr_group = gtk_radio_button_get_group (GTK_RADIO_BUTTON (radiobutton_tff));
-
-  radiobutton_bff = gtk_radio_button_new_with_mnemonic (NULL, _("Interlaced BFF"));
-  gtk_widget_show (radiobutton_bff);
-  gtk_box_pack_start (GTK_BOX (hbox5), radiobutton_bff, FALSE, FALSE, 0);
-  gtk_radio_button_set_group (GTK_RADIO_BUTTON (radiobutton_bff), radiobutton_progr_group);
-  radiobutton_progr_group = gtk_radio_button_get_group (GTK_RADIO_BUTTON (radiobutton_bff));
-
-  label15 = gtk_label_new (_("<b>Interlacing</b>"));
-  gtk_widget_show (label15);
-  gtk_frame_set_label_widget (GTK_FRAME (frame6), label15);
-  gtk_label_set_use_markup (GTK_LABEL (label15), TRUE);
-  gtk_label_set_justify (GTK_LABEL (label15), GTK_JUSTIFY_LEFT);
-
-  hbox1 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox1);
-  gtk_box_pack_start (GTK_BOX (vbox1), hbox1, TRUE, TRUE, 0);
-
-  frame3 = gtk_frame_new (NULL);
-  gtk_widget_show (frame3);
-  gtk_box_pack_start (GTK_BOX (hbox1), frame3, TRUE, TRUE, 0);
-
-  hbox2 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox2);
-  gtk_container_add (GTK_CONTAINER (frame3), hbox2);
-
-  radiobutton_ar43 = gtk_radio_button_new_with_mnemonic (NULL, _("4:3"));
-  gtk_widget_show (radiobutton_ar43);
-  gtk_box_pack_start (GTK_BOX (hbox2), radiobutton_ar43, TRUE, FALSE, 0);
-  gtk_radio_button_set_group (GTK_RADIO_BUTTON (radiobutton_ar43), radiobutton_ar43_group);
-  radiobutton_ar43_group = gtk_radio_button_get_group (GTK_RADIO_BUTTON (radiobutton_ar43));
-
-  radiobutton_ar169 = gtk_radio_button_new_with_mnemonic (NULL, _("16:9"));
-  gtk_widget_show (radiobutton_ar169);
-  gtk_box_pack_start (GTK_BOX (hbox2), radiobutton_ar169, TRUE, FALSE, 0);
-  gtk_radio_button_set_group (GTK_RADIO_BUTTON (radiobutton_ar169), radiobutton_ar43_group);
-  radiobutton_ar43_group = gtk_radio_button_get_group (GTK_RADIO_BUTTON (radiobutton_ar169));
-
-  label9 = gtk_label_new (_("<b>Aspect Ratio</b>"));
-  gtk_widget_show (label9);
-  gtk_frame_set_label_widget (GTK_FRAME (frame3), label9);
-  gtk_label_set_use_markup (GTK_LABEL (label9), TRUE);
-  gtk_label_set_justify (GTK_LABEL (label9), GTK_JUSTIFY_LEFT);
-
-  frame4 = gtk_frame_new (NULL);
-  gtk_widget_show (frame4);
-  gtk_box_pack_start (GTK_BOX (hbox1), frame4, TRUE, TRUE, 0);
-
-  optionmenu_matrix = gtk_option_menu_new ();
-  gtk_widget_show (optionmenu_matrix);
-  gtk_container_add (GTK_CONTAINER (frame4), optionmenu_matrix);
-
-  menu2 = gtk_menu_new ();
-
-  default1 = gtk_menu_item_new_with_mnemonic (_("Default"));
-  gtk_widget_show (default1);
-  gtk_container_add (GTK_CONTAINER (menu2), default1);
-
-  tmpgenc1 = gtk_menu_item_new_with_mnemonic (_("Tmpgenc"));
-  gtk_widget_show (tmpgenc1);
-  gtk_container_add (GTK_CONTAINER (menu2), tmpgenc1);
-
-  anime1 = gtk_menu_item_new_with_mnemonic (_("Anime"));
-  gtk_widget_show (anime1);
-  gtk_container_add (GTK_CONTAINER (menu2), anime1);
-
-  kvcd1 = gtk_menu_item_new_with_mnemonic (_("KVCD"));
-  gtk_widget_show (kvcd1);
-  gtk_container_add (GTK_CONTAINER (menu2), kvcd1);
-
-  hrtmpgenc1 = gtk_menu_item_new_with_mnemonic (_("HR-Tmpgenc"));
-  gtk_widget_show (hrtmpgenc1);
-  gtk_container_add (GTK_CONTAINER (menu2), hrtmpgenc1);
-  
-  gtk_option_menu_set_menu (GTK_OPTION_MENU (optionmenu_matrix), menu2);
-
-  label10 = gtk_label_new (_("<b>Matrices</b>"));
-  gtk_widget_show (label10);
-  gtk_frame_set_label_widget (GTK_FRAME (frame4), label10);
-  gtk_label_set_use_markup (GTK_LABEL (label10), TRUE);
-  gtk_label_set_justify (GTK_LABEL (label10), GTK_JUSTIFY_LEFT);
-
-  hbox3 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox3);
-  gtk_box_pack_start (GTK_BOX (vbox1), hbox3, FALSE, FALSE, 0);
-
-  label11 = gtk_label_new (_("Gop Size:"));
-  gtk_widget_show (label11);
-  gtk_box_pack_start (GTK_BOX (hbox3), label11, TRUE, FALSE, 0);
-  gtk_label_set_justify (GTK_LABEL (label11), GTK_JUSTIFY_LEFT);
-
-  entry_gopsize = gtk_entry_new ();
-  gtk_widget_show (entry_gopsize);
-  gtk_box_pack_start (GTK_BOX (hbox3), entry_gopsize, TRUE, TRUE, 0);
-
-  frame5 = gtk_frame_new (NULL);
-  gtk_widget_show (frame5);
-  gtk_box_pack_start (GTK_BOX (vbox1), frame5, FALSE, FALSE, 0);
-
-  hbox4 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox4);
-  gtk_container_add (GTK_CONTAINER (frame5), hbox4);
-
-  label13 = gtk_label_new (_("For info, size is : "));
-  gtk_widget_show (label13);
-  gtk_box_pack_start (GTK_BOX (hbox4), label13, FALSE, FALSE, 0);
-  gtk_label_set_justify (GTK_LABEL (label13), GTK_JUSTIFY_LEFT);
-
-  label_audiosize = gtk_label_new (_("0"));
-  gtk_widget_show (label_audiosize);
-  gtk_box_pack_start (GTK_BOX (hbox4), label_audiosize, FALSE, FALSE, 0);
-  gtk_label_set_justify (GTK_LABEL (label_audiosize), GTK_JUSTIFY_LEFT);
-
-  label12 = gtk_label_new (_("<b>Indicative audio size</b>"));
-  gtk_widget_show (label12);
-  gtk_frame_set_label_widget (GTK_FRAME (frame5), label12);
-  gtk_label_set_use_markup (GTK_LABEL (label12), TRUE);
-  gtk_label_set_justify (GTK_LABEL (label12), GTK_JUSTIFY_LEFT);
-
-  dialog_action_area1 = GTK_DIALOG (dialog1)->action_area;
-  gtk_widget_show (dialog_action_area1);
-  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
-
-  cancelbutton1 = gtk_button_new_from_stock ("gtk-cancel");
-  gtk_widget_show (cancelbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
-  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
-
-  okbutton1 = gtk_button_new_from_stock ("gtk-ok");
-  gtk_widget_show (okbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
-  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
-
-  /* Store pointers to all widgets, for use by lookup_widget(). */
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, "dialog1");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, "dialog_vbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, vbox1, "vbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, frame1, "frame1");
-  GLADE_HOOKUP_OBJECT (dialog1, table1, "table1");
-  GLADE_HOOKUP_OBJECT (dialog1, label2, "label2");
-  GLADE_HOOKUP_OBJECT (dialog1, label3, "label3");
-  GLADE_HOOKUP_OBJECT (dialog1, label4, "label4");
-  GLADE_HOOKUP_OBJECT (dialog1, optionmenu_mode, "optionmenu_mode");
-  GLADE_HOOKUP_OBJECT (dialog1, menu1, "menu1");
-  GLADE_HOOKUP_OBJECT (dialog1, single_pass___bitrate1, "single_pass___bitrate1");
-  GLADE_HOOKUP_OBJECT (dialog1, single_pass___quantizer1, "single_pass___quantizer1");
-  GLADE_HOOKUP_OBJECT (dialog1, two_pass__1, "two_pass__1");
-  GLADE_HOOKUP_OBJECT (dialog1, entry_bitrate, "entry_bitrate");
-  GLADE_HOOKUP_OBJECT (dialog1, spinbutton_quant, "spinbutton_quant");
-  GLADE_HOOKUP_OBJECT (dialog1, label1, "label1");
-  GLADE_HOOKUP_OBJECT (dialog1, frame2, "frame2");
-  GLADE_HOOKUP_OBJECT (dialog1, table2, "table2");
-  GLADE_HOOKUP_OBJECT (dialog1, label6, "label6");
-  GLADE_HOOKUP_OBJECT (dialog1, label7, "label7");
-  GLADE_HOOKUP_OBJECT (dialog1, entry_minbitrate, "entry_minbitrate");
-  GLADE_HOOKUP_OBJECT (dialog1, entry_maxbitrate, "entry_maxbitrate");
-  GLADE_HOOKUP_OBJECT (dialog1, label8, "label8");
-  GLADE_HOOKUP_OBJECT (dialog1, checkbutton_xvid, "checkbutton_xvid");
-  GLADE_HOOKUP_OBJECT (dialog1, label14, "label14");
-  GLADE_HOOKUP_OBJECT (dialog1, optionmenu1, "optionmenu1");
-  GLADE_HOOKUP_OBJECT (dialog1, menu3, "menu3");
-  GLADE_HOOKUP_OBJECT (dialog1, vcd, "vcd");
-  GLADE_HOOKUP_OBJECT (dialog1, svcd, "svcd");
-  GLADE_HOOKUP_OBJECT (dialog1, dvd, "dvd");
-  GLADE_HOOKUP_OBJECT (dialog1, label5, "label5");
-  GLADE_HOOKUP_OBJECT (dialog1, frame6, "frame6");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox5, "hbox5");
-  GLADE_HOOKUP_OBJECT (dialog1, radiobutton_progr, "radiobutton_progr");
-  GLADE_HOOKUP_OBJECT (dialog1, radiobutton_tff, "radiobutton_tff");
-  GLADE_HOOKUP_OBJECT (dialog1, radiobutton_bff, "radiobutton_bff");
-  GLADE_HOOKUP_OBJECT (dialog1, label15, "label15");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox1, "hbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, frame3, "frame3");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox2, "hbox2");
-  GLADE_HOOKUP_OBJECT (dialog1, radiobutton_ar43, "radiobutton_ar43");
-  GLADE_HOOKUP_OBJECT (dialog1, radiobutton_ar169, "radiobutton_ar169");
-  GLADE_HOOKUP_OBJECT (dialog1, label9, "label9");
-  GLADE_HOOKUP_OBJECT (dialog1, frame4, "frame4");
-  GLADE_HOOKUP_OBJECT (dialog1, optionmenu_matrix, "optionmenu_matrix");
-  GLADE_HOOKUP_OBJECT (dialog1, menu2, "menu2");
-  GLADE_HOOKUP_OBJECT (dialog1, default1, "default1");
-  GLADE_HOOKUP_OBJECT (dialog1, tmpgenc1, "tmpgenc1");
-  GLADE_HOOKUP_OBJECT (dialog1, anime1, "anime1");
-  GLADE_HOOKUP_OBJECT (dialog1, kvcd1, "kvcd1");
-  GLADE_HOOKUP_OBJECT (dialog1, hrtmpgenc1, "hrtmpgenc1");
-  GLADE_HOOKUP_OBJECT (dialog1, label10, "label10");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox3, "hbox3");
-  GLADE_HOOKUP_OBJECT (dialog1, label11, "label11");
-  GLADE_HOOKUP_OBJECT (dialog1, entry_gopsize, "entry_gopsize");
-  GLADE_HOOKUP_OBJECT (dialog1, frame5, "frame5");
-  GLADE_HOOKUP_OBJECT (dialog1, hbox4, "hbox4");
-  GLADE_HOOKUP_OBJECT (dialog1, label13, "label13");
-  GLADE_HOOKUP_OBJECT (dialog1, label_audiosize, "label_audiosize");
-  GLADE_HOOKUP_OBJECT (dialog1, label12, "label12");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, "dialog_action_area1");
-  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, "cancelbutton1");
-  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, "okbutton1");
-
-  return dialog1;
-}
-

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am	2007-02-15 08:00:13 UTC (rev 2824)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am	2007-02-16 17:44:01 UTC (rev 2825)
@@ -16,7 +16,7 @@
 	DIA_xvid.cpp DIA_crop.cpp DIA_color.cpp DIA_encoding.cpp  DIA_prefs.cpp \
 	DIA_requant.cpp DIA_xvid4.cpp DIA_lavcodec.cpp \
 	DIA_pause.cpp \
-	DIA_DVDff.cpp DIA_lavdecoder.cpp DIA_calculator.cpp DIA_equalizer.cpp \
+	DIA_lavdecoder.cpp DIA_calculator.cpp DIA_equalizer.cpp \
 	DIA_vobsub.cpp DIA_x264.cpp DIA_ocr.cpp  DIA_hue.cpp DIA_eq2.cpp \
 	DIA_asharp.cpp  DIA_idx_pg.cpp DIA_gototime.cpp \
 	DIA_audioTrack.cpp DIA_cnr2.cpp DIA_jobs.cpp DIA_jobs_save.cpp  \
@@ -39,7 +39,7 @@
 EXTRA_DIST =  \
 DIA_mcdeint.cpp     DIA_resize.cpp \
 DIA_cnr2.cpp          DIA_mjpeg.cpp       \
-DIA_DVDff.cpp        DIA_color.cpp         DIA_eq2.cpp          \
+DIA_color.cpp         DIA_eq2.cpp          \
 DIA_coloryuv.cpp      DIA_equalizer.cpp    DIA_mpdelogo.cpp    DIA_rotate.cpp \
 DIA_contrast.cpp      DIA_exLame.cpp       DIA_mpeg2opt.cpp    DIA_srt.cpp \
 DIA_about.cpp        DIA_tdeint.cpp \

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_DVDff.cpp (from rev 2818, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_DVDff.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_DVDff.cpp	2007-02-13 19:16:54 UTC (rev 2818)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_DVDff.cpp	2007-02-16 17:44:01 UTC (rev 2825)
@@ -0,0 +1,106 @@
+/*
+    Dialog for lavcodec based Mpeg1/mpeg2 codec
+
+
+*/
+#include <config.h>
+
+#include <stdio.h>
+#include <stdlib.h>
+
+
+#include "ADM_lavcodec.h"
+
+#include "default.h"
+#include "ADM_toolkit/toolkit.hxx"
+#include "ADM_codecs/ADM_codec.h"
+#include "ADM_encoder/ADM_vidEncode.hxx"
+#include "ADM_codecs/ADM_ffmpegConfig.h"
+#include "DIA_factory.h"
+#include "ADM_assert.h" 
+
+#warning FIXME Old : MaxBitrate in Byte/s, new entry in kb/s
+#warning FIXME Old : MaxBitrate in Byte/s, new entry in kb/s
+#warning FIXME Old : MaxBitrate in Byte/s, new entry in kb/s
+#warning FIXME Old : MaxBitrate in Byte/s new entry in kb/s
+#warning FIXME Old : MaxBitrate in Byte/s new entry in kb/s
+#warning FIXME Old : MaxBitrate in Byte/s new entry in kb/s
+
+
+
+#include "ADM_codecs/ADM_codec.h"
+#include "ADM_encoder/ADM_vidEncode.hxx"
+#include "ADM_assert.h" 
+#include "DIA_factory.h"
+#include "../../ADM_libraries/ADM_libmpeg2enc/ADM_mpeg2enc.h"
+
+/**
+      \fn DIA_DVDffParam
+      \brief Dialog to set encoding options for SVCD/DVD lavcodec based
+*/
+//____________________________________________
+
+uint8_t DIA_DVDffParam(COMPRES_PARAMS *incoming)
+{
+	
+
+	int ret;
+	FFcodecSetting *conf=(FFcodecSetting *)incoming->extraSettings;
+	ADM_assert(incoming->extraSettingsLen==sizeof(FFcodecSetting));
+
+diaMenuEntry wideM[]={
+  {0,_("4:3")},
+  {1,_("16:9")}};
+diaMenuEntry matrixM[]={
+  {0,_("Default")},
+  {1,_("Tmpgenc")},
+  {2,_("Anime")},
+  {3,_("KVCD")}
+};
+diaMenuEntry interM[]={
+  {0,_("Progressive")},
+  {1,_("Int. TFF")},
+  {2,_("Int. BFF")}
+};
+diaMenuEntry vbvM[3]=
+{
+	{40,"VCD 40 KB"},
+	{112,"SVCD 112 kB"},
+	{224,"DVD 224 KB"}
+};
+
+                      
+         diaElemBitrate bitrate(incoming,NULL);
+         diaElemUInteger maxb(&(conf->maxBitrate),_("Max Bitrate"),100,9000);
+         diaElemUInteger minb(&(conf->minBitrate),_("Min Bitrate"),0,9000);
+         diaElemToggle    xvid(&(conf->use_xvid_ratecontrol),_("Use Xvid Rate Control"));
+         
+         diaElemMenu      vbv(&(conf->bufferSize),_("Buffer Size"),3,vbvM);
+         
+         diaElemMenu      widescreen(&(conf->widescreen),_("Aspect Ratio"),2,wideM);
+         diaElemMenu      matrix(&(conf->user_matrix),_("Matrices"),4,matrixM);
+         diaElemUInteger  gop(&(conf->gop_size),_("Gop Size"),1,30);
+         
+uint32_t inter;
+          if(!conf->interlaced) inter=0;
+            else if(conf->bff) inter=2;
+                else inter=1;
+         diaElemMenu      interW(&inter,_("Interlacing"),3,interM);
+  
+      diaElem *elems[9]={&bitrate,&maxb,&minb,&xvid,&vbv,&widescreen,&interW,&matrix,&gop};
+    
+  if( diaFactoryRun("Mpeg2 Encoding",9,elems))
+  {
+    switch(inter)
+    {
+      case 0: conf->interlaced=0;conf->bff=0;break;
+      case 1: conf->interlaced=1;conf->bff=0;break;
+      case 2: conf->interlaced=1;conf->bff=1;break;
+      default: ADM_assert(0);
+    }
+    return 1;
+  }
+  return 0;
+}	
+// EOF
+

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am	2007-02-15 08:00:13 UTC (rev 2824)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am	2007-02-16 17:44:01 UTC (rev 2825)
@@ -2,10 +2,10 @@
 libADM_CommonUI_a_METASOURCES = AUTO
 libADM_CommonUI_a_SOURCES = GUI_sdlRender.cpp  GUI_xvRender.cpp  \
 DIA_resizeWiz.cpp DIA_builtin.cpp DIA_postproc.cpp DIA_enter.cpp \
-DIA_audioconfig.cpp GUI_render.cpp DIA_SVCD.cpp
+DIA_audioconfig.cpp GUI_render.cpp DIA_SVCD.cpp DIA_DVDff.cpp
 
 
 INCLUDES = $(all_includes) $(GTK_CFLAGS) $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \
 		-I./../../ADM_libraries/ADM_utilities \
-		-I./../ADM_commonUI -I../.... -I../..../ADM_libraries/ADM_lavutil \
+		-I./../ADM_commonUI -I../../.. -I./../../ADM_libraries/ADM_lavutil \
 		-I./../../ADM_inputs -I../..../ADM_outputs -I../../ADM_ocr



From mean at mail.berlios.de  Sat Feb 17 17:32:00 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 17 Feb 2007 17:32:00 +0100
Subject: [Avidemux-svn-commit] r2826 -
	branches/avidemux_2.4_branch/avidemux/ADM_video
Message-ID: <200702171632.l1HGW0LC003976@sheep.berlios.de>

Author: mean
Date: 2007-02-17 17:31:59 +0100 (Sat, 17 Feb 2007)
New Revision: 2826

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidFont.cpp
Log:
remove hack for comma

Modified: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidFont.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidFont.cpp	2007-02-16 17:44:01 UTC (rev 2825)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidFont.cpp	2007-02-17 16:31:59 UTC (rev 2826)
@@ -140,8 +140,10 @@
 	//printf("FONT: rendering %d %c\n",c,c);
 	*ww=0;	
 /* Ugly patch t avoid some display problem */	
+#if 0
         if(c=='\'') c='"';
         if(prevchar=='\'') prevchar='"';
+#endif
 /* Ugly patch t avoid some display problem */
 	glyph_index = FT_Get_Char_Index( _face, c );
 	if(prevchar)



From mean at mail.berlios.de  Sun Feb 18 10:19:09 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 18 Feb 2007 10:19:09 +0100
Subject: [Avidemux-svn-commit] r2827 - in
	branches/avidemux_2.4_branch/avidemux: .
	ADM_userInterfaces/ADM_GTK/ADM_dialog
	ADM_userInterfaces/ADM_GTK/ADM_dialogFactory
	ADM_userInterfaces/ADM_NONE/ADM_dialogFactory
	ADM_userInterfaces/ADM_commonUI
Message-ID: <200702180919.l1I9J92h030393@sheep.berlios.de>

Author: mean
Date: 2007-02-18 10:19:08 +0100 (Sun, 18 Feb 2007)
New Revision: 2827

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_bitrateHisto.cpp
Removed:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_bitrateHisto.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bitrate.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am
   branches/avidemux_2.4_branch/avidemux/Makefile.am
Log:
histogram using dialogFactory

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_bitrateHisto.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_bitrateHisto.cpp	2007-02-17 16:31:59 UTC (rev 2826)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_bitrateHisto.cpp	2007-02-18 09:19:08 UTC (rev 2827)
@@ -1,215 +0,0 @@
-/***************************************************************************
-                          ADM_guiBitrate  -  description
-                             -------------------
-
-	Simple bitrate analyzer
-
-    begin                : Mon Aug 31 2003
-    copyright            : (C) 2003 by mean
-    email                : fixounet at free.fr
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include "config.h"
-
-#include <stdio.h>
-#include <stdlib.h>
-#include <math.h>
-
-
-#include "ADM_toolkit_gtk/toolkit_gtk_include.h"
-
-#include "avi_vars.h"
-#include "ADM_toolkit_gtk/toolkit_gtk.h"
-#include "ADM_toolkit/toolkit.hxx"
-#include "ADM_toolkit_gtk/ADM_gladeSupport.h"
-#include "ADM_assert.h"
-
-
-
-
-
-
-
-static GtkWidget	*create_dialog1 (uint32_t max, float *value);
-
-
-void GUI_displayBitrate( void )
-{
-
-  int32_t total,max;
- uint32_t len,idx,nb_frame,k,changed;
- uint32_t round,sum,average[60];;
-
- float f;
-
- float display[20];
-
-	// 1st compute the total
-	total=0;
-	max=0;
-	if(!(frameEnd>frameStart))
-	{
-          GUI_Error_HIG(_("No data"), NULL);
-		return ;
-	}
-
-	round=((avifileinfo->fps1000+990)/1000);
-	if(!round) return;
-
-	video_body->getFrameSize (frameStart, &len);
-	for(k=0;k<round;k++) average[k]=0;
-
-	sum=0;
-	changed=0;
-
-	// 1 st pass, compute max
-	for( k=frameStart;k<frameEnd;k++)
-	{
- 		video_body->getFrameSize (k, &len);
-		sum-=average[changed];
-		average[changed]=len;
-		sum+=average[changed];
-		//printf("Frame %lu Br: %lu\n",k,(sum*8)/1000);
-		if(sum>max) max=sum;
-		changed++;
-		changed%=round;
-	}
-#define ROUNDUP 20000
-	max=(max+ROUNDUP -1)/ROUNDUP;
-	max=max*ROUNDUP;
-
-	printf("\n Total : %lu bytes, max %d bytes round %d\n",total,max,round);
-	if(!max)
-	{
-          GUI_Error_HIG(_("No data"), NULL);
-		return ;
-	}
-	nb_frame=frameEnd-frameStart;
-	// and now build an histogram
-	for(k=0;k<20;k++) display[k]=0;
-
-	video_body->getFrameSize (frameStart, &len);
-	for(k=0;k<round;k++) average[k]=0;
-
-	sum=0;
-	changed=0;
-
-
-	for(uint32_t k=frameStart;k<frameEnd;k++)
-	{
-		video_body->getFrameSize (k, &len);
-		// which case ?
-		sum-=average[changed];
-		average[changed]=len;
-		sum+=average[changed];
-		changed++;
-		changed%=round;
-
-		f=sum;
-		f=f/max;
-		f=f*20.;
-		idx=(uint32_t )floor(f+0.5);
-	//	printf("idx : %d\n",idx);
-		if(idx>19) idx=19;
-		display[idx]++;
-	}
-
-
-	for(k=0;k<20;k++) display[k]=(100*display[k])/nb_frame;
-	for(k=0;k<20;k++)
-	{
-		printf(" %d , %04d -- %04d percent -> %02.1f\n",k,(max*k*8)/20000,(8*max*(k+1))/20000,display[k]);
-
-	}
-	GtkWidget *dialog=create_dialog1((max*8)/1000,display);
-	gtk_register_dialog(dialog);
-	gtk_dialog_run(GTK_DIALOG(dialog));
-	gtk_unregister_dialog(dialog);
-	gtk_widget_destroy(dialog);
-}
-
-
-GtkWidget	*create_dialog1 (uint32_t max, float *value)
-{
-  GtkWidget *dialog1;
-  GtkWidget *dialog_vbox1;
-  GtkWidget *table1;
-  GtkWidget *label1;
-  GtkWidget *label2;
-  GtkWidget *progressbar1;
-  GtkWidget *progressbar2;
-  GtkWidget *dialog_action_area1;
-  GtkWidget *okbutton1;
-
-  dialog1 = gtk_dialog_new ();
-  gtk_window_set_title (GTK_WINDOW (dialog1), "Bitrate Histogram");
-
-  dialog_vbox1 = GTK_DIALOG (dialog1)->vbox;
-  gtk_widget_show (dialog_vbox1);
-
-  table1 = gtk_table_new (20, 2, FALSE);
-  gtk_widget_show (table1);
-  gtk_box_pack_start (GTK_BOX (dialog_vbox1), table1, TRUE, TRUE, 0);
-
-
-/*----*/
-	char string[200];
-	float p;
-
-	for(int j=0;j<20;j++)
-	{
-
-		sprintf(string,"%05d kbps :",(max*j)/20);
- 		label1 = gtk_label_new (string);
-  		gtk_widget_show (label1);
- 		gtk_table_attach (GTK_TABLE (table1), label1, 0, 1, 20-j-1, 20-j,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  		gtk_label_set_justify (GTK_LABEL (label1), GTK_JUSTIFY_LEFT);
-  		gtk_misc_set_alignment (GTK_MISC (label1), 0, 0.5);
-
-		gtk_widget_set_usize(label1,100,-1);
-
-		progressbar1 = gtk_progress_bar_new ();
-  		gtk_widget_show (progressbar1);
-  		gtk_table_attach (GTK_TABLE (table1), progressbar1, 1, 2, 20-j-1, 20-j,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-			p=value[j];
-			p=p/100.;	
-       			gtk_progress_set_percentage(GTK_PROGRESS(progressbar1),(gfloat)p);
-
-	}
-
-  dialog_action_area1 = GTK_DIALOG (dialog1)->action_area;
-  gtk_widget_show (dialog_action_area1);
-  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
-
-  okbutton1 = gtk_button_new_from_stock ("gtk-ok");
-  gtk_widget_show (okbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
-  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
-
-  /* Store pointers to all widgets, for use by lookup_widget(). */
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, "dialog1");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, "dialog_vbox1");
-  GLADE_HOOKUP_OBJECT (dialog1, table1, "table1");
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, "dialog_action_area1");
-  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, "okbutton1");
-
-  return dialog1;
-}
-
-
-
-// EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am	2007-02-17 16:31:59 UTC (rev 2826)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am	2007-02-18 09:19:08 UTC (rev 2827)
@@ -30,8 +30,7 @@
 	DIA_coloryuv.cpp \
 	DIA_quota.cpp \
 	DIA_animated.cpp \
-	DIA_partial.cpp \
-	DIA_bitrateHisto.cpp
+	DIA_partial.cpp 
 
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bitrate.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bitrate.cpp	2007-02-17 16:31:59 UTC (rev 2826)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bitrate.cpp	2007-02-18 09:19:08 UTC (rev 2827)
@@ -153,7 +153,7 @@
 #undef S
 #define P(x) 
 #define M(x,y)
-#define S(x)   x=gtk_spin_button_get_value  (GTK_SPIN_BUTTON(spin))
+#define S(x)   x=(uint32_t)gtk_spin_button_get_value  (GTK_SPIN_BUTTON(spin))
   switch(rank)
   {
     case 0: //CBR
@@ -197,6 +197,9 @@
   GtkSpinButton *spin=(GtkSpinButton*)w[3];
   GtkLabel *label=(GtkLabel*)w[1];
   int rank=gtk_combo_box_get_active(GTK_COMBO_BOX(combo));
+#undef P
+#undef M
+#undef S
 #define P(x) gtk_label_set_text(GTK_LABEL(label),_(#x));
 #define M(x,y) gtk_spin_button_set_range  (GTK_SPIN_BUTTON(spin),x,y)
 #define S(x)   gtk_spin_button_set_value  (GTK_SPIN_BUTTON(spin),x)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-02-17 16:31:59 UTC (rev 2826)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-02-18 09:19:08 UTC (rev 2827)
@@ -9,6 +9,6 @@
 libADM_dialogFactory_a_METASOURCES = AUTO
 
 libADM_dialogFactory_a_SOURCES = DIA_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_float.cpp FAC_menu.cpp \
-				DIA_filesel.cpp FAC_bitrate.cpp
+				DIA_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp	2007-02-17 16:31:59 UTC (rev 2826)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp	2007-02-18 09:19:08 UTC (rev 2827)
@@ -101,7 +101,26 @@
 {
  
 }
+//******************************************************
 
+diaElemBar::diaElemBar(uint32_t percent,const char *toggleTitle)
+  : diaElem(ELEM_BAR)
+{
+}
+
+diaElemBar::~diaElemBar()
+{
+  
+}
+void diaElemBar::setMe(void *dialog, void *opaque,uint32_t line)
+{
+  
+}
+void diaElemBar::getMe(void)
+{
+ 
+}
+
 //******************************************************
 
 diaElemMenu::diaElemMenu(uint32_t *intValue,const char *itle, uint32_t nb, 

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_bitrateHisto.cpp (from rev 2818, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_bitrateHisto.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_bitrateHisto.cpp	2007-02-13 19:16:54 UTC (rev 2818)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_bitrateHisto.cpp	2007-02-18 09:19:08 UTC (rev 2827)
@@ -0,0 +1,170 @@
+/***************************************************************************
+                          ADM_guiBitrate  -  description
+                             -------------------
+
+	Simple bitrate analyzer
+
+    begin                : Mon Aug 31 2003
+    copyright            : (C) 2003 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "config.h"
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <math.h>
+
+#include "default.h"
+#include "avi_vars.h"
+#include "ADM_toolkit/toolkit.hxx"
+#include "DIA_factory.h"
+#include "ADM_assert.h"
+
+/**
+      \fn GUI_displayBitrate
+      \brief display a bargraph with bitrates
+*/
+
+void GUI_displayBitrate( void )
+{
+
+  int32_t total,max;
+ uint32_t len,idx,nb_frame,k,changed;
+ uint32_t round,sum,average[60];;
+
+ float f;
+
+ float display[20];
+uint32_t medium=0;
+
+	// 1st compute the total
+	
+	max=0;
+	if(!(frameEnd>frameStart) || abs(frameStart-frameEnd)<5)
+	{
+          GUI_Error_HIG(_("No data"), NULL);
+		return ;
+	}
+
+	round=((avifileinfo->fps1000+990)/1000);
+	if(!round) return;
+
+	video_body->getFrameSize (frameStart, &len);
+	for(k=0;k<round;k++) average[k]=0;
+
+	sum=0;
+	changed=0;
+        total=0;
+	// 1 st pass, compute max
+	for( k=frameStart;k<frameEnd;k++)
+	{
+ 		video_body->getFrameSize (k, &len);
+                total+=len;
+		sum-=average[changed];
+		average[changed]=len;
+		sum+=average[changed];
+		//printf("Frame %lu Br: %lu\n",k,(sum*8)/1000);
+		if(sum>max) max=sum;
+		changed++;
+		changed%=round;
+	}
+        
+        float g=total;
+        g/=(frameEnd-frameStart);
+        g*=avifileinfo->fps1000;
+        g/=(1000.*1000.);
+        medium=(uint32_t)(g*8);
+        printf("Average :%u max%u\n",medium,max);
+#if 0
+#define ROUNDUP 20*1000
+        uint32_t s;
+	s=(max+ROUNDUP -1)/ROUNDUP;
+	max=s*ROUNDUP;
+#endif
+
+	printf("\n Total : %lu bytes, max br %d bytes round %d\n",total,max,round);
+	if(!max)
+	{
+          GUI_Error_HIG(_("No data"), NULL);
+		return ;
+	}
+	nb_frame=frameEnd-frameStart;
+	// and now build an histogram
+	for(k=0;k<20;k++) display[k]=0;
+
+	video_body->getFrameSize (frameStart, &len);
+	for(k=0;k<round;k++) average[k]=0;
+
+	sum=0;
+	changed=0;
+        uint32_t step=(max*8)/20000;
+
+	for(uint32_t k=frameStart;k<frameEnd;k++)
+	{
+		video_body->getFrameSize (k, &len);
+		// which case ?
+                if(sum>average[changed])
+		  sum-=average[changed];
+                else
+                   sum=0;
+		average[changed]=len;
+		sum+=average[changed];
+		changed++;
+		changed%=round;
+
+		f=sum;
+		f=f/max;
+		f=f*20.;
+		idx=(uint32_t )floor(f+0.5);
+	//	printf("idx : %d\n",idx);
+		if(idx>19) idx=19;
+		display[idx]++;
+	}
+
+
+	for(k=0;k<20;k++) display[k]=(100*display[k])/nb_frame;
+	for(k=0;k<20;k++)
+	{
+		printf(" %d , %04d -- %04d percent -> %02.1f\n",k,(max*k*8)/20000,(8*max*(k+1))/20000,display[k]);
+
+	}
+        
+        diaElemBar *bar[20];
+        char str[256];
+        for(int i=0;i<20;i++)
+        {
+          sprintf(str,"%03u--%03u",step*i,step*(i+1));
+          bar[19-i]=new  diaElemBar((uint32_t)display[i],str);
+            
+        }
+        
+        diaElemUInteger med(&medium,"Average bitrate",0,9999999);
+        diaElemBar foo(0,"foo");
+#define P(X) bar[X] 
+  
+      diaElem *elems[21]={
+            &med,
+            P(0),P(1),P(2),P(3),P(4),P(5),P(6),P(7),P(8),P(9),
+            P(10),P(11),P(12),P(13),P(14),P(15),P(16),P(17),P(18),P(19)
+          };
+    
+        diaFactoryRun(_("Bitrate Histogram"),21,elems);
+        
+        
+        for(int i=0;i<20;i++)
+        {
+          delete bar[i];
+        }
+}
+
+

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-17 16:31:59 UTC (rev 2826)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-18 09:19:08 UTC (rev 2827)
@@ -25,6 +25,7 @@
   ELEM_MENU,
   ELEM_FILE_READ,
   ELEM_BITRATE,
+  ELEM_BAR,
   ELEM_MAX=ELEM_TOGGLE
 };
 /*********************************************/
@@ -78,6 +79,18 @@
   void setMe(void *dialog, void *opaque,uint32_t line);
   void getMe(void);
 };
+/*************************************************/
+class diaElemBar : public diaElem
+{
+  protected :
+        uint32_t per;
+public:
+  
+  diaElemBar(uint32_t percent,const char *toggleTitle);
+  virtual ~diaElemBar() ;
+  void setMe(void *dialog, void *opaque,uint32_t line);
+  void getMe(void);
+};
 
 /*********************************************/
 #define ELEM_TYPE_FLOAT float
@@ -145,5 +158,5 @@
 };
 /*********************************************/
 uint8_t diaFactoryRun(const char *title,uint32_t nb,diaElem **elems);
-
+/*********************************************/
 #endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am	2007-02-17 16:31:59 UTC (rev 2826)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am	2007-02-18 09:19:08 UTC (rev 2827)
@@ -2,7 +2,8 @@
 libADM_CommonUI_a_METASOURCES = AUTO
 libADM_CommonUI_a_SOURCES = GUI_sdlRender.cpp  GUI_xvRender.cpp  \
 DIA_resizeWiz.cpp DIA_builtin.cpp DIA_postproc.cpp DIA_enter.cpp \
-DIA_audioconfig.cpp GUI_render.cpp DIA_SVCD.cpp DIA_DVDff.cpp
+DIA_audioconfig.cpp GUI_render.cpp DIA_SVCD.cpp DIA_DVDff.cpp \
+DIA_bitrateHisto.cpp
 
 
 INCLUDES = $(all_includes) $(GTK_CFLAGS) $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \

Modified: branches/avidemux_2.4_branch/avidemux/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/Makefile.am	2007-02-17 16:31:59 UTC (rev 2826)
+++ branches/avidemux_2.4_branch/avidemux/Makefile.am	2007-02-18 09:19:08 UTC (rev 2827)
@@ -27,6 +27,7 @@
 		./ADM_userInterfaces/ADM_GTK/ADM_dialog/libADM_dialog.a	\
 		./ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/libADM_dialogFactory.a	\
 		./ADM_userInterfaces/ADM_commonUI/libADM_CommonUI.a	\
+		./ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/libADM_dialogFactory.a	\
 		./ADM_userInterfaces/ADM_GTK/ADM_gui2/libADM_gui2.a	\
 		./ADM_userInterfaces/ADM_GTK/ADM_filters/libADM_filters.a \
 		./ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/libADM_toolkit_gtk.a	



From mean at mail.berlios.de  Sun Feb 18 10:26:41 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 18 Feb 2007 10:26:41 +0100
Subject: [Avidemux-svn-commit] r2828 - in
	branches/avidemux_2.4_branch/avidemux: .
	ADM_libraries/ADM_xvidratectl ADM_userInterfaces/ADM_GTK/ADM_gui2
Message-ID: <200702180926.l1I9QfAW030680@sheep.berlios.de>

Author: mean
Date: 2007-02-18 10:26:40 +0100 (Sun, 18 Feb 2007)
New Revision: 2828

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_xvidratectl.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
   branches/avidemux_2.4_branch/avidemux/Makefile.am
   branches/avidemux_2.4_branch/avidemux/main.cpp
Log:
grunster : mingw fix

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_xvidratectl.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_xvidratectl.cpp	2007-02-18 09:19:08 UTC (rev 2827)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_xvidratectl/ADM_xvidratectl.cpp	2007-02-18 09:26:40 UTC (rev 2828)
@@ -56,6 +56,7 @@
 #include "ADM_osSupport/ADM_debugID.h"
 #define MODULE_NAME  MODULE_XVID_RCTL
 #include "ADM_osSupport/ADM_debug.h"
+#include "ADM_osSupport/ADM_misc.h"
 
 // Glueing to avidemux
 #define DPRINTF(a,b, args...) aprintf(b,## args);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp	2007-02-18 09:19:08 UTC (rev 2827)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp	2007-02-18 09:26:40 UTC (rev 2828)
@@ -35,7 +35,7 @@
 #include <../ADM_assert.h>
 #define WIN32_CLASH
 #include "default.h"
-#include "ADM_osSupport/ADM_misc.h"
+#include "../ADM_osSupport/ADM_misc.h"
 
 #include "ADM_commonUI/GUI_render.h"
 

Modified: branches/avidemux_2.4_branch/avidemux/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/Makefile.am	2007-02-18 09:19:08 UTC (rev 2827)
+++ branches/avidemux_2.4_branch/avidemux/Makefile.am	2007-02-18 09:26:40 UTC (rev 2828)
@@ -156,7 +156,8 @@
 	-IADM_inputs -IADM_outputs \
 	-IADM_lavutil  -IADM_libraries -IADM_libraries/ADM_utilities -IADM_libraries/ADM_lavutil \
 	-IADM_userInterfaces/ADM_commonUI \
-	-IADM_userInterfaces/ADM_GTK $(GLIB_CFLAGS)
+	-IADM_userInterfaces/ADM_GTK $(GLIB_CFLAGS) \
+	@ADM_QTINCLUDES@
 
 # the library search path.
 if ADM_UI_GTK

Modified: branches/avidemux_2.4_branch/avidemux/main.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/main.cpp	2007-02-18 09:19:08 UTC (rev 2827)
+++ branches/avidemux_2.4_branch/avidemux/main.cpp	2007-02-18 09:26:40 UTC (rev 2828)
@@ -101,6 +101,13 @@
 extern pthread_mutex_t g_pSpiderMonkeyMutex;
 int CpuCaps::myCpuCaps=0;
 
+#ifdef QT_NEEDS_QMAIN
+int qMain(int argc, char *argv[])
+{
+	return main(argc, argv);
+}
+#endif	// QT_NEEDS_QMAIN
+
 int main(int argc, char *argv[])
 {
 // Check for big files



From mean at mail.berlios.de  Sun Feb 18 16:37:46 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 18 Feb 2007 16:37:46 +0100
Subject: [Avidemux-svn-commit] r2829 - in
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters:
	. icons
Message-ID: <200702181537.l1IFbk4f030776@sheep.berlios.de>

Author: mean
Date: 2007-02-18 16:37:43 +0100 (Sun, 18 Feb 2007)
New Revision: 2829

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/filter.qrc
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/down.png
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/up.png
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/mainfilter.ui
Log:
JM video filter

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp	2007-02-18 09:26:40 UTC (rev 2828)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp	2007-02-18 15:37:43 UTC (rev 2829)
@@ -6,7 +6,7 @@
     * I.e.
     0--1000 : QT4 internal
     2000-3000: Filters
-    3000-4000  External Filter
+    3000-4000  filterFamilyClick Filter
     8000-9000  Active Filter
     
     
@@ -34,6 +34,7 @@
 #include "ui_mainfilter.h"
 #undef Ui_Dialog
 #include "QStringListModel" 
+#include "QColor" 
 #include "default.h"
 #include "ADM_toolkit/filesel.h"
 
@@ -50,9 +51,9 @@
 #include "ADM_filter/video_filters.h"
 #include "ADM_video/ADM_vidPartial.h"
 /*******************************************************/
-#define NB_TREE 7
-static int startFilter[NB_TREE];
-static int filterSize[NB_TREE];
+#define NB_TREE 8
+#define myFg 0xFF
+#define myBg 0xF0
 static int max=0;
 /******************************************************/
 #define ALL_FILTER_BASE       1000
@@ -74,13 +75,12 @@
  public:
      filtermainWindow();
  //    virtual ~filtermainWindow();
-     void             buildAvailableFilterList(void);
      void             buildActiveFilterList(void);
      Ui_mainFilterDialog ui;
      
-     QListWidget      *allList[NB_TREE];
      
      
+     QListWidget      *availableList;
      QListWidget      *activeList;
      
      
@@ -94,9 +94,15 @@
         void partial(bool b);
         void activeDoubleClick( QListWidgetItem  *item);
         void allDoubleClick( QListWidgetItem  *item);
+	void filterFamilyClick(QListWidgetItem *item);
+	void filterFamilyClick(int  item);
  private slots:
  private:
+        int startFilter[NB_TREE];
+        int filterSize[NB_TREE];
         void setSelected(int sel);
+        void displayFamily(uint32_t family);
+        void setupFilters(void);
 };
 /**
         \fn     void setSelected(int sel)
@@ -114,12 +120,8 @@
 */
 void filtermainWindow::add( bool b)
 {
-  
-  /* Get selection if any */
-  int tab=ui.tabWidgetSubtitles->currentIndex();
-  ADM_assert(tab>=0 && tab < NB_TREE);
   /* Now that we have the tab, get the selection */
-   QListWidgetItem *item=allList[tab]->currentItem();
+   QListWidgetItem *item=availableList->currentItem();
    VF_FILTERS tag;
    if(item)
    {
@@ -150,6 +152,7 @@
         setSelected(nb_active_filter);
         buildActiveFilterList();
    }
+
 }
 /**
         \fn     remove( bool b)
@@ -297,7 +300,55 @@
             setSelected(itag+1);
         }
 }
+/**
+        \fn     filtermainWindow::filterFamilyClick( QListWidgetItem  *item)
+        \brief  Select family among color etc... 
+*/
 
+void filtermainWindow::filterFamilyClick(QListWidgetItem *item)
+{
+    int family= ui.listFilterCategory->currentRow();
+    if(family>=0)
+        displayFamily(family);
+}
+void filtermainWindow::filterFamilyClick(int  m)
+{
+        if(m>=0)
+                displayFamily(m);
+}
+void filtermainWindow::displayFamily(uint32_t family)
+{
+  printf("Family :%u\n",family);
+  
+  availableList->clear();
+  QColor colorgrey;
+  colorgrey.setRgb(myBg,myBg,myBg);
+  QBrush brush(colorgrey);
+  QSize sz;
+  
+  for (uint32_t i = 0; i < filterSize[family]; i++)
+    {
+      int r=startFilter[family]+i;
+
+      if (allfilters[r].viewable==1)
+        {
+          QString str; //="<b>";
+          str+=allfilters[r].name;
+         
+          QListWidgetItem *item;
+          if(family==NB_TREE-1)
+                item=new QListWidgetItem(str,availableList,EXTERNAL_FILTER_BASE+i);
+          else
+                item=new QListWidgetItem(str,availableList,ALL_FILTER_BASE+r);
+          item->setToolTip(allfilters[r].description);
+          if(i&1) item->setBackground(brush);
+          availableList->addItem(item);
+          
+        }
+     }
+   
+}
+
 /**
         \fn     filtermainWindow::activeDoubleClick( QListWidgetItem  *item)
         \brief  One of the active window has been double clicked, call configure
@@ -362,34 +413,21 @@
         }
         else delete replace;
 }
-#define myBg 0xF0
 /**
-        \fn     buildAvailableFilterList(void)
-        \brief  build the internal datas needed to handle the list. Need to be called only once.
+        \fn setup
+        \brief Prepare 
 */
-void filtermainWindow::buildAvailableFilterList(void)
+void filtermainWindow::setupFilters(void)
 {
   int current_tree=-1;
   int current_raw=0;;
   
   max=0;
-  QColor colorGrey;
-  colorGrey.setRgb(myBg,myBg,myBg);
-  QBrush brush(colorGrey);
-  QSize sz;
   
   for (uint32_t i = 0; i < nb_video_filter; i++)
     {
       if (allfilters[i].viewable==1)
         {
-          QString str; //="<b>";
-          str+=allfilters[i].name;
-          max++;
-          
-          QListWidgetItem *item=new QListWidgetItem(str,allList[current_tree],ALL_FILTER_BASE+i);
-          item->setToolTip(allfilters[i].description);
-          if(i&1) item->setBackground(brush);
-          allList[current_tree]->addItem(item);
           current_raw++;
           
         }else 
@@ -397,28 +435,35 @@
                 current_tree++;
                 if(current_tree) filterSize[current_tree-1]=current_raw;
                 if(current_tree>=NB_TREE) break;
-                allList[current_tree]->clear();
                 startFilter[current_tree]=i+1;
                 current_raw=0;
                 
         }
     }
-   
-    
-    ADM_assert(NB_TREE==7);
-  
+    ADM_assert(NB_TREE==8);
+    startFilter[NB_TREE-1]=2000;
+    filterSize[NB_TREE-1]=0;
+    for(int i=0;i<NB_TREE;i++)
+    {
+             printf("%d Start at %d size :%d\n",i,startFilter[i],filterSize[i]);
+    }
 }
-  /**
+
+/**
         \fn     buildActiveFilterList(void)
         \brief  Build and display all active filters (may be empty)
 */
 void filtermainWindow::buildActiveFilterList(void)
 {
   VF_FILTERS fil;
+  
+  
   activeList->clear();
-  QColor colorGrey;
+  QColor colorGrey,colorWhite;
   colorGrey.setRgb(myBg,myBg,myBg);
+  colorWhite.setRgb(myFg,myFg,myFg);
   QBrush brush(colorGrey);
+  QBrush brushW(colorWhite);
 
   for (uint32_t i = 1; i < nb_active_filter; i++)
     {
@@ -429,6 +474,7 @@
                  str+= videofilters[i].filter->printConf ();
                  QListWidgetItem *item=new QListWidgetItem(str,activeList,ACTIVE_FILTER_BASE+i);
                  if(i&1) item->setBackground(brush);
+                        else item->setBackground(brushW);
                  activeList->addItem(item);
     }
     
@@ -438,40 +484,31 @@
   */
 filtermainWindow::filtermainWindow()     : QDialog()
  {
-      ui.setupUi(this);
+        memset( startFilter,0,sizeof(int)*NB_TREE);
+        memset( filterSize,0,sizeof(int)*NB_TREE);
+ 
+    ui.setupUi(this);
+    setupFilters();  
       
-#define ASSOCIATE(x,y)   allList[x]=ui.listWidget##y;
-      ASSOCIATE(0,Transform);
-      ASSOCIATE(1,Interlacing);
-      ASSOCIATE(2,Colors);
-      ASSOCIATE(3,Noise);
-      ASSOCIATE(4,Sharpness);
-      ASSOCIATE(5,Subtitles);
-      ASSOCIATE(6,Misc);
-      
-      activeList=ui.listWidgetActive;
-      
-      buildAvailableFilterList();
-      buildActiveFilterList();
-      
-      
-      
+    availableList=ui.listWidgetAvailable;
+    activeList=ui.listWidgetActive;
+    connect(ui.listFilterCategory,SIGNAL(itemDoubleClicked(QListWidgetItem *)),
+                this,SLOT(filterFamilyClick(QListWidgetItem *)));
+    connect(ui.listFilterCategory,SIGNAL(itemClicked(QListWidgetItem *)),
+                this,SLOT(filterFamilyClick(QListWidgetItem *)));
+
     connect(activeList,SIGNAL(itemDoubleClicked(QListWidgetItem *)),this,SLOT(activeDoubleClick(QListWidgetItem *)));
-    for(int i=0;i<NB_TREE;i++)
-    {
-      connect(allList[i],SIGNAL(itemDoubleClicked(QListWidgetItem *)),this,SLOT(allDoubleClick(QListWidgetItem *)));
-    }
-
+    connect(availableList,SIGNAL(itemDoubleClicked(QListWidgetItem *)),this,SLOT(allDoubleClick(QListWidgetItem *)));
+    
     connect((ui.toolButtonConfigure),SIGNAL(clicked(bool)),this,SLOT(configure(bool)));
     connect((ui.toolButtonAdd),SIGNAL(clicked(bool)),this,SLOT(add(bool)));
     connect((ui.pushButtonRemove),SIGNAL(clicked(bool)),this,SLOT(remove(bool)));
     connect((ui.toolButtonUp),SIGNAL(clicked(bool)),this,SLOT(up(bool)));
     connect((ui.toolButtonDown),SIGNAL(clicked(bool)),this,SLOT(down(bool)));
     connect(ui.buttonClose, SIGNAL(clicked(bool)), this, SLOT(accept()));
-    connect(ui.toolButtonPartial, SIGNAL(clicked(bool)), this, SLOT(partial(bool)));
-    
-    ui.tabWidgetSubtitles->setCurrentIndex(0);
-    
+   
+    displayFamily(0);
+    buildActiveFilterList(); 
  }
 /*******************************************************/
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/filter.qrc
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/filter.qrc	2007-02-18 09:26:40 UTC (rev 2828)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/filter.qrc	2007-02-18 15:37:43 UTC (rev 2829)
@@ -7,7 +7,16 @@
         <file>icons/5.png</file>
         <file>icons/6.png</file>
         <file>icons/7.png</file>
+        <file>icons/add.png</file>
+        <file>icons/cd.png</file>
+        <file>icons/close.png</file>
         <file>icons/down.png</file>
+        <file>icons/exec.png</file>
+        <file>icons/fileopen.png</file>
+        <file>icons/filesave.png</file>
+        <file>icons/filesaveas.png</file>
+        <file>icons/remove.png</file>
+        <file>icons/thumbnail.png</file>
         <file>icons/up.png</file>
     </qresource>
 </RCC>

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/down.png
===================================================================
(Binary files differ)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/up.png
===================================================================
(Binary files differ)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/mainfilter.ui
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/mainfilter.ui	2007-02-18 09:26:40 UTC (rev 2828)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/mainfilter.ui	2007-02-18 15:37:43 UTC (rev 2829)
@@ -5,111 +5,547 @@
    <rect>
     <x>0</x>
     <y>0</y>
-    <width>1024</width>
-    <height>650</height>
+    <width>913</width>
+    <height>545</height>
    </rect>
   </property>
+  <property name="minimumSize" >
+   <size>
+    <width>0</width>
+    <height>0</height>
+   </size>
+  </property>
   <property name="windowTitle" >
-   <string>Dialog</string>
+   <string>Video Filter Manager</string>
   </property>
-  <layout class="QGridLayout" >
+  <layout class="QVBoxLayout" >
    <property name="margin" >
     <number>9</number>
    </property>
    <property name="spacing" >
     <number>6</number>
    </property>
-   <item row="0" column="1" >
-    <widget class="QLabel" name="label_2" >
-     <property name="text" >
-      <string>&lt;big>&lt;b>Active Filters&lt;/b>&lt;/big></string>
-     </property>
-    </widget>
-   </item>
-   <item row="0" column="0" >
-    <widget class="QLabel" name="label" >
-     <property name="text" >
-      <string>&lt;big>&lt;b>Available Filters&lt;/b>&lt;/big></string>
-     </property>
-     <property name="textFormat" >
-      <enum>Qt::RichText</enum>
-     </property>
-    </widget>
-   </item>
-   <item row="2" column="0" >
-    <layout class="QHBoxLayout" >
+   <item>
+    <layout class="QGridLayout" >
      <property name="margin" >
       <number>0</number>
      </property>
      <property name="spacing" >
       <number>6</number>
      </property>
-     <item>
-      <spacer>
-       <property name="orientation" >
-        <enum>Qt::Horizontal</enum>
+     <item row="4" column="0" colspan="2" >
+      <layout class="QGridLayout" >
+       <property name="margin" >
+        <number>0</number>
        </property>
-       <property name="sizeHint" >
+       <property name="spacing" >
+        <number>6</number>
+       </property>
+       <item row="0" column="1" >
+        <widget class="QPushButton" name="pushButtonSVCD" >
+         <property name="sizePolicy" >
+          <sizepolicy>
+           <hsizetype>5</hsizetype>
+           <vsizetype>0</vsizetype>
+           <horstretch>0</horstretch>
+           <verstretch>0</verstretch>
+          </sizepolicy>
+         </property>
+         <property name="minimumSize" >
+          <size>
+           <width>72</width>
+           <height>0</height>
+          </size>
+         </property>
+         <property name="text" >
+          <string>&amp;SVCD res</string>
+         </property>
+         <property name="icon" >
+          <iconset resource="filter.qrc" >:/new/prefix1/icons/cd.png</iconset>
+         </property>
+        </widget>
+       </item>
+       <item row="1" column="1" >
+        <widget class="QPushButton" name="pushButtonVCD" >
+         <property name="sizePolicy" >
+          <sizepolicy>
+           <hsizetype>5</hsizetype>
+           <vsizetype>0</vsizetype>
+           <horstretch>0</horstretch>
+           <verstretch>0</verstretch>
+          </sizepolicy>
+         </property>
+         <property name="minimumSize" >
+          <size>
+           <width>72</width>
+           <height>0</height>
+          </size>
+         </property>
+         <property name="text" >
+          <string>&amp;VCD res</string>
+         </property>
+         <property name="icon" >
+          <iconset resource="filter.qrc" >:/new/prefix1/icons/cd.png</iconset>
+         </property>
+        </widget>
+       </item>
+       <item row="1" column="0" >
+        <widget class="QPushButton" name="pushButtonHalfDVD" >
+         <property name="sizePolicy" >
+          <sizepolicy>
+           <hsizetype>7</hsizetype>
+           <vsizetype>5</vsizetype>
+           <horstretch>0</horstretch>
+           <verstretch>0</verstretch>
+          </sizepolicy>
+         </property>
+         <property name="minimumSize" >
+          <size>
+           <width>72</width>
+           <height>0</height>
+          </size>
+         </property>
+         <property name="text" >
+          <string>&amp;Half D1 res</string>
+         </property>
+         <property name="icon" >
+          <iconset resource="filter.qrc" >:/new/prefix1/icons/cd.png</iconset>
+         </property>
+        </widget>
+       </item>
+       <item row="0" column="0" >
+        <widget class="QPushButton" name="pushButtonDVD" >
+         <property name="sizePolicy" >
+          <sizepolicy>
+           <hsizetype>5</hsizetype>
+           <vsizetype>0</vsizetype>
+           <horstretch>0</horstretch>
+           <verstretch>0</verstretch>
+          </sizepolicy>
+         </property>
+         <property name="minimumSize" >
+          <size>
+           <width>72</width>
+           <height>0</height>
+          </size>
+         </property>
+         <property name="text" >
+          <string>&amp;DVD res</string>
+         </property>
+         <property name="icon" >
+          <iconset resource="filter.qrc" >:/new/prefix1/icons/cd.png</iconset>
+         </property>
+        </widget>
+       </item>
+      </layout>
+     </item>
+     <item rowspan="4" row="1" column="2" colspan="2" >
+      <widget class="QListWidget" name="listWidgetAvailable" >
+       <property name="sizePolicy" >
+        <sizepolicy>
+         <hsizetype>7</hsizetype>
+         <vsizetype>7</vsizetype>
+         <horstretch>0</horstretch>
+         <verstretch>0</verstretch>
+        </sizepolicy>
+       </property>
+       <property name="minimumSize" >
         <size>
-         <width>40</width>
-         <height>20</height>
+         <width>340</width>
+         <height>0</height>
         </size>
        </property>
-      </spacer>
+       <property name="cursor" >
+        <cursor>13</cursor>
+       </property>
+       <property name="alternatingRowColors" >
+        <bool>true</bool>
+       </property>
+      </widget>
      </item>
-     <item>
-      <widget class="QToolButton" name="toolButtonAdd" >
-       <property name="text" >
-        <string>Add</string>
+     <item rowspan="3" row="1" column="0" colspan="2" >
+      <widget class="QListWidget" name="listFilterCategory" >
+       <property name="sizePolicy" >
+        <sizepolicy>
+         <hsizetype>0</hsizetype>
+         <vsizetype>7</vsizetype>
+         <horstretch>0</horstretch>
+         <verstretch>0</verstretch>
+        </sizepolicy>
        </property>
-       <property name="toolButtonStyle" >
-        <enum>Qt::ToolButtonTextUnderIcon</enum>
+       <property name="minimumSize" >
+        <size>
+         <width>100</width>
+         <height>340</height>
+        </size>
        </property>
+       <property name="cursor" >
+        <cursor>13</cursor>
+       </property>
+       <property name="mouseTracking" >
+        <bool>false</bool>
+       </property>
+       <property name="autoFillBackground" >
+        <bool>false</bool>
+       </property>
+       <property name="styleSheet" >
+        <string/>
+       </property>
+       <property name="alternatingRowColors" >
+        <bool>false</bool>
+       </property>
+       <property name="selectionMode" >
+        <enum>QAbstractItemView::SingleSelection</enum>
+       </property>
+       <property name="selectionBehavior" >
+        <enum>QAbstractItemView::SelectRows</enum>
+       </property>
+       <property name="iconSize" >
+        <size>
+         <width>24</width>
+         <height>24</height>
+        </size>
+       </property>
+       <property name="textElideMode" >
+        <enum>Qt::ElideRight</enum>
+       </property>
+       <property name="movement" >
+        <enum>QListView::Static</enum>
+       </property>
+       <property name="flow" >
+        <enum>QListView::TopToBottom</enum>
+       </property>
+       <property name="isWrapping" stdset="0" >
+        <bool>false</bool>
+       </property>
+       <property name="resizeMode" >
+        <enum>QListView::Adjust</enum>
+       </property>
+       <property name="layoutMode" >
+        <enum>QListView::SinglePass</enum>
+       </property>
+       <property name="spacing" >
+        <number>3</number>
+       </property>
+       <property name="viewMode" >
+        <enum>QListView::ListMode</enum>
+       </property>
+       <property name="modelColumn" >
+        <number>0</number>
+       </property>
+       <property name="uniformItemSizes" >
+        <bool>false</bool>
+       </property>
+       <property name="batchSize" >
+        <number>100</number>
+       </property>
+       <item>
+        <property name="text" >
+         <string>Transform</string>
+        </property>
+        <property name="icon" >
+         <iconset resource="filter.qrc" >:/new/prefix1/icons/1.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>Interlacing</string>
+        </property>
+        <property name="icon" >
+         <iconset resource="filter.qrc" >:/new/prefix1/icons/2.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>Colors</string>
+        </property>
+        <property name="icon" >
+         <iconset resource="filter.qrc" >:/new/prefix1/icons/4.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>Noise</string>
+        </property>
+        <property name="icon" >
+         <iconset resource="filter.qrc" >:/new/prefix1/icons/5.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>Sharpness</string>
+        </property>
+        <property name="icon" >
+         <iconset resource="filter.qrc" >:/new/prefix1/icons/3.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>Subtitles</string>
+        </property>
+        <property name="icon" >
+         <iconset resource="filter.qrc" >:/new/prefix1/icons/7.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>Miscellaneous</string>
+        </property>
+        <property name="icon" >
+         <iconset resource="filter.qrc" >:/new/prefix1/icons/6.png</iconset>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>External</string>
+        </property>
+        <property name="icon" >
+         <iconset resource="filter.qrc" >:/new/prefix1/icons/exec.png</iconset>
+        </property>
+       </item>
       </widget>
      </item>
-    </layout>
-   </item>
-   <item row="3" column="1" >
-    <layout class="QHBoxLayout" >
-     <property name="margin" >
-      <number>0</number>
-     </property>
-     <property name="spacing" >
-      <number>6</number>
-     </property>
-     <item>
+     <item row="1" column="4" >
       <spacer>
        <property name="orientation" >
         <enum>Qt::Horizontal</enum>
        </property>
+       <property name="sizeType" >
+        <enum>QSizePolicy::Fixed</enum>
+       </property>
        <property name="sizeHint" >
         <size>
-         <width>40</width>
+         <width>12</width>
          <height>20</height>
         </size>
        </property>
       </spacer>
      </item>
-     <item>
-      <widget class="QPushButton" name="pushButtonPreview" >
+     <item row="0" column="5" >
+      <widget class="QLabel" name="label_2" >
+       <property name="sizePolicy" >
+        <sizepolicy>
+         <hsizetype>5</hsizetype>
+         <vsizetype>4</vsizetype>
+         <horstretch>0</horstretch>
+         <verstretch>0</verstretch>
+        </sizepolicy>
+       </property>
        <property name="text" >
-        <string>Preview</string>
+        <string>&lt;big>&lt;b>Active Filters&lt;/b>&lt;/big></string>
        </property>
       </widget>
      </item>
-     <item>
-      <widget class="QPushButton" name="buttonClose" >
-       <property name="text" >
-        <string>Close</string>
+     <item rowspan="4" row="1" column="5" colspan="11" >
+      <widget class="QListWidget" name="listWidgetActive" >
+       <property name="sizePolicy" >
+        <sizepolicy>
+         <hsizetype>7</hsizetype>
+         <vsizetype>7</vsizetype>
+         <horstretch>0</horstretch>
+         <verstretch>0</verstretch>
+        </sizepolicy>
        </property>
-       <property name="default" >
+       <property name="minimumSize" >
+        <size>
+         <width>340</width>
+         <height>0</height>
+        </size>
+       </property>
+       <property name="cursor" >
+        <cursor>13</cursor>
+       </property>
+       <property name="alternatingRowColors" >
         <bool>true</bool>
        </property>
       </widget>
      </item>
+     <item row="5" column="5" colspan="11" >
+      <layout class="QHBoxLayout" >
+       <property name="margin" >
+        <number>0</number>
+       </property>
+       <property name="spacing" >
+        <number>6</number>
+       </property>
+       <item>
+        <spacer>
+         <property name="orientation" >
+          <enum>Qt::Horizontal</enum>
+         </property>
+         <property name="sizeHint" >
+          <size>
+           <width>0</width>
+           <height>22</height>
+          </size>
+         </property>
+        </spacer>
+       </item>
+       <item>
+        <widget class="QToolButton" name="toolButtonConfigure" >
+         <property name="sizePolicy" >
+          <sizepolicy>
+           <hsizetype>0</hsizetype>
+           <vsizetype>5</vsizetype>
+           <horstretch>0</horstretch>
+           <verstretch>0</verstretch>
+          </sizepolicy>
+         </property>
+         <property name="text" >
+          <string>C&amp;onfigure</string>
+         </property>
+        </widget>
+       </item>
+       <item>
+        <widget class="QToolButton" name="toolButtonPartial" >
+         <property name="sizePolicy" >
+          <sizepolicy>
+           <hsizetype>0</hsizetype>
+           <vsizetype>5</vsizetype>
+           <horstretch>0</horstretch>
+           <verstretch>0</verstretch>
+          </sizepolicy>
+         </property>
+         <property name="text" >
+          <string>P&amp;artial</string>
+         </property>
+        </widget>
+       </item>
+       <item>
+        <widget class="QToolButton" name="toolButtonLoad" >
+         <property name="text" >
+          <string>Load</string>
+         </property>
+         <property name="icon" >
+          <iconset resource="filter.qrc" >:/new/prefix1/icons/fileopen.png</iconset>
+         </property>
+        </widget>
+       </item>
+       <item>
+        <widget class="QToolButton" name="toolButtonSave" >
+         <property name="text" >
+          <string>Save</string>
+         </property>
+         <property name="icon" >
+          <iconset resource="filter.qrc" >:/new/prefix1/icons/filesave.png</iconset>
+         </property>
+        </widget>
+       </item>
+       <item>
+        <widget class="QToolButton" name="toolButtonSaveScript" >
+         <property name="text" >
+          <string>Save Script</string>
+         </property>
+         <property name="icon" >
+          <iconset resource="filter.qrc" >:/new/prefix1/icons/filesaveas.png</iconset>
+         </property>
+        </widget>
+       </item>
+       <item>
+        <widget class="QToolButton" name="toolButtonDown" >
+         <property name="text" >
+          <string>Down</string>
+         </property>
+         <property name="icon" >
+          <iconset resource="filter.qrc" >:/new/prefix1/icons/down.png</iconset>
+         </property>
+        </widget>
+       </item>
+       <item>
+        <widget class="QToolButton" name="toolButtonUp" >
+         <property name="text" >
+          <string>Up</string>
+         </property>
+         <property name="icon" >
+          <iconset resource="filter.qrc" >:/new/prefix1/icons/up.png</iconset>
+         </property>
+        </widget>
+       </item>
+       <item>
+        <widget class="QToolButton" name="pushButtonRemove" >
+         <property name="text" >
+          <string>Remove</string>
+         </property>
+         <property name="icon" >
+          <iconset resource="filter.qrc" >:/new/prefix1/icons/remove.png</iconset>
+         </property>
+        </widget>
+       </item>
+      </layout>
+     </item>
+     <item row="5" column="2" colspan="2" >
+      <layout class="QHBoxLayout" >
+       <property name="margin" >
+        <number>0</number>
+       </property>
+       <property name="spacing" >
+        <number>6</number>
+       </property>
+       <item>
+        <spacer>
+         <property name="orientation" >
+          <enum>Qt::Horizontal</enum>
+         </property>
+         <property name="sizeHint" >
+          <size>
+           <width>0</width>
+           <height>22</height>
+          </size>
+         </property>
+        </spacer>
+       </item>
+       <item>
+        <widget class="QToolButton" name="toolButtonAdd" >
+         <property name="text" >
+          <string>Add</string>
+         </property>
+         <property name="icon" >
+          <iconset resource="filter.qrc" >:/new/prefix1/icons/add.png</iconset>
+         </property>
+         <property name="toolButtonStyle" >
+          <enum>Qt::ToolButtonIconOnly</enum>
+         </property>
+        </widget>
+       </item>
+      </layout>
+     </item>
+     <item row="0" column="2" >
+      <widget class="QLabel" name="label" >
+       <property name="sizePolicy" >
+        <sizepolicy>
+         <hsizetype>5</hsizetype>
+         <vsizetype>4</vsizetype>
+         <horstretch>0</horstretch>
+         <verstretch>0</verstretch>
+        </sizepolicy>
+       </property>
+       <property name="text" >
+        <string>&lt;big>&lt;b>Available Filters&lt;/b>&lt;/big></string>
+       </property>
+       <property name="textFormat" >
+        <enum>Qt::RichText</enum>
+       </property>
+      </widget>
+     </item>
     </layout>
    </item>
-   <item row="2" column="1" >
+   <item>
+    <spacer>
+     <property name="orientation" >
+      <enum>Qt::Vertical</enum>
+     </property>
+     <property name="sizeType" >
+      <enum>QSizePolicy::Fixed</enum>
+     </property>
+     <property name="sizeHint" >
+      <size>
+       <width>707</width>
+       <height>16</height>
+      </size>
+     </property>
+    </spacer>
+   </item>
+   <item>
     <layout class="QHBoxLayout" >
      <property name="margin" >
       <number>0</number>
@@ -131,209 +567,30 @@
       </spacer>
      </item>
      <item>
-      <widget class="QToolButton" name="toolButtonConfigure" >
+      <widget class="QPushButton" name="pushButtonPreview" >
        <property name="text" >
-        <string>Configure</string>
+        <string>&amp;Preview</string>
        </property>
-      </widget>
-     </item>
-     <item>
-      <widget class="QToolButton" name="pushButtonRemove" >
-       <property name="text" >
-        <string>Remove</string>
+       <property name="icon" >
+        <iconset resource="filter.qrc" >:/new/prefix1/icons/thumbnail.png</iconset>
        </property>
       </widget>
      </item>
      <item>
-      <widget class="QToolButton" name="toolButtonPartial" >
+      <widget class="QPushButton" name="buttonClose" >
        <property name="text" >
-        <string>Partial</string>
+        <string>&amp;Close</string>
        </property>
-      </widget>
-     </item>
-     <item>
-      <widget class="QToolButton" name="toolButtonUp" >
-       <property name="text" >
-        <string>Up</string>
-       </property>
        <property name="icon" >
-        <iconset resource="filter.qrc" >:/new/prefix1/icons/up.png</iconset>
+        <iconset resource="filter.qrc" >:/new/prefix1/icons/close.png</iconset>
        </property>
-      </widget>
-     </item>
-     <item>
-      <widget class="QToolButton" name="toolButtonDown" >
-       <property name="text" >
-        <string>Down</string>
+       <property name="default" >
+        <bool>true</bool>
        </property>
-       <property name="icon" >
-        <iconset resource="filter.qrc" >:/new/prefix1/icons/down.png</iconset>
-       </property>
       </widget>
      </item>
     </layout>
    </item>
-   <item row="1" column="0" >
-    <widget class="QTabWidget" name="tabWidgetSubtitles" >
-     <property name="tabPosition" >
-      <enum>QTabWidget::North</enum>
-     </property>
-     <property name="tabShape" >
-      <enum>QTabWidget::Rounded</enum>
-     </property>
-     <property name="currentIndex" >
-      <number>5</number>
-     </property>
-     <property name="elideMode" >
-      <enum>Qt::ElideLeft</enum>
-     </property>
-     <widget class="QWidget" name="Transform" >
-      <attribute name="title" >
-       <string>Transfom</string>
-      </attribute>
-      <attribute name="icon" >
-       <iconset resource="filter.qrc" >:/new/prefix1/icons/1.png</iconset>
-      </attribute>
-      <layout class="QGridLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
-        <number>6</number>
-       </property>
-       <item row="0" column="0" >
-        <widget class="QListWidget" name="listWidgetTransform" />
-       </item>
-      </layout>
-     </widget>
-     <widget class="QWidget" name="Interlacing" >
-      <attribute name="title" >
-       <string>Interlacing</string>
-      </attribute>
-      <attribute name="icon" >
-       <iconset resource="filter.qrc" >:/new/prefix1/icons/2.png</iconset>
-      </attribute>
-      <attribute name="toolTip" >
-       <string>Interlacing</string>
-      </attribute>
-      <layout class="QGridLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
-        <number>6</number>
-       </property>
-       <item row="0" column="0" >
-        <widget class="QListWidget" name="listWidgetInterlacing" />
-       </item>
-      </layout>
-     </widget>
-     <widget class="QWidget" name="Colors" >
-      <attribute name="title" >
-       <string>Colors</string>
-      </attribute>
-      <attribute name="icon" >
-       <iconset resource="filter.qrc" >:/new/prefix1/icons/4.png</iconset>
-      </attribute>
-      <layout class="QGridLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
-        <number>6</number>
-       </property>
-       <item row="0" column="0" >
-        <widget class="QListWidget" name="listWidgetColors" />
-       </item>
-      </layout>
-     </widget>
-     <widget class="QWidget" name="Noise" >
-      <attribute name="title" >
-       <string>Noise</string>
-      </attribute>
-      <attribute name="icon" >
-       <iconset resource="filter.qrc" >:/new/prefix1/icons/5.png</iconset>
-      </attribute>
-      <layout class="QGridLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
-        <number>6</number>
-       </property>
-       <item row="0" column="0" >
-        <widget class="QListWidget" name="listWidgetNoise" />
-       </item>
-      </layout>
-     </widget>
-     <widget class="QWidget" name="Subtitles" >
-      <attribute name="title" >
-       <string>Sharpness</string>
-      </attribute>
-      <attribute name="icon" >
-       <iconset resource="filter.qrc" >:/new/prefix1/icons/3.png</iconset>
-      </attribute>
-      <attribute name="toolTip" >
-       <string>Sharpness</string>
-      </attribute>
-      <layout class="QGridLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
-        <number>6</number>
-       </property>
-       <item row="0" column="0" >
-        <widget class="QListWidget" name="listWidgetSharpness" />
-       </item>
-      </layout>
-     </widget>
-     <widget class="QWidget" name="Sharpness" >
-      <attribute name="title" >
-       <string>Subtitles</string>
-      </attribute>
-      <attribute name="icon" >
-       <iconset resource="filter.qrc" >:/new/prefix1/icons/7.png</iconset>
-      </attribute>
-      <attribute name="toolTip" >
-       <string>Subtitles</string>
-      </attribute>
-      <layout class="QGridLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
-        <number>6</number>
-       </property>
-       <item row="0" column="0" >
-        <widget class="QListWidget" name="listWidgetSubtitles" />
-       </item>
-      </layout>
-     </widget>
-     <widget class="QWidget" name="Misc" >
-      <attribute name="title" >
-       <string>Misc</string>
-      </attribute>
-      <attribute name="icon" >
-       <iconset resource="filter.qrc" >:/new/prefix1/icons/6.png</iconset>
-      </attribute>
-      <layout class="QGridLayout" >
-       <property name="margin" >
-        <number>9</number>
-       </property>
-       <property name="spacing" >
-        <number>6</number>
-       </property>
-       <item row="0" column="0" >
-        <widget class="QListWidget" name="listWidgetMisc" />
-       </item>
-      </layout>
-     </widget>
-    </widget>
-   </item>
-   <item row="1" column="1" >
-    <widget class="QListWidget" name="listWidgetActive" />
-   </item>
   </layout>
  </widget>
  <resources>



From mean at mail.berlios.de  Sun Feb 18 17:17:58 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 18 Feb 2007 17:17:58 +0100
Subject: [Avidemux-svn-commit] r2830 - in branches/avidemux_2.4_branch:
	autononreg/dialogFactory avidemux/ADM_script
	avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog
	avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog
	avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory
	avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui
Message-ID: <200702181617.l1IGHwrb000437@sheep.berlios.de>

Author: mean
Date: 2007-02-18 17:17:57 +0100 (Sun, 18 Feb 2007)
New Revision: 2830

Added:
   branches/avidemux_2.4_branch/autononreg/dialogFactory/bar.js
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bar.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h
Log:
bar for dialogFactory/QT4

Copied: branches/avidemux_2.4_branch/autononreg/dialogFactory/bar.js (from rev 2822, branches/avidemux_2.4_branch/autononreg/dialogFactory/bitrate.js)
===================================================================
--- branches/avidemux_2.4_branch/autononreg/dialogFactory/bitrate.js	2007-02-14 20:46:44 UTC (rev 2822)
+++ branches/avidemux_2.4_branch/autononreg/dialogFactory/bar.js	2007-02-18 16:17:57 UTC (rev 2830)
@@ -0,0 +1,10 @@
+//AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
+var app = new Avidemux();
+var file="/work/samples/2mn.avi";
+var goodfcc="DIV3";
+var fps;
+
+	dialogFactoryBar();
+
+/* End of test
+*/

Modified: branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp	2007-02-18 15:37:43 UTC (rev 2829)
+++ branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp	2007-02-18 16:17:57 UTC (rev 2830)
@@ -73,6 +73,7 @@
 JSBool facMenu(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool facFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool facBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
+JSBool facBar(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 
 
 static JSFunctionSpec adm_functions[] = {
@@ -96,6 +97,7 @@
   {"dialogFactoryMenu",         facMenu,        0},
   {"dialogFactoryFileSel",      facFile,        0},
   {"dialogFactoryBitrate",      facBitrate,        0},
+  {"dialogFactoryBar",          facBar,        0},
   {0}
 };
 
@@ -588,5 +590,20 @@
   
   return JS_TRUE;
 }
+JSBool facBar(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    
+      diaElemBar bar1(25,"25");
+      diaElemBar bar2(65,"65");
+      diaElem *elems[]={&bar1,&bar2   };
+  if(diaFactoryRun("Test FileRead",2,elems))
+  {
+    *rval = BOOLEAN_TO_JSVAL(1);
+    
+  }else
+    *rval = BOOLEAN_TO_JSVAL(0);
+  
+  return JS_TRUE;
+}
 
 //EOF 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2007-02-18 15:37:43 UTC (rev 2829)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2007-02-18 16:17:57 UTC (rev 2830)
@@ -119,7 +119,6 @@
 void DIA_Calculator(uint32_t *sizeInMeg, uint32_t *avgBitrate ){return ;}
 uint8_t DIA_gotoTime(uint16_t *hh, uint16_t *mm, uint16_t *ss){return 0;}
 void DIA_properties( void){return ;}
-void  GUI_displayBitrate( void ){return ;}
 int GUI_handleVFilter (void){return 0;}
 uint8_t  initFileSelector(void){return 0;}
 uint8_t initGUI( void ){return 1;}

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-02-18 15:37:43 UTC (rev 2829)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-02-18 16:17:57 UTC (rev 2830)
@@ -117,7 +117,6 @@
 uint8_t DIA_about( void ){return 0;}
 void DIA_Calculator(uint32_t *sizeInMeg, uint32_t *avgBitrate ){return ;}
 uint8_t DIA_gotoTime(uint16_t *hh, uint16_t *mm, uint16_t *ss){return 0;}
-void  GUI_displayBitrate( void ){return ;}
 //int GUI_handleVFilter (void){return 0;}
 uint8_t  initFileSelector(void){return 0;}
 uint8_t initGUI( void ){return 1;}

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bar.cpp (from rev 2818, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_integer.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_integer.cpp	2007-02-13 19:16:54 UTC (rev 2818)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bar.cpp	2007-02-18 16:17:57 UTC (rev 2830)
@@ -0,0 +1,72 @@
+/***************************************************************************
+  FAC_toggle.cpp
+  Handle dialog factory element : Toggle
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <config.h>
+
+
+#include <string.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <math.h>
+
+#include <QDialog>
+#include <QSpinBox>
+#include <QGridLayout>
+#include <QLabel>
+#include <QProgressBar>
+
+#include "default.h"
+#include "ADM_commonUI/DIA_factory.h"
+#include "ADM_assert.h"
+
+
+extern const char *shortkey(const char *);
+
+
+
+//********************************************************************
+diaElemBar::diaElemBar(uint32_t percent,const char *toggleTitle)
+  : diaElem(ELEM_BAR)
+{
+  per=percent;
+  paramTitle=shortkey(toggleTitle);
+ }
+
+diaElemBar::~diaElemBar()
+{
+  if(paramTitle)
+    delete paramTitle;
+}
+void diaElemBar::setMe(void *dialog, void *opaque,uint32_t line)
+{
+  QProgressBar *box=new QProgressBar((QWidget *)dialog);
+  QGridLayout *layout=(QGridLayout*) opaque;
+ 
+  box->setMinimum(0);
+  box->setMaximum(100);
+  box->setValue(per);
+  box->show();
+ 
+ QLabel *text=new QLabel( this->paramTitle,(QWidget *)dialog);
+ text->setBuddy(box);
+ layout->addWidget(text,line,0);
+ layout->addWidget(box,line,1);
+ 
+}
+void diaElemBar::getMe(void)
+{
+}
+
+//EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-18 15:37:43 UTC (rev 2829)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-18 16:17:57 UTC (rev 2830)
@@ -3,7 +3,7 @@
 
 libADM_dialogFactory_a_METASOURCES = AUTO
 
-libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp FAC_filesel.cpp FAC_bitrate.cpp
+libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp FAC_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp
 
 
 INCLUDES = $(all_includes)  $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h	2007-02-18 15:37:43 UTC (rev 2829)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h	2007-02-18 16:17:57 UTC (rev 2830)
@@ -38,7 +38,7 @@
 PROCESS(actionFilters_2,ACT_DUMMY) \
 PROCESS(actionCalculator,ACT_DUMMY) \
 PROCESS(actionRebuild_I_B_Frames,ACT_RebuildKF) \
-PROCESS(actionBitrate_histogram,ACT_DUMMY) \
+PROCESS(actionBitrate_histogram,ACT_BitRate) \
 PROCESS(actionScan_for_black_frames,ACT_AllBlackFrames) \
 PROCESS(actionVob_to_vobsub,ACT_DUMMY) \
 PROCESS(actionOCR,ACT_Ocr) \



From mean at mail.berlios.de  Sun Feb 18 17:18:35 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 18 Feb 2007 17:18:35 +0100
Subject: [Avidemux-svn-commit] r2831 - branches/avidemux_2.4_branch
Message-ID: <200702181618.l1IGIZEX000475@sheep.berlios.de>

Author: mean
Date: 2007-02-18 17:18:35 +0100 (Sun, 18 Feb 2007)
New Revision: 2831

Modified:
   branches/avidemux_2.4_branch/configure.in.in
Log:
grunster/win32

Modified: branches/avidemux_2.4_branch/configure.in.in
===================================================================
--- branches/avidemux_2.4_branch/configure.in.in	2007-02-18 16:17:57 UTC (rev 2830)
+++ branches/avidemux_2.4_branch/configure.in.in	2007-02-18 16:18:35 UTC (rev 2831)
@@ -232,7 +232,7 @@
 case $host in
   MINGW32*)
     AC_MSG_NOTICE(MinGW detected.)
-    QTLIBS="-L$QTEXTRALIB -lopengl32 -lglu32 -lgdi32 -luser32 -lmingw32 -lqtmain -lQtOpenGL4 -lQtGui4 -lQtCore4 -mthreads -Wl,-enable-stdcall-fixup -Wl,-enable-auto-import -Wl,-enable-runtime-pseudo-reloc -Wl,-s -Wl,-s -Wl,-subsystem,windows"
+    QTLIBS="-L$QTEXTRALIB -lopengl32 -lglu32 -lgdi32 -luser32 -lmingw32 -lqtmain -lQtOpenGL4 -lQtGui4 -lQtCore4 -mthreads -Wl,-enable-stdcall-fixup -Wl,-enable-auto-import -Wl,-enable-runtime-pseudo-reloc -Wl,-subsystem,windows"
     QTINC="-I$QTDIR/include -I$QTDIR/include/QtCore -I$QTDIR/include/QtGui -I$QTDIR/include/QtOpenGL -DUNICODE -DQT_LARGEFILE_SUPPORT -DQT_DLL -DQT_NO_DEBUG -DQT_OPENGL_LIB -DQT_GUI_LIB -DQT_CORE_LIB -DQT_THREAD_SUPPORT -DQT_NEEDS_QMAIN -frtti -fexceptions -I$QTEXTRAINC"
     QTBIN="$QTDIR/bin"
 	QTPOSTFIX=""
@@ -428,7 +428,7 @@
 
 dnl _____________ needed for multithreaded x264 and for mplex_________
 if test "x$use_cygwin" = "xyes"; then
-        LIBS="$LIBS -lpthreadGC1"
+        LIBS="$LIBS -lpthreadGC1 -Wl,-s"
 else
         LDFLAGS="$LDFLAGS -lpthread -lX11 -lXext -L/usr/X11R6/lib"
 fi



From mean at mail.berlios.de  Sun Feb 18 18:53:57 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 18 Feb 2007 18:53:57 +0100
Subject: [Avidemux-svn-commit] r2832 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory
Message-ID: <200702181753.l1IHrvm5013095@sheep.berlios.de>

Author: mean
Date: 2007-02-18 18:53:57 +0100 (Sun, 18 Feb 2007)
New Revision: 2832

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bar.cpp
Log:
forgot one file

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bar.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bar.cpp	2007-02-18 16:18:35 UTC (rev 2831)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_bar.cpp	2007-02-18 17:53:57 UTC (rev 2832)
@@ -0,0 +1,76 @@
+/***************************************************************************
+  FAC_bar.cpp
+  Handle dialog factory element : Toggle
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <config.h>
+
+
+#include <string.h>
+#include <stdio.h>
+#include <math.h>
+
+#include "default.h"
+#include "ADM_toolkit_gtk/ADM_gladeSupport.h"
+#include "ADM_toolkit_gtk/toolkit_gtk.h"
+#include "ADM_toolkit_gtk/toolkit_gtk_include.h"
+#include "ADM_commonUI/DIA_factory.h"
+#include "ADM_assert.h"
+
+
+diaElemBar::diaElemBar(uint32_t percent,const char *toggleTitle)
+  : diaElem(ELEM_BAR)
+{
+  per=percent;
+  paramTitle=ADM_strdup(toggleTitle);
+}
+
+diaElemBar::~diaElemBar()
+{
+  ADM_dealloc(paramTitle);
+}
+void diaElemBar::setMe(void *dialog, void *opaque,uint32_t line)
+{
+  GtkWidget *widget;
+  GtkWidget *label;
+  GtkWidget *bar;
+  
+  label = gtk_label_new_with_mnemonic (paramTitle);
+  gtk_misc_set_alignment (GTK_MISC (label), 0.0, 0.5);
+  gtk_widget_show(label);
+  
+  gtk_table_attach (GTK_TABLE (opaque), label, 0, 1, line, line+1,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  
+  
+   bar = gtk_progress_bar_new ();
+   gtk_widget_show (bar);
+   gfloat p;
+   p=per;
+   p=p/100.;
+   gtk_progress_set_percentage(GTK_PROGRESS(bar),p);
+
+  
+  gtk_table_attach (GTK_TABLE (opaque), bar, 1, 2, line, line+1,
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  
+  
+}
+void diaElemBar::getMe(void)
+{
+  
+}
+
+//EOF



From mean at mail.berlios.de  Sun Feb 18 21:13:43 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 18 Feb 2007 21:13:43 +0100
Subject: [Avidemux-svn-commit] r2833 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons
Message-ID: <200702182013.l1IKDhrB031317@sheep.berlios.de>

Author: mean
Date: 2007-02-18 21:13:42 +0100 (Sun, 18 Feb 2007)
New Revision: 2833

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/add.png
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/cd.png
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/close.png
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/exec.png
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/fileopen.png
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/filesave.png
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/filesaveas.png
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/remove.png
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/thumbnail.png
Log:
icons

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/add.png
===================================================================
(Binary files differ)


Property changes on: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/add.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/cd.png
===================================================================
(Binary files differ)


Property changes on: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/cd.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/close.png
===================================================================
(Binary files differ)


Property changes on: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/close.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/exec.png
===================================================================
(Binary files differ)


Property changes on: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/exec.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/fileopen.png
===================================================================
(Binary files differ)


Property changes on: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/fileopen.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/filesave.png
===================================================================
(Binary files differ)


Property changes on: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/filesave.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/filesaveas.png
===================================================================
(Binary files differ)


Property changes on: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/filesaveas.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/remove.png
===================================================================
(Binary files differ)


Property changes on: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/remove.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/thumbnail.png
===================================================================
(Binary files differ)


Property changes on: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/icons/thumbnail.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From mean at mail.berlios.de  Mon Feb 19 20:14:51 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 19 Feb 2007 20:14:51 +0100
Subject: [Avidemux-svn-commit] r2834 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory
Message-ID: <200702191914.l1JJEpCK016625@sheep.berlios.de>

Author: mean
Date: 2007-02-19 20:14:51 +0100 (Mon, 19 Feb 2007)
New Revision: 2834

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp
Log:
temporary

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp	2007-02-18 20:13:42 UTC (rev 2833)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp	2007-02-19 19:14:51 UTC (rev 2834)
@@ -24,31 +24,89 @@
 #include <QDialog>
 #include <QMessageBox>
 #include <QGridLayout>
-#include <QCheckBox>
+#include <QLineEdit>
+#include <QLabel>
+#include <QDialogButtonBox>
 
 #include "default.h"
 #include "ADM_commonUI/DIA_factory.h"
 #include "ADM_assert.h"
 
+extern const char *shortkey(const char *);
 
+
+class  ADM_Qfilesel : public QWidget
+{
+     Q_OBJECT
+    
+  signals:
+        
+        
+   public slots:
+        
+  public:
+        QLineEdit *edit;
+        QDialogButtonBox *button;
+        QLabel *text;
+            
+        ADM_Qfilesel(QWidget *z,const char *title,char *entry,QGridLayout *layout,int line) : QWidget(z) 
+        {
+          
+  
+          edit=new QLineEdit(entry,z);
+          
+          edit->show();
+          
+          button=new QDialogButtonBox(QDialogButtonBox::Open,Qt::Horizontal,z);
+          button->show();
+          
+        
+        
+          text=new QLabel( title,z);
+          text->setBuddy(edit);
+          layout->addWidget(text,line,0);
+          layout->addWidget(edit,line,1);
+          layout->addWidget(button,line,2);
+          //QObject::connect(&button, SIGNAL(accepted()), NULL, SLOT(accept())); 
+        }
+        ~ADM_Qfilesel() 
+            {
+                if(edit) delete edit;
+                if(button) delete button;
+                if(text) delete text;
+            };
+};
+
+
 diaElemFileRead::diaElemFileRead(char **filename,const char *toggleTitle,const char *tip)
   : diaElem(ELEM_FILE_READ)
 {
- 
+  param=(void *)filename;
+  paramTitle=shortkey(toggleTitle);
+  this->tip=tip;
 }
 
 diaElemFileRead::~diaElemFileRead()
 {
-  
+  if(paramTitle)
+    delete paramTitle;
 }
 void diaElemFileRead::setMe(void *dialog, void *opaque,uint32_t line)
 {
- 
+ QGridLayout *layout=(QGridLayout*) opaque;
   
+  ADM_Qfilesel *fs=new ADM_Qfilesel((QWidget *)dialog,paramTitle,*(char **)param,layout, line);
+  myWidget=(void *)fs; 
 }
 void diaElemFileRead::getMe(void)
 {
- 
+  
+  char **n=(char **)param;
+  if(*n) ADM_dealloc(*n);
+  
+  ADM_Qfilesel *fs=(ADM_Qfilesel *)myWidget;
+  QString s=(fs->edit)->text();
+  *n=ADM_strdup( s.toLatin1() );
 }
 
 //EOF



From mean at mail.berlios.de  Mon Feb 19 20:18:14 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 19 Feb 2007 20:18:14 +0100
Subject: [Avidemux-svn-commit] r2835 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory
Message-ID: <200702191918.l1JJIEoT017131@sheep.berlios.de>

Author: mean
Date: 2007-02-19 20:18:14 +0100 (Mon, 19 Feb 2007)
New Revision: 2835

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Q_filesel.cpp
Removed:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
Log:
oops

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp	2007-02-19 19:14:51 UTC (rev 2834)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp	2007-02-19 19:18:14 UTC (rev 2835)
@@ -1,113 +0,0 @@
-/***************************************************************************
-  FAC_toggle.cpp
-  Handle dialog factory element : Toggle
-  (C) 2006 Mean Fixounet at free.fr 
-***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include <config.h>
-
-
-#include <string.h>
-#include <stdio.h>
-#include <stdlib.h>
-#include <math.h>
-
-#include <QDialog>
-#include <QMessageBox>
-#include <QGridLayout>
-#include <QLineEdit>
-#include <QLabel>
-#include <QDialogButtonBox>
-
-#include "default.h"
-#include "ADM_commonUI/DIA_factory.h"
-#include "ADM_assert.h"
-
-extern const char *shortkey(const char *);
-
-
-class  ADM_Qfilesel : public QWidget
-{
-     Q_OBJECT
-    
-  signals:
-        
-        
-   public slots:
-        
-  public:
-        QLineEdit *edit;
-        QDialogButtonBox *button;
-        QLabel *text;
-            
-        ADM_Qfilesel(QWidget *z,const char *title,char *entry,QGridLayout *layout,int line) : QWidget(z) 
-        {
-          
-  
-          edit=new QLineEdit(entry,z);
-          
-          edit->show();
-          
-          button=new QDialogButtonBox(QDialogButtonBox::Open,Qt::Horizontal,z);
-          button->show();
-          
-        
-        
-          text=new QLabel( title,z);
-          text->setBuddy(edit);
-          layout->addWidget(text,line,0);
-          layout->addWidget(edit,line,1);
-          layout->addWidget(button,line,2);
-          //QObject::connect(&button, SIGNAL(accepted()), NULL, SLOT(accept())); 
-        }
-        ~ADM_Qfilesel() 
-            {
-                if(edit) delete edit;
-                if(button) delete button;
-                if(text) delete text;
-            };
-};
-
-
-diaElemFileRead::diaElemFileRead(char **filename,const char *toggleTitle,const char *tip)
-  : diaElem(ELEM_FILE_READ)
-{
-  param=(void *)filename;
-  paramTitle=shortkey(toggleTitle);
-  this->tip=tip;
-}
-
-diaElemFileRead::~diaElemFileRead()
-{
-  if(paramTitle)
-    delete paramTitle;
-}
-void diaElemFileRead::setMe(void *dialog, void *opaque,uint32_t line)
-{
- QGridLayout *layout=(QGridLayout*) opaque;
-  
-  ADM_Qfilesel *fs=new ADM_Qfilesel((QWidget *)dialog,paramTitle,*(char **)param,layout, line);
-  myWidget=(void *)fs; 
-}
-void diaElemFileRead::getMe(void)
-{
-  
-  char **n=(char **)param;
-  if(*n) ADM_dealloc(*n);
-  
-  ADM_Qfilesel *fs=(ADM_Qfilesel *)myWidget;
-  QString s=(fs->edit)->text();
-  *n=ADM_strdup( s.toLatin1() );
-}
-
-//EOF
-

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-19 19:14:51 UTC (rev 2834)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-19 19:18:14 UTC (rev 2835)
@@ -3,7 +3,7 @@
 
 libADM_dialogFactory_a_METASOURCES = AUTO
 
-libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp FAC_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp
+libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp AQ_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp
 
 
 INCLUDES = $(all_includes)  $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Q_filesel.cpp (from rev 2834, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_filesel.cpp)



From mean at mail.berlios.de  Mon Feb 19 20:28:44 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 19 Feb 2007 20:28:44 +0100
Subject: [Avidemux-svn-commit] r2836 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory
Message-ID: <200702191928.l1JJSitP018160@sheep.berlios.de>

Author: mean
Date: 2007-02-19 20:28:43 +0100 (Mon, 19 Feb 2007)
New Revision: 2836

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_filesel.cpp
Removed:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Q_filesel.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
Log:
fileselector dialogFactory/QT4

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-19 19:18:14 UTC (rev 2835)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-19 19:28:43 UTC (rev 2836)
@@ -3,7 +3,7 @@
 
 libADM_dialogFactory_a_METASOURCES = AUTO
 
-libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp AQ_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp
+libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp AT_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp
 
 
 INCLUDES = $(all_includes)  $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Q_filesel.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Q_filesel.cpp	2007-02-19 19:18:14 UTC (rev 2835)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Q_filesel.cpp	2007-02-19 19:28:43 UTC (rev 2836)
@@ -1,113 +0,0 @@
-/***************************************************************************
-  FAC_toggle.cpp
-  Handle dialog factory element : Toggle
-  (C) 2006 Mean Fixounet at free.fr 
-***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include <config.h>
-
-
-#include <string.h>
-#include <stdio.h>
-#include <stdlib.h>
-#include <math.h>
-
-#include <QDialog>
-#include <QMessageBox>
-#include <QGridLayout>
-#include <QLineEdit>
-#include <QLabel>
-#include <QDialogButtonBox>
-
-#include "default.h"
-#include "ADM_commonUI/DIA_factory.h"
-#include "ADM_assert.h"
-
-extern const char *shortkey(const char *);
-
-
-class  ADM_Qfilesel : public QWidget
-{
-     Q_OBJECT
-    
-  signals:
-        
-        
-   public slots:
-        
-  public:
-        QLineEdit *edit;
-        QDialogButtonBox *button;
-        QLabel *text;
-            
-        ADM_Qfilesel(QWidget *z,const char *title,char *entry,QGridLayout *layout,int line) : QWidget(z) 
-        {
-          
-  
-          edit=new QLineEdit(entry,z);
-          
-          edit->show();
-          
-          button=new QDialogButtonBox(QDialogButtonBox::Open,Qt::Horizontal,z);
-          button->show();
-          
-        
-        
-          text=new QLabel( title,z);
-          text->setBuddy(edit);
-          layout->addWidget(text,line,0);
-          layout->addWidget(edit,line,1);
-          layout->addWidget(button,line,2);
-          //QObject::connect(&button, SIGNAL(accepted()), NULL, SLOT(accept())); 
-        }
-        ~ADM_Qfilesel() 
-            {
-                if(edit) delete edit;
-                if(button) delete button;
-                if(text) delete text;
-            };
-};
-
-
-diaElemFileRead::diaElemFileRead(char **filename,const char *toggleTitle,const char *tip)
-  : diaElem(ELEM_FILE_READ)
-{
-  param=(void *)filename;
-  paramTitle=shortkey(toggleTitle);
-  this->tip=tip;
-}
-
-diaElemFileRead::~diaElemFileRead()
-{
-  if(paramTitle)
-    delete paramTitle;
-}
-void diaElemFileRead::setMe(void *dialog, void *opaque,uint32_t line)
-{
- QGridLayout *layout=(QGridLayout*) opaque;
-  
-  ADM_Qfilesel *fs=new ADM_Qfilesel((QWidget *)dialog,paramTitle,*(char **)param,layout, line);
-  myWidget=(void *)fs; 
-}
-void diaElemFileRead::getMe(void)
-{
-  
-  char **n=(char **)param;
-  if(*n) ADM_dealloc(*n);
-  
-  ADM_Qfilesel *fs=(ADM_Qfilesel *)myWidget;
-  QString s=(fs->edit)->text();
-  *n=ADM_strdup( s.toLatin1() );
-}
-
-//EOF
-

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_filesel.cpp (from rev 2835, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Q_filesel.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Q_filesel.cpp	2007-02-19 19:18:14 UTC (rev 2835)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_filesel.cpp	2007-02-19 19:28:43 UTC (rev 2836)
@@ -0,0 +1,124 @@
+/***************************************************************************
+  FAC_toggle.cpp
+  Handle dialog factory element : Toggle
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <config.h>
+
+
+#include <string.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <math.h>
+
+#include <QDialog>
+#include <QMessageBox>
+#include <QGridLayout>
+#include <QLineEdit>
+#include <QLabel>
+#include <QDialogButtonBox>
+
+#include "default.h"
+#include "ADM_commonUI/DIA_factory.h"
+#include "ADM_assert.h"
+
+extern const char *shortkey(const char *);
+void GUI_FileSelRead(const char *label, char * * name);
+
+class  ADM_Qfilesel : public QWidget
+{
+     Q_OBJECT
+    
+  signals:
+        
+        
+   public slots:
+        void buttonPressed(QAbstractButton *s)
+        { 
+          char *n;
+          GUI_FileSelRead("Select file", &n);
+          if(n)
+          {
+            edit->setText(n);
+            ADM_dealloc(n); 
+          }
+          
+        }
+  public:
+        QLineEdit *edit;
+        QDialogButtonBox *button;
+        QLabel *text;
+            
+        ADM_Qfilesel(QWidget *z,const char *title,char *entry,QGridLayout *layout,int line) : QWidget(z) 
+        {
+          
+  
+          edit=new QLineEdit(entry,z);
+          
+          edit->show();
+          
+          button=new QDialogButtonBox(QDialogButtonBox::Open,Qt::Horizontal,z);
+          button->show();
+          
+        
+        
+          text=new QLabel( title,z);
+          text->setBuddy(edit);
+          layout->addWidget(text,line,0);
+          layout->addWidget(edit,line,1);
+          layout->addWidget(button,line,2);
+          //QObject::connect(&button, SIGNAL(accepted()), NULL, SLOT(accept())); 
+          connect( button,SIGNAL(clicked(QAbstractButton  *)),this,SLOT(buttonPressed(QAbstractButton  *)));
+        }
+        ~ADM_Qfilesel() 
+            {
+                if(edit) delete edit;
+                if(button) delete button;
+                if(text) delete text;
+            };
+};
+
+
+diaElemFileRead::diaElemFileRead(char **filename,const char *toggleTitle,const char *tip)
+  : diaElem(ELEM_FILE_READ)
+{
+  param=(void *)filename;
+  paramTitle=shortkey(toggleTitle);
+  this->tip=tip;
+}
+
+diaElemFileRead::~diaElemFileRead()
+{
+  if(paramTitle)
+    delete paramTitle;
+}
+void diaElemFileRead::setMe(void *dialog, void *opaque,uint32_t line)
+{
+ QGridLayout *layout=(QGridLayout*) opaque;
+  
+  ADM_Qfilesel *fs=new ADM_Qfilesel((QWidget *)dialog,paramTitle,*(char **)param,layout, line);
+  myWidget=(void *)fs; 
+}
+void diaElemFileRead::getMe(void)
+{
+  
+  char **n=(char **)param;
+  if(*n) ADM_dealloc(*n);
+  
+  ADM_Qfilesel *fs=(ADM_Qfilesel *)myWidget;
+  QString s=(fs->edit)->text();
+  *n=ADM_strdup( s.toLatin1() );
+}
+
+//EOF
+



From mean at mail.berlios.de  Tue Feb 20 21:02:47 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 20 Feb 2007 21:02:47 +0100
Subject: [Avidemux-svn-commit] r2837 - in
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4:
	ADM_dialog ADM_dialogFactory ADM_gui
Message-ID: <200702202002.l1KK2lWs029340@sheep.berlios.de>

Author: mean
Date: 2007-02-20 21:02:46 +0100 (Tue, 20 Feb 2007)
New Revision: 2837

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_bitrate.cpp
Removed:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bitrate.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_dialogFactory.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_filesel.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h
Log:
bitrate widget for dialogFactory/QT4, crashing svn status | grep -v ^?

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-02-19 19:28:43 UTC (rev 2836)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-02-20 20:02:46 UTC (rev 2837)
@@ -82,7 +82,6 @@
 uint8_t DIA_animated(ANIMATED_PARAM *param){return 0;}
 uint8_t DIA_rotate(AVDMGenericVideoStream *astream,ROTATE_PARAM *param){return 0;}
 uint8_t DIA_cnr2(CNR2Param *param){return 0;}
-uint8_t DIA_DVDffParam(COMPRES_PARAMS *incoming){return 0;}
 uint8_t DIA_getASharp(ASHARP_PARAM *param, AVDMGenericVideoStream *in){return 0;}
 uint8_t DIA_getEQ2Param(Eq2_Param *param, AVDMGenericVideoStream *in){return 0;}
 uint8_t DIA_getEqualizer(EqualizerParam *param, ADMImage *image){return 0;}
@@ -95,7 +94,6 @@
 uint8_t DIA_pipe(char **cmd,char **param){return 0;}
 uint8_t DIA_requant(COMPRES_PARAMS *incoming){return 0;}
 uint8_t  DIA_setUserMuxParam( int *mode, int *param, int *muxsize){return 0;}
-uint8_t DIA_SVCDParam(COMPRES_PARAMS *incoming){return 0;}
 uint8_t  DIA_tdeint(TDEINT_PARAM *param){return 0;}
 uint8_t DIA_vobsub(vobSubParam *param){return 0;}
 uint8_t DIA_x264(COMPRES_PARAMS *config){return 0;}

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bitrate.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bitrate.cpp	2007-02-19 19:28:43 UTC (rev 2836)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bitrate.cpp	2007-02-20 20:02:46 UTC (rev 2837)
@@ -1,55 +0,0 @@
-/***************************************************************************
-  FAC_toggle.cpp
-  Handle dialog factory element : Toggle
-  (C) 2006 Mean Fixounet at free.fr 
-***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include <config.h>
-
-
-#include <string.h>
-#include <stdio.h>
-#include <stdlib.h>
-#include <math.h>
-
-#include <QDialog>
-#include <QMessageBox>
-#include <QGridLayout>
-#include <QCheckBox>
-
-#include "default.h"
-#include "ADM_commonUI/DIA_factory.h"
-#include "ADM_assert.h"
-
-
-diaElemBitrate::diaElemBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip)
-  : diaElem(ELEM_BITRATE)
-{
- 
-}
-
-diaElemBitrate::~diaElemBitrate()
-{
-  
-}
-void diaElemBitrate::setMe(void *dialog, void *opaque,uint32_t line)
-{
- 
-  
-}
-void diaElemBitrate::getMe(void)
-{
- 
-}
-
-//EOF
-

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-19 19:28:43 UTC (rev 2836)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-20 20:02:46 UTC (rev 2837)
@@ -3,7 +3,7 @@
 
 libADM_dialogFactory_a_METASOURCES = AUTO
 
-libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp AT_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp
+libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp AT_filesel.cpp AT_bitrate.cpp FAC_bar.cpp
 
 
 INCLUDES = $(all_includes)  $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_bitrate.cpp (from rev 2822, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bitrate.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_bitrate.cpp	2007-02-14 20:46:44 UTC (rev 2822)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_bitrate.cpp	2007-02-20 20:02:46 UTC (rev 2837)
@@ -0,0 +1,180 @@
+/***************************************************************************
+  FAC_toggle.cpp
+  Handle dialog factory element : Toggle
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <config.h>
+
+
+#include <string.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <math.h>
+
+#include <QDialog>
+#include <QMessageBox>
+#include <QGridLayout>
+#include <QSpinBox>
+#include <QComboBox>
+#include <QLabel>
+
+#include "default.h"
+#include "ADM_commonUI/DIA_factory.h"
+#include "ADM_assert.h"
+
+extern const char *shortkey(const char *);
+
+class  ADM_Qbitrate : public QWidget
+{
+     Q_OBJECT
+    
+  signals:
+        
+        
+   public slots:
+        void comboChanged(int i);
+  public:
+        QSpinBox        *box;
+        QComboBox       *combo;
+        QLabel          *text1;
+        QLabel          *text2;
+        COMPRES_PARAMS  *compress;
+        
+        ADM_Qbitrate(QWidget *z,COMPRES_PARAMS *p,QGridLayout *layout,int line) : QWidget(z) 
+        {
+          
+           compress=p;
+           combo=new QComboBox(z);
+           
+#define add(x) combo->addItem(#x)
+  
+  add(Constant Bitrate);
+  add(Constant Quality);
+  add(Two pass-filesize);
+  add(Two pass-Avg bitrate);
+  
+           combo->show();
+           
+           text1=new QLabel( "Encoding mode",z);
+          text1->setBuddy(combo);
+          
+          
+           box=new QSpinBox(z);
+           box->show();
+           
+           text2=new QLabel( "Bitrate",z);
+           text2->setBuddy(combo);
+          
+          
+          layout->addWidget(text1,line,0);
+          layout->addWidget(combo,line,1);
+          
+          layout->addWidget(text2,line+1,0);
+          layout->addWidget(box,line+1,1);
+          int i;
+          switch(compress-> mode)
+          {
+            case  COMPRESS_CQ: i=1;break;
+            case  COMPRESS_CBR:i=0;break;
+            case  COMPRESS_2PASS:i=2;break;
+            case  COMPRESS_SAME:i=4;break;
+            case  COMPRESS_2PASS_BITRATE:i=3;break;
+            default: ADM_assert(0);
+          }
+          comboChanged(i);        
+          QObject::connect(combo, SIGNAL(currentIndexChanged(int )), this, SLOT(comboChanged(int )));
+          
+          
+        }
+        virtual ~ADM_Qbitrate() ;
+            
+};
+void ADM_Qbitrate::comboChanged(int i)
+{
+  printf("Changed\n"); 
+  #define P(x) text2->setText(_(#x))
+#define M(x,y) box->setMinimum  (x);box->setMaximum  (y);
+#define S(x)   box->setValue(x);
+  switch(i)
+  {
+    case 0: //CBR
+          P(Bitrate (kb/s));
+          M(0,20000);
+          S(compress->bitrate);
+          break; 
+    case 1:// CQ
+          P(Quantizer);
+          M(2,31);
+          S(compress->qz);
+          break;
+    case 2 : // 2pass Filesize
+          P(FileSize (MB));
+          M(1,8000);
+          S(compress->finalsize);
+          break;
+    case 3 : // 2pass Avg
+          P(Average Br (kb/s));
+          M(0,20000);
+          S(compress->avg_bitrate);
+          break;
+    case 4 : // Same Qz as input
+          P(-);
+          M(0,0);
+          break;
+    default:ADM_assert(0);
+  }
+}
+//**********************************
+diaElemBitrate::diaElemBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip)
+  : diaElem(ELEM_BITRATE)
+{
+ 
+  param=(void *)p;
+  memcpy(&copy,p,sizeof(copy));
+  paramTitle=NULL;
+  this->tip=tip;
+  setSize(2);
+}
+
+diaElemBitrate::~diaElemBitrate()
+{
+  ADM_assert(myWidget);
+
+  ADM_Qbitrate *z=(ADM_Qbitrate *)myWidget;
+  
+  if(z) delete z;
+
+  myWidget=NULL;
+}
+void diaElemBitrate::setMe(void *dialog, void *opaque,uint32_t line)
+{
+  QGridLayout *layout=(QGridLayout*) opaque;
+  ADM_Qbitrate *b=new ADM_Qbitrate( (QWidget *)dialog,(COMPRES_PARAMS *)&copy,layout,line);
+  myWidget=(void *)b;
+  
+}
+void diaElemBitrate::getMe(void)
+{
+  //memcpy(param,&copy,sizeof(copy));
+}
+ADM_Qbitrate::~ADM_Qbitrate()
+{
+#define DEL(x) if(x) {delete x;x=NULL;}
+//                 DEL(text1)
+//                 DEL(text2)
+//                 DEL(box) 
+//                 DEL(combo) 
+};
+
+//EOF
+

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_dialogFactory.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_dialogFactory.cpp	2007-02-19 19:28:43 UTC (rev 2836)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_dialogFactory.cpp	2007-02-20 20:02:46 UTC (rev 2837)
@@ -68,10 +68,20 @@
   
   QGridLayout layout(&dialog);
   
+  /* First compute the size of our window */
+  int vsize=0;
   for(int i=0;i<nb;i++)
   {
     ADM_assert(elems[i]);
-     elems[i]->setMe( (void *)&dialog,&layout,i); 
+     vsize+=elems[i]->getSize(); 
+  }
+
+ int  v=0;
+  for(int i=0;i<nb;i++)
+  {
+    ADM_assert(elems[i]);
+     elems[i]->setMe( (void *)&dialog,&layout,v); 
+     v+=elems[i]->getSize();
     
   }
   // Add buttons
@@ -80,7 +90,7 @@
                             | QDialogButtonBox::Cancel);
      QObject::connect(&buttonBox, SIGNAL(accepted()), &dialog, SLOT(accept()));
      QObject::connect(&buttonBox, SIGNAL(rejected()), &dialog, SLOT(reject()));
-     layout.addWidget(&buttonBox,nb,0);
+     layout.addWidget(&buttonBox,vsize,0);
   // run
   dialog.setLayout(&layout);
   if(dialog.exec()==QDialog::Accepted)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_filesel.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_filesel.cpp	2007-02-19 19:28:43 UTC (rev 2836)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_filesel.cpp	2007-02-20 20:02:46 UTC (rev 2837)
@@ -82,9 +82,11 @@
         }
         ~ADM_Qfilesel() 
             {
+#if 1 //Memleak or autoclean ?
                 if(edit) delete edit;
                 if(button) delete button;
                 if(text) delete text;
+#endif
             };
 };
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h	2007-02-19 19:28:43 UTC (rev 2836)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/translation_table.h	2007-02-20 20:02:46 UTC (rev 2837)
@@ -68,7 +68,7 @@
 #define LIST_OF_BUTTONS     \
 PROCESS(setMarkerA , ACT_GotoMarkA  ) \
 PROCESS(setMarkerB ,ACT_GotoMarkB )  \
-PROCESS(pushButtonVideoConf ,ACT_VideoConfigure )  \
+PROCESS(pushButtonVideoConf ,ACT_VideoCodec)  \
 PROCESS(pushButtonVideoFilter , ACT_VideoParameter  ) \
 PROCESS(pushButtonAudioConf ,ACT_AudioCodec ) \
 PROCESS(pushButtonAudioFilter ,ACT_AudioFilters ) 



From mean at mail.berlios.de  Tue Feb 20 21:11:06 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 20 Feb 2007 21:11:06 +0100
Subject: [Avidemux-svn-commit] r2838 -
	branches/avidemux_2.4_branch/avidemux/ADM_editor
Message-ID: <200702202011.l1KKB68R029965@sheep.berlios.de>

Author: mean
Date: 2007-02-20 21:11:05 +0100 (Tue, 20 Feb 2007)
New Revision: 2838

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edLoadSave.cpp
Log:
debacklashify also external audio track in project

Modified: branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edLoadSave.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edLoadSave.cpp	2007-02-20 20:02:46 UTC (rev 2837)
+++ branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edLoadSave.cpp	2007-02-20 20:11:05 UTC (rev 2838)
@@ -210,7 +210,11 @@
         if(!audioName) audioName="";
 
         if(source!=AudioAvi)
+        {
+                char *nm=cleanupPath(audioName);
                 qfprintf(fd,"app.audio.load(\"%s\",\"%s\");\n", audioSourceFromEnum(source),audioName); 
+                ADM_dealloc(nm);
+        }
         else 
         { // Maybe not the 1st track
           int source;



From mean at mail.berlios.de  Tue Feb 20 21:18:20 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 20 Feb 2007 21:18:20 +0100
Subject: [Avidemux-svn-commit] r2839 -
	branches/avidemux_2.4_branch/avidemux/ADM_editor
Message-ID: <200702202018.l1KKIKQJ030643@sheep.berlios.de>

Author: mean
Date: 2007-02-20 21:18:20 +0100 (Tue, 20 Feb 2007)
New Revision: 2839

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edLoadSave.cpp
Log:
oops, correct fix this time

Modified: branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edLoadSave.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edLoadSave.cpp	2007-02-20 20:11:05 UTC (rev 2838)
+++ branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edLoadSave.cpp	2007-02-20 20:18:20 UTC (rev 2839)
@@ -212,7 +212,7 @@
         if(source!=AudioAvi)
         {
                 char *nm=cleanupPath(audioName);
-                qfprintf(fd,"app.audio.load(\"%s\",\"%s\");\n", audioSourceFromEnum(source),audioName); 
+                qfprintf(fd,"app.audio.load(\"%s\",\"%s\");\n", audioSourceFromEnum(source),nm); 
                 ADM_dealloc(nm);
         }
         else 



From mean at mail.berlios.de  Wed Feb 21 20:22:49 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Wed, 21 Feb 2007 20:22:49 +0100
Subject: [Avidemux-svn-commit] r2840 - in
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces:
	ADM_QT4/ADM_dialogFactory ADM_commonUI
Message-ID: <200702211922.l1LJMnua014009@sheep.berlios.de>

Author: mean
Date: 2007-02-21 20:22:48 +0100 (Wed, 21 Feb 2007)
New Revision: 2840

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_bitrate.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
Log:
dont double delete

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_bitrate.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_bitrate.cpp	2007-02-20 20:18:20 UTC (rev 2839)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/T_bitrate.cpp	2007-02-21 19:22:48 UTC (rev 2840)
@@ -67,8 +67,8 @@
            
            text1=new QLabel( "Encoding mode",z);
           text1->setBuddy(combo);
+          text1->show();
           
-          
            box=new QSpinBox(z);
            box->show();
            
@@ -134,6 +134,17 @@
     default:ADM_assert(0);
   }
 }
+ADM_Qbitrate::~ADM_Qbitrate()
+{
+#define DEL(x) if(x) {delete x;x=NULL;}
+#if 0 // Automatically deleted
+                 DEL(text1)
+                 DEL(text2)
+                 DEL(box) 
+                 DEL(combo) 
+#endif
+};
+
 //**********************************
 diaElemBitrate::diaElemBitrate(COMPRES_PARAMS *p,const char *toggleTitle,const char *tip)
   : diaElem(ELEM_BITRATE)
@@ -149,16 +160,18 @@
 diaElemBitrate::~diaElemBitrate()
 {
   ADM_assert(myWidget);
-
+#if 0 // Automatically deleted as it is a child of main dialog
   ADM_Qbitrate *z=(ADM_Qbitrate *)myWidget;
   
   if(z) delete z;
 
   myWidget=NULL;
+#endif
 }
 void diaElemBitrate::setMe(void *dialog, void *opaque,uint32_t line)
 {
   QGridLayout *layout=(QGridLayout*) opaque;
+  
   ADM_Qbitrate *b=new ADM_Qbitrate( (QWidget *)dialog,(COMPRES_PARAMS *)&copy,layout,line);
   myWidget=(void *)b;
   
@@ -167,14 +180,6 @@
 {
   //memcpy(param,&copy,sizeof(copy));
 }
-ADM_Qbitrate::~ADM_Qbitrate()
-{
-#define DEL(x) if(x) {delete x;x=NULL;}
-//                 DEL(text1)
-//                 DEL(text2)
-//                 DEL(box) 
-//                 DEL(combo) 
-};
 
 //EOF
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-20 20:18:20 UTC (rev 2839)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-21 19:22:48 UTC (rev 2840)
@@ -41,7 +41,7 @@
   elemEnum mySelf;
   int       size; // Size of the widget in line
 
-  diaElem(elemEnum num) {param=NULL;mySelf=num;myWidget=NULL;size=1;};
+  diaElem(elemEnum num) {paramTitle=NULL;param=NULL;mySelf=num;myWidget=NULL;size=1;};
   int getSize(void) {return size;};
   virtual ~diaElem() {};
   virtual void setMe(void *dialog, void *opaque,uint32_t line)=0;



From mean at mail.berlios.de  Sat Feb 24 18:15:05 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 24 Feb 2007 18:15:05 +0100
Subject: [Avidemux-svn-commit] r2841 - in
	branches/avidemux_2.4_branch/avidemux: . ADM_encoder
	ADM_outputs/oplug_avi
Message-ID: <200702241715.l1OHF5mF032143@sheep.berlios.de>

Author: mean
Date: 2007-02-24 18:15:04 +0100 (Sat, 24 Feb 2007)
New Revision: 2841

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encCopy.h
   branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_savecopy.h
   branches/avidemux_2.4_branch/avidemux/gui_savenew.cpp
Log:
factorize code : copy mode and unpack mode for avi output

Modified: branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encCopy.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encCopy.h	2007-02-21 19:22:48 UTC (rev 2840)
+++ branches/avidemux_2.4_branch/avidemux/ADM_encoder/adm_encCopy.h	2007-02-24 17:15:04 UTC (rev 2841)
@@ -20,6 +20,7 @@
 #ifndef __ADM_encoder_copy__
 #define __ADM_encoder_copy__
 
+#include "ADM_encoder/adm_encoder.h"
 
 class EncoderCopy:public Encoder
 {

Modified: branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/Makefile.am	2007-02-21 19:22:48 UTC (rev 2840)
+++ branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/Makefile.am	2007-02-24 17:15:04 UTC (rev 2841)
@@ -8,7 +8,7 @@
 
 liboplug_avi_a_SOURCES = op_savesmart.cpp op_saveprocess.cpp op_aviwrite.cpp \
 			 op_avisavedual.cpp op_avisavecopy.cpp op_avisave.cpp  \
-			 avilist.cpp
+			 avilist.cpp op_avisavecopy_pack.cpp op_avisavecopy_unpack.cpp
 
 
 EXTRA_DIST =  GUI_mux.h       op_avisavecopy.cpp  op_aviwrite.hxx    \

Modified: branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp	2007-02-21 19:22:48 UTC (rev 2840)
+++ branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp	2007-02-24 17:15:04 UTC (rev 2841)
@@ -52,8 +52,16 @@
 #include "ADM_osSupport/ADM_debug.h"
 
 
-static void updateUserData(uint8_t *start, uint32_t len);
-uint8_t ADM_findMpegStartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset);
+/**
+      \fn  ~GenericAviSaveCopyUnpack
+      \brief destructor
+*/
+GenericAviSaveCopy::~GenericAviSaveCopy ()
+{
+      if(copy) delete copy;
+      copy=NULL; 
+}
+
 uint8_t GenericAviSaveCopy::setupVideo (char *name)
 {
   //  Setup avi file output, all is coming from original avi
@@ -65,13 +73,7 @@
   memcpy(&_videostreamheader,video_body->getVideoStreamHeader (),sizeof( _videostreamheader));
   memcpy(&_mainaviheader,video_body->getMainHeader (),sizeof(_mainaviheader));
   
-  // Change both to divx/DX50
-  if(_needUserDataUpdate)
-  {
-  	_videostreamheader.fccHandler=fourCC::get((uint8_t *)"divx");
-	_bih.biCompression=fourCC::get((uint8_t *)"DX50");
-  
-  }
+
   /* update to fix earlier bug */
    _mainaviheader.dwWidth=_bih.biWidth;
    _mainaviheader.dwHeight=_bih.biHeight;
@@ -105,16 +107,16 @@
  _incoming = getFirstVideoFilter (frameStart,frameEnd-frameStart);
  encoding_gui->setFps(_incoming->getInfo()->fps1000);
  encoding_gui->setPhasis("Saving");
+ // Set up our copy codec ...
+  copy=new EncoderCopy(NULL);
+  if(!copy->configure(_incoming))
+  {
+      printf("Copy cannot [configure] \n");
+      return 0;
+  }
   return 1;
 }
 
-//
-//      Just to keep gcc happy....
-//
-// GenericAviSaveCopy::~GenericAviSaveCopy ()
-// {
-// 
-// }
 
 // copy mode
 // Basically ask a video frame and send it to writter
@@ -126,62 +128,25 @@
   
   uint8_t    ret1;
  ADMCompressedImage img;
+ ADMBitstream bitstream;
  
- img.data=vbuffer;
-	if(!video_body->isReordered(frameStart+frame))
-	{
-		ret1 = video_body->getFrameNoAlloc (frameStart + frame,&img);// vbuffer, &len,      &_videoFlag);
-                _videoFlag=img.flags;
-	}
-	else
-	{
-			// we are async...
-			video_body->getFlags (frameStart + frame, &_videoFlag);
-			if(_videoFlag & AVI_B_FRAME)
-			{ 	// search if we have to send a I/P frame in adance
-				aprintf("\tIt is a B frame\n");
-				uint32_t forward;
-				forward=searchForward(frameStart+frame);
-				// if we did not sent it, do it now
-				if(forward!=_lastIPFrameSent)
-				{
-					aprintf("\tP Frame not sent, sending it :%lu\n",forward);
-					ret1 = video_body->getFrameNoAlloc (forward, &img);//vbuffer, &len,&_videoFlag);
-					_lastIPFrameSent=forward;
-                                         _videoFlag=img.flags;
+      img.data=vbuffer;
+      bitstream.bufferSize=_incoming->getInfo ()->width *   _incoming->getInfo ()->height * 3;
+      bitstream.data=vbuffer;
+      
+      
+       if(!video_body->isReordered(frameStart+frame))
+      {
+          ret1 = video_body->getFrameNoAlloc (frameStart + frame,&img);// vbuffer, &len,      &_videoFlag);
+          _videoFlag=img.flags;
+      }
+      else
+      {
+           ret1=copy->encode(frame,&bitstream);
+           img.dataLength=bitstream.len;
+           _videoFlag=img.flags=bitstream.flags;
+      }
 
-				}
-				else
-				{
-					// we already sent it :)
-					// send n-1
-					aprintf("\tP Frame already, sending  :%lu\n",frameStart+frame-1);
-					ret1 = video_body->getFrameNoAlloc (frameStart+frame-1,&img);// vbuffer, &len,	&_videoFlag);
-                                        _videoFlag=img.flags;
-
-				}
-
-			}
-			else // it is not a B frame and we have nothing on hold, sent it..
-			{
-				// send n-1 if we reach the fwd reference frame
-				if((frame+frameStart)==_lastIPFrameSent)
-				{
-					aprintf("\tSending Last B-frame :(%lu)\n",frameStart + frame-1);
-					ret1 = video_body->getFrameNoAlloc (frameStart + frame-1, &img); //vbuffer, &len, 		&_videoFlag);
-                                         _videoFlag=img.flags;
-
-				}
-				else
-				{
-					aprintf("\tJust sending it :(%lu)-(%lu)\n",frameStart + frame,_lastIPFrameSent);
-					ret1 = video_body->getFrameNoAlloc (frameStart + frame, &img);//vbuffer, &len,	&_videoFlag);
-                                        _videoFlag=img.flags;
-				}
-			}
-
-	}
-
   if (!ret1)
     return 0;
 
@@ -190,72 +155,21 @@
       // if so, we re-write the last I frame
       if(muxSize)
       	{
-				 		// we overshot the limit and it is a key frame
-				   	// start a new chunk
-				  	if(handleMuxSize() && (_videoFlag & AVI_KEY_FRAME))
-				   	{		
-							  uint8_t *extraData;
-							  uint32_t extraLen;
+                        // we overshot the limit and it is a key frame
+                // start a new chunk
+                if(handleMuxSize() && (_videoFlag & AVI_KEY_FRAME))
+                {		
+                    uint8_t *extraData;
+                    uint32_t extraLen;
 
-   							video_body->getExtraHeaderData(&extraLen,&extraData);
-					   
-							if(!reigniteChunk(extraLen,extraData)) return 0;
-						}
-				 }
-//  encoding_gui->feedFrame(len);  
-  if(_needUserDataUpdate)
-  	updateUserData(vbuffer,img.dataLength);
+                  video_body->getExtraHeaderData(&extraLen,&extraData);
+      
+                  if(!reigniteChunk(extraLen,extraData)) return 0;
+                }
+          }
+  
   encoding_gui->setFrame(frame,img.dataLength,0,frametogo);
   return writter->saveVideoFrame (img.dataLength, img.flags, img.data);
 
-}
-//_____________________________________________________
-// Update the user data field that is used to 
-// detect in windows world if it is packed or not
-//_____________________________________________________
-void updateUserData(uint8_t *start, uint32_t len)
-{
-	// lookup startcode
-	uint32_t sync,off,rlen;
-	uint8_t code;
-	uint8_t *end=start+len;
-	while(ADM_findMpegStartCode(start, end,&code,&off))
-	{
-		// update
-		start+=off;
-		rlen=end-start;
-		if(code!=0xb2 || rlen<4)
-		    continue;
-    	
-		printf("User data found\n");
-		// looks ok ?
-		if(!strncmp((char *)start,"DivX",4))
-		{
 
-    		    //
-    		    start+=4;
-    		    rlen-=4; // skip "DivX"
-				// looks for a p while not null
-				// if there isnt we will reach a new startcode
-				// and it will stop
-				while((*start!='p') && rlen) 
-				{
-					if(!*start)
-					{
-						rlen=0;
-						break;
-					}
-					rlen--;
-					start++;
-				}
-				if(!rlen) 
-					{
-						printf("Unpacketizer:packed marker not found!\n");
-					}
-				else	
-				        *start='n'; // remove 'p'
-				return;			
-		}
-	}
 }
-//EOF

Copied: branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp (from rev 2818, branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp	2007-02-13 19:16:54 UTC (rev 2818)
+++ branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp	2007-02-24 17:15:04 UTC (rev 2841)
@@ -0,0 +1,256 @@
+/***************************************************************************
+                          op_avisavecopy.cpp  -  description
+                             -------------------
+
+	We bypass the use of _incoming to have easy access to furure
+	frame.
+	In fact only the getflags is necessary, other stuff will be done throught
+	incoming.
+
+    begin                : Fri May 3 2002
+    copyright            : (C) 2002 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include <stdio.h>
+#include <stdlib.h>
+#include <math.h>
+#include <unistd.h>
+
+#include <time.h>
+#include <sys/time.h>
+#include "config.h"
+#include <pthread.h>
+#define WIN32_CLASH
+#include "fourcc.h"
+#include "avi_vars.h"
+#include "ADM_toolkit/toolkit.hxx"
+#include "subchunk.h"
+//#include "avilist.h"
+
+#include "ADM_video/ADM_genvideo.hxx"
+#include "ADM_filter/video_filters.h"
+#include "ADM_encoder/ADM_vidEncode.hxx"
+
+
+#include "ADM_audio/aviaudio.hxx"
+#include "ADM_audiofilter/audioprocess.hxx"
+#include "oplug_avi/op_aviwrite.hxx"
+#include "oplug_avi/op_avisave.h"
+#include "oplug_avi/op_savecopy.h"
+
+#include "ADM_osSupport/ADM_debugID.h"
+#define MODULE_NAME MODULE_SAVE_AVI
+#include "ADM_osSupport/ADM_debug.h"
+
+
+static void updateUserData(uint8_t *start, uint32_t len);
+uint8_t ADM_findMpegStartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset);
+
+
+/**
+      \fn  ~GenericAviSaveCopyUnpack
+      \brief destructor
+*/
+GenericAviSaveCopyPack::~GenericAviSaveCopyPack ()
+{
+      if(lookAhead) 
+      {
+          delete [] lookAhead->data;
+          delete lookAhead;
+      }
+      lookAhead=NULL;
+}
+/**
+      \fn GenericAviSaveCopyUnpack::setupVideo
+      \brief init for unpacker code
+
+*/
+uint8_t GenericAviSaveCopyPack::setupVideo (char *name)
+{
+  //  Setup avi file output, all is coming from original avi
+  // since we are inc copy mode
+  memcpy(&_bih,video_body->getBIH (),sizeof(_bih));
+  _bih.biSize=sizeof(_bih);  //fix old version of avidemux
+  _bih.biXPelsPerMeter=_bih.biClrUsed=_bih.biYPelsPerMeter=0;
+  //
+  memcpy(&_videostreamheader,video_body->getVideoStreamHeader (),sizeof( _videostreamheader));
+  memcpy(&_mainaviheader,video_body->getMainHeader (),sizeof(_mainaviheader));
+  
+  // Change both to divx/DX50
+  	_videostreamheader.fccHandler=fourCC::get((uint8_t *)"divx");
+	_bih.biCompression=fourCC::get((uint8_t *)"DX50");
+  /* update to fix earlier bug */
+   _mainaviheader.dwWidth=_bih.biWidth;
+   _mainaviheader.dwHeight=_bih.biHeight;
+
+   uint8_t *extraData;
+   uint32_t extraLen;
+  _lastIPFrameSent=0xfffffff;
+   video_body->getExtraHeaderData(&extraLen,&extraData);
+
+  	if (!writter->saveBegin (name,
+			   &_mainaviheader,
+			   frameEnd - frameStart + 1,
+			   &_videostreamheader,
+			   &_bih,
+			   extraData,extraLen,
+			   audio_filter,
+			   audio_filter2
+		))
+    	{
+          GUI_Error_HIG (_("Cannot initiate save"), NULL);
+      		return 0;
+    	}
+	if(audio_filter2)
+	{
+		printf("Second audio track present\n");
+	}
+	else
+	{
+		printf("Second audio track absent\n");
+	}
+ _incoming = getFirstVideoFilter (frameStart,frameEnd-frameStart);
+ encoding_gui->setFps(_incoming->getInfo()->fps1000);
+ encoding_gui->setPhasis("Saving");
+ 
+ // Set up our copy codec ...
+  copy=new EncoderCopy(NULL);
+  if(!copy->configure(_incoming))
+  {
+      printf("Copy cannot [configure] \n");
+      return 0;
+  }
+  // Our buffer
+#define LOOK_SIZE 2*3*_incoming->getInfo ()->width *   _incoming->getInfo ()->height * 3
+  uint8_t *buf=new uint8_t[LOOK_SIZE];
+           lookAhead=new ADMBitstream(LOOK_SIZE);
+           lookAhead->data=buf;
+  return 1;
+}
+
+
+// copy mode
+// Basically ask a video frame and send it to writter
+// If it contains b frame and frames have been re-ordered
+// reorder them back ...
+/**
+      \fn GenericAviSaveCopyUnpack::setupVideo
+      \brief init for unpacker code
+
+*/
+uint8_t GenericAviSaveCopyPack::writeVideoChunk (uint32_t frame)
+{
+  
+  uint8_t    ret1;
+ ADMCompressedImage img;
+ ADMBitstream bitstream;
+ 
+      img.data=vbuffer;
+      bitstream.bufferSize=_incoming->getInfo ()->width *   _incoming->getInfo ()->height * 3;
+      bitstream.data=vbuffer;
+      
+      
+       if(!video_body->isReordered(frameStart+frame))
+      {
+          ret1 = video_body->getFrameNoAlloc (frameStart + frame,&img);// vbuffer, &len,      &_videoFlag);
+          _videoFlag=img.flags;
+      }
+      else
+      {
+            // We prefectch one frame...
+        
+           ret1=copy->encode(frame,&bitstream);
+           img.dataLength=bitstream.len;
+           _videoFlag=img.flags=bitstream.flags;
+           if(bitstream.flags==AVI_KEY_FRAME)
+           {
+            updateUserData(bitstream.data,bitstream.len); 
+           }
+      }
+
+  if (!ret1)
+    return 0;
+
+    // check for split
+     // check for auto split
+      // if so, we re-write the last I frame
+      if(muxSize)
+      	{
+                        // we overshot the limit and it is a key frame
+                // start a new chunk
+                if(handleMuxSize() && (_videoFlag & AVI_KEY_FRAME))
+                {		
+                    uint8_t *extraData;
+                    uint32_t extraLen;
+
+                  video_body->getExtraHeaderData(&extraLen,&extraData);
+      
+                  if(!reigniteChunk(extraLen,extraData)) return 0;
+                }
+          }
+  
+  encoding_gui->setFrame(frame,img.dataLength,0,frametogo);
+  return writter->saveVideoFrame (img.dataLength, img.flags, img.data);
+
+}
+
+//_____________________________________________________
+// Update the user data field that is used to 
+// detect in windows world if it is packed or not
+//_____________________________________________________
+void updateUserData(uint8_t *start, uint32_t len)
+{
+      // lookup startcode
+      uint32_t sync,off,rlen;
+      uint8_t code;
+      uint8_t *end=start+len;
+      while(ADM_findMpegStartCode(start, end,&code,&off))
+      {
+              // update
+              start+=off;
+              rlen=end-start;
+              if(code!=0xb2 || rlen<4)
+                  continue;
+      
+              printf("User data found\n");
+              // looks ok ?
+              if(!strncmp((char *)start,"DivX",4))
+              {
+
+                  //
+                  start+=4;
+                  rlen-=4; // skip "DivX"
+                              // looks for a p while not null
+                              // if there isnt we will reach a new startcode
+                              // and it will stop
+                              while((*start!='p') && rlen) 
+                              {
+                                      if(!*start)
+                                      {
+                                              rlen=0;
+                                              break;
+                                      }
+                                      rlen--;
+                                      start++;
+                              }
+                              if(!rlen) 
+                                      {
+                                              printf("Unpacketizer:packed marker not found!\n");
+                                      }
+                              else	
+                                      *start='n'; // remove 'p'
+                              return;			
+              }
+      }
+}
+
+//EOF

Copied: branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp (from rev 2818, branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp	2007-02-13 19:16:54 UTC (rev 2818)
+++ branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp	2007-02-24 17:15:04 UTC (rev 2841)
@@ -0,0 +1,237 @@
+/***************************************************************************
+                          op_avisavecopy.cpp  -  description
+                             -------------------
+
+	We bypass the use of _incoming to have easy access to furure
+	frame.
+	In fact only the getflags is necessary, other stuff will be done throught
+	incoming.
+
+    begin                : Fri May 3 2002
+    copyright            : (C) 2002 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include <stdio.h>
+#include <stdlib.h>
+#include <math.h>
+#include <unistd.h>
+
+#include <time.h>
+#include <sys/time.h>
+#include "config.h"
+#include <pthread.h>
+#define WIN32_CLASH
+#include "fourcc.h"
+#include "avi_vars.h"
+#include "ADM_toolkit/toolkit.hxx"
+#include "subchunk.h"
+//#include "avilist.h"
+
+#include "ADM_video/ADM_genvideo.hxx"
+#include "ADM_filter/video_filters.h"
+#include "ADM_encoder/ADM_vidEncode.hxx"
+
+
+#include "ADM_audio/aviaudio.hxx"
+#include "ADM_audiofilter/audioprocess.hxx"
+#include "oplug_avi/op_aviwrite.hxx"
+#include "oplug_avi/op_avisave.h"
+#include "oplug_avi/op_savecopy.h"
+
+#include "ADM_osSupport/ADM_debugID.h"
+#define MODULE_NAME MODULE_SAVE_AVI
+#include "ADM_osSupport/ADM_debug.h"
+
+
+static void updateUserData(uint8_t *start, uint32_t len);
+uint8_t ADM_findMpegStartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset);
+
+
+
+/**
+      \fn GenericAviSaveCopyUnpack::setupVideo
+      \brief init for unpacker code
+
+*/
+uint8_t GenericAviSaveCopyUnpack::setupVideo (char *name)
+{
+  //  Setup avi file output, all is coming from original avi
+  // since we are inc copy mode
+  memcpy(&_bih,video_body->getBIH (),sizeof(_bih));
+  _bih.biSize=sizeof(_bih);  //fix old version of avidemux
+  _bih.biXPelsPerMeter=_bih.biClrUsed=_bih.biYPelsPerMeter=0;
+  //
+  memcpy(&_videostreamheader,video_body->getVideoStreamHeader (),sizeof( _videostreamheader));
+  memcpy(&_mainaviheader,video_body->getMainHeader (),sizeof(_mainaviheader));
+  
+  // Change both to divx/DX50
+  	_videostreamheader.fccHandler=fourCC::get((uint8_t *)"divx");
+	_bih.biCompression=fourCC::get((uint8_t *)"DX50");
+  /* update to fix earlier bug */
+   _mainaviheader.dwWidth=_bih.biWidth;
+   _mainaviheader.dwHeight=_bih.biHeight;
+
+   uint8_t *extraData;
+   uint32_t extraLen;
+  _lastIPFrameSent=0xfffffff;
+   video_body->getExtraHeaderData(&extraLen,&extraData);
+
+  	if (!writter->saveBegin (name,
+			   &_mainaviheader,
+			   frameEnd - frameStart + 1,
+			   &_videostreamheader,
+			   &_bih,
+			   extraData,extraLen,
+			   audio_filter,
+			   audio_filter2
+		))
+    	{
+          GUI_Error_HIG (_("Cannot initiate save"), NULL);
+      		return 0;
+    	}
+	if(audio_filter2)
+	{
+		printf("Second audio track present\n");
+	}
+	else
+	{
+		printf("Second audio track absent\n");
+	}
+ _incoming = getFirstVideoFilter (frameStart,frameEnd-frameStart);
+ encoding_gui->setFps(_incoming->getInfo()->fps1000);
+ encoding_gui->setPhasis("Saving");
+ 
+ // Set up our copy codec ...
+  copy=new EncoderCopy(NULL);
+  if(!copy->configure(_incoming))
+  {
+      printf("Copy cannot [configure] \n");
+      return 0;
+  }
+  return 1;
+}
+
+
+// copy mode
+// Basically ask a video frame and send it to writter
+// If it contains b frame and frames have been re-ordered
+// reorder them back ...
+/**
+      \fn GenericAviSaveCopyUnpack::setupVideo
+      \brief init for unpacker code
+
+*/
+uint8_t GenericAviSaveCopyUnpack::writeVideoChunk (uint32_t frame)
+{
+  
+  uint8_t    ret1;
+ ADMCompressedImage img;
+ ADMBitstream bitstream;
+ 
+      img.data=vbuffer;
+      bitstream.bufferSize=_incoming->getInfo ()->width *   _incoming->getInfo ()->height * 3;
+      bitstream.data=vbuffer;
+      
+      
+       if(!video_body->isReordered(frameStart+frame))
+      {
+          ret1 = video_body->getFrameNoAlloc (frameStart + frame,&img);// vbuffer, &len,      &_videoFlag);
+          _videoFlag=img.flags;
+      }
+      else
+      {
+           ret1=copy->encode(frame,&bitstream);
+           img.dataLength=bitstream.len;
+           _videoFlag=img.flags=bitstream.flags;
+           if(bitstream.flags==AVI_KEY_FRAME)
+           {
+            updateUserData(bitstream.data,bitstream.len); 
+           }
+      }
+
+  if (!ret1)
+    return 0;
+
+    // check for split
+     // check for auto split
+      // if so, we re-write the last I frame
+      if(muxSize)
+      	{
+                        // we overshot the limit and it is a key frame
+                // start a new chunk
+                if(handleMuxSize() && (_videoFlag & AVI_KEY_FRAME))
+                {		
+                    uint8_t *extraData;
+                    uint32_t extraLen;
+
+                  video_body->getExtraHeaderData(&extraLen,&extraData);
+      
+                  if(!reigniteChunk(extraLen,extraData)) return 0;
+                }
+          }
+  
+  encoding_gui->setFrame(frame,img.dataLength,0,frametogo);
+  return writter->saveVideoFrame (img.dataLength, img.flags, img.data);
+
+}
+
+//_____________________________________________________
+// Update the user data field that is used to 
+// detect in windows world if it is packed or not
+//_____________________________________________________
+void updateUserData(uint8_t *start, uint32_t len)
+{
+      // lookup startcode
+      uint32_t sync,off,rlen;
+      uint8_t code;
+      uint8_t *end=start+len;
+      while(ADM_findMpegStartCode(start, end,&code,&off))
+      {
+              // update
+              start+=off;
+              rlen=end-start;
+              if(code!=0xb2 || rlen<4)
+                  continue;
+      
+              printf("User data found\n");
+              // looks ok ?
+              if(!strncmp((char *)start,"DivX",4))
+              {
+
+                  //
+                  start+=4;
+                  rlen-=4; // skip "DivX"
+                              // looks for a p while not null
+                              // if there isnt we will reach a new startcode
+                              // and it will stop
+                              while((*start!='p') && rlen) 
+                              {
+                                      if(!*start)
+                                      {
+                                              rlen=0;
+                                              break;
+                                      }
+                                      rlen--;
+                                      start++;
+                              }
+                              if(!rlen) 
+                                      {
+                                              printf("Unpacketizer:packed marker not found!\n");
+                                      }
+                              else	
+                                      *start='n'; // remove 'p'
+                              return;			
+              }
+      }
+}
+
+//EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_savecopy.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_savecopy.h	2007-02-21 19:22:48 UTC (rev 2840)
+++ branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_savecopy.h	2007-02-24 17:15:04 UTC (rev 2841)
@@ -16,44 +16,60 @@
  ***************************************************************************/
  #ifndef __AVI_SAVECPY__
  #define   __AVI_SAVECPY__
-
+#include "ADM_encoder/adm_encCopy.h"
  class GenericAviSaveCopy : public   GenericAviSave
  {
      protected :
-			
+		                                EncoderCopy          *copy;	
 		          virtual uint8_t 	setupVideo( char *name  );
                           virtual uint8_t 	writeVideoChunk(uint32_t frame );
-			  	  uint8_t	_needUserDataUpdate;
 
      public:
-     						GenericAviSaveCopy()  :     GenericAviSave()
-										{
-											_needUserDataUpdate=0;
-										};
-						GenericAviSaveCopy(uint8_t pack)  :     GenericAviSave()
-										{
-											_needUserDataUpdate=pack;
-										};	
-               //           virtual ~GenericAviSaveCopy();
+                                              GenericAviSaveCopy()  :     GenericAviSave()
+                                                                      {
+                                                                        copy=NULL;
+                                                                      };
+                           virtual ~GenericAviSaveCopy();
    };
 
  class GenericAviSaveCopyDualAudio : public   GenericAviSaveCopy
  {
      protected :
 
-			
+                        
                         char				*_trackname;
-			uint32_t			_audioCurrent2;
+                        uint32_t			_audioCurrent2;
 
                         uint8_t    doOneTrack (uint32_t index,AVDMGenericAudioStream *stream,uint32_t target,uint32_t *current);
-		                   virtual uint8_t setupAudio( void);
-                        	 virtual uint8_t writeAudioChunk(uint32_t frame );
-				 //virtual uint8_t setupVideo (char *name);
+                                    virtual uint8_t setupAudio( void);
+                                  virtual uint8_t writeAudioChunk(uint32_t frame );
+
      public:
                                      GenericAviSaveCopyDualAudio(AVDMGenericAudioStream	*track);
-                          //virtual ~GenericAviSaveCopyDualAudio();
+
    };
-
-
-
+/*            Pack /unpack */
+class GenericAviSaveCopyUnpack : public   GenericAviSaveCopy
+ {
+     protected :
+                          virtual uint8_t 	setupVideo( char *name  );
+                          virtual uint8_t 	writeVideoChunk(uint32_t frame );
+     public:
+  
+ };
+class GenericAviSaveCopyPack : public   GenericAviSaveCopy
+ {
+     protected :
+                          EncoderCopy          *copy;
+                          ADMBitstream         *lookAhead;
+                          virtual uint8_t 	setupVideo( char *name  );
+                          virtual uint8_t 	writeVideoChunk(uint32_t frame );
+     public:
+                          virtual	~GenericAviSaveCopyPack();	
+                                        GenericAviSaveCopyPack()  :     GenericAviSaveCopy()
+                                        {
+                                                lookAhead=NULL;
+                                        };
+  
+ };
   #endif

Modified: branches/avidemux_2.4_branch/avidemux/gui_savenew.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gui_savenew.cpp	2007-02-21 19:22:48 UTC (rev 2840)
+++ branches/avidemux_2.4_branch/avidemux/gui_savenew.cpp	2007-02-24 17:15:04 UTC (rev 2841)
@@ -266,7 +266,7 @@
 		return 0;
         }
 	//
-	nw=new   GenericAviSaveCopy(1);
+	nw=new   GenericAviSaveCopyUnpack();
 	ret=nw->saveAvi(name);
 	delete nw;
 	return ret;



From mean at mail.berlios.de  Sat Feb 24 21:37:53 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 24 Feb 2007 21:37:53 +0100
Subject: [Avidemux-svn-commit] r2842 - in
	branches/avidemux_2.4_branch/avidemux: . ADM_editor
	ADM_inputs/ADM_3gp ADM_outputs/oplug_avi ADM_toolkit
	ADM_userInterfaces/ADM_GTK/ADM_gui2
Message-ID: <200702242037.l1OKbrLX021191@sheep.berlios.de>

Author: mean
Date: 2007-02-24 21:37:52 +0100 (Sat, 24 Feb 2007)
New Revision: 2842

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_outputfmt.h
   branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_3gp.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_3gp.h
   branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_infoextractor.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_savecopy.h
   branches/avidemux_2.4_branch/avidemux/ADM_toolkit/automation.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp
   branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
   branches/avidemux_2.4_branch/avidemux/gui_savenew.cpp
Log:
add packed vop output format, needed for some multimedia stuff/dvd players

Modified: branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.cpp	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_edit.cpp	2007-02-24 20:37:52 UTC (rev 2842)
@@ -618,10 +618,15 @@
 					bconsistency=0;
 					
 				}
-				if(bframe)
+                                uint32_t ffcheck=vid->decoder->isDivxPacked ();
+                                if(ffcheck)
+                                {
+                                  printf("[Editor] Decoder says it is vop packed\n");
+                                }
+				if(bframe || ffcheck)
 				{
 					printf("\n Mmm this appear to have b-frame...\n");
-					if(bconsistency)
+					if(bconsistency )
 					{
 						printf("\n And the index is ok\n");
 
@@ -648,15 +653,21 @@
 					{
 						printf("\n But the  index is not up to date \n");
 						uint32_t ispacked=0;
+                                                
+                                                uint32_t ff=vid->decoder->isDivxPacked ();
+                                                if(ff)
+                                                {
+                                                  printf("[Editor] Decoder says it is vop packed\n");
+                                                }
+                                                
 						// If it is Divx 5.0.xxx use divx decoder
-						if(fourCC::check(info.fcc,(uint8_t *)"DX50")
-						|| fourCC::check(info.fcc,(uint8_t *)"XVID" ))
+						if(isMpeg4Compatible(info.fcc))
 						{
 
 
 							//if(vid->decoder->isDivxPacked())
 							uint8_t forced= getEnv(ENV_EDITOR_PVOP);
-							if(vid->decoder->isDivxPacked() ||forced)
+							if(ff ||forced)
 							{
 								
 								// can only unpack avi

Modified: branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_outputfmt.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_outputfmt.h	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_outputfmt.h	2007-02-24 20:37:52 UTC (rev 2842)
@@ -15,6 +15,7 @@
 {
 	ADM_AVI=0,
         ADM_AVI_UNP,
+        ADM_AVI_PAK,
         ADM_AVI_DUAL,
 	ADM_OGM,
 	ADM_ES,

Modified: branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_3gp.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_3gp.cpp	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_3gp.cpp	2007-02-24 20:37:52 UTC (rev 2842)
@@ -294,8 +294,8 @@
         {
             if(VDEO.extraDataSize)
             {
-                uint32_t w,h;
-                if(extractMpeg4Info(VDEO.extraData,VDEO.extraDataSize,&w,&h))
+                uint32_t w,h,ti;
+                if(extractMpeg4Info(VDEO.extraData,VDEO.extraDataSize,&w,&h,&ti))
                 {
                     printf("MP4 Corrected size : %lu x %lu\n",w,h);
                     _video_bih.biWidth=_mainaviheader.dwWidth=w ;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_3gp.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_3gp.h	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_3gp.h	2007-02-24 20:37:52 UTC (rev 2842)
@@ -152,7 +152,7 @@
 
 };
 
-uint8_t extractMpeg4Info(uint8_t *data,uint32_t dataSize,uint32_t *w,uint32_t *h);
+uint8_t extractMpeg4Info(uint8_t *data,uint32_t dataSize,uint32_t *w,uint32_t *h,uint32_t *time_inc);
 uint8_t extractH263Info(uint8_t *data,uint32_t dataSize,uint32_t *w,uint32_t *h);
 #endif
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_infoextractor.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_infoextractor.cpp	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_3gp/ADM_infoextractor.cpp	2007-02-24 20:37:52 UTC (rev 2842)
@@ -44,13 +44,13 @@
 
 
 */
-uint8_t extractMpeg4Info(uint8_t *data,uint32_t dataSize,uint32_t *w,uint32_t *h)
+uint8_t extractMpeg4Info(uint8_t *data,uint32_t dataSize,uint32_t *w,uint32_t *h,uint32_t *time_inc)
 {
     // Search startcode
     uint8_t b;
     uint32_t idx=0;
     uint32_t mw,mh;
-    uint32_t time_inc;
+    uint32_t timeVal;
     
     mixDump(data,dataSize);
     printf("\n");
@@ -104,11 +104,14 @@
                   }
                  skip_bits(&s,2); //  Shape
                  skip_bits(&s,1); //  Marker
-                 time_inc=get_bits(&s,16); // Time increment
+                 timeVal=get_bits(&s,16); // Time increment
+                 *time_inc = av_log2(timeVal - 1) + 1;
+                 if (*time_inc < 1)
+                    *time_inc = 1;
                  skip_bits(&s,1); //  Marker
                  if(get_bits(&s,1)) // Fixed vop rate, compute how much bits needed
                  {
-                    uint32_t in=time_inc;
+                    uint32_t in=*time_inc;
                     uint32_t i=1;
                     in--;
                     while(in)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp	2007-02-24 20:37:52 UTC (rev 2842)
@@ -168,8 +168,35 @@
                 }
           }
   
+  if(_videoFlag==AVI_KEY_FRAME)
+          newFile();
   encoding_gui->setFrame(frame,img.dataLength,0,frametogo);
   return writter->saveVideoFrame (img.dataLength, img.flags, img.data);
 
 
 }
+/**
+      \fn newFile
+      \brief start a new file, for example if the muxer was setup to split every 700 Meg. Call only on intra!
+
+
+*/
+uint8_t          GenericAviSaveCopy::newFile(void)
+{
+        if(muxSize)
+      	{
+                        // we overshot the limit and it is a key frame
+                // start a new chunk
+                if(handleMuxSize() )
+                {		
+                    uint8_t *extraData;
+                    uint32_t extraLen;
+
+                  video_body->getExtraHeaderData(&extraLen,&extraData);
+      
+                  if(!reigniteChunk(extraLen,extraData)) return 0;
+                }
+          }
+    return 1;
+}
+// EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp	2007-02-24 20:37:52 UTC (rev 2842)
@@ -1,14 +1,10 @@
 /***************************************************************************
-                          op_avisavecopy.cpp  -  description
-                             -------------------
-
-	We bypass the use of _incoming to have easy access to furure
-	frame.
-	In fact only the getflags is necessary, other stuff will be done throught
-	incoming.
-
-    begin                : Fri May 3 2002
-    copyright            : (C) 2002 by mean
+        
+    Pack a mpeg4 the divx way
+    Sometimes needed for some DVD/multimedia stuff
+	
+    
+    copyright            : (C) 2007 by mean
     email                : fixounet at free.fr
  ***************************************************************************/
 
@@ -51,23 +47,26 @@
 #define MODULE_NAME MODULE_SAVE_AVI
 #include "ADM_osSupport/ADM_debug.h"
 
-
-static void updateUserData(uint8_t *start, uint32_t len);
+uint8_t extractMpeg4Info(uint8_t *data,uint32_t dataSize,uint32_t *w,uint32_t *h,uint32_t *time_inc);
+static  void updateUserData(uint8_t *start, uint32_t len);
 uint8_t ADM_findMpegStartCode(uint8_t *start, uint8_t *end,uint8_t *outstartcode,uint32_t *offset);
+static  void putNvop(ADMBitstream *data,uint32_t time_inc);
 
-
 /**
       \fn  ~GenericAviSaveCopyUnpack
       \brief destructor
 */
 GenericAviSaveCopyPack::~GenericAviSaveCopyPack ()
 {
-      if(lookAhead) 
+      if(lookAhead[0]) 
       {
-          delete [] lookAhead->data;
-          delete lookAhead;
+          delete [] lookAhead[0]->data;
+          delete [] lookAhead[1]->data;
+          delete lookAhead[0];
+          delete lookAhead[1];
       }
-      lookAhead=NULL;
+      lookAhead[0]=NULL;
+      lookAhead[1]=NULL;
 }
 /**
       \fn GenericAviSaveCopyUnpack::setupVideo
@@ -76,6 +75,7 @@
 */
 uint8_t GenericAviSaveCopyPack::setupVideo (char *name)
 {
+  printf("Setting up bitstream packer\n");
   //  Setup avi file output, all is coming from original avi
   // since we are inc copy mode
   memcpy(&_bih,video_body->getBIH (),sizeof(_bih));
@@ -96,7 +96,16 @@
    uint32_t extraLen;
   _lastIPFrameSent=0xfffffff;
    video_body->getExtraHeaderData(&extraLen,&extraData);
-
+    if(extraLen>3)
+    {
+      uint32_t w,h,ti;
+      if(extractMpeg4Info(extraData,extraLen,&w,&h,&ti) )
+      {
+        time_inc=ti;
+        printf("Found info : %u  x %u, timeinc %u\n",w,h,ti); 
+      }
+    }
+      
   	if (!writter->saveBegin (name,
 			   &_mainaviheader,
 			   frameEnd - frameStart + 1,
@@ -132,12 +141,46 @@
   // Our buffer
 #define LOOK_SIZE 2*3*_incoming->getInfo ()->width *   _incoming->getInfo ()->height * 3
   uint8_t *buf=new uint8_t[LOOK_SIZE];
-           lookAhead=new ADMBitstream(LOOK_SIZE);
-           lookAhead->data=buf;
+           lookAhead[0]=new ADMBitstream(LOOK_SIZE);
+           lookAhead[0]->data=buf;
+            buf=new uint8_t[LOOK_SIZE];
+           lookAhead[1]=new ADMBitstream(LOOK_SIZE);
+           lookAhead[1]->data=buf;
+
   return 1;
 }
+/**
+        \fn prefetch 
+        \brief Read frame FRAME in buffer BUFFER
+*/
 
-
+uint8_t GenericAviSaveCopyPack::prefetch(uint32_t buffer,uint32_t frame)
+{
+  uint8_t r=0;
+  ADM_assert(copy); 
+  ADM_assert(buffer==0 || buffer==1);
+  
+  aprintf("Fetching frame %u buffer%u\n",frame,buffer);
+        r=copy->encode(frame,lookAhead[buffer]);
+        if(!r)
+        {
+            aprintf("Prefetching  frame %u in buffer %u failed\n",frame, buffer);
+        }
+        else
+        {
+          if((lookAhead[buffer]->flags & AVI_KEY_FRAME ) && !time_inc)
+          {
+                uint32_t w,h,ti;
+                if(extractMpeg4Info(lookAhead[buffer]->data,lookAhead[buffer]->len,&w,&h,&ti) )
+                {
+                  time_inc=ti;
+                  printf("Found info : %u  x %u, timeinc %u\n",w,h,ti); 
+                }
+          }
+        }
+      return r;
+  
+}
 // copy mode
 // Basically ask a video frame and send it to writter
 // If it contains b frame and frames have been re-ordered
@@ -152,52 +195,81 @@
   
   uint8_t    ret1;
  ADMCompressedImage img;
- ADMBitstream bitstream;
  
-      img.data=vbuffer;
-      bitstream.bufferSize=_incoming->getInfo ()->width *   _incoming->getInfo ()->height * 3;
-      bitstream.data=vbuffer;
+      img.data=vbuffer;      
       
-      
        if(!video_body->isReordered(frameStart+frame))
       {
-          ret1 = video_body->getFrameNoAlloc (frameStart + frame,&img);// vbuffer, &len,      &_videoFlag);
+          ret1 = video_body->getFrameNoAlloc (frameStart + frame,&img);
           _videoFlag=img.flags;
       }
       else
       {
-            // We prefectch one frame...
+            ret1=1;
+            // We prefetch one frame...
+           if(!frame) // First frame.
+           {
+                if(!prefetch(0,frame))
+                {
+                  return 0;
+                }
+                curToggle=0;
+           }
+           uint32_t len=0;
+            ADMBitstream *current,*next;
+                 current=lookAhead[curToggle];
+                 next=lookAhead[curToggle^1];
+           if(frame+2<_incoming->getInfo()->nb_frames)
+           {
+               
+                 
+                if( !prefetch(curToggle^1,frame+1))
+                    {
+                        return 0; 
+                    }
+                // Curtoggle holds the current frame, curToggle ^1 hold the next frame
+                if(current->flags!=AVI_B_FRAME && next->flags==AVI_B_FRAME)
+                {
+                    aprintf("Packing frame :%u\n",frame);
+                    // We need to pack this
+                    len=current->len;
+                    memcpy(vbuffer,current->data,len);
+                    memcpy(vbuffer+len,next->data,next->len);
+                    len+=next->len;
+                    img.dataLength=len;
+                    // Put nvop in next buffer
+                    putNvop(next,time_inc);
+                }else
+                {
+                    // Just send 
+                    len=current->len;
+                    memcpy(vbuffer,current->data,len);             
+                }
         
-           ret1=copy->encode(frame,&bitstream);
-           img.dataLength=bitstream.len;
-           _videoFlag=img.flags=bitstream.flags;
-           if(bitstream.flags==AVI_KEY_FRAME)
+           }
+           else
+           { 
+              // Last frame
+             aprintf("Last frame\n");
+              len= current->len;
+              memcpy(vbuffer,current->data,len);
+           }
+           img.dataLength=len;
+           _videoFlag=img.flags=current->flags;
+           if(_videoFlag==AVI_KEY_FRAME)
            {
-            updateUserData(bitstream.data,bitstream.len); 
+            updateUserData(vbuffer,len); 
            }
+           curToggle^=1;
       }
 
   if (!ret1)
     return 0;
 
-    // check for split
-     // check for auto split
-      // if so, we re-write the last I frame
-      if(muxSize)
-      	{
-                        // we overshot the limit and it is a key frame
-                // start a new chunk
-                if(handleMuxSize() && (_videoFlag & AVI_KEY_FRAME))
-                {		
-                    uint8_t *extraData;
-                    uint32_t extraLen;
+     if(_videoFlag==AVI_KEY_FRAME)
+          newFile();
 
-                  video_body->getExtraHeaderData(&extraLen,&extraData);
-      
-                  if(!reigniteChunk(extraLen,extraData)) return 0;
-                }
-          }
-  
+  aprintf("Writting frame %u size %u flags %x\n",frame,img.dataLength,_videoFlag);  
   encoding_gui->setFrame(frame,img.dataLength,0,frametogo);
   return writter->saveVideoFrame (img.dataLength, img.flags, img.data);
 
@@ -207,6 +279,7 @@
 // Update the user data field that is used to 
 // detect in windows world if it is packed or not
 //_____________________________________________________
+static char signature[]="DivX999b0000p\0";
 void updateUserData(uint8_t *start, uint32_t len)
 {
       // lookup startcode
@@ -223,34 +296,57 @@
       
               printf("User data found\n");
               // looks ok ?
-              if(!strncmp((char *)start,"DivX",4))
+              if(!strncmp((char *)start,"DivX",4) && start[7]=='b'&& rlen>=14)
               {
-
-                  //
-                  start+=4;
-                  rlen-=4; // skip "DivX"
-                              // looks for a p while not null
-                              // if there isnt we will reach a new startcode
-                              // and it will stop
-                              while((*start!='p') && rlen) 
-                              {
-                                      if(!*start)
-                                      {
-                                              rlen=0;
-                                              break;
-                                      }
-                                      rlen--;
-                                      start++;
-                              }
-                              if(!rlen) 
-                                      {
-                                              printf("Unpacketizer:packed marker not found!\n");
-                                      }
-                              else	
-                                      *start='n'; // remove 'p'
-                              return;			
+                memcpy(start,signature,4+3+4+1+1+1); // 14
               }
       }
 }
-
+/**
+        \fn     putNvop
+        \brief  Put a vop non coded bit
+        
+        
+        00 00 01 B6
+        2 bits : B vop : 10
+        1*X : Stuffing
+        1*0 : End of stuffing
+        1*0 : Marker
+        1*time_bit : time
+        1*0 : Marker
+        1*0 : Vop coded
+    
+*/
+extern "C"
+{
+#define av_always_inline inline
+#include "ADM_libraries/ADM_lavutil/bswap.h" 
+#include "ADM_libraries/ADM_lavcodec/bitstream.h" 
+}
+void putNvop(ADMBitstream *data,uint32_t time_inc)
+{
+  ADM_assert(data->data[0]==0);
+  ADM_assert(data->data[1]==0);
+  ADM_assert(data->data[2]==1);
+  ADM_assert(data->data[3]==0xB6); // Vop start
+  
+  
+  ADM_assert(data->len>=6);
+  ADM_assert(time_inc);
+  
+  PutBitContext pbs;
+  init_put_bits(&pbs, data->data+4, data->len-4);
+    
+  put_bits(&pbs, 2,2); // Bvop
+  put_bits(&pbs, 2,2); // Padding
+  put_bits(&pbs, 1,0); // Marker
+  if(time_inc!=0xFFFF)
+    put_bits(&pbs, time_inc,0); // time_inc
+  put_bits(&pbs, 1,0); // Marker
+  put_bits(&pbs, 1,0); // vop not coded
+  
+  flush_put_bits(&pbs);
+  int nb=put_bits_count(&pbs)>>3;
+  data->len=nb;
+}
 //EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp	2007-02-24 20:37:52 UTC (rev 2842)
@@ -161,23 +161,9 @@
   if (!ret1)
     return 0;
 
-    // check for split
-     // check for auto split
-      // if so, we re-write the last I frame
-      if(muxSize)
-      	{
-                        // we overshot the limit and it is a key frame
-                // start a new chunk
-                if(handleMuxSize() && (_videoFlag & AVI_KEY_FRAME))
-                {		
-                    uint8_t *extraData;
-                    uint32_t extraLen;
+      if(_videoFlag==AVI_KEY_FRAME)
+          newFile();
 
-                  video_body->getExtraHeaderData(&extraLen,&extraData);
-      
-                  if(!reigniteChunk(extraLen,extraData)) return 0;
-                }
-          }
   
   encoding_gui->setFrame(frame,img.dataLength,0,frametogo);
   return writter->saveVideoFrame (img.dataLength, img.flags, img.data);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_savecopy.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_savecopy.h	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_savecopy.h	2007-02-24 20:37:52 UTC (rev 2842)
@@ -23,6 +23,7 @@
 		                                EncoderCopy          *copy;	
 		          virtual uint8_t 	setupVideo( char *name  );
                           virtual uint8_t 	writeVideoChunk(uint32_t frame );
+                                  uint8_t       newFile(void);
 
      public:
                                               GenericAviSaveCopy()  :     GenericAviSave()
@@ -61,14 +62,20 @@
  {
      protected :
                           EncoderCopy          *copy;
-                          ADMBitstream         *lookAhead;
+                          ADMBitstream         *lookAhead[2];
+                          uint32_t              curToggle;
+                          uint32_t              time_inc;
                           virtual uint8_t 	setupVideo( char *name  );
                           virtual uint8_t 	writeVideoChunk(uint32_t frame );
+                                  uint8_t       prefetch(uint32_t buffer,uint32_t frame);
      public:
                           virtual	~GenericAviSaveCopyPack();	
                                         GenericAviSaveCopyPack()  :     GenericAviSaveCopy()
                                         {
-                                                lookAhead=NULL;
+                                                lookAhead[0]=NULL;
+                                                lookAhead[1]=NULL;
+                                                curToggle=0;
+                                                time_inc=0;
                                         };
   
  };

Modified: branches/avidemux_2.4_branch/avidemux/ADM_toolkit/automation.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_toolkit/automation.cpp	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/ADM_toolkit/automation.cpp	2007-02-24 20:37:52 UTC (rev 2842)
@@ -98,6 +98,7 @@
 extern uint8_t ogmSave(const char *fd);
 static void set_autoindex(char *p);
 extern int A_SaveUnpackedVop(const char *name);
+extern int A_SavePackedVop(const char *name);
 extern int A_saveDVDPS(char *name);
 extern void A_saveWorkbench (char *name);
 extern uint8_t A_rebuildKeyFrame (void);
@@ -153,7 +154,8 @@
         {"save-jpg",		1,"save a jpeg",			(one_arg_type)A_saveJpg}        ,
         {"begin",		1,"set start frame",			setBegin},
         {"end",			1,"set end frame",			setEnd},
-        {"save-unpacked-vop",	1,"save avi, unpacking vop",(one_arg_type)A_SaveUnpackedVop},		
+        {"save-unpacked-vop",	1,"save avi, unpacking vop",(one_arg_type)A_SaveUnpackedVop},
+        {"save-packed-vop",	1,"save avi, packing vop",(one_arg_type)A_SavePackedVop},				
         {"save-ogm",		1,"save as ogm file ",			(one_arg_type)ogmSave},
         {"save-raw-audio",	1,"save audio as-is ",			A_saveAudio},
         {"save-raw-video",	1,"save raw video stream (mpeg/... ) ",	(one_arg_type)ADM_saveRaw},

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp	2007-02-24 20:37:52 UTC (rev 2842)
@@ -1117,6 +1117,7 @@
   gtk_container_add (GTK_CONTAINER (alignment14), comboboxFormat);
   gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("AVI"));
   gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("AVI, unp. VOP"));
+  gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("AVI, pack.VOP"));
   gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("AVI, dual audio"));
   gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("OGM"));
   gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("MPEG video"));

Modified: branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2007-02-24 20:37:52 UTC (rev 2842)
@@ -141,6 +141,7 @@
 extern uint8_t DIA_gotoTime(uint16_t *hh, uint16_t *mm, uint16_t *ss);
 extern uint8_t GUI_getFrame(uint32_t frameno, ADMImage *image, uint32_t *flags);
 extern int A_SaveUnpackedVop(const char *name);
+extern int A_SavePackedVop(const char *name);
 extern void      videoCodecConfigureUI(void);
 extern void audioCodecChanged(int newcodec);
 extern void videoCodecChanged(int newcodec);

Modified: branches/avidemux_2.4_branch/avidemux/gui_savenew.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gui_savenew.cpp	2007-02-24 17:15:04 UTC (rev 2841)
+++ branches/avidemux_2.4_branch/avidemux/gui_savenew.cpp	2007-02-24 20:37:52 UTC (rev 2842)
@@ -57,6 +57,7 @@
 
 static uint8_t  A_SaveAudioNVideo(const char *name);
  extern int A_SaveUnpackedVop(const char *name);
+ extern int A_SavePackedVop(const char *name);
  extern uint8_t ogmSave(const char *name);
  extern uint8_t ADM_saveRaw(const char *name);
  uint8_t A_SaveAudioDualAudio(const char *name);
@@ -185,6 +186,10 @@
 						case ADM_AVI_DUAL:
 								ret=A_SaveAudioDualAudio(name);
 								break;
+                                                case ADM_AVI_PAK:
+								ret=A_SavePackedVop(name);
+								break;
+
 						case ADM_AVI_UNP:
 								ret=A_SaveUnpackedVop(name);
 								break;
@@ -271,6 +276,24 @@
 	delete nw;
 	return ret;
 }
+int A_SavePackedVop(const char *name)
+{
+  aviInfo info;
+GenericAviSave	*nw;
+int ret;
+
+	video_body->getVideoInfo(&info);
+	if( !isMpeg4Compatible(  info.fcc))
+	{
+          GUI_Error_HIG(_("This cannot have packed VOP"),_( "It is not MPEG-4 video. File will not be saved."));
+		return 0;
+        }
+	//
+	nw=new   GenericAviSaveCopyPack();
+	ret=nw->saveAvi(name);
+	delete nw;
+	return ret;
+}
 //___________________________________
 uint8_t  A_SaveAudioNVideo(const char *name)
 {



From mean at mail.berlios.de  Sat Feb 24 23:08:15 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sat, 24 Feb 2007 23:08:15 +0100
Subject: [Avidemux-svn-commit] r2843 -
	branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi
Message-ID: <200702242208.l1OM8Fc2027117@sheep.berlios.de>

Author: mean
Date: 2007-02-24 23:08:15 +0100 (Sat, 24 Feb 2007)
New Revision: 2843

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp
Log:
fix length (forgot vop header)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp	2007-02-24 20:37:52 UTC (rev 2842)
+++ branches/avidemux_2.4_branch/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp	2007-02-24 22:08:15 UTC (rev 2843)
@@ -347,6 +347,6 @@
   
   flush_put_bits(&pbs);
   int nb=put_bits_count(&pbs)>>3;
-  data->len=nb;
+  data->len=nb+4;
 }
 //EOF



From mean at mail.berlios.de  Sun Feb 25 10:17:51 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 25 Feb 2007 10:17:51 +0100
Subject: [Avidemux-svn-commit] r2844 - in
	branches/avidemux_2.4_branch/avidemux: ADM_editor
	ADM_userInterfaces/ADM_GTK/ADM_gui2
	ADM_userInterfaces/ADM_QT4/ADM_gui
Message-ID: <200702250917.l1P9HpvM019566@sheep.berlios.de>

Author: mean
Date: 2007-02-25 10:17:50 +0100 (Sun, 25 Feb 2007)
New Revision: 2844

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_outputfmt.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui
Log:
automatically build output format menu

Modified: branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_outputfmt.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_outputfmt.h	2007-02-24 22:08:15 UTC (rev 2843)
+++ branches/avidemux_2.4_branch/avidemux/ADM_editor/ADM_outputfmt.h	2007-02-25 09:17:50 UTC (rev 2844)
@@ -23,8 +23,30 @@
         ADM_TS,
         ADM_MP4,
         ADM_PSP,
-	ADM_FMT_DUMMY
+        ADM_FORMAT_MAX,
+	ADM_FMT_DUMMY=ADM_FORMAT_MAX
 }ADM_OUT_FORMAT;
 
+typedef struct 
+{
+  ADM_OUT_FORMAT format;
+  const char *text;
+}ADM_FORMAT_DESC;
+
+const ADM_FORMAT_DESC ADM_allOutputFormat[]=
+{
+  {     ADM_AVI,"Avi"},
+  {     ADM_AVI_UNP,"Avi,unp. vop"},
+  {     ADM_AVI_PAK,"Avi,Pack vop"},
+  {     ADM_AVI_DUAL,"Avi,dual audio"},
+  {	ADM_OGM,"OGM"},
+  {	ADM_ES,"Mpeg Video"},
+  {	ADM_PS,"Mpeg PS (A+V"},
+  {     ADM_TS,"Mpeg TS (A+V"},
+  {     ADM_MP4,"MP4"},
+  {     ADM_PSP,"PSP"},
+  
+};
+
 #endif
 //EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2007-02-24 22:08:15 UTC (rev 2843)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2007-02-25 09:17:50 UTC (rev 2844)
@@ -45,6 +45,7 @@
 #include "../ADM_toolkit/filesel.h"
 #include "../ADM_editor/ADM_Video.h"
 #include "../ADM_osSupport/ADM_misc.h"
+#include "../ADM_editor/ADM_outputfmt.h"
 #include "../prefs.h"
 
 
@@ -395,7 +396,18 @@
                 }
         gtk_combo_box_set_active(combo_box,0);
 	on_audio_change();
-        
+        /*   Fill in output format window */
+        uint32_t nbFormat;
+
+                nbFormat=sizeof(ADM_allOutputFormat)/sizeof(ADM_FORMAT_DESC);
+                combo_box=GTK_COMBO_BOX(lookup_widget(guiRootWindow,FORMAT_WIDGET));
+                gtk_combo_box_remove_text(combo_box,0);
+                printf("Found %d Format \n",nbFormat);		       
+                for(uint32_t i=0;i<nbFormat;i++)
+                {
+                        gtk_combo_box_append_text      (combo_box,_(ADM_allOutputFormat[i].text));	
+                }
+        gtk_combo_box_set_active(combo_box,0);
         /* File in preview mode combobox */
 
                 combo_box=GTK_COMBO_BOX(lookup_widget(guiRootWindow,PREVIEW_WIDGET));

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp	2007-02-24 22:08:15 UTC (rev 2843)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp	2007-02-25 09:17:50 UTC (rev 2844)
@@ -19,7 +19,9 @@
 #include "interface.h"
 #include "support.h"
 #else
-#include "../ADM_toolkit_gtk/ADM_gladeSupport.h"
+#include "default.h"
+#include "ADM_toolkit_gtk/toolkit_gtk.h"
+#include "ADM_toolkit_gtk/ADM_gladeSupport.h"
 #endif
 #define GLADE_HOOKUP_OBJECT(component,widget,name) \
   g_object_set_data_full (G_OBJECT (component), name, \
@@ -1115,16 +1117,6 @@
   comboboxFormat = gtk_combo_box_new_text ();
   gtk_widget_show (comboboxFormat);
   gtk_container_add (GTK_CONTAINER (alignment14), comboboxFormat);
-  gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("AVI"));
-  gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("AVI, unp. VOP"));
-  gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("AVI, pack.VOP"));
-  gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("AVI, dual audio"));
-  gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("OGM"));
-  gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("MPEG video"));
-  gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("MPEG PS A+V"));
-  gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("MPEG TS A+V"));
-  gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("MP4"));
-  gtk_combo_box_append_text (GTK_COMBO_BOX (comboboxFormat), _("PSP"));
 
   guiDrawing = gtk_drawing_area_new ();
   gtk_widget_show (guiDrawing);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2007-02-24 22:08:15 UTC (rev 2843)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2007-02-25 09:17:50 UTC (rev 2844)
@@ -159,6 +159,9 @@
      LIST_OF_BUTTONS
 #undef PROCESS
      // ComboBox
+         
+         
+         
          //ACT_VideoCodecChanged
          connect( ui.comboBoxVideo,SIGNAL(activated(int)),this,SLOT(comboChanged(int)));
          connect( ui.comboBoxAudio,SIGNAL(activated(int)),this,SLOT(comboChanged(int)));
@@ -355,6 +358,15 @@
                         name=audioFilterGetIndexedName(i);
                         WIDGET(comboBoxAudio)->addItem(name);
                 }
+      /*   Fill in output format window */
+        uint32_t nbFormat;
+
+                nbFormat=sizeof(ADM_allOutputFormat)/sizeof(ADM_FORMAT_DESC);
+                printf("Found %d Format \n",nbFormat);
+                for(uint32_t i=0;i<nbFormat;i++)
+                {
+                       WIDGET(comboBoxFormat)->addItem(_(ADM_allOutputFormat[i].text));	
+                }
         
 }
 /*

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui	2007-02-24 22:08:15 UTC (rev 2843)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui2.ui	2007-02-25 09:17:50 UTC (rev 2844)
@@ -702,51 +702,6 @@
             <verstretch>0</verstretch>
            </sizepolicy>
           </property>
-          <item>
-           <property name="text" >
-            <string>AVI</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>AVI unp vop</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>AVI dual audio</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>OGM</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>Mpeg Video</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>Mpeg PS</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>Mpeg TS</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>MP4</string>
-           </property>
-          </item>
-          <item>
-           <property name="text" >
-            <string>PSP (broken)</string>
-           </property>
-          </item>
          </widget>
         </item>
        </layout>



From mean at mail.berlios.de  Sun Feb 25 10:25:21 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 25 Feb 2007 10:25:21 +0100
Subject: [Avidemux-svn-commit] r2845 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI
Message-ID: <200702250925.l1P9PLS7019933@sheep.berlios.de>

Author: mean
Date: 2007-02-25 10:25:21 +0100 (Sun, 25 Feb 2007)
New Revision: 2845

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_bitrateHisto.cpp
Log:
display more info in bitrate histogram

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_bitrateHisto.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_bitrateHisto.cpp	2007-02-25 09:17:50 UTC (rev 2844)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_bitrateHisto.cpp	2007-02-25 09:25:21 UTC (rev 2845)
@@ -46,7 +46,11 @@
 
  float display[20];
 uint32_t medium=0;
-
+uint32_t nbIFrame=0;
+uint32_t nbPFrame=0;
+uint32_t nbBFrame=0;
+uint32_t curBFrame=0;
+uint32_t maxBFrame=0;
 	// 1st compute the total
 	
 	max=0;
@@ -65,6 +69,7 @@
 	sum=0;
 	changed=0;
         total=0;
+        uint32_t flags;
 	// 1 st pass, compute max
 	for( k=frameStart;k<frameEnd;k++)
 	{
@@ -77,6 +82,25 @@
 		if(sum>max) max=sum;
 		changed++;
 		changed%=round;
+                video_body->getFlags (k, &flags);
+                if(!flags) 
+                {
+                  nbPFrame++;
+                  curBFrame=0;
+                }
+                if(flags==AVI_KEY_FRAME) 
+                {
+                  nbIFrame++;
+                  curBFrame=0;
+                }
+                if(flags==AVI_B_FRAME)
+                {
+                  nbBFrame++;
+                  curBFrame++;
+                  if(curBFrame>maxBFrame) 
+                    maxBFrame=curBFrame;
+                  
+                }
 	}
         
         float g=total;
@@ -149,11 +173,16 @@
         }
         
         diaElemUInteger med(&medium,"Average bitrate",0,9999999);
+        diaElemUInteger nI(&nbIFrame,"Number of I frames",0,9999999);
+        diaElemUInteger nP(&nbPFrame,"Number of P frames",0,9999999);
+        diaElemUInteger nB(&nbBFrame,"Number of B frames",0,9999999);
+        diaElemUInteger nMB(&maxBFrame,"Max B frames",0,9999999);
         diaElemBar foo(0,"foo");
 #define P(X) bar[X] 
   
-      diaElem *elems[21]={
+      diaElem *elems[21+4]={
             &med,
+            &nI,&nP,&nB,&nMB,
             P(0),P(1),P(2),P(3),P(4),P(5),P(6),P(7),P(8),P(9),
             P(10),P(11),P(12),P(13),P(14),P(15),P(16),P(17),P(18),P(19)
           };



From mean at mail.berlios.de  Sun Feb 25 13:22:31 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 25 Feb 2007 13:22:31 +0100
Subject: [Avidemux-svn-commit] r2846 - in branches/avidemux_2.4_branch:
	autononreg/dialogFactory avidemux avidemux/ADM_osSupport
	avidemux/ADM_script
	avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory
	avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory
	avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory
	avidemux/ADM_userInterfaces/ADM_commonUI
Message-ID: <200702251222.l1PCMVfR015323@sheep.berlios.de>

Author: mean
Date: 2007-02-25 13:22:30 +0100 (Sun, 25 Feb 2007)
New Revision: 2846

Added:
   branches/avidemux_2.4_branch/autononreg/dialogFactory/readonlytext.js
   branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_crashdump.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_readOnlyText.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_readOnlyText.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_debug.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_osSupport/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
   branches/avidemux_2.4_branch/avidemux/main.cpp
Log:
crash dump + readonlytext dialogFactory

Copied: branches/avidemux_2.4_branch/autononreg/dialogFactory/readonlytext.js (from rev 2731, branches/avidemux_2.4_branch/autononreg/dialogFactory/toggle.js)
===================================================================
--- branches/avidemux_2.4_branch/autononreg/dialogFactory/toggle.js	2007-01-14 13:23:04 UTC (rev 2731)
+++ branches/avidemux_2.4_branch/autononreg/dialogFactory/readonlytext.js	2007-02-25 12:22:30 UTC (rev 2846)
@@ -0,0 +1,10 @@
+//AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
+var app = new Avidemux();
+var file="/work/samples/2mn.avi";
+var goodfcc="DIV3";
+var fps;
+
+	dialogFactoryRoText();
+
+/* End of test
+*/

Added: branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_crashdump.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_crashdump.cpp	2007-02-25 09:25:21 UTC (rev 2845)
+++ branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_crashdump.cpp	2007-02-25 12:22:30 UTC (rev 2846)
@@ -0,0 +1,178 @@
+/***************************************************************************
+  Try to display interesting crash dump
+
+    copyright            : (C) 2007 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "config.h"
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <stdarg.h>
+#include <string.h>
+#include <default.h>
+#include <ADM_assert.h>
+#include <math.h>
+
+#include "default.h"
+#include "ADM_userInterfaces/ADM_commonUI/DIA_factory.h"
+
+#ifdef CYG_MANGLING
+void installSigHandler()
+{
+
+}
+#else
+#include <signal.h>
+#include <execinfo.h>
+void sig_segfault_handler(int signo);
+void installSigHandler()
+{
+    signal(11, sig_segfault_handler); // show stacktrace on default
+}
+extern void ADMImage_stat( void );
+
+static int lenCount(uint8_t *start,uint8_t *end,int *d)
+{
+  int val=0;
+  int digit=0;
+  *d=0;
+  while(*start>='0' && *start<='9' && start<end) 
+  {
+    val=val*10+*start-'0'; 
+    start++;
+    digit++;
+  }
+  *d=digit;
+  return val;
+}
+
+static int decodeOne(uint8_t *start, uint8_t *end,int *cons)
+{
+  *cons=0;
+  int len,digit;
+  uint8_t *org=start;
+  if(start+2>=end) return 0;
+  switch(*start )
+  {
+    case 'Z':
+    case 'P':  
+      
+        len=lenCount(start+1,end,&digit);
+        start+=1+digit;
+        for(int z=0;z<len;z++) printf("%c",*start++);
+        break;
+  }
+  return (int)((uint64_t)start-(uint64_t)org);
+}
+static int demangle(int i,  uint8_t *string)
+{
+ // Search 1st (
+  if(!string) return 0;
+  int len=strlen((char *)string);
+  if(!len) return 0;
+   
+  uint8_t *end=string+len;
+  uint8_t *start=string;
+  
+  while(*start!='(' && start+3<end) start++;
+  if(*start!='(') return 0;
+  start++;
+  
+  //  _qt(_Z9crashTestP9JSContextP8JSObjectjPlS3_+0) [0x4acf80]
+  
+  if(*start!='_' || start[1]!='Z')
+  {
+    return 0;
+  }
+  // Seems good !
+  start++;
+  start++;  
+  int digit;
+  // Function name..
+  int l=lenCount(start,end,&digit);
+  printf("\t<");
+  for(int i=0;i<l;i++)
+  {
+    printf("%c",start[digit+i]); 
+  }
+  printf(">(");
+  start+=digit+l;
+  
+  // Parama
+  int first=0;
+  while(start+2<end && *start=='P')
+  {
+    if(!first)  first=1;
+    else
+        printf(",");
+    
+      
+    start++;
+    l=lenCount(start,end,&digit);
+    for(int i=0;i<l;i++)
+    {
+      printf("%c",start[digit+i]); 
+    }
+    start+=digit+l;
+  }
+  printf(")\n");
+  return 1;
+}
+
+/**
+      \fn sig_segfault_handler
+      \brief our segfault handler
+
+*/
+void sig_segfault_handler(int signo)
+{
+     
+     void *stack[20];
+     char **functions;
+     int count, i;
+     static int running=0;
+      if(running) 
+      {
+        signo=0;
+        exit(1);
+      }
+      running=0; 
+      
+      
+      
+      printf("\n*********** BACKTRACK **************\n");
+      count = backtrace(stack, 20);
+      functions = backtrace_symbols(stack, count);
+      
+         for (i=0; i < count; i++) 
+         {
+            printf("Frame %2d: %s \n", i, functions[i]);
+            demangle(i,(uint8_t *)functions[i]);
+            
+         }
+      printf("*********** BACKTRACK **************\n");
+     // Now use dialogFactory
+      diaElemReadOnlyText *txt[count];
+      for(i=0;i<count;i++)
+          txt[i]=new diaElemReadOnlyText(functions[i],"Function:");
+      diaFactoryRun("BackTrace",count,(diaElem **)txt);
+      
+      //
+     printf("Memory stat:\n");
+     ADMImage_stat();
+     signo=0; // will keep GCC happy
+     exit(1); // _exit(1) ???
+}
+#endif
+//EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_debug.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_debug.cpp	2007-02-25 09:25:21 UTC (rev 2845)
+++ branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_debug.cpp	2007-02-25 12:22:30 UTC (rev 2846)
@@ -16,22 +16,24 @@
  *                                                                         *
  ***************************************************************************/
 
+#include "config.h"
 
 #include <stdio.h>
 #include <stdlib.h>
 #include <stdarg.h>
 #include <string.h>
+#include <default.h>
 #include <ADM_assert.h>
 #include <math.h>
 
-#include "config.h"
+
 #include "ADM_osSupport/ADM_debugID.h"
 #define MODULE_NAME MODULE_DEBUG
 #include "ADM_debug.h"
 
 // put here the module you want to be verbose (MODULE_xxx + MODULE_yyyy+  ....)
 #ifndef masked
-#define masked  (0*MODULE_LAVFORMAT) //+MODULE_3GP) //(MODULE_AUDIO_EDITOR) MODULE_OGM_AUDIO MODULE_REQUANT MODULE_CODEC
+#define masked  (0*MODULE_UNPACKER+ 0*MODULE_LAVFORMAT) //+MODULE_3GP) //(MODULE_AUDIO_EDITOR) MODULE_OGM_AUDIO MODULE_REQUANT MODULE_CODEC
 #endif
 
 // If the entitty is in masked we actually print the string
@@ -58,3 +60,5 @@
   }
 
 }
+
+//EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_osSupport/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_osSupport/Makefile.am	2007-02-25 09:25:21 UTC (rev 2845)
+++ branches/avidemux_2.4_branch/avidemux/ADM_osSupport/Makefile.am	2007-02-25 12:22:30 UTC (rev 2846)
@@ -8,7 +8,7 @@
 libADM_ossupport_a_SOURCES = \
 ADM_cpuCap.cpp  ADM_memcpy.cpp  ADM_misc.cpp   ADM_quota.cpp    TLK_clock.cpp \
 ADM_debug.cpp   ADM_memory.cpp  ADM_queue.cpp  ADM_threads.cpp  win32.cpp \
-ADM_memsupport.cpp ADM_fileio.cpp
+ADM_memsupport.cpp ADM_fileio.cpp ADM_crashdump.cpp
 
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp	2007-02-25 09:25:21 UTC (rev 2845)
+++ branches/avidemux_2.4_branch/avidemux/ADM_script/ADM_JSFunctions.cpp	2007-02-25 12:22:30 UTC (rev 2846)
@@ -74,6 +74,8 @@
 JSBool facFile(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool facBitrate(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 JSBool facBar(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
+JSBool facRoText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
+JSBool crashTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 
 
 static JSFunctionSpec adm_functions[] = {
@@ -97,7 +99,9 @@
   {"dialogFactoryMenu",         facMenu,        0},
   {"dialogFactoryFileSel",      facFile,        0},
   {"dialogFactoryBitrate",      facBitrate,        0},
-  {"dialogFactoryBar",          facBar,        0},
+  {"dialogFactoryBar",        facBar,        0},
+  {"dialogFactoryRoText",     facRoText,        0},
+  {"crashTest",               crashTest,        0},
   {0}
 };
 
@@ -605,5 +609,27 @@
   
   return JS_TRUE;
 }
+JSBool facRoText(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+    
+      diaElemReadOnlyText txt("blah blah","Value:");
+      
+      diaElem *elems[]={&txt   };
+  if(diaFactoryRun("Test FileRead",1,elems))
+  {
+    *rval = BOOLEAN_TO_JSVAL(1);
+    
+  }else
+    *rval = BOOLEAN_TO_JSVAL(0);
+  
+  return JS_TRUE;
+}
+JSBool crashTest(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+  
+  int *foobar=NULL;
+  *foobar=0; // CRASH!
+  return JS_TRUE;
+}
 
 //EOF 

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_readOnlyText.cpp (from rev 2818, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_integer.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_integer.cpp	2007-02-13 19:16:54 UTC (rev 2818)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_readOnlyText.cpp	2007-02-25 12:22:30 UTC (rev 2846)
@@ -0,0 +1,79 @@
+/***************************************************************************
+  FAC_toggle.cpp
+  Handle dialog factory element : Toggle
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <config.h>
+
+
+#include <string.h>
+#include <stdio.h>
+#include <math.h>
+
+#include "default.h"
+#include "ADM_toolkit_gtk/ADM_gladeSupport.h"
+#include "ADM_toolkit_gtk/toolkit_gtk.h"
+#include "ADM_toolkit_gtk/toolkit_gtk_include.h"
+#include "ADM_commonUI/DIA_factory.h"
+#include "ADM_assert.h"
+
+
+
+
+diaElemReadOnlyText::diaElemReadOnlyText(char *readyOnly,const char *toggleTitle,const char *tip)
+  : diaElem(ELEM_ROTEXT)
+{
+  param=(void *)readyOnly;
+  paramTitle=toggleTitle;
+  this->tip=tip;
+}
+
+diaElemReadOnlyText::~diaElemReadOnlyText()
+{
+  
+}
+void diaElemReadOnlyText::setMe(void *dialog, void *opaque,uint32_t line)
+{
+  GtkWidget *widget;
+  GtkObject *adj;
+  GtkWidget *label,*label2;
+  
+  label = gtk_label_new_with_mnemonic (paramTitle);
+  gtk_misc_set_alignment (GTK_MISC (label), 0.0, 0.5);
+  gtk_widget_show(label);
+  
+  gtk_table_attach (GTK_TABLE (opaque), label, 0, 1, line, line+1,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  
+  label2 = gtk_label_new_with_mnemonic ((char *)param);
+  gtk_misc_set_alignment (GTK_MISC (label2), 0.0, 0.5);
+  gtk_widget_show(label2);
+  
+ 
+  
+  gtk_table_attach (GTK_TABLE (opaque), label2, 1, 2, line, line+1,
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  
+  gtk_label_set_mnemonic_widget (GTK_LABEL(label), label2);
+  
+  myWidget=(void *)label2;
+  
+}
+void diaElemReadOnlyText::getMe(void)
+{
+ 
+  
+}
+//EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-02-25 09:25:21 UTC (rev 2845)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-02-25 12:22:30 UTC (rev 2846)
@@ -9,6 +9,6 @@
 libADM_dialogFactory_a_METASOURCES = AUTO
 
 libADM_dialogFactory_a_SOURCES = DIA_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_float.cpp FAC_menu.cpp \
-				DIA_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp
+				DIA_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp FAC_ReadOnlyText.cpp
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp	2007-02-25 09:25:21 UTC (rev 2845)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp	2007-02-25 12:22:30 UTC (rev 2846)
@@ -181,6 +181,24 @@
 {
  
 }
-             
 //******************************************************
+diaElemReadOnlyText::diaElemReadOnlyText(char *readyOnly,const char *toggleTitle,const char *tip)
+  : diaElem(ELEM_ROTEXT)
+{
+ 
+} 
+diaElemReadOnlyText::~diaElemReadOnlyText()
+{
+  
+}
+void diaElemReadOnlyText::setMe(void *dialog, void *opaque,uint32_t line)
+{
+ 
+  
+}
+void diaElemReadOnlyText::getMe(void)
+{
+ 
+}            
+//******************************************************
 //EOF

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_readOnlyText.cpp (from rev 2818, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_integer.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_integer.cpp	2007-02-13 19:16:54 UTC (rev 2818)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_readOnlyText.cpp	2007-02-25 12:22:30 UTC (rev 2846)
@@ -0,0 +1,71 @@
+/***************************************************************************
+  FAC_toggle.cpp
+  Handle dialog factory element : Toggle
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <config.h>
+
+
+#include <string.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <math.h>
+
+#include <QDialog>
+#include <QSpinBox>
+#include <QGridLayout>
+#include <QLabel>
+
+#include "default.h"
+#include "ADM_commonUI/DIA_factory.h"
+#include "ADM_assert.h"
+
+
+extern const char *shortkey(const char *);
+
+
+
+//********************************************************************
+diaElemReadOnlyText::diaElemReadOnlyText(char *readyOnly,const char *toggleTitle,const char *tip)
+  : diaElem(ELEM_TOGGLE)
+{
+  param=(void *)readyOnly;
+  paramTitle=shortkey(toggleTitle);
+  this->tip=tip;
+ }
+
+diaElemReadOnlyText::~diaElemReadOnlyText()
+{
+  if(paramTitle)
+    delete paramTitle;
+}
+void diaElemReadOnlyText::setMe(void *dialog, void *opaque,uint32_t line)
+{
+
+  QGridLayout *layout=(QGridLayout*) opaque;
+
+   
+ 
+ QLabel *text=new QLabel( this->paramTitle,(QWidget *)dialog);
+  QLabel *text2=new QLabel( (char *)param,(QWidget *)dialog);
+ text->setBuddy(text2);
+ layout->addWidget(text,line,0);
+ layout->addWidget(text2,line,1);
+ myWidget=(void *)text2;  
+}
+void diaElemReadOnlyText::getMe(void)
+{
+
+ 
+}
+//EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-25 09:25:21 UTC (rev 2845)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-25 12:22:30 UTC (rev 2846)
@@ -3,7 +3,7 @@
 
 libADM_dialogFactory_a_METASOURCES = AUTO
 
-libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp AT_filesel.cpp AT_bitrate.cpp FAC_bar.cpp
+libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp AT_filesel.cpp AT_bitrate.cpp FAC_bar.cpp FAC_readOnlyText.cpp
 
 
 INCLUDES = $(all_includes)  $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-25 09:25:21 UTC (rev 2845)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-25 12:22:30 UTC (rev 2846)
@@ -26,6 +26,7 @@
   ELEM_FILE_READ,
   ELEM_BITRATE,
   ELEM_BAR,
+  ELEM_ROTEXT,
   ELEM_MAX=ELEM_TOGGLE
 };
 /*********************************************/
@@ -156,6 +157,20 @@
   
   void changeFile(void);
 };
+/*************************************************/
+class diaElemReadOnlyText : public diaElem
+{
+
+public:
+  
+  diaElemReadOnlyText(char *readyOnly,const char *toggleTitle,const char *tip=NULL);
+  virtual ~diaElemReadOnlyText() ;
+  void setMe(void *dialog, void *opaque,uint32_t line);
+  void getMe(void);
+  
+  void changeFile(void);
+};
+
 /*********************************************/
 uint8_t diaFactoryRun(const char *title,uint32_t nb,diaElem **elems);
 /*********************************************/

Modified: branches/avidemux_2.4_branch/avidemux/main.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/main.cpp	2007-02-25 09:25:21 UTC (rev 2845)
+++ branches/avidemux_2.4_branch/avidemux/main.cpp	2007-02-25 12:22:30 UTC (rev 2846)
@@ -21,7 +21,6 @@
 #include <stdio.h>
 #include <stdlib.h>
 #include <glib.h>
-#include <signal.h>
 
 #ifdef HAVE_GETTEXT
 #include <libintl.h>
@@ -42,6 +41,7 @@
 #include "prefs.h"
 #include "ADM_audiodevice/audio_out.h"
 #include "ADM_toolkit/ADM_intfloat.h"
+
 #ifdef USE_XVID_4
 extern void xvid4_init(void);
 #endif
@@ -82,10 +82,8 @@
 extern void ADM_memStat( void );
 extern void ADM_memStatInit( void );
 extern void ADM_memStatEnd( void );
+extern void installSigHandler(void);
 
-
-void sig_segfault_handler(int signo);
-
 extern uint8_t  quotaInit(void);
 extern void ADMImage_stat( void );
 extern uint8_t win32_netInit(void);
@@ -120,8 +118,9 @@
 
 
 // thx smurf uk :)
-    signal(11, sig_segfault_handler); // show stacktrace on default
+    installSigHandler();
 
+
     printf("\n*******************\n");
     printf("  Avidemux 2, v  " VERSION "\n");
     printf("*******************\n");
@@ -278,15 +277,3 @@
         ADM_memStatEnd(  );
         printf("\n Goodbye...\n\n");
 }
-void sig_segfault_handler(int signo)
-{
-     ADMImage_stat();
-     g_on_error_stack_trace ("avidemux");
-     printf("Memory stat:\n");
-
-//   g_on_error_query (programname);
-
-
-     signo=0; // will keep GCC happy
-     exit(1); // _exit(1) ???
-}



From mean at mail.berlios.de  Sun Feb 25 17:47:06 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 25 Feb 2007 17:47:06 +0100
Subject: [Avidemux-svn-commit] r2847 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory
Message-ID: <200702251647.l1PGl67v009041@sheep.berlios.de>

Author: mean
Date: 2007-02-25 17:47:06 +0100 (Sun, 25 Feb 2007)
New Revision: 2847

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
Log:
oops

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-02-25 12:22:30 UTC (rev 2846)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-02-25 16:47:06 UTC (rev 2847)
@@ -9,6 +9,6 @@
 libADM_dialogFactory_a_METASOURCES = AUTO
 
 libADM_dialogFactory_a_SOURCES = DIA_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_float.cpp FAC_menu.cpp \
-				DIA_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp FAC_ReadOnlyText.cpp
+				DIA_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp FAC_readOnlyText.cpp
 
 



From mean at mail.berlios.de  Sun Feb 25 18:15:16 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 25 Feb 2007 18:15:16 +0100
Subject: [Avidemux-svn-commit] r2848 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2
Message-ID: <200702251715.l1PHFGmd013162@sheep.berlios.de>

Author: mean
Date: 2007-02-25 18:15:15 +0100 (Sun, 25 Feb 2007)
New Revision: 2848

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
Log:
disable vcodec when using pack/unpack bitstream

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2007-02-25 16:47:06 UTC (rev 2847)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2007-02-25 17:15:15 UTC (rev 2848)
@@ -86,6 +86,7 @@
 static void on_audio_change(void);
 static void on_video_change(void);
 static void on_preview_change(void);
+static void on_format_change(void);
 static int update_ui=0;
 
 static void GUI_initCustom(void);
@@ -431,6 +432,9 @@
         gtk_signal_connect(GTK_OBJECT(lookup_widget(guiRootWindow,PREVIEW_WIDGET)), "changed",
                        GTK_SIGNAL_FUNC(on_preview_change),
                        NULL);
+        gtk_signal_connect(GTK_OBJECT(lookup_widget(guiRootWindow,FORMAT_WIDGET)), "changed",
+                       GTK_SIGNAL_FUNC(on_format_change),
+                       NULL);
         
         // Add initial recent files
         UI_updateRecentMenu(  );
@@ -848,7 +852,22 @@
         HandleAction(ACT_PreviewChanged);
 
 }
+void on_format_change(void)
+{
+int enable;
+       if(update_ui) return;
+        ADM_OUT_FORMAT fmt=UI_GetCurrentFormat();
+        if(fmt==ADM_AVI_UNP || fmt==ADM_AVI_PAK)
+        {
+          gtk_widget_set_sensitive(lookup_widget(guiRootWindow,VIDEO_WIDGET),0);  
+          
+        }else
+        {
+          gtk_widget_set_sensitive(lookup_widget(guiRootWindow,VIDEO_WIDGET),1);  
+        }
 
+}
+
 int  UI_getCurrentPreview(void)
  {
        



From mean at mail.berlios.de  Sun Feb 25 18:34:26 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Sun, 25 Feb 2007 18:34:26 +0100
Subject: [Avidemux-svn-commit] r2849 -
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI
Message-ID: <200702251734.l1PHYQL6022953@sheep.berlios.de>

Author: mean
Date: 2007-02-25 18:34:24 +0100 (Sun, 25 Feb 2007)
New Revision: 2849

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_bitrateHisto.cpp
Log:
more info, better looking bitrate histogram

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_bitrateHisto.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_bitrateHisto.cpp	2007-02-25 17:15:15 UTC (rev 2848)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_bitrateHisto.cpp	2007-02-25 17:34:24 UTC (rev 2849)
@@ -38,7 +38,7 @@
 void GUI_displayBitrate( void )
 {
 
-  int32_t total,max;
+ uint32_t total,max;
  uint32_t len,idx,nb_frame,k,changed;
  uint32_t round,sum,average[60];;
 
@@ -71,6 +71,10 @@
         total=0;
         uint32_t flags;
 	// 1 st pass, compute max
+        /*
+            to do so : We compute the sum of frame size on [changed] frames i.e ~ 1 second
+        
+        */
 	for( k=frameStart;k<frameEnd;k++)
 	{
  		video_body->getFrameSize (k, &len);
@@ -108,15 +112,17 @@
         g*=avifileinfo->fps1000;
         g/=(1000.*1000.);
         medium=(uint32_t)(g*8);
+        
+        max=(max*8)/1000; // Max is now in kByte
+        
         printf("Average :%u max%u\n",medium,max);
-#if 0
-#define ROUNDUP 20*1000
-        uint32_t s;
-	s=(max+ROUNDUP -1)/ROUNDUP;
-	max=s*ROUNDUP;
-#endif
 
-	printf("\n Total : %lu bytes, max br %d bytes round %d\n",total,max,round);
+        /* Round up to the closer 200 kb */
+#define ROUNDUP 200
+        max=(max+ROUNDUP-1)/ROUNDUP;
+        max=max*ROUNDUP;
+        
+
 	if(!max)
 	{
           GUI_Error_HIG(_("No data"), NULL);
@@ -131,8 +137,9 @@
 
 	sum=0;
 	changed=0;
-        uint32_t step=(max*8)/20000;
-
+        uint32_t step=max/20;
+        uint32_t sumkb;
+        
 	for(uint32_t k=frameStart;k<frameEnd;k++)
 	{
 		video_body->getFrameSize (k, &len);
@@ -146,7 +153,7 @@
 		changed++;
 		changed%=round;
 
-		f=sum;
+		f=(sum*8)/1000;
 		f=f/max;
 		f=f*20.;
 		idx=(uint32_t )floor(f+0.5);
@@ -155,23 +162,25 @@
 		display[idx]++;
 	}
 
+        // So now we have a distribution
 
-	for(k=0;k<20;k++) display[k]=(100*display[k])/nb_frame;
-	for(k=0;k<20;k++)
-	{
-		printf(" %d , %04d -- %04d percent -> %02.1f\n",k,(max*k*8)/20000,(8*max*(k+1))/20000,display[k]);
-
-	}
+	for(k=0;k<20;k++) 
+        {
+          printf("%02u %04u %04u\n",k,(uint32_t)display[k],(uint32_t)(100.*display[k])/nb_frame);
+          display[k]=(100*display[k])/nb_frame;
+        }
+	
         
         diaElemBar *bar[20];
         char str[256];
         for(int i=0;i<20;i++)
         {
-          sprintf(str,"%03u--%03u",step*i,step*(i+1));
+          printf("%03u--%03u :%02u\n",step*i,step*(i+1),(uint32_t)display[i]);
+          sprintf(str,"%04u--%04u",step*i,step*(i+1));
           bar[19-i]=new  diaElemBar((uint32_t)display[i],str);
             
         }
-        
+        diaElemUInteger mx(&max,"Max bitrate",0,9999999);
         diaElemUInteger med(&medium,"Average bitrate",0,9999999);
         diaElemUInteger nI(&nbIFrame,"Number of I frames",0,9999999);
         diaElemUInteger nP(&nbPFrame,"Number of P frames",0,9999999);
@@ -180,14 +189,15 @@
         diaElemBar foo(0,"foo");
 #define P(X) bar[X] 
   
-      diaElem *elems[21+4]={
+      diaElem *elems[20+6]={
+            &mx,
             &med,
             &nI,&nP,&nB,&nMB,
             P(0),P(1),P(2),P(3),P(4),P(5),P(6),P(7),P(8),P(9),
             P(10),P(11),P(12),P(13),P(14),P(15),P(16),P(17),P(18),P(19)
           };
     
-        diaFactoryRun(_("Bitrate Histogram"),21,elems);
+        diaFactoryRun(_("Bitrate Histogram"),20+6,elems);
         
         
         for(int i=0;i<20;i++)



From mean at mail.berlios.de  Mon Feb 26 20:08:25 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Mon, 26 Feb 2007 20:08:25 +0100
Subject: [Avidemux-svn-commit] r2850 - in
	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces:
	ADM_GTK/ADM_dialogFactory ADM_NONE/ADM_dialogFactory
	ADM_QT4/ADM_dialogFactory ADM_commonUI
Message-ID: <200702261908.l1QJ8Pca018218@sheep.berlios.de>

Author: mean
Date: 2007-02-26 20:08:22 +0100 (Mon, 26 Feb 2007)
New Revision: 2850

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_notch.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_notch.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
Log:
better looking builtin

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_notch.cpp (from rev 2818, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_toggle.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_toggle.cpp	2007-02-13 19:16:54 UTC (rev 2818)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_notch.cpp	2007-02-26 19:08:22 UTC (rev 2850)
@@ -0,0 +1,73 @@
+/***************************************************************************
+  FAC_toggle.cpp
+  Handle dialog factory element : Toggle
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <config.h>
+
+
+#include <string.h>
+#include <stdio.h>
+#include <math.h>
+
+#include "default.h"
+#include "ADM_toolkit_gtk/ADM_gladeSupport.h"
+#include "ADM_toolkit_gtk/toolkit_gtk.h"
+#include "ADM_toolkit_gtk/toolkit_gtk_include.h"
+#include "ADM_commonUI/DIA_factory.h"
+#include "ADM_assert.h"
+
+
+
+
+diaElemNotch::diaElemNotch(uint32_t yes,const char *toggleTitle, const char *tip)
+  : diaElem(ELEM_NOTCH)
+{
+  yesno=yes;
+  paramTitle=toggleTitle;
+  this->tip=tip;
+}
+
+diaElemNotch::~diaElemNotch()
+{
+  
+}
+void diaElemNotch::setMe(void *dialog, void *opaque,uint32_t line)
+{
+  GtkWidget *widget;
+  
+  if(yesno)
+    widget = gtk_image_new_from_stock ("gtk-apply", GTK_ICON_SIZE_BUTTON);
+  else
+    widget = gtk_image_new_from_stock ("gtk-cancel", GTK_ICON_SIZE_BUTTON);
+  
+  gtk_widget_show (widget);
+  myWidget=(void *)widget;
+  
+  gtk_table_attach (GTK_TABLE (opaque), widget, 0, 1, line, line+1,
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  
+  GtkWidget *label;
+  
+  label = gtk_label_new_with_mnemonic (paramTitle);
+  gtk_misc_set_alignment (GTK_MISC (label), 0.0, 0.5);
+  gtk_widget_show(label);
+  
+  gtk_table_attach (GTK_TABLE (opaque), label, 1, 2, line, line+1,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  
+}
+
+//EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-02-25 17:34:24 UTC (rev 2849)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-02-26 19:08:22 UTC (rev 2850)
@@ -9,6 +9,6 @@
 libADM_dialogFactory_a_METASOURCES = AUTO
 
 libADM_dialogFactory_a_SOURCES = DIA_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_float.cpp FAC_menu.cpp \
-				DIA_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp FAC_readOnlyText.cpp
+				DIA_filesel.cpp FAC_bitrate.cpp FAC_bar.cpp FAC_readOnlyText.cpp FAC_notch.cpp
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp	2007-02-25 17:34:24 UTC (rev 2849)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialogFactory/FAC_toggle.cpp	2007-02-26 19:08:22 UTC (rev 2850)
@@ -199,6 +199,22 @@
 void diaElemReadOnlyText::getMe(void)
 {
  
-}            
+}
 //******************************************************
+diaElemNotch::diaElemNotch(uint32_t yes,const char *toggleTitle, const char *tip)
+  : diaElem(ELEM_NOTCH)
+{
+ 
+}
+
+diaElemNotch::~diaElemNotch()
+{
+  
+}
+void diaElemNotch::setMe(void *dialog, void *opaque,uint32_t line)
+{
+  
+}
+            
+//******************************************************
 //EOF

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_notch.cpp (from rev 2818, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_toggle.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_toggle.cpp	2007-02-13 19:16:54 UTC (rev 2818)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_notch.cpp	2007-02-26 19:08:22 UTC (rev 2850)
@@ -0,0 +1,51 @@
+/***************************************************************************
+  FAC_toggle.cpp
+  Handle dialog factory element : Toggle
+  (C) 2006 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <config.h>
+
+
+#include <string.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <math.h>
+
+#include <QDialog>
+#include <QMessageBox>
+#include <QGridLayout>
+#include <QCheckBox>
+
+#include "default.h"
+#include "ADM_commonUI/DIA_factory.h"
+#include "ADM_assert.h"
+
+extern const char *shortkey(const char *);
+
+diaElemNotch::diaElemNotch(uint32_t yes,const char *toggleTitle, const char *tip)
+  : diaElem(ELEM_NOTCH)
+{
+ 
+}
+
+diaElemNotch::~diaElemNotch()
+{
+  
+}
+void diaElemNotch::setMe(void *dialog, void *opaque,uint32_t line)
+{
+  
+}
+//******************************************************
+
+//EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-25 17:34:24 UTC (rev 2849)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/Makefile.am	2007-02-26 19:08:22 UTC (rev 2850)
@@ -3,7 +3,7 @@
 
 libADM_dialogFactory_a_METASOURCES = AUTO
 
-libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp AT_filesel.cpp AT_bitrate.cpp FAC_bar.cpp FAC_readOnlyText.cpp
+libADM_dialogFactory_a_SOURCES = AT_dialogFactory.cpp FAC_toggle.cpp FAC_integer.cpp FAC_menu.cpp FAC_float.cpp AT_filesel.cpp AT_bitrate.cpp FAC_bar.cpp FAC_readOnlyText.cpp FAC_notch.cpp
 
 
 INCLUDES = $(all_includes)  $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp	2007-02-25 17:34:24 UTC (rev 2849)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp	2007-02-26 19:08:22 UTC (rev 2850)
@@ -92,7 +92,7 @@
 #endif
 
         
-#define CREATE_TOGGLE(x)  diaElemToggle     t##x(&x,_("Option "#x));
+#define CREATE_TOGGLE(x)  diaElemNotch     t##x(x,_("Option "#x));
     
     
     CREATE_TOGGLE(mad)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-25 17:34:24 UTC (rev 2849)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-02-26 19:08:22 UTC (rev 2850)
@@ -27,6 +27,7 @@
   ELEM_BITRATE,
   ELEM_BAR,
   ELEM_ROTEXT,
+  ELEM_NOTCH,
   ELEM_MAX=ELEM_TOGGLE
 };
 /*********************************************/
@@ -170,8 +171,18 @@
   
   void changeFile(void);
 };
-
 /*********************************************/
+class diaElemNotch : public diaElem
+{
+  uint32_t yesno;
+public:
+  
+  diaElemNotch(uint32_t yes,const char *toggleTitle, const char *tip=NULL);
+  virtual ~diaElemNotch() ;
+  void setMe(void *dialog, void *opaque,uint32_t line);
+  void getMe(void) {};
+};
+/*********************************************/
 uint8_t diaFactoryRun(const char *title,uint32_t nb,diaElem **elems);
 /*********************************************/
 #endif



From mean at mail.berlios.de  Tue Feb 27 19:56:09 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 27 Feb 2007 19:56:09 +0100
Subject: [Avidemux-svn-commit] r2851 - in
	branches/avidemux_2.4_branch/avidemux: .
	ADM_userInterfaces/ADM_QT4/ADM_dialog
	ADM_userInterfaces/ADM_QT4/ADM_dialogFactory
	ADM_userInterfaces/ADM_commonUI
Message-ID: <200702271856.l1RIu9V1027705@sheep.berlios.de>

Author: mean
Date: 2007-02-27 19:56:08 +0100 (Tue, 27 Feb 2007)
New Revision: 2851

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_notch.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp
   branches/avidemux_2.4_branch/avidemux/Makefile.am
Log:
builtin for QT too , checkbox based

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-02-26 19:08:22 UTC (rev 2850)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-02-27 18:56:08 UTC (rev 2851)
@@ -108,7 +108,6 @@
 uint8_t  DIA_job_select(char **jobname, char **filename) {return 0;}
 uint8_t DIA_audioTrack(AudioSource *source, uint32_t *track,uint32_t nbTrack, audioInfo *infos){return 0;}
 const char * GUI_getCustomScript(uint32_t nb) {return 0;}
-uint8_t DIA_builtin(void){return 0;}
 uint8_t  DIA_v2v(char **vobname, char **ifoname,char **vobsubname) {return 0;}
 uint8_t DIA_RecentFiles( char **name ){return 0;}
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_notch.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_notch.cpp	2007-02-26 19:08:22 UTC (rev 2850)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/FAC_notch.cpp	2007-02-27 18:56:08 UTC (rev 2851)
@@ -35,7 +35,9 @@
 diaElemNotch::diaElemNotch(uint32_t yes,const char *toggleTitle, const char *tip)
   : diaElem(ELEM_NOTCH)
 {
- 
+  yesno=yes;
+  paramTitle=toggleTitle;
+  this->tip=tip;
 }
 
 diaElemNotch::~diaElemNotch()
@@ -44,7 +46,15 @@
 }
 void diaElemNotch::setMe(void *dialog, void *opaque,uint32_t line)
 {
-  
+  QCheckBox *box=new QCheckBox(paramTitle,(QWidget *)dialog);
+ QGridLayout *layout=(QGridLayout*) opaque;
+ myWidget=(void *)box; 
+ if( yesno)
+ {
+    box->setCheckState(Qt::Checked); 
+ }
+ box->show();
+ layout->addWidget(box,line,0);
 }
 //******************************************************
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp	2007-02-26 19:08:22 UTC (rev 2850)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_builtin.cpp	2007-02-27 18:56:08 UTC (rev 2851)
@@ -27,15 +27,15 @@
 
 #include <string.h>
 #include <stdio.h>
-# include <math.h>
+#include <math.h>
 
-
 #include "default.h"
-#include "default.h"
+#include "ADM_osSupport/ADM_misc.h"
+#include "DIA_factory.h"
 #include "ADM_assert.h"
 
-#include "DIA_factory.h"
-#define CHECK_SET(x) {gtk_toggle_button_set_active( GTK_TOGGLE_BUTTON(WID(x)),1);}
+
+
 /**
     \fn DIA_builtin(void)
     \brief Display component that are built in. They are detected at configure time.

Modified: branches/avidemux_2.4_branch/avidemux/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/Makefile.am	2007-02-26 19:08:22 UTC (rev 2850)
+++ branches/avidemux_2.4_branch/avidemux/Makefile.am	2007-02-27 18:56:08 UTC (rev 2851)
@@ -46,6 +46,7 @@
 			./ADM_userInterfaces/ADM_QT4/ADM_dialog/libADM_dialog.a	\
 			./ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/libADM_dialogFactory.a	\
 			./ADM_userInterfaces/ADM_commonUI/libADM_CommonUI.a	\
+			./ADM_userInterfaces/ADM_QT4/ADM_dialogFactory/libADM_dialogFactory.a	\
 			./ADM_userInterfaces/ADM_QT4/ADM_gui/libADM_gui2.a	\
 			./ADM_userInterfaces/ADM_QT4/ADM_filters/libADM_filters.a 
 



From mean at mail.berlios.de  Tue Feb 27 22:05:19 2007
From: mean at mail.berlios.de (mean at BerliOS)
Date: Tue, 27 Feb 2007 22:05:19 +0100
Subject: [Avidemux-svn-commit] r2852 -
	branches/avidemux_2.4_branch/autononreg/functiontest
Message-ID: <200702272105.l1RL5Js4009449@sheep.berlios.de>

Author: mean
Date: 2007-02-27 22:05:19 +0100 (Tue, 27 Feb 2007)
New Revision: 2852

Added:
   branches/avidemux_2.4_branch/autononreg/functiontest/crash.js
Log:
util

Added: branches/avidemux_2.4_branch/autononreg/functiontest/crash.js
===================================================================
--- branches/avidemux_2.4_branch/autononreg/functiontest/crash.js	2007-02-27 18:56:08 UTC (rev 2851)
+++ branches/avidemux_2.4_branch/autononreg/functiontest/crash.js	2007-02-27 21:05:19 UTC (rev 2852)
@@ -0,0 +1,7 @@
+//AD  <- These first 4 characters need to be the first 4 characters to identify the ECMAScript file to Avidemux
+var app = new Avidemux();
+
+        crashTest();
+
+/* End of test
+*/



