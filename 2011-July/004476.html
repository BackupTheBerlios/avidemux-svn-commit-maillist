<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r7322 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2011-July/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r7322%20-%0A%09branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate&In-Reply-To=%3C20110714174022.BF0E8481490%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004475.html">
   <LINK REL="Next"  HREF="004477.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r7322 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate</H1>
    <B>mean at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r7322%20-%0A%09branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate&In-Reply-To=%3C20110714174022.BF0E8481490%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r7322 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate">mean at mail.berlios.de
       </A><BR>
    <I>Thu Jul 14 19:40:22 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004475.html">[Avidemux-svn-commit] r7321 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/telecide
</A></li>
        <LI>Next message: <A HREF="004477.html">[Avidemux-svn-commit] r7323 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4476">[ date ]</a>
              <a href="thread.html#4476">[ thread ]</a>
              <a href="subject.html#4476">[ subject ]</a>
              <a href="author.html#4476">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2011-07-14 19:40:22 +0200 (Thu, 14 Jul 2011)
New Revision: 7322

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate/decimate.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate/decimate.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate/decimate_util.cpp
Log:
[Decimage] Partially working decimate. Code cleanup-ed

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate/decimate.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate/decimate.cpp	2011-07-14 17:40:21 UTC (rev 7321)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate/decimate.cpp	2011-07-14 17:40:22 UTC (rev 7322)
@@ -43,41 +43,9 @@
 
 #include &quot;ADM_default.h&quot;
 #include &quot;decimate.h&quot;
-
-
-
-
-#ifdef USE_SSE
-	#define DECIMATE_MMX_BUILD_PLANE 1
-	#define DECIMATE_MMX_BUILD	 1
-#endif
-
-#ifdef DECIMATE_MMX_BUILD_PLANE
-static void isse_blend_decimate_plane(uint8_t * dst, uint8_t* src,  uint8_t* src_next, 
-			int w, int h);
-int isse_scenechange_32(const uint8_t *c_plane,const  uint8_t *tplane, int height, int width) ;	
-int isse_scenechange_16(const uint8_t *c_plane,const  uint8_t *tplane, int height, int width) ;
-int isse_scenechange_8(const uint8_t *c_plane,const  uint8_t *tplane, int height, int width) ;
-#endif
-
-
-#define OutputDebugString(x) aprintf(&quot;%s\n&quot;,x)
-//________________________________
-
-#define GETFRAME(g, fp) \
-{ \
-	int GETFRAMEf; \
-	GETFRAMEf = (g); \
-	if (GETFRAMEf &lt; 0) GETFRAMEf = 0; \
-	if (GETFRAMEf &gt; num_frames_hi - 1) GETFRAMEf = num_frames_hi - 1; \
-	(fp) = vidCache-&gt;getImage(GETFRAMEf); \
-}
-//________________________________
-
-
-#define aprintf(...) {}
 #include &quot;DIA_factory.h&quot;
 
+#include &quot;dec_desc.cpp&quot;
 
 // Add the hook to make it valid plugin
 DECLARE_VIDEO_FILTER(   Decimate,   // Class
@@ -121,13 +89,15 @@
     diaElemFloat menuThresh1(&amp;t1,QT_TR_NOOP(&quot;_Threshold 1:&quot;),0,100.);
     diaElemFloat menuThresh2(&amp;t2,QT_TR_NOOP(&quot;T_hreshold 2:&quot;),0,100.);
     diaElemUInteger cycle(PX(cycle),QT_TR_NOOP(&quot;C_ycle:&quot;),2,40);
+    diaElemToggle show(PX(show),QT_TR_NOOP(&quot;Sho_w&quot;));
+    diaElem *elems[]={&amp;cycle,&amp;menuMode,&amp;menuQuality,&amp;menuThresh1,&amp;menuThresh2,&amp;show};
     
-    diaElem *elems[]={&amp;cycle,&amp;menuMode,&amp;menuQuality,&amp;menuThresh1,&amp;menuThresh2};
-    
-  if(diaFactoryRun(QT_TR_NOOP(&quot;Decomb Decimate&quot;),5,elems))
+  if(diaFactoryRun(QT_TR_NOOP(&quot;Decomb Decimate&quot;),6,elems))
   {
     _param-&gt;threshold=(double )t1;
     _param-&gt;threshold2=(double )t2;
+    updateInfo();
+    reset();
     return 1; 
   }
   return 0;        
@@ -137,35 +107,55 @@
 */
 const char   *Decimate::getConfiguration(void)
 {
-    const char strparam[255];
+    static char strparam[255]={0};
  	snprintf(strparam,254,&quot; Decomb Decimate cycle:%d&quot;,configuration.cycle);
     return strparam;
 }
+/**
+    \fn updateInfo
+*/
+void Decimate::updateInfo(void)
+{
+        if(configuration.cycle&lt;2)
+        {
+            ADM_error(&quot;Telecide:bad configuration! cycle&lt;2\n&quot;);
+            return;
+        }
+        double inc=info.frameIncrement;
+        inc*=configuration.cycle;
+        inc/=configuration.cycle-1;
+        info.frameIncrement=inc;
 
+}
 /**
+    \fn reset
+    \brief reset counters. Must be called each time a change is made (params/seek)
+*/
+void Decimate::reset(void)
+{
+		last_request = -1;
+		firsttime = true;
+        all_video_cycle = true;
+        hints_invalid=false;
+        vidCache-&gt;flush();
+}
+/**
     \fn Ctor
 */       
 Decimate::Decimate(	ADM_coreVideoFilter *in,CONFcouple *couples)      : ADM_coreVideoFilter(in,couples)
 {
 		
-		int count = 0;
 		char buf[80];
 		unsigned int *p;	
         deciMate *_param=&configuration;
 		//		
 		// Init here
-		debug=0;
-		show=0;		
-#ifdef USE_SSE	
-		if(CpuCaps::hasSSE())
-		{
-			printf(&quot;Decimate:SSE enabled\n&quot;);
-		}
-#endif
 		if(!couples || !ADM_paramLoad(couples,deciMate_param,&amp;configuration))
   		{
 			_param-&gt;cycle=5;
-			_param-&gt;mode=0;
+			_param-&gt;mode=3;
+            _param-&gt;show=false;
+            _param-&gt;debug=false;
 			_param-&gt;quality=2;
 			_param-&gt;threshold=0;
 			_param-&gt;threshold2=3.0;
@@ -176,24 +166,18 @@
 		
 		if (_param-&gt;mode == 0 || _param-&gt;mode == 2 || _param-&gt;mode == 3)
 		{
-#warning make it a function
-			num_frames_hi = _info.nb_frames;
-			_info.nb_frames = _info.nb_frames * (_param-&gt;cycle - 1) / _param-&gt;cycle;
-			_info.fps1000=_info.fps1000*(_param-&gt;cycle-1);
-			_info.fps1000=(uint32_t)(_info.fps1000/_param-&gt;cycle);
-			
+                    updateInfo();
 		}
-		last_request = -1;
-		firsttime = true;
 		sum = (unsigned int *) ADM_alloc(MAX_BLOCKS * MAX_BLOCKS * sizeof(unsigned int));
 		ADM_assert(sum);		
-		all_video_cycle = true;
+	
 
-		if (debug)
+		if (configuration.debug)
 		{
 			OutputDebugString( &quot;Decimate %s by Donald Graft, Copyright 2003\n&quot;, 0); // VERSION
 		}
-	}
+
+        reset();
 }
 /**
     \fn getCoupledConf
@@ -213,609 +197,414 @@
 		vidCache=NULL;
 		sum=NULL;
 }
+
 /**
-    \fn DrawShow
+    \fn getNextFrame
 */
-void Decimate::DrawShow(ADMImage  *src, int useframe, bool forced, int dropframe,
-						double metric, int inframe)
-{
-	char buf[80];
-	int start = (useframe / _param-&gt;cycle) * _param-&gt;cycle;
 
-	if (show == true)
-	{
-		sprintf(buf, &quot;Decimate %s&quot;, 0); // VERSION
-		DrawString(src, 0, 0, buf);
-		sprintf(buf, &quot;Copyright 2003 Donald Graft&quot;);
-		DrawString(src, 0, 1, buf);
-		sprintf(buf,&quot;%d: %3.2f&quot;, start, showmetrics[0]);
-		DrawString(src, 0, 3, buf);
-		sprintf(buf,&quot;%d: %3.2f&quot;, start + 1, showmetrics[1]);
-		DrawString(src, 0, 4, buf);
-		sprintf(buf,&quot;%d: %3.2f&quot;, start + 2, showmetrics[2]);
-		DrawString(src, 0, 5, buf);
-		sprintf(buf,&quot;%d: %3.2f&quot;, start + 3, showmetrics[3]);
-		DrawString(src, 0, 6, buf);
-		sprintf(buf,&quot;%d: %3.2f&quot;, start + 4, showmetrics[4]);
-		DrawString(src, 0, 7, buf);
-		if (all_video_cycle == false)
-		{
-			sprintf(buf,&quot;in frm %d, use frm %d&quot;, inframe, useframe);
-			DrawString(src, 0, 8, buf);
-			if (forced == false)
-				sprintf(buf,&quot;chose %d, dropping&quot;, dropframe);
-			else
-				sprintf(buf,&quot;chose %d, dropping, forced!&quot;, dropframe);
-			DrawString(src, 0, 9, buf);
-		}
-		else
-		{
-			sprintf(buf,&quot;in frm %d&quot;, inframe);
-			DrawString(src, 0, 8, buf);
-			sprintf(buf,&quot;chose %d, decimating all-video cycle&quot;, dropframe);
-			DrawString(src, 0, 9, buf);
-		}
-	}
-	if (debug)
-	{
-		if (!(inframe%_param-&gt;cycle))
-		{
-			sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start, showmetrics[0]);
-			OutputDebugString(buf);
-			sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 1, showmetrics[1]);
-			OutputDebugString(buf);
-			sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 2, showmetrics[2]);
-			OutputDebugString(buf);
-			sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 3, showmetrics[3]);
-			OutputDebugString(buf);
-			sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 4, showmetrics[4]);
-			OutputDebugString(buf);
-		}
-		if (all_video_cycle == false)
-		{
-			sprintf(buf,&quot;Decimate: in frm %d useframe %d\n&quot;, inframe, useframe);
-			OutputDebugString(buf);
-			if (forced == false)
-				sprintf(buf,&quot;Decimate: chose %d, dropping\n&quot;, dropframe);
-			else
-				sprintf(buf,&quot;Decimate: chose %d, dropping, forced!\n&quot;, dropframe);
-			OutputDebugString(buf);
-		}
-		else
-		{
-			sprintf(buf,&quot;Decimate: in frm %d\n&quot;, inframe);
-			OutputDebugString(buf);
-			sprintf(buf,&quot;Decimate: chose %d, decimating all-video cycle\n&quot;, dropframe);
-			OutputDebugString(buf);
-		}
-	}
+bool Decimate::getNextFrame(uint32_t *fn,ADMImage *data)
+{
+    switch(configuration.mode)
+    {
+        case 0: return get0(fn,data);break;
+        case 1: return get1(fn,data);break;
+        case 2: return get2(fn,data);break;
+        case 3: return get3(fn,data);break;     
+        default: ADM_assert(0);
+    }
+    return false;
 }
-//______________________________________________________________________
-uint8_t Decimate::getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-				ADMImage *data,uint32_t *flags)
+/**
+        \fn get0
+        \brief A B C... if B is close enough to A discard it.
+*/
+bool Decimate::get0(uint32_t *fn,ADMImage *data)
 {
-	int dropframe, useframe, nextfrm, wY, wUV, hY, hUV, x, y, pitchY, pitchUV, dpitchY, dpitchUV;
-	ADMImage  *src, *next, *dst;
-	unsigned char *srcrpY, *nextrpY, *dstwpY;
-	unsigned char *srcrpU, *nextrpU, *dstwpU;
-	unsigned char *srcrpV, *nextrpV, *dstwpV;
-	uint32_t inframe=frame;
-	double metric;
-	char buf[255];
+    
+    bool forced = false;
+    ADMImage *src,*next;
+    double metric;
+    char buf[256];
+    int useframe,dropframe;
+    int start;
+    deciMate *_param=&configuration;
+    /* Normal decimation. Remove the frame most similar to its preceding frame. */
+    /* Determine the correct frame to use and get it. */
+    int cycle=configuration.cycle;
+    int sourceFrame = (nextFrame*cycle)/(cycle-1);
+    int cycleStartFrame = (sourceFrame / cycle) * cycle;
+    int inframe=nextFrame;
+    *fn=nextFrame;
+    GETFRAME(sourceFrame, src);
+    if(!src)
+    {
+        ADM_info(&quot;Decimate: End of video stream, cannot get frame %d\n&quot;,useframe);
+        vidCache-&gt;unlockAll();
+        return false;
+    }
+    nextFrame++;
 
-        if(frame&gt;= _info.nb_frames) return 0;
-	*len=(_info.width*_info.height*3)&gt;&gt;1;
-	num_frames_hi = _in-&gt;getInfo()-&gt;nb_frames; /* FIXME MEANX */
-	if (_param-&gt;mode == 0)
-	{
-		bool forced = false;
-		int start;
+    
+    FindDuplicate(cycleStartFrame, &amp;dropframe, &amp;metric, &amp;forced);
+    if (sourceFrame &gt;= dropframe) sourceFrame++;
+    GETFRAME(sourceFrame, src);
+    if(!src)
+    {
+        vidCache-&gt;unlockAll();
+        return false;
+    }
+    data-&gt;duplicate(src);
+    vidCache-&gt;unlockAll();
 
-		/* Normal decimation. Remove the frame most similar to its preceding frame. */
-		/* Determine the correct frame to use and get it. */
-		useframe = inframe + inframe / (_param-&gt;cycle - 1);
-		start = (useframe /  _param-&gt;cycle) * _param-&gt;cycle;
-		FindDuplicate((useframe / _param-&gt;cycle) * _param-&gt;cycle, &amp;dropframe, &amp;metric, &amp;forced);
-		if (useframe &gt;= dropframe) useframe++;
-		GETFRAME(useframe, src);
-		if (show == true)
-		{
-			sprintf(buf, &quot;Decimate %s&quot;, 0);
-			DrawString(src, 0, 0, buf);
-			sprintf(buf, &quot;Copyright 2003 Donald Graft&quot;);
-			DrawString(src, 0, 1, buf);
-			sprintf(buf,&quot;%d: %3.2f&quot;, start, showmetrics[0]);
-			DrawString(src, 0, 3, buf);
-			sprintf(buf,&quot;%d: %3.2f&quot;, start + 1, showmetrics[1]);
-			DrawString(src, 0, 4, buf);
-			sprintf(buf,&quot;%d: %3.2f&quot;, start + 2, showmetrics[2]);
-			DrawString(src, 0, 5, buf);
-			sprintf(buf,&quot;%d: %3.2f&quot;, start + 3, showmetrics[3]);
-			DrawString(src, 0, 6, buf);
-			sprintf(buf,&quot;%d: %3.2f&quot;, start + 4, showmetrics[4]);
-			DrawString(src, 0, 7, buf);
-			sprintf(buf,&quot;in frm %d, use frm %d&quot;, inframe, useframe);
-			DrawString(src, 0, 8, buf);
-			sprintf(buf,&quot;dropping frm %d%s&quot;, dropframe, last_forced == true ? &quot;, forced!&quot; : &quot;&quot;);
-			DrawString(src, 0, 9, buf);
-		}
-		if (debug)
-		{	
-			if (!(inframe % _param-&gt;cycle))
-			{
-				sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start, showmetrics[0]);
-				OutputDebugString(buf);
-				sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 1, showmetrics[1]);
-				OutputDebugString(buf);
-				sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 2, showmetrics[2]);
-				OutputDebugString(buf);
-				sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 3, showmetrics[3]);
-				OutputDebugString(buf);
-				sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 4, showmetrics[4]);
-				OutputDebugString(buf);
-			}
-			sprintf(buf,&quot;Decimate: in frm %d, use frm %d\n&quot;, inframe, useframe);
-			OutputDebugString(buf);
-			sprintf(buf,&quot;Decimate: dropping frm %d%s\n&quot;, dropframe, last_forced == true ? &quot;, forced!&quot; : &quot;&quot;);
-			OutputDebugString(buf);
-		}
-	    //return src;
-	        //memcpy(data,src,*len);
+    if (configuration.show == true)
+    {
+        sprintf(buf, &quot;Decimate %d&quot;, 0);			                DrawString(data, 0, 0, buf);
+        sprintf(buf, &quot;Copyright 2003 Donald Graft&quot;);			DrawString(data, 0, 1, buf);
+        sprintf(buf,&quot;%d: %3.2f&quot;, start, showmetrics[0]);		DrawString(data, 0, 3, buf);
+        sprintf(buf,&quot;%d: %3.2f&quot;, start + 1, showmetrics[1]);	DrawString(data, 0, 4, buf);
+        sprintf(buf,&quot;%d: %3.2f&quot;, start + 2, showmetrics[2]);	DrawString(data, 0, 5, buf);
+        sprintf(buf,&quot;%d: %3.2f&quot;, start + 3, showmetrics[3]);	DrawString(data, 0, 6, buf);
+        sprintf(buf,&quot;%d: %3.2f&quot;, start + 4, showmetrics[4]);	DrawString(data, 0, 7, buf);
+        sprintf(buf,&quot;in frm %d, use frm %d&quot;, inframe, useframe);DrawString(data, 0, 8, buf);
+        sprintf(buf,&quot;dropping frm %d%s&quot;, dropframe, last_forced == true ? &quot;, forced!&quot; : &quot;&quot;);
+        DrawString(data, 0, 9, buf);
+    }
+    if (configuration.debug)
+    {	
+        if (!(inframe % _param-&gt;cycle))
+        {
+            OutputDebugString(&quot;Decimate: %d: %3.2f\n&quot;, start, showmetrics[0]);
+            OutputDebugString(&quot;Decimate: %d: %3.2f\n&quot;, start + 1, showmetrics[1]);
+            OutputDebugString(&quot;Decimate: %d: %3.2f\n&quot;, start + 2, showmetrics[2]);
+            OutputDebugString(&quot;Decimate: %d: %3.2f\n&quot;, start + 3, showmetrics[3]);
+            OutputDebugString(&quot;Decimate: %d: %3.2f\n&quot;, start + 4, showmetrics[4]);
+        }
+        OutputDebugString(&quot;Decimate: in frm %d, use frm %d\n&quot;, inframe, useframe);
+        OutputDebugString(&quot;Decimate: dropping frm %d%s\n&quot;, dropframe, last_forced == true ? &quot;, forced!&quot; : &quot;&quot;);
+    }		  
+    return true;
+}
+/**
+        \fn get1
+        \brief mode=1, A B C D =&gt; A  BC D, i.e. (B,C) is replaced by BC, blend between B &amp; C
+*/
 
-		data-&gt;duplicate(src);
-		vidCache-&gt;unlockAll();
-		  
-		return 1;
-	}
-	else if (_param-&gt;mode == 1)
-	{
-		bool forced = false;
-		int start = (inframe / _param-&gt;cycle) * _param-&gt;cycle;
-		unsigned int hint, film = 1;
+bool Decimate::get1(uint32_t *fn,ADMImage *data)
+{
+    bool    forced = false;
+    ADMImage *src,*next;
+    int useframe,dropframe;
+    deciMate *_param=&configuration;
+    int cycle=configuration.cycle;
+    int sourceFrame = (nextFrame*cycle)/(cycle-1);
+    int  cycleStartFrame = (sourceFrame / cycle) * cycle;
+    unsigned int hint, film = 1;
+    int inframe=nextFrame;
+    double metric;
+    char buf[256];
+    
+    GETFRAME(sourceFrame, src);
+    if(!src)
+    {
+        ADM_info(&quot;Decimate: End of video stream, cannot get frame %d\n&quot;,useframe);
+        vidCache-&gt;unlockAll();
+        return false;
+    }
+    *fn=nextFrame;
+    nextFrame++;
 
-		GETFRAME(inframe, src);
-	    	srcrpY = YPLANE(src); //(unsigned char *) src-&gt;GetReadPtr(PLANAR_Y);
-		if (GetHintingData(srcrpY, &amp;hint) == false)
-		{
-			film = hint &amp; PROGRESSIVE;
-//			if (film) OutputDebugString(&quot;film\n&quot;);
-//			else OutputDebugString(&quot;video\n&quot;);
-		}
 
-		/* Find the most similar frame as above but replace it with a blend of
-		   the preceding and following frames. */
-		num_frames_hi = _in-&gt;getInfo()-&gt;nb_frames; /* FIXME MEANX */
-		FindDuplicate((inframe / _param-&gt;cycle) * _param-&gt;cycle, &amp;dropframe, &amp;metric, &amp;forced);
-		if (!film || inframe != dropframe || (_param-&gt;threshold &amp;&amp; metric &gt; _param-&gt;threshold))
-		{
-			if (show == true)
-			{
+    if (GetHintingData(YPLANE(src), &amp;hint) == false)
+    {
+        film = hint &amp; PROGRESSIVE;
+    }
 
-				sprintf(buf, &quot;Decimate %s&quot;, 0);
-				DrawString(src, 0, 0, buf);
-				sprintf(buf, &quot;Copyright 2003 Donald Graft&quot;);
-				DrawString(src, 0, 1, buf);
-				sprintf(buf,&quot;%d: %3.2f&quot;, start, showmetrics[0]);
-				DrawString(src, 0, 3, buf);
-				sprintf(buf,&quot;%d: %3.2f&quot;, start + 1, showmetrics[1]);
-				DrawString(src, 0, 4, buf);
-				sprintf(buf,&quot;%d: %3.2f&quot;, start + 2, showmetrics[2]);
-				DrawString(src, 0, 5, buf);
-				sprintf(buf,&quot;%d: %3.2f&quot;, start + 3, showmetrics[3]);
-				DrawString(src, 0, 6, buf);
-				sprintf(buf,&quot;%d: %3.2f&quot;, start + 4, showmetrics[4]);
-				DrawString(src, 0, 7, buf);
-				sprintf(buf,&quot;infrm %d&quot;, inframe);
-				DrawString(src, 0, 8, buf);
-				if (last_forced == false)
-					sprintf(buf,&quot;chose %d, passing through&quot;, dropframe);
-				else
-					sprintf(buf,&quot;chose %d, passing through, forced!&quot;, dropframe);
-				DrawString(src, 0, 9, buf);
-			}
-			if (debug)
-			{
-				if (!(inframe % _param-&gt;cycle))
-				{
-					sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start, showmetrics[0]);
-					OutputDebugString(buf);
-					sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 1, showmetrics[1]);
-					OutputDebugString(buf);
-					sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 2, showmetrics[2]);
-					OutputDebugString(buf);
-					sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 3, showmetrics[3]);
-					OutputDebugString(buf);
-					sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 4, showmetrics[4]);
-					OutputDebugString(buf);
-				}
-				sprintf(buf,&quot;Decimate: in frm %d\n&quot;, inframe);
-				OutputDebugString(buf);
-				if (last_forced == false)
-					sprintf(buf,&quot;Decimate: chose %d, passing through\n&quot;, dropframe);
-				else
-					sprintf(buf,&quot;Decimate: chose %d, passing through, forced!\n&quot;, dropframe);
-				OutputDebugString(buf);
-			}
-			//return src;
-			//memcpy(data,src,*len);
+    /* Find the most similar frame as above but replace it with a blend of
+       the preceding and following frames. */
+    FindDuplicate(cycleStartFrame, &amp;dropframe, &amp;metric, &amp;forced);
+    if (!film || sourceFrame != dropframe || (_param-&gt;threshold &amp;&amp; metric &gt; _param-&gt;threshold))
+    {
+        data-&gt;duplicate(src);
+        vidCache-&gt;unlockAll();
+        if (configuration.show == true)
+        {
 
-			data-&gt;duplicate(src);
-			vidCache-&gt;unlockAll();
-			return 1;
-		}
-		if (inframe &lt; _in-&gt;getInfo()-&gt;nb_frames - 1) /* FIXME MEANX*/
-			nextfrm = inframe + 1;
-		else
-			nextfrm = _in-&gt;getInfo()-&gt;nb_frames - 1;
-		if (debug)
-		{
-			if (!(inframe % _param-&gt;cycle))
-			{
-				sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start, showmetrics[0]);
-				OutputDebugString(buf);
-				sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 1, showmetrics[1]);
-				OutputDebugString(buf);
-				sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 2, showmetrics[2]);
-				OutputDebugString(buf);
-				sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 3, showmetrics[3]);
-				OutputDebugString(buf);
-				sprintf(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 4, showmetrics[4]);
-				OutputDebugString(buf);
-			}
-			sprintf(buf,&quot;Decimate: in frm %d\n&quot;, inframe);
-			OutputDebugString(buf);
-			if (last_forced == false)
-				sprintf(buf,&quot;Decimate: chose %d, blending %d and %d\n&quot;, dropframe, inframe, nextfrm);
-			else
-				sprintf(buf,&quot;Decimate: chose %d, blending %d and %d, forced!\n&quot;, dropframe, inframe, nextfrm);
-			OutputDebugString(buf);
-		}
-		GETFRAME(nextfrm, next);
-		dst = data; //env-&gt;NewVideoFrame(vi);
-		pitchY = _info.width; //src-&gt;GetPitch(PLANAR_Y);
-		dpitchY = _info.width; //dst-&gt;GetPitch(PLANAR_Y);
-		wY = _info.width; //src-&gt;GetRowSize(PLANAR_Y);
-		hY = _info.height; //src-&gt;GetHeight(PLANAR_Y);
-		pitchUV = _info.width&gt;&gt;1;// src-&gt;GetPitch(PLANAR_V);
-		dpitchUV =_info.width&gt;&gt;1;// dst-&gt;GetPitch(PLANAR_V);
-		wUV = _info.width&gt;&gt;1;//src-&gt;GetRowSize(PLANAR_V);
-		hUV = _info.height&gt;&gt;1;//src-&gt;GetHeight(PLANAR_V);
-		
-		nextrpY = YPLANE(next); //next-&gt;GetReadPtr(PLANAR_Y);
-		dstwpY = YPLANE( dst); //dst-&gt;GetWritePtr(PLANAR_Y);
-#ifdef DECIMATE_MMX_BUILD_PLANE
-		if (CpuCaps::hasSSE()) 
-		{
-			isse_blend_decimate_plane(dstwpY, srcrpY, nextrpY, wY, hY);
-		} else {
-#endif
-			for (y = 0; y &lt; hY; y++)
-			{
-				for (x = 0; x &lt; wY; x++)
-				{
-					dstwpY[x] = ((int)srcrpY[x] + (int)nextrpY[x] ) &gt;&gt; 1;  
-				}
-				srcrpY += pitchY;
-				nextrpY += pitchY;
-				dstwpY += dpitchY;
-			}
-#ifdef DECIMATE_MMX_BUILD_PLANE
-		}
-#endif
-		srcrpU =   UPLANE(src);//-&gt;GetReadPtr(PLANAR_U);
-		nextrpU =   UPLANE(next);//-&gt;GetReadPtr(PLANAR_U);
-		dstwpU =  UPLANE(dst);//-&gt;GetWritePtr(PLANAR_U);
-#ifdef DECIMATE_MMX_BUILD_PLANE
-		if (CpuCaps::hasSSE()) 
-		{
-			isse_blend_decimate_plane(dstwpU, srcrpU, nextrpU, wUV, hUV);
-		} else {
-#endif
-			for (y = 0; y &lt; hUV; y++)
-			{
-				for (x = 0; x &lt; wUV; x++)
-				{
-					dstwpU[x] = ((int)srcrpU[x] + (int)nextrpU[x]) &gt;&gt; 1;
-				}
-				srcrpU += pitchUV;
-				nextrpU += pitchUV;
-				dstwpU += dpitchUV;
-			}
-#ifdef DECIMATE_MMX_BUILD_PLANE
-		}
-#endif
-		srcrpV =   VPLANE(src);//-&gt;GetReadPtr(PLANAR_V);
-		nextrpV =   VPLANE(next);//-&gt;GetReadPtr(PLANAR_V);
-		dstwpV =   VPLANE(dst);//-&gt;GetWritePtr(PLANAR_V);
+            sprintf(buf, &quot;Decimate %d&quot;, 0);				DrawString(data, 0, 0, buf);
+            sprintf(buf, &quot;Copyright 2003 Donald Graft&quot;);				DrawString(data, 0, 1, buf);
+            sprintf(buf,&quot;%d: %3.2f&quot;, cycleStartFrame, showmetrics[0]);		    DrawString(data, 0, 3, buf);
+            sprintf(buf,&quot;%d: %3.2f&quot;, cycleStartFrame + 1, showmetrics[1]);		DrawString(data, 0, 4, buf);
+            sprintf(buf,&quot;%d: %3.2f&quot;, cycleStartFrame + 2, showmetrics[2]);		DrawString(data, 0, 5, buf);
+            sprintf(buf,&quot;%d: %3.2f&quot;, cycleStartFrame + 3, showmetrics[3]);		DrawString(data, 0, 6, buf);
+            sprintf(buf,&quot;%d: %3.2f&quot;, cycleStartFrame + 4, showmetrics[4]);		DrawString(data, 0, 7, buf);
+            sprintf(buf,&quot;infrm %d&quot;, inframe);
+            DrawString(data, 0, 8, buf);
+            if (last_forced == false)
+                sprintf(buf,&quot;chose %d, passing through&quot;, dropframe);
+            else
+                sprintf(buf,&quot;chose %d, passing through, forced!&quot;, dropframe);
+            DrawString(data, 0, 9, buf);
+        }
+        if (configuration.debug)
+        {
+            if (!(inframe % _param-&gt;cycle))
+            {
+                OutputDebugString(&quot;Decimate: %d: %3.2f\n&quot;, start, showmetrics[0]);
+                OutputDebugString(&quot;Decimate: %d: %3.2f\n&quot;, start + 1, showmetrics[1]);
+                OutputDebugString(&quot;Decimate: %d: %3.2f\n&quot;, start + 2, showmetrics[2]);
+                OutputDebugString(&quot;Decimate: %d: %3.2f\n&quot;, start + 3, showmetrics[3]);
+                OutputDebugString(&quot;Decimate: %d: %3.2f\n&quot;, start + 4, showmetrics[4]);
+            }
+            OutputDebugString(&quot;Decimate: in frm %d\n&quot;, inframe);
+            
+            if (last_forced == false)
+            {
+                OutputDebugString(&quot;Decimate: chose %d, passing through\n&quot;, dropframe);
+            }
+            else
+            {
+                OutputDebugString(&quot;Decimate: chose %d, passing through, forced!\n&quot;, dropframe);
+            }
+        }
+        return true;
+    }
+    if (configuration.debug)
+    {
+        if (!(inframe % _param-&gt;cycle))
+        {
+            OutputDebugString( &quot;Decimate: %d: %3.2f\n&quot;, start, showmetrics[0]);
+            OutputDebugString( &quot;Decimate: %d: %3.2f\n&quot;, start + 1, showmetrics[1]);
+            OutputDebugString( &quot;Decimate: %d: %3.2f\n&quot;, start + 2, showmetrics[2]);
+            OutputDebugString( &quot;Decimate: %d: %3.2f\n&quot;, start + 3, showmetrics[3]);
+            OutputDebugString( &quot;Decimate: %d: %3.2f\n&quot;, start + 4, showmetrics[4]);
+        }
+        OutputDebugString(&quot;Decimate: in frm %d\n&quot;, inframe);
+        
+        if (last_forced == false)
+        {
+            OutputDebugString(&quot;Decimate: chose %d, blending %d and %d\n&quot;, dropframe, inframe, nextfrm);
+        }
+        else
+        {
+            OutputDebugString(&quot;Decimate: chose %d, blending %d and %d, forced!\n&quot;, dropframe, inframe, nextfrm);
+        }			
+    }
+    // Blend current frame with next frame
+    GETFRAME(sourceFrame+1, next);
+    if(!next)
+        data-&gt;duplicate(src);
+    else
+        data-&gt;blend(src,next);
+    vidCache-&gt;unlockAll();		
+    if (configuration.show == true)
+    {
 
-#ifdef DECIMATE_MMX_BUILD_PLANE
-		if (CpuCaps::hasSSE()) { 
-			isse_blend_decimate_plane(dstwpV, srcrpV, nextrpV, wUV, hUV );
-		} else {
-#endif
-			for (y = 0; y &lt; hUV; y++)
-			{
-				for (x = 0; x &lt; wUV; x++)
-				{
-					dstwpV[x] = ((int)srcrpV[x] + + (int)nextrpV[x]) &gt;&gt; 1;
-				}
-				srcrpV += pitchUV;
-				nextrpV += pitchUV;
-				dstwpV += dpitchUV;
-			}
-#ifdef DECIMATE_MMX_BUILD_PLANE
-		}
-#endif
-		if (show == true)
-		{
+        sprintf(buf, &quot;Decimate %d&quot;, 0);			DrawString(data, 0, 0, buf);
+        sprintf(buf, &quot;Copyright 2003 Donald Graft&quot;);			DrawString(data, 0, 1, buf);
+        sprintf(buf,&quot;%d: %3.2f&quot;, cycleStartFrame, showmetrics[0]);		DrawString(data, 0, 3, buf);
+        sprintf(buf,&quot;%d: %3.2f&quot;, cycleStartFrame + 1, showmetrics[1]);	DrawString(data, 0, 4, buf);
+        sprintf(buf,&quot;%d: %3.2f&quot;, cycleStartFrame + 2, showmetrics[2]);	DrawString(data, 0, 5, buf);
+        sprintf(buf,&quot;%d: %3.2f&quot;, cycleStartFrame + 3, showmetrics[3]);	DrawString(data, 0, 6, buf);
+        sprintf(buf,&quot;%d: %3.2f&quot;, cycleStartFrame + 4, showmetrics[4]);	DrawString(data, 0, 7, buf);
+        sprintf(buf,&quot;infrm %d&quot;, inframe);
+        DrawString(data, 0, 8, buf);
+        if (last_forced == false)
+            sprintf(buf,&quot;chose %d, blending %d and %d&quot;,dropframe, sourceFrame, sourceFrame+1);
+        else
+            sprintf(buf,&quot;chose %d, blending %d and %d, forced!&quot;, dropframe, sourceFrame, sourceFrame+1);
+        DrawString(data, 0, 9, buf);
+    }
+    
+    return true;
+}
+/**
+        \fn get2
+        \fn remove one frame from longest duplicate (anime)
+*/
 
-			sprintf(buf, &quot;Decimate %s&quot;, 0);
-			DrawString(dst, 0, 0, buf);
-			sprintf(buf, &quot;Copyright 2003 Donald Graft&quot;);
-			DrawString(dst, 0, 1, buf);
-			sprintf(buf,&quot;%d: %3.2f&quot;, start, showmetrics[0]);
-			DrawString(dst, 0, 3, buf);
-			sprintf(buf,&quot;%d: %3.2f&quot;, start + 1, showmetrics[1]);
-			DrawString(dst, 0, 4, buf);
-			sprintf(buf,&quot;%d: %3.2f&quot;, start + 2, showmetrics[2]);
-			DrawString(dst, 0, 5, buf);
-			sprintf(buf,&quot;%d: %3.2f&quot;, start + 3, showmetrics[3]);
-			DrawString(dst, 0, 6, buf);
-			sprintf(buf,&quot;%d: %3.2f&quot;, start + 4, showmetrics[4]);
-			DrawString(dst, 0, 7, buf);
-			sprintf(buf,&quot;infrm %d&quot;, inframe);
-			DrawString(dst, 0, 8, buf);
-			if (last_forced == false)
-				sprintf(buf,&quot;chose %d, blending %d and %d&quot;,dropframe, inframe, nextfrm);
-			else
-				sprintf(buf,&quot;chose %d, blending %d and %d, forced!&quot;, dropframe, inframe, nextfrm);
-			DrawString(dst, 0, 9, buf);
-		}
-		//return dst;
-		//memcpy(data,dst,*len);
+bool Decimate::get2(uint32_t *fn,ADMImage *data)
+{
+    bool forced = false;
+    double metric;
+    char buf[256];
+    
+    deciMate *_param=&configuration;
+    int cycle=configuration.cycle;
+    int sourceFrame = (nextFrame*cycle)/(cycle-1);
+    int cycleStartFrame = (sourceFrame / cycle) * cycle;
+    int useframe,dropframe;
+    *fn=nextFrame;
+    int inframe=nextFrame;
+    ADMImage *src,*next;
+    GETFRAME(sourceFrame, src);
+    if(!src)
+    {
+        ADM_info(&quot;Decimate: End of video stream, cannot get frame %d\n&quot;,useframe);
+        vidCache-&gt;unlockAll();
+        return false;
+    }
+    nextFrame++;
+    /* Delete the duplicate in the longest string of duplicates. */
+    FindDuplicate2(cycleStartFrame, &amp;dropframe, &amp;forced);
+    if (sourceFrame &gt;= dropframe) 
+        sourceFrame++;
+    GETFRAME(sourceFrame, src);
+    if(!src)
+    {
+        vidCache-&gt;unlockAll();
+        return false;
+    }
+    data-&gt;duplicate(src);
+    vidCache-&gt;unlockAll();
+    if (configuration.show == true)
+    {
+        int start = (useframe / _param-&gt;cycle) * _param-&gt;cycle;
 
-		data-&gt;duplicate(dst);
-		vidCache-&gt;unlockAll();		
-		return 1;
-	}
-	else if (_param-&gt;mode == 2)
-	{
-		bool forced = false;
 
-		/* Delete the duplicate in the longest string of duplicates. */
-		useframe = inframe + inframe / (_param-&gt;cycle - 1);
-		FindDuplicate2((useframe / _param-&gt;cycle) * _param-&gt;cycle, &amp;dropframe, &amp;forced);
-		if (useframe &gt;= dropframe) useframe++;
-		GETFRAME(useframe, src);
-		if (show == true)
-		{
-			int start = (useframe / _param-&gt;cycle) * _param-&gt;cycle;
+        sprintf(buf, &quot;Decimate %d&quot;, 0);			DrawString(data, 0, 0, buf);
+        sprintf(buf, &quot;Copyright 2003 Donald Graft&quot;);			    DrawString(data, 0, 1, buf);
+        sprintf(buf,&quot;in frm %d, use frm %d&quot;, inframe, useframe);	DrawString(data, 0, 3, buf);
+        sprintf(buf,&quot;%d: %3.2f (%s)&quot;, cycleStartFrame, showmetrics[0], Dshow[0] ? &quot;new&quot; : &quot;dup&quot;);	DrawString(data, 0, 4, buf);
+        sprintf(buf,&quot;%d: %3.2f (%s)&quot;, cycleStartFrame + 1, showmetrics[1],Dshow[1] ? &quot;new&quot; : &quot;dup&quot;);DrawString(data, 0, 5, buf);
+        sprintf(buf,&quot;%d: %3.2f (%s)&quot;, cycleStartFrame + 2, showmetrics[2],Dshow[2] ? &quot;new&quot; : &quot;dup&quot;);DrawString(data, 0, 6, buf);
+        sprintf(buf,&quot;%d: %3.2f (%s)&quot;, cycleStartFrame + 3, showmetrics[3],Dshow[3] ? &quot;new&quot; : &quot;dup&quot;);DrawString(data, 0, 7, buf);
+        sprintf(buf,&quot;%d: %3.2f (%s)&quot;, cycleStartFrame + 4, showmetrics[4],Dshow[4] ? &quot;new&quot; : &quot;dup&quot;);DrawString(data, 0, 8, buf);
+        sprintf(buf,&quot;Dropping frm %d%s&quot;, dropframe, last_forced == true ? &quot; forced!&quot; : &quot;&quot;);
+        DrawString(data, 0, 9, buf);
+    }
+    if (configuration.debug)
+    {	
+        sprintf(buf,&quot;Decimate: inframe %d useframe %d\n&quot;, inframe, useframe);
+        OutputDebugString(buf);
+    }
+    return true;
+}
+/**
+        \fn get3
+        \brief ivtc (after telecide)
+*/
 
-
-			sprintf(buf, &quot;Decimate %s&quot;, 0);
-			DrawString(src, 0, 0, buf);
-			sprintf(buf, &quot;Copyright 2003 Donald Graft&quot;);
-			DrawString(src, 0, 1, buf);
-			sprintf(buf,&quot;in frm %d, use frm %d&quot;, inframe, useframe);
-			DrawString(src, 0, 3, buf);
-			sprintf(buf,&quot;%d: %3.2f (%s)&quot;, start, showmetrics[0],
-					Dshow[0] ? &quot;new&quot; : &quot;dup&quot;);
-			DrawString(src, 0, 4, buf);
-			sprintf(buf,&quot;%d: %3.2f (%s)&quot;, start + 1, showmetrics[1],
-					Dshow[1] ? &quot;new&quot; : &quot;dup&quot;);
-			DrawString(src, 0, 5, buf);
-			sprintf(buf,&quot;%d: %3.2f (%s)&quot;, start + 2, showmetrics[2],
-					Dshow[2] ? &quot;new&quot; : &quot;dup&quot;);
-			DrawString(src, 0, 6, buf);
-			sprintf(buf,&quot;%d: %3.2f (%s)&quot;, start + 3, showmetrics[3],
-					Dshow[3] ? &quot;new&quot; : &quot;dup&quot;);
-			DrawString(src, 0, 7, buf);
-			sprintf(buf,&quot;%d: %3.2f (%s)&quot;, start + 4, showmetrics[4],
-					Dshow[4] ? &quot;new&quot; : &quot;dup&quot;);
-			DrawString(src, 0, 8, buf);
-			sprintf(buf,&quot;Dropping frm %d%s&quot;, dropframe, last_forced == true ? &quot; forced!&quot; : &quot;&quot;);
-			DrawString(src, 0, 9, buf);
-		}
-		if (debug)
-		{	
-			sprintf(buf,&quot;Decimate: inframe %d useframe %d\n&quot;, inframe, useframe);
-			OutputDebugString(buf);
-		}
-	    //return src;
-	    	//memcpy(data,src,*len);
-
-		data-&gt;duplicate(src);
-		vidCache-&gt;unlockAll();
-		return 1;
-	}
-	else if (_param-&gt;mode == 3)
-	{
-		bool forced = false;
-
-		/* Decimate by removing a duplicate from film cycles and doing a
-		   blend rate conversion on the video cycles. */
-		if (_param-&gt;cycle != 5)//	env-&gt;ThrowError(&quot;Decimate: mode=3 requires cycle=5&quot;);
-		{
-			printf(&quot;Decimate: mode=3 requires cycle=5\n&quot;);
-			return 0;
-		}
-		useframe = inframe + inframe / (_param-&gt;cycle - 1);
-		FindDuplicate((useframe / _param-&gt;cycle) * _param-&gt;cycle, &amp;dropframe, &amp;metric, &amp;forced);
-		/* Use hints from Telecide about film versus video. Also use the difference
-		   metric of the most similar frame in the cycle; if it exceeds threshold,
-		   assume it's a video cycle. */
-		if (!(inframe % 4))
-		{
-			all_video_cycle = false;
-			if (_param-&gt;threshold &amp;&amp; metric &gt; _param-&gt;threshold)
-			{
-				all_video_cycle = true;
-			}
-			if ((hints_invalid == false) &amp;&amp;
-				(!(hints[0] &amp; PROGRESSIVE) ||
-				 !(hints[1] &amp; PROGRESSIVE) ||
-				 !(hints[2] &amp; PROGRESSIVE) ||
-				 !(hints[3] &amp; PROGRESSIVE) ||
-				 !(hints[4] &amp; PROGRESSIVE)))
-			{
-				all_video_cycle = true;
-			}
-		}
-		if (all_video_cycle == false)
-		{
-			/* It's film, so decimate in the normal way. */
-			if (useframe &gt;= dropframe) useframe++;
-			GETFRAME(useframe, src);
-			DrawShow(src, useframe, forced, dropframe, metric, inframe);			
-			//memcpy(data,src,*len);
-
-			data-&gt;duplicate(src);
-		
-			vidCache-&gt;unlockAll();		
-			return 1; // return src;
-		}
-		else if ((inframe % 4) == 0)
-		{
-			/* It's a video cycle. Output the first frame of the cycle. */
-			GETFRAME(useframe, src);
-			DrawShow(src, 0, forced, dropframe, metric, inframe);
-			//return src;
-			//memcpy(data,src,*len);
-
-			data-&gt;duplicate(src);
-		
-			vidCache-&gt;unlockAll();		
-			return 1; // return src;
-		}
-		else if ((inframe % 4) == 3)
-		{
-			/* It's a video cycle. Output the last frame of the cycle. */
-			GETFRAME(useframe+1, src);
-			DrawShow(src, 0, forced, dropframe, metric, inframe);
-			//return src;
-			//memcpy(data,src,*len);
-
-			data-&gt;duplicate(src);
-		
-			vidCache-&gt;unlockAll();		
-			return 1; // return src;
-		}
-		else if ((inframe % 4) == 1 || (inframe % 4) == 2)
-		{
-			/* It's a video cycle. Make blends for the remaining frames. */
-			if ((inframe % 4) == 1)
-			{
-				GETFRAME(useframe, src);
-				if (useframe &lt; num_frames_hi - 1)
-					nextfrm = useframe + 1;
-				else
-					nextfrm = _in-&gt;getInfo()-&gt;nb_frames - 1;
-				GETFRAME(nextfrm, next);
-			}
-			else
-			{
-				GETFRAME(useframe + 1, src);
-				nextfrm = useframe;
-				GETFRAME(nextfrm, next);
-			}
-			dst = data; //env-&gt;NewVideoFrame(vi);
-			pitchY = _info.width; //src-&gt;GetPitch(PLANAR_Y);
-			dpitchY = _info.width; //dst-&gt;GetPitch(PLANAR_Y);
-			wY = _info.width; //src-&gt;GetRowSize(PLANAR_Y);
-			hY = _info.height; //src-&gt;GetHeight(PLANAR_Y);
-			pitchUV = _info.width&gt;&gt;1; //src-&gt;GetPitch(PLANAR_V);
-			dpitchUV =_info.width&gt;&gt;1; // dst-&gt;GetPitch(PLANAR_V);
-			wUV = _info.width&gt;&gt;1; //src-&gt;GetRowSize(PLANAR_V);
-			hUV = _info.height&gt;&gt;1; //src-&gt;GetHeight(PLANAR_V);
-			
-			srcrpY = YPLANE( src); //src-&gt;GetReadPtr(PLANAR_Y);
-			nextrpY = YPLANE( next); //next-&gt;GetReadPtr(PLANAR_Y);
-			dstwpY = YPLANE( dst); //dst-&gt;GetWritePtr(PLANAR_Y);
-#ifdef DECIMATE_MMX_BUILD_PLANE
-			if (CpuCaps::hasSSE()) { 
-				isse_blend_decimate_plane(dstwpY, srcrpY, nextrpY, wY, hY);
-			} else {
-#endif
-				for (y = 0; y &lt; hY; y++)
-				{
-					for (x = 0; x &lt; wY; x++)
-					{
-						dstwpY[x] = ((int)srcrpY[x] + (int)nextrpY[x]) &gt;&gt; 1;
-					}
-					srcrpY += pitchY;
-					nextrpY += pitchY;
-					dstwpY += dpitchY;
-				}
-#ifdef DECIMATE_MMX_BUILD_PLANE
-			}
-#endif
-			srcrpU =   UPLANE(src);//-&gt;GetReadPtr(PLANAR_U);
-			nextrpU =  UPLANE( next);//-&gt;GetReadPtr(PLANAR_U);
-			dstwpU =   UPLANE(dst);//-&gt;GetWritePtr(PLANAR_U);
-#ifdef DECIMATE_MMX_BUILD_PLANE
-			if (CpuCaps::hasSSE()) { 
-				isse_blend_decimate_plane(dstwpU, srcrpU, nextrpU, wUV, hUV);
-			} else {
-#endif
-				for (y = 0; y &lt; hUV; y++)
-				{
-					for (x = 0; x &lt; wUV; x++)
-					{
-						dstwpU[x] = ((int)srcrpU[x] + (int)nextrpU[x]) &gt;&gt; 1;
-					}
-					srcrpU += pitchUV;
-					nextrpU += pitchUV;
-					dstwpU += dpitchUV;
-				}
-#ifdef DECIMATE_MMX_BUILD_PLANE
-			}
-#endif
-			srcrpV =   VPLANE(src);//-&gt;GetReadPtr(PLANAR_V);
-			nextrpV =  VPLANE( next);//-&gt;GetReadPtr(PLANAR_V);
-			dstwpV =   VPLANE(dst);//-&gt;GetWritePtr(PLANAR_V);
-#ifdef DECIMATE_MMX_BUILD_PLANE
-			if (CpuCaps::hasSSE()) { 
-				isse_blend_decimate_plane(dstwpV, srcrpV, nextrpV, wUV, hUV);
-			} else {
-#endif
-				for (y = 0; y &lt; hUV; y++)
-				{
-					for (x = 0; x &lt; wUV; x++)
-					{
-						dstwpV[x] = ((int)srcrpV[x] + (int)nextrpV[x]) &gt;&gt; 1;
-					}
-					srcrpV += pitchUV;
-					nextrpV += pitchUV;
-					dstwpV += dpitchUV;
-				}
-#ifdef DECIMATE_MMX_BUILD_PLANE
-			}
-#endif
-			DrawShow(dst, 0, forced, dropframe, metric, inframe);
-			vidCache-&gt;unlockAll();
-			//return dst;
-			//memcpy(data,dst,*len);
-
-			data-&gt;duplicate(dst);
-			vidCache-&gt;unlockAll();		
-			return 1; // return src;			
-		}
-		//return src;
-		//memcpy(data,src,*len);
-
-                GETFRAME(useframe, src); // MEANX : not sure (jw detected a problem here)
-		data-&gt;duplicate(src);
-		vidCache-&gt;unlockAll();		
-		return 1; // return src;			
-	}
-	//env-&gt;ThrowError(&quot;Decimate: invalid mode option (0-3)&quot;);
-	printf(&quot;Decimate: invalid mode option (0-3)\n&quot;);
-	/* Avoid compiler warning. */
-	return 0;
+bool Decimate::get3(uint32_t *fn,ADMImage *data)
+{
+    bool forced = false;
+    ADMImage *src,*next;
+    int     dropframe;
+    double  metric;
+    char buf[256];
+    
+    deciMate *_param=&configuration;
+    /* Decimate by removing a duplicate from film cycles and doing a
+       blend rate conversion on the video cycles. */
+    if (_param-&gt;cycle != 5)//	env-&gt;ThrowError(&quot;Decimate: mode=3 requires cycle=5&quot;);
+    {
+        ADM_error(&quot;Decimate: mode=3 requires cycle=5\n&quot;);
+        return false;
+    }
+    int     sourceFrame = (nextFrame*5)/4;
+    int     cycleStartFrame = (sourceFrame /5) * 5;
+    
+    *fn=nextFrame;
+    GETFRAME(sourceFrame, src);
+    if(!src)
+    {
+        ADM_info(&quot;Decimate: End of video stream, cannot get frame %d\n&quot;,sourceFrame);
+        vidCache-&gt;unlockAll();
+        return false;
+    }
+    int inframe=nextFrame;
+    nextFrame++;
+    FindDuplicate(cycleStartFrame, &amp;dropframe, &amp;metric, &amp;forced);
+    /* Use hints from Telecide about film versus video. Also use the difference
+       metric of the most similar frame in the cycle; if it exceeds threshold,
+       assume it's a video cycle. */
+    if (!(inframe % 4))
+    {
+        all_video_cycle = false;
+        if (_param-&gt;threshold &amp;&amp; metric &gt; _param-&gt;threshold)
+        {
+            all_video_cycle = true;
+        }
+        if ((hints_invalid == false) &amp;&amp;
+            (!(hints[0] &amp; PROGRESSIVE) ||
+             !(hints[1] &amp; PROGRESSIVE) ||
+             !(hints[2] &amp; PROGRESSIVE) ||
+             !(hints[3] &amp; PROGRESSIVE) ||
+             !(hints[4] &amp; PROGRESSIVE)))
+        {
+            all_video_cycle = true;
+        }
+    }
+    if (all_video_cycle == false)
+    {
+        /* It's film, so decimate in the normal way. */
+        if (sourceFrame &gt;= dropframe) sourceFrame++;
+        GETFRAME(sourceFrame, src);
+        if(!src)
+        {
+            vidCache-&gt;unlockAll();
+            return false;
+        }
+        data-&gt;duplicate(src);    
+        vidCache-&gt;unlockAll();		
+        DrawShow(data, sourceFrame, forced, dropframe, metric, inframe);			
+        return true; // return src;
+    }
+    else 
+    {
+        switch(inframe %4)
+        {
+            case 0:
+                /* It's a video cycle. Output the first frame of the cycle. */
+                GETFRAME(sourceFrame, src);
+                data-&gt;duplicate(src);
+                vidCache-&gt;unlockAll();		
+                break;
+            case 3:
+                /* It's a video cycle. Output the last frame of the cycle. */
+                GETFRAME(sourceFrame+1, src);
+                if(!src)
+                {
+                    vidCache-&gt;unlockAll();		
+                    return false;
+                }
+                data-&gt;duplicate(src);
+                vidCache-&gt;unlockAll();		
+                break;
+            case 1: case 2:
+                /* It's a video cycle. Make blends for the remaining frames. */
+                if ((inframe % 4) == 1)  // MEANX dont undestand the difference ?
+                {
+                    GETFRAME(sourceFrame, src);
+                    GETFRAME(sourceFrame+1, next);
+                    if(!next) next=src;
+                }
+                else
+                {
+                    GETFRAME(sourceFrame + 1, src);
+                    GETFRAME(sourceFrame, next);
+                    if(!src) src=next;
+                }
+                data-&gt;blend(src,next);
+                vidCache-&gt;unlockAll();
+                break;
+            default:
+                ADM_assert(0);break;
+        }
+        DrawShow(data, 0, forced, dropframe, metric, inframe);
+        return true; // return src;			
+    }
+    GETFRAME(sourceFrame, src); // MEANX : not sure (jw detected a problem here)
+    data-&gt;duplicate(src);
+    vidCache-&gt;unlockAll();		
+    DrawShow(data, 0, forced, dropframe, metric, inframe);
+	return true;
 }
 
+/**
+    \fn goToTime
+*/
 bool                Decimate::goToTime(uint64_t usSeek)
 {
+    reset();
     return ADM_coreVideoFilter::goToTime(usSeek);
 }
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate/decimate.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate/decimate.h	2011-07-14 17:40:21 UTC (rev 7321)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate/decimate.h	2011-07-14 17:40:22 UTC (rev 7322)
@@ -16,6 +16,18 @@
 
 #define DrawString drawString
 
+#define GETFRAME(g, fp) \
+{ \
+	int GETFRAMEf=g; \
+	if (GETFRAMEf &lt; 0) GETFRAMEf = 0; \
+	(fp) = vidCache-&gt;getImage(GETFRAMEf); \
+}
+#if 1
+    #define aprintf(...) {}
+#else
+    #define aprintf ADM_info
+#endif
+#define OutputDebugString aprintf
 
 /**
     \class Telecide
@@ -26,7 +38,6 @@
 protected:
         deciMate           configuration;
 protected:
-        int 			num_frames_hi;
         int last_request, last_result;
         bool last_forced;
         double last_metric;
@@ -40,18 +51,14 @@
         bool hints_invalid;
         bool all_video_cycle;
         bool firsttime;
-        int heightY, row_sizeY, pitchY;
-        int heightUV, row_sizeUV, pitchUV;
-        int pitch, row_size, height;
         int xblocks, yblocks;
         unsigned int *sum, div;
-        bool debug, show;
         
         VideoCache	*vidCache;
 public:
-                            Decimate(ADM_coreVideoFilter *previous,CONFcouple *conf);
-                            ~Decimate();
-        bool                goToTime(uint64_t usSeek);
+                             Decimate(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                             ~Decimate();
+        bool                 goToTime(uint64_t usSeek);
         virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
         virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
         virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
@@ -62,7 +69,11 @@
 		                              double metric, int inframe );
         void   		FindDuplicate(int frame, int *chosen, double *metric, bool *forced   );
     	void   		FindDuplicate2(int frame, int *chosen, bool *forced );
-    	void   		FindDuplicateYUY2(int frame, int *chosen, double *metric, bool *force);
-    	void   		FindDuplicate2YUY2(int frame, int *chosen, bool *forced );
-	
+        void        updateInfo(void);
+        uint32_t    computeDiff(ADMImage *current,ADMImage *previous);
+        void        reset(void);
+        bool        get0(uint32_t *fn,ADMImage *data);
+        bool        get1(uint32_t *fn,ADMImage *data);
+        bool        get2(uint32_t *fn,ADMImage *data);
+        bool        get3(uint32_t *fn,ADMImage *data);
 };

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate/decimate_util.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate/decimate_util.cpp	2011-07-14 17:40:21 UTC (rev 7321)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/decimate/decimate_util.cpp	2011-07-14 17:40:22 UTC (rev 7322)
@@ -43,8 +43,87 @@
 
 #include &quot;ADM_default.h&quot;
 #include &quot;decimate.h&quot;
+/**
+    \fn computeDiff
+    \brief compute difference between image and its predecessor
+*/
+uint32_t Decimate::computeDiff(ADMImage *current,ADMImage *previous)
+{
+    uint8_t *prevY = previous-&gt;GetReadPtr(PLANAR_Y);
+    uint8_t *currY = current-&gt;GetReadPtr(PLANAR_Y);
+    uint32_t prevPitch=previous-&gt;GetPitch(PLANAR_Y);
+    uint32_t curPitch=current-&gt;GetPitch(PLANAR_Y);
+    deciMate *_param=&configuration;
+    // Zero
+    for (int y = 0; y &lt; yblocks; y++)
+    {
+        for (int x = 0; x &lt; xblocks; x++)
+        {
+            sum[y*xblocks+x] = 0;
+        }
+    }
+    // Raw diff
+    int height=info.height;
+    int width=info.width;
+    int inc=1;
+    
+    for (int y = 0; y &lt; height; y++)
+    {
+        for (int x = 0; x &lt; width;)
+        {
+            sum[(y/BLKSIZE)*xblocks+x/BLKSIZE] += abs((int)currY[x] - (int)prevY[x]);
+            x++;
+            if(!(x&amp;3))
+                if (_param-&gt;quality == 0 || _param-&gt;quality == 1)
+                {
+                    x+=12;
+                }
+        }
+        prevY += prevPitch;
+        currY += curPitch;
+    }
+    if (_param-&gt;quality == 1 || _param-&gt;quality == 3)
+    {
+#warning DO CHROMA SAMPLING
+#if 0
+        // also do u &amp; v
+        prevU = storepU[f-1];
+        prevV = storepV[f-1];
+        currU = storepU[f];
+        currV = storepV[f];
+        for (y = 0; y &lt; heightUV; y++)
+        {
+            for (x = 0; x &lt; row_sizeUV;)
+            {
+                sum[((2*y)/BLKSIZE)*xblocks+(2*x)/BLKSIZE] += abs((int)currU[x] - (int)prevU[x]);
+                sum[((2*y)/BLKSIZE)*xblocks+(2*x)/BLKSIZE] += abs((int)currV[x] - (int)prevV[x]);
+                x++;
+                if (_param-&gt;quality == 1)
+                {
+                    if (!(x%4)) x += 12;
+                }
+            }
+            prevU += pitchUV;
+            currU += pitchUV;
+            prevV += pitchUV;
+            currV += pitchUV;
 
-
+        }
+#endif
+    }
+    uint32_t highest_sum = 0;
+    for (int y = 0; y &lt; yblocks; y++)
+    {
+        for (int x = 0; x &lt; xblocks; x++)
+        {
+            if (sum[y*xblocks+x] &gt; highest_sum)
+            {
+                highest_sum = sum[y*xblocks+x];
+            }
+        }
+    }
+    return highest_sum;
+}
 /**
     \fn FindDuplicate
 */
@@ -52,13 +131,10 @@
 {
 	int f;
 	ADMImage  * store[MAX_CYCLE_SIZE+1];
-	const unsigned char *storepY[MAX_CYCLE_SIZE+1];
-	const unsigned char *storepU[MAX_CYCLE_SIZE+1];
-	const unsigned char *storepV[MAX_CYCLE_SIZE+1];
-	const unsigned char *prevY, *prevU, *prevV, *currY, *currU, *currV;
-	int x, y, lowest_index, div;
+    deciMate  *_param=&configuration;
+	int          lowest_index, div;
 	unsigned int count[MAX_CYCLE_SIZE], lowest;
-	bool found;
+	bool         found;
 	unsigned int highest_sum=0;
 
 	/* Only recalculate differences when a new set is needed. */
@@ -71,28 +147,25 @@
 	last_request = frame;
 
 	/* Get cycle+1 frames starting at the one before the asked-for one. */
+    ADMImage *lastImage=NULL;
 	for (f = 0; f &lt;= _param-&gt;cycle; f++)
 	{
 		GETFRAME(frame + f - 1, store[f]);
-		storepY[f] = YPLANE(store[f]);//-&gt;GetReadPtr(PLANAR_Y);
-		hints_invalid = GetHintingData((unsigned char *) storepY[f], &amp;hints[f]);
-		if (_param-&gt;quality == 1 || _param-&gt;quality == 3)
-		{
-			storepU[f] = UPLANE(store[f]);//-&gt;GetReadPtr(PLANAR_U);
-			storepV[f] = VPLANE(store[f]);//-&gt;GetReadPtr(PLANAR_V);
-		}
+        if(store[f]) lastImage=store[f];
+            else store[f]=lastImage;
+        hints_invalid=GetHintingData(lastImage-&gt;GetReadPtr(PLANAR_Y),&amp;hints[f]);
 	}
 
-    pitchY = _info.width; //store[0]-&gt;GetPitch(PLANAR_Y);
-    row_sizeY = _info.width; //store[0]-&gt;GetRowSize(PLANAR_Y);
-    heightY = _info.height; //store[0]-&gt;GetHeight(PLANAR_Y);
-	if (_param-&gt;quality == 1 || _param-&gt;quality == 3)
-	{
-		pitchUV = _info.width&gt;&gt;1; //store[0]-&gt;GetPitch(PLANAR_V);
-		row_sizeUV = _info.width&gt;&gt;1;//store[0]-&gt;GetRowSize(PLANAR_V);
-		heightUV = _info.height&gt;&gt;1;//store[0]-&gt;GetHeight(PLANAR_V);
-	}
+    if(!lastImage) 
+    {
+        *chosen=-1;
+        ADM_info(&quot;Cannot get input image\n&quot;);
+        return;
+    }
 
+    int row_sizeY = info.width; //store[0]-&gt;GetRowSize(PLANAR_Y);
+    int heightY = info.height; //store[0]-&gt;GetHeight(PLANAR_Y);
+
 	int use_quality=_param-&gt;quality;
 
 
@@ -120,65 +193,7 @@
 	/* Compare each frame to its predecessor. */
 	for (f = 1; f &lt;= _param-&gt;cycle; f++)
 	{
-		prevY = storepY[f-1];
-		currY = storepY[f];
-		for (y = 0; y &lt; yblocks; y++)
-		{
-			for (x = 0; x &lt; xblocks; x++)
-			{
-				sum[y*xblocks+x] = 0;
-			}
-		}
-		for (y = 0; y &lt; heightY; y++)
-		{
-			for (x = 0; x &lt; row_sizeY;)
-			{
-				sum[(y/BLKSIZE)*xblocks+x/BLKSIZE] += abs((int)currY[x] - (int)prevY[x]);
-				x++;
-				if (_param-&gt;quality == 0 || _param-&gt;quality == 1)
-				{
-					if (!(x%4)) x += 12;
-				}
-			}
-			prevY += pitchY;
-			currY += pitchY;
-		}
-		if (_param-&gt;quality == 1 || _param-&gt;quality == 3)
-		{
-			prevU = storepU[f-1];
-			prevV = storepV[f-1];
-			currU = storepU[f];
-			currV = storepV[f];
-			for (y = 0; y &lt; heightUV; y++)
-			{
-				for (x = 0; x &lt; row_sizeUV;)
-				{
-					sum[((2*y)/BLKSIZE)*xblocks+(2*x)/BLKSIZE] += abs((int)currU[x] - (int)prevU[x]);
-					sum[((2*y)/BLKSIZE)*xblocks+(2*x)/BLKSIZE] += abs((int)currV[x] - (int)prevV[x]);
-					x++;
-					if (_param-&gt;quality == 1)
-					{
-						if (!(x%4)) x += 12;
-					}
-				}
-				prevU += pitchUV;
-				currU += pitchUV;
-				prevV += pitchUV;
-				currV += pitchUV;
-			}
-		}
-		highest_sum = 0;
-		for (y = 0; y &lt; yblocks; y++)
-		{
-			for (x = 0; x &lt; xblocks; x++)
-			{
-				if (sum[y*xblocks+x] &gt; highest_sum)
-				{
-					highest_sum = sum[y*xblocks+x];
-				}
-			}
-		}
-		count[f-1] = highest_sum;
+		count[f-1] = computeDiff(store[f],store[f-1]);
 		showmetrics[f-1] = (count[f-1] * 100.0) / div;
 	}
 
@@ -194,7 +209,7 @@
 		lowest = count[0];
 		lowest_index = 0;
 	}
-	for (x = 1; x &lt; _param-&gt;cycle; x++)
+	for (int x = 1; x &lt; _param-&gt;cycle; x++)
 	{
 		if (count[x] &lt; lowest)
 		{
@@ -209,11 +224,10 @@
 		last_metric = (lowest * 100.0) / div;
 	*chosen = last_result;
 	*metric = last_metric;
-
 	
 	found = false;
 	last_forced = false;	
-
+    return;
 }
 /**
     \fn FindDuplicate2
@@ -222,9 +236,6 @@
 {
 	int f, g, fsum, bsum, highest, highest_index;
 	ADMImage * store[MAX_CYCLE_SIZE+1];
-	const unsigned char *storepY[MAX_CYCLE_SIZE+1];
-	const unsigned char *storepU[MAX_CYCLE_SIZE+1];
-	const unsigned char *storepV[MAX_CYCLE_SIZE+1];
 	const unsigned char *prevY, *prevU, *prevV, *currY, *currU, *currV;
 	int x, y;
 	double lowest;
@@ -233,7 +244,7 @@
 	unsigned int highest_sum;
 	bool found;
 #define BLKSIZE 32
-
+    deciMate *_param=&configuration;
 	/* Only recalculate differences when a new cycle is started. */
 	if (frame == last_request)
 	{
@@ -247,34 +258,14 @@
 	{
 		firsttime = false;
 		for (f = 0; f &lt; MAX_CYCLE_SIZE; f++) Dprev[f] = -1;
-		GETFRAME(frame, store[0]);
-		storepY[0] = YPLANE(store[0]);//-&gt;GetReadPtr(PLANAR_Y);
-		if (_param-&gt;quality == 1 || _param-&gt;quality == 3)
-		{
-			storepU[0] = UPLANE(store[0]);//-&gt;GetReadPtr(PLANAR_U);
-			storepV[0] = VPLANE(store[0]);//-&gt;GetReadPtr(PLANAR_V);
-		}
-
 		for (f = 1; f &lt;= _param-&gt;cycle; f++)
 		{
 			GETFRAME(frame + f - 1, store[f]);
-			storepY[f] =YPLANE( store[f]);//-&gt;GetReadPtr(PLANAR_Y);
-			if (_param-&gt;quality == 1 || _param-&gt;quality == 3)
-			{
-				storepU[f] = UPLANE(store[f]);//-&gt;GetReadPtr(PLANAR_U);
-				storepV[f] = VPLANE(store[f]);//-&gt;GetReadPtr(PLANAR_V);
-			}
 		}
 
-		pitchY = _info.width; //store[0]-&gt;GetPitch(PLANAR_Y);
-		row_sizeY = _info.width; //store[0]-&gt;GetRowSize(PLANAR_Y);
-		heightY = _info.height; //store[0]-&gt;GetHeight(PLANAR_Y);
-		if (_param-&gt;quality == 1 || _param-&gt;quality == 3)
-		{
-			pitchUV = _info.width&gt;&gt;1; //store[0]-&gt;GetPitch(PLANAR_V);
-			row_sizeUV = _info.width&gt;&gt;1; //store[0]-&gt;GetRowSize(PLANAR_V);
-			heightUV = _info.height&gt;&gt;1; //store[0]-&gt;GetHeight(PLANAR_V);
-		}
+		int row_sizeY = info.width; //store[0]-&gt;GetRowSize(PLANAR_Y);
+		int heightY = info.height; //store[0]-&gt;GetHeight(PLANAR_Y);
+
 		switch (_param-&gt;quality)
 		{
 		case 0: // subsample, luma only
@@ -298,64 +289,7 @@
 		/* Compare each frame to its predecessor. */
 		for (f = 1; f &lt;= _param-&gt;cycle; f++)
 		{
-			for (y = 0; y &lt; yblocks; y++)
-			{
-				for (x = 0; x &lt; xblocks; x++)
-				{
-					sum[y*xblocks+x] = 0;
-				}
-			}
-			prevY = storepY[f-1];
-			currY = storepY[f];
-			for (y = 0; y &lt; heightY; y++)
-			{
-				for (x = 0; x &lt; row_sizeY;)
-				{
-					sum[(y/BLKSIZE)*xblocks+x/BLKSIZE] += abs((int)currY[x] - (int)prevY[x]);
-					x++;
-					if (_param-&gt;quality == 0 || _param-&gt;quality == 1)
-					{
-						if (!(x%4)) x += 12;
-					}
-				}
-				prevY += pitchY;
-				currY += pitchY;
-			}
-			if (_param-&gt;quality == 1 || _param-&gt;quality == 3)
-			{
-				prevU = storepU[f-1];
-				currU = storepU[f];
-				prevV = storepV[f-1];
-				currV = storepV[f];
-				for (y = 0; y &lt; heightUV; y++)
-				{
-					for (x = 0; x &lt; row_sizeUV;)
-					{
-						sum[((2*y)/BLKSIZE)*xblocks+(2*x)/BLKSIZE] += abs((int)currU[x] - (int)prevU[x]);
-						sum[((2*y)/BLKSIZE)*xblocks+(2*x)/BLKSIZE] += abs((int)currV[x] - (int)prevV[x]);
-						x++;
-						if (_param-&gt;quality == 0 || _param-&gt;quality == 1)
-						{
-							if (!(x%4)) x += 12;
-						}
-					}
-					prevU += pitchUV;
-					currU += pitchUV;
-					prevV += pitchUV;
-					currV += pitchUV;
-				}
-			}
-			highest_sum = 0;
-			for (y = 0; y &lt; yblocks; y++)
-			{
-				for (x = 0; x &lt; xblocks; x++)
-				{
-					if (sum[y*xblocks+x] &gt; highest_sum)
-					{
-						highest_sum = sum[y*xblocks+x];
-					}
-				}
-			}
+			highest_sum = computeDiff(store[f],store[f-1]);
 			metrics[f-1] = (highest_sum * 100.0) / div;
 		}
 
@@ -366,34 +300,16 @@
 			else Dcurr[f] = 1;
 		}
 
-		if (debug)
+		if (configuration.debug)
 		{
-			sprintf(buf,&quot;Decimate: %d: %3.2f %3.2f %3.2f %3.2f %3.2f\n&quot;,
+			OutputDebugString(buf,&quot;Decimate: %d: %3.2f %3.2f %3.2f %3.2f %3.2f\n&quot;,
 					0, metrics[0], metrics[1], metrics[2], metrics[3], metrics[4]);
-			OutputDebugString(buf);
+			
 		}
-	}
- 	else if (frame &gt;= num_frames_hi - 1)
-	{
-		GETFRAME(num_frames_hi - 1, store[0]);
-		storepY[0] = YPLANE(store[0]);//-&gt;GetReadPtr(PLANAR_Y);
-		if (_param-&gt;quality == 1 || _param-&gt;quality == 3)
-		{
-			storepU[0] = UPLANE(store[0]);//-&gt;GetReadPtr(PLANAR_U);
-			storepV[0] = VPLANE(store[0]);//-&gt;GetReadPtr(PLANAR_V);
-		}
-		for (f = 0; f &lt; MAX_CYCLE_SIZE; f++) Dprev[f] = Dcurr[f];
-		for (f = 0; f &lt; MAX_CYCLE_SIZE; f++) Dcurr[f] = Dnext[f];
-	}
+	} // / !frame || first time
 	else
 	{
 		GETFRAME(frame + _param-&gt;cycle - 1, store[0]);
-		storepY[0] = YPLANE(store[0]);//-&gt;GetReadPtr(PLANAR_Y);
-		if (_param-&gt;quality == 1 || _param-&gt;quality == 3)
-		{
-			storepU[0] = UPLANE(store[0]);//-&gt;GetReadPtr(PLANAR_U);
-			storepV[0] = VPLANE(store[0]);//-&gt;GetReadPtr(PLANAR_V);
-		}
 		for (f = 0; f &lt; MAX_CYCLE_SIZE; f++) Dprev[f] = Dcurr[f];
 		for (f = 0; f &lt; MAX_CYCLE_SIZE; f++) Dcurr[f] = Dnext[f];
 	}
@@ -403,75 +319,12 @@
 	for (f = 1; f &lt;= _param-&gt;cycle; f++)
 	{
 		GETFRAME(frame + f + _param-&gt;cycle - 1, store[f]);
-		storepY[f] =YPLANE( store[f]);//-&gt;GetReadPtr(PLANAR_Y);
-		if (_param-&gt;quality == 1 || _param-&gt;quality == 3)
-		{
-			storepU[f] = UPLANE(store[f]);//-&gt;GetReadPtr(PLANAR_U);
-			storepV[f] = VPLANE(store[f]);//-&gt;GetReadPtr(PLANAR_V);
-		}
 	}
 
 	/* Compare each frame to its predecessor. */
 	for (f = 1; f &lt;= _param-&gt;cycle; f++)
 	{
-		prevY = storepY[f-1];
-		currY = storepY[f];
-		for (y = 0; y &lt; yblocks; y++)
-		{
-			for (x = 0; x &lt; xblocks; x++)
-			{
-				sum[y*xblocks+x] = 0;
-			}
-		}
-		for (y = 0; y &lt; heightY; y++)
-		{
-			for (x = 0; x &lt; row_sizeY;)
-			{
-				sum[(y/BLKSIZE)*xblocks+x/BLKSIZE] += abs((int)currY[x] - (int)prevY[x]);
-				x++;
-				if (_param-&gt;quality == 0 || _param-&gt;quality == 1)
-				{
-					if (!(x%4)) x += 12;
-				}
-			}
-			prevY += pitchY;
-			currY += pitchY;
-		}
-		if (_param-&gt;quality == 1 || _param-&gt;quality == 3)
-		{
-			prevU = storepU[f-1];
-			currU = storepU[f];
-			prevV = storepV[f-1];
-			currV = storepV[f];
-			for (y = 0; y &lt; heightUV; y++)
-			{
-				for (x = 0; x &lt; row_sizeUV;)
-				{
-					sum[((2*y)/BLKSIZE)*xblocks+(2*x)/BLKSIZE] += abs((int)currU[x] - (int)prevU[x]);
-					sum[((2*y)/BLKSIZE)*xblocks+(2*x)/BLKSIZE] += abs((int)currV[x] - (int)prevV[x]);
-					x++;
-					if (_param-&gt;quality == 0 || _param-&gt;quality == 1)
-					{
-						if (!(x%4)) x += 12;
-					}
-				}
-				prevU += pitchUV;
-				currU += pitchUV;
-				prevV += pitchUV;
-				currV += pitchUV;
-			}
-		}
-		highest_sum = 0;
-		for (y = 0; y &lt; yblocks; y++)
-		{
-			for (x = 0; x &lt; xblocks; x++)
-			{
-				if (sum[y*xblocks+x] &gt; highest_sum)
-				{
-					highest_sum = sum[y*xblocks+x];
-				}
-			}
-		}
+        highest_sum=computeDiff(store[f],store[f-1]);
 		metrics[f-1] = (highest_sum * 100.0) / div;
 	}
 
@@ -502,22 +355,22 @@
 		else Dnext[f] = 1;
 	}
 
-	if (debug)
+	if (configuration.debug)
 	{
-		sprintf(buf,&quot;Decimate: %d: %3.2f %3.2f %3.2f %3.2f %3.2f\n&quot;,
+		OutputDebugString(&quot;Decimate: %d: %3.2f %3.2f %3.2f %3.2f %3.2f\n&quot;,
 		        frame + 5, metrics[0], metrics[1], metrics[2], metrics[3], metrics[4]);
-		OutputDebugString(buf);
+		
 	}
 
-	if (debug)
+	if (configuration.debug)
 	{
-		sprintf(buf,&quot;Decimate: %d: %d %d %d %d %d\n&quot;,
+		OutputDebugString(&quot;Decimate: %d: %d %d %d %d %d\n&quot;,
 		        frame, Dcurr[0], Dcurr[1], Dcurr[2], Dcurr[3], Dcurr[4]);
 //		sprintf(buf,&quot;Decimate: %d: %d %d %d %d %d - %d %d %d %d %d - %d %d %d %d %d\n&quot;,
 //		        frame, Dprev[0], Dprev[1], Dprev[2], Dprev[3], Dprev[4],
 //					   Dcurr[0], Dcurr[1], Dcurr[2], Dcurr[3], Dcurr[4],
 //					   Dnext[0], Dnext[1], Dnext[2], Dnext[3], Dnext[4]);
-		OutputDebugString(buf);
+		
 	}
 
 	/* Find the longest strings of duplicates and decimate a frame from it. */
@@ -598,10 +451,10 @@
 		*chosen = last_result = frame + highest_index;
 	}
 	last_forced = false;
-	if (debug)
+	if (configuration.debug)
 	{
-		sprintf(buf,&quot;Decimate: dropping frame %d\n&quot;, last_result);
-		OutputDebugString(buf);
+		OutputDebugString(&quot;Decimate: dropping frame %d\n&quot;, last_result);
+		
 	}
 
 	
@@ -611,12 +464,76 @@
 	{
 		*chosen = last_result ;
 		*forced = last_forced = true;
-		if (debug)
+		if (configuration.debug)
 		{
-			sprintf(buf,&quot;Decimate: overridden drop frame -- drop %d\n&quot;, last_result);
-			OutputDebugString(buf);
+			OutputDebugString(&quot;Decimate: overridden drop frame -- drop %d\n&quot;, last_result);
 		}
 	}
 }
+/**
+    \fn DrawShow
+*/
+void Decimate::DrawShow(ADMImage  *src, int useframe, bool forced, int dropframe,
+						double metric, int inframe)
+{
+	char buf[80];
+    deciMate *_param=&configuration;
+	int start = (useframe / _param-&gt;cycle) * _param-&gt;cycle;
+
+	if (configuration.show == true)
+	{
+		sprintf(buf, &quot;Decimate %d&quot;, 0); 	DrawString(src, 0, 0, buf);
+		sprintf(buf, &quot;Copyright 2003 Donald Graft&quot;);	    DrawString(src, 0, 1, buf);
+		sprintf(buf,&quot;%d: %3.2f&quot;, start, showmetrics[0]);	DrawString(src, 0, 3, buf);
+		sprintf(buf,&quot;%d: %3.2f&quot;, start + 1, showmetrics[1]);DrawString(src, 0, 4, buf);
+		sprintf(buf,&quot;%d: %3.2f&quot;, start + 2, showmetrics[2]);DrawString(src, 0, 5, buf);
+		sprintf(buf,&quot;%d: %3.2f&quot;, start + 3, showmetrics[3]);DrawString(src, 0, 6, buf);
+		sprintf(buf,&quot;%d: %3.2f&quot;, start + 4, showmetrics[4]);DrawString(src, 0, 7, buf);
+		if (all_video_cycle == false)
+		{
+			sprintf(buf,&quot;in frm %d, use frm %d&quot;, inframe, useframe);
+			DrawString(src, 0, 8, buf);
+			if (forced == false)
+				sprintf(buf,&quot;chose %d, dropping&quot;, dropframe);
+			else
+				sprintf(buf,&quot;chose %d, dropping, forced!&quot;, dropframe);
+			DrawString(src, 0, 9, buf);
+		}
+		else
+		{
+			sprintf(buf,&quot;in frm %d&quot;, inframe);			                    DrawString(src, 0, 8, buf);
+			sprintf(buf,&quot;chose %d, decimating all-video cycle&quot;, dropframe);	DrawString(src, 0, 9, buf);
+		}
+	}
+	if (configuration.debug)
+	{
+		if (!(inframe%_param-&gt;cycle))
+		{
+			OutputDebugString(buf,&quot;Decimate: %d: %3.2f\n&quot;, start, showmetrics[0]);
+			OutputDebugString(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 1, showmetrics[1]);
+			OutputDebugString(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 2, showmetrics[2]);
+			OutputDebugString(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 3, showmetrics[3]);
+			OutputDebugString(buf,&quot;Decimate: %d: %3.2f\n&quot;, start + 4, showmetrics[4]);
+			
+		}
+		if (all_video_cycle == false)
+		{
+			OutputDebugString(buf,&quot;Decimate: in frm %d useframe %d\n&quot;, inframe, useframe);
+			if (forced == false)
+            {
+				OutputDebugString(&quot;Decimate: chose %d, dropping\n&quot;, dropframe);
+            }
+			else
+            {
+				OutputDebugString(&quot;Decimate: chose %d, dropping, forced!\n&quot;, dropframe);
+            }
+		}
+		else
+		{
+			OutputDebugString(&quot;Decimate: in frm %d\n&quot;, inframe);
+			OutputDebugString(&quot;Decimate: chose %d, decimating all-video cycle\n&quot;, dropframe);
+		}
+	}
+}
 // EOF
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004475.html">[Avidemux-svn-commit] r7321 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/telecide
</A></li>
	<LI>Next message: <A HREF="004477.html">[Avidemux-svn-commit] r7323 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4476">[ date ]</a>
              <a href="thread.html#4476">[ thread ]</a>
              <a href="subject.html#4476">[ subject ]</a>
              <a href="author.html#4476">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
