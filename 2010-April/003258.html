<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r6054 - in	branches/avidemux_2.6_branch_mean/avidemux_core:	ADM_coreImage/include ADM_coreImage/src	ADM_coreVideoFilter/include ADM_coreVideoFilter/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2010-April/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6054%20-%20in%0A%09branches/avidemux_2.6_branch_mean/avidemux_core%3A%0A%09ADM_coreImage/include%20ADM_coreImage/src%0A%09ADM_coreVideoFilter/include%20ADM_coreVideoFilter/src&In-Reply-To=%3C201004051805.o35I5oNp032009%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003257.html">
   <LINK REL="Next"  HREF="003259.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r6054 - in	branches/avidemux_2.6_branch_mean/avidemux_core:	ADM_coreImage/include ADM_coreImage/src	ADM_coreVideoFilter/include ADM_coreVideoFilter/src</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6054%20-%20in%0A%09branches/avidemux_2.6_branch_mean/avidemux_core%3A%0A%09ADM_coreImage/include%20ADM_coreImage/src%0A%09ADM_coreVideoFilter/include%20ADM_coreVideoFilter/src&In-Reply-To=%3C201004051805.o35I5oNp032009%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r6054 - in	branches/avidemux_2.6_branch_mean/avidemux_core:	ADM_coreImage/include ADM_coreImage/src	ADM_coreVideoFilter/include ADM_coreVideoFilter/src">mean at mail.berlios.de
       </A><BR>
    <I>Mon Apr  5 20:05:50 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="003257.html">[Avidemux-svn-commit] r6053 -	branches/avidemux_2.6_branch_mean/avidemux/qt4
</A></li>
        <LI>Next message: <A HREF="003259.html">[Avidemux-svn-commit] r6055 - in	branches/avidemux_2.6_branch_mean/avidemux_core:	ADM_coreDemuxer/include ADM_coreImageLoader/src	ADM_coreVideoCodec/include ADM_coreVideoEncoder/include	ADM_coreVideoEncoder/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3258">[ date ]</a>
              <a href="thread.html#3258">[ thread ]</a>
              <a href="subject.html#3258">[ subject ]</a>
              <a href="author.html#3258">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2010-04-05 20:05:50 +0200 (Mon, 05 Apr 2010)
New Revision: 6054

Removed:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_rgb.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/rgb2yuv.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/yuv.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_colorspace.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageSave.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/DIA_flyDialog.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp
Log:
[colorspace] Merge resizer + color converted inside ADM_ColorSpace

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_colorspace.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_colorspace.h	2010-04-05 18:05:44 UTC (rev 6053)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_colorspace.h	2010-04-05 18:05:50 UTC (rev 6054)
@@ -16,116 +16,53 @@
  #define ADM_COLORSPACE_H
 #include &quot;ADM_rgb.h&quot; // To have colors
 
-// Some handy simple colorspace code
-
-uint8_t  COL_yv12rgbBMP(uint32_t ww, uint32_t hh, uint8_t* in, uint8_t *out);
-uint8_t  COL_yv12rgb(uint32_t w, uint32_t h,uint8_t * ptr, uint8_t * out );
-
-uint8_t COL_422_YV12( uint8_t *in[3], uint32_t stride[3],  uint8_t *out,uint32_t w, uint32_t h);
-uint8_t COL_411_YV12( uint8_t *in[3], uint32_t stride[3],  uint8_t *out,uint32_t w, uint32_t h);
-
-uint8_t COL_RgbToYuv(uint8_t R,uint8_t G,uint8_t B, uint8_t *y,int8_t *u,int8_t  *v);
-uint8_t COL_YuvToRgb( uint8_t y,int8_t u,int8_t v,uint8_t *r,uint8_t *g,uint8_t *b);
-
-uint8_t COL_RawRGB32toYV12(uint8_t *data1,uint8_t *data2, uint8_t *oy,uint8_t *oy2, 
-				uint8_t *u, uint8_t *v,uint32_t lineSize,uint32_t height,uint32_t stride);
-
-uint8_t COL_RGB24_to_YV12(uint32_t w,uint32_t h,uint8_t *rgb, uint8_t *yuv);
-uint8_t COL_RGB24_to_YV12_revert(uint32_t w,uint32_t h,uint8_t *rgb, uint8_t *yuv);
-
-// Generic colorspace conversion class
-
-class ADMColorspace
+typedef enum 
 {
+    ADM_CS_BILINEAR,
+    ADM_CS_BICUBIC,
+    ADM_CS_LANZCOS
+}ADMColorSpace_algo;
+/**
+    \class ADMColorSpace
+*/
+class ADMColorSpaceFull
+{
   protected:
-    void  *context;
-    uint32_t width,height;
-    ADM_colorspace fromColor,toColor;
-    uint8_t getStrideAndPointers(uint8_t  *from,ADM_colorspace fromColor,uint8_t **srcData,int *srcStride);
+    void            *context;
+    uint32_t        srcWidth,srcHeight;
+    uint32_t        dstWidth,dstHeight;
+    ADM_colorspace  fromColor,toColor;
+    ADMColorSpace_algo algo;
+    uint8_t         getStrideAndPointers(bool dst,uint8_t  *from,ADM_colorspace fromColor,
+                                            uint8_t **srcData,int *srcStride);
   public :
     
-    ADMColorspace(uint32_t w, uint32_t h, ADM_colorspace from,ADM_colorspace to);
-    uint8_t convert(uint8_t  *from, uint8_t *to);
-    ~ADMColorspace();
-};
-/* Convert YV12 to RGB32, the reset must be called at least once before using scale */
- class ColBase
- {
-  protected:
-    void        *_context;
-    uint32_t    w,h;  
-    uint8_t     clean(void);
-     
-  public:
-                ColBase(uint32_t w, uint32_t h);
-                ~ColBase();
-     virtual   uint8_t reset(uint32_t neww, uint32_t newh) {return 0;};
-     virtual   uint8_t scale(uint8_t *src, uint8_t *target){return 0;};  
- };
- //************ YV12 to RB32********************************
- class ColYuvRgb : public ColBase
- {
-  protected:
-              uint32_t _inverted;
-  public:
-                ColYuvRgb(uint32_t w, uint32_t h,uint32_t inv=0): ColBase(w,h) {_inverted=inv;};
-                ~ColYuvRgb(){clean();};
-      virtual  uint8_t reset(uint32_t neww, uint32_t newh);
-      virtual  uint8_t scale(uint8_t *src, uint8_t *target);
-      virtual  uint8_t scale(uint8_t *src, uint8_t *target,uint32_t startx,uint32_t starty, uint32_t w,uint32_t h,uint32_t totalW,uint32_t totalH);    
- };
- //********************************************
-
-  /* Convert RGB24/32 to YV12, the reset must be called at least once before using scale */
-  class ColRgbToYV12  : public ColBase
-  {
-  protected:
-                int             _bmpMode;
-                ADM_colorspace  _colorspace;
-                uint32_t        _backward;
-  public:
-                ColRgbToYV12(uint32_t w, uint32_t h,ADM_colorspace col) : ColBase(w,h) 
-                    {
-                            _colorspace=col;
-                            _bmpMode=0;
-                    };
-                ~ColRgbToYV12(){clean();};
-      virtual  uint8_t reset(uint32_t neww, uint32_t newh);
-      virtual  uint8_t scale(uint8_t *src, uint8_t *target);  
-               uint8_t changeColorSpace(ADM_colorspace col);   
-               uint8_t setBmpMode(void);
-      
-  };
-//********************************************
-/* Convert RGB24 to YV12, the reset must be called at least once before using scale */
-  class ColYv12Rgb24  : public ColBase
-  {
-  protected:
+                    ADMColorSpaceFull(ADMColorSpace_algo algo, uint32_t sw, uint32_t sh, uint32_t dw,uint32_t dh,ADM_colorspace from,ADM_colorspace to);
+    bool            reset(ADMColorSpace_algo, uint32_t sw, uint32_t sh, uint32_t dw,uint32_t dh,ADM_colorspace from,ADM_colorspace to);
     
-  public:
-                ColYv12Rgb24(uint32_t w, uint32_t h) : ColBase(w,h) {};
-                ~ColYv12Rgb24(){clean();};
-      virtual  uint8_t reset(uint32_t neww, uint32_t newh);
-      virtual  uint8_t scale(uint8_t *src, uint8_t *target);     
-      
-  };
-//*************************************
-class COL_Generic2YV12 
+
+    bool            convert(uint8_t  *from, uint8_t *to);
+    bool            convertPlanes(uint32_t  sourceStride[3],uint32_t destStride[3],     
+                                  uint8_t   *sourceData[3], uint8_t *destData[3]);
+                    ~ADMColorSpaceFull();
+};
+/**
+    \class ADMColorSpaceSimple
+    \brief Same as Full but target &amp; source width/height are the same
+*/
+class ADMColorSpaceSimple :public ADMColorSpaceFull
 {
-protected:
-                void        *_context;
-                uint32_t    w,h;  
-                uint8_t     clean(void);
-                ADM_colorspace _colorspace;
-                uint32_t       _backward;
-    
 public:
-        
-                COL_Generic2YV12(uint32_t w, uint32_t h,ADM_colorspace) ;
-                ~COL_Generic2YV12(){clean();};
-                uint8_t transform(uint8_t **planes, uint32_t *strides,uint8_t *target);
-                
-}; 
+    bool            changeWidthHeight(uint32_t newWidth, uint32_t newHeight);
+                    ADMColorSpaceSimple( uint32_t width, uint32_t height, ADM_colorspace from,ADM_colorspace to,ADMColorSpace_algo algo=ADM_CS_BICUBIC):
+                        ADMColorSpaceFull(algo, width, height, width,height, from, to)
+                     {
+
+                     }
+};
+
+// Some misc functions
+bool ADM_ConvertRgb24ToYV12(bool inverted,uint32_t w, uint32_t h, uint8_t *source, uint8_t *destination);
 #endif
 //EOF
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp	2010-04-05 18:05:44 UTC (rev 6053)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp	2010-04-05 18:05:50 UTC (rev 6054)
@@ -53,18 +53,41 @@
     case ADM_COLOR_YV12: return PIX_FMT_YUV420P;
     case ADM_COLOR_YUV422P: return PIX_FMT_YUV422P;
     case ADM_COLOR_RGB32A: return PIX_FMT_RGB32;
+    case ADM_COLOR_BGR32A: return PIX_FMT_BGR32;
+    case ADM_COLOR_RGB24: return PIX_FMT_RGB24;
     default : ADM_assert(0); 
   }
   return PIX_FMT_YUV420P;
 }
 /**
       \fn getStrideAndPointers
+      \param dst=1 -&gt; destination, =0 source
       \brief Fill in strides etc.. needed by libswscale
 */
-uint8_t ADMColorspace::getStrideAndPointers(uint8_t  *from,ADM_colorspace fromColor,uint8_t **srcData,int *srcStride)
+uint8_t ADMColorSpaceFull::getStrideAndPointers(bool dst,
+        uint8_t  *from,ADM_colorspace fromColor,
+        uint8_t **srcData,int *srcStride)
 {
+    uint32_t width,height;
+    if(!dst)
+    {
+        width=srcWidth;
+        height=srcHeight;
+    }else
+    {
+        width=dstWidth;
+        height=dstHeight;
+    }
   switch(fromColor)
   {
+    case ADM_COLOR_RGB24:
+            srcData[0]=from;
+            srcData[1]=NULL;
+            srcData[2]=NULL;
+            srcStride[0]=width*3;
+            srcStride[1]=0;
+            srcStride[2]=0;
+            break;
     case  ADM_COLOR_YV12:
             srcData[0]=from;
             srcData[1]=from+width*height;
@@ -89,6 +112,14 @@
             srcStride[1]=0;
             srcStride[2]=0;
             break;
+    case ADM_COLOR_BGR32A:
+            srcData[0]=from;
+            srcData[1]=NULL;
+            srcData[2]=NULL;
+            srcStride[0]=width*4;
+            srcStride[1]=0;
+            srcStride[2]=0;
+            break;
     default:
         ADM_assert(0);
   }
@@ -101,21 +132,32 @@
   @param to Target image
 */
 
-uint8_t ADMColorspace::convert(uint8_t  *from, uint8_t *to)
+bool ADMColorSpaceFull::convert(uint8_t  *from, uint8_t *to)
 {
   uint8_t *srcData[3];
   uint8_t *dstData[3];
   int srcStride[3];
   int dstStride[3];
   
-  getStrideAndPointers(from,fromColor,srcData,srcStride);
-  getStrideAndPointers(to,toColor,dstData,dstStride);
-  sws_scale(CONTEXT,srcData,srcStride,0,height,dstData,dstStride);
-  return 1;
+  getStrideAndPointers(false,from,fromColor,srcData,srcStride);
+  getStrideAndPointers(true,to,toColor,dstData,dstStride);
+  sws_scale(CONTEXT,srcData,srcStride,0,srcHeight,dstData,dstStride);
+  return true;
   
 }
-
 /**
+    \fn convertPlanes
+    \brief Same as convert but the 3 planes are given separately
+*/
+bool            ADMColorSpaceFull::convertPlanes(uint32_t  sourceStride[3],uint32_t destStride[3],     
+                                  uint8_t   *sourceData[3], uint8_t *destData[3])
+{
+    int xs[3]={sourceStride[0],sourceStride[1],sourceStride[2]};
+    int xd[3]={destStride[0],destStride[1],destStride[2]};
+     sws_scale(CONTEXT,sourceData,xs,0,srcHeight,destData,xd);
+     return true;
+}
+/**
     \fn  ADMColorspace
     \brief Constructor
   @param w width
@@ -124,37 +166,76 @@
   @param to colorspace to concert to
 */
 
-ADMColorspace::ADMColorspace(uint32_t w, uint32_t h, ADM_colorspace from,ADM_colorspace to)
+ADMColorSpaceFull::ADMColorSpaceFull(ADMColorSpace_algo algo,
+            uint32_t sw, uint32_t sh,
+            uint32_t dw, uint32_t dh,
+            ADM_colorspace from,ADM_colorspace to)
 {
-  int flags=SWS_BICUBLIN;
-  FLAGS();
+   context=NULL;
+   reset(algo,sw,sh,dw,dh,from,to);
+
+}
+/**
+    \fn  ~ADMColorspace
+    \brief Destructor
+*/
+ADMColorSpaceFull::~ADMColorSpaceFull()
+{
+  if(context)
+  {
+     sws_freeContext(CONTEXT);
+     context=NULL;
+  }
+}
+/**
+    \fn reset
+*/
+bool  ADMColorSpaceFull::reset(ADMColorSpace_algo, uint32_t sw, uint32_t sh, uint32_t dw,uint32_t dh,ADM_colorspace from,ADM_colorspace to)
+{
+    if(context) sws_freeContext(CONTEXT);
+    context=NULL;
+    this-&gt;algo=algo;
+    int flags=SWS_BICUBLIN;
+#warning SET algo!
+    FLAGS();
   
-    width=w;
-    height=h;
+    srcWidth=sw;
+    srcHeight=sh;
+
+    dstWidth=dw;
+    dstHeight=dh;
+
     fromColor=from;
     toColor=to;
     PixelFormat lavFrom=ADMColor2LAVColor(fromColor);
     PixelFormat lavTo=ADMColor2LAVColor(toColor);
     
     context=(void *)sws_getContext(
-                      width,height,
+                      srcWidth,srcHeight,
                       lavFrom ,
-                      width,height,
+                      dstWidth,dstHeight,
                       lavTo,
                       flags, NULL, NULL,NULL);
+}
+//------------------------------
+bool            ADMColorSpaceSimple::changeWidthHeight(uint32_t newWidth, uint32_t newHeight)
+{
+    if(newWidth==srcWidth &amp;&amp; newHeight==srcHeight) return true; // no change
+    
+     return reset(algo, newWidth,newHeight, newWidth,newHeight,fromColor,toColor);
 
 }
+
+
 /**
-    \fn  ~ADMColorspace
-    \brief Destructor
+    \fn ADM_ConvertRgb24ToYV12
 */
-ADMColorspace::~ADMColorspace()
+bool ADM_ConvertRgb24ToYV12(bool inverted,uint32_t w, uint32_t h, uint8_t *source, uint8_t *destination) 
 {
-  if(context)
-  {
-     sws_freeContext(CONTEXT);
-     context=NULL;
-  }
+    ADMColorSpaceSimple  converter( w,h,ADM_COLOR_RGB24,ADM_COLOR_YV12);
+    return converter.convert(source,destination);
+    
+
+
 }
- 
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageSave.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageSave.cpp	2010-04-05 18:05:44 UTC (rev 6053)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageSave.cpp	2010-04-05 18:05:50 UTC (rev 6054)
@@ -11,6 +11,27 @@
 {
 #include &quot;ADM_lavcodec.h&quot;
 }
+/**
+    \fn SwapMe
+*/
+static inline void SwapMe(uint8_t *tgt,uint8_t *src,int nb);
+void SwapMe(uint8_t *tgt,uint8_t *src,int nb)
+{
+    uint8_t r,g,b;
+   nb=nb;
+   while(nb--)
+   {
+       r=*src++;
+       g=*src++;
+       b=*src++;
+       *tgt++=r;
+       *tgt++=g;
+       *tgt++=b;
+       
+   }
+   return;
+    
+}
 
 /**
     \fn saveAsBmp
@@ -61,13 +82,24 @@
 //            ADM_dealloc(out);
             return 0;
         }
+        ADMColorSpaceSimple converter(bmph.biWidth, bmph.biHeight, ADM_COLOR_YV12,ADM_COLOR_BGR24);
 
-        if(!COL_yv12rgbBMP(bmph.biWidth, bmph.biHeight,data, out))
-        {
-              GUI_Error_HIG(QT_TR_NOOP(&quot;Error converting to BMP&quot;), NULL);
-              ADM_dealloc(out);
-              return 0;
+        uint32_t ww=bmph.biWidth;
+        uint32_t hh=bmph.biHeight;
+        uint8_t swap[ww*3];
+        
+        uint8_t *up=out;
+        uint8_t *down=out+(hh-1)*ww*3;
+        
+        for(int y=0;y&lt;hh&gt;&gt;1;y++)
+        {
+            SwapMe(swap,up,ww); 
+            SwapMe(up,down,ww);
+            memcpy( down,swap,ww*3);
+            down-=3*ww;
+            up+=3*ww;
         }
+
         fd = ADM_fopen (filename, &quot;wb&quot;);
         if (!fd)
         {

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_rgb.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_rgb.cpp	2010-04-05 18:05:44 UTC (rev 6053)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_rgb.cpp	2010-04-05 18:05:50 UTC (rev 6054)
@@ -1,598 +0,0 @@
-/***************************************************************************
-                         ADM_Rgb : wrapper for yv12-&gt;RGB display
-                            using mplayer postproc
-
-
-    begin                : Thu Apr 16 2003
-    copyright            : (C) 2002 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
-    
- 16 08 2007 : Removed the manual RGB&lt;-&gt;BGR, newer swscale can output directly in the correct mode   
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-
-#include &quot;ADM_default.h&quot;
-#include &quot;ADM_colorspace.h&quot;
-
-extern &quot;C&quot; {
-#include &quot;ADM_ffmpeg/libavcodec/avcodec.h&quot;
-#include &quot;ADM_ffmpeg/libavutil/avutil.h&quot;
-#include &quot;ADM_ffmpeg/libswscale/swscale.h&quot;
-}
-
-	
-#include &quot;ADM_rgb.h&quot; 
-
-#define CLEANUP() \
-    if(_context) \
-    {\
-        if(ww==w &amp;&amp; hh==h)\
-           return 1; \
-        clean();  \
-    }
-
-#ifdef ADM_CPU_X86
-		#define ADD(x,y) if( CpuCaps::has##x()) flags|=SWS_CPU_CAPS_##y;
-#define FLAGS()		ADD(MMX,MMX);				ADD(3DNOW,3DNOW);		ADD(MMXEXT,MMX2);
-#else
-#ifdef ADM_CPU_ALTIVEC
-#define FLAGS() flags|=SWS_CPU_CAPS_ALTIVEC;
-#else
-#define FLAGS()
-#endif
-#endif
-
-#define TARGET_COLORSPACE       PIX_FMT_RGB32 
-#define ALTERNATE_COLORSPACE    PIX_FMT_BGR32
-
- //***********************************************
- ColBase::ColBase(uint32_t ww, uint32_t hh)
- {
-      _context=NULL;
-      w=0xfffff;
-      h=0xfffff;
-      //reset(ww,hh);   
- }
- ColBase::~ColBase()
- {
-    clean();   
- }
- //***********************************************
- uint8_t ColBase::clean(void)
- {
-        if(_context)
-		{
-			sws_freeContext((SwsContext *)_context);
-		}
-		_context=NULL; 
-		return 1;  
- }
- //***********************************************
- uint8_t ColYuvRgb::reset(uint32_t ww, uint32_t hh)
- {
- int flags=0;
-	
-    CLEANUP();
-    FLAGS();
-    flags|=SWS_BILINEAR;
-    PixelFormat fmt=TARGET_COLORSPACE;
-    if(_inverted) fmt=ALTERNATE_COLORSPACE;
-    if(!ww || !hh) return 0;
-
-	if (_context)
-		sws_freeContext((SwsContext *)_context);
-
-	 _context=(void *)sws_getContext(
-                      ww,hh,
-                      PIX_FMT_YUV420P ,
-                      ww,hh,
-                      fmt,
-                      flags, NULL, NULL,NULL);
-
-    if(!_context) ADM_assert(0);
-    w=ww;
-    h=hh;
-    return 1;
-}
-/**
-      \fn invertRGB
-      \brief Do RGBA-&gt;BGRA swap
-      howmuch is in pixel, i.e. you have to multiply it by 4 to get the nb of bytes!
-*/
-static void ADM_RGBA2BGRA(uint8_t *ptr, uint32_t howmuch)
-{
-#ifdef ADM_CPU_X86
-    __asm__(
-                        &quot;1: mov            (%0),%%eax \n&quot;
-                        &quot;bswap          %%eax \n&quot;
-                        &quot;rorl           $8,%%eax \n&quot;
-                        &quot;mov            %%eax,(%0) \n&quot;
-                        &quot;add            $4,%0 \n&quot;
-                        &quot;dec            %1 \n&quot;
-                        &quot;jne            1b\n&quot;
-                :  :&quot;r&quot; (ptr),&quot;r&quot; (howmuch)
-                : &quot;%eax&quot;
-                
-      
-                );
-#else
-uint8_t r,g,b,a;
-                  for(int xx=0;xx&lt;howmuch;xx++)
-                  {
-                      r=ptr[0];
-                      g=ptr[1];
-                      b=ptr[2];
-                      a=ptr[3];
-                      ptr[0]=b;
-                      ptr[1]=g;
-                      ptr[2]=r;
-                      ptr[3]=a;
-                      ptr+=4;
-                  }
-#endif
-}
-/**
-      \fn scale
-      \brief Do the actual colorconversion
-
-*/
- uint8_t ColYuvRgb::scale(uint8_t *src, uint8_t *target)
- {
-    uint8_t *srd[3];
-	uint8_t *dst[3];
-	int ssrc[3];
-	int ddst[3];
-
-	ADM_assert(_context);
-	
-			uint32_t page;
-
-			page=w*h;
-			srd[0]=src;
-			srd[1]=src+page;
-			srd[2]=src+((page*5)&gt;&gt;2);
-
-			ssrc[0]=w;
-			ssrc[1]=ssrc[2]=w&gt;&gt;1;
-
-			
-			dst[0]=target;
-			dst[1]=NULL;
-			dst[2]=NULL;
-			ddst[0]=w*4;
-			ddst[1]=ddst[2]=0;
-
-			sws_scale((SwsContext *)_context,srd,ssrc,0,h,dst,ddst);
-#if 0
-        if(_inverted)
-        {
-                uint8_t r,g,b,a;
-                uint8_t *ptr=target;
-                int pel=h*w;
-                ADM_RGBA2BGRA(ptr,pel);
-        }
-#endif
-#if  defined( ADM_BIG_ENDIAN)
-	if (!_inverted)
-	{
-        uint8_t r,g,b,a;
-        uint8_t *ptr=target;
-        int pel=h*w;
-        for(int yy=0;yy&lt;pel;yy++)
-        {
-              r=ptr[0];
-              g=ptr[1];
-              b=ptr[2];
-              a=ptr[3];
-              ptr[0]=a;
-              ptr[1]=b;
-              ptr[2]=g;
-              ptr[3]=r;
-              ptr+=4;
-        }
-	}
-#endif
-     
-        return 1;
- }
-
-/**
-      \fn scale
-      \brief Change colorspace but and put result in the target image , which is bigger
-        Normally not used !
-*/
- uint8_t ColYuvRgb::scale(uint8_t *src, uint8_t *target,uint32_t startx,uint32_t starty, uint32_t tw,uint32_t th,uint32_t totalW,uint32_t totalH)
- {
-    uint8_t *srd[3];
-    uint8_t *dst[3];
-    int ssrc[3];
-    int ddst[3];
-
-    ADM_assert(_context);
-    
-    uint32_t page;
-
-    page=tw*th;
-    srd[0]=src;
-    srd[1]=src+page;
-    srd[2]=src+((page*5)&gt;&gt;2);
-
-    ssrc[0]=tw;
-    ssrc[1]=ssrc[2]=tw&gt;&gt;1;
-
-    
-    dst[0]=target+(startx*4)+starty*totalW*4;
-    dst[1]=NULL;
-    dst[2]=NULL;
-    ddst[0]=totalW*4;
-    ddst[1]=ddst[2]=0;
-
-    sws_scale((SwsContext *)_context,srd,ssrc,0,th,dst,ddst);
-#if 0
-    if(_inverted)
-    {
-            uint8_t r,g,b,a;
-            uint8_t *ptr=NULL;
-            int pel=th;
-            for(int yy=0;yy&lt;th;yy++)
-            {
-              ptr=target+(startx*4)+(starty+yy)*totalW*4;;
-              ADM_RGBA2BGRA(ptr,tw);
-            }
-     }
-#endif
-
-#if defined(ADM_BIG_ENDIAN)
-     uint8_t r, g, b, a;
-     uint8_t *ptr = target;
-     int pel = h * w;
-
-     for (int yy = 0; yy &lt; th; yy++)
-     {
-          ptr = target + (startx * 4) + (starty + yy) * totalW * 4;
-          ADM_RGBA2BGRA(ptr, tw);
-     }
-#endif
-
-     return 1;
- }
-
- 
- 
-//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
-uint8_t ColYv12Rgb24::reset(uint32_t ww, uint32_t hh)
- {
- int flags=0;
-	CLEANUP();
-    FLAGS();
-    flags|=SWS_BILINEAR;
-   if(!ww || !hh) return 0;
-
-	if (_context)
-		sws_freeContext((SwsContext *)_context);
-
-	 _context=(void *)sws_getContext(
-				    		ww,hh,
-						PIX_FMT_YUV420P ,
-		 				ww,hh,
-	   					PIX_FMT_RGB24,
-	    					flags, NULL, NULL,NULL);
-
-    if(!_context) ADM_assert(0);
-    w=ww;
-    h=hh;
-    return 1;
-}
-  uint8_t ColYv12Rgb24::scale(uint8_t *src, uint8_t *target)
- {
-    uint8_t *srd[3];
-	uint8_t *dst[3];
-	int ssrc[3];
-	int ddst[3];
-
-	ADM_assert(_context);
-	
-			uint32_t page;
-
-			page=w*h;
-			srd[0]=src;
-			srd[1]=src+page;
-			srd[2]=src+((page*5)&gt;&gt;2);
-
-			ssrc[0]=w;
-			ssrc[1]=ssrc[2]=w&gt;&gt;1;
-
-			
-			dst[0]=target;
-			dst[1]=NULL;
-			dst[2]=NULL;
-			ddst[0]=w*3;
-			ddst[1]=ddst[2]=0;
-			
-			sws_scale((SwsContext *)_context,srd,ssrc,0,h,dst,ddst);
-     
-        return 1;
- }
-//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
-//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
-//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
- uint8_t ColRgbToYV12::reset(uint32_t ww, uint32_t hh)
- {
- int flags=0;
- int c;	
-    clean();
-    FLAGS();
-    flags|=SWS_BILINEAR;
-    switch(_colorspace)
-    {
-                case ADM_COLOR_RGB24:c=PIX_FMT_RGB24;break;
-                case ADM_COLOR_RGB32A:c=TARGET_COLORSPACE;break;
-                case ADM_COLOR_RGB16:c=PIX_FMT_RGB565;break;
-                default: ADM_assert(0);
-    }
-
-	if (_context)
-		sws_freeContext((SwsContext *)_context);
-
-         _context=(void *)sws_getContext(
-				    		ww,hh,
-						(PixelFormat)c ,
-		 				ww,hh,
-	   					PIX_FMT_YUV420P,
-	    					flags, NULL, NULL,NULL);
-
-    if(!_context) ADM_assert(0);
-    w=ww;
-    h=hh;
-    return 1;
-}
-uint8_t ColRgbToYV12::setBmpMode(void)
-{
-        _bmpMode=1;
-        return 1;
-}
-
-//***********************************************
- uint8_t ColRgbToYV12::scale(uint8_t *src, uint8_t *target)
- {
-    uint8_t *srd[3];
-        uint8_t *dst[3];
-        int ssrc[3];
-        int ddst[3];
-        int mul=0;
-
-        ADM_assert(_context);
-
-        uint32_t page;
-
-        page=w*h;
-        srd[0]=src;
-        srd[1]=0;
-        srd[2]=0;
-
-        switch(_colorspace)
-        {
-                case ADM_COLOR_RGB16:  mul=2;
-                        break;
-                case ADM_COLOR_RGB24:  mul=3;
-                        break;
-                case ADM_COLOR_RGB32A:  mul=4;
-                        break;
-        }
-        ssrc[0]=mul*w;
-        ssrc[1]=0;
-        ssrc[2]=0;
-
-        dst[0]=target;
-        dst[1]=target+page;
-        dst[2]=target+((page*5)&gt;&gt;2);
-        ddst[0]=w;
-        ddst[1]=ddst[2]=w&gt;&gt;1;
-        if(_bmpMode)
-        {
-                ssrc[0]=-mul*w;
-                srd[0]=src+mul*w*(h-1);
-                dst[2]=target+page;
-                dst[1]=target+((page*5)&gt;&gt;2);
-        }
-
-
-        sws_scale((SwsContext *)_context,srd,ssrc,0,h,dst,ddst);
-     
-        return 1;
- }
- uint8_t ColRgbToYV12::changeColorSpace(ADM_colorspace col)
- {
-int z;
-    
-    z=(int)col;
-    _backward=!!(z &amp; ADM_COLOR_BACKWARD);
-    z&amp;=~ADM_COLOR_BACKWARD;
-    _colorspace= (ADM_colorspace) z;
-       
- }
- //*************************
-static inline void SwapMe(uint8_t *tgt,uint8_t *src,int nb);
-void SwapMe(uint8_t *tgt,uint8_t *src,int nb)
-{
-    uint8_t r,g,b;
-   nb=nb;
-   while(nb--)
-   {
-       r=*src++;
-       g=*src++;
-       b=*src++;
-       *tgt++=r;
-       *tgt++=g;
-       *tgt++=b;
-       
-   }
-   return;
-    
-}
-//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
- uint8_t  COL_yv12rgbBMP(uint32_t ww, uint32_t hh, uint8_t* in, uint8_t *out)
-{
-     ColYv12Rgb24 rgb(ww,hh);
-     
-        rgb.reset(ww,hh);
-        rgb.scale(in,out);
-        // Now time to swap it
-        uint8_t swap[ww*3];
-        
-        uint8_t *up=out;
-        uint8_t *down=out+(hh-1)*ww*3;
-        
-        for(int y=0;y&lt;hh&gt;&gt;1;y++)
-        {
-            SwapMe(swap,up,ww); 
-            SwapMe(up,down,ww);
-            memcpy( down,swap,ww*3);
-            down-=3*ww;
-            up+=3*ww;
-        }
-        
-        return 1;
-     
-}
-//***************************************************
-//***************************************************
-//***************************************************
-//***************************************************
-//***************************************************
-//***************************************************
-
-COL_Generic2YV12::COL_Generic2YV12(uint32_t ww, uint32_t hh,ADM_colorspace col)
-{
-int flags=0;
-int c=0; 
-
-        FLAGS();
-        flags|=SWS_BILINEAR;
-        _context=NULL;
-        w=ww;
-        h=hh;
-        _colorspace=(ADM_colorspace)(col &amp; ADM_COLOR_MASK);
-        _backward= !!(col &amp; ADM_COLOR_BACKWARD);
-      
- 
-    switch(_colorspace)
-    {
-     
-                case ADM_COLOR_BGR24:c=PIX_FMT_BGR24;break;
-                case ADM_COLOR_RGB24:c=PIX_FMT_RGB24;break;
-                case ADM_COLOR_RGB555:c=PIX_FMT_RGB555;break;
-                case ADM_COLOR_BGR555:c=PIX_FMT_BGR555;break;
-                case ADM_COLOR_BGR32A:c=PIX_FMT_BGR32;break;
-                case ADM_COLOR_RGB32A:c=TARGET_COLORSPACE;break;
-                case ADM_COLOR_RGB16:c=PIX_FMT_RGB565;break;
-                case ADM_COLOR_YUV411:c=PIX_FMT_YUV411P;break;
-				case ADM_COLOR_YUV422:c=PIX_FMT_YUV422P;break;
-				case ADM_COLOR_YUV444:c=PIX_FMT_YUV444P;break;
-                default: ADM_assert(0);
-    }
-         _context=(void *)sws_getContext(
-                                                ww,hh,
-                                                (PixelFormat)c ,
-                                                ww,hh,
-                                                PIX_FMT_YUV420P,
-                                                flags, NULL, NULL,NULL);
-
-    if(!_context) ADM_assert(0);
-}
-
-uint8_t COL_Generic2YV12::clean(void)
-{
-        if(_context)
-                {
-                        sws_freeContext((SwsContext *)_context);
-                }
-                _context=NULL; 
-                return 1;  
-}
-
-uint8_t COL_Generic2YV12::transform(uint8_t **planes, uint32_t *strides,uint8_t *target)
-{
-	uint8_t *srd[3];
-	uint8_t *dst[3];
-	int ssrc[3];
-	int ddst[3];
-	int mul = 0;
-	uint32_t page = w * h;
-
-	ADM_assert(_context);
-
-	if(_colorspace &amp; ADM_COLOR_IS_YUV)
-	{
-		srd[0] = planes[0];
-		srd[1] = planes[2];
-		srd[2] = planes[1];
-		ssrc[0] = strides[0];
-		ssrc[1] = strides[2];
-		ssrc[2] = strides[1];
-
-		dst[0] = target;
-		dst[2] = target + page;
-		dst[1] = target + ((page * 5) &gt;&gt; 2);
-		ddst[0] = w;
-		ddst[1] = ddst[2] = w &gt;&gt; 1;
-
-		sws_scale((SwsContext *)_context, srd, ssrc, 0, h, dst, ddst);
-
-		return 1;
-	}
-
-	// Else RGB colorspace
-	switch (_colorspace &amp; 0x7FFF)
-	{
-		case ADM_COLOR_RGB16:
-		case ADM_COLOR_RGB555:
-		case ADM_COLOR_BGR555:
-			mul = 2;
-			break;
-		case ADM_COLOR_BGR24:
-		case ADM_COLOR_RGB24:
-			mul = 3;
-			break;
-		case ADM_COLOR_BGR32A:
-		case ADM_COLOR_RGB32A:
-			mul = 4;
-			break;
-		default:
-			ADM_assert(0);
-	}
-
-	srd[0] = planes[0];
-	srd[1] = srd[2] = 0;
-	ssrc[0] = mul * w;
-	ssrc[1] = ssrc[2] = 0;
-
-	if(strides &amp;&amp; strides[0] &gt; ssrc[0])
-		ssrc[0] = strides[0];
-
-	dst[0] = target;
-	dst[2] = target + page;
-	dst[1] = target + ((page * 5) &gt;&gt; 2);
-	ddst[0] = w;
-	ddst[1] = ddst[2] = w &gt;&gt; 1;
-
-	if(_backward)
-	{
-		ssrc[0] = -mul * w;
-		srd[0] = planes[0] + mul * w * (h - 1);
-	}
-
-	sws_scale((SwsContext *)_context, srd, ssrc, 0, h, dst, ddst);
-
-	return 1;
-}
-//EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/CMakeLists.txt	2010-04-05 18:05:44 UTC (rev 6053)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/CMakeLists.txt	2010-04-05 18:05:50 UTC (rev 6054)
@@ -3,10 +3,10 @@
         ADM_image.cpp  
         ADM_imageUtils.cpp
         ADM_imageResizer.cpp
-        yuv.cpp
-        rgb2yuv.cpp
+#        yuv.cpp
+#        rgb2yuv.cpp
         ADM_colorspace.cpp
-        ADM_rgb.cpp
+#        ADM_rgb.cpp
         ADM_pp.cpp
         ADM_print.cpp
         #ADM_vidFieldUtil.cpp

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/rgb2yuv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/rgb2yuv.cpp	2010-04-05 18:05:44 UTC (rev 6053)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/rgb2yuv.cpp	2010-04-05 18:05:50 UTC (rev 6054)
@@ -1,278 +0,0 @@
-
-/***************************************************************************
-                          yv.cpp  -  description
-                             -------------------
-
-	Convert a RGB triplet to its YUV conterpart
-
-    begin                : Wed Aug 12 2003
-    copyright            : (C) 2003 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include &lt;math.h&gt;
-
-
-#include &quot;ADM_default.h&quot;
-
-
-extern &quot;C&quot; {
-#include &quot;ADM_ffmpeg/libavcodec/avcodec.h&quot;
-#include &quot;ADM_ffmpeg/libswscale/swscale.h&quot;
-}
-
-#include &quot;ADM_colorspace.h&quot;
-
-/**
-	This is unoptimized because seldom called
-*/
-uint8_t COL_RgbToYuv(uint8_t R,uint8_t G,uint8_t B, uint8_t *y,int8_t *u,int8_t *v)
-{
-
-	float rr=R,bb=B,gg=G;
-	float yy,uu,vv;
-
-	yy=0.299*rr+ 		0.587*gg+ 	0.114*bb;
-	uu=-0.169*rr+ 	-0.331*gg+  	0.5*bb;
-	vv=0.5*rr+ 		-0.419*gg+ 	-0.081*bb;
-
-
-	if(uu&gt;127) uu=127;
-	if(uu&lt;-127) uu=-127;
-	*u=(int8_t)floor(uu);
-
-	if(vv&gt;127) vv=127;
-	if(vv&lt;-127) vv=-127;
-	*v=(int8_t)floor(vv);
-
-	if(yy&gt;255) yy=255;
-	if(yy&lt;0) yy=0;
-	*y=(uint8_t)floor(yy);
-
-	return 1;
-
-}
-static inline uint8_t PixelClip(int16_t in)
-{
-    if (in &gt; 255)
-	in = 255;
-   if(in&lt;0)
-   	in=0;
-    return (uint8_t) in;
-};
-
-			   	   
-static inline unsigned char ScaledPixelClip(long  i)
-{
-    return PixelClip(((i +32768) &gt;&gt; 16)); //  + 32768
-};
-
-//0.299	0.587	0.114
-const long int cyb = 6416; //int(0.114*219*65536/255+0.5);
-const long int cyg = 33038; //int(0.587*219*65536/255+0.5);
-const long int cyr = 16828; //int(0.299*219*65536/255+0.5);
-
-uint8_t COL_RawRGB32toYV12(uint8_t *data1,uint8_t *data2, uint8_t *oy,uint8_t *oy2, 
-				uint8_t *u, uint8_t *v,uint32_t lineSize,uint32_t height,uint32_t stride)
-{
-
-
-long int y1,y2;
-long int y3,y4;
-long int scaled_y,b_y;
-long int scaled_y2,b_y2;
-long int r_y,r_y2;  
-
-uint8_t *org1,*org2;
-/*
-0 2 1
-2 6 0
-1 5 3
-3 7 1
-*/
-#define B0 2
-#define R0 0
-#define M0 1
-
-#define M1 (M0+4)
-#define B1 (B0+4)
-#define R1 (R0+4)
-#define LEFT 0x108000
-
-//	printf(&quot;w %d h %d stride %d\n&quot;,lineSize,height,stride);
-	org1=data1;
-	org2=data2;
-	
-	long int alpha,beta,gamma;
-	
-    for(uint32_t yy=0;yy&lt;(height&gt;&gt;1);yy++)
-    {
-    	data1=org1;
-	data2=org2;
-      for (uint32_t x=0;x&lt;(lineSize&gt;&gt;1);x++)
-      {
-      
-#define MK1(source,out,row ) \
-       alpha=source[B##row]; \
-       alpha*=cyb; \
-       beta=source[M##row]; \
-       beta*=cyg; \
-       gamma=source[R##row]; \
-       gamma*=cyr;        \
-       out=(gamma+alpha+beta+LEFT)&gt;&gt;16; 
-      
-        
-       //y1 = (cyb*(long int)data1[B0] + cyg*(long int)data1[M0] + cyr*(long int)data1[R0] +LEFT) &gt;&gt; 16;
-        MK1(data1,y1,0);
-        oy[0] = y1;
-        //y2 = (cyb*(long int)data1[B1] + cyg*(long int)data1[M1] + cyr*(long int)data1[R1] +LEFT) &gt;&gt; 16;
-	MK1(data1,y2,1);
-        oy[1] = y2;
-	
-	//y3 = (cyb*(long int)data2[B0] + cyg*(long int)data2[M0] + cyr*(long int)data2[R0] +LEFT) &gt;&gt; 16;
-	MK1(data2,y3,0);
-        oy2[0] = y3;
-	
-        //y4 = (cyb*(long int)data2[B1] + cyg*(long int)data2[M1] + cyr*(long int)data2[R1] +LEFT) &gt;&gt; 16;
-	MK1(data2,y4,1);
-        oy2[1] = y4;
-
-
-        scaled_y = (y1+y2 - 32) * 38155;
-	scaled_y2 = (y3+y4 - 32) * 38155;
-	
-        b_y = ((data1[B0]+data1[B1]) &lt;&lt; 15) - scaled_y;
-	b_y2 = ((data2[B0]+data2[B1]) &lt;&lt; 15) - scaled_y2;
-	
-	b_y=(b_y+b_y2)/2;
-	
-        u[0] = ScaledPixelClip((b_y &gt;&gt; 10)*int(1/2.018*1024+0.5) + 0x800000);  // u * int(1/2.018*1024+0.5)
-        
-	r_y = ((data1[R0]+data1[R1]) &lt;&lt; 15) - scaled_y;
-	r_y2 = ((data2[R0]+data2[R1]) &lt;&lt; 15) - scaled_y2;
-	r_y=(r_y+r_y2)/2;
-	
-        v[0] = ScaledPixelClip((r_y &gt;&gt; 10)* int(1/1.596*1024+0.5) + 0x800000);  // v* int(1/1.596*1024+0.5)
-	
-	//u[0]=128;
-	//v[0]=128;
-        
-	oy+=2;
-	oy2+=2;
-	u++;
-	v++;
-	data1+=8;
-	data2+=8;
-      }
-     	org2+=2*stride;
-      	org1+=2*stride;
-	oy+=lineSize;
-	oy2+=lineSize;	
-     }
-      
-  return 1;
-}
-uint8_t COL_YuvToRgb( uint8_t y,int8_t u,int8_t v,uint8_t *r,uint8_t *g,uint8_t *b)
-{
-
-	float rr,bb,gg;
-	float yy=y,uu=u,vv=v;
-
-	rr=	yy+			 	1.402*vv;
-	gg= yy+ 	-0.344*uu+  	-0.714*vv;
-	bb=	yy+ 	1.772*uu 	 		;
-
-	#define CLIP(x) if(x&gt;255) x=255; else if (x&lt;0) x=0;x=x+0.49;
-	#define CVT(x,y) CLIP(x);*y=(uint8_t)floor(x);
-
-	CVT(rr,r);
-	CVT(gg,g);
-	CVT(bb,b);
-
-	return 1;
-
-}
-/**
- * 		\fn COL_RGB24_to_YV12
- *		\brief Convert RGB to YV12 using swscale
- */
-uint8_t COL_RGB24_to_YV12_revert(uint32_t w,uint32_t h,uint8_t *rgb, uint8_t *yuv)
-{
-	int flags = SWS_SPLINE;
-	struct SwsContext *context=NULL;
-	
-	#ifdef ADM_CPU_X86
-		#define ADD(x, y) if (CpuCaps::has##x()) flags |= SWS_CPU_CAPS_##y;
-
-		ADD(MMX,MMX);
-		ADD(3DNOW,3DNOW);
-		ADD(MMXEXT,MMX2);
-	#endif
-
-	#ifdef ADM_CPU_ALTIVEC
-	    flags |= SWS_CPU_CAPS_ALTIVEC;
-	#endif
-	    context = sws_getContext(w, h,
-	    									  PIX_FMT_RGB24,
-	    									  w, h,
-	    									  PIX_FMT_YUV420P,
-	    									  flags, NULL, NULL,NULL);
-	    ADM_assert(context);
-	
-	    uint8_t *src[3]={rgb+w*h*3-w*3,NULL,NULL};
-	    int srcStride[3]={-w*3,0,0};
-	    int dstStride[3]={w,w&gt;&gt;1,w&gt;&gt;1};
-	    uint8_t *dst[3]={yuv,yuv+w*h,yuv+((w*h*5)&gt;&gt;2)};
-//	    int sws_scale(struct SwsContext *context, uint8_t* src[], int srcStride[], int srcSliceY,
-//	                  int srcSliceH, uint8_t* dst[], int dstStride[]);	    
-	    sws_scale(context, src, srcStride, 0, h, dst, dstStride);
-	    
-		sws_freeContext(context);
-}
-/**
- * 		\fn COL_RGB24_to_YV12
- *		\brief Convert RGB to YV12 using swscale
- */
-uint8_t COL_RGB24_to_YV12(uint32_t w,uint32_t h,uint8_t *rgb, uint8_t *yuv)
-{
-	int flags = SWS_SPLINE;
-	struct SwsContext *context=NULL;
-	
-	#ifdef ADM_CPU_X86
-		#define ADD(x, y) if (CpuCaps::has##x()) flags |= SWS_CPU_CAPS_##y;
-
-		ADD(MMX,MMX);
-		ADD(3DNOW,3DNOW);
-		ADD(MMXEXT,MMX2);
-	#endif
-
-	#ifdef ADM_CPU_ALTIVEC
-	    flags |= SWS_CPU_CAPS_ALTIVEC;
-	#endif
-	    context = sws_getContext(w, h,
-	    									  PIX_FMT_RGB24,
-	    									  w, h,
-	    									  PIX_FMT_YUV420P,
-	    									  flags, NULL, NULL,NULL);
-	    ADM_assert(context);
-	
-	    uint8_t *src[3]={rgb,NULL,NULL};
-	    int srcStride[3]={w*3,0,0};
-	    int dstStride[3]={w,w&gt;&gt;1,w&gt;&gt;1};
-	    uint8_t *dst[3]={yuv,yuv+((w*h*5)&gt;&gt;2),yuv+w*h};
-//	    int sws_scale(struct SwsContext *context, uint8_t* src[], int srcStride[], int srcSliceY,
-//	                  int srcSliceH, uint8_t* dst[], int dstStride[]);	    
-	    sws_scale(context, src, srcStride, 0, h, dst, dstStride);
-	    
-		sws_freeContext(context);
-}
-//EOF

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/yuv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/yuv.cpp	2010-04-05 18:05:44 UTC (rev 6053)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/yuv.cpp	2010-04-05 18:05:50 UTC (rev 6054)
@@ -1,113 +0,0 @@
-
-/***************************************************************************
-                          yv.cpp  -  description
-                             -------------------
-
-Convert yv422/yuv411 to YV12
-
-Not optimised for speed at all, should take the one from ffmpeg
-
-    begin                : Wed Apr 19 2003
-    copyright            : (C) 2003 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-
-#include &quot;ADM_default.h&quot;
-#include &quot;ADM_ffmpeg/libavcodec/colorspace.h&quot;
-
-uint8_t COL_422_YV12( uint8_t *in[3], uint32_t stride[3],  uint8_t *out,uint32_t w, uint32_t h)
-{
-
-
-			uint8_t *xsrc;
-			uint8_t *dst_y,*dst_u,*dst_v;
-
-
-			xsrc= in[0];
-			dst_y=out;
-			// copy y as is
-            		for(uint32_t y=h;y&gt;0;y--)
-			{
-				memcpy(dst_y,xsrc,w);
-				dst_y+=w;
-				xsrc+=stride[0];
-			}
-			// u
-			xsrc= in[1];
-			dst_u=out+(w*h);
-			for(uint32_t y=h&gt;&gt;1;y&gt;0;y--)
-			{
-				memcpy(dst_u,xsrc,w&gt;&gt;1);
-				dst_u+=w&gt;&gt;1;
-				xsrc+=stride[1]*2;
-			}
-			// v
-			xsrc= in[2];
-			dst_v=out+(w*h)+((w*h)&gt;&gt;2);;
-			for(uint32_t y=h&gt;&gt;1;y&gt;0;y--)
-			{
-				memcpy(dst_v,xsrc,w&gt;&gt;1);
-				dst_v+=w&gt;&gt;1;
-				xsrc+=stride[2]*2;
-			}
-			return 1;
-}
-uint8_t COL_411_YV12( uint8_t *in[3], uint32_t stride[3],  uint8_t *out,uint32_t w, uint32_t h)
-{
-
-
-			uint8_t *xsrc;
-			uint8_t *dst_y,*dst_u,*dst_v;
-
-
-			xsrc= in[0];
-			dst_y=out;
-			// copy y as is
-            		for(uint32_t y=h;y&gt;0;y--)
-			{
-				memcpy(dst_y,xsrc,w);
-				dst_y+=w;
-				xsrc+=stride[0];
-			}
-			// u
-			xsrc= in[1];
-			dst_u=out+(w*h);
-			for(uint32_t y=h&gt;&gt;1;y&gt;0;y--)
-			{
-				//memcpy(dst_u,xsrc,w&gt;&gt;1);
-				for(uint32_t x=0;x&lt;w&gt;&gt;2;x++)
-					{
-						*(dst_u+x+x+1)=*(dst_u+x+x)=*(xsrc+x);
-					}
-				dst_u+=w&gt;&gt;1;
-				xsrc+=stride[1]*2;
-			}
-			// v
-			xsrc= in[2];
-			dst_v=out+(w*h)+((w*h)&gt;&gt;2);;
-			for(uint32_t y=h&gt;&gt;1;y&gt;0;y--)
-			{
-				for(uint32_t x=0;x&lt;w&gt;&gt;2;x++)
-					{
-						*(dst_v+x+x+1)=*(dst_v+x+x)=*(xsrc+x);
-					}
-				dst_v+=w&gt;&gt;1;
-				xsrc+=stride[2]*2;
-			}
-			return 1;
-}
-
-

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/DIA_flyDialog.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/DIA_flyDialog.h	2010-04-05 18:05:44 UTC (rev 6053)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/DIA_flyDialog.h	2010-04-05 18:05:50 UTC (rev 6054)
@@ -95,7 +95,7 @@
           void    *_cookie; // whatever
           void    *_slider; // widget
           void    *_canvas; // Drawing zone
-          ColYuvRgb *_rgb;
+          ADMColorSpaceSimple *_rgb;
 
           /* Filter dependant */
   virtual uint8_t    process(void)=0;

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp	2010-04-05 18:05:44 UTC (rev 6053)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp	2010-04-05 18:05:50 UTC (rev 6054)
@@ -73,12 +73,10 @@
  */
 void ADM_flyDialog::EndConstructor(void)
   {
-    if (isRgbInverted())
-                _rgb=new ColYuvRgb(_w,_h,1);
-        else
-                _rgb=new ColYuvRgb(_w,_h);
+#warning FIXME
 
-        _rgb-&gt;reset(_w,_h);
+//    if (isRgbInverted())
+            _rgb =new ADMColorSpaceSimple(_w,_h,ADM_COLOR_YV12,ADM_COLOR_YV12);
         if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
                 {
                         _zoom = calcZoomFactor();
@@ -274,7 +272,7 @@
 	if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
 		_resizer-&gt;resize(_yuvBufferOut-&gt;data, _rgbBufferOut);
 	else
-		_rgb-&gt;scale(_yuvBufferOut-&gt;data, _rgbBufferOut);
+		_rgb-&gt;convert(_yuvBufferOut-&gt;data, _rgbBufferOut);
 }
 /**
     \fn    copyYuvScratchToRgb
@@ -286,7 +284,7 @@
 	if (_resizeMethod == RESIZE_AUTO)
 		_resizer-&gt;resize(_yuvBuffer-&gt;data,_rgbBuffer);
 	else
-		_rgb-&gt;scale(_yuvBuffer-&gt;data,_rgbBuffer);
+		_rgb-&gt;convert(_yuvBuffer-&gt;data,_rgbBuffer);
 }
 /**
     \fn    copyRgbFinalToDisplay


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003257.html">[Avidemux-svn-commit] r6053 -	branches/avidemux_2.6_branch_mean/avidemux/qt4
</A></li>
	<LI>Next message: <A HREF="003259.html">[Avidemux-svn-commit] r6055 - in	branches/avidemux_2.6_branch_mean/avidemux_core:	ADM_coreDemuxer/include ADM_coreImageLoader/src	ADM_coreVideoCodec/include ADM_coreVideoEncoder/include	ADM_coreVideoEncoder/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3258">[ date ]</a>
              <a href="thread.html#3258">[ thread ]</a>
              <a href="subject.html#3258">[ subject ]</a>
              <a href="author.html#3258">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
