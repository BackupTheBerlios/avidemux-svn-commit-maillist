<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r6085 - in	branches/avidemux_2.6_branch_mean/avidemux: . common	common/ADM_render qt4/ADM_userInterfaces/ADM_gui
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2010-April/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6085%20-%20in%0A%09branches/avidemux_2.6_branch_mean/avidemux%3A%20.%20common%0A%09common/ADM_render%20qt4/ADM_userInterfaces/ADM_gui&In-Reply-To=%3C201004071534.o37FYdqC029967%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003288.html">
   <LINK REL="Next"  HREF="003290.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r6085 - in	branches/avidemux_2.6_branch_mean/avidemux: . common	common/ADM_render qt4/ADM_userInterfaces/ADM_gui</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6085%20-%20in%0A%09branches/avidemux_2.6_branch_mean/avidemux%3A%20.%20common%0A%09common/ADM_render%20qt4/ADM_userInterfaces/ADM_gui&In-Reply-To=%3C201004071534.o37FYdqC029967%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r6085 - in	branches/avidemux_2.6_branch_mean/avidemux: . common	common/ADM_render qt4/ADM_userInterfaces/ADM_gui">mean at mail.berlios.de
       </A><BR>
    <I>Wed Apr  7 17:34:39 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="003288.html">[Avidemux-svn-commit] r6084 - in	branches/avidemux_2.6_branch_mean/avidemux_core: ADM_core/src	ADM_ffmpeg/ffmpeg_config ADM_ffmpeg/libavutil
</A></li>
        <LI>Next message: <A HREF="003290.html">[Avidemux-svn-commit] r6086 - in	branches/avidemux_2.6_branch_mean/avidemux/common: . ADM_render
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3289">[ date ]</a>
              <a href="thread.html#3289">[ thread ]</a>
              <a href="subject.html#3289">[ subject ]</a>
              <a href="author.html#3289">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2010-04-07 17:34:38 +0200 (Wed, 07 Apr 2010)
New Revision: 6085

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_previewNavigate.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_simpleRender.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_simpleRender.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_accelRender.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_sdlRender.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_xvRender.h
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
   branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_preview.cpp
Log:
[Render] Simplification + merge colorconvert and scale in one operation

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.cpp	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.cpp	2010-04-07 15:34:38 UTC (rev 6085)
@@ -34,51 +34,35 @@
 #include &quot;config.h&quot;
 
 #include &quot;ADM_default.h&quot;
-
-
 #include &quot;ADM_editor/ADM_edit.hxx&quot;
-//#include &quot;ADM_videoFilter.h&quot;
-//#include &quot;ADM_videoFilter_internal.h&quot;
 #include &quot;ADM_render/GUI_render.h&quot;
-
-#include &quot;ADM_debugID.h&quot;
-#define MODULE_NAME MODULE_PREVIEW
-#include &quot;ADM_debug.h&quot;
-#include &quot;ADM_ffmpeg/libswscale/ADM_mp.h&quot;
 #include &quot;ADM_commonUI/GUI_ui.h&quot;
 #include &quot;ADM_preview.h&quot;
-#define MAX(a,b) ( (a)&gt;(b) ? (a) : (b) )
+
 #include &quot;DIA_coreToolkit.h&quot;
-extern void                 UI_setCurrentTime(uint64_t curTime);
 
+
 static void                 previewBlit(ADMImage *from,ADMImage *to,uint32_t startx,uint32_t starty);
 static ADM_PREVIEW_MODE     previewMode=ADM_PREVIEW_NONE;
 
-static uint32_t             defered_display=0;  /* When 1, it means we are in playback mode */
-static uint32_t             playbackOffset=0;   /* in playback mode, frame 0 = playbackOffset compared to real beginning of the file */
+static bool                 defered_display=false;  /* When 1, it means we are in playback mode */
 static renderZoom           zoom=ZOOM_1_1;
 static ADMImage             *resized=NULL;
 static ADMImageResizer      *resizer=NULL;
-static ADMImage             *original=NULL;
 
+
 /*************************************/
-static ADMImage *rdrImage=NULL; /* Unprocessed image */
-static ADMImage *previewImage;  /* Processed image if any */
+ADMImage *admPreview::rdrImage=NULL; /* Unprocessed image */
 
 static uint32_t  rdrPhysicalW=0;  /* W*H of the INPUT window */
 static uint32_t  rdrPhysicalH=0;
 
-static uint32_t  rdrWindowWUnzoomed=0;  /* W*H of the output window WITHOUT zoom */
-static uint32_t  rdrWindowHUnzoomed=0;
 
-static uint32_t  rdrWindowWZoomed=0;    /* Same but with zoom */
-static uint32_t  rdrWindowHZoomed=0;
 
-
 /*************************************/
 extern ADM_Composer *video_body;
 /**
-
+    \fn getBuffer
 */
 ADMImage *admPreview::getBuffer(void)
 {
@@ -97,12 +81,7 @@
   rdrImage=new ADMImage(w,h);
   rdrPhysicalW=w;
   rdrPhysicalH=h;
-  
-  rdrWindowWZoomed=rdrWindowWUnzoomed=w;
-  rdrWindowHZoomed=rdrWindowHUnzoomed=h;
-  
-  renderResize(w,h,w,h);
-  
+  renderDisplayResize(rdrPhysicalW,rdrPhysicalH,zoom);
 }
 
 
@@ -117,13 +96,16 @@
 {
   return previewMode; 
 }
-
+/**
+    \fn changePreviewZoom
+*/
 void changePreviewZoom(renderZoom nzoom)
 {
     admPreview::stop();
+    ADM_info(&quot;Preview :: Change zoom %d-&gt;%d\n&quot;,zoom,nzoom);
     zoom=nzoom;
+    renderDisplayResize(rdrPhysicalW,rdrPhysicalH,zoom);
     admPreview::start();
-  
 }
 
 /**
@@ -143,22 +125,19 @@
       \brief Enable or disable defered display. Used by playback mode to have smooth output
 
 */
-void admPreview::deferDisplay(uint32_t onoff,uint32_t startat)
+void admPreview::deferDisplay(bool onoff)
 {
       
-      if(onoff)
+      if(true==onoff)
       {
         renderStartPlaying();
         defered_display=1;
-        playbackOffset=startat;
       }
       else
       {
         renderStopPlaying();
         defered_display=0;
-        playbackOffset=0;
       }
-  
 }
 /**
       \fn admPreview::start
@@ -168,71 +147,7 @@
 
 void 	admPreview::start( void )
 {
-            aprintf(&quot;--killing\n&quot;);
-            renderLock();
-            ADM_assert(!original);
-            switch(previewMode)
-            {
-                  /* no break here, not a mistake */
-              case  ADM_PREVIEW_NONE:
-              case  ADM_PREVIEW_OUTPUT:
-              
-                  rdrWindowWUnzoomed=rdrPhysicalW;
-                  rdrWindowHUnzoomed=rdrPhysicalH;
-                  break;
-#if 0
-              case  ADM_PREVIEW_OUTPUT:
-                  rdrWindowWUnzoomed=preview-&gt;getInfo()-&gt;width;
-                  rdrWindowHUnzoomed=preview-&gt;getInfo()-&gt;height;
-                  break;
-
-              case  ADM_PREVIEW_SIDE:
-              {
-                  rdrWindowWUnzoomed=rdrPhysicalW+preview-&gt;getInfo()-&gt;width;
-                  rdrWindowHUnzoomed=MAX(rdrPhysicalH,preview-&gt;getInfo()-&gt;height);
-                  original=new ADMImage(rdrWindowWUnzoomed,rdrWindowHUnzoomed);
-                  break;
-              }
-              case  ADM_PREVIEW_TOP:
-              {
-                  
-                  rdrWindowWUnzoomed=MAX(rdrPhysicalW,preview-&gt;getInfo()-&gt;width);
-                  rdrWindowHUnzoomed=rdrPhysicalH+preview-&gt;getInfo()-&gt;height;
-                  original=new ADMImage(rdrWindowWUnzoomed,rdrWindowHUnzoomed);
-                  break;
-              }
-#endif
-              default: ADM_assert(0);
-            }
-        if(zoom!=ZOOM_1_1)
-        {
-            int mul;
-            switch(zoom)
-            {
-                    case ZOOM_1_4: mul=1;break;
-                    case ZOOM_1_2: mul=2;break;
-                    case ZOOM_1_1: mul=4;break;
-                    case ZOOM_2:   mul=8;break;
-                    case ZOOM_4:   mul=16;break;
-                    default : ADM_assert(0);
-    
-            }
-            rdrWindowWZoomed=(rdrWindowWUnzoomed*mul+3)/4;
-            rdrWindowHZoomed=(rdrWindowHUnzoomed*mul+3)/4;
-            
-    
-            if(rdrWindowWZoomed&amp;1) rdrWindowWZoomed++;
-            if(rdrWindowHZoomed&amp;1) rdrWindowHZoomed++;
-            ADM_assert(!resized);
-            resized=new ADMImage(rdrWindowWZoomed,rdrWindowHZoomed);
-            ADM_assert(!resizer);
-            resizer=new  ADMImageResizer(rdrWindowWUnzoomed,rdrWindowHUnzoomed,rdrWindowWZoomed,rdrWindowHZoomed);
-            renderResize(rdrWindowWZoomed,rdrWindowHZoomed,rdrWindowWUnzoomed,rdrWindowHUnzoomed);
-        }else
-        {
-             renderResize(rdrWindowWUnzoomed,rdrWindowHUnzoomed,rdrWindowWUnzoomed,rdrWindowHUnzoomed);
-        }
-        renderUnlock();
+            ADM_info(&quot;admPreview, killing\n&quot;);
 }
 /**
       \fn admPreview::stop
@@ -241,431 +156,12 @@
 
 void admPreview::stop( void )
 {
-  renderLock();
-#if 0
-      if(previewMode==ADM_PREVIEW_SEPARATE)
-                DIA_previewEnd();
-      if(  previewMode==ADM_PREVIEW_SIDE || previewMode==ADM_PREVIEW_TOP)
-      {
-        ADM_assert(original);
-        delete original;
-        original=NULL; 
-      }
-#endif
-      renderResize(rdrWindowWUnzoomed,rdrWindowHUnzoomed,rdrWindowWUnzoomed,rdrWindowHUnzoomed);
-      if(previewImage)
-      {
-        delete  previewImage; 
-        previewImage=NULL;
-      }
-      if(zoom!=ZOOM_1_1)
-      {
-          
-          
-          if(resized) delete resized;
-          if(resizer) delete resizer;
-          resized=NULL;
-          resizer=NULL;
-      }
+      renderLock();
+     
       renderUnlock();
 }
-/**
-    \fn getCurrentPts
-    \brief returns the PTS in us of the last displayed frame
-*/
-uint64_t admPreview::getCurrentPts(void)
-{
-        if(rdrImage) return rdrImage-&gt;Pts;
 
-}
-
 /**
-      \fn admPreview::update
-      \brief display data associated with framenum image
-      @param image : current main image (input)
-      @param framenum, framenumber
-*/
-#if 0 // OBSOLETE
-uint8_t admPreview::seekToIntra(uint32_t frame)
-{
-    if(!video_body-&gt;GoToIntra(frame)) 
-    {
-        printf(&quot;[PReview::seekToIntra] GoToIntra %u failed\n&quot;,frame);
-        return 0;
-    }
-    return samePicture();
-
-}
-#endif
-
-/**
-      \fn admPreview::seekToTime
-      \brief Seek to any given frame
-      
-      @param timeframe Time of the image 
-*/
-
-bool admPreview::seekToTime(uint64_t timeframe)
-{
-    if(!video_body-&gt;goToTimeVideo(timeframe)) 
-    {
-        ADM_warning(&quot; seeking for frame at %&quot;LLU&quot; ms failed\n&quot;,timeframe/1000LL);
-        return false;
-    }
-    return samePicture();
-}
-/**
-      \fn admPreview::seekToIntraPts
-      \brief Seek to intra at PTS given as arg
-      
-      @param timeframe Time of the image 
-*/
-
-bool admPreview::seekToIntraPts(uint64_t timeframe)
-{
-    if(!video_body-&gt;goToIntraTimeVideo(timeframe)) 
-    {
-        ADM_warning(&quot; seeking for frame at %&quot;LLU&quot; ms failed\n&quot;,timeframe/1000LL);
-        return false;
-    }
-    return samePicture();
-}
-/**
-    \fn samePicture
-*/
-uint8_t admPreview::samePicture(void)
-{
-    if(!video_body-&gt;samePicture(rdrImage)) return false;
-    UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
-    if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
-    {
-       if(!defered_display) 
-       {
-          renderUpdateImage(rdrImage-&gt;data,zoom);
-          
-        }
-    }else
-    {
-        ADM_assert(resizer);
-        ADM_assert(resized);
-        resizer-&gt;resize(rdrImage,resized);
-        if(!defered_display) 
-          renderUpdateImage(resized-&gt;data,ZOOM_1_1);
-    }
-    return true;
-}
-/**
-      \fn admPreview::update
-      \brief display data associated with framenum image
-      @param image : current main image (input)
-      @param framenum, framenumber
-*/
-
-uint8_t admPreview::nextPicture(void)
-{
-    uint32_t fl,len,flags;	
-
-    switch(previewMode)
-    {
-      case ADM_PREVIEW_NONE:
-       {
-#if 0
-        if( !video_body-&gt;getUncompressedFrame(framenum+playbackOffset,rdrImage,&amp;flags))
-        {
-          return 0; 
-        }
-#else
-
-        if(!video_body-&gt;nextPicture(rdrImage)) return 0;
-#endif
-            UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
-
-            if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
-            {
-               if(!defered_display) 
-               {
-                  renderUpdateImage(rdrImage-&gt;data,zoom);
-                  
-                }
-            }else
-            {
-                ADM_assert(resizer);
-                ADM_assert(resized);
-                resizer-&gt;resize(rdrImage,resized);
-                if(!defered_display) 
-                  renderUpdateImage(resized-&gt;data,ZOOM_1_1);
-            }
-           // printf(&quot;[admPreview] PTs: %llu\n&quot;,rdrImage-&gt;Pts);
-        }
-        break;
-#if 0
-      case ADM_PREVIEW_OUTPUT:
-            if(framenum&lt;=preview-&gt;getInfo()-&gt;nb_frames-1)
-                  {
-                          if(!preview-&gt;getFrameNumberNoAlloc(framenum,&amp;len,previewImage,&amp;fl)) return 0;
-                          if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
-                          {
-                            if(!defered_display) renderUpdateImage(previewImage-&gt;data,zoom);
-                          }
-                          else
-                          {
-                             resizer-&gt;resize(previewImage,resized);
-                             if(!defered_display) 
-                                  renderUpdateImage(resized-&gt;data,ZOOM_1_1);
-                          }
-                  }
-            break;
-      case ADM_PREVIEW_SEPARATE:
-            ADM_assert(preview);
-            ADM_assert(previewImage);
-
-              if( !video_body-&gt;getUncompressedFrame(framenum+playbackOffset,rdrImage,&amp;flags))
-              {
-                  return 0; 
-              }
-              UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
-
-            if(zoom==ZOOM_1_1 || renderHasAccelZoom()  )
-            {
-              if(!defered_display) 
-				  renderUpdateImage(rdrImage-&gt;data,zoom);
-            }
-			else
-            {
-                ADM_assert(resizer);
-                ADM_assert(resized);
-                resizer-&gt;resize(rdrImage,resized);
-                if(!defered_display) 
-                  renderUpdateImage(resized-&gt;data,zoom);
-            }
-          if( DIA_previewStillAlive())
-          {
-                  aprintf(&quot;Preview: Ask for frame %lu\n&quot;,framenum);
-                  if(framenum&lt;=preview-&gt;getInfo()-&gt;nb_frames-1)
-                  {
-                          preview-&gt;getFrameNumberNoAlloc(framenum,&amp;len,previewImage,&amp;fl);
-                          if(!defered_display) DIA_previewUpdate(previewImage-&gt;data);
-                  }
-          }
-          break;
-      case ADM_PREVIEW_SIDE:
-              ADM_assert(preview);
-              ADM_assert(previewImage);
-              ADM_assert(original);
-              
-              if( !video_body-&gt;getUncompressedFrame(framenum+playbackOffset,rdrImage,&amp;flags))
-              {
-                  return 0; 
-              }
-              UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
-              previewBlit(rdrImage,original,0,0);
-              
-              if(preview-&gt;getFrameNumberNoAlloc(framenum,&amp;len,previewImage,&amp;fl))
-              {
-                previewBlit(previewImage,original,rdrPhysicalW,0);
-              }
-              else printf(&quot;Cannot get frame %u\n&quot;,framenum);
-              if(zoom==ZOOM_1_1  || renderHasAccelZoom() )
-              {
-                if(!defered_display)
-                  renderUpdateImage(original-&gt;data,zoom);
-              }else
-              {
-                resizer-&gt;resize(original,resized);
-                if(!defered_display) 
-                  renderUpdateImage(resized-&gt;data,ZOOM_1_1);
-              }
-              break;
-        
-      case ADM_PREVIEW_TOP:
-              ADM_assert(preview);
-              ADM_assert(previewImage);
-              ADM_assert(original);
-              
-              if( !video_body-&gt;getUncompressedFrame(framenum+playbackOffset,rdrImage,&amp;flags))
-              {
-                  return 0; 
-              }
-              UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
-              previewBlit(rdrImage,original,0,0);
-              if(preview-&gt;getFrameNumberNoAlloc(framenum,&amp;len,previewImage,&amp;fl))
-              {
-                previewBlit(previewImage,original,0,rdrPhysicalH);
-              }
-              else printf(&quot;Cannot get frame %u\n&quot;,framenum);
-              if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
-              {
-                if(!defered_display)
-                  renderUpdateImage(original-&gt;data,zoom);
-              }else
-              {
-                resizer-&gt;resize(original,resized);
-                if(!defered_display) 
-                  renderUpdateImage(resized-&gt;data,ZOOM_1_1);
-              }
-              break;
-#endif
-      default: ADM_assert(0);
-    }
-    return true;
-}
-
-/**
-      \fn admPreview::update
-      \brief display data associated with framenum image
-      @param image : current main image (input)
-      @param framenum, framenumber
-*/
-
-uint8_t admPreview::previousPicture(void)
-{
-    uint32_t fl,len,flags;	
-
-    switch(previewMode)
-    {
-      case ADM_PREVIEW_NONE:
-       {
-#if 0
-        if( !video_body-&gt;getUncompressedFrame(framenum+playbackOffset,rdrImage,&amp;flags))
-        {
-          return 0; 
-        }
-#else
-
-        if(!video_body-&gt;previousPicture(rdrImage)) return 0;
-#endif
-            UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
-
-            if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
-            {
-               if(!defered_display) 
-               {
-                  renderUpdateImage(rdrImage-&gt;data,zoom);
-                  
-                }
-            }else
-            {
-                ADM_assert(resizer);
-                ADM_assert(resized);
-                resizer-&gt;resize(rdrImage,resized);
-                if(!defered_display) 
-                  renderUpdateImage(resized-&gt;data,ZOOM_1_1);
-            }
-           // printf(&quot;[admPreview] PTs: %llu\n&quot;,rdrImage-&gt;Pts);
-        }
-        break;
-#if 0
-      case ADM_PREVIEW_OUTPUT:
-            if(framenum&lt;=preview-&gt;getInfo()-&gt;nb_frames-1)
-                  {
-                          if(!preview-&gt;getFrameNumberNoAlloc(framenum,&amp;len,previewImage,&amp;fl)) return 0;
-                          if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
-                          {
-                            if(!defered_display) renderUpdateImage(previewImage-&gt;data,zoom);
-                          }
-                          else
-                          {
-                             resizer-&gt;resize(previewImage,resized);
-                             if(!defered_display) 
-                                  renderUpdateImage(resized-&gt;data,ZOOM_1_1);
-                          }
-                  }
-            break;
-      case ADM_PREVIEW_SEPARATE:
-            ADM_assert(preview);
-            ADM_assert(previewImage);
-
-              if( !video_body-&gt;getUncompressedFrame(framenum+playbackOffset,rdrImage,&amp;flags))
-              {
-                  return 0; 
-              }
-              UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
-
-            if(zoom==ZOOM_1_1 || renderHasAccelZoom()  )
-            {
-              if(!defered_display) 
-				  renderUpdateImage(rdrImage-&gt;data,zoom);
-            }
-			else
-            {
-                ADM_assert(resizer);
-                ADM_assert(resized);
-                resizer-&gt;resize(rdrImage,resized);
-                if(!defered_display) 
-                  renderUpdateImage(resized-&gt;data,zoom);
-            }
-          if( DIA_previewStillAlive())
-          {
-                  aprintf(&quot;Preview: Ask for frame %lu\n&quot;,framenum);
-                  if(framenum&lt;=preview-&gt;getInfo()-&gt;nb_frames-1)
-                  {
-                          preview-&gt;getFrameNumberNoAlloc(framenum,&amp;len,previewImage,&amp;fl);
-                          if(!defered_display) DIA_previewUpdate(previewImage-&gt;data);
-                  }
-          }
-          break;
-      case ADM_PREVIEW_SIDE:
-              ADM_assert(preview);
-              ADM_assert(previewImage);
-              ADM_assert(original);
-              
-              if( !video_body-&gt;getUncompressedFrame(framenum+playbackOffset,rdrImage,&amp;flags))
-              {
-                  return 0; 
-              }
-              UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
-              previewBlit(rdrImage,original,0,0);
-              
-              if(preview-&gt;getFrameNumberNoAlloc(framenum,&amp;len,previewImage,&amp;fl))
-              {
-                previewBlit(previewImage,original,rdrPhysicalW,0);
-              }
-              else printf(&quot;Cannot get frame %u\n&quot;,framenum);
-              if(zoom==ZOOM_1_1  || renderHasAccelZoom() )
-              {
-                if(!defered_display)
-                  renderUpdateImage(original-&gt;data,zoom);
-              }else
-              {
-                resizer-&gt;resize(original,resized);
-                if(!defered_display) 
-                  renderUpdateImage(resized-&gt;data,ZOOM_1_1);
-              }
-              break;
-        
-      case ADM_PREVIEW_TOP:
-              ADM_assert(preview);
-              ADM_assert(previewImage);
-              ADM_assert(original);
-              
-              if( !video_body-&gt;getUncompressedFrame(framenum+playbackOffset,rdrImage,&amp;flags))
-              {
-                  return 0; 
-              }
-              UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
-              previewBlit(rdrImage,original,0,0);
-              if(preview-&gt;getFrameNumberNoAlloc(framenum,&amp;len,previewImage,&amp;fl))
-              {
-                previewBlit(previewImage,original,0,rdrPhysicalH);
-              }
-              else printf(&quot;Cannot get frame %u\n&quot;,framenum);
-              if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
-              {
-                if(!defered_display)
-                  renderUpdateImage(original-&gt;data,zoom);
-              }else
-              {
-                resizer-&gt;resize(original,resized);
-                if(!defered_display) 
-                  renderUpdateImage(resized-&gt;data,ZOOM_1_1);
-              }
-              break;
-#endif
-      default: ADM_assert(0);
-    }
-    return true;
-}
-/**
       \fn previewBlit(ADMImage *from,ADMImage *to,uint32_t startx,uint32_t starty)
       \brief Blit &quot;from&quot; to &quot;to&quot; at position startx,starty
 */
@@ -690,52 +186,8 @@
     {
       case ADM_PREVIEW_NONE:
       case ADM_PREVIEW_OUTPUT:     
-           if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
-            {
-                renderUpdateImage(rdrImage-&gt;data,zoom);
-            }else
-            {
-                ADM_assert(resized);
-                renderUpdateImage(resized-&gt;data,zoom);
-            }
+        renderUpdateImage(rdrImage);
         break;
-#if 0
-      case ADM_PREVIEW_OUTPUT:
-            if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
-            {
-                renderUpdateImage(previewImage-&gt;data,zoom);
-            }else
-            {
-                ADM_assert(resized);
-                renderUpdateImage(resized-&gt;data,zoom);
-            }
-            break;
-
-      case ADM_PREVIEW_SEPARATE:
-            if(zoom==ZOOM_1_1 || renderHasAccelZoom()  )
-            {
-                renderUpdateImage(rdrImage-&gt;data,zoom);
-            }else{
-                ADM_assert(resized);
-                renderUpdateImage(resized-&gt;data,zoom);
-            }
-            if( DIA_previewStillAlive())
-            {
-                DIA_previewUpdate(previewImage-&gt;data);
-            }
-          break;
-      case ADM_PREVIEW_SIDE:
-      case ADM_PREVIEW_TOP:
-            if(zoom==ZOOM_1_1|| renderHasAccelZoom() )
-            {
-               renderUpdateImage(original-&gt;data,zoom);
-            }else
-            {
-              ADM_assert(resized);
-              renderUpdateImage(resized-&gt;data,zoom);
-            }
-              break;
-#endif
       default: ADM_assert(0);
     }
 }
@@ -761,66 +213,15 @@
 		delete rdrImage;
 		rdrImage = NULL;
 	}
-
-	if(original)
-    {
-		delete original;
-		original=NULL;
-	}
-
-	if(previewImage)
-	{
-		delete previewImage; 
-		previewImage=NULL;
-	}
 }
 /**
-    \fn nextKeyFrame
-
+    \fn updateImage
 */
-bool admPreview::nextKeyFrame(void)
+bool admPreview::updateImage(void)
 {
-    uint64_t pts=getCurrentPts();
-    ADM_info(&quot;Current PTS :%&quot;LLD&quot; ms\n&quot;,pts/1000LL);
-    if(false==video_body-&gt;getNKFramePTS(&amp;pts))
-    {
-        ADM_warning(&quot;Cannot find next keyframe\n&quot;);
-        return false;
-    }
-    ADM_info(&quot;next kf PTS :%&quot;LLD&quot; ms\n&quot;,pts/1000LL);
-    return seekToIntraPts(pts);
+            UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
+            if(!defered_display) 
+                renderUpdateImage(rdrImage);                  
+            return true;
 }
-/**
-    \fn previousKeyFrame
-
-*/
-bool admPreview::previousKeyFrame(void)
-{
-    uint64_t pts=getCurrentPts();
-    ADM_info(&quot;Current PTS :%&quot;LLD&quot; ms\n&quot;,pts/1000LL);
-    if(false==video_body-&gt;getPKFramePTS(&amp;pts))
-    {
-        ADM_warning(&quot;Cannot find previous keyframe\n&quot;);
-        return false;
-    }
-    ADM_info(&quot;next kf PTS :%&quot;LLD&quot; ms\n&quot;,pts/1000LL);
-    return seekToIntraPts(pts);
-}/**
-    \fn previousFrame
-
-*/
-bool admPreview::previousFrame(void)
-{
-    uint64_t pts=rdrImage-&gt;Pts;
-    ADMImage *tmpImage=NULL;
-    //tmpImage=video_body-&gt;seekAndGetImageBefore(pts);
-    if(!tmpImage)
-    {
-        GUI_Error_HIG(&quot;Seek&quot;,&quot;Cannot find previous frame&quot;);
-        return false;
-    }
-    rdrImage=tmpImage;
-    renderUpdateImage(rdrImage-&gt;data,zoom);
-    return true;
-}
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.h	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_preview.h	2010-04-07 15:34:38 UTC (rev 6085)
@@ -18,9 +18,13 @@
 ADM_PREVIEW_MODE  getPreviewMode(void);
 void             setPreviewMode(ADM_PREVIEW_MODE preview);
 void             changePreviewZoom(renderZoom nzoom);
-
+/**
+    class admPreview
+*/
 class admPreview
 {
+  protected:
+      static ADMImage *rdrImage;
   public:
       static uint8_t nextPicture(void);
       static uint8_t previousPicture(void);
@@ -30,7 +34,7 @@
       static void start(void);
       static void stop(void);
       static void setMainDimension(uint32_t, uint32_t );
-      static void deferDisplay(uint32_t onoff,uint32_t startat);
+      static void deferDisplay(bool onoff);
       static void displayNow(void);
       static void cleanUp(void);  
       static ADMImage *getBuffer(void);
@@ -39,5 +43,6 @@
       static bool previousKeyFrame(void);
       static bool previousFrame(void);
       static void destroy(void);
+      static bool updateImage(void);
 };
 #endif

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_previewNavigate.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_previewNavigate.cpp	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_previewNavigate.cpp	2010-04-07 15:34:38 UTC (rev 6085)
@@ -0,0 +1,157 @@
+/***************************************************************************
+    
+    Handle preview mode
+    
+    It is displayed in 3 layers
+    
+    
+    Engine : Call setPreviewMode and amdPreview depending on the actions
+            previewMode is the **current** preview mode
+    
+    admPreview : 
+          Allocate/desallocate ressources
+          Build preview window
+          Call display properly to display it
+          
+    GUI_PreviewXXXX
+          UI toolkit to actually display the window
+          See GUI_ui.h to see them
+                 
+    
+    
+    copyright            : (C) 2007 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;config.h&quot;
+
+#include &quot;ADM_default.h&quot;
+#include &quot;ADM_editor/ADM_edit.hxx&quot;
+#include &quot;ADM_render/GUI_render.h&quot;
+
+#include &quot;ADM_debugID.h&quot;
+#include &quot;ADM_commonUI/GUI_ui.h&quot;
+#include &quot;ADM_preview.h&quot;
+
+#include &quot;DIA_coreToolkit.h&quot;
+
+#define MAX(a,b) ( (a)&gt;(b) ? (a) : (b) )
+
+/*************************************/
+/*************************************/
+extern ADM_Composer *video_body;
+/**
+    \fn getCurrentPts
+    \brief returns the PTS in us of the last displayed frame
+*/
+uint64_t admPreview::getCurrentPts(void)
+{
+        if(rdrImage) return rdrImage-&gt;Pts;
+}
+/**
+      \fn admPreview::seekToTime
+      \brief Seek to any given frame
+      
+      @param timeframe Time of the image 
+*/
+
+bool admPreview::seekToTime(uint64_t timeframe)
+{
+    if(!video_body-&gt;goToTimeVideo(timeframe)) 
+    {
+        ADM_warning(&quot; seeking for frame at %&quot;LLU&quot; ms failed\n&quot;,timeframe/1000LL);
+        return false;
+    }
+    return samePicture();
+}
+/**
+      \fn admPreview::seekToIntraPts
+      \brief Seek to intra at PTS given as arg
+      
+      @param timeframe Time of the image 
+*/
+
+bool admPreview::seekToIntraPts(uint64_t timeframe)
+{
+    if(!video_body-&gt;goToIntraTimeVideo(timeframe)) 
+    {
+        ADM_warning(&quot; seeking for frame at %&quot;LLU&quot; ms failed\n&quot;,timeframe/1000LL);
+        return false;
+    }
+    return samePicture();
+}
+/**
+    \fn samePicture
+*/
+uint8_t admPreview::samePicture(void)
+{
+    if(!video_body-&gt;samePicture(rdrImage)) return false;
+    return updateImage();
+}
+/**
+      \fn admPreview::update
+      \brief display data associated with framenum image
+      @param image : current main image (input)
+      @param framenum, framenumber
+*/
+
+uint8_t admPreview::nextPicture(void)
+{
+   
+   if(!video_body-&gt;nextPicture(rdrImage)) return 0;
+   return updateImage();
+}
+
+/**
+      \fn admPreview::update
+      \brief display data associated with framenum image
+      @param image : current main image (input)
+      @param framenum, framenumber
+*/
+
+uint8_t admPreview::previousPicture(void)
+{
+    if(!video_body-&gt;previousPicture(rdrImage)) return 0;
+    return updateImage();
+}
+/**
+    \fn nextKeyFrame
+
+*/
+bool admPreview::nextKeyFrame(void)
+{
+    uint64_t pts=getCurrentPts();
+    ADM_info(&quot;Current PTS :%&quot;LLD&quot; ms\n&quot;,pts/1000LL);
+    if(false==video_body-&gt;getNKFramePTS(&amp;pts))
+    {
+        ADM_warning(&quot;Cannot find next keyframe\n&quot;);
+        return false;
+    }
+    ADM_info(&quot;next kf PTS :%&quot;LLD&quot; ms\n&quot;,pts/1000LL);
+    return seekToIntraPts(pts);
+}
+/**
+    \fn previousKeyFrame
+
+*/
+bool admPreview::previousKeyFrame(void)
+{
+    uint64_t pts=getCurrentPts();
+    ADM_info(&quot;Current PTS :%&quot;LLD&quot; ms\n&quot;,pts/1000LL);
+    if(false==video_body-&gt;getPKFramePTS(&amp;pts))
+    {
+        ADM_warning(&quot;Cannot find previous keyframe\n&quot;);
+        return false;
+    }
+    ADM_info(&quot;next kf PTS :%&quot;LLD&quot; ms\n&quot;,pts/1000LL);
+    return seekToIntraPts(pts);
+}
+// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt	2010-04-07 15:34:38 UTC (rev 6085)
@@ -2,8 +2,9 @@
 
 SET(${ADM_LIB}_SRCS
 GUI_render.cpp
-GUI_sdlRender.cpp
-GUI_xvRender.cpp
+GUI_simpleRender.cpp
+#GUI_sdlRender.cpp
+#GUI_xvRender.cpp
 )
 
 IF (APPLE)
@@ -17,8 +18,8 @@
         TARGET_LINK_LIBRARIES(${ADM_LIB}  ${GETTEXT_LIBRARY_DIR})
 ENDIF (GETTEXT_FOUND)
 
-IF (USE_SDL)
-        TARGET_LINK_LIBRARIES(${ADM_LIB}  ${SDL_LIBRARY})
-ENDIF (USE_SDL)
+#IF (USE_SDL)
+       # TARGET_LINK_LIBRARIES(${ADM_LIB}  ${SDL_LIBRARY})
+#ENDIF (USE_SDL)
 
 ADM_INSTALL_LIB(${ADM_LIB})

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_accelRender.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_accelRender.h	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_accelRender.h	2010-04-07 15:34:38 UTC (rev 6085)
@@ -4,21 +4,36 @@
 // Description: 
 //  Class to hold all accelerated display (xv, sdl....)
 //
-// Author: mean &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>&gt;, (C) 2004
+// Author: mean &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>&gt;, (C) 2004/2010
 //
 // Copyright: See COPYING file that comes with this distribution
 //
 //
 #ifndef GUI_ACCELRENDER_H
 #define GUI_ACCELRENDER_H
-class AccelRender
+#include &quot;ADM_colorspace.h&quot;
+/**
+    \class VideoRenderBase
+*/
+class VideoRenderBase
 {
-      public:
-                              AccelRender( void) {};
-              virtual	uint8_t init(GUI_WindowInfo * window, uint32_t w, uint32_t h)=0;
-              virtual	uint8_t end(void)=0;
-              virtual uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h,renderZoom zoom=ZOOM_1_1)=0;
-              virtual uint8_t hasHwZoom(void) {return 0;}
-              
+      protected:
+                        ADMColorScalerFull *scaler;
+                        uint32_t imageWidth;
+                        uint32_t imageHeight;
+                        uint32_t displayWidth;
+                        uint32_t displayHeight;
+                        renderZoom currentZoom;
+
+                        bool calcDisplayFromZoom(renderZoom zoom);
+                        bool baseInit(uint32_t w,uint32_t h,renderZoom zoom);
+       public:
+                                VideoRenderBase( void) {scaler=NULL;};
+                                ~VideoRenderBase() {if(scaler) delete scaler;scaler=NULL;}
+              virtual	bool    init(GUI_WindowInfo * window, uint32_t w, uint32_t h,renderZoom zoom)=0;
+              virtual	bool    stop(void)=0;
+              virtual   bool    displayImage(ADMImage *pic)=0;
+              virtual   bool    refresh(void) {return true;}
+              virtual   bool    changeZoom(renderZoom newzoom)=0;
 };
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.cpp	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.cpp	2010-04-07 15:34:38 UTC (rev 6085)
@@ -24,6 +24,7 @@
 #include &quot;GUI_render.h&quot;
 #include &quot;GUI_renderInternal.h&quot;
 #include &quot;GUI_accelRender.h&quot;
+#include &quot;GUI_simpleRender.h&quot;
 
 #ifdef USE_XV
 #include &quot;GUI_xvRender.h&quot;
@@ -33,39 +34,19 @@
 #include &quot;GUI_sdlRender.h&quot;
 #endif
 
-
 #include &quot;ADM_colorspace.h&quot;
-
 #include &quot;DIA_uiTypes.h&quot;
-#if ADM_UI_TYPE_BUILD == ADM_UI_QT4 
-    #define IVERT ADM_COLOR_BGR32A
-#else
-    #define IVERT ADM_COLOR_RGB32A
-#endif    
-#warning FIXME
-static ADMColorScalerSimple rgbConverter(640,480,ADM_COLOR_YV12,IVERT);
 
-
-static uint8_t	updateWindowSize(void * win, uint32_t w, uint32_t h);
-static uint8_t  GUI_ConvertRGB(uint8_t * in, uint8_t * out, uint32_t w, uint32_t h);
-
-// Used by flyDialog
-void GUI_RGBDisplay(uint8_t * dis, uint32_t w, uint32_t h, void *widg);
-
 //_____________________________________
-
 //_____________________________________
-static AccelRender    *accel_mode=NULL;
-static uint8_t        *accelSurface=NULL;
+static VideoRenderBase *renderer=NULL;
+static uint8_t         *accelSurface=NULL;
 //_______________________________________
 
-static uint8_t 	*screenBuffer=NULL;
-static uint8_t		*lastImage=NULL;
-static void           *draw=NULL;
-static uint32_t 	 renderW=0,renderH=0; /* Zoomed/display size */
-static uint32_t         phyW=0,phyH=0; /* Unzoomed size, only used when accel can do hw resize */
-static renderZoom       lastZoom;
-static uint8_t          _lock=0;
+static void         *draw=NULL;
+static uint32_t     phyW=0,phyH=0; /* physical window size */
+static renderZoom   lastZoom=ZOOM_1_1;
+static uint8_t      _lock=0;
 
 static const UI_FUNCTIONS_T *HookFunc=NULL;
 //_______________________________________
@@ -94,13 +75,13 @@
    RENDER_CHECK(UI_updateDrawWindowSize);
    HookFunc-&gt;UI_updateDrawWindowSize(win,w,h);
 }
-static  void MUI_rgbDraw(void *widg,uint32_t w, uint32_t h,uint8_t *ptr)
+void MUI_rgbDraw(void *widg,uint32_t w, uint32_t h,uint8_t *ptr)
 {
     RENDER_CHECK(UI_rgbDraw);
     HookFunc-&gt;UI_rgbDraw(widg, w,  h,ptr);
   
 }
-static  void *MUI_getDrawWidget(void)
+void *MUI_getDrawWidget(void)
 {
   RENDER_CHECK(UI_getDrawWidget);
   return HookFunc-&gt;UI_getDrawWidget();
@@ -127,11 +108,6 @@
 void renderDestroy(void)
 {
     ADM_info(&quot;Cleaning up Render\n&quot;);
-	if(screenBuffer) 
-	{
-		delete[] screenBuffer;
-		screenBuffer = NULL;
-	}
 }
 
 /**
@@ -154,18 +130,43 @@
 
 */
 //----------------------------------------
-uint8_t renderResize(uint32_t w, uint32_t h,uint32_t pw, uint32_t ph)
+uint8_t renderDisplayResize(uint32_t w, uint32_t h,renderZoom zoom)
 {
-	if(screenBuffer) 
+        bool create=false;
+        ADM_info(&quot;Render to %&quot;LU&quot;x%&quot;LU&quot; zoom=%d\n&quot;,w,h,zoom);
+        if(!renderer) create=true;
+        else
         {
-                delete  [] screenBuffer;
-                screenBuffer=NULL;
+            if(w!=phyW || h!=phyH) create=true;
         }
-        screenBuffer=new uint8_t[w*h*4];
-        phyW=pw;
-        phyH=ph;
-  
-        updateWindowSize( draw,w,h);
+        if(create)
+        {
+            if(renderer) delete renderer;
+            renderer=new simpleRender();
+            GUI_WindowInfo xinfo;
+            MUI_getWindowInfo(draw, &amp;xinfo);
+
+            renderer-&gt;init(&amp;xinfo,w,h,zoom);
+            lastZoom=zoom;
+            phyW=w;
+            phyH=h;
+        }else
+        {
+            if(lastZoom!=zoom) renderer-&gt;changeZoom(zoom);
+        }
+        lastZoom=zoom;
+         int mul;
+         switch(zoom)
+            {
+                    case ZOOM_1_4: mul=1;break;
+                    case ZOOM_1_2: mul=2;break;
+                    case ZOOM_1_1: mul=4;break;
+                    case ZOOM_2:   mul=8;break;
+                    case ZOOM_4:   mul=16;break;
+                    default : ADM_assert(0);
+    
+            }
+        MUI_updateDrawWindowSize(draw,(w*mul)/4,(h*mul)/4);
         UI_purge();
         return 1;
 }
@@ -175,30 +176,11 @@
 
 */
 //----------------------------------------
-uint8_t renderUpdateImage(uint8_t *ptr,renderZoom zoom)
+uint8_t renderUpdateImage(ADMImage *image)
 {
-
-    ADM_assert(screenBuffer);
-    lastImage=ptr;
     ADM_assert(!_lock);
-    if(accel_mode)
-    {
-        lastZoom=zoom;
-        if(accel_mode -&gt;hasHwZoom())
-        {
-           accel_mode-&gt;display(lastImage, phyW, phyH,zoom);
-        }else
-        {
-          accel_mode-&gt;display(lastImage, renderW, renderH,zoom);
-        }
-      
-    }else
-    {
-      GUI_ConvertRGB(ptr,screenBuffer, renderW,renderH);
-      renderRefresh();
-    }
-  return 1;
-
+    renderer-&gt;displayImage(image);
+    return 1;
 }
 /**
 	Refresh the image from internal buffer / last image
@@ -209,34 +191,22 @@
 uint8_t renderRefresh(void)
 {
       if(_lock) return 1;
-      if(!screenBuffer)
-      {
-              if(accel_mode) ADM_assert(0);
-              return 0;
-      }
-
-      if(accel_mode)
-      {
-          if(lastImage)
-               if(accel_mode -&gt;hasHwZoom())
-                {
-                  accel_mode-&gt;display(lastImage, phyW, phyH,lastZoom);
-                }else
-                {
-                  accel_mode-&gt;display(lastImage, renderW, renderH,lastZoom);
-                }
-      }
-      else
-              GUI_RGBDisplay(screenBuffer, renderW, renderH,draw);
-  return 1;
+      renderer-&gt;refresh();
+      return 1;
 }
-
+/**
+    \fn renderExpose
+*/
 uint8_t renderExpose(void)
 {
     renderRefresh();
 }
+/**
+    \fn 
+*/
 uint8_t renderStartPlaying( void )
 {
+#if 0
 char *displ;
 unsigned int renderI;
 ADM_RENDER_TYPE render;
@@ -244,7 +214,7 @@
 	ADM_assert(!accel_mode);
         
 
-	render=MUI_getPreferredRender();
+        render=MUI_getPreferredRender();
         GUI_WindowInfo xinfo;
         MUI_getWindowInfo(draw, &amp;xinfo);
         switch(render)
@@ -301,59 +271,49 @@
            accelSurface=new uint8_t[ (renderW*renderH*3)&gt;&gt;1];
           
         }
-	
+#endif	
 	return 1;
 }
+
 /**
-      \fn renderHasAccelZoom
-      \brief returns 1 if accel can do hw zoom
+    \fn renderStopPlaying
 */
-uint8_t renderHasAccelZoom(void)
-{
-    if(!accel_mode) return 0;
-    return accel_mode-&gt;hasHwZoom(); 
-}
-
 uint8_t renderStopPlaying( void )
-{
-      
-      if(accel_mode)
-      {
-              accel_mode-&gt;end();
-              delete accel_mode;
-              if(accelSurface) delete [] accelSurface;
-              accelSurface=NULL;
-                              
-      }
-      accel_mode=NULL;	
-      
-      return 1;
+{      
+      return true;
 }
-
-
-//___________________________________________________________________________
-//
-//
-uint8_t	updateWindowSize(void * win, uint32_t w, uint32_t h)
+//***************************************
+/**
+    \fn bool calcDisplayFromZoom(renderZoom zoom);
+*/
+bool VideoRenderBase::calcDisplayFromZoom(renderZoom zoom)
 {
-    ADM_assert(screenBuffer);
-    renderW = w;
-    renderH = h;
-
-    MUI_updateDrawWindowSize(win,w,h);
-    rgbConverter.changeWidthHeight(w,h);
-    return 1;
+        int mul;
+         switch(zoom)
+            {
+                    case ZOOM_1_4: mul=1;break;
+                    case ZOOM_1_2: mul=2;break;
+                    case ZOOM_1_1: mul=4;break;
+                    case ZOOM_2:   mul=8;break;
+                    case ZOOM_4:   mul=16;break;
+                    default : ADM_assert(0);
+    
+            }
+        displayWidth=(imageWidth*mul)/4;
+        displayHeight=(imageHeight*mul)/4;
+        return true;
 }
 
-uint8_t GUI_ConvertRGB(uint8_t * in, uint8_t * out, uint32_t w, uint32_t h)
+/**
+    \fn baseInit
+*/
+bool VideoRenderBase::baseInit(uint32_t w,uint32_t h,renderZoom zoom)
 {
-    rgbConverter.changeWidthHeight(w,h);
-    rgbConverter.convert(in,out);
-    return 1;
+        imageWidth=w;
+        imageHeight=h;
+        currentZoom=zoom;
+        calcDisplayFromZoom(zoom);
+        return true;
 }
-void GUI_RGBDisplay(uint8_t * dis, uint32_t w, uint32_t h, void *widg)
-{
-    
-    MUI_rgbDraw(widg,w,h,dis);
-}
+
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.h	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.h	2010-04-07 15:34:38 UTC (rev 6085)
@@ -21,8 +21,6 @@
 
 #include &quot;ADM_image.h&quot;
 
-class AVDMGenericVideoStream;
-
 typedef struct
 {
     void *display;
@@ -45,16 +43,15 @@
 }renderZoom;
 
 uint8_t renderInit( void );
-void   renderDestroy(void);
-uint8_t renderResize(uint32_t w, uint32_t h,uint32_t phyW,uint32_t phyH);
+void    renderDestroy(void);
+uint8_t renderDisplayResize(uint32_t w, uint32_t h,renderZoom zoom);
 uint8_t renderRefresh(void);
 uint8_t renderExpose(void);
-uint8_t renderUpdateImage(uint8_t *ptr,renderZoom zoom);
+uint8_t renderUpdateImage(ADMImage *img);
 uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t,uint32_t primary);
 
 uint8_t renderStartPlaying( void );
 uint8_t renderStopPlaying( void );
-uint8_t renderHasAccelZoom(void);
 
 uint8_t renderLock(void);
 uint8_t renderUnlock(void);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_sdlRender.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_sdlRender.h	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_sdlRender.h	2010-04-07 15:34:38 UTC (rev 6085)
@@ -17,18 +17,19 @@
 
 #ifndef TSDLRENDER_H
 #define TSDLRENDER_H
-
-class sdlAccelRender: public AccelRender
+/**
+    \class sdlRender
+*/
+class sdlRender: public VideoRenderBase
 {
   protected:
-              int     useYV12;
+              bool     useYV12;
               uint8_t *decoded;
-      public:
-                                sdlAccelRender( void ) ;
-              virtual	uint8_t init( GUI_WindowInfo * window, uint32_t w, uint32_t h);
-              virtual	uint8_t end(void);
-              virtual   uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h,renderZoom zoom);
-              			uint8_t hasHwZoom(void) {return 1;}
+  public:
+                             sdlRender( void ) ;
+              virtual	bool init( GUI_WindowInfo *  window, uint32_t w, uint32_t h,renderZoom zoom);
+              virtual	bool stop(void);				
+              virtual   bool displayImage(ADMImage *pic);
 };
 
 void initSdl(int videoDevice);

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_simpleRender.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_simpleRender.cpp	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_simpleRender.cpp	2010-04-07 15:34:38 UTC (rev 6085)
@@ -0,0 +1,110 @@
+/**
+    \author mean <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A> 2010
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;config.h&quot;
+#include &quot;ADM_default.h&quot;
+#include &quot;DIA_coreToolkit.h&quot;
+#include &quot;GUI_render.h&quot;
+#include &quot;GUI_renderInternal.h&quot;
+#include &quot;GUI_accelRender.h&quot;
+#include &quot;GUI_simpleRender.h&quot;
+
+extern void MUI_rgbDraw(void *widg,uint32_t w, uint32_t h,uint8_t *ptr);
+extern void *MUI_getDrawWidget(void);
+/**
+    \fn simpleRender
+*/
+simpleRender::simpleRender()
+{
+    ADM_info(&quot;creating simple render.\n&quot;);
+    videoBuffer=NULL;
+}
+/**
+    \fn simpleRender
+*/
+simpleRender::~simpleRender()
+{
+    ADM_info(&quot;Destroying simple render.\n&quot;);
+    if(videoBuffer) delete [] videoBuffer;
+    videoBuffer=NULL;
+}
+
+/**
+    \fn stop
+*/
+bool simpleRender::stop(void)
+{
+    ADM_info(&quot;stopping simple render.\n&quot;);
+    return true;
+}
+/**
+    \fn displayImage
+*/
+bool simpleRender::displayImage(ADMImage *pic)
+{
+    scaler-&gt;convert(pic-&gt;data,videoBuffer);
+    // Display RGB data
+    MUI_rgbDraw(MUI_getDrawWidget(),displayWidth,displayHeight,videoBuffer);
+    return true;
+}
+#if ADM_UI_TYPE_BUILD == ADM_UI_QT4
+    #define IVERT ADM_COLOR_BGR32A
+#else
+    #define IVERT ADM_COLOR_RGB32A
+#endif
+/**
+    \fn cleanup
+*/
+bool simpleRender::cleanup(void)
+{
+    if(videoBuffer) delete [] videoBuffer;
+    videoBuffer=NULL;
+    if(scaler) delete scaler;
+    scaler=NULL;
+    return true;
+}
+/**
+    \fn allocateStuff
+*/
+bool simpleRender::allocateStuff(void)
+{
+        cleanup();
+        scaler=new ADMColorScalerFull(ADM_CS_BICUBIC,imageWidth,imageHeight,displayWidth,displayHeight,
+            ADM_COLOR_YV12,
+            IVERT
+        );
+        videoBuffer=new uint8_t[displayWidth*displayHeight*4];
+        return true;
+}
+
+/**
+    \fn changeZoom
+*/
+bool simpleRender::changeZoom(renderZoom newZoom)
+{
+        ADM_info(&quot;changing zoom, simple render.\n&quot;);
+        calcDisplayFromZoom(newZoom);
+        currentZoom=newZoom;
+        allocateStuff();
+        return true;
+}
+/**
+    \fn changeZoom
+*/
+bool simpleRender::init( GUI_WindowInfo *  window, uint32_t w, uint32_t h,renderZoom zoom)
+{
+    info=*window;
+    baseInit(w,h,zoom);
+    ADM_info(&quot;init, simple render. w=%d, h=%d,zoom=%d\n&quot;,(int)w,(int)h,(int)zoom);
+    allocateStuff();
+    return true;
+}

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_simpleRender.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_simpleRender.h	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_simpleRender.h	2010-04-07 15:34:38 UTC (rev 6085)
@@ -0,0 +1,41 @@
+
+/***************************************************************************
+    \brief Class to handle native (QT/Gtk render)
+    \author (C) 2010 by mean  email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef T_SIMPLE_RENDER_H
+#define T_SIMPLE_RENDER_H
+/**
+    \fn class simpleRender
+*/
+class simpleRender: public VideoRenderBase
+{
+      protected:
+                             GUI_WindowInfo info;
+                             uint8_t *videoBuffer;
+                             void    *handle;
+                             bool    cleanup(void);
+                             bool    allocateStuff(void);
+      public:
+                             simpleRender( void ) ;
+                             ~simpleRender();
+              virtual	bool init( GUI_WindowInfo *  window, uint32_t w, uint32_t h,renderZoom zoom);
+              virtual	bool stop(void);				
+              virtual   bool displayImage(ADMImage *pic);
+              virtual   bool changeZoom(renderZoom newZoom);
+};
+#endif
+
+
+
+

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_xvRender.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_xvRender.h	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_xvRender.h	2010-04-07 15:34:38 UTC (rev 6085)
@@ -17,14 +17,16 @@
 
 #ifndef T_XVRENDER_H
 #define T_XVRENDER_H
-class XvAccelRender: public AccelRender
+/**
+    \fn class XvRender
+*/
+class XvRender: public VideoRenderBase
 {
       public:
-                              XvAccelRender( void ) ;
-              virtual	uint8_t init( GUI_WindowInfo *  window, uint32_t w, uint32_t h);
-              virtual	uint8_t end(void);				
-              virtual uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h,renderZoom zoom);
-                      uint8_t hasHwZoom(void) {return 1;}
+                             XvRender( void ) ;
+              virtual	bool init( GUI_WindowInfo *  window, uint32_t w, uint32_t h,renderZoom zoom);
+              virtual	bool stop(void);				
+              virtual   bool displayImage(ADMImage *pic);
 };
 #endif
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_play.cpp	2010-04-07 15:34:38 UTC (rev 6085)
@@ -128,8 +128,8 @@
     stop_req = 0;
     playing = 1;
 
-    admPreview::deferDisplay(1,0);
-    admPreview::samePicture();
+    admPreview::deferDisplay(true);
+    //admPreview::samePicture();
 
     GUIPlayback *playLoop=new GUIPlayback;
     playLoop-&gt;initialize();
@@ -138,9 +138,7 @@
     delete playLoop;
     playing = 0;
 
-//   getFirstVideoFilter( );
-
-   admPreview::deferDisplay(0,0);
+   admPreview::deferDisplay(false);
    // Resize the output window to original size...
    ADM_info(&quot;Restoring display.\n&quot;);
    

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-04-07 15:34:38 UTC (rev 6085)
@@ -191,7 +191,7 @@
 
 	prefs-&gt;get(DEVICE_VIDEODEVICE, &amp;videoDevice);
 
-	initSdl(videoDevice);
+//	initSdl(videoDevice);
 #endif
 
 	atexit(onexit);
@@ -312,7 +312,7 @@
 	ADM_lavDestroy();
 
 #ifdef USE_SDL
-	quitSdl();
+//	quitSdl();
 #endif
 
 #ifdef HAVE_AUDIO

Modified: branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-04-07 15:34:38 UTC (rev 6085)
@@ -39,6 +39,7 @@
 #
 SET(ADM_EXE_SRCS 
 ../common/ADM_preview.cpp  
+../common/ADM_previewNavigate.cpp  
 ../common/gtk_gui.cpp  
 ../common/gui_autodrive.cpp  
 ../common/GUI_jobs.cpp  

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_preview.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_preview.cpp	2010-04-07 07:39:21 UTC (rev 6084)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/T_preview.cpp	2010-04-07 15:34:38 UTC (rev 6085)
@@ -27,14 +27,12 @@
 #endif
 
 #include &quot;T_preview.h&quot;
-//#include &quot;Q_seekablePreview.h&quot;
 #include &quot;../ADM_render/GUI_render.h&quot;
 #include &quot;../ADM_render/GUI_accelRender.h&quot;
 #include &quot;DIA_coreToolkit.h&quot;
     
 void UI_QT4VideoWidget(QFrame *host);
 static QFrame *hostFrame=NULL;
-static AccelRender *accelRender=NULL;
 static uint8_t *lastImage=NULL;
 extern QWidget *QuiMainWindows;
 
@@ -44,18 +42,7 @@
 void DIA_previewEnd(void) {}
 uint8_t DIA_previewStillAlive(void) {return 1;}
 
-uint8_t	DIA_filterPreview(const char *captionText, AVDMGenericVideoStream *videoStream, uint32_t frame)
-{
-#if 0
-	ADM_assert(frame &lt;= videoStream-&gt;getInfo()-&gt;nb_frames);
 
-	printf(&quot;** DIA_filterPreview %i **\n&quot;, frame);
-	Ui_seekablePreviewWindow previewDialog(NULL,videoStream, frame);
-
-	previewDialog.exec();
-#endif
-}
-
 //****************************************************************************************************
 /*
   Function to display
@@ -78,17 +65,11 @@
 
 void ADM_Qvideo::paintEvent(QPaintEvent *ev)
 {
-	if(!displayW || !displayH || !rgbDataBuffer || accelRender)
+	if(!displayW || !displayH || !rgbDataBuffer )
 		return ;
 
-	if(accelRender) 
+	
 	{
-		if(lastImage)
-		{
-			accelRender-&gt;display(lastImage,displayW,displayH);
-		}
-	}else
-	{
 		QImage image(rgbDataBuffer,displayW,displayH,QImage::Format_RGB32);
 		QPainter painter(this);
 		painter.drawImage(QPoint(0,0),image);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003288.html">[Avidemux-svn-commit] r6084 - in	branches/avidemux_2.6_branch_mean/avidemux_core: ADM_core/src	ADM_ffmpeg/ffmpeg_config ADM_ffmpeg/libavutil
</A></li>
	<LI>Next message: <A HREF="003290.html">[Avidemux-svn-commit] r6086 - in	branches/avidemux_2.6_branch_mean/avidemux/common: . ADM_render
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3289">[ date ]</a>
              <a href="thread.html#3289">[ thread ]</a>
              <a href="subject.html#3289">[ subject ]</a>
              <a href="author.html#3289">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
