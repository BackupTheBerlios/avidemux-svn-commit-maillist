<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r5315 - in branches/avidemux_2.6_branch_mean:	avidemux_core/ADM_coreMuxer/include avidemux_core/ADM_coreMuxer/src	avidemux_plugins/ADM_muxers/muxerFlv	avidemux_plugins/ADM_muxers/muxerMkv	avidemux_plugins/ADM_muxers/muxerMp4	avidemux_plugins/ADM_muxers/muxerffPS
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2009-September/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r5315%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux_core/ADM_coreMuxer/include%20avidemux_core/ADM_coreMuxer/src%0A%09avidemux_plugins/ADM_muxers/muxerFlv%0A%09avidemux_plugins/ADM_muxers/muxerMkv%0A%09avidemux_plugins/ADM_muxers/muxerMp4%0A%09avidemux_plugins/ADM_muxers/muxerffPS&In-Reply-To=%3C200909041510.n84FA9Ik021510%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002526.html">
   <LINK REL="Next"  HREF="002529.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r5315 - in branches/avidemux_2.6_branch_mean:	avidemux_core/ADM_coreMuxer/include avidemux_core/ADM_coreMuxer/src	avidemux_plugins/ADM_muxers/muxerFlv	avidemux_plugins/ADM_muxers/muxerMkv	avidemux_plugins/ADM_muxers/muxerMp4	avidemux_plugins/ADM_muxers/muxerffPS</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r5315%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux_core/ADM_coreMuxer/include%20avidemux_core/ADM_coreMuxer/src%0A%09avidemux_plugins/ADM_muxers/muxerFlv%0A%09avidemux_plugins/ADM_muxers/muxerMkv%0A%09avidemux_plugins/ADM_muxers/muxerMp4%0A%09avidemux_plugins/ADM_muxers/muxerffPS&In-Reply-To=%3C200909041510.n84FA9Ik021510%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r5315 - in branches/avidemux_2.6_branch_mean:	avidemux_core/ADM_coreMuxer/include avidemux_core/ADM_coreMuxer/src	avidemux_plugins/ADM_muxers/muxerFlv	avidemux_plugins/ADM_muxers/muxerMkv	avidemux_plugins/ADM_muxers/muxerMp4	avidemux_plugins/ADM_muxers/muxerffPS">mean at mail.berlios.de
       </A><BR>
    <I>Fri Sep  4 17:10:09 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002526.html">[Avidemux-svn-commit] r5314 - in branches/avidemux_2.6_branch_mean:	avidemux_core/ADM_coreMuxer/include	avidemux_plugins/ADM_muxers/muxerMkv	avidemux_plugins/ADM_muxers/muxerffPS
</A></li>
        <LI>Next message: <A HREF="002529.html">[Avidemux-svn-commit] r5316 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2527">[ date ]</a>
              <a href="thread.html#2527">[ thread ]</a>
              <a href="subject.html#2527">[ subject ]</a>
              <a href="author.html#2527">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2009-09-04 17:10:07 +0200 (Fri, 04 Sep 2009)
New Revision: 5315

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_muxerUtils.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv/muxerFlv.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv/muxerFlv.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffPS/muxerffPS.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffPS/muxerffPS.h
Log:
[ff muxers] Better way of computing scale (in fact the right one :) ), factorize away some code

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h	2009-09-04 15:10:05 UTC (rev 5314)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/include/ADM_coreMuxerFfmpeg.h	2009-09-04 15:10:07 UTC (rev 5315)
@@ -21,6 +21,7 @@
 #include &quot;ADM_default.h&quot;
 #include &quot;fourcc.h&quot;
 #include &quot;ADM_muxer.h&quot;
+#include &quot;ADM_muxerUtils.h&quot;
 #include &quot;ADM_lavcodec.h&quot;
 extern &quot;C&quot;
 {
@@ -35,13 +36,24 @@
 class muxerFFmpeg : public ADM_muxer
 {
 protected:
-        virtual bool muxerRescaleVideoTime(uint64_t *time)=0;
+        virtual bool muxerRescaleVideoTime(uint64_t *time)
+        {
+             AVRational *scale=&amp;(video_st-&gt;time_base);
+            *time=rescaleLavPts(*time,scale);
+            return true;
+        }
+        virtual bool muxerRescaleAudioTime(uint64_t *time,uint32_t fq)
+        {       
+             AVRational *scale=&amp;(audio_st-&gt;time_base);
+            *time=rescaleLavPts(*time,scale);
+            return true;
+        }
+        // On case the muxer does not accept ADM_NO_PTS we can use computedDts
+        // The default is use ADM_NO_PTS
         virtual bool muxerRescaleVideoTimeDts(uint64_t *time,uint64_t computedDts)
-                    {
-                        return muxerRescaleVideoTime(time);
-                    }
-        virtual bool muxerRescaleAudioTime(uint64_t *time,uint32_t fq)=0;
-
+        {
+            return muxerRescaleVideoTime(time);
+        }
 protected:
         bool saveLoop(const char *title);
 protected:

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2009-09-04 15:10:05 UTC (rev 5314)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2009-09-04 15:10:07 UTC (rev 5315)
@@ -256,7 +256,7 @@
           switch(audioheader-&gt;encoding)
           {
                   case WAV_AC3: c-&gt;codec_id = CODEC_ID_AC3;c-&gt;frame_size=6*256;break;
-                  case WAV_MP2: c-&gt;codec_id = CODEC_ID_MP2;break;
+                  case WAV_MP2: c-&gt;codec_id = CODEC_ID_MP2;c-&gt;frame_size=1152;break;
                   case WAV_MP3:
   #warning FIXME : Probe deeper
                               c-&gt;frame_size=1152;
@@ -367,7 +367,7 @@
             pkt.size= len;
             if(flags &amp; 0x10) // FIXME AVI_KEY_FRAME
                         pkt.flags |= PKT_FLAG_KEY;
-            ret =av_write_frame(oc, &amp;pkt);
+            ret =av_interleaved_write_frame(oc, &amp;pkt);
             aprintf(&quot;[FF]Frame:%u, DTS=%08lu PTS=%08lu\n&quot;,written,dts,pts);
             if(ret)
             {
@@ -400,7 +400,7 @@
                     pkt.stream_index=1+audio;
                     pkt.data= audioBuffer;
                     pkt.size= audioSize;
-                    ret =av_write_frame(oc, &amp;pkt);
+                    ret =av_interleaved_write_frame(oc, &amp;pkt);
                     if(ret)
                     {
                         printf(&quot;[FF]Error writing audio packet\n&quot;);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_muxerUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_muxerUtils.cpp	2009-09-04 15:10:05 UTC (rev 5314)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_muxerUtils.cpp	2009-09-04 15:10:07 UTC (rev 5315)
@@ -49,8 +49,10 @@
 */
 uint64_t rescaleLavPts(uint64_t us, AVRational *scale)
 {
-
-     if(us==ADM_NO_PTS) return 0x8000000000000000LL;  // AV_NOPTS_VALUE
+#ifndef INT64_C
+#define INT64_C (uint64_t)
+#endif
+     if(us==ADM_NO_PTS) return AV_NOPTS_VALUE;  // AV_NOPTS_VALUE
     double db=(double)us;
     double s=scale-&gt;den;
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv/muxerFlv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv/muxerFlv.cpp	2009-09-04 15:10:05 UTC (rev 5314)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv/muxerFlv.cpp	2009-09-04 15:10:07 UTC (rev 5315)
@@ -145,17 +145,6 @@
 }
 
 
-bool muxerFlv::muxerRescaleVideoTime(uint64_t *time)
-{
-    AVRational *scale=&amp;(video_st-&gt;codec-&gt;time_base);
-    *time=rescaleLavPts(*time,scale);
-    return true;
-}
-bool muxerFlv::muxerRescaleAudioTime(uint64_t *time,uint32_t fq)
-{
-    *time=*time/1000;
-    return true;
-}
 
 /**
     \fn close

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv/muxerFlv.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv/muxerFlv.h	2009-09-04 15:10:05 UTC (rev 5314)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv/muxerFlv.h	2009-09-04 15:10:07 UTC (rev 5315)
@@ -31,8 +31,6 @@
 {
 protected:
 
-        bool muxerRescaleVideoTime(uint64_t *time);
-        bool muxerRescaleAudioTime(uint64_t *time,uint32_t fq);
 public:
                 muxerFlv();
         virtual ~muxerFlv();

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.cpp	2009-09-04 15:10:05 UTC (rev 5314)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.cpp	2009-09-04 15:10:07 UTC (rev 5315)
@@ -109,23 +109,6 @@
     return saveLoop(title);
 }
 
-bool muxerMkv::muxerRescaleVideoTime(uint64_t *time)
-{
-    if(*time==ADM_NO_PTS)
-    {
-        *time=AV_NOPTS_VALUE;
-        return true;
-    }
-    *time=*time/1000;
-
-    return true;
-}
-bool muxerMkv::muxerRescaleAudioTime(uint64_t *time,uint32_t fq)
-{
-
-   *time=*time/1000;
-    return true;
-}
 bool muxerMkv::muxerRescaleVideoTimeDts(uint64_t *time,uint64_t computedDts)
 {
     if(*time==ADM_NO_PTS)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.h	2009-09-04 15:10:05 UTC (rev 5314)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMkv/muxerMkv.h	2009-09-04 15:10:07 UTC (rev 5315)
@@ -23,8 +23,6 @@
 class muxerMkv : public muxerFFmpeg
 {
 protected:
-        bool muxerRescaleVideoTime(uint64_t *time);
-        bool muxerRescaleAudioTime(uint64_t *time,uint32_t fq);
         bool muxerRescaleVideoTimeDts(uint64_t *time,uint64_t computedDts);
 public:
                 muxerMkv();

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.cpp	2009-09-04 15:10:05 UTC (rev 5314)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.cpp	2009-09-04 15:10:07 UTC (rev 5315)
@@ -132,23 +132,6 @@
     return saveLoop(title);
 }
 
-bool muxerMP4::muxerRescaleVideoTime(uint64_t *time)
-{
-    AVRational *scale=&amp;(video_st-&gt;codec-&gt;time_base);
-    *time=rescaleLavPts(*time,scale);
-    return true;
-}
-bool muxerMP4::muxerRescaleAudioTime(uint64_t *time,uint32_t fq)
-{
-  AVPacket pkt;
-    double f=*time;
-    f*=fq; // In samples
-    f/=1000.*1000.; // In sec
-
-
-    *time=(uint64_t)(f+0.4);
-}
-  
 /**
     \fn close
     \brief Cleanup is done in the dtor

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.h	2009-09-04 15:10:05 UTC (rev 5314)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4/muxerMP4.h	2009-09-04 15:10:07 UTC (rev 5315)
@@ -36,8 +36,6 @@
 class muxerMP4 : public muxerFFmpeg
 {
 protected:
-        bool muxerRescaleVideoTime(uint64_t *time);
-        bool muxerRescaleAudioTime(uint64_t *time,uint32_t fq);
 public:
                 muxerMP4();
         virtual ~muxerMP4();

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffPS/muxerffPS.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffPS/muxerffPS.cpp	2009-09-04 15:10:05 UTC (rev 5314)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffPS/muxerffPS.cpp	2009-09-04 15:10:07 UTC (rev 5315)
@@ -159,6 +159,15 @@
         AVCodecContext *c;
         c = video_st-&gt;codec;
         rescaleFps(s-&gt;getAvgFps1000(),&amp;(c-&gt;time_base));
+        // Override codec settings
+#define MKX(a,bsize,maxb) case a: c-&gt;bit_rate=maxb*1000;c-&gt;rc_buffer_size=bsize*8*1000;break;
+        switch(psMuxerConfig.muxingType)
+        {
+            MKX(MUXER_VCD,  40,1152)
+            MKX(MUXER_SVCD,112,2400)
+            MKX(MUXER_DVD, 224,9800)
+        }
+
         c-&gt;gop_size=15;
         
         if(initAudio(nbAudioTrack,a)==false)
@@ -175,8 +184,8 @@
             case MUXER_DVD:  oc-&gt;mux_rate=1152*1000;;break;
         }
        
-        oc-&gt;preload=AV_TIME_BASE/10; // 100 ms preloading
-        oc-&gt;max_delay=200*1000; // 500 ms
+        oc-&gt;preload=0; // 100 ms preloading
+        oc-&gt;max_delay=2000; // 500 ms
         if (av_set_parameters(oc, NULL) &lt; 0)
         {
             printf(&quot;[ffPs]Lav: set param failed \n&quot;);
@@ -203,33 +212,18 @@
     const char *title=QT_TR_NOOP(&quot;Saving mpeg PS (ff)&quot;);
     return saveLoop(title);
 }
-#define INT64_C (uint64_t)
-bool muxerffPS::muxerRescaleVideoTime(uint64_t *time)
-{
-    if(*time==ADM_NO_PTS)
-    {
-        *time=AV_NOPTS_VALUE;
-        return true;
-    }
-    *time=*time/90;
-    
-    return true;
-}
+// Clock is 90 Khz for all mpeg streams
+// Since the unit is in us=10e6,
+// time=time/10E6*90E3
+// time=(time*9)/100
 bool muxerffPS::muxerRescaleVideoTimeDts(uint64_t *time,uint64_t computedDts)
 {
     if(*time==ADM_NO_PTS)
     {
         *time=computedDts;
-        return muxerRescaleVideoTime(time);
     }
     return muxerRescaleVideoTime(time);
 }
-
-bool muxerffPS::muxerRescaleAudioTime(uint64_t *time,uint32_t fq)
-{
-    *time=*time/90;
-    return true;
-}
   
 /**
     \fn close

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffPS/muxerffPS.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffPS/muxerffPS.h	2009-09-04 15:10:05 UTC (rev 5314)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerffPS/muxerffPS.h	2009-09-04 15:10:07 UTC (rev 5315)
@@ -41,10 +41,8 @@
 class muxerffPS : public muxerFFmpeg
 {
 protected:
-        bool muxerRescaleVideoTime(uint64_t *time);
-        bool muxerRescaleVideoTimeDts(uint64_t *time,uint64_t computedDts);
         
-        bool muxerRescaleAudioTime(uint64_t *time,uint32_t fq);
+        bool muxerRescaleVideoTimeDts(uint64_t *time,uint64_t computedDts);
 
 public:
                 muxerffPS();


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002526.html">[Avidemux-svn-commit] r5314 - in branches/avidemux_2.6_branch_mean:	avidemux_core/ADM_coreMuxer/include	avidemux_plugins/ADM_muxers/muxerMkv	avidemux_plugins/ADM_muxers/muxerffPS
</A></li>
	<LI>Next message: <A HREF="002529.html">[Avidemux-svn-commit] r5316 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerFlv
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2527">[ date ]</a>
              <a href="thread.html#2527">[ thread ]</a>
              <a href="subject.html#2527">[ subject ]</a>
              <a href="author.html#2527">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
