<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r3833 - in	branches/avidemux_2.4_branch/avidemux: . ADM_osSupport	ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2008-March/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3833%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%20.%20ADM_osSupport%0A%09ADM_userInterfaces/ADM_GTK/ADM_gui2%0A%09ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk%0A%09ADM_userInterfaces/ADM_NONE/ADM_gui2%0A%09ADM_userInterfaces/ADM_QT4/ADM_gui&In-Reply-To=%3C200803061849.m26In2DH019273%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001097.html">
   <LINK REL="Next"  HREF="001099.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r3833 - in	branches/avidemux_2.4_branch/avidemux: . ADM_osSupport	ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui</H1>
    <B>gruntster at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3833%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%20.%20ADM_osSupport%0A%09ADM_userInterfaces/ADM_GTK/ADM_gui2%0A%09ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk%0A%09ADM_userInterfaces/ADM_NONE/ADM_gui2%0A%09ADM_userInterfaces/ADM_QT4/ADM_gui&In-Reply-To=%3C200803061849.m26In2DH019273%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r3833 - in	branches/avidemux_2.4_branch/avidemux: . ADM_osSupport	ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui">gruntster at mail.berlios.de
       </A><BR>
    <I>Thu Mar  6 19:49:02 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001097.html">[Avidemux-svn-commit] r3831 - in	branches/avidemux_2.5_branch_mean/avidemux: .	ADM_core/include ADM_core/src ADM_libraries/ADM_mplex	ADM_libraries/ADM_utilities ADM_outputs/oplug_avi	ADM_outputs/oplug_dummy ADM_outputs/oplug_flv	ADM_outputs/oplug_mp4 ADM_outputs/oplug_mpeg	ADM_outputs/oplug_mpegFF ADM_toolkit	ADM_userInterfaces/ADM_GTK/ADM_gui2
</A></li>
        <LI>Next message: <A HREF="001099.html">[Avidemux-svn-commit] r3834 -	branches/avidemux_2.5_branch_mean/avidemux/ADM_outputs/oplug_avi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1098">[ date ]</a>
              <a href="thread.html#1098">[ thread ]</a>
              <a href="subject.html#1098">[ subject ]</a>
              <a href="author.html#1098">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: gruntster
Date: 2008-03-06 19:48:52 +0100 (Thu, 06 Mar 2008)
New Revision: 3833

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_misc.h
   branches/avidemux_2.4_branch/avidemux/ADM_osSupport/win32.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/toolkit.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/file_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp
   branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
Log:
[Preview] centre preview windows correctly on multi-monitor setups

Modified: branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_misc.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_misc.h	2008-03-06 18:32:32 UTC (rev 3832)
+++ branches/avidemux_2.4_branch/avidemux/ADM_osSupport/ADM_misc.h	2008-03-06 18:48:52 UTC (rev 3833)
@@ -85,7 +85,6 @@
 	#define SHTDN_REASON_FLAG_PLANNED 0x80000000
 
 	int shutdown_win32(void);
-	void getWorkingArea(uint32_t *width, uint32_t *height);
 #else
 	#include &lt;sys/resource.h&gt;
 #endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_osSupport/win32.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_osSupport/win32.cpp	2008-03-06 18:32:32 UTC (rev 3832)
+++ branches/avidemux_2.4_branch/avidemux/ADM_osSupport/win32.cpp	2008-03-06 18:48:52 UTC (rev 3833)
@@ -393,41 +393,6 @@
 	return true;
 }
 
-#define MONITOR_DEFAULTTONEAREST    0x00000002
-
-void getWorkingArea(uint32_t *width, uint32_t *height)
-{
-	typedef void* (WINAPI *MonitorFromWindow)(HWND hwnd, uint32_t dwFlags);
-	typedef bool (WINAPI *GetMonitorInfo)(void *hMonitor, LPMONITORINFO lpmi);
-
-	static HMODULE user32 = GetModuleHandle(&quot;user32.dll&quot;);
-	static MonitorFromWindow pMonitorFromWindow = (MonitorFromWindow)GetProcAddress(user32, &quot;MonitorFromWindow&quot;);
-	static GetMonitorInfo pGetMonitorInfo = (GetMonitorInfo)GetProcAddress(user32, &quot;GetMonitorInfoA&quot;);
-
-	if (pMonitorFromWindow == NULL)
-	{
-		RECT rect;
-
-		// Required for NT4 - no multi-monitor support
-		SystemParametersInfo(SPI_GETWORKAREA, 0, &amp;rect, 0);
-
-		*width = rect.right - rect.left;
-		*height = rect.bottom - rect.top;
-	}
-	else
-	{
-		void *hMonitor = pMonitorFromWindow(GetForegroundWindow(), MONITOR_DEFAULTTONEAREST);
-
-		MONITORINFO monitorInfo;
-
-		monitorInfo.cbSize = sizeof(MONITORINFO);
-		pGetMonitorInfo(hMonitor, &amp;monitorInfo);
-
-		*width = monitorInfo.rcWork.right - monitorInfo.rcWork.left;
-		*height = monitorInfo.rcWork.bottom - monitorInfo.rcWork.top;
-	}
-}
-
 void redirectStdoutToFile(void)
 {
 	// Don't redirect stdout and stderr if SDL hasn't already hijacked it.

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2008-03-06 18:32:32 UTC (rev 3832)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2008-03-06 18:48:52 UTC (rev 3833)
@@ -46,7 +46,7 @@
 #include &quot;../ADM_toolkit_gtk/ADM_jogshuttle.h&quot;
 #include &quot;gtkgui.h&quot;
 
-uint8_t UI_getPhysicalScreenSize(uint32_t *w,uint32_t *h);
+extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h);
 
 
 #define WOD(x) lookup_widget (guiRootWindow,#x)
@@ -54,7 +54,7 @@
 void frame2time(uint32_t frame, uint32_t fps, uint16_t * hh, uint16_t * mm,
 	   uint16_t * ss, uint16_t * ms);
 
-static GtkWidget *guiRootWindow=NULL;
+GtkWidget *guiRootWindow=NULL;
 static GtkWidget *guiDrawingArea=NULL;
 static GtkWidget *guiSlider=NULL;
 
@@ -329,7 +329,7 @@
 		GUI_initCursor(  );
     
                 
-                UI_getPhysicalScreenSize(&amp;w,&amp;h); //gtk_widget_get_parent_window (guiRootWindow));
+                UI_getPhysicalScreenSize(guiRootWindow, &amp;w, &amp;h);
                 printf(&quot;The screen seems to be %u x %u px\n&quot;,w,h);
  
                 GUI_gtk_grow_off(1);
@@ -1287,7 +1287,6 @@
 extern char **global_argv;
 typedef gboolean GCALL       (void *);
 extern int automation(void );
-extern uint8_t UI_getPhysicalScreenSize(uint32_t *w,uint32_t *h);
 extern void initTranslator(void);
 
 int UI_Init(int argc, char **argv)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp	2008-03-06 18:32:32 UTC (rev 3832)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp	2008-03-06 18:48:52 UTC (rev 3833)
@@ -44,7 +44,7 @@
 void GUI_gtk_grow_off(int onff);
 
 extern GtkWidget *getDrawWidget(void);
-extern uint8_t UI_getPhysicalScreenSize(uint32_t *w, uint32_t *h);
+extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w, uint32_t *h);
 
 #ifdef ENABLE_WINDOW_SIZING_HACK
 extern int maxWindowWidth, maxWindowHeight; // from GUI_bindings.cpp
@@ -194,7 +194,7 @@
 	gtk_window_get_size(window, &amp;windowWidth, &amp;windowHeight);
 	gtk_widget_get_size_request(drawingArea, &amp;drawingWidth, &amp;drawingHeight);
 
-	UI_getPhysicalScreenSize(&amp;screenWidth, &amp;screenHeight);
+	UI_getPhysicalScreenSize(window, &amp;screenWidth, &amp;screenHeight);
 
 	// Take drawing area out of the equation, how much extra do we need for additional controls?
 	windowWidth -= drawingWidth;
@@ -226,9 +226,11 @@
 void UI_centreCanvasWindow(GtkWindow *window, GtkWidget *canvas, int newCanvasWidth, int newCanvasHeight)
 {
 	int winWidth, winHeight, widgetWidth, widgetHeight;
-	uint32_t resWidth, resHeight;
+	GdkScreen *screen = gdk_screen_get_default();
+	int monitorNo = gdk_screen_get_monitor_at_window(screen, GTK_WIDGET(window-&gt;transient_parent)-&gt;window);
+	GdkRectangle rect;
 
-	UI_getPhysicalScreenSize(&amp;resWidth, &amp;resHeight);
+	gdk_screen_get_monitor_geometry(screen, monitorNo, &amp;rect);
 	gtk_widget_get_size_request((GtkWidget*)canvas, &amp;widgetWidth, &amp;widgetHeight);
 	gtk_window_get_size(window, &amp;winWidth, &amp;winHeight);
 
@@ -239,6 +241,6 @@
 	winWidth += 10;
 	winHeight += 40;
 
-	gtk_window_move(window, ((int)resWidth - winWidth) / 2, ((int)resHeight - winHeight) / 2);
+	gtk_window_move(window, rect.x + (rect.width - winWidth) / 2, rect.y + (rect.height - winHeight) / 2);
 }
 // EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/toolkit.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/toolkit.cpp	2008-03-06 18:32:32 UTC (rev 3832)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/toolkit.cpp	2008-03-06 18:48:52 UTC (rev 3833)
@@ -29,7 +29,7 @@
 #include &quot;avi_vars.h&quot;
 #include &quot;ADM_misc.h&quot;
 
-
+extern GtkWidget *guiRootWindow;
 GtkWidget *GUI_PixmapButtonDefault(GdkWindow * window, const gchar ** xpm,
                                   const gchar * tooltip);
 GtkWidget *GUI_PixmapButton(GdkWindow * window, const gchar ** xpm,
@@ -190,26 +190,22 @@
     \fn UI_getPhysicalScreenSize
     \brief return the physical size of display in pixels
 */
-uint8_t UI_getPhysicalScreenSize(uint32_t *w, uint32_t *h)
+uint8_t UI_getPhysicalScreenSize(void *window, uint32_t *w, uint32_t *h)
 {
-#ifdef ADM_WIN32
-	getWorkingArea(w, h);
-#else
-	static int inited = 0;
-	static int ww,hh;
+	GtkWindow* gtkWindow = (GtkWindow*)window;
+	GdkScreen *screen = gdk_screen_get_default();
 
-    if (!inited)
-    {      
-      GdkScreen* sc = gdk_screen_get_default();
-      ww = gdk_screen_get_width(sc);
-      hh = gdk_screen_get_height(sc);
-      inited = 1;
-    }
+	if (!gtkWindow)
+		gtkWindow = (GtkWindow*)guiRootWindow;
 
-    *w=ww;
-    *h=hh;
-#endif
+	int monitorNo = gdk_screen_get_monitor_at_window(screen, GTK_WIDGET(gtkWindow)-&gt;window);
+	GdkRectangle rect;
 
+	gdk_screen_get_monitor_geometry(screen, monitorNo, &amp;rect);
+
+	*w = rect.width;
+	*h = rect.height;
+
 	return 1;
 }
 //EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/file_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/file_none.cpp	2008-03-06 18:32:32 UTC (rev 3832)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/file_none.cpp	2008-03-06 18:48:52 UTC (rev 3833)
@@ -29,7 +29,7 @@
 void GUI_FileSelWrite(const char *label, char * * name)
 {}
 
-uint8_t UI_getPhysicalScreenSize(uint32_t *w,uint32_t *h)
+uint8_t UI_getPhysicalScreenSize(void *window, uint32_t *w,uint32_t *h)
 {
   *w=*h=10000; 
 }
\ No newline at end of file

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2008-03-06 18:32:32 UTC (rev 3832)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2008-03-06 18:48:52 UTC (rev 3833)
@@ -41,7 +41,7 @@
 extern int global_argc;
 extern char **global_argv;
 
-extern uint8_t UI_getPhysicalScreenSize(uint32_t *w,uint32_t *h);
+extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h);
 extern int automation(void );
 extern void HandleAction(Action a);
 extern uint32_t encoderGetNbEncoder (void);
@@ -622,16 +622,16 @@
 
 	loadTranslator();
 
-	uint32_t w, h;
-
-	UI_getPhysicalScreenSize(&amp;w,&amp;h);
-	printf(&quot;The screen seems to be %u x %u px\n&quot;,w,h);
-
 	MainWindow *mw = new MainWindow();
 	mw-&gt;show();
 
 	QuiMainWindows = (QWidget*)mw;
 
+	uint32_t w, h;
+
+	UI_getPhysicalScreenSize(QuiMainWindows, &amp;w,&amp;h);
+	printf(&quot;The screen seems to be %u x %u px\n&quot;,w,h);
+
 	UI_QT4VideoWidget(mw-&gt;ui.frame_video);  // Add the widget that will handle video display
 	UI_updateRecentMenu();
 	setupMenus();

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp	2008-03-06 18:32:32 UTC (rev 3832)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp	2008-03-06 18:48:52 UTC (rev 3833)
@@ -23,7 +23,7 @@
 uint8_t UI_arrow_enabled(void) {return 1;}
 uint8_t UI_arrow_disabled(void) {return 1;}
 
-uint8_t UI_getPhysicalScreenSize(uint32_t *w,uint32_t *h)
+uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h)
 {
 	QRect qrect = QApplication::desktop()-&gt;availableGeometry();
 

Modified: branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2008-03-06 18:32:32 UTC (rev 3832)
+++ branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2008-03-06 18:48:52 UTC (rev 3833)
@@ -149,7 +149,7 @@
 PARAM_MUX muxMode = MUX_REGULAR;
 int muxParam = 0;
 
-extern uint8_t UI_getPhysicalScreenSize(uint32_t *w,uint32_t *h);
+extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h);
 extern uint8_t GUI_jobs(void);
 extern bool parseECMAScript(const char *name);
 void A_parseECMAScript(const char *name);
@@ -1063,7 +1063,7 @@
   
   /* Zoom out if needed */
   uint32_t phyW,phyH;
-  UI_getPhysicalScreenSize(&amp;phyW,&amp;phyH);
+  UI_getPhysicalScreenSize(NULL, &amp;phyW,&amp;phyH);
   if(phyW&lt;avifileinfo-&gt;width || phyH&lt;avifileinfo-&gt;height)
   {
       if(phyW&lt;avifileinfo-&gt;width/2 || phyH&lt;avifileinfo-&gt;height/2)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001097.html">[Avidemux-svn-commit] r3831 - in	branches/avidemux_2.5_branch_mean/avidemux: .	ADM_core/include ADM_core/src ADM_libraries/ADM_mplex	ADM_libraries/ADM_utilities ADM_outputs/oplug_avi	ADM_outputs/oplug_dummy ADM_outputs/oplug_flv	ADM_outputs/oplug_mp4 ADM_outputs/oplug_mpeg	ADM_outputs/oplug_mpegFF ADM_toolkit	ADM_userInterfaces/ADM_GTK/ADM_gui2
</A></li>
	<LI>Next message: <A HREF="001099.html">[Avidemux-svn-commit] r3834 -	branches/avidemux_2.5_branch_mean/avidemux/ADM_outputs/oplug_avi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1098">[ date ]</a>
              <a href="thread.html#1098">[ thread ]</a>
              <a href="subject.html#1098">[ subject ]</a>
              <a href="author.html#1098">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
