<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r3866 - in	branches/avidemux_2.5_branch_gruntster: avidemux	avidemux/ADM_audio avidemux/ADM_audiocodec	avidemux/ADM_audiofilter avidemux/ADM_core/include	avidemux/ADM_core/src avidemux/ADM_editor	avidemux/ADM_libraries/ADM_lavformat avidemux/ADM_osSupport	avidemux/ADM_toolkit avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3	avidemux/plugins/ADM_audiodecoder/ADM_ad_faad	avidemux/plugins/ADM_audiodecoder/ADM_ad_mad	avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis cmake
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2008-March/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3866%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster%3A%20avidemux%0A%09avidemux/ADM_audio%20avidemux/ADM_audiocodec%0A%09avidemux/ADM_audiofilter%20avidemux/ADM_core/include%0A%09avidemux/ADM_core/src%20avidemux/ADM_editor%0A%09avidemux/ADM_libraries/ADM_lavformat%20avidemux/ADM_osSupport%0A%09avidemux/ADM_toolkit%20avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3%0A%09avidemux/plugins/ADM_audiodecoder/ADM_ad_faad%0A%09avidemux/plugins/ADM_audiodecoder/ADM_ad_mad%0A%09avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis%20cmake&In-Reply-To=%3C200803101839.m2AIdQfT010339%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001128.html">
   <LINK REL="Next"  HREF="001130.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r3866 - in	branches/avidemux_2.5_branch_gruntster: avidemux	avidemux/ADM_audio avidemux/ADM_audiocodec	avidemux/ADM_audiofilter avidemux/ADM_core/include	avidemux/ADM_core/src avidemux/ADM_editor	avidemux/ADM_libraries/ADM_lavformat avidemux/ADM_osSupport	avidemux/ADM_toolkit avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3	avidemux/plugins/ADM_audiodecoder/ADM_ad_faad	avidemux/plugins/ADM_audiodecoder/ADM_ad_mad	avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis cmake</H1>
    <B>gruntster at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3866%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster%3A%20avidemux%0A%09avidemux/ADM_audio%20avidemux/ADM_audiocodec%0A%09avidemux/ADM_audiofilter%20avidemux/ADM_core/include%0A%09avidemux/ADM_core/src%20avidemux/ADM_editor%0A%09avidemux/ADM_libraries/ADM_lavformat%20avidemux/ADM_osSupport%0A%09avidemux/ADM_toolkit%20avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3%0A%09avidemux/plugins/ADM_audiodecoder/ADM_ad_faad%0A%09avidemux/plugins/ADM_audiodecoder/ADM_ad_mad%0A%09avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis%20cmake&In-Reply-To=%3C200803101839.m2AIdQfT010339%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r3866 - in	branches/avidemux_2.5_branch_gruntster: avidemux	avidemux/ADM_audio avidemux/ADM_audiocodec	avidemux/ADM_audiofilter avidemux/ADM_core/include	avidemux/ADM_core/src avidemux/ADM_editor	avidemux/ADM_libraries/ADM_lavformat avidemux/ADM_osSupport	avidemux/ADM_toolkit avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3	avidemux/plugins/ADM_audiodecoder/ADM_ad_faad	avidemux/plugins/ADM_audiodecoder/ADM_ad_mad	avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis cmake">gruntster at mail.berlios.de
       </A><BR>
    <I>Mon Mar 10 19:39:26 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001128.html">[Avidemux-svn-commit] r3865 - in branches/avidemux_2.5_branch_gruntster: . avidemux avidemux/ADM_audiodevice avidemux/ADM_audiofilter avidemux/ADM_codecs avidemux/ADM_colorspace avidemux/ADM_core/include avidemux/ADM_core/src avidemux/ADM_filter avidemux/ADM_inputs/ADM_inpics avidemux/ADM_libraries/ADM_libmpeg2enc avidemux/ADM_libraries/ADM_libswscale avidemux/ADM_libraries/ADM_mplex avidemux/ADM_libraries/ADM_smjs avidemux/ADM_libraries/ADM_utilities avidemux/ADM_osSupport avidemux/ADM_outputs/oplug_avi avidemux/ADM_outputs/oplug_dummy avidemux/ADM_outputs/oplug_flv avidemux/ADM_outputs/oplug_mpeg avidemux/ADM_outputs/oplug_mpegFF avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2 avidemux/ADM_userInterfaces/ADM_GTK/ADM_ocr avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui avidemux/ADM_userInterfaces/ADM_com! monUI avidemux/ADM_video avidemux/ADM_videoFilter cmake
</A></li>
        <LI>Next message: <A HREF="001130.html">[Avidemux-svn-commit] r3867 - in	branches/avidemux_2.5_branch_gruntster: avidemux	avidemux/ADM_core/src avidemux/ADM_libraries/ADM_lavcodec	avidemux/ADM_osSupport avidemux/ADM_videoFilter cmake
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1129">[ date ]</a>
              <a href="thread.html#1129">[ thread ]</a>
              <a href="subject.html#1129">[ subject ]</a>
              <a href="author.html#1129">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: gruntster
Date: 2008-03-10 19:38:58 +0100 (Mon, 10 Mar 2008)
New Revision: 3866

Added:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_files.h
   branches/avidemux_2.5_branch_gruntster/cmake/ad_plugin.cmake
Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_channel_route.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_channel_route.h
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_audiodef.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audiogen.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/aviaudio.hxx
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_audiocodec.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_audiocodec.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_dca.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_lpcm.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_pluginLoad.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioeng_process.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_bridge.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_bridge.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_buildchain.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_mixer.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_mixer.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_default.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edAudio.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edAudio.hxx
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADMedAVIAUD.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_lavformat/movenc.c
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_osSupport/ADM_fileio.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/filesel.h
   branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_ad_a52.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_faad/ADM_ad_faad.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_faad/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_mad/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis/ADM_ad_vorbis.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/cmake/ADM_coreConfig.h.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/admCheckMiscLibs.cmake
Log:
[Merge] integrate changes from Mean's 2.5 branch (r3864)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_audiodef.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_audiodef.h	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_audiodef.h	2008-03-10 18:38:58 UTC (rev 3866)
@@ -32,6 +32,26 @@
     CHANNEL_LAST
 } CHANNEL_CONF;
 
+#define MAX_CHANNELS 9
+
+typedef enum 
+{
+	CH_INVALID=0,
+	CH_MONO,
+	CH_FRONT_LEFT,
+	CH_FRONT_RIGHT,
+	CH_FRONT_CENTER,
+	CH_REAR_LEFT,
+	CH_REAR_RIGHT,
+	CH_REAR_CENTER,
+	CH_SIDE_LEFT,
+	CH_SIDE_RIGHT,
+	CH_LFE
+}CHANNEL_TYPE;
+// returns true if channel mapping is identical
+bool ADM_audioCompareChannelMapping(WAVHeader *wh1, WAVHeader *wh2,CHANNEL_TYPE *map1,CHANNEL_TYPE *map2);
+
+
 typedef struct
 {
   const char    *desc;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audiogen.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audiogen.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/audiogen.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -531,4 +531,23 @@
     return 1;
 
 }
+/**
+ * 	\fn ADM_audioCompareChannelMapping
+ *  \brief return true if the two channel mapping are identical, false else.
+ */
+bool ADM_audioCompareChannelMapping(WAVHeader *wh1, WAVHeader *wh2,CHANNEL_TYPE *map1,CHANNEL_TYPE *map2)
+{
+	if(wh1-&gt;channels != wh2-&gt;channels) return false; // cannot be identical..
+		
+			for (int j = 0; j &lt; wh1-&gt;channels; j++)
+			{
+				if (map1[j] != map2[j]) 
+				{
+					return false;
+					
+				}
+			}
+	return true;
+}
+
 //

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/aviaudio.hxx
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/aviaudio.hxx	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/aviaudio.hxx	2008-03-10 18:38:58 UTC (rev 3866)
@@ -77,6 +77,7 @@
 class AVDMGenericAudioStream
 {
    	protected:
+   				
     #define SIZE_INTERNAL 64*1024 
 					uint8_t 	internalBuffer[2 * SIZE_INTERNAL];
 					float 	internalBuffer_float[SIZE_INTERNAL];
@@ -163,10 +164,14 @@
 										uint32_t *samples);
 		// Return 1 if needs special muxing mode (AAC)			
 			virtual uint8_t packetPerFrame( void)	{return 0;} 
+				// The channel mapping for this stream
+				// Only used by decoder...
+			virtual CHANNEL_TYPE *getChannelMapping(void) {if(_codec) return _codec-&gt;channelMapping; else return NULL;}
 }
 ;
+/* Describe the channel mapping */
 
-
+//
 uint8_t mpegAudioIdentify(uint8_t *ptr, uint32_t maxLookUp, WAVHeader *header, uint8_t *tokens=NULL);
 
 #endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_audiocodec.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_audiocodec.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_audiocodec.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -17,15 +17,14 @@
 #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
 #include &lt;string.h&gt;
-#include &quot;ADM_assert.h&quot;
 #include &lt;math.h&gt;
 
 #include &quot;config.h&quot;
+#include &quot;ADM_assert.h&quot;
 
 #include &quot;fourcc.h&quot;
 #include &quot;ADM_audio/aviaudio.hxx&quot;
 #include &quot;ADM_audiocodec/ADM_audiocodec.h&quot;
-#include &quot;ADM_audiofilter/audiofilter_channel_route.h&quot;
 #include &quot;ADM_libraries/ADM_libwrapper/libwrapper_global.h&quot;
 
 extern ADM_Audiocodec *ADM_ad_searchCodec(uint32_t fourcc,	WAVHeader *info,uint32_t extraLength,uint8_t *extraData);
@@ -128,15 +127,20 @@
 		printf(&quot;\n Unknown codec : %lu&quot;,fourcc);
 		out = (ADM_Audiocodec *) new ADM_AudiocodecUnknown(fourcc);
 	}
-        if(info-&gt;channels==1)
-        {
-            ch_route.input_type[0] = CH_MONO;
-        }else
-        {
-	   ch_route.input_type[0] = CH_FRONT_LEFT;
-	   ch_route.input_type[1] = CH_FRONT_RIGHT;
-        }
-
+	// For channel mapping, simple case we do it here so that the decoder does not have
+	// to worry.
+	// For more complicated case (channel &gt;2) , it is up to the decoder to do it...
+	switch(info-&gt;channels)
+	{
+			case 1: out-&gt;channelMapping[0] = CH_MONO;
+					break;
+			case 2: out-&gt;channelMapping[0] = CH_FRONT_LEFT;
+					out-&gt;channelMapping[1] = CH_FRONT_RIGHT;
+					break;
+			default:break;
+	
+	
+	}
 	return out;
 }
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_audiocodec.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_audiocodec.h	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_audiocodec.h	2008-03-10 18:38:58 UTC (rev 3866)
@@ -16,6 +16,7 @@
  ***************************************************************************/
 #ifndef ADMAUDIOCODEC
 #define ADMAUDIOCODEC
+
 #define SCRATCH_PAD_SIZE (100*1000*2)
 extern uint8_t scratchPad[];
 #define  ADMAC_BUFFER (48000*4)
@@ -33,6 +34,8 @@
 		virtual	uint8_t run(uint8_t *inptr, uint32_t nbIn, float *outptr, uint32_t *nbOut)=0;
 		virtual	uint8_t isCompressed(void)=0;
 		virtual	uint8_t isDecompressable(void)=0;
+		// Channel mapping, only input is used by the decoders..
+		CHANNEL_TYPE channelMapping[MAX_CHANNELS];
  };
 
 ADM_Audiocodec	*getAudioCodec(uint32_t fourcc, WAVHeader *info, uint32_t extra=0, uint8_t *extraData=NULL);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_dca.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_dca.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_dca.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -14,17 +14,13 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &quot;ADM_assert.h&quot;
 #include &lt;math.h&gt;
 
 #include &quot;config.h&quot;
-#include &quot;fourcc.h&quot;
+#include &quot;ADM_default.h&quot;
+
 #include &quot;ADM_audio/aviaudio.hxx&quot;
 #include &quot;ADM_audiocodec/ADM_audiocodec.h&quot;
-#include &quot;ADM_audiofilter/audiofilter_channel_route.h&quot;
 
 #include &quot;prefs.h&quot;
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_lpcm.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_lpcm.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_lpcm.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -16,29 +16,23 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-//#include &lt;sstream&gt;
-#include &quot;ADM_assert.h&quot;
+#include &quot;ADM_default.h&quot;
 #include &lt;math.h&gt;
 
-#include &quot;config.h&quot;
+
 #include &quot;avifmt.h&quot;
 #include &quot;avifmt2.h&quot;
-#include &quot;fourcc.h&quot;
-//#include &quot;ADM_audio/aviaudio.hxx&quot;
 #include &quot;ADM_audiocodec/ADM_audiocodec.h&quot;
-#include &quot;ADM_audiofilter/audiofilter_channel_route.h&quot;
 
+
 ADM_AudiocodecWavSwapped::ADM_AudiocodecWavSwapped( uint32_t fourcc ) : ADM_Audiocodec(fourcc)
 {
-	ch_route.input_type[0] = CH_FRONT_LEFT;
-	ch_route.input_type[1] = CH_FRONT_RIGHT;
-	ch_route.input_type[2] = CH_FRONT_CENTER;
-	ch_route.input_type[3] = CH_LFE;
-	ch_route.input_type[4] = CH_REAR_LEFT;
-	ch_route.input_type[5] = CH_REAR_RIGHT;
+	channelMapping[0] = CH_FRONT_LEFT;
+	channelMapping[1] = CH_FRONT_RIGHT;
+	channelMapping[2] = CH_FRONT_CENTER;
+	channelMapping[3] = CH_LFE;
+	channelMapping[4] = CH_REAR_LEFT;
+	channelMapping[5] = CH_REAR_RIGHT;
 }
 
 ADM_AudiocodecWavSwapped::~ADM_AudiocodecWavSwapped()

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_pluginLoad.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_pluginLoad.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_pluginLoad.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -44,7 +44,7 @@
 static uint8_t tryLoadingAudioPlugin(const char *file)
 {
 	ADM_ad_plugin blank;
-	printf(&quot;[ADM_ad_plugin] Scanning %s\n&quot;,ADM_GetFileName(file));
+	//printf(&quot;[ADM_ad_plugin] Scanning %s\n&quot;,ADM_GetFileName(file));
 	ADM_LibWrapper *wrapper=new ADM_LibWrapper;
 	 if(true!=wrapper-&gt;loadLibrary(file))
 	 {
@@ -91,10 +91,9 @@
  * 	\fn ADM_ad_loadPlugins
  *  \brief load all audio plugins
  */
-uint8_t ADM_ad_loadPlugins(void)
+uint8_t ADM_ad_loadPlugins(const char *path)
 {
 #define MAX_EXTERNAL_FILTER 50
-	  char *path=&quot;/home/fx/ADM_plugins&quot;;
 	  char *files[MAX_EXTERNAL_FILTER];
 	  uint32_t nbFile;
 	  

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/CMakeLists.txt	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/CMakeLists.txt	2008-03-10 18:38:58 UTC (rev 3866)
@@ -2,7 +2,7 @@
 	audiodeng_buildfilters.cpp  audioencoder_lavcodec.cpp  audioeng_process.cpp           audiofilter_film2pal.cpp   audiolib_sox.cpp
 	audioencoder_aften.cpp      audioencoder_pcm.cpp       audiofilter_bridge.cpp         audiofilter_limiter.cpp    audio_raw.cpp
 	audioencoder.cpp            audioencoder_twolame.cpp   audiofilter_buildchain.cpp     audiofilter_mixer.cpp
-	audioencoder_faac.cpp       audioencoder_vorbis.cpp    audiofilter_channel_route.cpp  audiofilter_normalize.cpp
+	audioencoder_faac.cpp       audioencoder_vorbis.cpp    audiofilter_normalize.cpp
 	audioencoder_lame.cpp       audioeng_buff.cpp          audiofilter_dolby.cpp          audiofilter_sox.cpp)
 	
 ADD_ADM_LIB_ALL_TARGETS(ADM_audiofilter ${ADMaudiofilter_SRCS})
@@ -21,4 +21,4 @@
 
 IF (USE_VORBIS)
 	ADD_SOURCE_CFLAGS(audioencoder_vorbis.cpp -I${VORBIS_INCLUDE_DIR})
-ENDIF (USE_VORBIS)
\ No newline at end of file
+ENDIF (USE_VORBIS)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -38,8 +38,7 @@
   tmpbuffer=new float[_wavheader-&gt;frequency*_wavheader-&gt;channels];
   tmphead=tmptail=0;
   eof_met=0;
-  ch_order[0] = CH_FRONT_LEFT;
-  ch_order[1] = CH_FRONT_RIGHT;
+  
 };
 /********************/
 AUDMEncoder::~AUDMEncoder()
@@ -134,27 +133,29 @@
 			nr = 0;
 	}
 }
-
-void AUDMEncoder::reorderChannels(float *data, uint32_t nb)
+/**
+ * 	\fn reorderChannels
+ *  \brief Reorder the channels
+ */
+void AUDMEncoder::reorderChannels(float *data, uint32_t nb,CHANNEL_TYPE *input,CHANNEL_TYPE *output)
 {
 	float tmp [_wavheader-&gt;channels];
 	static uint8_t reorder[MAX_CHANNELS];
 	static bool reorder_on;
 	
-	if (ch_route.mode &lt; 1) {
+	
 		reorder_on = 0;
 		int j = 0;
-
-		if (_wavheader-&gt;channels &gt; 2) {
+		// Should we reorder the channels (might be needed for encoder ?
+		if (_wavheader-&gt;channels &gt; 2) 
+		{
 			CHANNEL_TYPE *p_ch_type;
-			if (ch_route.copy)
- 				p_ch_type = ch_route.input_type;
-			else
- 				p_ch_type = ch_route.output_type;
-
-			for (int i = 0; i &lt; MAX_CHANNELS; i++) {
-				for (int c = 0; c &lt; _wavheader-&gt;channels; c++) {
-					if (p_ch_type[c] == ch_order[i]) {
+			for (int i = 0; i &lt; _wavheader-&gt;channels; i++) 
+			{
+				for (int c = 0; c &lt; _wavheader-&gt;channels; c++) 
+				{
+					if (input[c] == output[i]) 
+					{
 						if (j != c)
 							reorder_on = 1;
 						reorder[j++] = c;
@@ -162,9 +163,7 @@
 				}
 			}
 		}
-		if (ch_route.mode == 0)
-			ch_route.mode = 1;
-	}
+	
 
 	if (reorder_on)
 		for (int i = 0; i &lt; nb; i++) {

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.h	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.h	2008-03-10 18:38:58 UTC (rev 3866)
@@ -16,7 +16,6 @@
   \param param : An opaque structure that contains the codec specific configuration datas
 */
 #include &quot;audioeng_buildfilters.h&quot;
-#include &quot;audiofilter_channel_route.h&quot;
 
 typedef struct ADM_audioEncoderDescriptor
 {
@@ -56,10 +55,12 @@
     float          *tmpbuffer;
     uint8_t        refillBuffer(int minimum); // Mininum is in float
 
-    CHANNEL_TYPE ch_order[MAX_CHANNELS];
-    void reorderChannels(float *start, uint32_t nb);
+    
+    void reorderChannels(float *data, uint32_t nb,CHANNEL_TYPE *input,CHANNEL_TYPE *output);
 
     uint32_t       tmphead,tmptail;
+    // The encoder can remap the audio channel (or not). If so, let's store the the configuration here
+    CHANNEL_TYPE outputChannelMapping[MAX_CHANNELS];
   public:
     //
     uint32_t read(uint32_t len,uint8_t *buffer);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -40,18 +40,18 @@
   channels=instream-&gt;getInfo()-&gt;channels;
   switch(channels)
   {
-    case 1:ch_order[1] = CH_FRONT_LEFT;break;
+    case 1:outputChannelMapping[1] = CH_FRONT_LEFT;break;
     case 2:
-      ch_order[0] = CH_FRONT_LEFT;
-      ch_order[1] = CH_FRONT_RIGHT;
+    	outputChannelMapping[0] = CH_FRONT_LEFT;
+    	outputChannelMapping[1] = CH_FRONT_RIGHT;
       break;
     default :
-      ch_order[0] = CH_FRONT_CENTER;
-      ch_order[1] = CH_FRONT_LEFT;
-      ch_order[2] = CH_FRONT_RIGHT;
-      ch_order[3] = CH_REAR_LEFT;
-      ch_order[4] = CH_REAR_RIGHT;
-      ch_order[5] = CH_LFE;
+    	outputChannelMapping[0] = CH_FRONT_CENTER;
+    	outputChannelMapping[1] = CH_FRONT_LEFT;
+    	outputChannelMapping[2] = CH_FRONT_RIGHT;
+    	outputChannelMapping[3] = CH_REAR_LEFT;
+    	outputChannelMapping[4] = CH_REAR_RIGHT;
+    	outputChannelMapping[5] = CH_LFE;
   }
 };
 
@@ -207,7 +207,7 @@
           return 0; 
         }
         ADM_assert(tmptail&gt;=tmphead);
-        reorderChannels(&amp;(tmpbuffer[tmphead]),*samples);
+        reorderChannels(&amp;(tmpbuffer[tmphead]),*samples,_incoming-&gt;getChannelMapping(),outputChannelMapping);
         *len = faacEncEncode(_handle, (int32_t *)&amp;(tmpbuffer[tmphead]), _chunk, dest, FA_BUFFER_SIZE);
         if(!*len) 
         {

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -56,12 +56,12 @@
   _wavheader-&gt;encoding=WAV_OGG;
   _oldpos=0;
   _handle=(void *)new  vorbisStruct; 
-  ch_order[0] = CH_FRONT_LEFT;
-  ch_order[1] = CH_FRONT_RIGHT;
-  ch_order[2] = CH_REAR_LEFT;
-  ch_order[3] = CH_REAR_RIGHT;
-  ch_order[4] = CH_FRONT_CENTER;
-  ch_order[5] = CH_LFE;
+  outputChannelMapping[0] = CH_FRONT_LEFT;
+  outputChannelMapping[1] = CH_FRONT_RIGHT;
+  outputChannelMapping[2] = CH_REAR_LEFT;
+  outputChannelMapping[3] = CH_REAR_RIGHT;
+  outputChannelMapping[4] = CH_FRONT_CENTER;
+  outputChannelMapping[5] = CH_LFE;
 };
 
 
@@ -228,7 +228,7 @@
     float_samples=vorbis_analysis_buffer(&amp;VD, nbSample) ;
     int index=tmphead;
     // Put our samples in incoming buffer
-    reorderChannels(&amp;(tmpbuffer[tmphead]), nbSample);
+    reorderChannels(&amp;(tmpbuffer[tmphead]), nbSample,_incoming-&gt;getChannelMapping(),outputChannelMapping);
     for (int i = 0; i &lt; nbSample; i++)
       for (int j = 0; j &lt; _wavheader-&gt;channels; j++) {
       float_samples[j][i] = tmpbuffer[index++];

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioeng_process.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioeng_process.h	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioeng_process.h	2008-03-10 18:38:58 UTC (rev 3866)
@@ -61,7 +61,8 @@
     //! \param status Status of the fill operation
     virtual uint8_t fillIncomingBuffer(AUD_Status *status);
     //! length in float
-    uint32_t        _length; 
+    uint32_t        _length;
+    
   public:
 /** Constructor
     \param previous : Pointer to previous in chain filter 
@@ -86,5 +87,8 @@
 //! Rewind the stream to the beginning. Used mainly by the normalize filter 
         virtual   uint8_t    rewind(void)  ;
                   uint32_t   getLength(void) {return _length;};
+// Returns the channel mapping, by default it is the on from the previous
+// The value returned is an array up to MAX_CHANNELS                  
+        virtual   CHANNEL_TYPE    *getChannelMapping(void ) {return _previous-&gt;getChannelMapping();}
 };
 #endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_bridge.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_bridge.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_bridge.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -12,16 +12,10 @@
  *                                                                         *
  ***************************************************************************/
 
-#include &quot;config.h&quot;
 
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
+#include &quot;ADM_default.h&quot;
 #include &lt;math.h&gt;
 
-#include &quot;ADM_assert.h&quot;
-
-
 #include &quot;avifmt.h&quot;
 #include &quot;avifmt2.h&quot;
 // Needed for incoming ..
@@ -177,5 +171,15 @@
   }
   return 1;
 }
-
+/**
+ * 	\fn return _incoming-&gt;getChannelMapping();
+ * \brief since it is a bridge, we translate the filter channel mapping from the audiostream channel mapping
+ */
+CHANNEL_TYPE *AUDMAudioFilter_Bridge::getChannelMapping(void) 
+{
+	ADM_assert(_incoming);
+	CHANNEL_TYPE *chan=_incoming-&gt;getChannelMapping();
+	ADM_assert(chan);
+	return chan;
+}
 //EOF

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_bridge.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_bridge.h	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_bridge.h	2008-03-10 18:38:58 UTC (rev 3866)
@@ -31,6 +31,7 @@
                                                                                            // Output MAXIMUM max float value
                                                                                            // Not sample! float!
     virtual    uint8_t    rewind(void)  ;                                              // go back to the beginning
+    virtual CHANNEL_TYPE *getChannelMapping(void);
 };
 
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_buildchain.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_buildchain.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_buildchain.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -143,10 +143,7 @@
             mixer=new AUDMAudioFilterMixer( lastFilter,audioMixing);
             lastFilter = mixer;
             filtersFloat[filtercount++] = lastFilter;
-            ch_route.copy = 0;
-          } else
-            ch_route.copy = 1;
-
+          } 
     if (audioDRC)
           {
             AUDMAudioFilterLimiter *pdrc = NULL;
@@ -282,8 +279,6 @@
   AUDMAudioFilter         *lastFilter=NULL;
   AVDMGenericAudioStream  *output=NULL;
   AUDMEncoder             *tmpfilter=NULL;
-  ch_route.mode = 0;
-
 	// if audio is set to copy, we just return the first filter
   if(!audioProcessMode())
   {

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_channel_route.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_channel_route.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_channel_route.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -1,36 +0,0 @@
-//
-// C++ Implementation: audiofilter_channel_route
-//
-// Description: 
-//
-//
-// Author: Mihail Zenkov &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">kreator at tut.by</A>&gt;, (C) 2006
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-#include &lt;stdint.h&gt;
-#include &quot;ADM_audio/ADM_audiodef.h&quot;
-#include &quot;audiofilter_channel_route.h&quot;
-
-ChannelRoute ch_route;
-
-bool ChannelRoute::compareChType(WAVHeader *wh1, WAVHeader *wh2)
-{
-	static bool ret;
-	if (mode &lt; 1) {
-		int i = 0;
-		if (wh1-&gt;channels == wh2-&gt;channels)
-			for (int j = 0; j &lt; wh1-&gt;channels; j++)
-				if (input_type[i] == output_type[j]) {
-					i++;
-					if (i == wh1-&gt;channels) {
-						ret = 1;
-						return ret;
-					}
-					j = -1;
-				}
-		ret = 0;
-	}
-	return ret;
-}

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_channel_route.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_channel_route.h	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_channel_route.h	2008-03-10 18:38:58 UTC (rev 3866)
@@ -1,52 +0,0 @@
-//
-// C++ Interface: audiofilter_channel_route
-//
-// Description: 
-//
-//
-// Author: Mihail Zenkov &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">kreator at tut.by</A>&gt;, (C) 2006
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-#ifndef AUDM_CHANNEL_ROUTE_H
-#define AUDM_CHANNEL_ROUTE_H
-
-#define MAX_CHANNELS 9
-
-typedef enum 
-{
-	CH_INVALID=0,
-	CH_MONO,
-	CH_FRONT_LEFT,
-	CH_FRONT_RIGHT,
-	CH_FRONT_CENTER,
-	CH_REAR_LEFT,
-	CH_REAR_RIGHT,
-	CH_REAR_CENTER,
-	CH_SIDE_LEFT,
-	CH_SIDE_RIGHT,
-	CH_LFE
-}CHANNEL_TYPE;
-
-class ChannelRoute
-{
-public:
-	ChannelRoute() {}
-	~ChannelRoute() {}
-
-	bool compareChType(WAVHeader *wh1, WAVHeader *wh2);
-
-	CHANNEL_TYPE input_type[MAX_CHANNELS];
-	CHANNEL_TYPE output_type[MAX_CHANNELS];
-
-	/*	-1 get parm from each chunk
-		0 get parm from first chunk
-		1 all ready inited	 */
-	int8_t mode;
-	bool copy;
-};
-
-extern ChannelRoute ch_route;
-
-#endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_mixer.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_mixer.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_mixer.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -12,19 +12,13 @@
  *                                                                         *
  ***************************************************************************/
 
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;math.h&gt;
-
 #include &quot;ADM_default.h&quot;
 
 #include &quot;audioeng_process.h&quot;
 #include &quot;audiofilter_mixer.h&quot;
-#include &quot;audiofilter_channel_route.h&quot;
 #include &quot;audiofilter_dolby.h&quot;
+#include &lt;math.h&gt;
 
-
 AUDMAudioFilterMixer::AUDMAudioFilterMixer(AUDMAudioFilter *instream,CHANNEL_CONF out):AUDMAudioFilter (instream)
 {
     _output=out;
@@ -39,61 +33,61 @@
 	switch (_output) {
 		case CHANNEL_MONO:
 			_wavHeader.channels = 1;
-			ch_route.output_type[0] = CH_MONO;
+			outputChannelMapping[0] = CH_MONO;
 		break;
 		case CHANNEL_STEREO:
 			_wavHeader.channels = 2;
-			ch_route.output_type[0] = CH_FRONT_LEFT;
-			ch_route.output_type[1] = CH_FRONT_RIGHT;
+			outputChannelMapping[0] = CH_FRONT_LEFT;
+			outputChannelMapping[1] = CH_FRONT_RIGHT;
 		break;
 		case CHANNEL_2F_1R:
 			_wavHeader.channels = 3;
-			ch_route.output_type[0] = CH_FRONT_LEFT;
-			ch_route.output_type[1] = CH_FRONT_RIGHT;
-			ch_route.output_type[2] = CH_REAR_CENTER;
+			outputChannelMapping[0] = CH_FRONT_LEFT;
+			outputChannelMapping[1] = CH_FRONT_RIGHT;
+			outputChannelMapping[2] = CH_REAR_CENTER;
 		break;
 		case CHANNEL_3F:
 			_wavHeader.channels = 3;
-			ch_route.output_type[0] = CH_FRONT_LEFT;
-			ch_route.output_type[1] = CH_FRONT_RIGHT;
-			ch_route.output_type[2] = CH_FRONT_CENTER;
+			outputChannelMapping[0] = CH_FRONT_LEFT;
+			outputChannelMapping[1] = CH_FRONT_RIGHT;
+			outputChannelMapping[2] = CH_FRONT_CENTER;
 		break;
 		case CHANNEL_3F_1R:
 			_wavHeader.channels = 4;
-			ch_route.output_type[0] = CH_FRONT_LEFT;
-			ch_route.output_type[1] = CH_FRONT_RIGHT;
-			ch_route.output_type[2] = CH_REAR_CENTER;
-			ch_route.output_type[3] = CH_FRONT_CENTER;
+			outputChannelMapping[0] = CH_FRONT_LEFT;
+			outputChannelMapping[1] = CH_FRONT_RIGHT;
+			outputChannelMapping[2] = CH_REAR_CENTER;
+			outputChannelMapping[3] = CH_FRONT_CENTER;
 		break;
 		case CHANNEL_2F_2R:
 			_wavHeader.channels = 4;
-			ch_route.output_type[0] = CH_FRONT_LEFT;
-			ch_route.output_type[1] = CH_FRONT_RIGHT;
-			ch_route.output_type[2] = CH_REAR_LEFT;
-			ch_route.output_type[3] = CH_REAR_RIGHT;
+			outputChannelMapping[0] = CH_FRONT_LEFT;
+			outputChannelMapping[1] = CH_FRONT_RIGHT;
+			outputChannelMapping[2] = CH_REAR_LEFT;
+			outputChannelMapping[3] = CH_REAR_RIGHT;
 		break;
 		case CHANNEL_3F_2R:
 			_wavHeader.channels = 5;
-			ch_route.output_type[0] = CH_FRONT_LEFT;
-			ch_route.output_type[1] = CH_FRONT_RIGHT;
-			ch_route.output_type[2] = CH_REAR_LEFT;
-			ch_route.output_type[3] = CH_REAR_RIGHT;
-			ch_route.output_type[4] = CH_FRONT_CENTER;
+			outputChannelMapping[0] = CH_FRONT_LEFT;
+			outputChannelMapping[1] = CH_FRONT_RIGHT;
+			outputChannelMapping[2] = CH_REAR_LEFT;
+			outputChannelMapping[3] = CH_REAR_RIGHT;
+			outputChannelMapping[4] = CH_FRONT_CENTER;
 		break;
 		case CHANNEL_3F_2R_LFE:
 			_wavHeader.channels = 6;
-			ch_route.output_type[0] = CH_FRONT_LEFT;
-			ch_route.output_type[1] = CH_FRONT_RIGHT;
-			ch_route.output_type[2] = CH_REAR_LEFT;
-			ch_route.output_type[3] = CH_REAR_RIGHT;
-			ch_route.output_type[4] = CH_FRONT_CENTER;
-			ch_route.output_type[5] = CH_LFE;
+			outputChannelMapping[0] = CH_FRONT_LEFT;
+			outputChannelMapping[1] = CH_FRONT_RIGHT;
+			outputChannelMapping[2] = CH_REAR_LEFT;
+			outputChannelMapping[3] = CH_REAR_RIGHT;
+			outputChannelMapping[4] = CH_FRONT_CENTER;
+			outputChannelMapping[5] = CH_LFE;
 		break;
 		case CHANNEL_DOLBY_PROLOGIC:
 		case CHANNEL_DOLBY_PROLOGIC2:
 			_wavHeader.channels = 2;
-			ch_route.output_type[0] = CH_FRONT_LEFT;
-			ch_route.output_type[1] = CH_FRONT_RIGHT;
+			outputChannelMapping[0] = CH_FRONT_LEFT;
+			outputChannelMapping[1] = CH_FRONT_RIGHT;
 			DolbyInit();
 		break;
 	}
@@ -106,7 +100,14 @@
 //    printf(&quot;[mixer]Out   channels : %u : %u \n&quot;,_wavHeader.channels,ADM_channel_mixer[_output]);
 
 };
-
+/**
+ * 	\fn getChannelMapping
+ *  \brief That filter changes the channel mapping, output its own
+ */
+CHANNEL_TYPE    *AUDMAudioFilterMixer::getChannelMapping(void ) 
+{
+		return this-&gt;outputChannelMapping;
+}
 AUDMAudioFilterMixer::~AUDMAudioFilterMixer()
 {
 };
@@ -118,7 +119,7 @@
     
 }
 
-static int MNto1(float *in,float *out,uint32_t nbSample,uint32_t chan)
+static int MNto1(float *in,float *out,uint32_t nbSample,uint32_t chan,CHANNEL_TYPE *chanMap)
 {
 float sum;
 int den=(chan+1)&amp;0xfe;
@@ -135,13 +136,13 @@
     
 }
 
-static int MStereo(float *in,float *out,uint32_t nbSample,uint32_t chan)
+static int MStereo(float *in,float *out,uint32_t nbSample,uint32_t chan,CHANNEL_TYPE *chanMap)
 {
 	memset(out, 0, sizeof(float) * nbSample * 2);
 
 	for (int i = 0; i &lt; nbSample; i++) {
 		for (int c = 0; c &lt; chan; c++) {
-			switch (ch_route.input_type[c]) {
+			switch (chanMap[c]) {
 				case CH_MONO:
 				case CH_FRONT_CENTER:
 				case CH_REAR_CENTER:
@@ -168,13 +169,13 @@
 	return nbSample*2;
 }
 
-static int M2F1R(float *in,float *out,uint32_t nbSample,uint32_t chan)
+static int M2F1R(float *in,float *out,uint32_t nbSample,uint32_t chan,CHANNEL_TYPE *chanMap)
 {
 	memset(out, 0, sizeof(float) * nbSample * 3);
 
 	for (int i = 0; i &lt; nbSample; i++) {
 		for (int c = 0; c &lt; chan; c++) {
-			switch (ch_route.input_type[c]) {
+			switch (chanMap[c]) {
 				case CH_MONO:
 				case CH_FRONT_CENTER:
 					out[0]  += *in * 0.707;
@@ -213,13 +214,13 @@
 	return nbSample * 3;
 }
 
-static int M3F(float *in,float *out,uint32_t nbSample,uint32_t chan)
+static int M3F(float *in,float *out,uint32_t nbSample,uint32_t chan,CHANNEL_TYPE *chanMap)
 {
 	memset(out, 0, sizeof(float) * nbSample * 3);
 
 	for (int i = 0; i &lt; nbSample; i++) {
 		for (int c = 0; c &lt; chan; c++) {
-			switch (ch_route.input_type[c]) {
+			switch (chanMap[c]) {
 				case CH_MONO:
 				case CH_FRONT_CENTER:
 				case CH_REAR_CENTER:
@@ -249,13 +250,13 @@
 	return nbSample * 3;
 }
 
-static int M3F1R(float *in,float *out,uint32_t nbSample,uint32_t chan)
+static int M3F1R(float *in,float *out,uint32_t nbSample,uint32_t chan,CHANNEL_TYPE *chanMap)
 {
 	memset(out, 0, sizeof(float) * nbSample * 4);
 
 	for (int i = 0; i &lt; nbSample; i++) {
 		for (int c = 0; c &lt; chan; c++) {
-			switch (ch_route.input_type[c]) {
+			switch (chanMap[c]) {
 				case CH_MONO:
 				case CH_FRONT_CENTER:
 					out[3]  += *in;
@@ -294,13 +295,13 @@
 	return nbSample * 4;
 }
 
-static int M2F2R(float *in,float *out,uint32_t nbSample,uint32_t chan)
+static int M2F2R(float *in,float *out,uint32_t nbSample,uint32_t chan,CHANNEL_TYPE *chanMap)
 {
 	memset(out, 0, sizeof(float) * nbSample * 4);
 
 	for (int i = 0; i &lt; nbSample; i++) {
 		for (int c = 0; c &lt; chan; c++) {
-			switch (ch_route.input_type[c]) {
+			switch (chanMap[c]) {
 				case CH_MONO:
 				case CH_FRONT_CENTER:
 					out[0]  += *in * 0.707;
@@ -345,13 +346,13 @@
 	return nbSample * 4;
 }
 
-static int M3F2R(float *in,float *out,uint32_t nbSample,uint32_t chan)
+static int M3F2R(float *in,float *out,uint32_t nbSample,uint32_t chan,CHANNEL_TYPE *chanMap)
 {
 	memset(out, 0, sizeof(float) * nbSample * 5);
 
 	for (int i = 0; i &lt; nbSample; i++) {
 		for (int c = 0; c &lt; chan; c++) {
-			switch (ch_route.input_type[c]) {
+			switch (chanMap[c]) {
 				case CH_MONO:
 				case CH_FRONT_CENTER:
 					out[4]  += *in;
@@ -396,13 +397,13 @@
 	return nbSample * 5;
 }
 
-static int M3F2RLFE(float *in,float *out,uint32_t nbSample,uint32_t chan)
+static int M3F2RLFE(float *in,float *out,uint32_t nbSample,uint32_t chan,CHANNEL_TYPE *chanMap)
 {
 	memset(out, 0, sizeof(float) * nbSample * 6);
 
 	for (int i = 0; i &lt; nbSample; i++) {
 		for (int c = 0; c &lt; chan; c++) {
-			switch (ch_route.input_type[c]) {
+			switch (chanMap[c]) {
 				case CH_MONO:
 				case CH_FRONT_CENTER:
 					out[4]  += *in;
@@ -443,13 +444,13 @@
 	return nbSample * 6;
 }
 
-static int MDolbyProLogic(float *in,float *out,uint32_t nbSample,uint32_t chan)
+static int MDolbyProLogic(float *in,float *out,uint32_t nbSample,uint32_t chan,CHANNEL_TYPE *chanMap)
 {
 	memset(out, 0, sizeof(float) * nbSample * 2);
 
 	for (int i = 0; i &lt; nbSample; i++) {
 		for (int c = 0; c &lt; chan; c++) {
-			switch (ch_route.input_type[c]) {
+			switch (chanMap[c]) {
 				case CH_MONO:
 				case CH_FRONT_CENTER:
 				case CH_LFE:
@@ -487,13 +488,13 @@
 	return nbSample*2;
 }
 
-static int MDolbyProLogic2(float *in,float *out,uint32_t nbSample,uint32_t chan)
+static int MDolbyProLogic2(float *in,float *out,uint32_t nbSample,uint32_t chan,CHANNEL_TYPE *chanMap)
 {
 	memset(out, 0, sizeof(float) * nbSample * 2);
 
 	for (int i = 0; i &lt; nbSample; i++) {
 		for (int c = 0; c &lt; chan; c++) {
-			switch (ch_route.input_type[c]) {
+			switch (chanMap[c]) {
 				case CH_MONO:
 				case CH_FRONT_CENTER:
 				case CH_LFE:
@@ -538,7 +539,7 @@
 }
 
 
-typedef int MIXER(float *in,float *out,uint32_t nbSample,uint32_t chan)  ;
+typedef int MIXER(float *in,float *out,uint32_t nbSample,uint32_t chan,CHANNEL_TYPE *chanMap)  ;
 
 static MIXER *matrixCall[CHANNEL_LAST] = {
 NULL, MNto1, MStereo, M2F1R, M3F, M3F1R, M2F2R, M3F2R, M3F2RLFE, MDolbyProLogic, MDolbyProLogic2
@@ -586,13 +587,15 @@
     
 
     // Now do the downsampling
-	if (_output == CHANNEL_INVALID || ch_route.compareChType(&amp;_wavHeader, _previous-&gt;getInfo())) {
-		ch_route.copy = 1;
+	if (_output == CHANNEL_INVALID || true==ADM_audioCompareChannelMapping(&amp;_wavHeader, _previous-&gt;getInfo(),
+			_previous-&gt;getChannelMapping(),outputChannelMapping))
+	{
+		
 		rd= (uint32_t)MCOPY(&amp;_incomingBuffer[_head],output,available,input_channels);
-	} else {
-		ch_route.copy = 0;
+	} else 
+	{
 		MIXER *call=matrixCall[_output];
-		rd= (uint32_t)call(&amp;_incomingBuffer[_head],output,available,input_channels);
+		rd= (uint32_t)call(&amp;_incomingBuffer[_head],output,available,input_channels,_previous-&gt;getChannelMapping());
 	}
 
     _head+=available*input_channels;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_mixer.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_mixer.h	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_mixer.h	2008-03-10 18:38:58 UTC (rev 3866)
@@ -5,10 +5,14 @@
     protected:
         CHANNEL_CONF    _output;
         CHANNEL_CONF    _input;
+        // output channel mapping
+        CHANNEL_TYPE outputChannelMapping[MAX_CHANNELS];
     public:
 
       ~AUDMAudioFilterMixer();
       AUDMAudioFilterMixer(AUDMAudioFilter *instream,CHANNEL_CONF out);
       uint32_t   fill(uint32_t max,float *output,AUD_Status *status);
+      // That filter changes its output channel mapping...
+      virtual   CHANNEL_TYPE    *getChannelMapping(void );
 };
 #endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_default.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_default.h	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_default.h	2008-03-10 18:38:58 UTC (rev 3866)
@@ -34,4 +34,5 @@
 #endif
 
 #include &quot;ADM_mangle.h&quot;
+#include &quot;ADM_files.h&quot;
 #endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_files.h (from rev 3865, branches/avidemux_2.5_branch_mean_merged/avidemux/ADM_core/include/ADM_files.h)
===================================================================
--- branches/avidemux_2.5_branch_mean_merged/avidemux/ADM_core/include/ADM_files.h	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_files.h	2008-03-10 18:38:58 UTC (rev 3866)
@@ -0,0 +1,33 @@
+/** *************************************************************************
+             
+    \fn ADM_filest.h
+    \brief Helpers function to access configuration files
+                      
+    copyright            : (C) 2008 by mean
+    
+ ***************************************************************************/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_FILES_H
+#define ADM_FILES_H
+// Returns dir to ~/.avidemux, no need to free it
+char *ADM_getBaseDir(void);
+// Returns dir to ~/.avidemux/jobs, no need to free it
+char *ADM_getJobDir(void);
+// Returns dir to ~/.avidemux/custom, no need to free it
+char *ADM_getCustomDir(void);
+#ifdef __cplusplus
+/* Returns the full path relative to install dir i.e. /usr +base1/base2, needs to be deleted [] by caller */
+char *ADM_getInstallRelativePath(const char *base1, const char *base2=NULL,const char *base3=NULL);
+/* Returns the full path relative to .avidemux dir i.e. /home/fx/... +base1/base2 needs to be deleted []*/
+char *ADM_getHomeRelativePath(const char *base1, const char *base2=NULL,const char *base3=NULL);
+#endif
+uint8_t buildDirectoryContent(uint32_t *outnb,const char *base, char *jobName[],int maxElems,const char *ext);
+
+#endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -29,6 +29,12 @@
 #include &quot;ADM_toolkit/filesel.h&quot;
 #include &quot;ADM_toolkit/toolkit.hxx&quot;
 
+#if defined(__WIN32)
+  static const char *separator=&quot;\\&quot;; 
+#else
+  static const char *separator=&quot;/&quot;;
+#endif
+
 #undef fread
 #undef fwrite
 #undef fopen
@@ -62,12 +68,12 @@
   return fclose(file); 
 }
 //*****************************
-static char basedir[1024]={0};
-static char jobdir[1024]={0};
-static char customdir[1024]={0};
-int baseDirDone=0;
-int jobDirDone=0;
-int customDirDone=0;
+static char ADM_basedir[1024]={0};
+static char *ADM_jobdir=NULL;
+static char *ADM_customdir=NULL;
+static int baseDirDone=0;
+
+
 #ifdef __WIN32
 const char *ADM_DIR_NAME=&quot;\\avidemux&quot;;
 #else
@@ -82,23 +88,15 @@
 
 char *ADM_getCustomDir(void)
 {
-  if(customDirDone) return customdir;
-
-  char *rootDir;
-  rootDir=ADM_getBaseDir();
-  strncpy(customdir,rootDir,1023);
-#if defined(__WIN32)
-  strcat(customdir,&quot;\\custom&quot;); 
-#else
-  strcat(customdir,&quot;/custom&quot;);
-#endif
-  if(!ADM_mkdir(customdir))
+  if(ADM_customdir) return ADM_customdir;
+  ADM_customdir=ADM_getHomeRelativePath(&quot;custom&quot;);
+  
+  if(!ADM_mkdir(ADM_customdir))
   {
-    GUI_Error_HIG(&quot;Oops&quot;,&quot;can't create custom directory (%s).&quot;,customdir);
-                return NULL;
+	  printf(&quot;can't create custom directory (%s).\n&quot;,ADM_customdir);
+      return NULL;
   }
-  customDirDone=1;
-  return customdir;
+  return ADM_customdir;
 }
 /*
       Get the  directory where jobs are stored
@@ -106,24 +104,60 @@
 
 char *ADM_getJobDir(void)
 {
-  if(jobDirDone) return jobdir;
+	  if(ADM_jobdir) return ADM_jobdir;
+	  ADM_jobdir=ADM_getHomeRelativePath(&quot;jobs&quot;);
+	  
+	  if(!ADM_mkdir(ADM_jobdir))
+	  {
+		  printf(&quot;can't create custom directory (%s).\n&quot;,ADM_jobdir);
+	      return NULL;
+	  }
+	  return ADM_jobdir;
+}
+/**
+ * 	\fn ADM_getRelativePath
+ */
+static char *ADM_getRelativePath(const char *base0,const char *base1, const char *base2,const char *base3)
+{
+	char *result;
+	int length=strlen(base1);
+	if(base2) length+=strlen(base2);
+	if(base3) length+=strlen(base3);
 
-  char *rootDir;
-  rootDir=ADM_getBaseDir();
-  strncpy(jobdir,rootDir,1023);
-#if defined(__WIN32)
-  strcat(jobdir,&quot;\\jobs&quot;); 
-#else
-  strcat(jobdir,&quot;/jobs&quot;);
-#endif
-  if(!ADM_mkdir(jobdir))
-  {
-    GUI_Error_HIG(&quot;Oops&quot;,&quot;can't create job directory (%s).&quot;,jobdir);
-                return NULL;
-  }
-  jobDirDone=1;
-  return jobdir;
+	
+	
+	length+=strlen(base0);
+	length+=5; // Slashes + end 0
+	result=(char *)new char [length];
+	strcpy(result,base0);
+	strcat(result,separator);
+		
+	strcat(result,base1);
+	strcat(result,separator);
+	if(base2)
+	{
+		strcat(result,base2);
+		strcat(result,separator);
+		if(base3)
+		{
+			strcat(result,base3);
+			strcat(result,separator);
+		}
+	}
+	return result;
 }
+/**
+ * 	\fn char *ADM_getHomeRelativePath(const char *base1, const char *base2=NULL,const char *base3=NULL);
+ *  \brief Returns home directory +base 1 + base 2... The return value is a copy, and must be deleted []
+ */
+char *ADM_getHomeRelativePath(const char *base1, const char *base2,const char *base3)
+{
+	return ADM_getRelativePath(ADM_getBaseDir(),base1,base2,base3);
+}
+char *ADM_getInstallRelativePath(const char *base1, const char *base2,const char *base3)
+{
+	return ADM_getRelativePath(ADM_INSTALL_DIR,base1,base2,base3);
+}
 /*
       Get the root directory for .avidemux stuff
 ******************************************************/
@@ -133,7 +167,7 @@
 DIR *dir=NULL;
 char *home;
 //
-        if(baseDirDone) return basedir;
+        if(baseDirDone) return ADM_basedir;
 // Get the base directory
 #if defined(__WIN32)
         if( ! (home=getenv(&quot;USERPROFILE&quot;)) )
@@ -163,11 +197,11 @@
         delete [] dirname;
 
         // Now built the filename
-        strncpy(basedir,home,1023);
-        strncat(basedir,ADM_DIR_NAME,1023-strlen(basedir));
+        strncpy(ADM_basedir,home,1023);
+        strncat(ADM_basedir,ADM_DIR_NAME,1023-strlen(ADM_basedir));
         baseDirDone=1;
-        printf(&quot;Using %s as base directory for prefs/jobs/...\n&quot;,basedir);
-        return basedir;
+        printf(&quot;Using %s as base directory for prefs/jobs/...\n&quot;,ADM_basedir);
+        return ADM_basedir;
 }
 /*----------------------------------------
       Create a directory
@@ -206,6 +240,11 @@
               closedir(dir); 
               return 1;
 }
+/**
+ *  \fn buildDirectoryContent
+ * 	\brief Returns the content of a dir with the extension ext. The receiving array must be allocated by caller
+ * (just the array, not the names themselves)
+ */
 uint8_t buildDirectoryContent(uint32_t *outnb,const char *base, char *jobName[],int maxElems,const char *ext)
 {
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edAudio.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edAudio.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edAudio.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -21,20 +21,12 @@
  *                                                                         *
  ***************************************************************************/
 
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-//#include &lt;stream.h&gt;
-#include &quot;ADM_assert.h&quot;
+#include &quot;ADM_default.h&quot;
 #include &lt;math.h&gt;
-#include &quot;config.h&quot;
 #include &quot;avifmt.h&quot;
 #include &quot;avifmt2.h&quot;
 
-#include &quot;fourcc.h&quot;
 
-//#include &quot;aviaudio.hxx&quot;
-
 #include &quot;ADM_editor/ADM_edit.hxx&quot;
 #include &quot;ADM_editor/ADM_edAudio.hxx&quot;
 
@@ -51,7 +43,15 @@
 }
 // Build information
 //
-
+CHANNEL_TYPE *AVDMEditAudioStream::getChannelMapping(void)
+{
+#if 0
+	return _father-&gt;getChannelMapping();
+#else
+	return AVDMGenericAudioStream::getChannelMapping();
+#endif
+	
+}
 AVDMEditAudioStream::AVDMEditAudioStream (ADM_Composer * father)
 {
   uint32_t l = 0;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edAudio.hxx
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edAudio.hxx	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edAudio.hxx	2008-03-10 18:38:58 UTC (rev 3866)
@@ -30,4 +30,5 @@
 	virtual	uint8_t		getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
 	virtual	uint8_t		flushPacket(void);
 	virtual uint8_t		extraData(uint32_t *l,uint8_t **d);
+	virtual CHANNEL_TYPE *getChannelMapping(void);
 };

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADMedAVIAUD.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADMedAVIAUD.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADMedAVIAUD.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -47,6 +47,14 @@
 	return 1;
 
 }
+#if 0
+CHANNEL_TYPE *ADM_Composer::getChannelMapping(void)
+{
+	_VIDEOS *currentVideo;
+		currentVideo=&amp;_videos[AUDIOSEG];
+		return currentVideo-&gt;_audiostream-&gt;getChannelMapping();
+}
+#endif
 uint8_t ADM_Composer::getAudioPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
 {
 uint8_t r;	

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_lavformat/movenc.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_lavformat/movenc.c	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_lavformat/movenc.c	2008-03-10 18:38:58 UTC (rev 3866)
@@ -946,13 +946,21 @@
     put_be32(pb, 0x1);
 
     put_be32(pb, av_rescale_rnd(track-&gt;trackDuration, globalTimescale, track-&gt;timescale, AV_ROUND_UP)); /* duration   ... doesn't seem to effect psp */
-
-    // MEANX : NO put_be32(pb, track-&gt;cluster[0].cts); /* first pts is cts since dts is 0 */
-      put_be32(pb, 0x00000000);
+#if 1
+    // MEANX : NO 
+    put_be32(pb, 0x00000000);
+    put_be32(pb, 0x0001);
     // /MEANX
+#else
+    put_be32(pb, track-&gt;cluster[0].cts); /* first pts is cts since dts is 0 */
+    put_be32(pb, 0x00010000);
+#endif
+    
+     
+    
 
 
-    put_be32(pb, 0x0001); // MEANX put_be32(pb, 0x00010000);
+   // MEANX 
     return 0x24;
 }
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_osSupport/ADM_fileio.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_osSupport/ADM_fileio.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_osSupport/ADM_fileio.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -1,143 +1 @@
-/***************************************************************************
-                    
-    copyright            : (C) 2006 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot; 
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-    
-#include &lt;dirent.h&gt;
-#include &lt;errno.h&gt;
-#include &lt;sys/stat.h&gt;
-
-#include &lt;unistd.h&gt;
-
-#ifdef __MINGW32__
-#include &lt;glib.h&gt;
-#endif
-
-#include &quot;ADM_default.h&quot;
-
-
-#include &quot;ADM_toolkit/filesel.h&quot;
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-
-//*****************************
-static char basedir[1024]={0};
-static char jobdir[1024]={0};
-static char customdir[1024]={0};
-int baseDirDone=0;
-int jobDirDone=0;
-int customDirDone=0;
-#ifdef __WIN32
-const char *ADM_DIR_NAME=&quot;\\avidemux&quot;;
-#else
-const char *ADM_DIR_NAME=&quot;/.avidemux&quot;;
-#endif
-/*
-
-*/
-/*
-      Get the  directory where jobs are stored
-******************************************************/
-
-char *ADM_getCustomDir(void)
-{
-  if(customDirDone) return customdir;
-
-  char *rootDir;
-  rootDir=ADM_getBaseDir();
-  strncpy(customdir,rootDir,1023);
-#if defined(__WIN32)
-  strcat(customdir,&quot;\\custom&quot;); 
-#else
-  strcat(customdir,&quot;/custom&quot;);
-#endif
-  if(!ADM_mkdir(customdir))
-  {
-    GUI_Error_HIG(QT_TR_NOOP(&quot;Oops&quot;),QT_TR_NOOP(&quot;can't create custom directory (%s).&quot;),customdir);
-                return NULL;
-  }
-  customDirDone=1;
-  return customdir;
-}
-/*
-      Get the  directory where jobs are stored
-******************************************************/
-
-char *ADM_getJobDir(void)
-{
-  if(jobDirDone) return jobdir;
-
-  char *rootDir;
-  rootDir=ADM_getBaseDir();
-  strncpy(jobdir,rootDir,1023);
-#if defined(__WIN32)
-  strcat(jobdir,&quot;\\jobs&quot;); 
-#else
-  strcat(jobdir,&quot;/jobs&quot;);
-#endif
-  if(!ADM_mkdir(jobdir))
-  {
-    GUI_Error_HIG(QT_TR_NOOP(&quot;Oops&quot;),QT_TR_NOOP(&quot;can't create job directory (%s).&quot;),jobdir);
-                return NULL;
-  }
-  jobDirDone=1;
-  return jobdir;
-}
-/*
-      Get the root directory for .avidemux stuff
-******************************************************/
-char *ADM_getBaseDir(void)
-{
-char *dirname=NULL;
-DIR *dir=NULL;
-char *home;
-//
-        if(baseDirDone) return basedir;
-// Get the base directory
-#if defined(__WIN32)
-        if( ! (home=getenv(&quot;USERPROFILE&quot;)) )
-        {
-          GUI_Error_HIG(QT_TR_NOOP(&quot;Oops&quot;),QT_TR_NOOP(&quot;can't determine $USERPROFILE.&quot;));
-                    home=&quot;c:\\&quot;;
-        }
-
-#else
-        if( ! (home=getenv(&quot;HOME&quot;)) )
-        {
-          GUI_Error_HIG(QT_TR_NOOP(&quot;Oops&quot;),QT_TR_NOOP(&quot;can't determine $HOME.&quot;));
-                return NULL;
-        }
-#endif
-
- // Try to open the .avidemux directory
-        dirname=new char[strlen(home)+strlen(ADM_DIR_NAME)+2];
-        strcpy(dirname,home);
-        strcat(dirname,ADM_DIR_NAME);
-        if(!ADM_mkdir(dirname))
-        {
-          GUI_Error_HIG(QT_TR_NOOP(&quot;Oops&quot;),QT_TR_NOOP(&quot;Cannot create the .avidemux directory&quot;), NULL);
-                        delete [] dirname;
-                        return NULL;
-        }
-        delete [] dirname;
-
-        // Now built the filename
-        strncpy(basedir,home,1023);
-        strncat(basedir,ADM_DIR_NAME,1023-strlen(basedir));
-        baseDirDone=1;
-        printf(&quot;Using %s as base directory for prefs/jobs/...\n&quot;,basedir);
-        return basedir;
-}
+// RMED
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/filesel.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/filesel.h	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/filesel.h	2008-03-10 18:38:58 UTC (rev 3866)
@@ -25,12 +25,6 @@
 uint8_t FileSel_SelectRead(const char *title,char *target,uint32_t max, const char *source);
 uint8_t FileSel_SelectDir(const char *title,char *target,uint32_t max, const char *source);
 
-char *ADM_getBaseDir(void);
-char *ADM_getJobDir(void);
-char *ADM_getCustomDir(void);
 
-uint8_t buildDirectoryContent(uint32_t *outnb,const char *base, char *jobName[],int maxElems,const char *ext);
-//const char *GetFileName(const char *str);
-
 #endif
 //EOF

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -74,7 +74,7 @@
 extern void ADM_memStatInit( void );
 extern void ADM_memStatEnd( void );
 extern void getUIDescription(char*);
-extern uint8_t ADM_ad_loadPlugins(void);
+extern uint8_t ADM_ad_loadPlugins(const char *path);
 
 #ifdef __MINGW32__
 extern EXCEPTION_DISPOSITION exceptionHandler(struct _EXCEPTION_RECORD* pExceptionRec, void* pEstablisherFrame, struct _CONTEXT* pContextRecord, void* pDispatcherContext);
@@ -236,8 +236,19 @@
 	}
 	
 	ADM_dealloc(dynloadPath);
-	// Load audio codec plugin
-	ADM_ad_loadPlugins();
+	//***************Plugins *********************
+	// Load system wide audio decoder plugin
+	char *adPlugins=ADM_getInstallRelativePath(&quot;lib&quot;,&quot;ADM_plugins&quot;,&quot;audioDecoder&quot;);
+	ADM_ad_loadPlugins(adPlugins);
+	delete [] adPlugins;
+	// load local audio decoder plugins
+	adPlugins=ADM_getHomeRelativePath(&quot;plugins&quot;,&quot;audioDecoder&quot;);
+	ADM_ad_loadPlugins(adPlugins);
+	delete [] adPlugins;
+	//***************Plugins *********************
+	
+	
+	
     ADM_lavInit();
 #ifdef HAVE_AUDIO
     AVDM_audioInit();

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_ad_a52.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_ad_a52.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_ad_a52.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -16,7 +16,7 @@
  ***************************************************************************/
 #include &quot;ADM_default.h&quot;
 #include &quot;ADM_ad_plugin.h&quot;
-#include &quot;ADM_audiofilter/audiofilter_channel_route.h&quot;
+
 #ifdef USE_AC3
 extern &quot;C&quot; {
 #include &quot;ADM_liba52/a52.h&quot;
@@ -131,8 +131,8 @@
             break;
         }
 
-	if (ch_route.mode &lt; 1) {
-		CHANNEL_TYPE *p_ch_type = ch_route.input_type;
+
+		CHANNEL_TYPE *p_ch_type = channelMapping;
 		if (flags &amp; A52_LFE) {
 			*(p_ch_type++) = CH_LFE;
 		}
@@ -177,7 +177,7 @@
 			default:
 				ADM_assert(0);
 		}
-	}
+	
 
         sample_t level = 1, bias = 0;
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/CMakeLists.txt	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/CMakeLists.txt	2008-03-10 18:38:58 UTC (rev 3866)
@@ -6,5 +6,5 @@
 TARGET_LINK_LIBRARIES(ADM_ad_a52 ADM_liba52)
 
 # FIXME
-ADD_TARGET_CFLAGS(ADM_ad_a52 &quot;-I${CMAKE_BINARY_DIR}/config/cli&quot;)
-ADD_TARGET_CFLAGS(ADM_ad_a52 &quot;-I${CMAKE_SOURCE_DIR}/avidemux/ADM_audiocodec&quot;)
\ No newline at end of file
+INCLUDE(ad_plugin)
+ADM_audio_plugin(ADM_ad_a52)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_faad/ADM_ad_faad.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_faad/ADM_ad_faad.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_faad/ADM_ad_faad.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -17,7 +17,7 @@
 //
 #include &quot;ADM_default.h&quot;
 #include &quot;ADM_ad_plugin.h&quot;
-#include &quot;ADM_audiofilter/audiofilter_channel_route.h&quot;
+
 #include &quot;faad.h&quot;
 
 #define FAAD_BUFFER 2048
@@ -92,12 +92,12 @@
 			
 		}
 
-	ch_route.input_type[0] = CH_FRONT_CENTER;
-	ch_route.input_type[1] = CH_FRONT_LEFT;
-	ch_route.input_type[2] = CH_FRONT_RIGHT;
-	ch_route.input_type[3] = CH_REAR_LEFT;
-	ch_route.input_type[4] = CH_REAR_RIGHT;
-	ch_route.input_type[5] = CH_LFE;
+		channelMapping[0] = CH_FRONT_CENTER;
+		channelMapping[1] = CH_FRONT_LEFT;
+		channelMapping[2] = CH_FRONT_RIGHT;
+		channelMapping[3] = CH_REAR_LEFT;
+		channelMapping[4] = CH_REAR_RIGHT;
+		channelMapping[5] = CH_LFE;
 
 		printf(&quot;[FAAD]Faad decoder created\n&quot;);
 }

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_faad/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_faad/CMakeLists.txt	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_faad/CMakeLists.txt	2008-03-10 18:38:58 UTC (rev 3866)
@@ -3,5 +3,6 @@
 ADD_LIBRARY(ADM_ad_faad SHARED ${ADM_ad_faad_SRCS})
 
 # FIXME
-ADD_TARGET_CFLAGS(ADM_ad_faad &quot;-I${CMAKE_BINARY_DIR}/config/cli&quot;)
-ADD_TARGET_CFLAGS(ADM_ad_faad &quot;-I${CMAKE_SOURCE_DIR}/avidemux/ADM_audiocodec&quot;)
\ No newline at end of file
+TARGET_LINK_LIBRARIES(ADM_ad_faad  ${FAAD_LIBRARY_DIR})
+INCLUDE(ad_plugin)
+ADM_audio_plugin(ADM_ad_faad)
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_mad/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_mad/CMakeLists.txt	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_mad/CMakeLists.txt	2008-03-10 18:38:58 UTC (rev 3866)
@@ -11,5 +11,5 @@
 ADD_TARGET_CFLAGS(ADM_ad_Mad ${MAD_CFLAGS})
 
 # FIXME
-ADD_TARGET_CFLAGS(ADM_ad_Mad &quot;-I${CMAKE_BINARY_DIR}/config/cli&quot;)
-ADD_TARGET_CFLAGS(ADM_ad_Mad &quot;-I${CMAKE_SOURCE_DIR}/avidemux/ADM_audiocodec&quot;)
\ No newline at end of file
+INCLUDE(ad_plugin)
+ADM_audio_plugin(ADM_ad_Mad)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis/ADM_ad_vorbis.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis/ADM_ad_vorbis.cpp	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis/ADM_ad_vorbis.cpp	2008-03-10 18:38:58 UTC (rev 3866)
@@ -27,8 +27,8 @@
  ***************************************************************************/
 #include &quot;ADM_default.h&quot;
 #include &quot;ADM_ad_plugin.h&quot;
-#include &quot;ADM_audiofilter/audiofilter_channel_route.h&quot;
 
+
 #include &lt;vorbis/codec.h&gt;
 #include &quot;ADM_ad_vorbis.h&quot;
 
@@ -158,12 +158,12 @@
 	STRUCT-&gt;ampscale=1;
 	_init=1;
 
-	ch_route.input_type[0] = CH_FRONT_LEFT;
-	ch_route.input_type[1] = CH_FRONT_RIGHT;
-	ch_route.input_type[2] = CH_REAR_LEFT;
-	ch_route.input_type[3] = CH_REAR_RIGHT;
-	ch_route.input_type[4] = CH_FRONT_CENTER;
-	ch_route.input_type[5] = CH_LFE;
+	channelMapping[0] = CH_FRONT_LEFT;
+	channelMapping[1] = CH_FRONT_RIGHT;
+	channelMapping[2] = CH_REAR_LEFT;
+	channelMapping[3] = CH_REAR_RIGHT;
+	channelMapping[4] = CH_FRONT_CENTER;
+	channelMapping[5] = CH_LFE;
  }
  // This codec expects more or less one packet at a time !
  

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis/CMakeLists.txt	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis/CMakeLists.txt	2008-03-10 18:38:58 UTC (rev 3866)
@@ -2,6 +2,8 @@
 
 ADD_LIBRARY(ADM_ad_vorbis SHARED ${ADM_ad_vorbis_SRCS})
 
-# FIXME
-ADD_TARGET_CFLAGS(ADM_ad_vorbis &quot;-I${CMAKE_BINARY_DIR}/config/cli&quot;)
-ADD_TARGET_CFLAGS(ADM_ad_vorbis &quot;-I${CMAKE_SOURCE_DIR}/avidemux/ADM_audiocodec&quot;)
\ No newline at end of file
+# FIXME
+TARGET_LINK_LIBRARIES(ADM_ad_vorbis  ${VORBIS_LIBRARY_DIR})
+TARGET_LINK_LIBRARIES(ADM_ad_vorbis  ${VORBISENC_LIBRARY_DIR})
+INCLUDE(ad_plugin)
+ADM_audio_plugin(ADM_ad_vorbis)

Modified: branches/avidemux_2.5_branch_gruntster/cmake/ADM_coreConfig.h.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/ADM_coreConfig.h.cmake	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/cmake/ADM_coreConfig.h.cmake	2008-03-10 18:38:58 UTC (rev 3866)
@@ -1,6 +1,8 @@
 #ifndef ADM_CORE_H
 #define ADM_CORE_H
 
+#define ADM_INSTALL_DIR &quot;${ADM_INSTALL_DIR}&quot;
+
 // GCC - CPU
 #cmakedefine ADM_BIG_ENDIAN
 #cmakedefine ADM_CPU_64BIT

Copied: branches/avidemux_2.5_branch_gruntster/cmake/ad_plugin.cmake (from rev 3865, branches/avidemux_2.5_branch_mean_merged/cmake/ad_plugin.cmake)

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admCheckMiscLibs.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admCheckMiscLibs.cmake	2008-03-10 16:21:10 UTC (rev 3865)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admCheckMiscLibs.cmake	2008-03-10 18:38:58 UTC (rev 3866)
@@ -89,6 +89,7 @@
 ENDIF (GETTEXT)
 
 SET(ADM_LOCALE &quot;${CMAKE_INSTALL_PREFIX}/share/locale&quot;)
+SET(ADM_INSTALL_DIR &quot;${CMAKE_INSTALL_PREFIX}&quot;)
 
 MESSAGE(&quot;&quot;)
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001128.html">[Avidemux-svn-commit] r3865 - in branches/avidemux_2.5_branch_gruntster: . avidemux avidemux/ADM_audiodevice avidemux/ADM_audiofilter avidemux/ADM_codecs avidemux/ADM_colorspace avidemux/ADM_core/include avidemux/ADM_core/src avidemux/ADM_filter avidemux/ADM_inputs/ADM_inpics avidemux/ADM_libraries/ADM_libmpeg2enc avidemux/ADM_libraries/ADM_libswscale avidemux/ADM_libraries/ADM_mplex avidemux/ADM_libraries/ADM_smjs avidemux/ADM_libraries/ADM_utilities avidemux/ADM_osSupport avidemux/ADM_outputs/oplug_avi avidemux/ADM_outputs/oplug_dummy avidemux/ADM_outputs/oplug_flv avidemux/ADM_outputs/oplug_mpeg avidemux/ADM_outputs/oplug_mpegFF avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog avidemux/ADM_userInterfaces/ADM_GTK/ADM_filters avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2 avidemux/ADM_userInterfaces/ADM_GTK/ADM_ocr avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui avidemux/ADM_userInterfaces/ADM_com! monUI avidemux/ADM_video avidemux/ADM_videoFilter cmake
</A></li>
	<LI>Next message: <A HREF="001130.html">[Avidemux-svn-commit] r3867 - in	branches/avidemux_2.5_branch_gruntster: avidemux	avidemux/ADM_core/src avidemux/ADM_libraries/ADM_lavcodec	avidemux/ADM_osSupport avidemux/ADM_videoFilter cmake
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1129">[ date ]</a>
              <a href="thread.html#1129">[ thread ]</a>
              <a href="subject.html#1129">[ subject ]</a>
              <a href="author.html#1129">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
