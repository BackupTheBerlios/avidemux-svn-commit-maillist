<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r3851 - in	branches/avidemux_2.5_branch_gruntster/avidemux: .	ADM_core/include ADM_core/src ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2008-March/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3851%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster/avidemux%3A%20.%0A%09ADM_core/include%20ADM_core/src%20ADM_userInterfaces/ADM_GTK/ADM_gui2%0A%09ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk%0A%09ADM_userInterfaces/ADM_NONE/ADM_gui2%0A%09ADM_userInterfaces/ADM_QT4/ADM_gui&In-Reply-To=%3C200803080933.m289XKFj013717%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001113.html">
   <LINK REL="Next"  HREF="001115.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r3851 - in	branches/avidemux_2.5_branch_gruntster/avidemux: .	ADM_core/include ADM_core/src ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui</H1>
    <B>gruntster at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3851%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster/avidemux%3A%20.%0A%09ADM_core/include%20ADM_core/src%20ADM_userInterfaces/ADM_GTK/ADM_gui2%0A%09ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk%0A%09ADM_userInterfaces/ADM_NONE/ADM_gui2%0A%09ADM_userInterfaces/ADM_QT4/ADM_gui&In-Reply-To=%3C200803080933.m289XKFj013717%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r3851 - in	branches/avidemux_2.5_branch_gruntster/avidemux: .	ADM_core/include ADM_core/src ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui">gruntster at mail.berlios.de
       </A><BR>
    <I>Sat Mar  8 10:33:20 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001113.html">[Avidemux-svn-commit] r3850 - in	branches/avidemux_2.5_branch_gruntster/avidemux:	ADM_libraries/ADM_mplex plugins
</A></li>
        <LI>Next message: <A HREF="001115.html">[Avidemux-svn-commit] r3852 - in	branches/avidemux_2.5_branch_mean_merged/avidemux: .	ADM_core/include ADM_core/src ADM_libraries/ADM_mplex	ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui plugins	plugins/ADM_audiodecoder plugins/ADM_audiodecoder/ADM_ad_ac3	plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52	plugins/ADM_audiodecoder/ADM_ad_faad	plugins/ADM_audiodecoder/ADM_ad_mad	plugins/ADM_audiodecoder/ADM_ad_mad/ADM_libMad	plugins/ADM_audiodecoder/ADM_ad_vorbis
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1114">[ date ]</a>
              <a href="thread.html#1114">[ thread ]</a>
              <a href="subject.html#1114">[ subject ]</a>
              <a href="author.html#1114">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: gruntster
Date: 2008-03-08 10:33:15 +0100 (Sat, 08 Mar 2008)
New Revision: 3851

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_misc.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_win32.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/toolkit.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/file_none.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp
Log:
[Merge] integrate changes from 2.4 branch (r3833)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_misc.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_misc.h	2008-03-08 09:30:39 UTC (rev 3850)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_misc.h	2008-03-08 09:33:15 UTC (rev 3851)
@@ -72,7 +72,6 @@
 	#define SHTDN_REASON_FLAG_PLANNED 0x80000000
 
 	int shutdown_win32(void);
-	void getWorkingArea(uint32_t *width, uint32_t *height);
 #else
 	#include &lt;sys/resource.h&gt;
 #endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_win32.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_win32.cpp	2008-03-08 09:30:39 UTC (rev 3850)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_win32.cpp	2008-03-08 09:33:15 UTC (rev 3851)
@@ -396,39 +396,6 @@
 
 #define MONITOR_DEFAULTTONEAREST    0x00000002
 
-void getWorkingArea(uint32_t *width, uint32_t *height)
-{
-	typedef void* (WINAPI *MonitorFromWindow)(HWND hwnd, uint32_t dwFlags);
-	typedef bool (WINAPI *GetMonitorInfo)(void *hMonitor, LPMONITORINFO lpmi);
-
-	static HMODULE user32 = GetModuleHandle(&quot;user32.dll&quot;);
-	static MonitorFromWindow pMonitorFromWindow = (MonitorFromWindow)GetProcAddress(user32, &quot;MonitorFromWindow&quot;);
-	static GetMonitorInfo pGetMonitorInfo = (GetMonitorInfo)GetProcAddress(user32, &quot;GetMonitorInfoA&quot;);
-
-	if (pMonitorFromWindow == NULL)
-	{
-		RECT rect;
-
-		// Required for NT4 - no multi-monitor support
-		SystemParametersInfo(SPI_GETWORKAREA, 0, &amp;rect, 0);
-
-		*width = rect.right - rect.left;
-		*height = rect.bottom - rect.top;
-	}
-	else
-	{
-		void *hMonitor = pMonitorFromWindow(GetForegroundWindow(), MONITOR_DEFAULTTONEAREST);
-
-		MONITORINFO monitorInfo;
-
-		monitorInfo.cbSize = sizeof(MONITORINFO);
-		pGetMonitorInfo(hMonitor, &amp;monitorInfo);
-
-		*width = monitorInfo.rcWork.right - monitorInfo.rcWork.left;
-		*height = monitorInfo.rcWork.bottom - monitorInfo.rcWork.top;
-	}
-}
-
 void redirectStdoutToFile(void)
 {
 	// Don't redirect stdout and stderr if SDL hasn't already hijacked it.

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2008-03-08 09:30:39 UTC (rev 3850)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2008-03-08 09:33:15 UTC (rev 3851)
@@ -35,7 +35,7 @@
 #include &quot;gtkgui.h&quot;
 #include &quot;ADM_toolkit/toolkit.hxx&quot;
 
-uint8_t UI_getPhysicalScreenSize(uint32_t *w,uint32_t *h);
+extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h);
 
 
 #define WOD(x) lookup_widget (guiRootWindow,#x)
@@ -43,7 +43,7 @@
 void frame2time(uint32_t frame, uint32_t fps, uint16_t * hh, uint16_t * mm,
 	   uint16_t * ss, uint16_t * ms);
 
-static GtkWidget *guiRootWindow=NULL;
+GtkWidget *guiRootWindow=NULL;
 static GtkWidget *guiDrawingArea=NULL;
 static GtkWidget *guiSlider=NULL;
 
@@ -318,7 +318,7 @@
 		GUI_initCursor(  );
     
                 
-                UI_getPhysicalScreenSize(&amp;w,&amp;h); //gtk_widget_get_parent_window (guiRootWindow));
+                UI_getPhysicalScreenSize(guiRootWindow, &amp;w, &amp;h);
                 printf(&quot;The screen seems to be %u x %u px\n&quot;,w,h);
  
                 GUI_gtk_grow_off(1);
@@ -1276,7 +1276,6 @@
 extern char **global_argv;
 typedef gboolean GCALL       (void *);
 extern int automation(void );
-extern uint8_t UI_getPhysicalScreenSize(uint32_t *w,uint32_t *h);
 extern void initTranslator(void);
 
 int UI_Init(int argc, char **argv)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp	2008-03-08 09:30:39 UTC (rev 3850)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp	2008-03-08 09:33:15 UTC (rev 3851)
@@ -41,7 +41,7 @@
 void GUI_gtk_grow_off(int onff);
 
 extern GtkWidget *getDrawWidget(void);
-extern uint8_t UI_getPhysicalScreenSize(uint32_t *w, uint32_t *h);
+extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w, uint32_t *h);
 
 #ifdef ENABLE_WINDOW_SIZING_HACK
 extern int maxWindowWidth, maxWindowHeight; // from GUI_bindings.cpp
@@ -191,7 +191,7 @@
 	gtk_window_get_size(window, &amp;windowWidth, &amp;windowHeight);
 	gtk_widget_get_size_request(drawingArea, &amp;drawingWidth, &amp;drawingHeight);
 
-	UI_getPhysicalScreenSize(&amp;screenWidth, &amp;screenHeight);
+	UI_getPhysicalScreenSize(window, &amp;screenWidth, &amp;screenHeight);
 
 	// Take drawing area out of the equation, how much extra do we need for additional controls?
 	windowWidth -= drawingWidth;
@@ -223,9 +223,11 @@
 void UI_centreCanvasWindow(GtkWindow *window, GtkWidget *canvas, int newCanvasWidth, int newCanvasHeight)
 {
 	int winWidth, winHeight, widgetWidth, widgetHeight;
-	uint32_t resWidth, resHeight;
+	GdkScreen *screen = gdk_screen_get_default();
+	int monitorNo = gdk_screen_get_monitor_at_window(screen, GTK_WIDGET(window-&gt;transient_parent)-&gt;window);
+	GdkRectangle rect;
 
-	UI_getPhysicalScreenSize(&amp;resWidth, &amp;resHeight);
+	gdk_screen_get_monitor_geometry(screen, monitorNo, &amp;rect);
 	gtk_widget_get_size_request((GtkWidget*)canvas, &amp;widgetWidth, &amp;widgetHeight);
 	gtk_window_get_size(window, &amp;winWidth, &amp;winHeight);
 
@@ -236,6 +238,6 @@
 	winWidth += 10;
 	winHeight += 40;
 
-	gtk_window_move(window, ((int)resWidth - winWidth) / 2, ((int)resHeight - winHeight) / 2);
+	gtk_window_move(window, rect.x + (rect.width - winWidth) / 2, rect.y + (rect.height - winHeight) / 2);
 }
 // EOF

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/toolkit.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/toolkit.cpp	2008-03-08 09:30:39 UTC (rev 3850)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk/toolkit.cpp	2008-03-08 09:33:15 UTC (rev 3851)
@@ -24,8 +24,8 @@
 #endif
 
 
+extern GtkWidget *guiRootWindow;
 
-
 GtkWidget *GUI_PixmapButtonDefault(GdkWindow * window, const gchar ** xpm,
                                   const gchar * tooltip);
 GtkWidget *GUI_PixmapButton(GdkWindow * window, const gchar ** xpm,
@@ -186,26 +186,22 @@
     \fn UI_getPhysicalScreenSize
     \brief return the physical size of display in pixels
 */
-uint8_t UI_getPhysicalScreenSize(uint32_t *w, uint32_t *h)
+uint8_t UI_getPhysicalScreenSize(void *window, uint32_t *w, uint32_t *h)
 {
-#ifdef __WIN32
-	getWorkingArea(w, h);
-#else
-	static int inited = 0;
-	static int ww,hh;
+	GtkWindow* gtkWindow = (GtkWindow*)window;
+	GdkScreen *screen = gdk_screen_get_default();
 
-    if (!inited)
-    {      
-      GdkScreen* sc = gdk_screen_get_default();
-      ww = gdk_screen_get_width(sc);
-      hh = gdk_screen_get_height(sc);
-      inited = 1;
-    }
+	if (!gtkWindow)
+		gtkWindow = (GtkWindow*)guiRootWindow;
 
-    *w=ww;
-    *h=hh;
-#endif
+	int monitorNo = gdk_screen_get_monitor_at_window(screen, GTK_WIDGET(gtkWindow)-&gt;window);
+	GdkRectangle rect;
 
+	gdk_screen_get_monitor_geometry(screen, monitorNo, &amp;rect);
+
+	*w = rect.width;
+	*h = rect.height;
+
 	return 1;
 }
 //EOF

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/file_none.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/file_none.cpp	2008-03-08 09:30:39 UTC (rev 3850)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_gui2/file_none.cpp	2008-03-08 09:33:15 UTC (rev 3851)
@@ -29,7 +29,7 @@
 void GUI_FileSelWrite(const char *label, char * * name)
 {}
 
-uint8_t UI_getPhysicalScreenSize(uint32_t *w,uint32_t *h)
+uint8_t UI_getPhysicalScreenSize(void *window, uint32_t *w,uint32_t *h)
 {
   *w=*h=10000; 
 }
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2008-03-08 09:30:39 UTC (rev 3850)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2008-03-08 09:33:15 UTC (rev 3851)
@@ -42,7 +42,7 @@
 extern int global_argc;
 extern char **global_argv;
 
-extern uint8_t UI_getPhysicalScreenSize(uint32_t *w,uint32_t *h);
+extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h);
 extern int automation(void );
 extern void HandleAction(Action a);
 extern uint32_t encoderGetNbEncoder (void);
@@ -623,16 +623,16 @@
 
 	loadTranslator();
 
-	uint32_t w, h;
-
-	UI_getPhysicalScreenSize(&amp;w,&amp;h);
-	printf(&quot;The screen seems to be %u x %u px\n&quot;,w,h);
-
 	MainWindow *mw = new MainWindow();
 	mw-&gt;show();
 
 	QuiMainWindows = (QWidget*)mw;
 
+	uint32_t w, h;
+
+	UI_getPhysicalScreenSize(QuiMainWindows, &amp;w,&amp;h);
+	printf(&quot;The screen seems to be %u x %u px\n&quot;,w,h);
+
 	UI_QT4VideoWidget(mw-&gt;ui.frame_video);  // Add the widget that will handle video display
 	UI_updateRecentMenu();
 	setupMenus();

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp	2008-03-08 09:30:39 UTC (rev 3850)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/gui_none.cpp	2008-03-08 09:33:15 UTC (rev 3851)
@@ -23,7 +23,7 @@
 uint8_t UI_arrow_enabled(void) {return 1;}
 uint8_t UI_arrow_disabled(void) {return 1;}
 
-uint8_t UI_getPhysicalScreenSize(uint32_t *w,uint32_t *h)
+uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h)
 {
 	QRect qrect = QApplication::desktop()-&gt;availableGeometry();
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp	2008-03-08 09:30:39 UTC (rev 3850)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp	2008-03-08 09:33:15 UTC (rev 3851)
@@ -146,7 +146,7 @@
 PARAM_MUX muxMode = MUX_REGULAR;
 int muxParam = 0;
 
-extern uint8_t UI_getPhysicalScreenSize(uint32_t *w,uint32_t *h);
+extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h);
 extern uint8_t GUI_jobs(void);
 extern bool parseECMAScript(const char *name);
 void A_parseECMAScript(const char *name);
@@ -1060,7 +1060,7 @@
   
   /* Zoom out if needed */
   uint32_t phyW,phyH;
-  UI_getPhysicalScreenSize(&amp;phyW,&amp;phyH);
+  UI_getPhysicalScreenSize(NULL, &amp;phyW,&amp;phyH);
   if(phyW&lt;avifileinfo-&gt;width || phyH&lt;avifileinfo-&gt;height)
   {
       if(phyW&lt;avifileinfo-&gt;width/2 || phyH&lt;avifileinfo-&gt;height/2)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001113.html">[Avidemux-svn-commit] r3850 - in	branches/avidemux_2.5_branch_gruntster/avidemux:	ADM_libraries/ADM_mplex plugins
</A></li>
	<LI>Next message: <A HREF="001115.html">[Avidemux-svn-commit] r3852 - in	branches/avidemux_2.5_branch_mean_merged/avidemux: .	ADM_core/include ADM_core/src ADM_libraries/ADM_mplex	ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui plugins	plugins/ADM_audiodecoder plugins/ADM_audiodecoder/ADM_ad_ac3	plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52	plugins/ADM_audiodecoder/ADM_ad_faad	plugins/ADM_audiodecoder/ADM_ad_mad	plugins/ADM_audiodecoder/ADM_ad_mad/ADM_libMad	plugins/ADM_audiodecoder/ADM_ad_vorbis
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1114">[ date ]</a>
              <a href="thread.html#1114">[ thread ]</a>
              <a href="subject.html#1114">[ subject ]</a>
              <a href="author.html#1114">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
