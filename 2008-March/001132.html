<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r3869 - in	branches/avidemux_2.5_branch_gruntster: . avidemux	avidemux/ADM_core/src avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3	avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52	avidemux/plugins/ADM_audiodecoder/ADM_ad_faad cmake
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2008-March/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3869%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster%3A%20.%20avidemux%0A%09avidemux/ADM_core/src%20avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3%0A%09avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52%0A%09avidemux/plugins/ADM_audiodecoder/ADM_ad_faad%20cmake&In-Reply-To=%3C200803111821.m2BILxIQ011891%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001131.html">
   <LINK REL="Next"  HREF="001133.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r3869 - in	branches/avidemux_2.5_branch_gruntster: . avidemux	avidemux/ADM_core/src avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3	avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52	avidemux/plugins/ADM_audiodecoder/ADM_ad_faad cmake</H1>
    <B>gruntster at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3869%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster%3A%20.%20avidemux%0A%09avidemux/ADM_core/src%20avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3%0A%09avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52%0A%09avidemux/plugins/ADM_audiodecoder/ADM_ad_faad%20cmake&In-Reply-To=%3C200803111821.m2BILxIQ011891%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r3869 - in	branches/avidemux_2.5_branch_gruntster: . avidemux	avidemux/ADM_core/src avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3	avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52	avidemux/plugins/ADM_audiodecoder/ADM_ad_faad cmake">gruntster at mail.berlios.de
       </A><BR>
    <I>Tue Mar 11 19:21:59 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001131.html">[Avidemux-svn-commit] r3868 - in	branches/avidemux_2.5_branch_gruntster: . avidemux	avidemux/ADM_audiocodec avidemux/ADM_core/src	avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3	avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52	avidemux/plugins/ADM_audiodecoder/ADM_ad_faad	avidemux/plugins/ADM_audiodecoder/ADM_ad_mad	avidemux/plugins/ADM_audiodecoder/ADM_ad_mad/ADM_libMad	avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis cmake
</A></li>
        <LI>Next message: <A HREF="001133.html">[Avidemux-svn-commit] r3870 - in	branches/avidemux_2.5_branch_gruntster/avidemux:	ADM_audiocodec ADM_core/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1132">[ date ]</a>
              <a href="thread.html#1132">[ thread ]</a>
              <a href="subject.html#1132">[ subject ]</a>
              <a href="author.html#1132">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: gruntster
Date: 2008-03-11 19:21:46 +0100 (Tue, 11 Mar 2008)
New Revision: 3869

Modified:
   branches/avidemux_2.5_branch_gruntster/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_ad_a52.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_faad/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/cmake/Ts.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/ad_plugin.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/admCheckMiscLibs.cmake
Log:
[AudioDec] install plugins and core

Modified: branches/avidemux_2.5_branch_gruntster/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/CMakeLists.txt	2008-03-11 13:58:28 UTC (rev 3868)
+++ branches/avidemux_2.5_branch_gruntster/CMakeLists.txt	2008-03-11 18:21:46 UTC (rev 3869)
@@ -49,6 +49,12 @@
 	SET(USE_JOG 1)
 ENDIF (UNIX AND NOT APPLE)
 
+IF (WIN32)
+	SET(BIN_DIR .)
+ELSE (WIN32)
+	SET(BIN_DIR bin)
+ENDIF (WIN32)
+
 ########################################
 # Standard Avidemux defines
 ########################################
@@ -61,11 +67,9 @@
 SET(ADM_UI_GTK 1)
 SET(ADM_UI_QT4 1)
 
-SET(HAVE_AUDIO 1)
-SET(USE_MP3 1)
-SET(USE_AC3 1)
 SET(USE_FFMPEG 1)
 SET(USE_MJPEG 1)
+SET(ADM_INSTALL_DIR &quot;${CMAKE_INSTALL_PREFIX}&quot;)
 
 IF (NOT CMAKE_BUILD_TYPE)
 	SET(CMAKE_BUILD_TYPE &quot;Release&quot;)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp	2008-03-11 13:58:28 UTC (rev 3868)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_fileio.cpp	2008-03-11 18:21:46 UTC (rev 3869)
@@ -1,449 +1,492 @@
-/***************************************************************************
-                    
-    copyright            : (C) 2006 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;dirent.h&gt;
-#include &lt;errno.h&gt;
-#include &lt;sys/stat.h&gt;
-#include &lt;unistd.h&gt;
-
-#ifdef __MINGW32__
-#include &lt;glib.h&gt;
-#endif
-
-#include &quot;ADM_default.h&quot;
-#include &quot;ADM_toolkit/filesel.h&quot;
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-
-#if defined(__WIN32)
-  static const char *separator=&quot;\\&quot;; 
-#else
-  static const char *separator=&quot;/&quot;;
-#endif
-
-#undef fread
-#undef fwrite
-#undef fopen
-#undef fclose
-
-size_t ADM_fread (void *ptr, size_t size, size_t n, FILE *sstream)
-{
-  return fread(ptr,size,n,sstream);
-}
-
-size_t ADM_fwrite (void *ptr, size_t size, size_t n, FILE *sstream)
-{
-  return fwrite(ptr,size,n,sstream);
-}
-FILE  *ADM_fopen (const char *file, const char *mode)
-{
-  FILE *f;
-
-#ifdef __MINGW32__
-  gchar *retval = g_locale_from_utf8 (file, -1, NULL, NULL, NULL);
-  f=fopen(retval,mode);
-  g_free (retval);
-  return f;
-#else
-  return fopen(file,mode); 
-#endif
-}
-
-int    ADM_fclose (FILE *file)
-{
-  return fclose(file); 
-}
-//*****************************
-static char ADM_basedir[1024]={0};
-static char *ADM_jobdir=NULL;
-static char *ADM_customdir=NULL;
-static int baseDirDone=0;
-
-
-#ifdef __WIN32
-const char *ADM_DIR_NAME=&quot;\\avidemux&quot;;
-#else
-const char *ADM_DIR_NAME=&quot;/.avidemux&quot;;
-#endif
-/*
-
-*/
-/*
-      Get the  directory where jobs are stored
-******************************************************/
-
-char *ADM_getCustomDir(void)
-{
-  if(ADM_customdir) return ADM_customdir;
-  ADM_customdir=ADM_getHomeRelativePath(&quot;custom&quot;);
-  
-  if(!ADM_mkdir(ADM_customdir))
-  {
-	  printf(&quot;can't create custom directory (%s).\n&quot;,ADM_customdir);
-      return NULL;
-  }
-  return ADM_customdir;
-}
-/*
-      Get the  directory where jobs are stored
-******************************************************/
-
-char *ADM_getJobDir(void)
-{
-	  if(ADM_jobdir) return ADM_jobdir;
-	  ADM_jobdir=ADM_getHomeRelativePath(&quot;jobs&quot;);
-	  
-	  if(!ADM_mkdir(ADM_jobdir))
-	  {
-		  printf(&quot;can't create custom directory (%s).\n&quot;,ADM_jobdir);
-	      return NULL;
-	  }
-	  return ADM_jobdir;
-}
-/**
- * 	\fn ADM_getRelativePath
- */
-static char *ADM_getRelativePath(const char *base0,const char *base1, const char *base2,const char *base3)
-{
-	char *result;
-	int length=strlen(base1);
-	if(base2) length+=strlen(base2);
-	if(base3) length+=strlen(base3);
-
-	
-	
-	length+=strlen(base0);
-	length+=5; // Slashes + end 0
-	result=(char *)new char [length];
-	strcpy(result,base0);
-	strcat(result,separator);
-		
-	strcat(result,base1);
-	strcat(result,separator);
-	if(base2)
-	{
-		strcat(result,base2);
-		strcat(result,separator);
-		if(base3)
-		{
-			strcat(result,base3);
-			strcat(result,separator);
-		}
-	}
-	return result;
-}
-/**
- * 	\fn char *ADM_getHomeRelativePath(const char *base1, const char *base2=NULL,const char *base3=NULL);
- *  \brief Returns home directory +base 1 + base 2... The return value is a copy, and must be deleted []
- */
-char *ADM_getHomeRelativePath(const char *base1, const char *base2,const char *base3)
-{
-	return ADM_getRelativePath(ADM_getBaseDir(),base1,base2,base3);
-}
-char *ADM_getInstallRelativePath(const char *base1, const char *base2,const char *base3)
-{
-	return ADM_getRelativePath(ADM_INSTALL_DIR,base1,base2,base3);
-}
-/*
-      Get the root directory for .avidemux stuff
-******************************************************/
-char *ADM_getBaseDir(void)
-{
-	char *dirname=NULL;
-	DIR *dir=NULL;
-	char *home;
-
-	if(baseDirDone) return ADM_basedir;
-
-	// Get the base directory
-#if defined(__WIN32)
-	if(!(home = getenv(&quot;USERPROFILE&quot;)))
-	{
-		printf(&quot;Oops: can't determine $USERPROFILE.&quot;);
-		home=&quot;c:\\&quot;;
-	}
-#else
-	if(!(home = getenv(&quot;HOME&quot;)))
-	{
-		printf(&quot;Oops: can't determine $HOME.&quot;);
-		return NULL;
-	}
-#endif
-
-	// Try to open the .avidemux directory
-	dirname = new char[strlen(home) + strlen(ADM_DIR_NAME) + 2];
-	strcpy(dirname, home);
-	strcat(dirname, ADM_DIR_NAME);
-
-	if(!ADM_mkdir(dirname))
-	{
-		printf(&quot;Oops: cannot create the .avidemux directory&quot;, NULL);
-		delete [] dirname;
-		return NULL;
-	}
-
-	delete [] dirname;
-
-	// Now built the filename
-	strncpy(ADM_basedir,home,1023);
-	strncat(ADM_basedir,ADM_DIR_NAME,1023-strlen(ADM_basedir));
-	baseDirDone=1;
-	printf(&quot;Using %s as base directory for prefs/jobs/...\n&quot;, ADM_basedir);
-
-	return ADM_basedir;
-}
-/*----------------------------------------
-      Create a directory
-      If it already exists, do nothing
-------------------------------------------*/
-uint8_t ADM_mkdir(const char *dirname)
-{
-DIR *dir=NULL;
-              // Check it already exists ?
-              dir=opendir(dirname);
-              if(dir)
-              { 
-                  printf(&quot;Directory %s exists.Good.\n&quot;,dirname);
-                  closedir(dir);
-                  return 1;
-              }
-#ifdef __MINGW32__
-                if(mkdir(dirname))
-                {
-                    printf(&quot;Oops: mkdir failed on %s\n&quot;,dirname);   
-                    return 0;
-                }
-                
-#else    
-                char *sys=new char[strlen(dirname)+strlen(&quot;mkdir &quot;)+2];
-                strcpy(sys,&quot;mkdir &quot;);
-                strcat(sys,dirname);
-                printf(&quot;Creating dir :%s\n&quot;,sys);
-                system(sys);
-                delete [] sys;
-#endif		
-              if((dir=opendir(dirname))==NULL)
-                {
-                        return 0;
-                }
-              closedir(dir); 
-              return 1;
-}
-/**
- *  \fn buildDirectoryContent
- * 	\brief Returns the content of a dir with the extension ext. The receiving array must be allocated by caller
- * (just the array, not the names themselves)
- */
-uint8_t buildDirectoryContent(uint32_t *outnb,const char *base, char *jobName[],int maxElems,const char *ext)
-{
-
-DIR *dir;
-struct dirent *direntry;
-int dirmax=0,len;
-int extlen=strlen(ext);
-    ADM_assert(extlen);
-    
-         dir=opendir(base);
-        if(!dir)
-        {
-                return 0;
-        }
-        while((direntry=readdir(dir)))
-        {
-                len=strlen(direntry-&gt;d_name);
-                if(len&lt;(extlen+1)) continue;
-                int xbase=len-extlen;
-                if(memcmp(direntry-&gt;d_name+xbase,ext,extlen))
-                //if(direntry-&gt;d_name[len-1]!='s' || direntry-&gt;d_name[len-2]!='j' || direntry-&gt;d_name[len-3]!='.')
-                {
-                        printf(&quot;ignored:%s\n&quot;,direntry-&gt;d_name);
-                        continue;
-                }
-                jobName[dirmax]=(char *)ADM_alloc(strlen(base)+strlen(direntry-&gt;d_name)+2);
-                strcpy(jobName[dirmax],base);
-                strcat(jobName[dirmax],&quot;/&quot;);
-                strcat(jobName[dirmax],direntry-&gt;d_name);
-                dirmax++;
-                if(dirmax&gt;=maxElems)
-                {
-                        printf(&quot;[jobs]: Max # of jobs exceeded\n&quot;);
-                         break;
-                }
-        }
-        closedir(dir);
-        *outnb=dirmax;
-        return 1;
-}
-//------------------------------------------------------------------
-
-/*
-
-** note: it modifies it's first argument
-*/
-void simplify_path(char **buf){
-   unsigned int last1slash = 0;
-   unsigned int last2slash = 0;
-	while( !strncmp(*buf,&quot;/../&quot;,4) )
-		memmove(*buf,*buf+3,strlen(*buf+3)+1);
-	for(unsigned int i=0;i&lt;strlen(*buf)-2;i++)
-		while( !strncmp(*buf+i,&quot;/./&quot;,3) )
-			memmove(*buf+i,*buf+i+2,strlen(*buf+i+2)+1);
-	for(unsigned int i=0;i&lt;strlen(*buf)-3;i++){
-		if( *(*buf+i) == '/' ){
-			last2slash = last1slash;
-			last1slash = i;
-		}
-		if( !strncmp(*buf+i,&quot;/../&quot;,4) ){
-			memmove(*buf+last2slash,*buf+i+3,strlen(*buf+i+3)+1);
-			return simplify_path(buf);
-		}
-	}
-}
-
-/**
-        \fn ADM_PathCanonize
-        \brief Canonize the path, returns a copy of the absolute path given as parameter
-*/
-char *ADM_PathCanonize(const char *tmpname)
-{
-	char path[300];
-	char *out ;
-
-	if( ! getcwd(path,300) ){
-		fprintf(stderr,&quot;\ngetcwd() failed with: %s (%u)\n&quot;,
-		               strerror(errno), errno );
-		path[0] = '\0';
-	}
-	if(!tmpname || tmpname[0]==0)
-	{
-		out=new char [strlen(path)+2];
-		strcpy(out,path);
-#ifndef __WIN32		
-		strcat(out,&quot;/&quot;);
-#else
-		strcat(out,&quot;\\&quot;);
-#endif	
-		printf(&quot;\n Canonizing null string ??? (%s)\n&quot;,out);
-	}else if(tmpname[0]=='/'
-#if defined(__WIN32)
-		|| tmpname[1]==':'
-#endif	
-	
-	)
-	{
-		out=new char[strlen(tmpname)+1];
-		strcpy(out,tmpname);
-		return out;
-	}else{
-		out=new char[strlen(path)+strlen(tmpname)+6];
-		strcpy(out,path);
-#ifndef __WIN32		
-		strcat(out,&quot;/&quot;);
-#else
-		strcat(out,&quot;\\&quot;);
-#endif		
-		strcat(out,tmpname);
-	}
-	simplify_path(&amp;out);
-	return out;
-}
-
-/**
-        \fn ADM_PathStripName
-	\brief Returns path only /foo/bar.avi -&gt; /foo INPLACE, no copy done
-
-*/
-void		ADM_PathStripName(char *str)
-{
-		int len=strlen(str);
-		if(len&lt;=1) return;
-		len--;
-#ifndef __WIN32		
-		while( *(str+len)!='/' &amp;&amp; len)
-#else
-	while( *(str+len)!='\\' &amp;&amp; len)
-#endif		
-		{
-			 *(str+len)=0;
-			 len--;
-		}
-}
-
-/**
-    \fn ADM_GetFileName
-    \brief Get the filename without path. /foo/bar.avi -&gt; bar.avi INPLACE, NO COPY
-
-*/
-const char *ADM_GetFileName(const char *str)
-{
-	char *filename;
-        char *filename2;
-#ifndef __WIN32		
-	filename = strrchr(str, '/');
-        
-#else
-	filename = strrchr(str, '\\');
-        filename2 = strrchr(str, '/');
-        if(filename2 &amp;&amp; filename)
-        {
-          if(filename2&gt;filename) filename=filename2; 
-        }
-#endif
-	if (filename)
-		return filename+1;
-	else
-		return str;
-}
-
-/**
-    \fn ADM_PathSplit
-    \brief Split path into absolute path+name and extention i.e. /foo/bar/zee.avi -&gt; /foo/bar/zee,avi.             Copy are returned
-
-*/
-void ADM_PathSplit(char *str, char **root, char **ext)
-{
-	char *full;
-	uint32_t l;
-
-		full=ADM_PathCanonize(str);
-		// Search the last .
-		l=strlen(full);
-		l--;
-		ADM_assert(l&gt;0);
-		while( *(full+l)!='.' &amp;&amp; l) l--;
-		if(!l || l==(strlen(full)-1))
-		{
-			if(l==(strlen(full)-1))
-			{
-				*(full+l)=0;  // remove trailing .
-			}
-			*ext=new char[2];
-			*root=full;
-			strcpy(*ext,&quot;&quot;);
-			return ;
-		}
-		// else we do get an extension
-		// starting at l+1
-		uint32_t suff;
-
-		suff=strlen(full)-l-1;
-		*ext=new char[suff+1];
-		strcpy(*ext,full+l+1);
-		*(full+l)=0;
-		*root=full;
-		return ;
-}
+/***************************************************************************
+                    
+    copyright            : (C) 2006 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+#include &lt;dirent.h&gt;
+#include &lt;errno.h&gt;
+#include &lt;sys/stat.h&gt;
+#include &lt;unistd.h&gt;
+
+#ifdef __MINGW32__
+#include &lt;glib.h&gt;
+#endif
+
+#include &quot;ADM_default.h&quot;
+#include &quot;ADM_toolkit/filesel.h&quot;
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+
+#ifdef __WIN32
+static const char *separator=&quot;\\&quot;;
+const char *ADM_DIR_NAME=&quot;\\avidemux&quot;;
+#else
+static const char *separator=&quot;/&quot;;
+const char *ADM_DIR_NAME=&quot;/.avidemux&quot;;
+#endif
+
+static char ADM_basedir[1024] = {0};
+static char *ADM_jobdir = NULL;
+static char *ADM_customdir = NULL;
+static int baseDirDone = 0;
+
+#undef fread
+#undef fwrite
+#undef fopen
+#undef fclose
+
+size_t ADM_fread(void *ptr, size_t size, size_t n, FILE *sstream)
+{
+	return fread(ptr,size,n,sstream);
+}
+
+size_t ADM_fwrite(void *ptr, size_t size, size_t n, FILE *sstream)
+{
+	return fwrite(ptr,size,n,sstream);
+}
+
+FILE *ADM_fopen(const char *file, const char *mode)
+{
+	FILE *f;
+
+#ifdef __MINGW32__
+	gchar *retval = g_locale_from_utf8 (file, -1, NULL, NULL, NULL);
+	f=fopen(retval,mode);
+	g_free (retval);
+	return f;
+#else
+	return fopen(file,mode); 
+#endif
+}
+
+int ADM_fclose(FILE *file)
+{
+	return fclose(file); 
+}
+
+/*
+      Get the  directory where jobs are stored
+******************************************************/
+char *ADM_getCustomDir(void)
+{
+	if (ADM_customdir)
+		return ADM_customdir;
+
+	ADM_customdir = ADM_getHomeRelativePath(&quot;custom&quot;);
+
+	if (!ADM_mkdir(ADM_customdir))
+	{
+		printf(&quot;can't create custom directory (%s).\n&quot;, ADM_customdir);
+		return NULL;
+	}
+
+	return ADM_customdir;
+}
+
+/*
+      Get the  directory where jobs are stored
+******************************************************/
+char *ADM_getJobDir(void)
+{
+	if (ADM_jobdir)
+		return ADM_jobdir;
+
+	ADM_jobdir = ADM_getHomeRelativePath(&quot;jobs&quot;);
+
+	if (!ADM_mkdir(ADM_jobdir))
+	{
+		printf(&quot;can't create custom directory (%s).\n&quot;, ADM_jobdir);
+		return NULL;
+	}
+
+	return ADM_jobdir;
+}
+
+/**
+ * 	\fn ADM_getRelativePath
+ */
+static char *ADM_getRelativePath(const char *base0,const char *base1, const char *base2,const char *base3)
+{
+	char *result;
+	int length = strlen(base1);
+
+	if (base2)
+		length += strlen(base2);
+
+	if (base3)
+		length += strlen(base3);
+
+	length += strlen(base0);
+	length += 5; // Slashes + end 0
+	result = (char *)new char [length];
+	strcpy(result, base0);
+	strcat(result, separator);
+
+	strcat(result, base1);
+	strcat(result, separator);
+
+	if (base2)
+	{
+		strcat(result, base2);
+		strcat(result, separator);
+
+		if (base3)
+		{
+			strcat(result, base3);
+			strcat(result, separator);
+		}
+	}
+
+	return result;
+}
+
+/**
+ * 	\fn char *ADM_getHomeRelativePath(const char *base1, const char *base2=NULL,const char *base3=NULL);
+ *  \brief Returns home directory +base 1 + base 2... The return value is a copy, and must be deleted []
+ */
+char *ADM_getHomeRelativePath(const char *base1, const char *base2,const char *base3)
+{
+	return ADM_getRelativePath(ADM_getBaseDir(), base1, base2, base3);
+}
+
+char *ADM_getInstallRelativePath(const char *base1, const char *base2,const char *base3)
+{
+	return ADM_getRelativePath(ADM_INSTALL_DIR, base1, base2, base3);
+}
+
+/*
+      Get the root directory for .avidemux stuff
+******************************************************/
+char *ADM_getBaseDir(void)
+{
+	char *dirname = NULL;
+	DIR *dir = NULL;
+	char *home;
+
+	if (baseDirDone)
+		return ADM_basedir;
+
+	// Get the base directory
+#if defined(__WIN32)
+	if (!(home = getenv(&quot;USERPROFILE&quot;)))
+	{
+		printf(&quot;Oops: can't determine $USERPROFILE.&quot;);
+		home = NULL;
+	}
+#else
+	if (!(home = getenv(&quot;HOME&quot;)))
+	{
+		printf(&quot;Oops: can't determine $HOME.&quot;);
+		return NULL;
+	}
+#endif
+
+	// Try to open the .avidemux directory
+	dirname = new char[strlen(home) + strlen(ADM_DIR_NAME) + 2];
+	strcpy(dirname, home);
+	strcat(dirname, ADM_DIR_NAME);
+
+	if (!ADM_mkdir(dirname))
+	{
+		printf(&quot;Oops: cannot create the .avidemux directory&quot;, NULL);
+		delete [] dirname;
+		return NULL;
+	}
+
+	delete [] dirname;
+
+	// Now built the filename
+	strncpy(ADM_basedir,home, 1023);
+	strncat(ADM_basedir, ADM_DIR_NAME, 1023 - strlen(ADM_basedir));
+	baseDirDone = 1;
+	printf(&quot;Using %s as base directory for prefs/jobs/...\n&quot;, ADM_basedir);
+
+	return ADM_basedir;
+}
+
+/*----------------------------------------
+      Create a directory
+      If it already exists, do nothing
+------------------------------------------*/
+uint8_t ADM_mkdir(const char *dirname)
+{
+	DIR *dir = NULL;
+
+	// Check it already exists ?
+	dir = opendir(dirname);
+
+	if (dir)
+	{ 
+		printf(&quot;Directory %s exists.Good.\n&quot;, dirname);
+		closedir(dir);
+		return 1;
+	}
+
+#ifdef __MINGW32__
+	if (mkdir(dirname))
+	{
+		printf(&quot;Oops: mkdir failed on %s\n&quot;, dirname);   
+		return 0;
+	}
+#else
+	char *sys = new char[strlen(dirname) + strlen(&quot;mkdir &quot;) + 2];
+
+	strcpy(sys, &quot;mkdir &quot;);
+	strcat(sys, dirname);
+	printf(&quot;Creating dir :%s\n&quot;, sys);
+	system(sys);
+
+	delete [] sys;
+#endif
+	if ((dir = opendir(dirname)) == NULL)
+		return 0;
+
+	closedir(dir);
+
+	return 1;
+}
+/**
+ *  \fn buildDirectoryContent
+ * 	\brief Returns the content of a dir with the extension ext. The receiving array must be allocated by caller
+ * (just the array, not the names themselves)
+ */
+uint8_t buildDirectoryContent(uint32_t *outnb, const char *base, char *jobName[], int maxElems, const char *ext)
+{
+	DIR *dir;
+	struct dirent *direntry;
+	int dirmax = 0, len;
+	int extlen = strlen(ext);
+
+	ADM_assert(extlen);
+
+	dir = opendir(base);
+	if (!dir)
+		return 0;
+
+	while((direntry = readdir(dir)))
+	{
+		len = strlen(direntry-&gt;d_name);
+
+		if (len &lt; (extlen + 1))
+			continue;
+
+		int xbase = len - extlen;
+
+		if (memcmp(direntry-&gt;d_name + xbase, ext, extlen))
+			//if (direntry-&gt;d_name[len-1]!='s' || direntry-&gt;d_name[len-2]!='j' || direntry-&gt;d_name[len-3]!='.')
+		{
+			printf(&quot;ignored:%s\n&quot;, direntry-&gt;d_name);
+			continue;
+		}
+
+		jobName[dirmax] = (char *)ADM_alloc(strlen(base) + strlen(direntry-&gt;d_name) + 2);
+		strcpy(jobName[dirmax], base);
+		strcat(jobName[dirmax], &quot;/&quot;);
+		strcat(jobName[dirmax], direntry-&gt;d_name);
+		dirmax++;
+
+		if (dirmax &gt;= maxElems)
+		{
+			printf(&quot;[jobs]: Max # of jobs exceeded\n&quot;);
+			break;
+		}
+	}
+
+	closedir(dir);
+	*outnb = dirmax;
+
+	return 1;
+}
+//------------------------------------------------------------------
+
+/*
+
+** note: it modifies it's first argument
+*/
+void simplify_path(char **buf)
+{
+	unsigned int last1slash = 0;
+	unsigned int last2slash = 0;
+
+	while (!strncmp(*buf, &quot;/../&quot;, 4))
+		memmove(*buf, *buf + 3, strlen(*buf + 3) + 1);
+
+	for (unsigned int i = 0; i &lt; strlen(*buf) - 2; i++)
+		while (!strncmp(*buf + i, &quot;/./&quot;, 3))
+			memmove(*buf + i, *buf + i + 2, strlen(*buf + i + 2) + 1);
+
+	for (unsigned int i = 0; i &lt; strlen(*buf) - 3; i++)
+	{
+		if (*(*buf + i) == '/')
+		{
+			last2slash = last1slash;
+			last1slash = i;
+		}
+
+		if (!strncmp(*buf + i, &quot;/../&quot;, 4))
+		{
+			memmove(*buf + last2slash, *buf + i + 3, strlen(*buf + i + 3) + 1);
+
+			return simplify_path(buf);
+		}
+	}
+}
+
+/**
+        \fn ADM_PathCanonize
+        \brief Canonize the path, returns a copy of the absolute path given as parameter
+*/
+char *ADM_PathCanonize(const char *tmpname)
+{
+	char path[300];
+	char *out;
+
+	if (!getcwd(path, 300))
+	{
+		fprintf(stderr, &quot;\ngetcwd() failed with: %s (%u)\n&quot;, strerror(errno), errno);
+		path[0] = '\0';
+	}
+
+	if (!tmpname || tmpname[0] == 0)
+	{
+		out = new char[strlen(path) + 2];
+		strcpy(out, path);
+#ifndef __WIN32
+		strcat(out, &quot;/&quot;);
+#else
+		strcat(out, &quot;\\&quot;);
+#endif
+		printf(&quot;\n Canonizing null string ??? (%s)\n&quot;, out);
+	}
+	else if (tmpname[0] == '/'
+#if defined(__WIN32)
+		|| tmpname[1] == ':'
+#endif
+		)
+	{
+		out = new char[strlen(tmpname) + 1];
+		strcpy(out, tmpname);
+
+		return out;
+	}
+	else
+	{
+		out = new char[strlen(path) + strlen(tmpname) + 6];
+		strcpy(out, path);
+#ifndef __WIN32
+		strcat(out, &quot;/&quot;);
+#else
+		strcat(out, &quot;\\&quot;);
+#endif
+		strcat(out, tmpname);
+	}
+
+	simplify_path(&amp;out);
+
+	return out;
+}
+
+/**
+        \fn ADM_PathStripName
+	\brief Returns path only /foo/bar.avi -&gt; /foo INPLACE, no copy done
+
+*/
+void ADM_PathStripName(char *str)
+{
+	int len = strlen(str);
+
+	if (len &lt;= 1)
+		return;
+
+	len--;
+
+#ifndef __WIN32
+	while (*(str + len) != '/' &amp;&amp; len)
+#else
+	while (*(str + len) != '\\' &amp;&amp; len)
+#endif
+	{
+		*(str + len) = 0;
+		len--;
+	}
+}
+
+/**
+    \fn ADM_GetFileName
+    \brief Get the filename without path. /foo/bar.avi -&gt; bar.avi INPLACE, NO COPY
+
+*/
+const char *ADM_GetFileName(const char *str)
+{
+	char *filename;
+	char *filename2;
+
+#ifndef __WIN32
+	filename = strrchr(str, '/');
+#else
+	filename = strrchr(str, '\\');
+	filename2 = strrchr(str, '/');
+
+	if (filename2 &amp;&amp; filename)
+		if (filename2 &gt; filename)
+			filename = filename2;
+#endif
+
+	if (filename)
+		return filename + 1;
+	else
+		return str;
+}
+
+/**
+    \fn ADM_PathSplit
+    \brief Split path into absolute path+name and extention i.e. /foo/bar/zee.avi -&gt; /foo/bar/zee,avi.             Copy are returned
+
+*/
+void ADM_PathSplit(char *str, char **root, char **ext)
+{
+	char *full;
+	uint32_t l;
+
+	full = ADM_PathCanonize(str);
+	// Search the last
+	l = strlen(full);
+	l--;
+	ADM_assert(l &gt; 0);
+
+	while (*(full + l) != '.' &amp;&amp; l)
+		l--;
+
+	if (!l || l == (strlen(full) - 1))
+	{
+		if (l == (strlen(full) - 1))
+			*(full + l) = 0;  // remove trailing
+
+		*ext = new char[2];
+		*root = full;
+		strcpy(*ext, &quot;&quot;);
+
+		return;
+	}
+	// else we do get an extension
+	// starting at l+1
+	uint32_t suff;
+
+	suff = strlen(full) - l - 1;
+	*ext = new char[suff + 1];
+	strcpy(*ext, full + l + 1);
+	*(full + l) = 0;
+	*root = full;
+}

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/CMakeLists.txt	2008-03-11 13:58:28 UTC (rev 3868)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/CMakeLists.txt	2008-03-11 18:21:46 UTC (rev 3869)
@@ -12,4 +12,6 @@
 	TARGET_LINK_LIBRARIES(ADM_core pthreadGC2 imagehlp wsock32)
 ENDIF (MINGW)
 
-REMOVE_DEFINITIONS(-DHAVE_CONFIG_H)
\ No newline at end of file
+REMOVE_DEFINITIONS(-DHAVE_CONFIG_H)
+
+INSTALL(TARGETS ADM_core RUNTIME DESTINATION ${BIN_DIR} LIBRARY DESTINATION lib)
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt	2008-03-11 13:58:28 UTC (rev 3868)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt	2008-03-11 18:21:46 UTC (rev 3869)
@@ -531,4 +531,4 @@
 	SET(ADM_EXES ${ADM_EXES} avidemux2_qt4)
 ENDIF (ADM_UI_QT4)
 
-INSTALL(TARGETS ${ADM_EXES} RUNTIME DESTINATION bin LIBRARY DESTINATION lib)
+INSTALL(TARGETS ${ADM_EXES} RUNTIME DESTINATION ${BIN_DIR} LIBRARY DESTINATION lib)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_ad_a52.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_ad_a52.cpp	2008-03-11 13:58:28 UTC (rev 3868)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_ad_a52.cpp	2008-03-11 18:21:46 UTC (rev 3869)
@@ -17,7 +17,6 @@
 #include &quot;ADM_default.h&quot;
 #include &quot;ADM_ad_plugin.h&quot;
 
-#ifdef USE_AC3
 extern &quot;C&quot; {
 #include &quot;ADM_liba52/a52.h&quot;
 #include &quot;ADM_liba52/mm_accel.h&quot;
@@ -216,5 +215,3 @@
     return 1; 
 
 }
-
-#endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52/CMakeLists.txt	2008-03-11 13:58:28 UTC (rev 3868)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52/CMakeLists.txt	2008-03-11 18:21:46 UTC (rev 3869)
@@ -4,6 +4,7 @@
 	bit_allocate.c  bitstream.c  downmix.c  imdct.c  parse.c)
 
 ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})
+TARGET_LINK_LIBRARIES(${ADM_LIB} ADM_core)
 
 IF (UNIX)
 	ADD_TARGET_CFLAGS(${ADM_LIB} -fPIC)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/CMakeLists.txt	2008-03-11 13:58:28 UTC (rev 3868)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/CMakeLists.txt	2008-03-11 18:21:46 UTC (rev 3869)
@@ -3,7 +3,7 @@
 SET(ADM_ad_a52_SRCS ADM_ad_a52.cpp)
 
 ADD_LIBRARY(ADM_ad_a52 SHARED ${ADM_ad_a52_SRCS})
-TARGET_LINK_LIBRARIES(ADM_ad_a52 ADM_liba52)
+TARGET_LINK_LIBRARIES(ADM_ad_a52 ADM_core ADM_liba52)
 
 INCLUDE(ad_plugin)
 ADM_audio_plugin(ADM_ad_a52)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_faad/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_faad/CMakeLists.txt	2008-03-11 13:58:28 UTC (rev 3868)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_audiodecoder/ADM_ad_faad/CMakeLists.txt	2008-03-11 18:21:46 UTC (rev 3869)
@@ -2,7 +2,7 @@
 checkFaad()
 
 IF (HAVE_FAAD)
-	SET(ADM_ad_faad_SRCS ADM_ad_faad.cpp )
+	SET(ADM_ad_faad_SRCS ADM_ad_faad.cpp)
 
 	ADD_LIBRARY(ADM_ad_faad SHARED ${ADM_ad_faad_SRCS})
 	TARGET_LINK_LIBRARIES(ADM_ad_faad ADM_core ${FAAD_LIBRARY_DIR})

Modified: branches/avidemux_2.5_branch_gruntster/cmake/Ts.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/Ts.cmake	2008-03-11 13:58:28 UTC (rev 3868)
+++ branches/avidemux_2.5_branch_gruntster/cmake/Ts.cmake	2008-03-11 18:21:46 UTC (rev 3869)
@@ -64,7 +64,7 @@
                 
             SET(qm_files ${qm_files} ${_outXml} ${_out})
 
-			INSTALL(FILES ${_out} DESTINATION &quot;${CMAKE_INSTALL_PREFIX}/bin/i18n&quot;)
+			INSTALL(FILES ${_out} DESTINATION &quot;${CMAKE_INSTALL_PREFIX}/${BIN_DIR}/i18n&quot;)
         ENDFOREACH(ts_input ${ts_files})
 
         SET(${_sources} ${${_sources}} ${qm_files})
@@ -95,7 +95,7 @@
                 
             SET(qm_files ${qm_files} ${_out})
 
-			INSTALL(FILES ${_out} DESTINATION &quot;${CMAKE_INSTALL_PREFIX}/bin/i18n&quot;)
+			INSTALL(FILES ${_out} DESTINATION &quot;${CMAKE_INSTALL_PREFIX}/${BIN_DIR}/i18n&quot;)
         ENDFOREACH(ts_input ${ts_files})
 
         SET(${_sources} ${${_sources}} ${qm_files})

Modified: branches/avidemux_2.5_branch_gruntster/cmake/ad_plugin.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/ad_plugin.cmake	2008-03-11 13:58:28 UTC (rev 3868)
+++ branches/avidemux_2.5_branch_gruntster/cmake/ad_plugin.cmake	2008-03-11 18:21:46 UTC (rev 3869)
@@ -3,6 +3,5 @@
 	INCLUDE_DIRECTORIES(&quot;${CMAKE_SOURCE_DIR}/avidemux/ADM_core/include&quot;)
 	INCLUDE_DIRECTORIES(&quot;${CMAKE_SOURCE_DIR}/avidemux/ADM_audiocodec&quot;)
 
-	INSTALL(TARGETS ${_lib} LIBRARY DESTINATION &quot;${CMAKE_INSTALL_PREFIX}/lib/ADM_plugins/audioDecoder/&quot;)
+	INSTALL(TARGETS ${_lib} DESTINATION &quot;${CMAKE_INSTALL_PREFIX}/lib/ADM_plugins/audioDecoder/&quot;)
 ENDMACRO(ADM_audio_plugin)
-

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admCheckMiscLibs.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admCheckMiscLibs.cmake	2008-03-11 13:58:28 UTC (rev 3868)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admCheckMiscLibs.cmake	2008-03-11 18:21:46 UTC (rev 3869)
@@ -89,7 +89,6 @@
 ENDIF (GETTEXT)
 
 SET(ADM_LOCALE &quot;${CMAKE_INSTALL_PREFIX}/share/locale&quot;)
-SET(ADM_INSTALL_DIR &quot;${CMAKE_INSTALL_PREFIX}&quot;)
 
 MESSAGE(&quot;&quot;)
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001131.html">[Avidemux-svn-commit] r3868 - in	branches/avidemux_2.5_branch_gruntster: . avidemux	avidemux/ADM_audiocodec avidemux/ADM_core/src	avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3	avidemux/plugins/ADM_audiodecoder/ADM_ad_ac3/ADM_liba52	avidemux/plugins/ADM_audiodecoder/ADM_ad_faad	avidemux/plugins/ADM_audiodecoder/ADM_ad_mad	avidemux/plugins/ADM_audiodecoder/ADM_ad_mad/ADM_libMad	avidemux/plugins/ADM_audiodecoder/ADM_ad_vorbis cmake
</A></li>
	<LI>Next message: <A HREF="001133.html">[Avidemux-svn-commit] r3870 - in	branches/avidemux_2.5_branch_gruntster/avidemux:	ADM_audiocodec ADM_core/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1132">[ date ]</a>
              <a href="thread.html#1132">[ thread ]</a>
              <a href="subject.html#1132">[ subject ]</a>
              <a href="author.html#1132">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
