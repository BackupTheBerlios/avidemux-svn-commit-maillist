<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r3994 - in	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_encoder	ADM_outputs/oplug_avi ADM_outputs/oplug_dummy	ADM_outputs/oplug_flv ADM_outputs/oplug_mp4	ADM_outputs/oplug_mpeg ADM_outputs/oplug_mpegFF	ADM_outputs/oplug_ogm ADM_plugin	plugins/ADM_videoEncoder/ADM_vidEnc_x264
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2008-April/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3994%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster/avidemux%3A%20ADM_encoder%0A%09ADM_outputs/oplug_avi%20ADM_outputs/oplug_dummy%0A%09ADM_outputs/oplug_flv%20ADM_outputs/oplug_mp4%0A%09ADM_outputs/oplug_mpeg%20ADM_outputs/oplug_mpegFF%0A%09ADM_outputs/oplug_ogm%20ADM_plugin%0A%09plugins/ADM_videoEncoder/ADM_vidEnc_x264&In-Reply-To=%3C200804281509.m3SF9B7S028147%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001253.html">
   <LINK REL="Next"  HREF="001255.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r3994 - in	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_encoder	ADM_outputs/oplug_avi ADM_outputs/oplug_dummy	ADM_outputs/oplug_flv ADM_outputs/oplug_mp4	ADM_outputs/oplug_mpeg ADM_outputs/oplug_mpegFF	ADM_outputs/oplug_ogm ADM_plugin	plugins/ADM_videoEncoder/ADM_vidEnc_x264</H1>
    <B>gruntster at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3994%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster/avidemux%3A%20ADM_encoder%0A%09ADM_outputs/oplug_avi%20ADM_outputs/oplug_dummy%0A%09ADM_outputs/oplug_flv%20ADM_outputs/oplug_mp4%0A%09ADM_outputs/oplug_mpeg%20ADM_outputs/oplug_mpegFF%0A%09ADM_outputs/oplug_ogm%20ADM_plugin%0A%09plugins/ADM_videoEncoder/ADM_vidEnc_x264&In-Reply-To=%3C200804281509.m3SF9B7S028147%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r3994 - in	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_encoder	ADM_outputs/oplug_avi ADM_outputs/oplug_dummy	ADM_outputs/oplug_flv ADM_outputs/oplug_mp4	ADM_outputs/oplug_mpeg ADM_outputs/oplug_mpegFF	ADM_outputs/oplug_ogm ADM_plugin	plugins/ADM_videoEncoder/ADM_vidEnc_x264">gruntster at mail.berlios.de
       </A><BR>
    <I>Mon Apr 28 17:09:11 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001253.html">[Avidemux-svn-commit] r3993 -	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui
</A></li>
        <LI>Next message: <A HREF="001255.html">[Avidemux-svn-commit] r3995 - in	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_editor	ADM_encoder ADM_plugin ADM_script	plugins/ADM_videoEncoder/ADM_vidEnc_x264
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1254">[ date ]</a>
              <a href="thread.html#1254">[ thread ]</a>
              <a href="subject.html#1254">[ subject ]</a>
              <a href="author.html#1254">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: gruntster
Date: 2008-04-28 17:08:46 +0200 (Mon, 28 Apr 2008)
New Revision: 3994

Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encdivx2p.cpp
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_externalEncoder.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_externalEncoder.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encCopy.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encCopy.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encRequant.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encRequant.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encXvid4.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encXvid4.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encdivx.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encdivx.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg1.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmpeg2enc.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmpeg2enc.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encx264.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encx264.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encxvid.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encxvid.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encyv12.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encyv12.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_dummy/oplug_dummy.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mp4/oplug_mp4.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpeg/op_mpegpass.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_ogm/op_ogsaveprocess.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_plugin/ADM_vidEnc_plugin.h
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.h
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/interface.c
Log:
[x264] pass in and correctly process encode parameters

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_externalEncoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_externalEncoder.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_externalEncoder.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -22,15 +22,18 @@
 {
 	_plugin = getVideoEncoderPlugin(params-&gt;extra_param);
 	_openPass = false;
+	_logFileName = NULL;
 }
 
 externalEncoder::~externalEncoder()
 {
 	stop();
-	delete _plugin;
+
+	if (_logFileName)
+		delete [] _logFileName;
 }
 
-uint8_t externalEncoder::configure(AVDMGenericVideoStream *instream)
+uint8_t externalEncoder::configure(AVDMGenericVideoStream *instream, int useExistingLogFile)
 {
 	ADV_Info *info;
 
@@ -50,6 +53,10 @@
 	properties.height = _h;
 	properties.parWidth = instream-&gt;getPARWidth();
 	properties.parHeight = instream-&gt;getPARHeight();
+	properties.frameCount = info-&gt;nb_frames;
+	properties.fps1000 = info-&gt;fps1000;
+	properties.logFileName = _logFileName;
+	properties.useExistingLogFile = useExistingLogFile;
 
 	if (_plugin-&gt;open(_plugin-&gt;encoderId, &amp;properties))
 		return 1;
@@ -62,15 +69,22 @@
 	uint32_t l, f;
 	int outLength, videoFrameType;
 	int64_t ptsFrame;
-	vidEncEncodeParams params;
+	vidEncEncodeParameters params;
 
+	if (!_openPass &amp;&amp; !isDualPass())
+		if (startPass1() != ADM_VIDENC_ERR_SUCCESS)
+		{
+			printf (&quot;[externalEncoder] Error starting first pass\n&quot;);
+			return 0;
+		}
+
 	if (!_in-&gt;getFrameNumberNoAlloc(frame, &amp;l, _vbuffer, &amp;f))
 	{
-		printf (&quot;[VidEnc Plugin] Error: Cannot read incoming frame!\n&quot;);
+		printf (&quot;[externalEncoder] Error reading incoming frame\n&quot;);
 		return 0;
 	}
 
-	params.structSize = sizeof(vidEncEncodeParams);
+	params.structSize = sizeof(vidEncEncodeParameters);
 	params.frameData = _vbuffer-&gt;data;
 	params.frameDataSize = 0;
 	params.encodedData = out-&gt;data;
@@ -132,8 +146,11 @@
 
 uint8_t externalEncoder::startPass2(void)
 {
-	_openPass = (_plugin-&gt;finishPass(_plugin-&gt;encoderId) &amp;&amp; _plugin-&gt;beginPass(_plugin-&gt;encoderId));
+	if (_openPass)
+		_plugin-&gt;finishPass(_plugin-&gt;encoderId);
 
+	_openPass = (_plugin-&gt;beginPass(_plugin-&gt;encoderId) == ADM_VIDENC_ERR_SUCCESS);
+
 	return _openPass;
 }
 
@@ -160,5 +177,11 @@
 
 uint8_t externalEncoder::setLogFile(const char *p, uint32_t fr)
 {
+	if (_logFileName)
+		delete [] _logFileName;
+
+	_logFileName = new char[strlen(p) + 1];
+	strcpy(_logFileName, p);
+
 	return 1;
 }

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_externalEncoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_externalEncoder.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_externalEncoder.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -28,12 +28,13 @@
 private:
 	ADM_vidEnc_plugin *_plugin;
 	bool _openPass;
+	char* _logFileName;
 
 public:
 	externalEncoder(COMPRES_PARAMS *params);
 	~externalEncoder();
 	virtual uint8_t isDualPass(void);
-	virtual uint8_t configure(AVDMGenericVideoStream * instream);
+	virtual uint8_t configure(AVDMGenericVideoStream * instream, int useExistingLogFile);
 	virtual uint8_t encode(uint32_t frame, ADMBitstream *out);
 	virtual uint8_t hasExtraHeaderData(uint32_t *l, uint8_t **data);
 	virtual uint8_t setLogFile(const char *p, uint32_t fr);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -40,7 +40,7 @@
 
 typedef int _vidEncOpen(int encoderId, vidEncVideoProperties *properties);
 typedef int _vidEncBeginPass(int encoderId);
-typedef int _vidEncEncodeFrame(int encoderId, vidEncEncodeParams *encodeParams);
+typedef int _vidEncEncodeFrame(int encoderId, vidEncEncodeParameters *encodeParams);
 typedef int _vidFinishPass(int encoderId);
 typedef int _vidEncClose(int encoderId);
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/CMakeLists.txt	2008-04-28 15:08:46 UTC (rev 3994)
@@ -1,5 +1,5 @@
 SET(ADM_encoder_SRCS 
-	adm_encConfig.cpp  adm_encdivx2p.cpp  adm_encffmpeg1.cpp  adm_encmjpeg.cpp     adm_encoder.cpp     adm_encx264.cpp   adm_encxvid.cpp
+	adm_encConfig.cpp  adm_encffmpeg1.cpp  adm_encmjpeg.cpp     adm_encoder.cpp     adm_encx264.cpp   adm_encxvid.cpp
 	adm_encCopy.cpp    adm_encdivx.cpp    adm_encffmpeg.cpp   adm_encmpeg2enc.cpp  adm_encRequant.cpp  adm_encXvid4.cpp  adm_encyv12.cpp
 	ADM_pluginLoad.cpp ADM_externalEncoder.cpp)
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -456,6 +456,9 @@
 		vidEncOptions encodeOptions;
 		vidEncVideoProperties properties;
 
+		memset(&amp;properties, 0, sizeof(vidEncVideoProperties));
+		properties.structSize = sizeof(vidEncVideoProperties);
+
 		if (avifileinfo)
 		{
 			aviInfo info;
@@ -465,17 +468,10 @@
 			properties.height = info.height;
 			properties.parWidth = video_body-&gt;getPARWidth();
 			properties.parHeight = video_body-&gt;getPARHeight();
+			properties.frameCount = info.nb_frames;
+			properties.fps1000 = info.fps1000;
 		}
-		else
-		{
-			properties.width = 0;
-			properties.height = 0;
-			properties.parWidth = 0;
-			properties.parHeight = 0;
-		}
 
-		properties.structSize = sizeof(vidEncVideoProperties);
-
 		if (plugin-&gt;isConfigurable(plugin-&gt;encoderId))
 			if (plugin-&gt;configure(plugin-&gt;encoderId, &amp;properties))
 			{

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encCopy.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encCopy.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encCopy.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -99,7 +99,7 @@
 
 /****************************************************************/
 uint8_t
-EncoderCopy::configure (AVDMGenericVideoStream * instream)
+EncoderCopy::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   aviInfo info;
   _in = instream;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encCopy.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encCopy.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encCopy.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -33,7 +33,7 @@
     EncoderCopy (COMPRES_PARAMS * codecconfig);
    ~EncoderCopy ();		// can be called twice if needed ..
   virtual uint8_t isDualPass (void);
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t encode (uint32_t frame, ADMBitstream *out);
   virtual uint8_t setLogFile (const char *p, uint32_t fr);
   virtual uint8_t stop (void);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encRequant.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encRequant.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encRequant.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -107,7 +107,7 @@
 
 /****************************************************************/
 uint8_t
-EncoderRequant::configure (AVDMGenericVideoStream * instream)
+EncoderRequant::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   aviInfo info;
   _in = instream;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encRequant.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encRequant.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encRequant.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -30,7 +30,7 @@
           EncoderRequant (COMPRES_PARAMS * codecconfig);
           ~EncoderRequant ();		// can be called twice if needed ..
   virtual uint8_t isDualPass (void);
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t encode (uint32_t frame, ADMBitstream *out);
   virtual uint8_t setLogFile (const char *p, uint32_t fr);
   virtual uint8_t stop (void);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encXvid4.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encXvid4.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encXvid4.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -61,7 +61,7 @@
 };
 //--------------------------------
 uint8_t
-EncoderXvid4::configure (AVDMGenericVideoStream * instream)
+EncoderXvid4::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   ADM_assert (instream);
   ADV_Info *info;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encXvid4.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encXvid4.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encXvid4.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -42,7 +42,7 @@
     EncoderXvid4 (COMPRES_PARAMS * codecconfig);
    ~EncoderXvid4 ();		// can be called twice if needed ..
   virtual uint8_t isDualPass (void);
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
  
   virtual uint8_t encode (uint32_t frame, ADMBitstream *out);
   virtual uint8_t setLogFile (const char *p, uint32_t fr);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encdivx.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encdivx.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encdivx.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -54,7 +54,7 @@
 };
 //--------------------------------
 uint8_t
-EncoderDivx::configure (AVDMGenericVideoStream * instream)
+EncoderDivx::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   //  COMPRES_PARAMS par;
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encdivx.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encdivx.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encdivx.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -32,7 +32,7 @@
 public:
   EncoderDivx (DIVXConfig * conf);
   virtual uint8_t isDualPass (void);
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t encode (uint32_t frame, uint32_t * len, uint8_t * out,
 			  uint32_t * flags);
   virtual uint8_t setLogFile (const char *p, uint32_t fr);

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encdivx2p.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encdivx2p.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encdivx2p.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -1 +0,0 @@
-// Rmed

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -64,7 +64,7 @@
 
 }
 uint8_t
-EncoderFFMPEGHuff::configure (AVDMGenericVideoStream * instream)
+EncoderFFMPEGHuff::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   ADM_assert (instream);
   ADV_Info *info;
@@ -105,7 +105,7 @@
 
 }
 uint8_t
-EncoderFFMPEGFFHuff::configure (AVDMGenericVideoStream * instream)
+EncoderFFMPEGFFHuff::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   ADM_assert (instream);
   ADV_Info *info;
@@ -148,7 +148,7 @@
 
 }
 uint8_t
-EncoderFFMPEGFFV1::configure (AVDMGenericVideoStream * instream)
+EncoderFFMPEGFFV1::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   ADM_assert (instream);
   ADV_Info *info;
@@ -187,7 +187,7 @@
 
 }
 uint8_t
-EncodeFFMPEGSNow::configure (AVDMGenericVideoStream * instream)
+EncodeFFMPEGSNow::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   ADM_assert (instream);
   ADV_Info *info;
@@ -229,7 +229,7 @@
 
 }
 uint8_t
-EncoderFFMPEGDV::configure (AVDMGenericVideoStream * instream)
+EncoderFFMPEGDV::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   ADM_assert (instream);
   ADV_Info *info;
@@ -276,7 +276,7 @@
 
 }
 uint8_t
-EncoderFFMPEGFLV1::configure (AVDMGenericVideoStream * instream)
+EncoderFFMPEGFLV1::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   ADM_assert (instream);
   ADV_Info *info;
@@ -344,7 +344,7 @@
   return NULL;
 }
 //--------------------------------
-uint8_t EncoderFFMPEG::configure (AVDMGenericVideoStream * instream)
+uint8_t EncoderFFMPEG::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
 
   ADM_assert (instream);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -36,7 +36,7 @@
     stop ();
   };				// can be called twice if needed ..
   virtual uint8_t isDualPass (void);
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t encode (uint32_t frame,ADMBitstream *out);
   virtual uint8_t setLogFile (const char *p, uint32_t fr);
   virtual uint8_t stop (void);
@@ -71,7 +71,7 @@
   {
     return 0;
   };
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t setLogFile (const char *p, uint32_t fr)
   {
     UNUSED_ARG (p);
@@ -113,7 +113,7 @@
   {
     return 0;
   };
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t setLogFile (const char *p, uint32_t fr)
   {
     UNUSED_ARG (p);
@@ -156,7 +156,7 @@
   {
     return 0;
   };
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t setLogFile (const char *p, uint32_t fr)
   {
     UNUSED_ARG (p);
@@ -202,7 +202,7 @@
     EncoderFFMPEGMpeg1 (FF_CODEC_ID id, COMPRES_PARAMS * config);
     virtual ~ EncoderFFMPEGMpeg1 ();	// can be called twice if needed ..
   virtual uint8_t isDualPass (void);
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t encode (uint32_t frame, ADMBitstream *out);
   virtual uint8_t setLogFile (const char *p, uint32_t fr);
   virtual uint8_t stop (void);
@@ -227,7 +227,7 @@
   {
     return 0;
   };
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t setLogFile (const char *p, uint32_t fr)
   {
     UNUSED_ARG (p);
@@ -272,7 +272,7 @@
   {
     return 0;
   };
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t setLogFile (const char *p, uint32_t fr)
   {
     UNUSED_ARG (p);
@@ -314,7 +314,7 @@
   {
     return 0;
   };
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t setLogFile (const char *p, uint32_t fr)
   {
     UNUSED_ARG (p);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg1.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg1.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encffmpeg1.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -202,7 +202,7 @@
 
 //--------------------------------
 uint8_t
-EncoderFFMPEGMpeg1::configure (AVDMGenericVideoStream * instream)
+EncoderFFMPEGMpeg1::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
 
   ADM_assert (instream);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -63,7 +63,7 @@
 };
 //--------------------------------
 uint8_t
-EncoderMjpeg::configure (AVDMGenericVideoStream * instream)
+EncoderMjpeg::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   ADV_Info *info;
 //         int q,s;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmjpeg.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -35,7 +35,7 @@
   {
     return 0;
   };				// mjpeg is always monopass
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t encode (uint32_t frame, ADMBitstream *out);
   virtual uint8_t setLogFile (const char *p, uint32_t fr);	// for dual pass only
   virtual uint8_t stop (void);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmpeg2enc.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmpeg2enc.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmpeg2enc.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -191,7 +191,7 @@
 
 
 //--------------------------------
-uint8_t     EncoderMpeg2enc::configure (AVDMGenericVideoStream * instream)
+uint8_t     EncoderMpeg2enc::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
 
   ADM_assert (instream);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmpeg2enc.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmpeg2enc.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encmpeg2enc.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -46,7 +46,7 @@
     EncoderMpeg2enc (MPEG2ENC_ID id, COMPRES_PARAMS * config);
     virtual ~ EncoderMpeg2enc ();	// can be called twice if needed ..
     virtual uint8_t isDualPass (void);
-    virtual uint8_t configure (AVDMGenericVideoStream * instream);
+    virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
     virtual uint8_t encode (uint32_t frame, ADMBitstream *out);
     virtual uint8_t setLogFile (const char *p, uint32_t fr);
     virtual uint8_t stop (void);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -81,7 +81,7 @@
   };
   virtual ~ Encoder (void);
   virtual uint8_t isDualPass (void) = 0;
-  virtual uint8_t configure (AVDMGenericVideoStream * instream) = 0;
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile) = 0;
   virtual uint8_t encode (uint32_t frame, ADMBitstream * out) = 0;
   virtual uint8_t stop (void) = 0;
   virtual uint8_t setLogFile (const char *o, uint32_t frames) = 0;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encx264.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encx264.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encx264.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -75,7 +75,7 @@
 }
 //--------------------------------
 uint8_t
-EncoderX264::configure (AVDMGenericVideoStream * instream)
+EncoderX264::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   ADM_assert (instream);
   ADV_Info *info;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encx264.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encx264.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encx264.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -46,7 +46,7 @@
     EncoderX264 (COMPRES_PARAMS * conf);
    ~EncoderX264 ();
   virtual uint8_t isDualPass (void);	// mjpeg is always monopass
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t encode (uint32_t frame, ADMBitstream *out);
   virtual uint8_t setLogFile (const char *p, uint32_t fr);	// for dual pass only
   virtual uint8_t stop (void);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encxvid.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encxvid.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encxvid.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -68,7 +68,7 @@
 
 };
 //--------------------------------
-uint8_t EncoderXvid::configure (AVDMGenericVideoStream * instream)
+uint8_t EncoderXvid::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   ADM_assert (instream);
   ADV_Info *

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encxvid.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encxvid.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encxvid.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -41,7 +41,7 @@
     EncoderXvid (XVIDconfig * codecconfig);
    ~EncoderXvid ();		// can be called twice if needed ..
   virtual uint8_t isDualPass (void);
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t encode (uint32_t frame, uint32_t * len, uint8_t * out,
 			  uint32_t * flags);
   virtual uint8_t setLogFile (const char *p, uint32_t fr);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encyv12.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encyv12.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encyv12.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -46,7 +46,7 @@
 };
 //--------------------------------
 uint8_t
-EncoderYV12::configure (AVDMGenericVideoStream * instream)
+EncoderYV12::configure (AVDMGenericVideoStream * instream, int useExistingLogFile)
 {
   ADM_assert (instream);
   ADV_Info *info;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encyv12.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encyv12.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encyv12.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -33,7 +33,7 @@
   {
     return 0;
   };
-  virtual uint8_t configure (AVDMGenericVideoStream * instream);
+  virtual uint8_t configure (AVDMGenericVideoStream * instream, int useExistingLogFile);
   virtual uint8_t encode (uint32_t frame, ADMBitstream *out);
 
   virtual uint8_t stop (void);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -103,7 +103,7 @@
  encoding_gui-&gt;setPhasis(QT_TR_NOOP(&quot;Saving&quot;));
  // Set up our copy codec ...
   copy=new EncoderCopy(NULL);
-  if(!copy-&gt;configure(_incoming))
+  if(!copy-&gt;configure(_incoming, 0))
   {
       printf(&quot;Copy cannot [configure] \n&quot;);
       return 0;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_pack.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -132,7 +132,7 @@
  
  // Set up our copy codec ...
   copy=new EncoderCopy(NULL);
-  if(!copy-&gt;configure(_incoming))
+  if(!copy-&gt;configure(_incoming, 0))
   {
       printf(&quot;Copy cannot [configure] \n&quot;);
       return 0;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_avisavecopy_unpack.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -106,7 +106,7 @@
  
  // Set up our copy codec ...
   copy=new EncoderCopy(NULL);
-  if(!copy-&gt;configure(_incoming))
+  if(!copy-&gt;configure(_incoming, 0))
   {
       printf(&quot;Copy cannot [configure] \n&quot;);
       return 0;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_avi/op_saveprocess.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -78,10 +78,24 @@
   TwoPassLogFile=new char[strlen(name)+6];
   strcpy(TwoPassLogFile,name);
   strcat(TwoPassLogFile,&quot;.stat&quot;);
- _encode-&gt;setLogFile(TwoPassLogFile,frametogo);
+  _encode-&gt;setLogFile(TwoPassLogFile,frametogo);
+
+  int reuse = 0;
+
+  if (_encode-&gt;isDualPass())
+  {
+	  FILE *tmp;
+
+	  if ((tmp = fopen(TwoPassLogFile,&quot;rt&quot;)))
+	  {
+		  fclose(tmp);
+
+		  if (GUI_Question(QT_TR_NOOP(&quot;Reuse the existing log file?&quot;)))
+			  reuse = 1;
+	  }
+  }
  
- 
-  if (!_encode-&gt;configure (_incoming))
+  if (!_encode-&gt;configure (_incoming, reuse))
     {
       delete 	_encode;
       _encode = NULL;
@@ -109,22 +123,9 @@
     {
       uint8_t *buffer;
       uint32_t len, flag;
-      FILE *tmp;
-	uint8_t reuse=0;
 
  	aprintf(&quot;\n** Dual pass encoding**\n&quot;);
 
-	
-	
-	if((tmp=fopen(TwoPassLogFile,&quot;rt&quot;)))
-	{
-		fclose(tmp);
-                if(GUI_Question(QT_TR_NOOP(&quot;\n Reuse the existing log-file ?&quot;)))
-		{
-			reuse=1;
-		}
-	}
-	
 	if(!reuse)
  	{
 	

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_dummy/oplug_dummy.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_dummy/oplug_dummy.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_dummy/oplug_dummy.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -138,7 +138,7 @@
                 else
                         encoding_gui-&gt;setCodec(_encode-&gt;getDisplayName());
                 
-                if (!_encode-&gt;configure (_incoming))
+                if (!_encode-&gt;configure (_incoming, 0))
                 {
                       GUI_Error_HIG (QT_TR_NOOP(&quot;Filter init failed&quot;), NULL);
                      goto  stopit;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_flv/oplug_flv.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -190,7 +190,7 @@
                 else
                         encoding_gui-&gt;setCodec(_encode-&gt;getDisplayName());
                 
-                if (!_encode-&gt;configure (_incoming))
+                if (!_encode-&gt;configure (_incoming, 0))
                 {
                       GUI_Error_HIG (QT_TR_NOOP(&quot;Filter init failed&quot;), NULL);
                      goto  stopit;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mp4/oplug_mp4.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mp4/oplug_mp4.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mp4/oplug_mp4.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -66,7 +66,7 @@
 static char *twoFake=NULL;
 
 extern AVDMGenericAudioStream *mpt_getAudioStream(void);
-uint8_t prepareDualPass(uint32_t bufferSize,uint8_t *buffer,char *TwoPassLogFile,DIA_encoding *encoding_gui,Encoder *_encode,uint32_t total);
+uint8_t prepareDualPass(uint32_t bufferSize,uint8_t *buffer,DIA_encoding *encoding_gui,Encoder *_encode,uint32_t total,int reuse);
 uint8_t extractVolHeader(uint8_t *data,uint32_t dataSize,uint32_t *headerSize);
 extern void    UI_purge(void );
 /*
@@ -114,6 +114,8 @@
 uint32_t    totalAudioSize=0;
 uint32_t sent=0;
 const char *containerTitle;
+int reuse = 0;
+
            switch(type)
            {
              case ADM_PSP:muxerType=MUXER_PSP;containerTitle=QT_TR_NOOP(&quot;PSP&quot;);break;
@@ -160,17 +162,31 @@
                 strcat(TwoPassLogFile,&quot;.stat&quot;);
                 _encode-&gt;setLogFile(TwoPassLogFile,total);
 
-                if (!_encode-&gt;configure (_incoming))
+				dualPass = _encode-&gt;isDualPass();
+
+				if (dualPass)
+				{
+					FILE *tmp;
+
+					if ((tmp = fopen(TwoPassLogFile,&quot;rt&quot;)))
+					{
+						fclose(tmp);
+
+						if (GUI_Question(QT_TR_NOOP(&quot;Reuse the existing log file?&quot;)))
+							reuse = 1;
+					}
+				}
+
+                if (!_encode-&gt;configure (_incoming, reuse))
                 {
                       GUI_Error_HIG (QT_TR_NOOP(&quot;Filter init failed&quot;), NULL);
                      goto  stopit;
-                };
+                }
 
-                dualPass=_encode-&gt;isDualPass();
                 if(dualPass)
                 {
                        
-                        if(!prepareDualPass(bitstream.bufferSize,videoBuffer,TwoPassLogFile,encoding_gui,_encode,total))
+                        if(!prepareDualPass(bitstream.bufferSize,videoBuffer,encoding_gui,_encode,total,reuse))
                                 goto stopit;
                 }else
                 {
@@ -373,26 +389,16 @@
            deleteAudioFilter (audio);
            return ret;
 }
-uint8_t prepareDualPass(uint32_t bufferSize,uint8_t *buffer,char *TwoPassLogFile,DIA_encoding *encoding_gui,Encoder *_encode,uint32_t total)
+uint8_t prepareDualPass(uint32_t bufferSize,uint8_t *buffer,DIA_encoding *encoding_gui,Encoder *_encode,uint32_t total,int reuse)
 {
       uint32_t len, flag;
-      FILE *tmp;
-      uint8_t reuse=0,r;
+      uint8_t r;
       ADMBitstream bitstream(0);
       uint32_t prefill=0;
       uint32_t sent=0;
       
         aprintf(&quot;\n** Dual pass encoding**\n&quot;);
 
-        if((tmp=fopen(TwoPassLogFile,&quot;rt&quot;)))
-        {
-                fclose(tmp);
-                if(GUI_Question(QT_TR_NOOP(&quot;\n Reuse the existing log-file ?&quot;)))
-                {
-                        reuse=1;
-                }
-        }
-        
         if(!reuse)
         {
         

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpeg/op_mpegpass.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpeg/op_mpegpass.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpeg/op_mpegpass.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -214,7 +214,7 @@
           copy=new EncoderCopy(NULL);
           muxerMT context;
           
-          copy-&gt;configure(NULL);
+          copy-&gt;configure(NULL, 0);
           // 
           memset(&amp;context,0,sizeof(context));
           context.videoEncoder=copy;
@@ -269,7 +269,7 @@
             audioQueueMT context;
             uint8_t r;
             
-            copy-&gt;configure(NULL);
+            copy-&gt;configure(NULL, 0);
             pq=new PacketQueue(&quot;TS audioQ&quot;,5000,2*1024*1024);
             memset(&amp;context,0,sizeof(context));
             context.audioEncoder=audio;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_mpegFF/oplug_vcdff.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -94,6 +94,7 @@
 ADMBitstream bitstream(0);
 uint32_t audioSum=0;
 DIA_encoding  *encoding;
+int reuse = 0;
 
         twoPass=new char[strlen(name)+6];
         twoFake=new char[strlen(name)+6];
@@ -229,7 +230,16 @@
       }
 
       encoder-&gt;setLogFile(twoPass,total);
-      if(!encoder-&gt;configure(_incoming))
+
+	  if (encoder-&gt;isDualPass())
+	  {
+		  printf(&quot;Verifying log file\n&quot;);
+
+		  if (encoder-&gt;verifyLog(twoPass, total) &amp;&amp; GUI_Question(QT_TR_NOOP(&quot;Reuse the existing log file?&quot;)))
+			  reuse = 1;
+	  }
+
+      if(!encoder-&gt;configure(_incoming, reuse))
               goto finishvcdff;
 
       _buffer=new uint8_t[_page]; // Might overflow if _page only
@@ -282,15 +292,6 @@
         // pass 1
         if(encoder-&gt;isDualPass()) //Cannot be requant
         {
-                        FILE *fd;
-                        uint8_t reuse=0;
-                        
-                        printf(&quot;Verifying log file\n&quot;);
-                        if(encoder-&gt;verifyLog(twoPass,total))
-                          if(GUI_Question(QT_TR_NOOP(&quot;Reuse log file ?&quot;)))
-                                {
-                                        reuse=1;
-                                }
                         if(!reuse)
                         {
                                 encoding-&gt;setPhasis (QT_TR_NOOP(&quot;Pass 1/2&quot;));

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_ogm/op_ogsaveprocess.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_ogm/op_ogsaveprocess.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/oplug_ogm/op_ogsaveprocess.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -63,7 +63,22 @@
    
  	_encode-&gt;setLogFile(TwoPassLogFile,_togo);
 	
-  	if (!_encode-&gt;configure (_incoming))
+	int reuse = 0;
+
+	if (_encode-&gt;isDualPass())
+	{
+		FILE *tmp;
+
+		if ((tmp = fopen(TwoPassLogFile,&quot;rt&quot;)))
+		{
+			fclose(tmp);
+
+			if (GUI_Question(QT_TR_NOOP(&quot;Reuse the existing log file?&quot;)))
+				reuse = 1;
+		}
+	}
+
+  	if (!_encode-&gt;configure (_incoming, reuse))
     	{
       		delete 	_encode;
       		_encode = NULL;
@@ -83,19 +98,8 @@
 	{
 		uint8_t *buffer;
 		uint32_t len, flag;
-		FILE *tmp;
-		uint8_t reuse=0;
 
 		aprintf(&quot;\n** Dual pass encoding**\n&quot;);
-
-		if((tmp=fopen(TwoPassLogFile,&quot;rt&quot;)))
-		{
-			fclose(tmp);
-                        if(GUI_Question(QT_TR_NOOP(&quot;\n Reuse the existing log-file ?&quot;)))
-			{
-				reuse=1;
-			}
-		}
 	
 		if(!reuse)
  		{

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_plugin/ADM_vidEnc_plugin.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_plugin/ADM_vidEnc_plugin.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_plugin/ADM_vidEnc_plugin.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -19,8 +19,8 @@
 
 #define ADM_VIDENC_API_VERSION 1
 
+#define ADM_VIDENC_ERR_SUCCESS 1
 #define ADM_VIDENC_ERR_FAILED 0
-#define ADM_VIDENC_ERR_SUCCESS 1
 #define ADM_VIDENC_ERR_CLOSED -1
 #define ADM_VIDENC_ERR_ALREADY_OPEN -2
 #define ADM_VIDENC_ERR_INVALID_ENCODER_ID -3
@@ -52,7 +52,7 @@
 	int64_t ptsFrame;
 	unsigned int quantiser;
 	int frameType;
-} vidEncEncodeParams;
+} vidEncEncodeParameters;
 
 typedef struct
 {
@@ -61,6 +61,10 @@
 	unsigned int height;
 	unsigned int parWidth;
 	unsigned int parHeight;
+	unsigned int frameCount;
+	unsigned int fps1000;
+	const char* logFileName;
+	int useExistingLogFile;
 } vidEncVideoProperties;
 
 typedef struct
@@ -85,11 +89,11 @@
 int vidEncSetOptions(int encoderId, vidEncOptions *encodeOptions, char *pluginOptions);
 
 int vidEncGetPassCount(int encoderId);
-int vidEncGetLastPass(int encoderId);
+int vidEncGetCurrentPass(int encoderId);
 
 int vidEncOpen(int encoderId, vidEncVideoProperties *properties);
 int vidEncBeginPass(int encoderId);
-int vidEncEncodeFrame(int encoderId, vidEncEncodeParams *encodeParams);
+int vidEncEncodeFrame(int encoderId, vidEncEncodeParameters *encodeParams);
 int vidEndFinishPass(int encoderId);
 int vidEncClose(int encoderId);
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2008-04-28 15:08:46 UTC (rev 3994)
@@ -14,6 +14,8 @@
  *                                                                         *
  ***************************************************************************/
 
+#include &lt;math.h&gt;
+
 #include &quot;config.h&quot;
 #include &quot;ADM_inttype.h&quot;
 #include &quot;ADM_files.h&quot;
@@ -34,7 +36,7 @@
 	int x264Encoder_getCurrentPass(void) { return encoder.getCurrentPass(); }
 	int x264Encoder_open(vidEncVideoProperties *properties) { return encoder.open(properties); }
 	int x264Encoder_beginPass(void) { return encoder.beginPass(); }
-	int x264Encoder_encodeFrame(vidEncEncodeParams *encodeParams) { return encoder.encodeFrame(encodeParams); }
+	int x264Encoder_encodeFrame(vidEncEncodeParameters *encodeParams) { return encoder.encodeFrame(encodeParams); }
 	int x264Encoder_finishPass(void) { return encoder.finishPass(); }
 	void x264Encoder_close(void) { encoder.close(); }
 }
@@ -43,15 +45,23 @@
 {
 	_loader = NULL;
 	_handler = NULL;
+	_opened = false;
+
 	_passCount = 1;
 	_currentPass = 0;
 	_openPass = false;
 
+	_logFileName = NULL;
+
+	_extraData = NULL;
+	_extraSize = 0;
+
+	_seiUserData = NULL;
+	_seiUserDataLen = 0;
+
 	_encodeOptions.structSize = sizeof(vidEncOptions);
 	_encodeOptions.encodeMode = ADM_VIDENC_MODE_AQP;
 	_encodeOptions.encodeModeParameter = 26;
-
-	updateParameters();
 }
 
 x264Encoder::~x264Encoder(void)
@@ -60,6 +70,9 @@
 
 	if (_loader)
 		delete _loader;
+
+	if (_logFileName)
+		delete [] _logFileName;
 }
 
 void x264Encoder::setUiType(int uiType)
@@ -125,6 +138,9 @@
 
 int x264Encoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
 {
+	if (_opened)
+		return ADM_VIDENC_ERR_ALREADY_OPEN;
+
 	bool success = true;
 
 	if (pluginOptions)
@@ -133,43 +149,12 @@
 	if (encodeOptions &amp;&amp; success)
 		memcpy(&amp;_encodeOptions, encodeOptions, sizeof(vidEncOptions));
 
-	updateParameters();
-
-	return success;
+	if (success)
+		return ADM_VIDENC_ERR_SUCCESS;
+	else
+		return ADM_VIDENC_ERR_FAILED;
 }
 
-void x264Encoder::updateParameters(void)
-{
-	x264_param_t *param = _options.getParameters();
-
-	memcpy(&amp;_param, param, sizeof(x264_param_t));
-	delete param;
-
-	switch (_encodeOptions.encodeMode)
-	{
-		case ADM_VIDENC_MODE_CBR:
-			_param.rc.i_rc_method = X264_RC_ABR;
-			_param.rc.i_bitrate = _encodeOptions.encodeModeParameter;
-			break;
-		case ADM_VIDENC_MODE_CQP:
-			_param.rc.i_rc_method = X264_RC_CQP;
-			_param.rc.i_qp_constant = _encodeOptions.encodeModeParameter;
-			break;
-		case ADM_VIDENC_MODE_AQP:
-			_param.rc.i_rc_method = X264_RC_CRF;
-			_param.rc.f_rf_constant = _encodeOptions.encodeModeParameter;
-			break;
-		case ADM_VIDENC_MODE_2PASS_SIZE:
-			_param.rc.i_rc_method = X264_RC_ABR;
-			_param.rc.i_bitrate = _encodeOptions.encodeModeParameter;
-			break;
-		case ADM_VIDENC_MODE_2PASS_ABR:
-			_param.rc.i_rc_method = X264_RC_ABR;
-			_param.rc.i_bitrate = _encodeOptions.encodeModeParameter;
-			break;
-	}
-}
-
 int x264Encoder::getCurrentPass(void)
 {
 	return _currentPass;
@@ -182,44 +167,45 @@
 
 int x264Encoder::open(vidEncVideoProperties *properties)
 {
-	if (_handler)
+	if (_opened)
 		return ADM_VIDENC_ERR_ALREADY_OPEN;
 
-	_param.i_width = _width = properties-&gt;width;
-	_param.i_height = _height = properties-&gt;height;
+	_opened = true;
+	_currentPass = 0;
 
-	// FIXME
-	_param.rc.i_rc_method = X264_RC_CRF;
-	_param.rc.f_rf_constant = 26;
-	_param.vui.i_sar_height = 1;
-	_param.vui.i_sar_width = 1;
+	memcpy(&amp;_properties, properties, sizeof(vidEncVideoProperties));
+	_properties.logFileName = NULL;
 
-    _param.i_fps_num = 25000;
-    _param.i_fps_den = 1000;
+	if (_logFileName)
+		delete [] _logFileName;
 
-	//_param.rc.b_stat_read = 1;
-	//_param.rc.psz_stat_in = &quot;C:\\Users\\Grant\\Desktop\\test.avi.stat&quot;;
+	_logFileName = new char[strlen(properties-&gt;logFileName) + 1];
+	strcpy(_logFileName, properties-&gt;logFileName);
 
-	printParam(&amp;_param);
-	printCqm((uint8_t*)&amp;_param, sizeof(x264_param_t));
-	printf(&quot;\n&quot;);
+	updateEncodeParameters(&amp;_properties);
 
-	_handler = x264_encoder_open(&amp;_param);
-	_seiUserData = NULL;
-	_seiUserDataLen = 0;
+	_param.i_width = _properties.width;
+	_param.i_height = _properties.height;
+	_param.i_fps_num = _properties.fps1000;
+	_param.i_fps_den = 1000;
 
-	_extraData = NULL;
-	_extraSize = 0;
+	if (_options.getSarAsInput())
+	{
+		_param.vui.i_sar_width = _properties.parWidth;
+		_param.vui.i_sar_height = _properties.parHeight;
+	}
 
-	if (_handler)
-		return ADM_VIDENC_ERR_SUCCESS;
-	else
-		return ADM_VIDENC_ERR_FAILED;
+	if (_passCount &gt; 1 &amp;&amp; properties-&gt;useExistingLogFile)
+		_currentPass++;
+
+	printParam(&amp;_param);
+
+	return ADM_VIDENC_ERR_SUCCESS;
 }
 
 int x264Encoder::beginPass(void)
 {
-	if (!_handler)
+	if (!_opened)
 		return ADM_VIDENC_ERR_CLOSED;
 
 	if (_openPass)
@@ -230,11 +216,50 @@
 
 	_openPass = true;
 	_currentPass++;
+
+	printf(&quot;[x264] begin pass %d/%d\n&quot;, _currentPass, _passCount);
+
+	if (_passCount &gt; 1)
+	{
+		if (_currentPass == 1)
+		{
+			_param.rc.b_stat_write = 1;
+			_param.rc.b_stat_read = 0;
+			_param.rc.psz_stat_out = _logFileName;
+			printf(&quot;[x264] writing to %s\n&quot;, _logFileName);
+		}
+		else
+		{
+			_param.rc.b_stat_write = 0;
+			_param.rc.b_stat_read = 1;
+			_param.rc.psz_stat_in = _logFileName;
+			printf(&quot;[x264] reading from %s\n&quot;, _logFileName);
+		}
+	}
+	else
+	{
+		_param.rc.b_stat_write = 0;
+		_param.rc.b_stat_read = 0;
+	}
+
+	_handler = x264_encoder_open(&amp;_param);
+	_seiUserData = NULL;
+	_seiUserDataLen = 0;
+
+	_extraData = NULL;
+	_extraSize = 0;
+
+	_currentFrame = 0;
+
+	if (_handler)
+		return ADM_VIDENC_ERR_SUCCESS;
+	else
+		return ADM_VIDENC_ERR_FAILED;
 }
 
-int x264Encoder::encodeFrame(vidEncEncodeParams *encodeParams)
+int x264Encoder::encodeFrame(vidEncEncodeParameters *encodeParams)
 {
-	if (!_handler)
+	if (!_opened)
 		return ADM_VIDENC_ERR_CLOSED;
 
 	x264_nal_t *nal;
@@ -246,11 +271,11 @@
 	_picture.img.i_csp = X264_CSP_I420;
 	_picture.img.i_plane = 3;
 	_picture.img.plane[0] = encodeParams-&gt;frameData;	// Y
-	_picture.img.plane[2] = encodeParams-&gt;frameData + _width * _height;	// U
-	_picture.img.plane[1] = encodeParams-&gt;frameData + ((_width * _height * 5) &gt;&gt; 2);	// V
-	_picture.img.i_stride[0] = _width;
-	_picture.img.i_stride[1] = _width &gt;&gt; 1;
-	_picture.img.i_stride[2] = _width &gt;&gt; 1;
+	_picture.img.plane[2] = encodeParams-&gt;frameData + _param.i_width * _param.i_height;	// U
+	_picture.img.plane[1] = encodeParams-&gt;frameData + ((_param.i_width * _param.i_height * 5) &gt;&gt; 2);	// V
+	_picture.img.i_stride[0] = _param.i_width;
+	_picture.img.i_stride[1] = _param.i_width &gt;&gt; 1;
+	_picture.img.i_stride[2] = _param.i_width &gt;&gt; 1;
 	_picture.i_type = X264_TYPE_AUTO;
 	_picture.i_pts = _currentFrame++;
 
@@ -294,40 +319,40 @@
 
 	switch (picture_out.i_type)
 	{
-	case X264_TYPE_IDR:
-		encodeParams-&gt;frameType = ADM_VIDENC_FRAMETYPE_IDR;
+		case X264_TYPE_IDR:
+			encodeParams-&gt;frameType = ADM_VIDENC_FRAMETYPE_IDR;
 
-		if(!_param.b_repeat_headers &amp;&amp; _seiUserData &amp;&amp; !picture_out.i_pts)
-		{
-			// Put our SEI front...
-			// first a temp location...
-			uint8_t tmpBuffer[size];
-			memcpy(tmpBuffer, encodeParams-&gt;encodedData, size);
+			if(!_param.b_repeat_headers &amp;&amp; _seiUserData &amp;&amp; !picture_out.i_pts)
+			{
+				// Put our SEI front...
+				// first a temp location...
+				uint8_t tmpBuffer[size];
+				memcpy(tmpBuffer, encodeParams-&gt;encodedData, size);
 
-			// Put back out SEI and add Size
-			encodeParams-&gt;encodedData[0] = (_seiUserDataLen &gt;&gt; 24) &amp; 0xff;
-			encodeParams-&gt;encodedData[1] = (_seiUserDataLen &gt;&gt; 16) &amp; 0xff;
-			encodeParams-&gt;encodedData[2] = (_seiUserDataLen &gt;&gt; 8) &amp; 0xff;
-			encodeParams-&gt;encodedData[3] = (_seiUserDataLen &gt;&gt; 0) &amp; 0xff;
+				// Put back out SEI and add Size
+				encodeParams-&gt;encodedData[0] = (_seiUserDataLen &gt;&gt; 24) &amp; 0xff;
+				encodeParams-&gt;encodedData[1] = (_seiUserDataLen &gt;&gt; 16) &amp; 0xff;
+				encodeParams-&gt;encodedData[2] = (_seiUserDataLen &gt;&gt; 8) &amp; 0xff;
+				encodeParams-&gt;encodedData[3] = (_seiUserDataLen &gt;&gt; 0) &amp; 0xff;
 
-			memcpy(encodeParams-&gt;encodedData + 4, _seiUserData, _seiUserDataLen);
-			memcpy(encodeParams-&gt;encodedData + 4 + _seiUserDataLen, tmpBuffer, size);
+				memcpy(encodeParams-&gt;encodedData + 4, _seiUserData, _seiUserDataLen);
+				memcpy(encodeParams-&gt;encodedData + 4 + _seiUserDataLen, tmpBuffer, size);
 
-			size += 4 + _seiUserDataLen;
-			encodeParams-&gt;encodedDataSize = size; // update total size
-		}
+				size += 4 + _seiUserDataLen;
+				encodeParams-&gt;encodedDataSize = size; // update total size
+			}
 
-		break;
-	case X264_TYPE_I:
-	case X264_TYPE_P:
-		encodeParams-&gt;frameType = ADM_VIDENC_FRAMETYPE_P;
-		break;
-	case X264_TYPE_B:
-	case X264_TYPE_BREF:
-		encodeParams-&gt;frameType = ADM_VIDENC_FRAMETYPE_B;
-		break;
-	default:
-		printf (&quot;[x264] Unknown image type: %d\n&quot;, picture_out.i_type);
+			break;
+		case X264_TYPE_I:
+		case X264_TYPE_P:
+			encodeParams-&gt;frameType = ADM_VIDENC_FRAMETYPE_P;
+			break;
+		case X264_TYPE_B:
+		case X264_TYPE_BREF:
+			encodeParams-&gt;frameType = ADM_VIDENC_FRAMETYPE_B;
+			break;
+		default:
+			printf (&quot;[x264] Unknown image type: %d\n&quot;, picture_out.i_type);
 	}
 
 	encodeParams-&gt;quantiser = picture_out.i_qpplus1;
@@ -337,7 +362,7 @@
 
 int x264Encoder::getExtraHeaderData(uint8_t **data)
 {
-	if (!_handler)
+	if (!_opened)
 		return ADM_VIDENC_ERR_CLOSED;
 
 	return ADM_VIDENC_ERR_FAILED;
@@ -355,7 +380,7 @@
 	uint8_t picParam[X264_MAX_HEADER_SIZE];
 	uint8_t seqParam[X264_MAX_HEADER_SIZE];
 	uint8_t sei[X264_MAX_HEADER_SIZE];
-	int picParamLen = 0, seqParamLen = 0, seiParamLen=0, len;
+	int picParamLen = 0, seqParamLen = 0, seiParamLen = 0, len;
 	int sz;
 
 	_extraData = new uint8_t[X264_MAX_HEADER_SIZE];
@@ -409,7 +434,7 @@
 	_extraData[2] = seqParam[2];	//0x00; // profile_compatibility
 	_extraData[3] = seqParam[3];	//0x0D; // AVCLevelIndication
 	_extraData[4] = 0xFC + 3;	// lengthSizeMinusOne 
-	_extraData[5] = 0xE0 + 1;	// nonReferenceDegredationPriorityLow        
+	_extraData[5] = 0xE0 + 1;	// nonReferenceDegredationPriorityLow
 
 	offset = 6;
 	_extraData[offset] = seqParamLen &gt;&gt; 8;
@@ -448,15 +473,23 @@
 
 int x264Encoder::finishPass(void)
 {
-	if (!_handler)
+	if (!_opened)
 		return ADM_VIDENC_ERR_CLOSED;
 
 	if (_openPass)
 		_openPass = false;
+
+	if (_handler)
+	{
+		x264_encoder_close(_handler);
+		_handler = NULL;
+	}
 }
 
 void x264Encoder::close(void)
 {
+	_opened = false;
+
 	if (_handler)
 	{
 		x264_encoder_close(_handler);
@@ -572,3 +605,57 @@
 	for (int index = 0; index &lt; size; index++)
 		printf(&quot;%d &quot;, cqm[index]);
 }
+
+void x264Encoder::updateEncodeParameters(vidEncVideoProperties *properties)
+{
+	x264_param_t *param = _options.getParameters();
+
+	memcpy(&amp;_param, param, sizeof(x264_param_t));
+	delete param;
+
+	switch (_encodeOptions.encodeMode)
+	{
+		case ADM_VIDENC_MODE_CBR:
+			_passCount = 1;
+			_param.rc.i_rc_method = X264_RC_ABR;
+			_param.rc.i_bitrate = _encodeOptions.encodeModeParameter;
+			break;
+		case ADM_VIDENC_MODE_CQP:
+			_passCount = 1;
+			_param.rc.i_rc_method = X264_RC_CQP;
+			_param.rc.i_qp_constant = _encodeOptions.encodeModeParameter;
+			break;
+		case ADM_VIDENC_MODE_AQP:
+			_passCount = 1;
+			_param.rc.i_rc_method = X264_RC_CRF;
+			_param.rc.f_rf_constant = _encodeOptions.encodeModeParameter;
+			break;
+		case ADM_VIDENC_MODE_2PASS_SIZE:
+			_passCount = 2;
+			_param.rc.i_rc_method = X264_RC_ABR;
+			_param.rc.i_bitrate = calculateBitrate(properties-&gt;fps1000, properties-&gt;frameCount, _encodeOptions.encodeModeParameter) / 1000;
+			break;
+		case ADM_VIDENC_MODE_2PASS_ABR:
+			_passCount = 2;
+			_param.rc.i_rc_method = X264_RC_ABR;
+			_param.rc.i_bitrate = _encodeOptions.encodeModeParameter;
+			break;
+	}
+}
+
+unsigned int x264Encoder::calculateBitrate(unsigned int fps1000, unsigned int frameCount, unsigned int sizeInMb)
+{
+	double db, ti;
+
+	db = sizeInMb;
+	db = db * 1024. * 1024. * 8.;
+	// now db is in bits
+
+	// compute duration
+	ti = frameCount;
+	ti *= 1000;
+	ti /= fps1000;	// nb sec
+	db = db / ti;
+
+	return (unsigned int)floor(db);
+}

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.h	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.h	2008-04-28 15:08:46 UTC (rev 3994)
@@ -40,15 +40,16 @@
 		configGuiLoader *_loader;
 		x264Options _options;
 		vidEncOptions _encodeOptions;
+		vidEncVideoProperties _properties;
+		char *_logFileName;
 
 		x264_t *_handler;
 		x264_param_t _param;
 		x264_picture_t _picture;
 
-		int _width, _height;
 		uint32_t _currentFrame;
 		int _currentPass, _passCount;
-		bool _openPass;
+		bool _opened, _openPass;
 
 		uint8_t *_seiUserData;
 		uint32_t _seiUserDataLen;
@@ -58,7 +59,8 @@
 
 		void printParam(x264_param_t* x264Param);
 		void printCqm(const uint8_t cqm[], int size);
-		void updateParameters(void);
+		void updateEncodeParameters(vidEncVideoProperties *properties);
+		unsigned int calculateBitrate(unsigned int fps1000, unsigned int frameCount, unsigned int sizeInMb);
 
 	public:
 		x264Encoder(void);
@@ -73,7 +75,7 @@
 		int open(vidEncVideoProperties *properties);
 		int beginPass(void);
 		int getExtraHeaderData(uint8_t **data);
-		int encodeFrame(vidEncEncodeParams *encodeParams);
+		int encodeFrame(vidEncEncodeParameters *encodeParams);
 		int finishPass(void);
 		void close(void);
 	};
@@ -87,6 +89,6 @@
 	int x264Encoder_getCurrentPass(void);
 	int x264Encoder_open(vidEncVideoProperties *properties);
 	void x264Encoder_close(void);
-	int x264Encoder_encodeFrame(vidEncEncodeParams *encodeParams);
+	int x264Encoder_encodeFrame(vidEncEncodeParameters *encodeParams);
 #endif	// __cplusplus
 #endif	// encoder_h

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/interface.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/interface.c	2008-04-28 11:35:40 UTC (rev 3993)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/interface.c	2008-04-28 15:08:46 UTC (rev 3994)
@@ -109,7 +109,7 @@
 	return x264Encoder_beginPass();
 }
 
-int vidEncEncodeFrame(int encoderId, vidEncEncodeParams *encodeParams)
+int vidEncEncodeFrame(int encoderId, vidEncEncodeParameters *encodeParams)
 {
 	return x264Encoder_encodeFrame(encodeParams);
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001253.html">[Avidemux-svn-commit] r3993 -	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui
</A></li>
	<LI>Next message: <A HREF="001255.html">[Avidemux-svn-commit] r3995 - in	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_editor	ADM_encoder ADM_plugin ADM_script	plugins/ADM_videoEncoder/ADM_vidEnc_x264
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1254">[ date ]</a>
              <a href="thread.html#1254">[ thread ]</a>
              <a href="subject.html#1254">[ subject ]</a>
              <a href="author.html#1254">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
