<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r3988 - in	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_editor	ADM_encoder ADM_script ADM_userInterfaces/ADM_GTK	plugins/ADM_videoEncoder/ADM_vidEnc_x264	plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2008-April/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3988%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster/avidemux%3A%20ADM_editor%0A%09ADM_encoder%20ADM_script%20ADM_userInterfaces/ADM_GTK%0A%09plugins/ADM_videoEncoder/ADM_vidEnc_x264%0A%09plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4&In-Reply-To=%3C200804270248.m3R2meqs003530%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001247.html">
   <LINK REL="Next"  HREF="001249.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r3988 - in	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_editor	ADM_encoder ADM_script ADM_userInterfaces/ADM_GTK	plugins/ADM_videoEncoder/ADM_vidEnc_x264	plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4</H1>
    <B>gruntster at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3988%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster/avidemux%3A%20ADM_editor%0A%09ADM_encoder%20ADM_script%20ADM_userInterfaces/ADM_GTK%0A%09plugins/ADM_videoEncoder/ADM_vidEnc_x264%0A%09plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4&In-Reply-To=%3C200804270248.m3R2meqs003530%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r3988 - in	branches/avidemux_2.5_branch_gruntster/avidemux: ADM_editor	ADM_encoder ADM_script ADM_userInterfaces/ADM_GTK	plugins/ADM_videoEncoder/ADM_vidEnc_x264	plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4">gruntster at mail.berlios.de
       </A><BR>
    <I>Sun Apr 27 04:48:40 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001247.html">[Avidemux-svn-commit] r3987 - in	branches/avidemux_2.5_branch_gruntster:	avidemux/ADM_audiofilter avidemux/ADM_encoder	avidemux/ADM_outputs/oplug_avi avidemux/ADM_outputs/oplug_dummy	avidemux/ADM_outputs/oplug_flv avidemux/ADM_outputs/oplug_mp4	avidemux/ADM_outputs/oplug_mpeg avidemux/ADM_outputs/oplug_mpegFF	avidemux/ADM_outputs/oplug_ogm	avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog	avidemux/ADM_userInterfaces/ADM_commonUI avidemux/winInstaller po
</A></li>
        <LI>Next message: <A HREF="001249.html">[Avidemux-svn-commit] r3989 -	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1248">[ date ]</a>
              <a href="thread.html#1248">[ thread ]</a>
              <a href="subject.html#1248">[ subject ]</a>
              <a href="author.html#1248">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: gruntster
Date: 2008-04-27 04:48:33 +0200 (Sun, 27 Apr 2008)
New Revision: 3988

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edLoadSave.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemuxVideo.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemuxVideo.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ui_support.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/options.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
Log:
[x264] save/load javascript using XML

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edLoadSave.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edLoadSave.cpp	2008-04-26 19:45:40 UTC (rev 3987)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_editor/ADM_edLoadSave.cpp	2008-04-27 02:48:33 UTC (rev 3988)
@@ -165,28 +165,33 @@
 //___________________________
         qfprintf(fd,&quot;\n//** Filters **\n&quot;);
         filterSaveScriptJS(fd);
+
 // Video codec
 //___________________________
-uint8_t  *extraData ;
-uint32_t extraDataSize;
-char *pth;
-        qfprintf(fd,&quot;\n//** Video Codec conf **\n&quot;);
-        videoCodecGetConf(&amp;extraDataSize,&amp;extraData);
-        
-        pth= ADM_cleanupPath(name );
-        qfprintf(fd,&quot;app.video.codec(\&quot;%s\&quot;,\&quot;%s\&quot;,\&quot;&quot;,videoCodecGetName(),videoCodecGetMode());
-        ADM_dealloc(pth);
-        // Now deal with extra data
-        qfprintf(fd,&quot;%d &quot;,extraDataSize);
-        if(extraDataSize)
-        {
-                for(int i=0;i&lt;extraDataSize;i++)
-                {
-                        qfprintf(fd,&quot;%02x &quot;,extraData[i]);
-                }
+		uint8_t *extraData;
+		uint32_t extraDataSize;
 
-        }
-        qfprintf(fd,&quot;\&quot;);\n&quot;);
+		qfprintf(fd, &quot;\n//** Video Codec conf **\n&quot;);
+		videoCodecGetConf(&amp;extraDataSize, &amp;extraData);
+
+		if (videoCodecGetType() == CodecExternal)
+		{
+			qfprintf(fd, &quot;app.video.codecPlugin(\&quot;%s\&quot;, \&quot;%s\&quot;, \&quot;%s\&quot;);\n&quot;, videoCodecPluginGetGuid(), videoCodecGetName(), videoCodecGetMode());
+			qfprintf(fd, &quot;app.video.codecConf(\&quot;%s\&quot;);\n&quot;, extraData);
+		}
+		else
+		{
+			qfprintf(fd, &quot;app.video.codec(\&quot;%s\&quot;, \&quot;%s\&quot;, \&quot;&quot;, videoCodecGetName(), videoCodecGetMode());
+
+			// Now deal with extra data
+			qfprintf(fd, &quot;%d &quot;, extraDataSize);
+
+			if (extraDataSize)
+				for(int i = 0; i &lt; extraDataSize; i++)
+					qfprintf(fd, &quot;%02x &quot;, extraData[i]);
+
+			qfprintf(fd, &quot;\&quot;);\n&quot;);
+		}
         
 // Audio Source
 //______________________________________________

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.cpp	2008-04-26 19:45:40 UTC (rev 3987)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_pluginLoad.cpp	2008-04-27 02:48:33 UTC (rev 3988)
@@ -123,7 +123,6 @@
 
 	memset(files, 0, sizeof(char *)*MAX_EXTERNAL_FILTER);
 	printf(&quot;[ADM_vidEnc_plugin] Scanning directory %s\n&quot;, path);
-	fflush(stdout);
 
 	if (!buildDirectoryContent(&amp;nbFile, path, files, MAX_EXTERNAL_FILTER, SHARED_LIB_EXT))
 		printf(&quot;[ADM_vidEnc_plugin] Cannot parse plugin\n&quot;);
@@ -158,8 +157,10 @@
 
 		param-&gt;codec = CodecExternal;
 		param-&gt;menuName = displayName;
-		param-&gt;tagName = displayName;
+		param-&gt;tagName = codecName;
 		param-&gt;extra_param = i;
+		param-&gt;extraSettings = NULL;
+		param-&gt;extraSettingsLen = 0;
 
 		int length = plugin-&gt;getOptions(plugin-&gt;encoderId, NULL, NULL, 0);
 		char *pluginOptions = new char[length + 1];
@@ -174,10 +175,12 @@
 	return 1;
 }
 
-void updateCompressionParameters(COMPRES_PARAMS *params, int encodeMode, int encodeModeParameter, char* extraSettings, int extraSettingsLength)
+void updateCompressionParameters(COMPRES_PARAMS *params, int encodeMode, int encodeModeParameter, char *extraSettings, int extraSettingsLength)
 {
 	COMPRESSION_MODE compressMode = getCompressionMode(encodeMode);
 
+	params-&gt;mode = compressMode;
+
 	switch (compressMode)
 	{
 		case COMPRESS_CBR:

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2008-04-26 19:45:40 UTC (rev 3987)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.cpp	2008-04-27 02:48:33 UTC (rev 3988)
@@ -42,7 +42,6 @@
 // Some static stuff
 void setVideoEncoderSettings(COMPRESSION_MODE mode, uint32_t param, uint32_t extraConf, uint8_t *extraData);
 static void encoderPrint(void);
-static const char *encoderGetName(void);
 
 #include &quot;adm_encConfig.h&quot;
 #include &quot;adm_encoder.h&quot;
@@ -77,8 +76,6 @@
 SelectCodecType currentCodecType = CodecCopy;
 int currentCodecIndex = 0;
 
-uint8_t loadVideoCodecConf (char *name);
-uint8_t saveVideoCodecConf (char *name);
 uint8_t mk_hex (uint8_t a, uint8_t b);
 
 CodecFamilty videoCodecGetFamily(void)
@@ -148,7 +145,7 @@
 		go = cs + equal + 1;
 		*(cs + equal) = 0;
 		iparam = atoi (cs + equal + 1);
-		printf (&quot;codec conf is %s\n&quot;, cs);
+		printf (&quot;Codec conf is %s\n&quot;, cs);
 
 		// search the codec
 		if (!strcasecmp (cs, &quot;aq&quot;))
@@ -324,11 +321,6 @@
 	prefs-&gt;set (CODECS_PREFERREDCODEC, AllVideoCodec[currentCodecIndex].tagName);
 }
 
-const char* encoderGetName(void)
-{
-	return AllVideoCodec[currentCodecIndex].tagName;
-}
-
 SelectCodecType videoCodecGetType(void)
 {
 	return currentCodecType;
@@ -348,7 +340,7 @@
 		if (!strcasecmp(name, AllVideoCodec[i].tagName))
 		{
 			printf (&quot;\n Codec %s found\n&quot;, name);
-			videoCodecSetcodec (AllVideoCodec[i].codec);
+			videoCodecSetCodec(i);
 
 			return 1;
 		}
@@ -362,6 +354,38 @@
 
 	return 0;
 }
+
+int videoCodecPluginSelectByGuid(const char *guid)
+{
+	int encoderCount = encoderGetEncoderCount();
+
+	for (int i = 0; i &lt; encoderCount; i++)
+	{
+		if (AllVideoCodec[i].codec == CodecExternal)
+		{
+			ADM_vidEnc_plugin *plugin = getVideoEncoderPlugin(AllVideoCodec[i].extra_param);
+			const char* encoderGuid = plugin-&gt;getEncoderGuid(plugin-&gt;encoderId);
+
+			if (strcmp(encoderGuid, guid) == 0)
+			{
+				printf (&quot;Codec plugin %s (%s) found\n&quot;, plugin-&gt;getEncoderName(plugin-&gt;encoderId), encoderGuid);
+				videoCodecSetCodec(i);
+
+				return 1;
+			}
+		}
+	}
+
+	return 0;
+}
+
+const char* videoCodecPluginGetGuid(void)
+{
+	ADM_vidEnc_plugin *plugin = getVideoEncoderPlugin(AllVideoCodec[currentCodecIndex].extra_param);
+
+	return plugin-&gt;getEncoderGuid(plugin-&gt;encoderId);
+}
+
 const char *videoCodecGetMode(void)
 {
 	uint8_t *data;
@@ -396,20 +420,9 @@
 	return string;
 }
 
-const char *
-videoCodecGetName (void)
+const char *videoCodecGetName(void)
 {
-  int nb = encoderGetEncoderCount ();
-  for (uint32_t i = 0; i &lt; nb; i++)
-    {
-      if (currentCodecType == AllVideoCodec[i].codec)
-	{
-	  return AllVideoCodec[i].tagName;
-	}
-
-    }
-  printf (&quot;\n Mmmm get video codec name failed..\n&quot;);
-  return NULL;
+	return AllVideoCodec[currentCodecIndex].tagName;
 }
 
 ///
@@ -423,9 +436,10 @@
 
 }
 
-void videoCodecSetcodec (SelectCodecType codec)
+void videoCodecSetCodec(int codecIndex)
 {
-	currentCodecType = codec;
+	currentCodecIndex = codecIndex;
+	currentCodecType = AllVideoCodec[codecIndex].codec;
 	encoderPrint();
 }
 
@@ -434,11 +448,9 @@
 	if (codecIndex == -1)
 		codecIndex = currentCodecIndex;
 
-	printf (&quot;Configuring codec: %d\n&quot;, codecIndex);
-
 	COMPRES_PARAMS *param = &amp;AllVideoCodec[codecIndex];
 
-	if (currentCodecType == CodecExternal)
+	if (AllVideoCodec[codecIndex].codec == CodecExternal)
 	{
 		ADM_vidEnc_plugin *plugin = getVideoEncoderPlugin(param-&gt;extra_param);
 		vidEncOptions encodeOptions;
@@ -522,7 +534,7 @@
 			ADM_assert(0);
 	}
 
-	if (zparam-&gt;extra_param)
+	if (zparam-&gt;codec == CodecExternal)
 	{
 		ADM_vidEnc_plugin *plugin = getVideoEncoderPlugin(zparam-&gt;extra_param);
 		vidEncOptions options;
@@ -546,10 +558,10 @@
 	else if (extraConf &amp;&amp; extraData &amp;&amp; zparam-&gt;extraSettingsLen)
 	{
 		if (zparam-&gt;extraSettingsLen != extraConf)
-			printf(&quot;\n*** ERROR : Extra data for codec config has a different size!!! *****\n&quot;);
+			printf(&quot;*** ERROR : Extra data for codec config has a different size!!! *****\n&quot;);
 		else
 		{
-			printf (&quot;\n using %u bytes of codec specific data...\n&quot;, extraConf);
+			printf (&quot;using %u bytes of codec specific data...\n&quot;, extraConf);
 			memcpy (zparam-&gt;extraSettings, extraData, extraConf);
 		}
 	}
@@ -630,47 +642,53 @@
 */
 uint8_t loadVideoCodecConf (char *name)
 {
-	FILE *fd = NULL;
-	char str[4000];
-	char str_extra[4000];
-	char str_tmp[4000];
-	uint32_t nb;
-	uint32_t extraSize = 0;
-	uint8_t *extra = NULL;
+	if (currentCodecType == CodecExternal)
+		videoCodecSetConf(strlen(name), (uint8_t*)name);
+	else
+	{
+		FILE *fd = NULL;
+		char str[4000];
+		char str_extra[4000];
+		char str_tmp[4000];
+		uint32_t nb;
+		uint32_t extraSize = 0;
+		uint8_t *extra = NULL;
 
-	fd = fopen (name, &quot;rt&quot;);
+		fd = fopen (name, &quot;rt&quot;);
 
-	if (!fd)
-	{
-		printf (&quot;Trouble reading codec conf\n&quot;);
-		return 0;
-	}
+		if (!fd)
+		{
+			printf (&quot;Trouble reading codec conf\n&quot;);
+			return 0;
+		}
 
-	fscanf (fd, &quot;%s\n&quot;, str);
-	// and video codec
-	fscanf (fd, &quot;Video codec : %s\n&quot;, str);
-	videoCodecSelectByName (str);
+		fscanf (fd, &quot;%s\n&quot;, str);
+		// and video codec
+		fscanf (fd, &quot;Video codec : %s\n&quot;, str);
+		videoCodecSelectByName (str);
 
-	fgets (str, 200, fd);		// here we got the conf
-	fscanf (fd, &quot;Video extraConf size : %lu\n&quot;, &amp;extraSize);
+		fgets (str, 200, fd);		// here we got the conf
+		fscanf (fd, &quot;Video extraConf size : %lu\n&quot;, &amp;extraSize);
 
-	if (extraSize)
-	{
-		uint8_t *ptr;
-		fgets (str_tmp, 3999, fd);
-		ptr = (uint8_t *) str_tmp;
+		if (extraSize)
+		{
+			uint8_t *ptr;
+			fgets (str_tmp, 3999, fd);
+			ptr = (uint8_t *) str_tmp;
 
-		for (uint32_t k = 0; k &lt; extraSize; k++)
-		{
-			str_extra[k] = mk_hex (*ptr, *(ptr + 1));
-			ptr += 3;
+			for (uint32_t k = 0; k &lt; extraSize; k++)
+			{
+				str_extra[k] = mk_hex (*ptr, *(ptr + 1));
+				ptr += 3;
+			}
+
+			extra = (uint8_t *) str_extra;
 		}
 
-		extra = (uint8_t *) str_extra;
+		videoCodecSetConf(extraSize, extra);
+		fclose (fd);
 	}
 
-	videoCodecSetConf (str, extraSize, extra);
-	fclose (fd);
 	return 1;
 }
 
@@ -701,7 +719,7 @@
 		}
 
 		extra = (uint8_t *)str_extra;
-		videoCodecSetConf(str, extraSize, extra);
+		videoCodecSetConf(extraSize, extra);
 	}
 
 	return 1;
@@ -732,11 +750,6 @@
 
 uint8_t videoCodecGetConf (uint32_t * optSize, uint8_t ** data)
 {
-	static char conf[4000];
-	static char tmp[2000];
-	uint32_t confSize = 0;
-	conf[0] = 0;
-
 	*optSize = 0;
 	*data = NULL;
 
@@ -744,21 +757,32 @@
 
 	if (param-&gt;extraSettingsLen)
 	{
-		*data = (uint8_t *) param-&gt;extraSettings;
+		*data = (uint8_t*)param-&gt;extraSettings;
 		*optSize = param-&gt;extraSettingsLen;
 	}
 
-	confSize = *optSize;
-	printf (&quot;Conf size : %d\n&quot;, confSize);
+	printf (&quot;Conf size: %d\n&quot;, *optSize);
+
 	return 1;
 }
 
-void videoCodecSetConf(char *name, uint32_t extraLen, uint8_t *extraData)
+void videoCodecSetConf(uint32_t extraLen, uint8_t *extraData)
 {
 	COMPRES_PARAMS *param = &amp;AllVideoCodec[currentCodecIndex];
 
-	if (extraLen)
+	if (param-&gt;codec == CodecExternal)
 	{
+		if (param-&gt;extraSettings)
+			delete [] (char*)param-&gt;extraSettings;
+
+		param-&gt;extraSettings = new char[extraLen + 1];
+		param-&gt;extraSettingsLen = extraLen;
+
+		memcpy(param-&gt;extraSettings, extraData, extraLen);
+		((char*)param-&gt;extraSettings)[extraLen] = 0;
+	}
+	else if (extraLen)
+	{
 		if (extraLen != param-&gt;extraSettingsLen)
 		{
 			printf(&quot;Codec:%s\n&quot;, param-&gt;descriptor);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.h	2008-04-26 19:45:40 UTC (rev 3987)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encConfig.h	2008-04-27 02:48:33 UTC (rev 3988)
@@ -1,21 +1,25 @@
-#ifndef _ADM_encoder_Config_
-#define _ADM_encoder_Config_
+#ifndef adm_encConfig_h
+#define adm_encConfig_h
 
-void saveEncoderConfig (void);
-void loadEncoderConfig (void);
+#include &quot;ADM_vidEncode.hxx&quot;
 
-const char *videoCodecGetName (void);
+void saveEncoderConfig(void);
+void videoCodecSetCodec(int codecIndex);
+int videoCodecConfigure(char *cmdString, uint32_t optionSize, uint8_t * option);
+
+const char *videoCodecGetName(void);
 int videoCodecSelectByName (const char *name);
+int videoCodecPluginSelectByGuid(const char *guid);
 
+SelectCodecType videoCodecGetType(void);
+const char* videoCodecPluginGetGuid(void);
+void videoCodecSetConf(uint32_t extraLen, uint8_t * extraData);
+uint8_t videoCodecGetConf(uint32_t * nbData, uint8_t ** data);
 
-void videoCodecSetConf (char *name, uint32_t extraLen, uint8_t * extraData);
-uint8_t videoCodecGetConf (uint32_t * nbData, uint8_t ** data);
-
 // Returns the mode (CQ/CBR...) as a string, suitable for a script
-const char *videoCodecGetMode (void);
-uint8_t videoCodecSetFinalSize (uint32_t size);
+const char *videoCodecGetMode(void);
+uint8_t videoCodecSetFinalSize(uint32_t size);
 
-//
 void setPSP_X264Preset(void);
 void setIpod_Xvid4Preset(void);
-#endif
+#endif	// adm_encConfig_h

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.h	2008-04-26 19:45:40 UTC (rev 3987)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/adm_encoder.h	2008-04-27 02:48:33 UTC (rev 3988)
@@ -114,6 +114,4 @@
 extern void videoCodecConfigureUI(int codecIndex = -1);
 extern int videoCodecConfigure (char *p, uint32_t i, uint8_t * c);
 extern void videoCodecSelect (void);
-extern void videoCodecSetcodec (SelectCodecType codec);
-extern uint8_t EncoderSaveMpeg (const char *name);
 #endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemuxVideo.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemuxVideo.cpp	2008-04-26 19:45:40 UTC (rev 3987)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemuxVideo.cpp	2008-04-27 02:48:33 UTC (rev 3988)
@@ -27,22 +27,16 @@
 #include &quot;ADM_encoder/adm_encConfig.h&quot;
 #include &quot;ADM_editor/ADM_outputfmt.h&quot;
 #include &quot;../ADM_userInterfaces/ADM_commonUI/GUI_ui.h&quot;
-
-
 #include &quot;ADM_script/ADM_container.h&quot;
 
 extern VF_FILTERS filterGetTagFromName(char *inname);
-//extern uint8_t indexMpeg(char *mpeg,char *file,uint8_t aid);
 extern uint8_t A_ListAllBlackFrames( char *file );
 extern uint8_t loadVideoCodecConfString( char *name);
 extern uint8_t ADM_saveRaw (const char *name);
 extern int A_saveJpg (char *name);
 extern uint8_t loadVideoCodecConf( char *name);
-extern int videoCodecConfigure(char *p,uint32_t i, uint8_t  *c);
-
 extern void filterCleanUp( void );
 
-
 JSPropertySpec ADM_JSAvidemuxVideo::avidemuxvideo_properties[] = 
 { 
         { &quot;process&quot;, videoprocess_prop, JSPROP_ENUMERATE },        // process video when saving
@@ -56,6 +50,7 @@
         { &quot;clearFilters&quot;, ClearFilters, 0, 0, 0 }, // Delete all filters
 	{ &quot;addFilter&quot;, AddFilter, 10, 0, 0 },	// Add filter to filter chain
 	{ &quot;codec&quot;, Codec, 3, 0, 0 },	// Set the video codec
+	{ &quot;codecPlugin&quot;, codecPlugin, 3, 0, 0 },	// Set the video codec plugin
 	{ &quot;codecConf&quot;, CodecConf, 1, 0, 0 },	// load video codec config
 	{ &quot;save&quot;, Save, 1, 0, 0 },	// save video portion of the stream
 	{ &quot;saveJpeg&quot;, SaveJPEG, 1, 0, 0 },	// save the current frame as a JPEG
@@ -288,22 +283,70 @@
         return JS_TRUE;
 }// end Codec
 
+JSBool ADM_JSAvidemuxVideo::codecPlugin(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
+{
+	*rval = BOOLEAN_TO_JSVAL(false);
+
+	if (argc &gt; 3)
+		return JS_FALSE;
+
+	printf(&quot;Codec Plugin ... \n&quot;);
+
+	if (!JSVAL_IS_STRING(argv[0]) || !JSVAL_IS_STRING(argv[1]) || !JSVAL_IS_STRING(argv[2]))
+		return JS_FALSE;
+
+	printf(&quot;[guid] %s\n&quot;, JS_GetStringBytes(JSVAL_TO_STRING(argv[0])));
+	printf(&quot;[desc] %s\n&quot;, JS_GetStringBytes(JSVAL_TO_STRING(argv[1])));
+	printf(&quot;[conf] %s\n&quot;, JS_GetStringBytes(JSVAL_TO_STRING(argv[2])));
+
+	char *guid = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
+	char *desc = JS_GetStringBytes(JSVAL_TO_STRING(argv[1]));
+	char *conf = JS_GetStringBytes(JSVAL_TO_STRING(argv[2]));
+
+	enterLock();
+
+	if (!videoCodecPluginSelectByGuid(guid))
+		*rval = BOOLEAN_TO_JSVAL(false);
+	else
+	{
+		// now do the conf
+		// format CBR=bitrate in kbits
+		//	  CQ=Q
+		//	  2 Pass=size
+		// We have to replace
+		if (!videoCodecConfigure(conf, 0, NULL))
+			*rval = BOOLEAN_TO_JSVAL(false);
+		else
+			*rval = BOOLEAN_TO_JSVAL(true);
+	}
+
+	leaveLock();
+
+	return JS_TRUE;
+}
+
 JSBool ADM_JSAvidemuxVideo::CodecConf(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
-{// begin CodecConf
-        *rval = BOOLEAN_TO_JSVAL(false);
-        if(argc != 1)
-                return JS_FALSE;
-        if(JSVAL_IS_STRING(argv[0]) == false)
-                return JS_FALSE;
-        char *pTempStr = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
-        printf(&quot;Codec Conf Video \&quot;%s\&quot;\n&quot;,pTempStr);
-        enterLock();
-        *rval = INT_TO_JSVAL(loadVideoCodecConf(pTempStr));
-        leaveLock();
-        return JS_TRUE;
-}// end CodecConf
+{
+	*rval = BOOLEAN_TO_JSVAL(false);
 
+	if (argc != 1)
+		return JS_FALSE;
+
+	if (!JSVAL_IS_STRING(argv[0]))
+		return JS_FALSE;
+
+	char *pTempStr = JS_GetStringBytes(JSVAL_TO_STRING(argv[0]));
+
+	printf(&quot;Codec Conf Video \&quot;%s\&quot;\n&quot;, pTempStr);
+
+	enterLock();
+	*rval = INT_TO_JSVAL(loadVideoCodecConf(pTempStr));
+	leaveLock();
+
+	return JS_TRUE;
+}
+
 JSBool ADM_JSAvidemuxVideo::Save(JSContext *cx, JSObject *obj, uintN argc, 
                                        jsval *argv, jsval *rval)
 {// begin Save

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemuxVideo.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemuxVideo.h	2008-04-26 19:45:40 UTC (rev 3987)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemuxVideo.h	2008-04-27 02:48:33 UTC (rev 3988)
@@ -25,6 +25,7 @@
 	static JSBool AddFilter(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 	static JSBool IndexMPEG(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 	static JSBool Codec(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
+	static JSBool codecPlugin(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 	static JSBool CodecConf(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 	static JSBool Save(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 	static JSBool SaveJPEG(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ui_support.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ui_support.cpp	2008-04-26 19:45:40 UTC (rev 3987)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ui_support.cpp	2008-04-27 02:48:33 UTC (rev 3988)
@@ -38,6 +38,6 @@
 {
 	char *pluginDir = ADM_getPluginPath();
 
-	loadVideoEncoderPlugins(ADM_VIDENC_UI_CLI, pluginDir);
+	loadVideoEncoderPlugins(ADM_VIDENC_UI_GTK, pluginDir);
 	delete [] pluginDir;
 }

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2008-04-26 19:45:40 UTC (rev 3987)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/encoder.cpp	2008-04-27 02:48:33 UTC (rev 3988)
@@ -125,15 +125,17 @@
 
 int x264Encoder::setOptions(vidEncOptions *encodeOptions, char *pluginOptions)
 {
-	if (_options.fromXml(pluginOptions))
-	{
+	bool success = true;
+
+	if (pluginOptions)
+		success = _options.fromXml(pluginOptions);
+
+	if (encodeOptions &amp;&amp; success)
 		memcpy(&amp;_encodeOptions, encodeOptions, sizeof(vidEncOptions));
-		updateParameters();
 
-		return 1;
-	}
-	else
-		return 0;
+	updateParameters();
+
+	return success;
 }
 
 void x264Encoder::updateParameters(void)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/options.cpp	2008-04-26 19:45:40 UTC (rev 3987)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/options.cpp	2008-04-27 02:48:33 UTC (rev 3988)
@@ -1283,8 +1283,26 @@
 		xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)&quot;accessUnitDelimiters&quot;, boolean2String(xmlBuffer, bufferSize, getAccessUnitDelimiters()));
 		xmlNewChild(xmlNodeRoot, NULL, (xmlChar*)&quot;spsIdentifier&quot;, number2String(xmlBuffer, bufferSize, getSpsIdentifier()));
 
-		xmlDocDumpFormatMemory(xmlDoc, &amp;tempBuffer, &amp;tempBufferSize, 1);
+		xmlDocDumpMemory(xmlDoc, &amp;tempBuffer, &amp;tempBufferSize);
 
+		// remove carriage returns (even though libxml was instructed not to format the XML)
+		xmlChar* bufferChar = tempBuffer;
+		int bufferCharIndex = 0;
+
+		while (*bufferChar != '\0')
+		{
+			if (*bufferChar == '\n')
+			{
+				memmove(bufferChar, bufferChar + 1, tempBufferSize - bufferCharIndex);
+				tempBufferSize--;
+			}
+			else if (*bufferChar == '\&quot;')
+				*bufferChar = '\'';
+
+			bufferChar++;
+			bufferCharIndex++;
+		}
+
 		xml = new char[tempBufferSize + 1];
 		memcpy(xml, tempBuffer, tempBufferSize);
 		xml[tempBufferSize] = 0;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2008-04-26 19:45:40 UTC (rev 3987)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2008-04-27 02:48:33 UTC (rev 3988)
@@ -428,6 +428,8 @@
 
 void x264ConfigDialog::saveSettings(vidEncOptions *encodeOptions, x264Options *options)
 {
+	encodeOptions-&gt;structSize = sizeof(vidEncOptions);
+
 	// General tab
 	switch (ui.encodingModeComboBox-&gt;currentIndex())
 	{


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001247.html">[Avidemux-svn-commit] r3987 - in	branches/avidemux_2.5_branch_gruntster:	avidemux/ADM_audiofilter avidemux/ADM_encoder	avidemux/ADM_outputs/oplug_avi avidemux/ADM_outputs/oplug_dummy	avidemux/ADM_outputs/oplug_flv avidemux/ADM_outputs/oplug_mp4	avidemux/ADM_outputs/oplug_mpeg avidemux/ADM_outputs/oplug_mpegFF	avidemux/ADM_outputs/oplug_ogm	avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog	avidemux/ADM_userInterfaces/ADM_commonUI avidemux/winInstaller po
</A></li>
	<LI>Next message: <A HREF="001249.html">[Avidemux-svn-commit] r3989 -	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1248">[ date ]</a>
              <a href="thread.html#1248">[ thread ]</a>
              <a href="subject.html#1248">[ subject ]</a>
              <a href="author.html#1248">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
