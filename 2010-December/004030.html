<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r6854 - in	branches/avidemux_2.5_branch_gruntster/cmake: . patches
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2010-December/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6854%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster/cmake%3A%20.%20patches&In-Reply-To=%3C20101220145757.4775A480BCC%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004029.html">
   <LINK REL="Next"  HREF="004031.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r6854 - in	branches/avidemux_2.5_branch_gruntster/cmake: . patches</H1>
    <B>gruntster at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6854%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster/cmake%3A%20.%20patches&In-Reply-To=%3C20101220145757.4775A480BCC%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r6854 - in	branches/avidemux_2.5_branch_gruntster/cmake: . patches">gruntster at mail.berlios.de
       </A><BR>
    <I>Mon Dec 20 15:57:57 CET 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="004029.html">[Avidemux-svn-commit] r6853 - in	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264:	. qt4
</A></li>
        <LI>Next message: <A HREF="004031.html">[Avidemux-svn-commit] r6855 -	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4030">[ date ]</a>
              <a href="thread.html#4030">[ thread ]</a>
              <a href="subject.html#4030">[ subject ]</a>
              <a href="author.html#4030">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: gruntster
Date: 2010-12-20 15:57:56 +0100 (Mon, 20 Dec 2010)
New Revision: 6854

Removed:
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_Makefile.patch
Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_ffv1.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264_parser.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12enc.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo_enc.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_vc1dec.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_file.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_matroskaenc.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavutil_avutil.h.patch
Log:
[ffmpeg] update FFmpeg to r26061 &amp; libswscale to r32724

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,7 +1,7 @@
 include(admFFmpegUtil)
 
-set(FFMPEG_VERSION 25831)	# <A HREF="http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=95fe12b28a9c50f6c1ca2298fad7febfbbd20550;sf=tgz">http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=95fe12b28a9c50f6c1ca2298fad7febfbbd20550;sf=tgz</A>
-set(SWSCALE_VERSION 32647)	# <A HREF="http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=e75b939d479ce8120d2d30d7275849e3377a990e;sf=tgz">http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=e75b939d479ce8120d2d30d7275849e3377a990e;sf=tgz</A>
+set(FFMPEG_VERSION 26061)	# <A HREF="http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz">http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz</A>
+set(SWSCALE_VERSION 32724)	# <A HREF="http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=d1a43021d9198868fa7a023a30e5ee9e09a907d3;sf=tgz">http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=d1a43021d9198868fa7a023a30e5ee9e09a907d3;sf=tgz</A>
 
 set(LIBRARY_SOURCE_DIR &quot;${CMAKE_SOURCE_DIR}/avidemux/ADM_libraries&quot;)
 set(FFMPEG_SOURCE_DIR &quot;${LIBRARY_SOURCE_DIR}/ffmpeg&quot;)

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2010-12-20 14:57:56 UTC (rev 6854)
@@ -11,7 +11,7 @@
 	unix2dos $1/$2.new
 	mv $1/$2 $1/$2.old
 	mv $1/$2.new $1/$2
-	diff -c $1/$2.old $1/$2 &gt; $curDir/$1_$2.patch
+	diff -u $1/$2.old $1/$2 &gt; $curDir/$1_$2.patch
 	rm $1/$2.old
 	cd $curDir
 	dos2unix $1_$2.patch
@@ -21,6 +21,7 @@
 updatePatch libavcodec ffv1.c
 updatePatch libavcodec h263dec.c
 updatePatch libavcodec h264.c
+updatePatch libavcodec h264_parser.c
 updatePatch libavcodec mpeg12.c
 updatePatch libavcodec mpeg12enc.c
 updatePatch libavcodec mpegvideo.c
@@ -30,6 +31,5 @@
 updatePatch libavformat file.c
 updatePatch libavformat isom.c
 updatePatch libavformat matroskaenc.c
-updatePatch libavformat Makefile
 updatePatch libavutil avutil.h
 

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,34 +1,28 @@
-*** libavcodec/avcodec.h.old	Fri Nov 26 17:53:30 2010
---- libavcodec/avcodec.h	Fri Nov 26 17:53:30 2010
-***************
-*** 663,668 ****
---- 663,670 ----
-  #define CODEC_FLAG2_PSY           0x00080000 ///&lt; Use psycho visual optimizations.
-  #define CODEC_FLAG2_SSIM          0x00100000 ///&lt; Compute SSIM during encoding, error[] values are undefined.
-  #define CODEC_FLAG2_INTRA_REFRESH 0x00200000 ///&lt; Use periodic insertion of intra blocks instead of keyframes.
-+ //MEANX: NEVER EVER USE CLOSED GOP ?
-+ #define CODEC_FLAG2_32_PULLDOWN   0x80000000
-  
-  /* Unsupported options :
-   *              Syntax Arithmetic coding (SAC)
-***************
-*** 1550,1555 ****
---- 1552,1558 ----
-       * - decoding: unused
-       */
-      int rc_max_rate;
-+     int rc_max_rate_header; /*&lt; That one is set in the header MEANX */
-  
-      /**
-       * minimum bitrate
-***************
-*** 1564,1569 ****
---- 1567,1574 ----
-       * - decoding: unused
-       */
-      int rc_buffer_size;
-+     int rc_buffer_size_header;  /*&lt; That one is set in the header MEANX*/
-+ 
-      float rc_buffer_aggressivity;
-  
-      /**
+--- libavcodec/avcodec.h.old	2010-12-20 13:49:18 +0000
++++ libavcodec/avcodec.h	2010-12-20 13:49:18 +0000
+@@ -665,6 +665,8 @@
+ #define CODEC_FLAG2_PSY           0x00080000 ///&lt; Use psycho visual optimizations.
+ #define CODEC_FLAG2_SSIM          0x00100000 ///&lt; Compute SSIM during encoding, error[] values are undefined.
+ #define CODEC_FLAG2_INTRA_REFRESH 0x00200000 ///&lt; Use periodic insertion of intra blocks instead of keyframes.
++//MEANX: NEVER EVER USE CLOSED GOP ?
++#define CODEC_FLAG2_32_PULLDOWN   0x80000000
+ 
+ /* Unsupported options :
+  *              Syntax Arithmetic coding (SAC)
+@@ -1559,6 +1561,7 @@
+      * - decoding: unused
+      */
+     int rc_max_rate;
++    int rc_max_rate_header; /*&lt; That one is set in the header MEANX */
+ 
+     /**
+      * minimum bitrate
+@@ -1573,6 +1576,8 @@
+      * - decoding: unused
+      */
+     int rc_buffer_size;
++    int rc_buffer_size_header;  /*&lt; That one is set in the header MEANX*/
++
+     float rc_buffer_aggressivity;
+ 
+     /**

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_ffv1.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_ffv1.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_ffv1.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,13 +1,11 @@
-*** libavcodec/ffv1.c.old	Fri Nov 26 17:53:32 2010
---- libavcodec/ffv1.c	Fri Nov 26 17:53:32 2010
-***************
-*** 1734,1739 ****
---- 1734,1741 ----
-          clear_state(f);
-      }else{
-          p-&gt;key_frame= 0;
-+          p-&gt;pict_type= FF_P_TYPE; // MEANX : looks more like a P to me as user
-+ 
-      }
-      if(f-&gt;ac&gt;1){
-          int i;
+--- libavcodec/ffv1.c.old	2010-12-20 13:49:20 +0000
++++ libavcodec/ffv1.c	2010-12-20 13:49:20 +0000
+@@ -1734,6 +1734,8 @@
+         clear_state(f);
+     }else{
+         p-&gt;key_frame= 0;
++         p-&gt;pict_type= FF_P_TYPE; // MEANX : looks more like a P to me as user
++
+     }
+     if(f-&gt;ac&gt;1){
+         int i;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,62 +1,56 @@
-*** libavcodec/h263dec.c.old	Fri Nov 26 17:53:32 2010
---- libavcodec/h263dec.c	Fri Nov 26 17:53:32 2010
-***************
-*** 120,125 ****
---- 120,144 ----
-  
-      return 0;
-  }
-+ /* MeanX : Ugly patch to detect vo ppacked stuff ... */
-+ int av_is_voppacked(AVCodecContext *avctx, int *vop_packed, int *gmc, int *qpel);
-+ 
-+ int av_is_voppacked(AVCodecContext *avctx, int *vop_packed, int *gmc, int *qpel)
-+ {
-+     MpegEncContext *s = avctx-&gt;priv_data;
-+     // set sane default
-+     *vop_packed=0;
-+     *gmc=0;
-+     *qpel=0;
-+     if(avctx-&gt;codec-&gt;id!=CODEC_ID_MPEG4) return 0;
-+     	
-+   	*vop_packed=(s-&gt;divx_packed);
-+ 	*qpel=s-&gt;quarter_sample;
-+ 	*gmc=0;	// FIXME
-+ 	return 1;
-+ 
-+   }
-+   /* MeanX */
-  
-  av_cold int ff_h263_decode_end(AVCodecContext *avctx)
-  {
-***************
-*** 415,420 ****
---- 434,445 ----
-      } else {
-          ret = h263_decode_picture_header(s);
-      }
-+ 	//MEANX we need to do it here also for quicktime file / ctts atom 
-+         // we need the correct frame type, and qt file may contain 
-+         // vop not coded frame.
-+         pict-&gt;pict_type=s-&gt;current_picture.pict_type= s-&gt;pict_type;
-+         pict-&gt;key_frame=s-&gt;current_picture.key_frame= s-&gt;pict_type == FF_I_TYPE;
-+         //MEANX
-  
-      if(ret==FRAME_SKIPPED) return get_consumed_bytes(s, buf_size);
-  
-***************
-*** 710,715 ****
---- 735,748 ----
-  
-  assert(s-&gt;current_picture.pict_type == s-&gt;current_picture_ptr-&gt;pict_type);
-  assert(s-&gt;current_picture.pict_type == s-&gt;pict_type);
-+ /* MEANX */
-+   if(s-&gt;current_picture_ptr)
-+       s-&gt;current_picture_ptr-&gt;opaque=pict-&gt;opaque;
-+ /* MEANX */
-+ 
-+ 
-+ 
-+ 
-      if (s-&gt;pict_type == FF_B_TYPE || s-&gt;low_delay) {
-          *pict= *(AVFrame*)s-&gt;current_picture_ptr;
-      } else if (s-&gt;last_picture_ptr != NULL) {
+--- libavcodec/h263dec.c.old	2010-12-20 13:49:21 +0000
++++ libavcodec/h263dec.c	2010-12-20 13:49:21 +0000
+@@ -120,6 +120,25 @@
+ 
+     return 0;
+ }
++/* MeanX : Ugly patch to detect vo ppacked stuff ... */
++int av_is_voppacked(AVCodecContext *avctx, int *vop_packed, int *gmc, int *qpel);
++
++int av_is_voppacked(AVCodecContext *avctx, int *vop_packed, int *gmc, int *qpel)
++{
++    MpegEncContext *s = avctx-&gt;priv_data;
++    // set sane default
++    *vop_packed=0;
++    *gmc=0;
++    *qpel=0;
++    if(avctx-&gt;codec-&gt;id!=CODEC_ID_MPEG4) return 0;
++    	
++  	*vop_packed=(s-&gt;divx_packed);
++	*qpel=s-&gt;quarter_sample;
++	*gmc=0;	// FIXME
++	return 1;
++
++  }
++  /* MeanX */
+ 
+ av_cold int ff_h263_decode_end(AVCodecContext *avctx)
+ {
+@@ -422,6 +441,12 @@
+     } else {
+         ret = h263_decode_picture_header(s);
+     }
++	//MEANX we need to do it here also for quicktime file / ctts atom 
++        // we need the correct frame type, and qt file may contain 
++        // vop not coded frame.
++        pict-&gt;pict_type=s-&gt;current_picture.pict_type= s-&gt;pict_type;
++        pict-&gt;key_frame=s-&gt;current_picture.key_frame= s-&gt;pict_type == FF_I_TYPE;
++        //MEANX
+ 
+     if(ret==FRAME_SKIPPED) return get_consumed_bytes(s, buf_size);
+ 
+@@ -717,6 +742,14 @@
+ 
+ assert(s-&gt;current_picture.pict_type == s-&gt;current_picture_ptr-&gt;pict_type);
+ assert(s-&gt;current_picture.pict_type == s-&gt;pict_type);
++/* MEANX */
++  if(s-&gt;current_picture_ptr)
++      s-&gt;current_picture_ptr-&gt;opaque=pict-&gt;opaque;
++/* MEANX */
++
++
++
++
+     if (s-&gt;pict_type == FF_B_TYPE || s-&gt;low_delay) {
+         *pict= *(AVFrame*)s-&gt;current_picture_ptr;
+     } else if (s-&gt;last_picture_ptr != NULL) {

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,24 +1,22 @@
-*** libavcodec/h264.c.old	Fri Nov 26 17:53:33 2010
---- libavcodec/h264.c	Fri Nov 26 17:53:33 2010
-***************
-*** 3395,3400 ****
---- 3395,3413 ----
-      return 0;
-  }
-  
-+ /* MEANX */
-+ int av_getAVCStreamInfo(AVCodecContext *avctx, uint32_t  *nalSize, uint32_t *isAvc);
-+ 
-+ int av_getAVCStreamInfo(AVCodecContext *avctx, uint32_t  *nalSize, uint32_t *isAvc)
-+ {
-+       H264Context *h = avctx-&gt;priv_data;
-+       assert(h);
-+       *nalSize=h-&gt;nal_length_size;
-+       *isAvc=h-&gt;is_avc;
-+ 	return 1;
-+ 
-+   }
-+ /* MeanX */
-  
-  AVCodec h264_decoder = {
-      &quot;h264&quot;,
+--- libavcodec/h264.c.old	2010-12-20 13:49:22 +0000
++++ libavcodec/h264.c	2010-12-20 13:49:22 +0000
+@@ -3395,6 +3395,19 @@
+     return 0;
+ }
+ 
++/* MEANX */
++int av_getAVCStreamInfo(AVCodecContext *avctx, uint32_t  *nalSize, uint32_t *isAvc);
++
++int av_getAVCStreamInfo(AVCodecContext *avctx, uint32_t  *nalSize, uint32_t *isAvc)
++{
++      H264Context *h = avctx-&gt;priv_data;
++      assert(h);
++      *nalSize=h-&gt;nal_length_size;
++      *isAvc=h-&gt;is_avc;
++	return 1;
++
++  }
++/* MeanX */
+ 
+ AVCodec h264_decoder = {
+     &quot;h264&quot;,

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264_parser.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264_parser.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264_parser.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,8 +1,6 @@
-Index: libavcodec/h264_parser.c
-===================================================================
---- libavcodec/h264_parser.c	(revision 25831)
-+++ libavcodec/h264_parser.c	(working copy)
-@@ -30,9 +30,54 @@
+--- libavcodec/h264_parser.c.old	2010-12-20 13:49:23 +0000
++++ libavcodec/h264_parser.c	2010-12-20 13:49:23 +0000
+@@ -30,7 +30,52 @@
  #include &quot;h264data.h&quot;
  #include &quot;golomb.h&quot;
  
@@ -40,7 +38,7 @@
 +    int f=ctx-&gt;sps.nal_hrd_parameters_present_flag | ctx-&gt;sps.vcl_hrd_parameters_present_flag;
 +    info-&gt;hasStructInfo=f | ctx-&gt;sps.pic_struct_present_flag;;
 +    // While decoding SEI, if CpbDpbDelaysPresentFlags is there we skip cpb_removal_delay + dpb_output_delay
- 
++
 +    info-&gt;CpbDpbToSkip=0;
 +    if(f)
 +    {
@@ -53,7 +51,5 @@
 +}
 +// /MEANX
  
-+
+ 
  int ff_h264_find_frame_end(H264Context *h, const uint8_t *buf, int buf_size)
- {
-     int i;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,16 +1,14 @@
-*** libavcodec/mpeg12.c.old	Sat Mar 27 20:05:36 2010
---- libavcodec/mpeg12.c	Sat Mar 27 20:05:36 2010
-***************
-*** 1948,1953 ****
---- 1948,1958 ----
-          ff_er_frame_end(s);
-  
-          MPV_frame_end(s);
-+ /* MEANX */
-+   if(s-&gt;current_picture_ptr)
-+       s-&gt;current_picture_ptr-&gt;opaque=pict-&gt;opaque;
-+ /* MEANX */
-+ 
-  
-          if (s-&gt;pict_type == FF_B_TYPE || s-&gt;low_delay) {
-              *pict= *(AVFrame*)s-&gt;current_picture_ptr;
+--- libavcodec/mpeg12.c.old	2010-12-20 13:49:23 +0000
++++ libavcodec/mpeg12.c	2010-12-20 13:49:23 +0000
+@@ -1948,6 +1948,11 @@
+         ff_er_frame_end(s);
+ 
+         MPV_frame_end(s);
++/* MEANX */
++  if(s-&gt;current_picture_ptr)
++      s-&gt;current_picture_ptr-&gt;opaque=pict-&gt;opaque;
++/* MEANX */
++
+ 
+         if (s-&gt;pict_type == FF_B_TYPE || s-&gt;low_delay) {
+             *pict= *(AVFrame*)s-&gt;current_picture_ptr;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12enc.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12enc.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpeg12enc.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,231 +1,188 @@
-*** libavcodec/mpeg12enc.c.old	Sun Oct 18 17:15:07 2009
---- libavcodec/mpeg12enc.c	Sun Oct 18 17:15:07 2009
-***************
-*** 127,136 ****
---- 127,145 ----
-              s-&gt;frame_rate_index= i;
-          }
-      }
-+  /* MEANX 
-+ 
-      if(dmin)
-          return -1;
-      else
-          return 0;
-+   */
-+         if(dmin&gt;4)
-+    {
-+         av_log(0,AV_LOG_ERROR,&quot;We did a roundup ! Expect async!\n&quot;);
-+    }
-+         return 0; //MEANX
-+ 
-  }
-  
-  static av_cold int encode_init(AVCodecContext *avctx)
-***************
-*** 209,214 ****
---- 218,224 ----
-              put_sbits(&amp;s-&gt;pb, 12, s-&gt;width );
-              put_sbits(&amp;s-&gt;pb, 12, s-&gt;height);
-  
-+ #if 0 //MEANX
-              for(i=1; i&lt;15; i++){
-                  float error= aspect_ratio;
-                  if(s-&gt;codec_id == CODEC_ID_MPEG1VIDEO || i &lt;=1)
-***************
-*** 223,242 ****
-                      s-&gt;aspect_ratio_info= i;
-                  }
-              }
-  
-!             put_bits(&amp;s-&gt;pb, 4, s-&gt;aspect_ratio_info);
-!             put_bits(&amp;s-&gt;pb, 4, s-&gt;frame_rate_index);
-  
-!             if(s-&gt;avctx-&gt;rc_max_rate){
-!                 v = (s-&gt;avctx-&gt;rc_max_rate + 399) / 400;
-                  if (v &gt; 0x3ffff &amp;&amp; s-&gt;codec_id == CODEC_ID_MPEG1VIDEO)
-                      v = 0x3ffff;
-              }else{
-                  v= 0x3FFFF;
-              }
-  
-!             if(s-&gt;avctx-&gt;rc_buffer_size)
-!                 vbv_buffer_size = s-&gt;avctx-&gt;rc_buffer_size;
-              else
-                  /* VBV calculation: Scaled so that a VCD has the proper VBV size of 40 kilobytes */
-                  vbv_buffer_size = (( 20 * s-&gt;bit_rate) / (1151929 / 2)) * 8 * 1024;
---- 233,276 ----
-                      s-&gt;aspect_ratio_info= i;
-                  }
-              }
-+ #endif // MEANX
-+             //MEANX put_bits(&amp;s-&gt;pb, 4, s-&gt;aspect_ratio_info);
-+             //MEANX put_bits(&amp;s-&gt;pb, 4, s-&gt;frame_rate_index);
-+  // MEANX 4:3
-+   if(s-&gt;avctx-&gt;sample_aspect_ratio.num==16 &amp;&amp; s-&gt;avctx-&gt;sample_aspect_ratio.den==9)
-+             {
-+                 //printf(&quot;FFmpeg : Wide\n&quot;);
-+                 put_bits(&amp;s-&gt;pb,4,3); //16:9
-+             }
-+             else        //4:3
-+             {
-+               if(s-&gt;codec_id == CODEC_ID_MPEG2VIDEO)
-+                 put_bits(&amp;s-&gt;pb, 4, 2);
-+               else
-+                 put_bits(&amp;s-&gt;pb, 4, 12); // MPEG1
-+             }
-+ // /MEANX
-  
-! // //MEANX PULLDOWN            put_bits(&amp;s-&gt;pb, 4, s-&gt;frame_rate_index);
-! if((s-&gt;flags2 &amp; CODEC_FLAG2_32_PULLDOWN) &amp;&amp; (s-&gt;codec_id == CODEC_ID_MPEG2VIDEO))
-!             {           
-!                 put_bits(&amp;s-&gt;pb, 4,4);
-!             }
-!             else
-!             {                                  
-!                 put_bits(&amp;s-&gt;pb, 4, s-&gt;frame_rate_index);
-!             } //MEANX pulldown
-  
-!             if(s-&gt;avctx-&gt;rc_max_rate_header){ //MEANX we use header
-!                 v = (s-&gt;avctx-&gt;rc_max_rate_header + 399) / 400;
-                  if (v &gt; 0x3ffff &amp;&amp; s-&gt;codec_id == CODEC_ID_MPEG1VIDEO)
-                      v = 0x3ffff;
-              }else{
-                  v= 0x3FFFF;
-              }
-  
-!             if(s-&gt;avctx-&gt;rc_buffer_size_header) // MEANX we use header
-!                 vbv_buffer_size = s-&gt;avctx-&gt;rc_buffer_size_header;
-              else
-                  /* VBV calculation: Scaled so that a VCD has the proper VBV size of 40 kilobytes */
-                  vbv_buffer_size = (( 20 * s-&gt;bit_rate) / (1151929 / 2)) * 8 * 1024;
-***************
-*** 269,276 ****
-  
-                  put_bits(&amp;s-&gt;pb, 3, s-&gt;avctx-&gt;profile); //profile
-                  put_bits(&amp;s-&gt;pb, 4, s-&gt;avctx-&gt;level); //level
-  
--                 put_bits(&amp;s-&gt;pb, 1, s-&gt;progressive_sequence);
-                  put_bits(&amp;s-&gt;pb, 2, s-&gt;chroma_format);
-                  put_bits(&amp;s-&gt;pb, 2, s-&gt;width &gt;&gt;12);
-                  put_bits(&amp;s-&gt;pb, 2, s-&gt;height&gt;&gt;12);
---- 303,319 ----
-  
-                  put_bits(&amp;s-&gt;pb, 3, s-&gt;avctx-&gt;profile); //profile
-                  put_bits(&amp;s-&gt;pb, 4, s-&gt;avctx-&gt;level); //level
-+    // MEANX pulldown put_bits(&amp;s-&gt;pb, 1, s-&gt;progressive_sequence);
-+   // MEANX Pulldown
-+  if(s-&gt;flags2 &amp; CODEC_FLAG2_32_PULLDOWN) //MEANX
-+                         put_bits(&amp;s-&gt;pb, 1, 0);
-+                 else
-+                         put_bits(&amp;s-&gt;pb, 1, s-&gt;progressive_sequence);
-+ 
-+ 
-+ // /MEANX
-+ 
-  
-                  put_bits(&amp;s-&gt;pb, 2, s-&gt;chroma_format);
-                  put_bits(&amp;s-&gt;pb, 2, s-&gt;width &gt;&gt;12);
-                  put_bits(&amp;s-&gt;pb, 2, s-&gt;height&gt;&gt;12);
-***************
-*** 339,344 ****
---- 382,389 ----
-  
-  void mpeg1_encode_picture_header(MpegEncContext *s, int picture_number)
-  {
-+ 	int tff,rff; //MEANX
-+ 
-      mpeg1_encode_sequence_header(s);
-  
-      /* mpeg1 picture header */
-***************
-*** 375,380 ****
---- 420,468 ----
-  
-      s-&gt;frame_pred_frame_dct = 1;
-      if(s-&gt;codec_id == CODEC_ID_MPEG2VIDEO){
-+  /* MEANX -- Pulldown */
-+         if(s-&gt;flags2 &amp; CODEC_FLAG2_32_PULLDOWN)
-+         {
-+         
-+                 switch((s-&gt;picture_number - 
-+                           s-&gt;gop_picture_number)&amp;3)
-+                 {
-+                         case 0:
-+                         default:
-+                                 rff=1;
-+                                 tff=1;
-+                                 break;
-+                         case 1:
-+                                 rff=0;
-+                                 tff=0;
-+                                 break;
-+                         case 2:
-+                                 rff=1;
-+                                 tff=0;
-+                                 break;
-+                         case 3:
-+                                 rff=0;
-+                                 tff=1;
-+                                 break;
-+                 }               
+--- libavcodec/mpeg12enc.c.old	2010-12-20 13:49:24 +0000
++++ libavcodec/mpeg12enc.c	2010-12-20 13:49:24 +0000
+@@ -127,10 +127,19 @@
+             s-&gt;frame_rate_index= i;
+         }
+     }
++ /* MEANX 
++
+     if(dmin)
+         return -1;
+     else
+         return 0;
++  */
++        if(dmin&gt;4)
++   {
++        av_log(0,AV_LOG_ERROR,&quot;We did a roundup ! Expect async!\n&quot;);
++   }
++        return 0; //MEANX
++
+ }
+ 
+ static av_cold int encode_init(AVCodecContext *avctx)
+@@ -209,6 +218,7 @@
+             put_sbits(&amp;s-&gt;pb, 12, s-&gt;width );
+             put_sbits(&amp;s-&gt;pb, 12, s-&gt;height);
+ 
++#if 0 //MEANX
+             for(i=1; i&lt;15; i++){
+                 float error= aspect_ratio;
+                 if(s-&gt;codec_id == CODEC_ID_MPEG1VIDEO || i &lt;=1)
+@@ -223,20 +233,44 @@
+                     s-&gt;aspect_ratio_info= i;
+                 }
+             }
++#endif // MEANX
++            //MEANX put_bits(&amp;s-&gt;pb, 4, s-&gt;aspect_ratio_info);
++            //MEANX put_bits(&amp;s-&gt;pb, 4, s-&gt;frame_rate_index);
++ // MEANX 4:3
++  if(s-&gt;avctx-&gt;sample_aspect_ratio.num==16 &amp;&amp; s-&gt;avctx-&gt;sample_aspect_ratio.den==9)
++            {
++                //printf(&quot;FFmpeg : Wide\n&quot;);
++                put_bits(&amp;s-&gt;pb,4,3); //16:9
 +            }
-+         else
-+         {
-+                 if (s-&gt;progressive_sequence) 
-+                 {
-+                         tff=0; /* no repeat */
-+                 } else 
-+                 {
-+                         tff= s-&gt;current_picture_ptr-&gt;top_field_first;
-+                 }
-+                 rff=s-&gt;repeat_first_field;
-+         
-+         }
-+ 
-+ //               /MEANX pulldown
-+ 
-+ 
-+ 
-          put_header(s, EXT_START_CODE);
-          put_bits(&amp;s-&gt;pb, 4, 8); //pic ext
-          if (s-&gt;pict_type == FF_P_TYPE || s-&gt;pict_type == FF_B_TYPE) {
-***************
-*** 393,403 ****
---- 481,496 ----
-  
-          assert(s-&gt;picture_structure == PICT_FRAME);
-          put_bits(&amp;s-&gt;pb, 2, s-&gt;picture_structure);
-+ #if 0 //MEANX
-+ 
-          if (s-&gt;progressive_sequence) {
-              put_bits(&amp;s-&gt;pb, 1, 0); /* no repeat */
-          } else {
-              put_bits(&amp;s-&gt;pb, 1, s-&gt;current_picture_ptr-&gt;top_field_first);
-          }
-+ #endif
-+          put_bits(&amp;s-&gt;pb, 1, tff);  //MEANX PULLDOWN
-+ 
-          /* XXX: optimize the generation of this flag with entropy
-             measures */
-          s-&gt;frame_pred_frame_dct = s-&gt;progressive_sequence;
-***************
-*** 407,413 ****
-          put_bits(&amp;s-&gt;pb, 1, s-&gt;q_scale_type);
-          put_bits(&amp;s-&gt;pb, 1, s-&gt;intra_vlc_format);
-          put_bits(&amp;s-&gt;pb, 1, s-&gt;alternate_scan);
-!         put_bits(&amp;s-&gt;pb, 1, s-&gt;repeat_first_field);
-          s-&gt;progressive_frame = s-&gt;progressive_sequence;
-          put_bits(&amp;s-&gt;pb, 1, s-&gt;chroma_format == CHROMA_420 ? s-&gt;progressive_frame : 0); /* chroma_420_type */
-          put_bits(&amp;s-&gt;pb, 1, s-&gt;progressive_frame);
---- 500,509 ----
-          put_bits(&amp;s-&gt;pb, 1, s-&gt;q_scale_type);
-          put_bits(&amp;s-&gt;pb, 1, s-&gt;intra_vlc_format);
-          put_bits(&amp;s-&gt;pb, 1, s-&gt;alternate_scan);
-!  // MEANX put_bits(&amp;s-&gt;pb, 1, s-&gt;repeat_first_field);
-! 	put_bits(&amp;s-&gt;pb, 1, rff);
-!       // /MEANX
-! 
-          s-&gt;progressive_frame = s-&gt;progressive_sequence;
-          put_bits(&amp;s-&gt;pb, 1, s-&gt;chroma_format == CHROMA_420 ? s-&gt;progressive_frame : 0); /* chroma_420_type */
-          put_bits(&amp;s-&gt;pb, 1, s-&gt;progressive_frame);
++            else        //4:3
++            {
++              if(s-&gt;codec_id == CODEC_ID_MPEG2VIDEO)
++                put_bits(&amp;s-&gt;pb, 4, 2);
++              else
++                put_bits(&amp;s-&gt;pb, 4, 12); // MPEG1
++            }
++// /MEANX
+ 
+-            put_bits(&amp;s-&gt;pb, 4, s-&gt;aspect_ratio_info);
+-            put_bits(&amp;s-&gt;pb, 4, s-&gt;frame_rate_index);
++// //MEANX PULLDOWN            put_bits(&amp;s-&gt;pb, 4, s-&gt;frame_rate_index);
++if((s-&gt;flags2 &amp; CODEC_FLAG2_32_PULLDOWN) &amp;&amp; (s-&gt;codec_id == CODEC_ID_MPEG2VIDEO))
++            {           
++                put_bits(&amp;s-&gt;pb, 4,4);
++            }
++            else
++            {                                  
++                put_bits(&amp;s-&gt;pb, 4, s-&gt;frame_rate_index);
++            } //MEANX pulldown
+ 
+-            if(s-&gt;avctx-&gt;rc_max_rate){
+-                v = (s-&gt;avctx-&gt;rc_max_rate + 399) / 400;
++            if(s-&gt;avctx-&gt;rc_max_rate_header){ //MEANX we use header
++                v = (s-&gt;avctx-&gt;rc_max_rate_header + 399) / 400;
+                 if (v &gt; 0x3ffff &amp;&amp; s-&gt;codec_id == CODEC_ID_MPEG1VIDEO)
+                     v = 0x3ffff;
+             }else{
+                 v= 0x3FFFF;
+             }
+ 
+-            if(s-&gt;avctx-&gt;rc_buffer_size)
+-                vbv_buffer_size = s-&gt;avctx-&gt;rc_buffer_size;
++            if(s-&gt;avctx-&gt;rc_buffer_size_header) // MEANX we use header
++                vbv_buffer_size = s-&gt;avctx-&gt;rc_buffer_size_header;
+             else
+                 /* VBV calculation: Scaled so that a VCD has the proper VBV size of 40 kilobytes */
+                 vbv_buffer_size = (( 20 * s-&gt;bit_rate) / (1151929 / 2)) * 8 * 1024;
+@@ -269,8 +303,17 @@
+ 
+                 put_bits(&amp;s-&gt;pb, 3, s-&gt;avctx-&gt;profile); //profile
+                 put_bits(&amp;s-&gt;pb, 4, s-&gt;avctx-&gt;level); //level
++   // MEANX pulldown put_bits(&amp;s-&gt;pb, 1, s-&gt;progressive_sequence);
++  // MEANX Pulldown
++ if(s-&gt;flags2 &amp; CODEC_FLAG2_32_PULLDOWN) //MEANX
++                        put_bits(&amp;s-&gt;pb, 1, 0);
++                else
++                        put_bits(&amp;s-&gt;pb, 1, s-&gt;progressive_sequence);
++
++
++// /MEANX
++
+ 
+-                put_bits(&amp;s-&gt;pb, 1, s-&gt;progressive_sequence);
+                 put_bits(&amp;s-&gt;pb, 2, s-&gt;chroma_format);
+                 put_bits(&amp;s-&gt;pb, 2, s-&gt;width &gt;&gt;12);
+                 put_bits(&amp;s-&gt;pb, 2, s-&gt;height&gt;&gt;12);
+@@ -339,6 +382,8 @@
+ 
+ void mpeg1_encode_picture_header(MpegEncContext *s, int picture_number)
+ {
++	int tff,rff; //MEANX
++
+     mpeg1_encode_sequence_header(s);
+ 
+     /* mpeg1 picture header */
+@@ -375,6 +420,49 @@
+ 
+     s-&gt;frame_pred_frame_dct = 1;
+     if(s-&gt;codec_id == CODEC_ID_MPEG2VIDEO){
++ /* MEANX -- Pulldown */
++        if(s-&gt;flags2 &amp; CODEC_FLAG2_32_PULLDOWN)
++        {
++        
++                switch((s-&gt;picture_number - 
++                          s-&gt;gop_picture_number)&amp;3)
++                {
++                        case 0:
++                        default:
++                                rff=1;
++                                tff=1;
++                                break;
++                        case 1:
++                                rff=0;
++                                tff=0;
++                                break;
++                        case 2:
++                                rff=1;
++                                tff=0;
++                                break;
++                        case 3:
++                                rff=0;
++                                tff=1;
++                                break;
++                }               
++           }
++        else
++        {
++                if (s-&gt;progressive_sequence) 
++                {
++                        tff=0; /* no repeat */
++                } else 
++                {
++                        tff= s-&gt;current_picture_ptr-&gt;top_field_first;
++                }
++                rff=s-&gt;repeat_first_field;
++        
++        }
++
++//               /MEANX pulldown
++
++
++
+         put_header(s, EXT_START_CODE);
+         put_bits(&amp;s-&gt;pb, 4, 8); //pic ext
+         if (s-&gt;pict_type == FF_P_TYPE || s-&gt;pict_type == FF_B_TYPE) {
+@@ -393,11 +481,16 @@
+ 
+         assert(s-&gt;picture_structure == PICT_FRAME);
+         put_bits(&amp;s-&gt;pb, 2, s-&gt;picture_structure);
++#if 0 //MEANX
++
+         if (s-&gt;progressive_sequence) {
+             put_bits(&amp;s-&gt;pb, 1, 0); /* no repeat */
+         } else {
+             put_bits(&amp;s-&gt;pb, 1, s-&gt;current_picture_ptr-&gt;top_field_first);
+         }
++#endif
++         put_bits(&amp;s-&gt;pb, 1, tff);  //MEANX PULLDOWN
++
+         /* XXX: optimize the generation of this flag with entropy
+            measures */
+         s-&gt;frame_pred_frame_dct = s-&gt;progressive_sequence;
+@@ -407,7 +500,10 @@
+         put_bits(&amp;s-&gt;pb, 1, s-&gt;q_scale_type);
+         put_bits(&amp;s-&gt;pb, 1, s-&gt;intra_vlc_format);
+         put_bits(&amp;s-&gt;pb, 1, s-&gt;alternate_scan);
+-        put_bits(&amp;s-&gt;pb, 1, s-&gt;repeat_first_field);
++ // MEANX put_bits(&amp;s-&gt;pb, 1, s-&gt;repeat_first_field);
++	put_bits(&amp;s-&gt;pb, 1, rff);
++      // /MEANX
++
+         s-&gt;progressive_frame = s-&gt;progressive_sequence;
+         put_bits(&amp;s-&gt;pb, 1, s-&gt;chroma_format == CHROMA_420 ? s-&gt;progressive_frame : 0); /* chroma_420_type */
+         put_bits(&amp;s-&gt;pb, 1, s-&gt;progressive_frame);

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,23 +1,15 @@
-*** libavcodec/mpegvideo.c.old	Sun Sep  5 02:05:37 2010
---- libavcodec/mpegvideo.c	Sun Sep  5 02:05:37 2010
-***************
-*** 653,659 ****
-      FF_ALLOCZ_OR_GOTO(s-&gt;avctx, s-&gt;prev_pict_types, PREV_PICT_TYPES_BUFFER_SIZE, fail);
-  
-      s-&gt;parse_context.state= -1;
-!     if((s-&gt;avctx-&gt;debug&amp;(FF_DEBUG_VIS_QP|FF_DEBUG_VIS_MB_TYPE)) || (s-&gt;avctx-&gt;debug_mv)){
-         s-&gt;visualization_buffer[0] = av_malloc((s-&gt;mb_width*16 + 2*EDGE_WIDTH) * s-&gt;mb_height*16 + 2*EDGE_WIDTH);
-         s-&gt;visualization_buffer[1] = av_malloc((s-&gt;mb_width*16 + 2*EDGE_WIDTH) * s-&gt;mb_height*16 + 2*EDGE_WIDTH);
-         s-&gt;visualization_buffer[2] = av_malloc((s-&gt;mb_width*16 + 2*EDGE_WIDTH) * s-&gt;mb_height*16 + 2*EDGE_WIDTH);
---- 653,663 ----
-      FF_ALLOCZ_OR_GOTO(s-&gt;avctx, s-&gt;prev_pict_types, PREV_PICT_TYPES_BUFFER_SIZE, fail);
-  
-      s-&gt;parse_context.state= -1;
-!  //MEANX: Allocate them always, as they may be free when we decode 1st image
-! 
-!     // MEANXif((s-&gt;avctx-&gt;debug&amp;(FF_DEBUG_VIS_QP|FF_DEBUG_VIS_MB_TYPE)) || (s-&gt;avctx-&gt;debug_mv)){
-! if(1){ // MEANX
-! 
-         s-&gt;visualization_buffer[0] = av_malloc((s-&gt;mb_width*16 + 2*EDGE_WIDTH) * s-&gt;mb_height*16 + 2*EDGE_WIDTH);
-         s-&gt;visualization_buffer[1] = av_malloc((s-&gt;mb_width*16 + 2*EDGE_WIDTH) * s-&gt;mb_height*16 + 2*EDGE_WIDTH);
-         s-&gt;visualization_buffer[2] = av_malloc((s-&gt;mb_width*16 + 2*EDGE_WIDTH) * s-&gt;mb_height*16 + 2*EDGE_WIDTH);
+--- libavcodec/mpegvideo.c.old	2010-12-20 13:49:25 +0000
++++ libavcodec/mpegvideo.c	2010-12-20 13:49:25 +0000
+@@ -653,7 +653,11 @@
+     FF_ALLOCZ_OR_GOTO(s-&gt;avctx, s-&gt;prev_pict_types, PREV_PICT_TYPES_BUFFER_SIZE, fail);
+ 
+     s-&gt;parse_context.state= -1;
+-    if((s-&gt;avctx-&gt;debug&amp;(FF_DEBUG_VIS_QP|FF_DEBUG_VIS_MB_TYPE)) || (s-&gt;avctx-&gt;debug_mv)){
++ //MEANX: Allocate them always, as they may be free when we decode 1st image
++
++    // MEANXif((s-&gt;avctx-&gt;debug&amp;(FF_DEBUG_VIS_QP|FF_DEBUG_VIS_MB_TYPE)) || (s-&gt;avctx-&gt;debug_mv)){
++if(1){ // MEANX
++
+        s-&gt;visualization_buffer[0] = av_malloc((s-&gt;mb_width*16 + 2*EDGE_WIDTH) * s-&gt;mb_height*16 + 2*EDGE_WIDTH);
+        s-&gt;visualization_buffer[1] = av_malloc((s-&gt;mb_width*16 + 2*EDGE_WIDTH) * s-&gt;mb_height*16 + 2*EDGE_WIDTH);
+        s-&gt;visualization_buffer[2] = av_malloc((s-&gt;mb_width*16 + 2*EDGE_WIDTH) * s-&gt;mb_height*16 + 2*EDGE_WIDTH);

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo_enc.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo_enc.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo_enc.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,34 +1,30 @@
-*** libavcodec/mpegvideo_enc.c.old	Sat Mar 27 20:05:40 2010
---- libavcodec/mpegvideo_enc.c	Sat Mar 27 20:05:40 2010
-***************
-*** 367,378 ****
---- 367,380 ----
-  
-          av_log(avctx, AV_LOG_INFO, &quot;Warning vbv_delay will be set to 0xFFFF (=VBR) as the specified vbv buffer is too large for the given bitrate!\n&quot;);
-      }
-+ #if 0 //MEANX
-  
-      if((s-&gt;flags &amp; CODEC_FLAG_4MV) &amp;&amp; s-&gt;codec_id != CODEC_ID_MPEG4
-         &amp;&amp; s-&gt;codec_id != CODEC_ID_H263 &amp;&amp; s-&gt;codec_id != CODEC_ID_H263P &amp;&amp; s-&gt;codec_id != CODEC_ID_FLV1){
-          av_log(avctx, AV_LOG_ERROR, &quot;4MV not supported by codec\n&quot;);
-          return -1;
-      }
-+ #endif
-  
-      if(s-&gt;obmc &amp;&amp; s-&gt;avctx-&gt;mb_decision != FF_MB_DECISION_SIMPLE){
-          av_log(avctx, AV_LOG_ERROR, &quot;OBMC is only supported with simple mb decision\n&quot;);
-***************
-*** 413,422 ****
---- 415,426 ----
-          return -1;
-      }
-  
-+ #if 0 //MEANX
-      if(s-&gt;mpeg_quant &amp;&amp; s-&gt;codec_id != CODEC_ID_MPEG4){ //FIXME mpeg2 uses that too
-          av_log(avctx, AV_LOG_ERROR, &quot;mpeg2 style quantization not supported by codec\n&quot;);
-          return -1;
-      }
-+ #endif
-  
-      if((s-&gt;flags &amp; CODEC_FLAG_CBP_RD) &amp;&amp; !avctx-&gt;trellis){
-          av_log(avctx, AV_LOG_ERROR, &quot;CBP RD needs trellis quant\n&quot;);
+--- libavcodec/mpegvideo_enc.c.old	2010-12-20 13:49:26 +0000
++++ libavcodec/mpegvideo_enc.c	2010-12-20 13:49:26 +0000
+@@ -367,12 +367,14 @@
+ 
+         av_log(avctx, AV_LOG_INFO, &quot;Warning vbv_delay will be set to 0xFFFF (=VBR) as the specified vbv buffer is too large for the given bitrate!\n&quot;);
+     }
++#if 0 //MEANX
+ 
+     if((s-&gt;flags &amp; CODEC_FLAG_4MV) &amp;&amp; s-&gt;codec_id != CODEC_ID_MPEG4
+        &amp;&amp; s-&gt;codec_id != CODEC_ID_H263 &amp;&amp; s-&gt;codec_id != CODEC_ID_H263P &amp;&amp; s-&gt;codec_id != CODEC_ID_FLV1){
+         av_log(avctx, AV_LOG_ERROR, &quot;4MV not supported by codec\n&quot;);
+         return -1;
+     }
++#endif
+ 
+     if(s-&gt;obmc &amp;&amp; s-&gt;avctx-&gt;mb_decision != FF_MB_DECISION_SIMPLE){
+         av_log(avctx, AV_LOG_ERROR, &quot;OBMC is only supported with simple mb decision\n&quot;);
+@@ -413,10 +415,12 @@
+         return -1;
+     }
+ 
++#if 0 //MEANX
+     if(s-&gt;mpeg_quant &amp;&amp; s-&gt;codec_id != CODEC_ID_MPEG4){ //FIXME mpeg2 uses that too
+         av_log(avctx, AV_LOG_ERROR, &quot;mpeg2 style quantization not supported by codec\n&quot;);
+         return -1;
+     }
++#endif
+ 
+     if((s-&gt;flags &amp; CODEC_FLAG_CBP_RD) &amp;&amp; !avctx-&gt;trellis){
+         av_log(avctx, AV_LOG_ERROR, &quot;CBP RD needs trellis quant\n&quot;);

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,17 +1,15 @@
-*** libavcodec/utils.c.old	Fri Nov 26 17:53:37 2010
---- libavcodec/utils.c	Fri Nov 26 17:53:37 2010
-***************
-*** 655,664 ****
---- 655,666 ----
-  
-      if((avctx-&gt;codec-&gt;capabilities &amp; CODEC_CAP_DELAY) || avpkt-&gt;size){
-          //FIXME remove the check below _after_ ensuring that all audio check that the available space is enough
-+ #if 0 // MEANX : Silence
-          if(*frame_size_ptr &lt; AVCODEC_MAX_AUDIO_FRAME_SIZE){
-              av_log(avctx, AV_LOG_ERROR, &quot;buffer smaller than AVCODEC_MAX_AUDIO_FRAME_SIZE\n&quot;);
-              return -1;
-          }
-+ #endif
-          if(*frame_size_ptr &lt; FF_MIN_BUFFER_SIZE ||
-          *frame_size_ptr &lt; avctx-&gt;channels * avctx-&gt;frame_size * sizeof(int16_t)){
-              av_log(avctx, AV_LOG_ERROR, &quot;buffer %d too small\n&quot;, *frame_size_ptr);
+--- libavcodec/utils.c.old	2010-12-20 13:49:27 +0000
++++ libavcodec/utils.c	2010-12-20 13:49:27 +0000
+@@ -659,10 +659,12 @@
+ 
+     if((avctx-&gt;codec-&gt;capabilities &amp; CODEC_CAP_DELAY) || avpkt-&gt;size){
+         //FIXME remove the check below _after_ ensuring that all audio check that the available space is enough
++#if 0 // MEANX : Silence
+         if(*frame_size_ptr &lt; AVCODEC_MAX_AUDIO_FRAME_SIZE){
+             av_log(avctx, AV_LOG_ERROR, &quot;buffer smaller than AVCODEC_MAX_AUDIO_FRAME_SIZE\n&quot;);
+             return -1;
+         }
++#endif
+         if(*frame_size_ptr &lt; FF_MIN_BUFFER_SIZE ||
+         *frame_size_ptr &lt; avctx-&gt;channels * avctx-&gt;frame_size * sizeof(int16_t)){
+             av_log(avctx, AV_LOG_ERROR, &quot;buffer %d too small\n&quot;, *frame_size_ptr);

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_vc1dec.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_vc1dec.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_vc1dec.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,22 +1,14 @@
-*** libavcodec/vc1dec.c.old	Mon Aug  2 20:19:57 2010
---- libavcodec/vc1dec.c	Mon Aug  2 20:19:57 2010
-***************
-*** 3146,3152 ****
-      AVFrame *pict = data;
-      uint8_t *buf2 = NULL;
-      const uint8_t *buf_start = buf;
-! 
-      /* no supplementary picture */
-      if (buf_size == 0) {
-          /* special case for last picture */
---- 3146,3155 ----
-      AVFrame *pict = data;
-      uint8_t *buf2 = NULL;
-      const uint8_t *buf_start = buf;
-! /** MEANX **/
-!     if(s-&gt;flags&amp; CODEC_FLAG_LOW_DELAY)
-!         s-&gt;low_delay=1;
-! /** /MEANX **/
-      /* no supplementary picture */
-      if (buf_size == 0) {
-          /* special case for last picture */
+--- libavcodec/vc1dec.c.old	2010-12-20 13:49:28 +0000
++++ libavcodec/vc1dec.c	2010-12-20 13:49:28 +0000
+@@ -3146,7 +3146,10 @@
+     AVFrame *pict = data;
+     uint8_t *buf2 = NULL;
+     const uint8_t *buf_start = buf;
+-
++/** MEANX **/
++    if(s-&gt;flags&amp; CODEC_FLAG_LOW_DELAY)
++        s-&gt;low_delay=1;
++/** /MEANX **/
+     /* no supplementary picture */
+     if (buf_size == 0) {
+         /* special case for last picture */

Deleted: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_Makefile.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_Makefile.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_Makefile.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,19 +0,0 @@
-*** libavformat/Makefile.old	Sun Nov 28 09:30:28 2010
---- libavformat/Makefile	Sun Nov 28 09:30:28 2010
-***************
-*** 114,120 ****
-                                              riff.o isom.o rmdec.o rm.o
-  OBJS-$(CONFIG_MATROSKA_MUXER)            += matroskaenc.o matroska.o \
-                                              riff.o isom.o avc.o \
-!                                             flacenc_header.o
-  OBJS-$(CONFIG_MD5_MUXER)                 += md5enc.o
-  OBJS-$(CONFIG_MJPEG_DEMUXER)             += rawdec.o
-  OBJS-$(CONFIG_MJPEG_MUXER)               += rawenc.o
---- 114,120 ----
-                                              riff.o isom.o rmdec.o rm.o
-  OBJS-$(CONFIG_MATROSKA_MUXER)            += matroskaenc.o matroska.o \
-                                              riff.o isom.o avc.o \
-!                                             flacenc_header.o avlanguage.o
-  OBJS-$(CONFIG_MD5_MUXER)                 += md5enc.o
-  OBJS-$(CONFIG_MJPEG_DEMUXER)             += rawdec.o
-  OBJS-$(CONFIG_MJPEG_MUXER)               += rawenc.o

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_file.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_file.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_file.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,80 +1,78 @@
-*** libavformat/file.c.old	Tue Jul  6 19:51:26 2010
---- libavformat/file.c	Tue Jul  6 19:51:26 2010
-***************
-*** 30,35 ****
---- 30,104 ----
-  #include &lt;stdlib.h&gt;
-  #include &quot;os_support.h&quot;
-  
-+ // GRUNTSTER start
-+ #ifdef __WIN32
-+ #include &lt;windows.h&gt;
-+ 
-+ int utf8StringToWideChar(const char *utf8String, int utf8StringLength, wchar_t *wideCharString);
-+ int ADM_open(const char *path, int oflag, ...);
-+ 
-+ int utf8StringToWideChar(const char *utf8String, int utf8StringLength, wchar_t *wideCharString)
-+ {
-+ 	int wideCharStringLength = MultiByteToWideChar(CP_UTF8, 0, utf8String, utf8StringLength, NULL, 0);
-+ 
-+ 	if (wideCharString)
-+ 		MultiByteToWideChar(CP_UTF8, 0, utf8String, utf8StringLength, wideCharString, wideCharStringLength);
-+ 
-+ 	return wideCharStringLength;
-+ }
-+ 
-+ int ADM_open(const char *path, int oflag, ...)
-+ {
-+ 	int fileNameLength = utf8StringToWideChar(path, -1, NULL);
-+ 	wchar_t wcFile[fileNameLength];
-+ 	int creation = 0, access = 0;
-+ 	HANDLE hFile;
-+ 
-+ 	utf8StringToWideChar(path, -1, wcFile);
-+ 
-+ 	if (oflag &amp; O_WRONLY || oflag &amp; O_RDWR)
-+ 	{
-+ 		access = GENERIC_WRITE;
-+ 
-+ 		if (oflag &amp; O_RDWR)
-+ 			access |= GENERIC_READ;
-+ 
-+ 		if (oflag &amp; O_CREAT)
-+ 		{
-+ 			if (oflag &amp; O_EXCL)
-+ 				creation = CREATE_NEW;
-+ 			else if (oflag &amp; O_TRUNC)
-+ 				creation = CREATE_ALWAYS;
-+ 			else
-+ 				creation = OPEN_ALWAYS;
-+ 		}
-+ 		else if (oflag &amp; O_TRUNC)
-+ 			creation = TRUNCATE_EXISTING;
-+ 	}
-+ 	else if (oflag &amp; O_RDONLY)
-+ 		creation = OPEN_EXISTING;
-+ 
-+ 	if (creation &amp; GENERIC_WRITE)
-+ 	{
-+ 		hFile = CreateFileW(wcFile, access, 0, NULL, creation, 0, NULL);
-+ 
-+ 		if (hFile == INVALID_HANDLE_VALUE)
-+ 			return -1;
-+ 		else
-+ 			CloseHandle(hFile);
-+ 	}
-+ 
-+ 	hFile = CreateFileW(wcFile, access, FILE_SHARE_READ, NULL, creation, 0, NULL);
-+ 
-+ 	if (hFile == INVALID_HANDLE_VALUE)
-+ 		return -1;
-+ 	else
-+ 		return _open_osfhandle((intptr_t)hFile, oflag);
-+ }
-+ 
-+ #define open ADM_open
-+ #endif
-+ // GRUNTSTER end
-  
-  /* standard file protocol */
-  
+--- libavformat/file.c.old	2010-12-20 13:49:28 +0000
++++ libavformat/file.c	2010-12-20 13:49:29 +0000
+@@ -30,6 +30,75 @@
+ #include &lt;stdlib.h&gt;
+ #include &quot;os_support.h&quot;
+ 
++// GRUNTSTER start
++#ifdef __WIN32
++#include &lt;windows.h&gt;
++
++int utf8StringToWideChar(const char *utf8String, int utf8StringLength, wchar_t *wideCharString);
++int ADM_open(const char *path, int oflag, ...);
++
++int utf8StringToWideChar(const char *utf8String, int utf8StringLength, wchar_t *wideCharString)
++{
++	int wideCharStringLength = MultiByteToWideChar(CP_UTF8, 0, utf8String, utf8StringLength, NULL, 0);
++
++	if (wideCharString)
++		MultiByteToWideChar(CP_UTF8, 0, utf8String, utf8StringLength, wideCharString, wideCharStringLength);
++
++	return wideCharStringLength;
++}
++
++int ADM_open(const char *path, int oflag, ...)
++{
++	int fileNameLength = utf8StringToWideChar(path, -1, NULL);
++	wchar_t wcFile[fileNameLength];
++	int creation = 0, access = 0;
++	HANDLE hFile;
++
++	utf8StringToWideChar(path, -1, wcFile);
++
++	if (oflag &amp; O_WRONLY || oflag &amp; O_RDWR)
++	{
++		access = GENERIC_WRITE;
++
++		if (oflag &amp; O_RDWR)
++			access |= GENERIC_READ;
++
++		if (oflag &amp; O_CREAT)
++		{
++			if (oflag &amp; O_EXCL)
++				creation = CREATE_NEW;
++			else if (oflag &amp; O_TRUNC)
++				creation = CREATE_ALWAYS;
++			else
++				creation = OPEN_ALWAYS;
++		}
++		else if (oflag &amp; O_TRUNC)
++			creation = TRUNCATE_EXISTING;
++	}
++	else if (oflag &amp; O_RDONLY)
++		creation = OPEN_EXISTING;
++
++	if (creation &amp; GENERIC_WRITE)
++	{
++		hFile = CreateFileW(wcFile, access, 0, NULL, creation, 0, NULL);
++
++		if (hFile == INVALID_HANDLE_VALUE)
++			return -1;
++		else
++			CloseHandle(hFile);
++	}
++
++	hFile = CreateFileW(wcFile, access, FILE_SHARE_READ, NULL, creation, 0, NULL);
++
++	if (hFile == INVALID_HANDLE_VALUE)
++		return -1;
++	else
++		return _open_osfhandle((intptr_t)hFile, oflag);
++}
++
++#define open ADM_open
++#endif
++// GRUNTSTER end
+ 
+ /* standard file protocol */
+ 

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,22 +1,14 @@
-*** libavformat/isom.c.old	Fri Nov 26 17:53:40 2010
---- libavformat/isom.c	Fri Nov 26 17:53:40 2010
-***************
-*** 222,228 ****
-      { CODEC_ID_MP1, MKTAG('.', 'm', 'p', '1') }, /* MPEG layer 1 */
-      { CODEC_ID_MP2, MKTAG('.', 'm', 'p', '2') }, /* MPEG layer 2 */
-  
-!     { CODEC_ID_MP3, MKTAG('.', 'm', 'p', '3') }, /* MPEG layer 3 */ /* sample files at <A HREF="http://www.3ivx.com/showcase.html">http://www.3ivx.com/showcase.html</A> use this tag */
-      { CODEC_ID_MP3, 0x6D730055 }, /* MPEG layer 3 */
-  
-  /*  { CODEC_ID_OGG_VORBIS, MKTAG('O', 'g', 'g', 'S') }, *//* sample files at <A HREF="http://heroinewarrior.com/xmovie.php3">http://heroinewarrior.com/xmovie.php3</A> use this tag */
---- 222,231 ----
-      { CODEC_ID_MP1, MKTAG('.', 'm', 'p', '1') }, /* MPEG layer 1 */
-      { CODEC_ID_MP2, MKTAG('.', 'm', 'p', '2') }, /* MPEG layer 2 */
-  
-!     //MEANX { CODEC_ID_MP3, MKTAG('.', 'm', 'p', '3') }, /* MPEG layer 3 */ /* sample files at <A HREF="http://www.3ivx.com/showcase.html">http://www.3ivx.com/showcase.html</A> use this tag */
-!      { CODEC_ID_MP3, MKTAG( 'm', 'p', '4','a') },
-!      { CODEC_ID_MP2, MKTAG( 'm', 'p', '4', 'a') },
-!     // /MEANX
-      { CODEC_ID_MP3, 0x6D730055 }, /* MPEG layer 3 */
-  
-  /*  { CODEC_ID_OGG_VORBIS, MKTAG('O', 'g', 'g', 'S') }, *//* sample files at <A HREF="http://heroinewarrior.com/xmovie.php3">http://heroinewarrior.com/xmovie.php3</A> use this tag */
+--- libavformat/isom.c.old	2010-12-20 13:49:29 +0000
++++ libavformat/isom.c	2010-12-20 13:49:29 +0000
+@@ -222,7 +222,10 @@
+     { CODEC_ID_MP1, MKTAG('.', 'm', 'p', '1') }, /* MPEG layer 1 */
+     { CODEC_ID_MP2, MKTAG('.', 'm', 'p', '2') }, /* MPEG layer 2 */
+ 
+-    { CODEC_ID_MP3, MKTAG('.', 'm', 'p', '3') }, /* MPEG layer 3 */ /* sample files at <A HREF="http://www.3ivx.com/showcase.html">http://www.3ivx.com/showcase.html</A> use this tag */
++    //MEANX { CODEC_ID_MP3, MKTAG('.', 'm', 'p', '3') }, /* MPEG layer 3 */ /* sample files at <A HREF="http://www.3ivx.com/showcase.html">http://www.3ivx.com/showcase.html</A> use this tag */
++     { CODEC_ID_MP3, MKTAG( 'm', 'p', '4','a') },
++     { CODEC_ID_MP2, MKTAG( 'm', 'p', '4', 'a') },
++    // /MEANX
+     { CODEC_ID_MP3, 0x6D730055 }, /* MPEG layer 3 */
+ 
+ /*  { CODEC_ID_OGG_VORBIS, MKTAG('O', 'g', 'g', 'S') }, *//* sample files at <A HREF="http://heroinewarrior.com/xmovie.php3">http://heroinewarrior.com/xmovie.php3</A> use this tag */

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_matroskaenc.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_matroskaenc.c.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_matroskaenc.c.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,70 +1,64 @@
-*** libavformat/matroskaenc.c.old	Fri Nov 26 17:53:41 2010
---- libavformat/matroskaenc.c	Fri Nov 26 17:53:41 2010
-***************
-*** 410,415 ****
---- 410,416 ----
-  
-  static int put_xiph_codecpriv(AVFormatContext *s, ByteIOContext *pb, AVCodecContext *codec)
-  {
-+ #if 0 // MEANX avidemux does thing differently
-      uint8_t *header_start[3];
-      int header_len[3];
-      int first_header_size;
-***************
-*** 434,439 ****
---- 435,462 ----
-          put_buffer(pb, header_start[j], header_len[j]);
-  
-      return 0;
-+ #else
-+    // Not endian safe....
-+       uint32_t packetLen[3],*ptr=(uint32_t *)codec-&gt;extradata;
-+       uint8_t *data[3],i,j;
-+       if( 3*4+ptr[0]+ptr[1]+ptr[2]!=codec-&gt;extradata_size)
-+       {
-+         av_log(s, AV_LOG_ERROR, &quot;Broken avidemux xiph header.\n&quot;);
-+         return -1;
-+       }
-+       data[0]=codec-&gt;extradata+3*4;
-+       data[1]=data[0]+ptr[0];
-+       data[2]=data[1]+ptr[1];
-+       put_byte(pb, 2);                    // number packets - 1
-+       for (j = 0; j &lt; 2; j++) 
-+       {
-+           put_xiph_size(pb, ptr[j]);
-+       }
-+       for (j = 0; j &lt; 3; j++)
-+         put_buffer(pb, data[j], ptr[j]);
-+       
-+       return 0; // /MEANX
-+ #endif
-  }
-  
-  static void get_aac_sample_rates(AVFormatContext *s, AVCodecContext *codec, int *sample_rate, int *output_sample_rate)
-***************
-*** 552,557 ****
---- 575,598 ----
-          put_ebml_uint (pb, MATROSKA_ID_TRACKUID        , i + 1);
-          put_ebml_uint (pb, MATROSKA_ID_TRACKFLAGLACING , 0);    // no lacing (yet)
-  
-+  		/**  MEANX : Add a default duration for video **/
-+  		if(codec-&gt;codec_type==CODEC_TYPE_VIDEO)
-+  		{
-+  			if(codec-&gt;time_base.den &amp;&amp; codec-&gt;time_base.num)
-+  			{
-+  				int num = codec-&gt;time_base.num;
-+  				int den = codec-&gt;time_base.den;
-+  				unsigned int default_duration;
-+  				float period = num;
-+  
-+  				period /= den;
-+  				period *= 1000*1000*1000; // in ns
-+  				default_duration = (unsigned int)floor(period);
-+  				put_ebml_uint(pb, MATROSKA_ID_TRACKDEFAULTDURATION, default_duration);
-+  			}
-+  		}
-+  		/**  MEANX : Add a default duration for video **/
+--- libavformat/matroskaenc.c.old	2010-12-20 13:49:30 +0000
++++ libavformat/matroskaenc.c	2010-12-20 13:49:30 +0000
+@@ -410,6 +410,7 @@
+ 
+ static int put_xiph_codecpriv(AVFormatContext *s, ByteIOContext *pb, AVCodecContext *codec)
+ {
++#if 0 // MEANX avidemux does thing differently
+     uint8_t *header_start[3];
+     int header_len[3];
+     int first_header_size;
+@@ -434,6 +435,28 @@
+         put_buffer(pb, header_start[j], header_len[j]);
+ 
+     return 0;
++#else
++   // Not endian safe....
++      uint32_t packetLen[3],*ptr=(uint32_t *)codec-&gt;extradata;
++      uint8_t *data[3],i,j;
++      if( 3*4+ptr[0]+ptr[1]+ptr[2]!=codec-&gt;extradata_size)
++      {
++        av_log(s, AV_LOG_ERROR, &quot;Broken avidemux xiph header.\n&quot;);
++        return -1;
++      }
++      data[0]=codec-&gt;extradata+3*4;
++      data[1]=data[0]+ptr[0];
++      data[2]=data[1]+ptr[1];
++      put_byte(pb, 2);                    // number packets - 1
++      for (j = 0; j &lt; 2; j++) 
++      {
++          put_xiph_size(pb, ptr[j]);
++      }
++      for (j = 0; j &lt; 3; j++)
++        put_buffer(pb, data[j], ptr[j]);
++      
++      return 0; // /MEANX
++#endif
+ }
+ 
+ static void get_aac_sample_rates(AVFormatContext *s, AVCodecContext *codec, int *sample_rate, int *output_sample_rate)
+@@ -552,6 +575,24 @@
+         put_ebml_uint (pb, MATROSKA_ID_TRACKUID        , i + 1);
+         put_ebml_uint (pb, MATROSKA_ID_TRACKFLAGLACING , 0);    // no lacing (yet)
+ 
++ 		/**  MEANX : Add a default duration for video **/
++ 		if(codec-&gt;codec_type==CODEC_TYPE_VIDEO)
++ 		{
++ 			if(codec-&gt;time_base.den &amp;&amp; codec-&gt;time_base.num)
++ 			{
++ 				int num = codec-&gt;time_base.num;
++ 				int den = codec-&gt;time_base.den;
++ 				unsigned int default_duration;
++ 				float period = num;
 + 
-          if ((tag = av_metadata_get(st-&gt;metadata, &quot;title&quot;, NULL, 0)))
-              put_ebml_string(pb, MATROSKA_ID_TRACKNAME, tag-&gt;value);
-          tag = av_metadata_get(st-&gt;metadata, &quot;language&quot;, NULL, 0);
++ 				period /= den;
++ 				period *= 1000*1000*1000; // in ns
++ 				default_duration = (unsigned int)floor(period);
++ 				put_ebml_uint(pb, MATROSKA_ID_TRACKDEFAULTDURATION, default_duration);
++ 			}
++ 		}
++ 		/**  MEANX : Add a default duration for video **/
++
+         if ((tag = av_metadata_get(st-&gt;metadata, &quot;title&quot;, NULL, 0)))
+             put_ebml_string(pb, MATROSKA_ID_TRACKNAME, tag-&gt;value);
+         tag = av_metadata_get(st-&gt;metadata, &quot;language&quot;, NULL, 0);

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavutil_avutil.h.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavutil_avutil.h.patch	2010-12-20 13:36:10 UTC (rev 6853)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavutil_avutil.h.patch	2010-12-20 14:57:56 UTC (rev 6854)
@@ -1,18 +1,16 @@
-*** libavutil/avutil.h.old	Sat Jan 24 22:57:50 2009
---- libavutil/avutil.h	Sat Jan 24 22:57:49 2009
-***************
-*** 26,31 ****
---- 26,38 ----
-   * external API header
-   */
-  
-+ /* MEANX
-+  * - */
-+ #define ASMALIGN(ZEROBITS) &quot;.p2align &quot; #ZEROBITS &quot;\n\t&quot;
-+ /* /MEANX
-+  */
-+ 
-+ 
-  
-  #define AV_STRINGIFY(s)         AV_TOSTRING(s)
-  #define AV_TOSTRING(s) #s
+--- libavutil/avutil.h.old	2010-12-20 13:49:31 +0000
++++ libavutil/avutil.h	2010-12-20 13:49:31 +0000
+@@ -26,6 +26,13 @@
+  * external API header
+  */
+ 
++/* MEANX
++ * - */
++#define ASMALIGN(ZEROBITS) &quot;.p2align &quot; #ZEROBITS &quot;\n\t&quot;
++/* /MEANX
++ */
++
++
+ 
+ #define AV_STRINGIFY(s)         AV_TOSTRING(s)
+ #define AV_TOSTRING(s) #s


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004029.html">[Avidemux-svn-commit] r6853 - in	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264:	. qt4
</A></li>
	<LI>Next message: <A HREF="004031.html">[Avidemux-svn-commit] r6855 -	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_matroska
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4030">[ date ]</a>
              <a href="thread.html#4030">[ thread ]</a>
              <a href="subject.html#4030">[ subject ]</a>
              <a href="author.html#4030">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
