<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r3446 - in	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces:	ADM_GTK/ADM_dialog ADM_GTK/ADM_gui2 ADM_QT4/ADM_dialog ADM_commonUI
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2007-July/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3446%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces%3A%0A%09ADM_GTK/ADM_dialog%20ADM_GTK/ADM_gui2%20ADM_QT4/ADM_dialog%20ADM_commonUI&In-Reply-To=%3C200707261334.l6QDYLYs017021%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000720.html">
   <LINK REL="Next"  HREF="000722.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r3446 - in	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces:	ADM_GTK/ADM_dialog ADM_GTK/ADM_gui2 ADM_QT4/ADM_dialog ADM_commonUI</H1>
    <B>gruntster at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3446%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces%3A%0A%09ADM_GTK/ADM_dialog%20ADM_GTK/ADM_gui2%20ADM_QT4/ADM_dialog%20ADM_commonUI&In-Reply-To=%3C200707261334.l6QDYLYs017021%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r3446 - in	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces:	ADM_GTK/ADM_dialog ADM_GTK/ADM_gui2 ADM_QT4/ADM_dialog ADM_commonUI">gruntster at mail.berlios.de
       </A><BR>
    <I>Thu Jul 26 15:34:21 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000720.html">[Avidemux-svn-commit] r3445 - in	branches/avidemux_2.4_branch/avidemux: . ADM_ocr	ADM_userInterfaces/ADM_GTK/ADM_ocr	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_commonUI
</A></li>
        <LI>Next message: <A HREF="000722.html">[Avidemux-svn-commit] r3447 -	branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_asf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#721">[ date ]</a>
              <a href="thread.html#721">[ thread ]</a>
              <a href="subject.html#721">[ subject ]</a>
              <a href="author.html#721">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: gruntster
Date: 2007-07-26 15:33:46 +0200 (Thu, 26 Jul 2007)
New Revision: 3446

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_asharp.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_chromaShift.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_contrast.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_crop.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_eq2.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_equalizer.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_flyDialog.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_hue.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_mpdelogo.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_preview.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_srt.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/T_flyDialog.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyAsharp.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyAsharp.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyChromaShift.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyChromaShift.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyContrast.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyContrast.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyCrop.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyCrop.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyDialog.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyDialog.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyHue.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyHue.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyPreview.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.h
Log:
[Preview] centralise all resize logic to flyDialog + manually centre filter windows + optimise YUV &amp; RGB resizing

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_asharp.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_asharp.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_asharp.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -54,8 +54,6 @@
 static GtkWidget *dialog=NULL;
 static flyASharp *myCrop=NULL;
 
-extern float UI_calcZoomToFitScreen(GtkWindow* window, GtkWidget* drawingArea, uint32_t imageWidth, uint32_t imageHeight);
-
 //
 //      Video is in YV12 Colorspace
 //
@@ -71,19 +69,6 @@
         dialog=create_dialog1();
         gtk_register_dialog(dialog);
         gtk_window_set_title (GTK_WINDOW (dialog), _(&quot;ASHARP&quot;));
-
-		float zoom = UI_calcZoomToFitScreen(GTK_WINDOW(dialog), WID(drawingarea1), width, height);
-
-		uint32_t zoomW = width * zoom;
-		uint32_t zoomH = height * zoom;
-
-		gtk_widget_set_usize(WID(drawingarea1), zoomW, zoomH);
-
-		if (zoom &lt; 1)
-		{
-			gtk_window_set_position(GTK_WINDOW(dialog), GTK_WIN_POS_CENTER);
-		}
-
         gtk_widget_show(dialog);
 
         gtk_signal_connect(GTK_OBJECT(WID(drawingarea1)), &quot;expose_event&quot;,
@@ -99,7 +84,6 @@
           
         myCrop=new flyASharp( width, height,in,WID(drawingarea1),WID(hscale1));
         memcpy(&amp;(myCrop-&gt;param),param,sizeof(ASHARP_PARAM));
-		myCrop-&gt;resizeImage(zoomW, zoomH);
         myCrop-&gt;upload();
         myCrop-&gt;sliderChanged();
         ret=0;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_chromaShift.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_chromaShift.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_chromaShift.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -1,308 +1,293 @@
-/***************************************************************************
-                          ADM_guiChromaShift.cpp  -  description
-                             -------------------
-    begin                : Sun Aug 24 2003
-    copyright            : (C) 2002-2003 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &lt;config.h&gt;
-#include &lt;string.h&gt;
-#include &lt;stdio.h&gt;
-#include &lt;gdk/gdkkeysyms.h&gt;
-#include &lt;gtk/gtk.h&gt;
-# include &lt;math.h&gt;
-
-#include &quot;default.h&quot;
-#include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
-#include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-
-#include &quot;ADM_image.h&quot;
-#include &quot;ADM_video/ADM_genvideo.hxx&quot;
-#include &quot;ADM_colorspace/ADM_rgb.h&quot;
-#include &quot;ADM_assert.h&quot;
-#include &quot;DIA_flyDialog.h&quot;
-#include &quot;ADM_videoFilter/ADM_vidChromaShift_param.h&quot;
-#include &quot;DIA_flyChromaShift.h&quot;
-
-static int lock=0;
-
-static GtkWidget *dialog;
-static GtkWidget *create_ChromaShift( void );
-
-
-static void read( void );
-static void upload ( void );
-static gboolean gui_draw( void );
-static gboolean gui_update( void );
-static gboolean slider_update( void );
-static void update(void);
-
-static flyChromaShift *myCrop=NULL;
-
-extern float UI_calcZoomToFitScreen(GtkWindow* window, GtkWidget* drawingArea, uint32_t imageWidth, uint32_t imageHeight);
-//**************************************
-
-uint8_t DIA_getChromaShift( AVDMGenericVideoStream *instream,CHROMASHIFT_PARAM    *param );
-uint8_t DIA_getChromaShift( AVDMGenericVideoStream *in,CHROMASHIFT_PARAM    *param )
-{
-uint8_t ret=0;
-  
-        uint32_t width,height;
-
-        // Allocate space for green-ised video
-        width=in-&gt;getInfo()-&gt;width;
-        height=in-&gt;getInfo()-&gt;height;
-
-        dialog=create_ChromaShift();
-        gtk_register_dialog(dialog);
-        gtk_window_set_title (GTK_WINDOW (dialog), _(&quot;ASHARP&quot;));
-
-		float zoom = UI_calcZoomToFitScreen(GTK_WINDOW(dialog), WID(drawingarea1), width, height);
+/***************************************************************************
+                          ADM_guiChromaShift.cpp  -  description
+                             -------------------
+    begin                : Sun Aug 24 2003
+    copyright            : (C) 2002-2003 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
 
-		uint32_t zoomW = width * zoom;
-		uint32_t zoomH = height * zoom;
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &lt;config.h&gt;
+#include &lt;string.h&gt;
+#include &lt;stdio.h&gt;
+#include &lt;gdk/gdkkeysyms.h&gt;
+#include &lt;gtk/gtk.h&gt;
+# include &lt;math.h&gt;
 
-		gtk_widget_set_usize(WID(drawingarea1), zoomW, zoomH);
+#include &quot;default.h&quot;
+#include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
+#include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
 
-		if (zoom &lt; 1)
-		{
-			gtk_window_set_position(GTK_WINDOW(dialog), GTK_WIN_POS_CENTER);
-		}
-
-        gtk_widget_show(dialog);
-	
-        myCrop=new flyChromaShift( width, height,in,WID(drawingarea1),WID(hscale));
-        memcpy(&amp;(myCrop-&gt;param),param,sizeof(CHROMASHIFT_PARAM));
-		myCrop-&gt;resizeImage(zoomW, zoomH);
-        myCrop-&gt;upload();
-        myCrop-&gt;sliderChanged();
-        
-        gtk_signal_connect(GTK_OBJECT(WID(drawingarea1)), &quot;expose_event&quot;,
-            GTK_SIGNAL_FUNC(gui_draw),
-            NULL);
-        
-        gtk_signal_connect (GTK_OBJECT(WID( spinbutton_U)), &quot;value_changed&quot;,
-                    GTK_SIGNAL_FUNC (gui_update),
-                    NULL);
-        gtk_signal_connect (GTK_OBJECT(WID( spinbutton_V)), &quot;value_changed&quot;,
-                    GTK_SIGNAL_FUNC (gui_update),
-                    NULL);
-        gtk_signal_connect (GTK_OBJECT(WID( spinbutton_V)), &quot;value_changed&quot;,
-                    GTK_SIGNAL_FUNC (gui_update),
-                    NULL);
-         gtk_signal_connect (GTK_OBJECT(WID( hscale)), &quot;value_changed&quot;,
-                    GTK_SIGNAL_FUNC (slider_update),
-                    NULL);
-
-          
-       
-        ret=0;
-        int response;
-        response=gtk_dialog_run(GTK_DIALOG(dialog));
-
-        if(response==GTK_RESPONSE_OK)
-        {
-            myCrop-&gt;download();
-            memcpy(param,&amp;(myCrop-&gt;param),sizeof(CHROMASHIFT_PARAM));
-            ret=1;
-        }
-        gtk_unregister_dialog(dialog);
-        gtk_widget_destroy(dialog);
-        delete myCrop;
-        return ret;
-}
-      
-/**********************************/
-void read( void )
-{
-	myCrop-&gt;download();
-}
-void upload ( void )
-{
-	myCrop-&gt;upload();
-}
-gboolean slider_update( void )
-{
-        myCrop-&gt;sliderChanged();
-        return true;
-}
-gboolean gui_update( void)
-{
-  if(lock) return true;
-      myCrop-&gt;update();
-  return true;
-}
-gboolean gui_draw( void )
-{
-	myCrop-&gt;display();
-	return true;
-}
-
-/******************************/
-#define SPIN_GET(x,y) {y= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(lookup_widget(dialog,#x))) ;\
-				printf(#x&quot;:%d\n&quot;, y);}
-
-#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(lookup_widget(dialog,#x)),(gfloat)y) ; printf(#x&quot;:%d\n&quot;, y);}
-
-
-uint8_t    flyChromaShift::upload(void)
-{
-        SPIN_SET(spinbutton_U,param.u);
-        SPIN_SET(spinbutton_V,param.v);
-  return 1;
-}
-uint8_t    flyChromaShift::download(void)
-{
-        SPIN_GET(spinbutton_U,param.u);
-        SPIN_GET(spinbutton_V,param.v);
-  
-  return 1;
-}
-
-
-/*----------------------------------------------------------------*/
-
-GtkWidget*
-create_ChromaShift (void)
-{
-  GtkWidget *ChromaShift;
-  GtkWidget *dialog_vbox1;
-  GtkWidget *vbox1;
-  GtkWidget *table1;
-  GtkWidget *label1;
-  GtkWidget *label2;
-  GtkObject *spinbutton_U_adj;
-  GtkWidget *spinbutton_U;
-  GtkObject *spinbutton_V_adj;
-  GtkWidget *spinbutton_V;
-  GtkWidget *hscale;
-  GtkWidget *frame1;
-  GtkWidget *alignment1;
-  GtkWidget *drawingarea1;
-  GtkWidget *label3;
-  GtkWidget *dialog_action_area1;
-  GtkWidget *cancelbutton1;
-  GtkWidget *applybutton1;
-  GtkWidget *okbutton1;
-
-  ChromaShift = gtk_dialog_new ();
-  gtk_window_set_title (GTK_WINDOW (ChromaShift), _(&quot;ChromaShift&quot;));
-  gtk_window_set_type_hint (GTK_WINDOW (ChromaShift), GDK_WINDOW_TYPE_HINT_DIALOG);
-
-  dialog_vbox1 = GTK_DIALOG (ChromaShift)-&gt;vbox;
-  gtk_widget_show (dialog_vbox1);
-
-  vbox1 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox1);
-  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
-
-  table1 = gtk_table_new (2, 2, FALSE);
-  gtk_widget_show (table1);
-  gtk_box_pack_start (GTK_BOX (vbox1), table1, FALSE, FALSE, 0);
-
-  label1 = gtk_label_new (_(&quot;U Shift :&quot;));
-  gtk_widget_show (label1);
-  gtk_table_attach (GTK_TABLE (table1), label1, 0, 1, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label1), 0, 0.5);
-
-  label2 = gtk_label_new (_(&quot;V Shift :&quot;));
-  gtk_widget_show (label2);
-  gtk_table_attach (GTK_TABLE (table1), label2, 0, 1, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label2), 0, 0.5);
-
-  spinbutton_U_adj = gtk_adjustment_new (0, -32, 32, 1, 10, 10);
-  spinbutton_U = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton_U_adj), 1, 0);
-  gtk_widget_show (spinbutton_U);
-  gtk_table_attach (GTK_TABLE (table1), spinbutton_U, 1, 2, 0, 1,
-                    (GtkAttachOptions) (0),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton_U), TRUE);
-
-  spinbutton_V_adj = gtk_adjustment_new (0, -32, 32, 1, 10, 10);
-  spinbutton_V = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton_V_adj), 1, 0);
-  gtk_widget_show (spinbutton_V);
-  gtk_table_attach (GTK_TABLE (table1), spinbutton_V, 1, 2, 1, 2,
-                    (GtkAttachOptions) (0),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton_V), TRUE);
-
-  hscale = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 0, 100, 1, 1, 1)));
-  gtk_widget_show (hscale);
-  gtk_box_pack_start (GTK_BOX (vbox1), hscale, FALSE, FALSE, 0);
-  gtk_scale_set_digits (GTK_SCALE (hscale), 0);
-
-  frame1 = gtk_frame_new (NULL);
-  gtk_widget_show (frame1);
-  gtk_box_pack_start (GTK_BOX (vbox1), frame1, TRUE, TRUE, 0);
-  gtk_frame_set_shadow_type (GTK_FRAME (frame1), GTK_SHADOW_NONE);
-
-  alignment1 = gtk_alignment_new (0.5, 0.5, 1, 1);
-  gtk_widget_show (alignment1);
-  gtk_container_add (GTK_CONTAINER (frame1), alignment1);
-  gtk_alignment_set_padding (GTK_ALIGNMENT (alignment1), 0, 0, 12, 0);
-
-  drawingarea1 = gtk_drawing_area_new ();
-  gtk_widget_show (drawingarea1);
-  gtk_container_add (GTK_CONTAINER (alignment1), drawingarea1);
-
-  label3 = gtk_label_new (_(&quot;&lt;b&gt;Preview&lt;/b&gt;&quot;));
-  gtk_widget_show (label3);
-  gtk_frame_set_label_widget (GTK_FRAME (frame1), label3);
-  gtk_label_set_use_markup (GTK_LABEL (label3), TRUE);
-
-  dialog_action_area1 = GTK_DIALOG (ChromaShift)-&gt;action_area;
-  gtk_widget_show (dialog_action_area1);
-  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
-
-  cancelbutton1 = gtk_button_new_from_stock (&quot;gtk-cancel&quot;);
-  gtk_widget_show (cancelbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (ChromaShift), cancelbutton1, GTK_RESPONSE_CANCEL);
-  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
-
-  applybutton1 = gtk_button_new_from_stock (&quot;gtk-apply&quot;);
-  gtk_widget_show (applybutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (ChromaShift), applybutton1, GTK_RESPONSE_APPLY);
-  GTK_WIDGET_SET_FLAGS (applybutton1, GTK_CAN_DEFAULT);
-
-  okbutton1 = gtk_button_new_from_stock (&quot;gtk-ok&quot;);
-  gtk_widget_show (okbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (ChromaShift), okbutton1, GTK_RESPONSE_OK);
-  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
-
-  /* Store pointers to all widgets, for use by lookup_widget(). */
-  GLADE_HOOKUP_OBJECT_NO_REF (ChromaShift, ChromaShift, &quot;ChromaShift&quot;);
-  GLADE_HOOKUP_OBJECT_NO_REF (ChromaShift, dialog_vbox1, &quot;dialog_vbox1&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, vbox1, &quot;vbox1&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, table1, &quot;table1&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, label1, &quot;label1&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, label2, &quot;label2&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, spinbutton_U, &quot;spinbutton_U&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, spinbutton_V, &quot;spinbutton_V&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, hscale, &quot;hscale&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, frame1, &quot;frame1&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, alignment1, &quot;alignment1&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, drawingarea1, &quot;drawingarea1&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, label3, &quot;label3&quot;);
-  GLADE_HOOKUP_OBJECT_NO_REF (ChromaShift, dialog_action_area1, &quot;dialog_action_area1&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, cancelbutton1, &quot;cancelbutton1&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, applybutton1, &quot;applybutton1&quot;);
-  GLADE_HOOKUP_OBJECT (ChromaShift, okbutton1, &quot;okbutton1&quot;);
-
-  return ChromaShift;
-}
-
-
+#include &quot;ADM_image.h&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+#include &quot;ADM_colorspace/ADM_rgb.h&quot;
+#include &quot;ADM_assert.h&quot;
+#include &quot;DIA_flyDialog.h&quot;
+#include &quot;ADM_videoFilter/ADM_vidChromaShift_param.h&quot;
+#include &quot;DIA_flyChromaShift.h&quot;
+
+static int lock=0;
+
+static GtkWidget *dialog;
+static GtkWidget *create_ChromaShift( void );
+
+
+static void read( void );
+static void upload ( void );
+static gboolean gui_draw( void );
+static gboolean gui_update( void );
+static gboolean slider_update( void );
+static void update(void);
+
+static flyChromaShift *myCrop=NULL;
+
+//**************************************
+
+uint8_t DIA_getChromaShift( AVDMGenericVideoStream *instream,CHROMASHIFT_PARAM    *param );
+uint8_t DIA_getChromaShift( AVDMGenericVideoStream *in,CHROMASHIFT_PARAM    *param )
+{
+uint8_t ret=0;
+  
+        uint32_t width,height;
+
+        // Allocate space for green-ised video
+        width=in-&gt;getInfo()-&gt;width;
+        height=in-&gt;getInfo()-&gt;height;
+
+        dialog=create_ChromaShift();
+        gtk_register_dialog(dialog);
+        gtk_window_set_title (GTK_WINDOW (dialog), _(&quot;ASHARP&quot;));
+        gtk_widget_show(dialog);
+	
+        myCrop=new flyChromaShift( width, height,in,WID(drawingarea1),WID(hscale));
+        memcpy(&amp;(myCrop-&gt;param),param,sizeof(CHROMASHIFT_PARAM));
+        myCrop-&gt;upload();
+        myCrop-&gt;sliderChanged();
+        
+        gtk_signal_connect(GTK_OBJECT(WID(drawingarea1)), &quot;expose_event&quot;,
+            GTK_SIGNAL_FUNC(gui_draw),
+            NULL);
+        
+        gtk_signal_connect (GTK_OBJECT(WID( spinbutton_U)), &quot;value_changed&quot;,
+                    GTK_SIGNAL_FUNC (gui_update),
+                    NULL);
+        gtk_signal_connect (GTK_OBJECT(WID( spinbutton_V)), &quot;value_changed&quot;,
+                    GTK_SIGNAL_FUNC (gui_update),
+                    NULL);
+        gtk_signal_connect (GTK_OBJECT(WID( spinbutton_V)), &quot;value_changed&quot;,
+                    GTK_SIGNAL_FUNC (gui_update),
+                    NULL);
+         gtk_signal_connect (GTK_OBJECT(WID( hscale)), &quot;value_changed&quot;,
+                    GTK_SIGNAL_FUNC (slider_update),
+                    NULL);
+
+          
+       
+        ret=0;
+        int response;
+        response=gtk_dialog_run(GTK_DIALOG(dialog));
+
+        if(response==GTK_RESPONSE_OK)
+        {
+            myCrop-&gt;download();
+            memcpy(param,&amp;(myCrop-&gt;param),sizeof(CHROMASHIFT_PARAM));
+            ret=1;
+        }
+        gtk_unregister_dialog(dialog);
+        gtk_widget_destroy(dialog);
+        delete myCrop;
+        return ret;
+}
+      
+/**********************************/
+void read( void )
+{
+	myCrop-&gt;download();
+}
+void upload ( void )
+{
+	myCrop-&gt;upload();
+}
+gboolean slider_update( void )
+{
+        myCrop-&gt;sliderChanged();
+        return true;
+}
+gboolean gui_update( void)
+{
+  if(lock) return true;
+      myCrop-&gt;update();
+  return true;
+}
+gboolean gui_draw( void )
+{
+	myCrop-&gt;display();
+	return true;
+}
+
+/******************************/
+#define SPIN_GET(x,y) {y= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(lookup_widget(dialog,#x))) ;\
+				printf(#x&quot;:%d\n&quot;, y);}
+
+#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(lookup_widget(dialog,#x)),(gfloat)y) ; printf(#x&quot;:%d\n&quot;, y);}
+
+
+uint8_t    flyChromaShift::upload(void)
+{
+        SPIN_SET(spinbutton_U,param.u);
+        SPIN_SET(spinbutton_V,param.v);
+  return 1;
+}
+uint8_t    flyChromaShift::download(void)
+{
+        SPIN_GET(spinbutton_U,param.u);
+        SPIN_GET(spinbutton_V,param.v);
+  
+  return 1;
+}
+
+
+/*----------------------------------------------------------------*/
+
+GtkWidget*
+create_ChromaShift (void)
+{
+  GtkWidget *ChromaShift;
+  GtkWidget *dialog_vbox1;
+  GtkWidget *vbox1;
+  GtkWidget *table1;
+  GtkWidget *label1;
+  GtkWidget *label2;
+  GtkObject *spinbutton_U_adj;
+  GtkWidget *spinbutton_U;
+  GtkObject *spinbutton_V_adj;
+  GtkWidget *spinbutton_V;
+  GtkWidget *hscale;
+  GtkWidget *frame1;
+  GtkWidget *alignment1;
+  GtkWidget *drawingarea1;
+  GtkWidget *label3;
+  GtkWidget *dialog_action_area1;
+  GtkWidget *cancelbutton1;
+  GtkWidget *applybutton1;
+  GtkWidget *okbutton1;
+
+  ChromaShift = gtk_dialog_new ();
+  gtk_window_set_title (GTK_WINDOW (ChromaShift), _(&quot;ChromaShift&quot;));
+  gtk_window_set_type_hint (GTK_WINDOW (ChromaShift), GDK_WINDOW_TYPE_HINT_DIALOG);
+
+  dialog_vbox1 = GTK_DIALOG (ChromaShift)-&gt;vbox;
+  gtk_widget_show (dialog_vbox1);
+
+  vbox1 = gtk_vbox_new (FALSE, 0);
+  gtk_widget_show (vbox1);
+  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
+
+  table1 = gtk_table_new (2, 2, FALSE);
+  gtk_widget_show (table1);
+  gtk_box_pack_start (GTK_BOX (vbox1), table1, FALSE, FALSE, 0);
+
+  label1 = gtk_label_new (_(&quot;U Shift :&quot;));
+  gtk_widget_show (label1);
+  gtk_table_attach (GTK_TABLE (table1), label1, 0, 1, 0, 1,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_misc_set_alignment (GTK_MISC (label1), 0, 0.5);
+
+  label2 = gtk_label_new (_(&quot;V Shift :&quot;));
+  gtk_widget_show (label2);
+  gtk_table_attach (GTK_TABLE (table1), label2, 0, 1, 1, 2,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_misc_set_alignment (GTK_MISC (label2), 0, 0.5);
+
+  spinbutton_U_adj = gtk_adjustment_new (0, -32, 32, 1, 10, 10);
+  spinbutton_U = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton_U_adj), 1, 0);
+  gtk_widget_show (spinbutton_U);
+  gtk_table_attach (GTK_TABLE (table1), spinbutton_U, 1, 2, 0, 1,
+                    (GtkAttachOptions) (0),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton_U), TRUE);
+
+  spinbutton_V_adj = gtk_adjustment_new (0, -32, 32, 1, 10, 10);
+  spinbutton_V = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton_V_adj), 1, 0);
+  gtk_widget_show (spinbutton_V);
+  gtk_table_attach (GTK_TABLE (table1), spinbutton_V, 1, 2, 1, 2,
+                    (GtkAttachOptions) (0),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton_V), TRUE);
+
+  hscale = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 0, 100, 1, 1, 1)));
+  gtk_widget_show (hscale);
+  gtk_box_pack_start (GTK_BOX (vbox1), hscale, FALSE, FALSE, 0);
+  gtk_scale_set_digits (GTK_SCALE (hscale), 0);
+
+  frame1 = gtk_frame_new (NULL);
+  gtk_widget_show (frame1);
+  gtk_box_pack_start (GTK_BOX (vbox1), frame1, TRUE, TRUE, 0);
+  gtk_frame_set_shadow_type (GTK_FRAME (frame1), GTK_SHADOW_NONE);
+
+  alignment1 = gtk_alignment_new (0.5, 0.5, 1, 1);
+  gtk_widget_show (alignment1);
+  gtk_container_add (GTK_CONTAINER (frame1), alignment1);
+  gtk_alignment_set_padding (GTK_ALIGNMENT (alignment1), 0, 0, 12, 0);
+
+  drawingarea1 = gtk_drawing_area_new ();
+  gtk_widget_show (drawingarea1);
+  gtk_container_add (GTK_CONTAINER (alignment1), drawingarea1);
+
+  label3 = gtk_label_new (_(&quot;&lt;b&gt;Preview&lt;/b&gt;&quot;));
+  gtk_widget_show (label3);
+  gtk_frame_set_label_widget (GTK_FRAME (frame1), label3);
+  gtk_label_set_use_markup (GTK_LABEL (label3), TRUE);
+
+  dialog_action_area1 = GTK_DIALOG (ChromaShift)-&gt;action_area;
+  gtk_widget_show (dialog_action_area1);
+  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
+
+  cancelbutton1 = gtk_button_new_from_stock (&quot;gtk-cancel&quot;);
+  gtk_widget_show (cancelbutton1);
+  gtk_dialog_add_action_widget (GTK_DIALOG (ChromaShift), cancelbutton1, GTK_RESPONSE_CANCEL);
+  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
+
+  applybutton1 = gtk_button_new_from_stock (&quot;gtk-apply&quot;);
+  gtk_widget_show (applybutton1);
+  gtk_dialog_add_action_widget (GTK_DIALOG (ChromaShift), applybutton1, GTK_RESPONSE_APPLY);
+  GTK_WIDGET_SET_FLAGS (applybutton1, GTK_CAN_DEFAULT);
+
+  okbutton1 = gtk_button_new_from_stock (&quot;gtk-ok&quot;);
+  gtk_widget_show (okbutton1);
+  gtk_dialog_add_action_widget (GTK_DIALOG (ChromaShift), okbutton1, GTK_RESPONSE_OK);
+  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
+
+  /* Store pointers to all widgets, for use by lookup_widget(). */
+  GLADE_HOOKUP_OBJECT_NO_REF (ChromaShift, ChromaShift, &quot;ChromaShift&quot;);
+  GLADE_HOOKUP_OBJECT_NO_REF (ChromaShift, dialog_vbox1, &quot;dialog_vbox1&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, vbox1, &quot;vbox1&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, table1, &quot;table1&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, label1, &quot;label1&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, label2, &quot;label2&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, spinbutton_U, &quot;spinbutton_U&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, spinbutton_V, &quot;spinbutton_V&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, hscale, &quot;hscale&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, frame1, &quot;frame1&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, alignment1, &quot;alignment1&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, drawingarea1, &quot;drawingarea1&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, label3, &quot;label3&quot;);
+  GLADE_HOOKUP_OBJECT_NO_REF (ChromaShift, dialog_action_area1, &quot;dialog_action_area1&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, cancelbutton1, &quot;cancelbutton1&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, applybutton1, &quot;applybutton1&quot;);
+  GLADE_HOOKUP_OBJECT (ChromaShift, okbutton1, &quot;okbutton1&quot;);
+
+  return ChromaShift;
+}
+
+

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_contrast.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_contrast.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_contrast.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -1,310 +1,294 @@
-/***************************************************************************
-                          ADM_guiContrast.cpp  -  description
-                             -------------------
-    begin                : Mon Sep 23 2002
-    copyright            : (C) 2002 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-
-#include &lt;gtk/gtk.h&gt;
-#include &lt;time.h&gt;
-#include &lt;sys/time.h&gt;
-#include &lt;math.h&gt;
-
-
-#include &quot;fourcc.h&quot;
-#include &quot;avio.hxx&quot;
-
-#include &quot;avi_vars.h&quot;
-#ifdef HAVE_ENCODER
-
-
-#include &quot;ADM_editor/ADM_edit.hxx&quot;
-#include &quot;ADM_video/ADM_genvideo.hxx&quot;
-#include &quot;ADM_video/ADM_vidContrast.h&quot;
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-#include &quot;ADM_colorspace/ADM_rgb.h&quot;
-#include &quot;ADM_toolkit_gtk/ADM_gladeSupport.h&quot;
-#include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
-#include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
-#include &lt;ADM_assert.h&gt;
-#include &quot;DIA_flyDialog.h&quot;
-#include &quot;DIA_flyContrast.h&quot;
-
-/********************************************************************/
-static GtkWidget *create_dialog1 (void);
-static GtkWidget *dialog = NULL;
-
-static gboolean gui_draw (GtkWidget * widget,
-			  GdkEventExpose * event, gpointer user_data);
-static void gui_update (GtkButton * button, gpointer user_data);
-static void frame_changed( void );
-
-static int lock=0;
-static flyContrast *myCrop=NULL;
-
-extern float UI_calcZoomToFitScreen(GtkWindow* window, GtkWidget* drawingArea, uint32_t imageWidth, uint32_t imageHeight);
-
-/********************************************************************/
-uint8_t DIA_contrast(AVDMGenericVideoStream *in,CONTRAST_PARAM *param)
-{
-  
-   uint32_t width,height;
-      uint8_t ret=0;
-        // Allocate space for green-ised video
-        width=in-&gt;getInfo()-&gt;width;
-        height=in-&gt;getInfo()-&gt;height;
-
-        dialog=create_dialog1();
-        gtk_register_dialog(dialog);
-        gtk_window_set_title (GTK_WINDOW (dialog), _(&quot;ASHARP&quot;));
-
-		float zoom = UI_calcZoomToFitScreen(GTK_WINDOW(dialog), WID(drawingarea1), width, height);
+/***************************************************************************
+                          ADM_guiContrast.cpp  -  description
+                             -------------------
+    begin                : Mon Sep 23 2002
+    copyright            : (C) 2002 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
 
-		uint32_t zoomW = width * zoom;
-		uint32_t zoomH = height * zoom;
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;config.h&quot;
 
-		gtk_widget_set_usize(WID(drawingarea1), zoomW, zoomH);
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
 
-		if (zoom &lt; 1)
-		{
-			gtk_window_set_position(GTK_WINDOW(dialog), GTK_WIN_POS_CENTER);
-		}
-
-        gtk_widget_show(dialog);	
-        
-          // and value changed
-#define CNX(x,y) gtk_signal_connect(GTK_OBJECT(WID(x)), y, GTK_SIGNAL_FUNC(gui_update), (void *) (1));
-
-        CNX (checkLuma, &quot;toggled&quot;);
-        CNX (checkbuttonU, &quot;toggled&quot;);
-        CNX (checkbuttonV, &quot;toggled&quot;);
-        
-        
-        CNX (hscaleContrast, &quot;value_changed&quot;);
-        CNX (hscaleContrast, &quot;drag_data_received&quot;);
-      
-        CNX (hscaleBright, &quot;value_changed&quot;);
-        CNX (hscaleBright, &quot;drag_data_received&quot;);
-        gtk_signal_connect(GTK_OBJECT(WID(hscale1)), &quot;value_changed&quot;,GTK_SIGNAL_FUNC(frame_changed),   NULL);
-        gtk_signal_connect(GTK_OBJECT(WID(drawingarea1)), &quot;expose_event&quot;,
-            GTK_SIGNAL_FUNC(gui_draw),
-            NULL);
-
-
-          
-        myCrop=new flyContrast( width, height,in,WID(drawingarea1),WID(hscale1));
-        memcpy(&amp;(myCrop-&gt;param),param,sizeof(CONTRAST_PARAM));
-		myCrop-&gt;resizeImage(zoomW, zoomH);
-        myCrop-&gt;upload();
-        myCrop-&gt;sliderChanged();
-        ret=0;
-        int response;
-        response=gtk_dialog_run(GTK_DIALOG(dialog));
-
-        if(response==GTK_RESPONSE_OK)
-        {
-            myCrop-&gt;download();
-            memcpy(param,&amp;(myCrop-&gt;param),sizeof(CONTRAST_PARAM));
-            ret=1;
-        }
-        gtk_unregister_dialog(dialog);
-        gtk_widget_destroy(dialog);
-        delete myCrop;
-        return ret;
-}
-
-
-//
-//        Check entered values and green-out the selected portion on the screen
-//        Each value must be even
-//
-void frame_changed( void )
-{
-  myCrop-&gt;sliderChanged();
-}
-void gui_update (GtkButton * button, gpointer user_data)
-{
-  if(lock) return;
-    myCrop-&gt;update();
-}
-
-gboolean gui_draw (GtkWidget * widget, GdkEventExpose * event, gpointer user_data)
-{
-  myCrop-&gt;display();
-  return TRUE;
-}
-
-/**************************************/
-#define CHECKBOX(x,y) if(TRUE==gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(lookup_widget(dialog,#x))))  \
-			y=1; else y=0;
-#define SCHECKBOX(x,y) gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(lookup_widget(dialog,#x)),y)
-
-
-uint8_t flyContrast::upload(void)
-{
-    lock++;
-      SCHECKBOX (checkLuma, param.doLuma);
-      SCHECKBOX (checkbuttonU, param.doChromaU);
-      SCHECKBOX (checkbuttonV, param.doChromaV);
-
-      GtkAdjustment *adj=gtk_range_get_adjustment (GTK_RANGE(WID(hscaleBright)));
-      GTK_ADJUSTMENT(adj)-&gt;value=param.offset;
-  
-      adj=gtk_range_get_adjustment (GTK_RANGE(WID(hscaleContrast)));
-      GTK_ADJUSTMENT(adj)-&gt;value=param.coef;
-    lock--;
-    return 1;
-}
-uint8_t flyContrast::download (void)
-{
-  CHECKBOX (checkLuma, param.doLuma);
-  CHECKBOX (checkbuttonU, param.doChromaU);
-  CHECKBOX (checkbuttonV, param.doChromaV);
-  
-  GtkAdjustment *adj=gtk_range_get_adjustment (GTK_RANGE(WID(hscaleBright)));
-  param.offset= (int32_t)GTK_ADJUSTMENT(adj)-&gt;value;
-  
-  adj=gtk_range_get_adjustment (GTK_RANGE(WID(hscaleContrast)));
-  param.coef=GTK_ADJUSTMENT(adj)-&gt;value;
-   return 1;
-}
-
-GtkWidget*
-create_dialog1 (void)
-{
-  GtkWidget *dialog1;
-  GtkWidget *dialog_vbox1;
-  GtkWidget *vbox1;
-  GtkWidget *hbox1;
-  GtkWidget *vbox3;
-  GtkWidget *label1;
-  GtkWidget *hscaleContrast;
-  GtkWidget *label2;
-  GtkWidget *hscaleBright;
-  GtkWidget *vbox2;
-  GtkWidget *checkLuma;
-  GtkWidget *checkbuttonU;
-  GtkWidget *checkbuttonV;
-  GtkWidget *hscale1;
-  GtkWidget *drawingarea1;
-  GtkWidget *dialog_action_area1;
-  GtkWidget *cancelbutton1;
-  GtkWidget *okbutton1;
-
-  dialog1 = gtk_dialog_new ();
-  gtk_window_set_title (GTK_WINDOW (dialog1), _(&quot;Contrast&quot;));
-  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
-
-  dialog_vbox1 = GTK_DIALOG (dialog1)-&gt;vbox;
-  gtk_widget_show (dialog_vbox1);
-
-  vbox1 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox1);
-  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
-
-  hbox1 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox1);
-  gtk_box_pack_start (GTK_BOX (vbox1), hbox1, TRUE, TRUE, 0);
-
-  vbox3 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox3);
-  gtk_box_pack_start (GTK_BOX (hbox1), vbox3, TRUE, TRUE, 0);
-
-  label1 = gtk_label_new (_(&quot;Contrast&quot;));
-  gtk_widget_show (label1);
-  gtk_box_pack_start (GTK_BOX (vbox3), label1, FALSE, FALSE, 0);
-
-  hscaleContrast = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (1, 0.5, 1.5, 0.1, 0.1, 0)));
-  gtk_widget_show (hscaleContrast);
-  gtk_box_pack_start (GTK_BOX (vbox3), hscaleContrast, FALSE, TRUE, 0);
-  gtk_scale_set_value_pos (GTK_SCALE (hscaleContrast), GTK_POS_LEFT);
-
-  label2 = gtk_label_new (_(&quot;Brightness&quot;));
-  gtk_widget_show (label2);
-  gtk_box_pack_start (GTK_BOX (vbox3), label2, FALSE, FALSE, 0);
-
-  hscaleBright = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, -127, 127, 1, 1, 0)));
-  gtk_widget_show (hscaleBright);
-  gtk_box_pack_start (GTK_BOX (vbox3), hscaleBright, FALSE, TRUE, 0);
-  gtk_scale_set_value_pos (GTK_SCALE (hscaleBright), GTK_POS_LEFT);
-  gtk_scale_set_digits (GTK_SCALE (hscaleBright), 0);
-
-  vbox2 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox2);
-  gtk_box_pack_start (GTK_BOX (hbox1), vbox2, TRUE, TRUE, 0);
-
-  checkLuma = gtk_check_button_new_with_mnemonic (_(&quot;Luma&quot;));
-  gtk_widget_show (checkLuma);
-  gtk_box_pack_start (GTK_BOX (vbox2), checkLuma, FALSE, FALSE, 0);
-
-  checkbuttonU = gtk_check_button_new_with_mnemonic (_(&quot;Chroma U&quot;));
-  gtk_widget_show (checkbuttonU);
-  gtk_box_pack_start (GTK_BOX (vbox2), checkbuttonU, FALSE, FALSE, 0);
-
-  checkbuttonV = gtk_check_button_new_with_mnemonic (_(&quot;Chroma v&quot;));
-  gtk_widget_show (checkbuttonV);
-  gtk_box_pack_start (GTK_BOX (vbox2), checkbuttonV, FALSE, FALSE, 0);
-
-  hscale1 = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 0, 99, 1, 1, 1)));
-  gtk_widget_show (hscale1);
-  gtk_box_pack_start (GTK_BOX (vbox1), hscale1, TRUE, TRUE, 0);
-
-  drawingarea1 = gtk_drawing_area_new ();
-  gtk_widget_show (drawingarea1);
-  gtk_box_pack_start (GTK_BOX (vbox1), drawingarea1, TRUE, TRUE, 0);
-  gtk_widget_set_size_request (drawingarea1, -1, 300);
-
-  dialog_action_area1 = GTK_DIALOG (dialog1)-&gt;action_area;
-  gtk_widget_show (dialog_action_area1);
-  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
-
-  cancelbutton1 = gtk_button_new_from_stock (&quot;gtk-cancel&quot;);
-  gtk_widget_show (cancelbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
-  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
-
-  okbutton1 = gtk_button_new_from_stock (&quot;gtk-ok&quot;);
-  gtk_widget_show (okbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
-  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
-
-  /* Store pointers to all widgets, for use by lookup_widget(). */
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, &quot;dialog1&quot;);
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, &quot;dialog_vbox1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, vbox1, &quot;vbox1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hbox1, &quot;hbox1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, vbox3, &quot;vbox3&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label1, &quot;label1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hscaleContrast, &quot;hscaleContrast&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label2, &quot;label2&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hscaleBright, &quot;hscaleBright&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, vbox2, &quot;vbox2&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, checkLuma, &quot;checkLuma&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, checkbuttonU, &quot;checkbuttonU&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, checkbuttonV, &quot;checkbuttonV&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hscale1, &quot;hscale1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, drawingarea1, &quot;drawingarea1&quot;);
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, &quot;dialog_action_area1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, &quot;cancelbutton1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, &quot;okbutton1&quot;);
-
-  return dialog1;
-}
-
-
-#endif
+#include &lt;gtk/gtk.h&gt;
+#include &lt;time.h&gt;
+#include &lt;sys/time.h&gt;
+#include &lt;math.h&gt;
+
+
+#include &quot;fourcc.h&quot;
+#include &quot;avio.hxx&quot;
+
+#include &quot;avi_vars.h&quot;
+#ifdef HAVE_ENCODER
+
+
+#include &quot;ADM_editor/ADM_edit.hxx&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+#include &quot;ADM_video/ADM_vidContrast.h&quot;
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+#include &quot;ADM_colorspace/ADM_rgb.h&quot;
+#include &quot;ADM_toolkit_gtk/ADM_gladeSupport.h&quot;
+#include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
+#include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
+#include &lt;ADM_assert.h&gt;
+#include &quot;DIA_flyDialog.h&quot;
+#include &quot;DIA_flyContrast.h&quot;
+
+/********************************************************************/
+static GtkWidget *create_dialog1 (void);
+static GtkWidget *dialog = NULL;
+
+static gboolean gui_draw (GtkWidget * widget,
+			  GdkEventExpose * event, gpointer user_data);
+static void gui_update (GtkButton * button, gpointer user_data);
+static void frame_changed( void );
+
+static int lock=0;
+static flyContrast *myCrop=NULL;
+
+/********************************************************************/
+uint8_t DIA_contrast(AVDMGenericVideoStream *in,CONTRAST_PARAM *param)
+{
+  
+   uint32_t width,height;
+      uint8_t ret=0;
+        // Allocate space for green-ised video
+        width=in-&gt;getInfo()-&gt;width;
+        height=in-&gt;getInfo()-&gt;height;
+
+        dialog=create_dialog1();
+        gtk_register_dialog(dialog);
+        gtk_window_set_title (GTK_WINDOW (dialog), _(&quot;ASHARP&quot;));
+        gtk_widget_show(dialog);	
+        
+          // and value changed
+#define CNX(x,y) gtk_signal_connect(GTK_OBJECT(WID(x)), y, GTK_SIGNAL_FUNC(gui_update), (void *) (1));
+
+        CNX (checkLuma, &quot;toggled&quot;);
+        CNX (checkbuttonU, &quot;toggled&quot;);
+        CNX (checkbuttonV, &quot;toggled&quot;);
+        
+        
+        CNX (hscaleContrast, &quot;value_changed&quot;);
+        CNX (hscaleContrast, &quot;drag_data_received&quot;);
+      
+        CNX (hscaleBright, &quot;value_changed&quot;);
+        CNX (hscaleBright, &quot;drag_data_received&quot;);
+        gtk_signal_connect(GTK_OBJECT(WID(hscale1)), &quot;value_changed&quot;,GTK_SIGNAL_FUNC(frame_changed),   NULL);
+        gtk_signal_connect(GTK_OBJECT(WID(drawingarea1)), &quot;expose_event&quot;,
+            GTK_SIGNAL_FUNC(gui_draw),
+            NULL);
+
+
+          
+        myCrop=new flyContrast( width, height,in,WID(drawingarea1),WID(hscale1));
+        memcpy(&amp;(myCrop-&gt;param),param,sizeof(CONTRAST_PARAM));
+        myCrop-&gt;upload();
+        myCrop-&gt;sliderChanged();
+        ret=0;
+        int response;
+        response=gtk_dialog_run(GTK_DIALOG(dialog));
+
+        if(response==GTK_RESPONSE_OK)
+        {
+            myCrop-&gt;download();
+            memcpy(param,&amp;(myCrop-&gt;param),sizeof(CONTRAST_PARAM));
+            ret=1;
+        }
+        gtk_unregister_dialog(dialog);
+        gtk_widget_destroy(dialog);
+        delete myCrop;
+        return ret;
+}
+
+
+//
+//        Check entered values and green-out the selected portion on the screen
+//        Each value must be even
+//
+void frame_changed( void )
+{
+  myCrop-&gt;sliderChanged();
+}
+void gui_update (GtkButton * button, gpointer user_data)
+{
+  if(lock) return;
+    myCrop-&gt;update();
+}
+
+gboolean gui_draw (GtkWidget * widget, GdkEventExpose * event, gpointer user_data)
+{
+  myCrop-&gt;display();
+  return TRUE;
+}
+
+/**************************************/
+#define CHECKBOX(x,y) if(TRUE==gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(lookup_widget(dialog,#x))))  \
+			y=1; else y=0;
+#define SCHECKBOX(x,y) gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(lookup_widget(dialog,#x)),y)
+
+
+uint8_t flyContrast::upload(void)
+{
+    lock++;
+      SCHECKBOX (checkLuma, param.doLuma);
+      SCHECKBOX (checkbuttonU, param.doChromaU);
+      SCHECKBOX (checkbuttonV, param.doChromaV);
+
+      GtkAdjustment *adj=gtk_range_get_adjustment (GTK_RANGE(WID(hscaleBright)));
+      GTK_ADJUSTMENT(adj)-&gt;value=param.offset;
+  
+      adj=gtk_range_get_adjustment (GTK_RANGE(WID(hscaleContrast)));
+      GTK_ADJUSTMENT(adj)-&gt;value=param.coef;
+    lock--;
+    return 1;
+}
+uint8_t flyContrast::download (void)
+{
+  CHECKBOX (checkLuma, param.doLuma);
+  CHECKBOX (checkbuttonU, param.doChromaU);
+  CHECKBOX (checkbuttonV, param.doChromaV);
+  
+  GtkAdjustment *adj=gtk_range_get_adjustment (GTK_RANGE(WID(hscaleBright)));
+  param.offset= (int32_t)GTK_ADJUSTMENT(adj)-&gt;value;
+  
+  adj=gtk_range_get_adjustment (GTK_RANGE(WID(hscaleContrast)));
+  param.coef=GTK_ADJUSTMENT(adj)-&gt;value;
+   return 1;
+}
+
+GtkWidget*
+create_dialog1 (void)
+{
+  GtkWidget *dialog1;
+  GtkWidget *dialog_vbox1;
+  GtkWidget *vbox1;
+  GtkWidget *hbox1;
+  GtkWidget *vbox3;
+  GtkWidget *label1;
+  GtkWidget *hscaleContrast;
+  GtkWidget *label2;
+  GtkWidget *hscaleBright;
+  GtkWidget *vbox2;
+  GtkWidget *checkLuma;
+  GtkWidget *checkbuttonU;
+  GtkWidget *checkbuttonV;
+  GtkWidget *hscale1;
+  GtkWidget *drawingarea1;
+  GtkWidget *dialog_action_area1;
+  GtkWidget *cancelbutton1;
+  GtkWidget *okbutton1;
+
+  dialog1 = gtk_dialog_new ();
+  gtk_window_set_title (GTK_WINDOW (dialog1), _(&quot;Contrast&quot;));
+  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
+
+  dialog_vbox1 = GTK_DIALOG (dialog1)-&gt;vbox;
+  gtk_widget_show (dialog_vbox1);
+
+  vbox1 = gtk_vbox_new (FALSE, 0);
+  gtk_widget_show (vbox1);
+  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
+
+  hbox1 = gtk_hbox_new (FALSE, 0);
+  gtk_widget_show (hbox1);
+  gtk_box_pack_start (GTK_BOX (vbox1), hbox1, TRUE, TRUE, 0);
+
+  vbox3 = gtk_vbox_new (FALSE, 0);
+  gtk_widget_show (vbox3);
+  gtk_box_pack_start (GTK_BOX (hbox1), vbox3, TRUE, TRUE, 0);
+
+  label1 = gtk_label_new (_(&quot;Contrast&quot;));
+  gtk_widget_show (label1);
+  gtk_box_pack_start (GTK_BOX (vbox3), label1, FALSE, FALSE, 0);
+
+  hscaleContrast = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (1, 0.5, 1.5, 0.1, 0.1, 0)));
+  gtk_widget_show (hscaleContrast);
+  gtk_box_pack_start (GTK_BOX (vbox3), hscaleContrast, FALSE, TRUE, 0);
+  gtk_scale_set_value_pos (GTK_SCALE (hscaleContrast), GTK_POS_LEFT);
+
+  label2 = gtk_label_new (_(&quot;Brightness&quot;));
+  gtk_widget_show (label2);
+  gtk_box_pack_start (GTK_BOX (vbox3), label2, FALSE, FALSE, 0);
+
+  hscaleBright = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, -127, 127, 1, 1, 0)));
+  gtk_widget_show (hscaleBright);
+  gtk_box_pack_start (GTK_BOX (vbox3), hscaleBright, FALSE, TRUE, 0);
+  gtk_scale_set_value_pos (GTK_SCALE (hscaleBright), GTK_POS_LEFT);
+  gtk_scale_set_digits (GTK_SCALE (hscaleBright), 0);
+
+  vbox2 = gtk_vbox_new (FALSE, 0);
+  gtk_widget_show (vbox2);
+  gtk_box_pack_start (GTK_BOX (hbox1), vbox2, TRUE, TRUE, 0);
+
+  checkLuma = gtk_check_button_new_with_mnemonic (_(&quot;Luma&quot;));
+  gtk_widget_show (checkLuma);
+  gtk_box_pack_start (GTK_BOX (vbox2), checkLuma, FALSE, FALSE, 0);
+
+  checkbuttonU = gtk_check_button_new_with_mnemonic (_(&quot;Chroma U&quot;));
+  gtk_widget_show (checkbuttonU);
+  gtk_box_pack_start (GTK_BOX (vbox2), checkbuttonU, FALSE, FALSE, 0);
+
+  checkbuttonV = gtk_check_button_new_with_mnemonic (_(&quot;Chroma v&quot;));
+  gtk_widget_show (checkbuttonV);
+  gtk_box_pack_start (GTK_BOX (vbox2), checkbuttonV, FALSE, FALSE, 0);
+
+  hscale1 = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 0, 99, 1, 1, 1)));
+  gtk_widget_show (hscale1);
+  gtk_box_pack_start (GTK_BOX (vbox1), hscale1, TRUE, TRUE, 0);
+
+  drawingarea1 = gtk_drawing_area_new ();
+  gtk_widget_show (drawingarea1);
+  gtk_box_pack_start (GTK_BOX (vbox1), drawingarea1, TRUE, TRUE, 0);
+  gtk_widget_set_size_request (drawingarea1, -1, 300);
+
+  dialog_action_area1 = GTK_DIALOG (dialog1)-&gt;action_area;
+  gtk_widget_show (dialog_action_area1);
+  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
+
+  cancelbutton1 = gtk_button_new_from_stock (&quot;gtk-cancel&quot;);
+  gtk_widget_show (cancelbutton1);
+  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
+  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
+
+  okbutton1 = gtk_button_new_from_stock (&quot;gtk-ok&quot;);
+  gtk_widget_show (okbutton1);
+  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
+  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
+
+  /* Store pointers to all widgets, for use by lookup_widget(). */
+  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, &quot;dialog1&quot;);
+  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, &quot;dialog_vbox1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, vbox1, &quot;vbox1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, hbox1, &quot;hbox1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, vbox3, &quot;vbox3&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, label1, &quot;label1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, hscaleContrast, &quot;hscaleContrast&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, label2, &quot;label2&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, hscaleBright, &quot;hscaleBright&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, vbox2, &quot;vbox2&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, checkLuma, &quot;checkLuma&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, checkbuttonU, &quot;checkbuttonU&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, checkbuttonV, &quot;checkbuttonV&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, hscale1, &quot;hscale1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, drawingarea1, &quot;drawingarea1&quot;);
+  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, &quot;dialog_action_area1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, &quot;cancelbutton1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, &quot;okbutton1&quot;);
+
+  return dialog1;
+}
+
+
+#endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_crop.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_crop.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_crop.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -40,7 +40,6 @@
 #include &quot;DIA_flyCrop.h&quot;
 
 static GtkWidget	*create_dialog1 (void);
-extern float UI_calcZoomToFitScreen(GtkWindow* window, GtkWidget* drawingArea, uint32_t imageWidth, uint32_t imageHeight);
 
 /* Link between UI and core */
 static gboolean 	ui_draw( void );
@@ -74,19 +73,6 @@
 	dialog=create_dialog1();
 	gtk_register_dialog(dialog);
 	gtk_window_set_title(GTK_WINDOW(dialog), name);
-
-	float zoom = UI_calcZoomToFitScreen(GTK_WINDOW(dialog), WID(drawingarea1), width, height);
-
-	uint32_t zoomW = width * zoom;
-	uint32_t zoomH = height * zoom;
-
-	gtk_widget_set_usize(WID(drawingarea1), zoomW, zoomH);
-
-	if (zoom &lt; 1)
-	{
-		gtk_window_set_position(GTK_WINDOW(dialog), GTK_WIN_POS_CENTER);
-	}
-
 	gtk_widget_show(dialog);
 	
 #define CONNECT(x,y,z) 	gtk_signal_connect(GTK_OBJECT(WID(x)), #y, GTK_SIGNAL_FUNC(z), NULL);
@@ -108,7 +94,6 @@
 	CONNECT_SPIN(Bottom);
 
 	myCrop=new flyCrop(width, height,in,WID(drawingarea1),WID(scale));
-	myCrop-&gt;resizeImage(zoomW, zoomH);
 	myCrop-&gt;left=param-&gt;left;
 	myCrop-&gt;right=param-&gt;right;
 	myCrop-&gt;top=param-&gt;top;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_eq2.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_eq2.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_eq2.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -69,6 +69,7 @@
 static ColYuvRgb    *rgbConv=NULL;
 
 extern float UI_calcZoomToFitScreen(GtkWindow* window, GtkWidget* drawingArea, uint32_t imageWidth, uint32_t imageHeight);
+extern void UI_centreCanvasWindow(GtkWindow *window, GtkWidget *canvas, int newCanvasWidth, int newCanvasHeight);
 
 /************************************************************************/
 uint8_t DIA_getEQ2Param(Eq2_Param *param, AVDMGenericVideoStream *in)
@@ -142,7 +143,7 @@
 
 		if (zoom &lt; 1)
 		{
-			gtk_window_set_position(GTK_WINDOW(dialog), GTK_WIN_POS_CENTER);
+			UI_centreCanvasWindow((GtkWindow*)dialog, WID(drawingarea1), zoomW, zoomH);
 			resizer = new ADMImageResizer(w, h, zoomW, zoomH, PIX_FMT_YUV420P, PIX_FMT_RGB32);
 		}
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_equalizer.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_equalizer.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_equalizer.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -62,6 +62,7 @@
 
 extern void GUI_RGBDisplay(uint8_t * dis, uint32_t w, uint32_t h, void *widg);
 extern float UI_calcZoomToFitScreen(GtkWindow* window, GtkWidget* drawingArea, uint32_t imageWidth, uint32_t imageHeight);
+extern void UI_centreCanvasWindow(GtkWindow *window, GtkWidget *canvas, int newCanvasWidth, int newCanvasHeight);
 
 static ADMImage *imgsrc,*imgdst,*imgdisplay;
 static GtkWidget *dialog=NULL;
@@ -129,7 +130,7 @@
 
 	if (zoom &lt; 1)
 	{
-		gtk_window_set_position(GTK_WINDOW(dialog), GTK_WIN_POS_CENTER);
+		UI_centreCanvasWindow((GtkWindow*)dialog, WID(drawingarea1), zoomW, zoomH);
 		resizer = new ADMImageResizer(w, h, zoomW, zoomH, PIX_FMT_YUV420P, PIX_FMT_RGB32);
 	}
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_flyDialog.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_flyDialog.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_flyDialog.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -1,81 +1,87 @@
-/***************************************************************************
-    copyright            : (C) 2006 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
-***************************************************************************/
-
-/***************************************************************************
-*                                                                         *
-*   This program is free software; you can redistribute it and/or modify  *
-*   it under the terms of the GNU General Public License as published by  *
-*   the Free Software Foundation; either version 2 of the License, or     *
-*   (at your option) any later version.                                   *
-*                                                                         *
-***************************************************************************///
-
-#include &quot;config.h&quot;
-
-#include &lt;gtk/gtk.h&gt;
-
-#include &quot;default.h&quot;
-#include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
-#include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
-#include &quot;ADM_video/ADM_genvideo.hxx&quot;
-#include &quot;DIA_flyDialog.h&quot;
-#include &quot;ADM_assert.h&quot;
-
-extern void GUI_RGBDisplay(uint8_t * dis, uint32_t w, uint32_t h, void *widg);
-
-void ADM_flyDialog::postInit(uint32_t width, uint32_t height, AVDMGenericVideoStream *in,
-							 void *canvas, void *slider, int yuv)
-{
-	if (slider != NULL)
-	{
-		GtkAdjustment *adj = (GtkAdjustment*)gtk_adjustment_new(0, 0, in-&gt;getInfo()-&gt;nb_frames - 1, 0, 0, 0);
-
-		gtk_range_set_adjustment(GTK_RANGE(_slider), adj);
-		gtk_scale_set_digits(GTK_SCALE(_slider), 0);
-	}
-}
-
-uint8_t  ADM_flyDialog::display(void)
-{
-	ADM_assert(_canvas);
-	ADM_assert(_rgbBufferOut);
-
-	if (_resizer)
-	{
-		_resizer-&gt;resize(_rgbBufferOut, _rgbBufferDisplay);
-		GUI_RGBDisplay(_rgbBufferDisplay, _zoomW, _zoomH, _canvas);
-	}
-	else
-		GUI_RGBDisplay(_rgbBufferOut, _w, _h, _canvas);
-
-	return 1; 
-}
-
-uint32_t ADM_flyDialog::sliderGet(void)
-{
-	ADM_assert(_slider);
-	GtkAdjustment *adj=gtk_range_get_adjustment (GTK_RANGE(_slider));
-	return (uint32_t)GTK_ADJUSTMENT(adj)-&gt;value;
-}
-
-uint8_t ADM_flyDialog::sliderSet(uint32_t value)
-{
-	ADM_assert(_slider);
-
-	GtkAdjustment *adj = gtk_range_get_adjustment(GTK_RANGE(_slider));
-
-	adj-&gt;value = value;
-
-	gtk_range_set_adjustment(GTK_RANGE(_slider), adj);
-
-	return 1; 
-}
-
-uint8_t ADM_flyDialog::isRgbInverted(void)
-{
-	return 0; 
-}
-
-//EOF
+/***************************************************************************
+    copyright            : (C) 2006 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+***************************************************************************/
+
+/***************************************************************************
+*                                                                         *
+*   This program is free software; you can redistribute it and/or modify  *
+*   it under the terms of the GNU General Public License as published by  *
+*   the Free Software Foundation; either version 2 of the License, or     *
+*   (at your option) any later version.                                   *
+*                                                                         *
+***************************************************************************///
+
+#include &quot;config.h&quot;
+
+#include &lt;gtk/gtk.h&gt;
+
+#include &quot;default.h&quot;
+#include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
+#include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+#include &quot;DIA_flyDialog.h&quot;
+#include &quot;ADM_assert.h&quot;
+
+extern void GUI_RGBDisplay(uint8_t * dis, uint32_t w, uint32_t h, void *widg);
+extern float UI_calcZoomToFitScreen(GtkWindow* window, GtkWidget* drawingArea, uint32_t imageWidth, uint32_t imageHeight);
+extern void UI_centreCanvasWindow(GtkWindow *window, GtkWidget *canvas, int newCanvasWidth, int newCanvasHeight);
+
+void ADM_flyDialog::postInit(void)
+{
+	if (_slider)
+	{
+		GtkAdjustment *adj = (GtkAdjustment*)gtk_adjustment_new(0, 0, _in-&gt;getInfo()-&gt;nb_frames - 1, 0, 1, 0);
+
+		gtk_range_set_adjustment(GTK_RANGE(_slider), adj);
+		gtk_scale_set_digits(GTK_SCALE(_slider), 0);
+	}
+
+	GtkWindow *window = (GtkWindow*)gtk_widget_get_ancestor((GtkWidget*)_canvas, GTK_TYPE_WINDOW);
+	UI_centreCanvasWindow(window, (GtkWidget*)_canvas, _zoomW, _zoomH);
+	gtk_widget_set_usize((GtkWidget*)_canvas, _zoomW, _zoomH);
+}
+
+float ADM_flyDialog::calcZoomFactor(void)
+{
+	GtkWindow *window = (GtkWindow*)gtk_widget_get_ancestor((GtkWidget*)_canvas, GTK_TYPE_WINDOW);
+
+	return UI_calcZoomToFitScreen(window, (GtkWidget*)_canvas, _w, _h);
+}
+
+uint8_t  ADM_flyDialog::display(void)
+{
+	ADM_assert(_canvas);
+	ADM_assert(_rgbBufferOut);
+
+	GUI_RGBDisplay(_rgbBufferOut, _zoomW, _zoomH, _canvas);
+
+	return 1; 
+}
+
+uint32_t ADM_flyDialog::sliderGet(void)
+{
+	ADM_assert(_slider);
+	GtkAdjustment *adj=gtk_range_get_adjustment (GTK_RANGE(_slider));
+	return (uint32_t)GTK_ADJUSTMENT(adj)-&gt;value;
+}
+
+uint8_t ADM_flyDialog::sliderSet(uint32_t value)
+{
+	ADM_assert(_slider);
+
+	GtkAdjustment *adj = gtk_range_get_adjustment(GTK_RANGE(_slider));
+
+	adj-&gt;value = value;
+
+	gtk_range_set_adjustment(GTK_RANGE(_slider), adj);
+
+	return 1; 
+}
+
+uint8_t ADM_flyDialog::isRgbInverted(void)
+{
+	return 0; 
+}
+
+//EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_hue.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_hue.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_hue.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -56,8 +56,6 @@
 static GtkWidget *dialog=NULL;
 static flyHue *myCrop=NULL;
 
-extern float UI_calcZoomToFitScreen(GtkWindow* window, GtkWidget* drawingArea, uint32_t imageWidth, uint32_t imageHeight);
-
 /**
       \fn DIA_getHue
       \brief Handle Hue (fly)Dialog
@@ -75,18 +73,6 @@
         
         gtk_window_set_title (GTK_WINDOW (dialog), _(&quot;Hue&quot;));
 
-		float zoom = UI_calcZoomToFitScreen(GTK_WINDOW(dialog), WID(drawingarea1), width, height);
-
-		uint32_t zoomW = width * zoom;
-		uint32_t zoomH = height * zoom;
-
-		gtk_widget_set_usize(WID(drawingarea1), zoomW, zoomH);
-
-		if (zoom &lt; 1)
-		{
-			gtk_window_set_position(GTK_WINDOW(dialog), GTK_WIN_POS_CENTER);
-		}
-
         gtk_signal_connect(GTK_OBJECT(WID(drawingarea1)), &quot;expose_event&quot;,
             GTK_SIGNAL_FUNC(draw),
             NULL);
@@ -98,7 +84,6 @@
           
         myCrop=new flyHue( width, height,in,WID(drawingarea1),WID(hscale1));
         memcpy(&amp;(myCrop-&gt;param),param,sizeof(Hue_Param));
-		myCrop-&gt;resizeImage(zoomW, zoomH);
         myCrop-&gt;upload();
         myCrop-&gt;sliderChanged();
         ret=0;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_mpdelogo.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_mpdelogo.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_mpdelogo.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -1,111 +1,112 @@
-/***************************************************************************
-                          DIA_crop.cpp  -  description
-                             -------------------
-
-			    GUI for cropping including autocrop
-			    +Revisted the Gtk2 way
-			     +Autocrop now in RGB space (more accurate)
-
-    begin                : Fri May 3 2002
-    copyright            : (C) 2002 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include &quot;config.h&quot;
-
-#include &lt;string.h&gt;
-#include &lt;stdio.h&gt;
-
-#include &lt;gdk/gdkkeysyms.h&gt;
-#include &lt;gtk/gtk.h&gt;
-#include &lt;math.h&gt;
-
-#include &quot;default.h&quot;
-#include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
-#include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-
-#include &quot;ADM_image.h&quot;
-#include &quot;ADM_video/ADM_genvideo.hxx&quot;
-#include &quot;ADM_colorspace/ADM_rgb.h&quot;
-#include &quot;ADM_assert.h&quot;
-#include &quot;ADM_video/ADM_vidMPdelogo.h&quot;
-
+/***************************************************************************
+                          DIA_crop.cpp  -  description
+                             -------------------
+
+			    GUI for cropping including autocrop
+			    +Revisted the Gtk2 way
+			     +Autocrop now in RGB space (more accurate)
+
+    begin                : Fri May 3 2002
+    copyright            : (C) 2002 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include &quot;config.h&quot;
+
+#include &lt;string.h&gt;
+#include &lt;stdio.h&gt;
+
+#include &lt;gdk/gdkkeysyms.h&gt;
+#include &lt;gtk/gtk.h&gt;
+#include &lt;math.h&gt;
+
+#include &quot;default.h&quot;
+#include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
+#include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+
+#include &quot;ADM_image.h&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+#include &quot;ADM_colorspace/ADM_rgb.h&quot;
+#include &quot;ADM_assert.h&quot;
+#include &quot;ADM_video/ADM_vidMPdelogo.h&quot;
+
 extern &quot;C&quot; {
 #include &quot;ADM_libraries/ADM_lavcodec/avcodec.h&quot;
-}
-
-static GtkWidget	*create_dialog1 (void);
-static void  		ui_read ( void);
-static void  		ui_update ( void);
-static void 		draw (GtkWidget *dialog,uint32_t w,uint32_t h );
-static gboolean 	gui_draw( void );
-static void 		autocrop (void );
-static void 		reset( void );
-static void 		ui_upload(void);
-static gboolean		ui_changed(void);
-
-
-static void		prepare(uint32_t img);
-static void 		frame_changed( void );
-
-extern void GUI_RGBDisplay(uint8_t * dis, uint32_t w, uint32_t h, void *widg);
-extern float UI_calcZoomToFitScreen(GtkWindow* window, GtkWidget* drawingArea, uint32_t imageWidth, uint32_t imageHeight);
-
-static ColYuvRgb    *rgbConv=NULL;
-static uint8_t *working=NULL;
-static uint8_t *rgbBufferDisplay=NULL;
-static uint8_t *original=NULL;
-static GtkWidget *dialog=NULL;
-static uint32_t x,y,w,h,zoomW,zoomH,band;
-
-static AVDMGenericVideoStream *incoming=NULL;
-static ADMImage *imgsrc=NULL;
-static ADMImageResizer *resizer=NULL;
-
-static int lock=0,width,height;
-
-
-//
-//	Video is in YV12 Colorspace
-//
-//
-uint8_t DIA_getMPdelogo(MPDELOGO_PARAM *param,AVDMGenericVideoStream *in)
-
-{
-	// Allocate space for green-ised video
-	width=in-&gt;getInfo()-&gt;width;
-	height=in-&gt;getInfo()-&gt;height;
-		
-	working=new uint8_t [width*height*4];	
-	original=NULL;
-
-	uint8_t ret=0;
-
-	dialog=create_dialog1();
-        gtk_register_dialog(dialog);
-	
-	x=param-&gt;xoff;
-	y=param-&gt;yoff;
-	w=param-&gt;lw;
-	h=param-&gt;lh;
-	band=param-&gt;band;
-
-	imgsrc=new ADMImage(width,height);
-	incoming=in;
-	
-	rgbConv=new ColYuvRgb(width,height);
-        rgbConv-&gt;reset(width,height);
-
+}
+
+static GtkWidget	*create_dialog1 (void);
+static void  		ui_read ( void);
+static void  		ui_update ( void);
+static void 		draw (GtkWidget *dialog,uint32_t w,uint32_t h );
+static gboolean 	gui_draw( void );
+static void 		autocrop (void );
+static void 		reset( void );
+static void 		ui_upload(void);
+static gboolean		ui_changed(void);
+
+
+static void		prepare(uint32_t img);
+static void 		frame_changed( void );
+
+extern void GUI_RGBDisplay(uint8_t * dis, uint32_t w, uint32_t h, void *widg);
+extern float UI_calcZoomToFitScreen(GtkWindow* window, GtkWidget* drawingArea, uint32_t imageWidth, uint32_t imageHeight);
+extern void UI_centreCanvasWindow(GtkWindow *window, GtkWidget *canvas, int newCanvasWidth, int newCanvasHeight);
+
+static ColYuvRgb    *rgbConv=NULL;
+static uint8_t *working=NULL;
+static uint8_t *rgbBufferDisplay=NULL;
+static uint8_t *original=NULL;
+static GtkWidget *dialog=NULL;
+static uint32_t x,y,w,h,zoomW,zoomH,band;
+
+static AVDMGenericVideoStream *incoming=NULL;
+static ADMImage *imgsrc=NULL;
+static ADMImageResizer *resizer=NULL;
+
+static int lock=0,width,height;
+
+
+//
+//	Video is in YV12 Colorspace
+//
+//
+uint8_t DIA_getMPdelogo(MPDELOGO_PARAM *param,AVDMGenericVideoStream *in)
+
+{
+	// Allocate space for green-ised video
+	width=in-&gt;getInfo()-&gt;width;
+	height=in-&gt;getInfo()-&gt;height;
+		
+	working=new uint8_t [width*height*4];	
+	original=NULL;
+
+	uint8_t ret=0;
+
+	dialog=create_dialog1();
+        gtk_register_dialog(dialog);
+	
+	x=param-&gt;xoff;
+	y=param-&gt;yoff;
+	w=param-&gt;lw;
+	h=param-&gt;lh;
+	band=param-&gt;band;
+
+	imgsrc=new ADMImage(width,height);
+	incoming=in;
+	
+	rgbConv=new ColYuvRgb(width,height);
+        rgbConv-&gt;reset(width,height);
+
 	float zoom = UI_calcZoomToFitScreen(GTK_WINDOW(dialog), WID(drawingarea1), width, height);
 
 	zoomW = width * zoom;
@@ -116,418 +117,418 @@
 
 	if (zoom &lt; 1)
 	{
-		gtk_window_set_position(GTK_WINDOW(dialog), GTK_WIN_POS_CENTER);
+		UI_centreCanvasWindow((GtkWindow*)dialog, WID(drawingarea1), zoomW, zoomH);
 		resizer = new ADMImageResizer(width, height, zoomW, zoomH, PIX_FMT_RGB32, PIX_FMT_RGB32);
-	}
-
-	prepare(0);
-	gtk_widget_show(dialog);
-	
-	ui_upload();
-	ui_update();
-	
-#define CONNECT(x,y,z) 	gtk_signal_connect(GTK_OBJECT(WID(x)), #y,GTK_SIGNAL_FUNC(z),   NULL);
-
-        CONNECT(drawingarea1,expose_event,gui_draw);
-        CONNECT(hscale1,value_changed,frame_changed);	  
-		      
-#define CONNECT_SPIN(x) CONNECT(spinbutton##x, value_changed,ui_changed)
-      	  
-        CONNECT_SPIN(X);
-        CONNECT_SPIN(Y);
-        CONNECT_SPIN(W);
-        CONNECT_SPIN(H);
-        CONNECT_SPIN(Band);
-	  
-	draw(dialog,width,height);
-
-	ret=0;
-	int response;
-	while( (response=gtk_dialog_run(GTK_DIALOG(dialog)))==GTK_RESPONSE_APPLY)
-	{
-		ui_changed();
-		
-	}
-	if(response==GTK_RESPONSE_OK)
-        {
-		ui_read( );
-		param-&gt;xoff=x;
-                param-&gt;yoff=y;
-                param-&gt;lw=w;
-                param-&gt;lh=h;
-                param-&gt;band=band;
-		ret=1;
-	}
-        gtk_unregister_dialog(dialog);
-	gtk_widget_destroy(dialog);
-	delete working;	
-	delete imgsrc;
-	delete rgbConv;
-
-	if (resizer)
-	{
-		delete resizer;
-		delete[] rgbBufferDisplay;
-
-		resizer=NULL;
-		rgbBufferDisplay=NULL;
-	}
-
-	working=NULL;
-	dialog=NULL;
-	original=NULL;
-	imgsrc=NULL;
-	return ret;
-}
-void frame_changed( void )
-{
-uint32_t new_frame,max,l,f;
-double   percent;
-GtkWidget *wid;	
-GtkAdjustment *adj;
-
-        max=incoming-&gt;getInfo()-&gt;nb_frames;
-        wid=WID(hscale1);
-        adj=gtk_range_get_adjustment (GTK_RANGE(wid));
-        new_frame=0;
-        
-        percent=(double)GTK_ADJUSTMENT(adj)-&gt;value;
-        percent*=max;
-        percent/=100.;
-        new_frame=(uint32_t)floor(percent);
-        
-        if(new_frame&gt;=max) new_frame=max-1;
-        
-        prepare(new_frame);
-        ui_update();
-        gui_draw();
-
-
-}
-void prepare(uint32_t img)
-{
-	uint32_t l,f;
-	
-	ADM_assert(incoming-&gt;getFrameNumberNoAlloc(img,&amp;l,imgsrc,&amp;f));
-	original=imgsrc-&gt;data;
-	
-
-}
-gboolean ui_changed(void)
-{
-	if(!lock)
-	{
-		ui_read();
-		memcpy(working,original,(width*height*3)&gt;&gt;1);
-		ui_update();
-		draw(dialog,width,height);
-	}
-		return true;
-}
-
-
-/*---------------------------------------------------------------------------
-	Actually draw the working frame on screen
-*/
-gboolean gui_draw( void )
-{
-	draw(dialog,width,height);
-	return true;
-}
-void draw (GtkWidget *dialog,uint32_t w,uint32_t h )
-{
-	GtkWidget *draw=WID(drawingarea1);
-
-	if (resizer)
-	{
-		resizer-&gt;resize(working, rgbBufferDisplay);
-		GUI_RGBDisplay(rgbBufferDisplay, zoomW, zoomH, (void*)draw);
-	}
-	else
-		GUI_RGBDisplay(working, w, h, (void*)draw);
-}
-/*---------------------------------------------------------------------------
-	Read entried from dialog box
-*/
-
-#define SPIN_GET(x,y) {x= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(WID(spinbutton##y))) ;}
-#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(spinbutton##y)),(gfloat)x) ;}
-
-
-void ui_read (void )
-{
-	int reject=0;
-	
-			SPIN_GET(x,X);
-			SPIN_GET(y,Y);
-			SPIN_GET(h,H);
-			SPIN_GET(w,W);
-                        SPIN_GET(band,Band);
-			
-			//printf(&quot;%d %d %d %d\n&quot;,x,y,w,h);
-			
-			x&amp;=0xffffe;
-			y&amp;=0xffffe;
-			h&amp;=0xffffe;
-			w&amp;=0xffffe;
-			
-			if((x+w)&gt;width)
-				{
-                                        if(w&gt;=width) w=width;
-                                        x=width-w;
-                                        reject=1;
-				}
-			if((y+h)&gt;height)
-				{
-                                        if(h&gt;=height) h=height;
-                                        y=height-h;
-                                        reject=1;
-				}
-			if(reject)
-				ui_upload();
-}
-
-void ui_upload(void)
-{
-	lock++;
-	SPIN_SET(x,X);
-	SPIN_SET(y,Y);
-	SPIN_SET(w,W);
-	SPIN_SET(h,H);
-        SPIN_SET(band,Band);
-	lock--;
-}
-//____________________________________
-void reset( void )
-{
-	
-	x=y=w=h=0;
-	ui_upload();
-	ui_update();
-	gui_draw();
-	
-
-}
-/*---------------------------------------------------------------------------
-	Green-ify the displayed frame on cropped parts
-*/
-void ui_update( )
-{
-
-        uint8_t  *in,*in2;
-        uint8_t *buffer=working;
-
-        rgbConv-&gt;scale(original,buffer);
-        // Buffer is in RGB space
-        in=buffer+x*4+y*width*4;
-        in2=buffer+(x+w)*4+y*width*4;
-        
-        for(int yy=0;yy&lt;h;yy++)
-        {
-          in[0]=in[2]=0;in[1]=0xff;
-          in2[0]=in2[2]=0;in2[1]=0xff;
-          in+=width*4;
-          in2+=width*4;
-        }
-        in=buffer+(y*width+x)*4;
-        in2=buffer+((y+h)*width+x)*4;
-        for(int yy=0;yy&lt;w;yy++)
-        {
-          in[0]=in[2]=0;in[1]=0xff;
-          in2[0]=in2[2]=0;in2[1]=0xff;
-          in+=4;
-          in2+=4;
-        }
-
-}
-
-//--------------------------------------------
-GtkWidget*
-create_dialog1 (void)
-{
-  GtkWidget *dialog1;
-  GtkWidget *dialog_vbox1;
-  GtkWidget *vbox1;
-  GtkWidget *vbox2;
-  GtkWidget *table2;
-  GtkWidget *label3;
-  GtkWidget *label4;
-  GtkWidget *label5;
-  GtkWidget *label6;
-  GtkWidget *label7;
-  GtkObject *spinbuttonX_adj;
-  GtkWidget *spinbuttonX;
-  GtkObject *spinbuttonY_adj;
-  GtkWidget *spinbuttonY;
-  GtkObject *spinbuttonW_adj;
-  GtkWidget *spinbuttonW;
-  GtkObject *spinbuttonH_adj;
-  GtkWidget *spinbuttonH;
-  GtkWidget *hseparator1;
-  GtkWidget *hseparator2;
-  GtkObject *spinbuttonBand_adj;
-  GtkWidget *spinbuttonBand;
-  GtkWidget *hseparator3;
-  GtkWidget *hscale1;
-  GtkWidget *drawingarea1;
-  GtkWidget *dialog_action_area1;
-  GtkWidget *cancelbutton1;
-  GtkWidget *okbutton1;
-
-  dialog1 = gtk_dialog_new ();
-  gtk_window_set_title (GTK_WINDOW (dialog1), _(&quot;Mplayer Delogo&quot;));
-  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
-
-  dialog_vbox1 = GTK_DIALOG (dialog1)-&gt;vbox;
-  gtk_widget_show (dialog_vbox1);
-
-  vbox1 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox1);
-  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
-
-  vbox2 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox2);
-  gtk_box_pack_start (GTK_BOX (vbox1), vbox2, FALSE, FALSE, 0);
-
-  table2 = gtk_table_new (3, 4, FALSE);
-  gtk_widget_show (table2);
-  gtk_box_pack_start (GTK_BOX (vbox2), table2, TRUE, TRUE, 0);
-
-  label3 = gtk_label_new (_(&quot;X&quot;));
-  gtk_widget_show (label3);
-  gtk_table_attach (GTK_TABLE (table2), label3, 0, 1, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label3), 0, 0.5);
-
-  label4 = gtk_label_new (_(&quot;Y&quot;));
-  gtk_widget_show (label4);
-  gtk_table_attach (GTK_TABLE (table2), label4, 0, 1, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label4), 0, 0.5);
-
-  label5 = gtk_label_new (_(&quot;W&quot;));
-  gtk_widget_show (label5);
-  gtk_table_attach (GTK_TABLE (table2), label5, 2, 3, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label5), 0, 0.5);
-
-  label6 = gtk_label_new (_(&quot;H&quot;));
-  gtk_widget_show (label6);
-  gtk_table_attach (GTK_TABLE (table2), label6, 2, 3, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label6), 0, 0.5);
-
-  label7 = gtk_label_new (_(&quot;Band&quot;));
-  gtk_widget_show (label7);
-  gtk_table_attach (GTK_TABLE (table2), label7, 0, 1, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label7), 0, 0.5);
-
-  spinbuttonX_adj = gtk_adjustment_new (1, 0, 2000, 1, 10, 10);
-  spinbuttonX = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonX_adj), 1, 0);
-  gtk_widget_show (spinbuttonX);
-  gtk_table_attach (GTK_TABLE (table2), spinbuttonX, 1, 2, 0, 1,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  spinbuttonY_adj = gtk_adjustment_new (1, 0, 2000, 1, 10, 10);
-  spinbuttonY = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonY_adj), 1, 0);
-  gtk_widget_show (spinbuttonY);
-  gtk_table_attach (GTK_TABLE (table2), spinbuttonY, 1, 2, 1, 2,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  spinbuttonW_adj = gtk_adjustment_new (1, 0, 2000, 1, 10, 10);
-  spinbuttonW = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonW_adj), 1, 0);
-  gtk_widget_show (spinbuttonW);
-  gtk_table_attach (GTK_TABLE (table2), spinbuttonW, 3, 4, 0, 1,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  spinbuttonH_adj = gtk_adjustment_new (1, 0, 2000, 1, 10, 10);
-  spinbuttonH = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonH_adj), 1, 0);
-  gtk_widget_show (spinbuttonH);
-  gtk_table_attach (GTK_TABLE (table2), spinbuttonH, 3, 4, 1, 2,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  hseparator1 = gtk_hseparator_new ();
-  gtk_widget_show (hseparator1);
-  gtk_table_attach (GTK_TABLE (table2), hseparator1, 3, 4, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (GTK_FILL), 0, 0);
-
-  hseparator2 = gtk_hseparator_new ();
-  gtk_widget_show (hseparator2);
-  gtk_table_attach (GTK_TABLE (table2), hseparator2, 2, 3, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (GTK_FILL), 0, 0);
-
-  spinbuttonBand_adj = gtk_adjustment_new (1, 0, 100, 1, 10, 10);
-  spinbuttonBand = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonBand_adj), 1, 0);
-  gtk_widget_show (spinbuttonBand);
-  gtk_table_attach (GTK_TABLE (table2), spinbuttonBand, 1, 2, 2, 3,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  hseparator3 = gtk_hseparator_new ();
-  gtk_widget_show (hseparator3);
-  gtk_box_pack_start (GTK_BOX (vbox2), hseparator3, FALSE, FALSE, 0);
-
-  hscale1 = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 0, 100, 1, 1, 0)));
-  gtk_widget_show (hscale1);
-  gtk_box_pack_start (GTK_BOX (vbox1), hscale1, FALSE, FALSE, 0);
-
-  drawingarea1 = gtk_drawing_area_new ();
-  gtk_widget_show (drawingarea1);
-  gtk_box_pack_start (GTK_BOX (vbox1), drawingarea1, TRUE, TRUE, 0);
-  gtk_widget_set_size_request (drawingarea1, 100, 100);
-
-  dialog_action_area1 = GTK_DIALOG (dialog1)-&gt;action_area;
-  gtk_widget_show (dialog_action_area1);
-  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
-
-  cancelbutton1 = gtk_button_new_from_stock (&quot;gtk-cancel&quot;);
-  gtk_widget_show (cancelbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
-  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
-
-  okbutton1 = gtk_button_new_from_stock (&quot;gtk-ok&quot;);
-  gtk_widget_show (okbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
-  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
-
-  /* Store pointers to all widgets, for use by lookup_widget(). */
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, &quot;dialog1&quot;);
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, &quot;dialog_vbox1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, vbox1, &quot;vbox1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, vbox2, &quot;vbox2&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, table2, &quot;table2&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label3, &quot;label3&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label4, &quot;label4&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label5, &quot;label5&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label6, &quot;label6&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label7, &quot;label7&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonX, &quot;spinbuttonX&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonY, &quot;spinbuttonY&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonW, &quot;spinbuttonW&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonH, &quot;spinbuttonH&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hseparator1, &quot;hseparator1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hseparator2, &quot;hseparator2&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonBand, &quot;spinbuttonBand&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hseparator3, &quot;hseparator3&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hscale1, &quot;hscale1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, drawingarea1, &quot;drawingarea1&quot;);
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, &quot;dialog_action_area1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, &quot;cancelbutton1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, &quot;okbutton1&quot;);
-
-  return dialog1;
-}
-
-
+	}
+
+	prepare(0);
+	gtk_widget_show(dialog);
+	
+	ui_upload();
+	ui_update();
+	
+#define CONNECT(x,y,z) 	gtk_signal_connect(GTK_OBJECT(WID(x)), #y,GTK_SIGNAL_FUNC(z),   NULL);
+
+        CONNECT(drawingarea1,expose_event,gui_draw);
+        CONNECT(hscale1,value_changed,frame_changed);	  
+		      
+#define CONNECT_SPIN(x) CONNECT(spinbutton##x, value_changed,ui_changed)
+      	  
+        CONNECT_SPIN(X);
+        CONNECT_SPIN(Y);
+        CONNECT_SPIN(W);
+        CONNECT_SPIN(H);
+        CONNECT_SPIN(Band);
+	  
+	draw(dialog,width,height);
+
+	ret=0;
+	int response;
+	while( (response=gtk_dialog_run(GTK_DIALOG(dialog)))==GTK_RESPONSE_APPLY)
+	{
+		ui_changed();
+		
+	}
+	if(response==GTK_RESPONSE_OK)
+        {
+		ui_read( );
+		param-&gt;xoff=x;
+                param-&gt;yoff=y;
+                param-&gt;lw=w;
+                param-&gt;lh=h;
+                param-&gt;band=band;
+		ret=1;
+	}
+        gtk_unregister_dialog(dialog);
+	gtk_widget_destroy(dialog);
+	delete working;	
+	delete imgsrc;
+	delete rgbConv;
+
+	if (resizer)
+	{
+		delete resizer;
+		delete[] rgbBufferDisplay;
+
+		resizer=NULL;
+		rgbBufferDisplay=NULL;
+	}
+
+	working=NULL;
+	dialog=NULL;
+	original=NULL;
+	imgsrc=NULL;
+	return ret;
+}
+void frame_changed( void )
+{
+uint32_t new_frame,max,l,f;
+double   percent;
+GtkWidget *wid;	
+GtkAdjustment *adj;
+
+        max=incoming-&gt;getInfo()-&gt;nb_frames;
+        wid=WID(hscale1);
+        adj=gtk_range_get_adjustment (GTK_RANGE(wid));
+        new_frame=0;
+        
+        percent=(double)GTK_ADJUSTMENT(adj)-&gt;value;
+        percent*=max;
+        percent/=100.;
+        new_frame=(uint32_t)floor(percent);
+        
+        if(new_frame&gt;=max) new_frame=max-1;
+        
+        prepare(new_frame);
+        ui_update();
+        gui_draw();
+
+
+}
+void prepare(uint32_t img)
+{
+	uint32_t l,f;
+	
+	ADM_assert(incoming-&gt;getFrameNumberNoAlloc(img,&amp;l,imgsrc,&amp;f));
+	original=imgsrc-&gt;data;
+	
+
+}
+gboolean ui_changed(void)
+{
+	if(!lock)
+	{
+		ui_read();
+		memcpy(working,original,(width*height*3)&gt;&gt;1);
+		ui_update();
+		draw(dialog,width,height);
+	}
+		return true;
+}
+
+
+/*---------------------------------------------------------------------------
+	Actually draw the working frame on screen
+*/
+gboolean gui_draw( void )
+{
+	draw(dialog,width,height);
+	return true;
+}
+void draw (GtkWidget *dialog,uint32_t w,uint32_t h )
+{
+	GtkWidget *draw=WID(drawingarea1);
+
+	if (resizer)
+	{
+		resizer-&gt;resize(working, rgbBufferDisplay);
+		GUI_RGBDisplay(rgbBufferDisplay, zoomW, zoomH, (void*)draw);
+	}
+	else
+		GUI_RGBDisplay(working, w, h, (void*)draw);
+}
+/*---------------------------------------------------------------------------
+	Read entried from dialog box
+*/
+
+#define SPIN_GET(x,y) {x= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(WID(spinbutton##y))) ;}
+#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(spinbutton##y)),(gfloat)x) ;}
+
+
+void ui_read (void )
+{
+	int reject=0;
+	
+			SPIN_GET(x,X);
+			SPIN_GET(y,Y);
+			SPIN_GET(h,H);
+			SPIN_GET(w,W);
+                        SPIN_GET(band,Band);
+			
+			//printf(&quot;%d %d %d %d\n&quot;,x,y,w,h);
+			
+			x&amp;=0xffffe;
+			y&amp;=0xffffe;
+			h&amp;=0xffffe;
+			w&amp;=0xffffe;
+			
+			if((x+w)&gt;width)
+				{
+                                        if(w&gt;=width) w=width;
+                                        x=width-w;
+                                        reject=1;
+				}
+			if((y+h)&gt;height)
+				{
+                                        if(h&gt;=height) h=height;
+                                        y=height-h;
+                                        reject=1;
+				}
+			if(reject)
+				ui_upload();
+}
+
+void ui_upload(void)
+{
+	lock++;
+	SPIN_SET(x,X);
+	SPIN_SET(y,Y);
+	SPIN_SET(w,W);
+	SPIN_SET(h,H);
+        SPIN_SET(band,Band);
+	lock--;
+}
+//____________________________________
+void reset( void )
+{
+	
+	x=y=w=h=0;
+	ui_upload();
+	ui_update();
+	gui_draw();
+	
+
+}
+/*---------------------------------------------------------------------------
+	Green-ify the displayed frame on cropped parts
+*/
+void ui_update( )
+{
+
+        uint8_t  *in,*in2;
+        uint8_t *buffer=working;
+
+        rgbConv-&gt;scale(original,buffer);
+        // Buffer is in RGB space
+        in=buffer+x*4+y*width*4;
+        in2=buffer+(x+w)*4+y*width*4;
+        
+        for(int yy=0;yy&lt;h;yy++)
+        {
+          in[0]=in[2]=0;in[1]=0xff;
+          in2[0]=in2[2]=0;in2[1]=0xff;
+          in+=width*4;
+          in2+=width*4;
+        }
+        in=buffer+(y*width+x)*4;
+        in2=buffer+((y+h)*width+x)*4;
+        for(int yy=0;yy&lt;w;yy++)
+        {
+          in[0]=in[2]=0;in[1]=0xff;
+          in2[0]=in2[2]=0;in2[1]=0xff;
+          in+=4;
+          in2+=4;
+        }
+
+}
+
+//--------------------------------------------
+GtkWidget*
+create_dialog1 (void)
+{
+  GtkWidget *dialog1;
+  GtkWidget *dialog_vbox1;
+  GtkWidget *vbox1;
+  GtkWidget *vbox2;
+  GtkWidget *table2;
+  GtkWidget *label3;
+  GtkWidget *label4;
+  GtkWidget *label5;
+  GtkWidget *label6;
+  GtkWidget *label7;
+  GtkObject *spinbuttonX_adj;
+  GtkWidget *spinbuttonX;
+  GtkObject *spinbuttonY_adj;
+  GtkWidget *spinbuttonY;
+  GtkObject *spinbuttonW_adj;
+  GtkWidget *spinbuttonW;
+  GtkObject *spinbuttonH_adj;
+  GtkWidget *spinbuttonH;
+  GtkWidget *hseparator1;
+  GtkWidget *hseparator2;
+  GtkObject *spinbuttonBand_adj;
+  GtkWidget *spinbuttonBand;
+  GtkWidget *hseparator3;
+  GtkWidget *hscale1;
+  GtkWidget *drawingarea1;
+  GtkWidget *dialog_action_area1;
+  GtkWidget *cancelbutton1;
+  GtkWidget *okbutton1;
+
+  dialog1 = gtk_dialog_new ();
+  gtk_window_set_title (GTK_WINDOW (dialog1), _(&quot;Mplayer Delogo&quot;));
+  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
+
+  dialog_vbox1 = GTK_DIALOG (dialog1)-&gt;vbox;
+  gtk_widget_show (dialog_vbox1);
+
+  vbox1 = gtk_vbox_new (FALSE, 0);
+  gtk_widget_show (vbox1);
+  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
+
+  vbox2 = gtk_vbox_new (FALSE, 0);
+  gtk_widget_show (vbox2);
+  gtk_box_pack_start (GTK_BOX (vbox1), vbox2, FALSE, FALSE, 0);
+
+  table2 = gtk_table_new (3, 4, FALSE);
+  gtk_widget_show (table2);
+  gtk_box_pack_start (GTK_BOX (vbox2), table2, TRUE, TRUE, 0);
+
+  label3 = gtk_label_new (_(&quot;X&quot;));
+  gtk_widget_show (label3);
+  gtk_table_attach (GTK_TABLE (table2), label3, 0, 1, 0, 1,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_misc_set_alignment (GTK_MISC (label3), 0, 0.5);
+
+  label4 = gtk_label_new (_(&quot;Y&quot;));
+  gtk_widget_show (label4);
+  gtk_table_attach (GTK_TABLE (table2), label4, 0, 1, 1, 2,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_misc_set_alignment (GTK_MISC (label4), 0, 0.5);
+
+  label5 = gtk_label_new (_(&quot;W&quot;));
+  gtk_widget_show (label5);
+  gtk_table_attach (GTK_TABLE (table2), label5, 2, 3, 0, 1,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_misc_set_alignment (GTK_MISC (label5), 0, 0.5);
+
+  label6 = gtk_label_new (_(&quot;H&quot;));
+  gtk_widget_show (label6);
+  gtk_table_attach (GTK_TABLE (table2), label6, 2, 3, 1, 2,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_misc_set_alignment (GTK_MISC (label6), 0, 0.5);
+
+  label7 = gtk_label_new (_(&quot;Band&quot;));
+  gtk_widget_show (label7);
+  gtk_table_attach (GTK_TABLE (table2), label7, 0, 1, 2, 3,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+  gtk_misc_set_alignment (GTK_MISC (label7), 0, 0.5);
+
+  spinbuttonX_adj = gtk_adjustment_new (1, 0, 2000, 1, 10, 10);
+  spinbuttonX = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonX_adj), 1, 0);
+  gtk_widget_show (spinbuttonX);
+  gtk_table_attach (GTK_TABLE (table2), spinbuttonX, 1, 2, 0, 1,
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+
+  spinbuttonY_adj = gtk_adjustment_new (1, 0, 2000, 1, 10, 10);
+  spinbuttonY = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonY_adj), 1, 0);
+  gtk_widget_show (spinbuttonY);
+  gtk_table_attach (GTK_TABLE (table2), spinbuttonY, 1, 2, 1, 2,
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+
+  spinbuttonW_adj = gtk_adjustment_new (1, 0, 2000, 1, 10, 10);
+  spinbuttonW = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonW_adj), 1, 0);
+  gtk_widget_show (spinbuttonW);
+  gtk_table_attach (GTK_TABLE (table2), spinbuttonW, 3, 4, 0, 1,
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+
+  spinbuttonH_adj = gtk_adjustment_new (1, 0, 2000, 1, 10, 10);
+  spinbuttonH = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonH_adj), 1, 0);
+  gtk_widget_show (spinbuttonH);
+  gtk_table_attach (GTK_TABLE (table2), spinbuttonH, 3, 4, 1, 2,
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+
+  hseparator1 = gtk_hseparator_new ();
+  gtk_widget_show (hseparator1);
+  gtk_table_attach (GTK_TABLE (table2), hseparator1, 3, 4, 2, 3,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (GTK_FILL), 0, 0);
+
+  hseparator2 = gtk_hseparator_new ();
+  gtk_widget_show (hseparator2);
+  gtk_table_attach (GTK_TABLE (table2), hseparator2, 2, 3, 2, 3,
+                    (GtkAttachOptions) (GTK_FILL),
+                    (GtkAttachOptions) (GTK_FILL), 0, 0);
+
+  spinbuttonBand_adj = gtk_adjustment_new (1, 0, 100, 1, 10, 10);
+  spinbuttonBand = gtk_spin_button_new (GTK_ADJUSTMENT (spinbuttonBand_adj), 1, 0);
+  gtk_widget_show (spinbuttonBand);
+  gtk_table_attach (GTK_TABLE (table2), spinbuttonBand, 1, 2, 2, 3,
+                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
+                    (GtkAttachOptions) (0), 0, 0);
+
+  hseparator3 = gtk_hseparator_new ();
+  gtk_widget_show (hseparator3);
+  gtk_box_pack_start (GTK_BOX (vbox2), hseparator3, FALSE, FALSE, 0);
+
+  hscale1 = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 0, 100, 1, 1, 0)));
+  gtk_widget_show (hscale1);
+  gtk_box_pack_start (GTK_BOX (vbox1), hscale1, FALSE, FALSE, 0);
+
+  drawingarea1 = gtk_drawing_area_new ();
+  gtk_widget_show (drawingarea1);
+  gtk_box_pack_start (GTK_BOX (vbox1), drawingarea1, TRUE, TRUE, 0);
+  gtk_widget_set_size_request (drawingarea1, 100, 100);
+
+  dialog_action_area1 = GTK_DIALOG (dialog1)-&gt;action_area;
+  gtk_widget_show (dialog_action_area1);
+  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
+
+  cancelbutton1 = gtk_button_new_from_stock (&quot;gtk-cancel&quot;);
+  gtk_widget_show (cancelbutton1);
+  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
+  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
+
+  okbutton1 = gtk_button_new_from_stock (&quot;gtk-ok&quot;);
+  gtk_widget_show (okbutton1);
+  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
+  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
+
+  /* Store pointers to all widgets, for use by lookup_widget(). */
+  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, &quot;dialog1&quot;);
+  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, &quot;dialog_vbox1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, vbox1, &quot;vbox1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, vbox2, &quot;vbox2&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, table2, &quot;table2&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, label3, &quot;label3&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, label4, &quot;label4&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, label5, &quot;label5&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, label6, &quot;label6&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, label7, &quot;label7&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonX, &quot;spinbuttonX&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonY, &quot;spinbuttonY&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonW, &quot;spinbuttonW&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonH, &quot;spinbuttonH&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, hseparator1, &quot;hseparator1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, hseparator2, &quot;hseparator2&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, spinbuttonBand, &quot;spinbuttonBand&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, hseparator3, &quot;hseparator3&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, hscale1, &quot;hscale1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, drawingarea1, &quot;drawingarea1&quot;);
+  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, &quot;dialog_action_area1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, &quot;cancelbutton1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, &quot;okbutton1&quot;);
+
+  return dialog1;
+}
+
+

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_preview.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_preview.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -32,7 +32,6 @@
 #include &quot;DIA_flyPreview.h&quot;
 
 static GtkWidget *create_dialog1(void);
-extern float UI_calcZoomToFitScreen(GtkWindow* window, GtkWidget* drawingArea, uint32_t imageWidth, uint32_t imageHeight);
 
 static GtkWidget *dialog = NULL;
 
@@ -79,16 +78,6 @@
 	width = videoStream-&gt;getInfo()-&gt;width;
 	height = videoStream-&gt;getInfo()-&gt;height;
 
-	float zoom = UI_calcZoomToFitScreen(GTK_WINDOW(dialog), WID(drawingarea1), width, height);
-
-	uint32_t zoomW = width * zoom;
-	uint32_t zoomH = height * zoom;
-
-	gtk_widget_set_usize(WID(drawingarea1), zoomW, zoomH);
-
-	if (zoom &lt; 1)
-		gtk_window_set_position(GTK_WINDOW(dialog), GTK_WIN_POS_CENTER);
-
 	gtk_signal_connect(GTK_OBJECT(WID(scale)), &quot;value_changed&quot;, GTK_SIGNAL_FUNC(seekablePreview_frame_changed), NULL);
 	gtk_signal_connect(GTK_OBJECT(WID(drawingarea1)), &quot;expose_event&quot;, GTK_SIGNAL_FUNC(seekablePreview_draw), NULL);
 	gtk_dialog_add_action_widget(GTK_DIALOG(dialog), WID(buttonOk), GTK_RESPONSE_OK);
@@ -97,7 +86,6 @@
 
 	seekablePreview = new flySeekablePreview(width, height, videoStream, WID(drawingarea1), WID(scale));
 	seekablePreview-&gt;process();
-	seekablePreview-&gt;resizeImage(zoomW, zoomH);
 	seekablePreview-&gt;sliderSet(frame);
 	seekablePreview-&gt;sliderChanged();
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_srt.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_srt.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_srt.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -1,311 +1,296 @@
-/***************************************************************************
-                          ADM_guiSRT.cpp  -  description
-                             -------------------
-    begin                : Wed Dec 18 2002
-    copyright            : (C) 2002 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-
-#include &lt;gtk/gtk.h&gt;
-#include &lt;time.h&gt;
-#include &lt;sys/time.h&gt;
-#include &lt;math.h&gt;
-#include &lt;iconv.h&gt;
-
-
-#include &quot;fourcc.h&quot;
-#include &quot;avio.hxx&quot;
-
-#ifdef USE_FREETYPE
-
-#include &quot;avi_vars.h&quot;
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-#include &quot;ADM_toolkit/filesel.h&quot;
-
-
-
-#include &quot;ADM_editor/ADM_edit.hxx&quot;
-#include &quot;ADM_video/ADM_genvideo.hxx&quot;
-
-//#include &quot;ADM_video/ADM_vidFont.h&quot;
-class ADMfont;
-#include &quot;ADM_video/ADM_vidSRT.h&quot;
-
-#include &quot;ADM_toolkit_gtk/ADM_gladeSupport.h&quot;
-#include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
-#include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
-
-#include &quot;ADM_colorspace/ADM_rgb.h&quot;
-#include &quot;ADM_colorspace/colorspace.h&quot;
-
-#include &quot;ADM_osSupport/ADM_debugID.h&quot;
-#define MODULE_NAME MODULE_FILTER
-#include &quot;ADM_osSupport/ADM_debug.h&quot;
-
-#include &lt;ADM_assert.h&gt;
-#include &quot;DIA_flyDialog.h&quot;
-#include &quot;DIA_flySrtPos.h&quot;
-
-
-static void read( void );
-static void upload ( void );
-static gboolean slider_update( void );
-static gboolean gui_update( void);
-static gboolean gui_draw( void );
-static GtkWidget *create_dialog1 (void);
-
-static GtkWidget *dialog=NULL;
-static flySrtPos *myCrop=NULL;
-static int lock=0;
-
-extern float UI_calcZoomToFitScreen(GtkWindow* window, GtkWidget* drawingArea, uint32_t imageWidth, uint32_t imageHeight);
-/**
-      \fn DIA_srtPos
-      \brief Dialog that handles subtitle size and position
-*/
-int DIA_srtPos(AVDMGenericVideoStream *in,uint32_t *size,uint32_t *position)
-{
-  uint8_t ret=0;
-  
-        uint32_t width,height;
-
-        // Allocate space for green-ised video
-        width=in-&gt;getInfo()-&gt;width;
-        height=in-&gt;getInfo()-&gt;height;
-
-        dialog=create_dialog1();
-        gtk_register_dialog(dialog);
-        gtk_window_set_title (GTK_WINDOW (dialog), _(&quot;Subtitle Size and Position&quot;));
-
-		float zoom = UI_calcZoomToFitScreen(GTK_WINDOW(dialog), WID(drawingarea1), width, height);
+/***************************************************************************
+                          ADM_guiSRT.cpp  -  description
+                             -------------------
+    begin                : Wed Dec 18 2002
+    copyright            : (C) 2002 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
 
-		uint32_t zoomW = width * zoom;
-		uint32_t zoomH = height * zoom;
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;config.h&quot;
 
-		gtk_widget_set_usize(WID(drawingarea1), zoomW, zoomH);
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
 
-		if (zoom &lt; 1)
-		{
-			gtk_window_set_position(GTK_WINDOW(dialog), GTK_WIN_POS_CENTER);
-		}
-
-        gtk_widget_show(dialog);
-	
-        myCrop=new flySrtPos( width, height,in,WID(drawingarea1),WID(hscale1));
-        myCrop-&gt;param.fontSize=*size;
-        myCrop-&gt;param.position=*position;
-
-        gtk_range_set_range(GTK_RANGE(WID(vscale1)),0,height-1);
-
-		myCrop-&gt;resizeImage(zoomW, zoomH);
-        myCrop-&gt;upload();
-        myCrop-&gt;sliderChanged();
-        
-        gtk_signal_connect(GTK_OBJECT(WID(drawingarea1)), &quot;expose_event&quot;,
-            GTK_SIGNAL_FUNC(gui_draw),
-            NULL);
-        
-        gtk_signal_connect (GTK_OBJECT(WID( spinbutton1)), &quot;value_changed&quot;,
-                    GTK_SIGNAL_FUNC (gui_update),
-                    NULL);
-        
-         gtk_signal_connect (GTK_OBJECT(WID( hscale1)), &quot;value_changed&quot;,
-                    GTK_SIGNAL_FUNC (slider_update),
-                    NULL);
-
-          gtk_signal_connect (GTK_OBJECT(WID( vscale1)), &quot;value_changed&quot;,
-                    GTK_SIGNAL_FUNC (gui_update),
-                    NULL);
-       
-        ret=0;
-        int response;
-        response=gtk_dialog_run(GTK_DIALOG(dialog));
-
-        if(response==GTK_RESPONSE_OK)
-        {
-            myCrop-&gt;download();
-            *size=myCrop-&gt;param.fontSize;
-            *position=myCrop-&gt;param.position;
-            ret=1;
-        }
-        gtk_unregister_dialog(dialog);
-        gtk_widget_destroy(dialog);
-        delete myCrop;
-        return ret;
-}
-/**********************************/
-void read( void )
-{
-	myCrop-&gt;download();
-}
-gboolean slider_update( void )
-{
-        myCrop-&gt;sliderChanged();
-        return true;
-}
-gboolean gui_update( void)
-{
-  if(lock) return true;
-      myCrop-&gt;update();
-  return true;
-}
-gboolean gui_draw( void )
-{
-	myCrop-&gt;display();
-	return true;
-}
-
-/******************************/
-#define SPIN_GET(x,y) {y= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(lookup_widget(dialog,#x))) ;\
-				printf(#x&quot;:%d\n&quot;, y);}
-
-#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(lookup_widget(dialog,#x)),(gfloat)y) ; printf(#x&quot;:%d\n&quot;, y);}
-
-
-uint8_t    flySrtPos::upload(void)
-{
-        SPIN_SET(spinbutton1,param.fontSize);
-        
-        int32_t max=_h;
-        max-=(SRT_MAX_LINE)*param.fontSize;
-        if(max&lt;0) max=0;
-        if(param.position&gt;=max)
-        {
-          param.position=max;
-        }
-        
-        GtkAdjustment *adj=gtk_range_get_adjustment (GTK_RANGE(WID(vscale1)));
-        GTK_ADJUSTMENT(adj)-&gt;value=param.position;
-        return 1;
-}
-uint8_t    flySrtPos::download(void)
-{
-        SPIN_GET(spinbutton1,param.fontSize);
-        GtkAdjustment *adj=gtk_range_get_adjustment (GTK_RANGE(WID(vscale1)));
-        param.position=(uint32_t)GTK_ADJUSTMENT(adj)-&gt;value;
-        
-        int32_t max=_h;
-        max-=(SRT_MAX_LINE)*param.fontSize;
-        if(max&lt;0) max=0;
-        if(param.position&gt;=max)
-        {
-          param.position=max;
-          upload(); 
-        }
-        
-        return 1;
-}
-
-/*
-	Almost straigh out of glade2
-
-*/
-
-GtkWidget*
-create_dialog1 (void)
-{
-  GtkWidget *dialog1;
-  GtkWidget *dialog_vbox1;
-  GtkWidget *vbox1;
-  GtkWidget *hbox1;
-  GtkWidget *label1;
-  GtkObject *spinbutton1_adj;
-  GtkWidget *spinbutton1;
-  GtkWidget *hscale1;
-  GtkWidget *hbox2;
-  GtkWidget *drawingarea1;
-  GtkWidget *vscale1;
-  GtkWidget *dialog_action_area1;
-  GtkWidget *cancelbutton1;
-  GtkWidget *okbutton1;
-
-  dialog1 = gtk_dialog_new ();
-  gtk_window_set_title (GTK_WINDOW (dialog1), _(&quot;Subtitle Size and Position&quot;));
-  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
-
-  dialog_vbox1 = GTK_DIALOG (dialog1)-&gt;vbox;
-  gtk_widget_show (dialog_vbox1);
-
-  vbox1 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox1);
-  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
-
-  hbox1 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox1);
-  gtk_box_pack_start (GTK_BOX (vbox1), hbox1, FALSE, FALSE, 0);
-
-  label1 = gtk_label_new (_(&quot;Font Size:&quot;));
-  gtk_widget_show (label1);
-  gtk_box_pack_start (GTK_BOX (hbox1), label1, FALSE, FALSE, 0);
-
-  spinbutton1_adj = gtk_adjustment_new (1, 6, 99, 1, 10, 10);
-  spinbutton1 = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton1_adj), 1, 2);
-  gtk_widget_show (spinbutton1);
-  gtk_box_pack_start (GTK_BOX (hbox1), spinbutton1, FALSE, FALSE, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton1), TRUE);
-
-  hscale1 = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 0, 99, 1, 1, 1)));
-  gtk_widget_show (hscale1);
-  gtk_box_pack_start (GTK_BOX (vbox1), hscale1, FALSE, FALSE, 0);
-
-  hbox2 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox2);
-  gtk_box_pack_start (GTK_BOX (vbox1), hbox2, TRUE, TRUE, 0);
-
-  drawingarea1 = gtk_drawing_area_new ();
-  gtk_widget_show (drawingarea1);
-  gtk_box_pack_start (GTK_BOX (hbox2), drawingarea1, TRUE, TRUE, 0);
-
-  vscale1 = gtk_vscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 100, 1, 1, 1, 1)));
-  gtk_widget_show (vscale1);
-  gtk_box_pack_start (GTK_BOX (hbox2), vscale1, FALSE, FALSE, 0);
-  gtk_scale_set_digits (GTK_SCALE (vscale1), 0);
-
-  dialog_action_area1 = GTK_DIALOG (dialog1)-&gt;action_area;
-  gtk_widget_show (dialog_action_area1);
-  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
-
-  cancelbutton1 = gtk_button_new_from_stock (&quot;gtk-cancel&quot;);
-  gtk_widget_show (cancelbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
-  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
-
-  okbutton1 = gtk_button_new_from_stock (&quot;gtk-ok&quot;);
-  gtk_widget_show (okbutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
-  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
-
-  /* Store pointers to all widgets, for use by lookup_widget(). */
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, &quot;dialog1&quot;);
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, &quot;dialog_vbox1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, vbox1, &quot;vbox1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hbox1, &quot;hbox1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label1, &quot;label1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, spinbutton1, &quot;spinbutton1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hscale1, &quot;hscale1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hbox2, &quot;hbox2&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, drawingarea1, &quot;drawingarea1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, vscale1, &quot;vscale1&quot;);
-  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, &quot;dialog_action_area1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, &quot;cancelbutton1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, &quot;okbutton1&quot;);
-
-  return dialog1;
-}
-
-//-------------------------------
-#endif //FREETYPE
+#include &lt;gtk/gtk.h&gt;
+#include &lt;time.h&gt;
+#include &lt;sys/time.h&gt;
+#include &lt;math.h&gt;
+#include &lt;iconv.h&gt;
+
+
+#include &quot;fourcc.h&quot;
+#include &quot;avio.hxx&quot;
+
+#ifdef USE_FREETYPE
+
+#include &quot;avi_vars.h&quot;
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+#include &quot;ADM_toolkit/filesel.h&quot;
+
+
+
+#include &quot;ADM_editor/ADM_edit.hxx&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+
+//#include &quot;ADM_video/ADM_vidFont.h&quot;
+class ADMfont;
+#include &quot;ADM_video/ADM_vidSRT.h&quot;
+
+#include &quot;ADM_toolkit_gtk/ADM_gladeSupport.h&quot;
+#include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
+#include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
+
+#include &quot;ADM_colorspace/ADM_rgb.h&quot;
+#include &quot;ADM_colorspace/colorspace.h&quot;
+
+#include &quot;ADM_osSupport/ADM_debugID.h&quot;
+#define MODULE_NAME MODULE_FILTER
+#include &quot;ADM_osSupport/ADM_debug.h&quot;
+
+#include &lt;ADM_assert.h&gt;
+#include &quot;DIA_flyDialog.h&quot;
+#include &quot;DIA_flySrtPos.h&quot;
+
+
+static void read( void );
+static void upload ( void );
+static gboolean slider_update( void );
+static gboolean gui_update( void);
+static gboolean gui_draw( void );
+static GtkWidget *create_dialog1 (void);
+
+static GtkWidget *dialog=NULL;
+static flySrtPos *myCrop=NULL;
+static int lock=0;
+
+/**
+      \fn DIA_srtPos
+      \brief Dialog that handles subtitle size and position
+*/
+int DIA_srtPos(AVDMGenericVideoStream *in,uint32_t *size,uint32_t *position)
+{
+  uint8_t ret=0;
+  
+        uint32_t width,height;
+
+        // Allocate space for green-ised video
+        width=in-&gt;getInfo()-&gt;width;
+        height=in-&gt;getInfo()-&gt;height;
+
+        dialog=create_dialog1();
+        gtk_register_dialog(dialog);
+        gtk_window_set_title (GTK_WINDOW (dialog), _(&quot;Subtitle Size and Position&quot;));
+        gtk_widget_show(dialog);
+	
+        myCrop=new flySrtPos( width, height,in,WID(drawingarea1),WID(hscale1));
+        myCrop-&gt;param.fontSize=*size;
+        myCrop-&gt;param.position=*position;
+
+        gtk_range_set_range(GTK_RANGE(WID(vscale1)),0,height-1);
+
+        myCrop-&gt;upload();
+        myCrop-&gt;sliderChanged();
+        
+        gtk_signal_connect(GTK_OBJECT(WID(drawingarea1)), &quot;expose_event&quot;,
+            GTK_SIGNAL_FUNC(gui_draw),
+            NULL);
+        
+        gtk_signal_connect (GTK_OBJECT(WID( spinbutton1)), &quot;value_changed&quot;,
+                    GTK_SIGNAL_FUNC (gui_update),
+                    NULL);
+        
+         gtk_signal_connect (GTK_OBJECT(WID( hscale1)), &quot;value_changed&quot;,
+                    GTK_SIGNAL_FUNC (slider_update),
+                    NULL);
+
+          gtk_signal_connect (GTK_OBJECT(WID( vscale1)), &quot;value_changed&quot;,
+                    GTK_SIGNAL_FUNC (gui_update),
+                    NULL);
+       
+        ret=0;
+        int response;
+        response=gtk_dialog_run(GTK_DIALOG(dialog));
+
+        if(response==GTK_RESPONSE_OK)
+        {
+            myCrop-&gt;download();
+            *size=myCrop-&gt;param.fontSize;
+            *position=myCrop-&gt;param.position;
+            ret=1;
+        }
+        gtk_unregister_dialog(dialog);
+        gtk_widget_destroy(dialog);
+        delete myCrop;
+        return ret;
+}
+/**********************************/
+void read( void )
+{
+	myCrop-&gt;download();
+}
+gboolean slider_update( void )
+{
+        myCrop-&gt;sliderChanged();
+        return true;
+}
+gboolean gui_update( void)
+{
+  if(lock) return true;
+      myCrop-&gt;update();
+  return true;
+}
+gboolean gui_draw( void )
+{
+	myCrop-&gt;display();
+	return true;
+}
+
+/******************************/
+#define SPIN_GET(x,y) {y= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(lookup_widget(dialog,#x))) ;\
+				printf(#x&quot;:%d\n&quot;, y);}
+
+#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(lookup_widget(dialog,#x)),(gfloat)y) ; printf(#x&quot;:%d\n&quot;, y);}
+
+
+uint8_t    flySrtPos::upload(void)
+{
+        SPIN_SET(spinbutton1,param.fontSize);
+        
+        int32_t max=_h;
+        max-=(SRT_MAX_LINE)*param.fontSize;
+        if(max&lt;0) max=0;
+        if(param.position&gt;=max)
+        {
+          param.position=max;
+        }
+        
+        GtkAdjustment *adj=gtk_range_get_adjustment (GTK_RANGE(WID(vscale1)));
+        GTK_ADJUSTMENT(adj)-&gt;value=param.position;
+        return 1;
+}
+uint8_t    flySrtPos::download(void)
+{
+        SPIN_GET(spinbutton1,param.fontSize);
+        GtkAdjustment *adj=gtk_range_get_adjustment (GTK_RANGE(WID(vscale1)));
+        param.position=(uint32_t)GTK_ADJUSTMENT(adj)-&gt;value;
+        
+        int32_t max=_h;
+        max-=(SRT_MAX_LINE)*param.fontSize;
+        if(max&lt;0) max=0;
+        if(param.position&gt;=max)
+        {
+          param.position=max;
+          upload(); 
+        }
+        
+        return 1;
+}
+
+/*
+	Almost straigh out of glade2
+
+*/
+
+GtkWidget*
+create_dialog1 (void)
+{
+  GtkWidget *dialog1;
+  GtkWidget *dialog_vbox1;
+  GtkWidget *vbox1;
+  GtkWidget *hbox1;
+  GtkWidget *label1;
+  GtkObject *spinbutton1_adj;
+  GtkWidget *spinbutton1;
+  GtkWidget *hscale1;
+  GtkWidget *hbox2;
+  GtkWidget *drawingarea1;
+  GtkWidget *vscale1;
+  GtkWidget *dialog_action_area1;
+  GtkWidget *cancelbutton1;
+  GtkWidget *okbutton1;
+
+  dialog1 = gtk_dialog_new ();
+  gtk_window_set_title (GTK_WINDOW (dialog1), _(&quot;Subtitle Size and Position&quot;));
+  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
+
+  dialog_vbox1 = GTK_DIALOG (dialog1)-&gt;vbox;
+  gtk_widget_show (dialog_vbox1);
+
+  vbox1 = gtk_vbox_new (FALSE, 0);
+  gtk_widget_show (vbox1);
+  gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
+
+  hbox1 = gtk_hbox_new (FALSE, 0);
+  gtk_widget_show (hbox1);
+  gtk_box_pack_start (GTK_BOX (vbox1), hbox1, FALSE, FALSE, 0);
+
+  label1 = gtk_label_new (_(&quot;Font Size:&quot;));
+  gtk_widget_show (label1);
+  gtk_box_pack_start (GTK_BOX (hbox1), label1, FALSE, FALSE, 0);
+
+  spinbutton1_adj = gtk_adjustment_new (1, 6, 99, 1, 10, 10);
+  spinbutton1 = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton1_adj), 1, 2);
+  gtk_widget_show (spinbutton1);
+  gtk_box_pack_start (GTK_BOX (hbox1), spinbutton1, FALSE, FALSE, 0);
+  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton1), TRUE);
+
+  hscale1 = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 0, 99, 1, 1, 1)));
+  gtk_widget_show (hscale1);
+  gtk_box_pack_start (GTK_BOX (vbox1), hscale1, FALSE, FALSE, 0);
+
+  hbox2 = gtk_hbox_new (FALSE, 0);
+  gtk_widget_show (hbox2);
+  gtk_box_pack_start (GTK_BOX (vbox1), hbox2, TRUE, TRUE, 0);
+
+  drawingarea1 = gtk_drawing_area_new ();
+  gtk_widget_show (drawingarea1);
+  gtk_box_pack_start (GTK_BOX (hbox2), drawingarea1, TRUE, TRUE, 0);
+
+  vscale1 = gtk_vscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 100, 1, 1, 1, 1)));
+  gtk_widget_show (vscale1);
+  gtk_box_pack_start (GTK_BOX (hbox2), vscale1, FALSE, FALSE, 0);
+  gtk_scale_set_digits (GTK_SCALE (vscale1), 0);
+
+  dialog_action_area1 = GTK_DIALOG (dialog1)-&gt;action_area;
+  gtk_widget_show (dialog_action_area1);
+  gtk_button_box_set_layout (GTK_BUTTON_BOX (dialog_action_area1), GTK_BUTTONBOX_END);
+
+  cancelbutton1 = gtk_button_new_from_stock (&quot;gtk-cancel&quot;);
+  gtk_widget_show (cancelbutton1);
+  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
+  GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
+
+  okbutton1 = gtk_button_new_from_stock (&quot;gtk-ok&quot;);
+  gtk_widget_show (okbutton1);
+  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
+  GTK_WIDGET_SET_FLAGS (okbutton1, GTK_CAN_DEFAULT);
+
+  /* Store pointers to all widgets, for use by lookup_widget(). */
+  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, &quot;dialog1&quot;);
+  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, &quot;dialog_vbox1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, vbox1, &quot;vbox1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, hbox1, &quot;hbox1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, label1, &quot;label1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, spinbutton1, &quot;spinbutton1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, hscale1, &quot;hscale1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, hbox2, &quot;hbox2&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, drawingarea1, &quot;drawingarea1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, vscale1, &quot;vscale1&quot;);
+  GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, &quot;dialog_action_area1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, &quot;cancelbutton1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, okbutton1, &quot;okbutton1&quot;);
+
+  return dialog1;
+}
+
+//-------------------------------
+#endif //FREETYPE

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_gtkRender.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -18,21 +18,17 @@
 
 #include &lt;stdio.h&gt;         
 #include &lt;stdlib.h&gt;
-#include &lt;math.h&gt;
 #include &lt;unistd.h&gt;
 
 #include &lt;gtk/gtk.h&gt;
 #ifdef ADM_WIN32
+#define WIN32_CLASH
 #include &lt;gdk/gdkwin32.h&gt;
 #else
 #include &lt;gdk/gdkx.h&gt;
 #endif
 
-#include &lt;time.h&gt;
-#include &lt;sys/time.h&gt;
-
-#include &lt;../ADM_assert.h&gt;
-#define WIN32_CLASH
+#include &quot;../ADM_assert.h&quot;
 #include &quot;default.h&quot;
 #include &quot;../ADM_osSupport/ADM_misc.h&quot;
 
@@ -41,10 +37,8 @@
 
 #include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
 
-#include &quot;../prefs.h&quot;
 #include &quot;../../../ADM_colorspace/ADM_rgb.h&quot;
 #include &quot;../../../ADM_libraries/ADM_libswscale/ADM_mp.h&quot;
-#include &quot;../gtkgui.h&quot;
 
 void GUI_gtk_grow_off(int onff);
 
@@ -148,4 +142,24 @@
 	else
 		return 1;
 }
+
+// GTK doesn't centre the window correctly.  Use this function to centre windows with a canvas that is yet to resized.
+void UI_centreCanvasWindow(GtkWindow *window, GtkWidget *canvas, int newCanvasWidth, int newCanvasHeight)
+{
+	int winWidth, winHeight, widgetWidth, widgetHeight;
+	uint32_t resWidth, resHeight;
+
+	UI_getPhysicalScreenSize(&amp;resWidth, &amp;resHeight);
+	gtk_widget_get_size_request((GtkWidget*)canvas, &amp;widgetWidth, &amp;widgetHeight);
+	gtk_window_get_size(window, &amp;winWidth, &amp;winHeight);
+
+	winWidth = newCanvasWidth;
+	winHeight = (winHeight - widgetHeight) + newCanvasHeight;
+
+	// Take borders and captions into consideration (GTK doesn't seem to support this so we'll have to guess)
+	winWidth += 10;
+	winHeight += 40;
+
+	gtk_window_move(window, ((int)resWidth - winWidth) / 2, ((int)resHeight - winHeight) / 2);
+}
 // EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/T_flyDialog.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/T_flyDialog.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/T_flyDialog.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -33,8 +33,8 @@
 #include &quot;DIA_flyDialogQt4.h&quot;
 #include &quot;ADM_assert.h&quot;
 
-void ADM_flyDialog::postInit(uint32_t width, uint32_t height, AVDMGenericVideoStream *in,
-							 void *canvas, void *slider, int yuv) {}
+void ADM_flyDialog::postInit() {}
+float ADM_flyDialog::calcZoomFactor(void) {return 1;}
 
 uint8_t  ADM_flyDialog::display(void)
 {

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyAsharp.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyAsharp.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyAsharp.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -42,7 +42,7 @@
 {
     download();
     process();
-    _rgb-&gt;scale(_yuvBufferOut-&gt;data,_rgbBufferOut);
+	copyYuvFinalToRgb();
     display();
     return 1;
 }
@@ -50,7 +50,7 @@
 {
 uint8_t *src,*dst;
 uint32_t stride;
-int32_t T,D,B,B2;   
+int32_t T,D,B,B2;
 uint32_t ww,hh;
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyAsharp.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyAsharp.h	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyAsharp.h	2007-07-26 13:33:46 UTC (rev 3446)
@@ -13,9 +13,6 @@
    uint8_t    upload(void);
    uint8_t    update(void);
    flyASharp (uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
-                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,1) 
-                    {
-                      
-                    };
+                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,1,RESIZE_AUTO) {};
 };
 #endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyChromaShift.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyChromaShift.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyChromaShift.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -49,7 +49,7 @@
 {
    download();
     process();
-    _rgb-&gt;scale(_yuvBufferOut-&gt;data,_rgbBufferOut);
+	copyYuvFinalToRgb();
     display();
 }
 //EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyChromaShift.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyChromaShift.h	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyChromaShift.h	2007-07-26 13:33:46 UTC (rev 3446)
@@ -11,10 +11,7 @@
    uint8_t    upload(void);
    uint8_t    update(void);
    flyChromaShift (uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
-                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,1) 
-                    {
-                      
-                    };
+                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,1,RESIZE_AUTO) {};
 };
 
 #endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyContrast.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyContrast.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyContrast.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -31,7 +31,7 @@
 {
     download();
     process();
-    _rgb-&gt;scale(_yuvBufferOut-&gt;data,_rgbBufferOut);
+	copyYuvFinalToRgb();
     display();
     return 1;
 }

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyContrast.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyContrast.h	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyContrast.h	2007-07-26 13:33:46 UTC (rev 3446)
@@ -13,7 +13,7 @@
    uint8_t    upload(void);
    uint8_t    update(void);
    flyContrast (uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
-                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,1) 
+                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,1,RESIZE_AUTO)
                     {
                       
                     };

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyCrop.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyCrop.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyCrop.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -98,6 +98,8 @@
                 in+=4*w;
   
         }
+
+		copyRgbFinalToDisplay();
 }
 
 /*----------------------------------

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyCrop.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyCrop.h	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyCrop.h	2007-07-26 13:33:46 UTC (rev 3446)
@@ -1,5 +1,3 @@
-
-
 #ifndef FLY_CROP_H
 #define FLY_CROP_H
 class flyCrop : public ADM_flyDialog
@@ -13,6 +11,6 @@
    uint8_t    upload(void);
    uint8_t    autocrop(void);
    flyCrop (uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
-                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,0) {};
+                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,0,RESIZE_LAST) {};
 };
 #endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyDialog.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyDialog.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyDialog.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -16,70 +16,95 @@
 
 #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
-#include &lt;math.h&gt;
-#include &lt;string.h&gt;
-#include &lt;time.h&gt;
-#include &lt;sys/time.h&gt;
 
 #include &quot;default.h&quot;
 
-#include &quot;ADM_colorspace/colorspace.h&quot;
 #include &quot;ADM_colorspace/ADM_rgb.h&quot;
 #include &quot;ADM_commonUI/GUI_render.h&quot;
 #include &quot;ADM_video/ADM_genvideo.hxx&quot;
 #include &quot;DIA_flyDialog.h&quot;
-
 #include &quot;ADM_assert.h&quot;
 
 extern &quot;C&quot; {
 #include &quot;ADM_libraries/ADM_lavcodec/avcodec.h&quot;
 }
 
-/**
-    \fn ADM_flyDialog
-*/
- ADM_flyDialog::ADM_flyDialog(uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
-                                void *canvas, void *slider,int yuv)
+ADM_flyDialog::ADM_flyDialog(uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
+                                void *canvas, void *slider,int yuv, ResizeMethod resizeMethod)
 {
 	ADM_assert(canvas);
 
 	if (slider)
 		ADM_assert(in);
 
-  _w=_zoomW=width;
-  _h=_zoomH=height;
-  _isYuvProcessing=yuv;
-  _in=in;
+	_w = width;
+	_h = height;
+	_isYuvProcessing = yuv;
+	_in = in;
+	_slider = slider;
+	_canvas = canvas;
+	_cookie = NULL;
+	_resizeMethod = resizeMethod;
 
-    if(isRgbInverted())
-        _rgb=new ColYuvRgb(_w,_h,1);
-    else
-    _rgb=new ColYuvRgb(_w,_h);
+	if (isRgbInverted())
+		_rgb=new ColYuvRgb(_w,_h,1);
+	else
+		_rgb=new ColYuvRgb(_w,_h);
 
-  _rgb-&gt;reset(_w,_h);
+	_rgb-&gt;reset(_w,_h);
 
-  _yuvBuffer=new ADMImage(_w,_h);
+	_yuvBuffer=new ADMImage(_w,_h);
 
-  if(_isYuvProcessing)
-  {
-     _yuvBufferOut=new ADMImage(_w,_h);
-     _rgbBuffer=NULL;
-  }
-  else
-  {
-    _rgbBuffer =new uint8_t [_w*_h*4];
-    _yuvBufferOut=NULL;
-  }
-    _rgbBufferOut =new uint8_t [_w*_h*4];
+	if(_isYuvProcessing)
+	{
+		_yuvBufferOut=new ADMImage(_w,_h);
+		_rgbBuffer=NULL;
+	}
+	else
+	{
+		_rgbBuffer =new uint8_t [_w*_h*4];
+		_yuvBufferOut=NULL;
+	}
 
-  _slider=slider;
-  _canvas=canvas;
-  _cookie=NULL;
-  _rgbBufferDisplay=NULL;
-  _resizer=NULL;
+	_rgbBufferOut =new uint8_t [_w*_h*4];
 
-  postInit(width, height, in, canvas, slider, yuv);
+	if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
+	{
+		float zoom = calcZoomFactor();
+
+		if (zoom == 1)
+			_resizeMethod = RESIZE_NONE;
+		else
+		{
+			_zoomW = _w * zoom;
+			_zoomH = _h * zoom;
+		}
+	}
+
+	if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
+	{
+		PixelFormat sourceColour;
+
+		if (_resizeMethod == RESIZE_AUTO || _isYuvProcessing)
+			sourceColour = PIX_FMT_YUV420P;
+		else
+			sourceColour = PIX_FMT_RGB32;
+
+		_resizer = new ADMImageResizer(_w, _h, _zoomW, _zoomH, sourceColour, PIX_FMT_RGB32);
+		_rgbBufferDisplay = new uint8_t[_w * _h * 4];
+	}
+	else
+	{
+		_zoomW = _w;
+		_zoomH = _h;
+
+		_resizer = NULL;
+		_rgbBufferDisplay = NULL;
+	}
+
+	postInit();
 }
+
 /**
     \fn cleanup
     \brief deallocate
@@ -124,40 +149,49 @@
       printf(&quot;[FlyDialog] Cannot get frame %u\n&quot;,fn); 
       return 0;
     }
-    /* Process...*/
-    
+
+    // Process...    
     if(_isYuvProcessing)
     {
         process();
-        _rgb-&gt;scale(_yuvBufferOut-&gt;data,_rgbBufferOut);
-        
-    } else // RGB Processing
-      
+		copyYuvFinalToRgb();
+    }
+	else // RGB Processing      
     {
         ADM_assert(_rgbBuffer);
-        _rgb-&gt;scale(_yuvBuffer-&gt;data,_rgbBuffer);
+		copyYuvScratchToRgb();
         process();
     }
+
     display();
 }
 
-void ADM_flyDialog::resizeImage(uint32_t width, uint32_t height)
+void ADM_flyDialog::copyYuvFinalToRgb(void)
 {
-	_zoomW = width;
-	_zoomH = height;
+	if (_resizeMethod == RESIZE_AUTO || _resizeMethod == RESIZE_LAST)
+		_resizer-&gt;resize(_yuvBufferOut-&gt;data, _rgbBufferOut);
+	else
+		_rgb-&gt;scale(_yuvBufferOut-&gt;data, _rgbBufferOut);
+}
 
-	if (_resizer)
+void ADM_flyDialog::copyYuvScratchToRgb(void)
+{
+	if (_resizeMethod == RESIZE_AUTO)
+		_resizer-&gt;resize(_yuvBuffer-&gt;data,_rgbBuffer);
+	else
+		_rgb-&gt;scale(_yuvBuffer-&gt;data,_rgbBuffer);
+}
+
+void ADM_flyDialog::copyRgbFinalToDisplay(void)
+{
+	if (_resizeMethod == RESIZE_LAST)
 	{
-		delete _resizer;
-		delete[] _rgbBufferDisplay;
-	}
+		_resizer-&gt;resize(_rgbBufferOut, _rgbBufferDisplay);
 
-	if (width == _w &amp;&amp; height == _h)
-		_resizer = NULL;
-	else
-	{
-		_resizer = new ADMImageResizer(_w, _h, _zoomW, _zoomH, PIX_FMT_RGB32, PIX_FMT_RGB32);
-		_rgbBufferDisplay = new uint8_t[_zoomW * _zoomH * 4];
+		uint8_t* tempRgb = _rgbBufferDisplay;
+
+		_rgbBufferDisplay = _rgbBufferOut;
+		_rgbBufferOut = tempRgb;
 	}
 }
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyDialog.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyDialog.h	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyDialog.h	2007-07-26 13:33:46 UTC (rev 3446)
@@ -24,6 +24,12 @@
  ***************************************************************************/
 #ifndef ADM_FLY_DIALOG_H
 #define ADM_FLY_DIALOG_H
+enum ResizeMethod {
+    RESIZE_NONE = 0,	// No automatic resize
+	RESIZE_AUTO = 1,	// Resize image when convenient (YUV: after filter, RGB: before applying filter)
+	RESIZE_LAST = 2		// Resize image after filter has been applied (slower for RGB)
+};
+
 class ADM_flyDialog
 {
   protected:
@@ -36,11 +42,15 @@
           uint8_t  *_rgbBufferOut;
 		  uint8_t  *_rgbBufferDisplay;
           uint8_t  _isYuvProcessing;
-
+		  ResizeMethod _resizeMethod;
 		  ADMImageResizer *_resizer;
 
-  virtual void postInit(uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
-                                    void *canvas, void *slider,int yuv);
+  virtual void postInit(void);
+		  float calcZoomFactor(void);
+          void copyYuvFinalToRgb(void);
+          void copyYuvScratchToRgb(void);
+		  void copyRgbFinalToDisplay(void);
+
   public:
           void    *_cookie; // whatever
           void    *_slider; // widget
@@ -61,11 +71,10 @@
           uint8_t  isRgbInverted(void);
   virtual uint8_t  update(void) {};
           uint8_t  cleanup(void);
-		  void resizeImage(uint32_t width, uint32_t height);
-         /*                               */
-                  ADM_flyDialog(uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
-                                    void *canvas, void *slider,int yuv);
-    virtual      ~ADM_flyDialog(void);
+
+          ADM_flyDialog(uint32_t width, uint32_t height, AVDMGenericVideoStream *in,
+                             void *canvas, void *slider, int yuv, ResizeMethod resizeMethod);
+  virtual ~ADM_flyDialog(void);
 };
 
 #endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyHue.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyHue.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyHue.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -46,7 +46,7 @@
 {
     download();
     process();
-    _rgb-&gt;scale(_yuvBufferOut-&gt;data,_rgbBufferOut);
+	copyYuvFinalToRgb();
     display();
     return 1;
 }        

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyHue.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyHue.h	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyHue.h	2007-07-26 13:33:46 UTC (rev 3446)
@@ -11,9 +11,6 @@
    uint8_t    upload(void);
    uint8_t    update(void);
    flyHue (uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
-                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,1) 
-                    {
-                      
-                    };
+                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,1,RESIZE_AUTO) {};
 };
 #endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyPreview.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyPreview.h	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyPreview.h	2007-07-26 13:33:46 UTC (rev 3446)
@@ -7,10 +7,10 @@
 	uint8_t download(void) {return 1;}
 	uint8_t upload(void) {return 1;}
 	uint8_t cleanup(void) {return 1;}
-	uint8_t setData(uint8_t *buffer) {_rgb-&gt;scale(buffer, _rgbBufferOut);}
+	uint8_t setData(uint8_t *buffer) {_rgb-&gt;scale(buffer, _rgbBufferOut); return 1;}
 
 	flyPreview(uint32_t width, uint32_t height, void *canvas) : 
-		ADM_flyDialog(width, height, NULL, canvas, NULL, 0) {delete _rgbBuffer; _rgbBuffer = NULL;};
+		ADM_flyDialog(width, height, NULL, canvas, NULL, 0, RESIZE_NONE) {delete _rgbBuffer; _rgbBuffer = NULL;};
 	virtual ~flyPreview(void) {_rgbBuffer = NULL;};
 };
 
@@ -23,7 +23,7 @@
 	uint8_t cleanup(void) {return 1;}
 
 	flySeekablePreview(uint32_t width, uint32_t height, AVDMGenericVideoStream *videoStream, void *canvas, void *slider) : 
-		ADM_flyDialog(width, height, videoStream, canvas, slider, 0) {delete _rgbBufferOut; _rgbBufferOut = NULL;};
+		ADM_flyDialog(width, height, videoStream, canvas, slider, 0, RESIZE_AUTO) {delete _rgbBufferOut; _rgbBufferOut = NULL;};
 	virtual ~flySeekablePreview(void) {_rgbBufferOut = NULL;};
 };
 #endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.cpp	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.cpp	2007-07-26 13:33:46 UTC (rev 3446)
@@ -59,7 +59,7 @@
 {
     download();
     process();
-    _rgb-&gt;scale(_yuvBufferOut-&gt;data,_rgbBufferOut);
+	copyYuvFinalToRgb();
     display();
 }
 #endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.h	2007-07-25 18:17:34 UTC (rev 3445)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.h	2007-07-26 13:33:46 UTC (rev 3446)
@@ -19,10 +19,7 @@
    uint8_t    upload(void);
    uint8_t    update(void);
    flySrtPos (uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
-                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,1) 
-                    {
-                      
-                    };
+                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,1,RESIZE_AUTO) {};
 };
 
 #endif


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000720.html">[Avidemux-svn-commit] r3445 - in	branches/avidemux_2.4_branch/avidemux: . ADM_ocr	ADM_userInterfaces/ADM_GTK/ADM_ocr	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_commonUI
</A></li>
	<LI>Next message: <A HREF="000722.html">[Avidemux-svn-commit] r3447 -	branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_asf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#721">[ date ]</a>
              <a href="thread.html#721">[ thread ]</a>
              <a href="subject.html#721">[ subject ]</a>
              <a href="author.html#721">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
