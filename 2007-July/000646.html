<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r3369 - in	branches/avidemux_2.4_branch/avidemux: .	ADM_libraries/ADM_utilities ADM_ocr	ADM_userInterfaces/ADM_GTK/ADM_dialog	ADM_userInterfaces/ADM_GTK/ADM_ocr	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_commonUI
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2007-July/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3369%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%20.%0A%09ADM_libraries/ADM_utilities%20ADM_ocr%0A%09ADM_userInterfaces/ADM_GTK/ADM_dialog%0A%09ADM_userInterfaces/ADM_GTK/ADM_ocr%0A%09ADM_userInterfaces/ADM_NONE/ADM_dialog%0A%09ADM_userInterfaces/ADM_QT4/ADM_dialog%0A%09ADM_userInterfaces/ADM_commonUI&In-Reply-To=%3C200707141828.l6EISST6031126%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000645.html">
   <LINK REL="Next"  HREF="000647.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r3369 - in	branches/avidemux_2.4_branch/avidemux: .	ADM_libraries/ADM_utilities ADM_ocr	ADM_userInterfaces/ADM_GTK/ADM_dialog	ADM_userInterfaces/ADM_GTK/ADM_ocr	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_commonUI</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3369%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%20.%0A%09ADM_libraries/ADM_utilities%20ADM_ocr%0A%09ADM_userInterfaces/ADM_GTK/ADM_dialog%0A%09ADM_userInterfaces/ADM_GTK/ADM_ocr%0A%09ADM_userInterfaces/ADM_NONE/ADM_dialog%0A%09ADM_userInterfaces/ADM_QT4/ADM_dialog%0A%09ADM_userInterfaces/ADM_commonUI&In-Reply-To=%3C200707141828.l6EISST6031126%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r3369 - in	branches/avidemux_2.4_branch/avidemux: .	ADM_libraries/ADM_utilities ADM_ocr	ADM_userInterfaces/ADM_GTK/ADM_dialog	ADM_userInterfaces/ADM_GTK/ADM_ocr	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_commonUI">mean at mail.berlios.de
       </A><BR>
    <I>Sat Jul 14 20:28:28 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000645.html">[Avidemux-svn-commit] r3368 - in	branches/avidemux_2.4_branch/avidemux: .	ADM_userInterfaces/ADM_GTK/ADM_dialog	ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui ADM_userInterfaces/ADM_commonUI
</A></li>
        <LI>Next message: <A HREF="000647.html">[Avidemux-svn-commit] r3370 -	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#646">[ date ]</a>
              <a href="thread.html#646">[ thread ]</a>
              <a href="subject.html#646">[ subject ]</a>
              <a href="author.html#646">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2007-07-14 20:28:27 +0200 (Sat, 14 Jul 2007)
New Revision: 3369

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_ocr.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/prefs.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_ocr/ADM_ocr.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_ocr/ADM_ocr.h
   branches/avidemux_2.4_branch/avidemux/ADM_ocr/adm_glyph.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_ocr.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_ocr/adm_ocr.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp
   branches/avidemux_2.4_branch/avidemux/CMakeLists.txt
   branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
   branches/avidemux_2.4_branch/avidemux/prefs.h
   branches/avidemux_2.4_branch/avidemux/prefs.in
Log:
[OCR] Global glyphset file, part 1

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/prefs.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/prefs.cpp	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_utilities/prefs.cpp	2007-07-14 18:28:27 UTC (rev 3369)
@@ -135,12 +135,14 @@
 	{&quot;filters.autoload.path&quot;,		STRING,&quot;/tmp/&quot;,NULL, NULL, NULL },
 	{&quot;filters.autoload.active&quot;,		UINT,	&quot;0&quot;,	NULL,	&quot;0&quot;,	&quot;1&quot;	},
 	{&quot;feature.alternate_mp3_tag&quot;,		UINT,	&quot;1&quot;,	NULL,	&quot;0&quot;,	&quot;1&quot;	},
+	{&quot;feature.global_glyph&quot;,		UINT,	&quot;1&quot;,	NULL,	&quot;0&quot;,	&quot;1&quot;	},
+	{&quot;feature.global_glyph.name&quot;,		STRING,&quot;&quot;,	NULL, NULL, NULL },
 	{&quot;priority.encoding&quot;,		UINT,	&quot;3&quot;,	NULL,	&quot;0&quot;,	&quot;4&quot;	},
 	{&quot;priority.indexing&quot;,		UINT,	&quot;3&quot;,	NULL,	&quot;0&quot;,	&quot;4&quot;	},
 	{&quot;priority.playback&quot;,		UINT,	&quot;0&quot;,	NULL,	&quot;0&quot;,	&quot;4&quot;	}
 };
 
-int num_opts = 76;
+int num_opts = 78;
 // &lt;/prefs_gen&gt;
 
 #ifdef USE_LIBXML2

Modified: branches/avidemux_2.4_branch/avidemux/ADM_ocr/ADM_ocr.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_ocr/ADM_ocr.cpp	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/ADM_ocr/ADM_ocr.cpp	2007-07-14 18:28:27 UTC (rev 3369)
@@ -23,7 +23,7 @@
 static uint32_t minThreshold=0x80;
 
 /* In the UI related code */
-extern ReplyType glyphToText(admGlyph *glyph);
+//extern ReplyType glyphToText(admGlyph *glyph);
 extern void UI_purge(void);
 
 extern uint8_t adm_estimate_glyphSize(admGlyph *glyph,uint32_t *minx, uint32_t *maxx,uint32_t *miny,uint32_t *maxy,int *raw);
@@ -75,7 +75,7 @@
       @param h height of bitmap
       @param decodedString Will contain ocr'ed text
 */
-ReplyType ocrBitmap(uint8_t *workArea,uint32_t w,uint32_t h,char *decodedString)
+ReplyType ocrBitmap(uint8_t *workArea,uint32_t w,uint32_t h,char *decodedString,admGlyph *head)
 {
 uint8_t found;
 uint32_t colstart=0,colend=0,oldcol;
@@ -130,7 +130,7 @@
          
          
             // printf(&quot;Found glyph: %lu %lu\n&quot;,colstart,colend);  
-            reply=handleGlyph(workArea,colstart,colend,w,bottom,top);
+            reply=handleGlyph(workArea,colstart,colend,w,bottom,top,head);
             switch(reply)
                 {
                         case ReplySkip:break;
@@ -170,7 +170,7 @@
                 that case we use another method to extract the glyph.
                 We split it using leftturn method and do it again.
 */
-ReplyType handleGlyph(uint8_t *workArea,uint32_t start, uint32_t end,uint32_t w,uint32_t h,uint32_t base)
+ReplyType handleGlyph(uint8_t *workArea,uint32_t start, uint32_t end,uint32_t w,uint32_t h,uint32_t base,admGlyph *head)
 {
 uint8_t found=0;
 static int inc=1;
@@ -228,7 +228,7 @@
                 
                     if(lefty-&gt;width)
                     {
-                        reply=glyphToText(lefty);
+                        reply=glyphToText(lefty,head);
                         if(reply!=ReplyOk)
                         {
                             printf(&quot;Glyph2text failed(1)\n&quot;);
@@ -248,7 +248,7 @@
             if(raw) delete [] raw;
             if(glyph-&gt;width)
             {
-                reply=glyphToText(glyph);
+                reply=glyphToText(glyph,head);
                 if(reply!=ReplyOk)                 
                 {
                     printf(&quot;Glyph2text failed(2)\n&quot;);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_ocr/ADM_ocr.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_ocr/ADM_ocr.h	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/ADM_ocr/ADM_ocr.h	2007-07-14 18:28:27 UTC (rev 3369)
@@ -22,9 +22,13 @@
         ReplySkip=3,
         ReplySkipAll=4
 }ReplyType;
-
-ReplyType handleGlyph(uint8_t *workArea,uint32_t start, uint32_t end,uint32_t w,uint32_t h,uint32_t base);
-ReplyType ocrBitmap(uint8_t *data,uint32_t w,uint32_t h,char *decodedString);
+// GUI independant part
+ReplyType handleGlyph(uint8_t *workArea,uint32_t start, uint32_t end,uint32_t w,uint32_t h,uint32_t base,admGlyph *head);
+ReplyType ocrBitmap(uint8_t *workArea,uint32_t w,uint32_t h,char *decodedString,admGlyph *head);
 uint8_t   mergeBitmap(uint8_t *bitin, uint8_t *bitout, uint8_t *maskin,uint32_t w, uint32_t h);
 void ocrUpdateMinThreshold(void);
+
+// In GUI dependant part
+ReplyType glyphToText(admGlyph *glyph,admGlyph *head);
+
 #endif 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_ocr/adm_glyph.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_ocr/adm_glyph.cpp	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/ADM_ocr/adm_glyph.cpp	2007-07-14 18:28:27 UTC (rev 3369)
@@ -163,7 +163,7 @@
 {
   FILE *out;
   uint32_t slen;
-    
+  nb=0;
   admGlyph *glyph=head-&gt;next;
     
     
@@ -173,9 +173,18 @@
     GUI_Error_HIG(_(&quot;Could not write the file&quot;), NULL);
     return 0;
   }
+    
+    /* First count how many glyphs */
+     while(glyph)
+    {
+      glyph=glyph-&gt;next;
+      nb++;
+    }
+    
 #define WRITE(x) fwrite(&amp;(x),sizeof(x),1,out);
     WRITE(nb);
     
+    glyph=head-&gt;next;
     while(glyph)
     {
       WRITE(glyph-&gt;width);
@@ -187,7 +196,7 @@
       fwrite(glyph-&gt;code,slen,1,out);
       glyph=glyph-&gt;next;
     }
-    
+    printf(&quot;[Glyph] Saved %u glyphs\n&quot;,nb);
     fclose(out);
     return 1;
   
@@ -236,6 +245,7 @@
     
     fclose(out);
     *outNb=nbGlyphs;
+    printf(&quot;[Glyph] Loaded %u glyphs\n&quot;,nbGlyphs);
     return 1;
 
 }

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_ocr.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_ocr.cpp	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_ocr.cpp	2007-07-14 18:28:27 UTC (rev 3369)
@@ -1,45 +1,31 @@
-//
-// C++ Implementation: %{MODULE}
-//
-// Description:
-//
-//
-// Author: %{AUTHOR} &lt;%{EMAIL}&gt;, (C) %{YEAR}
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
+/*
+ * DO NOT EDIT THIS FILE - it is generated by Glade.
+ */
 
-#include &lt;config.h&gt;
+#ifdef HAVE_CONFIG_H
+#  include &lt;config.h&gt;
+#endif
 
+#include &lt;sys/types.h&gt;
+#include &lt;sys/stat.h&gt;
+#include &lt;unistd.h&gt;
+#include &lt;string.h&gt;
 #include &lt;stdio.h&gt;
-#include &lt;math.h&gt;
 
 #include &lt;gdk/gdkkeysyms.h&gt;
 #include &lt;gtk/gtk.h&gt;
 
-#include &lt;gtk/gtk.h&gt;
-
-#include &quot;default.h&quot;
 #include &quot;ADM_toolkit_gtk/ADM_gladeSupport.h&quot;
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
 #include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
 #include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
-#include &quot;ADM_assert.h&quot; 
- GtkWidget	*DIA_ocr(void);
 
-GtkWidget *DIA_ocr (void)
+
+GtkWidget*
+DIA_ocr (void)
 {
   GtkWidget *dialog1;
   GtkWidget *dialog_vbox1;
   GtkWidget *vbox1;
-  GtkWidget *hbox1;
-  GtkWidget *vbox5;
-  GtkWidget *frameGlyph;
-  GtkWidget *vbox6;
-  GtkWidget *buttonGlyphLoad;
-  GtkWidget *buttonGlyphSave;
-  GtkWidget *label6;
   GtkWidget *frame5;
   GtkWidget *table1;
   GtkWidget *label8;
@@ -47,20 +33,6 @@
   GtkWidget *labelNbGlyphs;
   GtkWidget *labelNbLines;
   GtkWidget *label7;
-  GtkWidget *frameLoad;
-  GtkWidget *vbox2;
-  GtkWidget *frame2;
-  GtkWidget *vbox3;
-  GtkWidget *labelVobsub;
-  GtkWidget *buttonVobsub;
-  GtkWidget *label2;
-  GtkWidget *frame3;
-  GtkWidget *vbox4;
-  GtkWidget *labelSrt;
-  GtkWidget *buttonSrt;
-  GtkWidget *label4;
-  GtkWidget *label1;
-  GtkWidget *buttonStart;
   GtkWidget *frameBitmap;
   GtkWidget *vbox7;
   GtkWidget *drawingareaBitmap;
@@ -83,6 +55,7 @@
 
   dialog1 = gtk_dialog_new ();
   gtk_window_set_title (GTK_WINDOW (dialog1), _(&quot;Mini OCR&quot;));
+  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
 
   dialog_vbox1 = GTK_DIALOG (dialog1)-&gt;vbox;
   gtk_widget_show (dialog_vbox1);
@@ -91,39 +64,9 @@
   gtk_widget_show (vbox1);
   gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
 
-  hbox1 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox1);
-  gtk_box_pack_start (GTK_BOX (vbox1), hbox1, TRUE, TRUE, 0);
-
-  vbox5 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox5);
-  gtk_box_pack_start (GTK_BOX (hbox1), vbox5, TRUE, TRUE, 0);
-
-  frameGlyph = gtk_frame_new (NULL);
-  gtk_widget_show (frameGlyph);
-  gtk_box_pack_start (GTK_BOX (vbox5), frameGlyph, FALSE, FALSE, 0);
-
-  vbox6 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox6);
-  gtk_container_add (GTK_CONTAINER (frameGlyph), vbox6);
-
-  buttonGlyphLoad = gtk_button_new_from_stock (&quot;gtk-open&quot;);
-  gtk_widget_show (buttonGlyphLoad);
-  gtk_box_pack_start (GTK_BOX (vbox6), buttonGlyphLoad, FALSE, FALSE, 0);
-
-  buttonGlyphSave = gtk_button_new_from_stock (&quot;gtk-save&quot;);
-  gtk_widget_show (buttonGlyphSave);
-  gtk_box_pack_start (GTK_BOX (vbox6), buttonGlyphSave, FALSE, FALSE, 0);
-
-  label6 = gtk_label_new (_(&quot;&lt;b&gt;Glyphs&lt;/b&gt;&quot;));
-  gtk_widget_show (label6);
-  gtk_frame_set_label_widget (GTK_FRAME (frameGlyph), label6);
-  gtk_label_set_use_markup (GTK_LABEL (label6), TRUE);
-  gtk_label_set_justify (GTK_LABEL (label6), GTK_JUSTIFY_LEFT);
-
   frame5 = gtk_frame_new (NULL);
   gtk_widget_show (frame5);
-  gtk_box_pack_start (GTK_BOX (vbox5), frame5, FALSE, FALSE, 0);
+  gtk_box_pack_start (GTK_BOX (vbox1), frame5, FALSE, FALSE, 0);
 
   table1 = gtk_table_new (2, 2, FALSE);
   gtk_widget_show (table1);
@@ -134,7 +77,6 @@
   gtk_table_attach (GTK_TABLE (table1), label8, 0, 1, 0, 1,
                     (GtkAttachOptions) (0),
                     (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (label8), GTK_JUSTIFY_LEFT);
   gtk_misc_set_alignment (GTK_MISC (label8), 0, 0.5);
 
   label9 = gtk_label_new (_(&quot;# of lines&quot;));
@@ -142,7 +84,6 @@
   gtk_table_attach (GTK_TABLE (table1), label9, 0, 1, 1, 2,
                     (GtkAttachOptions) (0),
                     (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (label9), GTK_JUSTIFY_LEFT);
   gtk_misc_set_alignment (GTK_MISC (label9), 0, 0.5);
 
   labelNbGlyphs = gtk_label_new (_(&quot;0&quot;));
@@ -150,7 +91,6 @@
   gtk_table_attach (GTK_TABLE (table1), labelNbGlyphs, 1, 2, 0, 1,
                     (GtkAttachOptions) (0),
                     (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (labelNbGlyphs), GTK_JUSTIFY_LEFT);
   gtk_misc_set_alignment (GTK_MISC (labelNbGlyphs), 0, 0.5);
 
   labelNbLines = gtk_label_new (_(&quot;0&quot;));
@@ -158,77 +98,13 @@
   gtk_table_attach (GTK_TABLE (table1), labelNbLines, 1, 2, 1, 2,
                     (GtkAttachOptions) (0),
                     (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (labelNbLines), GTK_JUSTIFY_LEFT);
   gtk_misc_set_alignment (GTK_MISC (labelNbLines), 0, 0.5);
 
   label7 = gtk_label_new (_(&quot;&lt;b&gt;Stats&lt;/b&gt;&quot;));
   gtk_widget_show (label7);
   gtk_frame_set_label_widget (GTK_FRAME (frame5), label7);
   gtk_label_set_use_markup (GTK_LABEL (label7), TRUE);
-  gtk_label_set_justify (GTK_LABEL (label7), GTK_JUSTIFY_LEFT);
 
-  frameLoad = gtk_frame_new (NULL);
-  gtk_widget_show (frameLoad);
-  gtk_box_pack_start (GTK_BOX (hbox1), frameLoad, TRUE, TRUE, 0);
-
-  vbox2 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox2);
-  gtk_container_add (GTK_CONTAINER (frameLoad), vbox2);
-
-  frame2 = gtk_frame_new (NULL);
-  gtk_widget_show (frame2);
-  gtk_box_pack_start (GTK_BOX (vbox2), frame2, FALSE, FALSE, 0);
-
-  vbox3 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox3);
-  gtk_container_add (GTK_CONTAINER (frame2), vbox3);
-
-  labelVobsub = gtk_label_new (_(&quot;  &quot;));
-  gtk_widget_show (labelVobsub);
-  gtk_box_pack_start (GTK_BOX (vbox3), labelVobsub, FALSE, FALSE, 0);
-  gtk_label_set_justify (GTK_LABEL (labelVobsub), GTK_JUSTIFY_LEFT);
-
-  buttonVobsub = gtk_button_new_from_stock (&quot;gtk-open&quot;);
-  gtk_widget_show (buttonVobsub);
-  gtk_box_pack_start (GTK_BOX (vbox3), buttonVobsub, FALSE, FALSE, 0);
-
-  label2 = gtk_label_new (_(&quot;VobSub&quot;));
-  gtk_widget_show (label2);
-  gtk_frame_set_label_widget (GTK_FRAME (frame2), label2);
-  gtk_label_set_justify (GTK_LABEL (label2), GTK_JUSTIFY_LEFT);
-
-  frame3 = gtk_frame_new (NULL);
-  gtk_widget_show (frame3);
-  gtk_box_pack_start (GTK_BOX (vbox2), frame3, FALSE, FALSE, 0);
-
-  vbox4 = gtk_vbox_new (FALSE, 0);
-  gtk_widget_show (vbox4);
-  gtk_container_add (GTK_CONTAINER (frame3), vbox4);
-
-  labelSrt = gtk_label_new (_(&quot; &quot;));
-  gtk_widget_show (labelSrt);
-  gtk_box_pack_start (GTK_BOX (vbox4), labelSrt, FALSE, FALSE, 0);
-  gtk_label_set_justify (GTK_LABEL (labelSrt), GTK_JUSTIFY_LEFT);
-
-  buttonSrt = gtk_button_new_from_stock (&quot;gtk-save&quot;);
-  gtk_widget_show (buttonSrt);
-  gtk_box_pack_start (GTK_BOX (vbox4), buttonSrt, FALSE, FALSE, 0);
-
-  label4 = gtk_label_new (_(&quot;Output Srt&quot;));
-  gtk_widget_show (label4);
-  gtk_frame_set_label_widget (GTK_FRAME (frame3), label4);
-  gtk_label_set_justify (GTK_LABEL (label4), GTK_JUSTIFY_LEFT);
-
-  label1 = gtk_label_new (_(&quot;&lt;b&gt;Files&lt;/b&gt;&quot;));
-  gtk_widget_show (label1);
-  gtk_frame_set_label_widget (GTK_FRAME (frameLoad), label1);
-  gtk_label_set_use_markup (GTK_LABEL (label1), TRUE);
-  gtk_label_set_justify (GTK_LABEL (label1), GTK_JUSTIFY_LEFT);
-
-  buttonStart = gtk_button_new_with_mnemonic (_(&quot;StartOcr&quot;));
-  gtk_widget_show (buttonStart);
-  gtk_box_pack_start (GTK_BOX (vbox1), buttonStart, FALSE, FALSE, 0);
-
   frameBitmap = gtk_frame_new (NULL);
   gtk_widget_show (frameBitmap);
   gtk_box_pack_start (GTK_BOX (vbox1), frameBitmap, FALSE, FALSE, 0);
@@ -251,7 +127,6 @@
   gtk_table_attach (GTK_TABLE (table2), label13, 0, 1, 0, 1,
                     (GtkAttachOptions) (GTK_FILL),
                     (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (label13), GTK_JUSTIFY_LEFT);
   gtk_misc_set_alignment (GTK_MISC (label13), 0, 0.5);
 
   drawingareaSmall = gtk_drawing_area_new ();
@@ -265,7 +140,6 @@
   gtk_table_attach (GTK_TABLE (table2), label14, 1, 2, 0, 1,
                     (GtkAttachOptions) (GTK_FILL),
                     (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (label14), GTK_JUSTIFY_LEFT);
   gtk_misc_set_alignment (GTK_MISC (label14), 0, 0.5);
 
   labelText = gtk_label_new (_(&quot; &quot;));
@@ -273,7 +147,6 @@
   gtk_table_attach (GTK_TABLE (table2), labelText, 1, 2, 1, 2,
                     (GtkAttachOptions) (GTK_FILL),
                     (GtkAttachOptions) (0), 0, 0);
-  gtk_label_set_justify (GTK_LABEL (labelText), GTK_JUSTIFY_LEFT);
   gtk_misc_set_alignment (GTK_MISC (labelText), 0, 0.5);
 
   entry = gtk_entry_new ();
@@ -317,7 +190,6 @@
   gtk_widget_show (label12);
   gtk_frame_set_label_widget (GTK_FRAME (frameBitmap), label12);
   gtk_label_set_use_markup (GTK_LABEL (label12), TRUE);
-  gtk_label_set_justify (GTK_LABEL (label12), GTK_JUSTIFY_LEFT);
 
   dialog_action_area1 = GTK_DIALOG (dialog1)-&gt;action_area;
   gtk_widget_show (dialog_action_area1);
@@ -332,13 +204,6 @@
   GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, &quot;dialog1&quot;);
   GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, &quot;dialog_vbox1&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, vbox1, &quot;vbox1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hbox1, &quot;hbox1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, vbox5, &quot;vbox5&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, frameGlyph, &quot;frameGlyph&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, vbox6, &quot;vbox6&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, buttonGlyphLoad, &quot;buttonGlyphLoad&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, buttonGlyphSave, &quot;buttonGlyphSave&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label6, &quot;label6&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, frame5, &quot;frame5&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, table1, &quot;table1&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, label8, &quot;label8&quot;);
@@ -346,20 +211,6 @@
   GLADE_HOOKUP_OBJECT (dialog1, labelNbGlyphs, &quot;labelNbGlyphs&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, labelNbLines, &quot;labelNbLines&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, label7, &quot;label7&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, frameLoad, &quot;frameLoad&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, vbox2, &quot;vbox2&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, frame2, &quot;frame2&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, vbox3, &quot;vbox3&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, labelVobsub, &quot;labelVobsub&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, buttonVobsub, &quot;buttonVobsub&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label2, &quot;label2&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, frame3, &quot;frame3&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, vbox4, &quot;vbox4&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, labelSrt, &quot;labelSrt&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, buttonSrt, &quot;buttonSrt&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label4, &quot;label4&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label1, &quot;label1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, buttonStart, &quot;buttonStart&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, frameBitmap, &quot;frameBitmap&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, vbox7, &quot;vbox7&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, drawingareaBitmap, &quot;drawingareaBitmap&quot;);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_ocr/adm_ocr.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_ocr/adm_ocr.cpp	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_ocr/adm_ocr.cpp	2007-07-14 18:28:27 UTC (rev 3369)
@@ -73,12 +73,6 @@
 #define TESTSUB &quot;/home/fx/usbstick/subs/vts_01_0.idx&quot;
 #define CONNECT(x,y,z) 	gtk_signal_connect(GTK_OBJECT(WID(x)), #y,GTK_SIGNAL_FUNC(z),   NULL);
 
-
-
-
-
-
-
 extern  uint8_t DIA_vobsub(vobSubParam *param);
 //********************************************
 extern  GtkWidget *DIA_ocr(void);
@@ -87,20 +81,19 @@
 static void       displaySmall( admGlyph *glyph );
 static int        cb_accept(GtkObject * object, gpointer user_data);
 
-static GtkWidget *dialog;
-static GtkWidget *mainDisplay;
-static GtkWidget *smallDisplay;
+static GtkWidget *dialog=NULL;
+static GtkWidget *mainDisplay=NULL;
+static GtkWidget *smallDisplay=NULL;
 static uint32_t redraw_x,redraw_y;
 //********************************************
-ReplyType glyphToText(admGlyph *glyph);
+//ReplyType glyphToText(admGlyph *glyph,admGlyph *head);
 static ReplyType setup(void);
 //********************************************
-static uint8_t ocrSaveGlyph(void);
-static  vobSubParam subparam={NULL,0,0};
+static uint8_t ocrSaveGlyph(admGlyph *head);
+
 static uint8_t *workArea;
 static vobSubBitmap *bitmap;
-static admGlyph head(250,4);
-static uint32_t lang_index=0;
+static uint8_t *sdata=NULL;
 static uint32_t nbGlyphs;
 static char decodedString[1024];
 
@@ -120,12 +113,12 @@
 /* +++++++++++++++++++++++++++++++++++++++++++++++++++++++
         Main
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
-uint8_t ADM_ocr_engine( void)
+   
+uint8_t ADM_ocr_engine(  vobSubParam *subparam,const char *labelSrt,admGlyph *head)
 {
 // 
     uint32_t nbSub=0;
     FILE *out=NULL;
-    head.next=NULL;
     ADMVideoVobSub *vobsub=NULL;
     uint32_t startTime,endTime;
     uint32_t w,h,oldw=0,oldh=0;
@@ -134,27 +127,30 @@
     uint32_t first,last;
     uint32_t seqNum;
     char     text[1024];
-    lang_index=0;
     nbGlyphs=0;
     ReplyType reply;
     
+    dialog=NULL;
+    mainDisplay=NULL;
+    smallDisplay=NULL;
+    workArea=NULL;
+    bitmap=NULL;
+    sdata=NULL;
+    
+
+    
 // Create UI &amp;&amp; prepare callback
     
     dialog=DIA_ocr();
     gtk_register_dialog(dialog);
 #define ASSOCIATE(x,y)   gtk_dialog_add_action_widget (GTK_DIALOG (dialog), WID(x),y)
-    ASSOCIATE(buttonStart,actionGo);
+    
     ASSOCIATE(buttonOk,   actionAccept);
     ASSOCIATE(buttonSkip,     actionSkip);
     ASSOCIATE(buttonSkipAll,     actionSkipAll);
     ASSOCIATE(buttonIgnore,   actionIgnore);
     ASSOCIATE(buttonCalibrate,   actionCalibrate);
     
-    ASSOCIATE(buttonGlyphLoad,   actionLoadGlyph);
-    ASSOCIATE(buttonGlyphSave,   actionSaveGlyph);
-    
-    ASSOCIATE(buttonVobsub,   actionLoadVob);
-    ASSOCIATE(buttonSrt,   actionSaveSub);
    
     gtk_widget_show(dialog);
 //  disable
@@ -167,8 +163,6 @@
 
     CONNECT(entry,activate,cb_accept);
 _again:    
-    reply=setup();
-    if(reply==ReplyClose) goto endIt;
     
     printf(&quot;Go go go\n&quot;);
     
@@ -177,30 +171,17 @@
     redraw_x=redraw_y=0;
     UI_purge();
 //  Time to go
-    // Inactivate frame1=glyph    frame2=in/out  buttonStart
-    gtk_widget_set_sensitive(WID(buttonStart),0);
-    gtk_widget_set_sensitive(WID(frameGlyph),0);
-    gtk_widget_set_sensitive(WID(frameLoad),0);
+    
     gtk_widget_set_sensitive(WID(frameBitmap),1);
-
-    gtk_widget_set_sensitive(WID(buttonStart),0);
-   
-  
-   char *fileout;
-   fileout=(char *)gtk_label_get_text(GTK_LABEL(WID(labelSrt)));
-   if(!fileout)
-    {
-      GUI_Error_HIG(_(&quot;Incorrect output file&quot;), NULL);
-        goto _again;
-    }
-    out=fopen(fileout,&quot;wb&quot;);
+ 
+    out=fopen(labelSrt,&quot;wb&quot;);
     if(!out)
     {
-      GUI_Error_HIG(_(&quot;Output file error&quot;), _(&quot;Could not open \&quot;%s\&quot; for writing.&quot;), fileout);
-        goto _again;
+       GUI_Error_HIG(_(&quot;Output file error&quot;), _(&quot;Could not open \&quot;%s\&quot; for writing.&quot;), labelSrt);
+       goto endIt;
     }
      
-    vobsub=new ADMVideoVobSub(subparam.subname,subparam.index);
+    vobsub=new ADMVideoVobSub(subparam-&gt;subname,subparam-&gt;index);
     nbSub=vobsub-&gt;getNbImage();
    
     if(!nbSub)
@@ -259,7 +240,7 @@
              gui_draw();
              UI_purge();
              // OCR
-              reply=ocrBitmap(workArea,w,h,decodedString);
+              reply=ocrBitmap(workArea,w,h,decodedString,head);
               if(reply==ReplyClose) goto endIt;
               if(reply==ReplyCalibrate)
                 {
@@ -290,16 +271,8 @@
 
 endIt:
     // Final round
-    gtk_widget_set_sensitive(WID(frameGlyph),1);
-    gtk_widget_set_sensitive(WID(frameLoad),0);
-    gtk_widget_set_sensitive(WID(buttonStart),0);  
     gtk_widget_set_sensitive(WID(frameBitmap),0);
-   // gtk_widget_set_sensitive(WID(Current_Glyph),0); 
-    
-    if(nbGlyphs &amp;&amp; actionSaveGlyph==gtk_dialog_run(GTK_DIALOG(dialog)))
-    {
-      ocrSaveGlyph();
-    }
+   // gtk_widget_set_sensitive(WID(Current_Glyph),0);     
     if(vobsub)
         delete vobsub;
     vobsub=NULL;
@@ -308,9 +281,7 @@
     out=NULL;
     gtk_unregister_dialog(dialog);
     gtk_widget_destroy(dialog);
-    if(head.next)
-        destroyGlyphTree(&amp;head);
-    head.next=NULL;
+
     return 1;
 
 }
@@ -318,13 +289,13 @@
     \fn ocrSaveGlyph
     \brief bridge to saveGlyph
 */
-uint8_t ocrSaveGlyph(void)
+uint8_t ocrSaveGlyph(admGlyph *head)
 {
   char *name=NULL;
           GUI_FileSelWrite(_(&quot;Select Glyphfile to save to&quot;), &amp;name);
         if(!name)
             return 0;
-        saveGlyph(name,&amp;head,nbGlyphs);
+        saveGlyph(name,head,nbGlyphs);
         ADM_dealloc(name);
         return 1;
 
@@ -334,7 +305,7 @@
         Search throught the existing glyphs , if not present create it
         and append the text to decodedString
 */
-ReplyType glyphToText(admGlyph *glyph)
+ReplyType glyphToText(admGlyph *glyph,admGlyph *head)
 {
  admGlyph *cand;
             //printf(&quot;2t: %d x %d\n&quot;,glyph-&gt;width,glyph-&gt;height);
@@ -343,7 +314,7 @@
                 delete glyph;
                 return ReplyOk;
             }
-            cand=searchGlyph(&amp;head,glyph);
+            cand=searchGlyph(head,glyph);
             if(!cand) // New glyph
             {
                 char *string;
@@ -364,7 +335,7 @@
                 {
                 case actionIgnore:
                         glyph-&gt;code=NULL;
-                        insertInGlyphTree(&amp;head,glyph);
+                        insertInGlyphTree(head,glyph);
                         nbGlyphs++;
                         break;
                 case actionCalibrate: return ReplyCalibrate;
@@ -373,7 +344,7 @@
                     if(string&amp;&amp; strlen(string))
                     {
                         glyph-&gt;code=ADM_strdup(string);
-                        insertInGlyphTree(&amp;head,glyph);
+                        insertInGlyphTree(head,glyph);
                         //printf(&quot;New glyph:%s\n&quot;,glyph-&gt;code);
                         strcat(decodedString,glyph-&gt;code);
                         nbGlyphs++;
@@ -429,7 +400,7 @@
 }
 //*****************************************************************************************
  static int sx=0,sy=0,sw=0,sh=0;
- uint8_t *sdata=NULL;
+
 void displaySmall( admGlyph *glyph)
 {
     if(sw!=glyph-&gt;width || sh!=glyph-&gt;height)
@@ -479,88 +450,7 @@
     return true;
 }
 
-/******************************************************************************************
- Setup (input/output files etc..)
-*****************************************************************************************/
-ReplyType setup(void)
-{
-int sel;
-char text[1024];
-    while(1)
-    {
-    //gtk_widget_set_sensitive(WID(buttonAccept),0);
-    //gtk_widget_set_sensitive(WID(buttonSkip),0);
-    //gtk_widget_set_sensitive(WID(entryEntry),0);
-    UI_purge();
-    // Main loop : Only accept glyph load/save
-    // Sub &amp; srt select &amp; start ocr
-    gtk_widget_set_sensitive(WID(frameGlyph),1);
-    gtk_widget_set_sensitive(WID(frameLoad),1);
-    gtk_widget_set_sensitive(WID(buttonStart),1);
-    
-    gtk_widget_set_sensitive(WID(frameBitmap),0);
-    //gtk_widget_set_sensitive(WID(Current_Glyph),0); 
-     switch(sel=gtk_dialog_run(GTK_DIALOG(dialog)))
-     {
-        case actionLoadVob:
-                {
-                   
-                        subparam.index=lang_index;
-                        subparam.subname=NULL;
-                        if(DIA_vobsub(&amp;subparam))
-                        {
-                            lang_index=subparam.index;
-                            gtk_label_set_text(GTK_LABEL(WID(labelVobsub)),subparam.subname);
-                        }
-                        
-                    
-                }
-                break;
-        case actionSaveSub:
-                {
-                    char *srt=NULL;
-                    GUI_FileSelWrite(_(&quot;Select SRT to save&quot;), &amp;srt);
-                    if(srt)
-                    {
-                        gtk_label_set_text(GTK_LABEL(WID(labelSrt)),srt);
-                    }
-                }
-                break;
-        
-        case actionLoadGlyph:
-            {
-                 char *gly=NULL;
-                    
-                    GUI_FileSelRead(_(&quot;Select Glyoh to save&quot;), &amp;gly);
-                    if(gly)
-                    {
-                            loadGlyph(gly,&amp;head,&amp;nbGlyphs);
-                            sprintf(text,&quot;%03d&quot;,nbGlyphs);
-                            gtk_label_set_text(GTK_LABEL(WID(labelNbGlyphs)),text);
-                    }
-            }
-                break;
-        
-        case actionSaveGlyph:
-            
-                    if(!nbGlyphs)
-                    {
-                      GUI_Error_HIG(_(&quot;No glyphs to save&quot;), NULL);
-                        break;
-                    }                  
-                    ocrSaveGlyph();
-                        break;
-        
-        case GTK_RESPONSE_CLOSE: 
-            printf(&quot;Close req\n&quot;);
-            return ReplyClose;
-        default:
-            printf(&quot;Other input:%d\n&quot;,sel);
-     }
-    // Everything selected, check
-    if(sel==actionGo) return ReplyOk;
-    }
-}
+
 /**
     \fn cb_accept
     \brief Bridge between dialog/Accept and gtk signals

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2007-07-14 18:28:27 UTC (rev 3369)
@@ -159,4 +159,9 @@
     printf(&quot;*********************************\n&quot;);
 }
 uint8_t DIA_glyphEdit(void) {return 0;};
+#include &quot;ADM_ocr/adm_glyph.h&quot;
+uint8_t ADM_ocr_engine(  vobSubParam *subparam,const char *labelSrt,admGlyph *head)
+{
+  return 0; 
+}
 //EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-07-14 18:28:27 UTC (rev 3369)
@@ -103,5 +103,11 @@
 {
   return 0; 
 }
+#include &quot;ADM_ocr/adm_glyph.h&quot;
+uint8_t ADM_ocr_engine(  vobSubParam *subparam,const char *labelSrt,admGlyph *head)
+{
+  return 0; 
+}
+
 //EOF
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/CMakeLists.txt	2007-07-14 18:28:27 UTC (rev 3369)
@@ -9,11 +9,11 @@
 DIA_audioFilter.cpp   DIA_enter.cpp           DIA_flyCrop.cpp      DIA_gototime.cpp    DIA_postproc.cpp  DIA_srt.cpp        GUI_render.cpp
 DIA_bitrateHisto.cpp  DIA_flyAsharp.cpp       DIA_flyDialog.cpp    DIA_lavcodec.cpp    DIA_prefs.cpp     DIA_SVCD.cpp       GUI_sdlRender.cpp
 DIA_builtin.cpp       DIA_flyChromaShift.cpp  DIA_flyHue.cpp       DIA_lavDecoder.cpp  DIA_requant.cpp   DIA_tdeint.cpp     GUI_xvRender.cpp
-DIA_animated.cpp
+DIA_animated.cpp      DIA_ocr.cpp
 )
 ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})
 ADD_ADM_LIB(${ADM_LIB} ADM_userInterfaces)
 
 ####################################&quot;
-include_directories(./..)
+include_directories(./.. ./../../ADM_inputs)
 SDLify(GUI_sdlRender.cpp)

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_ocr.cpp (from rev 3352, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyAsharp.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyAsharp.cpp	2007-07-09 14:04:04 UTC (rev 3352)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_ocr.cpp	2007-07-14 18:28:27 UTC (rev 3369)
@@ -0,0 +1,178 @@
+/**/
+/***************************************************************************
+                          DIA_hue
+                             -------------------
+
+                           Ui for hue &amp; sat
+
+    begin                : 08 Apr 2005
+    copyright            : (C) 2004/5 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+
+
+#include &lt;config.h&gt;
+
+
+#include &lt;string.h&gt;
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;math.h&gt;
+
+#include &quot;default.h&quot;
+
+
+#include &quot;ADM_userInterfaces/ADM_commonUI/DIA_factory.h&quot;
+#include &quot;ADM_editor/ADM_edit.hxx&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+#include &quot;ADM_filter/video_filters.h&quot;
+
+#include &quot;ADM_video/ADM_vobsubinfo.h&quot;
+#include &quot;ADM_video/ADM_vidVobSub.h&quot;
+#include &quot;ADM_ocr/ADM_ocr.h&quot;
+#include &quot;ADM_osSupport/ADM_misc.h&quot;
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+#include &quot;prefs.h&quot;
+#include &quot;ADM_assert.h&quot;
+
+extern uint8_t DIA_vobsub(vobSubParam *param);
+extern uint8_t ADM_ocr_engine(  vobSubParam *subparam,const char *labelSrt,admGlyph *head);
+static void cb_idx(void *foo);
+static void cleanupSub(vobSubParam *p);
+/**
+    \fn DIA_ocrGen
+    \brief Dialog to select input &amp; output files before calling the actual ocr engine
+*/
+uint8_t DIA_ocrGen(void)
+{
+
+  vobSubParam subparam={NULL,0,0};
+  char *srtFileName=NULL;
+  char *glyphFileName=NULL;
+  admGlyph head(16,16);
+  char *globalGlyph=NULL;
+  uint32_t globalGlyphOn=0;
+  prefs-&gt;get(FEATURE_GLOBAL_GLYPH,&amp;globalGlyphOn);
+  if(globalGlyphOn)
+  {
+     prefs-&gt;get(FEATURE_GLOBAL_GLYPH_NAME,&amp;globalGlyph);
+     if(!*globalGlyph)
+     {
+        ADM_dezalloc(globalGlyph);
+        globalGlyph=NULL; 
+     }
+  }
+
+  if(globalGlyph)
+  {
+    glyphFileName=globalGlyph;
+  }
+_again:  
+  // Fist build a dialogFactory to get input and output files
+  diaElemButton   selectIdx(_(&quot;Select idx file:&quot;), cb_idx,&amp;subparam,NULL);
+  diaElemFile     selectGlyph(1,&amp;glyphFileName,_(&quot;Use glyphset (optional):&quot;),NULL);  
+  diaElemFile     selectSrt(1,&amp;srtFileName,_(&quot;Output SRT file&quot;),NULL);
+  
+  diaElem *elems[]={&amp;selectIdx,&amp;selectSrt,&amp;selectGlyph};
+  
+  
+   uint32_t n=3;
+   if(globalGlyph)
+   {
+     n--; // Remove glyph from dialog
+   }
+  
+        if( !diaFactoryRun(_(&quot;Select input and ouput files&quot;),n,elems))
+        {
+          cleanupSub(&amp;subparam);
+          if(srtFileName )ADM_dezalloc(srtFileName);
+          srtFileName=NULL;
+          destroyGlyphTree(&amp;head);
+          return 0;
+        }
+        if(!ADM_fileExist(subparam.subname))
+        {
+          GUI_Error_HIG(_(&quot;File error&quot;),_(&quot;The idx/sub file does not exist.&quot;));
+          goto _again; 
+        }
+        if(!srtFileName || !*srtFileName)
+        {
+          GUI_Error_HIG(_(&quot;File error&quot;),_(&quot;Please Select a valid output SRT file.&quot;));
+          goto _again; 
+        }
+         if(glyphFileName &amp;&amp; *glyphFileName)
+         {
+           if(!ADM_fileExist(glyphFileName))
+            {
+              GUI_Error_HIG(_(&quot;File error&quot;),_(&quot;The idx/sub file does not exist.&quot;));
+              goto _again; 
+            }
+            // Purge previous glyph set if any
+            destroyGlyphTree(&amp;head);
+            uint32_t nb;
+            printf(&quot;[OCR] Loading glyphset :&lt;%s&gt;\n&quot;,glyphFileName);
+            if(!loadGlyph(glyphFileName,&amp;head,&amp;nb))
+            {
+              GUI_Error_HIG(_(&quot;File error&quot;),_(&quot;Cannot load the glyphset file.&quot;));
+              goto _again;               
+            }
+            printf(&quot;[GLYPH] Found %u glyph\n&quot;);
+         }
+        // We have our SRT and our idx/sub files : Go go go
+        ADM_ocr_engine(&amp;subparam,srtFileName,&amp;head);
+        
+        // Save glyph set 
+_save:
+        if(globalGlyph)
+        {
+          uint32_t nb=1;
+           saveGlyph(globalGlyph,&amp;head,nb);
+        }else
+        {
+            char *save=NULL;
+            uint32_t nb=1;
+              diaElemFile     selectSave(1,&amp;save,_(&quot;Glyphset filename&quot;),NULL);
+              diaElem *elems2[]={&amp;selectSave};
+            if( diaFactoryRun(_(&quot;Save Glyph&quot;),1,elems2))
+            {
+              saveGlyph(save,&amp;head,nb);
+            }
+            if(save) ADM_dezalloc(save);
+        }
+cleanup:
+  cleanupSub(&amp;subparam);
+  if(srtFileName )ADM_dezalloc(srtFileName);
+  srtFileName=NULL;
+  destroyGlyphTree(&amp;head);
+  return 1;  
+}
+/**
+
+*/
+void cleanupSub(vobSubParam *p)
+{
+  if(p-&gt;subname) ADM_dezalloc(p-&gt;subname);
+  p-&gt;subname=NULL; 
+  
+}
+/**
+
+*/
+void cb_idx(void *foo)
+{
+   vobSubParam *bar=(vobSubParam *)foo;
+   
+    cleanupSub(bar);
+    DIA_vobsub(bar);
+}
+//EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_prefs.cpp	2007-07-14 18:28:27 UTC (rev 3369)
@@ -79,6 +79,10 @@
 uint32_t pp_type=3;
 uint32_t pp_value=5;
 uint32_t hzd,vzd,dring;
+
+uint32_t useGlobalGlyph=0;
+char     *globalGlyphName=NULL;
+
 	olddevice=newdevice=AVDM_getCurrentDevice();
 
         // Default pp
@@ -97,6 +101,9 @@
         prefs-&gt;get(FEATURE_AUTO_BUILDMAP,&amp;autovbr);
         // autoindex
         prefs-&gt;get(FEATURE_AUTO_REBUILDINDEX,&amp;autoindex);
+        // Global glyph
+        prefs-&gt;get(FEATURE_GLOBAL_GLYPH,&amp;useGlobalGlyph);
+        prefs-&gt;get(FEATURE_GLOBAL_GLYPH_NAME,&amp;globalGlyphName);
          // autoindex
         prefs-&gt;get(FEATURE_AUTO_UNPACK,&amp;autounpack);
         // Alternate mp3 tag (haali)
@@ -294,7 +301,13 @@
                filterPath = ADM_strdup(&quot;c:\\&quot;);
 #endif
         diaElemDirSelect  entryFilterPath(&amp;filterPath,_(&quot;_Filter directory:&quot;),&quot;&quot;);
-        
+        /*********************************/
+        diaMenuEntry globalGlyhEntries[]={
+                             {0,       _(&quot;No&quot;),NULL}
+                             ,{1,      _(&quot;Yes&quot;),NULL}};
+        diaElemMenu  menuGlobaGlyh(&amp;useGlobalGlyph,_(&quot;Use _Global GlyphSet:&quot;), sizeof(globalGlyhEntries)/sizeof(diaMenuEntry),globalGlyhEntries,&quot;&quot;);
+        diaElemFile  entryGLyphPath(0,&amp;globalGlyphName,_(&quot;Gl_yphSet:&quot;),&quot;&quot;);
+        menuGlobaGlyh.link(&amp;(globalGlyhEntries[1]),1,&amp;entryGLyphPath);
         /**********************************************************************/
         /* First Tab : user interface */
         diaElem *diaUser[]={&amp;useSysTray,&amp;menuMessage};
@@ -325,14 +338,23 @@
         diaElem *diaCpu[]={&amp;multiThread, &amp;menuEncodePriority, &amp;menuIndexPriority, &amp;menuPlaybackPriority};
         diaElemTabs tabCpu(&quot;CPU&quot;,4,(diaElem **)diaCpu);
         
-        /* seventh Tab : Xfilter */
+        /* 7th Tab : Global Glyph */
+        diaElem *diaGlyph[]={&amp;menuGlobaGlyh,&amp;entryGLyphPath};
+        diaElemTabs tabGlyph(_(&quot;Global Glyphset&quot;),2,(diaElem **)diaGlyph);
+        
+        
+        /* 8th Tab : Xfilter */
         diaElem *diaXFilter[]={&amp;loadEx,&amp;entryFilterPath};
         diaElemTabs tabXfilter(_(&quot;External Filters&quot;),2,(diaElem **)diaXFilter);
                                     
 // SET
-        diaElemTabs *tabs[]={&amp;tabUser,&amp;tabAuto,&amp;tabInput,&amp;tabOutput,&amp;tabAudio,&amp;tabVideo,&amp;tabCpu,&amp;tabXfilter};
-        if( diaFactoryRunTabs(_(&quot;Preferences&quot;),8,tabs))
+        diaElemTabs *tabs[]={&amp;tabUser,&amp;tabAuto,&amp;tabInput,&amp;tabOutput,&amp;tabAudio,&amp;tabVideo,&amp;tabCpu,&amp;tabGlyph,&amp;tabXfilter};
+        if( diaFactoryRunTabs(_(&quot;Preferences&quot;),9,tabs))
 	{
+               prefs-&gt;set(FEATURE_GLOBAL_GLYPH,useGlobalGlyph);
+                prefs-&gt;set(FEATURE_GLOBAL_GLYPH_NAME,globalGlyphName);
+
+          
 		ret=1;
                 // Postproc
                 #undef DOME

Modified: branches/avidemux_2.4_branch/avidemux/CMakeLists.txt
===================================================================
--- branches/avidemux_2.4_branch/avidemux/CMakeLists.txt	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/CMakeLists.txt	2007-07-14 18:28:27 UTC (rev 3369)
@@ -202,15 +202,16 @@
 
 
 TARGET_LINK_LIBRARIES(avidemux2_cli ADM_commonUI )
+TARGET_LINK_LIBRARIES(avidemux2_cli ADM_ocr )
 TARGET_LINK_LIBRARIES(avidemux2_cli ADM_dialogNone )
 TARGET_LINK_LIBRARIES(avidemux2_cli ADM_dialogFactoryNone )
 TARGET_LINK_LIBRARIES(avidemux2_cli ADM_dialogFiltersNone )
 TARGET_LINK_LIBRARIES(avidemux2_cli ADM_dialogGuiNone )
 
 if(GTK_FOUND)
+TARGET_LINK_LIBRARIES(avidemux2_gtk ADM_commonUI )
 TARGET_LINK_LIBRARIES(avidemux2_gtk ADM_ocrGtk )
 TARGET_LINK_LIBRARIES(avidemux2_gtk ADM_ocr )
-TARGET_LINK_LIBRARIES(avidemux2_gtk ADM_commonUI )
 TARGET_LINK_LIBRARIES(avidemux2_gtk ADM_dialogGtk )
 TARGET_LINK_LIBRARIES(avidemux2_gtk ADM_filtersGtk )
 TARGET_LINK_LIBRARIES(avidemux2_gtk ADM_dialogFactoryGtk )
@@ -220,8 +221,8 @@
 endif(GTK_FOUND)
 
 if(QT4_FOUND)
+TARGET_LINK_LIBRARIES(avidemux2_qt4 ADM_commonUI )
 TARGET_LINK_LIBRARIES(avidemux2_qt4 ADM_ocr )
-TARGET_LINK_LIBRARIES(avidemux2_qt4 ADM_commonUI )
 TARGET_LINK_LIBRARIES(avidemux2_qt4 ADM_dialogQt4 )
 
 TARGET_LINK_LIBRARIES(avidemux2_qt4 ADM_dialogFactoryQt4 )

Modified: branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2007-07-14 18:28:27 UTC (rev 3369)
@@ -151,6 +151,7 @@
 int ignore_change;
 
 extern uint8_t ADM_ocr_engine( void);
+extern uint8_t DIA_ocrGen(void);
 uint8_t A_TimeShift(void);
 PARAM_MUX muxMode = MUX_REGULAR;
 int muxParam = 0;
@@ -229,7 +230,8 @@
         case ACT_ViewMain: UI_toogleMain();return;
         case ACT_ViewSide: UI_toogleSide();return;
       case ACT_Ocr:
-                ADM_ocr_engine( );
+                DIA_ocrGen(); //
+                //ADM_ocr_engine( );
                 return;
       case ACT_AudioConfigure:
     		audioCodecSelect();

Modified: branches/avidemux_2.4_branch/avidemux/prefs.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/prefs.h	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/prefs.h	2007-07-14 18:28:27 UTC (rev 3369)
@@ -81,6 +81,8 @@
 	FILTERS_AUTOLOAD_PATH,
 	FILTERS_AUTOLOAD_ACTIVE,
 	FEATURE_ALTERNATE_MP3_TAG,
+	FEATURE_GLOBAL_GLYPH,
+	FEATURE_GLOBAL_GLYPH_NAME,
 	PRIORITY_ENCODING,
 	PRIORITY_INDEXING,
 	PRIORITY_PLAYBACK

Modified: branches/avidemux_2.4_branch/avidemux/prefs.in
===================================================================
--- branches/avidemux_2.4_branch/avidemux/prefs.in	2007-07-14 17:33:40 UTC (rev 3368)
+++ branches/avidemux_2.4_branch/avidemux/prefs.in	2007-07-14 18:28:27 UTC (rev 3369)
@@ -91,6 +91,9 @@
 filters.autoload.path,                  STRING, &quot;/tmp/&quot;
 filters.autoload.active,                UINT,   0,      0,      1
 feature.alternate_mp3_tag,              UINT,   1,      0,      1
+# Global glyphset file
+feature.global_glyph,                   UINT,   1,      0,      1
+feature.global_glyph.name,              STRING, &quot;&quot;
 # priority
 priority.encoding,          UINT,   3,      0,      4
 priority.indexing,          UINT,   3,      0,      4


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000645.html">[Avidemux-svn-commit] r3368 - in	branches/avidemux_2.4_branch/avidemux: .	ADM_userInterfaces/ADM_GTK/ADM_dialog	ADM_userInterfaces/ADM_GTK/ADM_gui2	ADM_userInterfaces/ADM_GTK/ADM_toolkit_gtk	ADM_userInterfaces/ADM_NONE/ADM_gui2	ADM_userInterfaces/ADM_QT4/ADM_gui ADM_userInterfaces/ADM_commonUI
</A></li>
	<LI>Next message: <A HREF="000647.html">[Avidemux-svn-commit] r3370 -	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#646">[ date ]</a>
              <a href="thread.html#646">[ thread ]</a>
              <a href="subject.html#646">[ subject ]</a>
              <a href="author.html#646">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
