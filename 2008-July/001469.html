<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r4221 - in	branches/avidemux_2.5_branch_gruntster/avidemux: . ADM_audio	ADM_audioEncoder ADM_audioEncoder/include	ADM_audioEncoder/src ADM_audiocodec ADM_audiodevice	ADM_audiofilter ADM_core/include ADM_core/src ADM_coreAudio	ADM_coreAudio/include ADM_coreAudio/src ADM_libraries/ADM_utilities	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_filters	ADM_userInterfaces/ADM_commonUI
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2008-July/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4221%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster/avidemux%3A%20.%20ADM_audio%0A%09ADM_audioEncoder%20ADM_audioEncoder/include%0A%09ADM_audioEncoder/src%20ADM_audiocodec%20ADM_audiodevice%0A%09ADM_audiofilter%20ADM_core/include%20ADM_core/src%20ADM_coreAudio%0A%09ADM_coreAudio/include%20ADM_coreAudio/src%20ADM_libraries/ADM_utilities%0A%09ADM_userInterfaces/ADM_NONE/ADM_dialog%0A%09ADM_userInterfaces/ADM_QT4/ADM_dialog%0A%09ADM_userInterfaces/ADM_QT4/ADM_filters%0A%09ADM_userInterfaces/ADM_commonUI&In-Reply-To=%3C200807161739.m6GHdhJv021064%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001468.html">
   <LINK REL="Next"  HREF="001470.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r4221 - in	branches/avidemux_2.5_branch_gruntster/avidemux: . ADM_audio	ADM_audioEncoder ADM_audioEncoder/include	ADM_audioEncoder/src ADM_audiocodec ADM_audiodevice	ADM_audiofilter ADM_core/include ADM_core/src ADM_coreAudio	ADM_coreAudio/include ADM_coreAudio/src ADM_libraries/ADM_utilities	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_filters	ADM_userInterfaces/ADM_commonUI</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4221%20-%20in%0A%09branches/avidemux_2.5_branch_gruntster/avidemux%3A%20.%20ADM_audio%0A%09ADM_audioEncoder%20ADM_audioEncoder/include%0A%09ADM_audioEncoder/src%20ADM_audiocodec%20ADM_audiodevice%0A%09ADM_audiofilter%20ADM_core/include%20ADM_core/src%20ADM_coreAudio%0A%09ADM_coreAudio/include%20ADM_coreAudio/src%20ADM_libraries/ADM_utilities%0A%09ADM_userInterfaces/ADM_NONE/ADM_dialog%0A%09ADM_userInterfaces/ADM_QT4/ADM_dialog%0A%09ADM_userInterfaces/ADM_QT4/ADM_filters%0A%09ADM_userInterfaces/ADM_commonUI&In-Reply-To=%3C200807161739.m6GHdhJv021064%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r4221 - in	branches/avidemux_2.5_branch_gruntster/avidemux: . ADM_audio	ADM_audioEncoder ADM_audioEncoder/include	ADM_audioEncoder/src ADM_audiocodec ADM_audiodevice	ADM_audiofilter ADM_core/include ADM_core/src ADM_coreAudio	ADM_coreAudio/include ADM_coreAudio/src ADM_libraries/ADM_utilities	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_filters	ADM_userInterfaces/ADM_commonUI">mean at mail.berlios.de
       </A><BR>
    <I>Wed Jul 16 19:39:43 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001468.html">[Avidemux-svn-commit] r4220 -	branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mp4
</A></li>
        <LI>Next message: <A HREF="001470.html">[Avidemux-svn-commit] r4222 - in	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder:	. src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1469">[ date ]</a>
              <a href="thread.html#1469">[ thread ]</a>
              <a href="subject.html#1469">[ subject ]</a>
              <a href="author.html#1469">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2008-07-16 19:39:39 +0200 (Wed, 16 Jul 2008)
New Revision: 4221

Added:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_aften.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_aften_param.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_config.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_enum.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_faac.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_faac_param.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_lame.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_lame_param.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_lavcodec.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_pcm.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_twolame.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_twolame_param.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_vorbis.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_vorbis_param.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_aften.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_faac.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_lame.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_lavcodec.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_pcm.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_twolame.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_vorbis.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/include/
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/include/ADM_audiodef.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/include/ADM_coreAudio.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/include/audioencoder.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/src/
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/src/ADM_audioUtils.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/src/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/src/audioencoder.cpp
Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_audiodef.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften_param.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_config.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac_param.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame_param.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lavcodec.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lavcodec.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_pcm.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_pcm.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame_param.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis_param.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_coreAudio.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_audioUtils.cpp
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/aviaudio.hxx
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_ad_plugin.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiodevice/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiodeng_buildfilters.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioeng_buildfilters.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioeng_process.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_buildchain.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/avifmt2.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_audioconfig.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt
Log:
[Audio] Create coreAudio + begin moving away audioEncoder


Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_audiodef.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_audiodef.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_audiodef.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,69 +0,0 @@
-/*
-
-
-*/
-#ifndef AUDIO_DEF
-#define AUDIO_DEF
-#include &lt;string.h&gt;
-typedef struct
-{
-    uint16_t	encoding;	
-    uint16_t	channels;					/* 1 = mono, 2 = stereo */
-    uint32_t	frequency;				/* One of 11025, 22050, or 44100 48000 Hz */
-    uint32_t	byterate;					/* Average bytes per second */
-    uint16_t	blockalign;				/* Bytes per sample block */
-    uint16_t	bitspersample;		/* One of 8, 12, 16, or 4 for ADPCM */
-} WAVHeader;
-void printWavHeader(WAVHeader *hdr);
-
-typedef enum 
-{
-    CHANNEL_INVALID=0,
-    CHANNEL_MONO,
-    CHANNEL_STEREO,
-    CHANNEL_2F_1R,
-    CHANNEL_3F,
-    CHANNEL_3F_1R,
-    CHANNEL_2F_2R,
-    CHANNEL_3F_2R,
-    CHANNEL_3F_2R_LFE,
-    CHANNEL_DOLBY_PROLOGIC,
-    CHANNEL_DOLBY_PROLOGIC2,
-    CHANNEL_LAST
-} CHANNEL_CONF;
-
-#define MAX_CHANNELS 9
-
-typedef enum 
-{
-	CH_INVALID=0,
-	CH_MONO,
-	CH_FRONT_LEFT,
-	CH_FRONT_RIGHT,
-	CH_FRONT_CENTER,
-	CH_REAR_LEFT,
-	CH_REAR_RIGHT,
-	CH_REAR_CENTER,
-	CH_SIDE_LEFT,
-	CH_SIDE_RIGHT,
-	CH_LFE
-}CHANNEL_TYPE;
-// returns true if channel mapping is identical
-bool ADM_audioCompareChannelMapping(WAVHeader *wh1, WAVHeader *wh2,CHANNEL_TYPE *map1,CHANNEL_TYPE *map2);
-
-
-typedef struct
-{
-  const char    *desc;
-  CHANNEL_CONF  conf;
-}AudioChannelDesc;
-const AudioChannelDesc localDownmixing[]=
-{
-  {&quot;No downmixing (multichannel)&quot;, CHANNEL_INVALID},
-  {&quot;Stereo&quot;, CHANNEL_STEREO},
-  {&quot;Dolby Prologic&quot;, CHANNEL_DOLBY_PROLOGIC},
-  {&quot;Dolby Prologic II&quot;, CHANNEL_DOLBY_PROLOGIC2}
-  
-};
-#define NB_LOCAL_DOWNMIX (sizeof(localDownmixing)/sizeof(AudioChannelDesc))
-#endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/aviaudio.hxx
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/aviaudio.hxx	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/aviaudio.hxx	2008-07-16 17:39:39 UTC (rev 4221)
@@ -22,7 +22,7 @@
 class AviList;
 
 
-#include &quot;../ADM_audio/ADM_audiodef.h&quot;
+#include &quot;ADM_coreAudio/include/ADM_coreAudio.h&quot;
 typedef struct
 {
 	uint16_t	encoding;	

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_aften.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_aften.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,31 @@
+
+/***************************************************************************
+    copyright            : (C) 2002-6 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef AUDMaudioAften
+#define AUDMaudioAften
+#ifdef USE_AFTEN
+ //_____________________________________________
+class AUDMEncoder_Aften : public AUDMEncoder
+{
+protected:
+         void           *_handle;
+         
+public:
+                        uint8_t init(ADM_audioEncoderDescriptor *config);
+                virtual ~AUDMEncoder_Aften();
+                        AUDMEncoder_Aften(AUDMAudioFilter *instream);	
+                virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
+};
+#endif
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_aften_param.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften_param.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften_param.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_aften_param.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,10 @@
+#ifndef AUDM_AFTEN_PARAM_H
+#define AUDM_AFTEN_PARAM_H
+#ifdef USE_AFTEN
+
+typedef struct AFTEN_encoderParam
+{
+  ADM_mode        mode;
+};
+#endif
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_config.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_config.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_config.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_config.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,180 @@
+#ifndef AUDIOENCODER_CONFIG_H
+#define AUDIOENCODER_CONFIG_H
+
+#include &quot;audioencoder_faac_param.h&quot;
+#include &quot;audioencoder_lame_param.h&quot;
+#include &quot;audioencoder_twolame_param.h&quot;
+#include &quot;audioencoder_vorbis_param.h&quot;
+#include &quot;audioencoder_aften_param.h&quot;
+
+
+
+extern int DIA_defaultSettings(ADM_audioEncoderDescriptor *descriptor);
+/**** Copy ****/
+
+ADM_audioEncoderDescriptor copyDescriptor=
+{
+  AUDIOENC_COPY,
+  DIA_defaultSettings,
+  &quot;Copy encoder&quot;,
+  128,
+  99,
+  0,
+  NULL
+};
+/**** FAAC ****/
+#ifdef USE_FAAC
+FAAC_encoderParam aacParam={128};
+ADM_audioEncoderDescriptor aacDescriptor=
+{
+        AUDIOENC_FAAC,
+        DIA_defaultSettings,
+        &quot;FAAC encoder&quot;,
+        128,
+        6,      // AAC can do 5.1
+        sizeof(aacParam),
+        &amp;aacParam
+};
+#endif
+/**** LAME ****/
+LAME_encoderParam lameParam=
+{
+  ADM_LAME_PRESET_CBR,
+  ADM_STEREO,
+  2,
+  0 /* Reservoir enable by default */
+};
+#ifdef HAVE_LIBMP3LAME
+extern int DIA_getLameSettings(ADM_audioEncoderDescriptor *descriptor);
+ADM_audioEncoderDescriptor  lameDescriptor=
+{
+  AUDIOENC_MP3,
+  DIA_getLameSettings,
+  &quot;Lame encoder&quot;,
+  128,
+  2,      // Lame can only do stereo
+  sizeof(lameParam),
+  &amp;lameParam
+};
+#endif
+/**** TWOLAME ****/
+TWOLAME_encoderParam twolameParam=
+{
+  ADM_STEREO
+};
+ADM_audioEncoderDescriptor  twolameDescriptor=
+{
+  AUDIOENC_2LAME,
+  DIA_defaultSettings,
+  &quot;TwoLame encoder&quot;,
+  128,
+  2,      // Lame can only do stereo
+  sizeof(twolameParam),
+  &amp;twolameParam
+};
+/********** Lavcodec **************/
+ADM_audioEncoderDescriptor  lavcodecMP2Descriptor=
+{
+  AUDIOENC_MP2,
+  DIA_defaultSettings,
+  &quot;LAvcodec MP2 encoder&quot;,
+  128,
+  2,    
+  0,
+  NULL
+};
+ADM_audioEncoderDescriptor  lavcodecAC3Descriptor=
+{
+  AUDIOENC_AC3,
+  DIA_defaultSettings,
+  &quot;LAvcodec AC3 encoder&quot;,
+  128,
+  6,    
+  0,
+  NULL
+};
+
+/************** Vorbis **************/
+#ifdef USE_VORBIS
+extern int DIA_getVorbisSettings(ADM_audioEncoderDescriptor *descriptor);
+VORBIS_encoderParam vorbisParam=
+{
+  ADM_VORBIS_VBR,
+  3
+  
+};
+ADM_audioEncoderDescriptor  vorbisDescriptor=
+{
+  AUDIOENC_VORBIS,
+  DIA_getVorbisSettings,
+  &quot;Vorbis encoder&quot;,
+  128,
+  6,      // Lame can only do stereo
+  sizeof(vorbisParam),
+  &amp;vorbisParam
+};
+#endif
+/********** PCM **************/
+ADM_audioEncoderDescriptor  pcmDescriptor=
+{
+  AUDIOENC_NONE,
+  NULL,
+  &quot;PCM encoder&quot;,
+  128,
+  6,    
+  0,
+  NULL
+};
+ADM_audioEncoderDescriptor  lpcmDescriptor=
+{
+  AUDIOENC_LPCM,
+  NULL,
+  &quot;LPCM encoder&quot;,
+  128,
+  6,    
+  0,
+  NULL
+};
+//---------------- AFTEN ------------------
+#ifdef USE_AFTEN
+AFTEN_encoderParam aftenParam =
+{
+  ADM_STEREO
+};
+
+ADM_audioEncoderDescriptor  aftenDescriptor=
+{
+  AUDIOENC_AFTEN,
+  DIA_defaultSettings,
+  &quot;Aften AC3 encoder&quot;,
+  128,
+  6,      // Lame can only do stereo
+  sizeof(aftenParam),
+  &amp;aftenParam
+};
+#endif
+ADM_audioEncoderDescriptor *allDescriptors[]=
+{
+      &amp;copyDescriptor,
+#ifdef USE_FAAC
+      &amp;aacDescriptor,
+#endif
+      &amp;twolameDescriptor,
+      &amp;lavcodecAC3Descriptor,
+      &amp;lavcodecMP2Descriptor,
+#ifdef USE_VORBIS
+      &amp;vorbisDescriptor ,
+#endif      
+      &amp;pcmDescriptor,
+      &amp;lpcmDescriptor
+#ifdef USE_AFTEN
+      ,&amp;aftenDescriptor
+#endif
+#ifdef HAVE_LIBMP3LAME
+      ,&amp;lameDescriptor
+#endif
+};
+#define NB_AUDIO_DESCRIPTOR (sizeof(allDescriptors)/sizeof(ADM_audioEncoderDescriptor *))
+#endif
+//EOF
+

Added: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_enum.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_enum.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_enum.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,24 @@
+/**
+    \fn audioencoder_enum
+    \brief Temporary, will be removed
+*/
+
+#ifndef audioencoder_enum_h
+#define audioencoder_enum_h
+
+typedef enum 
+{
+	AUDIOENC_NONE,
+	AUDIOENC_MP3,
+	AUDIOENC_MP2,
+	AUDIOENC_AC3,
+	AUDIOENC_2LAME,
+	AUDIOENC_FAAC,
+	AUDIOENC_VORBIS,
+    AUDIOENC_COPY,
+    AUDIOENC_LPCM,
+    AUDIOENC_AFTEN,
+    AUDIOENC_DUMMY
+}AUDIOENCODER;
+
+#endif
\ No newline at end of file

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_faac.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_faac.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,31 @@
+
+/***************************************************************************
+    copyright            : (C) 2002-6 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef AUDMaudioAAC
+#define AUDMaudioAAC
+
+ //_____________________________________________
+class AUDMEncoder_Faac : public AUDMEncoder
+{
+protected:
+         void           *_handle;
+         uint8_t        refillBuffer(int minimum);
+public:
+                        uint8_t init(ADM_audioEncoderDescriptor *config);
+                virtual ~AUDMEncoder_Faac();
+                        AUDMEncoder_Faac(AUDMAudioFilter *instream);	
+                virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
+};
+
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_faac_param.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac_param.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac_param.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_faac_param.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,8 @@
+
+#ifndef FAAC_PARAM_H
+#define FAAC_PARAM_H
+typedef struct 
+{
+  uint32_t dummy;
+}FAAC_encoderParam;
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_lame.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_lame.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,35 @@
+
+/***************************************************************************
+    copyright            : (C) 2002-6 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef AUDMaudioLame
+#define AUDMaudioLame
+
+ //_____________________________________________
+class AUDMEncoder_Lame : public AUDMEncoder
+{
+  protected:
+   
+    void              *lameFlags;
+    ADM_LAME_PRESET   _preset;
+         
+  public:
+            uint8_t     init(ADM_audioEncoderDescriptor *config);
+    virtual             ~AUDMEncoder_Lame();
+                        AUDMEncoder_Lame(AUDMAudioFilter *instream);	
+            uint8_t	isVBR(void );
+            
+   virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
+};
+
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_lame_param.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame_param.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame_param.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_lame_param.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,31 @@
+#ifndef AUDM_LAME_PARAM_H
+#define AUDM_LAME_PARAM_H
+
+typedef enum 
+{
+  ADM_LAME_PRESET_CBR,
+  ADM_LAME_PRESET_ABR,
+  ADM_LAME_PRESET_EXTREME
+}ADM_LAME_PRESET;
+
+typedef struct 
+{
+  ADM_LAME_PRESET preset;
+  const char	*name;
+}ADM_PRESET_DEFINITION;
+static const ADM_PRESET_DEFINITION      presetDefinition[]=
+{
+  {ADM_LAME_PRESET_CBR,&quot;CBR&quot;},
+  {ADM_LAME_PRESET_ABR,&quot;ABR&quot;},
+  {ADM_LAME_PRESET_EXTREME,&quot;Extreme&quot;}
+};    
+
+typedef struct 
+{
+  ADM_LAME_PRESET preset;
+  ADM_mode        mode;
+  uint32_t        quality;
+  uint32_t        disableReservoir; // usefull for strict CBR (FLV)
+}LAME_encoderParam;
+
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_lavcodec.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lavcodec.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lavcodec.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_lavcodec.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,32 @@
+
+/***************************************************************************
+    copyright            : (C) 2002-6 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef AUDMaudioLavcodec
+#define AUDMaudioLavcodec
+ //_____________________________________________
+class AUDMEncoder_Lavcodec : public AUDMEncoder
+{
+  protected:
+   
+    void              *_context;
+    uint32_t          _fourcc;
+         
+  public:
+            uint8_t     init(ADM_audioEncoderDescriptor *config);
+   virtual             ~AUDMEncoder_Lavcodec();
+                        AUDMEncoder_Lavcodec(uint32_t fourcc,AUDMAudioFilter *instream);	
+   virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
+};
+
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_pcm.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_pcm.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_pcm.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_pcm.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,36 @@
+/***************************************************************************
+    copyright            : (C) 2002-6 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef AUDMaudioPCM
+#define AUDMaudioPCM
+
+/*!
+    This class is the float-&gt;PCM encoder.
+    It is somehow special as it can alsa be a LPCM encoder and a bigendian/littleendian swapper
+*/
+class AUDMEncoder_PCM : public AUDMEncoder
+{
+  protected:
+    uint32_t            revert;
+         
+  public:
+            uint8_t     init(ADM_audioEncoderDescriptor *config);
+            virtual     ~AUDMEncoder_PCM();
+                        /*! \param reverted : Should the endianness be reverted compared to system  
+                            \param fourCC   : FourCC to use (WAV_PCM/WAV_LPCM)
+                        */
+                         AUDMEncoder_PCM(uint32_t reverted,uint32_t fourCC,AUDMAudioFilter * instream);
+    virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
+};
+
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_twolame.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_twolame.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,30 @@
+/***************************************************************************
+    copyright            : (C) 2002-6 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef AUDMaudioTwoLame
+#define AUDMaudioTwoLame
+
+ //_____________________________________________
+class AUDMEncoder_Twolame : public AUDMEncoder
+{
+  protected:
+    void           *_twolameOptions;
+         
+  public:
+            uint8_t     init(ADM_audioEncoderDescriptor *config);
+    virtual             ~AUDMEncoder_Twolame();
+                        AUDMEncoder_Twolame(AUDMAudioFilter *instream);	
+    virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
+};
+
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_twolame_param.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame_param.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame_param.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_twolame_param.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,10 @@
+#ifndef AUDM_TWOLAME_PARAM_H
+#define AUDM_TWOLAME_PARAM_H
+
+
+typedef struct 
+{
+  ADM_mode        mode;
+}TWOLAME_encoderParam;
+
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_vorbis.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_vorbis.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,35 @@
+
+/***************************************************************************
+    copyright            : (C) 2002-6 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef AUDMaudioVorbis
+#define AUDMaudioVorbis
+
+ //_____________________________________________
+class AUDMEncoder_Vorbis : public AUDMEncoder
+{
+  protected:
+   
+    void              *_handle;
+    uint64_t          _oldpos;
+
+         
+  public:
+            uint8_t     init(ADM_audioEncoderDescriptor *config);
+            virtual     ~AUDMEncoder_Vorbis();
+                        AUDMEncoder_Vorbis(AUDMAudioFilter *instream);	
+            
+   virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
+};
+
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_vorbis_param.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis_param.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis_param.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/include/audioencoder_vorbis_param.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,17 @@
+#ifndef AUDM_VORBIS_PARAM_H
+#define AUDM_VORBIS_PARAM_H
+
+typedef enum 
+{
+  ADM_VORBIS_CBR,
+  ADM_VORBIS_VBR,
+  ADM_VORBIS_QUALITY
+  
+}ADM_VORBIS_MODE;
+
+typedef struct 
+{
+  ADM_VORBIS_MODE    mode;   // 0 cbr 1 vbr 2 quality
+  float              quality;
+}VORBIS_encoderParam;
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_aften.cpp (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften.cpp)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften.cpp	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_aften.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,166 @@
+
+/***************************************************************************
+    copyright            : (C) 2002-6 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+
+    Interface to Aften
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;config.h&quot;
+#ifdef USE_AFTEN
+#include &quot;config.h&quot;
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+#include &lt;math.h&gt;
+
+
+#include &quot;ADM_default.h&quot;
+
+#include &quot;audioprocess.hxx&quot;
+#include &quot;audioeng_process.h&quot;
+#include &quot;audioencoder.h&quot;
+//
+extern &quot;C&quot;
+{
+#if defined(USE_AFTEN_06)
+	#include &quot;aften.h&quot;
+#else	// Aften 0.05 &amp; 0.07 onwards
+	#include &quot;aften/aften.h&quot;
+#endif
+};
+#include &quot;audioencoder_aften_param.h&quot;
+#include &quot;audioencoder_aften.h&quot;
+
+#define _HANDLE ((AftenContext *)_handle)
+AUDMEncoder_Aften::AUDMEncoder_Aften(AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
+{
+  uint32_t channels;
+  channels=instream-&gt;getInfo()-&gt;channels;
+  _handle=(void *)new AftenContext;
+  memset(_handle,0,sizeof(AftenContext));
+  aften_set_defaults(_HANDLE);
+  _wavheader-&gt;encoding=WAV_AC3;
+#if defined(USE_AFTEN_05) || defined(USE_AFTEN_06)
+#elif defined(USE_AFTEN_07)
+  _HANDLE-&gt;params.n_threads=1; // MThread collides with avidemux multithreading
+#else
+  _HANDLE-&gt;system.n_threads=1;
+#endif
+};
+
+
+AUDMEncoder_Aften::~AUDMEncoder_Aften()
+{
+    if(_handle)
+      aften_encode_close(_HANDLE);
+    delete(_HANDLE);
+    _handle=NULL;
+
+    printf(&quot;[Aften] Deleting aften\n&quot;);
+    cleanup();
+};
+
+
+//________________________________________________
+//   Init lame encoder
+// frequence    : Impose frequency , 0 means reuse the incoming fq
+// mode                         : ADM_STEREO etc...
+// bitrate              : Bitrate in kbps (96,192...)
+// return 0 : init failed
+//                              1 : init succeeded
+//_______________________________________________
+uint8_t AUDMEncoder_Aften::init(ADM_audioEncoderDescriptor *config)
+{
+
+
+int ret=0;
+
+#if defined(USE_AFTEN_05) || defined(USE_AFTEN_06)
+int mask;
+#else
+unsigned int mask;
+#endif
+
+    _wavheader-&gt;byterate=(config-&gt;bitrate*1000)/8;
+    _HANDLE-&gt;sample_format=A52_SAMPLE_FMT_FLT;
+    _HANDLE-&gt;channels=_wavheader-&gt;channels;
+    _HANDLE-&gt;samplerate=_wavheader-&gt;frequency;
+    
+    _HANDLE-&gt;params.bitrate=config-&gt;bitrate;
+    switch(_wavheader-&gt;channels)
+    {
+        case 1: mask = 0x04;  break;
+        case 2: mask = 0x03;  break;
+        case 3: mask = 0x07;  break;
+        case 4: mask = 0x107; break;
+        case 5: mask = 0x37;  break;
+        case 6: mask = 0x3F;  break;
+      }
+
+#if defined(USE_AFTEN_05) || defined(USE_AFTEN_06)
+	aften_wav_chmask_to_acmod(_wavheader-&gt;channels, mask, &amp;(_HANDLE-&gt;acmod), &amp;(_HANDLE-&gt;lfe));
+#else
+	aften_wav_channels_to_acmod(_wavheader-&gt;channels, mask, &amp;(_HANDLE-&gt;acmod), &amp;(_HANDLE-&gt;lfe));
+#endif
+
+   //   _HANDLE-&gt;params.verbose=2;
+    int er= aften_encode_init(_HANDLE);
+    if(er&lt;0)
+    {
+      printf(&quot;[Aften] init error %d\n&quot;,er); 
+      return 0;
+    }
+    _chunk=256*6*_wavheader-&gt;channels;
+    printf(&quot;[Aften] Initialized with fd %u Channels %u bitrate %u\n&quot;,_HANDLE-&gt;samplerate,
+                                                                    _HANDLE-&gt;channels,_HANDLE-&gt;params.bitrate);
+    return 1;
+}
+
+
+//______________________________________________
+uint8_t	AUDMEncoder_Aften::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
+{
+  uint32_t count=0;
+  int r;
+  void *ptr;
+_again:
+        *len = 0;
+        _chunk=256*6*_wavheader-&gt;channels;
+        if(!refillBuffer(_chunk ))
+        {
+          return 0; 
+        }
+        ptr=(void *)&amp;(tmpbuffer[tmphead]);
+        ADM_assert(tmptail&gt;=tmphead);
+
+#ifdef USE_AFTEN_05
+		aften_remap_wav_to_a52(ptr, 256*6, _wavheader-&gt;channels, A52_SAMPLE_FMT_FLT, _HANDLE-&gt;acmod, _HANDLE-&gt;lfe);
+#else
+		aften_remap_wav_to_a52(ptr, 256*6, _wavheader-&gt;channels, A52_SAMPLE_FMT_FLT, _HANDLE-&gt;acmod);
+#endif
+
+        r=aften_encode_frame(_HANDLE, dest,(void *)ptr);
+        if(r&lt;0)
+        {
+          printf(&quot;[Aften] Encoding error %d\n&quot;,r);
+          return 0; 
+        }
+        
+        *samples=256*6;
+        *len=r;
+        tmphead+=_chunk;
+        return 1;
+}
+
+#endif		
+// EOF

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_faac.cpp (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.cpp)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.cpp	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_faac.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,223 @@
+
+/***************************************************************************
+    copyright            : (C) 2002-6 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+
+    Interface to FAAC
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;config.h&quot;
+#ifdef USE_FAAC
+#include &quot;config.h&quot;
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+#include &lt;math.h&gt;
+
+
+#include &quot;ADM_default.h&quot;
+
+#include &quot;audioprocess.hxx&quot;
+#include &quot;audioeng_process.h&quot;
+#include &quot;audioencoder.h&quot;
+//
+
+#include &quot;faac.h&quot;
+#include &quot;audioencoder_faac.h&quot;
+
+AUDMEncoder_Faac::AUDMEncoder_Faac(AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
+{
+  uint32_t channels;
+  channels=instream-&gt;getInfo()-&gt;channels;
+  switch(channels)
+  {
+    case 1:outputChannelMapping[1] = CH_FRONT_LEFT;break;
+    case 2:
+    	outputChannelMapping[0] = CH_FRONT_LEFT;
+    	outputChannelMapping[1] = CH_FRONT_RIGHT;
+      break;
+    default :
+    	outputChannelMapping[0] = CH_FRONT_CENTER;
+    	outputChannelMapping[1] = CH_FRONT_LEFT;
+    	outputChannelMapping[2] = CH_FRONT_RIGHT;
+    	outputChannelMapping[3] = CH_REAR_LEFT;
+    	outputChannelMapping[4] = CH_REAR_RIGHT;
+    	outputChannelMapping[5] = CH_LFE;
+  }
+};
+
+
+AUDMEncoder_Faac::~AUDMEncoder_Faac()
+{
+    if(_handle)
+        faacEncClose(_handle);
+    _handle=NULL;
+
+    printf(&quot;[FAAC] Deleting faac\n&quot;);
+    cleanup();
+};
+
+
+//________________________________________________
+//   Init lame encoder
+// frequence    : Impose frequency , 0 means reuse the incoming fq
+// mode                         : ADM_STEREO etc...
+// bitrate              : Bitrate in kbps (96,192...)
+// return 0 : init failed
+//                              1 : init succeeded
+//_______________________________________________
+uint8_t AUDMEncoder_Faac::init(ADM_audioEncoderDescriptor *config)
+{
+unsigned long int samples_input, max_bytes_output;
+faacEncConfigurationPtr cfg;
+int ret=0;
+
+    printf(&quot;[FAAC] Incoming Fq :%u\n&quot;,_wavheader-&gt;frequency);
+     _handle = faacEncOpen(_wavheader-&gt;frequency,
+                                 _wavheader-&gt;channels,
+                                 &amp;samples_input,
+                                &amp;max_bytes_output);
+    if(!_handle)
+    {
+          printf(&quot;Cannot open faac with fq=%lu chan=%lu br=%lu\n&quot;,
+          _wavheader-&gt;frequency,_wavheader-&gt;channels,config-&gt;bitrate);
+          return 0;
+    }
+    printf(&quot; [FAAC] : Sample input:%d, max byte output%d \n&quot;,samples_input,max_bytes_output);
+    cfg= faacEncGetCurrentConfiguration(_handle);
+    
+    // Set default conf, same as ffmpeg
+    cfg-&gt;aacObjectType = LOW;
+    cfg-&gt;mpegVersion = MPEG4;
+    cfg-&gt;bandWidth= (_wavheader-&gt;frequency*3)/4; // Should be relevant
+    cfg-&gt;useTns = 0;
+    cfg-&gt;allowMidside = 0;
+    cfg-&gt;bitRate = (config-&gt;bitrate*1000)/_wavheader-&gt;channels; // It is per channel
+    cfg-&gt;outputFormat = 0; // 0 Raw 1 ADTS
+    cfg-&gt;inputFormat = FAAC_INPUT_FLOAT;
+    cfg-&gt;useLfe=0;	
+    if (!(ret=faacEncSetConfiguration(_handle, cfg))) 
+    {
+        printf(&quot;[FAAC] Cannot set conf for faac with fq=%lu chan=%lu br=%lu (err:%d)\n&quot;,
+				_wavheader-&gt;frequency,_wavheader-&gt;channels,config-&gt;bitrate,ret);
+	return 0;
+    }
+     unsigned char *data=NULL;
+     unsigned long size=0;
+     if((ret=faacEncGetDecoderSpecificInfo(_handle, &amp;data,&amp;size)))
+     {
+        printf(&quot;FAAC: GetDecoderSpecific info failed (err:%d)\n&quot;,ret);
+        return 0;
+     }
+     _extraSize=size;
+     _extraData=new uint8_t[size];
+     memcpy(_extraData,data,size);
+
+    // update
+     _wavheader-&gt;byterate=(config-&gt;bitrate*1000)/8;
+//    _wavheader-&gt;dwScale=1024;
+//    _wavheader-&gt;dwSampleSize=0;
+    _wavheader-&gt;blockalign=4096;
+    _wavheader-&gt;bitspersample=0;
+
+    _chunk=samples_input;
+
+
+    printf(&quot;[Faac] Initialized :\n&quot;);
+    
+    printf(&quot;[Faac]Version        : %s\n&quot;,cfg-&gt;name);
+    printf(&quot;[Faac]Bitrate        : %lu\n&quot;,cfg-&gt;bitRate);
+    printf(&quot;[Faac]Mpeg2 (1)/4(0) : %u\n&quot;,cfg-&gt;mpegVersion);
+    printf(&quot;[Faac]Use lfe      ) : %u\n&quot;,cfg-&gt;useLfe);
+    printf(&quot;[Faac]Sample output  : %lu\n&quot;,_chunk / _wavheader-&gt;channels);
+    printf(&quot;[Faac]Bitrate        : %lu\n&quot;,cfg-&gt;bitRate*_wavheader-&gt;channels);
+
+    
+    return 1;
+}
+
+//_____________________________________________
+//  Need to multiply the float by 32767, can't use
+//  generic fill buffer
+//----------------------------------------------
+uint8_t AUDMEncoder_Faac::refillBuffer(int minimum)
+{
+  uint32_t filler=_wavheader-&gt;frequency*_wavheader-&gt;channels;
+  uint32_t nb;
+  AUD_Status status;
+  if(eof_met) return 0;
+  while(1)
+  {
+    ADM_assert(tmptail&gt;=tmphead);
+    if((tmptail-tmphead)&gt;=minimum) return 1;
+  
+    if(tmphead &amp;&amp; tmptail&gt;filler/2)
+    {
+      memmove(&amp;tmpbuffer[0],&amp;tmpbuffer[tmphead],(tmptail-tmphead)*sizeof(float)); 
+      tmptail-=tmphead;
+      tmphead=0;
+    }
+    ADM_assert(filler&gt;tmptail);
+    nb=_incoming-&gt;fill( (filler-tmptail)/2,&amp;tmpbuffer[tmptail],&amp;status);
+    if(!nb)
+    {
+      if(status!=AUD_END_OF_STREAM) ADM_assert(0);
+      
+      if((tmptail-tmphead)&lt;minimum)
+      {
+        memset(&amp;tmpbuffer[tmptail],0,sizeof(float)*(minimum-(tmptail-tmphead)));
+        tmptail=tmphead+minimum;
+        eof_met=1;  
+        return minimum;
+      }
+      else continue;
+    } else
+    {
+      float *s=&amp;(tmpbuffer[tmptail]);
+      for(int i=0;i&lt;nb;i++)
+      {
+        *s=*s*32767.;
+        s++;
+      }
+      tmptail+=nb;
+    }
+  }
+}
+
+#define FA_BUFFER_SIZE (SIZE_INTERNAL/4)
+//______________________________________________
+uint8_t	AUDMEncoder_Faac::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
+{
+  uint32_t count=0;
+_again:
+        *samples = _chunk/_wavheader-&gt;channels;
+        *len = 0;
+
+        if(!refillBuffer(_chunk ))
+        {
+          return 0; 
+        }
+        ADM_assert(tmptail&gt;=tmphead);
+        reorderChannels(&amp;(tmpbuffer[tmphead]),*samples,_incoming-&gt;getChannelMapping(),outputChannelMapping);
+        *len = faacEncEncode(_handle, (int32_t *)&amp;(tmpbuffer[tmphead]), _chunk, dest, FA_BUFFER_SIZE);
+        if(!*len) 
+        {
+          count++;
+          if(count&lt;20)
+            goto _again;
+          *samples=0;
+        }
+        tmphead+=_chunk;
+        return 1;
+}
+#endif		
+// EOF

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_lame.cpp (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame.cpp)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame.cpp	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_lame.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,258 @@
+/***************************************************************************
+    copyright            : (C) 2006 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;config.h&quot;
+
+#ifdef HAVE_LIBMP3LAME
+#include &lt;lame/lame.h&gt;
+
+#include &quot;ADM_default.h&quot;
+#include &quot;audioprocess.hxx&quot;
+#include &quot;audioeng_process.h&quot;
+#include &quot;audioencoder.h&quot;
+
+#include &quot;audioencoder_lame_param.h&quot;
+#include &quot;audioencoder_lame.h&quot;
+
+
+
+#define MYFLAGS (lame_global_flags *)lameFlags
+
+AUDMEncoder_Lame::AUDMEncoder_Lame(AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
+{
+  printf(&quot;[Lame] Creating lame\n&quot;);
+  lameFlags=NULL;
+  _wavheader-&gt;encoding=WAV_MP3;
+};
+
+AUDMEncoder_Lame::~AUDMEncoder_Lame()
+{
+  printf(&quot;[Lame] Deleting lame\n&quot;);
+  if(lameFlags)
+  {
+    lame_close(MYFLAGS);
+  }
+  lameFlags=NULL;
+  cleanup();
+};
+
+
+//________________________________________________
+//   Init lame encoder
+// frequence    : Impose frequency , 0 means reuse the incoming fq
+// mode                         : ADM_STEREO etc...
+// bitrate              : Bitrate in kbps (96,192...)
+// return 0 : init failed
+//                              1 : init succeeded
+//_______________________________________________
+uint8_t AUDMEncoder_Lame::init(ADM_audioEncoderDescriptor *config)
+{
+  int ret;
+  MPEG_mode_e mmode;
+  uint32_t frequence;
+  LAME_encoderParam *lameConf=(LAME_encoderParam *)config-&gt;param;
+      ADM_assert(config-&gt;paramSize==sizeof(LAME_encoderParam));
+
+      lameFlags = lame_init();
+      if (lameFlags == NULL)
+          return 0;
+      
+      if(_incoming-&gt;getInfo()-&gt;channels&gt;2)
+      {
+        printf(&quot;Too many channels\n&quot;);
+        return 0; 
+      }
+
+	// recompute output length
+	
+      
+      ret = lame_set_in_samplerate(MYFLAGS, _wavheader-&gt;frequency);
+      ret = lame_set_num_channels(MYFLAGS, _wavheader-&gt;channels);
+
+    
+      frequence = _wavheader-&gt;frequency;
+    printf(&quot;\n output frequency : %lu\n&quot;, frequence);
+    ret = lame_set_out_samplerate(MYFLAGS, frequence);
+
+    ret = lame_set_quality(MYFLAGS, 2);
+    
+    if (_wavheader-&gt;channels == 2)
+      {
+        switch (lameConf-&gt;mode)
+	    {
+	    case ADM_STEREO:
+		mmode = STEREO;
+		break;
+	    case ADM_JSTEREO:
+		mmode = JOINT_STEREO;
+		break;
+	    default:
+		printf(&quot;\n **** unknown mode ***\n&quot;);
+		mmode = STEREO;
+		break;
+
+	    }
+    } else
+    {
+		mmode = MONO;
+     	printf(&quot;\n mono audio mp3&quot;);
+  	}
+
+        ret = lame_set_brate(MYFLAGS, config-&gt;bitrate);
+        ret = lame_set_mode(MYFLAGS, mmode);	// 0 stereo 1 jstero
+        ret = lame_set_quality(MYFLAGS, lameConf-&gt;quality);	// 0 stereo 1 jstero
+        ret = lame_set_disable_reservoir(MYFLAGS,lameConf-&gt;disableReservoir);
+        printf(&quot;[Lame]Using quality of %d\n&quot;,lame_get_quality(MYFLAGS));
+        ret = lame_init_params(MYFLAGS);
+    if (ret == -1)
+	return 0;
+    // update bitrate in header
+    _wavheader-&gt;byterate = (config-&gt;bitrate &gt;&gt; 3) * 1000;
+#define BLOCK_SIZE 1152
+    // configure CBR/ABR/...
+    _preset=lameConf-&gt;preset;
+    switch(_preset)
+    {
+    	default:
+    	case ADM_LAME_PRESET_CBR: 
+          break;
+	case ADM_LAME_PRESET_ABR:
+	  
+          lame_set_preset( MYFLAGS, config-&gt;bitrate);
+	  _wavheader-&gt;blockalign=BLOCK_SIZE;
+	 break;
+	case ADM_LAME_PRESET_EXTREME: 
+	  _wavheader-&gt;blockalign=BLOCK_SIZE;
+          lame_set_preset( MYFLAGS, EXTREME);	
+	break;
+    
+    
+    }
+
+    lame_print_config(MYFLAGS);
+    lame_print_internals(MYFLAGS);
+    _chunk=BLOCK_SIZE*_wavheader-&gt;channels;
+    return 1;
+}
+uint8_t	AUDMEncoder_Lame::isVBR(void )
+{
+	if(_preset==ADM_LAME_PRESET_CBR) return 0;
+	return 1;
+
+}
+
+uint8_t	AUDMEncoder_Lame::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
+{
+  int32_t nbout;
+  
+        *samples = BLOCK_SIZE; //FIXME
+        *len = 0;
+
+        if(!refillBuffer(_chunk ))
+        {
+          return 0; 
+        }
+        
+        if(tmptail-tmphead&lt;_chunk)
+        {
+          return 0; 
+        }
+        dither16(&amp;(tmpbuffer[tmphead]),_chunk,_wavheader-&gt;channels);
+        ADM_assert(tmptail&gt;=tmphead);
+        if (_wavheader-&gt;channels == 1)
+        {
+          nbout = lame_encode_buffer(MYFLAGS, (int16_t *)&amp;(tmpbuffer[tmphead]),(int16_t *)&amp;(tmpbuffer[tmphead]), _chunk, dest, 16 * 1024);
+          
+        }
+        else
+        {
+          nbout = lame_encode_buffer_interleaved(MYFLAGS, (int16_t *)&amp;(tmpbuffer[tmphead]), _chunk/2, dest, 16 * 1024);
+        }
+        tmphead+=_chunk;
+        if (nbout &lt; 0) {
+          printf(&quot;\n Error !!! : %ld\n&quot;, nbout);
+          return 0;
+        }
+        *len=nbout;
+        if(!*len) *samples=0;
+        //printf(&quot;Audio packet : size %u, sample %u\n&quot;,*len,*samples);
+        return 1;
+}
+/**
+      \fn DIA_getLameSettings
+      \brief Dialog to set lame settings
+      @return 1 on success, 0 on failure
+
+*/
+#include &quot;DIA_factory.h&quot;
+int DIA_getLameSettings(ADM_audioEncoderDescriptor *descriptor)
+  {
+    int ret=0;
+    char string[400];
+    uint32_t mmode,ppreset;
+#define SZT(x) sizeof(x)/sizeof(diaMenuEntry )
+#define PX(x) &amp;(lameParam-&gt;x)
+    
+    
+    LAME_encoderParam *lameParam;
+    ADM_assert(sizeof(LAME_encoderParam)==descriptor-&gt;paramSize);
+  
+    lameParam=(LAME_encoderParam*)descriptor-&gt;param;
+    mmode=lameParam-&gt;mode;
+    ppreset=lameParam-&gt;preset;
+    diaMenuEntry channelMode[]={
+                             {ADM_STEREO,      QT_TR_NOOP(&quot;Stereo&quot;),NULL},
+                             {ADM_JSTEREO,   QT_TR_NOOP(&quot;Joint stereo&quot;),NULL},
+                             {ADM_MONO,      QT_TR_NOOP(&quot;Mono&quot;),NULL}};
+          
+    diaElemMenu menuMode(&amp;mmode,   QT_TR_NOOP(&quot;C_hannel mode:&quot;), SZT(channelMode),channelMode);
+    
+    diaMenuEntry encodingMode[]={
+                             {ADM_LAME_PRESET_CBR,      QT_TR_NOOP(&quot;CBR&quot;),NULL},
+                             {ADM_LAME_PRESET_ABR,   QT_TR_NOOP(&quot;ABR&quot;),NULL},
+#if 0
+                             {ADM_LAME_PRESET_EXTREME,      QT_TR_NOOP(&quot;Extreme&quot;),NULL}
+#endif
+    }; 
+    diaElemMenu Mode(&amp;ppreset,   QT_TR_NOOP(&quot;Bit_rate mode:&quot;), SZT(encodingMode),encodingMode);
+#define BITRATE(x) {x,QT_TR_NOOP(#x)}
+    diaMenuEntry bitrateM[]={
+                              BITRATE(56),
+                              BITRATE(64),
+                              BITRATE(80),
+                              BITRATE(96),
+                              BITRATE(112),
+                              BITRATE(128),
+                              BITRATE(160),
+                              BITRATE(192),
+                              BITRATE(224)
+                          };
+    diaElemMenu bitrate(&amp;(descriptor-&gt;bitrate),   QT_TR_NOOP(&quot;_Bitrate:&quot;), SZT(bitrateM),bitrateM);
+    
+    
+    
+    
+    diaElemUInteger quality(PX(quality),QT_TR_NOOP(&quot;_Quality:&quot;),0,9);
+    diaElemToggle reservoir(PX(disableReservoir),QT_TR_NOOP(&quot;_Disable reservoir:&quot;));
+  
+      diaElem *elems[]={&amp;menuMode,&amp;Mode,&amp;quality,&amp;bitrate,&amp;reservoir};
+    
+  if( diaFactoryRun(QT_TR_NOOP(&quot;LAME Configuration&quot;),5,elems))
+  {
+    lameParam-&gt;mode=(ADM_mode)mmode; 
+    lameParam-&gt;preset=(ADM_LAME_PRESET)ppreset;
+    return 1;
+  }
+  return 0;
+}  
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_lavcodec.cpp (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lavcodec.cpp)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lavcodec.cpp	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_lavcodec.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,149 @@
+/***************************************************************************
+                        
+    copyright            : (C) 2002-2006 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+    
+    Interface to FFmpeg mpeg1/2 audio encoder
+    
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+#include &lt;math.h&gt;
+
+#include &quot;ADM_default.h&quot;
+
+#include &quot;audioprocess.hxx&quot;
+#include &quot;audioeng_process.h&quot;
+#include &quot;audioencoder.h&quot;
+//
+#include &quot;audioencoder_lavcodec.h&quot;
+
+#include &quot;ADM_lavcodec.h&quot;
+
+#include &quot;ADM_osSupport/ADM_debugID.h&quot;
+#define MODULE_NAME MODULE_AUDIO_FILTER
+#include &quot;ADM_osSupport/ADM_debug.h&quot;
+
+
+#define CONTEXT ((AVCodecContext  	*)_context)
+
+
+// Ctor: Duplicate
+//__________
+
+AUDMEncoder_Lavcodec::AUDMEncoder_Lavcodec(uint32_t fourcc,AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
+{
+  _fourcc=fourcc;
+  if(_fourcc!=WAV_MP2 &amp;&amp; _fourcc!=WAV_AC3) ADM_assert(0);
+  _context=NULL;
+  _wavheader-&gt;encoding=_fourcc;
+  printf(&quot;[Lavcodec] Creating Lavcodec\n&quot;);
+};
+
+
+AUDMEncoder_Lavcodec::~AUDMEncoder_Lavcodec()
+{
+  printf(&quot;[Lavcodec] Deleting Lavcodec\n&quot;);
+  if(_context)
+  {
+    avcodec_close(CONTEXT);
+    ADM_dealloc(_context);
+  }
+  _context=NULL;
+  cleanup();
+};
+
+//________________________________________________
+//   Init lame encoder
+//_______________________________________________
+uint8_t AUDMEncoder_Lavcodec::init(ADM_audioEncoderDescriptor *config)
+{
+  int ret;
+  _context=( void *)avcodec_alloc_context();
+  _wavheader-&gt;byterate=(config-&gt;bitrate*1000)&gt;&gt;3;
+
+      
+  if(_fourcc==WAV_MP2 &amp;&amp; _incoming-&gt;getInfo()-&gt;channels&gt;2)
+  {
+    printf(&quot;[Lavcodec]Too many channels\n&quot;);
+    return 0; 
+  }
+  _wavheader-&gt;byterate=(config-&gt;bitrate*1000)&gt;&gt;3;         
+      
+  if(_fourcc==WAV_MP2)
+    _chunk = 1152*_wavheader-&gt;channels;
+  else
+    _chunk = 1536*_wavheader-&gt;channels; // AC3
+
+  printf(&quot;[Lavcodec]Incoming : fq : %lu, channel : %lu bitrate: %lu \n&quot;,
+         _wavheader-&gt;frequency,_wavheader-&gt;channels,config-&gt;bitrate);
+  
+  
+  CONTEXT-&gt;channels     =  _wavheader-&gt;channels;
+  CONTEXT-&gt;sample_rate  =  _wavheader-&gt;frequency;
+  CONTEXT-&gt;bit_rate     = (config-&gt;bitrate*1000); // bits -&gt; kbits
+
+  AVCodec *codec;
+  CodecID codecID;
+  
+  if(_fourcc==WAV_MP2) codecID=CODEC_ID_MP2;
+        else codecID=CODEC_ID_AC3;
+  codec = avcodec_find_encoder(codecID);
+  ADM_assert(codec);
+  
+  ret = avcodec_open(CONTEXT, codec);
+  if (0&gt; ret) 
+  {
+    printf(&quot;[Lavcodec] init failed err : %d!\n&quot;,ret);
+    return 0;
+  }
+
+
+  printf(&quot;[Lavcodec]Lavcodec successfully initialized\n&quot;);
+  return 1;       
+}
+//*********************************
+uint8_t	AUDMEncoder_Lavcodec::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
+{
+  uint32_t nbout;
+  
+  *samples = _chunk/_wavheader-&gt;channels; //FIXME
+  *len = 0;
+
+  if(!refillBuffer(_chunk ))
+  {
+    return 0; 
+  }
+        
+  if(tmptail-tmphead&lt;_chunk)
+  {
+    return 0; 
+  }
+
+  dither16(&amp;(tmpbuffer[tmphead]),_chunk,_wavheader-&gt;channels);
+
+  ADM_assert(tmptail&gt;=tmphead);
+  nbout = avcodec_encode_audio(CONTEXT, dest, 5000, (short *) &amp;(tmpbuffer[tmphead]));
+
+  tmphead+=_chunk;
+  if (nbout &lt; 0) 
+  {
+    printf(&quot;[Lavcodec] Error !!! : %ld\n&quot;, nbout);
+    return 0;
+  }
+  *len=nbout;
+  return 1;
+}
+
+// EOF

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_pcm.cpp (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_pcm.cpp)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_pcm.cpp	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_pcm.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,114 @@
+/***************************************************************************
+    copyright            : (C) 2006 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+#include &lt;math.h&gt;
+
+#include &quot;ADM_default.h&quot;
+
+#include &quot;audioprocess.hxx&quot;
+#include &quot;audioeng_process.h&quot;
+#include &quot;audioencoder.h&quot;
+//
+#include &quot;audioencoder_pcm.h&quot;
+
+
+#include &quot;ADM_osSupport/ADM_debugID.h&quot;
+#define MODULE_NAME MODULE_AUDIO_FILTER
+#include &quot;ADM_osSupport/ADM_debug.h&quot;
+
+
+
+
+// Ctor: Duplicate
+//__________
+
+AUDMEncoder_PCM::AUDMEncoder_PCM(uint32_t reverted,uint32_t fourCC,AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
+{
+  printf(&quot;[PCM] Creating PCM\n&quot;);
+  ADM_assert(fourCC==WAV_PCM || fourCC==WAV_LPCM);
+  _wavheader-&gt;encoding=fourCC;
+  revert=reverted;
+};
+
+
+AUDMEncoder_PCM::~AUDMEncoder_PCM()
+{
+  printf(&quot;[PCM] Deleting PCM\n&quot;);
+  cleanup();
+};
+
+//________________________________________________
+//   Init lame encoder
+// frequence    : Impose frequency , 0 means reuse the incoming fq
+// mode                         : ADM_STEREO etc...
+// bitrate              : Bitrate in kbps (96,192...)
+// return 0 : init failed
+//                              1 : init succeeded
+//_______________________________________________
+uint8_t AUDMEncoder_PCM::init(ADM_audioEncoderDescriptor *config)
+{
+  
+  _wavheader-&gt;byterate=_wavheader-&gt;channels*_wavheader-&gt;frequency*2;
+  _chunk = (_wavheader-&gt;frequency/100)*_wavheader-&gt;channels*2;
+  
+
+ 
+  printf(&quot;[PCM]Incoming :fq : %lu, channel : %lu \n&quot;,_wavheader-&gt;frequency,_wavheader-&gt;channels);
+  printf(&quot;[PCM]PCM successfully initialized\n&quot;);
+  return 1;       
+}
+
+uint8_t	AUDMEncoder_PCM::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
+{
+  uint32_t nbout;
+  
+  *samples = _chunk; //FIXME
+  *len = 0;
+
+  if(!refillBuffer(_chunk ))
+  {
+    return 0; 
+  }
+        
+  if(tmptail-tmphead&lt;_chunk)
+  {
+    return 0; 
+  }
+        // Do in place replace
+  dither16(&amp;(tmpbuffer[tmphead]),_chunk,_wavheader-&gt;channels);
+  if(!revert)
+    memcpy(dest,&amp;(tmpbuffer[tmphead]),_chunk*2);
+  else
+  {
+    uint16_t *in,*out,tmp;
+    in=(uint16_t*)&amp;(tmpbuffer[tmphead]);
+    out=(uint16_t *)dest;
+    for(int i=0;i&lt;_chunk;i++)
+    {
+      tmp=*in++;
+      tmp=((tmp&amp;0xff)&lt;&lt;8)+(tmp&gt;&gt;8);
+      *out++=tmp;
+    }
+  }
+  tmphead+=_chunk;
+  *len=_chunk*2;
+  *samples=_chunk/_wavheader-&gt;channels;
+  return 1;
+}
+
+
+// EOF

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_twolame.cpp (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame.cpp)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame.cpp	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_twolame.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,176 @@
+/***************************************************************************
+    copyright            : (C) 2006 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+#include &lt;math.h&gt;
+
+#include &quot;ADM_default.h&quot;
+
+#include &quot;audioprocess.hxx&quot;
+#include &quot;audioeng_process.h&quot;
+#include &quot;audioencoder.h&quot;
+//
+#include &quot;audioencoder_twolame.h&quot;
+#include &quot;audioencoder_twolame_param.h&quot;
+
+extern &quot;C&quot;
+{
+#include &quot;ADM_libraries/ADM_libtwolame/twolame.h&quot;
+}
+#include &quot;ADM_osSupport/ADM_debugID.h&quot;
+#define MODULE_NAME MODULE_AUDIO_FILTER
+#include &quot;ADM_osSupport/ADM_debug.h&quot;
+
+
+#define OPTIONS (twolame_options_struct *)_twolameOptions
+
+// Ctor: Duplicate
+//__________
+
+AUDMEncoder_Twolame::AUDMEncoder_Twolame(AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
+{
+  printf(&quot;[TwoLame] Creating Twolame\n&quot;);
+  _twolameOptions=NULL;
+  _wavheader-&gt;encoding=WAV_MP2;
+};
+
+
+AUDMEncoder_Twolame::~AUDMEncoder_Twolame()
+{
+  printf(&quot;[TwoLame] Deleting TwoLame\n&quot;);
+  if(_twolameOptions)
+  {
+    twolame_close((twolame_options_struct **)&amp;_twolameOptions);
+  }
+  _twolameOptions=NULL;
+  cleanup();
+};
+
+//________________________________________________
+//   Init lame encoder
+// frequence    : Impose frequency , 0 means reuse the incoming fq
+// mode                         : ADM_STEREO etc...
+// bitrate              : Bitrate in kbps (96,192...)
+// return 0 : init failed
+//                              1 : init succeeded
+//_______________________________________________
+uint8_t AUDMEncoder_Twolame::init(ADM_audioEncoderDescriptor *config)
+{
+  int ret;
+  TWOLAME_MPEG_mode mmode;    	
+  uint32_t frequence;
+  TWOLAME_encoderParam *lameConf=(TWOLAME_encoderParam *)config-&gt;param;
+  ADM_assert(config-&gt;paramSize==sizeof(TWOLAME_encoderParam));
+
+  _twolameOptions = twolame_init();
+  if (_twolameOptions == NULL)
+    return 0;
+      
+  if(_wavheader-&gt;channels&gt;2)
+  {
+    printf(&quot;[TwoLame]Too many channels\n&quot;);
+    return 0; 
+  }
+  _wavheader-&gt;byterate=(config-&gt;bitrate*1000)&gt;&gt;3;         
+      
+ 
+  _chunk = 1152*_wavheader-&gt;channels;
+
+ 
+  printf(&quot;[TwoLame]Incoming :fq : %lu, channel : %lu bitrate: %lu \n&quot;,
+        _wavheader-&gt;frequency,_wavheader-&gt;channels,config-&gt;bitrate);
+		
+ 
+  twolame_set_in_samplerate(OPTIONS, _wavheader-&gt;frequency);
+  twolame_set_out_samplerate (OPTIONS, _wavheader-&gt;frequency);
+  twolame_set_num_channels(OPTIONS, _wavheader-&gt;channels);
+  if(_wavheader-&gt;channels==1) mmode=TWOLAME_MONO;
+  else
+    switch (lameConf-&gt;mode)
+  {
+    case ADM_STEREO:
+      mmode = TWOLAME_STEREO;
+      break;
+    case ADM_JSTEREO:
+      mmode = TWOLAME_JOINT_STEREO;
+      break;
+    case ADM_MONO:
+      mmode=TWOLAME_MONO;
+      break;
+				
+    default:
+      printf(&quot;\n **** unknown mode, going stereo ***\n&quot;);
+      mmode = TWOLAME_STEREO;
+      break;
+
+  }
+  twolame_set_mode(OPTIONS,mmode);
+  twolame_set_error_protection(OPTIONS,TRUE);	
+    	//toolame_setPadding (options,TRUE);
+  twolame_set_bitrate (OPTIONS,config-&gt;bitrate);
+  twolame_set_verbosity(OPTIONS, 2);
+  if(twolame_init_params(OPTIONS))
+  {
+    printf(&quot;[TwoLame]Twolame init failed\n&quot;);
+    return 0;
+  }
+	
+ 
+
+  printf(&quot;[TwoLame]Libtoolame successfully initialized\n&quot;);
+  return 1;       
+}
+
+uint8_t	AUDMEncoder_Twolame::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
+{
+  int nbout;
+  
+  *samples = 1152; //FIXME
+  *len = 0;
+  ADM_assert(tmptail&gt;=tmphead);
+  if(!refillBuffer(_chunk ))
+  {
+    return 0; 
+  }
+        
+  if(tmptail-tmphead&lt;_chunk)
+  {
+    return 0; 
+  }
+
+  dither16(&amp;(tmpbuffer[tmphead]),_chunk,_wavheader-&gt;channels);
+
+  ADM_assert(tmptail&gt;=tmphead);
+  if (_wavheader-&gt;channels == 1)
+  {
+    nbout =twolame_encode_buffer(OPTIONS, (int16_t *)&amp;(tmpbuffer[tmphead]),(int16_t *)&amp;(tmpbuffer[tmphead]), _chunk, dest, 16 * 1024);
+  }
+  else
+  {
+    nbout = twolame_encode_buffer_interleaved(OPTIONS, (int16_t *)&amp;(tmpbuffer[tmphead]), _chunk/2, dest, 16 * 1024);
+  }
+  tmphead+=_chunk;
+  ADM_assert(tmptail&gt;=tmphead);
+  if (nbout &lt; 0) {
+    printf(&quot;\n Error !!! : %ld\n&quot;, nbout);
+    return 0;
+  }
+  *len=nbout;
+  return 1;
+}
+
+
+// EOF

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_vorbis.cpp (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.cpp)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.cpp	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder/src/audioencoder_vorbis.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,307 @@
+/***************************************************************************
+    copyright            : (C) 2006 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;config.h&quot;
+#ifdef USE_VORBIS
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+#include &lt;math.h&gt;
+
+#include &quot;ADM_default.h&quot;
+
+#include &quot;audioprocess.hxx&quot;
+#include &quot;audioeng_process.h&quot;
+#include &quot;audioencoder.h&quot;
+//
+#include &quot;audioencoder_vorbis_param.h&quot;
+#include &quot;audioencoder_vorbis.h&quot;
+
+
+#include &quot;vorbis/vorbisenc.h&quot;
+#include &quot;ADM_osSupport/ADM_debugID.h&quot;
+#define MODULE_NAME MODULE_AUDIO_FILTER
+#include &quot;ADM_osSupport/ADM_debug.h&quot;
+
+
+#define OPTIONS (twolame_options_struct *)_twolameOptions
+
+#define VD (((vorbisStruct *)_handle)-&gt;vd)
+#define VI (((vorbisStruct *)_handle)-&gt;vi)
+#define VB (((vorbisStruct *)_handle)-&gt;vb)
+#define VC (((vorbisStruct *)_handle)-&gt;vc)
+typedef struct vorbisStruct
+{ 
+	vorbis_info 	 vi ;
+	vorbis_dsp_state vd ;
+	vorbis_block     vb ;
+	vorbis_comment   vc ;
+}vorbisStruct;
+//__________
+
+AUDMEncoder_Vorbis::AUDMEncoder_Vorbis(AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
+{
+  printf(&quot;[Vorbis] Creating Vorbis\n&quot;);
+  _handle=NULL;
+  _wavheader-&gt;encoding=WAV_OGG;
+  _oldpos=0;
+  _handle=(void *)new  vorbisStruct; 
+  outputChannelMapping[0] = CH_FRONT_LEFT;
+  outputChannelMapping[1] = CH_FRONT_RIGHT;
+  outputChannelMapping[2] = CH_REAR_LEFT;
+  outputChannelMapping[3] = CH_REAR_RIGHT;
+  outputChannelMapping[4] = CH_FRONT_CENTER;
+  outputChannelMapping[5] = CH_LFE;
+};
+
+
+AUDMEncoder_Vorbis::~AUDMEncoder_Vorbis()
+{
+  printf(&quot;[Vorbis] Deleting Vorbis\n&quot;);
+  if(_handle)
+  {
+    vorbis_block_clear(&amp;VB);
+    vorbis_dsp_clear(&amp;VD);
+    vorbis_info_clear(&amp;VI);
+    delete (vorbisStruct *)_handle;
+  }    	
+  _handle=NULL;
+  
+  cleanup();
+};
+
+//________________________________________________
+//   Init lame encoder
+// frequence    : Impose frequency , 0 means reuse the incoming fq
+// mode                         : ADM_STEREO etc...
+// bitrate              : Bitrate in kbps (96,192...)
+// return 0 : init failed
+//                              1 : init succeeded
+//_______________________________________________
+uint8_t AUDMEncoder_Vorbis::init(ADM_audioEncoderDescriptor *config)
+{
+  int ret;
+  VORBIS_encoderParam *vorbisConf=(VORBIS_encoderParam *)config-&gt;param;
+  ADM_assert(config-&gt;paramSize==sizeof(VORBIS_encoderParam));
+
+  ogg_packet header1,header2,header3;
+  int err;
+
+  
+  
+  vorbis_info_init(&amp;VI) ;
+
+  switch(vorbisConf-&gt;mode)
+  {
+    
+    case ADM_VORBIS_VBR:
+                      err=vorbis_encode_init(&amp;VI,
+                              _wavheader-&gt;channels,
+                              _wavheader-&gt;frequency,
+                              -1, // Max bitrate      
+                              config-&gt;bitrate*1000, //long nominal_bitrate,
+                              -1 //long min_bitrate))
+                            );
+                      break;
+    case  ADM_VORBIS_QUALITY :
+                    err=vorbis_encode_init_vbr(&amp;VI,
+                                _wavheader-&gt;channels,
+                                _wavheader-&gt;frequency,
+                                vorbisConf-&gt;quality/10
+                              );
+                    break;
+      
+    default:
+      ADM_assert(0);
+  }
+  if (err!=0) 
+  {
+	  delete (vorbisStruct*)_handle;
+	  _handle = NULL;
+
+    printf(&quot;[vorbis] init error %d\n&quot;,err);
+    return 0;
+  }
+  vorbis_analysis_init(&amp;VD, &amp;VI) ;
+  vorbis_block_init(&amp;VD, &amp;VB);
+  vorbis_comment_init(&amp;VC);
+  vorbis_comment_add_tag(&amp;VC, &quot;encoder&quot;, &quot;AVIDEMUX2&quot;) ;
+
+  vorbis_analysis_headerout(&amp;VD, &amp;VC, &amp;header1,
+                             &amp;header2, &amp;header3);
+
+
+// Store all headers as extra data
+// see ogg vorbis decode for details
+// we need 3 packets
+
+  _extraSize=header1.bytes+header2.bytes+header3.bytes+3*sizeof(uint32_t);
+  _extraData=new uint8_t[_extraSize];
+
+  uint32_t *ex=(uint32_t *)_extraData;
+  uint8_t *d;
+  d=_extraData+sizeof(uint32_t)*3;
+  ex[0]=header1.bytes;
+  ex[1]=header2.bytes;
+  ex[2]=header3.bytes;
+  memcpy(d,header1.packet,ex[0]);
+  d+=ex[0];
+  memcpy(d,header2.packet,ex[1]);
+  d+=ex[1];
+  memcpy(d,header3.packet,ex[2]);
+  vorbis_comment_clear(&amp;VC);
+			
+  printf(&quot;\n[Vorbis]Vorbis encoder initialized\n&quot;);
+  switch(vorbisConf-&gt;mode)
+  {
+    case ADM_VORBIS_VBR:
+      printf(&quot;[Vorbis]CBR Bitrate:%lu\n&quot;,config-&gt;bitrate);
+      break;
+    case ADM_VORBIS_QUALITY: //FIXME FIXME FIXME
+      printf(&quot;[Vorbis]VBR Quality:%.1f\n&quot;,vorbisConf-&gt;quality);
+    break;
+    default:
+      ADM_assert(0);
+  }
+   
+  printf(&quot;[Vorbis]Channels  :%lu\n&quot;,_wavheader-&gt;channels);
+  printf(&quot;[Vorbis]Frequency :%lu\n&quot;,_wavheader-&gt;frequency);
+  return 1;
+}
+
+#define ROUNDMAX 3000
+
+uint8_t	AUDMEncoder_Vorbis::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
+{
+  uint32_t nbout;
+  uint32_t consumed=0;
+  float **float_samples;
+  ogg_packet op ;
+
+  *len = 0;
+  _chunk=1024*_wavheader-&gt;channels;
+  int count=ROUNDMAX;
+// Check that we have packet from previous pass
+  while(count--)
+  {
+    if(!refillBuffer(_chunk ))
+    {
+      return 0; 
+    }
+        
+    if(tmptail-tmphead&lt;_chunk)
+    {
+      return 0; 
+    }
+    
+	//printf(&quot;Round %d\n&quot;,ROUNDMAX-count);
+    if(vorbis_analysis_blockout(&amp;VD, &amp;VB) == 1) 
+    {
+      vorbis_analysis(&amp;VB, NULL);
+      vorbis_bitrate_addblock(&amp;VB) ;
+	//printf(&quot;Blockout\n&quot;);
+	
+      if(vorbis_bitrate_flushpacket(&amp;VD, &amp;op)) 
+      {
+        memcpy(dest, op.packet,op.bytes);
+        *len=op.bytes;
+        *samples=op.granulepos-_oldpos;
+        _oldpos=op.granulepos;
+        //  aprintf(&quot;1st packet :sampl:%lu len :%lu sample:%lu abs:%llu\n&quot;,*samples,op.bytes,total,op.granulepos);
+        return 1;
+      }
+    }
+
+    
+    uint32_t nbSample=(tmptail-tmphead)/_wavheader-&gt;channels;
+    if(nbSample&gt;1024) nbSample=1024;
+    float_samples=vorbis_analysis_buffer(&amp;VD, nbSample) ;
+    int index=tmphead;
+    // Put our samples in incoming buffer
+    reorderChannels(&amp;(tmpbuffer[tmphead]), nbSample,_incoming-&gt;getChannelMapping(),outputChannelMapping);
+    for (int i = 0; i &lt; nbSample; i++)
+      for (int j = 0; j &lt; _wavheader-&gt;channels; j++) {
+      float_samples[j][i] = tmpbuffer[index++];
+      if (float_samples[j][i] &gt; 1) float_samples[j][i] = 1;
+      if (float_samples[j][i] &lt; -1) float_samples[j][i] = -1;
+      }
+      // Buffer full, go go go
+      vorbis_analysis_wrote(&amp;VD, nbSample) ;  
+      tmphead+=nbSample*_wavheader-&gt;channels;	
+  }
+  return 0;
+	
+}
+/**
+      \fn DIA_getLameSettings
+      \brief Dialog to set lame settings
+      @return 1 on success, 0 on failure
+
+*/
+#include &quot;DIA_factory.h&quot;
+int DIA_getVorbisSettings(ADM_audioEncoderDescriptor *descriptor)
+  {
+    int ret=0;
+    char string[400];
+    uint32_t mmode,ppreset;
+    ELEM_TYPE_FLOAT qqual;
+#define SZT(x) sizeof(x)/sizeof(diaMenuEntry )
+#define PX(x) &amp;(lameParam-&gt;x)
+    
+    
+   VORBIS_encoderParam *vorbisParam;
+  ADM_assert(sizeof(VORBIS_encoderParam)==descriptor-&gt;paramSize);
+  vorbisParam=(VORBIS_encoderParam*)descriptor-&gt;param;
+  
+    mmode=vorbisParam-&gt;mode;
+    qqual=(ELEM_TYPE_FLOAT)vorbisParam-&gt;quality;
+    
+    diaMenuEntry channelMode[]={
+                             {ADM_VORBIS_VBR,      QT_TR_NOOP(&quot;VBR&quot;),NULL},
+                             {ADM_VORBIS_QUALITY,   QT_TR_NOOP(&quot;Quality based&quot;),NULL}};
+          
+    diaElemMenu menuMode(&amp;mmode,   QT_TR_NOOP(&quot;_Mode:&quot;), SZT(channelMode),channelMode);
+    
+#define BITRATE(x) {x,QT_TR_NOOP(#x)}
+    diaMenuEntry bitrateM[]={
+                              BITRATE(56),
+                              BITRATE(64),
+                              BITRATE(80),
+                              BITRATE(96),
+                              BITRATE(112),
+                              BITRATE(128),
+                              BITRATE(160),
+                              BITRATE(192),
+                              BITRATE(224)
+                          };
+    diaElemMenu bitrate(&amp;(descriptor-&gt;bitrate),   QT_TR_NOOP(&quot;_Bitrate:&quot;), SZT(bitrateM),bitrateM);
+    
+    diaElemFloat quality(&amp;qqual,QT_TR_NOOP(&quot;_Quality:&quot;),-1.,10.);
+    
+    
+    
+  
+      diaElem *elems[]={&amp;menuMode,&amp;bitrate,&amp;quality};
+    
+  if( diaFactoryRun(QT_TR_NOOP(&quot;Vorbis Configuration&quot;),3,elems))
+  {
+    vorbisParam-&gt;mode=(ADM_VORBIS_MODE)mmode;
+    vorbisParam-&gt;quality=(float)qqual;
+    
+    return 1;
+  }
+  return 0;
+}  
+
+#endif		
+// EOF

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_ad_plugin.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_ad_plugin.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiocodec/ADM_ad_plugin.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -5,7 +5,7 @@
 #ifndef ADM_ad_plugin_h
 #define ADM_ad_plugin_h
 #include &quot;ADM_default.h&quot;
-#include &quot;../ADM_audio/ADM_audiodef.h&quot;
+#include &quot;ADM_coreAudio/include/ADM_coreAudio.h&quot;
 #include &quot;ADM_audiocodec.h&quot;
 #include &quot;../ADM_audio/aviaudio.hxx&quot;
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiodevice/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiodevice/CMakeLists.txt	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiodevice/CMakeLists.txt	2008-07-16 17:39:39 UTC (rev 4221)
@@ -3,6 +3,7 @@
 	)
 
 ADD_ADM_LIB_ALL_TARGETS(ADM_audiodevice ${ADM_audiodevice_SRCS})
+INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/avidemux/ADM_coreAudio/include)
 
 #SDLify(ADM_deviceSDL.cpp)
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/CMakeLists.txt	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/CMakeLists.txt	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,24 +1,11 @@
 SET(ADMaudiofilter_SRCS 
-	audiodeng_buildfilters.cpp  audioencoder_lavcodec.cpp  audioeng_process.cpp           audiofilter_film2pal.cpp   audiolib_sox.cpp
-	audioencoder_aften.cpp      audioencoder_pcm.cpp       audiofilter_bridge.cpp         audiofilter_limiter.cpp    audio_raw.cpp
-	audioencoder.cpp            audioencoder_twolame.cpp   audiofilter_buildchain.cpp     audiofilter_mixer.cpp
-	audioencoder_faac.cpp       audioencoder_vorbis.cpp    audiofilter_normalize.cpp
-	audioencoder_lame.cpp       audioeng_buff.cpp          audiofilter_dolby.cpp          audiofilter_sox.cpp)
+	audiodeng_buildfilters.cpp    audioeng_process.cpp           audiofilter_film2pal.cpp   audiolib_sox.cpp
+	audiofilter_bridge.cpp         audiofilter_limiter.cpp    audio_raw.cpp
+	audiofilter_buildchain.cpp     audiofilter_mixer.cpp
+	audiofilter_normalize.cpp
+	audioeng_buff.cpp          audiofilter_dolby.cpp          audiofilter_sox.cpp)
 	
 ADD_ADM_LIB_ALL_TARGETS(ADM_audiofilter ${ADMaudiofilter_SRCS})
+INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/avidemux/ADM_coreAudio/include)
+INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/avidemux/ADM_audioEncoder/include)
 
-IF (USE_AFTEN)
-	ADD_SOURCE_CFLAGS(audioencoder_aften.cpp -I${AFTEN_INCLUDE_DIR})
-ENDIF (USE_AFTEN)
-
-IF (USE_FAAC)
-	ADD_SOURCE_CFLAGS(audioencoder_faac.cpp -I${FAAC_INCLUDE_DIR})
-ENDIF (USE_FAAC)
-
-IF (HAVE_LIBMP3LAME)
-	ADD_SOURCE_CFLAGS(audioencoder_lame.cpp -I${LAME_INCLUDE_DIR})
-ENDIF (HAVE_LIBMP3LAME)
-
-IF (USE_VORBIS)
-	ADD_SOURCE_CFLAGS(audioencoder_vorbis.cpp -I${VORBIS_INCLUDE_DIR})
-ENDIF (USE_VORBIS)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiodeng_buildfilters.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiodeng_buildfilters.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiodeng_buildfilters.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -29,7 +29,7 @@
 #include &quot;ADM_audiofilter/audioeng_buildfilters.h&quot;
 
 
-#include &quot;ADM_audiofilter/audioencoder.h&quot;
+#include &quot;audioencoder.h&quot;
 
 #include &quot;ADM_audiocodec/ADM_audiocodeclist.h&quot;
 

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,154 +0,0 @@
- 
-/***************************************************************************
-    copyright            : (C) 2002-6 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;math.h&gt;
-
-#include &quot;ADM_assert.h&quot;
-
-#include &quot;ADM_default.h&quot;
-
-#include &quot;audioprocess.hxx&quot;
-#include &quot;audioeng_process.h&quot;
-#include &quot;audioencoder.h&quot;
-
-AUDMEncoder::AUDMEncoder(AUDMAudioFilter *in)  :AVDMGenericAudioStream  ()
-{
-  _wavheader = new WAVHeader;
-  _incoming=in;
-  memcpy(_wavheader, _incoming-&gt;getInfo(), sizeof(WAVHeader));
-  _wavheader-&gt;encoding=WAV_AAC;
-  _incoming-&gt;rewind();	// rewind
-  _extraData=NULL;
-  _extraSize=0;
-  tmpbuffer=new float[_wavheader-&gt;frequency*_wavheader-&gt;channels];
-  tmphead=tmptail=0;
-  eof_met=0;
-  
-};
-/********************/
-AUDMEncoder::~AUDMEncoder()
-{
-  cleanup();
-};
-/********************/
-uint8_t AUDMEncoder::cleanup(void)
-{
-  if(_wavheader) delete(_wavheader);
-  _wavheader=NULL;
-
-  if(_extraData) delete [] _extraData;
-  _extraData=NULL;
-  
-  if(tmpbuffer) delete [] tmpbuffer;
-  tmpbuffer=NULL;
-};
-/********************/
-
-uint8_t AUDMEncoder::refillBuffer(int minimum)
-{
-  uint32_t filler=_wavheader-&gt;frequency*_wavheader-&gt;channels;
-  uint32_t nb;
-  AUD_Status status;
-  if(eof_met) return 0;
-  while(1)
-  {
-    ADM_assert(tmptail&gt;=tmphead);
-    if((tmptail-tmphead)&gt;=minimum) return 1;
-  
-    if(tmphead &amp;&amp; tmptail&gt;filler/2)
-    {
-      memmove(&amp;tmpbuffer[0],&amp;tmpbuffer[tmphead],(tmptail-tmphead)*sizeof(float)); 
-      tmptail-=tmphead;
-      tmphead=0;
-    }
-    ADM_assert(filler&gt;tmptail);
-    nb=_incoming-&gt;fill( (filler-tmptail)/2,&amp;tmpbuffer[tmptail],&amp;status);
-    if(!nb)
-    {
-      if(status!=AUD_END_OF_STREAM) ADM_assert(0);
-      
-      if((tmptail-tmphead)&lt;minimum)
-      {
-        memset(&amp;tmpbuffer[tmptail],0,sizeof(float)*(minimum-(tmptail-tmphead)));
-        tmptail=tmphead+minimum;
-        eof_met=1;  
-        return minimum;
-      }
-      else continue;
-    } else
-      tmptail+=nb;
-  }
-}
-
-
-/**
- * 	\fn reorderChannels
- *  \brief Reorder the channels
- */
-void AUDMEncoder::reorderChannels(float *data, uint32_t nb,CHANNEL_TYPE *input,CHANNEL_TYPE *output)
-{
-	float tmp [_wavheader-&gt;channels];
-	static uint8_t reorder[MAX_CHANNELS];
-	static bool reorder_on;
-	
-	
-		reorder_on = 0;
-		int j = 0;
-		// Should we reorder the channels (might be needed for encoder ?
-		if (_wavheader-&gt;channels &gt; 2) 
-		{
-			CHANNEL_TYPE *p_ch_type;
-			for (int i = 0; i &lt; _wavheader-&gt;channels; i++) 
-			{
-				for (int c = 0; c &lt; _wavheader-&gt;channels; c++) 
-				{
-					if (input[c] == output[i]) 
-					{
-						if (j != c)
-							reorder_on = 1;
-						reorder[j++] = c;
-					}
-				}
-			}
-		}
-	
-
-	if (reorder_on)
-		for (int i = 0; i &lt; nb; i++) {
-			memcpy(tmp, data, sizeof(tmp));
-			for (int c = 0; c &lt; _wavheader-&gt;channels; c++)
-				*data++ = tmp[reorder[c]];
-		}
-
-}
-
-uint32_t AUDMEncoder::read(uint32_t len,uint8_t *buffer)
-{
-  ADM_assert(0);
-  return 0; 
-}
-
-uint32_t AUDMEncoder::grab(uint8_t * obuffer)
-{
-  uint32_t len,sam;
-  if(getPacket(obuffer,&amp;len,&amp;sam))
-    return len;
-  return MINUS_ONE;
-}
-
-//EOF

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,75 +0,0 @@
-/***************************************************************************
-    copyright            : (C) 2006 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-
-#ifndef AUDIO_ENCODER_H
-#define AUDIO_ENCODER_H
-/*!
-  This structure defines an audio encoder
-  \param encoder Encoder attached to this descriptor
-   \param name The name of the codec
-  \param bitrate The bitrate in kb/s
-  \param configure Function to call to configure the codec
-  \param maxChannels The maximum # of channels this codec supports
-  \param param : An opaque structure that contains the codec specific configuration datas
-*/
-#include &quot;ADM_coreAudio.h&quot;
-#include &quot;audioeng_buildfilters.h&quot;
-
-typedef struct ADM_audioEncoderDescriptor
-{
-  AUDIOENCODER encoder;
-  int       (*configure)(ADM_audioEncoderDescriptor *descritor);
-  const     char *name;
-  uint32_t  bitrate;
-  uint32_t  maxChannels;
-  uint32_t  paramSize;
-  void     *param;
-} ADM_audioEncoderDescriptor;
-
-/*!
-  Base class for all audio encoder.It does the reverse of the bridge class and offers a proper GenericAudioStreamAPI
-
-*/
-
- //_____________________________________________
-class AUDMEncoder : public AVDMGenericAudioStream
-{
-  protected:
-    //
-    uint32_t grab(uint8_t *outbuffer);
-    uint32_t grab(float *outbuffer) {ADM_assert(0);return 1;}
-    uint32_t  eof_met;
-    uint32_t  _chunk;
-    //
-    uint8_t         *_extraData;
-    uint32_t        _extraSize;
-    AUDMAudioFilter *_incoming;
-    uint8_t         cleanup(void);
-    
-    float          *tmpbuffer;
-    uint8_t        refillBuffer(int minimum); // Mininum is in float
-
-    
-    void reorderChannels(float *data, uint32_t nb,CHANNEL_TYPE *input,CHANNEL_TYPE *output);
-
-    uint32_t       tmphead,tmptail;
-    // The encoder can remap the audio channel (or not). If so, let's store the the configuration here
-    CHANNEL_TYPE outputChannelMapping[MAX_CHANNELS];
-  public:
-    //
-    uint32_t read(uint32_t len,uint8_t *buffer);
-    uint32_t read(uint32_t len,float *buffer) {ADM_assert(0);return 1;}
-    //
-    virtual ~AUDMEncoder();
-    AUDMEncoder(AUDMAudioFilter *in);	
-    virtual uint8_t init(ADM_audioEncoderDescriptor *config)=0;
-    virtual uint8_t getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)=0;
-    virtual uint8_t packetPerFrame( void) {return 1;}
-    virtual uint8_t extraData(uint32_t *l,uint8_t **d) {*l=_extraSize;*d=_extraData;return 1;}
-            uint8_t  goTo(uint32_t timeMS) {ADM_assert(0);return 1;}
-};
-
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,166 +0,0 @@
-
-/***************************************************************************
-    copyright            : (C) 2002-6 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
-
-    Interface to Aften
-
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-#ifdef USE_AFTEN
-#include &quot;config.h&quot;
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;math.h&gt;
-
-
-#include &quot;ADM_default.h&quot;
-
-#include &quot;audioprocess.hxx&quot;
-#include &quot;audioeng_process.h&quot;
-#include &quot;audioencoder.h&quot;
-//
-extern &quot;C&quot;
-{
-#if defined(USE_AFTEN_06)
-	#include &quot;aften.h&quot;
-#else	// Aften 0.05 &amp; 0.07 onwards
-	#include &quot;aften/aften.h&quot;
-#endif
-};
-#include &quot;ADM_audiofilter/audioencoder_aften_param.h&quot;
-#include &quot;ADM_audiofilter/audioencoder_aften.h&quot;
-
-#define _HANDLE ((AftenContext *)_handle)
-AUDMEncoder_Aften::AUDMEncoder_Aften(AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
-{
-  uint32_t channels;
-  channels=instream-&gt;getInfo()-&gt;channels;
-  _handle=(void *)new AftenContext;
-  memset(_handle,0,sizeof(AftenContext));
-  aften_set_defaults(_HANDLE);
-  _wavheader-&gt;encoding=WAV_AC3;
-#if defined(USE_AFTEN_05) || defined(USE_AFTEN_06)
-#elif defined(USE_AFTEN_07)
-  _HANDLE-&gt;params.n_threads=1; // MThread collides with avidemux multithreading
-#else
-  _HANDLE-&gt;system.n_threads=1;
-#endif
-};
-
-
-AUDMEncoder_Aften::~AUDMEncoder_Aften()
-{
-    if(_handle)
-      aften_encode_close(_HANDLE);
-    delete(_HANDLE);
-    _handle=NULL;
-
-    printf(&quot;[Aften] Deleting aften\n&quot;);
-    cleanup();
-};
-
-
-//________________________________________________
-//   Init lame encoder
-// frequence    : Impose frequency , 0 means reuse the incoming fq
-// mode                         : ADM_STEREO etc...
-// bitrate              : Bitrate in kbps (96,192...)
-// return 0 : init failed
-//                              1 : init succeeded
-//_______________________________________________
-uint8_t AUDMEncoder_Aften::init(ADM_audioEncoderDescriptor *config)
-{
-
-
-int ret=0;
-
-#if defined(USE_AFTEN_05) || defined(USE_AFTEN_06)
-int mask;
-#else
-unsigned int mask;
-#endif
-
-    _wavheader-&gt;byterate=(config-&gt;bitrate*1000)/8;
-    _HANDLE-&gt;sample_format=A52_SAMPLE_FMT_FLT;
-    _HANDLE-&gt;channels=_wavheader-&gt;channels;
-    _HANDLE-&gt;samplerate=_wavheader-&gt;frequency;
-    
-    _HANDLE-&gt;params.bitrate=config-&gt;bitrate;
-    switch(_wavheader-&gt;channels)
-    {
-        case 1: mask = 0x04;  break;
-        case 2: mask = 0x03;  break;
-        case 3: mask = 0x07;  break;
-        case 4: mask = 0x107; break;
-        case 5: mask = 0x37;  break;
-        case 6: mask = 0x3F;  break;
-      }
-
-#if defined(USE_AFTEN_05) || defined(USE_AFTEN_06)
-	aften_wav_chmask_to_acmod(_wavheader-&gt;channels, mask, &amp;(_HANDLE-&gt;acmod), &amp;(_HANDLE-&gt;lfe));
-#else
-	aften_wav_channels_to_acmod(_wavheader-&gt;channels, mask, &amp;(_HANDLE-&gt;acmod), &amp;(_HANDLE-&gt;lfe));
-#endif
-
-   //   _HANDLE-&gt;params.verbose=2;
-    int er= aften_encode_init(_HANDLE);
-    if(er&lt;0)
-    {
-      printf(&quot;[Aften] init error %d\n&quot;,er); 
-      return 0;
-    }
-    _chunk=256*6*_wavheader-&gt;channels;
-    printf(&quot;[Aften] Initialized with fd %u Channels %u bitrate %u\n&quot;,_HANDLE-&gt;samplerate,
-                                                                    _HANDLE-&gt;channels,_HANDLE-&gt;params.bitrate);
-    return 1;
-}
-
-
-//______________________________________________
-uint8_t	AUDMEncoder_Aften::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
-{
-  uint32_t count=0;
-  int r;
-  void *ptr;
-_again:
-        *len = 0;
-        _chunk=256*6*_wavheader-&gt;channels;
-        if(!refillBuffer(_chunk ))
-        {
-          return 0; 
-        }
-        ptr=(void *)&amp;(tmpbuffer[tmphead]);
-        ADM_assert(tmptail&gt;=tmphead);
-
-#ifdef USE_AFTEN_05
-		aften_remap_wav_to_a52(ptr, 256*6, _wavheader-&gt;channels, A52_SAMPLE_FMT_FLT, _HANDLE-&gt;acmod, _HANDLE-&gt;lfe);
-#else
-		aften_remap_wav_to_a52(ptr, 256*6, _wavheader-&gt;channels, A52_SAMPLE_FMT_FLT, _HANDLE-&gt;acmod);
-#endif
-
-        r=aften_encode_frame(_HANDLE, dest,(void *)ptr);
-        if(r&lt;0)
-        {
-          printf(&quot;[Aften] Encoding error %d\n&quot;,r);
-          return 0; 
-        }
-        
-        *samples=256*6;
-        *len=r;
-        tmphead+=_chunk;
-        return 1;
-}
-
-#endif		
-// EOF

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,31 +0,0 @@
-
-/***************************************************************************
-    copyright            : (C) 2002-6 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef AUDMaudioAften
-#define AUDMaudioAften
-#ifdef USE_AFTEN
- //_____________________________________________
-class AUDMEncoder_Aften : public AUDMEncoder
-{
-protected:
-         void           *_handle;
-         
-public:
-                        uint8_t init(ADM_audioEncoderDescriptor *config);
-                virtual ~AUDMEncoder_Aften();
-                        AUDMEncoder_Aften(AUDMAudioFilter *instream);	
-                virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
-};
-#endif
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften_param.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften_param.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_aften_param.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,10 +0,0 @@
-#ifndef AUDM_AFTEN_PARAM_H
-#define AUDM_AFTEN_PARAM_H
-#ifdef USE_AFTEN
-
-typedef struct AFTEN_encoderParam
-{
-  ADM_mode        mode;
-};
-#endif
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_config.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_config.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_config.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,180 +0,0 @@
-#ifndef AUDIOENCODER_CONFIG_H
-#define AUDIOENCODER_CONFIG_H
-
-#include &quot;audioencoder_faac_param.h&quot;
-#include &quot;audioencoder_lame_param.h&quot;
-#include &quot;audioencoder_twolame_param.h&quot;
-#include &quot;audioencoder_vorbis_param.h&quot;
-#include &quot;audioencoder_aften_param.h&quot;
-
-
-
-extern int DIA_defaultSettings(ADM_audioEncoderDescriptor *descriptor);
-/**** Copy ****/
-
-ADM_audioEncoderDescriptor copyDescriptor=
-{
-  AUDIOENC_COPY,
-  DIA_defaultSettings,
-  &quot;Copy encoder&quot;,
-  128,
-  99,
-  0,
-  NULL
-};
-/**** FAAC ****/
-#ifdef USE_FAAC
-FAAC_encoderParam aacParam={128};
-ADM_audioEncoderDescriptor aacDescriptor=
-{
-        AUDIOENC_FAAC,
-        DIA_defaultSettings,
-        &quot;FAAC encoder&quot;,
-        128,
-        6,      // AAC can do 5.1
-        sizeof(aacParam),
-        &amp;aacParam
-};
-#endif
-/**** LAME ****/
-LAME_encoderParam lameParam=
-{
-  ADM_LAME_PRESET_CBR,
-  ADM_STEREO,
-  2,
-  0 /* Reservoir enable by default */
-};
-#ifdef HAVE_LIBMP3LAME
-extern int DIA_getLameSettings(ADM_audioEncoderDescriptor *descriptor);
-ADM_audioEncoderDescriptor  lameDescriptor=
-{
-  AUDIOENC_MP3,
-  DIA_getLameSettings,
-  &quot;Lame encoder&quot;,
-  128,
-  2,      // Lame can only do stereo
-  sizeof(lameParam),
-  &amp;lameParam
-};
-#endif
-/**** TWOLAME ****/
-TWOLAME_encoderParam twolameParam=
-{
-  ADM_STEREO
-};
-ADM_audioEncoderDescriptor  twolameDescriptor=
-{
-  AUDIOENC_2LAME,
-  DIA_defaultSettings,
-  &quot;TwoLame encoder&quot;,
-  128,
-  2,      // Lame can only do stereo
-  sizeof(twolameParam),
-  &amp;twolameParam
-};
-/********** Lavcodec **************/
-ADM_audioEncoderDescriptor  lavcodecMP2Descriptor=
-{
-  AUDIOENC_MP2,
-  DIA_defaultSettings,
-  &quot;LAvcodec MP2 encoder&quot;,
-  128,
-  2,    
-  0,
-  NULL
-};
-ADM_audioEncoderDescriptor  lavcodecAC3Descriptor=
-{
-  AUDIOENC_AC3,
-  DIA_defaultSettings,
-  &quot;LAvcodec AC3 encoder&quot;,
-  128,
-  6,    
-  0,
-  NULL
-};
-
-/************** Vorbis **************/
-#ifdef USE_VORBIS
-extern int DIA_getVorbisSettings(ADM_audioEncoderDescriptor *descriptor);
-VORBIS_encoderParam vorbisParam=
-{
-  ADM_VORBIS_VBR,
-  3
-  
-};
-ADM_audioEncoderDescriptor  vorbisDescriptor=
-{
-  AUDIOENC_VORBIS,
-  DIA_getVorbisSettings,
-  &quot;Vorbis encoder&quot;,
-  128,
-  6,      // Lame can only do stereo
-  sizeof(vorbisParam),
-  &amp;vorbisParam
-};
-#endif
-/********** PCM **************/
-ADM_audioEncoderDescriptor  pcmDescriptor=
-{
-  AUDIOENC_NONE,
-  NULL,
-  &quot;PCM encoder&quot;,
-  128,
-  6,    
-  0,
-  NULL
-};
-ADM_audioEncoderDescriptor  lpcmDescriptor=
-{
-  AUDIOENC_LPCM,
-  NULL,
-  &quot;LPCM encoder&quot;,
-  128,
-  6,    
-  0,
-  NULL
-};
-//---------------- AFTEN ------------------
-#ifdef USE_AFTEN
-AFTEN_encoderParam aftenParam =
-{
-  ADM_STEREO
-};
-
-ADM_audioEncoderDescriptor  aftenDescriptor=
-{
-  AUDIOENC_AFTEN,
-  DIA_defaultSettings,
-  &quot;Aften AC3 encoder&quot;,
-  128,
-  6,      // Lame can only do stereo
-  sizeof(aftenParam),
-  &amp;aftenParam
-};
-#endif
-ADM_audioEncoderDescriptor *allDescriptors[]=
-{
-      &amp;copyDescriptor,
-#ifdef USE_FAAC
-      &amp;aacDescriptor,
-#endif
-      &amp;twolameDescriptor,
-      &amp;lavcodecAC3Descriptor,
-      &amp;lavcodecMP2Descriptor,
-#ifdef USE_VORBIS
-      &amp;vorbisDescriptor ,
-#endif      
-      &amp;pcmDescriptor,
-      &amp;lpcmDescriptor
-#ifdef USE_AFTEN
-      ,&amp;aftenDescriptor
-#endif
-#ifdef HAVE_LIBMP3LAME
-      ,&amp;lameDescriptor
-#endif
-};
-#define NB_AUDIO_DESCRIPTOR (sizeof(allDescriptors)/sizeof(ADM_audioEncoderDescriptor *))
-#endif
-//EOF
-

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,223 +0,0 @@
-
-/***************************************************************************
-    copyright            : (C) 2002-6 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
-
-    Interface to FAAC
-
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-#ifdef USE_FAAC
-#include &quot;config.h&quot;
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;math.h&gt;
-
-
-#include &quot;ADM_default.h&quot;
-
-#include &quot;audioprocess.hxx&quot;
-#include &quot;audioeng_process.h&quot;
-#include &quot;audioencoder.h&quot;
-//
-
-#include &quot;faac.h&quot;
-#include &quot;ADM_audiofilter/audioencoder_faac.h&quot;
-
-AUDMEncoder_Faac::AUDMEncoder_Faac(AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
-{
-  uint32_t channels;
-  channels=instream-&gt;getInfo()-&gt;channels;
-  switch(channels)
-  {
-    case 1:outputChannelMapping[1] = CH_FRONT_LEFT;break;
-    case 2:
-    	outputChannelMapping[0] = CH_FRONT_LEFT;
-    	outputChannelMapping[1] = CH_FRONT_RIGHT;
-      break;
-    default :
-    	outputChannelMapping[0] = CH_FRONT_CENTER;
-    	outputChannelMapping[1] = CH_FRONT_LEFT;
-    	outputChannelMapping[2] = CH_FRONT_RIGHT;
-    	outputChannelMapping[3] = CH_REAR_LEFT;
-    	outputChannelMapping[4] = CH_REAR_RIGHT;
-    	outputChannelMapping[5] = CH_LFE;
-  }
-};
-
-
-AUDMEncoder_Faac::~AUDMEncoder_Faac()
-{
-    if(_handle)
-        faacEncClose(_handle);
-    _handle=NULL;
-
-    printf(&quot;[FAAC] Deleting faac\n&quot;);
-    cleanup();
-};
-
-
-//________________________________________________
-//   Init lame encoder
-// frequence    : Impose frequency , 0 means reuse the incoming fq
-// mode                         : ADM_STEREO etc...
-// bitrate              : Bitrate in kbps (96,192...)
-// return 0 : init failed
-//                              1 : init succeeded
-//_______________________________________________
-uint8_t AUDMEncoder_Faac::init(ADM_audioEncoderDescriptor *config)
-{
-unsigned long int samples_input, max_bytes_output;
-faacEncConfigurationPtr cfg;
-int ret=0;
-
-    printf(&quot;[FAAC] Incoming Fq :%u\n&quot;,_wavheader-&gt;frequency);
-     _handle = faacEncOpen(_wavheader-&gt;frequency,
-                                 _wavheader-&gt;channels,
-                                 &amp;samples_input,
-                                &amp;max_bytes_output);
-    if(!_handle)
-    {
-          printf(&quot;Cannot open faac with fq=%lu chan=%lu br=%lu\n&quot;,
-          _wavheader-&gt;frequency,_wavheader-&gt;channels,config-&gt;bitrate);
-          return 0;
-    }
-    printf(&quot; [FAAC] : Sample input:%d, max byte output%d \n&quot;,samples_input,max_bytes_output);
-    cfg= faacEncGetCurrentConfiguration(_handle);
-    
-    // Set default conf, same as ffmpeg
-    cfg-&gt;aacObjectType = LOW;
-    cfg-&gt;mpegVersion = MPEG4;
-    cfg-&gt;bandWidth= (_wavheader-&gt;frequency*3)/4; // Should be relevant
-    cfg-&gt;useTns = 0;
-    cfg-&gt;allowMidside = 0;
-    cfg-&gt;bitRate = (config-&gt;bitrate*1000)/_wavheader-&gt;channels; // It is per channel
-    cfg-&gt;outputFormat = 0; // 0 Raw 1 ADTS
-    cfg-&gt;inputFormat = FAAC_INPUT_FLOAT;
-    cfg-&gt;useLfe=0;	
-    if (!(ret=faacEncSetConfiguration(_handle, cfg))) 
-    {
-        printf(&quot;[FAAC] Cannot set conf for faac with fq=%lu chan=%lu br=%lu (err:%d)\n&quot;,
-				_wavheader-&gt;frequency,_wavheader-&gt;channels,config-&gt;bitrate,ret);
-	return 0;
-    }
-     unsigned char *data=NULL;
-     unsigned long size=0;
-     if((ret=faacEncGetDecoderSpecificInfo(_handle, &amp;data,&amp;size)))
-     {
-        printf(&quot;FAAC: GetDecoderSpecific info failed (err:%d)\n&quot;,ret);
-        return 0;
-     }
-     _extraSize=size;
-     _extraData=new uint8_t[size];
-     memcpy(_extraData,data,size);
-
-    // update
-     _wavheader-&gt;byterate=(config-&gt;bitrate*1000)/8;
-//    _wavheader-&gt;dwScale=1024;
-//    _wavheader-&gt;dwSampleSize=0;
-    _wavheader-&gt;blockalign=4096;
-    _wavheader-&gt;bitspersample=0;
-
-    _chunk=samples_input;
-
-
-    printf(&quot;[Faac] Initialized :\n&quot;);
-    
-    printf(&quot;[Faac]Version        : %s\n&quot;,cfg-&gt;name);
-    printf(&quot;[Faac]Bitrate        : %lu\n&quot;,cfg-&gt;bitRate);
-    printf(&quot;[Faac]Mpeg2 (1)/4(0) : %u\n&quot;,cfg-&gt;mpegVersion);
-    printf(&quot;[Faac]Use lfe      ) : %u\n&quot;,cfg-&gt;useLfe);
-    printf(&quot;[Faac]Sample output  : %lu\n&quot;,_chunk / _wavheader-&gt;channels);
-    printf(&quot;[Faac]Bitrate        : %lu\n&quot;,cfg-&gt;bitRate*_wavheader-&gt;channels);
-
-    
-    return 1;
-}
-
-//_____________________________________________
-//  Need to multiply the float by 32767, can't use
-//  generic fill buffer
-//----------------------------------------------
-uint8_t AUDMEncoder_Faac::refillBuffer(int minimum)
-{
-  uint32_t filler=_wavheader-&gt;frequency*_wavheader-&gt;channels;
-  uint32_t nb;
-  AUD_Status status;
-  if(eof_met) return 0;
-  while(1)
-  {
-    ADM_assert(tmptail&gt;=tmphead);
-    if((tmptail-tmphead)&gt;=minimum) return 1;
-  
-    if(tmphead &amp;&amp; tmptail&gt;filler/2)
-    {
-      memmove(&amp;tmpbuffer[0],&amp;tmpbuffer[tmphead],(tmptail-tmphead)*sizeof(float)); 
-      tmptail-=tmphead;
-      tmphead=0;
-    }
-    ADM_assert(filler&gt;tmptail);
-    nb=_incoming-&gt;fill( (filler-tmptail)/2,&amp;tmpbuffer[tmptail],&amp;status);
-    if(!nb)
-    {
-      if(status!=AUD_END_OF_STREAM) ADM_assert(0);
-      
-      if((tmptail-tmphead)&lt;minimum)
-      {
-        memset(&amp;tmpbuffer[tmptail],0,sizeof(float)*(minimum-(tmptail-tmphead)));
-        tmptail=tmphead+minimum;
-        eof_met=1;  
-        return minimum;
-      }
-      else continue;
-    } else
-    {
-      float *s=&amp;(tmpbuffer[tmptail]);
-      for(int i=0;i&lt;nb;i++)
-      {
-        *s=*s*32767.;
-        s++;
-      }
-      tmptail+=nb;
-    }
-  }
-}
-
-#define FA_BUFFER_SIZE (SIZE_INTERNAL/4)
-//______________________________________________
-uint8_t	AUDMEncoder_Faac::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
-{
-  uint32_t count=0;
-_again:
-        *samples = _chunk/_wavheader-&gt;channels;
-        *len = 0;
-
-        if(!refillBuffer(_chunk ))
-        {
-          return 0; 
-        }
-        ADM_assert(tmptail&gt;=tmphead);
-        reorderChannels(&amp;(tmpbuffer[tmphead]),*samples,_incoming-&gt;getChannelMapping(),outputChannelMapping);
-        *len = faacEncEncode(_handle, (int32_t *)&amp;(tmpbuffer[tmphead]), _chunk, dest, FA_BUFFER_SIZE);
-        if(!*len) 
-        {
-          count++;
-          if(count&lt;20)
-            goto _again;
-          *samples=0;
-        }
-        tmphead+=_chunk;
-        return 1;
-}
-#endif		
-// EOF

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,31 +0,0 @@
-
-/***************************************************************************
-    copyright            : (C) 2002-6 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef AUDMaudioAAC
-#define AUDMaudioAAC
-
- //_____________________________________________
-class AUDMEncoder_Faac : public AUDMEncoder
-{
-protected:
-         void           *_handle;
-         uint8_t        refillBuffer(int minimum);
-public:
-                        uint8_t init(ADM_audioEncoderDescriptor *config);
-                virtual ~AUDMEncoder_Faac();
-                        AUDMEncoder_Faac(AUDMAudioFilter *instream);	
-                virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
-};
-
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac_param.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac_param.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_faac_param.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,8 +0,0 @@
-
-#ifndef FAAC_PARAM_H
-#define FAAC_PARAM_H
-typedef struct 
-{
-  uint32_t dummy;
-}FAAC_encoderParam;
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,258 +0,0 @@
-/***************************************************************************
-    copyright            : (C) 2006 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-
-#ifdef HAVE_LIBMP3LAME
-#include &lt;lame/lame.h&gt;
-
-#include &quot;ADM_default.h&quot;
-#include &quot;audioprocess.hxx&quot;
-#include &quot;audioeng_process.h&quot;
-#include &quot;audioencoder.h&quot;
-
-#include &quot;ADM_audiofilter/audioencoder_lame_param.h&quot;
-#include &quot;ADM_audiofilter/audioencoder_lame.h&quot;
-
-
-
-#define MYFLAGS (lame_global_flags *)lameFlags
-
-AUDMEncoder_Lame::AUDMEncoder_Lame(AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
-{
-  printf(&quot;[Lame] Creating lame\n&quot;);
-  lameFlags=NULL;
-  _wavheader-&gt;encoding=WAV_MP3;
-};
-
-AUDMEncoder_Lame::~AUDMEncoder_Lame()
-{
-  printf(&quot;[Lame] Deleting lame\n&quot;);
-  if(lameFlags)
-  {
-    lame_close(MYFLAGS);
-  }
-  lameFlags=NULL;
-  cleanup();
-};
-
-
-//________________________________________________
-//   Init lame encoder
-// frequence    : Impose frequency , 0 means reuse the incoming fq
-// mode                         : ADM_STEREO etc...
-// bitrate              : Bitrate in kbps (96,192...)
-// return 0 : init failed
-//                              1 : init succeeded
-//_______________________________________________
-uint8_t AUDMEncoder_Lame::init(ADM_audioEncoderDescriptor *config)
-{
-  int ret;
-  MPEG_mode_e mmode;
-  uint32_t frequence;
-  LAME_encoderParam *lameConf=(LAME_encoderParam *)config-&gt;param;
-      ADM_assert(config-&gt;paramSize==sizeof(LAME_encoderParam));
-
-      lameFlags = lame_init();
-      if (lameFlags == NULL)
-          return 0;
-      
-      if(_incoming-&gt;getInfo()-&gt;channels&gt;2)
-      {
-        printf(&quot;Too many channels\n&quot;);
-        return 0; 
-      }
-
-	// recompute output length
-	
-      
-      ret = lame_set_in_samplerate(MYFLAGS, _wavheader-&gt;frequency);
-      ret = lame_set_num_channels(MYFLAGS, _wavheader-&gt;channels);
-
-    
-      frequence = _wavheader-&gt;frequency;
-    printf(&quot;\n output frequency : %lu\n&quot;, frequence);
-    ret = lame_set_out_samplerate(MYFLAGS, frequence);
-
-    ret = lame_set_quality(MYFLAGS, 2);
-    
-    if (_wavheader-&gt;channels == 2)
-      {
-        switch (lameConf-&gt;mode)
-	    {
-	    case ADM_STEREO:
-		mmode = STEREO;
-		break;
-	    case ADM_JSTEREO:
-		mmode = JOINT_STEREO;
-		break;
-	    default:
-		printf(&quot;\n **** unknown mode ***\n&quot;);
-		mmode = STEREO;
-		break;
-
-	    }
-    } else
-    {
-		mmode = MONO;
-     	printf(&quot;\n mono audio mp3&quot;);
-  	}
-
-        ret = lame_set_brate(MYFLAGS, config-&gt;bitrate);
-        ret = lame_set_mode(MYFLAGS, mmode);	// 0 stereo 1 jstero
-        ret = lame_set_quality(MYFLAGS, lameConf-&gt;quality);	// 0 stereo 1 jstero
-        ret = lame_set_disable_reservoir(MYFLAGS,lameConf-&gt;disableReservoir);
-        printf(&quot;[Lame]Using quality of %d\n&quot;,lame_get_quality(MYFLAGS));
-        ret = lame_init_params(MYFLAGS);
-    if (ret == -1)
-	return 0;
-    // update bitrate in header
-    _wavheader-&gt;byterate = (config-&gt;bitrate &gt;&gt; 3) * 1000;
-#define BLOCK_SIZE 1152
-    // configure CBR/ABR/...
-    _preset=lameConf-&gt;preset;
-    switch(_preset)
-    {
-    	default:
-    	case ADM_LAME_PRESET_CBR: 
-          break;
-	case ADM_LAME_PRESET_ABR:
-	  
-          lame_set_preset( MYFLAGS, config-&gt;bitrate);
-	  _wavheader-&gt;blockalign=BLOCK_SIZE;
-	 break;
-	case ADM_LAME_PRESET_EXTREME: 
-	  _wavheader-&gt;blockalign=BLOCK_SIZE;
-          lame_set_preset( MYFLAGS, EXTREME);	
-	break;
-    
-    
-    }
-
-    lame_print_config(MYFLAGS);
-    lame_print_internals(MYFLAGS);
-    _chunk=BLOCK_SIZE*_wavheader-&gt;channels;
-    return 1;
-}
-uint8_t	AUDMEncoder_Lame::isVBR(void )
-{
-	if(_preset==ADM_LAME_PRESET_CBR) return 0;
-	return 1;
-
-}
-
-uint8_t	AUDMEncoder_Lame::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
-{
-  int32_t nbout;
-  
-        *samples = BLOCK_SIZE; //FIXME
-        *len = 0;
-
-        if(!refillBuffer(_chunk ))
-        {
-          return 0; 
-        }
-        
-        if(tmptail-tmphead&lt;_chunk)
-        {
-          return 0; 
-        }
-        dither16(&amp;(tmpbuffer[tmphead]),_chunk,_wavheader-&gt;channels);
-        ADM_assert(tmptail&gt;=tmphead);
-        if (_wavheader-&gt;channels == 1)
-        {
-          nbout = lame_encode_buffer(MYFLAGS, (int16_t *)&amp;(tmpbuffer[tmphead]),(int16_t *)&amp;(tmpbuffer[tmphead]), _chunk, dest, 16 * 1024);
-          
-        }
-        else
-        {
-          nbout = lame_encode_buffer_interleaved(MYFLAGS, (int16_t *)&amp;(tmpbuffer[tmphead]), _chunk/2, dest, 16 * 1024);
-        }
-        tmphead+=_chunk;
-        if (nbout &lt; 0) {
-          printf(&quot;\n Error !!! : %ld\n&quot;, nbout);
-          return 0;
-        }
-        *len=nbout;
-        if(!*len) *samples=0;
-        //printf(&quot;Audio packet : size %u, sample %u\n&quot;,*len,*samples);
-        return 1;
-}
-/**
-      \fn DIA_getLameSettings
-      \brief Dialog to set lame settings
-      @return 1 on success, 0 on failure
-
-*/
-#include &quot;DIA_factory.h&quot;
-int DIA_getLameSettings(ADM_audioEncoderDescriptor *descriptor)
-  {
-    int ret=0;
-    char string[400];
-    uint32_t mmode,ppreset;
-#define SZT(x) sizeof(x)/sizeof(diaMenuEntry )
-#define PX(x) &amp;(lameParam-&gt;x)
-    
-    
-    LAME_encoderParam *lameParam;
-    ADM_assert(sizeof(LAME_encoderParam)==descriptor-&gt;paramSize);
-  
-    lameParam=(LAME_encoderParam*)descriptor-&gt;param;
-    mmode=lameParam-&gt;mode;
-    ppreset=lameParam-&gt;preset;
-    diaMenuEntry channelMode[]={
-                             {ADM_STEREO,      QT_TR_NOOP(&quot;Stereo&quot;),NULL},
-                             {ADM_JSTEREO,   QT_TR_NOOP(&quot;Joint stereo&quot;),NULL},
-                             {ADM_MONO,      QT_TR_NOOP(&quot;Mono&quot;),NULL}};
-          
-    diaElemMenu menuMode(&amp;mmode,   QT_TR_NOOP(&quot;C_hannel mode:&quot;), SZT(channelMode),channelMode);
-    
-    diaMenuEntry encodingMode[]={
-                             {ADM_LAME_PRESET_CBR,      QT_TR_NOOP(&quot;CBR&quot;),NULL},
-                             {ADM_LAME_PRESET_ABR,   QT_TR_NOOP(&quot;ABR&quot;),NULL},
-#if 0
-                             {ADM_LAME_PRESET_EXTREME,      QT_TR_NOOP(&quot;Extreme&quot;),NULL}
-#endif
-    }; 
-    diaElemMenu Mode(&amp;ppreset,   QT_TR_NOOP(&quot;Bit_rate mode:&quot;), SZT(encodingMode),encodingMode);
-#define BITRATE(x) {x,QT_TR_NOOP(#x)}
-    diaMenuEntry bitrateM[]={
-                              BITRATE(56),
-                              BITRATE(64),
-                              BITRATE(80),
-                              BITRATE(96),
-                              BITRATE(112),
-                              BITRATE(128),
-                              BITRATE(160),
-                              BITRATE(192),
-                              BITRATE(224)
-                          };
-    diaElemMenu bitrate(&amp;(descriptor-&gt;bitrate),   QT_TR_NOOP(&quot;_Bitrate:&quot;), SZT(bitrateM),bitrateM);
-    
-    
-    
-    
-    diaElemUInteger quality(PX(quality),QT_TR_NOOP(&quot;_Quality:&quot;),0,9);
-    diaElemToggle reservoir(PX(disableReservoir),QT_TR_NOOP(&quot;_Disable reservoir:&quot;));
-  
-      diaElem *elems[]={&amp;menuMode,&amp;Mode,&amp;quality,&amp;bitrate,&amp;reservoir};
-    
-  if( diaFactoryRun(QT_TR_NOOP(&quot;LAME Configuration&quot;),5,elems))
-  {
-    lameParam-&gt;mode=(ADM_mode)mmode; 
-    lameParam-&gt;preset=(ADM_LAME_PRESET)ppreset;
-    return 1;
-  }
-  return 0;
-}  
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,35 +0,0 @@
-
-/***************************************************************************
-    copyright            : (C) 2002-6 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef AUDMaudioLame
-#define AUDMaudioLame
-
- //_____________________________________________
-class AUDMEncoder_Lame : public AUDMEncoder
-{
-  protected:
-   
-    void              *lameFlags;
-    ADM_LAME_PRESET   _preset;
-         
-  public:
-            uint8_t     init(ADM_audioEncoderDescriptor *config);
-    virtual             ~AUDMEncoder_Lame();
-                        AUDMEncoder_Lame(AUDMAudioFilter *instream);	
-            uint8_t	isVBR(void );
-            
-   virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
-};
-
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame_param.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame_param.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lame_param.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,31 +0,0 @@
-#ifndef AUDM_LAME_PARAM_H
-#define AUDM_LAME_PARAM_H
-
-typedef enum 
-{
-  ADM_LAME_PRESET_CBR,
-  ADM_LAME_PRESET_ABR,
-  ADM_LAME_PRESET_EXTREME
-}ADM_LAME_PRESET;
-
-typedef struct 
-{
-  ADM_LAME_PRESET preset;
-  const char	*name;
-}ADM_PRESET_DEFINITION;
-static const ADM_PRESET_DEFINITION      presetDefinition[]=
-{
-  {ADM_LAME_PRESET_CBR,&quot;CBR&quot;},
-  {ADM_LAME_PRESET_ABR,&quot;ABR&quot;},
-  {ADM_LAME_PRESET_EXTREME,&quot;Extreme&quot;}
-};    
-
-typedef struct 
-{
-  ADM_LAME_PRESET preset;
-  ADM_mode        mode;
-  uint32_t        quality;
-  uint32_t        disableReservoir; // usefull for strict CBR (FLV)
-}LAME_encoderParam;
-
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lavcodec.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lavcodec.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lavcodec.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,149 +0,0 @@
-/***************************************************************************
-                        
-    copyright            : (C) 2002-2006 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
-    
-    Interface to FFmpeg mpeg1/2 audio encoder
-    
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;math.h&gt;
-
-#include &quot;ADM_default.h&quot;
-
-#include &quot;audioprocess.hxx&quot;
-#include &quot;audioeng_process.h&quot;
-#include &quot;audioencoder.h&quot;
-//
-#include &quot;ADM_audiofilter/audioencoder_lavcodec.h&quot;
-
-#include &quot;ADM_lavcodec.h&quot;
-
-#include &quot;ADM_osSupport/ADM_debugID.h&quot;
-#define MODULE_NAME MODULE_AUDIO_FILTER
-#include &quot;ADM_osSupport/ADM_debug.h&quot;
-
-
-#define CONTEXT ((AVCodecContext  	*)_context)
-
-
-// Ctor: Duplicate
-//__________
-
-AUDMEncoder_Lavcodec::AUDMEncoder_Lavcodec(uint32_t fourcc,AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
-{
-  _fourcc=fourcc;
-  if(_fourcc!=WAV_MP2 &amp;&amp; _fourcc!=WAV_AC3) ADM_assert(0);
-  _context=NULL;
-  _wavheader-&gt;encoding=_fourcc;
-  printf(&quot;[Lavcodec] Creating Lavcodec\n&quot;);
-};
-
-
-AUDMEncoder_Lavcodec::~AUDMEncoder_Lavcodec()
-{
-  printf(&quot;[Lavcodec] Deleting Lavcodec\n&quot;);
-  if(_context)
-  {
-    avcodec_close(CONTEXT);
-    ADM_dealloc(_context);
-  }
-  _context=NULL;
-  cleanup();
-};
-
-//________________________________________________
-//   Init lame encoder
-//_______________________________________________
-uint8_t AUDMEncoder_Lavcodec::init(ADM_audioEncoderDescriptor *config)
-{
-  int ret;
-  _context=( void *)avcodec_alloc_context();
-  _wavheader-&gt;byterate=(config-&gt;bitrate*1000)&gt;&gt;3;
-
-      
-  if(_fourcc==WAV_MP2 &amp;&amp; _incoming-&gt;getInfo()-&gt;channels&gt;2)
-  {
-    printf(&quot;[Lavcodec]Too many channels\n&quot;);
-    return 0; 
-  }
-  _wavheader-&gt;byterate=(config-&gt;bitrate*1000)&gt;&gt;3;         
-      
-  if(_fourcc==WAV_MP2)
-    _chunk = 1152*_wavheader-&gt;channels;
-  else
-    _chunk = 1536*_wavheader-&gt;channels; // AC3
-
-  printf(&quot;[Lavcodec]Incoming : fq : %lu, channel : %lu bitrate: %lu \n&quot;,
-         _wavheader-&gt;frequency,_wavheader-&gt;channels,config-&gt;bitrate);
-  
-  
-  CONTEXT-&gt;channels     =  _wavheader-&gt;channels;
-  CONTEXT-&gt;sample_rate  =  _wavheader-&gt;frequency;
-  CONTEXT-&gt;bit_rate     = (config-&gt;bitrate*1000); // bits -&gt; kbits
-
-  AVCodec *codec;
-  CodecID codecID;
-  
-  if(_fourcc==WAV_MP2) codecID=CODEC_ID_MP2;
-        else codecID=CODEC_ID_AC3;
-  codec = avcodec_find_encoder(codecID);
-  ADM_assert(codec);
-  
-  ret = avcodec_open(CONTEXT, codec);
-  if (0&gt; ret) 
-  {
-    printf(&quot;[Lavcodec] init failed err : %d!\n&quot;,ret);
-    return 0;
-  }
-
-
-  printf(&quot;[Lavcodec]Lavcodec successfully initialized\n&quot;);
-  return 1;       
-}
-//*********************************
-uint8_t	AUDMEncoder_Lavcodec::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
-{
-  uint32_t nbout;
-  
-  *samples = _chunk/_wavheader-&gt;channels; //FIXME
-  *len = 0;
-
-  if(!refillBuffer(_chunk ))
-  {
-    return 0; 
-  }
-        
-  if(tmptail-tmphead&lt;_chunk)
-  {
-    return 0; 
-  }
-
-  dither16(&amp;(tmpbuffer[tmphead]),_chunk,_wavheader-&gt;channels);
-
-  ADM_assert(tmptail&gt;=tmphead);
-  nbout = avcodec_encode_audio(CONTEXT, dest, 5000, (short *) &amp;(tmpbuffer[tmphead]));
-
-  tmphead+=_chunk;
-  if (nbout &lt; 0) 
-  {
-    printf(&quot;[Lavcodec] Error !!! : %ld\n&quot;, nbout);
-    return 0;
-  }
-  *len=nbout;
-  return 1;
-}
-
-// EOF

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lavcodec.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lavcodec.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_lavcodec.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,32 +0,0 @@
-
-/***************************************************************************
-    copyright            : (C) 2002-6 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef AUDMaudioLavcodec
-#define AUDMaudioLavcodec
- //_____________________________________________
-class AUDMEncoder_Lavcodec : public AUDMEncoder
-{
-  protected:
-   
-    void              *_context;
-    uint32_t          _fourcc;
-         
-  public:
-            uint8_t     init(ADM_audioEncoderDescriptor *config);
-   virtual             ~AUDMEncoder_Lavcodec();
-                        AUDMEncoder_Lavcodec(uint32_t fourcc,AUDMAudioFilter *instream);	
-   virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
-};
-
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_pcm.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_pcm.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_pcm.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,114 +0,0 @@
-/***************************************************************************
-    copyright            : (C) 2006 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;math.h&gt;
-
-#include &quot;ADM_default.h&quot;
-
-#include &quot;audioprocess.hxx&quot;
-#include &quot;audioeng_process.h&quot;
-#include &quot;audioencoder.h&quot;
-//
-#include &quot;ADM_audiofilter/audioencoder_pcm.h&quot;
-
-
-#include &quot;ADM_osSupport/ADM_debugID.h&quot;
-#define MODULE_NAME MODULE_AUDIO_FILTER
-#include &quot;ADM_osSupport/ADM_debug.h&quot;
-
-
-
-
-// Ctor: Duplicate
-//__________
-
-AUDMEncoder_PCM::AUDMEncoder_PCM(uint32_t reverted,uint32_t fourCC,AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
-{
-  printf(&quot;[PCM] Creating PCM\n&quot;);
-  ADM_assert(fourCC==WAV_PCM || fourCC==WAV_LPCM);
-  _wavheader-&gt;encoding=fourCC;
-  revert=reverted;
-};
-
-
-AUDMEncoder_PCM::~AUDMEncoder_PCM()
-{
-  printf(&quot;[PCM] Deleting PCM\n&quot;);
-  cleanup();
-};
-
-//________________________________________________
-//   Init lame encoder
-// frequence    : Impose frequency , 0 means reuse the incoming fq
-// mode                         : ADM_STEREO etc...
-// bitrate              : Bitrate in kbps (96,192...)
-// return 0 : init failed
-//                              1 : init succeeded
-//_______________________________________________
-uint8_t AUDMEncoder_PCM::init(ADM_audioEncoderDescriptor *config)
-{
-  
-  _wavheader-&gt;byterate=_wavheader-&gt;channels*_wavheader-&gt;frequency*2;
-  _chunk = (_wavheader-&gt;frequency/100)*_wavheader-&gt;channels*2;
-  
-
- 
-  printf(&quot;[PCM]Incoming :fq : %lu, channel : %lu \n&quot;,_wavheader-&gt;frequency,_wavheader-&gt;channels);
-  printf(&quot;[PCM]PCM successfully initialized\n&quot;);
-  return 1;       
-}
-
-uint8_t	AUDMEncoder_PCM::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
-{
-  uint32_t nbout;
-  
-  *samples = _chunk; //FIXME
-  *len = 0;
-
-  if(!refillBuffer(_chunk ))
-  {
-    return 0; 
-  }
-        
-  if(tmptail-tmphead&lt;_chunk)
-  {
-    return 0; 
-  }
-        // Do in place replace
-  dither16(&amp;(tmpbuffer[tmphead]),_chunk,_wavheader-&gt;channels);
-  if(!revert)
-    memcpy(dest,&amp;(tmpbuffer[tmphead]),_chunk*2);
-  else
-  {
-    uint16_t *in,*out,tmp;
-    in=(uint16_t*)&amp;(tmpbuffer[tmphead]);
-    out=(uint16_t *)dest;
-    for(int i=0;i&lt;_chunk;i++)
-    {
-      tmp=*in++;
-      tmp=((tmp&amp;0xff)&lt;&lt;8)+(tmp&gt;&gt;8);
-      *out++=tmp;
-    }
-  }
-  tmphead+=_chunk;
-  *len=_chunk*2;
-  *samples=_chunk/_wavheader-&gt;channels;
-  return 1;
-}
-
-
-// EOF

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_pcm.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_pcm.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_pcm.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,36 +0,0 @@
-/***************************************************************************
-    copyright            : (C) 2002-6 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef AUDMaudioPCM
-#define AUDMaudioPCM
-
-/*!
-    This class is the float-&gt;PCM encoder.
-    It is somehow special as it can alsa be a LPCM encoder and a bigendian/littleendian swapper
-*/
-class AUDMEncoder_PCM : public AUDMEncoder
-{
-  protected:
-    uint32_t            revert;
-         
-  public:
-            uint8_t     init(ADM_audioEncoderDescriptor *config);
-            virtual     ~AUDMEncoder_PCM();
-                        /*! \param reverted : Should the endianness be reverted compared to system  
-                            \param fourCC   : FourCC to use (WAV_PCM/WAV_LPCM)
-                        */
-                         AUDMEncoder_PCM(uint32_t reverted,uint32_t fourCC,AUDMAudioFilter * instream);
-    virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
-};
-
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,176 +0,0 @@
-/***************************************************************************
-    copyright            : (C) 2006 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;math.h&gt;
-
-#include &quot;ADM_default.h&quot;
-
-#include &quot;audioprocess.hxx&quot;
-#include &quot;audioeng_process.h&quot;
-#include &quot;audioencoder.h&quot;
-//
-#include &quot;ADM_audiofilter/audioencoder_twolame.h&quot;
-#include &quot;ADM_audiofilter/audioencoder_twolame_param.h&quot;
-
-extern &quot;C&quot;
-{
-#include &quot;ADM_libraries/ADM_libtwolame/twolame.h&quot;
-}
-#include &quot;ADM_osSupport/ADM_debugID.h&quot;
-#define MODULE_NAME MODULE_AUDIO_FILTER
-#include &quot;ADM_osSupport/ADM_debug.h&quot;
-
-
-#define OPTIONS (twolame_options_struct *)_twolameOptions
-
-// Ctor: Duplicate
-//__________
-
-AUDMEncoder_Twolame::AUDMEncoder_Twolame(AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
-{
-  printf(&quot;[TwoLame] Creating Twolame\n&quot;);
-  _twolameOptions=NULL;
-  _wavheader-&gt;encoding=WAV_MP2;
-};
-
-
-AUDMEncoder_Twolame::~AUDMEncoder_Twolame()
-{
-  printf(&quot;[TwoLame] Deleting TwoLame\n&quot;);
-  if(_twolameOptions)
-  {
-    twolame_close((twolame_options_struct **)&amp;_twolameOptions);
-  }
-  _twolameOptions=NULL;
-  cleanup();
-};
-
-//________________________________________________
-//   Init lame encoder
-// frequence    : Impose frequency , 0 means reuse the incoming fq
-// mode                         : ADM_STEREO etc...
-// bitrate              : Bitrate in kbps (96,192...)
-// return 0 : init failed
-//                              1 : init succeeded
-//_______________________________________________
-uint8_t AUDMEncoder_Twolame::init(ADM_audioEncoderDescriptor *config)
-{
-  int ret;
-  TWOLAME_MPEG_mode mmode;    	
-  uint32_t frequence;
-  TWOLAME_encoderParam *lameConf=(TWOLAME_encoderParam *)config-&gt;param;
-  ADM_assert(config-&gt;paramSize==sizeof(TWOLAME_encoderParam));
-
-  _twolameOptions = twolame_init();
-  if (_twolameOptions == NULL)
-    return 0;
-      
-  if(_wavheader-&gt;channels&gt;2)
-  {
-    printf(&quot;[TwoLame]Too many channels\n&quot;);
-    return 0; 
-  }
-  _wavheader-&gt;byterate=(config-&gt;bitrate*1000)&gt;&gt;3;         
-      
- 
-  _chunk = 1152*_wavheader-&gt;channels;
-
- 
-  printf(&quot;[TwoLame]Incoming :fq : %lu, channel : %lu bitrate: %lu \n&quot;,
-        _wavheader-&gt;frequency,_wavheader-&gt;channels,config-&gt;bitrate);
-		
- 
-  twolame_set_in_samplerate(OPTIONS, _wavheader-&gt;frequency);
-  twolame_set_out_samplerate (OPTIONS, _wavheader-&gt;frequency);
-  twolame_set_num_channels(OPTIONS, _wavheader-&gt;channels);
-  if(_wavheader-&gt;channels==1) mmode=TWOLAME_MONO;
-  else
-    switch (lameConf-&gt;mode)
-  {
-    case ADM_STEREO:
-      mmode = TWOLAME_STEREO;
-      break;
-    case ADM_JSTEREO:
-      mmode = TWOLAME_JOINT_STEREO;
-      break;
-    case ADM_MONO:
-      mmode=TWOLAME_MONO;
-      break;
-				
-    default:
-      printf(&quot;\n **** unknown mode, going stereo ***\n&quot;);
-      mmode = TWOLAME_STEREO;
-      break;
-
-  }
-  twolame_set_mode(OPTIONS,mmode);
-  twolame_set_error_protection(OPTIONS,TRUE);	
-    	//toolame_setPadding (options,TRUE);
-  twolame_set_bitrate (OPTIONS,config-&gt;bitrate);
-  twolame_set_verbosity(OPTIONS, 2);
-  if(twolame_init_params(OPTIONS))
-  {
-    printf(&quot;[TwoLame]Twolame init failed\n&quot;);
-    return 0;
-  }
-	
- 
-
-  printf(&quot;[TwoLame]Libtoolame successfully initialized\n&quot;);
-  return 1;       
-}
-
-uint8_t	AUDMEncoder_Twolame::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
-{
-  int nbout;
-  
-  *samples = 1152; //FIXME
-  *len = 0;
-  ADM_assert(tmptail&gt;=tmphead);
-  if(!refillBuffer(_chunk ))
-  {
-    return 0; 
-  }
-        
-  if(tmptail-tmphead&lt;_chunk)
-  {
-    return 0; 
-  }
-
-  dither16(&amp;(tmpbuffer[tmphead]),_chunk,_wavheader-&gt;channels);
-
-  ADM_assert(tmptail&gt;=tmphead);
-  if (_wavheader-&gt;channels == 1)
-  {
-    nbout =twolame_encode_buffer(OPTIONS, (int16_t *)&amp;(tmpbuffer[tmphead]),(int16_t *)&amp;(tmpbuffer[tmphead]), _chunk, dest, 16 * 1024);
-  }
-  else
-  {
-    nbout = twolame_encode_buffer_interleaved(OPTIONS, (int16_t *)&amp;(tmpbuffer[tmphead]), _chunk/2, dest, 16 * 1024);
-  }
-  tmphead+=_chunk;
-  ADM_assert(tmptail&gt;=tmphead);
-  if (nbout &lt; 0) {
-    printf(&quot;\n Error !!! : %ld\n&quot;, nbout);
-    return 0;
-  }
-  *len=nbout;
-  return 1;
-}
-
-
-// EOF

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,30 +0,0 @@
-/***************************************************************************
-    copyright            : (C) 2002-6 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef AUDMaudioTwoLame
-#define AUDMaudioTwoLame
-
- //_____________________________________________
-class AUDMEncoder_Twolame : public AUDMEncoder
-{
-  protected:
-    void           *_twolameOptions;
-         
-  public:
-            uint8_t     init(ADM_audioEncoderDescriptor *config);
-    virtual             ~AUDMEncoder_Twolame();
-                        AUDMEncoder_Twolame(AUDMAudioFilter *instream);	
-    virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
-};
-
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame_param.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame_param.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_twolame_param.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,10 +0,0 @@
-#ifndef AUDM_TWOLAME_PARAM_H
-#define AUDM_TWOLAME_PARAM_H
-
-
-typedef struct 
-{
-  ADM_mode        mode;
-}TWOLAME_encoderParam;
-
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,307 +0,0 @@
-/***************************************************************************
-    copyright            : (C) 2006 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-#ifdef USE_VORBIS
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;math.h&gt;
-
-#include &quot;ADM_default.h&quot;
-
-#include &quot;audioprocess.hxx&quot;
-#include &quot;audioeng_process.h&quot;
-#include &quot;audioencoder.h&quot;
-//
-#include &quot;ADM_audiofilter/audioencoder_vorbis_param.h&quot;
-#include &quot;ADM_audiofilter/audioencoder_vorbis.h&quot;
-
-
-#include &quot;vorbis/vorbisenc.h&quot;
-#include &quot;ADM_osSupport/ADM_debugID.h&quot;
-#define MODULE_NAME MODULE_AUDIO_FILTER
-#include &quot;ADM_osSupport/ADM_debug.h&quot;
-
-
-#define OPTIONS (twolame_options_struct *)_twolameOptions
-
-#define VD (((vorbisStruct *)_handle)-&gt;vd)
-#define VI (((vorbisStruct *)_handle)-&gt;vi)
-#define VB (((vorbisStruct *)_handle)-&gt;vb)
-#define VC (((vorbisStruct *)_handle)-&gt;vc)
-typedef struct vorbisStruct
-{ 
-	vorbis_info 	 vi ;
-	vorbis_dsp_state vd ;
-	vorbis_block     vb ;
-	vorbis_comment   vc ;
-}vorbisStruct;
-//__________
-
-AUDMEncoder_Vorbis::AUDMEncoder_Vorbis(AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
-{
-  printf(&quot;[Vorbis] Creating Vorbis\n&quot;);
-  _handle=NULL;
-  _wavheader-&gt;encoding=WAV_OGG;
-  _oldpos=0;
-  _handle=(void *)new  vorbisStruct; 
-  outputChannelMapping[0] = CH_FRONT_LEFT;
-  outputChannelMapping[1] = CH_FRONT_RIGHT;
-  outputChannelMapping[2] = CH_REAR_LEFT;
-  outputChannelMapping[3] = CH_REAR_RIGHT;
-  outputChannelMapping[4] = CH_FRONT_CENTER;
-  outputChannelMapping[5] = CH_LFE;
-};
-
-
-AUDMEncoder_Vorbis::~AUDMEncoder_Vorbis()
-{
-  printf(&quot;[Vorbis] Deleting Vorbis\n&quot;);
-  if(_handle)
-  {
-    vorbis_block_clear(&amp;VB);
-    vorbis_dsp_clear(&amp;VD);
-    vorbis_info_clear(&amp;VI);
-    delete (vorbisStruct *)_handle;
-  }    	
-  _handle=NULL;
-  
-  cleanup();
-};
-
-//________________________________________________
-//   Init lame encoder
-// frequence    : Impose frequency , 0 means reuse the incoming fq
-// mode                         : ADM_STEREO etc...
-// bitrate              : Bitrate in kbps (96,192...)
-// return 0 : init failed
-//                              1 : init succeeded
-//_______________________________________________
-uint8_t AUDMEncoder_Vorbis::init(ADM_audioEncoderDescriptor *config)
-{
-  int ret;
-  VORBIS_encoderParam *vorbisConf=(VORBIS_encoderParam *)config-&gt;param;
-  ADM_assert(config-&gt;paramSize==sizeof(VORBIS_encoderParam));
-
-  ogg_packet header1,header2,header3;
-  int err;
-
-  
-  
-  vorbis_info_init(&amp;VI) ;
-
-  switch(vorbisConf-&gt;mode)
-  {
-    
-    case ADM_VORBIS_VBR:
-                      err=vorbis_encode_init(&amp;VI,
-                              _wavheader-&gt;channels,
-                              _wavheader-&gt;frequency,
-                              -1, // Max bitrate      
-                              config-&gt;bitrate*1000, //long nominal_bitrate,
-                              -1 //long min_bitrate))
-                            );
-                      break;
-    case  ADM_VORBIS_QUALITY :
-                    err=vorbis_encode_init_vbr(&amp;VI,
-                                _wavheader-&gt;channels,
-                                _wavheader-&gt;frequency,
-                                vorbisConf-&gt;quality/10
-                              );
-                    break;
-      
-    default:
-      ADM_assert(0);
-  }
-  if (err!=0) 
-  {
-	  delete (vorbisStruct*)_handle;
-	  _handle = NULL;
-
-    printf(&quot;[vorbis] init error %d\n&quot;,err);
-    return 0;
-  }
-  vorbis_analysis_init(&amp;VD, &amp;VI) ;
-  vorbis_block_init(&amp;VD, &amp;VB);
-  vorbis_comment_init(&amp;VC);
-  vorbis_comment_add_tag(&amp;VC, &quot;encoder&quot;, &quot;AVIDEMUX2&quot;) ;
-
-  vorbis_analysis_headerout(&amp;VD, &amp;VC, &amp;header1,
-                             &amp;header2, &amp;header3);
-
-
-// Store all headers as extra data
-// see ogg vorbis decode for details
-// we need 3 packets
-
-  _extraSize=header1.bytes+header2.bytes+header3.bytes+3*sizeof(uint32_t);
-  _extraData=new uint8_t[_extraSize];
-
-  uint32_t *ex=(uint32_t *)_extraData;
-  uint8_t *d;
-  d=_extraData+sizeof(uint32_t)*3;
-  ex[0]=header1.bytes;
-  ex[1]=header2.bytes;
-  ex[2]=header3.bytes;
-  memcpy(d,header1.packet,ex[0]);
-  d+=ex[0];
-  memcpy(d,header2.packet,ex[1]);
-  d+=ex[1];
-  memcpy(d,header3.packet,ex[2]);
-  vorbis_comment_clear(&amp;VC);
-			
-  printf(&quot;\n[Vorbis]Vorbis encoder initialized\n&quot;);
-  switch(vorbisConf-&gt;mode)
-  {
-    case ADM_VORBIS_VBR:
-      printf(&quot;[Vorbis]CBR Bitrate:%lu\n&quot;,config-&gt;bitrate);
-      break;
-    case ADM_VORBIS_QUALITY: //FIXME FIXME FIXME
-      printf(&quot;[Vorbis]VBR Quality:%.1f\n&quot;,vorbisConf-&gt;quality);
-    break;
-    default:
-      ADM_assert(0);
-  }
-   
-  printf(&quot;[Vorbis]Channels  :%lu\n&quot;,_wavheader-&gt;channels);
-  printf(&quot;[Vorbis]Frequency :%lu\n&quot;,_wavheader-&gt;frequency);
-  return 1;
-}
-
-#define ROUNDMAX 3000
-
-uint8_t	AUDMEncoder_Vorbis::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
-{
-  uint32_t nbout;
-  uint32_t consumed=0;
-  float **float_samples;
-  ogg_packet op ;
-
-  *len = 0;
-  _chunk=1024*_wavheader-&gt;channels;
-  int count=ROUNDMAX;
-// Check that we have packet from previous pass
-  while(count--)
-  {
-    if(!refillBuffer(_chunk ))
-    {
-      return 0; 
-    }
-        
-    if(tmptail-tmphead&lt;_chunk)
-    {
-      return 0; 
-    }
-    
-	//printf(&quot;Round %d\n&quot;,ROUNDMAX-count);
-    if(vorbis_analysis_blockout(&amp;VD, &amp;VB) == 1) 
-    {
-      vorbis_analysis(&amp;VB, NULL);
-      vorbis_bitrate_addblock(&amp;VB) ;
-	//printf(&quot;Blockout\n&quot;);
-	
-      if(vorbis_bitrate_flushpacket(&amp;VD, &amp;op)) 
-      {
-        memcpy(dest, op.packet,op.bytes);
-        *len=op.bytes;
-        *samples=op.granulepos-_oldpos;
-        _oldpos=op.granulepos;
-        //  aprintf(&quot;1st packet :sampl:%lu len :%lu sample:%lu abs:%llu\n&quot;,*samples,op.bytes,total,op.granulepos);
-        return 1;
-      }
-    }
-
-    
-    uint32_t nbSample=(tmptail-tmphead)/_wavheader-&gt;channels;
-    if(nbSample&gt;1024) nbSample=1024;
-    float_samples=vorbis_analysis_buffer(&amp;VD, nbSample) ;
-    int index=tmphead;
-    // Put our samples in incoming buffer
-    reorderChannels(&amp;(tmpbuffer[tmphead]), nbSample,_incoming-&gt;getChannelMapping(),outputChannelMapping);
-    for (int i = 0; i &lt; nbSample; i++)
-      for (int j = 0; j &lt; _wavheader-&gt;channels; j++) {
-      float_samples[j][i] = tmpbuffer[index++];
-      if (float_samples[j][i] &gt; 1) float_samples[j][i] = 1;
-      if (float_samples[j][i] &lt; -1) float_samples[j][i] = -1;
-      }
-      // Buffer full, go go go
-      vorbis_analysis_wrote(&amp;VD, nbSample) ;  
-      tmphead+=nbSample*_wavheader-&gt;channels;	
-  }
-  return 0;
-	
-}
-/**
-      \fn DIA_getLameSettings
-      \brief Dialog to set lame settings
-      @return 1 on success, 0 on failure
-
-*/
-#include &quot;DIA_factory.h&quot;
-int DIA_getVorbisSettings(ADM_audioEncoderDescriptor *descriptor)
-  {
-    int ret=0;
-    char string[400];
-    uint32_t mmode,ppreset;
-    ELEM_TYPE_FLOAT qqual;
-#define SZT(x) sizeof(x)/sizeof(diaMenuEntry )
-#define PX(x) &amp;(lameParam-&gt;x)
-    
-    
-   VORBIS_encoderParam *vorbisParam;
-  ADM_assert(sizeof(VORBIS_encoderParam)==descriptor-&gt;paramSize);
-  vorbisParam=(VORBIS_encoderParam*)descriptor-&gt;param;
-  
-    mmode=vorbisParam-&gt;mode;
-    qqual=(ELEM_TYPE_FLOAT)vorbisParam-&gt;quality;
-    
-    diaMenuEntry channelMode[]={
-                             {ADM_VORBIS_VBR,      QT_TR_NOOP(&quot;VBR&quot;),NULL},
-                             {ADM_VORBIS_QUALITY,   QT_TR_NOOP(&quot;Quality based&quot;),NULL}};
-          
-    diaElemMenu menuMode(&amp;mmode,   QT_TR_NOOP(&quot;_Mode:&quot;), SZT(channelMode),channelMode);
-    
-#define BITRATE(x) {x,QT_TR_NOOP(#x)}
-    diaMenuEntry bitrateM[]={
-                              BITRATE(56),
-                              BITRATE(64),
-                              BITRATE(80),
-                              BITRATE(96),
-                              BITRATE(112),
-                              BITRATE(128),
-                              BITRATE(160),
-                              BITRATE(192),
-                              BITRATE(224)
-                          };
-    diaElemMenu bitrate(&amp;(descriptor-&gt;bitrate),   QT_TR_NOOP(&quot;_Bitrate:&quot;), SZT(bitrateM),bitrateM);
-    
-    diaElemFloat quality(&amp;qqual,QT_TR_NOOP(&quot;_Quality:&quot;),-1.,10.);
-    
-    
-    
-  
-      diaElem *elems[]={&amp;menuMode,&amp;bitrate,&amp;quality};
-    
-  if( diaFactoryRun(QT_TR_NOOP(&quot;Vorbis Configuration&quot;),3,elems))
-  {
-    vorbisParam-&gt;mode=(ADM_VORBIS_MODE)mmode;
-    vorbisParam-&gt;quality=(float)qqual;
-    
-    return 1;
-  }
-  return 0;
-}  
-
-#endif		
-// EOF

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,35 +0,0 @@
-
-/***************************************************************************
-    copyright            : (C) 2002-6 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef AUDMaudioVorbis
-#define AUDMaudioVorbis
-
- //_____________________________________________
-class AUDMEncoder_Vorbis : public AUDMEncoder
-{
-  protected:
-   
-    void              *_handle;
-    uint64_t          _oldpos;
-
-         
-  public:
-            uint8_t     init(ADM_audioEncoderDescriptor *config);
-            virtual     ~AUDMEncoder_Vorbis();
-                        AUDMEncoder_Vorbis(AUDMAudioFilter *instream);	
-            
-   virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
-};
-
-#endif

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis_param.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis_param.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder_vorbis_param.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,17 +0,0 @@
-#ifndef AUDM_VORBIS_PARAM_H
-#define AUDM_VORBIS_PARAM_H
-
-typedef enum 
-{
-  ADM_VORBIS_CBR,
-  ADM_VORBIS_VBR,
-  ADM_VORBIS_QUALITY
-  
-}ADM_VORBIS_MODE;
-
-typedef struct 
-{
-  ADM_VORBIS_MODE    mode;   // 0 cbr 1 vbr 2 quality
-  float              quality;
-}VORBIS_encoderParam;
-#endif

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioeng_buildfilters.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioeng_buildfilters.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioeng_buildfilters.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -37,23 +37,9 @@
 void audioFilter_MP3DisableReservoir(int onoff);
 uint32_t audioFilter_getOuputCodec(void);
 uint32_t audioFilter_getOuputFrequency(uint32_t inputFrequency);
-typedef enum 
-{
-	AUDIOENC_NONE,
-	AUDIOENC_MP3,
-	AUDIOENC_MP2,
-	AUDIOENC_AC3,
-	AUDIOENC_2LAME,
-	AUDIOENC_FAAC,
-	AUDIOENC_VORBIS,
-        AUDIOENC_COPY,
-        AUDIOENC_LPCM,
-#ifdef USE_AFTEN        
-        AUDIOENC_AFTEN,
-#endif        
-	AUDIOENC_DUMMY
-}AUDIOENCODER;
 
+#include &quot;ADM_audioEncoder/include/audioencoder_enum.h&quot;
+
 typedef enum 
 {
 	RESAMPLING_NONE=0,

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioeng_process.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioeng_process.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioeng_process.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -19,7 +19,7 @@
 #define __Audio_ENG_Process__
 
 #define AUD_PROCESS_BUFFER_SIZE 48000*2*4 // should be enougth 4 seconds of stereo
-#include &quot;ADM_audio/ADM_audiodef.h&quot;
+#include &quot;ADM_coreAudio/include/ADM_coreAudio.h&quot;
 /**
   This enumerate is used to give a more accurate error when no audio is output from
   an audio filter.

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_buildchain.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_buildchain.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audiofilter_buildchain.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -21,38 +21,38 @@
 
 #include &quot;ADM_audio/audiomode.hxx&quot;
 #include &quot;ADM_audiofilter/audiofilter_limiter_param.h&quot;
-#include &quot;ADM_audiofilter/audioencoder_lame_param.h&quot;
-#include &quot;ADM_audiofilter/audioencoder_twolame_param.h&quot;
-#include &quot;ADM_audiofilter/audioencoder_faac_param.h&quot;
-#include &quot;ADM_audiofilter/audioencoder_vorbis_param.h&quot;
-#include &quot;ADM_audiofilter/audioencoder_aften_param.h&quot;
-#include &quot;ADM_audiofilter/audiofilter_normalize_param.h&quot;
+#include &quot;audioencoder_lame_param.h&quot;
+#include &quot;audioencoder_twolame_param.h&quot;
+#include &quot;audioencoder_faac_param.h&quot;
+#include &quot;audioencoder_vorbis_param.h&quot;
+#include &quot;audioencoder_aften_param.h&quot;
+#include &quot;audiofilter_normalize_param.h&quot;
 
 #include &quot;audioprocess.hxx&quot;
 #include &quot;ADM_audiofilter/audioeng_buildfilters.h&quot;
 #include &quot;ADM_audiofilter/audio_raw.h&quot;
 
 /* ************* Encoder *********** */
-#include &quot;ADM_audiofilter/audioencoder.h&quot;
+#include &quot;audioencoder.h&quot;
 #ifdef USE_FAAC
-#include &quot;ADM_audiofilter/audioencoder_faac.h&quot;
+#include &quot;audioencoder_faac.h&quot;
 #endif
 #ifdef HAVE_LIBMP3LAME
-#include &quot;ADM_audiofilter/audioencoder_lame.h&quot;
+#include &quot;audioencoder_lame.h&quot;
 #endif
 #ifdef USE_VORBIS
-#include &quot;ADM_audiofilter/audioencoder_vorbis.h&quot;
+#include &quot;audioencoder_vorbis.h&quot;
 #endif
 #ifdef USE_AFTEN
-#include &quot;ADM_audiofilter/audioencoder_aften.h&quot;
+#include &quot;audioencoder_aften.h&quot;
 #endif
 
-#include &quot;ADM_audiofilter/audioencoder_twolame.h&quot;
-#include &quot;ADM_audiofilter/audioencoder_lavcodec.h&quot;
+#include &quot;audioencoder_twolame.h&quot;
+#include &quot;audioencoder_lavcodec.h&quot;
 
 
 #include &quot;ADM_audiocodec/ADM_audiocodeclist.h&quot;
-#include &quot;ADM_audiofilter/audioencoder_pcm.h&quot;
+#include &quot;audioencoder_pcm.h&quot;
 
 #include &quot;prefs.h&quot;
 

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_coreAudio.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_coreAudio.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_coreAudio.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,19 +0,0 @@
-/**
-        \file ADM_audioCore.h
-
-*/
-#ifndef ADM_audioCore_H
-#define ADM_audioCore_H
-
-
-
-#define DITHER_SIZE 4800
-#define DITHER_CHANNELS 6
-void            AUDMEncoder_initDither();
-void dither16(float *start, uint32_t nb, uint8_t channels);
-
-
-
-#endif
-//EOF
-

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_audioUtils.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_audioUtils.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_audioUtils.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,48 +0,0 @@
-/**
-    \fn ADM_audioUtils.cpp
-    \brief Will be moved later to ADM_coreAudio
-
-
-*/
-#include &quot;ADM_default.h&quot;
-#include &quot;ADM_coreAudio.h&quot;
-#include &lt;math.h&gt;
-
-static float rand_table[DITHER_CHANNELS][DITHER_SIZE];
-
-void AUDMEncoder_initDither(void)
-{
-  printf(&quot;Initializing Dithering tables\n&quot;);
-	float d, dp;
-	for (int c = 0; c &lt; DITHER_CHANNELS; c++) {
-		dp = 0;
-		for (int i = 0; i &lt; DITHER_SIZE-1; i++) {
-			d = rand() / (float)RAND_MAX - 0.5;
-			rand_table[c][i] = d - dp;
-			dp = d;
-		}
-  		rand_table[c][DITHER_SIZE-1] = 0 - dp;
-	}
-}
-
-void dither16(float *start, uint32_t len, uint8_t channels)
-{
-	static uint16_t nr = 0;
-	int16_t *data_int = (int16_t *)start;
-	float *data = start;
-
-	len /= channels;
-	for (int i = 0; i &lt; len; i++) {
-		for (int c = 0; c &lt; channels; c++) {
-			*data = roundf(*data * 32766 + rand_table[c][nr]);
-			if (*data &gt; 32767.0f) *data = 32767;
-			if (*data &lt; -32768.0f) *data = -32768;
-			*data_int = (int16_t) *data;
-			data++;
-			data_int++;
-		}
-		nr++;
-		if (nr &gt;= DITHER_SIZE)
-			nr = 0;
-	}
-}
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/CMakeLists.txt	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/CMakeLists.txt	2008-07-16 17:39:39 UTC (rev 4221)
@@ -1,7 +1,6 @@
 SET(ADM_core_SRCS 
 	ADM_cpuCap.cpp  ADM_memcpy.cpp  ADM_memsupport.cpp  ADM_threads.cpp  ADM_win32.cpp
 	ADM_memory.cpp  ADM_misc.cpp  TLK_clock.cpp  ADM_crashdump.cpp  ADM_fileio.cpp ADM_dynamicLoading.cpp
-        ADM_audioUtils.cpp
 )
 
 ADD_LIBRARY(ADM_core SHARED ${ADM_core_SRCS})

Added: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/CMakeLists.txt	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/CMakeLists.txt	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1 @@
+ADD_SUBDIRECTORY(src)

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/include/ADM_audiodef.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_audiodef.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audio/ADM_audiodef.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/include/ADM_audiodef.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,69 @@
+/*
+
+
+*/
+#ifndef AUDIO_DEF
+#define AUDIO_DEF
+#include &lt;string.h&gt;
+typedef struct
+{
+    uint16_t	encoding;	
+    uint16_t	channels;					/* 1 = mono, 2 = stereo */
+    uint32_t	frequency;				/* One of 11025, 22050, or 44100 48000 Hz */
+    uint32_t	byterate;					/* Average bytes per second */
+    uint16_t	blockalign;				/* Bytes per sample block */
+    uint16_t	bitspersample;		/* One of 8, 12, 16, or 4 for ADPCM */
+} WAVHeader;
+void printWavHeader(WAVHeader *hdr);
+
+typedef enum 
+{
+    CHANNEL_INVALID=0,
+    CHANNEL_MONO,
+    CHANNEL_STEREO,
+    CHANNEL_2F_1R,
+    CHANNEL_3F,
+    CHANNEL_3F_1R,
+    CHANNEL_2F_2R,
+    CHANNEL_3F_2R,
+    CHANNEL_3F_2R_LFE,
+    CHANNEL_DOLBY_PROLOGIC,
+    CHANNEL_DOLBY_PROLOGIC2,
+    CHANNEL_LAST
+} CHANNEL_CONF;
+
+#define MAX_CHANNELS 9
+
+typedef enum 
+{
+	CH_INVALID=0,
+	CH_MONO,
+	CH_FRONT_LEFT,
+	CH_FRONT_RIGHT,
+	CH_FRONT_CENTER,
+	CH_REAR_LEFT,
+	CH_REAR_RIGHT,
+	CH_REAR_CENTER,
+	CH_SIDE_LEFT,
+	CH_SIDE_RIGHT,
+	CH_LFE
+}CHANNEL_TYPE;
+// returns true if channel mapping is identical
+bool ADM_audioCompareChannelMapping(WAVHeader *wh1, WAVHeader *wh2,CHANNEL_TYPE *map1,CHANNEL_TYPE *map2);
+
+
+typedef struct
+{
+  const char    *desc;
+  CHANNEL_CONF  conf;
+}AudioChannelDesc;
+const AudioChannelDesc localDownmixing[]=
+{
+  {&quot;No downmixing (multichannel)&quot;, CHANNEL_INVALID},
+  {&quot;Stereo&quot;, CHANNEL_STEREO},
+  {&quot;Dolby Prologic&quot;, CHANNEL_DOLBY_PROLOGIC},
+  {&quot;Dolby Prologic II&quot;, CHANNEL_DOLBY_PROLOGIC2}
+  
+};
+#define NB_LOCAL_DOWNMIX (sizeof(localDownmixing)/sizeof(AudioChannelDesc))
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/include/ADM_coreAudio.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_coreAudio.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_coreAudio.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/include/ADM_coreAudio.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,19 @@
+/**
+        \file ADM_audioCore.h
+
+*/
+#ifndef ADM_audioCore_H
+#define ADM_audioCore_H
+
+
+
+#define DITHER_SIZE 4800
+#define DITHER_CHANNELS 6
+void            AUDMEncoder_initDither();
+void dither16(float *start, uint32_t nb, uint8_t channels);
+
+#include &quot;ADM_audiodef.h&quot;
+
+#endif
+//EOF
+

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/include/audioencoder.h (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.h)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.h	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/include/audioencoder.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,75 @@
+/***************************************************************************
+    copyright            : (C) 2006 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+
+#ifndef AUDIO_ENCODER_H
+#define AUDIO_ENCODER_H
+/*!
+  This structure defines an audio encoder
+  \param encoder Encoder attached to this descriptor
+   \param name The name of the codec
+  \param bitrate The bitrate in kb/s
+  \param configure Function to call to configure the codec
+  \param maxChannels The maximum # of channels this codec supports
+  \param param : An opaque structure that contains the codec specific configuration datas
+*/
+#include &quot;ADM_coreAudio.h&quot;
+#include &quot;ADM_audioEncoder/include/audioencoder_enum.h&quot;
+typedef struct ADM_audioEncoderDescriptor
+{
+  AUDIOENCODER encoder;
+  int       (*configure)(ADM_audioEncoderDescriptor *descritor);
+  const     char *name;
+  uint32_t  bitrate;
+  uint32_t  maxChannels;
+  uint32_t  paramSize;
+  void     *param;
+} ADM_audioEncoderDescriptor;
+
+/*!
+  Base class for all audio encoder.It does the reverse of the bridge class and offers a proper GenericAudioStreamAPI
+
+*/
+#include &quot;ADM_audio/aviaudio.hxx&quot; // FIXME!!!!
+#include &quot;ADM_audiofilter/audioeng_process.h&quot; // FIXME!!!
+ //_____________________________________________
+class AUDMEncoder : public AVDMGenericAudioStream
+{
+  protected:
+    //
+    uint32_t grab(uint8_t *outbuffer);
+    uint32_t grab(float *outbuffer) {ADM_assert(0);return 1;}
+    uint32_t  eof_met;
+    uint32_t  _chunk;
+    //
+    uint8_t         *_extraData;
+    uint32_t        _extraSize;
+    AUDMAudioFilter *_incoming;
+    uint8_t         cleanup(void);
+    
+    float          *tmpbuffer;
+    uint8_t        refillBuffer(int minimum); // Mininum is in float
+
+    
+    void reorderChannels(float *data, uint32_t nb,CHANNEL_TYPE *input,CHANNEL_TYPE *output);
+
+    uint32_t       tmphead,tmptail;
+    // The encoder can remap the audio channel (or not). If so, let's store the the configuration here
+    CHANNEL_TYPE outputChannelMapping[MAX_CHANNELS];
+  public:
+    //
+    uint32_t read(uint32_t len,uint8_t *buffer);
+    uint32_t read(uint32_t len,float *buffer) {ADM_assert(0);return 1;}
+    //
+    virtual ~AUDMEncoder();
+    AUDMEncoder(AUDMAudioFilter *in);	
+    virtual uint8_t init(ADM_audioEncoderDescriptor *config)=0;
+    virtual uint8_t getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)=0;
+    virtual uint8_t packetPerFrame( void) {return 1;}
+    virtual uint8_t extraData(uint32_t *l,uint8_t **d) {*l=_extraSize;*d=_extraData;return 1;}
+            uint8_t  goTo(uint32_t timeMS) {ADM_assert(0);return 1;}
+};
+
+#endif

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/src/ADM_audioUtils.cpp (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_audioUtils.cpp)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/ADM_audioUtils.cpp	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/src/ADM_audioUtils.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,48 @@
+/**
+    \fn ADM_audioUtils.cpp
+    \brief Will be moved later to ADM_coreAudio
+
+
+*/
+#include &quot;ADM_default.h&quot;
+#include &quot;ADM_coreAudio.h&quot;
+#include &lt;math.h&gt;
+
+static float rand_table[DITHER_CHANNELS][DITHER_SIZE];
+
+void AUDMEncoder_initDither(void)
+{
+  printf(&quot;Initializing Dithering tables\n&quot;);
+	float d, dp;
+	for (int c = 0; c &lt; DITHER_CHANNELS; c++) {
+		dp = 0;
+		for (int i = 0; i &lt; DITHER_SIZE-1; i++) {
+			d = rand() / (float)RAND_MAX - 0.5;
+			rand_table[c][i] = d - dp;
+			dp = d;
+		}
+  		rand_table[c][DITHER_SIZE-1] = 0 - dp;
+	}
+}
+
+void dither16(float *start, uint32_t len, uint8_t channels)
+{
+	static uint16_t nr = 0;
+	int16_t *data_int = (int16_t *)start;
+	float *data = start;
+
+	len /= channels;
+	for (int i = 0; i &lt; len; i++) {
+		for (int c = 0; c &lt; channels; c++) {
+			*data = roundf(*data * 32766 + rand_table[c][nr]);
+			if (*data &gt; 32767.0f) *data = 32767;
+			if (*data &lt; -32768.0f) *data = -32768;
+			*data_int = (int16_t) *data;
+			data++;
+			data_int++;
+		}
+		nr++;
+		if (nr &gt;= DITHER_SIZE)
+			nr = 0;
+	}
+}
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/src/CMakeLists.txt	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/src/CMakeLists.txt	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,8 @@
+SET(ADMaudioCore_SRCS
+ADM_audioUtils.cpp
+audioencoder.cpp
+)	
+ADD_LIBRARY(ADM_coreAudio SHARED ${ADMaudioCore_SRCS})
+INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/avidemux/ADM_coreAudio/include)
+
+INSTALL(TARGETS ADM_coreAudio RUNTIME DESTINATION ${BIN_DIR}  LIBRARY DESTINATION lib  ARCHIVE DESTINATION lib)

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/src/audioencoder.cpp (from rev 4205, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.cpp)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audiofilter/audioencoder.cpp	2008-07-07 17:43:08 UTC (rev 4205)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreAudio/src/audioencoder.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -0,0 +1,147 @@
+ 
+/***************************************************************************
+    copyright            : (C) 2002-6 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include &quot;ADM_default.h&quot;
+#include &quot;ADM_coreAudio.h&quot;
+#include &quot;ADM_audiofilter/audioprocess.hxx&quot;
+#include &quot;ADM_audiofilter/audioeng_process.h&quot;
+#include &quot;audioencoder.h&quot;
+
+AUDMEncoder::AUDMEncoder(AUDMAudioFilter *in)  :AVDMGenericAudioStream  ()
+{
+  _wavheader = new WAVHeader;
+  _incoming=in;
+  memcpy(_wavheader, _incoming-&gt;getInfo(), sizeof(WAVHeader));
+  _wavheader-&gt;encoding=WAV_AAC;
+  _incoming-&gt;rewind();	// rewind
+  _extraData=NULL;
+  _extraSize=0;
+  tmpbuffer=new float[_wavheader-&gt;frequency*_wavheader-&gt;channels];
+  tmphead=tmptail=0;
+  eof_met=0;
+  
+};
+/********************/
+AUDMEncoder::~AUDMEncoder()
+{
+  cleanup();
+};
+/********************/
+uint8_t AUDMEncoder::cleanup(void)
+{
+  if(_wavheader) delete(_wavheader);
+  _wavheader=NULL;
+
+  if(_extraData) delete [] _extraData;
+  _extraData=NULL;
+  
+  if(tmpbuffer) delete [] tmpbuffer;
+  tmpbuffer=NULL;
+};
+/********************/
+
+uint8_t AUDMEncoder::refillBuffer(int minimum)
+{
+  uint32_t filler=_wavheader-&gt;frequency*_wavheader-&gt;channels;
+  uint32_t nb;
+  AUD_Status status;
+  if(eof_met) return 0;
+  while(1)
+  {
+    ADM_assert(tmptail&gt;=tmphead);
+    if((tmptail-tmphead)&gt;=minimum) return 1;
+  
+    if(tmphead &amp;&amp; tmptail&gt;filler/2)
+    {
+      memmove(&amp;tmpbuffer[0],&amp;tmpbuffer[tmphead],(tmptail-tmphead)*sizeof(float)); 
+      tmptail-=tmphead;
+      tmphead=0;
+    }
+    ADM_assert(filler&gt;tmptail);
+    nb=_incoming-&gt;fill( (filler-tmptail)/2,&amp;tmpbuffer[tmptail],&amp;status);
+    if(!nb)
+    {
+      if(status!=AUD_END_OF_STREAM) ADM_assert(0);
+      
+      if((tmptail-tmphead)&lt;minimum)
+      {
+        memset(&amp;tmpbuffer[tmptail],0,sizeof(float)*(minimum-(tmptail-tmphead)));
+        tmptail=tmphead+minimum;
+        eof_met=1;  
+        return minimum;
+      }
+      else continue;
+    } else
+      tmptail+=nb;
+  }
+}
+
+
+/**
+ * 	\fn reorderChannels
+ *  \brief Reorder the channels
+ */
+void AUDMEncoder::reorderChannels(float *data, uint32_t nb,CHANNEL_TYPE *input,CHANNEL_TYPE *output)
+{
+	float tmp [_wavheader-&gt;channels];
+	static uint8_t reorder[MAX_CHANNELS];
+	static bool reorder_on;
+	
+	
+		reorder_on = 0;
+		int j = 0;
+		// Should we reorder the channels (might be needed for encoder ?
+		if (_wavheader-&gt;channels &gt; 2) 
+		{
+			CHANNEL_TYPE *p_ch_type;
+			for (int i = 0; i &lt; _wavheader-&gt;channels; i++) 
+			{
+				for (int c = 0; c &lt; _wavheader-&gt;channels; c++) 
+				{
+					if (input[c] == output[i]) 
+					{
+						if (j != c)
+							reorder_on = 1;
+						reorder[j++] = c;
+					}
+				}
+			}
+		}
+	
+
+	if (reorder_on)
+		for (int i = 0; i &lt; nb; i++) {
+			memcpy(tmp, data, sizeof(tmp));
+			for (int c = 0; c &lt; _wavheader-&gt;channels; c++)
+				*data++ = tmp[reorder[c]];
+		}
+
+}
+
+uint32_t AUDMEncoder::read(uint32_t len,uint8_t *buffer)
+{
+  ADM_assert(0);
+  return 0; 
+}
+
+uint32_t AUDMEncoder::grab(uint8_t * obuffer)
+{
+  uint32_t len,sam;
+  if(getPacket(obuffer,&amp;len,&amp;sam))
+    return len;
+  return MINUS_ONE;
+}
+
+//EOF

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/avifmt2.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/avifmt2.h	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ADM_utilities/avifmt2.h	2008-07-16 17:39:39 UTC (rev 4221)
@@ -44,7 +44,7 @@
 #define AVI_KEY_FRAME   0x10
 #define AVI_B_FRAME	0x4000	 // hopefully it is not used..
 
-#include &quot;../../ADM_audio/ADM_audiodef.h&quot;
+#include &quot;ADM_coreAudio/include/ADM_coreAudio.h&quot;
 
 void Endian_AviMainHeader(MainAVIHeader *m);
 void Endian_BitMapInfo( ADM_BITMAPINFOHEADER *b);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -34,7 +34,7 @@
 #include &quot;ADM_videoFilter/ADM_vidVobSub.h&quot;
 
 #include &quot;ADM_encoder/ADM_vidEncode.hxx&quot;
-#include &quot;ADM_audiofilter/audioencoder.h&quot;
+#include &quot;ADM_coreAudio/include/audioencoder.h&quot;
 #include &quot;ADM_lavcodec.h&quot;
 #include &quot;ADM_codecs/ADM_ffmpegConfig.h&quot;
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -22,8 +22,9 @@
 
 
 #include &quot;ADM_encoder/ADM_vidEncode.hxx&quot;
-#include &quot;ADM_audiofilter/audioencoder.h&quot;
+#include &quot;ADM_audioEncoder/include/audioencoder_enum.h&quot;
 
+
 #ifdef USE_XX_XVID 
 #include &quot;xvid.h&quot;
 int  DIA_getXvidCompressParams(COMPRESSION_MODE * mode, uint32_t * qz,

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_filters/Q_mainfilter.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -32,7 +32,6 @@
 
 # include &quot;prefs.h&quot;
 #include &quot;ADM_audiodevice/audio_out.h&quot;
-#include &quot;ADM_audio/ADM_audiodef.h&quot;
 
 #include &quot;ADM_userInterfaces/ADM_render/GUI_render.h&quot;
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_audioconfig.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_audioconfig.cpp	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_audioconfig.cpp	2008-07-16 17:39:39 UTC (rev 4221)
@@ -20,7 +20,7 @@
 #include &quot;DIA_factory.h&quot;
 #include &quot;../../ADM_audiofilter/audioprocess.hxx&quot;
 #include &quot;../../ADM_audiofilter/audioeng_process.h&quot;
-#include &quot;../../ADM_audiofilter/audioencoder.h&quot;
+#include &quot;ADM_coreAudio/include/audioencoder.h&quot;
 
 /**
       \fn DIA_defaultSettings

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt	2008-07-16 13:07:21 UTC (rev 4220)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt	2008-07-16 17:39:39 UTC (rev 4221)
@@ -56,6 +56,7 @@
 INCLUDE_DIRECTORIES(&quot;${CMAKE_CURRENT_SOURCE_DIR}/ADM_core/include&quot;)
 INCLUDE_DIRECTORIES(&quot;${CMAKE_CURRENT_SOURCE_DIR}/ADM_coreUI/include&quot;)
 INCLUDE_DIRECTORIES(&quot;${CMAKE_CURRENT_SOURCE_DIR}/ADM_coreImage/include&quot;)
+INCLUDE_DIRECTORIES(&quot;${CMAKE_CURRENT_SOURCE_DIR}/ADM_coreAudio/include&quot;)
 INCLUDE_DIRECTORIES(&quot;${CMAKE_CURRENT_SOURCE_DIR}/ADM_libraries/ADM_utilities&quot;)
 INCLUDE_DIRECTORIES(&quot;${CMAKE_CURRENT_SOURCE_DIR}/ADM_libraries/ADM_ffmpeg/ADM_lavutil&quot;)
 INCLUDE_DIRECTORIES(&quot;${CMAKE_CURRENT_SOURCE_DIR}/ADM_libraries/ADM_ffmpeg/ADM_lavcodec&quot;)
@@ -151,6 +152,7 @@
 ########################################
 SET(ADM_SUBDIR 
 	ADM_audiofilter
+	ADM_audioEncoder
 	ADM_editor
 	ADM_audiocodec
 	ADM_audio
@@ -220,7 +222,6 @@
 	ADD_SUBDIRECTORY(${_current})
 	ADD_ADMLIB_ALL_TARGETS(${_current})
 ENDFOREACH(_current ${ADM_TAILS})
-
 ###########################################
 # Construct ADM_libraries
 ###########################################
@@ -316,7 +317,12 @@
 ADD_LIB_ALL_TARGETS(ADM_coreUI)
 ADD_SUBDIRECTORY(ADM_coreImage)
 ADD_LIB_ALL_TARGETS(ADM_coreImage)
+ADD_SUBDIRECTORY(ADM_coreAudio)
+ADD_LIB_ALL_TARGETS(ADM_coreAudio)
 
+# To be removed
+ADD_SUBDIRECTORY(ADM_audioEncoder)
+
 ###########################################
 # External libs
 ###########################################
@@ -375,23 +381,6 @@
 		TARGET_LINK_LIBRARIES(avidemux2_qt4 ${SDL_LIBRARY})
 	ENDIF (ADM_UI_QT4)
 ENDIF (USE_SDL)
-if(0)
-# aRts
-IF (USE_ARTS)
-	IF (ADM_UI_GTK)
-		ADD_TARGET_LDFLAGS(avidemux2_gtk ${ARTS_LDFLAGS})
-	ENDIF (ADM_UI_GTK)
-
-	IF (ADM_UI_QT4)
-		ADD_TARGET_LDFLAGS(avidemux2_qt4 ${ARTS_LDFLAGS})
-	ENDIF (ADM_UI_QT4)
-ENDIF (USE_ARTS)
-
-# JACK
-IF (USE_JACK)
-	ADD_LIB_ALL_TARGETS(&quot;${JACK_LIBRARY_DIR}&quot;)
-ENDIF (USE_JACK)
-endif(0)
 # LAME
 IF (HAVE_LIBMP3LAME)
 	ADD_LIB_ALL_TARGETS(&quot;${LAME_LIBRARY_DIR}&quot;)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001468.html">[Avidemux-svn-commit] r4220 -	branches/avidemux_2.4_branch/avidemux/ADM_inputs/ADM_mp4
</A></li>
	<LI>Next message: <A HREF="001470.html">[Avidemux-svn-commit] r4222 - in	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_audioEncoder:	. src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1469">[ date ]</a>
              <a href="thread.html#1469">[ thread ]</a>
              <a href="subject.html#1469">[ subject ]</a>
              <a href="author.html#1469">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
