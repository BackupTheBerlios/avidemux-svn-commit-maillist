From mean at mail.berlios.de  Tue Nov  1 14:30:43 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue,  1 Nov 2011 14:30:43 +0100
Subject: [Avidemux-svn-commit] r7639 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3:
	include src
Message-ID: <20111101133043.EF871481280@sheep.berlios.de>

Author: mean
Date: 2011-11-01 14:30:43 +0100 (Tue, 01 Nov 2011)
New Revision: 7639

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/include/SysLog2.h
Removed:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/include/SysLog.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/src/SysLog.cpp
Log:
[core/sql] Rename syslog to syslog2 to avoid issue

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/include/SysLog.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/include/SysLog.h	2011-10-31 06:54:31 UTC (rev 7638)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/include/SysLog.h	2011-11-01 13:30:43 UTC (rev 7639)
@@ -1,63 +0,0 @@
-/*
- **	SysLog.h
- **
- **	Published / author: 2004-08-18 / grymse at alhem.net
- **/
-
-/*
-Copyright (C) 2004,2005,2006  Anders Hedstrom
-
-This program is made available under the terms of the GNU GPL.
-
-If you would like to use this program in a closed-source application,
-a separate license agreement is available. For information about 
-the closed-source license agreement for this program, please
-visit http://www.alhem.net/sqlwrapped/license.html and/or
-email license at alhem.net.
-
-This program is free software; you can redistribute it and/or
-modify it under the terms of the GNU General Public License
-as published by the Free Software Foundation; either version 2
-of the License, or (at your option) any later version.
-
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
-
-You should have received a copy of the GNU General Public License
-along with this program; if not, write to the Free Software
-Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-*/
-#ifndef _SYSLOG_H_SQLITE
-#define _SYSLOG_H_SQLITE
-#ifndef WIN32
-
-#include <syslog.h>
-
-
-#ifdef SQLITEW_NAMESPACE
-namespace SQLITEW_NAMESPACE {
-#endif
-
-
-/** Log class writing to syslog. */
-class SysLog : public IError
-{
-public:
-	SysLog(const std::string& = "database", int = LOG_PID, int = LOG_USER);
-	virtual ~SysLog();
-
-	void error(Database&,const std::string&);
-	void error(Database&,Query&,const std::string&);
-
-};
-
-
-
-#ifdef SQLITEW_NAMESPACE
-} // namespace SQLITEW_NAMESPACE {
-#endif
-
-#endif // WIN32
-#endif // _SYSLOG_H

Copied: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/include/SysLog2.h (from rev 7638, branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/include/SysLog.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/include/SysLog2.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/include/SysLog2.h	2011-11-01 13:30:43 UTC (rev 7639)
@@ -0,0 +1,63 @@
+/*
+ **	SysLog.h
+ **
+ **	Published / author: 2004-08-18 / grymse at alhem.net
+ **/
+
+/*
+Copyright (C) 2004,2005,2006  Anders Hedstrom
+
+This program is made available under the terms of the GNU GPL.
+
+If you would like to use this program in a closed-source application,
+a separate license agreement is available. For information about 
+the closed-source license agreement for this program, please
+visit http://www.alhem.net/sqlwrapped/license.html and/or
+email license at alhem.net.
+
+This program is free software; you can redistribute it and/or
+modify it under the terms of the GNU General Public License
+as published by the Free Software Foundation; either version 2
+of the License, or (at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+*/
+#ifndef _SYSLOG_H_SQLITE
+#define _SYSLOG_H_SQLITE
+#ifndef WIN32
+
+#include <syslog.h>
+
+
+#ifdef SQLITEW_NAMESPACE
+namespace SQLITEW_NAMESPACE {
+#endif
+
+
+/** Log class writing to syslog. */
+class SysLog : public IError
+{
+public:
+	SysLog(const std::string& = "database", int = LOG_PID, int = LOG_USER);
+	virtual ~SysLog();
+
+	void error(Database&,const std::string&);
+	void error(Database&,Query&,const std::string&);
+
+};
+
+
+
+#ifdef SQLITEW_NAMESPACE
+} // namespace SQLITEW_NAMESPACE {
+#endif
+
+#endif // WIN32
+#endif // _SYSLOG_H

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/src/SysLog.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/src/SysLog.cpp	2011-10-31 06:54:31 UTC (rev 7638)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSqlLight3/src/SysLog.cpp	2011-11-01 13:30:43 UTC (rev 7639)
@@ -38,7 +38,7 @@
 #include "Database.h"
 #include "Query.h"
 #include "IError.h"
-#include "SysLog.h"
+#include "SysLog2.h"
 
 
 #ifdef SQLITEW_NAMESPACE



From mean at mail.berlios.de  Tue Nov  1 15:04:20 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue,  1 Nov 2011 15:04:20 +0100
Subject: [Avidemux-svn-commit] r7640 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_mad
Message-ID: <20111101140421.0817B481280@sheep.berlios.de>

Author: mean
Date: 2011-11-01 15:04:20 +0100 (Tue, 01 Nov 2011)
New Revision: 7640

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_mad/ADM_ad_mad.cpp
Log:
[Mad] Say the error is coming from mad

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_mad/ADM_ad_mad.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_mad/ADM_ad_mad.cpp	2011-11-01 13:30:43 UTC (rev 7639)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_mad/ADM_ad_mad.cpp	2011-11-01 14:04:20 UTC (rev 7640)
@@ -128,7 +128,7 @@
         {
             if (MAD_RECOVERABLE(Stream->error))
             {
-                    printf(" error :%x \n",(int)Stream->error);
+                    ADM_info("[Mad:Error] %x \n",(int)Stream->error);
             } else
             {
                 if (Stream->error == MAD_ERROR_BUFLEN)	// we consumed everything



From mean at mail.berlios.de  Tue Nov  1 15:04:22 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue,  1 Nov 2011 15:04:22 +0100
Subject: [Avidemux-svn-commit] r7641 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <20111101140422.45E85481280@sheep.berlios.de>

Author: mean
Date: 2011-11-01 15:04:22 +0100 (Tue, 01 Nov 2011)
New Revision: 7641

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
Log:
[editor] switch all audio tracks if possible

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2011-11-01 14:04:20 UTC (rev 7640)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2011-11-01 14:04:22 UTC (rev 7641)
@@ -515,26 +515,25 @@
 WAVHeader *wav;
 aviInfo    info;
 uint32_t ref;
-
-
-        if(false==_segments.getRefFromTime(xtime,&ref))  
+        int n=_segments.getNbRefVideos();
+        packetBufferSize=0; // Flush PCM decoder
+        for(int i=0;i<n;i++)
         {
-            ADM_warning("[Editor::changeAudioStream] Cannot get ref video for time %"LLD" ms\n",xtime/1000);
-            return 0;
+            _VIDEOS *v=_segments.getRefVideo(i);
+            uint32_t nb=v->audioTracks.size();
+            if(newstream>=nb)
+            {
+                ADM_warning("[Editor::changeAudioStream] New stream exceeds # of stream (%d/%d)\n",(int)newstream,(int)nb);
+                continue;
+            }
+            v->currentAudioStream=newstream;
+            if(!i) // update general info for track 0
+            {
+                wavHeader.frequency=v->audioTracks[newstream]->wavheader.frequency;
+                wavHeader.channels=v->audioTracks[newstream]->wavheader.channels;
+            }
+            ADM_info("Switched to track %d for video %d\n",newstream,i);
         }
-        _VIDEOS *v=_segments.getRefVideo(ref);
-        ADM_assert(v);
-        uint32_t nb=v->audioTracks.size();
-        if(newstream>=nb)
-        {
-            ADM_warning("[Editor::changeAudioStream] New stream exceeds # of stream (%d/%d)\n",(int)newstream,(int)nb);
-            return false;
-        }
-        v->currentAudioStream=newstream;
-        // Change our header also
-        wavHeader.frequency=v->audioTracks[newstream]->wavheader.frequency;
-        wavHeader.channels=v->audioTracks[newstream]->wavheader.channels;
-        //ADM_warning("New fq=%d\n",(int)wavHeader.frequency);
         return true;
 }
 



From gruntster at mail.berlios.de  Tue Nov  1 17:42:37 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue,  1 Nov 2011 17:42:37 +0100
Subject: [Avidemux-svn-commit] r7642 - in branches:
	avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux
	avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools
	avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame
	avidemux_2.5_branch_gruntster/platforms/windows/installer
	avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux
	avidemux_2.6_branch_mean/foreignBuilds/mswin/lame
Message-ID: <20111101164237.B4968481280@sheep.berlios.de>

Author: gruntster
Date: 2011-11-01 17:42:37 +0100 (Tue, 01 Nov 2011)
New Revision: 7642

Added:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/vbrquantize.c.patch
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/lame/vbrquantize.c.patch
Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/package_notes.xslt
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Package Notes.xml
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/lame/Perform Build.bat
Log:
[mswin] misc changes to build scripts

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml	2011-11-01 14:04:22 UTC (rev 7641)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml	2011-11-01 16:42:37 UTC (rev 7642)
@@ -1,5 +1,6 @@
 <?xml version="1.0"?>
 <log>
+  <buildentry revision="7609" date="2011-10-12" />
   <buildentry revision="7573" date="2011-09-22">
     <comment>Updated x264 to r2085.</comment>
   </buildentry>

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/package_notes.xslt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/package_notes.xslt	2011-11-01 14:04:22 UTC (rev 7641)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/package_notes.xslt	2011-11-01 16:42:37 UTC (rev 7642)
@@ -54,10 +54,10 @@
           padding-bottom: 5px;
           }
         </style>
-        <title>Avidemux 2.5 Win32 Package Notes</title>
+        <title>Avidemux 2.5 Windows Package Notes</title>
       </head>
       <body>
-        <h1>Avidemux 2.5 Win32 Package Notes</h1>
+        <h1>Avidemux 2.5 Windows Package Notes</h1>
         <div>
           <xsl:apply-templates select="buildentry" />
         </div>

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/Perform Build.bat	2011-11-01 14:04:22 UTC (rev 7641)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/Perform Build.bat	2011-11-01 16:42:37 UTC (rev 7642)
@@ -17,15 +17,16 @@
 call "../Set Common Environment Variables"
 if errorlevel 1 goto end
 
-set package=lame-3.98.4.tar.gz
-set sourceFolder=lame-3.98.4-%BuildBits%
-set tarFolder=lame-3.98.4
+set version=3.99
+set package=lame-%version%.tar.gz
+set sourceFolder=lame-%version%-%BuildBits%
+set tarFolder=lame-%version%
 set curDir=%CD%
 
 if not exist %package% (
 	echo.
 	echo Downloading
-	wget http://sourceforge.net/projects/lame/files/lame/3.98.4/%package%/download/
+	wget http://sourceforge.net/projects/lame/files/lame/%version%/%package%/download/
 )
 
 if errorlevel 1 goto end
@@ -48,6 +49,10 @@
 )
 
 echo.
+echo Patching
+patch -p0 -i "%curDir%\vbrquantize.c.patch"
+
+echo.
 echo Configuring
 set CFLAGS=%CFLAGS% -O2
 

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/vbrquantize.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/vbrquantize.c.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/vbrquantize.c.patch	2011-11-01 16:42:37 UTC (rev 7642)
@@ -0,0 +1,12 @@
+--- ./libmp3lame/vbrquantize.c.org	2011-05-07 17:05:17 +0100
++++ ./libmp3lame/vbrquantize.c	2011-11-01 14:08:17 +0000
+@@ -22,6 +22,9 @@
+ 
+ /* $Id: vbrquantize.c,v 1.141 2011/05/07 16:05:17 rbrito Exp $ */
+ 
++#undef FORCEINLINE
++#define FORCEINLINE
++
+ #ifdef HAVE_CONFIG_H
+ #  include <config.h>
+ #endif

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2011-11-01 14:04:22 UTC (rev 7641)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2011-11-01 16:42:37 UTC (rev 7642)
@@ -16,7 +16,7 @@
 # Defines
 ##########################
 
-!define PRODUCT_VERSION "2.5.4.${REVISION}"
+!define PRODUCT_VERSION "2.5.5.${REVISION}"
 !define PRODUCT_NAME "Avidemux 2.5"
 !define PRODUCT_FULLNAME "Avidemux ${PRODUCT_VERSION} (${BUILD_BITS}-bit beta)"
 

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Package Notes.xml
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Package Notes.xml	2011-11-01 14:04:22 UTC (rev 7641)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Package Notes.xml	2011-11-01 16:42:37 UTC (rev 7642)
@@ -1,5 +1,6 @@
 <?xml version="1.0"?>
 <log>
+  <buildentry revision="7604" date="2011-10-11" />
   <buildentry revision="7590" date="2011-09-28" />
   <buildentry revision="7573" date="2011-09-22">
     <comment>Updated x264 to r2085.</comment>

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/lame/Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/lame/Perform Build.bat	2011-11-01 14:04:22 UTC (rev 7641)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/lame/Perform Build.bat	2011-11-01 16:42:37 UTC (rev 7642)
@@ -17,15 +17,16 @@
 call "../Set Common Environment Variables"
 if errorlevel 1 goto end
 
-set package=lame-3.98.4.tar.gz
-set sourceFolder=lame-3.98.4-%BuildBits%
-set tarFolder=lame-3.98.4
+set version=3.99
+set package=lame-%version%.tar.gz
+set sourceFolder=lame-%version%-%BuildBits%
+set tarFolder=lame-%version%
 set curDir=%CD%
 
 if not exist %package% (
 	echo.
 	echo Downloading
-	wget http://sourceforge.net/projects/lame/files/lame/3.98.4/%package%/download/
+	wget http://sourceforge.net/projects/lame/files/lame/%version%/%package%/download/
 )
 
 if errorlevel 1 goto end
@@ -48,6 +49,10 @@
 )
 
 echo.
+echo Patching
+patch -p0 -i "%curDir%\vbrquantize.c.patch"
+
+echo.
 echo Configuring
 set CFLAGS=%CFLAGS% -O2
 

Added: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/lame/vbrquantize.c.patch
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/lame/vbrquantize.c.patch	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/lame/vbrquantize.c.patch	2011-11-01 16:42:37 UTC (rev 7642)
@@ -0,0 +1,12 @@
+--- ./libmp3lame/vbrquantize.c.org	2011-05-07 17:05:17 +0100
++++ ./libmp3lame/vbrquantize.c	2011-11-01 14:08:17 +0000
+@@ -22,6 +22,9 @@
+ 
+ /* $Id: vbrquantize.c,v 1.141 2011/05/07 16:05:17 rbrito Exp $ */
+ 
++#undef FORCEINLINE
++#define FORCEINLINE
++
+ #ifdef HAVE_CONFIG_H
+ #  include <config.h>
+ #endif



From gruntster at mail.berlios.de  Tue Nov  1 18:01:38 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue,  1 Nov 2011 18:01:38 +0100
Subject: [Avidemux-svn-commit] r7643 - in branches:
	avidemux_2.5_branch_gruntster/cmake avidemux_2.6_branch_mean/cmake
Message-ID: <20111101170138.A75A7481351@sheep.berlios.de>

Author: gruntster
Date: 2011-11-01 18:01:38 +0100 (Tue, 01 Nov 2011)
New Revision: 7643

Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admGetRevision.cmake
   branches/avidemux_2.6_branch_mean/cmake/admGetRevision.cmake
Log:
[cmake] stamp application with last svn commit revision rather than current revision

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admGetRevision.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admGetRevision.cmake	2011-11-01 16:42:37 UTC (rev 7642)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admGetRevision.cmake	2011-11-01 17:01:38 UTC (rev 7643)
@@ -7,7 +7,7 @@
         MESSAGE(STATUS "Seems to be SVN...")
         FIND_PACKAGE( Subversion)
         Subversion_WC_INFO( ${_dir} ADM_SVN)
-        SET(${_rev} ${ADM_SVN_WC_REVISION})
+        SET(${_rev} ${ADM_SVN_WC_LAST_CHANGED_REV})
 else (EXISTS "${_dir}/.svn")
         if (EXISTS "${_dir}/.git")
                 MESSAGE(STATUS "Seems to be git svn...")

Modified: branches/avidemux_2.6_branch_mean/cmake/admGetRevision.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admGetRevision.cmake	2011-11-01 16:42:37 UTC (rev 7642)
+++ branches/avidemux_2.6_branch_mean/cmake/admGetRevision.cmake	2011-11-01 17:01:38 UTC (rev 7643)
@@ -7,7 +7,7 @@
         MESSAGE(STATUS "Seems to be SVN...")
         FIND_PACKAGE( Subversion)
         Subversion_WC_INFO( ${_dir} ADM_SVN)
-        SET(${_rev} ${ADM_SVN_WC_REVISION})
+        SET(${_rev} ${ADM_SVN_WC_LAST_CHANGED_REV})
 else (EXISTS "${_dir}/.svn")
         if (EXISTS "${_dir}/.git")
                 MESSAGE(STATUS "Seems to be git or git-svn...")



From mean at mail.berlios.de  Wed Nov  2 07:27:33 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  2 Nov 2011 07:27:33 +0100
Subject: [Avidemux-svn-commit] r7644 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv
Message-ID: <20111102062733.BF3E3481169@sheep.berlios.de>

Author: mean
Date: 2011-11-02 07:27:33 +0100 (Wed, 02 Nov 2011)
New Revision: 7644

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp
Log:
[flv] Better compatibility with metadata (merge from 2.6)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp	2011-11-01 17:01:38 UTC (rev 7643)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp	2011-11-02 06:27:33 UTC (rev 7644)
@@ -85,13 +85,27 @@
     \fn     readFlvString
     \brief  read pascal like string
 */
+#define FLV_MAX_STRING 255
 char *flvHeader::readFlvString(void)
 {
-static char stringz[255];
+static uint8_t stringz[FLV_MAX_STRING+1];
     int size=read16();
-    read(size,(uint8_t *)stringz);
+    if(size>FLV_MAX_STRING)
+    {
+        int pre=FLV_MAX_STRING;
+        read(pre,stringz);
+        printf("String way too large :%d\n",size);
+        mixDump(stringz,pre);
+        stringz[0]='X';
+        stringz[1]='X';
+        stringz[2]=0;
+        stringz[FLV_MAX_STRING]=0;
+        Skip(size-FLV_MAX_STRING);
+        return (char *)stringz;
+    }
+    read(size,stringz);
     stringz[size]=0;
-    return stringz;
+    return (char *)stringz;
 }
 
 extern "C" {
@@ -212,24 +226,18 @@
 uint8_t flvHeader::parseMetaData(uint32_t remaining)
 {
     uint32_t endPos=ftello(_fd)+remaining;
+    // Check the first one is onMetaData...
+    uint8_t type=read8();
+    char *z;
+    if(type!=AMF_DATA_TYPE_STRING) // String!
+        goto endit;
+    z=readFlvString();
+    printf("[FlashString] %s\n",z);
+    if(z && strncmp(z,"onMetaData",10)) goto endit;
+    // Normally the next one is mixed array
+    while(ftello(_fd)<endPos-4)
     {
-        // Check the first one is onMetaData...
-        uint8_t type=read8();
-        if(type!=AMF_DATA_TYPE_STRING) // String!
-            goto endit;
-        char *z=readFlvString();
-        printf("[FlashString] %s\n",z);
-        if(z && strncmp(z,"onMetaData",10)) goto endit;
-        // Normally the next one is mixed array
-        Skip(4);
-        Skip(1);
-        while(ftello(_fd)<endPos-4)
-        {
-            char *s=readFlvString();
-            printf("[FlvType]  String : %s ",s);
-            
-            if(false==parseOneMeta(s,endPos)) goto endit;
-        }
+         if(false==parseOneMeta("meta",endPos)) goto endit;
     }
 endit:
     fseeko(_fd,endPos,SEEK_SET);



From mean at mail.berlios.de  Wed Nov  2 08:03:56 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  2 Nov 2011 08:03:56 +0100
Subject: [Avidemux-svn-commit] r7645 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src
Message-ID: <20111102070357.2B9BE48146F@sheep.berlios.de>

Author: mean
Date: 2011-11-02 08:03:56 +0100 (Wed, 02 Nov 2011)
New Revision: 7645

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoder.cpp
Log:
[core] When extracting name from full path, also take \ as valid folder delimiter for win32

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoder.cpp	2011-11-02 06:27:33 UTC (rev 7644)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoder.cpp	2011-11-02 07:03:56 UTC (rev 7645)
@@ -223,12 +223,17 @@
         ADM_info("No preset found\n");
         return true;
     }
+    size_t lastSlash,lastBackSlash,lastDot;
     for(int i=0;i<nb;i++)
     {
         std::string s=std::string(list[i]);
-        size_t lastSlash=s.find_last_of('/');
+        lastSlash=s.find_last_of('/');
         s.replace(0,lastSlash+1,std::string(""));
-        size_t lastDot=s.find_last_of('.');
+#ifdef __WIN32 // also replace \ 
+        lastBackSlash=s.find_last_of('\\');
+        s.replace(0,lastBackSlash+1,std::string(""));
+#endif // 
+        lastDot=s.find_last_of('.');
         s.replace(lastDot,s.size(),std::string(""));
         // Remove extension
         listOut.push_back(s);



From mean at mail.berlios.de  Thu Nov  3 07:44:39 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu,  3 Nov 2011 07:44:39 +0100
Subject: [Avidemux-svn-commit] r7646 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src
Message-ID: <20111103064439.70E8548157C@sheep.berlios.de>

Author: mean
Date: 2011-11-03 07:44:38 +0100 (Thu, 03 Nov 2011)
New Revision: 7646

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoder.cpp
Log:
[videoEncoder] Preset management, try2 : work with win32 paths

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoder.cpp	2011-11-02 07:03:56 UTC (rev 7645)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoder.cpp	2011-11-03 06:44:38 UTC (rev 7646)
@@ -30,6 +30,9 @@
 #else
 const std::string slash=std::string("/");
 #endif
+
+#define MAX_NB_PRESET 30
+
 /**
     \fn ADM_coreVideoEncoder
 */                          
@@ -173,6 +176,28 @@
     return true;
 }
 /**
+    \fn getFileNameAndExt
+    \brief only keep filename and ext from input (i.e. remove folders)
+*/
+static bool getFileNameAndExt(const std::string &input, std::string &output)
+{
+    std::string s=input;
+    size_t lastSlash,lastBackSlash;
+    
+     lastSlash=s.find_last_of("/");
+     if(lastSlash!=-1)
+        s.replace(0,lastSlash+1,std::string(""));
+#ifdef __WIN32
+     lastBackSlash=s.find_last_of("\\");
+     if(lastBackSlash!=-1)
+        s.replace(0,lastBackSlash+1,std::string(""));
+#endif
+    ADM_info("Stripping : %s => %s\n",input.c_str(),s.c_str());
+    output=s;   
+    return true;
+}
+
+/**
     \fn ADM_pluginInstallSystem
     \brief Copy if needed the system presets to the user presets list
 */
@@ -181,11 +206,10 @@
     std::string sysPath,userPath;
     ADM_pluginSystemPath(pluginName,pluginVersion,sysPath);
     ADM_pluginGetPath(pluginName,pluginVersion,userPath);
-#define NB 20
-    char *list[NB];
+    char *list[MAX_NB_PRESET];
     uint32_t nb=0;
     ADM_info("Looking for file %s in folder %s\n",ext.c_str(),sysPath.c_str());
-    if(false==buildDirectoryContent(&nb,sysPath.c_str(),list,NB,ext.c_str()))
+    if(false==buildDirectoryContent(&nb,sysPath.c_str(),list,MAX_NB_PRESET,ext.c_str()))
     {
         ADM_info("No preset found\n");
         return true;
@@ -194,10 +218,9 @@
     for( int i=0;i<nb;i++)
     {
         std::string s=std::string(list[i]);
-        size_t lastSlash=s.find_last_of('/');
-        s.replace(0,lastSlash+1,std::string("")); // filename+ext
-        std::string file=s;
-        s=userPath+std::string("/")+s; // 
+        std::string file;
+        getFileNameAndExt(s,file);
+        s=userPath+slash+file; // 
         if(!ADM_fileExist(s.c_str()))
         {
             ADM_info("%s exists in system folder, but not in user folder, copying..\n",file.c_str());
@@ -213,7 +236,7 @@
 */
 bool ADM_listFile(const std::string path,const std::string extension,vector <std::string > & listOut)
 {
-#define NB 20
+#define NB 30
     char *list[NB];
     uint32_t nb=0;
 
@@ -223,20 +246,17 @@
         ADM_info("No preset found\n");
         return true;
     }
-    size_t lastSlash,lastBackSlash,lastDot;
+    size_t lastDot;
     for(int i=0;i<nb;i++)
     {
         std::string s=std::string(list[i]);
-        lastSlash=s.find_last_of('/');
-        s.replace(0,lastSlash+1,std::string(""));
-#ifdef __WIN32 // also replace \ 
-        lastBackSlash=s.find_last_of('\\');
-        s.replace(0,lastBackSlash+1,std::string(""));
-#endif // 
-        lastDot=s.find_last_of('.');
-        s.replace(lastDot,s.size(),std::string(""));
+        std::string file;
+        getFileNameAndExt(s,file);
+        lastDot=file.find_last_of('.');
         // Remove extension
-        listOut.push_back(s);
+        if(lastDot!=-1)
+            file.replace(lastDot,file.size(),std::string(""));
+        listOut.push_back(file);
     }
     clearDirectoryContent(nb,list);
     return true;



From mean at mail.berlios.de  Fri Nov  4 07:24:59 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri,  4 Nov 2011 07:24:59 +0100
Subject: [Avidemux-svn-commit] r7647 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4
Message-ID: <20111104062459.A809C480E33@sheep.berlios.de>

Author: mean
Date: 2011-11-04 07:24:59 +0100 (Fri, 04 Nov 2011)
New Revision: 7647

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.h
Log:
[x264 UI/Qt4] Fix subpixel refinement

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.cpp	2011-11-03 06:44:38 UTC (rev 7646)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.cpp	2011-11-04 06:24:59 UTC (rev 7647)
@@ -87,7 +87,9 @@
        ui.setupUi(this);
         connect(ui.encodingModeComboBox, SIGNAL(currentIndexChanged(int)), this, SLOT(encodingModeComboBox_currentIndexChanged(int)));
         connect(ui.quantiserSlider, SIGNAL(valueChanged(int)), this, SLOT(quantiserSlider_valueChanged(int)));
+        connect(ui.meSlider, SIGNAL(valueChanged(int)), this, SLOT(meSlider_valueChanged(int)));
         connect(ui.quantiserSpinBox, SIGNAL(valueChanged(int)), this, SLOT(quantiserSpinBox_valueChanged(int)));
+        connect(ui.meSpinBox, SIGNAL(valueChanged(int)), this, SLOT(meSpinBox_valueChanged(int)));
         connect(ui.targetRateControlSpinBox, SIGNAL(valueChanged(int)), this, SLOT(targetRateControlSpinBox_valueChanged(int)));
 #if 0
         connect(ui.maxCrfSlider, SIGNAL(valueChanged(int)), this, SLOT(maxCrfSlider_valueChanged(int)));
@@ -355,10 +357,18 @@
 	ui.quantiserSpinBox->setValue(value);
 }
 
+void x264Dialog::meSlider_valueChanged(int value)
+{
+	ui.meSpinBox->setValue(value);
+}
 void x264Dialog::quantiserSpinBox_valueChanged(int value)
 {
 	ui.quantiserSlider->setValue(value);
 }
+void x264Dialog::meSpinBox_valueChanged(int value)
+{
+	ui.meSlider->setValue(value);
+}
 
 void x264Dialog::targetRateControlSpinBox_valueChanged(int value)
 {

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.h	2011-11-03 06:44:38 UTC (rev 7646)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.h	2011-11-04 06:24:59 UTC (rev 7647)
@@ -30,6 +30,8 @@
 public slots:
 
 private slots:
+        void meSpinBox_valueChanged(int value);
+        void meSlider_valueChanged(int value);
         void encodingModeComboBox_currentIndexChanged(int index);
         void quantiserSlider_valueChanged(int value);
         void quantiserSpinBox_valueChanged(int value);



From mean at mail.berlios.de  Fri Nov  4 07:25:00 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri,  4 Nov 2011 07:25:00 +0100
Subject: [Avidemux-svn-commit] r7648 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4
Message-ID: <20111104062500.C7276480E33@sheep.berlios.de>

Author: mean
Date: 2011-11-04 07:25:00 +0100 (Fri, 04 Nov 2011)
New Revision: 7648

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.cpp
Log:
[x264-UI-QT4] Fix UI for max ref frame

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.cpp	2011-11-04 06:24:59 UTC (rev 7647)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.cpp	2011-11-04 06:25:00 UTC (rev 7648)
@@ -168,7 +168,7 @@
           MK_CHECKBOX(dctDecimateCheckBox,analyze.dct_decimate);
 
           MK_UINT(maxBFramesSpinBox,MaxBFrame);
-          MK_UINT(maxBFramesSpinBox,MaxRefFrames);
+          MK_UINT(refFramesSpinBox,MaxRefFrames);
           MK_UINT(minGopSizeSpinBox,MinIdr);
           MK_UINT(maxGopSizeSpinBox,MaxIdr);
           MK_UINT(meSpinBox,analyze.subpel_refine);
@@ -272,7 +272,7 @@
           MK_CHECKBOX(dctDecimateCheckBox,analyze.dct_decimate);
 
           MK_UINT(maxBFramesSpinBox,MaxBFrame);
-          MK_UINT(maxBFramesSpinBox,MaxRefFrames);
+          MK_UINT(refFramesSpinBox,MaxRefFrames);
           MK_UINT(minGopSizeSpinBox,MinIdr);
           MK_UINT(maxGopSizeSpinBox,MaxIdr);
           MK_UINT(meSpinBox,analyze.subpel_refine);



From mean at mail.berlios.de  Sat Nov  5 10:39:50 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  5 Nov 2011 10:39:50 +0100
Subject: [Avidemux-svn-commit] r7649 -
	branches/avidemux_2.6_branch_mean/cmake
Message-ID: <20111105093950.6161D48139B@sheep.berlios.de>

Author: mean
Date: 2011-11-05 10:39:49 +0100 (Sat, 05 Nov 2011)
New Revision: 7649

Modified:
   branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake
Log:
[ffmpeg] Bump to 0.8.6

Modified: branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake	2011-11-04 06:25:00 UTC (rev 7648)
+++ branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake	2011-11-05 09:39:49 UTC (rev 7649)
@@ -1,4 +1,4 @@
- set(FFMPEG_VERSION "850")	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz
+ set(FFMPEG_VERSION "860")	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz
 #set(FFMPEG_VERSION "efb5fa79f5ca34140db357a00c999286097ab53e")	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz
 #set(FFMPEG_VERSION "8cb3c557a9f3b24bc55325e3f64a2150b983305c")	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz
 



From mean at mail.berlios.de  Sat Nov  5 10:39:52 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  5 Nov 2011 10:39:52 +0100
Subject: [Avidemux-svn-commit] r7650 - in
	branches/avidemux_2.6_branch_mean/avidemux_core:
	ADM_coreVideoCodec/src ffmpeg_package/patches
Message-ID: <20111105093952.5EF4148139B@sheep.berlios.de>

Author: mean
Date: 2011-11-05 10:39:52 +0100 (Sat, 05 Nov 2011)
New Revision: 7650

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/libavcodec_h263dec.c.patch
Log:
[lav] Remove opaque patch, no longer needed

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2011-11-05 09:39:49 UTC (rev 7649)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2011-11-05 09:39:52 UTC (rev 7650)
@@ -100,9 +100,10 @@
       out->_qSize = out->_qStride = 0;
       out->quant = NULL;
     }
-    //printf("[LAVC] Old pts :%"LLD" new pts :%"LLD"\n",out->Pts, (uint64_t)(src->reordered_opaque));
+    uint64_t pts_opaque=(uint64_t)(src->reordered_opaque);
+    //printf("[LAVC] Old pts :%"LLD" new pts :%"LLD"\n",out->Pts, pts_opaque);
     //printf("[LAVC] pts: %"LLU"\n",src->pts);
-    out->Pts= (uint64_t)(src->reordered_opaque);
+    out->Pts= (uint64_t)(pts_opaque);
 
     return 1;
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/libavcodec_h263dec.c.patch
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/libavcodec_h263dec.c.patch	2011-11-05 09:39:49 UTC (rev 7649)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/libavcodec_h263dec.c.patch	2011-11-05 09:39:52 UTC (rev 7650)
@@ -26,31 +26,3 @@
  
  av_cold int ff_h263_decode_end(AVCodecContext *avctx)
  {
-@@ -431,6 +450,12 @@
-     } else {
-         ret = h263_decode_picture_header(s);
-     }
-+	//MEANX we need to do it here also for quicktime file / ctts atom 
-+        // we need the correct frame type, and qt file may contain 
-+        // vop not coded frame.
-+        pict->pict_type=s->current_picture.pict_type= s->pict_type;
-+        pict->key_frame=s->current_picture.key_frame= s->pict_type == FF_I_TYPE;
-+        //MEANX
- 
-     if(ret==FRAME_SKIPPED) return get_consumed_bytes(s, buf_size);
- 
-@@ -715,6 +740,14 @@
- 
- assert(s->current_picture.pict_type == s->current_picture_ptr->pict_type);
- assert(s->current_picture.pict_type == s->pict_type);
-+
-+/* MEANX */
-+  if(s->current_picture_ptr)
-+      s->current_picture_ptr->opaque=pict->opaque;
-+/* MEANX */
-+
-+
-+
-     if (s->pict_type == AV_PICTURE_TYPE_B || s->low_delay) {
-         *pict= *(AVFrame*)s->current_picture_ptr;
-     } else if (s->last_picture_ptr != NULL) {



From mean at mail.berlios.de  Sat Nov  5 10:42:21 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  5 Nov 2011 10:42:21 +0100
Subject: [Avidemux-svn-commit] r7652 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches
Message-ID: <20111105094221.EFF8E48139B@sheep.berlios.de>

Author: mean
Date: 2011-11-05 10:42:21 +0100 (Sat, 05 Nov 2011)
New Revision: 7652

Removed:
   branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/libavformat_file.c.patch
Log:
[ffmpeg] No more utf8<>ucs2 patch needed with recent ffmpeg

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/libavformat_file.c.patch
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/libavformat_file.c.patch	2011-11-05 09:41:05 UTC (rev 7651)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/libavformat_file.c.patch	2011-11-05 09:42:21 UTC (rev 7652)
@@ -1,78 +0,0 @@
---- libavformat/file.c	2011-08-10 14:18:20.000000000 +0200
-+++ libavformat/file.c	2011-09-03 08:35:49.575349178 +0200
-@@ -31,6 +31,75 @@
- #include "os_support.h"
- #include "url.h"
- 
-+// GRUNTSTER start
-+#ifdef __WIN32
-+#include <windows.h>
-+
-+int utf8StringToWideChar(const char *utf8String, int utf8StringLength, wchar_t *wideCharString);
-+int ADM_open(const char *path, int oflag, ...);
-+
-+int utf8StringToWideChar(const char *utf8String, int utf8StringLength, wchar_t *wideCharString)
-+{
-+	int wideCharStringLength = MultiByteToWideChar(CP_UTF8, 0, utf8String, utf8StringLength, NULL, 0);
-+
-+	if (wideCharString)
-+		MultiByteToWideChar(CP_UTF8, 0, utf8String, utf8StringLength, wideCharString, wideCharStringLength);
-+
-+	return wideCharStringLength;
-+}
-+
-+int ADM_open(const char *path, int oflag, ...)
-+{
-+	int fileNameLength = utf8StringToWideChar(path, -1, NULL);
-+	wchar_t wcFile[fileNameLength];
-+	int creation = 0, access = 0;
-+	HANDLE hFile;
-+
-+	utf8StringToWideChar(path, -1, wcFile);
-+
-+	if (oflag & O_WRONLY || oflag & O_RDWR)
-+	{
-+		access = GENERIC_WRITE;
-+
-+		if (oflag & O_RDWR)
-+			access |= GENERIC_READ;
-+
-+		if (oflag & O_CREAT)
-+		{
-+			if (oflag & O_EXCL)
-+				creation = CREATE_NEW;
-+			else if (oflag & O_TRUNC)
-+				creation = CREATE_ALWAYS;
-+			else
-+				creation = OPEN_ALWAYS;
-+		}
-+		else if (oflag & O_TRUNC)
-+			creation = TRUNCATE_EXISTING;
-+	}
-+	else if (oflag & O_RDONLY)
-+		creation = OPEN_EXISTING;
-+
-+	if (creation & GENERIC_WRITE)
-+	{
-+		hFile = CreateFileW(wcFile, access, 0, NULL, creation, 0, NULL);
-+
-+		if (hFile == INVALID_HANDLE_VALUE)
-+			return -1;
-+		else
-+			CloseHandle(hFile);
-+	}
-+
-+	hFile = CreateFileW(wcFile, access, FILE_SHARE_READ, NULL, creation, 0, NULL);
-+
-+	if (hFile == INVALID_HANDLE_VALUE)
-+		return -1;
-+	else
-+		return _open_osfhandle((intptr_t)hFile, oflag);
-+}
-+
-+#define open ADM_open
-+#endif
-+// GRUNTSTER end
- 
- /* standard file protocol */
- 



From mean at mail.berlios.de  Sat Nov  5 18:15:06 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  5 Nov 2011 18:15:06 +0100
Subject: [Avidemux-svn-commit] r7653 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreUI/include
Message-ID: <20111105171506.7A53948139B@sheep.berlios.de>

Author: mean
Date: 2011-11-05 18:15:06 +0100 (Sat, 05 Nov 2011)
New Revision: 7653

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreUI/include/DIA_factory.h
Log:
[DIA] Dont use tip=NULL, patch by nibbles, need for clang

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreUI/include/DIA_factory.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreUI/include/DIA_factory.h	2011-11-05 09:42:21 UTC (rev 7652)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreUI/include/DIA_factory.h	2011-11-05 17:15:06 UTC (rev 7653)
@@ -206,7 +206,7 @@
 };
 /*********************************************/
 typedef diaElem *CREATE_TOGGLE_UINT(uint32_t *toggleValue,const char *toggleTitle, uint32_t *uintval, 
-								const char *name,uint32_t min,uint32_t max,const char *tip=NULL);
+								const char *name,uint32_t min,uint32_t max,const char *tip);
 class diaElemToggleUint : public diaElem
 {
   protected:
@@ -226,7 +226,7 @@
   int getRequiredLayout(void);
 };
 typedef diaElem *CREATE_TOGGLE_INT(uint32_t *toggleValue,const char *toggleTitle, int32_t *intval, 
-									const char *name,int32_t min,int32_t max,const char *tip=NULL);
+									const char *name,int32_t min,int32_t max,const char *tip);
 class diaElemToggleInt : public diaElem
 {
   protected:
@@ -620,7 +620,7 @@
   void updateMe(void);
 };
 /**********************************************/
-typedef diaElem *(CREATE_THREADCOUNT_T)(uint32_t *value, const char *title, const char *tip = NULL);
+typedef diaElem *(CREATE_THREADCOUNT_T)(uint32_t *value, const char *title, const char *tip);
 class diaElemThreadCount : public diaElem
 {
 
@@ -634,7 +634,7 @@
   void updateMe(void);
 };
 /**********************************************/
-typedef diaElem *(CREATE_ASPECTRATIO_T)(uint32_t *value, const char *title, const char *tip = NULL);
+typedef diaElem *(CREATE_ASPECTRATIO_T)(uint32_t *value, const char *title, const char *tip);
 class diaElemAspectRatio : public diaElem
 {
 public:



From mean at mail.berlios.de  Sat Nov  5 18:15:07 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  5 Nov 2011 18:15:07 +0100
Subject: [Avidemux-svn-commit] r7654 -
	branches/avidemux_2.5_branch_gruntster/avidemux
Message-ID: <20111105171507.6B75648139B@sheep.berlios.de>

Author: mean
Date: 2011-11-05 18:15:07 +0100 (Sat, 05 Nov 2011)
New Revision: 7654

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt
Log:
[Mac] Fix BUNDLE, patch by nibbles

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt	2011-11-05 17:15:06 UTC (rev 7653)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/CMakeLists.txt	2011-11-05 17:15:07 UTC (rev 7654)
@@ -99,7 +99,7 @@
 	SET(MACOSX_BUNDLE_INFO_STRING "Avidemux ${ADM_OSX_VERSION}")
 	SET(MACOSX_BUNDLE_LONG_VERSION_STRING "${ADM_OSX_VERSION}") 
 	SET(MACOSX_BUNDLE_SHORT_VERSION_STRING "${ADM_OSX_VERSION}")
-	SET(MACOSX_BUNDLE_VERSION "${ADM_OSX_VERSION}")
+	SET(MACOSX_BUNDLE_BUNDLE_VERSION "${ADM_OSX_VERSION}")
 	SET(MACOSX_BUNDLE_BUNDLE_NAME "Avidemux" )
 	SET(MACOSX_BUNDLE_COPYRIGHT "Copyright 2001-2010 Mean" )
 	SET(MACOSX_BUNDLE_SIGNATURE "Avdx" )



From mean at mail.berlios.de  Sun Nov  6 19:16:17 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  6 Nov 2011 19:16:17 +0100
Subject: [Avidemux-svn-commit] r7655 - in branches/avidemux_2.6_branch_mean:
	avidemux_core/ADM_coreUtils/src
	avidemux_plugins/ADM_videoEncoder/x264
Message-ID: <20111106181617.D630A4815BA@sheep.berlios.de>

Author: mean
Date: 2011-11-06 19:16:17 +0100 (Sun, 06 Nov 2011)
New Revision: 7655

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/avidemutils.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/ADM_x264Setup.cpp
Log:
[2pass/X264] Fix average birate, was off by *1000 + be more verbose (x264)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/avidemutils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/avidemutils.cpp	2011-11-05 17:15:07 UTC (rev 7654)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/avidemutils.cpp	2011-11-06 18:16:17 UTC (rev 7655)
@@ -310,6 +310,11 @@
 bool ADM_computeAverageBitrateFromDuration(uint64_t duration, uint32_t sizeInMB, uint32_t *avgInKbits)
 {
     float f;
+    if(duration==ADM_NO_PTS)
+    {
+        ADM_error("[ADM_computeBitrateFromDuration] No source duration!\n");
+        return false;
+    }
     if(!duration) 
     {
         ADM_error("[ADM_computeBitrateFromDuration] No source duration!\n");
@@ -318,7 +323,8 @@
     f=sizeInMB; 
     f=f*1024*1024*8; // in bits
     f*=1000*1000;
-    f/=duration;
+    f/=duration; // bit/s
+    f/=1000; // in kbps
     *avgInKbits=(uint32_t)f;
     return true;
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/ADM_x264Setup.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/ADM_x264Setup.cpp	2011-11-05 17:15:07 UTC (rev 7654)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/ADM_x264Setup.cpp	2011-11-06 18:16:17 UTC (rev 7655)
@@ -21,6 +21,7 @@
 #undef ADM_MINIMAL_UI_INTERFACE // we need the full UI
 #include "DIA_factory.h"
 #include "DIA_coreToolkit.h"
+#include "ADM_vidMisc.h"
 #if 1
     #define aprintf(...) {}
     #define avsnprintf(...) {}
@@ -159,6 +160,8 @@
                         if(x264Settings.general.params.mode==COMPRESS_2PASS)
                         {
                             uint64_t duration=source->getInfo()->totalDuration; // in us
+                            ADM_info("Source duration :%s\n",ADM_us2plain(duration));
+                            ADM_info("Target size     :%d\n",(int)x264Settings.general.params.finalsize);
                             uint32_t avg;
                             if(false==ADM_computeAverageBitrateFromDuration(duration, 
                                             x264Settings.general.params.finalsize,



From mean at mail.berlios.de  Sun Nov  6 20:02:22 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  6 Nov 2011 20:02:22 +0100
Subject: [Avidemux-svn-commit] r7656 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src
Message-ID: <20111106190222.C3DBF48133D@sheep.berlios.de>

Author: mean
Date: 2011-11-06 20:02:22 +0100 (Sun, 06 Nov 2011)
New Revision: 7656

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
Log:
[ffmpeg video encoders] Stats must be allocated by av_malloc as it will be free-ed by av_close_context

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2011-11-06 18:16:17 UTC (rev 7655)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2011-11-06 19:02:22 UTC (rev 7656)
@@ -19,6 +19,11 @@
 #include "ADM_default.h"
 #include "ADM_coreVideoEncoderFFmpeg.h"
 #include "prefs.h"
+extern "C"
+{
+char *av_strdup(const char *s);
+void *av_malloc(size_t size) ;
+}
 //#define TIME_TENTH_MILLISEC
 #if 1
     #define aprintf(...) {}
@@ -319,7 +324,7 @@
   fseek (_statfile, 0, SEEK_END);
   statSize = ftello (_statfile);
   fseek (_statfile, 0, SEEK_SET);
-  _context->stats_in = (char *) ADM_alloc (statSize + 1);
+  _context->stats_in = (char *) av_malloc(statSize+1);
   _context->stats_in[statSize] = 0;
   fread (_context->stats_in, statSize, 1, _statfile);
   fclose(_statfile);
@@ -460,7 +465,6 @@
 
         }
 #undef SETX
-
   _context->bit_rate_tolerance = 8000000;
   _context->b_quant_factor = 1.25;
   _context->rc_strategy = 2;
@@ -473,7 +477,7 @@
   _context->rc_qsquish = 1.0;
   _context->rc_qmod_amp = 0;
   _context->rc_qmod_freq = 0;
-  _context->rc_eq = const_cast < char *>("tex^qComp");
+  _context->rc_eq = av_strdup("tex^qComp");
   _context->rc_max_rate = 000;
   _context->rc_min_rate = 000;
   _context->rc_buffer_size = 000;
@@ -521,7 +525,7 @@
                     printf("[ffMpeg4] No source duration!\n");
                     return false;
                 }
-                averageBitrate=(uint32_t)avg;
+                averageBitrate=(uint32_t)avg*1000; // convert from kb/s to b/s
             }
 
         printf("[ffmpeg4] Average bitrate =%"LU" kb/s\n",averageBitrate/1000);



From mean at mail.berlios.de  Mon Nov  7 07:37:44 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  7 Nov 2011 07:37:44 +0100
Subject: [Avidemux-svn-commit] r7657 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src
Message-ID: <20111107063744.ADA0B4815BA@sheep.berlios.de>

Author: mean
Date: 2011-11-07 07:37:44 +0100 (Mon, 07 Nov 2011)
New Revision: 7657

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_vidFieldASM.cpp
Log:
[fieldUtil] Patch for clang by nibbles

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_vidFieldASM.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_vidFieldASM.cpp	2011-11-06 19:02:22 UTC (rev 7656)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_vidFieldASM.cpp	2011-11-07 06:37:44 UTC (rev 7657)
@@ -141,8 +141,8 @@
                             "add 	$4,	"REG_ax"\n\t"
                             "add 	$4,	"REG_bx"\n\t"
                             "add 	$4,	"REG_cx"\n\t"
-                            "add 	$4,	"Mangle(_l_e)"\n\t"
-                            "add 	$4,	"Mangle(_l_e2)"\n\t"
+                            "addl 	$4,	"Mangle(_l_e)"\n\t"
+                            "addl 	$4,	"Mangle(_l_e2)"\n\t"
                             "sub 	$1,	"REG_si"\n\t"
                             "jnz 7b\n\t"
                             "pop "REG_bx"\n\t" // Dont clobber ebx for macOsX



From mean at mail.berlios.de  Tue Nov  8 07:33:14 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue,  8 Nov 2011 07:33:14 +0100
Subject: [Avidemux-svn-commit] r7658 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src
Message-ID: <20111108063315.2F6814815AA@sheep.berlios.de>

Author: mean
Date: 2011-11-08 07:33:14 +0100 (Tue, 08 Nov 2011)
New Revision: 7658

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_vidFieldBlend.cpp
Log:
[MacOsX] Asm fix by nibbles

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_vidFieldBlend.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_vidFieldBlend.cpp	2011-11-07 06:37:44 UTC (rev 7657)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/ADM_vidFieldBlend.cpp	2011-11-08 06:33:14 UTC (rev 7658)
@@ -163,7 +163,7 @@
 "add       $4,"REG_di" \n\t"
 "sub       $1,"REG_dx"	\n\t"
 "jne        DHLineB%= \n\t"   // next
-"sub       $1,"Mangle(_l_h)"  \n\t" // next line
+"subl       $1,"Mangle(_l_h)"  \n\t" // next line
 "jne        DHCOLB%= \n\t"
 "pop 				"REG_ax"\n\t"
 "pop 				"REG_si"\n\t"



From mean at mail.berlios.de  Wed Nov  9 07:50:00 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  9 Nov 2011 07:50:00 +0100
Subject: [Avidemux-svn-commit] r7659 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/xvid4
Message-ID: <20111109065000.AD4574815C3@sheep.berlios.de>

Author: mean
Date: 2011-11-09 07:50:00 +0100 (Wed, 09 Nov 2011)
New Revision: 7659

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/xvid4/ADM_xvid4.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/xvid4/ADM_xvid4.h
Log:
[xvid4] minimalistic 2 pass support

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/xvid4/ADM_xvid4.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/xvid4/ADM_xvid4.cpp	2011-11-08 06:33:14 UTC (rev 7658)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/xvid4/ADM_xvid4.cpp	2011-11-09 06:50:00 UTC (rev 7659)
@@ -27,6 +27,7 @@
 #define aprintf printf
 #endif
 
+extern bool ADM_computeAverageBitrateFromDuration(uint64_t duration, uint32_t sizeInMB, uint32_t *avgInKbits);;
 
 #define MMSET(x) memset(&(x),0,sizeof(x))
 
@@ -40,20 +41,20 @@
     1500,           //uint32_t          avg_bitrate;  /// avg_bitrate is in kb/s!!
     ADM_ENC_CAP_CBR+ADM_ENC_CAP_CQ+ADM_ENC_CAP_2PASS+ADM_ENC_CAP_2PASS_BR+ADM_ENC_CAP_GLOBAL+ADM_ENC_CAP_SAME
     },
-            XVID_PROFILE_AS_L4, // Profile
-            3, // rdMode
-            3, // MotionEstimation
-            0, // cqmMode
-            0, // arMode
-            2, // MaxBframe
-            200, // MaxKeyInterval
-            
-            99, // nbThreads
-            true, // rdOnBframe
-            true, //bool:hqAcPred
-            true, //bool:optimizeChrome
-            true, // Trellis
+    XVID_PROFILE_AS_L4, // Profile
+    3, // rdMode
+    3, // MotionEstimation
+    0, // cqmMode
+    0, // arMode
+    2, // MaxBframe
+    200, // MaxKeyInterval
     
+    99, // nbThreads
+    true, // rdOnBframe
+    true, //bool:hqAcPred
+    true, //bool:optimizeChrome
+    true, // Trellis
+    
 };
 
 typedef enum
@@ -101,9 +102,22 @@
     MMSET(xvid_enc_frame);
     frameNum=0;
     backRef=fwdRef=refIndex=0;
+    pass=0;
+    memset(&pass1,0,sizeof(pass1));
+    memset(&pass2,0,sizeof(pass2));
         
 }
 /**
+    \fn  setPassAndLogFile
+*/
+bool        xvid4Encoder::setPassAndLogFile(int pass,const char *name)
+{
+        logFile=std::string(name);
+        this->pass=pass;
+        ADM_info("Checking pass %d, using stat file =%s\n",pass,logFile.c_str());
+        return true;
+}
+/**
     \fn query
     \brief query xvid about version and flags
 */
@@ -137,6 +151,57 @@
 #endif
 }
 /**
+    \fn setupPass
+*/
+bool xvid4Encoder::setupPass(void)
+{
+    uint32_t avgKbits=0;
+    switch(this->pass)
+    {
+        case 1:
+                plugins[0].func = xvid_plugin_2pass1;
+                plugins[0].param = &pass1;
+                memset(&pass1,0,sizeof(pass1));
+                pass1.version=XVID_VERSION;
+                pass1.filename=ADM_strdup(logFile.c_str()); // LEAK!
+                break;
+        case 2:
+                {
+                plugins[0].func = xvid_plugin_2pass2;
+                plugins[0].param = &pass2;
+                memset(&pass2,0,sizeof(pass2));
+                pass2.version=XVID_VERSION;
+                pass2.filename=ADM_strdup(logFile.c_str()); // LEAK!
+                uint64_t duration=source->getInfo()->totalDuration;
+                switch(xvid4Settings.params.mode)
+                {
+                  case COMPRESS_2PASS:
+                            if(false==ADM_computeAverageBitrateFromDuration(duration,
+                                        xvid4Settings.params.finalsize,&avgKbits))
+                            {
+                                ADM_error("Cannot compute average size\n");
+                                return false;
+                            }
+                            break;
+                  case COMPRESS_2PASS_BITRATE:
+                            avgKbits=xvid4Settings.params.avg_bitrate;
+                            break;
+                  default:
+                            ADM_assert(0);
+                            break;
+                }
+                ADM_info("Using average bitrate of %d kb/s\n",avgKbits);
+                pass2.bitrate=avgKbits*1000;  // kb -> bit/s
+                }
+                break;
+        default:
+                ADM_assert(0);
+                break;
+                
+    }
+    return true;
+}
+/**
     \fn setup
 */
 bool xvid4Encoder::setup(void)
@@ -174,13 +239,11 @@
     {
       case COMPRESS_2PASS:
       case COMPRESS_2PASS_BITRATE:
-#if 0
            if(false==setupPass())
             {
                 ADM_warning("[xvid4] Multipass setup failed\n");
                 return false;
             }
-#endif
             break;
       case COMPRESS_SAME:
       case COMPRESS_CQ:

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/xvid4/ADM_xvid4.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/xvid4/ADM_xvid4.h	2011-11-08 06:33:14 UTC (rev 7658)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/xvid4/ADM_xvid4.h	2011-11-09 06:50:00 UTC (rev 7659)
@@ -37,6 +37,8 @@
                bool            postAmble (ADMBitstream * out,xvid_enc_stats_t *stat,int size);
                bool            query(void);
 
+               bool            setupPass(void);
+
                 xvid_plugin_single_t single;
                 xvid_plugin_2pass1_t pass1;
                 xvid_plugin_2pass2_t pass2;
@@ -49,6 +51,9 @@
                 uint32_t        backRef;
                 uint32_t        fwdRef;
                 uint32_t        refIndex;
+
+                std::string     logFile;
+                int             pass;
 public:
 
                            xvid4Encoder(ADM_coreVideoFilter *src,bool globalHeader);
@@ -57,9 +62,9 @@
 virtual        bool        encode (ADMBitstream * out);
 virtual const  char        *getFourcc(void) {return "DIVX";}
 
-virtual        bool         isDualPass(void) ;
-static         int          hook (void *handle, int opt, void *param1, void *param2);
-
+virtual        bool        isDualPass(void) ;
+static         int         hook (void *handle, int opt, void *param1, void *param2);
+               bool        setPassAndLogFile(int pass,const char *name);
 };
 
 #endif



From mean at mail.berlios.de  Thu Nov 10 07:50:17 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 10 Nov 2011 07:50:17 +0100
Subject: [Avidemux-svn-commit] r7660 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <20111110065017.EFF94481465@sheep.berlios.de>

Author: mean
Date: 2011-11-10 07:50:17 +0100 (Thu, 10 Nov 2011)
New Revision: 7660

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
Log:
[main] If the exe name contains portable, use portable mode

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2011-11-09 06:50:00 UTC (rev 7659)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2011-11-10 06:50:17 UTC (rev 7660)
@@ -405,10 +405,21 @@
 #endif
     return true;
 }
-
+/**
+    \fn isPortableMode
+    \brief returns true if we are in portable mode
+*/
 bool isPortableMode(int argc, char *argv[])
 {
 	bool portableMode = false;
+    std::string mySelf=argv[0];
+    // if the name ends by "_portable.exe" => portable
+    int match=mySelf.find("portable");
+    if(match!=-1)
+    {
+        ADM_info("Portable mode\n");
+        return true;
+    }
 
 	for (int i = 0; i < argc; i++)
 	{



From mean at mail.berlios.de  Fri Nov 11 09:29:18 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 11 Nov 2011 09:29:18 +0100
Subject: [Avidemux-svn-commit] r7661 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src
Message-ID: <20111111082918.84F734816F7@sheep.berlios.de>

Author: mean
Date: 2011-11-11 09:29:18 +0100 (Fri, 11 Nov 2011)
New Revision: 7661

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/CMakeLists.txt
Log:
[coreImage] Fix building with clang compiler (macOsX). Patch by nibbles

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/CMakeLists.txt	2011-11-10 06:50:17 UTC (rev 7660)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_coreImage/src/CMakeLists.txt	2011-11-11 08:29:18 UTC (rev 7661)
@@ -21,8 +21,16 @@
 
 ADD_LIBRARY(ADM_coreImage SHARED ${ADM_coreImage_SRCS})
 ADD_SOURCE_CFLAGS(DIA_flyDialog.cpp " -DADM_UI_TYPE_BUILD=99")
+
 IF (APPLE)
-	TARGET_LINK_LIBRARIES(ADM_coreImage -Wl,-read_only_relocs,suppress)
+    SET_SOURCE_FILES_PROPERTIES("ADM_imageUtils.cpp" PROPERTIES COMPILE_FLAGS -O0)
+    SET_SOURCE_FILES_PROPERTIES("ADM_vidFieldASM.cpp" PROPERTIES COMPILE_FLAGS -O0)
+    SET_SOURCE_FILES_PROPERTIES("ADM_vidFieldBlend.cpp" PROPERTIES COMPILE_FLAGS -O0)
+
+    IF (NOT ADM_CPU_X86_64)
+        TARGET_LINK_LIBRARIES(ADM_coreImage -Wl,-read_only_relocs,suppress)
+    ENDIF (NOT ADM_CPU_X86_64)
+
 ENDIF (APPLE)
 
 TARGET_LINK_LIBRARIES(ADM_coreImage ADM_core ADM_coreUI ADM_libswscale ADM_libpostproc)



From gruntster at mail.berlios.de  Sun Nov 13 20:45:52 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 13 Nov 2011 20:45:52 +0100
Subject: [Avidemux-svn-commit] r7662 - in
	branches/avidemux_2.5_branch_gruntster:
	avidemux/ADM_libraries cmake cmake/patches
Message-ID: <20111113194553.22016481418@sheep.berlios.de>

Author: gruntster
Date: 2011-11-13 20:45:52 +0100 (Sun, 13 Nov 2011)
New Revision: 7662

Added:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.6.tar.bz2
Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.5.tar.bz2
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_file.c.patch
Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
Log:
[ffmpeg] upgrade ffmpeg to 0.8.6

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.5.tar.bz2
===================================================================
(Binary files differ)

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.6.tar.bz2 (from rev 7609, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.5.tar.bz2)
===================================================================
(Binary files differ)

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2011-11-11 08:29:18 UTC (rev 7661)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2011-11-13 19:45:52 UTC (rev 7662)
@@ -1,6 +1,6 @@
 include(admFFmpegUtil)
 
-set(FFMPEG_VERSION 0.8.5)
+set(FFMPEG_VERSION 0.8.6)
 set(FFMPEG_SOURCE_ARCHIVE "ffmpeg-${FFMPEG_VERSION}.tar.bz2")
 set(FFMPEG_SOURCE_ARCHIVE_DIR "ffmpeg-${FFMPEG_VERSION}")
 

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2011-11-11 08:29:18 UTC (rev 7661)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2011-11-13 19:45:52 UTC (rev 7662)
@@ -2,7 +2,7 @@
 
 export curDir=$PWD
 export ffmpegPath=../../avidemux/ADM_libraries/ffmpeg
-export origFfmpegPath=../ffmpeg-0.8.5
+export origFfmpegPath=../ffmpeg-0.8.6
 
 function updatePatch {
 	#cd $ffmpegPath
@@ -36,7 +36,6 @@
 updatePatch libavcodec mpegvideo_enc.c
 updatePatch libavcodec utils.c
 updatePatch libavcodec vc1dec.c
-updatePatch libavformat file.c
 updatePatch libavformat isom.c
 updatePatch libavformat matroskaenc.c
 updatePatch libavutil avutil.h

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch	2011-11-11 08:29:18 UTC (rev 7661)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch	2011-11-13 19:45:52 UTC (rev 7662)
@@ -1,5 +1,5 @@
---- ../ffmpeg-0.8/libavcodec/h263dec.c	2011-06-23 20:23:53 +0100
-+++ libavcodec/h263dec.c	2011-06-23 20:23:53 +0100
+--- ../ffmpeg-0.8.6/libavcodec/h263dec.c	2011-11-13 16:42:33 +0000
++++ libavcodec/h263dec.c	2011-11-13 16:42:33 +0000
 @@ -115,6 +115,25 @@
  
      return 0;
@@ -26,29 +26,3 @@
  
  av_cold int ff_h263_decode_end(AVCodecContext *avctx)
  {
-@@ -431,6 +450,12 @@
-     } else {
-         ret = h263_decode_picture_header(s);
-     }
-+	//MEANX we need to do it here also for quicktime file / ctts atom 
-+        // we need the correct frame type, and qt file may contain 
-+        // vop not coded frame.
-+        pict->pict_type=s->current_picture.pict_type= s->pict_type;
-+        pict->key_frame=s->current_picture.key_frame= s->pict_type == FF_I_TYPE;
-+        //MEANX
- 
-     if(ret==FRAME_SKIPPED) return get_consumed_bytes(s, buf_size);
- 
-@@ -715,6 +740,12 @@
- 
- assert(s->current_picture.pict_type == s->current_picture_ptr->pict_type);
- assert(s->current_picture.pict_type == s->pict_type);
-+
-+/* MEANX */
-+    if(s->current_picture_ptr)
-+        s->current_picture_ptr->opaque=pict->opaque;
-+/* MEANX */
-+
-     if (s->pict_type == AV_PICTURE_TYPE_B || s->low_delay) {
-         *pict= *(AVFrame*)s->current_picture_ptr;
-     } else if (s->last_picture_ptr != NULL) {

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2011-11-11 08:29:18 UTC (rev 7661)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2011-11-13 19:45:52 UTC (rev 7662)
@@ -1,6 +1,6 @@
---- ../ffmpeg-0.8.5/libavcodec/h264.c	2011-10-11 22:27:47 +0100
-+++ libavcodec/h264.c	2011-10-11 22:27:47 +0100
-@@ -4241,6 +4241,20 @@
+--- ../ffmpeg-0.8.6/libavcodec/h264.c	2011-11-13 16:42:34 +0000
++++ libavcodec/h264.c	2011-11-13 16:42:33 +0000
+@@ -4250,6 +4250,20 @@
      { FF_PROFILE_UNKNOWN },
  };
  

Deleted: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_file.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_file.c.patch	2011-11-11 08:29:18 UTC (rev 7661)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_file.c.patch	2011-11-13 19:45:52 UTC (rev 7662)
@@ -1,78 +0,0 @@
---- libavformat/file.c.orig	2011-05-10 22:40:30 +0100
-+++ libavformat/file.c	2011-05-10 22:40:30 +0100
-@@ -31,6 +31,75 @@
- #include "os_support.h"
- #include "url.h"
- 
-+// GRUNTSTER start
-+#ifdef __WIN32
-+#include <windows.h>
-+
-+int utf8StringToWideChar(const char *utf8String, int utf8StringLength, wchar_t *wideCharString);
-+int ADM_open(const char *path, int oflag, ...);
-+
-+int utf8StringToWideChar(const char *utf8String, int utf8StringLength, wchar_t *wideCharString)
-+{
-+	int wideCharStringLength = MultiByteToWideChar(CP_UTF8, 0, utf8String, utf8StringLength, NULL, 0);
-+
-+	if (wideCharString)
-+		MultiByteToWideChar(CP_UTF8, 0, utf8String, utf8StringLength, wideCharString, wideCharStringLength);
-+
-+	return wideCharStringLength;
-+}
-+
-+int ADM_open(const char *path, int oflag, ...)
-+{
-+	int fileNameLength = utf8StringToWideChar(path, -1, NULL);
-+	wchar_t wcFile[fileNameLength];
-+	int creation = 0, access = 0;
-+	HANDLE hFile;
-+
-+	utf8StringToWideChar(path, -1, wcFile);
-+
-+	if (oflag & O_WRONLY || oflag & O_RDWR)
-+	{
-+		access = GENERIC_WRITE;
-+
-+		if (oflag & O_RDWR)
-+			access |= GENERIC_READ;
-+
-+		if (oflag & O_CREAT)
-+		{
-+			if (oflag & O_EXCL)
-+				creation = CREATE_NEW;
-+			else if (oflag & O_TRUNC)
-+				creation = CREATE_ALWAYS;
-+			else
-+				creation = OPEN_ALWAYS;
-+		}
-+		else if (oflag & O_TRUNC)
-+			creation = TRUNCATE_EXISTING;
-+	}
-+	else if (oflag & O_RDONLY)
-+		creation = OPEN_EXISTING;
-+
-+	if (creation & GENERIC_WRITE)
-+	{
-+		hFile = CreateFileW(wcFile, access, 0, NULL, creation, 0, NULL);
-+
-+		if (hFile == INVALID_HANDLE_VALUE)
-+			return -1;
-+		else
-+			CloseHandle(hFile);
-+	}
-+
-+	hFile = CreateFileW(wcFile, access, FILE_SHARE_READ, NULL, creation, 0, NULL);
-+
-+	if (hFile == INVALID_HANDLE_VALUE)
-+		return -1;
-+	else
-+		return _open_osfhandle((intptr_t)hFile, oflag);
-+}
-+
-+#define open ADM_open
-+#endif
-+// GRUNTSTER end
- 
- /* standard file protocol */
- 



From mean at mail.berlios.de  Mon Nov 14 07:49:28 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 14 Nov 2011 07:49:28 +0100
Subject: [Avidemux-svn-commit] r7663 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore
Message-ID: <20111114064929.2388C481417@sheep.berlios.de>

Author: mean
Date: 2011-11-14 07:49:28 +0100 (Mon, 14 Nov 2011)
New Revision: 7663

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.cpp
Log:
[audiocore] missing  include, patch by nibbles

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.cpp	2011-11-13 19:45:52 UTC (rev 7662)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.cpp	2011-11-14 06:49:28 UTC (rev 7663)
@@ -20,6 +20,7 @@
 #include <stdlib.h>
 #include <pthread.h>
 #include <AudioUnit/AudioUnit.h>
+#include <CoreAudio/AudioHardware.h>
 #include <CoreServices/CoreServices.h>
 
 #include "ADM_default.h"



From gruntster at mail.berlios.de  Wed Nov 16 21:45:48 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 16 Nov 2011 21:45:48 +0100
Subject: [Avidemux-svn-commit] r7664 - in
	branches/avidemux_2.5_branch_gruntster: avidemux/ADM_encoder
	avidemux/ADM_outputs cmake/patches
Message-ID: <20111116204549.305C4481446@sheep.berlios.de>

Author: gruntster
Date: 2011-11-16 21:45:48 +0100 (Wed, 16 Nov 2011)
New Revision: 7664

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_externalEncoder.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/ADM_lavformat.cpp
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch
Log:
[ffmpeg] don't reference deprecated API

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_externalEncoder.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_externalEncoder.cpp	2011-11-14 06:49:28 UTC (rev 7663)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_encoder/ADM_externalEncoder.cpp	2011-11-16 20:45:48 UTC (rev 7664)
@@ -23,6 +23,7 @@
 extern "C"
 {
 #include "libavcodec/avcodec.h"
+#include "libavutil/pixdesc.h"
 #include "libswscale/swscale.h"
 }
 
@@ -139,7 +140,7 @@
 			_resampleBuffer = new uint8_t[_resampleSize];
 		}
 
-		printf("[externalEncoder] Target colourspace: %s\n", _pixFmt == PIX_FMT_YUV420P ? "yv12" : avcodec_get_pix_fmt_name(_pixFmt));
+		printf("[externalEncoder] Target colourspace: %s\n", _pixFmt == PIX_FMT_YUV420P ? "yv12" : av_get_pix_fmt_name(_pixFmt));
 
 		return (startPass() == ADM_VIDENC_ERR_SUCCESS);
 	}

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/ADM_lavformat.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/ADM_lavformat.cpp	2011-11-14 06:49:28 UTC (rev 7663)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_outputs/ADM_lavformat.cpp	2011-11-16 20:45:48 UTC (rev 7664)
@@ -487,19 +487,14 @@
 	oc->preload=AV_TIME_BASE/10; // 100 ms preloading
 	oc->max_delay=200*1000; // 500 ms
 
-	if (av_set_parameters(oc, NULL) < 0)
+	if (avio_open(&(oc->pb), filename, AVIO_FLAG_WRITE) < 0)
 	{
-		printf("Lav: set param failed \n");
+		printf("Lav: Failed to open file :%s\n",filename);
 		return 0;
 	}
-	 if (url_fopen(&(oc->pb), filename, URL_WRONLY) < 0)
-	 {
-	 	printf("Lav: Failed to open file :%s\n",filename);
-		return 0;
-        }
 
-	ADM_assert(av_write_header(oc)>=0);
-	dump_format(oc, 0, filename, 1);
+	ADM_assert(avformat_write_header(oc, NULL)>=0);
+	av_dump_format(oc, 0, filename, 1);
 
 
 	printf("lavformat mpeg muxer initialized\n");
@@ -672,7 +667,7 @@
 		// Flush
 		// Cause deadlock :
 		av_write_trailer(oc);
-		url_fclose((oc->pb));
+		avio_close(oc->pb);
 
 	}
 	if(audio_st)

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch	2011-11-14 06:49:28 UTC (rev 7663)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch	2011-11-16 20:45:48 UTC (rev 7664)
@@ -1,5 +1,5 @@
---- ../ffmpeg-0.8.6/libavcodec/h263dec.c	2011-11-13 16:42:33 +0000
-+++ libavcodec/h263dec.c	2011-11-13 16:42:33 +0000
+--- ../ffmpeg-0.8.6/libavcodec/h263dec.c	2011-11-16 20:43:49 +0000
++++ libavcodec/h263dec.c	2011-11-16 20:43:49 +0000
 @@ -115,6 +115,25 @@
  
      return 0;
@@ -26,3 +26,29 @@
  
  av_cold int ff_h263_decode_end(AVCodecContext *avctx)
  {
+@@ -431,6 +450,12 @@
+     } else {
+         ret = h263_decode_picture_header(s);
+     }
++	//MEANX we need to do it here also for quicktime file / ctts atom 
++        // we need the correct frame type, and qt file may contain 
++        // vop not coded frame.
++        pict->pict_type=s->current_picture.pict_type= s->pict_type;
++        pict->key_frame=s->current_picture.key_frame= s->pict_type == FF_I_TYPE;
++        //MEANX
+ 
+     if(ret==FRAME_SKIPPED) return get_consumed_bytes(s, buf_size);
+ 
+@@ -715,6 +740,12 @@
+ 
+ assert(s->current_picture.pict_type == s->current_picture_ptr->pict_type);
+ assert(s->current_picture.pict_type == s->pict_type);
++
++/* MEANX */
++    if(s->current_picture_ptr)
++        s->current_picture_ptr->opaque=pict->opaque;
++/* MEANX */
++
+     if (s->pict_type == AV_PICTURE_TYPE_B || s->low_delay) {
+         *pict= *(AVFrame*)s->current_picture_ptr;
+     } else if (s->last_picture_ptr != NULL) {



From mean at mail.berlios.de  Thu Nov 17 07:16:12 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 17 Nov 2011 07:16:12 +0100
Subject: [Avidemux-svn-commit] r7665 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif
Message-ID: <20111117061612.8209F4814E9@sheep.berlios.de>

Author: mean
Date: 2011-11-17 07:16:11 +0100 (Thu, 17 Nov 2011)
New Revision: 7665

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif/ADM_vidYadif_asm.c
Log:
[yadif] use cmpl instead of cmp, compatibility with MacOsX (patch by nibbles)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif/ADM_vidYadif_asm.c
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif/ADM_vidYadif_asm.c	2011-11-16 20:45:48 UTC (rev 7664)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoFilters/Yadif/ADM_vidYadif_asm.c	2011-11-17 06:16:11 UTC (rev 7665)
@@ -141,7 +141,7 @@
 \
             /* if(p->mode<2) ... */\
             "movq    %[tmp3], %%mm6 \n\t" /* diff */\
-            "cmp       $2, %[mode] \n\t"\
+            "cmpl      $2, %[mode] \n\t"\
             "jge       1f \n\t"\
             LOAD4("(%["prev2"],%[mrefs],2)", %%mm2) /* prev2[x-2*refs] */\
             LOAD4("(%["next2"],%[mrefs],2)", %%mm4) /* next2[x-2*refs] */\



From mean at mail.berlios.de  Thu Nov 17 07:25:38 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 17 Nov 2011 07:25:38 +0100
Subject: [Avidemux-svn-commit] r7666 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: .
	ADM_core/include ADM_core/src
Message-ID: <20111117062539.45EE448149A@sheep.berlios.de>

Author: mean
Date: 2011-11-17 07:25:38 +0100 (Thu, 17 Nov 2011)
New Revision: 7666

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp
Log:
[core] dont override memcpy on macOsX

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h	2011-11-17 06:16:11 UTC (rev 7665)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h	2011-11-17 06:25:38 UTC (rev 7666)
@@ -71,15 +71,19 @@
 /* */
 void            ADM_usleep(unsigned long us);
 
+#ifndef __APPLE__
+    typedef void *(* adm_fast_memcpy)(void *to, const void *from, size_t len);
+    extern adm_fast_memcpy myAdmMemcpy;
+#endif
 
-typedef void *(* adm_fast_memcpy)(void *to, const void *from, size_t len);
-extern adm_fast_memcpy myAdmMemcpy;
-
 #define ADM_memalign(x,y) ADM_alloc(y)
 
 #define ADM_dealloc(x) ADM_dezalloc( (void *)x)
-#define memcpy myAdmMemcpy
 
+#ifndef __APPLE__
+    #define memcpy myAdmMemcpy
+#endif
+
 // Override fread/fwrite ..
 #define fread   ADM_fread
 #define fwrite  ADM_fwrite

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/CMakeLists.txt	2011-11-17 06:16:11 UTC (rev 7665)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/src/CMakeLists.txt	2011-11-17 06:25:38 UTC (rev 7666)
@@ -1,5 +1,5 @@
 SET(ADM_core_SRCS 
-	ADM_cpuCap.cpp  ADM_memcpy.cpp  ADM_memsupport.cpp  ADM_threads.cpp  ADM_win32.cpp  ADM_translate.cpp
+	ADM_cpuCap.cpp  ADM_memsupport.cpp  ADM_threads.cpp  ADM_win32.cpp  ADM_translate.cpp
 	ADM_memory.cpp  ADM_misc.cpp  TLK_clock.cpp  ADM_fileio.cpp ADM_dynamicLoading.cpp)
 
 IF (MINGW)
@@ -10,6 +10,10 @@
 	SET(ADM_core_SRCS ${ADM_core_SRCS} ADM_crashdump_unix.cpp)
 ENDIF (MINGW)
 
+IF (NOT APPLE)
+	SET(ADM_core_SRCS ${ADM_core_SRCS} ADM_memcpy.cpp)
+ENDIF (NOT APPLE)
+
 ADD_LIBRARY(ADM_core SHARED ${ADM_core_SRCS})
 ADD_TARGET_DEFINITIONS(ADM_core ADM_DEBUG FIND_LEAKS)
 

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp	2011-11-17 06:16:11 UTC (rev 7665)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/main.cpp	2011-11-17 06:25:38 UTC (rev 7666)
@@ -168,7 +168,9 @@
 
 	// Start counting memory
 	ADM_memStatInit();
+#ifndef __APPLE__
     ADM_InitMemcpy();
+#endif
 	printf("\nInitialising prefs\n");
 	initPrefs();
 	prefs->load();



From gruntster at mail.berlios.de  Tue Nov 22 18:48:37 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 22 Nov 2011 18:48:37 +0100
Subject: [Avidemux-svn-commit] r7667 - in branches/avidemux_2.6_branch_mean:
	avidemux_plugins/ADM_audioEncoders/lavcodec cmake
	foreignBuilds/mswin foreignBuilds/mswin/avidemux
	foreignBuilds/mswin/avidemux/Tools
Message-ID: <20111122174838.420774815B2@sheep.berlios.de>

Author: gruntster
Date: 2011-11-22 18:48:37 +0100 (Tue, 22 Nov 2011)
New Revision: 7667

Added:
   branches/avidemux_2.6_branch_mean/cmake/FindBourne.cmake
   branches/avidemux_2.6_branch_mean/cmake/ffmpeg_configure.sh.cmake
   branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/Avidemux_qt4.cbp.patch
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/avidemux.layout
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/avidemux.workspace
Removed:
   branches/avidemux_2.6_branch_mean/cmake/admFFmpegMake.cmake
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
   branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/Set Common Environment Variables.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/1. Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/1b. Perform Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Set Avidemux Environment Variables.bat
Log:
[mingw] don't require Bourne shell to be in Path so MinGW makefiles can be produced (rather than just MSYS)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/CMakeLists.txt	2011-11-17 06:25:38 UTC (rev 7666)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/CMakeLists.txt	2011-11-22 17:48:37 UTC (rev 7667)
@@ -5,7 +5,7 @@
 	SET(ADM_ae_lav_${_ext}_SRCS audioencoder_lavcodec.cpp)
 
 	ADD_AUDIO_ENCODER(ADM_ae_lav_${_ext} ${ADM_ae_lav_${_ext}_SRCS})
-	ADD_TARGET_CFLAGS(ADM_ae_lav_${_ext} "-DADM_AE_SET='\"ADM_lav_${_ext}.h\"'")
+	ADD_TARGET_CFLAGS(ADM_ae_lav_${_ext} "-DADM_AE_SET=${_ext}")
 	TARGET_LINK_LIBRARIES(ADM_ae_lav_${_ext}  ADM_libavcodec ADM_libavutil)
 
 	INIT_AUDIO_ENCODER(ADM_ae_lav_${_ext})

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2011-11-17 06:25:38 UTC (rev 7666)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2011-11-22 17:48:37 UTC (rev 7667)
@@ -27,9 +27,15 @@
 #include "DIA_coreToolkit.h"
 #include "audioencoder.h"
 #include "audioencoderInternal.h"
+
+#if ADM_AE_SET == mp2
+#include "ADM_lav_mp2.h"
+#elif ADM_AE_SET == ac3
+#include "ADM_lav_ac3.h"
+#elif ADM_AE_SET == aac
+#include "ADM_lav_aac.h"
+#endif
 
-#include ADM_AE_SET
-
 #include "audioencoder_lavcodec.h"
 
 static bool configure (void);

Added: branches/avidemux_2.6_branch_mean/cmake/FindBourne.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/FindBourne.cmake	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/cmake/FindBourne.cmake	2011-11-22 17:48:37 UTC (rev 7667)
@@ -0,0 +1,25 @@
+if (NOT BASH_EXECUTABLE)
+	message(STATUS "Checking for Bourne shell")
+	message(STATUS "*************************")
+
+	find_program(BASH_EXECUTABLE
+		sh
+		${BASH_DIR}
+		/bin
+		/usr/bin 
+		/usr/local/bin
+		/sbin)
+	set(BASH_EXECUTABLE ${BASH_EXECUTABLE} CACHE STRING "")
+
+	if (BASH_EXECUTABLE)
+		message(STATUS "Found Bourne shell")
+		
+		if (VERBOSE)
+			message(STATUS "Path: ${BASH_EXECUTABLE}")
+		endif (VERBOSE)
+	else (BASH_EXECUTABLE)
+		message(FATAL_ERROR "Bourne shell not found")
+	endif (BASH_EXECUTABLE)
+
+	message("")
+endif (NOT BASH_EXECUTABLE)
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake	2011-11-17 06:25:38 UTC (rev 7666)
+++ branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake	2011-11-22 17:48:37 UTC (rev 7667)
@@ -1,3 +1,12 @@
+MACRO (xadd opt)
+	if ("${ARGV1}" STREQUAL "")
+		set(FFMPEG_FLAGS "${FFMPEG_FLAGS} ${opt}")
+	else ("${ARGV1}" STREQUAL "")
+		string(STRIP ${ARGV1} arg)
+		set(FFMPEG_FLAGS "${FFMPEG_FLAGS} ${opt}=\"${arg}\"")
+	endif ("${ARGV1}" STREQUAL "")
+ENDMACRO (xadd)
+
  set(FFMPEG_VERSION "860")	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz
 #set(FFMPEG_VERSION "efb5fa79f5ca34140db357a00c999286097ab53e")	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz
 #set(FFMPEG_VERSION "8cb3c557a9f3b24bc55325e3f64a2150b983305c")	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz
@@ -20,18 +29,11 @@
 set(FFMPEG_MUXERS  flv  matroska  mpeg1vcd  mpeg2dvd  mpeg2svcd  mpegts  mov  mp4  psp)
 set(FFMPEG_PARSERS  ac3  h263  h264  mpeg4video)
 set(FFMPEG_PROTOCOLS  file)
-set(FFMPEG_FLAGS  --enable-shared --disable-static --disable-everything --disable-avfilter )
-set(FFMPEG_FLAGS  ${FFMPEG_FLAGS} --enable-hwaccels --enable-postproc --enable-gpl )
-set(FFMPEG_FLAGS  ${FFMPEG_FLAGS} --enable-runtime-cpudetect --disable-network )
-set(FFMPEG_FLAGS  ${FFMPEG_FLAGS} --disable-ffplay --disable-ffprobe)
-#set(FFMPEG_FLAGS  ${FFMPEG_FLAGS} --enable-audio-float)
+xadd("--enable-shared --disable-static --disable-everything --disable-avfilter --enable-hwaccels --enable-postproc --enable-gpl")
+xadd("--enable-runtime-cpudetect --disable-network --disable-ffplay --disable-ffprobe")
 
-MACRO (xadd opt)
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} ${opt})
-ENDMACRO (xadd opt)
-
 if (NOT CROSS)
-	xadd(--prefix=${CMAKE_INSTALL_PREFIX})
+	xadd(--prefix ${CMAKE_INSTALL_PREFIX})
 endif (NOT CROSS)
 
 # Clean FFmpeg
@@ -49,7 +51,6 @@
 	include(admFFmpegPrepareGit)
 endif (NOT FFMPEG_PREPARED)
 
-
 message("")
 
 if (FFMPEG_PERFORM_PATCH)
@@ -73,104 +74,102 @@
 	set(FFMPEG_DECODERS ${FFMPEG_DECODERS} h264_vdpau  vc1_vdpau  mpeg1_vdpau  mpeg_vdpau  wmv3_vdpau)
 endif (USE_VDPAU)
 
-xadd(--enable-bsf=aac_adtstoasc)
+xadd(--enable-bsf aac_adtstoasc)
 
 # Configure FFmpeg, if required
 foreach (decoder ${FFMPEG_DECODERS})
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-decoder=${decoder})
+	xadd(--enable-decoder ${decoder})
 endforeach (decoder)
 
 foreach (encoder ${FFMPEG_ENCODERS})
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-encoder=${encoder})
+	xadd(--enable-encoder ${encoder})
 endforeach (encoder)
 
 foreach (muxer ${FFMPEG_MUXERS})
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-muxer=${muxer})
+	xadd(--enable-muxer ${muxer})
 endforeach (muxer)
 
 foreach (parser ${FFMPEG_PARSERS})
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-parser=${parser})
+	xadd(--enable-parser ${parser})
 endforeach (parser)
 
 foreach (protocol ${FFMPEG_PROTOCOLS})
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-protocol=${protocol})
+	xadd(--enable-protocol ${protocol})
 endforeach (protocol)
 
 if (WIN32)
 	if (ADM_CPU_X86_32)
-		set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-memalign-hack)
+		xadd(--enable-memalign-hack)
 	endif (ADM_CPU_X86_32)
 
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-w32threads)
+	xadd(--enable-w32threads)
 else (WIN32)
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-pthreads)
+	xadd(--enable-pthreads)
 endif (WIN32)
 
 if (NOT ADM_DEBUG)
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --disable-debug)
+	xadd(--disable-debug)
 endif (NOT ADM_DEBUG)
 
 if (CMAKE_C_FLAGS)
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --extra-cflags=${CMAKE_C_FLAGS})
+	xadd(--extra-cflags ${CMAKE_C_FLAGS})
 endif (CMAKE_C_FLAGS)
 
 if (CMAKE_SHARED_LINKER_FLAGS)
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --extra-ldflags=${CMAKE_SHARED_LINKER_FLAGS})
+	xadd(--extra-ldflags ${CMAKE_SHARED_LINKER_FLAGS})
 endif (CMAKE_SHARED_LINKER_FLAGS)
 
 #  Cross compiler override (win32 & win64)
 if (CROSS)
-if(APPLE)
-	xadd(--prefix=/opt/mac)
-	xadd(--host-cc=gcc)
-	xadd(--cc=${CMAKE_CROSS_PREFIX}-gcc)
-	xadd(--ld=${CMAKE_CROSS_PREFIX}-gcc) # Not an error !
-	xadd(--ar=${CMAKE_CROSS_PREFIX}-ar) 
-	xadd(--nm=${CMAKE_CROSS_PREFIX}-nm) 
-	xadd(--strip=${CMAKE_CROSS_PREFIX}-strip) 
+	if(APPLE)
+		xadd(--prefix /opt/mac)
+		xadd(--host-cc gcc)
+		xadd(--cc ${CMAKE_CROSS_PREFIX}-gcc)
+		xadd(--ld ${CMAKE_CROSS_PREFIX}-gcc) # Not an error !
+		xadd(--ar ${CMAKE_CROSS_PREFIX}-ar) 
+		xadd(--nm ${CMAKE_CROSS_PREFIX}-nm) 
+		xadd(--strip ${CMAKE_CROSS_PREFIX}-strip) 
 
-	set(CROSS_OS darwin)	
+		set(CROSS_OS darwin)
+		set(CROSS_ARCH i386)
+	else(APPLE)
+		xadd(--prefix /mingw)
+		xadd(--host-cc gcc)
+		xadd(--cc ${CMAKE_CROSS_PREFIX}-gcc)
+		xadd(--ld ${CMAKE_CROSS_PREFIX}-gcc) # Not an error !
+		xadd(--ar ${CMAKE_CROSS_PREFIX}-ar) 
+		xadd(--nm ${CMAKE_CROSS_PREFIX}-nm) 
+		xadd(--sysroot /mingw/include)
 
-	set(CROSS_ARCH i386)
+		set(CROSS_OS mingw32)	
 
-else(APPLE)
-	xadd(--prefix=/mingw)
-	xadd(--host-cc=gcc)
-	xadd(--cc=${CMAKE_CROSS_PREFIX}-gcc)
-	xadd(--ld=${CMAKE_CROSS_PREFIX}-gcc) # Not an error !
-	xadd(--ar=${CMAKE_CROSS_PREFIX}-ar) 
-	xadd(--nm=${CMAKE_CROSS_PREFIX}-nm) 
-	xadd(--sysroot=/mingw/include)
+		if (ADM_CPU_64BIT)
+			set(CROSS_ARCH x86_64)
+		else (ADM_CPU_64BIT)
+			set(CROSS_ARCH i386)
+		endif (ADM_CPU_64BIT)
+	endif(APPLE)
 
-	set(CROSS_OS mingw32)	
-
-	if (ADM_CPU_64BIT)
-		set(CROSS_ARCH x86_64)
-	else (ADM_CPU_64BIT)
-		set(CROSS_ARCH i386)
-	endif (ADM_CPU_64BIT)
-
-endif(APPLE)
 	message(STATUS "Using cross compilation flag: ${FFMPEG_FLAGS}")
 endif (CROSS)
 
 if (CROSS_ARCH OR CROSS_OS)
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-cross-compile)
+	xadd(--enable-cross-compile)
 endif (CROSS_ARCH OR CROSS_OS)
 
 if (CROSS_ARCH)
 	set(CROSS_ARCH "${CROSS_ARCH}" CACHE STRING "")
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --arch=${CROSS_ARCH})
+	xadd(--arch ${CROSS_ARCH})
 endif (CROSS_ARCH)
 
 if (CROSS_OS)
 	set(CROSS_OS "${CROSS_OS}" CACHE STRING "")
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --target-os=${CROSS_OS})
+	xadd(--target-os ${CROSS_OS})
 endif (CROSS_OS)
 
 if (FF_FLAGS)
 	set(FF_FLAGS "${FF_FLAGS}" CACHE STRING "")
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} ${FF_FLAGS})
+	xadd(${FF_FLAGS})
 endif (FF_FLAGS)
 
 if (NOT "${LAST_FFMPEG_FLAGS}" STREQUAL "${FFMPEG_FLAGS}")
@@ -180,9 +179,10 @@
 if (NOT EXISTS "${FFMPEG_BINARY_DIR}/Makefile")
 	set(FFMPEG_PERFORM_BUILD 1)
 endif (NOT EXISTS "${FFMPEG_BINARY_DIR}/Makefile")
-	
 
 if (FFMPEG_PERFORM_BUILD)
+	find_package(Bourne)
+
 	message(STATUS "Configuring FFmpeg")
 	set(LAST_FFMPEG_FLAGS "${FFMPEG_FLAGS}" CACHE STRING "" FORCE)
 
@@ -190,16 +190,27 @@
 	file(REMOVE "${FFMPEG_BINARY_DIR}/ffmpeg${CMAKE_EXECUTABLE_SUFFIX}")
 	file(REMOVE "${FFMPEG_BINARY_DIR}/ffmpeg_g${CMAKE_EXECUTABLE_SUFFIX}")
 
-	execute_process(COMMAND sh ${FFMPEG_SOURCE_DIR}/configure ${FFMPEG_FLAGS}
-					WORKING_DIRECTORY "${FFMPEG_BINARY_DIR}"
-	                                OUTPUT_VARIABLE FFMPEG_CONFIGURE_OUTPUT
-	                                RESULT_VARIABLE FFMPEG_CONFIGURE_RESULT)
-        IF(NOT (FFMPEG_CONFIGURE_RESULT EQUAL 0))
-	        MESSAGE(ERROR "configure returned <${FFMPEG_CONFIGURE_RESULT}>")
-	        MESSAGE(ERROR "configure output is <${FFMPEG_CONFIGURE_OUTPUT}>")
-	        MESSAGE(ERROR "When configuing ffmpeg using < sh ${FFMPEG_SOURCE_DIR}/configure ${FFMPEG_FLAGS}>")
-                MESSAGE(FATAL_ERROR "An error occured ")
-        ENDIF(NOT (FFMPEG_CONFIGURE_RESULT EQUAL 0))
+	get_filename_component(bash_directory ${BASH_EXECUTABLE} PATH)
+
+	if (WIN32)
+		# make path compatible with bash
+		set(ffmpeg_bash_directory "/${bash_directory}")
+		string(REPLACE ":" "" ffmpeg_bash_directory ${ffmpeg_bash_directory})
+	else (WIN32)
+		set(ffmpeg_bash_directory "${bash_directory}")
+	endif (WIN32)
+
+	configure_file("${AVIDEMUX_TOP_SOURCE_DIR}/cmake/ffmpeg_configure.sh.cmake" "${FFMPEG_BINARY_DIR}/ffmpeg_configure.sh")
+
+	execute_process(COMMAND ${BASH_EXECUTABLE} ffmpeg_configure.sh WORKING_DIRECTORY "${FFMPEG_BINARY_DIR}"
+					OUTPUT_VARIABLE FFMPEG_CONFIGURE_OUTPUT RESULT_VARIABLE FFMPEG_CONFIGURE_RESULT)
+
+    if (NOT (FFMPEG_CONFIGURE_RESULT EQUAL 0))
+	    MESSAGE(ERROR "configure returned <${FFMPEG_CONFIGURE_RESULT}>")
+	    MESSAGE(ERROR "configure output is <${FFMPEG_CONFIGURE_OUTPUT}>")
+		MESSAGE(FATAL_ERROR "An error occured ")
+    endif (NOT (FFMPEG_CONFIGURE_RESULT EQUAL 0))
+
 	MESSAGE(STATUS "Configuring done, processing")
 
 	if (ADM_CPU_X86)
@@ -241,6 +252,7 @@
 
 # Build FFmpeg
 getFfmpegLibNames("${FFMPEG_SOURCE_DIR}")
+configure_file("${AVIDEMUX_TOP_SOURCE_DIR}/cmake/ffmpeg_make.sh.cmake" "${FFMPEG_BINARY_DIR}/ffmpeg_make.sh")
 
 add_custom_command(OUTPUT
 						"${FFMPEG_BINARY_DIR}/libavcodec/${LIBAVCODEC_LIB}"
@@ -249,8 +261,7 @@
 						"${FFMPEG_BINARY_DIR}/libpostproc/${LIBPOSTPROC_LIB}"
 						"${FFMPEG_BINARY_DIR}/libswscale/${LIBSWSCALE_LIB}"
 						"${FFMPEG_BINARY_DIR}/ffmpeg${CMAKE_EXECUTABLE_SUFFIX}"
-				   COMMAND ${CMAKE_COMMAND} -DCMAKE_BUILD_TOOL=${CMAKE_BUILD_TOOL} -P "${AVIDEMUX_TOP_SOURCE_DIR}/cmake/admFFmpegMake.cmake"
-				   WORKING_DIRECTORY "${FFMPEG_BINARY_DIR}")
+				   COMMAND ${BASH_EXECUTABLE} ffmpeg_make.sh WORKING_DIRECTORY "${FFMPEG_BINARY_DIR}")
 
 # Add and install libraries
 registerFFmpeg("${FFMPEG_SOURCE_DIR}" "${FFMPEG_BINARY_DIR}" 0)

Deleted: branches/avidemux_2.6_branch_mean/cmake/admFFmpegMake.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admFFmpegMake.cmake	2011-11-17 06:25:38 UTC (rev 7666)
+++ branches/avidemux_2.6_branch_mean/cmake/admFFmpegMake.cmake	2011-11-22 17:48:37 UTC (rev 7667)
@@ -1 +0,0 @@
-execute_process(COMMAND ${CMAKE_BUILD_TOOL})
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/cmake/ffmpeg_configure.sh.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/ffmpeg_configure.sh.cmake	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/cmake/ffmpeg_configure.sh.cmake	2011-11-22 17:48:37 UTC (rev 7667)
@@ -0,0 +1,2 @@
+export PATH=$PATH:${ffmpeg_bash_directory}
+${FFMPEG_SOURCE_DIR}/configure ${FFMPEG_FLAGS}
\ No newline at end of file

Copied: branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake (from rev 7666, branches/avidemux_2.6_branch_mean/cmake/admFFmpegMake.cmake)
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake	2011-11-22 17:48:37 UTC (rev 7667)
@@ -0,0 +1,2 @@
+export PATH=$PATH:${ffmpeg_bash_directory}
+make
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/Set Common Environment Variables.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/Set Common Environment Variables.bat	2011-11-17 06:25:38 UTC (rev 7666)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/Set Common Environment Variables.bat	2011-11-22 17:48:37 UTC (rev 7667)
@@ -21,7 +21,7 @@
 set SDLDIR=%usrLocalDir%
 set CFLAGS=%CFLAGS% -I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
 set CXXFLAGS=%CXXFLAGS% -I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
-set LDFLAGS=%LDFLAGS% -s -shared-libgcc -shared-libstdc++ -L%CMAKE_LIBRARY_PATH%
+set LDFLAGS=%LDFLAGS% -shared-libgcc -shared-libstdc++ -L%CMAKE_LIBRARY_PATH%
 set admBuildDir=%devDir%\avidemux_2.6_build%BuildBits%
 set admSdkBuildDir=%devDir%\avidemux_2.6_build%BuildBits%_sdk
 
@@ -31,6 +31,9 @@
 	set LDFLAGS=%LDFLAGS% -m32
 )
 
+if "%DebugFlags%" == "" set LDFLAGS=%LDFLAGS% -s
+
+
 if exist "%qtDir%" (
 	for /f %%d in ('dir /b /ad /on %qtDir%') do set qtVer=%%d
 ) else (
@@ -73,7 +76,7 @@
 	goto error
 )
 
-set PATH=%cmakeDir%;%mingwDir%\bin;%usrLocalDir%\bin;%msysDir%\bin;%msysDir%\local-shared\bin;%qtDir%\bin;c:\strawberry\perl\bin;%PATH%
+set PATH=%cmakeDir%;%mingwDir%\bin;%usrLocalDir%\bin;%msysDir%\local-shared\bin;%qtDir%\bin;c:\strawberry\perl\bin;%PATH%
 
 goto end
 

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/1. Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/1. Build.bat	2011-11-17 06:25:38 UTC (rev 7666)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/1. Build.bat	2011-11-22 17:48:37 UTC (rev 7667)
@@ -1,27 +1,41 @@
 @echo off
 
+set BuildGenerator=MinGW Makefiles
+
 :start
 echo MinGW build for Avidemux
 echo ========================
 echo 1. 32-bit build
 echo 2. 64-bit build
 echo 3. Debug build
+echo 4. Code::Blocks build
 echo X. Exit
 echo.
 
-choice /c 123x
+choice /c 1234x
 
-if errorlevel 1 set BuildBits=32
-if errorlevel 2 set BuildBits=64
+if errorlevel 5 goto end
+if errorlevel 4 (
+	set INCLUDE_MSYS_PATH=false
+	set BuildGenerator=CodeBlocks - MinGW Makefiles
+	echo.
+	echo -- Code::Blocks mode set --
+	echo.
+	goto :start	)
 if errorlevel 3 (
 	set DebugFlags=-DCMAKE_BUILD_TYPE=Debug
 	echo.
 	echo -- Debug mode set --
 	echo.
 	goto :start	)
+if errorlevel 2 (
+	set BuildBits=64
+	goto :begin	)
+if errorlevel 1 (
+	set BuildBits=32
+	goto :begin	)
 
-if errorlevel 4 goto end
-
+:begin
 verify >nul
 echo.
 

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/1b. Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/1b. Perform Build.bat	2011-11-17 06:25:38 UTC (rev 7666)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/1b. Perform Build.bat	2011-11-22 17:48:37 UTC (rev 7667)
@@ -1,49 +1,64 @@
+if "%BuildGenerator%" == "CodeBlocks - MinGW Makefiles" copy "%curDir%\Tools\avidemux.workspace" "%SourceDir%\%buildFolder%"
+
+rem ## Core ##
 cd "%sourceDir%\%buildCoreFolder%"
-cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DUSE_SYSTEM_SPIDERMONKEY=ON -DCMAKE_INCLUDE_PATH="%SpiderMonkeySourceDir%" -DCMAKE_LIBRARY_PATH="%SpiderMonkeyLibDir%" %DebugFlags% ../../avidemux_core
+cmake -G"%BuildGenerator%" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DBASH_DIR="%msysDir%\bin" %DebugFlags% ../../avidemux_core
 
 if errorlevel 1 goto error
+if "%BuildGenerator%" == "CodeBlocks - MinGW Makefiles" copy "%curDir%\Tools\avidemux.layout" admCore.layout
 pause
 
-make install
+mingw32-make install
 if errorlevel 1 goto error
 
-cd "%sourceDir%\%buildCliFolder%"
-cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DUSE_SYSTEM_SPIDERMONKEY=ON -DCMAKE_INCLUDE_PATH="%SpiderMonkeySourceDir%" -DCMAKE_LIBRARY_PATH="%SpiderMonkeyLibDir%" %DebugFlags% ../../avidemux/cli
+rem ## Qt4 ##
+cd "%sourceDir%\%buildQtFolder%"
+cmake -G"%BuildGenerator%" -DCMAKE_INSTALL_PREFIX="%buildDir%" %DebugFlags% ../../avidemux/qt4
 
 if errorlevel 1 goto error
+if "%BuildGenerator%" == "CodeBlocks - MinGW Makefiles" (
+	copy "%curDir%\Tools\avidemux.layout" Avidemux_qt4.layout
+	patch -p0 -i "%curDir%\Tools\Avidemux_qt4.cbp.patch"	)
 pause
 
-make install
+mingw32-make install
 if errorlevel 1 goto error
 
-cd "%sourceDir%\%buildGtkFolder%"
-rem cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DUSE_SYSTEM_SPIDERMONKEY=ON -DCMAKE_INCLUDE_PATH="%SpiderMonkeySourceDir%" -DCMAKE_LIBRARY_PATH="%SpiderMonkeyLibDir%" %DebugFlags% ../../avidemux/gtk
+rem ## CLI ##
+cd "%sourceDir%\%buildCliFolder%"
+cmake -G"%BuildGenerator%" -DCMAKE_INSTALL_PREFIX="%buildDir%" %DebugFlags% ../../avidemux/cli
 
 if errorlevel 1 goto error
-rem pause
+if "%BuildGenerator%" == "CodeBlocks - MinGW Makefiles" copy "%curDir%\Tools\avidemux.layout" Avidemux_cli.layout
+pause
 
-rem make install
+mingw32-make install
 if errorlevel 1 goto error
 
-cd "%sourceDir%\%buildQtFolder%"
-cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DUSE_SYSTEM_SPIDERMONKEY=ON -DCMAKE_INCLUDE_PATH="%SpiderMonkeySourceDir%" -DCMAKE_LIBRARY_PATH="%SpiderMonkeyLibDir%" %DebugFlags% ../../avidemux/qt4
+rem ## GTK ##
+cd "%sourceDir%\%buildGtkFolder%"
+rem cmake -G"%BuildGenerator%" -DCMAKE_INSTALL_PREFIX="%buildDir%" %DebugFlags% ../../avidemux/gtk
 
 if errorlevel 1 goto error
-pause
+rem if "%BuildGenerator%" == "CodeBlocks - MinGW Makefiles" copy "%curDir%\Tools\avidemux.layout" Avidemux_gtk.layout
+rem pause
 
-make install
+rem mingw32-make install
 if errorlevel 1 goto error
 
+rem ## Plugins ##
 set msysSourceDir=%sourceDir:\=/%
 cd "%sourceDir%\%buildPluginFolder%"
-cmake -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_SOURCE_DIR="%msysSourceDir%" -DPLUGIN_UI=ALL %DebugFlags% ../../avidemux_plugins
+cmake -G"%BuildGenerator%" -DCMAKE_INSTALL_PREFIX="%buildDir%" -DAVIDEMUX_SOURCE_DIR="%msysSourceDir%" -DPLUGIN_UI=ALL %DebugFlags% ../../avidemux_plugins
 
 if errorlevel 1 goto error
+if "%BuildGenerator%" == "CodeBlocks - MinGW Makefiles" copy "%curDir%\Tools\avidemux.layout" "%sourceDir%\%buildPluginFolder%\AdmPlugins.layout"
 pause
 
 rmdir /s /q "%buildDir%\plugins" 2> NUL
-make install
+mingw32-make install
 if errorlevel 1 goto error
+
 goto :EOF
 
 :error

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Set Avidemux Environment Variables.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Set Avidemux Environment Variables.bat	2011-11-17 06:25:38 UTC (rev 7666)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Set Avidemux Environment Variables.bat	2011-11-22 17:48:37 UTC (rev 7667)
@@ -33,7 +33,12 @@
 	goto error
 )
 
-set buildFolder=build%BuildBits%
+if "%BuildGenerator%" == "CodeBlocks - MinGW Makefiles" (
+	set buildFolder=build%BuildBits%-cb
+) else (
+	set buildFolder=build%BuildBits%
+)
+
 set buildCoreFolder=%buildFolder%\core
 set buildCliFolder=%buildFolder%\cli
 set buildGtkFolder=%buildFolder%\gtk

Added: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/Avidemux_qt4.cbp.patch
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/Avidemux_qt4.cbp.patch	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/Avidemux_qt4.cbp.patch	2011-11-22 17:48:37 UTC (rev 7667)
@@ -0,0 +1,14 @@
+--- Avidemux_qt4.cbp.orig	2011-11-22 14:56:59 +0000
++++ Avidemux_qt4.cbp	2011-11-22 14:57:21 +0000
+@@ -134,8 +134,9 @@
+          </MakeCommands>
+       </Target>
+       <Target title="install">
+-         <Option working_dir="E:/Dev/avidemux_2.6_dev/build64-cb/qt" />
+-         <Option type="4" />
++         <Option output="..\..\..\avidemux_2.6_build64\avidemux.exe" prefix_auto="0" extension_auto="0" />
++         <Option working_dir="..\..\..\avidemux_2.6_build64" />
++         <Option type="0" />
+          <MakeCommands>
+             <Build command="E:/Dev/MinGW64/bin/mingw32-make.exe -f &quot;E:/Dev/avidemux_2.6_dev/build64-cb/qt/Makefile&quot;  VERBOSE=1 install" />
+             <CompileFile command="E:/Dev/MinGW64/bin/mingw32-make.exe -f &quot;E:/Dev/avidemux_2.6_dev/build64-cb/qt/Makefile&quot;  VERBOSE=1 &quot;$file&quot;" />

Added: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/avidemux.layout
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/avidemux.layout	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/avidemux.layout	2011-11-22 17:48:37 UTC (rev 7667)
@@ -0,0 +1,4 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
+<CodeBlocks_layout_file>
+	<ActiveTarget name="install" />
+</CodeBlocks_layout_file>

Added: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/avidemux.workspace
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/avidemux.workspace	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/avidemux.workspace	2011-11-22 17:48:37 UTC (rev 7667)
@@ -0,0 +1,9 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
+<CodeBlocks_workspace_file>
+	<Workspace title="Workspace">
+		<Project filename="cli/Avidemux_cli.cbp" />
+		<Project filename="core/admCore.cbp" />
+		<Project filename="plugins/AdmPlugins.cbp" />
+		<Project filename="qt/Avidemux_qt4.cbp" active="1" />
+	</Workspace>
+</CodeBlocks_workspace_file>



From mean at mail.berlios.de  Sat Nov 26 10:03:19 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 26 Nov 2011 10:03:19 +0100
Subject: [Avidemux-svn-commit] r7668 -
	branches/avidemux_2.6_branch_mean/cmake
Message-ID: <20111126090319.68883481363@sheep.berlios.de>

Author: mean
Date: 2011-11-26 10:03:18 +0100 (Sat, 26 Nov 2011)
New Revision: 7668

Modified:
   branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake
Log:
[ffmpeg] Be verbose

Modified: branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake	2011-11-22 17:48:37 UTC (rev 7667)
+++ branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake	2011-11-26 09:03:18 UTC (rev 7668)
@@ -1,2 +1,2 @@
 export PATH=$PATH:${ffmpeg_bash_directory}
-make
\ No newline at end of file
+make V=1 VERBOSE=1



From mean at mail.berlios.de  Sun Nov 27 20:16:04 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 27 Nov 2011 20:16:04 +0100
Subject: [Avidemux-svn-commit] r7669 -
	branches/avidemux_2.6_branch_mean/cmake
Message-ID: <20111127191605.3956448283D@sheep.berlios.de>

Author: mean
Date: 2011-11-27 20:16:04 +0100 (Sun, 27 Nov 2011)
New Revision: 7669

Modified:
   branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake
Log:
[Build] Try to make it work reliably on linux

Modified: branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake	2011-11-26 09:03:18 UTC (rev 7668)
+++ branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake	2011-11-27 19:16:04 UTC (rev 7669)
@@ -254,7 +254,8 @@
 getFfmpegLibNames("${FFMPEG_SOURCE_DIR}")
 configure_file("${AVIDEMUX_TOP_SOURCE_DIR}/cmake/ffmpeg_make.sh.cmake" "${FFMPEG_BINARY_DIR}/ffmpeg_make.sh")
 
-add_custom_command(OUTPUT
+if(WIN32 AND NOT CROSS)
+  add_custom_command(OUTPUT
 						"${FFMPEG_BINARY_DIR}/libavcodec/${LIBAVCODEC_LIB}"
 						"${FFMPEG_BINARY_DIR}/libavformat/${LIBAVFORMAT_LIB}"
 						"${FFMPEG_BINARY_DIR}/libavutil/${LIBAVUTIL_LIB}"
@@ -262,6 +263,16 @@
 						"${FFMPEG_BINARY_DIR}/libswscale/${LIBSWSCALE_LIB}"
 						"${FFMPEG_BINARY_DIR}/ffmpeg${CMAKE_EXECUTABLE_SUFFIX}"
 				   COMMAND ${BASH_EXECUTABLE} ffmpeg_make.sh WORKING_DIRECTORY "${FFMPEG_BINARY_DIR}")
+else(WIN32 AND NOT CROSS)
+  add_custom_command(OUTPUT
+						"${FFMPEG_BINARY_DIR}/libavcodec/${LIBAVCODEC_LIB}"
+						"${FFMPEG_BINARY_DIR}/libavformat/${LIBAVFORMAT_LIB}"
+						"${FFMPEG_BINARY_DIR}/libavutil/${LIBAVUTIL_LIB}"
+						"${FFMPEG_BINARY_DIR}/libpostproc/${LIBPOSTPROC_LIB}"
+						"${FFMPEG_BINARY_DIR}/libswscale/${LIBSWSCALE_LIB}"
+						"${FFMPEG_BINARY_DIR}/ffmpeg${CMAKE_EXECUTABLE_SUFFIX}"
+				   COMMAND ${CMAKE_BUILD_TOOL} WORKING_DIRECTORY "${FFMPEG_BINARY_DIR}")
+endif(WIN32 AND NOT CROSS)
 
 # Add and install libraries
 registerFFmpeg("${FFMPEG_SOURCE_DIR}" "${FFMPEG_BINARY_DIR}" 0)

Modified: branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake	2011-11-26 09:03:18 UTC (rev 7668)
+++ branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake	2011-11-27 19:16:04 UTC (rev 7669)
@@ -1,2 +1,2 @@
 export PATH=$PATH:${ffmpeg_bash_directory}
-make V=1 VERBOSE=1
+make 



From mean at mail.berlios.de  Mon Nov 28 08:25:32 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 28 Nov 2011 08:25:32 +0100
Subject: [Avidemux-svn-commit] r7670 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include
Message-ID: <20111128072532.ABBF648283D@sheep.berlios.de>

Author: mean
Date: 2011-11-28 08:25:32 +0100 (Mon, 28 Nov 2011)
New Revision: 7670

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_assert.h
Log:
[alloc] try to no use malloc wrapper on win32, maybe what is causing sse2 issue on xp

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_assert.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_assert.h	2011-11-27 19:16:04 UTC (rev 7669)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_assert.h	2011-11-28 07:25:32 UTC (rev 7670)
@@ -86,7 +86,7 @@
 #define fopen   ADM_fopen
 #define fclose  ADM_fclose
 
-#if !defined(__APPLE__) && !defined(__WIN64)
+#if !defined(__APPLE__) && !defined(__WIN64) && !defined(__MINGW32__)
 #ifndef ADM_LEGACY_PROGGY
   #define malloc #error
   #define realloc #error



From mean at mail.berlios.de  Tue Nov 29 07:50:18 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 29 Nov 2011 07:50:18 +0100
Subject: [Avidemux-svn-commit] r7671 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include
Message-ID: <20111129065018.A0927481380@sheep.berlios.de>

Author: mean
Date: 2011-11-29 07:50:18 +0100 (Tue, 29 Nov 2011)
New Revision: 7671

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_assert.h
Log:
[Apple] dont override malloc & friends on macOsX, patch by nibbles

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_assert.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_assert.h	2011-11-28 07:25:32 UTC (rev 7670)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_assert.h	2011-11-29 06:50:18 UTC (rev 7671)
@@ -71,15 +71,19 @@
 /* */
 void            ADM_usleep(unsigned long us);
 
+#ifndef __APPLE__
+  typedef void *(* adm_fast_memcpy)(void *to, const void *from, size_t len);
+  extern adm_fast_memcpy myAdmMemcpy;
+#endif
 
-typedef void *(* adm_fast_memcpy)(void *to, const void *from, size_t len);
-extern adm_fast_memcpy myAdmMemcpy;
-
 #define ADM_memalign(x,y) ADM_alloc(y)
 
 #define ADM_dealloc(x) ADM_dezalloc( (void *)x)
-#define memcpy myAdmMemcpy
 
+#ifndef __APPLE__
+  #define memcpy myAdmMemcpy
+#endif
+
 // Override fread/fwrite ..
 #define fread   ADM_fread
 #define fwrite  ADM_fwrite



From mean at mail.berlios.de  Tue Nov 29 07:50:20 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 29 Nov 2011 07:50:20 +0100
Subject: [Avidemux-svn-commit] r7672 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include
Message-ID: <20111129065020.17F7F481380@sheep.berlios.de>

Author: mean
Date: 2011-11-29 07:50:19 +0100 (Tue, 29 Nov 2011)
New Revision: 7672

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_assert.h
Log:
[Core] We can use malloc wrapper on win32

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_assert.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_assert.h	2011-11-29 06:50:18 UTC (rev 7671)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_assert.h	2011-11-29 06:50:19 UTC (rev 7672)
@@ -90,7 +90,7 @@
 #define fopen   ADM_fopen
 #define fclose  ADM_fclose
 
-#if !defined(__APPLE__) && !defined(__WIN64) && !defined(__MINGW32__)
+#if !defined(__APPLE__) && !defined(__WIN64) 
 #ifndef ADM_LEGACY_PROGGY
   #define malloc #error
   #define realloc #error



From mean at mail.berlios.de  Tue Nov 29 07:50:21 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 29 Nov 2011 07:50:21 +0100
Subject: [Avidemux-svn-commit] r7673 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src
Message-ID: <20111129065021.989A8481380@sheep.berlios.de>

Author: mean
Date: 2011-11-29 07:50:21 +0100 (Tue, 29 Nov 2011)
New Revision: 7673

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/CMakeLists.txt
Log:
[apple] dont use our own malloc/free on macOsX, patch by nibbles

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/CMakeLists.txt	2011-11-29 06:50:19 UTC (rev 7672)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/CMakeLists.txt	2011-11-29 06:50:21 UTC (rev 7673)
@@ -1,5 +1,5 @@
 SET(ADM_core_SRCS 
-	ADM_cpuCap.cpp  ADM_memcpy.cpp  ADM_memsupport.cpp  ADM_threads.cpp  ADM_win32.cpp
+	ADM_cpuCap.cpp  ADM_memsupport.cpp  ADM_threads.cpp  ADM_win32.cpp
 	ADM_memory.cpp  ADM_misc.cpp  TLK_clock.cpp  ADM_fileio.cpp ADM_dynamicLoading.cpp
         ADM_debug.cpp 
         ADM_queue.cpp
@@ -14,6 +14,10 @@
 	SET(ADM_core_SRCS ${ADM_core_SRCS} ADM_crashdump_unix.cpp)
 ENDIF (MINGW)
 
+IF (NOT APPLE)
+	SET(ADM_core_SRCS ${ADM_core_SRCS} ADM_memcpy.cpp)
+ENDIF (NOT APPLE)
+
 ADM_ADD_SHARED_LIBRARY(ADM_core6 ${ADM_core_SRCS})
 ADD_TARGET_DEFINITIONS(ADM_core6 ADM_DEBUG FIND_LEAKS)
 



From mean at mail.berlios.de  Tue Nov 29 07:50:23 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 29 Nov 2011 07:50:23 +0100
Subject: [Avidemux-svn-commit] r7674 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <20111129065023.3D928481380@sheep.berlios.de>

Author: mean
Date: 2011-11-29 07:50:22 +0100 (Tue, 29 Nov 2011)
New Revision: 7674

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
Log:
[apple] dont initialize our memcpy stuff, patch by nibbles

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2011-11-29 06:50:21 UTC (rev 7673)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2011-11-29 06:50:22 UTC (rev 7674)
@@ -208,7 +208,9 @@
 
 	// Start counting memory
 	ADM_memStatInit();
+#ifndef __APPLE__
     ADM_InitMemcpy();
+#endif
 	printf("\nInitialising prefs\n");
 	initPrefs();
 	if(false==prefs->load()) // no prefs, set some sane default



From mean at mail.berlios.de  Tue Nov 29 07:50:25 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 29 Nov 2011 07:50:25 +0100
Subject: [Avidemux-svn-commit] r7675 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src
Message-ID: <20111129065025.7AD80481380@sheep.berlios.de>

Author: mean
Date: 2011-11-29 07:50:25 +0100 (Tue, 29 Nov 2011)
New Revision: 7675

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/CMakeLists.txt
Log:
[imageUtils] tune for macOsX, patch by nibbles

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/CMakeLists.txt	2011-11-29 06:50:22 UTC (rev 7674)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/CMakeLists.txt	2011-11-29 06:50:25 UTC (rev 7675)
@@ -22,7 +22,10 @@
 ADM_ADD_SHARED_LIBRARY(ADM_coreImage6 ${ADM_coreImage_SRCS})
 ADD_SOURCE_CFLAGS(DIA_flyDialog.cpp " -DADM_UI_TYPE_BUILD=99")
 IF (APPLE)
-	TARGET_LINK_LIBRARIES(ADM_coreImage6 -Wl,-read_only_relocs,suppress)
+    SET_SOURCE_FILES_PROPERTIES("ADM_imageUtils.cpp" PROPERTIES COMPILE_FLAGS -O0)
+    IF (NOT ADM_CPU_X86_64)
+        TARGET_LINK_LIBRARIES(ADM_coreImage6 -Wl,-read_only_relocs,suppress)
+    ENDIF (NOT ADM_CPU_X86_64)
 ENDIF (APPLE)
 
 TARGET_LINK_LIBRARIES(ADM_coreImage6 ADM_core6 ADM_coreUI6 ADM_libswscale ADM_libpostproc ADM_coreUtils6)



From mean at mail.berlios.de  Tue Nov 29 07:50:27 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 29 Nov 2011 07:50:27 +0100
Subject: [Avidemux-svn-commit] r7676 -
	branches/avidemux_2.6_branch_mean/cmake
Message-ID: <20111129065027.B11E9481380@sheep.berlios.de>

Author: mean
Date: 2011-11-29 07:50:27 +0100 (Tue, 29 Nov 2011)
New Revision: 7676

Modified:
   branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake
Log:
[ffmpeg] Be verbose (again)

Modified: branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake	2011-11-29 06:50:25 UTC (rev 7675)
+++ branches/avidemux_2.6_branch_mean/cmake/ffmpeg_make.sh.cmake	2011-11-29 06:50:27 UTC (rev 7676)
@@ -1,2 +1,2 @@
 export PATH=$PATH:${ffmpeg_bash_directory}
-make 
+make  V=1 VERBOSE=1



From mean at mail.berlios.de  Wed Nov 30 09:55:12 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed, 30 Nov 2011 09:55:12 +0100
Subject: [Avidemux-svn-commit] r7677 - in branches/avidemux_2.6_branch_mean:
	. cmake
Message-ID: <20111130085513.4386448140B@sheep.berlios.de>

Author: mean
Date: 2011-11-30 09:55:12 +0100 (Wed, 30 Nov 2011)
New Revision: 7677

Modified:
   branches/avidemux_2.6_branch_mean/bootStrap.bash
   branches/avidemux_2.6_branch_mean/bootStrapCrossMingw_w32.sh
   branches/avidemux_2.6_branch_mean/bootStrapCrossMingw_w64.sh
   branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake
Log:
[build] Workaround cmake limitation when a custom command ouputs several targets by forcing -j1 for core

Modified: branches/avidemux_2.6_branch_mean/bootStrap.bash
===================================================================
--- branches/avidemux_2.6_branch_mean/bootStrap.bash	2011-11-29 06:50:27 UTC (rev 7676)
+++ branches/avidemux_2.6_branch_mean/bootStrap.bash	2011-11-30 08:55:12 UTC (rev 7677)
@@ -9,6 +9,7 @@
 do_qt4=1
 do_plugins=1
 debug=0
+export O_PARAL="-j 2"
 fail()
 {
         echo "** Failed at $1**"
@@ -33,7 +34,7 @@
         mkdir $BUILDDIR || fail mkdir
         cd $BUILDDIR 
         cmake $PKG $FAKEROOT -DCMAKE_EDIT_COMMAND=vim -DAVIDEMUX_SOURCE_DIR=$TOP -DCMAKE_INSTALL_PREFIX=/usr $EXTRA $DEBUG -G "$BUILDER" $SOURCEDIR || fail cmakeZ
-        make  -j 2 >& /tmp/log$BUILDDIR || fail make
+        make  $PARAL >& /tmp/log$BUILDDIR || fail make
 	if  [ "x$PKG" != "x" ] ; then
           fakeroot make package DESTDIR=$FAKEROOT_DIR/tmp || fail package
 	fi
@@ -167,10 +168,12 @@
 if [ "x$do_core" = "x1" ] ; then 
         echo "** CORE **"
         cd $TOP
+        export PARAL=""
         Process buildCore ../avidemux_core
         echo " Installing core"
         cd $TOP/buildCore${POSTFIX} 
 fi
+export PARAL="$O_PARAL"
 if [ "x$do_qt4" = "x1" ] ; then 
         echo "** QT4 **"
         cd $TOP

Modified: branches/avidemux_2.6_branch_mean/bootStrapCrossMingw_w32.sh
===================================================================
--- branches/avidemux_2.6_branch_mean/bootStrapCrossMingw_w32.sh	2011-11-29 06:50:27 UTC (rev 7676)
+++ branches/avidemux_2.6_branch_mean/bootStrapCrossMingw_w32.sh	2011-11-30 08:55:12 UTC (rev 7677)
@@ -5,6 +5,7 @@
 export SDLDIR=/mingw
 export MINGW=/mingw
 export QT_HOME=/mingw/Qt/current
+export O_PARAL="-j 2"
 # ** Put your config here **
 
 fail()
@@ -23,7 +24,7 @@
         mkdir $BUILDDIR || fail mkdir
         cd $BUILDDIR 
         sh $TOP/foreignBuilds/$SCRIPT $EXTRA || fail cmake
-        make -j 2 VERBOSE=1 || fail make
+        make $PARAL VERBOSE=1 || fail make
         make install || fail make_install
 }
 
@@ -35,7 +36,9 @@
 Process buildMingwCore cross_mingw_core
 echo "** QT4 **"
 cd $TOP
+export PARAL=""
 Process buildMingwQt4 cross_mingw_qt4 
+export PARAL="$O_PARAL"
 #echo "** GTK **"
 #cd $TOP
 #Process buildGtk ../avidemux/gtk

Modified: branches/avidemux_2.6_branch_mean/bootStrapCrossMingw_w64.sh
===================================================================
--- branches/avidemux_2.6_branch_mean/bootStrapCrossMingw_w64.sh	2011-11-29 06:50:27 UTC (rev 7676)
+++ branches/avidemux_2.6_branch_mean/bootStrapCrossMingw_w64.sh	2011-11-30 08:55:12 UTC (rev 7677)
@@ -6,6 +6,7 @@
 export MINGW=/mingw
 export QT_HOME=/mingw/Qt/qt471win64
 export CFLAGS="-fpermissive"
+export O_PARAL="-j 2"
 # ** Put your config here **
 
 fail()
@@ -24,7 +25,7 @@
         mkdir $BUILDDIR || fail mkdir
         cd $BUILDDIR 
         sh $TOP/foreignBuilds/$SCRIPT $EXTRA || fail cmake
-        make  VERBOSE=1 || fail make
+        make  $PARAL VERBOSE=1 || fail make
         make install || fail make_install
 }
 
@@ -33,7 +34,9 @@
 echo "Top dir : $TOP"
 echo "** CORE **"
 cd $TOP
+export PARAL=""
 Process buildMingwCore cross_mingw64_core
+export PARAL="$O_PARAL"
 echo "** QT4 **"
 cd $TOP
 Process buildMingwQt4 cross_mingw64_qt4 

Modified: branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake	2011-11-29 06:50:27 UTC (rev 7676)
+++ branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake	2011-11-30 08:55:12 UTC (rev 7677)
@@ -254,7 +254,6 @@
 getFfmpegLibNames("${FFMPEG_SOURCE_DIR}")
 configure_file("${AVIDEMUX_TOP_SOURCE_DIR}/cmake/ffmpeg_make.sh.cmake" "${FFMPEG_BINARY_DIR}/ffmpeg_make.sh")
 
-if(WIN32 AND NOT CROSS)
   add_custom_command(OUTPUT
 						"${FFMPEG_BINARY_DIR}/libavcodec/${LIBAVCODEC_LIB}"
 						"${FFMPEG_BINARY_DIR}/libavformat/${LIBAVFORMAT_LIB}"
@@ -263,16 +262,6 @@
 						"${FFMPEG_BINARY_DIR}/libswscale/${LIBSWSCALE_LIB}"
 						"${FFMPEG_BINARY_DIR}/ffmpeg${CMAKE_EXECUTABLE_SUFFIX}"
 				   COMMAND ${BASH_EXECUTABLE} ffmpeg_make.sh WORKING_DIRECTORY "${FFMPEG_BINARY_DIR}")
-else(WIN32 AND NOT CROSS)
-  add_custom_command(OUTPUT
-						"${FFMPEG_BINARY_DIR}/libavcodec/${LIBAVCODEC_LIB}"
-						"${FFMPEG_BINARY_DIR}/libavformat/${LIBAVFORMAT_LIB}"
-						"${FFMPEG_BINARY_DIR}/libavutil/${LIBAVUTIL_LIB}"
-						"${FFMPEG_BINARY_DIR}/libpostproc/${LIBPOSTPROC_LIB}"
-						"${FFMPEG_BINARY_DIR}/libswscale/${LIBSWSCALE_LIB}"
-						"${FFMPEG_BINARY_DIR}/ffmpeg${CMAKE_EXECUTABLE_SUFFIX}"
-				   COMMAND ${CMAKE_BUILD_TOOL} WORKING_DIRECTORY "${FFMPEG_BINARY_DIR}")
-endif(WIN32 AND NOT CROSS)
 
 # Add and install libraries
 registerFFmpeg("${FFMPEG_SOURCE_DIR}" "${FFMPEG_BINARY_DIR}" 0)



From mean at mail.berlios.de  Wed Nov 30 21:01:19 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed, 30 Nov 2011 21:01:19 +0100
Subject: [Avidemux-svn-commit] r7678 - in branches/avidemux_2.6_branch_mean:
	avidemux/common/ADM_render avidemux/qt4/ADM_UIs/src
	avidemux_plugins/ADM_videoFilters6_openGl/glVdpau
Message-ID: <20111130200119.BD41C48140B@sheep.berlios.de>

Author: mean
Date: 2011-11-30 21:01:19 +0100 (Wed, 30 Nov 2011)
New Revision: 7678

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
Log:
[GL] Include glu.h also, patch by hobbes

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.cpp	2011-11-30 08:55:12 UTC (rev 7677)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.cpp	2011-11-30 20:01:19 UTC (rev 7678)
@@ -20,6 +20,7 @@
 #	define GL_TEXTURE_RECTANGLE_NV GL_TEXTURE_RECTANGLE_EXT
 #else
 #	include <GL/gl.h>
+#	include <GL/glu.h>
 #	include <GL/glext.h>
 #endif
 #define ADM_LEGACY_PROGGY // Dont clash with free/malloc etc..
@@ -401,4 +402,4 @@
 {
     return new QtGlRender();
 }
-// EOF
\ No newline at end of file
+// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-11-30 08:55:12 UTC (rev 7677)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-11-30 20:01:19 UTC (rev 7678)
@@ -7,6 +7,7 @@
 #include "T_openGLFilter.h"
 #include "ADM_default.h"
 #include "DIA_coreToolkit.h"
+#include <GL/glu.h>
 static QGLWidget *thisWidget=NULL;
 /**
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-11-30 08:55:12 UTC (rev 7677)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-11-30 20:01:19 UTC (rev 7678)
@@ -12,6 +12,7 @@
 #define GL_GLEXT_PROTOTYPES
 
 #       include <GL/gl.h>
+#       include <GL/glu.h>
 #       include <GL/glext.h>
 
 #include <QtGui/QImage> 



