<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r4737 -	branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2009-April/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4737%20-%0A%09branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS&In-Reply-To=%3C200904151754.n3FHsOJU007499%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001964.html">
   <LINK REL="Next"  HREF="001966.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r4737 -	branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4737%20-%0A%09branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS&In-Reply-To=%3C200904151754.n3FHsOJU007499%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r4737 -	branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS">mean at mail.berlios.de
       </A><BR>
    <I>Wed Apr 15 19:54:24 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001964.html">[Avidemux-svn-commit] r4736 -	branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS
</A></li>
        <LI>Next message: <A HREF="001966.html">[Avidemux-svn-commit] r4738 - in	branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers:	MpegPS MpegTS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1965">[ date ]</a>
              <a href="thread.html#1965">[ thread ]</a>
              <a href="subject.html#1965">[ subject ]</a>
              <a href="author.html#1965">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2009-04-15 19:54:24 +0200 (Wed, 15 Apr 2009)
New Revision: 4737

Modified:
   branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsAudioProbe.cpp
   branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsAudioProbe.h
   branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
   branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsPlugin.cpp
   branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/dmxTSPacket.cpp
   branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/dmxTSPacket.h
Log:
[TS Demuxer] Very basic mpeg2 indexer

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsAudioProbe.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsAudioProbe.cpp	2009-04-14 17:43:17 UTC (rev 4736)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsAudioProbe.cpp	2009-04-15 17:54:24 UTC (rev 4737)
@@ -35,7 +35,7 @@
 #define LPCM_AUDIO_VALUE 0xA0
 #define DTS_AC3_AUDIO_VALUE 0x00
 
-static bool addAudioTrack(int pid, listOfTsAudioTracks *list, tsPacketLinearTracker *p);
+static bool addAudioTrack(int pid, listOfTsAudioTracks *list, tsPacketLinear *p);
 static bool tsCheckMp2Audio(WAVHeader *hdr, uint8_t *data, uint32_t dataSize);
 /**
     \fn listOfPsAudioTracks
@@ -50,7 +50,7 @@
     uint64_t fileSize;
 
     listOfTsAudioTracks *tracks=new listOfTsAudioTracks;
-    tsPacketLinearTracker *packet=new tsPacketLinearTracker(0xE0);
+    tsPacketLinear *packet=new tsPacketLinear(0xE0);
 
     printf(&quot;[MpegPS] Probing audio for %s\n&quot;,fileName);
 
@@ -58,12 +58,14 @@
     fileSize=packet-&gt;getSize();
 
     packet-&gt;setPos(fileSize/2); // Jump in the middle of the stream
-
+#if 0
     while(packet-&gt;getPacketOfType(0xE0,PACKET_PROBE_SIZE,&amp;size,&amp;dts,&amp;pts,buffer,&amp;startAt))
     {
+
         packetStats *stat=packet-&gt;getStat(0xE0);
         if(stat-&gt;count &gt; PROBE_PACKET_VIDEO_COUNT)
                 break;
+
     }
     // Now synthetize
     for(int i=0x0;i&lt;0xFF;i++)   
@@ -81,7 +83,7 @@
          }
 
     }
-
+#endif
 end:
     printf(&quot;[PsDemux] Audio probe done, found %lu tracks\n&quot;,tracks-&gt;size());
     delete packet;
@@ -98,7 +100,7 @@
     \brief gather information about audio &amp; add audio track to the list
 
 */
-bool addAudioTrack(int pid, listOfTsAudioTracks *list, tsPacketLinearTracker *p)
+bool addAudioTrack(int pid, listOfTsAudioTracks *list, tsPacketLinear *p)
 {
 #define PROBE_ANALYZE_SIZE 6000 // Should be enough in all cases (need ~ 2 blocks)
 uint8_t audioBuffer[PROBE_ANALYZE_SIZE];

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsAudioProbe.h
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsAudioProbe.h	2009-04-14 17:43:17 UTC (rev 4736)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsAudioProbe.h	2009-04-15 17:54:24 UTC (rev 4737)
@@ -21,7 +21,7 @@
 typedef struct
 {
     WAVHeader header;
-    uint8_t   esID;
+    uint32_t  esID;
 }tsAudioTrackInfo;
 
 typedef vector &lt;tsAudioTrackInfo*&gt; listOfTsAudioTracks;

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2009-04-14 17:43:17 UTC (rev 4736)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2009-04-15 17:54:24 UTC (rev 4737)
@@ -25,6 +25,7 @@
 #include &quot;ADM_quota.h&quot;
 #include &quot;ADM_tsAudioProbe.h&quot;
 #include &quot;DIA_working.h&quot;
+#include &quot;ADM_tsPatPmt.h&quot;
 
 static const char Type[5]={'X','I','P','B','P'};
 
@@ -54,6 +55,7 @@
     uint32_t fps;
     uint32_t interlaced;
     uint32_t ar;
+    uint32_t pid;
 }PSVideo;
 
 typedef enum
@@ -86,13 +88,13 @@
 {
 protected:
         FILE *index;
-        tsPacketLinearTracker *pkt;
-        listOfTsAudioTracks *audioTracks;
+        tsPacketLinear       *pkt;
+        listOfTsAudioTracks  *audioTracks;
         DIA_workingBase  *ui;
 public:
                 TsIndexer(void);
                 ~TsIndexer();
-        bool    run(const char *file);
+        bool    run(const char *file,uint32_t nbTracks, ADM_TS_TRACK *Tracks);
         bool    writeVideo(PSVideo *video);
         bool    writeAudio(void);
         bool    writeSystem(const char *filename,bool append);
@@ -106,9 +108,23 @@
 uint8_t   tsIndexer(const char *file)
 {
 bool r;
+
+    ADM_TS_TRACK *tracks;
+    uint32_t nbTracks;
+
+    if(TS_scanForPrograms(file,&amp;nbTracks,&amp;tracks)==false) 
+    {
+        printf(&quot;[Ts Indexer] Scan of pmt failed\n&quot;);
+        return false;
+    }
+    ADM_assert(tracks);
+    ADM_assert(nbTracks);
+    
+
     TsIndexer *dx=new TsIndexer;
-    r=dx-&gt;run(file);
+    r=dx-&gt;run(file,nbTracks,tracks);
     delete dx;
+    delete [] tracks;
     return r;
 }
 
@@ -137,7 +153,7 @@
 /**
     \fn run
 */  
-bool TsIndexer::run(const char *file)
+bool TsIndexer::run(const char *file,uint32_t nbTracks, ADM_TS_TRACK *Tracks)
 {
 uint32_t temporal_ref,val;
 uint64_t fullSize;
@@ -148,6 +164,14 @@
 indexerData  data;    
 dmxPacketInfo info;
 
+    if(!nbTracks) return false;
+    if(Tracks[0].trackType!=ADM_TS_MPEG2)
+    {
+        printf(&quot;[Ts Indexer] Only Mpeg2 video supported\n&quot;);
+        return false;
+    }
+    video.pid=Tracks[0].trackPid;
+
     memset(&amp;data,0,sizeof(data));
     char indexName[strlen(file)+5];
     sprintf(indexName,&quot;%s.idx&quot;,file);
@@ -158,24 +182,8 @@
         return false;
     }
     writeSystem(file,true);
-    pkt=new tsPacketLinearTracker(0xE0);
+    pkt=new tsPacketLinear(Tracks[0].trackPid);
 
-    audioTracks=tsProbeAudio(file);
-    if(audioTracks)
-    {
-        for(int i=0;i&lt;audioTracks-&gt;size();i++)
-        {
-                printf(&quot;[PsProbe] Found audio Track %d, pid=%x\n&quot;,i,(*audioTracks)[i]-&gt;esID);
-                WAVHeader *hdr=&amp;((*audioTracks)[i]-&gt;header);
-                printf(&quot;[PsProbe] codec    : 0x%x \n&quot;,hdr-&gt;encoding);
-                printf(&quot;[PsProbe] frequency: %&quot;LU&quot; Hz\n&quot;,hdr-&gt;frequency);
-                printf(&quot;[PsProbe] channel  : %&quot;LU&quot; \n&quot;,hdr-&gt;channels);
-                printf(&quot;[PsProbe] byterate : %&quot;LU&quot; Byte/s\n&quot;,hdr-&gt;byterate);
-
-        }
-
-    }
-
     FP_TYPE append=FP_APPEND;
     pkt-&gt;open(file,append);
     data.pkt=pkt;
@@ -216,8 +224,8 @@
                           video.fps= FPS[val &amp; 0xf];
                           pkt-&gt;forward(4);
                           writeVideo(&amp;video);
-                          writeAudio();
-                          pkt-&gt;resetStats();
+                          //writeAudio();
+                          //pkt-&gt;resetStats();
                           qfprintf(index,&quot;[Data]&quot;);
                           break;
                   case 0xb8: // GOP
@@ -317,9 +325,11 @@
     {
         if(data-&gt;frameType==1)
         {
+#if 0
             // If audio, also dump audio
             if(audioTracks)
             {
+
                 qfprintf(index,&quot;\nAudio bf:%08&quot;LLX&quot; &quot;,data-&gt;startAt);
                 for(int i=0;i&lt;audioTracks-&gt;size();i++)
                 {
@@ -330,6 +340,7 @@
                 }
                 
             }
+#endif
             // start a new line
             qfprintf(index,&quot;\nVideo at:%08&quot;LLX&quot;:%04&quot;LX&quot; Pts:%08&quot;LLD&quot;:%08&quot;LLD&quot; &quot;,data-&gt;startAt,data-&gt;offset,info-&gt;pts,info-&gt;dts);
             data-&gt;nextOffset=-2;
@@ -361,6 +372,7 @@
     qfprintf(index,&quot;Fps=%d\n&quot;,video-&gt;fps);
     qfprintf(index,&quot;Interlaced=%d\n&quot;,video-&gt;interlaced);
     qfprintf(index,&quot;AR=%d\n&quot;,video-&gt;ar);
+    qfprintf(index,&quot;Pid=%d\n&quot;,video-&gt;pid);
     return true;
 }
 /**
@@ -371,7 +383,7 @@
 {
     qfprintf(index,&quot;PSD1\n&quot;);
     qfprintf(index,&quot;[System]\n&quot;);
-    qfprintf(index,&quot;Type=P\n&quot;);
+    qfprintf(index,&quot;Type=T\n&quot;);
     qfprintf(index,&quot;File=%s\n&quot;,filename);
     qfprintf(index,&quot;Append=%d\n&quot;,append);
     return true;

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsPlugin.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsPlugin.cpp	2009-04-14 17:43:17 UTC (rev 4736)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/ADM_tsPlugin.cpp	2009-04-15 17:54:24 UTC (rev 4737)
@@ -60,14 +60,8 @@
     printf(&quot;[TSDemuxer] Analyzing file..\n&quot;);
     count++;
 
-    ADM_TS_TRACK *tracks;
-    uint32_t nbTracks;
-
-    if(TS_scanForPrograms(fileName,&amp;nbTracks,&amp;tracks)==false) return 0;
-    ADM_assert(tracks);
-    ADM_assert(nbTracks);
-    delete [] tracks;
-    //if(true==tsIndexer(fileName)) goto again;
+  
+    if(true==tsIndexer(fileName)) goto again;
     printf(&quot;[TSDemuxer] Failed..\n&quot;);
    return 0;
 }

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/dmxTSPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/dmxTSPacket.cpp	2009-04-14 17:43:17 UTC (rev 4736)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/dmxTSPacket.cpp	2009-04-15 17:54:24 UTC (rev 4737)
@@ -23,6 +23,7 @@
 #include &quot;dmxTSPacket.h&quot;
 #include &quot;dmx_mpegstartcode.h&quot;
 
+#define TS_PES_MAX_LIMIT (1024*1024*2)
 
 
 #define ADM_NO_CONFIG_H
@@ -35,7 +36,7 @@
 }
 #include &quot;ADM_tsCrc.cpp&quot;
 
-
+extern void mixDump(uint8_t *ptr, uint32_t len);
 /**
     \fn tsPacket
     \brief ctor
@@ -43,8 +44,6 @@
 tsPacket::tsPacket(void) 
 {
     extraCrap=0; // =4 for ts2
-
-
 }
 /**
     \fn tsPacket
@@ -89,12 +88,13 @@
 */
 uint64_t    tsPacket::getPos(void)
 {
-    return 0;
+    uint64_t pos;
+    _file-&gt;getpos(&amp;pos);
+    return pos;
 }
 /**
     \fn setPos
 */
-
 bool    tsPacket::setPos(uint64_t pos)
 {
     if(!_file-&gt;setpos(pos))
@@ -295,11 +295,12 @@
         \brief Returns the next PES packet
         
 */
-extern void mixDump(uint8_t *ptr, uint32_t len);
+
 bool        tsPacket::getNextPES(TS_PESpacket *pes)
 {
 #define zprintf printf
     TSpacketInfo pkt;
+    pes-&gt;fresh=false;
 nextPack3:
     // Sync at source
     if(false==getNextPacket_NoHeader(pes-&gt;pid,&amp;pkt,false)) return false;    
@@ -340,14 +341,22 @@
                 _file-&gt;setpos(pos);
                 break;
          }
+        if(pes-&gt;payloadLimit&gt;TS_PES_MAX_LIMIT)
+        {
+            printf(&quot;[Ts Demuxer] Pes Packet too big\n&quot;);
+            goto nextPack3;
+        }
     }
+    //____________________
     // Now decode PES header (extra memcpy)
+    //____________________
     printf(&quot;[Ts Demuxer] Full size :%d\n&quot;,pes-&gt;payloadSize);
     if(false==decodePesHeader(pes))
         goto nextPack3;
 
     //
-    printf(&quot;[Ts Demuxer] Found PES of len %d\n&quot;,pes-&gt;payloadSize);
+    printf(&quot;[Ts Demuxer] Found PES of len %d\n&quot;,pes-&gt;payloadSize);  
+    pes-&gt;fresh=true;
     return true;
 }
 /**
@@ -366,6 +375,7 @@
     pes-&gt;dts=ADM_NO_PTS;
     pes-&gt;pts=ADM_NO_PTS;
 
+    if(pes-&gt;payloadSize&lt;(4+2+1+2)) return false;
     
     while(*start==0xff &amp;&amp; start&lt;end) start++; // Padding
     if(start&gt;=end) fail(&quot;too much padding&quot;);
@@ -380,33 +390,36 @@
         ptsdts=c&gt;&gt;6;
         // header len
         len=*start++;
-
+        int available=(int)(end-start);
         switch(ptsdts)
         {
                 case 2: // PTS=1 DTS=0
                        
                         {
+                                if(available&lt;5) return false;
                                 uint64_t pts1,pts2,pts0;
                                 //      printf(&quot;\n PTS10\n&quot;);
-                                        pts0=*start++;  
-                                        pts1=*start++; 
-                                        pts2=*start++;                 
+                                        pts0=start[0];  
+                                        pts1=(start[1]&lt;&lt;8)+start[2]; 
+                                        pts2=(start[3]&lt;&lt;8)+start[4]; 
+                                        start+=5;
                                         pes-&gt;pts=(pts1&gt;&gt;1)&lt;&lt;15;
                                         pes-&gt;pts+=pts2&gt;&gt;1;
                                         pes-&gt;pts+=(((pts0&amp;6)&gt;&gt;1)&lt;&lt;30);
                         }
                         break;
                 case 3: // PTS=1 DTS=1
+                                if(available&lt;10) return false;
                                 #define PTS11_ADV 10 // nut monkey
-//                                if(len&gt;=PTS11_ADV)
+                                if(len&gt;=PTS11_ADV)
                                 {
                                         uint32_t skip=PTS11_ADV;
                                         uint64_t pts1,pts2,dts,pts0;
                                                 //      printf(&quot;\n PTS10\n&quot;);
-                                                pts0=*start++;  
-                                                pts1=*start++;; 
-                                                pts2=(start[0]&lt;&lt;8)+start[1]; 
-                                                start+=2;
+                                                pts0=start[0];  
+                                                pts1=(start[1]&lt;&lt;8)+start[2]; 
+                                                pts2=(start[3]&lt;&lt;8)+start[4]; 
+                                                start+=5;
                                                                         
                                                 pes-&gt;pts=(pts1&gt;&gt;1)&lt;&lt;15;
                                                 pes-&gt;pts+=pts2&gt;&gt;1;
@@ -414,7 +427,7 @@
                                                 pts0=*start++;  
                                                 pts1=(start[0]&lt;&lt;8)+start[1]; 
                                                 pts2=(start[2]&lt;&lt;8)+start[3];       
-                                                start+=4;
+                                                start+=5;
                                                 pes-&gt;dts=(pts1&gt;&gt;1)&lt;&lt;15;
                                                 pes-&gt;dts+=pts2&gt;&gt;1;
                                                 pes-&gt;dts+=(((pts0&amp;6)&gt;&gt;1)&lt;&lt;30);
@@ -447,300 +460,20 @@
 */      
 bool        tsPacket::getPacket(uint32_t maxSize, uint8_t *pid, uint32_t *packetSize,uint64_t *opts,uint64_t *odts,uint8_t *buffer,uint64_t *startAt)
 {
-uint32_t globstream,len;
-uint8_t  stream,substream;
-uint64_t pts,dts;
-        // Resync on our stream
-_again2:
-        *pid=0;
-        if(!_file-&gt;sync(&amp;stream)) 
-        {
-                uint64_t pos;
-                _file-&gt;getpos(&amp;pos);
-                printf(&quot;[DmxPS] cannot sync  at &quot;LLU&quot;/&quot;LLU&quot;\n&quot;,pos,_size);
-                return false;
-        }
-// Position of this packet just before startcode
-        _file-&gt;getpos(startAt);
-        *startAt-=4;
-// Handle out of band stuff        
-        if(stream==PACK_START_CODE) 
-        {
-        		_file-&gt;forward(8);
-        		goto _again2;
-        }
-        if( stream==PADDING_CODE ||stream==SYSTEM_START_CODE) 
-        {
-                        len=_file-&gt;read16i();
-                        //printf(&quot;\tForwarding %lu bytes\n&quot;,len);
-        		_file-&gt;forward(len);
-        		goto _again2;
-        }
-        // Only keep relevant parts
-        // i.e. a/v : C0 C9 E0 E9
-        // subs 20-29
-        // private data 1/2
-#define INSIDE(min,max) (stream&gt;=min &amp;&amp; stream&lt;max)
-        if(!(  INSIDE(0xC0,0xC9) || INSIDE(0xE0,0xE9) || INSIDE(0x20,0x29) || stream==PRIVATE_STREAM_1 || stream==PRIVATE_STREAM_2
-        			)) goto _again2;
-        // Ok we got a candidate
-        if(!getPacketInfo(stream,&amp;substream,&amp;len,&amp;pts,&amp;dts))   
-        {
-                goto _again2;
-        }
-        
-        //printf(&quot;Main Stream :%x substream :%x\n&quot;,stream,substream);
-        if(stream==PRIVATE_STREAM_1) globstream=0xFF00+substream;
-                else                 globstream=stream;
 
-        *pid=globstream;
-        *opts=pts;
-        *odts=dts;
-        *packetSize=len;
-        if(len&gt;     maxSize)
-        {
-                printf(&quot;[DmxPS] Packet too big %d vs %d\n&quot;,len,maxSize);
-        }
-        if(!_file-&gt;read32(len,buffer)) return false;
-        return true;
+        return false;
        
 }
-/**
 
-    \fn getPacketInfo
-    \brief       Retrieve info about the packet we just met.It is assumed that parser is just after the packet startcode
-
-*/
-
-uint8_t tsPacket::getPacketInfo(uint8_t stream,uint8_t *substream,uint32_t *olen,uint64_t *opts,uint64_t *odts)
-{
-
-//uint32_t un ,deux;
-uint64_t size=0;
-uint8_t c,d;
-uint8_t align=0;
-                        
-                *substream=0xff;
-                *opts=ADM_NO_PTS;
-                *odts=ADM_NO_PTS;
-                
-                                        
-                size=_file-&gt;read16i();
-                if((stream==PADDING_CODE) || 
-                	 (stream==PRIVATE_STREAM_2)
-                        ||(stream==SYSTEM_START_CODE) //?
-                        ) // special case, no header
-                        {
-                                *olen=size;      
-                                return 1;
-                        }
-                                
-                        //      remove padding if any                                           
-        
-                while((c=_file-&gt;read8i()) == 0xff) 
-                {
-                        size--;
-                }
-//----------------------------------------------------------------------------
-//-------------------------------MPEG-2 PES packet style----------------------
-//----------------------------------------------------------------------------
-                if(((c&amp;0xC0)==0x80))
-                {
-                        uint32_t ptsdts,len;
-                        //printf(&quot;\n mpeg2 type \n&quot;);
-                        //_muxTypeMpeg2=1;
-                        // c= copyright and stuff       
-                        //printf(&quot; %x align\n&quot;,c);      
-                        if(c &amp; 4) align=1;      
-                        c=_file-&gt;read8i();     // PTS/DTS
-                        //printf(&quot;%x ptsdts\n&quot;,c
-                        ptsdts=c&gt;&gt;6;
-                        // header len
-                        len=_file-&gt;read8i();
-                        size-=3;  
-
-                        switch(ptsdts)
-                        {
-                                case 2: // PTS=1 DTS=0
-                                        if(len&gt;=5)
-                                        {
-                                                uint64_t pts1,pts2,pts0;
-                                                //      printf(&quot;\n PTS10\n&quot;);
-                                                        pts0=_file-&gt;read8i();  
-                                                        pts1=_file-&gt;read16i(); 
-                                                        pts2=_file-&gt;read16i();                 
-                                                        len-=5;
-                                                        size-=5;
-                                                        *opts=(pts1&gt;&gt;1)&lt;&lt;15;
-                                                        *opts+=pts2&gt;&gt;1;
-                                                        *opts+=(((pts0&amp;6)&gt;&gt;1)&lt;&lt;30);
-                                        }
-                                        break;
-                                case 3: // PTS=1 DTS=1
-                                                #define PTS11_ADV 10 // nut monkey
-                                                if(len&gt;=PTS11_ADV)
-                                                {
-                                                        uint32_t skip=PTS11_ADV;
-                                                        uint64_t pts1,pts2,dts,pts0;
-                                                                //      printf(&quot;\n PTS10\n&quot;);
-                                                                pts0=_file-&gt;read8i();  
-                                                                pts1=_file-&gt;read16i(); 
-                                                                pts2=_file-&gt;read16i(); 
-                                                                                        
-                                                                *opts=(pts1&gt;&gt;1)&lt;&lt;15;
-                                                                *opts+=pts2&gt;&gt;1;
-                                                                *opts+=(((pts0&amp;6)&gt;&gt;1)&lt;&lt;30);
-                                                                pts0=_file-&gt;read8i();  
-                                                                pts1=_file-&gt;read16i(); 
-                                                                pts2=_file-&gt;read16i();                 
-                                                                dts=(pts1&gt;&gt;1)&lt;&lt;15;
-                                                                dts+=pts2&gt;&gt;1;
-                                                                dts+=(((pts0&amp;6)&gt;&gt;1)&lt;&lt;30);
-                                                                len-=skip;
-                                                                size-=skip;
-                                                                *odts=dts;
-                                                                        //printf(&quot;DTS: %lx\n&quot;,dts);                
-                                                   }
-                                                   break;               
-                                case 1:
-                                                return 0;//ADM_assert(0); // forbidden !
-                                                break;
-                                case 0: 
-                                                // printf(&quot;\n PTS00\n&quot;);
-                                                break; // no pts nor dts
-                                                                                
-                                                            
-                        }  
-// Extension bit        
-// &gt;stealthdave&lt;                                
-
-                        // Skip remaining headers if any
-                        if(len) 
-                        {
-                                _file-&gt;forward(len);
-                                size=size-len;
-                        }
-                                
-                if(stream==PRIVATE_STREAM_1)
-                {
-                        if(size&gt;5)
-                        {
-                        // read sub id
-                               *substream=_file-&gt;read8i();
-  //                    printf(&quot;\n Subid : %x&quot;,*subid);
-                                switch(*substream)
-                                {
-                                // DTS
-                                        case 0x88:case 0x89:case 0x8A:case 0x8B:
-                                        
-                                                *substream=*substream-0x48;
-                                                break;
-
-                                //AC3
-                                        case 0x80:case 0x81:case 0x82:case 0x83:
-                                        case 0x84:case 0x85:case 0x86:case 0x87:
-                                                *substream=*substream-0x80;
-                                                break;
-                                // PCM
-                                        case 0xA0:case 0xA1:case 0xa2:case 0xa3:
-                                        case 0xA4:case 0xA5:case 0xa6:case 0xa7:
-                                                // we have an additionnal header
-                                                // of 3 bytes
-                                                _file-&gt;forward(3);
-                                                size-=3;
-                                                break;
-                                // Subs
-                                case 0x20:case 0x21:case 0x22:case 0x23:
-                                case 0x24:case 0x25:case 0x26:case 0x27:
-                                                break;
-                             
-                                default:
-                                                doNoComplainAnyMore++;
-                                                if(doNoComplainAnyMore&lt;10)
-                                                    printf(&quot;[DmxPS]Unkown substream %x\n&quot;,*substream);
-                                                *substream=0xff;
-                                }
-                                // skip audio header (if not sub)
-                                if(*substream&gt;0x26 || *substream&lt;0x20)
-                                {
-                                        _file-&gt;forward(3);
-                                        size-=3;
-                                }
-                                size--;
-                        }
-                }
-               //    printf(&quot; pid %x size : %x len %x\n&quot;,sid,size,len);
-                *olen=size;
-                return 1;
-        }
-//----------------------------------------------------------------------------------------------                
-//-------------------------------MPEG-1 PES packet style----------------------                                  
-//----------------------------------------------------------------------------------------------                                        
-           if(0) //_muxTypeMpeg2)
-                {
-                        printf(&quot;[DmxPS]*** packet type 1 inside type 2 ?????*****\n&quot;);
-                        return 0; // mmmm                       
-                }
-          // now look at  STD buffer size if present
-          // 01xxxxxxxxx
-          if ((c&gt;&gt;6) == 1) 
-          {       // 01
-                        size-=2;
-                        _file-&gt;read8i();                       // skip one byte
-                        c=_file-&gt;read8i();   // then another
-           }                       
-           // PTS/DTS
-           switch(c&gt;&gt;4)
-           {
-                case 2:
-                {
-                        // 0010 xxxx PTS only
-                        uint64_t pts1,pts2,pts0;
-                                        size -= 4;
-                                        pts0=(c&gt;&gt;1) &amp;7;
-                                        pts1=_file-&gt;read16i()&gt;&gt;1;
-                                        pts2=_file-&gt;read16i()&gt;&gt;1;
-                                        *opts=pts2+(pts1&lt;&lt;15)+(pts0&lt;&lt;30);
-                                        break;
-                  }
-                  case 3:
-                  {               // 0011 xxxx
-                        uint64_t pts1,pts2,pts0;
-                                        size -= 9;
-                                                                        
-                                        pts0=(c&gt;&gt;1) &amp;7;
-                                        pts1=_file-&gt;read16i()&gt;&gt;1;
-                                        pts2=_file-&gt;read16i()&gt;&gt;1;
-                                        *opts=pts2+(pts1&lt;&lt;15)+(pts0&lt;&lt;30);
-                                        _file-&gt;forward(5);
-                   }                                                               
-                   break;
-                   
-                case 1:
-                        // 0001 xxx             
-                        // PTSDTS=01 not allowed                        
-                                return 0;
-                                break; 
-                }
-                                                                
-
-                if(!align)      
-                        size--;         
-        *olen=size;
-        return 1;
-}
-//************************************************************************************
-
 #define ADM_PACKET_LINEAR 10*1024
 /**
     \fn tsPacket
 */
-tsPacketLinear::tsPacketLinear(uint8_t pid) : tsPacket()
+tsPacketLinear::tsPacketLinear(uint32_t pid) : tsPacket()
 {
-    oldStartAt=startAt=0xfffffff;
-    oldBufferLen=bufferLen=0;
-    bufferIndex=0;
-    myPid=pid;
+    oldStartAt=0xfffffff;
+    oldBufferLen=0;
+    pesPacket=new TS_PESpacket(pid);
     eof=false;
 }
 /**
@@ -748,6 +481,8 @@
 */
 tsPacketLinear::~tsPacketLinear() 
 {
+    if(pesPacket) delete pesPacket;
+    pesPacket=NULL;
 }
 /**
     \fn refill
@@ -756,18 +491,15 @@
 {
 // In case a startcode spawns across 2 packets
 // we have to keep track of the old one
-        oldBufferDts=bufferDts;
-        oldBufferPts=bufferPts;
-        oldStartAt=startAt;
-        oldBufferLen=bufferLen;
-        if( false== getPacketOfType(myPid,ADM_PACKET_LINEAR, &amp;bufferLen,&amp;bufferPts,&amp;bufferDts,buffer,&amp;startAt)) 
+        oldBufferDts=pesPacket-&gt;dts;
+        oldBufferPts=pesPacket-&gt;dts;
+        oldStartAt=pesPacket-&gt;startAt;
+        oldBufferLen=pesPacket-&gt;payloadSize;
+        if(false==getNextPES(pesPacket))
         {
-            printf(&quot;[tsPacketLinear] Refill failed for pid :%x\n&quot;,myPid);
-            bufferIndex=bufferLen=0;
-            return false;
+                printf(&quot;[tsPacketLinear] Refill failed for pid :%x\n&quot;,pesPacket-&gt;pid);
+                return false;
         }
-        //printf(&quot;Refill : At :%&quot;LLX&quot; size :%&quot;LD&quot;\n&quot;,startAt,bufferLen);
-        bufferIndex=0;
         return true;
 }
 /**
@@ -776,18 +508,16 @@
 uint8_t tsPacketLinear::readi8(void)
 {
     consumed++;
-    if(bufferIndex&lt;bufferLen)
+    if(pesPacket-&gt;offset&lt;pesPacket-&gt;payloadSize)
     {
-        return buffer[bufferIndex++];
+        return pesPacket-&gt;payload[pesPacket-&gt;offset++];
     }
     if(false==refill()) 
     {
         eof=1;
         return 0;
     }
-    ADM_assert(bufferLen);
-    bufferIndex=1;
-    return buffer[0];
+    return pesPacket-&gt;payload[pesPacket-&gt;offset++];
     
 }
 /**
@@ -795,10 +525,12 @@
 */
 uint16_t tsPacketLinear::readi16(void)
 {
-    if(bufferIndex+1&lt;bufferLen)
+    if(pesPacket-&gt;offset+1&lt;pesPacket-&gt;payloadSize)
     {
-        uint16_t v=(buffer[bufferIndex]&lt;&lt;8)+buffer[bufferIndex+1];;
-        bufferIndex+=2;
+        uint8_t *r=pesPacket-&gt;payload+pesPacket-&gt;offset;
+        uint16_t v=(r[0]&lt;&lt;8)+r[1];;
+        
+        pesPacket-&gt;offset+=2;
         consumed+=2;
         return v;
     }
@@ -809,11 +541,11 @@
 */
 uint32_t tsPacketLinear::readi32(void)
 {
-    if(bufferIndex+3&lt;bufferLen)
+    if(pesPacket-&gt;offset+3&lt;pesPacket-&gt;payloadSize)
     {
-        uint8_t *p=buffer+bufferIndex;
-        uint32_t v=(p[0]&lt;&lt;24)+(p[1]&lt;&lt;16)+(p[2]&lt;&lt;8)+p[3];
-        bufferIndex+=4;
+         uint8_t *p=pesPacket-&gt;payload+pesPacket-&gt;offset;
+         uint32_t v=(p[0]&lt;&lt;24)+(p[1]&lt;&lt;16)+(p[2]&lt;&lt;8)+p[3];
+         pesPacket-&gt;offset+=4;
         consumed+=4;
         return v;
     }
@@ -825,14 +557,14 @@
 bool tsPacketLinear::forward(uint32_t v)
 {
 next:
- uint32_t delta=bufferLen-bufferIndex;
+ uint32_t delta=pesPacket-&gt;payloadSize-pesPacket-&gt;offset;
     if(v&gt;100*1000)
     {
         ADM_assert(0);
     }
     if(v&lt;=delta)
     {
-        bufferIndex+=v;
+        pesPacket-&gt;offset+=v;
         consumed+=v;
         return true;
     }
@@ -851,19 +583,19 @@
     // Enough already ?
     while(len)
     {
-        uint32_t avail=bufferLen-bufferIndex;
+        uint32_t avail=pesPacket-&gt;payloadSize-pesPacket-&gt;offset;
         uint32_t chunk=avail;
         if(chunk&gt;len) chunk=len;
 #if 0
         printf(&quot;len:%ld avail:%ld chunk %ld index:%d size:%d\n&quot;,
                 len,avail,chunk,bufferIndex,bufferLen);
 #endif
-        memcpy(out,buffer+bufferIndex,chunk);
-        bufferIndex+=chunk;
+        memcpy(out,pesPacket-&gt;payload+pesPacket-&gt;offset,chunk);
+        pesPacket-&gt;offset+=chunk;
         len-=chunk;
         out+=chunk;
         consumed+=chunk;
-        if(bufferIndex==bufferLen)
+        if(pesPacket-&gt;payloadSize==pesPacket-&gt;offset)
         {
             //printf(&quot;Refill\n&quot;);
             if(false==refill()) return false;
@@ -879,19 +611,20 @@
 */
 bool    tsPacketLinear::getInfo(dmxPacketInfo *info)
 {
-    if(bufferIndex&lt;4)
+#warning FIXME
+    if(pesPacket-&gt;offset&lt;4)
     {
         info-&gt;startAt=this-&gt;oldStartAt;
-        info-&gt;offset=oldBufferLen+bufferIndex;
+        info-&gt;offset=oldBufferLen;
         info-&gt;pts=oldBufferPts;
         info-&gt;dts=oldBufferDts;
 
     }else
     {
-        info-&gt;startAt=this-&gt;startAt;
-        info-&gt;offset=bufferIndex;
-        info-&gt;pts=bufferPts;
-        info-&gt;dts=bufferDts;
+        info-&gt;startAt=pesPacket-&gt;startAt;
+        info-&gt;offset=pesPacket-&gt;offset;
+        info-&gt;pts=pesPacket-&gt;pts;
+        info-&gt;dts=pesPacket-&gt;dts;
     }
     return true;
 
@@ -912,9 +645,8 @@
         printf(&quot;[tsPacketLinear] Seek to %&quot;LLX&quot;:%&quot;LX&quot; failed\n&quot;,packetStart,offset);
         return false;
     }
-    ADM_assert(offset&lt;bufferLen);
-    bufferIndex=offset;
-    
+    ADM_assert(offset&lt;pesPacket-&gt;payloadSize);
+    pesPacket-&gt;offset=offset;
     return true;
 }
 /**
@@ -933,78 +665,10 @@
 */
 bool    tsPacketLinear::changePid(uint32_t pid) 
 {
-    myPid=(pid&amp;0xff);
-    bufferLen=bufferIndex=0;
+    pesPacket-&gt;pid=(pid&amp;0xff);
+    pesPacket-&gt;offset=pesPacket-&gt;payloadSize;
     return true;
 }
 /* ********************************************************* */
-/**
-    \fn tsPacketLinearTracker
-*/
- tsPacketLinearTracker::tsPacketLinearTracker(uint8_t pid)  : tsPacketLinear(pid)
-{
-   resetStats();
-}
-/**
-    \fn ~tsPacketLinearTracker
-*/
-tsPacketLinearTracker::~tsPacketLinearTracker()
-{
 
-    
-}
-/**
-        \fn getStat
-*/
-packetStats    *tsPacketLinearTracker::getStat(int index)
-{   
-    if(index&lt;0 || index&gt;=256) ADM_assert(0);
-    return stats+index;
-}
-/**
-    \fn getPacketgetPacketOfType
-    \brief Keep track of all the packets we have seen so far.
-    Usefull to detect the streams present and to look up the PTS/DTS of audio streams for the audio part of the index
-*/
-bool           tsPacketLinearTracker::getPacketOfType(uint8_t pid,uint32_t maxSize, uint32_t *packetSize,uint64_t *pts,uint64_t *dts,uint8_t *buffer,uint64_t *startAt)
-{
- bool xit=false;
-    uint8_t tmppid;
-    while(1)
-    {
-        if(true!=getPacket(maxSize,&amp;tmppid,packetSize,pts,dts,buffer,startAt))
-                return false;
-        else
-        {
-                // Update 
-                ADM_assert(tmppid&lt;0x100);
-                packetStats *p=stats+tmppid;
-                uint64_t ts=*pts;
-                if(ts==ADM_NO_PTS) ts=*dts;
-                if(ts!=ADM_NO_PTS)
-                {
-                    p-&gt;startCount=p-&gt;count;
-                    p-&gt;startAt=*startAt;
-                    p-&gt;startSize=p-&gt;size;
-                    p-&gt;startDts=ts;
-                }
-                p-&gt;count++;
-                p-&gt;size+=*packetSize;
-                if(tmppid==pid) return true;
-        }
-    }
-    return false;
-}
-/**
-    \fn resetStats
-*/
-bool           tsPacketLinearTracker::resetStats(void)
-{
-    memset(stats,0,sizeof(stats));
-    for(int i=0;i&lt;256;i++)
-    {
-        packetStats *p=stats+i;
-        p-&gt;startDts=ADM_NO_PTS;
-    }
-}
 //EOF

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/dmxTSPacket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/dmxTSPacket.h	2009-04-14 17:43:17 UTC (rev 4736)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS/dmxTSPacket.h	2009-04-15 17:54:24 UTC (rev 4737)
@@ -26,6 +26,7 @@
     bool        payloadStart;
     uint32_t    continuityCounter;
     uint8_t     payload[TS_PACKET_LEN];
+    uint64_t    startAt;
 };
 
 
@@ -35,6 +36,7 @@
 class TS_PSIpacketInfo
 {
 public:
+    
     uint32_t    pid;
     uint32_t    payloadSize;
     uint8_t     payload[TS_PSI_MAX_LEN];
@@ -57,6 +59,8 @@
     uint8_t     *payload;
     uint64_t    pts;
     uint64_t    dts;
+    uint64_t    startAt;
+    bool        fresh; // True if we just filled it with a new packet
                 TS_PESpacket(uint32_t pid)
                 {
                     payload=(uint8_t *)ADM_alloc(2048);
@@ -90,7 +94,6 @@
 protected:
 
     uint32_t            extraCrap;
-    uint8_t             getPacketInfo(uint8_t stream,uint8_t *substream,uint32_t *olen,uint64_t *opts,uint64_t *odts);
 public:
                         tsPacket(void);
     virtual            ~tsPacket();
@@ -118,13 +121,7 @@
 class tsPacketLinear : public tsPacket
 {
 protected:
-        uint8_t  myPid;
-        uint64_t startAt;
-        uint32_t bufferLen;
-        uint64_t bufferPts;
-        uint64_t bufferDts;
-        uint32_t bufferIndex;
-        uint8_t  buffer[ADM_PACKET_LINEAR];
+        TS_PESpacket *pesPacket;
         bool     eof;
         bool     refill(void);
         uint64_t oldStartAt;
@@ -134,7 +131,7 @@
         uint32_t consumed;
 
 public:
-                tsPacketLinear(uint8_t pid);
+                tsPacketLinear(uint32_t pid);
                 ~tsPacketLinear();
         uint32_t getConsumed(void);
         uint8_t  readi8();
@@ -148,6 +145,7 @@
         bool    seek(uint64_t packetStart, uint32_t offset);
         bool    changePid(uint32_t pid) ;
 };
+
 /**
     \class tsPacketLinearTracker
 */
@@ -162,18 +160,5 @@
     uint64_t startDts;
 }packetStats;
 
-class tsPacketLinearTracker : public tsPacketLinear
-{
-protected:
-      packetStats stats[256];
 
-public:
-                        tsPacketLinearTracker(uint8_t pid);
-                        ~tsPacketLinearTracker();
-         packetStats    *getStat(int intdex);
-         bool           resetStats(void);
-virtual  bool           getPacketOfType(uint8_t pid,uint32_t maxSize, uint32_t *packetSize,uint64_t *pts,uint64_t *dts,uint8_t *buffer,uint64_t *startAt);
-};
-
-
 #endif


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001964.html">[Avidemux-svn-commit] r4736 -	branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers/MpegTS
</A></li>
	<LI>Next message: <A HREF="001966.html">[Avidemux-svn-commit] r4738 - in	branches/avidemux_2.6_branch_mean/plugins/ADM_demuxers:	MpegPS MpegTS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1965">[ date ]</a>
              <a href="thread.html#1965">[ thread ]</a>
              <a href="subject.html#1965">[ subject ]</a>
              <a href="author.html#1965">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
