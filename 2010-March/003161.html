<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r5956 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_videoCodec/src	avidemux/gtk/ADM_userInterfaces/ADM_dialog	avidemux/qt4/ADM_userInterfaces/ADM_dialog	avidemux/qt4/ADM_userInterfaces/ADM_gui	avidemux_core/ADM_core/include	avidemux_core/ADM_coreUI/include avidemux_core/ADM_coreUI/src	avidemux_plugins/ADM_demuxers/Matroska
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2010-March/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r5956%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common/ADM_videoCodec/src%0A%09avidemux/gtk/ADM_userInterfaces/ADM_dialog%0A%09avidemux/qt4/ADM_userInterfaces/ADM_dialog%0A%09avidemux/qt4/ADM_userInterfaces/ADM_gui%0A%09avidemux_core/ADM_core/include%0A%09avidemux_core/ADM_coreUI/include%20avidemux_core/ADM_coreUI/src%0A%09avidemux_plugins/ADM_demuxers/Matroska&In-Reply-To=%3C201003010622.o216M4la000024%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="003162.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r5956 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_videoCodec/src	avidemux/gtk/ADM_userInterfaces/ADM_dialog	avidemux/qt4/ADM_userInterfaces/ADM_dialog	avidemux/qt4/ADM_userInterfaces/ADM_gui	avidemux_core/ADM_core/include	avidemux_core/ADM_coreUI/include avidemux_core/ADM_coreUI/src	avidemux_plugins/ADM_demuxers/Matroska</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r5956%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common/ADM_videoCodec/src%0A%09avidemux/gtk/ADM_userInterfaces/ADM_dialog%0A%09avidemux/qt4/ADM_userInterfaces/ADM_dialog%0A%09avidemux/qt4/ADM_userInterfaces/ADM_gui%0A%09avidemux_core/ADM_core/include%0A%09avidemux_core/ADM_coreUI/include%20avidemux_core/ADM_coreUI/src%0A%09avidemux_plugins/ADM_demuxers/Matroska&In-Reply-To=%3C201003010622.o216M4la000024%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r5956 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_videoCodec/src	avidemux/gtk/ADM_userInterfaces/ADM_dialog	avidemux/qt4/ADM_userInterfaces/ADM_dialog	avidemux/qt4/ADM_userInterfaces/ADM_gui	avidemux_core/ADM_core/include	avidemux_core/ADM_coreUI/include avidemux_core/ADM_coreUI/src	avidemux_plugins/ADM_demuxers/Matroska">mean at mail.berlios.de
       </A><BR>
    <I>Mon Mar  1 07:22:04 CET 2010</I>
    <P><UL>
        
        <LI>Next message: <A HREF="003162.html">[Avidemux-svn-commit] r5957 - in branches/avidemux_2.6_branch_mean:	autononreg/dialogFactory avidemux/common/ADM_script2/include	avidemux/common/ADM_script2/src	avidemux/qt4/ADM_userInterfaces/ADM_dialog	avidemux_core/ADM_coreUI/include avidemux_core/ADM_coreUI/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3161">[ date ]</a>
              <a href="thread.html#3161">[ thread ]</a>
              <a href="subject.html#3161">[ subject ]</a>
              <a href="author.html#3161">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2010-03-01 07:22:02 +0100 (Mon, 01 Mar 2010)
New Revision: 5956

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_ffmpeg_vdpau.cpp
   branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_encoding.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/Q_encoding.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/Q_encoding.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/alert_qt4.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_clock.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/DIA_coreUI_internal.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/DIA_encoding.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/src/DIA_coreToolkit.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/src/DIA_encoding.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv.cpp
Log:
[UI] Base groundwork for encoding dialog + qt4 version, some dos2unix to files while we are at it

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_ffmpeg_vdpau.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_ffmpeg_vdpau.cpp	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_ffmpeg_vdpau.cpp	2010-03-01 06:22:02 UTC (rev 5956)
@@ -244,6 +244,7 @@
             ADM_assert(VDP_STATUS_OK==funcs.destroySurface((VDPAU-&gt;renders[i]-&gt;surface)));
             delete VDPAU-&gt;renders[i];
         }
+        printf(&quot;[VDPAU] Destroying decoder\n&quot;);
          ADM_assert(VDP_STATUS_OK==funcs.decoderDestroy(VDPAU-&gt;vdpDecoder));
          delete VDPAU;
          vdpau=NULL;

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_encoding.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_encoding.cpp	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/ADM_userInterfaces/ADM_dialog/DIA_encoding.cpp	2010-03-01 06:22:02 UTC (rev 5956)
@@ -6,7 +6,7 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-
+#if 0
 #include &lt;math.h&gt;
 
 #include &quot;ADM_toolkitGtk.h&quot;
@@ -1001,3 +1001,4 @@
   gtk_widget_grab_default (closebutton1);
   return dialog1;
 }
+#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/CMakeLists.txt	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/CMakeLists.txt	2010-03-01 06:22:02 UTC (rev 5956)
@@ -1,42 +1,42 @@
-SET(ADM_LIB ADM_dialogQt4)
-
+SET(ADM_LIB ADM_dialogQt4)
+
 SET(    
-        uiFiles
-        about.ui  
-        calculator.ui  
-#encoding.ui  
-        license.ui
+        uiFiles
+        about.ui  
+        calculator.ui  
+        encoding.ui  
+        license.ui
         jobs.ui  
         props.ui  vobsub.ui  
-        working.ui)
-
-SET(headers
-	Q_about.h  Q_calculator.h  
-#Q_encoding.h
-	Q_license.h  Q_jobs.h  Q_props.h  Q_vobsub.h  Q_working.h  T_index_pg.h)
-
-QT4_WRAP_UI(${ADM_LIB}_headers ${uiFiles})
-QT4_WRAP_CPP(${ADM_LIB}_source ${headers})
-QT4_ADD_RESOURCES(${ADM_LIB}_resource  about.qrc)
-
-SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS}
+        working.ui)
+
+SET(headers
+	Q_about.h  Q_calculator.h  
+        Q_encoding.h
+	Q_license.h  Q_jobs.h  Q_props.h  Q_vobsub.h  Q_working.h  T_index_pg.h)
+
+QT4_WRAP_UI(${ADM_LIB}_headers ${uiFiles})
+QT4_WRAP_CPP(${ADM_LIB}_source ${headers})
+QT4_ADD_RESOURCES(${ADM_LIB}_resource  about.qrc)
+
+SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS}
 	${${ADM_LIB}_headers}  ${${ADM_LIB}_source}  ${${ADM_LIB}_resource}  
-        Q_about.cpp  
-        Q_license.cpp
-        Q_jobs.cpp  Q_props.cpp   
-        Q_working.cpp   
-        T_index_pg.cpp
+        Q_about.cpp  
+        Q_license.cpp
+        Q_jobs.cpp  Q_props.cpp   
+        Q_working.cpp   
+        T_index_pg.cpp
         alert_qt4.cpp  
         DIA_busy.cpp  
-        DIA_none.cpp  
+        DIA_none.cpp  
 #DIA_xvid4.cpp  OCR_none.cpp
 #Q_vobsub.cpp  
 #Q_calculator.cpp  
-#Q_encoding.cpp  
-
-)
-
-ADD_DEFINITIONS(-DADM_SUBVERSION=${ADM_SUBVERSION})
-INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})
-INCLUDE_DIRECTORIES(&quot;${CMAKE_SOURCE_DIR}/avidemux/ADM_UIs/ADM_QT4/include&quot;)
-ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})
+        Q_encoding.cpp  
+
+)
+
+ADD_DEFINITIONS(-DADM_SUBVERSION=${ADM_SUBVERSION})
+INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})
+INCLUDE_DIRECTORIES(&quot;${CMAKE_SOURCE_DIR}/avidemux/ADM_UIs/ADM_QT4/include&quot;)
+ADD_LIBRARY(${ADM_LIB} STATIC ${${ADM_LIB}_SRCS})

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/Q_encoding.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/Q_encoding.cpp	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/Q_encoding.cpp	2010-03-01 06:22:02 UTC (rev 5956)
@@ -1,463 +1,302 @@
-/***************************************************************************
-    copyright            : (C) 2001 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &lt;math.h&gt;
-
-#include &quot;Q_encoding.h&quot;
-#include &quot;prefs.h&quot;
-#include &quot;DIA_working.h&quot;
-#include &quot;DIA_encoding.h&quot;
-#include &quot;DIA_coreToolkit.h&quot;
-#include &quot;ADM_libraries/ADM_utilities/avidemutils.h&quot;
-#include &quot;ADM_video/ADM_vidMisc.h&quot;
-
-extern void UI_purge(void);
-static int stopReq=0;
-
-encodingWindow::encodingWindow() : QDialog()
- {
-	ui.setupUi(this);
-
-#ifndef __WIN32
-	//check for root privileges
-	if (getuid() == 0)
-	{
-		// set priority to normal, regardless of preferences
-		ui.comboBoxPriority-&gt;setCurrentIndex(2);
-	}
-#endif
-
-	connect(ui.checkBoxShutdown, SIGNAL(stateChanged(int)), this, SLOT(shutdownChanged(int)));
-	connect(ui.pushButton, SIGNAL(pressed()), this, SLOT(buttonPressed()));
-	connect(ui.comboBoxPriority, SIGNAL(currentIndexChanged(int)), this, SLOT(priorityChanged(int)));
-
-	// set priority
-	uint32_t priority;
-
-	prefs-&gt;get(PRIORITY_ENCODING,&amp;priority);	
-
-#ifndef __WIN32
-	// check for root privileges
-	if (getuid() == 0)
-	{
-		ui.comboBoxPriority-&gt;setCurrentIndex(priority);
-	}
-#else
-	ui.comboBoxPriority-&gt;setCurrentIndex(priority);
-#endif
- }
-
-void encodingWindow::buttonPressed(void)
-{
-	printf(&quot;StopReq\n&quot;);
-	stopReq=1;
-}
-
-void encodingWindow::priorityChanged(int priorityLevel)
-{
-#ifndef __WIN32
-	if (getuid() != 0)
-	{
-		ui.comboBoxPriority-&gt;disconnect(SIGNAL(currentIndexChanged(int)));
-		ui.comboBoxPriority-&gt;setCurrentIndex(2);
-		connect(ui.checkBoxShutdown, SIGNAL(currentIndexChanged(int)), this, SLOT(priorityChanged(int)));
-
-		GUI_Error_HIG(QT_TR_NOOP(&quot;Privileges Required&quot;), QT_TR_NOOP( &quot;Root privileges are required to perform this operation.&quot;));
-
-		return;
-	}
-#endif
-
-	setpriority(PRIO_PROCESS, 0, ADM_getNiceValue(priorityLevel));
-}
-
-void encodingWindow::shutdownChanged(int state)
-{
-#ifndef __WIN32
-	if (getuid() != 0)
-	{
-		ui.checkBoxShutdown-&gt;disconnect(SIGNAL(stateChanged(int)));
-		ui.checkBoxShutdown-&gt;setCheckState(Qt::Unchecked);
-		connect(ui.checkBoxShutdown, SIGNAL(stateChanged(int)), this, SLOT(shutdownChanged(int)));
-
-		GUI_Error_HIG(QT_TR_NOOP(&quot;Privileges Required&quot;), QT_TR_NOOP( &quot;Root privileges are required to perform this operation.&quot;));
-	}
-#endif
-}
-
-//*******************************************
-#define WIDGET(x) (window-&gt;ui.x)
-#define WRITEM(x,y) window-&gt;ui.x-&gt;setText(y)
-#define WRITE(x) WRITEM(x,string)
-/*************************************/
-static char string[80];
-static encodingWindow *window=NULL;
-DIA_encoding::DIA_encoding( uint32_t fps1000 )
-{
-uint32_t useTray=0;
-
-
-        ADM_assert(window==NULL);
-        stopReq=0;
-        _lastnb=0;
-        _totalSize=0;
-        _audioSize=0;
-        _videoSize=0;
-        _current=0;
-        window=new encodingWindow();
-        setFps(fps1000);
-		_originalPriority=getpriority(PRIO_PROCESS, 0);
-        _lastTime=0;
-        _lastFrame=0;
-        _fps_average=0;
-        _total=1000;
-
-         window-&gt;setModal(TRUE);
-         window-&gt;show();
-
-}
-/**
-    \fn setFps(uint32_t fps)
-    \brief Memorize fps, it will be used later for bitrate computation
-*/
-
-void DIA_encoding::setFps(uint32_t fps)
-{
-        _roundup=(uint32_t )floor( (fps+999)/1000);
-        _fps1000=fps;
-        ADM_assert(_roundup&lt;MAX_BR_SLOT);
-        memset(_bitrate,0,sizeof(_bitrate));
-        _bitrate_sum=0;
-        _average_bitrate=0;
-        
-}
-
-void DIA_stop( void)
-{
-        printf(&quot;Stop request\n&quot;);
-        stopReq=1;
-}
-DIA_encoding::~DIA_encoding( )
-{
-	bool shutdownRequired = (window-&gt;ui.checkBoxShutdown-&gt;checkState() == Qt::Checked);
-
-	setpriority(PRIO_PROCESS, 0, _originalPriority);
-
-	if(window) delete window;
-	window=NULL;
-
-	if (shutdownRequired &amp;&amp; !stopReq)
-	{
-		DIA_working *work=new DIA_working(QT_TR_NOOP(&quot;Shutting down&quot;));
-		bool performShutdown=true;
-
-		for(int i = 0; i &lt;= 30; i++)
-		{
-			if (work-&gt;isAlive())
-			{
-				GUI_Sleep(1000);
-				work-&gt;update(i, 30);
-			}
-			else
-			{
-				performShutdown=false;
-				break;
-			}
-		}
-
-		if (performShutdown &amp;&amp; shutdown())
-		{
-			GUI_Sleep(5000);
-		}
-
-		delete work;
-	}
-}
-/**
-    \fn setPhasis(const char *n)
-    \brief Display parameters as phasis
-*/
-
-void DIA_encoding::setPhasis(const char *n)
-{
-          ADM_assert(window);
-          WRITEM(labelPhasis,n);
-
-}
-/**
-    \fn setAudioCodec(const char *n)
-    \brief Display parameters as audio codec
-*/
-
-void DIA_encoding::setAudioCodec(const char *n)
-{
-          ADM_assert(window);
-          WRITEM(labelAudCodec,n);
-}
-/**
-    \fn setCodec(const char *n)
-    \brief Display parameters as video codec
-*/
-
-void DIA_encoding::setCodec(const char *n)
-{
-          ADM_assert(window);
-          WRITEM(labelVidCodec,n);
-}
-/**
-    \fn setBitrate(uint32_t br,uint32_t globalbr)
-    \brief Display parameters as instantaneous bitrate and average bitrate
-*/
-
-void DIA_encoding::setBitrate(uint32_t br,uint32_t globalbr)
-{
-          ADM_assert(window);
-          snprintf(string,79,&quot;%lu kB/s&quot;,br,globalbr);
-          WRITE(labelVidBitrate);
-
-}
-/**
-    \fn reset(void)
-    \brief Reset everything, used for 2pass
-*/
-
-void DIA_encoding::reset(void)
-{
-          ADM_assert(window);
-          _totalSize=0;
-          _videoSize=0;
-          _current=0;
-}
-/**
-    \fn setContainer(const char *container)
-    \brief Display parameter as container field
-*/
-
-void DIA_encoding::setContainer(const char *container)
-{
-        ADM_assert(window);
-        WRITEM(labelContainer,container);
-}
-#define  ETA_SAMPLE_PERIOD 60000 //Use last n millis to calculate ETA
-#define  GUI_UPDATE_RATE 500  
-/**
-    \fn setFrame(uint32_t nb,uint32_t size, uint32_t quant,uint32_t total)
-    \brief Recompute and update everything concering video
-*/
-
-void DIA_encoding::setFrame(uint32_t nb,uint32_t size, uint32_t quant,uint32_t total)
-{
-          _total=total;
-          _videoSize+=size;
-          if(nb &lt; _lastnb || _lastnb == 0) // restart ?
-           {
-                _lastnb = nb;
-                clock.reset();
-                _lastTime=clock.getElapsedMS();
-                _lastFrame=0;
-                _fps_average=0;
-                _videoSize=size;
-    
-                _nextUpdate = _lastTime + GUI_UPDATE_RATE;
-                _nextSampleStartTime=_lastTime + ETA_SAMPLE_PERIOD;
-                _nextSampleStartFrame=0;
-          } 
-          _lastnb = nb;
-          _current=nb%_roundup;
-          _bitrate[_current].size=size;
-          _bitrate[_current].quant=quant;
-}
-/**
-    \fn updateUI(void)
-    \brief Recompute and update all fields, especially ETA
-*/
-
-void DIA_encoding::updateUI(void)
-{
-uint32_t tim;
-
-	   ADM_assert(window);
-     	   //
-           //	nb/total=timestart/totaltime -&gt; total time =timestart*total/nb
-           //
-           //
-           
-           UI_purge();
-          if(!_lastnb) return;
-          
-          tim=clock.getElapsedMS();
-          if(_lastTime &gt; tim) return;
-          if( tim &lt; _nextUpdate) return ; 
-          _nextUpdate = tim+GUI_UPDATE_RATE;
-  
-          snprintf(string,79,&quot;%lu&quot;,_lastnb);
-          WIDGET(labelFrame)-&gt;setText(string);
-
-          snprintf(string,79,&quot;%lu&quot;,_total);
-          WIDGET(labelTotalFrame)-&gt;setText(string);
-
-		  snprintf(string,79,&quot;%lu&quot;,_total);
-          WIDGET(labelTotalFrame)-&gt;setText(string);
-
-          // Average bitrate  on the last second
-          uint32_t sum=0,aquant=0,gsum;
-          for(int i=0;i&lt;_roundup;i++)
-          {
-            sum+=_bitrate[i].size;
-            aquant+=_bitrate[i].quant;
-          }
-          
-          aquant/=_roundup;
-
-          sum=(sum*8)/1000;
-
-          // Now compute global average bitrate
-          float whole=_videoSize,second;
-            second=_lastnb;
-            second/=_fps1000;
-            second*=1000;
-           
-          whole/=second;
-          whole/=1000;
-          whole*=8;
-      
-          gsum=(uint32_t)whole;
-
-          setBitrate(sum,gsum);
-          setQuantIn(aquant);
-
-          // compute fps
-          uint32_t deltaFrame, deltaTime;
-          deltaTime=tim-_lastTime;
-          deltaFrame=_lastnb-_lastFrame;
-
-          _fps_average    =(float)( deltaFrame*1000.0F / deltaTime ); 
-
-          snprintf(string,79,&quot;%.2f&quot;,_fps_average);
-          WIDGET(labelFps)-&gt;setText(string);
-  
-          uint32_t   hh,mm,ss;
-  
-            double framesLeft=(_total-_lastnb);
-
-			ms2time(tim,&amp;hh,&amp;mm,&amp;ss);
-			snprintf(string,79,&quot;%02d:%02d:%02d&quot;,hh,mm,ss);
-			WIDGET(labelElapsed)-&gt;setText(string);
-
-//            WIDGET(labelETA)-&gt;setText(ms2timedisplay((uint32_t) floor(0.5 + deltaTime * framesLeft / deltaFrame)));
-  
-           // Check if we should move on to the next sample period
-          if (tim &gt;= _nextSampleStartTime + ETA_SAMPLE_PERIOD ) {
-            _lastTime=_nextSampleStartTime;
-            _lastFrame=_nextSampleStartFrame;
-            _nextSampleStartTime=tim;
-            _nextSampleStartFrame=0;
-          } else if (tim &gt;= _nextSampleStartTime &amp;&amp; _nextSampleStartFrame == 0 ) {
-            // Store current point for use later as the next sample period.
-            //
-            _nextSampleStartTime=tim;
-            _nextSampleStartFrame=_lastnb;
-          }
-          // update progress bar
-            float f=_lastnb*100;
-            f=f/_total;
-            WIDGET(progressBar)-&gt;setValue((int)f);
-          
-        _totalSize=_audioSize+_videoSize;
-        setSize(_totalSize&gt;&gt;20);
-        setAudioSizeIn((_audioSize&gt;&gt;20));
-        setVideoSizeIn((_videoSize&gt;&gt;20));
-        UI_purge();
-
-}
-/**
-    \fn setQuantIn(int size)
-    \brief display parameter as quantizer
-*/
-
-void DIA_encoding::setQuantIn(int size)
-{
-          ADM_assert(window);
-          sprintf(string,&quot;%lu&quot;,size);
-          WRITE(labelQz);
-
-}
-/**
-    \fn setSize(int size)
-    \brief display parameter as total size
-*/
-
-void DIA_encoding::setSize(int size)
-{
-          ADM_assert(window);
-          sprintf(string,&quot;%lu MB&quot;,size);
-          WRITE(labelTotalSize);
-
-}
-/**
-    \fn setAudioSizeIn(int size)
-    \brief display parameter as audio size
-*/
-
-void DIA_encoding::setAudioSizeIn(int size)
-{
-          ADM_assert(window);
-          sprintf(string,&quot;%lu MB&quot;,size);
-          WRITE(labelAudioSize);
-
-}
-/**
-    \fn setVideoSizeIn(int size)
-    \brief display parameter as video size
-*/
-
-void DIA_encoding::setVideoSizeIn(int size)
-{
-          ADM_assert(window);
-          sprintf(string,&quot;%lu MB&quot;,size);
-          WRITE(labelVideoSize);
-
-}
-/**
-    \fn setAudioSize( uint32_t size)
-    \brief set the total audio size as per parameter
-*/
-
-void DIA_encoding::setAudioSize(uint32_t size)
-{
-      _audioSize=size;
-}
-/**
-    \fn isAlive( void )
-    \brief return 0 if the window was killed or cancel button press, 1 otherwisearchForward
-*/
-uint8_t DIA_encoding::isAlive( void )
-{
-        updateUI();
-
-        if(stopReq)
-        {
-          if(GUI_Alternate((char*)QT_TR_NOOP(&quot;The encoding is paused. Do you want to resume or abort?&quot;),
-                              (char*)QT_TR_NOOP(&quot;Resume&quot;),(char*)QT_TR_NOOP(&quot;Abort&quot;)))
-                 {
-                         stopReq=0;
-                 }
-        }
-
-        if(!stopReq) return 1;		
-
-        return 0;
-}
-
-//********************************************
-//EOF
+/***************************************************************************
+    copyright            : (C) 2001 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &lt;math.h&gt;
+#include &quot;ADM_inttype.h&quot;
+#include &quot;Q_encoding.h&quot;
+
+#include &quot;prefs.h&quot;
+#include &quot;DIA_working.h&quot;
+#include &quot;DIA_encoding.h&quot;
+#include &quot;DIA_coreToolkit.h&quot;
+#include &quot;avidemutils.h&quot;
+#include &quot;ADM_vidMisc.h&quot;
+
+extern void UI_purge(void);
+static int stopReq=0;
+
+encodingWindow::encodingWindow() : QDialog()
+ {
+	ui.setupUi(this);
+
+#ifndef __WIN32
+	//check for root privileges
+	if (getuid() == 0)
+	{
+		// set priority to normal, regardless of preferences
+		ui.comboBoxPriority-&gt;setCurrentIndex(2);
+	}
+#endif
+
+	connect(ui.checkBoxShutdown, SIGNAL(stateChanged(int)), this, SLOT(shutdownChanged(int)));
+	connect(ui.pushButton, SIGNAL(pressed()), this, SLOT(buttonPressed()));
+	connect(ui.comboBoxPriority, SIGNAL(currentIndexChanged(int)), this, SLOT(priorityChanged(int)));
+
+	// set priority
+	uint32_t priority;
+
+	prefs-&gt;get(PRIORITY_ENCODING,&amp;priority);	
+
+#ifndef __WIN32
+	// check for root privileges
+	if (getuid() == 0)
+	{
+		ui.comboBoxPriority-&gt;setCurrentIndex(priority);
+	}
+#else
+	ui.comboBoxPriority-&gt;setCurrentIndex(priority);
+#endif
+ }
+
+void encodingWindow::buttonPressed(void)
+{
+	printf(&quot;StopReq\n&quot;);
+	stopReq=1;
+}
+
+void encodingWindow::priorityChanged(int priorityLevel)
+{
+#ifndef __WIN32
+	if (getuid() != 0)
+	{
+		ui.comboBoxPriority-&gt;disconnect(SIGNAL(currentIndexChanged(int)));
+		ui.comboBoxPriority-&gt;setCurrentIndex(2);
+		connect(ui.checkBoxShutdown, SIGNAL(currentIndexChanged(int)), this, SLOT(priorityChanged(int)));
+
+		GUI_Error_HIG(QT_TR_NOOP(&quot;Privileges Required&quot;), QT_TR_NOOP( &quot;Root privileges are required to perform this operation.&quot;));
+
+		return;
+	}
+#endif
+
+	setpriority(PRIO_PROCESS, 0, ADM_getNiceValue(priorityLevel));
+}
+
+void encodingWindow::shutdownChanged(int state)
+{
+#ifndef __WIN32
+	if (getuid() != 0)
+	{
+		ui.checkBoxShutdown-&gt;disconnect(SIGNAL(stateChanged(int)));
+		ui.checkBoxShutdown-&gt;setCheckState(Qt::Unchecked);
+		connect(ui.checkBoxShutdown, SIGNAL(stateChanged(int)), this, SLOT(shutdownChanged(int)));
+
+		GUI_Error_HIG(QT_TR_NOOP(&quot;Privileges Required&quot;), QT_TR_NOOP( &quot;Root privileges are required to perform this operation.&quot;));
+	}
+#endif
+}
+
+//*******************************************
+#define WIDGET(x) (window-&gt;ui.x)
+#define WRITEM(x,y) window-&gt;ui.x-&gt;setText(y)
+#define WRITE(x) WRITEM(x,string)
+/*************************************/
+static char string[80];
+static encodingWindow *window=NULL;
+DIA_encodingQt4::DIA_encodingQt4( uint64_t duration) : DIA_encodingBase(duration)
+{
+        ADM_assert(window==NULL);
+        stopReq=0;
+        window=new encodingWindow();
+        window-&gt;setModal(TRUE);
+        window-&gt;show();
+
+}
+/**
+    \fn setFps(uint32_t fps)
+    \brief Memorize fps, it will be used later for bitrate computation
+*/
+
+void DIA_encodingQt4::setFps(uint32_t fps)
+{
+    
+        
+}
+
+void DIA_stop( void)
+{
+        printf(&quot;Stop request\n&quot;);
+        stopReq=1;
+}
+/**
+    \fn dtpor
+*/
+DIA_encodingQt4::~DIA_encodingQt4( )
+{
+	bool shutdownRequired = (window-&gt;ui.checkBoxShutdown-&gt;checkState() == Qt::Checked);
+
+	if(window) delete window;
+	window=NULL;
+#if 0
+	if (shutdownRequired &amp;&amp; !stopReq)
+	{
+		DIA_working *work=new DIA_working(QT_TR_NOOP(&quot;Shutting down&quot;));
+		bool performShutdown=true;
+
+		for(int i = 0; i &lt;= 30; i++)
+		{
+			if (work-&gt;isAlive())
+			{
+				GUI_Sleep(1000);
+				work-&gt;update(i, 30);
+			}
+			else
+			{
+				performShutdown=false;
+				break;
+			}
+		}
+
+		if (performShutdown &amp;&amp; shutdown())
+		{
+			GUI_Sleep(5000);
+		}
+
+		delete work;
+	}
+#endif
+}
+/**
+    \fn setPhasis(const char *n)
+    \brief Display parameters as phasis
+*/
+
+void DIA_encodingQt4::setPhasis(const char *n)
+{
+          ADM_assert(window);
+          WRITEM(labelPhasis,n);
+
+}
+/**
+    \fn    setPercent
+    \brief display percent of saved file
+*/
+
+void DIA_encodingQt4::setPercent(uint32_t p)
+{
+          ADM_assert(window);
+}
+/**
+    \fn setAudioCodec(const char *n)
+    \brief Display parameters as audio codec
+*/
+
+void DIA_encodingQt4::setAudioCodec(const char *n)
+{
+          ADM_assert(window);
+          WRITEM(labelAudCodec,n);
+}
+/**
+    \fn setCodec(const char *n)
+    \brief Display parameters as video codec
+*/
+
+void DIA_encodingQt4::setVideoCodec(const char *n)
+{
+          ADM_assert(window);
+          WRITEM(labelVidCodec,n);
+}
+/**
+    \fn setBitrate(uint32_t br,uint32_t globalbr)
+    \brief Display parameters as instantaneous bitrate and average bitrate
+*/
+
+void DIA_encodingQt4::setBitrate(uint32_t br,uint32_t globalbr)
+{
+          ADM_assert(window);
+          snprintf(string,79,&quot;%lu kB/s&quot;,br,globalbr);
+          WRITE(labelVidBitrate);
+
+}
+/**
+    \fn setContainer(const char *container)
+    \brief Display parameter as container field
+*/
+
+void DIA_encodingQt4::setContainer(const char *container)
+{
+        ADM_assert(window);
+        WRITEM(labelContainer,container);
+}
+
+/**
+    \fn setQuantIn(int size)
+    \brief display parameter as quantizer
+*/
+
+void DIA_encodingQt4::setQuantIn(int size)
+{
+          ADM_assert(window);
+          sprintf(string,&quot;%lu&quot;,size);
+          WRITE(labelQz);
+
+}
+/**
+    \fn setSize(int size)
+    \brief display parameter as total size
+*/
+
+void DIA_encodingQt4::setTotalSize(uint64_t size)
+{
+          ADM_assert(window);
+          uint64_t mb=size&gt;&gt;20;
+          sprintf(string,&quot;%lu MB&quot;,(int)mb);
+          WRITE(labelTotalSize);
+
+}
+
+/**
+    \fn setAudioSizeIn(int size)
+    \brief display parameter as audio size
+*/
+
+void DIA_encodingQt4::setAudioSize(uint64_t size)
+{
+          ADM_assert(window);
+          uint64_t mb=size&gt;&gt;20;
+          sprintf(string,&quot;%lu MB&quot;,(int)mb);
+          WRITE(labelAudioSize);
+
+}
+/**
+    \fn isAlive( void )
+    \brief return 0 if the window was killed or cancel button press, 1 otherwisearchForward
+*/
+bool DIA_encodingQt4::isAlive( void )
+{
+
+        if(stopReq)
+        {
+          if(GUI_Alternate((char*)QT_TR_NOOP(&quot;The encoding is paused. Do you want to resume or abort?&quot;),
+                              (char*)QT_TR_NOOP(&quot;Resume&quot;),(char*)QT_TR_NOOP(&quot;Abort&quot;)))
+                 {
+                         stopReq=0;
+                 }
+        }
+
+        if(!stopReq) return true;		
+
+        return false;
+}
+/**
+        \fn createEncoding
+*/
+namespace ADM_Qt4CoreUIToolkit
+{
+DIA_encodingBase *createEncoding(uint64_t duration)
+{
+        return new DIA_encodingQt4(duration);
+}
+}
+//********************************************
+//EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/Q_encoding.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/Q_encoding.h	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/Q_encoding.h	2010-03-01 06:22:02 UTC (rev 5956)
@@ -1,19 +1,65 @@
-#ifndef Q_encoding_h
-#define Q_encoding_h
-
-#include &quot;ui_encoding.h&quot;
-
-class encodingWindow : public QDialog
-{
-     Q_OBJECT
-
- public:
-     encodingWindow();
-     Ui_encodingDialog ui;
-
- public slots:
-	void buttonPressed(void);
-	void priorityChanged(int priorityLevel);
-	void shutdownChanged(int state);
-};
-#endif	// Q_encoding_h
+/** *************************************************************************
+             
+    \fn Q_encoding.h
+    
+                      
+    copyright            : (C) 2008 by mean/gruntster/?
+    
+ ***************************************************************************/
+
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef Q_encoding_h
+#define Q_encoding_h
+
+#include &quot;ui_encoding.h&quot;
+#include &quot;ADM_inttype.h&quot;
+#include &quot;DIA_encoding.h&quot;
+/**
+    \class encodingWindow
+*/
+class encodingWindow : public QDialog
+{
+     Q_OBJECT
+
+ public:
+     encodingWindow();
+     Ui_encodingDialog ui;
+
+ public slots:
+	void buttonPressed(void);
+	void priorityChanged(int priorityLevel);
+	void shutdownChanged(int state);
+};
+/**
+    \class DIA_encodingQt4
+*/
+
+class DIA_encodingQt4 : public DIA_encodingBase
+{
+public:
+    DIA_encodingQt4( uint64_t duration);
+    ~DIA_encodingQt4( );
+    
+protected:
+    encodingWindow *window;
+    void setFps(uint32_t fps);
+    void setPhasis(const char *n);
+    void setAudioCodec(const char *n);
+    void setVideoCodec(const char *n);
+    void setBitrate(uint32_t br,uint32_t globalbr);
+    void setContainer(const char *container);
+    void setQuantIn(int size);
+    void setTotalSize(uint64_t size);
+    void setAudioSize(uint64_t size);
+    void setPercent(uint32_t percent);
+    bool isAlive( void );
+};
+#endif	// Q_encoding_h

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/alert_qt4.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/alert_qt4.cpp	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/alert_qt4.cpp	2010-03-01 06:22:02 UTC (rev 5956)
@@ -227,6 +227,7 @@
 }
 //****************************************************************************************************
 extern DIA_workingBase *createWorking(const char *title);
+extern DIA_encodingBase *createEncoding(uint64_t duration);
 }
 
 static CoreToolkitDescriptor Qt4CoreToolkitDescriptor=
@@ -240,8 +241,8 @@
 		&amp;ADM_Qt4CoreUIToolkit::GUI_Verbose,
 		&amp;ADM_Qt4CoreUIToolkit::GUI_Quiet,
 		&amp;ADM_Qt4CoreUIToolkit::GUI_isQuiet,
-        &amp;ADM_Qt4CoreUIToolkit::createWorking,
-        //&amp;ADM_Qt4CoreUIToolkit::createEncodingQt4
+                &amp;ADM_Qt4CoreUIToolkit::createWorking,
+                &amp;ADM_Qt4CoreUIToolkit::createEncoding
 };
 
 void InitCoreToolkit(void )

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-03-01 06:22:02 UTC (rev 5956)
@@ -1,570 +1,570 @@
-/***************************************************************************
-    copyright            : (C) 2001 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-#include &quot;ADM_inttype.h&quot;
-#include &lt;QtCore/QFileInfo&gt;
-#include &lt;QtCore/QUrl&gt;
-#include &lt;QtGui/QKeyEvent&gt;
-#include &lt;QtGui/QGraphicsView&gt;
-
-#include &quot;Q_gui2.h&quot;
-#include &quot;ADM_default.h&quot;
-
-//#include &quot;ADM_codecs/ADM_codec.h&quot;
-#include &quot;gui_action.hxx&quot;
-#include &quot;ADM_editor/ADM_outputfmt.h&quot;
-#include &quot;DIA_fileSel.h&quot;
-#include &quot;ADM_vidMisc.h&quot;
-#include &quot;prefs.h&quot;
-#include &quot;avi_vars.h&quot;
-
+/***************************************************************************
+    copyright            : (C) 2001 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;config.h&quot;
+#include &quot;ADM_inttype.h&quot;
+#include &lt;QtCore/QFileInfo&gt;
+#include &lt;QtCore/QUrl&gt;
+#include &lt;QtGui/QKeyEvent&gt;
+#include &lt;QtGui/QGraphicsView&gt;
+
+#include &quot;Q_gui2.h&quot;
+#include &quot;ADM_default.h&quot;
+
+//#include &quot;ADM_codecs/ADM_codec.h&quot;
+#include &quot;gui_action.hxx&quot;
+#include &quot;ADM_editor/ADM_outputfmt.h&quot;
+#include &quot;DIA_fileSel.h&quot;
+#include &quot;ADM_vidMisc.h&quot;
+#include &quot;prefs.h&quot;
+#include &quot;avi_vars.h&quot;
+
 #include &quot;ADM_render/GUI_renderInternal.h&quot;
 #include &quot;ADM_coreVideoEncoderInternal.h&quot;
 #include &quot;ADM_muxerProto.h&quot;
-#include &quot;T_vumeter.h&quot;
-extern int global_argc;
-extern char **global_argv;
-
-extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h);
-extern int automation(void );
-extern void HandleAction(Action a);
-extern int encoderGetEncoderCount (void);
-extern const char *encoderGetIndexedName (uint32_t i);
+#include &quot;T_vumeter.h&quot;
+extern int global_argc;
+extern char **global_argv;
+
+extern uint8_t UI_getPhysicalScreenSize(void* window, uint32_t *w,uint32_t *h);
+extern int automation(void );
+extern void HandleAction(Action a);
+extern int encoderGetEncoderCount (void);
+extern const char *encoderGetIndexedName (uint32_t i);
 uint32_t audioEncoderGetNumberOfEncoders(void);
 const char  *audioEncoderGetDisplayName(uint32_t i);
-extern void checkCrashFile(void);
-extern void UI_QT4VideoWidget(QFrame *frame);
-extern void loadTranslator(void);
-extern void initTranslator(void);
-extern void destroyTranslator(void);
-extern ADM_RENDER_TYPE UI_getPreferredRender(void);
-extern int A_openAvi(const char *name);
-extern int A_appendAvi(const char *name);
-extern char *actual_workbench_file;
-extern void FileSel_ReadWrite(SELFILE_CB *cb, int rw, const char *name, const char *actual_workbench_file);
+extern void checkCrashFile(void);
+extern void UI_QT4VideoWidget(QFrame *frame);
+extern void loadTranslator(void);
+extern void initTranslator(void);
+extern void destroyTranslator(void);
+extern ADM_RENDER_TYPE UI_getPreferredRender(void);
+extern int A_openAvi(const char *name);
+extern int A_appendAvi(const char *name);
+extern char *actual_workbench_file;
+extern void FileSel_ReadWrite(SELFILE_CB *cb, int rw, const char *name, const char *actual_workbench_file);
 
-
-int SliderIsShifted=0;
-static void setupMenus(void);
-static int shiftKeyHeld=0;
-static ADM_QSlider *slider=NULL;
-static int _upd_in_progres=0;
-static char     *customNames[ADM_MAC_CUSTOM_SCRIPT];
-static QAction  *customActions[ADM_MAC_CUSTOM_SCRIPT];
-static uint32_t ADM_nbCustom=0;
-static int currentFps = 0;
-static int frameCount = 0;
-static int currentFrame = 0;
+
+int SliderIsShifted=0;
+static void setupMenus(void);
+static int shiftKeyHeld=0;
+static ADM_QSlider *slider=NULL;
+static int _upd_in_progres=0;
+static char     *customNames[ADM_MAC_CUSTOM_SCRIPT];
+static QAction  *customActions[ADM_MAC_CUSTOM_SCRIPT];
+static uint32_t ADM_nbCustom=0;
+static int currentFps = 0;
+static int frameCount = 0;
+static int currentFrame = 0;
 bool     ADM_ve6_getEncoderInfo(int filter, const char **name, uint32_t *major,uint32_t *minor,uint32_t *patch);
 uint32_t ADM_ve6_getNbEncoders(void);
 void UI_refreshCustomMenu(void);
 QWidget *QuiMainWindows=NULL;
 QGraphicsView *drawWindow=NULL;
 uint8_t UI_updateRecentMenu( void );
-
-#ifdef HAVE_AUDIO
-extern uint8_t AVDM_setVolume(int volume);
-#endif
-
-#define WIDGET(x)  (((MainWindow *)QuiMainWindows)-&gt;ui.x)
-
-#define CONNECT(object,zzz) connect( (ui.object),SIGNAL(triggered()),this,SLOT(buttonPressed()));
-#define CONNECT_TB(object,zzz) connect( (ui.object),SIGNAL(clicked(bool)),this,SLOT(toolButtonPressed(bool)));
-#define DECLARE_VAR(object,signal_name) {#object,signal_name},
-
-#include &quot;translation_table.h&quot;    
-/*
-    Declare the table converting widget name to our internal signal           
-*/
-typedef struct 
-{
-	const char *name;
-	Action     action; 
+
+#ifdef HAVE_AUDIO
+extern uint8_t AVDM_setVolume(int volume);
+#endif
+
+#define WIDGET(x)  (((MainWindow *)QuiMainWindows)-&gt;ui.x)
+
+#define CONNECT(object,zzz) connect( (ui.object),SIGNAL(triggered()),this,SLOT(buttonPressed()));
+#define CONNECT_TB(object,zzz) connect( (ui.object),SIGNAL(clicked(bool)),this,SLOT(toolButtonPressed(bool)));
+#define DECLARE_VAR(object,signal_name) {#object,signal_name},
+
+#include &quot;translation_table.h&quot;    
+/*
+    Declare the table converting widget name to our internal signal           
+*/
+typedef struct 
+{
+	const char *name;
+	Action     action; 
 }adm_qt4_translation;
-
-const adm_qt4_translation myTranslationTable[]=
-{
-#define PROCESS DECLARE_VAR
-	LIST_OF_OBJECTS
-	LIST_OF_BUTTONS
-#undef PROCESS
-};
-static Action searchTranslationTable(const char *name);
-#define SIZEOF_MY_TRANSLATION sizeof(myTranslationTable)/sizeof(adm_qt4_translation)
-
-int UI_readCurTime(uint16_t &amp;hh, uint16_t &amp;mm, uint16_t &amp;ss, uint16_t &amp;ms);
-void UI_updateFrameCount(uint32_t curFrame);
-void UI_updateTimeCount(uint32_t curFrame,uint32_t fps);
-extern void UI_purge(void);
-/*
-    Declare the class that will be our main window
-
-*/
-
-void MainWindow::comboChanged(int z)
-{
-	const char *source=qPrintable(sender()-&gt;objectName());
-
-	if(!strcmp(source,&quot;comboBoxVideo&quot;))  
-	{
-		bool b=FALSE;
-		if(ui.comboBoxVideo-&gt;currentIndex())
-		{
-			b=TRUE;
-		}
-		ui.pushButtonVideoConf-&gt;setEnabled(b);
-		ui.pushButtonVideoFilter-&gt;setEnabled(b);
-		HandleAction (ACT_VideoCodecChanged) ;
-	}
-	else if(!strcmp(source,&quot;comboBoxAudio&quot;))  
-	{
-		bool b=FALSE;
-		if(ui.comboBoxAudio-&gt;currentIndex())
-		{
-			b=TRUE;
-		}
-		ui.pushButtonAudioConf-&gt;setEnabled(b);
-		ui.pushButtonAudioFilter-&gt;setEnabled(b);
-		HandleAction (ACT_AudioCodecChanged) ;
-	}
-	else
-		printf(&quot;From +: %s\n&quot;,source);
-}
-
-void MainWindow::sliderValueChanged(int u) 
-{
-	if(!_upd_in_progres)
-		HandleAction(ACT_Scale);
-}
-
-void MainWindow::sliderMoved(int value)
-{
-	SliderIsShifted = shiftKeyHeld;
-}
-
-void MainWindow::sliderReleased(void)
-{
-	SliderIsShifted = 0;
-}
-
-void MainWindow::volumeChange( int u )
-{
-#ifdef HAVE_AUDIO
-	if (_upd_in_progres || !ui.toolButtonAudioToggle-&gt;isChecked())
-		return;
-
-	_upd_in_progres++;
-
-	int vol = ui.horizontalSlider_2-&gt;value();
-
-	AVDM_setVolume(vol);
-	_upd_in_progres--;
-#endif
-}
-
-void MainWindow::audioToggled(bool checked)
-{
-#ifdef HAVE_AUDIO
-	if (checked)
-		AVDM_setVolume(ui.horizontalSlider_2-&gt;value());
-	else
-		AVDM_setVolume(0);
-#endif
-}
-
-void MainWindow::previewModeChanged(QAction *action)
-{
-	HandleAction(ACT_PreviewChanged);
-}
-
-void MainWindow::timeChangeFinished(void)
-{
-	this-&gt;setFocus(Qt::OtherFocusReason);
-}
-
-void MainWindow::currentFrameChanged(void)
-{
-	HandleAction(ACT_JumpToFrame);
-
-	this-&gt;setFocus(Qt::OtherFocusReason);
-}
-
-void MainWindow::currentTimeChanged(void)
-{
-	HandleAction(ACT_JumpToTime);
-
-	this-&gt;setFocus(Qt::OtherFocusReason);
-}
-
-
-MainWindow::MainWindow() : QMainWindow()
-{
-	ui.setupUi(this);
-
-	this-&gt;setStatusBar(0);
-	this-&gt;adjustSize();
-
-#if defined(__APPLE__) &amp;&amp; defined(USE_SDL)
-	ui.actionAbout_avidemux-&gt;setMenuRole(QAction::NoRole);
-	ui.actionPreferences-&gt;setMenuRole(QAction::NoRole);
-	ui.actionQuit-&gt;setMenuRole(QAction::NoRole);
-#endif
-
-	// Preview modes
-	QActionGroup *groupPreviewModes = new QActionGroup(this);
-
-	groupPreviewModes-&gt;addAction(ui.actionPreviewInput);
-	groupPreviewModes-&gt;addAction(ui.actionPreviewOutput);
-	groupPreviewModes-&gt;addAction(ui.actionPreviewSide);
-	groupPreviewModes-&gt;addAction(ui.actionPreviewTop);
-	groupPreviewModes-&gt;addAction(ui.actionPreviewSeparate);
-	connect(groupPreviewModes, SIGNAL(triggered(QAction*)), this, SLOT(previewModeChanged(QAction*)));
-
-	// Zoom modes
-	QActionGroup *groupZoomModes = new QActionGroup(this);
-
-	groupZoomModes-&gt;addAction(ui.actionZoom_1_4);
-	groupZoomModes-&gt;addAction(ui.actionZoom_1_2);
-	groupZoomModes-&gt;addAction(ui.actionZoom_1_1);
-	groupZoomModes-&gt;addAction(ui.actionZoom_2_1);
-
-	/*
-	Connect our button to buttonPressed
-	*/
-#define PROCESS CONNECT
-	LIST_OF_OBJECTS
-#undef PROCESS
-#define PROCESS CONNECT_TB
-	LIST_OF_BUTTONS
-#undef PROCESS
-
-	connect(ui.actionPrevious_intra_frame, SIGNAL(triggered()), this, SLOT(previousIntraFrame()));
-	connect(ui.actionNext_intra_frame, SIGNAL(triggered()), this, SLOT(nextIntraFrame()));
-
-	//ACT_VideoCodecChanged
-	connect( ui.comboBoxVideo,SIGNAL(activated(int)),this,SLOT(comboChanged(int)));
-	connect( ui.comboBoxAudio,SIGNAL(activated(int)),this,SLOT(comboChanged(int)));
-
-	// Slider
-	slider=ui.horizontalSlider;
-	slider-&gt;setMinimum(0);
-	slider-&gt;setMaximum(1000000000);
-	connect( slider,SIGNAL(valueChanged(int)),this,SLOT(sliderValueChanged(int)));
-	connect( slider,SIGNAL(sliderMoved(int)),this,SLOT(sliderMoved(int)));
-	connect( slider,SIGNAL(sliderReleased()),this,SLOT(sliderReleased()));
-
-	// Volume slider
-	QSlider *volSlider=ui.horizontalSlider_2;
-	volSlider-&gt;setMinimum(0);
-	volSlider-&gt;setMaximum(100);
-	connect(volSlider,SIGNAL(valueChanged(int)),this,SLOT(volumeChange(int)));
-	connect(ui.toolButtonAudioToggle,SIGNAL(clicked(bool)),this,SLOT(audioToggled(bool)));
-
-	// default state
-	bool b=0;
-	ui.pushButtonVideoConf-&gt;setEnabled(b);
-	ui.pushButtonVideoFilter-&gt;setEnabled(b);
-	ui.pushButtonAudioConf-&gt;setEnabled(b);
-	ui.pushButtonAudioFilter-&gt;setEnabled(b);
-
-	/* Time Shift */
-	connect(ui.checkBox_TimeShift,SIGNAL(stateChanged(int)),this,SLOT(timeChanged(int)));
-	connect(ui.spinBox_TimeValue,SIGNAL(valueChanged(int)),this,SLOT(timeChanged(int)));
-	connect(ui.spinBox_TimeValue, SIGNAL(editingFinished()), this, SLOT(timeChangeFinished()));
-
-
-
-
-	QRegExp timeRegExp(&quot;^[0-9]{2}:[0-5][0-9]:[0-5][0-9]\\.[0-9]{3}$&quot;);
-	QRegExpValidator *timeValidator = new QRegExpValidator(timeRegExp, this);
-	ui.currentTime-&gt;setValidator(timeValidator);
-	ui.currentTime-&gt;setInputMask(&quot;99:99:99.999&quot;);
-
-	connect(ui.currentTime, SIGNAL(editingFinished()), this, SLOT(currentTimeChanged()));
-
-	/* Build the custom menu */
-	buildCustomMenu();
-
-	this-&gt;installEventFilter(this);
-	slider-&gt;installEventFilter(this);
-	
-	ui.currentTime-&gt;installEventFilter(this);
-
-	this-&gt;setFocus(Qt::OtherFocusReason);
-
-	setAcceptDrops(true);
-}
-/**
-\fn     custom
-\brief  Invoked when one of the custom script has been called
-*/
-void MainWindow::custom(void)
-{
-	printf(&quot;[Custom] Invoked\n&quot;);
-	QObject *ptr=sender();
-	if(!ptr) return;
-	for(int i=0;i&lt;ADM_nbCustom;i++)
-	{
-		if(customActions[i]==ptr)
-		{
-			printf(&quot;[Custom] %u/%u scripts\n&quot;,i,ADM_nbCustom);
-			HandleAction( (Action)(ACT_CUSTOM_BASE+i));
-			return; 
-		}
-	}
-	printf(&quot;[Custom] Not found\n&quot;);
-}
-/**
-    Get the custom entry 
-
-*/
-const char * GUI_getCustomScript(uint32_t nb)
-{
-	ADM_assert(nb&lt;ADM_nbCustom);
-	return customNames[nb];
-
-}
-/**
-    \fn timeChanged
-    \brief Called whenever timeshift is on/off'ed or value changes
-*/
-void MainWindow::timeChanged(int)
-{
-	HandleAction (ACT_TimeShift) ;
-}
-/*
-      We receive a button press event
-*/
-void MainWindow::buttonPressed(void)
-{
-	// Receveid a key press Event, look into table..
-	const char *source=qPrintable(sender()-&gt;objectName());
-
-	Action action=searchTranslationTable(source);
-
-	if(action!=ACT_DUMMY)
-		HandleAction (action);
-
-}
-void MainWindow::toolButtonPressed(bool i)
-{
-	buttonPressed();
-}
-
-bool MainWindow::eventFilter(QObject* watched, QEvent* event)
-{
-	QKeyEvent *keyEvent;
-
-	switch (event-&gt;type())
-	{
-		case QEvent::KeyPress:
-			keyEvent = (QKeyEvent*)event;
-
-			if (watched == slider)
-			{
-				switch (keyEvent-&gt;key())
-				{
-					case Qt::Key_Left:
-						if (keyEvent-&gt;modifiers() == Qt::ShiftModifier)
-							HandleAction(ACT_Back25Frames);
-						else if (keyEvent-&gt;modifiers() == Qt::ControlModifier)
-							HandleAction(ACT_Back50Frames);
-						else
-							HandleAction(ACT_PreviousFrame);
-
-						return true;
-					case Qt::Key_Right:
-						if (keyEvent-&gt;modifiers() == Qt::ShiftModifier)
-							HandleAction(ACT_Forward25Frames);
-						else if (keyEvent-&gt;modifiers() == Qt::ControlModifier)
-							HandleAction(ACT_Forward50Frames);
-						else
-							HandleAction(ACT_NextFrame);
-
-						return true;
-					case Qt::Key_Up:
-						HandleAction(ACT_NextKFrame);
-						return true;
-					case Qt::Key_Down:
-						HandleAction(ACT_PreviousKFrame);
-						return true;
-					case Qt::Key_Shift:
-						shiftKeyHeld = 1;
-						break;
-				}
-			}
-			else if (keyEvent-&gt;key() == Qt::Key_Space)
-			{
-				HandleAction(ACT_PlayAvi);
-				return true;
-			}
-
-			break;
-		case QEvent::KeyRelease:
-			keyEvent = (QKeyEvent*)event;
-
-			if (keyEvent-&gt;key() == Qt::Key_Shift)
-				shiftKeyHeld = 0;
-
-			break;
-		case QEvent::FocusOut:
-			if (watched == ui.currentTime)
-			{
-				uint16_t hh, mm, ss, ms;
-
-				if (!UI_readCurTime(hh, mm, ss, ms))
-					UI_updateTimeCount(currentFrame, currentFps);
-			}
-	}
-
-	return QObject::eventFilter(watched, event);
-}
-
-void MainWindow::mousePressEvent(QMouseEvent* event)
-{
-	this-&gt;setFocus(Qt::OtherFocusReason);
-}
-
-void MainWindow::dragEnterEvent(QDragEnterEvent *event)
-{
-	if (event-&gt;mimeData()-&gt;hasFormat(&quot;text/uri-list&quot;))
-		event-&gt;acceptProposedAction();
-}
-
-void MainWindow::dropEvent(QDropEvent *event)
-{
-	QList&lt;QUrl&gt; urlList;
-	QString fileName;
-	QFileInfo info;
-
-	if (event-&gt;mimeData()-&gt;hasUrls())
-	{
-		urlList = event-&gt;mimeData()-&gt;urls();
-
-		for (int fileIndex = 0; fileIndex &lt; urlList.size(); fileIndex++)
-		{
-			fileName = urlList[fileIndex].toLocalFile();
-			info.setFile(fileName);
-
-			if (info.isFile())
-			{
-				if (avifileinfo)
-					FileSel_ReadWrite(reinterpret_cast &lt;void (*)(const char *)&gt; (A_appendAvi), 0, fileName.toUtf8().data(), actual_workbench_file);
-				else
-					FileSel_ReadWrite(reinterpret_cast &lt;void (*)(const char *)&gt; (A_openAvi), 0, fileName.toUtf8().data(), actual_workbench_file);
-			}
-		}
-	}
-
-	event-&gt;acceptProposedAction();
-}
-
-void MainWindow::previousIntraFrame(void)
-{
-	if (ui.spinBox_TimeValue-&gt;hasFocus())
-		ui.spinBox_TimeValue-&gt;stepDown();
-	else
-		HandleAction(ACT_PreviousKFrame);
-}
-
-void MainWindow::nextIntraFrame(void)
-{
-	if (ui.spinBox_TimeValue-&gt;hasFocus())
-		ui.spinBox_TimeValue-&gt;stepUp();
-	else
-		HandleAction(ACT_NextKFrame);
-}
-
-void MainWindow::clearCustomMenu(void)
-{
-	if (ADM_nbCustom)
-	{
-		for(int i = 0; i &lt; ADM_nbCustom; i++)
-		{
-			disconnect(customActions[i], SIGNAL(triggered()), this, SLOT(custom()));
-			delete customActions[i];
-			delete customNames[i];
-		}
-
-		ui.menuCustom-&gt;clear();
-		ADM_nbCustom = 0;
-	}
-}
-
-void MainWindow::buildCustomMenu(void)
-{
-	clearCustomMenu();
-
-	char *customdir = ADM_getCustomDir();
-
-	if (!customdir)
-	{
-		printf(&quot;No custom dir...\n&quot;);
-		return;
-	}
-
-	/* Collect the name */
-	if (! buildDirectoryContent(&amp;ADM_nbCustom, customdir, customNames, ADM_MAC_CUSTOM_SCRIPT,&quot;.js&quot;))
-	{
-		printf(&quot;Failed to build custom dir content&quot;);
-		return;
-	}
-
-	if(ADM_nbCustom)
-	{
-		printf(&quot;Found %u custom script(s), adding them\n&quot;, ADM_nbCustom);
-
-		for(int i=0; i &lt; ADM_nbCustom; i++)
-		{
-			customActions[i] = new QAction(QString::fromUtf8(ADM_GetFileName(customNames[i])), NULL);
-			ui.menuCustom-&gt;addAction(customActions[i]);
-			connect(customActions[i], SIGNAL(triggered()), this, SLOT(custom()));
-		}
-	}
-	else
-		printf(&quot;No custom scripts\n&quot;);
-
-	printf(&quot;Custom menu built\n&quot;);
-}
-
-MainWindow::~MainWindow()
-{
-	clearCustomMenu();
-}
-static const UI_FUNCTIONS_T UI_Hooks=
-    {
-        ADM_RENDER_API_VERSION_NUMBER,
-        UI_purge,
-        UI_getWindowInfo,
-        UI_updateDrawWindowSize,
-        UI_rgbDraw,
-        UI_getDrawWidget,
-        UI_getPreferredRender
-        
+
+const adm_qt4_translation myTranslationTable[]=
+{
+#define PROCESS DECLARE_VAR
+	LIST_OF_OBJECTS
+	LIST_OF_BUTTONS
+#undef PROCESS
+};
+static Action searchTranslationTable(const char *name);
+#define SIZEOF_MY_TRANSLATION sizeof(myTranslationTable)/sizeof(adm_qt4_translation)
+
+int UI_readCurTime(uint16_t &amp;hh, uint16_t &amp;mm, uint16_t &amp;ss, uint16_t &amp;ms);
+void UI_updateFrameCount(uint32_t curFrame);
+void UI_updateTimeCount(uint32_t curFrame,uint32_t fps);
+extern void UI_purge(void);
+/*
+    Declare the class that will be our main window
+
+*/
+
+void MainWindow::comboChanged(int z)
+{
+	const char *source=qPrintable(sender()-&gt;objectName());
+
+	if(!strcmp(source,&quot;comboBoxVideo&quot;))  
+	{
+		bool b=FALSE;
+		if(ui.comboBoxVideo-&gt;currentIndex())
+		{
+			b=TRUE;
+		}
+		ui.pushButtonVideoConf-&gt;setEnabled(b);
+		ui.pushButtonVideoFilter-&gt;setEnabled(b);
+		HandleAction (ACT_VideoCodecChanged) ;
+	}
+	else if(!strcmp(source,&quot;comboBoxAudio&quot;))  
+	{
+		bool b=FALSE;
+		if(ui.comboBoxAudio-&gt;currentIndex())
+		{
+			b=TRUE;
+		}
+		ui.pushButtonAudioConf-&gt;setEnabled(b);
+		ui.pushButtonAudioFilter-&gt;setEnabled(b);
+		HandleAction (ACT_AudioCodecChanged) ;
+	}
+	else
+		printf(&quot;From +: %s\n&quot;,source);
+}
+
+void MainWindow::sliderValueChanged(int u) 
+{
+	if(!_upd_in_progres)
+		HandleAction(ACT_Scale);
+}
+
+void MainWindow::sliderMoved(int value)
+{
+	SliderIsShifted = shiftKeyHeld;
+}
+
+void MainWindow::sliderReleased(void)
+{
+	SliderIsShifted = 0;
+}
+
+void MainWindow::volumeChange( int u )
+{
+#ifdef HAVE_AUDIO
+	if (_upd_in_progres || !ui.toolButtonAudioToggle-&gt;isChecked())
+		return;
+
+	_upd_in_progres++;
+
+	int vol = ui.horizontalSlider_2-&gt;value();
+
+	AVDM_setVolume(vol);
+	_upd_in_progres--;
+#endif
+}
+
+void MainWindow::audioToggled(bool checked)
+{
+#ifdef HAVE_AUDIO
+	if (checked)
+		AVDM_setVolume(ui.horizontalSlider_2-&gt;value());
+	else
+		AVDM_setVolume(0);
+#endif
+}
+
+void MainWindow::previewModeChanged(QAction *action)
+{
+	HandleAction(ACT_PreviewChanged);
+}
+
+void MainWindow::timeChangeFinished(void)
+{
+	this-&gt;setFocus(Qt::OtherFocusReason);
+}
+
+void MainWindow::currentFrameChanged(void)
+{
+	HandleAction(ACT_JumpToFrame);
+
+	this-&gt;setFocus(Qt::OtherFocusReason);
+}
+
+void MainWindow::currentTimeChanged(void)
+{
+	HandleAction(ACT_JumpToTime);
+
+	this-&gt;setFocus(Qt::OtherFocusReason);
+}
+
+
+MainWindow::MainWindow() : QMainWindow()
+{
+	ui.setupUi(this);
+
+	this-&gt;setStatusBar(0);
+	this-&gt;adjustSize();
+
+#if defined(__APPLE__) &amp;&amp; defined(USE_SDL)
+	ui.actionAbout_avidemux-&gt;setMenuRole(QAction::NoRole);
+	ui.actionPreferences-&gt;setMenuRole(QAction::NoRole);
+	ui.actionQuit-&gt;setMenuRole(QAction::NoRole);
+#endif
+
+	// Preview modes
+	QActionGroup *groupPreviewModes = new QActionGroup(this);
+
+	groupPreviewModes-&gt;addAction(ui.actionPreviewInput);
+	groupPreviewModes-&gt;addAction(ui.actionPreviewOutput);
+	groupPreviewModes-&gt;addAction(ui.actionPreviewSide);
+	groupPreviewModes-&gt;addAction(ui.actionPreviewTop);
+	groupPreviewModes-&gt;addAction(ui.actionPreviewSeparate);
+	connect(groupPreviewModes, SIGNAL(triggered(QAction*)), this, SLOT(previewModeChanged(QAction*)));
+
+	// Zoom modes
+	QActionGroup *groupZoomModes = new QActionGroup(this);
+
+	groupZoomModes-&gt;addAction(ui.actionZoom_1_4);
+	groupZoomModes-&gt;addAction(ui.actionZoom_1_2);
+	groupZoomModes-&gt;addAction(ui.actionZoom_1_1);
+	groupZoomModes-&gt;addAction(ui.actionZoom_2_1);
+
+	/*
+	Connect our button to buttonPressed
+	*/
+#define PROCESS CONNECT
+	LIST_OF_OBJECTS
+#undef PROCESS
+#define PROCESS CONNECT_TB
+	LIST_OF_BUTTONS
+#undef PROCESS
+
+	connect(ui.actionPrevious_intra_frame, SIGNAL(triggered()), this, SLOT(previousIntraFrame()));
+	connect(ui.actionNext_intra_frame, SIGNAL(triggered()), this, SLOT(nextIntraFrame()));
+
+	//ACT_VideoCodecChanged
+	connect( ui.comboBoxVideo,SIGNAL(activated(int)),this,SLOT(comboChanged(int)));
+	connect( ui.comboBoxAudio,SIGNAL(activated(int)),this,SLOT(comboChanged(int)));
+
+	// Slider
+	slider=ui.horizontalSlider;
+	slider-&gt;setMinimum(0);
+	slider-&gt;setMaximum(1000000000);
+	connect( slider,SIGNAL(valueChanged(int)),this,SLOT(sliderValueChanged(int)));
+	connect( slider,SIGNAL(sliderMoved(int)),this,SLOT(sliderMoved(int)));
+	connect( slider,SIGNAL(sliderReleased()),this,SLOT(sliderReleased()));
+
+	// Volume slider
+	QSlider *volSlider=ui.horizontalSlider_2;
+	volSlider-&gt;setMinimum(0);
+	volSlider-&gt;setMaximum(100);
+	connect(volSlider,SIGNAL(valueChanged(int)),this,SLOT(volumeChange(int)));
+	connect(ui.toolButtonAudioToggle,SIGNAL(clicked(bool)),this,SLOT(audioToggled(bool)));
+
+	// default state
+	bool b=0;
+	ui.pushButtonVideoConf-&gt;setEnabled(b);
+	ui.pushButtonVideoFilter-&gt;setEnabled(b);
+	ui.pushButtonAudioConf-&gt;setEnabled(b);
+	ui.pushButtonAudioFilter-&gt;setEnabled(b);
+
+	/* Time Shift */
+	connect(ui.checkBox_TimeShift,SIGNAL(stateChanged(int)),this,SLOT(timeChanged(int)));
+	connect(ui.spinBox_TimeValue,SIGNAL(valueChanged(int)),this,SLOT(timeChanged(int)));
+	connect(ui.spinBox_TimeValue, SIGNAL(editingFinished()), this, SLOT(timeChangeFinished()));
+
+
+
+
+	QRegExp timeRegExp(&quot;^[0-9]{2}:[0-5][0-9]:[0-5][0-9]\\.[0-9]{3}$&quot;);
+	QRegExpValidator *timeValidator = new QRegExpValidator(timeRegExp, this);
+	ui.currentTime-&gt;setValidator(timeValidator);
+	ui.currentTime-&gt;setInputMask(&quot;99:99:99.999&quot;);
+
+	connect(ui.currentTime, SIGNAL(editingFinished()), this, SLOT(currentTimeChanged()));
+
+	/* Build the custom menu */
+	buildCustomMenu();
+
+	this-&gt;installEventFilter(this);
+	slider-&gt;installEventFilter(this);
+	
+	ui.currentTime-&gt;installEventFilter(this);
+
+	this-&gt;setFocus(Qt::OtherFocusReason);
+
+	setAcceptDrops(true);
+}
+/**
+\fn     custom
+\brief  Invoked when one of the custom script has been called
+*/
+void MainWindow::custom(void)
+{
+	printf(&quot;[Custom] Invoked\n&quot;);
+	QObject *ptr=sender();
+	if(!ptr) return;
+	for(int i=0;i&lt;ADM_nbCustom;i++)
+	{
+		if(customActions[i]==ptr)
+		{
+			printf(&quot;[Custom] %u/%u scripts\n&quot;,i,ADM_nbCustom);
+			HandleAction( (Action)(ACT_CUSTOM_BASE+i));
+			return; 
+		}
+	}
+	printf(&quot;[Custom] Not found\n&quot;);
+}
+/**
+    Get the custom entry 
+
+*/
+const char * GUI_getCustomScript(uint32_t nb)
+{
+	ADM_assert(nb&lt;ADM_nbCustom);
+	return customNames[nb];
+
+}
+/**
+    \fn timeChanged
+    \brief Called whenever timeshift is on/off'ed or value changes
+*/
+void MainWindow::timeChanged(int)
+{
+	HandleAction (ACT_TimeShift) ;
+}
+/*
+      We receive a button press event
+*/
+void MainWindow::buttonPressed(void)
+{
+	// Receveid a key press Event, look into table..
+	const char *source=qPrintable(sender()-&gt;objectName());
+
+	Action action=searchTranslationTable(source);
+
+	if(action!=ACT_DUMMY)
+		HandleAction (action);
+
+}
+void MainWindow::toolButtonPressed(bool i)
+{
+	buttonPressed();
+}
+
+bool MainWindow::eventFilter(QObject* watched, QEvent* event)
+{
+	QKeyEvent *keyEvent;
+
+	switch (event-&gt;type())
+	{
+		case QEvent::KeyPress:
+			keyEvent = (QKeyEvent*)event;
+
+			if (watched == slider)
+			{
+				switch (keyEvent-&gt;key())
+				{
+					case Qt::Key_Left:
+						if (keyEvent-&gt;modifiers() == Qt::ShiftModifier)
+							HandleAction(ACT_Back25Frames);
+						else if (keyEvent-&gt;modifiers() == Qt::ControlModifier)
+							HandleAction(ACT_Back50Frames);
+						else
+							HandleAction(ACT_PreviousFrame);
+
+						return true;
+					case Qt::Key_Right:
+						if (keyEvent-&gt;modifiers() == Qt::ShiftModifier)
+							HandleAction(ACT_Forward25Frames);
+						else if (keyEvent-&gt;modifiers() == Qt::ControlModifier)
+							HandleAction(ACT_Forward50Frames);
+						else
+							HandleAction(ACT_NextFrame);
+
+						return true;
+					case Qt::Key_Up:
+						HandleAction(ACT_NextKFrame);
+						return true;
+					case Qt::Key_Down:
+						HandleAction(ACT_PreviousKFrame);
+						return true;
+					case Qt::Key_Shift:
+						shiftKeyHeld = 1;
+						break;
+				}
+			}
+			else if (keyEvent-&gt;key() == Qt::Key_Space)
+			{
+				HandleAction(ACT_PlayAvi);
+				return true;
+			}
+
+			break;
+		case QEvent::KeyRelease:
+			keyEvent = (QKeyEvent*)event;
+
+			if (keyEvent-&gt;key() == Qt::Key_Shift)
+				shiftKeyHeld = 0;
+
+			break;
+		case QEvent::FocusOut:
+			if (watched == ui.currentTime)
+			{
+				uint16_t hh, mm, ss, ms;
+
+				if (!UI_readCurTime(hh, mm, ss, ms))
+					UI_updateTimeCount(currentFrame, currentFps);
+			}
+	}
+
+	return QObject::eventFilter(watched, event);
+}
+
+void MainWindow::mousePressEvent(QMouseEvent* event)
+{
+	this-&gt;setFocus(Qt::OtherFocusReason);
+}
+
+void MainWindow::dragEnterEvent(QDragEnterEvent *event)
+{
+	if (event-&gt;mimeData()-&gt;hasFormat(&quot;text/uri-list&quot;))
+		event-&gt;acceptProposedAction();
+}
+
+void MainWindow::dropEvent(QDropEvent *event)
+{
+	QList&lt;QUrl&gt; urlList;
+	QString fileName;
+	QFileInfo info;
+
+	if (event-&gt;mimeData()-&gt;hasUrls())
+	{
+		urlList = event-&gt;mimeData()-&gt;urls();
+
+		for (int fileIndex = 0; fileIndex &lt; urlList.size(); fileIndex++)
+		{
+			fileName = urlList[fileIndex].toLocalFile();
+			info.setFile(fileName);
+
+			if (info.isFile())
+			{
+				if (avifileinfo)
+					FileSel_ReadWrite(reinterpret_cast &lt;void (*)(const char *)&gt; (A_appendAvi), 0, fileName.toUtf8().data(), actual_workbench_file);
+				else
+					FileSel_ReadWrite(reinterpret_cast &lt;void (*)(const char *)&gt; (A_openAvi), 0, fileName.toUtf8().data(), actual_workbench_file);
+			}
+		}
+	}
+
+	event-&gt;acceptProposedAction();
+}
+
+void MainWindow::previousIntraFrame(void)
+{
+	if (ui.spinBox_TimeValue-&gt;hasFocus())
+		ui.spinBox_TimeValue-&gt;stepDown();
+	else
+		HandleAction(ACT_PreviousKFrame);
+}
+
+void MainWindow::nextIntraFrame(void)
+{
+	if (ui.spinBox_TimeValue-&gt;hasFocus())
+		ui.spinBox_TimeValue-&gt;stepUp();
+	else
+		HandleAction(ACT_NextKFrame);
+}
+
+void MainWindow::clearCustomMenu(void)
+{
+	if (ADM_nbCustom)
+	{
+		for(int i = 0; i &lt; ADM_nbCustom; i++)
+		{
+			disconnect(customActions[i], SIGNAL(triggered()), this, SLOT(custom()));
+			delete customActions[i];
+			delete customNames[i];
+		}
+
+		ui.menuCustom-&gt;clear();
+		ADM_nbCustom = 0;
+	}
+}
+
+void MainWindow::buildCustomMenu(void)
+{
+	clearCustomMenu();
+
+	char *customdir = ADM_getCustomDir();
+
+	if (!customdir)
+	{
+		printf(&quot;No custom dir...\n&quot;);
+		return;
+	}
+
+	/* Collect the name */
+	if (! buildDirectoryContent(&amp;ADM_nbCustom, customdir, customNames, ADM_MAC_CUSTOM_SCRIPT,&quot;.js&quot;))
+	{
+		printf(&quot;Failed to build custom dir content&quot;);
+		return;
+	}
+
+	if(ADM_nbCustom)
+	{
+		printf(&quot;Found %u custom script(s), adding them\n&quot;, ADM_nbCustom);
+
+		for(int i=0; i &lt; ADM_nbCustom; i++)
+		{
+			customActions[i] = new QAction(QString::fromUtf8(ADM_GetFileName(customNames[i])), NULL);
+			ui.menuCustom-&gt;addAction(customActions[i]);
+			connect(customActions[i], SIGNAL(triggered()), this, SLOT(custom()));
+		}
+	}
+	else
+		printf(&quot;No custom scripts\n&quot;);
+
+	printf(&quot;Custom menu built\n&quot;);
+}
+
+MainWindow::~MainWindow()
+{
+	clearCustomMenu();
+}
+static const UI_FUNCTIONS_T UI_Hooks=
+    {
+        ADM_RENDER_API_VERSION_NUMBER,
+        UI_purge,
+        UI_getWindowInfo,
+        UI_updateDrawWindowSize,
+        UI_rgbDraw,
+        UI_getDrawWidget,
+        UI_getPreferredRender
+        
     };
 QApplication *myApplication=NULL;
 /**
     \fn  UI_Init
     \brief First part of UI initialization
 
-*/
-int UI_Init(int nargc,char **nargv)
-{
-	initTranslator();
-
-	global_argc=nargc;
-	global_argv=nargv;
+*/
+int UI_Init(int nargc,char **nargv)
+{
+	initTranslator();
+
+	global_argc=nargc;
+	global_argv=nargv;
 	ADM_renderLibInit(&amp;UI_Hooks);
     Q_INIT_RESOURCE(avidemux);
 	Q_INIT_RESOURCE(filter);
@@ -586,332 +586,332 @@
 
 	UI_QT4VideoWidget(mw-&gt;ui.frame_video);  // Add the widget that will handle video display
 	UI_updateRecentMenu();
-    // Init vumeter
-    UI_InitVUMeter(mw-&gt;ui.frameVU);
-	return 0;
-}
-
-void UI_refreshCustomMenu(void)
-{
-	((MainWindow*)QuiMainWindows)-&gt;buildCustomMenu();
-}
-
-/**
-    \fn UI_getCurrentPreview(void)
-    \brief Read previewmode from comboxbox 
-*/
-int UI_getCurrentPreview(void)
-{
-	int index;
-
-	if (WIDGET(actionPreviewOutput)-&gt;isChecked())
-		index = 1;
-	else if (WIDGET(actionPreviewSide)-&gt;isChecked())
-		index = 2;
-	else if (WIDGET(actionPreviewTop)-&gt;isChecked())
-		index = 3;
-	else if (WIDGET(actionPreviewSeparate)-&gt;isChecked())
-		index = 4;
-	else
-		index = 0;
-
-	return index;
-}
-
-/**
-    \fn UI_setCurrentPreview(int ne)
-    \brief Update comboxbox with previewmode
-*/
-void UI_setCurrentPreview(int ne)
-{
-	switch (ne)
-	{
-		case 1:
-			WIDGET(actionPreviewOutput)-&gt;setChecked(true);
-			break;
-		case 2:
-			WIDGET(actionPreviewSide)-&gt;setChecked(true);
-			break;
-		case 3:
-			WIDGET(actionPreviewTop)-&gt;setChecked(true);
-			break;
-		case 4:
-			WIDGET(actionPreviewSeparate)-&gt;setChecked(true);
-			break;
-		default:
-			WIDGET(actionPreviewInput)-&gt;setChecked(true);
-	}
-}
-
-/**
-    \fn UI_RunApp(void)
-    \brief Main entry point for the GUI application
-*/
-int UI_RunApp(void)
-{
-	
-	setupMenus();
-	checkCrashFile();
-
-	if (global_argc &gt;= 2)
-		automation();
-
-	myApplication-&gt;exec();
-
+        // Init vumeter
+        UI_InitVUMeter(mw-&gt;ui.frameVU);
+	return 0;
+}
+
+void UI_refreshCustomMenu(void)
+{
+	((MainWindow*)QuiMainWindows)-&gt;buildCustomMenu();
+}
+
+/**
+    \fn UI_getCurrentPreview(void)
+    \brief Read previewmode from comboxbox 
+*/
+int UI_getCurrentPreview(void)
+{
+	int index;
+
+	if (WIDGET(actionPreviewOutput)-&gt;isChecked())
+		index = 1;
+	else if (WIDGET(actionPreviewSide)-&gt;isChecked())
+		index = 2;
+	else if (WIDGET(actionPreviewTop)-&gt;isChecked())
+		index = 3;
+	else if (WIDGET(actionPreviewSeparate)-&gt;isChecked())
+		index = 4;
+	else
+		index = 0;
+
+	return index;
+}
+
+/**
+    \fn UI_setCurrentPreview(int ne)
+    \brief Update comboxbox with previewmode
+*/
+void UI_setCurrentPreview(int ne)
+{
+	switch (ne)
+	{
+		case 1:
+			WIDGET(actionPreviewOutput)-&gt;setChecked(true);
+			break;
+		case 2:
+			WIDGET(actionPreviewSide)-&gt;setChecked(true);
+			break;
+		case 3:
+			WIDGET(actionPreviewTop)-&gt;setChecked(true);
+			break;
+		case 4:
+			WIDGET(actionPreviewSeparate)-&gt;setChecked(true);
+			break;
+		default:
+			WIDGET(actionPreviewInput)-&gt;setChecked(true);
+	}
+}
+
+/**
+    \fn UI_RunApp(void)
+    \brief Main entry point for the GUI application
+*/
+int UI_RunApp(void)
+{
+	
+	setupMenus();
+	checkCrashFile();
+
+	if (global_argc &gt;= 2)
+		automation();
+
+	myApplication-&gt;exec();
+
 	destroyTranslator();
     delete myApplication;
     myApplication=NULL;
-    
-}
-/**
-    \fn searchTranslationTable(const char *name))
-    \brief return the action corresponding to a give button. The translation table is in translation_table.h
-*/
-Action searchTranslationTable(const char *name)
-{
-	for(int i=0;i&lt; SIZEOF_MY_TRANSLATION;i++)
-	{
-		if(!strcmp(name, myTranslationTable[i].name))
-		{
-			return  myTranslationTable[i].action;
-		}
-	}
-	printf(&quot;WARNING: Signal not found in translation table %s\n&quot;,name);
-	return ACT_DUMMY;
-}
-/**
-    \fn     UI_updateRecentMenu( void )
-    \brief  Update the recent submenu with the latest files loaded
-*/
-uint8_t UI_updateRecentMenu( void )
-{
-	const char **names;
-	uint32_t nb_item=0;
-	QAction *actions[4]={WIDGET(actionRecent0),WIDGET(actionRecent1),WIDGET(actionRecent2),WIDGET(actionRecent3)};
-	names=prefs-&gt;get_lastfiles();
-
-	// hide them all
-	for(int i=0;i&lt;4;i++) actions[i]-&gt;setVisible(0);
-	// Redraw..
-	for( nb_item=0;nb_item&lt;4;nb_item++)
-	{
-		if(!names[nb_item]) 
-		{
-			return 1;
-		}
-		else
-		{
-			//actions[nb_item]-&gt;setVisible(1);
-			// Replace widget ?
-			actions[nb_item]-&gt;setText(QString::fromUtf8(names[nb_item]));
-			actions[nb_item]-&gt;setVisible(1);
-		}
-		// Update name
-	}
-	return 1;
-}
-/** 
-  \fn    setupMenus(void)
-  \brief Fill in video &amp; audio co
-*/
-void setupMenus(void)
-{
+    
+}
+/**
+    \fn searchTranslationTable(const char *name))
+    \brief return the action corresponding to a give button. The translation table is in translation_table.h
+*/
+Action searchTranslationTable(const char *name)
+{
+	for(int i=0;i&lt; SIZEOF_MY_TRANSLATION;i++)
+	{
+		if(!strcmp(name, myTranslationTable[i].name))
+		{
+			return  myTranslationTable[i].action;
+		}
+	}
+	printf(&quot;WARNING: Signal not found in translation table %s\n&quot;,name);
+	return ACT_DUMMY;
+}
+/**
+    \fn     UI_updateRecentMenu( void )
+    \brief  Update the recent submenu with the latest files loaded
+*/
+uint8_t UI_updateRecentMenu( void )
+{
+	const char **names;
+	uint32_t nb_item=0;
+	QAction *actions[4]={WIDGET(actionRecent0),WIDGET(actionRecent1),WIDGET(actionRecent2),WIDGET(actionRecent3)};
+	names=prefs-&gt;get_lastfiles();
+
+	// hide them all
+	for(int i=0;i&lt;4;i++) actions[i]-&gt;setVisible(0);
+	// Redraw..
+	for( nb_item=0;nb_item&lt;4;nb_item++)
+	{
+		if(!names[nb_item]) 
+		{
+			return 1;
+		}
+		else
+		{
+			//actions[nb_item]-&gt;setVisible(1);
+			// Replace widget ?
+			actions[nb_item]-&gt;setText(QString::fromUtf8(names[nb_item]));
+			actions[nb_item]-&gt;setVisible(1);
+		}
+		// Update name
+	}
+	return 1;
+}
+/** 
+  \fn    setupMenus(void)
+  \brief Fill in video &amp; audio co
+*/
+void setupMenus(void)
+{
 	uint32_t nbVid;
-    uint32_t maj,mn,pa;
-	const char *name;
-
-	nbVid=ADM_ve6_getNbEncoders();
-	printf(&quot;Found %d video encoder(s)\n&quot;,nbVid);
-	for(uint32_t i=1;i&lt;nbVid;i++)
-	{
-		ADM_ve6_getEncoderInfo(i,&amp;name,&amp;maj,&amp;mn,&amp;pa);
-		WIDGET(comboBoxVideo)-&gt;addItem(name);
-	}
-
-	// And A codec
-
-	uint32_t nbAud;
-
-    nbAud=audioEncoderGetNumberOfEncoders();
-	printf(&quot;Found %d audio encoder(s)\n&quot;,nbAud);		       
-	for(uint32_t i=1;i&lt;nbAud;i++)
-	{
-		name=audioEncoderGetDisplayName(i);
-		WIDGET(comboBoxAudio)-&gt;addItem(name);
+    uint32_t maj,mn,pa;
+	const char *name;
+
+	nbVid=ADM_ve6_getNbEncoders();
+	printf(&quot;Found %d video encoder(s)\n&quot;,nbVid);
+	for(uint32_t i=1;i&lt;nbVid;i++)
+	{
+		ADM_ve6_getEncoderInfo(i,&amp;name,&amp;maj,&amp;mn,&amp;pa);
+		WIDGET(comboBoxVideo)-&gt;addItem(name);
 	}
-
-	/*   Fill in output format window */
-	uint32_t nbFormat=ADM_mx_getNbMuxers();
-
-	printf(&quot;Found %d format(s)\n&quot;,nbFormat);
-	for(uint32_t i=0;i&lt;nbFormat;i++)
+
+	// And A codec
+
+	uint32_t nbAud;
+
+    nbAud=audioEncoderGetNumberOfEncoders();
+	printf(&quot;Found %d audio encoder(s)\n&quot;,nbAud);		       
+	for(uint32_t i=1;i&lt;nbAud;i++)
 	{
+		name=audioEncoderGetDisplayName(i);
+		WIDGET(comboBoxAudio)-&gt;addItem(name);
+	}
+
+	/*   Fill in output format window */
+	uint32_t nbFormat=ADM_mx_getNbMuxers();
+
+	printf(&quot;Found %d format(s)\n&quot;,nbFormat);
+	for(uint32_t i=0;i&lt;nbFormat;i++)
+	{
         const char *name=ADM_mx_getName(i);
-		WIDGET(comboBoxFormat)-&gt;addItem(name);	
-	}
-
-}
-/*
-    Return % of scale (between 0 and 1)
-*/
-double 	UI_readScale( void )
-{
-	double v;
-	if(!slider) v=0;
-	v= (double)(slider-&gt;value());
-	v/=10000000;
-	return v;
-}
-void UI_setScale( double val )
-{
-	if(_upd_in_progres) return;
-	_upd_in_progres++;
-	slider-&gt;setValue( (int)(val * 10000000));
-	_upd_in_progres--;
-}
-
-int UI_readCurFrame(void)
-{
-	return 0;
-}
-
-int UI_readCurTime(uint16_t &amp;hh, uint16_t &amp;mm, uint16_t &amp;ss, uint16_t &amp;ms)
-{
-	int success = 0;
-
-	QString timeText = WIDGET(currentTime)-&gt;text();
-	int pos;
-
-	if (WIDGET(currentTime)-&gt;validator()-&gt;validate(timeText, pos) == QValidator::Acceptable)
-	{
-		uint32_t frame;
-
-		hh = (uint16_t)timeText.left(2).toUInt();
-		mm = (uint16_t)timeText.mid(3, 2).toUInt();
-		ss = (uint16_t)timeText.mid(6, 2).toUInt();
-		ms = (uint16_t)timeText.right(3).toUInt();
-
-		time2frame(&amp;frame, currentFps, hh, mm, ss, ms);
-
-		if (frame &lt;= frameCount)
-			success = 1;
-	}
-
-	return success;
-}
-
-void UI_purge( void )
-{
-	QCoreApplication::processEvents ();
-}
-
-
-//*******************************************
-
-/**
-    \fn UI_setTitle(char *name)
-    \brief Set the main window title, usually name if the file being edited
-*/
-void UI_setTitle(const char *name)
-{
-	char *title;
-	const char* defaultTitle = &quot;Avidemux&quot;;
-
-	if (name &amp;&amp; strlen(name) &gt; 0)
-	{
-		title = new char[strlen(defaultTitle) + strlen(name) + 3 + 1];
-
-		strcpy(title, name);
-		strcat(title, &quot; - &quot;);
-		strcat(title, defaultTitle);
-	}
-	else
-	{
-		title = new char[strlen(defaultTitle) + 1];
-
-		strcpy(title, defaultTitle);
-	}
-
-	QuiMainWindows-&gt;setWindowTitle(QString::fromUtf8(title));
-	delete [] title;
-}
-
-/**
-    \fn     UI_setFrameType( uint32_t frametype,uint32_t qp)
-    \brief  Display frametype (I/P/B) and associated quantizer
-*/
-
-void UI_setFrameType( uint32_t frametype,uint32_t qp)
-{
-	char string[100];
-	char	c='?';
-	switch(frametype)
-	{
-	case AVI_KEY_FRAME: c='I';break;
-	case AVI_B_FRAME: c='B';break;
-	case 0: c='P';break;
-	default:c='?';break;
-
-	}
-	sprintf(string,QT_TR_NOOP(&quot;%c (%02d)&quot;),c,qp);
-	WIDGET(label_8)-&gt;setText(string);	
-
-}
-
-/**
-    \fn     UI_updateFrameCount(uint32_t curFrame)
-    \brief  Display the current displayed frame #
-*/
-void UI_updateFrameCount(uint32_t curFrame)
-{
-	
-}
-
-/**
-    \fn      UI_setFrameCount(uint32_t curFrame,uint32_t total)
-    \brief  Display the current displayed frame # and total frame #
-*/
-void UI_setFrameCount(uint32_t curFrame,uint32_t total)
-{
-	
-}
-
-/**
-    \fn     UI_updateTimeCount(uint32_t curFrame,uint32_t fps)
-    \brief  Display the time corresponding to current frame according to fps (fps1000)
-*/
-void UI_updateTimeCount(uint32_t curFrame,uint32_t fps)
-{
-	char text[80];   
-	uint32_t mm,hh,ss,ms;
-
-	frame2time(curFrame,fps, &amp;hh, &amp;mm, &amp;ss, &amp;ms);
-	sprintf(text, &quot;%02d:%02d:%02d.%03d&quot;, hh, mm, ss, ms);
-	WIDGET(currentTime)-&gt;setText(text);
-}
-
-/**
-    \fn     UI_updateTimeCount(uint32_t curFrame,uint32_t fps)
-    \brief  Display the time corresponding to current frame according to fps (fps1000) and total duration
-*/
-void UI_setTimeCount(uint32_t curFrame,uint32_t total, uint32_t fps)
-{
-	char text[80];   
-	uint32_t mm,hh,ss,ms;
-
-	if(total) total--; // We display from 0 to X
-
-	UI_updateTimeCount(curFrame,fps);
-	frame2time(total,fps, &amp;hh, &amp;mm, &amp;ss, &amp;ms);
-	sprintf(text, &quot;/ %02d:%02d:%02d.%03d&quot;, hh, mm, ss, ms);
-	WIDGET(totalTime)-&gt;setText(text);
-
-	slider-&gt;setFrameCount(total);
-
-	currentFps = fps;	
-}
+		WIDGET(comboBoxFormat)-&gt;addItem(name);	
+	}
 
+}
+/*
+    Return % of scale (between 0 and 1)
+*/
+double 	UI_readScale( void )
+{
+	double v;
+	if(!slider) v=0;
+	v= (double)(slider-&gt;value());
+	v/=10000000;
+	return v;
+}
+void UI_setScale( double val )
+{
+	if(_upd_in_progres) return;
+	_upd_in_progres++;
+	slider-&gt;setValue( (int)(val * 10000000));
+	_upd_in_progres--;
+}
+
+int UI_readCurFrame(void)
+{
+	return 0;
+}
+
+int UI_readCurTime(uint16_t &amp;hh, uint16_t &amp;mm, uint16_t &amp;ss, uint16_t &amp;ms)
+{
+	int success = 0;
+
+	QString timeText = WIDGET(currentTime)-&gt;text();
+	int pos;
+
+	if (WIDGET(currentTime)-&gt;validator()-&gt;validate(timeText, pos) == QValidator::Acceptable)
+	{
+		uint32_t frame;
+
+		hh = (uint16_t)timeText.left(2).toUInt();
+		mm = (uint16_t)timeText.mid(3, 2).toUInt();
+		ss = (uint16_t)timeText.mid(6, 2).toUInt();
+		ms = (uint16_t)timeText.right(3).toUInt();
+
+		time2frame(&amp;frame, currentFps, hh, mm, ss, ms);
+
+		if (frame &lt;= frameCount)
+			success = 1;
+	}
+
+	return success;
+}
+
+void UI_purge( void )
+{
+	QCoreApplication::processEvents ();
+}
+
+
+//*******************************************
+
 /**
+    \fn UI_setTitle(char *name)
+    \brief Set the main window title, usually name if the file being edited
+*/
+void UI_setTitle(const char *name)
+{
+	char *title;
+	const char* defaultTitle = &quot;Avidemux&quot;;
+
+	if (name &amp;&amp; strlen(name) &gt; 0)
+	{
+		title = new char[strlen(defaultTitle) + strlen(name) + 3 + 1];
+
+		strcpy(title, name);
+		strcat(title, &quot; - &quot;);
+		strcat(title, defaultTitle);
+	}
+	else
+	{
+		title = new char[strlen(defaultTitle) + 1];
+
+		strcpy(title, defaultTitle);
+	}
+
+	QuiMainWindows-&gt;setWindowTitle(QString::fromUtf8(title));
+	delete [] title;
+}
+
+/**
+    \fn     UI_setFrameType( uint32_t frametype,uint32_t qp)
+    \brief  Display frametype (I/P/B) and associated quantizer
+*/
+
+void UI_setFrameType( uint32_t frametype,uint32_t qp)
+{
+	char string[100];
+	char	c='?';
+	switch(frametype)
+	{
+	case AVI_KEY_FRAME: c='I';break;
+	case AVI_B_FRAME: c='B';break;
+	case 0: c='P';break;
+	default:c='?';break;
+
+	}
+	sprintf(string,QT_TR_NOOP(&quot;%c (%02d)&quot;),c,qp);
+	WIDGET(label_8)-&gt;setText(string);	
+
+}
+
+/**
+    \fn     UI_updateFrameCount(uint32_t curFrame)
+    \brief  Display the current displayed frame #
+*/
+void UI_updateFrameCount(uint32_t curFrame)
+{
+	
+}
+
+/**
+    \fn      UI_setFrameCount(uint32_t curFrame,uint32_t total)
+    \brief  Display the current displayed frame # and total frame #
+*/
+void UI_setFrameCount(uint32_t curFrame,uint32_t total)
+{
+	
+}
+
+/**
+    \fn     UI_updateTimeCount(uint32_t curFrame,uint32_t fps)
+    \brief  Display the time corresponding to current frame according to fps (fps1000)
+*/
+void UI_updateTimeCount(uint32_t curFrame,uint32_t fps)
+{
+	char text[80];   
+	uint32_t mm,hh,ss,ms;
+
+	frame2time(curFrame,fps, &amp;hh, &amp;mm, &amp;ss, &amp;ms);
+	sprintf(text, &quot;%02d:%02d:%02d.%03d&quot;, hh, mm, ss, ms);
+	WIDGET(currentTime)-&gt;setText(text);
+}
+
+/**
+    \fn     UI_updateTimeCount(uint32_t curFrame,uint32_t fps)
+    \brief  Display the time corresponding to current frame according to fps (fps1000) and total duration
+*/
+void UI_setTimeCount(uint32_t curFrame,uint32_t total, uint32_t fps)
+{
+	char text[80];   
+	uint32_t mm,hh,ss,ms;
+
+	if(total) total--; // We display from 0 to X
+
+	UI_updateTimeCount(curFrame,fps);
+	frame2time(total,fps, &amp;hh, &amp;mm, &amp;ss, &amp;ms);
+	sprintf(text, &quot;/ %02d:%02d:%02d.%03d&quot;, hh, mm, ss, ms);
+	WIDGET(totalTime)-&gt;setText(text);
+
+	slider-&gt;setFrameCount(total);
+
+	currentFps = fps;	
+}
+
+/**
     \fn UI_setCurrentTime
     \brief Set current PTS of displayed video
 */
@@ -940,131 +940,131 @@
     ms2time(shorty,&amp;hh,&amp;mm,&amp;ss,&amp;ms);
   	sprintf(text, &quot;/%02d:%02d:%02d.%03d&quot;, hh, mm, ss, ms);
     WIDGET(totalTime)-&gt;setText(text);
-}
-/**
-    \fn     UI_setMarkers(uint64_t Ptsa, uint32_t Ptsb )
-    \brief  Display frame # for marker A &amp; B
-*/
-void UI_setMarkers(uint64_t a, uint64_t b)
-{
-	char text[80];
+}
+/**
+    \fn     UI_setMarkers(uint64_t Ptsa, uint32_t Ptsb )
+    \brief  Display frame # for marker A &amp; B
+*/
+void UI_setMarkers(uint64_t a, uint64_t b)
+{
+	char text[80];
     uint32_t hh,mm,ss,ms;
     uint32_t timems;
     a/=1000;
     b/=1000;
 
     timems=(uint32_t)(a);
-    ms2time(timems,&amp;hh,&amp;mm,&amp;ss,&amp;ms);
-	snprintf(text,79,&quot;%02&quot;LU&quot;:%02&quot;LU&quot;:%02&quot;LU&quot;.%02&quot;LU,hh,mm,ss,ms);
-	WIDGET(pushButtonJumpToMarkerA)-&gt;setText(text);
-
+    ms2time(timems,&amp;hh,&amp;mm,&amp;ss,&amp;ms);
+	snprintf(text,79,&quot;%02&quot;LU&quot;:%02&quot;LU&quot;:%02&quot;LU&quot;.%02&quot;LU,hh,mm,ss,ms);
+	WIDGET(pushButtonJumpToMarkerA)-&gt;setText(text);
+
 	timems=(uint32_t)(b);
     ms2time(timems,&amp;hh,&amp;mm,&amp;ss,&amp;ms);
-	snprintf(text,79,&quot;%02&quot;LU&quot;:%02&quot;LU&quot;:%02&quot;LU&quot;.%02&quot;LU,hh,mm,ss,ms);
-	WIDGET(pushButtonJumpToMarkerB)-&gt;setText(text);
-
-	//slider-&gt;setMarkers(a, b);
-}
-
-/**
-    \fn     UI_getCurrentVCodec(void)
-    \brief  Returns the current selected video code in menu, i.e its number (0 being the first)
-*/
-int 	UI_getCurrentVCodec(void)
-{
-	int i=WIDGET(comboBoxVideo)-&gt;currentIndex();
-	if(i&lt;0) i=0;
-	return i; 
-}
-/**
-    \fn     UI_setVideoCodec( int i)
-    \brief  Select the video codec which is # x in pulldown menu (starts at zero :copy)
-*/
-
-void UI_setVideoCodec( int i)
-{
-	int b=!!i;
-	WIDGET(comboBoxVideo)-&gt;setCurrentIndex(i);
-
-	WIDGET(pushButtonVideoConf)-&gt;setEnabled(b);
-	WIDGET(pushButtonVideoFilter)-&gt;setEnabled(b);
-}
-/**
-    \fn     UI_getCurrentACodec(void)
-    \brief  Returns the current selected audio code in menu, i.e its number (0 being the first)
-*/
-
-int 	UI_getCurrentACodec(void)
-{
-	int i=WIDGET(comboBoxAudio)-&gt;currentIndex();
-	if(i&lt;0) i=0;
-	return i; 
-}
-/**
-    \fn     UI_setAudioCodec( int i)
-    \brief  Select the audio codec which is # x in pulldown menu (starts at zero :copy)
-*/
-
-void UI_setAudioCodec( int i)
-{ int b=!!i;
-WIDGET(comboBoxAudio)-&gt;setCurrentIndex(i);
-WIDGET(pushButtonAudioConf)-&gt;setEnabled(b);
-WIDGET(pushButtonAudioFilter)-&gt;setEnabled(b);
-}
-/**
-    \fn     UI_GetCurrentFormat(void)
-    \brief  Returns the current selected output format
-*/
-
-ADM_OUT_FORMAT 	UI_GetCurrentFormat( void )
-{
-	int i=WIDGET(comboBoxFormat)-&gt;currentIndex();
-	if(i&lt;0) i=0;
-	return (ADM_OUT_FORMAT)i; 
-}
-/**
-    \fn     UI_SetCurrentFormat( ADM_OUT_FORMAT fmt )
-    \brief  Select  output format
-*/
-uint8_t 	UI_SetCurrentFormat( uint32_t fmt )
-{
-	WIDGET(comboBoxFormat)-&gt;setCurrentIndex((int)fmt);
-}
-
-/**
-      \fn UI_getTimeShift
-      \brief get state (on/off) and value for time Shift
-*/
-uint8_t UI_getTimeShift(int *onoff,int *value)
-{
-	if(WIDGET(checkBox_TimeShift)-&gt;checkState()==Qt::Checked)
-		*onoff=1;
-	else
-		*onoff=0;
-	*value=WIDGET(spinBox_TimeValue)-&gt;value();
-	return 1;
-}
-/**
-      \fn UI_setTimeShift
-      \brief get state (on/off) and value for time Shift
-*/
-
-uint8_t UI_setTimeShift(int onoff,int value)
-{
-	if (onoff &amp;&amp; value)
-		WIDGET(checkBox_TimeShift)-&gt;setCheckState(Qt::Checked);
-	else
-		WIDGET(checkBox_TimeShift)-&gt;setCheckState(Qt::Unchecked);
-	WIDGET(spinBox_TimeValue)-&gt;setValue(value);
-	return 1;
+	snprintf(text,79,&quot;%02&quot;LU&quot;:%02&quot;LU&quot;:%02&quot;LU&quot;.%02&quot;LU,hh,mm,ss,ms);
+	WIDGET(pushButtonJumpToMarkerB)-&gt;setText(text);
+
+	//slider-&gt;setMarkers(a, b);
 }
+
 /**
+    \fn     UI_getCurrentVCodec(void)
+    \brief  Returns the current selected video code in menu, i.e its number (0 being the first)
+*/
+int 	UI_getCurrentVCodec(void)
+{
+	int i=WIDGET(comboBoxVideo)-&gt;currentIndex();
+	if(i&lt;0) i=0;
+	return i; 
+}
+/**
+    \fn     UI_setVideoCodec( int i)
+    \brief  Select the video codec which is # x in pulldown menu (starts at zero :copy)
+*/
+
+void UI_setVideoCodec( int i)
+{
+	int b=!!i;
+	WIDGET(comboBoxVideo)-&gt;setCurrentIndex(i);
+
+	WIDGET(pushButtonVideoConf)-&gt;setEnabled(b);
+	WIDGET(pushButtonVideoFilter)-&gt;setEnabled(b);
+}
+/**
+    \fn     UI_getCurrentACodec(void)
+    \brief  Returns the current selected audio code in menu, i.e its number (0 being the first)
+*/
+
+int 	UI_getCurrentACodec(void)
+{
+	int i=WIDGET(comboBoxAudio)-&gt;currentIndex();
+	if(i&lt;0) i=0;
+	return i; 
+}
+/**
+    \fn     UI_setAudioCodec( int i)
+    \brief  Select the audio codec which is # x in pulldown menu (starts at zero :copy)
+*/
+
+void UI_setAudioCodec( int i)
+{ int b=!!i;
+WIDGET(comboBoxAudio)-&gt;setCurrentIndex(i);
+WIDGET(pushButtonAudioConf)-&gt;setEnabled(b);
+WIDGET(pushButtonAudioFilter)-&gt;setEnabled(b);
+}
+/**
+    \fn     UI_GetCurrentFormat(void)
+    \brief  Returns the current selected output format
+*/
+
+ADM_OUT_FORMAT 	UI_GetCurrentFormat( void )
+{
+	int i=WIDGET(comboBoxFormat)-&gt;currentIndex();
+	if(i&lt;0) i=0;
+	return (ADM_OUT_FORMAT)i; 
+}
+/**
+    \fn     UI_SetCurrentFormat( ADM_OUT_FORMAT fmt )
+    \brief  Select  output format
+*/
+uint8_t 	UI_SetCurrentFormat( uint32_t fmt )
+{
+	WIDGET(comboBoxFormat)-&gt;setCurrentIndex((int)fmt);
+}
+
+/**
+      \fn UI_getTimeShift
+      \brief get state (on/off) and value for time Shift
+*/
+uint8_t UI_getTimeShift(int *onoff,int *value)
+{
+	if(WIDGET(checkBox_TimeShift)-&gt;checkState()==Qt::Checked)
+		*onoff=1;
+	else
+		*onoff=0;
+	*value=WIDGET(spinBox_TimeValue)-&gt;value();
+	return 1;
+}
+/**
+      \fn UI_setTimeShift
+      \brief get state (on/off) and value for time Shift
+*/
+
+uint8_t UI_setTimeShift(int onoff,int value)
+{
+	if (onoff &amp;&amp; value)
+		WIDGET(checkBox_TimeShift)-&gt;setCheckState(Qt::Checked);
+	else
+		WIDGET(checkBox_TimeShift)-&gt;setCheckState(Qt::Unchecked);
+	WIDGET(spinBox_TimeValue)-&gt;setValue(value);
+	return 1;
+}
+/**
     \fn UI_setVUMeter
-*/
+*/
 bool UI_setVUMeter( uint32_t volume[6])
 {
     UI_vuUpdate( volume);
     return true;
-}
-//********************************************
-//EOF
+}
+//********************************************
+//EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_clock.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_clock.h	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_clock.h	2010-03-01 06:22:02 UTC (rev 5956)
@@ -18,7 +18,8 @@
 #define ADM_CLOCK_H
 class Clock
 {
-	private: uint32_t _startTime;
+	private: 
+            uint32_t _startTime;
 
 	public:
 			Clock(void );

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/DIA_coreUI_internal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/DIA_coreUI_internal.h	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/DIA_coreUI_internal.h	2010-03-01 06:22:02 UTC (rev 5956)
@@ -126,7 +126,7 @@
 typedef void            CREATE_GUI_QUIET(void);
 typedef uint8_t			CREATE_GUI_IS_GUIET(void);
 typedef DIA_workingBase  *CREATE_GUI_WORKING(const char *title);
-typedef DIA_encodingBase *CREATE_GUI_ENCODING(uint32_t fps1000);
+typedef DIA_encodingBase *CREATE_GUI_ENCODING(uint64_t duration);
 // GUI_Sleep is internal
 typedef struct
 {

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/DIA_encoding.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/DIA_encoding.h	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/DIA_encoding.h	2010-03-01 06:22:02 UTC (rev 5956)
@@ -16,52 +16,48 @@
 #ifndef ADM_ENCODING_H
 #define ADM_ENCODING_H
 
+#include &quot;ADM_clock.h&quot;
+/**
+    \class DIA_encodingBase
+    \brief Base class for encoding dialog
+*/
 
-#define MAX_BR_SLOT 200
-
-typedef struct 
-{
-  uint32_t size;
-  uint32_t quant;
-}encodingSlice;
-
 class DIA_encodingBase
 {
 protected:
-                Clock	clock;
-                uint32_t  _lastTime;            // Start time used to calc. ETA
-                uint32_t  _lastFrame;           // Start frame used to calc. ETA
-                uint32_t  _nextSampleStartTime; // Next start time to be used for ETA
-                uint32_t  _nextSampleStartFrame; // Next start frame for ETA
+                Clock	  clock;
+                
+                uint32_t  _lastFrameCount;       // Start frame used to calc. ETA
+                uint32_t  _currentFrameCount;    //
+                uint32_t  _lastClock;            // Start time used to calc. ETA
                 uint32_t  _nextUpdate;           // Next time to update the GUI
-                float _fps_average;
-                uint32_t _average_bitrate;
-                uint64_t _totalSize;
-                uint64_t _audioSize;
-                uint64_t _videoSize;
-                uint32_t _bitrate_sum;           // Sum of bitrate array
-                encodingSlice _bitrate[MAX_BR_SLOT];
-                uint32_t _roundup;
-                uint32_t _current;
-                uint32_t _total;
-                uint32_t _lastnb;
-                uint32_t _fps1000;
-                uint32_t _originalPriority;
+                float     _fps_average;
+                uint32_t  _average_bitrate;
+                uint64_t  _totalDurationUs;
+                uint64_t  _currentDurationUs;
+                uint64_t  _totalSize;
+                uint64_t  _audioSize;
+                uint64_t  _videoSize;
+                uint32_t  _originalPriority;
         
 public:
-                             DIA_encodingBase( uint32_t fps1000 );
+                             DIA_encodingBase( uint64_t duration );
                 virtual      ~DIA_encodingBase( );
                 
                 virtual void reset( void );
-                virtual void setPhasis(const char *n);
-                virtual void setCodec(const char *n);
-                virtual void setAudioCodec(const char *n);
-                virtual void setFps(uint32_t fps);
-                virtual void setFrame(uint32_t nb,uint32_t size, uint32_t quant,uint32_t total);
-                virtual void setPercent(uint32_t percent);
-                virtual void setContainer(const char *container);
-                virtual void setAudioSize(uint32_t size);
-                virtual uint8_t isAlive(void);
+                virtual void setPhasis(const char *n)=0;
+                virtual void setVideoCodec(const char *n)=0;
+                virtual void setAudioCodec(const char *n)=0;
+                virtual void setFps(uint32_t fps1000)=0;
+                virtual void setPercent(uint32_t percent)=0;
+                virtual void setContainer(const char *container)=0;
+                virtual void setAudioSize(uint64_t size)=0;
+                virtual void setTotalSize(uint64_t size)=0;
+                virtual bool isAlive(void)=0;
+
+                virtual void pushVideoFrame(uint32_t size, uint32_t quant,uint64_t timeUs);
+                virtual void pushAudioFrame(uint32_t size);
+                virtual void refresh(void);
 };
 //********************
 DIA_encodingBase *createEncoding(uint32_t fps1000);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/src/DIA_coreToolkit.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/src/DIA_coreToolkit.cpp	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/src/DIA_coreToolkit.cpp	2010-03-01 06:22:02 UTC (rev 5956)
@@ -231,9 +231,10 @@
 /**
     \fn createEncoding
 */
-DIA_encodingBase *createEncoding(uint32_t fps1000)
+DIA_encodingBase *createEncoding(uint64_t duration)
 {
- if(Toolkit-&gt;createEncoding) return Toolkit-&gt;createEncoding(fps1000);
-    return new DIA_encodingBase(fps1000);
+    if(Toolkit-&gt;createEncoding) return Toolkit-&gt;createEncoding(duration);
+//    return new DIA_encodingDummy(duration);
+    return NULL;
 } 
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/src/DIA_encoding.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/src/DIA_encoding.cpp	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/src/DIA_encoding.cpp	2010-03-01 06:22:02 UTC (rev 5956)
@@ -7,9 +7,9 @@
  *                                                                         *
  ***************************************************************************/
 
-#include &lt;math.h&gt;
 
-//#include &quot;prefs.h&quot;
+
+
 #include &quot;ADM_default.h&quot;
 #include &quot;DIA_coreToolkit.h&quot;
 #include &quot;avidemutils.h&quot;
@@ -17,33 +17,20 @@
 #include &quot;DIA_encoding.h&quot;
 #include &quot;ADM_vidMisc.h&quot;
 
+#include &lt;math.h&gt;
+#define  ETA_SAMPLE_PERIOD 60000 //Use last n millis to calculate ETA
+#define  GUI_UPDATE_RATE 500    // Ms
 
-DIA_encodingBase::DIA_encodingBase( uint32_t fps1000 )
+DIA_encodingBase::DIA_encodingBase( uint64_t duration )
 {
-
-        _lastnb=0;
-        _totalSize=0;
-        _audioSize=0;
-        _videoSize=0;
-        _current=0;
-        setFps(fps1000);
         _originalPriority=getpriority(PRIO_PROCESS, 0);
-        _lastTime=0;
-        _lastFrame=0;
-        _fps_average=0;
-        _total=1000;
+        _totalDurationUs=duration;
+#ifdef __WIN32
+        _originalPriority=getpriority(PRIO_PROCESS, 0);
+#endif
+        reset();
 }
 
-void DIA_encodingBase::setFps(uint32_t fps)
-{
-        _roundup=(uint32_t )floor( (fps+999)/1000);
-        _fps1000=fps;
-        ADM_assert(_roundup&lt;MAX_BR_SLOT);
-        memset(_bitrate,0,sizeof(_bitrate));
-        _bitrate_sum=0;
-        _average_bitrate=0;
-        
-}
 void DIA_stop( void)
 {
 	printf(&quot;Stop request\n&quot;);
@@ -53,69 +40,57 @@
 
 DIA_encodingBase::~DIA_encodingBase( )
 {
-
+#ifdef __WIN32
 	setpriority(PRIO_PROCESS, 0, _originalPriority);
-
+#endif
 }
 
-void DIA_encodingBase::setPhasis(const char *n)
+void DIA_encodingBase::reset(void)
 {
+        _lastFrameCount=0;
+        _currentFrameCount=0;
+        _totalSize=0;
+        _audioSize=0;
+        _videoSize=0;
+        _nextUpdate=GUI_UPDATE_RATE;
+        _lastClock=0;
+        _fps_average=0;
+        clock.reset();
 
 }
-void DIA_encodingBase::setAudioCodec(const char *n)
-{
 
-}
-
-void DIA_encodingBase::setCodec(const char *n)
+void DIA_encodingBase::pushVideoFrame(uint32_t size, uint32_t quant,uint64_t timeUs)
 {
-
-}
-void DIA_encodingBase::reset(void)
-{
-          _totalSize=0;
-          _videoSize=0;
-          _current=0;
-}
-void DIA_encodingBase::setContainer(const char *container)
-{
-}
-#define  ETA_SAMPLE_PERIOD 60000 //Use last n millis to calculate ETA
-#define  GUI_UPDATE_RATE 500  
-
-void DIA_encodingBase::setFrame(uint32_t nb,uint32_t size, uint32_t quant,uint32_t total)
-{
-          _total=total;
           _videoSize+=size;
-          if(nb &lt; _lastnb || _lastnb == 0) // restart ?
-           {
-                _lastnb = nb;
-                clock.reset();
-                _lastTime=clock.getElapsedMS();
-                _lastFrame=0;
-                _fps_average=0;
-                _videoSize=size;
-    
-                _nextUpdate = _lastTime + GUI_UPDATE_RATE;
-                _nextSampleStartTime=_lastTime + ETA_SAMPLE_PERIOD;
-                _nextSampleStartFrame=0;
-          } 
-          _lastnb = nb;
-          _current=nb%_roundup;
-          _bitrate[_current].size=size;
-          _bitrate[_current].quant=quant;
+          _currentFrameCount++;
+          _currentDurationUs=timeUs;
 }
-void DIA_encodingBase::setAudioSize(uint32_t size)
+void DIA_encodingBase::pushAudioFrame(uint32_t size)
 {
-      _audioSize=size;
+          _audioSize+=size;
 }
-uint8_t DIA_encodingBase::isAlive( void )
+void DIA_encodingBase::refresh(void)
 {
-	return 0;
+          uint32_t time=clock.getElapsedMS();
+          if(time&gt;_nextUpdate)
+          {
+                uint32_t deltaTime=time-_lastClock;
+                uint32_t deltaFrame=_currentFrameCount-_lastFrameCount;
+                if(deltaFrame)
+                {
+                    deltaFrame*=1000;
+                    deltaFrame/=deltaTime;
+                    _fps_average=((float)deltaFrame)/1000.;
+                    setFps(deltaFrame);
+                    float percent=_currentDurationUs/_totalDurationUs;
+                    if(percent&gt;1.0) percent=1.0;
+                    percent*=100;
+                    setPercent((uint32_t)percent);
+                }
+                _nextUpdate=time+GUI_UPDATE_RATE;
+                setAudioSize(_audioSize);
+                UI_purge();
+          }
 }
-void DIA_encodingBase::setPercent(uint32_t percent)
-{
-
-}
 //EOF
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv.cpp	2010-02-28 20:50:24 UTC (rev 5955)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkv.cpp	2010-03-01 06:22:02 UTC (rev 5956)
@@ -208,7 +208,7 @@
             *bFramePresent=false;
         }else
         {
-            ADM_info(&quot;PTS is monotonous, probably no bframe\n&quot;);
+            ADM_info(&quot;PTS is not monotonous, there are bframe\n&quot;);
             *bFramePresent=true;
         }
     }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="003162.html">[Avidemux-svn-commit] r5957 - in branches/avidemux_2.6_branch_mean:	autononreg/dialogFactory avidemux/common/ADM_script2/include	avidemux/common/ADM_script2/src	avidemux/qt4/ADM_userInterfaces/ADM_dialog	avidemux_core/ADM_coreUI/include avidemux_core/ADM_coreUI/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3161">[ date ]</a>
              <a href="thread.html#3161">[ thread ]</a>
              <a href="subject.html#3161">[ subject ]</a>
              <a href="author.html#3161">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
