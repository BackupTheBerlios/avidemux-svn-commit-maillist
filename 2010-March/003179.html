<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r5974 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_videoFilter2/include	avidemux/common/ADM_videoFilter2/src	avidemux_core/ADM_coreImage/include avidemux_core/ADM_coreImage/src	avidemux_core/ADM_coreVideoFilter/include	avidemux_core/ADM_coreVideoFilter/src	avidemux_plugins/ADM_videoEncoder/null	avidemux_plugins/ADM_videoEncoder/png	avidemux_plugins/ADM_videoEncoder/yv12	avidemux_plugins/ADM_videoFilters6/dummy	avidemux_plugins/ADM_videoFilters6/verticalFlip
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2010-March/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r5974%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common/ADM_videoFilter2/include%0A%09avidemux/common/ADM_videoFilter2/src%0A%09avidemux_core/ADM_coreImage/include%20avidemux_core/ADM_coreImage/src%0A%09avidemux_core/ADM_coreVideoFilter/include%0A%09avidemux_core/ADM_coreVideoFilter/src%0A%09avidemux_plugins/ADM_videoEncoder/null%0A%09avidemux_plugins/ADM_videoEncoder/png%0A%09avidemux_plugins/ADM_videoEncoder/yv12%0A%09avidemux_plugins/ADM_videoFilters6/dummy%0A%09avidemux_plugins/ADM_videoFilters6/verticalFlip&In-Reply-To=%3C201003050618.o256IuEj014527%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003178.html">
   <LINK REL="Next"  HREF="003180.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r5974 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_videoFilter2/include	avidemux/common/ADM_videoFilter2/src	avidemux_core/ADM_coreImage/include avidemux_core/ADM_coreImage/src	avidemux_core/ADM_coreVideoFilter/include	avidemux_core/ADM_coreVideoFilter/src	avidemux_plugins/ADM_videoEncoder/null	avidemux_plugins/ADM_videoEncoder/png	avidemux_plugins/ADM_videoEncoder/yv12	avidemux_plugins/ADM_videoFilters6/dummy	avidemux_plugins/ADM_videoFilters6/verticalFlip</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r5974%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common/ADM_videoFilter2/include%0A%09avidemux/common/ADM_videoFilter2/src%0A%09avidemux_core/ADM_coreImage/include%20avidemux_core/ADM_coreImage/src%0A%09avidemux_core/ADM_coreVideoFilter/include%0A%09avidemux_core/ADM_coreVideoFilter/src%0A%09avidemux_plugins/ADM_videoEncoder/null%0A%09avidemux_plugins/ADM_videoEncoder/png%0A%09avidemux_plugins/ADM_videoEncoder/yv12%0A%09avidemux_plugins/ADM_videoFilters6/dummy%0A%09avidemux_plugins/ADM_videoFilters6/verticalFlip&In-Reply-To=%3C201003050618.o256IuEj014527%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r5974 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_videoFilter2/include	avidemux/common/ADM_videoFilter2/src	avidemux_core/ADM_coreImage/include avidemux_core/ADM_coreImage/src	avidemux_core/ADM_coreVideoFilter/include	avidemux_core/ADM_coreVideoFilter/src	avidemux_plugins/ADM_videoEncoder/null	avidemux_plugins/ADM_videoEncoder/png	avidemux_plugins/ADM_videoEncoder/yv12	avidemux_plugins/ADM_videoFilters6/dummy	avidemux_plugins/ADM_videoFilters6/verticalFlip">mean at mail.berlios.de
       </A><BR>
    <I>Fri Mar  5 07:18:56 CET 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="003178.html">[Avidemux-svn-commit] r5973 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/yadif
</A></li>
        <LI>Next message: <A HREF="003180.html">[Avidemux-svn-commit] r5975 -	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3179">[ date ]</a>
              <a href="thread.html#3179">[ thread ]</a>
              <a href="subject.html#3179">[ subject ]</a>
              <a href="author.html#3179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2010-03-05 07:18:44 +0100 (Fri, 05 Mar 2010)
New Revision: 5974

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_videoFilterCache.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_videoFilterCache.cpp
Removed:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_videoFilterCache.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_videoFilterCache.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/include/ADM_videoFilterBridge.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilterBridge.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilter.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_coreVideoFilter.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/null/nullEncoder.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/png/ADM_pngEncoder.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/yv12/ADM_yv12Encoder.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/dummy/dummyVideoFilter.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/verticalFlip/verticalFlip.cpp
Log:
[filter] Add a sort-of-frame-number to the api, reintroduce video cache

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/include/ADM_videoFilterBridge.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/include/ADM_videoFilterBridge.h	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/include/ADM_videoFilterBridge.h	2010-03-05 06:18:44 UTC (rev 5974)
@@ -31,14 +31,13 @@
         FilterInfo          bridgeInfo;
         bool                firstImage;
         uint32_t            lastSentImage;
-        virtual bool        nextFrame(ADMImage *image);    /// Return the next image
 public:
                             ADM_videoFilterBridge(uint64_t startTime, uint64_t endTime);
                             ~ADM_videoFilterBridge();
        virtual bool         goToTime(uint64_t usSeek);  
-       virtual bool         getNextFrame(ADMImage *image);      
-	   virtual FilterInfo  *getInfo(void);                                      /// Return picture parameters after this filter
-	   virtual bool         getCoupledConf(CONFcouple **couples) {*couples=NULL;return true;} ; /// Return the current filter configuration
+       virtual bool         getNextFrame(uint32_t *frameNumber,ADMImage *image);      
+       virtual FilterInfo  *getInfo(void);                                      /// Return picture parameters after this filter
+       virtual bool         getCoupledConf(CONFcouple **couples) {*couples=NULL;return true;} ; /// Return the current filter configuration
 
         bool                rewind(void);
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilterBridge.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilterBridge.cpp	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoFilter2/src/ADM_videoFilterBridge.cpp	2010-03-05 06:18:44 UTC (rev 5974)
@@ -65,7 +65,7 @@
     \fn getNextFrame
     \brief
 */
-bool         ADM_videoFilterBridge::nextFrame(ADMImage *image)
+bool         ADM_videoFilterBridge::getNextFrame(uint32_t *frameNumber,ADMImage *image)
 {
 again:
     bool r=false;
@@ -74,9 +74,12 @@
         firstImage=false;
         r=video_body-&gt;samePicture(image);
         lastSentImage=0;
+        *frameNumber=nextFrame=0;
     }else
     {
         r=   video_body-&gt;nextPicture(image);
+        nextFrame++;
+        *frameNumber=nextFrame;
         lastSentImage++;
     }
     if(r==false) return false;
@@ -97,16 +100,6 @@
     return true;
 }
 /**
-    \fn getFrame
-    \brief This one is special. the lower level can only do sequential access
-            so we in case of non-sequential access we rely on the cache of decoded image.
-            (TODO)
-*/
-bool         ADM_videoFilterBridge::getNextFrame(ADMImage *image)
-{  
-        return nextFrame(image);
-}
-/**
     \fn ADM_videoFilterBridge
 
 */

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_videoFilterCache.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_videoFilterCache.h	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_videoFilterCache.h	2010-03-05 06:18:44 UTC (rev 5974)
@@ -1,52 +0,0 @@
-//
-// C++ Interface: ADM_cache
-//
-// Description: 
-//
-//
-// Author: mean &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>&gt;, (C) 2004
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-
-#ifndef __ADM_CACHE__
-#define __ADM_CACHE__
-#include &quot;ADM_coreVideoFilter.h&quot;
-/**
-    \struct videoCacheEntry
-*/
-typedef struct vidCacheEntry
-{
-		uint32_t 	frameNum;
-		ADMImage 	*frameBuffer;
-		uint8_t		frameLock;		
-		uint32_t	lastUse;
-
-}vidCacheEntry;
-/**
-    \class VideoCache
-*/
-class VideoCache
-{
-	private:
-		vidCacheEntry	    *entry;
-		uint32_t	        counter;
-		uint32_t 	        nbEntry;
-		FilterInfo           info;
-		ADM_coreVideoFilter *incoming;
-		
-		
-		int32_t 	        searchFrame( uint32_t frame);
-		int32_t 	        searchPtr( ADMImage *ptr);
-		
-	public:
-		VideoCache(uint32_t nb,ADM_coreVideoFilter *in);
-		~VideoCache(void);
-		
-		ADMImage *getImage(uint32_t frame);
-		uint8_t unlockAll(void);
-		uint8_t unlock(ADMImage  *frame);
-		uint8_t purge(void);
-};
-#endif

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_videoFilterCache.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_videoFilterCache.cpp	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_videoFilterCache.cpp	2010-03-05 06:18:44 UTC (rev 5974)
@@ -1,154 +0,0 @@
-/** *************************************************************************
-        \file                  ADM_videoFilterCache.cpp
-        \brief Cache/buffer for video filter
-		\author (c) 2008/2010 Mean, <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
-
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include &quot;ADM_default.h&quot;
-#include &quot;ADM_videoFilterCache.h&quot;
-
-#if 1
-#define aprintf(...) {}
-#else
-#define aprintf printf
-#endif
-
-VideoCache::VideoCache(uint32_t nb,ADM_coreVideoFilter *in)
-{
-uint32_t sz;
-	nbEntry=nb;
-	incoming=in;
-	memcpy(&amp;info,in-&gt;getInfo(),sizeof(info));
-	// Ready buffers
-	entry=new vidCacheEntry[nbEntry];
-	sz=(info.width*info.height*3)&gt;&gt;1;
-	for(uint32_t i=0;i&lt;nbEntry;i++)
-	{
-		entry[i].frameBuffer	=new ADMImage(info.width,info.height);	
-		entry[i].frameNum	=0xffff0000;
-		entry[i].frameLock	=0;
-	}	
-	counter=0;
-}
-//_____________________________________________
-VideoCache::~ VideoCache()
-{
-	for(uint32_t i=0;i&lt;nbEntry;i++)
-	{
-		delete  entry[i].frameBuffer;
-	}
-	delete [] entry;
-	
-}
-//_____________________________________________
-int32_t VideoCache::searchFrame( uint32_t frame)
-{
-	for(uint32_t i=0;i&lt;nbEntry;i++)
-	{
-		if(entry[i].frameNum==frame) return i;
-	}
-	return -1;
-}
-//_____________________________________________
-int32_t 	 VideoCache::searchPtr( ADMImage *ptr)
-{
-	for(uint32_t i=0;i&lt;nbEntry;i++)
-	{
-		if(entry[i].frameBuffer==ptr) return i;
-	}
-	return -1;
-}
-//_____________________________________________
-uint8_t  VideoCache::unlockAll(void)
-{
-	for(uint32_t i=0;i&lt;nbEntry;i++)
-	{		
-		entry[i].frameLock=0;		
-	}
-	return 1;
-}
-//_____________________________________________
-uint8_t  VideoCache::unlock(ADMImage *frame)
-{
-int32_t k;
-	k=searchPtr(frame) ;
-	ADM_assert(k&gt;=0);
-	entry[k].frameLock--;	
-	return 1;	
-}
-//_____________________________________________
-uint8_t  VideoCache::purge(void)
-{
-	for(uint32_t i=0;i&lt;nbEntry;i++)
-	{		
-		entry[i].frameLock=0;
-		entry[i].frameNum=0xffff0000;	
-		entry[i].lastUse=0xffff0000;	
-	}
-	return 1;
-
-}
-/**
-    \fn getImage
-*/
-ADMImage *VideoCache::getImage(uint32_t frame)
-{
-int32_t i;
-uint32_t tryz=nbEntry;
-uint32_t len,flags;
-ADMImage *ptr=NULL;
-
-	// Already there ?
-	if((i=searchFrame(frame))&gt;=0)
-	{
-		aprintf(&quot;Cache : Cache hit %d buffer %d\n&quot;,frame,i);
-		entry[i].frameLock++;
-		entry[i].lastUse=counter;
-		counter++;
-		return entry[i].frameBuffer;	
-	}
-	// Else get it!
-	
-	// First elect a new buffer, we do it by 
-	// using a RLU scheme
-	
-	uint32_t deltamax=0,delta;
-	uint32_t target=0xfff;
-	aprintf(&quot;Cache : Cache miss %d\n&quot;,frame);
-	//for(uint32_t i=0;i&lt;nbEntry;i++) printf(&quot;%d(%d) &quot;,frameNum[i],frameLock[i]);printf(&quot;\n&quot;);
-	for(uint32_t i=0;i&lt;nbEntry;i++)
-	{
-		if(entry[i].frameLock) continue; 	// don&quot;t consider locked frames
-		
-		
-		delta=abs((int)counter-(int)entry[i].lastUse);
-		if(delta&gt;deltamax)
-		{
-			deltamax=delta;
-			target=i;
-		}
-	}
-	ADM_assert(target!=0xfff);
-	// Target is the new cache we will use
-
-	ptr=entry[target].frameBuffer;
-    if(!incoming-&gt;getNextFrame(entry[target].frameBuffer)) return NULL;
-	// Update LRU info
-	entry[target].frameLock++;
-	entry[target].frameNum=frame;
-	entry[target].lastUse=counter;
-	counter++;	
-	return ptr;
-	
-}
-// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/CMakeLists.txt	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/CMakeLists.txt	2010-03-05 06:18:44 UTC (rev 5974)
@@ -1,6 +1,5 @@
 SET(ADM_coreImage_SRCS 
 #        ADM_videoFilter.cpp  
-        ADM_videoFilterCache.cpp
         ADM_image.cpp  
         ADM_imageUtils.cpp
         ADM_imageResizer.cpp

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilter.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilter.h	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_coreVideoFilter.h	2010-03-05 06:18:44 UTC (rev 5974)
@@ -18,6 +18,7 @@
 
 #include &quot;ADM_confCouple.h&quot;
 #include &quot;ADM_image.h&quot;
+#include &quot;ADM_videoFilterCache.h&quot;
 /**
     \struct FilterInfo
     \brief Describes the video stream at this point in the filter chain
@@ -38,20 +39,21 @@
 {
 protected:
             FilterInfo           info;
-            uint32_t             nextFrame;
+            uint32_t             nextFrame; // next frame to fetch, it is reset to 0 after a seek!
+            VideoCache           *vidCache;
 public:
             ADM_coreVideoFilter(ADM_coreVideoFilter *previous,CONFcouple *conf=NULL);
             ~ADM_coreVideoFilter();
 
        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
        virtual bool         goToTime(uint64_t usSeek);              
-       virtual bool         getNextFrame(ADMImage *image)=0;              /// Dont mix getFrame &amp; getNextFrame !
-	   virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
-	   virtual bool         getCoupledConf(CONFcouple **couples)=0 ;   /// Return the current filter configuration
+       virtual bool         getNextFrame(uint32_t *frameNumber,ADMImage *image)=0;              /// Dont mix getFrame &amp; getNextFrame !
+       virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
+       virtual bool         getCoupledConf(CONFcouple **couples)=0 ;   /// Return the current filter configuration
        virtual bool         configure(void) {return true;}             /// Start graphical user interface
 protected:
             ADM_coreVideoFilter *previousFilter;
 };
 
 #endif
-// EOF
\ No newline at end of file
+// EOF

Copied: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_videoFilterCache.h (from rev 5973, branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_videoFilterCache.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_videoFilterCache.h	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/include/ADM_videoFilterCache.h	2010-03-05 06:18:44 UTC (rev 5974)
@@ -0,0 +1,52 @@
+//
+// C++ Interface: ADM_cache
+//
+// Description: 
+//
+//
+// Author: mean &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>&gt;, (C) 2004
+//
+// Copyright: See COPYING file that comes with this distribution
+//
+//
+
+#ifndef __ADM_CACHE__
+#define __ADM_CACHE__
+class ADM_coreVideoFilter;
+#include &quot;ADM_image.h&quot;
+/**
+    \struct videoCacheEntry
+*/
+typedef struct vidCacheEntry
+{
+		uint32_t 	frameNum;
+		ADMImage 	*frameBuffer;
+		uint8_t		frameLock;		
+		uint32_t	lastUse;
+
+}vidCacheEntry;
+/**
+    \class VideoCache
+*/
+class VideoCache
+{
+	private:
+		vidCacheEntry	        *entry;
+		uint32_t	        counter;
+		uint32_t 	        nbEntry;
+		ADM_coreVideoFilter     *incoming;
+		
+		
+		int32_t 	        searchFrame( uint32_t frame);
+		int32_t 	        searchPtr( ADMImage *ptr);
+		
+	public:
+		VideoCache(uint32_t nb,ADM_coreVideoFilter *in);
+		~VideoCache(void);
+		
+		ADMImage *getImage(uint32_t frame);
+		uint8_t unlockAll(void);
+		uint8_t unlock(ADMImage  *frame);
+		uint8_t flush(void);
+};
+#endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_coreVideoFilter.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_coreVideoFilter.cpp	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_coreVideoFilter.cpp	2010-03-05 06:18:44 UTC (rev 5974)
@@ -38,6 +38,7 @@
 {
     previousFilter=previous;
     nextFrame=0;
+    vidCache=NULL;
     if(previous) memcpy(&amp;info,previous-&gt;getInfo(),sizeof(info));
 }
 /**
@@ -45,7 +46,8 @@
 */
  ADM_coreVideoFilter:: ~ADM_coreVideoFilter()
 {
-
+        if(vidCache) delete vidCache;
+        vidCache=NULL;
 }
 /**
     \fn getConfiguration
@@ -77,6 +79,8 @@
     float newSeek=usSeek;
     newSeek/=thisIncrement;
     newSeek*=oldIncrement;
+    if(vidCache) vidCache-&gt;flush();
+    nextFrame=0;
     return  previousFilter-&gt;goToTime((uint64_t)newSeek);
 
 }

Copied: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_videoFilterCache.cpp (from rev 5973, branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_videoFilterCache.cpp)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_videoFilterCache.cpp	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/ADM_videoFilterCache.cpp	2010-03-05 06:18:44 UTC (rev 5974)
@@ -0,0 +1,158 @@
+/** *************************************************************************
+        \file                  ADM_videoFilterCache.cpp
+        \brief Cache/buffer for video filter
+		\author (c) 2008/2010 Mean, <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include &quot;ADM_default.h&quot;
+#include &quot;ADM_videoFilterCache.h&quot;
+#include &quot;ADM_coreVideoFilter.h&quot;
+#if 1
+#define aprintf(...) {}
+#else
+#define aprintf printf
+#endif
+
+VideoCache::VideoCache(uint32_t nb,ADM_coreVideoFilter *in)
+{
+uint32_t sz;
+	nbEntry=nb;
+	incoming=in;
+	// Ready buffers
+	entry=new vidCacheEntry[nbEntry];
+        uint32_t w=in-&gt;getInfo()-&gt;width;
+        uint32_t h=in-&gt;getInfo()-&gt;height;
+
+	sz=(w*h*3)&gt;&gt;1;
+	for(uint32_t i=0;i&lt;nbEntry;i++)
+	{
+		entry[i].frameBuffer	=new ADMImage(w,h);	
+		entry[i].frameNum	=0xffff0000;
+		entry[i].frameLock	=0;
+	}	
+	counter=0;
+}
+//_____________________________________________
+VideoCache::~ VideoCache()
+{
+	for(uint32_t i=0;i&lt;nbEntry;i++)
+	{
+		delete  entry[i].frameBuffer;
+	}
+	delete [] entry;
+	
+}
+//_____________________________________________
+int32_t VideoCache::searchFrame( uint32_t frame)
+{
+	for(uint32_t i=0;i&lt;nbEntry;i++)
+	{
+		if(entry[i].frameNum==frame) return i;
+	}
+	return -1;
+}
+//_____________________________________________
+int32_t 	 VideoCache::searchPtr( ADMImage *ptr)
+{
+	for(uint32_t i=0;i&lt;nbEntry;i++)
+	{
+		if(entry[i].frameBuffer==ptr) return i;
+	}
+	return -1;
+}
+//_____________________________________________
+uint8_t  VideoCache::unlockAll(void)
+{
+	for(uint32_t i=0;i&lt;nbEntry;i++)
+	{		
+		entry[i].frameLock=0;		
+	}
+	return 1;
+}
+//_____________________________________________
+uint8_t  VideoCache::unlock(ADMImage *frame)
+{
+int32_t k;
+	k=searchPtr(frame) ;
+	ADM_assert(k&gt;=0);
+	entry[k].frameLock--;	
+	return 1;	
+}
+//_____________________________________________
+uint8_t  VideoCache::flush(void)
+{
+	for(uint32_t i=0;i&lt;nbEntry;i++)
+	{		
+		entry[i].frameLock=0;
+		entry[i].frameNum=0xffff0000;	
+		entry[i].lastUse=0xffff0000;	
+	}
+	return 1;
+
+}
+/**
+    \fn getImage
+*/
+ADMImage *VideoCache::getImage(uint32_t frame)
+{
+int32_t i;
+uint32_t tryz=nbEntry;
+uint32_t len,flags;
+ADMImage *ptr=NULL;
+
+	// Already there ?
+	if((i=searchFrame(frame))&gt;=0)
+	{
+		aprintf(&quot;Cache : Cache hit %d buffer %d\n&quot;,frame,i);
+		entry[i].frameLock++;
+		entry[i].lastUse=counter;
+		counter++;
+		return entry[i].frameBuffer;	
+	}
+	// Else get it!
+	
+	// First elect a new buffer, we do it by 
+	// using a RLU scheme
+	
+	uint32_t deltamax=0,delta;
+	uint32_t target=0xfff;
+	aprintf(&quot;Cache : Cache miss %d\n&quot;,frame);
+	//for(uint32_t i=0;i&lt;nbEntry;i++) printf(&quot;%d(%d) &quot;,frameNum[i],frameLock[i]);printf(&quot;\n&quot;);
+	for(uint32_t i=0;i&lt;nbEntry;i++)
+	{
+		if(entry[i].frameLock) continue; 	// don&quot;t consider locked frames
+		
+		
+		delta=abs((int)counter-(int)entry[i].lastUse);
+		if(delta&gt;deltamax)
+		{
+			deltamax=delta;
+			target=i;
+		}
+	}
+	ADM_assert(target!=0xfff);
+	// Target is the new cache we will use
+
+	ptr=entry[target].frameBuffer;
+        uint32_t nb;
+        if(!incoming-&gt;getNextFrame(&amp;nb,entry[target].frameBuffer)) return NULL;
+        ADM_assert(nb==frame);
+	// Update LRU info
+	entry[target].frameLock++;
+	entry[target].frameNum=nb;
+	entry[target].lastUse=counter;
+	counter++;	
+	return ptr;
+	
+}
+// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/CMakeLists.txt	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/CMakeLists.txt	2010-03-05 06:18:44 UTC (rev 5974)
@@ -1,6 +1,7 @@
 SET(ADM_CoreVideoFilter_SRCS 
 	ADM_coreVideoFilter.cpp
         DIA_flyDialog.cpp
+        ADM_videoFilterCache.cpp
 )
 
 ADD_LIBRARY(ADM_coreVideoFilter6 SHARED ${ADM_CoreVideoFilter_SRCS})

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoFilter/src/DIA_flyDialog.cpp	2010-03-05 06:18:44 UTC (rev 5974)
@@ -221,6 +221,7 @@
 uint8_t    ADM_flyDialog::sliderChanged(void)
 {
   uint32_t fn= sliderGet();
+  uint32_t frameNumber;
   uint32_t len,flags;
   
     ADM_assert(_yuvBuffer);
@@ -233,7 +234,7 @@
     time/=ADM_FLY_SLIDER_MAX;
     time*=_in-&gt;getInfo()-&gt;totalDuration;
     _in-&gt;goToTime(time);
-    if(!_in-&gt;getNextFrame(_yuvBuffer))
+    if(!_in-&gt;getNextFrame(&amp;frameNumber,_yuvBuffer))
     {
       ADM_warning(&quot;[FlyDialog] Cannot get frame %u\n&quot;,fn); 
       return 0;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/null/nullEncoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/null/nullEncoder.cpp	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/null/nullEncoder.cpp	2010-03-05 06:18:44 UTC (rev 5974)
@@ -55,7 +55,8 @@
 */
 bool         ADM_nullEncoder::encode (ADMBitstream * out)
 {
-    if(source-&gt;getNextFrame(image)==false)
+    uint32_t fn;
+    if(source-&gt;getNextFrame(&amp;fn,image)==false)
     {
         printf(&quot;[null] Cannot get next image\n&quot;);
         return false;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/png/ADM_pngEncoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/png/ADM_pngEncoder.cpp	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/png/ADM_pngEncoder.cpp	2010-03-05 06:18:44 UTC (rev 5974)
@@ -45,7 +45,8 @@
 */
 bool         ADM_pngEncoder::encode (ADMBitstream * out)
 {
-    if(source-&gt;getNextFrame(image)==false)
+    uint32_t fn;
+    if(source-&gt;getNextFrame(&amp;fn,image)==false)
     {
         printf(&quot;[YV12] Cannot get next image\n&quot;);
         return false;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/yv12/ADM_yv12Encoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/yv12/ADM_yv12Encoder.cpp	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/yv12/ADM_yv12Encoder.cpp	2010-03-05 06:18:44 UTC (rev 5974)
@@ -45,7 +45,8 @@
 */
 bool         ADM_yv12Encoder::encode (ADMBitstream * out)
 {
-    if(source-&gt;getNextFrame(image)==false)
+    uint32_t fn;
+    if(source-&gt;getNextFrame(&amp;fn,image)==false)
     {
         printf(&quot;[YV12] Cannot get next image\n&quot;);
         return false;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/dummy/dummyVideoFilter.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/dummy/dummyVideoFilter.cpp	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/dummy/dummyVideoFilter.cpp	2010-03-05 06:18:44 UTC (rev 5974)
@@ -27,11 +27,11 @@
                     dummyVideoFilter(ADM_coreVideoFilter *previous,CONFcouple *conf);
                     ~dummyVideoFilter();
 
-       virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
-       virtual bool         getNextFrame(ADMImage *image);    /// Return the next image
+        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *frameNumner,ADMImage *image);    /// Return the next image
 	 //  virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
-	   virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
-       virtual bool         configure(void) {return true;}             /// Start graphical user interface
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) {return true;}             /// Start graphical user interface
 };
 
 // Add the hook to make it valid plugin
@@ -68,10 +68,10 @@
     \fn getFrame
     \brief Get a processed frame
 */
-bool dummyVideoFilter::getNextFrame(ADMImage *image)
+bool dummyVideoFilter::getNextFrame(uint32_t *fn,ADMImage *image)
 {
     // since we do nothing, just get the output of previous filter
-    return previousFilter-&gt;getNextFrame(image);
+    return previousFilter-&gt;getNextFrame(fn,image);
 }
 /**
     \fn getCoupledConf
@@ -92,4 +92,4 @@
     return &quot;Dummy Filter.&quot;;
 }
 // Normally not needed :virtual FilterInfo  *getInfo(void)
-//EOF
\ No newline at end of file
+//EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/verticalFlip/verticalFlip.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/verticalFlip/verticalFlip.cpp	2010-03-05 06:18:35 UTC (rev 5973)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/verticalFlip/verticalFlip.cpp	2010-03-05 06:18:44 UTC (rev 5974)
@@ -27,11 +27,11 @@
                     verticalFlipFilter(ADM_coreVideoFilter *previous,CONFcouple *conf);
                     ~verticalFlipFilter();
 
-       virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
-       virtual bool         getNextFrame(ADMImage *image);    /// Return the next image
+        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
 	 //  virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
-	   virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
-       virtual bool         configure(void) {return true;}             /// Start graphical user interface
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) {return true;}             /// Start graphical user interface
 };
 
 // Add the hook to make it valid plugin
@@ -82,10 +82,10 @@
     \fn getFrame
     \brief Get a processed frame
 */
-bool verticalFlipFilter::getNextFrame(ADMImage *image)
+bool verticalFlipFilter::getNextFrame(uint32_t *fn,ADMImage *image)
 {
     // since we do nothing, just get the output of previous filter
-    if(false==previousFilter-&gt;getNextFrame(image))
+    if(false==previousFilter-&gt;getNextFrame(fn,image))
     {
         ADM_warning(&quot;FlipFilter : Cannot get frame\n&quot;);
         return false;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003178.html">[Avidemux-svn-commit] r5973 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/yadif
</A></li>
	<LI>Next message: <A HREF="003180.html">[Avidemux-svn-commit] r5975 -	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3179">[ date ]</a>
              <a href="thread.html#3179">[ thread ]</a>
              <a href="subject.html#3179">[ subject ]</a>
              <a href="author.html#3179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
