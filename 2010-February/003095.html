<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r5890 - in branches/avidemux_2.6_branch_mean:	avidemux_core/ADM_coreMuxer/src	avidemux_core/ADM_coreVideoEncoder/src	avidemux_plugins/ADM_audioEncoders/lavcodec
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2010-February/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r5890%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux_core/ADM_coreMuxer/src%0A%09avidemux_core/ADM_coreVideoEncoder/src%0A%09avidemux_plugins/ADM_audioEncoders/lavcodec&In-Reply-To=%3C201002040642.o146gExg007950%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003094.html">
   <LINK REL="Next"  HREF="003096.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r5890 - in branches/avidemux_2.6_branch_mean:	avidemux_core/ADM_coreMuxer/src	avidemux_core/ADM_coreVideoEncoder/src	avidemux_plugins/ADM_audioEncoders/lavcodec</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r5890%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux_core/ADM_coreMuxer/src%0A%09avidemux_core/ADM_coreVideoEncoder/src%0A%09avidemux_plugins/ADM_audioEncoders/lavcodec&In-Reply-To=%3C201002040642.o146gExg007950%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r5890 - in branches/avidemux_2.6_branch_mean:	avidemux_core/ADM_coreMuxer/src	avidemux_core/ADM_coreVideoEncoder/src	avidemux_plugins/ADM_audioEncoders/lavcodec">mean at mail.berlios.de
       </A><BR>
    <I>Thu Feb  4 07:42:14 CET 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="003094.html">[Avidemux-svn-commit] r5889 - in branches/avidemux_2.6_branch_mean: avidemux/common avidemux/common/ADM_audioFilter/src avidemux/common/ADM_videoEncoder/include avidemux/common/ADM_videoEncoder/src avidemux_core/ADM_coreAudioEncoder/include avidemux_core/ADM_coreAudioFilter/include avidemux_core/ADM_coreMuxer/include avidemux_core/ADM_coreVideoEncoder/include avidemux_core/ADM_coreVideoEncoder/src avidemux_plugins/ADM_audioEncoders/aften avidemux_plugins/ADM_audioEncoders/faac avidemux_plugins/ADM_audioEncoders/lame avidemux_plugins/ADM_audioEncoders/lavcodec avidemux_plugins/ADM_audioEncoders/pcm avidemux_plugins/ADM_audioEncoders/twolame avidemux_plugins/ADM_audioEncoders/vorbis avidemux_plugins/ADM_muxers/muxerMp4 avidemux_plugins/ADM_videoEncoder/ffFlv1 avidemux_plugins/ADM_videoEncoder/ffMpeg4 avidemux_plugins/ADM_videoEncoder/ffMsMpeg4 avidemux_plugins/ADM_videoEncoder/huff avidemux_plugins/ADM_videoEncoder/jpeg avidemux_plugins/ADM_videoEncoder/png avidemux_plugins/ADM_videoEncode! r/yv12
</A></li>
        <LI>Next message: <A HREF="003096.html">[Avidemux-svn-commit] r5891 -	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3095">[ date ]</a>
              <a href="thread.html#3095">[ thread ]</a>
              <a href="subject.html#3095">[ subject ]</a>
              <a href="author.html#3095">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2010-02-04 07:42:13 +0100 (Thu, 04 Feb 2010)
New Revision: 5890

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/ADM_lav_aac.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
Log:
[encoder] Activate global header, incomplete

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-04 06:42:04 UTC (rev 5889)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2010-02-04 06:42:13 UTC (rev 5890)
@@ -134,6 +134,7 @@
         c-&gt;width = stream-&gt;getWidth();
         c-&gt;height =stream-&gt;getHeight();
         uint32_t fcc=stream-&gt;getFCC();
+        
         if(isMpeg4Compatible(fcc))
         {
                 c-&gt;codec_id = CODEC_ID_MPEG4;
@@ -216,8 +217,18 @@
                         }
                 }
         }
+        if(useGlobalHeader()==true)
+        {
+            if(videoExtraDataSize)
+            {
+                ADM_info(&quot;Video has extradata and muxer requires globalHeader, assuming it is done so.\n&quot;);
+                c-&gt;flags|=CODEC_FLAG_GLOBAL_HEADER;
+            }else       
+            {
+                ADM_warning(&quot;Video has no extradata but muxer requires globalHeader.\n&quot;);
+            }
+        }
 
-
         printf(&quot;[FF] Video initialized\n&quot;);
 
     return true;
@@ -287,7 +298,17 @@
           c-&gt;bit_rate = audioheader-&gt;byterate*8;
           c-&gt;rc_buffer_size=(c-&gt;bit_rate/(2*8)); // 500 ms worth
           c-&gt;channels = audioheader-&gt;channels;
-
+          if(useGlobalHeader()==true)
+          {
+            if(audioextraSize)
+            {
+                ADM_info(&quot;Audio has extradata and muxer requires globalHeader, assuming it is done so.\n&quot;);
+                c-&gt;flags|=CODEC_FLAG_GLOBAL_HEADER;
+            }else       
+            {
+                ADM_warning(&quot;Audio has no extradata but muxer requires globalHeader.\n&quot;);
+            }
+          }
         }
         printf(&quot;[FF] Audio initialized\n&quot;);
         return true;

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-04 06:42:04 UTC (rev 5889)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2010-02-04 06:42:13 UTC (rev 5890)
@@ -115,6 +115,11 @@
     _isMT=false;
     encoderDelay=source-&gt;getInfo()-&gt;frameIncrement*LAVS(max_b_frames);
     ADM_info(&quot;[Lavcodec] Using a video encoder delay of %d ms\n&quot;,(int)(encoderDelay/1000));
+    if(_globalHeader)
+    {
+                ADM_info(&quot;Codec configured to use global header\n&quot;);
+                _context-&gt;flags|=CODEC_FLAG_GLOBAL_HEADER;
+    }
 }
 /**
     \fn ADM_coreVideoEncoderFFmpeg

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/ADM_lav_aac.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/ADM_lav_aac.h	2010-02-04 06:42:04 UTC (rev 5889)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/ADM_lav_aac.h	2010-02-04 06:42:13 UTC (rev 5890)
@@ -8,3 +8,5 @@
 #define ADM_LAV_MAX_CHANNEL 6
 #define ADM_LAV_SAMPLE_PER_P 1024
 
+#define ADM_LAV_GLOBAL_HEADER 1
+

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2010-02-04 06:42:04 UTC (rev 5889)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2010-02-04 06:42:13 UTC (rev 5890)
@@ -73,6 +73,12 @@
   _context=NULL;
   _globalHeader=globalHeader;
    printf(&quot;[Lavcodec] Creating Lavcodec audio encoder (0x%x)\n&quot;,makeName(WAV));
+#if defined(ADM_LAV_GLOBAL_HEADER) // Only AAC ?
+    if(globalHeader)
+        _globalHeader=true;
+    else
+#endif
+    _globalHeader=false;
 
   wavheader.encoding=makeName(WAV);
   
@@ -110,15 +116,21 @@
   }
   wavheader.byterate=(lavBitrate*1000)&gt;&gt;3;         
       
-    _chunk = ADM_LAV_SAMPLE_PER_P*wavheader.channels; // AC3
+  _chunk = ADM_LAV_SAMPLE_PER_P*wavheader.channels; // AC3
   printf(&quot;[Lavcodec]Incoming : fq : %&quot;LU&quot;, channel : %&quot;LU&quot; bitrate: %&quot;LU&quot; \n&quot;,
-         wavheader.frequency,wavheader.channels,lavBitrate);
+  wavheader.frequency,wavheader.channels,lavBitrate);
   
   
   CONTEXT-&gt;channels     =  wavheader.channels;
   CONTEXT-&gt;sample_rate  =  wavheader.frequency;
   CONTEXT-&gt;bit_rate     = (lavBitrate*1000); // bits -&gt; kbits
 
+  if(true==_globalHeader)
+  {
+    ADM_info(&quot;Configuring audio codec to use global headers\n&quot;);
+    CONTEXT-&gt;flags|=CODEC_FLAG_GLOBAL_HEADER;
+  }
+
   AVCodec *codec;
   CodecID codecID;
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003094.html">[Avidemux-svn-commit] r5889 - in branches/avidemux_2.6_branch_mean: avidemux/common avidemux/common/ADM_audioFilter/src avidemux/common/ADM_videoEncoder/include avidemux/common/ADM_videoEncoder/src avidemux_core/ADM_coreAudioEncoder/include avidemux_core/ADM_coreAudioFilter/include avidemux_core/ADM_coreMuxer/include avidemux_core/ADM_coreVideoEncoder/include avidemux_core/ADM_coreVideoEncoder/src avidemux_plugins/ADM_audioEncoders/aften avidemux_plugins/ADM_audioEncoders/faac avidemux_plugins/ADM_audioEncoders/lame avidemux_plugins/ADM_audioEncoders/lavcodec avidemux_plugins/ADM_audioEncoders/pcm avidemux_plugins/ADM_audioEncoders/twolame avidemux_plugins/ADM_audioEncoders/vorbis avidemux_plugins/ADM_muxers/muxerMp4 avidemux_plugins/ADM_videoEncoder/ffFlv1 avidemux_plugins/ADM_videoEncoder/ffMpeg4 avidemux_plugins/ADM_videoEncoder/ffMsMpeg4 avidemux_plugins/ADM_videoEncoder/huff avidemux_plugins/ADM_videoEncoder/jpeg avidemux_plugins/ADM_videoEncoder/png avidemux_plugins/ADM_videoEncode! r/yv12
</A></li>
	<LI>Next message: <A HREF="003096.html">[Avidemux-svn-commit] r5891 -	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3095">[ date ]</a>
              <a href="thread.html#3095">[ thread ]</a>
              <a href="subject.html#3095">[ subject ]</a>
              <a href="author.html#3095">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
