<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r6914 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_audioFilter/include	avidemux/common/ADM_audioFilter/src avidemux/common/ADM_editor	avidemux/common/ADM_script2/binding	avidemux/common/ADM_script2/include avidemux/common/ADM_script2/py	avidemux/common/ADM_script2/src	avidemux_core/ADM_coreAudioFilter/include
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2011-January/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6914%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common/ADM_audioFilter/include%0A%09avidemux/common/ADM_audioFilter/src%20avidemux/common/ADM_editor%0A%09avidemux/common/ADM_script2/binding%0A%09avidemux/common/ADM_script2/include%20avidemux/common/ADM_script2/py%0A%09avidemux/common/ADM_script2/src%0A%09avidemux_core/ADM_coreAudioFilter/include&In-Reply-To=%3C20110106065418.322C6480402%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004088.html">
   <LINK REL="Next"  HREF="004090.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r6914 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_audioFilter/include	avidemux/common/ADM_audioFilter/src avidemux/common/ADM_editor	avidemux/common/ADM_script2/binding	avidemux/common/ADM_script2/include avidemux/common/ADM_script2/py	avidemux/common/ADM_script2/src	avidemux_core/ADM_coreAudioFilter/include</H1>
    <B>mean at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6914%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common/ADM_audioFilter/include%0A%09avidemux/common/ADM_audioFilter/src%20avidemux/common/ADM_editor%0A%09avidemux/common/ADM_script2/binding%0A%09avidemux/common/ADM_script2/include%20avidemux/common/ADM_script2/py%0A%09avidemux/common/ADM_script2/src%0A%09avidemux_core/ADM_coreAudioFilter/include&In-Reply-To=%3C20110106065418.322C6480402%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r6914 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_audioFilter/include	avidemux/common/ADM_audioFilter/src avidemux/common/ADM_editor	avidemux/common/ADM_script2/binding	avidemux/common/ADM_script2/include avidemux/common/ADM_script2/py	avidemux/common/ADM_script2/src	avidemux_core/ADM_coreAudioFilter/include">mean at mail.berlios.de
       </A><BR>
    <I>Thu Jan  6 07:54:18 CET 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004088.html">[Avidemux-svn-commit] r6913 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec
</A></li>
        <LI>Next message: <A HREF="004090.html">[Avidemux-svn-commit] r6915 - in	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2:	binding py
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4089">[ date ]</a>
              <a href="thread.html#4089">[ thread ]</a>
              <a href="subject.html#4089">[ subject ]</a>
              <a href="author.html#4089">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2011-01-06 07:54:18 +0100 (Thu, 06 Jan 2011)
New Revision: 6914

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/include/ADM_audioFilterInterface.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_interface.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_normalize.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edPySave.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/binding/adm.admPyClass
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptCommon.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptAudio.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_normalize_param.h
Log:
[audiofilter] Bind normalize, +UI, still incomplete

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/include/ADM_audioFilterInterface.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/include/ADM_audioFilterInterface.h	2011-01-06 06:54:16 UTC (rev 6913)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/include/ADM_audioFilterInterface.h	2011-01-06 06:54:18 UTC (rev 6914)
@@ -19,18 +19,18 @@
 #define ADM_audioFilterInterface_H
 
 #include &quot;ADM_audiodef.h&quot;
-
+#include &quot;audiofilter_normalize_param.h&quot;
 /* Filter part */
 bool            audioFilterReset(void);
 
 bool            audioFilterSetResample(uint32_t newfq);  // Set 0 to disable frequency
 bool            audioFilterSetFrameRate(FILMCONV conf);
 bool            audioFilterSetMixer(CHANNEL_CONF conf); // Invalid to disable
-
+bool            audioFilterSetNormalize( ADM_GAINMode mode,uint32_t gain);
 uint32_t        audioFilterGetResample(void);  // Set 0 to disable frequency
 FILMCONV        audioFilterGetFrameRate(void);
 CHANNEL_CONF    audioFilterGetMixer(void); // Invalid to disable
-
+bool            audioFilterGetNormalize( ADM_GAINMode *mode,uint32_t *gain);
 bool            audioFilterConfigure(void);
 
 /* Encoder part */

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_interface.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_interface.cpp	2011-01-06 06:54:16 UTC (rev 6913)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_interface.cpp	2011-01-06 06:54:18 UTC (rev 6914)
@@ -87,8 +87,40 @@
 {
     return audioEncodingConfig.film2pal;
 }
+/**
+    \fn audioFilterSetNormalize
+    \brief 
+*/
+bool            audioFilterSetNormalize( ADM_GAINMode mode,uint32_t gain)
+{
+    if(mode&gt;=ADM_GAIN_MAX)
+    {
+        ADM_error(&quot;incorrect mode value for normalize&quot;);
+        return false;
+    }
+    if(!gain)
+    {
+        ADM_error(&quot;gain cannot be null&quot;);
+        return false;
+    }
 
+    audioEncodingConfig.gainParam.mode=mode;
+    audioEncodingConfig.gainParam.gain10=gain;
+    return true;
+}
 /**
+    \fn audioFilterSetNormalize
+    \brief 
+*/
+bool            audioFilterGetNormalize( ADM_GAINMode *mode,uint32_t *gain)
+{
+
+    *mode=audioEncodingConfig.gainParam.mode;
+    *gain=audioEncodingConfig.gainParam.gain10;
+    return true;
+}
+
+/**
     \fn audioFilterSetMixer
     \brief
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_normalize.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_normalize.cpp	2011-01-06 06:54:16 UTC (rev 6913)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audioFilter/src/audiofilter_normalize.cpp	2011-01-06 06:54:18 UTC (rev 6914)
@@ -20,19 +20,16 @@
  ***************************************************************************/
 
 
-#include &lt;math.h&gt;
 
 #include &quot;ADM_default.h&quot;
+#include &lt;math.h&gt;
 #include &quot;ADM_audioFilter.h&quot;
 #include &quot;audiofilter_normalize_param.h&quot;
 #include &quot;audiofilter_normalize.h&quot;
 #include &quot;audiofilter_dolby.h&quot;
 
 #include &quot;ADM_coreAudio.h&quot;
-//#include &quot;ADM_dialog/DIA_busy.h&quot; //CANNOT USE IT! We are in another thread!
 
-//extern AVDMGenericAudioStream *currentaudiostream;
-
 #ifdef __WIN32
 #define POW10(x)   pow(10,x)
 #elif defined(ADM_BSD_FAMILY)
@@ -44,8 +41,9 @@
 #define LINEAR_TO_DB(x) (20.*log10(x))
 #define DB_TO_LINEAR(x) (POW10((x/20.)))
 
-// Ctor
-//__________
+/**
+        \fn Ctor
+**/
 
 AUDMAudioFilterNormalize::AUDMAudioFilterNormalize(AUDMAudioFilter * instream,GAINparam *param):AUDMAudioFilter (instream)
 {
@@ -53,26 +51,33 @@
     // nothing special here...
   switch(param-&gt;mode)
   {
-    case ADM_NO_GAIN: _ratio=1;_scanned=1;printf(&quot;[Gain] Gain of 1.0\n&quot;);break; 
-    case ADM_GAIN_AUTOMATIC: _ratio=1;_scanned=0;printf(&quot;[Gain] Automatic gain\n&quot;);break;
+    case ADM_NO_GAIN: _ratio=1;_scanned=1;ADM_info(&quot;[Gain] Gain of 1.0\n&quot;);break; 
+    case ADM_GAIN_AUTOMATIC: _ratio=1;_scanned=0;ADM_info(&quot;[Gain] Automatic gain\n&quot;);break;
     case ADM_GAIN_MANUAL: 
                 _scanned=1;
                 db_out =  param-&gt;gain10/10.0; // Dbout is in 10*DB (!)
                 _ratio = DB_TO_LINEAR(db_out);
-                printf(&quot;[Gain] %f db (p=%d)\n&quot;, (float)(param-&gt;gain10)/10.,param-&gt;gain10);
-                printf(&quot;[Gain] Linear ratio of : %03.3f\n&quot;, _ratio);
+                ADM_info(&quot;[Gain] %f db (p=%d)\n&quot;, (float)(param-&gt;gain10)/10.,param-&gt;gain10);
+                ADM_info(&quot;[Gain] Linear ratio of : %03.3f\n&quot;, _ratio);
+                break;
+    default:
+                ADM_error(&quot;Unknown normalize mode\n&quot;);
+                ADM_assert(0);
+                break;
   }
     _previous-&gt;rewind();
 };
-
+/**
+        \fn dtor
+*/
 AUDMAudioFilterNormalize::~AUDMAudioFilterNormalize()
 {
-
+        ADM_info(&quot;Destroying normalize audio filter\n&quot;);
 }
-//
-// For normalize, we scan the input stream
-// to check for maximum value
-//___________________________________________
+/**
+        \fn preprocess
+        \brief Search for max value to compute gain
+*/
 uint8_t AUDMAudioFilterNormalize::preprocess(void)
 {
 
@@ -86,7 +91,7 @@
     float *max=new float[_wavHeader.channels];
     _previous-&gt;rewind();
     DolbySkip(1);
-    printf(&quot;\n Seeking for maximum value, that can take a while\n&quot;);
+    ADM_info(&quot;Seeking for maximum value, that can take a while\n&quot;);
 
     llength=_length ;
     
@@ -103,7 +108,7 @@
             }
            else 
             {
-              printf(&quot;Unknown cause : %d\n&quot;,status);
+              ADM_error(&quot;Unknown cause : %d\n&quot;,status);
               ADM_assert(0); 
             }
           }
@@ -131,9 +136,9 @@
     for(int chan=0;chan&lt;_wavHeader.channels;chan++)
     {
         if(max[chan]&gt;mx) mx=max[chan];
-        printf(&quot;[Normalize] maximum found for channel %d : %f\n&quot;, chan,max[chan]);
+        ADM_info(&quot;[Normalize] maximum found for channel %d : %f\n&quot;, chan,max[chan]);
     }
-    printf(&quot;[Normalize] Using : %0.4f as max value \n&quot;, mx);
+    ADM_info(&quot;[Normalize] Using : %0.4f as max value \n&quot;, mx);
     double db_in, db_out=-3;
 
     if (mx&gt;0.001)
@@ -147,9 +152,9 @@
     _ratio=1;
 
     float db_delta=db_out-db_in;
-    printf(&quot;[Normalize]Gain %f dB\n&quot;,db_delta);
+    ADM_info(&quot;[Normalize]Gain %f dB\n&quot;,db_delta);
     _ratio = DB_TO_LINEAR(db_delta);
-    printf(&quot;\n Using ratio of : %f\n&quot;, _ratio);
+    ADM_info(&quot;\n Using ratio of : %f\n&quot;, _ratio);
 
     _scanned = 1;
     DolbySkip(0);
@@ -157,8 +162,10 @@
     delete [] max;
     return 1;
 }
-//
-//___________________________________________
+/**
+        \fn fill
+        \brief
+*/
 uint32_t AUDMAudioFilterNormalize::fill( uint32_t max, float * buffer,AUD_Status *status)
 {
     uint32_t rd, i, j,rd2;

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edPySave.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edPySave.cpp	2011-01-06 06:54:16 UTC (rev 6913)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edPySave.cpp	2011-01-06 06:54:18 UTC (rev 6914)
@@ -24,6 +24,7 @@
 #include &quot;ADM_editor/ADM_edit.hxx&quot;
 
 #include &quot;audioEncoderApi.h&quot;
+#include &quot;audiofilter_normalize_param.h&quot;
 #include &quot;DIA_coreToolkit.h&quot;
 #include &quot;ADM_editor/ADM_edit.hxx&quot;
 #include &quot;ADM_videoEncoderApi.h&quot;
@@ -203,7 +204,15 @@
                 case FILMCONV_FILM2PAL:  qfprintf(fd,&quot;adm.audioFilm2pal=1\n&quot;);break;
                 default:ADM_assert(0);
         }
-   
+   // --------- Normalize ----------------
+        ADM_GAINMode mode;
+        uint32_t gain;
+        audioFilterGetNormalize(&amp;mode,&amp;gain);
+        if(mode &amp;&amp; gain)
+        {
+            qfprintf(fd,&quot;adm.audioNormalizeMode=%d\n&quot;,(int)mode); 
+            qfprintf(fd,&quot;adm.audioNormalizeGain=%d\n&quot;,(int)gain); 
+        }
        
         
   

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/binding/adm.admPyClass
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/binding/adm.admPyClass	2011-01-06 06:54:16 UTC (rev 6913)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/binding/adm.admPyClass	2011-01-06 06:54:18 UTC (rev 6914)
@@ -42,5 +42,7 @@
 /* ATTRIBUTES */ double markerA:scriptSetMarkerA,scriptGetMarkerA
 /* ATTRIBUTES */ double markerB:scriptSetMarkerB,scriptGetMarkerB
 /* ATTRIBUTES */ int    audioResample:scriptSetResample,scriptGetResample
+/* ATTRIBUTES */ int    audioNormalizeMode:scriptSetNormalizeMode,scriptGetNormalizeMode
+/* ATTRIBUTES */ int    audioNormalizeValue:scriptSetNormalizeValue,scriptGetNormalizeValue
 /* ATTRIBUTES */ int    audioPal2film:scriptSetPal2film,scriptGetPal2film
 /* ATTRIBUTES */ int    audioFilm2pal:scriptSetFilm2pal,scriptGetFilm2pal

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptCommon.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptCommon.h	2011-01-06 06:54:16 UTC (rev 6913)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptCommon.h	2011-01-06 06:54:18 UTC (rev 6914)
@@ -24,6 +24,12 @@
 int scriptAddSegment(int ref, double start, double duration);
 int scriptAudioReset(void);
 int scriptAudioMixer(const char *s);
+// Normalize
+int scriptGetNormalizeMode(void);
+int scriptGetNormalizeValue(void);
+void scriptSetNormalizeMode(int v);
+void scriptSetNormalizeValue(int v);
+
 // Fq
 int32_t scriptGetResample(void);
 void    scriptSetResample(int32_t fq);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp	2011-01-06 06:54:16 UTC (rev 6913)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp	2011-01-06 06:54:18 UTC (rev 6914)
@@ -251,6 +251,14 @@
   {
      return tp_number(scriptGetResample());
   }
+  if (!strcmp(key, &quot;audioNormalizeValue&quot;))
+  {
+     return tp_number(scriptGetNormalizeValue());
+  }
+  if (!strcmp(key, &quot;audioNormalizeMode&quot;))
+  {
+     return tp_number(scriptGetNormalizeMode());
+  }
   if (!strcmp(key, &quot;markerA&quot;))
   {
      return tp_number(scriptGetMarkerA());
@@ -375,6 +383,18 @@
      scriptSetResample(val);
      return tp_None;
   }
+  if (!strcmp(key, &quot;audioNormalizeValue&quot;))
+  {
+     int val=pm.asInt();
+     scriptSetNormalizeValue(val);
+     return tp_None;
+  }
+  if (!strcmp(key, &quot;audioNormalizeMode&quot;))
+  {
+     int val=pm.asInt();
+     scriptSetNormalizeMode(val);
+     return tp_None;
+  }
   if (!strcmp(key, &quot;markerA&quot;))
   {
      double val=pm.asDouble();

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptAudio.cpp	2011-01-06 06:54:16 UTC (rev 6913)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptAudio.cpp	2011-01-06 06:54:18 UTC (rev 6914)
@@ -47,6 +47,50 @@
     return audioFilterSetMixer(c);
 }
 /**
+    \fn scriptGetNormalizeMode
+*/
+int scriptGetNormalizeMode(void)
+{
+    ADM_GAINMode m;
+    uint32_t gain;
+    audioFilterGetNormalize( &amp;m,&amp;gain);
+    return m;
+}
+/**
+    \fn scriptGetNormalizeValue
+*/
+int scriptGetNormalizeValue(void)
+{
+    ADM_GAINMode m;
+    uint32_t gain;
+    audioFilterGetNormalize( &amp;m,&amp;gain);
+    return (int)gain;
+}
+
+/**
+    \fn scriptSetNormalizeMode
+*/
+void scriptSetNormalizeMode(int mode)
+{
+    ADM_GAINMode m;
+    uint32_t gain;
+    audioFilterGetNormalize( &amp;m,&amp;gain);
+    m=(ADM_GAINMode)mode;
+    audioFilterSetNormalize( m,gain);
+}
+/**
+    \fn scriptSetNormalizeValue
+*/
+void scriptSetNormalizeValue(int value)
+{
+    ADM_GAINMode m;
+    uint32_t gain;
+    audioFilterGetNormalize( &amp;m,&amp;gain);
+    gain=(uint32_t)value;
+    audioFilterSetNormalize( m,gain);
+
+}
+/**
     \fn jsGetResample
 */
 int32_t scriptGetResample(void)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_normalize_param.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_normalize_param.h	2011-01-06 06:54:16 UTC (rev 6913)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudioFilter/include/audiofilter_normalize_param.h	2011-01-06 06:54:18 UTC (rev 6914)
@@ -15,7 +15,8 @@
 {
   ADM_NO_GAIN,
   ADM_GAIN_AUTOMATIC,
-  ADM_GAIN_MANUAL
+  ADM_GAIN_MANUAL,
+  ADM_GAIN_MAX // dont use!
   
 }ADM_GAINMode;
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004088.html">[Avidemux-svn-commit] r6913 -	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec
</A></li>
	<LI>Next message: <A HREF="004090.html">[Avidemux-svn-commit] r6915 - in	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2:	binding py
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4089">[ date ]</a>
              <a href="thread.html#4089">[ thread ]</a>
              <a href="subject.html#4089">[ subject ]</a>
              <a href="author.html#4089">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
