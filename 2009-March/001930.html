<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r4701 - in branches/avidemux_2.6_branch_mean:	avidemux/ADM_audioFilter/include avidemux/ADM_audioFilter/src	avidemux/ADM_audiofilter avidemux/ADM_coreAudioEncoder/include	plugins/ADM_audioEncoders plugins/ADM_audioEncoders/lame	plugins/ADM_audioEncoders/twolame
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2009-March/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4701%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/ADM_audioFilter/include%20avidemux/ADM_audioFilter/src%0A%09avidemux/ADM_audiofilter%20avidemux/ADM_coreAudioEncoder/include%0A%09plugins/ADM_audioEncoders%20plugins/ADM_audioEncoders/lame%0A%09plugins/ADM_audioEncoders/twolame&In-Reply-To=%3C200903211456.n2LEu0nf003465%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001929.html">
   <LINK REL="Next"  HREF="001931.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r4701 - in branches/avidemux_2.6_branch_mean:	avidemux/ADM_audioFilter/include avidemux/ADM_audioFilter/src	avidemux/ADM_audiofilter avidemux/ADM_coreAudioEncoder/include	plugins/ADM_audioEncoders plugins/ADM_audioEncoders/lame	plugins/ADM_audioEncoders/twolame</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4701%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/ADM_audioFilter/include%20avidemux/ADM_audioFilter/src%0A%09avidemux/ADM_audiofilter%20avidemux/ADM_coreAudioEncoder/include%0A%09plugins/ADM_audioEncoders%20plugins/ADM_audioEncoders/lame%0A%09plugins/ADM_audioEncoders/twolame&In-Reply-To=%3C200903211456.n2LEu0nf003465%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r4701 - in branches/avidemux_2.6_branch_mean:	avidemux/ADM_audioFilter/include avidemux/ADM_audioFilter/src	avidemux/ADM_audiofilter avidemux/ADM_coreAudioEncoder/include	plugins/ADM_audioEncoders plugins/ADM_audioEncoders/lame	plugins/ADM_audioEncoders/twolame">mean at mail.berlios.de
       </A><BR>
    <I>Sat Mar 21 15:56:00 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001929.html">[Avidemux-svn-commit] r4700 - in branches/avidemux_2.6_branch_mean:	avidemux/ADM_audioFilter/include avidemux/ADM_audioFilter/src	avidemux/ADM_audiofilter avidemux/ADM_coreAudioEncoder/include	avidemux/ADM_coreAudioEncoder/src cmake	plugins/ADM_audioEncoders plugins/ADM_audioEncoders/lame
</A></li>
        <LI>Next message: <A HREF="001931.html">[Avidemux-svn-commit] r4702 - in	branches/avidemux_2.6_branch_mean/avidemux: .	ADM_audioFilter/include ADM_audioFilter/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1930">[ date ]</a>
              <a href="thread.html#1930">[ thread ]</a>
              <a href="subject.html#1930">[ subject ]</a>
              <a href="author.html#1930">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2009-03-21 15:56:00 +0100 (Sat, 21 Mar 2009)
New Revision: 4701

Added:
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/include/audioEncoderApi.h
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audiofilter_encoder.cpp
Removed:
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audioEncoderApi.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/include/audiofilter_access.h
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audiofilter.cpp
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audiofilter_access.cpp
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audioeng_buildfilters.h
   branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/include/audioencoderInternal.h
   branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp
   branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.h
   branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp
   branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/twolame/audioencoder_twolame.h
   branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/twolame/audioencoder_twolame_param.h
Log:
[Audio] Hook encoder and filter chain to create audio access when encoding

Copied: branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/include/audioEncoderApi.h (from rev 4700, branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audioEncoderApi.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audioEncoderApi.h	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/include/audioEncoderApi.h	2009-03-21 14:56:00 UTC (rev 4701)
@@ -0,0 +1,35 @@
+/**
+    \file audioEncoderApi.h
+    \brief Helper functions to deal with audioEncoders
+
+*/
+#ifndef AUDIOENCODERAPI_H
+#define AUDIOENCODERAPI_H
+
+/// Select the best encoder using the audio fourcc : WAV_MP3 etc...
+uint8_t audio_selectCodecByTag(uint32_t tag);
+/// Set an option for example &quot;DISABLERESERVOIR&quot;,1
+uint8_t audioSetOption(const char *option, uint32_t value);
+/// Select the copy Codec
+uint8_t audio_setCopyCodec(void);
+/// Directly set the codec, *only to be used
+uint8_t audioCodecSetByIndex(int i);
+/// Spawn a new encoder
+ADM_AudioEncoder *audioEncoderCreate(AUDMAudioFilter *filter);
+/// Select a encoder by its name e.g. &quot;lame&quot;, used only by JS. Update UI as well
+uint8_t audioCodecSetByName( const char *name);
+/// Returns the name of the currently selected codec
+const char *audioCodecGetName( void );
+/// Update the UI with the currently selected codec
+void audioPrintCurrentCodec(void);
+/// Returns 1 if we are in process mode, 0 if in copy mode
+uint32_t audioProcessMode(void);
+/// Retrieve current audio encoder configuration
+uint8_t getAudioExtraConf(uint32_t *bitrate,uint32_t *extraDataSize, uint8_t **extradata);
+/// Set current audio encoder configuration
+uint8_t setAudioExtraConf(uint32_t bitrate,uint32_t extraDataSize, uint8_t *extradata);
+
+
+
+#endif
+// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/include/audiofilter_access.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/include/audiofilter_access.h	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/include/audiofilter_access.h	2009-03-21 14:56:00 UTC (rev 4701)
@@ -16,6 +16,7 @@
 #define AUDM_ACCESS_H
 
 #include &quot;ADM_audioStream.h&quot;
+class ADM_AudioEncoder;
 /**
     \class ADMAudioFilter_Access
     \brief Bridge audioFilter-&gt;Access
@@ -28,10 +29,11 @@
     AUDMAudioFilter     *filter;
     WAVHeader           header;
     uint64_t            samplesSeen;
+    ADM_AudioEncoder    *encoder;
   public:
                 WAVHeader         *getWavHeader(void) {return &header;}
 
-                                    ADMAudioFilter_Access(AUDMAudioFilter *incoming,uint64_t timeUs) ;
+                                    ADMAudioFilter_Access(AUDMAudioFilter *incoming,ADM_AudioEncoder *encoder,uint64_t timeUs) ;
                 virtual           ~ADMAudioFilter_Access();
                                     /// Return true if the demuxer can seek in time
                 virtual bool      canSeekTime(void) {return false;};

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/CMakeLists.txt	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/CMakeLists.txt	2009-03-21 14:56:00 UTC (rev 4701)
@@ -1,5 +1,8 @@
 # Filters
 SET(ADM_audioFilter_SRCS
+
+audio_encoderPlugin.cpp
+
 audiofilter_bridge.cpp
 audiofilter_access.cpp
 audiofilter_mixer.cpp
@@ -8,7 +11,7 @@
 audiofilter_limiter.cpp
 audiofilter_normalize.cpp
 audiofilter_SRC.cpp
-audio_encoderPlugin.cpp
+audiofilter_encoder.cpp
 ADM_audioResample.cpp
 audiofilter.cpp
 ADM_libsamplerate/samplerate.c  

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audiofilter.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audiofilter.cpp	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audiofilter.cpp	2009-03-21 14:56:00 UTC (rev 4701)
@@ -26,8 +26,8 @@
 extern ADM_Composer *video_body;
 
 //
-static bool ADM_buildFilterChain(VectorOfAudioFilter *vec,ADM_AUDIOFILTER_CONFIG *config);
-static bool ADM_emptyFilterChain(VectorOfAudioFilter *vec);
+ bool ADM_buildFilterChain(VectorOfAudioFilter *vec,ADM_AUDIOFILTER_CONFIG *config);
+ bool ADM_emptyFilterChain(VectorOfAudioFilter *vec);
 /**
         \fn createPlaybackFilter
         \brief Create a float output filter for playback

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audiofilter_access.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audiofilter_access.cpp	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audiofilter_access.cpp	2009-03-21 14:56:00 UTC (rev 4701)
@@ -19,12 +19,17 @@
 
 #include &quot;ADM_audioFilter.h&quot;
 #include &quot;audiofilter_access.h&quot;
+#include &quot;audioencoder.h&quot;
+
+extern bool            destroyEncodingFilter(void);
+
 /**
     \fn ADMAudioFilter_Access
 */
-ADMAudioFilter_Access::ADMAudioFilter_Access(AUDMAudioFilter *incoming,uint64_t timeUs)
+ADMAudioFilter_Access::ADMAudioFilter_Access(AUDMAudioFilter *incoming,ADM_AudioEncoder *encoder,uint64_t timeUs)
 {
     filter=incoming;
+    this-&gt;encoder=encoder;
     ADM_assert(filter);
     startTimeUs=timeUs;
     memcpy(&amp;header,incoming-&gt;getInfo(),sizeof(header));
@@ -37,6 +42,16 @@
 ADMAudioFilter_Access::~ADMAudioFilter_Access()
 {
     printf(&quot;[FilterAccess] Destroyed\n&quot;);
+    if(filter)
+    {
+        destroyEncodingFilter();
+        filter=NULL;
+    }
+    if(encoder)
+    {
+        delete encoder;
+        encoder=NULL;
+    }
 }
 /**
     \fn setPos
@@ -61,21 +76,18 @@
 */                
 bool    ADMAudioFilter_Access::getPacket(uint8_t *buffer, uint32_t *size, uint32_t maxSize,uint64_t *dts)
 {
-    maxSize/=sizeof(float);
-    *size=0;
-
-    AUD_Status status;
-    uint32_t rd=filter-&gt;fill(maxSize,(float *)buffer,&amp;status);
-    if(!rd)
+    uint32_t samples;
+    bool r=encoder-&gt;encode(buffer,size,&amp;samples);
+    if(false==r)
     {
-        printf(&quot;[Filter_access] Fill error!\n&quot;);
+        printf(&quot;[Access] getpacket failed for encoding\n&quot;);
         return false;
     }
-    *size=rd*sizeof(float);
 
-    float d=(float)samplesSeen/(float)(rd/header.channels);
+    float d=(float)samplesSeen/(float)(header.frequency);
+    d*=1000*1000;
     *dts=startTimeUs+(uint64_t)d;
-    samplesSeen+=(rd/header.channels);
+    samplesSeen+=samples;
     return true;
 }
 

Added: branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audiofilter_encoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audiofilter_encoder.cpp	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audiofilter_encoder.cpp	2009-03-21 14:56:00 UTC (rev 4701)
@@ -0,0 +1,95 @@
+/***************************************************************************
+            \file audiofilter_encoder.cpp
+            \brief Generate a access class = to the output of encoder + filterchain
+              (c) 2006 Mean , <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+
+#include &quot;ADM_default.h&quot;
+#include &lt;math.h&gt;
+
+#include &quot;audiofilter_bridge.h&quot;
+#include &quot;audiofilter_access.h&quot;
+#include &quot;audiofilter_internal.h&quot;
+#include &quot;audiofilter_conf.h&quot;
+#include &quot;audioencoder.h&quot;
+#include &quot;audioEncoderApi.h&quot;
+
+VectorOfAudioFilter EncodingVector;
+extern ADM_Composer *video_body;
+
+//
+ extern bool ADM_buildFilterChain(VectorOfAudioFilter *vec,ADM_AUDIOFILTER_CONFIG *config);
+ extern bool ADM_emptyFilterChain(VectorOfAudioFilter *vec);
+/**
+        \fn createPlaybackFilter
+        \brief Create a float output filter for playback
+        @param StartTime in us
+        @param shift in ms
+*/
+AUDMAudioFilter *createEncodingFilter(uint64_t startTime,int32_t shift)
+{
+    //
+    ADM_AUDIOFILTER_CONFIG playback;
+    playback.startTimeInUs=startTime;
+    playback.shiftInMs=shift;
+    playback.mixerEnabled=true;
+    playback.mixerConf=CHANNEL_STEREO;
+    //
+    ADM_buildFilterChain(&amp;EncodingVector,&amp;playback);
+    //
+    int last=EncodingVector.size();
+    ADM_assert(last);
+    return EncodingVector[last-1];
+}
+/**
+        \fn destroyPlaybackFilter
+        \brief Destroy a float output filter for playback
+*/
+
+bool            destroyEncodingFilter(void)
+{
+
+    ADM_emptyFilterChain(&amp;EncodingVector);
+    return true;
+
+}
+/**
+    \fn createEncodingAccess
+*/
+ADM_audioAccess *createEncodingAccess(uint64_t startTime,int32_t shift)
+{
+    printf(&quot;[AccessFilter] Creating access filter\n&quot;);
+    // 1-Create access filter
+    AUDMAudioFilter *filter=createEncodingFilter(startTime,shift);
+    if(!filter)
+    {
+        printf(&quot;[Access] Cannot create audio filter\n&quot;);
+        return NULL;
+    }
+
+    // 2- spawn encoder
+    ADM_AudioEncoder *encoder=audioEncoderCreate(filter);
+    if(!encoder) 
+    {
+        printf(&quot;[Access] Cannot create audio encoder\n&quot;);
+        return NULL;
+    }
+    // 3- Create access
+    ADM_audioAccess *access=new ADMAudioFilter_Access(filter,encoder,0);
+    if(!access)
+    {
+        printf(&quot;[Access] Cannot create access\n&quot;);
+    }
+    return access;
+}
+// EOF
\ No newline at end of file

Deleted: branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audioEncoderApi.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audioEncoderApi.h	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audioEncoderApi.h	2009-03-21 14:56:00 UTC (rev 4701)
@@ -1,35 +0,0 @@
-/**
-    \file audioEncoderApi.h
-    \brief Helper functions to deal with audioEncoders
-
-*/
-#ifndef AUDIOENCODERAPI_H
-#define AUDIOENCODERAPI_H
-
-/// Select the best encoder using the audio fourcc : WAV_MP3 etc...
-uint8_t audio_selectCodecByTag(uint32_t tag);
-/// Set an option for example &quot;DISABLERESERVOIR&quot;,1
-uint8_t audioSetOption(const char *option, uint32_t value);
-/// Select the copy Codec
-uint8_t audio_setCopyCodec(void);
-/// Directly set the codec, *only to be used
-uint8_t audioCodecSetByIndex(int i);
-/// Spawn a new encoder
-ADM_AudioEncoder *audioEncoderCreate(AUDMAudioFilter *filter);
-/// Select a encoder by its name e.g. &quot;lame&quot;, used only by JS. Update UI as well
-uint8_t audioCodecSetByName( const char *name);
-/// Returns the name of the currently selected codec
-const char *audioCodecGetName( void );
-/// Update the UI with the currently selected codec
-void audioPrintCurrentCodec(void);
-/// Returns 1 if we are in process mode, 0 if in copy mode
-uint32_t audioProcessMode(void);
-/// Retrieve current audio encoder configuration
-uint8_t getAudioExtraConf(uint32_t *bitrate,uint32_t *extraDataSize, uint8_t **extradata);
-/// Set current audio encoder configuration
-uint8_t setAudioExtraConf(uint32_t bitrate,uint32_t extraDataSize, uint8_t *extradata);
-
-
-
-#endif
-// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audioeng_buildfilters.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audioeng_buildfilters.h	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audioeng_buildfilters.h	2009-03-21 14:56:00 UTC (rev 4701)
@@ -20,7 +20,7 @@
 #include &quot;audioencoder.h&quot;
 #include &quot;ADM_audio/aviaudio.hxx&quot;
 
-#include &quot;ADM_audiofilter/audioEncoderApi.h&quot;
+#include &quot;audioEncoderApi.h&quot;
 #include &quot;ADM_audioStream.h&quot;
 
  ADM_audioStream *buildAudioFilter(ADM_audioStream *stream, uint32_t startTime);

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/include/audioencoderInternal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/include/audioencoderInternal.h	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/include/audioencoderInternal.h	2009-03-21 14:56:00 UTC (rev 4701)
@@ -34,7 +34,7 @@
     uint32_t     apiVersion;            // const
     ADM_AudioEncoder *(*create)(AUDMAudioFilter *head);  
     void         (*destroy)(ADM_AudioEncoder *codec);
-    uint8_t      (*configure)(void);    
+    bool         (*configure)(void);    
     const char   *codecName;        // Internal name (tag)
     const char   *menuName;         // Displayed name (in menu)
     const char   *description;
@@ -42,13 +42,13 @@
     uint32_t     major,minor,patch;     // Const
     uint32_t     wavTag;                // const Avi fourcc
     uint32_t     priority;              // const Higher means the codec is prefered and should appear first in the list
-    uint8_t      (*getConfigurationData)(uint32_t *l, uint8_t **d); // Get the encoder private conf
-    uint8_t      (*setConfigurationData)(uint32_t l, uint8_t *d); // Get the encoder private conf
+    bool         (*getConfigurationData)(uint32_t *l, uint8_t **d); // Get the encoder private conf
+    bool         (*setConfigurationData)(uint32_t l, uint8_t *d); // Get the encoder private conf
 
     uint32_t     (*getBitrate)(void);
     void         (*setBitrate)(uint32_t br);
  
-    uint8_t      (*setOption)(const char *paramName, uint32_t value);
+    bool         (*setOption)(const char *paramName, uint32_t value);
 
     void         *opaque;               // Hide stuff in here
 }ADM_audioEncoder;
@@ -56,8 +56,8 @@
 // Macros to declare audio encoder
 /**************************************************************************/
 #define ADM_DECLARE_AUDIO_ENCODER_PREAMBLE(Class) \
-static uint8_t getConfigurationData (uint32_t * l, uint8_t ** d); \
-static uint8_t setConfigurationData (uint32_t l, uint8_t * d);\
+static bool getConfigurationData (uint32_t * l, uint8_t ** d); \
+static bool setConfigurationData (uint32_t l, uint8_t * d);\
 static uint32_t     getBitrate(void); \
 static void         setBitrate(uint32_t br); \
 \
@@ -72,13 +72,13 @@
 } 
 //******************************************************
 #define ADM_DECLARE_AUDIO_ENCODER_CONFIG(configData) \
-uint8_t getConfigurationData (uint32_t * l, uint8_t ** d)\
+bool getConfigurationData (uint32_t * l, uint8_t ** d)\
 {\
   *l = sizeof (configData); \
   *d = (uint8_t *) &amp; configData; \
   return 1; \
 } \
-uint8_t setConfigurationData (uint32_t l, uint8_t * d)\
+bool setConfigurationData (uint32_t l, uint8_t * d)\
 {\
   if (sizeof (configData) != l) \
     {\

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/CMakeLists.txt	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/CMakeLists.txt	2009-03-21 14:56:00 UTC (rev 4701)
@@ -9,7 +9,7 @@
 MESSAGE(&quot;***  /Audio Codec  ***&quot;)
 
 
-#ADD_SUBDIRECTORY(twolame)
+ADD_SUBDIRECTORY(twolame)
 #ADD_SUBDIRECTORY(pcm)
 #ADD_SUBDIRECTORY(lavcodec)
 

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp	2009-03-21 14:56:00 UTC (rev 4701)
@@ -31,8 +31,8 @@
 };
 extern &quot;C&quot;
 {
-static uint8_t configure (void);
-static uint8_t setOption(const char *paramName, uint32_t value);
+static bool configure (void);
+static bool setOption(const char *paramName, uint32_t value);
 };
 /********************* Declare Plugin *****************************************************/
 ADM_DECLARE_AUDIO_ENCODER_PREAMBLE(AUDMEncoder_Lame);
@@ -252,7 +252,7 @@
 */
 #define QT_TR_NOOP(x) x
 
-uint8_t configure (void)
+bool configure (void)
 {
   int ret = 0;
   char string[400];
@@ -301,7 +301,7 @@
      \fn setOption
      \brief Allow giving codec specific options as string+value
 */
-uint8_t setOption(const char *paramName, uint32_t value)
+bool setOption(const char *paramName, uint32_t value)
 {
     if(!strcasecmp(paramName,&quot;MP3DisableReservoir&quot;))
     {

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.h
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.h	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.h	2009-03-21 14:56:00 UTC (rev 4701)
@@ -1,5 +1,6 @@
 
 /***************************************************************************
+    \file audioencoder_lame.h
     copyright            : (C) 2002-6 by mean
     email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
  ***************************************************************************/

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/twolame/audioencoder_twolame.cpp	2009-03-21 14:56:00 UTC (rev 4701)
@@ -1,5 +1,6 @@
 /***************************************************************************
-    copyright            : (C) 2006 by mean
+    \file audioencoder_twolame.cpp
+    copyright            : (C) 2006/2009 by mean
     email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
  ***************************************************************************/
 
@@ -32,10 +33,9 @@
 
 static TWOLAME_encoderParam twolameParam=
 {
-    128,
-    ADM_STEREO
+    128
 };
-static uint8_t configure (void);
+static bool configure (void);
 /********************* Declare Plugin *****************************************************/
 ADM_DECLARE_AUDIO_ENCODER_PREAMBLE(AUDMEncoder_Twolame);
 
@@ -64,15 +64,19 @@
 ADM_DECLARE_AUDIO_ENCODER_CONFIG(twolameParam);
 
 /******************* / Declare plugin*******************************************************/
+/**
 
-AUDMEncoder_Twolame::AUDMEncoder_Twolame(AUDMAudioFilter * instream)  :AUDMEncoder    (instream)
+*/
+AUDMEncoder_Twolame::AUDMEncoder_Twolame(AUDMAudioFilter * instream)  :ADM_AudioEncoder    (instream)
 {
   printf(&quot;[TwoLame] Creating Twolame\n&quot;);
   _twolameOptions=NULL;
-  _wavheader-&gt;encoding=WAV_MP2;
+  wavheader.encoding=WAV_MP2;
 };
 
+/**
 
+*/
 AUDMEncoder_Twolame::~AUDMEncoder_Twolame()
 {
   printf(&quot;[TwoLame] Deleting TwoLame\n&quot;);
@@ -81,62 +85,45 @@
     twolame_close((twolame_options_struct **)&amp;_twolameOptions);
   }
   _twolameOptions=NULL;
-  cleanup();
+
 };
 /**
     \fn initialize
 
 */
-uint8_t AUDMEncoder_Twolame::initialize(void)
+bool AUDMEncoder_Twolame::initialize(void)
 {
   int ret;
   TWOLAME_MPEG_mode mmode;
   uint32_t frequence;
   TWOLAME_encoderParam *lameConf=&twolameParam;
+    int channels=wavheader.channels;
 
-
   _twolameOptions = twolame_init();
   if (_twolameOptions == NULL)
     return 0;
 
-  if(_wavheader-&gt;channels&gt;2)
+  if(channels&gt;2)
   {
     printf(&quot;[TwoLame]Too many channels\n&quot;);
     return 0;
   }
-  _wavheader-&gt;byterate=(lameConf-&gt;bitrate*1000)&gt;&gt;3;
+  wavheader.byterate=(lameConf-&gt;bitrate*1000)&gt;&gt;3;
 
 
-  _chunk = 1152*_wavheader-&gt;channels;
+  _chunk = 1152*channels;
 
 
   printf(&quot;[TwoLame]Incoming :fq : %&quot;LU&quot;, channel : %&quot;LU&quot; bitrate: %&quot;LU&quot; \n&quot;,
-        _wavheader-&gt;frequency,_wavheader-&gt;channels,lameConf-&gt;bitrate);
+        wavheader.frequency,channels,lameConf-&gt;bitrate);
 
 
-  twolame_set_in_samplerate(OPTIONS, _wavheader-&gt;frequency);
-  twolame_set_out_samplerate (OPTIONS, _wavheader-&gt;frequency);
-  twolame_set_num_channels(OPTIONS, _wavheader-&gt;channels);
-  if(_wavheader-&gt;channels==1) mmode=TWOLAME_MONO;
+  twolame_set_in_samplerate(OPTIONS, wavheader.frequency);
+  twolame_set_out_samplerate (OPTIONS, wavheader.frequency);
+  twolame_set_num_channels(OPTIONS, channels);
+  if(channels==1) mmode=TWOLAME_MONO;
   else
-    switch (lameConf-&gt;mode)
-  {
-    case ADM_STEREO:
       mmode = TWOLAME_STEREO;
-      break;
-    case ADM_JSTEREO:
-      mmode = TWOLAME_JOINT_STEREO;
-      break;
-    case ADM_MONO:
-      mmode=TWOLAME_MONO;
-      break;
-
-    default:
-      printf(&quot;\n **** unknown mode, going stereo ***\n&quot;);
-      mmode = TWOLAME_STEREO;
-      break;
-
-  }
   twolame_set_mode(OPTIONS,mmode);
   twolame_set_error_protection(OPTIONS,TRUE);
     	//toolame_setPadding (options,TRUE);
@@ -145,38 +132,35 @@
   if(twolame_init_params(OPTIONS))
   {
     printf(&quot;[TwoLame]Twolame init failed\n&quot;);
-    return 0;
+    return false;
   }
-
-
-
   printf(&quot;[TwoLame]Libtoolame successfully initialized\n&quot;);
-  return 1;
+  return true;
 }
 /**
         \fn getPacket
 */
-uint8_t	AUDMEncoder_Twolame::getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples)
+bool 	AUDMEncoder_Twolame::encode(uint8_t *dest, uint32_t *len, uint32_t *samples)
 {
   int nbout;
-
+  int channels=wavheader.channels;
   *samples = 1152; //FIXME
   *len = 0;
   ADM_assert(tmptail&gt;=tmphead);
   if(!refillBuffer(_chunk ))
   {
-    return 0;
+    return false;
   }
 
   if(tmptail-tmphead&lt;_chunk)
   {
-    return 0;
+    return false;
   }
 
-  dither16(&amp;(tmpbuffer[tmphead]),_chunk,_wavheader-&gt;channels);
+  dither16(&amp;(tmpbuffer[tmphead]),_chunk,channels);
 
   ADM_assert(tmptail&gt;=tmphead);
-  if (_wavheader-&gt;channels == 1)
+  if (channels == 1)
   {
     nbout =twolame_encode_buffer(OPTIONS, (int16_t *)&amp;(tmpbuffer[tmphead]),(int16_t *)&amp;(tmpbuffer[tmphead]), _chunk, dest, 16 * 1024);
   }
@@ -187,11 +171,11 @@
   tmphead+=_chunk;
   ADM_assert(tmptail&gt;=tmphead);
   if (nbout &lt; 0) {
-    printf(&quot;\n Error !!! : %d\n&quot;, nbout);
-    return 0;
+    printf(&quot;[TwoLame] Error !!! : %d\n&quot;, nbout);
+    return false;
   }
   *len=nbout;
-  return 1;
+  return true;
 }
 #define SZT(x) sizeof(x)/sizeof(diaMenuEntry )
 #define BITRATE(x) {x,QT_TR_NOOP(#x)}
@@ -199,18 +183,10 @@
 /**
     \fn configure
 */
-uint8_t configure (void)
+bool configure (void)
 {
  int ret=0;
 
-  uint32_t m=(uint32_t)twolameParam.mode;
-
-    diaMenuEntry channelMode[] =
-    {
-        {ADM_STEREO, QT_TR_NOOP (&quot;Stereo&quot;), NULL},
-        {ADM_JSTEREO, QT_TR_NOOP (&quot;Joint stereo&quot;), NULL},
-        {ADM_MONO, QT_TR_NOOP (&quot;Mono&quot;), NULL}
-    };
     diaMenuEntry bitrateM[]={
                               BITRATE(56),
                               BITRATE(64),
@@ -225,16 +201,15 @@
                           };
     diaElemMenu bitrate(&amp;(twolameParam.bitrate),   QT_TR_NOOP(&quot;_Bitrate:&quot;), SZT(bitrateM),bitrateM);
 
-    diaElemMenu menuMode (&amp;m, QT_TR_NOOP (&quot;C_hannel mode:&quot;),SZT (channelMode), channelMode);
 
-    diaElem *elems[]={&amp;bitrate,&amp;menuMode};
+    diaElem *elems[]={&amp;bitrate};
 
-    if( diaFactoryRun(QT_TR_NOOP(&quot;TwoLame Configuration&quot;),2,elems))
+    if( diaFactoryRun(QT_TR_NOOP(&quot;TwoLame Configuration&quot;),1,elems))
     {
-        twolameParam.mode=(ADM_mode)m;
-        return 1;
+        
+        return true;
     }
 
-    return 0;
+    return false;
 }
 // EOF

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/twolame/audioencoder_twolame.h
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/twolame/audioencoder_twolame.h	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/twolame/audioencoder_twolame.h	2009-03-21 14:56:00 UTC (rev 4701)
@@ -1,5 +1,6 @@
 /***************************************************************************
-    copyright            : (C) 2002-6 by mean
+    \file audioencoder_twolame.h
+    copyright            : (C) 2002-9 by mean
     email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
  ***************************************************************************/
 
@@ -15,16 +16,18 @@
 #define AUDMaudioTwoLame
 
  //_____________________________________________
-class AUDMEncoder_Twolame : public AUDMEncoder
+class AUDMEncoder_Twolame : public ADM_AudioEncoder
 {
   protected:
     void           *_twolameOptions;
+    uint32_t        _chunk;
          
   public:
-            uint8_t     initialize(void);
+            bool     initialize(void);
     virtual             ~AUDMEncoder_Twolame();
                         AUDMEncoder_Twolame(AUDMAudioFilter *instream);	
-    virtual uint8_t	    getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
+    virtual bool    encode(uint8_t *dest, uint32_t *len, uint32_t *samples);
+    virtual bool    isVBR(void) {return false;}
 };
 
 #endif

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/twolame/audioencoder_twolame_param.h
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/twolame/audioencoder_twolame_param.h	2009-03-21 14:55:57 UTC (rev 4700)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/twolame/audioencoder_twolame_param.h	2009-03-21 14:56:00 UTC (rev 4701)
@@ -10,7 +10,7 @@
 typedef struct 
 {
   uint32_t        bitrate;
-  ADM_mode        mode;
+
 }TWOLAME_encoderParam;
 
 #endif


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001929.html">[Avidemux-svn-commit] r4700 - in branches/avidemux_2.6_branch_mean:	avidemux/ADM_audioFilter/include avidemux/ADM_audioFilter/src	avidemux/ADM_audiofilter avidemux/ADM_coreAudioEncoder/include	avidemux/ADM_coreAudioEncoder/src cmake	plugins/ADM_audioEncoders plugins/ADM_audioEncoders/lame
</A></li>
	<LI>Next message: <A HREF="001931.html">[Avidemux-svn-commit] r4702 - in	branches/avidemux_2.6_branch_mean/avidemux: .	ADM_audioFilter/include ADM_audioFilter/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1930">[ date ]</a>
              <a href="thread.html#1930">[ thread ]</a>
              <a href="subject.html#1930">[ subject ]</a>
              <a href="author.html#1930">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
