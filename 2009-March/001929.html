<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r4700 - in branches/avidemux_2.6_branch_mean:	avidemux/ADM_audioFilter/include avidemux/ADM_audioFilter/src	avidemux/ADM_audiofilter avidemux/ADM_coreAudioEncoder/include	avidemux/ADM_coreAudioEncoder/src cmake	plugins/ADM_audioEncoders plugins/ADM_audioEncoders/lame
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2009-March/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4700%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/ADM_audioFilter/include%20avidemux/ADM_audioFilter/src%0A%09avidemux/ADM_audiofilter%20avidemux/ADM_coreAudioEncoder/include%0A%09avidemux/ADM_coreAudioEncoder/src%20cmake%0A%09plugins/ADM_audioEncoders%20plugins/ADM_audioEncoders/lame&In-Reply-To=%3C200903211455.n2LEtw0Q003453%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001928.html">
   <LINK REL="Next"  HREF="001930.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r4700 - in branches/avidemux_2.6_branch_mean:	avidemux/ADM_audioFilter/include avidemux/ADM_audioFilter/src	avidemux/ADM_audiofilter avidemux/ADM_coreAudioEncoder/include	avidemux/ADM_coreAudioEncoder/src cmake	plugins/ADM_audioEncoders plugins/ADM_audioEncoders/lame</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r4700%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/ADM_audioFilter/include%20avidemux/ADM_audioFilter/src%0A%09avidemux/ADM_audiofilter%20avidemux/ADM_coreAudioEncoder/include%0A%09avidemux/ADM_coreAudioEncoder/src%20cmake%0A%09plugins/ADM_audioEncoders%20plugins/ADM_audioEncoders/lame&In-Reply-To=%3C200903211455.n2LEtw0Q003453%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r4700 - in branches/avidemux_2.6_branch_mean:	avidemux/ADM_audioFilter/include avidemux/ADM_audioFilter/src	avidemux/ADM_audiofilter avidemux/ADM_coreAudioEncoder/include	avidemux/ADM_coreAudioEncoder/src cmake	plugins/ADM_audioEncoders plugins/ADM_audioEncoders/lame">mean at mail.berlios.de
       </A><BR>
    <I>Sat Mar 21 15:55:58 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001928.html">[Avidemux-svn-commit] r4699 - in	branches/avidemux_2.6_branch_mean/avidemux:	ADM_coreAudioEncoder/include ADM_coreAudioEncoder/src ADM_toolkit
</A></li>
        <LI>Next message: <A HREF="001930.html">[Avidemux-svn-commit] r4701 - in branches/avidemux_2.6_branch_mean:	avidemux/ADM_audioFilter/include avidemux/ADM_audioFilter/src	avidemux/ADM_audiofilter avidemux/ADM_coreAudioEncoder/include	plugins/ADM_audioEncoders plugins/ADM_audioEncoders/lame	plugins/ADM_audioEncoders/twolame
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1929">[ date ]</a>
              <a href="thread.html#1929">[ thread ]</a>
              <a href="subject.html#1929">[ subject ]</a>
              <a href="author.html#1929">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2009-03-21 15:55:57 +0100 (Sat, 21 Mar 2009)
New Revision: 4700

Added:
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/include/audio_encoderPlugin.h
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audio_encoderPlugin.cpp
Removed:
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audio_encoderPlugin.cpp
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audio_encoderPlugin.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/include/audioencoder.h
   branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/include/audioencoderInternal.h
   branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/src/audioencoder.cpp
   branches/avidemux_2.6_branch_mean/cmake/ae_plugin.cmake
   branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp
   branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.h
   branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame_param.h
Log:
[Audio] Lame encoder

Copied: branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/include/audio_encoderPlugin.h (from rev 4699, branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audio_encoderPlugin.h)
===================================================================

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/CMakeLists.txt	2009-03-19 17:02:27 UTC (rev 4699)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/CMakeLists.txt	2009-03-21 14:55:57 UTC (rev 4700)
@@ -8,6 +8,7 @@
 audiofilter_limiter.cpp
 audiofilter_normalize.cpp
 audiofilter_SRC.cpp
+audio_encoderPlugin.cpp
 ADM_audioResample.cpp
 audiofilter.cpp
 ADM_libsamplerate/samplerate.c  

Copied: branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audio_encoderPlugin.cpp (from rev 4699, branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audio_encoderPlugin.cpp)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audio_encoderPlugin.cpp	2009-03-19 17:02:27 UTC (rev 4699)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_audioFilter/src/audio_encoderPlugin.cpp	2009-03-21 14:55:57 UTC (rev 4700)
@@ -0,0 +1,430 @@
+/***************************************************************************
+                          audio_encoderPlugin.cpp  -  description
+                             -------------------
+    
+    copyright            : (C) 2008 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &lt;vector&gt;
+#include &quot;ADM_default.h&quot;
+#include &quot;audioencoderInternal.h&quot;
+#include &quot;ADM_dynamicLoading.h&quot;
+std::vector &lt;ADM_audioEncoder *&gt; ListOfAudioEncoder;
+
+static AUDIOENCODER  currentEncoder=0; //0 is always dummy
+
+static AUDIOENCODER ADM_encoderByName(const char *name);
+static const char *ADM_audioEncoderById(AUDIOENCODER id);
+
+/**
+    \class ADM_AudioEncoderLoader
+    \brief Helper class to load plugins
+*/
+class ADM_AudioEncoderLoader :public ADM_LibWrapper
+{
+
+public:
+        int                 initialised;
+        ADM_audioEncoder    *encoderBlock;
+        
+
+
+        ADM_AudioEncoderLoader(const char *file) : ADM_LibWrapper()
+		{
+                ADM_audioEncoder    *e;
+                ADM_audioEncoder *(*getInfo)(void);
+                initialised = loadLibrary(file) &amp;&amp; getSymbols(1,
+				&amp;getInfo, &quot;getInfo&quot;
+                );
+                encoderBlock=NULL;
+                if(initialised)
+                {
+                    e=getInfo();
+                    if(e-&gt;apiVersion!=ADM_AUDIO_ENCODER_API_VERSION)
+                    {
+                        e=NULL;
+                        initialised=0;
+                    }else
+                    {
+                        printf(&quot;[AudioEncoder] Loaded %s version %02d.%02d.%02d wavTag :0x%x\n&quot;,e-&gt;codecName,
+                                e-&gt;major,e-&gt;minor,e-&gt;patch,e-&gt;wavTag);
+                        encoderBlock=new ADM_audioEncoder;
+                        *encoderBlock=*e;
+                        encoderBlock-&gt;opaque=(void *)this;
+                    } 
+                }else
+                {
+                    printf(&quot;Symbol loading failed for %s\n&quot;,file);
+                }
+		}
+        ADM_AudioEncoderLoader(const char *name, const char *menuName) : ADM_LibWrapper()
+		{
+                    encoderBlock=new ADM_audioEncoder;
+                    encoderBlock-&gt;codecName=name;
+                    encoderBlock-&gt;menuName=menuName;                    
+                    encoderBlock-&gt;opaque=(void *)this;
+		}
+        ~ADM_AudioEncoderLoader()
+        {
+            if(encoderBlock) delete encoderBlock;
+            encoderBlock=NULL;
+            
+        }
+};
+
+/**
+        \fn ADM_ae_getPluginNbEncoders
+        \brief Returns the number of av filter plugins except one
+*/
+uint32_t ADM_ae_getPluginNbEncoders(void)
+{
+    return ListOfAudioEncoder.size()-1;
+}
+/**
+    \fn     ADM_ae_getAPluginEncoderInfo
+    \brief  Get Infos about the encoder #th plugin (plugin display)
+*/
+bool     ADM_ae_getAPluginEncoderInfo(int filter, const char **name, uint32_t *major,uint32_t *minor,uint32_t *patch)
+{
+    filter++;
+    ADM_assert(filter&lt;ListOfAudioEncoder.size());
+    *major=ListOfAudioEncoder[filter]-&gt;major;
+    *minor=ListOfAudioEncoder[filter]-&gt;minor;
+    *patch=ListOfAudioEncoder[filter]-&gt;patch;
+    *name=ListOfAudioEncoder[filter]-&gt;description;
+    return true;
+}
+/**
+    \fn tryLoadingFilterPlugin
+    \brief Try loading the file given as argument as an audio device plugin
+
+*/
+#define Fail(x) {printf(&quot;%s:&quot;#x&quot;\n&quot;,file);goto er;}
+static bool tryLoadingFilterPlugin(const char *file)
+{
+	ADM_AudioEncoderLoader *dll=new ADM_AudioEncoderLoader(file);
+    if(!dll-&gt;initialised) Fail(CannotLoad);
+    
+
+    ListOfAudioEncoder.push_back(dll-&gt;encoderBlock); // Needed for cleanup. FIXME TODO Delete it.
+    printf(&quot;[AudioEncoder] Registered filter %s as  %s\n&quot;,file,dll-&gt;encoderBlock-&gt;description);
+    return true;
+	// Fail!
+er:
+	delete dll;
+	return false;
+
+}
+/**
+ * 	\fn ADM_ae_loadPlugins
+ *  \brief load all audio encoder plugins
+ */
+uint8_t ADM_ae_loadPlugins(const char *path)
+{
+#define MAX_EXTERNAL_FILTER 100
+// FIXME Factorize
+
+	char *files[MAX_EXTERNAL_FILTER];
+	uint32_t nbFile;
+    // Add the copy encoder
+    ADM_AudioEncoderLoader *copy=new ADM_AudioEncoderLoader(&quot;copy&quot;,&quot;Copy&quot;);
+    ListOfAudioEncoder.push_back(copy-&gt;encoderBlock);
+    //
+	memset(files,0,sizeof(char *)*MAX_EXTERNAL_FILTER);
+	printf(&quot;[ADM_ae_plugin] Scanning directory %s\n&quot;,path);
+
+	if(!buildDirectoryContent(&amp;nbFile, path, files, MAX_EXTERNAL_FILTER, SHARED_LIB_EXT))
+	{
+		printf(&quot;[ADM_ae_plugin] Cannot parse plugin\n&quot;);
+		return 0;
+	}
+
+	for(int i=0;i&lt;nbFile;i++)
+		tryLoadingFilterPlugin(files[i]);
+
+	printf(&quot;[ADM_ae_plugin] Scanning done\n&quot;);
+
+	return 1;
+}
+/**
+    \fn audioPrintCurrentCodec
+    \brief updates the UI with the current selected audio encoder
+*/
+void UI_setAudioCodec( int i);
+void audioPrintCurrentCodec(void)
+{
+			UI_setAudioCodec(currentEncoder);
+}
+
+/**
+    \fn ADM_encoderByName
+    \brief Returns the Id of the given string 
+
+*/
+AUDIOENCODER ADM_encoderByName(const char *name)
+{
+	if(!name) return (AUDIOENCODER)0;
+    if(!strcasecmp(name,&quot;copy&quot;)) return (AUDIOENCODER)0; // copy
+	for(uint32_t i=1;i&lt;ListOfAudioEncoder.size();i++)
+	{
+		if(!strcasecmp(name,ListOfAudioEncoder[i]-&gt;codecName))
+		{
+			return i;
+		}	
+	}
+	printf(&quot;[AudioEncoder] Encoder not found :%s\n&quot;,name);
+	return (AUDIOENCODER)0;
+
+}
+/**
+    \fn    ADM_audioEncoderById
+    \brief Returns the name of a device from its Id
+*/
+static const char *ADM_audioEncoderById(AUDIOENCODER id)
+{
+
+	ADM_assert(id&lt;ListOfAudioEncoder.size());
+    return ListOfAudioEncoder[id]-&gt;codecName;
+}
+/**
+    \fn AVDM_getCurrentAudioEncoder
+    \brief
+*/
+AUDIOENCODER AVDM_getCurrentAudioEncoder( void)
+{
+	return currentEncoder;
+}
+/**
+    \fn audioCodecSelect
+    \brief Update UI
+*/
+uint8_t DIA_audioCodec( int *codec );
+void audioCodecSelect( void )
+{
+#warning FIXME 
+#warning FIXME 
+#warning FIXME 
+	//DIA_audioCodec( &amp;currentEncoder );
+	audioPrintCurrentCodec();
+}
+/**
+    \fn     audioCodecSetByName
+    \brief  only called by JS, we have to update UI as well
+*/
+uint8_t audioCodecSetByName( const char *name)
+{
+		for(uint32_t i=0;i&lt;ListOfAudioEncoder.size();i++)
+		{
+			if(!strcasecmp(name,ListOfAudioEncoder[i]-&gt;codecName))
+			{
+
+				currentEncoder=i;
+                audioPrintCurrentCodec(); // Update UI
+				return 1;
+			}
+
+		}
+		printf(&quot;\n Mmmm Select audio codec by name failed...(%s).\n&quot;,name);
+		return 0;
+}
+/**
+    \fn audioCodecSetByIndex
+    \brief To be used by UI code only!
+*/
+uint8_t audioCodecSetByIndex(int i)
+{
+    ADM_assert(i&lt;ListOfAudioEncoder.size());
+    currentEncoder=i;
+    printf(&quot;[AudioEncoder] Selected %s for index %d, tag 0x%x \n&quot;,ListOfAudioEncoder[currentEncoder]-&gt;codecName,i,ListOfAudioEncoder[currentEncoder]-&gt;wavTag);
+    return 1;
+
+}
+/**
+    \fn audioCodecGetName
+    \brief Returns the current codec tagname
+*/
+const char *audioCodecGetName( void )
+{
+	  ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
+      return ListOfAudioEncoder[currentEncoder]-&gt;codecName;
+
+}
+
+/**
+    \fn audioProcessMode
+    \brief
+    @return 1 in process mode, 0 in copy mode
+*/
+uint32_t audioProcessMode(void)
+{
+        if(!currentEncoder) return 0;
+        return 1;
+}
+/**
+ * 	\fn getAudioOuputTag
+ *  \brief Return the encoding of the currently selected codec
+ *  Must be called only in process mode, else it is meaningless.
+ */
+uint32_t audioFilter_getOuputCodec(void)
+{
+	ADM_assert(!currentEncoder);
+    return ListOfAudioEncoder[currentEncoder]-&gt;wavTag;
+}
+
+/**
+ * 	\fn audioFilter_getMaxChannels
+ *  \brief Return the max # of channels a codec supports
+ */
+uint32_t audioFilter_getMaxChannels(void)
+{
+    ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
+	if(!currentEncoder) return 99999;
+	return ListOfAudioEncoder[currentEncoder]-&gt;maxChannels;
+}
+/**
+    \fn audioCodecConfigure
+    \brief
+*/
+void audioCodecConfigure( void )
+{
+    if(ListOfAudioEncoder[currentEncoder]-&gt;configure)
+    ListOfAudioEncoder[currentEncoder]-&gt;configure();
+}
+/**
+    \fn audioGetBitrate
+*/
+uint32_t audioGetBitrate(void)
+{
+    ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
+    if(ListOfAudioEncoder[currentEncoder]-&gt;getBitrate)
+        return ListOfAudioEncoder[currentEncoder]-&gt;getBitrate();
+    return 0;
+} 
+void audioFilter_SetBitrate( int i)
+{
+    ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
+    if(ListOfAudioEncoder[currentEncoder]-&gt;setBitrate)
+        ListOfAudioEncoder[currentEncoder]-&gt;setBitrate(i);
+    
+}
+/**
+    \fn audioEncoderGetNumberOfEncoders
+*/
+uint32_t audioEncoderGetNumberOfEncoders(void)
+{
+    return ListOfAudioEncoder.size();
+}
+/**
+    \fn audioEncoderGetDisplayName
+*/
+const char  *audioEncoderGetDisplayName(uint32_t i)
+{
+     ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
+     return ListOfAudioEncoder[i]-&gt;menuName;
+}
+/**
+        \fn audioEncoderCreate
+        \brief Spawn an audio encoder
+*/
+ADM_AudioEncoder *audioEncoderCreate(AUDMAudioFilter *filter)
+{
+      ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
+      static ADM_audioEncoder *enc=ListOfAudioEncoder[currentEncoder];
+     return enc-&gt;create(filter);
+}
+/**
+        \fn getAudioExtraConf
+        \brief 
+*/
+
+uint8_t getAudioExtraConf(uint32_t *bitrate,uint32_t *extraDataSize, uint8_t **extradata)
+{
+    if(!currentEncoder)
+    {
+        printf(&quot;[AudioEncoder] Cannot get conf on copy!\n&quot;);
+        return 0;
+    }
+     ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
+     ADM_audioEncoder *encoder= ListOfAudioEncoder[currentEncoder];
+     *bitrate=encoder-&gt;getBitrate();
+     if(encoder-&gt;getConfigurationData)
+        return encoder-&gt;getConfigurationData(extraDataSize,extradata);
+     else return 1;
+}
+/**
+    \fn setAudioExtraConf
+*/
+uint8_t setAudioExtraConf(uint32_t bitrate,uint32_t extraDataSize, uint8_t *extradata)
+{
+    if(!currentEncoder)
+    {
+        printf(&quot;[AudioEncoder] Cannot set conf on copy!\n&quot;);
+        return 0;
+    }
+     ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
+     ADM_audioEncoder *encoder= ListOfAudioEncoder[currentEncoder];
+     encoder-&gt;setBitrate(bitrate);
+     if(encoder-&gt;setConfigurationData)
+        return encoder-&gt;setConfigurationData(extraDataSize,extradata);
+    else return 1;
+}     
+/**
+        \fn audio_selectCodecByTag
+        \brief Select the &quot;best&quot; encoder outputing tag codec
+*/
+uint8_t audio_selectCodecByTag(uint32_t tag)
+{
+    int selected=-1,priority=-1;
+    for(int i=1;i&lt;ListOfAudioEncoder.size();i++)
+    {
+        ADM_audioEncoder *c=ListOfAudioEncoder[i];
+        if(c-&gt;wavTag==tag)
+        {
+            if((int)c-&gt;priority&gt;priority)
+            {
+                selected=i;
+                priority=c-&gt;priority;
+            }
+        }
+    }
+    if(selected!=-1)
+    {
+        currentEncoder=selected;
+        UI_setAudioCodec( (int)currentEncoder);
+        printf(&quot;[AudioEncoder] Selected %s for tag %d (%s)\n&quot;,ListOfAudioEncoder[currentEncoder]-&gt;codecName,tag,&quot;&quot;);
+        return 1;
+    }
+    return 0;
+}
+/**
+         \fn audioSetOption
+         \brief Allow per codec switch
+*/
+uint8_t audioSetOption(const char *option, uint32_t value)
+{
+    ADM_audioEncoder *c=ListOfAudioEncoder[currentEncoder];
+    if(!c-&gt;setOption) return 0;
+    return c-&gt;setOption(option,value);
+
+}
+/**
+         \fn audio_setCopyCodec
+         \brief Set audio codec to copy
+*/
+uint8_t audio_setCopyCodec(void)
+{
+    currentEncoder=0;
+    return 1;
+
+}
+
+//**

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/CMakeLists.txt	2009-03-19 17:02:27 UTC (rev 4699)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/CMakeLists.txt	2009-03-21 14:55:57 UTC (rev 4700)
@@ -10,8 +10,8 @@
 #        audiofilter_SRC.cpp
         audio_raw.cpp
 	audioeng_buff.cpp          
-        audio_encoderWrapper.cpp
-        audio_encoderPlugin.cpp
+#        audio_encoderWrapper.cpp
+#        audio_encoderPlugin.cpp
 )
 	
 ADD_ADM_LIB_ALL_TARGETS(ADM_audiofilter ${ADMaudiofilter_SRCS})

Deleted: branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audio_encoderPlugin.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audio_encoderPlugin.cpp	2009-03-19 17:02:27 UTC (rev 4699)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audio_encoderPlugin.cpp	2009-03-21 14:55:57 UTC (rev 4700)
@@ -1,428 +0,0 @@
-/***************************************************************************
-                          audio_encoderPlugin.cpp  -  description
-                             -------------------
-    
-    copyright            : (C) 2008 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &lt;vector&gt;
-#include &quot;ADM_default.h&quot;
-#include &quot;audioencoderInternal.h&quot;
-#include &quot;ADM_dynamicLoading.h&quot;
-std::vector &lt;ADM_audioEncoder *&gt; ListOfAudioEncoder;
-
-static AUDIOENCODER  currentEncoder=0; //0 is always dummy
-
-static AUDIOENCODER ADM_encoderByName(const char *name);
-static const char *ADM_audioEncoderById(AUDIOENCODER id);
-
-/**
-    \class ADM_AudioEncoderLoader
-    \brief Helper class to load plugins
-*/
-class ADM_AudioEncoderLoader :public ADM_LibWrapper
-{
-
-public:
-        int                 initialised;
-        ADM_audioEncoder    *encoderBlock;
-        
-
-
-        ADM_AudioEncoderLoader(const char *file) : ADM_LibWrapper()
-		{
-                ADM_audioEncoder    *e;
-                ADM_audioEncoder *(*getInfo)(void);
-                initialised = loadLibrary(file) &amp;&amp; getSymbols(1,
-				&amp;getInfo, &quot;getInfo&quot;
-                );
-                encoderBlock=NULL;
-                if(initialised)
-                {
-                    e=getInfo();
-                    if(e-&gt;apiVersion!=ADM_AUDIO_ENCODER_API_VERSION)
-                    {
-                        e=NULL;
-                        initialised=0;
-                    }else
-                    {
-                        printf(&quot;[AudioEncoder] Loaded %s version %02d.%02d.%02d wavTag :0x%x\n&quot;,e-&gt;codecName,
-                                e-&gt;major,e-&gt;minor,e-&gt;patch,e-&gt;wavTag);
-                        encoderBlock=new ADM_audioEncoder;
-                        *encoderBlock=*e;
-                        encoderBlock-&gt;opaque=(void *)this;
-                    } 
-                }else
-                {
-                    printf(&quot;Symbol loading failed for %s\n&quot;,file);
-                }
-		}
-        ADM_AudioEncoderLoader(const char *name, const char *menuName) : ADM_LibWrapper()
-		{
-                    encoderBlock=new ADM_audioEncoder;
-                    encoderBlock-&gt;codecName=name;
-                    encoderBlock-&gt;menuName=menuName;                    
-                    encoderBlock-&gt;opaque=(void *)this;
-		}
-        ~ADM_AudioEncoderLoader()
-        {
-            if(encoderBlock) delete encoderBlock;
-            encoderBlock=NULL;
-            
-        }
-};
-
-/**
-        \fn ADM_ae_getPluginNbEncoders
-        \brief Returns the number of av filter plugins except one
-*/
-uint32_t ADM_ae_getPluginNbEncoders(void)
-{
-    return ListOfAudioEncoder.size()-1;
-}
-/**
-    \fn     ADM_ae_getAPluginEncoderInfo
-    \brief  Get Infos about the encoder #th plugin (plugin display)
-*/
-bool     ADM_ae_getAPluginEncoderInfo(int filter, const char **name, uint32_t *major,uint32_t *minor,uint32_t *patch)
-{
-    filter++;
-    ADM_assert(filter&lt;ListOfAudioEncoder.size());
-    *major=ListOfAudioEncoder[filter]-&gt;major;
-    *minor=ListOfAudioEncoder[filter]-&gt;minor;
-    *patch=ListOfAudioEncoder[filter]-&gt;patch;
-    *name=ListOfAudioEncoder[filter]-&gt;description;
-    return true;
-}
-/**
-    \fn tryLoadingFilterPlugin
-    \brief Try loading the file given as argument as an audio device plugin
-
-*/
-#define Fail(x) {printf(&quot;%s:&quot;#x&quot;\n&quot;,file);goto er;}
-static bool tryLoadingFilterPlugin(const char *file)
-{
-	ADM_AudioEncoderLoader *dll=new ADM_AudioEncoderLoader(file);
-    if(!dll-&gt;initialised) Fail(CannotLoad);
-    
-
-    ListOfAudioEncoder.push_back(dll-&gt;encoderBlock); // Needed for cleanup. FIXME TODO Delete it.
-    printf(&quot;[AudioEncoder] Registered filter %s as  %s\n&quot;,file,dll-&gt;encoderBlock-&gt;description);
-    return true;
-	// Fail!
-er:
-	delete dll;
-	return false;
-
-}
-/**
- * 	\fn ADM_ae_loadPlugins
- *  \brief load all audio encoder plugins
- */
-uint8_t ADM_ae_loadPlugins(const char *path)
-{
-#define MAX_EXTERNAL_FILTER 100
-// FIXME Factorize
-
-	char *files[MAX_EXTERNAL_FILTER];
-	uint32_t nbFile;
-    // Add the copy encoder
-    ADM_AudioEncoderLoader *copy=new ADM_AudioEncoderLoader(&quot;copy&quot;,&quot;Copy&quot;);
-    ListOfAudioEncoder.push_back(copy-&gt;encoderBlock);
-    //
-	memset(files,0,sizeof(char *)*MAX_EXTERNAL_FILTER);
-	printf(&quot;[ADM_ae_plugin] Scanning directory %s\n&quot;,path);
-
-	if(!buildDirectoryContent(&amp;nbFile, path, files, MAX_EXTERNAL_FILTER, SHARED_LIB_EXT))
-	{
-		printf(&quot;[ADM_ae_plugin] Cannot parse plugin\n&quot;);
-		return 0;
-	}
-
-	for(int i=0;i&lt;nbFile;i++)
-		tryLoadingFilterPlugin(files[i]);
-
-	printf(&quot;[ADM_ae_plugin] Scanning done\n&quot;);
-
-	return 1;
-}
-/**
-    \fn audioPrintCurrentCodec
-    \brief updates the UI with the current selected audio encoder
-*/
-void UI_setAudioCodec( int i);
-void audioPrintCurrentCodec(void)
-{
-			UI_setAudioCodec(currentEncoder);
-}
-
-/**
-    \fn ADM_encoderByName
-    \brief Returns the Id of the given string 
-
-*/
-AUDIOENCODER ADM_encoderByName(const char *name)
-{
-	if(!name) return (AUDIOENCODER)0;
-    if(!strcasecmp(name,&quot;copy&quot;)) return (AUDIOENCODER)0; // copy
-	for(uint32_t i=1;i&lt;ListOfAudioEncoder.size();i++)
-	{
-		if(!strcasecmp(name,ListOfAudioEncoder[i]-&gt;codecName))
-		{
-			return i;
-		}	
-	}
-	printf(&quot;[AudioEncoder] Encoder not found :%s\n&quot;,name);
-	return (AUDIOENCODER)0;
-
-}
-/**
-    \fn    ADM_audioEncoderById
-    \brief Returns the name of a device from its Id
-*/
-static const char *ADM_audioEncoderById(AUDIOENCODER id)
-{
-
-	ADM_assert(id&lt;ListOfAudioEncoder.size());
-    return ListOfAudioEncoder[id]-&gt;codecName;
-}
-/**
-    \fn AVDM_getCurrentAudioEncoder
-    \brief
-*/
-AUDIOENCODER AVDM_getCurrentAudioEncoder( void)
-{
-	return currentEncoder;
-}
-/**
-    \fn audioCodecSelect
-    \brief Update UI
-*/
-uint8_t DIA_audioCodec( int *codec );
-void audioCodecSelect( void )
-{
- 
-	DIA_audioCodec( &amp;currentEncoder );
-	audioPrintCurrentCodec();
-}
-/**
-    \fn     audioCodecSetByName
-    \brief  only called by JS, we have to update UI as well
-*/
-uint8_t audioCodecSetByName( const char *name)
-{
-		for(uint32_t i=0;i&lt;ListOfAudioEncoder.size();i++)
-		{
-			if(!strcasecmp(name,ListOfAudioEncoder[i]-&gt;codecName))
-			{
-
-				currentEncoder=i;
-                audioPrintCurrentCodec(); // Update UI
-				return 1;
-			}
-
-		}
-		printf(&quot;\n Mmmm Select audio codec by name failed...(%s).\n&quot;,name);
-		return 0;
-}
-/**
-    \fn audioCodecSetByIndex
-    \brief To be used by UI code only!
-*/
-uint8_t audioCodecSetByIndex(int i)
-{
-    ADM_assert(i&lt;ListOfAudioEncoder.size());
-    currentEncoder=i;
-    printf(&quot;[AudioEncoder] Selected %s for index %d, tag 0x%x \n&quot;,ListOfAudioEncoder[currentEncoder]-&gt;codecName,i,ListOfAudioEncoder[currentEncoder]-&gt;wavTag);
-    return 1;
-
-}
-/**
-    \fn audioCodecGetName
-    \brief Returns the current codec tagname
-*/
-const char *audioCodecGetName( void )
-{
-	  ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
-      return ListOfAudioEncoder[currentEncoder]-&gt;codecName;
-
-}
-
-/**
-    \fn audioProcessMode
-    \brief
-    @return 1 in process mode, 0 in copy mode
-*/
-uint32_t audioProcessMode(void)
-{
-        if(!currentEncoder) return 0;
-        return 1;
-}
-/**
- * 	\fn getAudioOuputTag
- *  \brief Return the encoding of the currently selected codec
- *  Must be called only in process mode, else it is meaningless.
- */
-uint32_t audioFilter_getOuputCodec(void)
-{
-	ADM_assert(!currentEncoder);
-    return ListOfAudioEncoder[currentEncoder]-&gt;wavTag;
-}
-
-/**
- * 	\fn audioFilter_getMaxChannels
- *  \brief Return the max # of channels a codec supports
- */
-uint32_t audioFilter_getMaxChannels(void)
-{
-    ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
-	if(!currentEncoder) return 99999;
-	return ListOfAudioEncoder[currentEncoder]-&gt;maxChannels;
-}
-/**
-    \fn audioCodecConfigure
-    \brief
-*/
-void audioCodecConfigure( void )
-{
-    if(ListOfAudioEncoder[currentEncoder]-&gt;configure)
-    ListOfAudioEncoder[currentEncoder]-&gt;configure();
-}
-/**
-    \fn audioGetBitrate
-*/
-uint32_t audioGetBitrate(void)
-{
-    ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
-    if(ListOfAudioEncoder[currentEncoder]-&gt;getBitrate)
-        return ListOfAudioEncoder[currentEncoder]-&gt;getBitrate();
-    return 0;
-} 
-void audioFilter_SetBitrate( int i)
-{
-    ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
-    if(ListOfAudioEncoder[currentEncoder]-&gt;setBitrate)
-        ListOfAudioEncoder[currentEncoder]-&gt;setBitrate(i);
-    
-}
-/**
-    \fn audioEncoderGetNumberOfEncoders
-*/
-uint32_t audioEncoderGetNumberOfEncoders(void)
-{
-    return ListOfAudioEncoder.size();
-}
-/**
-    \fn audioEncoderGetDisplayName
-*/
-const char  *audioEncoderGetDisplayName(uint32_t i)
-{
-     ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
-     return ListOfAudioEncoder[i]-&gt;menuName;
-}
-/**
-        \fn audioEncoderCreate
-        \brief Spawn an audio encoder
-*/
-AUDMEncoder *audioEncoderCreate(AUDMAudioFilter *filter)
-{
-      ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
-      static ADM_audioEncoder *enc=ListOfAudioEncoder[currentEncoder];
-     return enc-&gt;create(filter);
-}
-/**
-        \fn getAudioExtraConf
-        \brief 
-*/
-
-uint8_t getAudioExtraConf(uint32_t *bitrate,uint32_t *extraDataSize, uint8_t **extradata)
-{
-    if(!currentEncoder)
-    {
-        printf(&quot;[AudioEncoder] Cannot get conf on copy!\n&quot;);
-        return 0;
-    }
-     ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
-     ADM_audioEncoder *encoder= ListOfAudioEncoder[currentEncoder];
-     *bitrate=encoder-&gt;getBitrate();
-     if(encoder-&gt;getConfigurationData)
-        return encoder-&gt;getConfigurationData(extraDataSize,extradata);
-     else return 1;
-}
-/**
-    \fn setAudioExtraConf
-*/
-uint8_t setAudioExtraConf(uint32_t bitrate,uint32_t extraDataSize, uint8_t *extradata)
-{
-    if(!currentEncoder)
-    {
-        printf(&quot;[AudioEncoder] Cannot set conf on copy!\n&quot;);
-        return 0;
-    }
-     ADM_assert(currentEncoder&lt;ListOfAudioEncoder.size());
-     ADM_audioEncoder *encoder= ListOfAudioEncoder[currentEncoder];
-     encoder-&gt;setBitrate(bitrate);
-     if(encoder-&gt;setConfigurationData)
-        return encoder-&gt;setConfigurationData(extraDataSize,extradata);
-    else return 1;
-}     
-/**
-        \fn audio_selectCodecByTag
-        \brief Select the &quot;best&quot; encoder outputing tag codec
-*/
-uint8_t audio_selectCodecByTag(uint32_t tag)
-{
-    int selected=-1,priority=-1;
-    for(int i=1;i&lt;ListOfAudioEncoder.size();i++)
-    {
-        ADM_audioEncoder *c=ListOfAudioEncoder[i];
-        if(c-&gt;wavTag==tag)
-        {
-            if((int)c-&gt;priority&gt;priority)
-            {
-                selected=i;
-                priority=c-&gt;priority;
-            }
-        }
-    }
-    if(selected!=-1)
-    {
-        currentEncoder=selected;
-        UI_setAudioCodec( (int)currentEncoder);
-        printf(&quot;[AudioEncoder] Selected %s for tag %d (%s)\n&quot;,ListOfAudioEncoder[currentEncoder]-&gt;codecName,tag,&quot;&quot;);
-        return 1;
-    }
-    return 0;
-}
-/**
-         \fn audioSetOption
-         \brief Allow per codec switch
-*/
-uint8_t audioSetOption(const char *option, uint32_t value)
-{
-    ADM_audioEncoder *c=ListOfAudioEncoder[currentEncoder];
-    if(!c-&gt;setOption) return 0;
-    return c-&gt;setOption(option,value);
-
-}
-/**
-         \fn audio_setCopyCodec
-         \brief Set audio codec to copy
-*/
-uint8_t audio_setCopyCodec(void)
-{
-    currentEncoder=0;
-    return 1;
-
-}
-
-//**

Deleted: branches/avidemux_2.6_branch_mean/avidemux/ADM_audiofilter/audio_encoderPlugin.h
===================================================================

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/include/audioencoder.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/include/audioencoder.h	2009-03-19 17:02:27 UTC (rev 4699)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/include/audioencoder.h	2009-03-21 14:55:57 UTC (rev 4700)
@@ -5,18 +5,18 @@
     email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
  ***************************************************************************/
 
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
 
 #ifndef AUDIO_ENCODER_H
 #define AUDIO_ENCODER_H
-/*!
-  This structure defines an audio encoder
-  \param encoder Encoder attached to this descriptor
-   \param name The name of the codec
-  \param bitrate The bitrate in kb/s
-  \param configure Function to call to configure the codec
-  \param maxChannels The maximum # of channels this codec supports
-  \param param : An opaque structure that contains the codec specific configuration datas
-*/
+
 #include &quot;ADM_coreAudio.h&quot;
 #include &quot;ADM_audioCodecEnum.h&quot;
 #include &quot;ADM_audioFilter.h&quot; 
@@ -64,7 +64,7 @@
                     ADM_AudioEncoder(AUDMAudioFilter *in);	
                     virtual ~ADM_AudioEncoder();
 
-
+    virtual bool    isVBR(void) {return true;}
     virtual bool    initialize(void)=0; /// Returns true if init ok, false if encoding is impossible
     virtual bool    encode(uint8_t *dest, uint32_t *len, uint32_t *samples)=0; /// returns false if eof met
 };

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/include/audioencoderInternal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/include/audioencoderInternal.h	2009-03-19 17:02:27 UTC (rev 4699)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/include/audioencoderInternal.h	2009-03-21 14:55:57 UTC (rev 4700)
@@ -3,20 +3,37 @@
     \brief interface to audio encoder plugins
 
 */
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
 #ifndef AUDIOENCODERINTERNAL_H
 #define AUDIOENCODERINTERNAL_H
 
-#define ADM_AUDIO_ENCODER_API_VERSION 1
+#define ADM_AUDIO_ENCODER_API_VERSION 2
 #include &quot;audioencoder.h&quot;
 class AUDMEncoder;
-class AUDMAudioFilter;
+class ADM_AudioEncoder;
 
-
+/*!
+  This structure defines an audio encoder
+  \param encoder Encoder attached to this descriptor
+   \param name The name of the codec
+  \param bitrate The bitrate in kb/s
+  \param configure Function to call to configure the codec
+  \param maxChannels The maximum # of channels this codec supports
+  \param param : An opaque structure that contains the codec specific configuration datas
+*/
 typedef struct
 {
     uint32_t     apiVersion;            // const
-    AUDMEncoder *(*create)(AUDMAudioFilter *head);  
-    void         (*destroy)(AUDMEncoder *codec);
+    ADM_AudioEncoder *(*create)(AUDMAudioFilter *head);  
+    void         (*destroy)(ADM_AudioEncoder *codec);
     uint8_t      (*configure)(void);    
     const char   *codecName;        // Internal name (tag)
     const char   *menuName;         // Displayed name (in menu)
@@ -44,11 +61,11 @@
 static uint32_t     getBitrate(void); \
 static void         setBitrate(uint32_t br); \
 \
-static AUDMEncoder * create (AUDMAudioFilter * head) \
+static ADM_AudioEncoder * create (AUDMAudioFilter * head) \
 { \
   return new Class (head); \
 } \
-static void destroy (AUDMEncoder * in) \
+static void destroy (ADM_AudioEncoder * in) \
 {\
   Class *z = (Class *) in; \
   delete z; \

Modified: branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/src/audioencoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/src/audioencoder.cpp	2009-03-19 17:02:27 UTC (rev 4699)
+++ branches/avidemux_2.6_branch_mean/avidemux/ADM_coreAudioEncoder/src/audioencoder.cpp	2009-03-21 14:55:57 UTC (rev 4700)
@@ -43,6 +43,7 @@
         _extraData=NULL;
     }
 }
+
 /**
     \fn refillBuffer
 */

Modified: branches/avidemux_2.6_branch_mean/cmake/ae_plugin.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/ae_plugin.cmake	2009-03-19 17:02:27 UTC (rev 4699)
+++ branches/avidemux_2.6_branch_mean/cmake/ae_plugin.cmake	2009-03-21 14:55:57 UTC (rev 4700)
@@ -1,3 +1,6 @@
+#
+#  Macro to declare an audio encoder plugin
+#
 MACRO(INIT_AUDIO_ENCODER _lib)
 	INCLUDE_DIRECTORIES(&quot;${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_core/include&quot;)
 	INCLUDE_DIRECTORIES(&quot;${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_coreAudio/include&quot;)
@@ -2,4 +5,7 @@
 	INCLUDE_DIRECTORIES(&quot;${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_coreUI/include&quot;)
-	INCLUDE_DIRECTORIES(&quot;${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_audiofilter&quot;)
-        ADD_DEFINITIONS(&quot;-DADM_MINIMAL_UI_INTERFACE&quot;)
+	INCLUDE_DIRECTORIES(&quot;${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_audioFilter/include&quot;)
+    INCLUDE_DIRECTORIES(&quot;${AVIDEMUX_SOURCE_DIR}/avidemux/ADM_coreAudioEncoder/include&quot;)
+
+    ADD_DEFINITIONS(&quot;-DADM_MINIMAL_UI_INTERFACE&quot;)
+
 ENDMACRO(INIT_AUDIO_ENCODER)

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/CMakeLists.txt	2009-03-19 17:02:27 UTC (rev 4699)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/CMakeLists.txt	2009-03-21 14:55:57 UTC (rev 4700)
@@ -9,9 +9,9 @@
 MESSAGE(&quot;***  /Audio Codec  ***&quot;)
 
 
-ADD_SUBDIRECTORY(twolame)
-ADD_SUBDIRECTORY(pcm)
-ADD_SUBDIRECTORY(lavcodec)
+#ADD_SUBDIRECTORY(twolame)
+#ADD_SUBDIRECTORY(pcm)
+#ADD_SUBDIRECTORY(lavcodec)
 
 if(USE_LAME)
 ADD_SUBDIRECTORY(lame)
@@ -22,9 +22,9 @@
 endif(USE_AFTEN)
 
 if(USE_VORBIS)
-ADD_SUBDIRECTORY(vorbis)
+#ADD_SUBDIRECTORY(vorbis)
 endif(USE_VORBIS)
 
 if(USE_FAAC)
-ADD_SUBDIRECTORY(faac)
+#ADD_SUBDIRECTORY(faac)
 endif(USE_FAAC)

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp	2009-03-19 17:02:27 UTC (rev 4699)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.cpp	2009-03-21 14:55:57 UTC (rev 4700)
@@ -1,5 +1,7 @@
 /***************************************************************************
-    copyright            : (C) 2006 by mean
+        \file audioencoder_lame.cpp
+        \brief Avidemux audio encoder plugin, front end for libmp3lame
+    copyright            : (C) 2006/2009 by mean
     email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
  ***************************************************************************/
 
@@ -24,7 +26,6 @@
 static LAME_encoderParam myLameParam = {
   128,
   ADM_LAME_PRESET_CBR,		// preset;
-  ADM_STEREO,			//ADM_mode        mode;
   2,				//uint32_t        quality;
   0,				//uint32_t        disableReservoir; // usefull for strict CBR (FLV)
 };
@@ -43,10 +44,10 @@
   configure,		//** put your own function here**
   &quot;Lame&quot;,
   &quot;MP3 (lame)&quot;,
-  &quot;Lame MP3 encoder plugin Mean 2008&quot;,
+  &quot;Lame MP3 encoder plugin Mean 2009&quot;,
   2,                    // Max channels
   1,0,0,                // Version
-  WAV_MP3,
+  WAV_MP3,              // WavTag
   200,                  // Priority
   getConfigurationData,  // Defined by macro automatically
   setConfigurationData,  // Defined by macro automatically
@@ -66,12 +67,11 @@
     \fn AUDMEncoder_Lame Constructor
     \brief
 */
-AUDMEncoder_Lame::AUDMEncoder_Lame (AUDMAudioFilter * instream):AUDMEncoder
-  (instream)
+AUDMEncoder_Lame::AUDMEncoder_Lame (AUDMAudioFilter * instream):ADM_AudioEncoder  (instream)
 {
   printf (&quot;[Lame] Creating lame\n&quot;);
   lameFlags = NULL;
-  _wavheader-&gt;encoding = WAV_MP3;
+  wavheader.encoding = WAV_MP3;
 };
 
 /**
@@ -88,8 +88,6 @@
       lame_close (MYFLAGS);
     }
   lameFlags = NULL;
-  cleanup ();
-
 };
 
 
@@ -99,8 +97,7 @@
     @return 1 on success, 0 on error
 */
 
-uint8_t
-AUDMEncoder_Lame::initialize (void)
+bool AUDMEncoder_Lame::initialize (void)
 {
 
   int ret;
@@ -111,43 +108,31 @@
 
   lameFlags = lame_init ();
   if (lameFlags == NULL)
-    return 0;
+    return false;
 
   if (_incoming-&gt;getInfo ()-&gt;channels &gt; 2)
     {
       printf (&quot;[Lame]Too many channels\n&quot;);
-      return 0;
+      return false;
     }
 
   // recompute output length
 
 
-  ret = lame_set_in_samplerate (MYFLAGS, _wavheader-&gt;frequency);
-  ret = lame_set_num_channels (MYFLAGS, _wavheader-&gt;channels);
+  ret = lame_set_in_samplerate (MYFLAGS, wavheader.frequency);
+  ret = lame_set_num_channels (MYFLAGS,  wavheader.channels);
 
 
-  frequence = _wavheader-&gt;frequency;
+  frequence = wavheader.frequency;
   printf (&quot;[Lame] output frequency : %&quot;LU&quot;\n&quot;, frequence);
   ret = lame_set_out_samplerate (MYFLAGS, frequence);
 
   ret = lame_set_quality (MYFLAGS, 2);
 
-  if (_wavheader-&gt;channels == 2)
+  if (wavheader.channels == 2)
     {
-      switch (lameConf-&gt;mode)
-	{
-	case ADM_STEREO:
-	  mmode = STEREO;
-	  break;
-	case ADM_JSTEREO:
-	  mmode = JOINT_STEREO;
-	  break;
-	default:
-	  printf (&quot;[Lame] **** unknown mode ***\n&quot;);
-	  mmode = STEREO;
-	  break;
 
-	}
+          mmode = STEREO;
     }
   else
     {
@@ -162,9 +147,12 @@
   printf (&quot;[Lame]Using quality of %d\n&quot;, lame_get_quality (MYFLAGS));
   ret = lame_init_params (MYFLAGS);
   if (ret == -1)
-    return 0;
+    {
+        printf(&quot;[Lame] Init params failes %d\n&quot;,ret);
+        return false;
+    }
   // update bitrate in header
-  _wavheader-&gt;byterate = (lameConf-&gt;bitrate &gt;&gt; 3) * 1000;
+  wavheader.byterate = (lameConf-&gt;bitrate &gt;&gt; 3) * 1000;
 #define BLOCK_SIZE 1152
   // configure CBR/ABR/...
 
@@ -176,10 +164,10 @@
     case ADM_LAME_PRESET_ABR:
 
       lame_set_preset (MYFLAGS, lameConf-&gt;bitrate);
-      _wavheader-&gt;blockalign = BLOCK_SIZE;
+      wavheader.blockalign = BLOCK_SIZE;
       break;
     case ADM_LAME_PRESET_EXTREME:
-      _wavheader-&gt;blockalign = BLOCK_SIZE;
+      wavheader.blockalign = BLOCK_SIZE;
       lame_set_preset (MYFLAGS, EXTREME);
       break;
 
@@ -188,33 +176,32 @@
 
   lame_print_config (MYFLAGS);
   lame_print_internals (MYFLAGS);
-  _chunk = BLOCK_SIZE * _wavheader-&gt;channels;
+  _chunk = BLOCK_SIZE * wavheader.channels;
 
-  return 1;
+  return true;
 }
 /**
     \fn isVBR
     @return 1 if the stream is vbr, 0 is cbr
 
 */
-uint8_t AUDMEncoder_Lame::isVBR (void)
+bool AUDMEncoder_Lame::isVBR (void)
 {
   if (myLameParam.preset == ADM_LAME_PRESET_CBR)
-    return 0;
-  return 1;
+    return false;
+  return true;
 
 }
 /**
-    \fn getPacket
+    \fn encode
     \brief Get an encoded mp3 packet
     @param dest [in] Where to write datas
     @param len  [out] Length of encoded datas in bytes
     @param samples [out] Number of samples
-    @return 1 on success, 0 on error
+    @return true on success, false on error
 
 */
-uint8_t AUDMEncoder_Lame::getPacket (uint8_t * dest, uint32_t * len,
-			     uint32_t * samples)
+bool AUDMEncoder_Lame::encode(uint8_t *dest, uint32_t *len, uint32_t *samples)
 {
 
   int32_t nbout;
@@ -224,42 +211,38 @@
 
   if (!refillBuffer (_chunk))
     {
-      return 0;
+      return false;
     }
 
   if (tmptail - tmphead &lt; _chunk)
     {
-      return 0;
+      return false;
     }
-  dither16 (&amp;(tmpbuffer[tmphead]), _chunk, _wavheader-&gt;channels);
+  dither16 (&amp;(tmpbuffer[tmphead]), _chunk, wavheader.channels);
   ADM_assert (tmptail &gt;= tmphead);
-  if (_wavheader-&gt;channels == 1)
+  if (wavheader.channels == 1)
     {
-      nbout =
-	lame_encode_buffer (MYFLAGS, (int16_t *) &amp; (tmpbuffer[tmphead]),
+      nbout =	lame_encode_buffer (MYFLAGS, (int16_t *) &amp; (tmpbuffer[tmphead]),
 			    (int16_t *) &amp; (tmpbuffer[tmphead]), _chunk, dest,
 			    16 * 1024);
 
     }
   else
     {
-      nbout =
-	lame_encode_buffer_interleaved (MYFLAGS,
+      nbout =	lame_encode_buffer_interleaved (MYFLAGS,
 					(int16_t *) &amp; (tmpbuffer[tmphead]),
 					_chunk / 2, dest, 16 * 1024);
     }
   tmphead += _chunk;
   if (nbout &lt; 0)
     {
-      printf (&quot;\n Error !!! : %&quot;LD&quot;\n&quot;, nbout);
-      return 0;
+      printf (&quot;[Lame] Error !!! : %&quot;LD&quot;\n&quot;, nbout);
+      return false;
     }
   *len = nbout;
   if (!*len)
     *samples = 0;
-  //printf(&quot;Audio packet : size %u, sample %u\n&quot;,*len,*samples);
-
-  return 1;
+  return true;
 }
 /**
       \fn configure
@@ -278,26 +261,14 @@
 #define PX(x) &amp;(lameParam-&gt;x)
 
   LAME_encoderParam *lameParam = &myLameParam;
-  mmode = lameParam-&gt;mode;
   ppreset = lameParam-&gt;preset;
-  diaMenuEntry channelMode[] = {
-    {ADM_STEREO, QT_TR_NOOP (&quot;Stereo&quot;), NULL},
-    {ADM_JSTEREO, QT_TR_NOOP (&quot;Joint stereo&quot;), NULL},
-    {ADM_MONO, QT_TR_NOOP (&quot;Mono&quot;), NULL}
-  };
 
-  diaElemMenu menuMode (&amp;mmode, QT_TR_NOOP (&quot;C_hannel mode:&quot;),
-			SZT (channelMode), channelMode);
-
   diaMenuEntry encodingMode[] = {
     {ADM_LAME_PRESET_CBR, QT_TR_NOOP (&quot;CBR&quot;), NULL},
     {ADM_LAME_PRESET_ABR, QT_TR_NOOP (&quot;ABR&quot;), NULL},
-#if 0
-    {ADM_LAME_PRESET_EXTREME, QT_TR_NOOP (&quot;Extreme&quot;), NULL}
-#endif
   };
-  diaElemMenu Mode (&amp;ppreset, QT_TR_NOOP (&quot;Bit_rate mode:&quot;),
-		    SZT (encodingMode), encodingMode);
+  diaElemMenu Mode (&amp;ppreset, QT_TR_NOOP (&quot;Bit_rate mode:&quot;),   SZT (encodingMode), encodingMode);
+
 #define BITRATE(x) {x,QT_TR_NOOP(#x)}
   diaMenuEntry bitrateM[] = {
     BITRATE (56),
@@ -318,9 +289,9 @@
   diaElemToggle reservoir (PX (disableReservoir),
 			   QT_TR_NOOP (&quot;_Disable reservoir:&quot;));
 
-  diaElem *elems[] = { &amp;menuMode, &amp;Mode, &amp;quality, &amp;bitrate, &amp;reservoir };
+  diaElem *elems[] = { &amp;Mode, &amp;bitrate,&amp;quality, &amp;reservoir };
 
-  if (diaFactoryRun (QT_TR_NOOP (&quot;LAME Configuration&quot;), 5, elems))
+  if (diaFactoryRun (QT_TR_NOOP (&quot;LAME Configuration&quot;), 4, elems))
     {
       return 1;
     }

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.h
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.h	2009-03-19 17:02:27 UTC (rev 4699)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame.h	2009-03-21 14:55:57 UTC (rev 4700)
@@ -12,25 +12,27 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#ifndef AUDMaudioLame
-#define AUDMaudioLame
+#ifndef AUDMaudioLame_H
+#define AUDMaudioLame_H
 
- //_____________________________________________
-class AUDMEncoder_Lame : public AUDMEncoder
+ /**
+        \class AUDMEncoder_Lame
+        \brief Front end for libmp3lame
+*/
+class AUDMEncoder_Lame : public ADM_AudioEncoder
 {
   protected:
    
     void              *lameFlags;
-    
+    uint32_t          _chunk; // Nb of float we encode each time
          
   public:
-//            uint8_t     init(ADM_audioEncoderDescriptor *config);
     virtual             ~AUDMEncoder_Lame();
                         AUDMEncoder_Lame(AUDMAudioFilter *instream);	
-            uint8_t	isVBR(void );
+            bool	    isVBR(void );
             
-   virtual uint8_t	getPacket(uint8_t *dest, uint32_t *len, uint32_t *samples);
-   virtual uint8_t  initialize(void);
+   virtual bool         encode(uint8_t *dest, uint32_t *len, uint32_t *samples);
+   virtual bool         initialize(void);
 };
 
 #endif

Modified: branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame_param.h
===================================================================
--- branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame_param.h	2009-03-19 17:02:27 UTC (rev 4699)
+++ branches/avidemux_2.6_branch_mean/plugins/ADM_audioEncoders/lame/audioencoder_lame_param.h	2009-03-21 14:55:57 UTC (rev 4700)
@@ -26,7 +26,6 @@
 {
   uint32_t        bitrate; // in kbps
   ADM_LAME_PRESET preset;
-  ADM_mode        mode;
   uint32_t        quality;
   uint32_t        disableReservoir; // usefull for strict CBR (FLV)
 }LAME_encoderParam;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001928.html">[Avidemux-svn-commit] r4699 - in	branches/avidemux_2.6_branch_mean/avidemux:	ADM_coreAudioEncoder/include ADM_coreAudioEncoder/src ADM_toolkit
</A></li>
	<LI>Next message: <A HREF="001930.html">[Avidemux-svn-commit] r4701 - in branches/avidemux_2.6_branch_mean:	avidemux/ADM_audioFilter/include avidemux/ADM_audioFilter/src	avidemux/ADM_audiofilter avidemux/ADM_coreAudioEncoder/include	plugins/ADM_audioEncoders plugins/ADM_audioEncoders/lame	plugins/ADM_audioEncoders/twolame
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1929">[ date ]</a>
              <a href="thread.html#1929">[ thread ]</a>
              <a href="subject.html#1929">[ subject ]</a>
              <a href="author.html#1929">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
