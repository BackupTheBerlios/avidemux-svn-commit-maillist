<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r3268 - in	branches/avidemux_2.4_branch/avidemux:	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_commonUI ADM_video ADM_videoFilter
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2007-June/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3268%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%0A%09ADM_userInterfaces/ADM_NONE/ADM_dialog%0A%09ADM_userInterfaces/ADM_QT4/ADM_dialog%0A%09ADM_userInterfaces/ADM_commonUI%20ADM_video%20ADM_videoFilter&In-Reply-To=%3C200706171543.l5HFhURH027205%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000556.html">
   <LINK REL="Next"  HREF="000558.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r3268 - in	branches/avidemux_2.4_branch/avidemux:	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_commonUI ADM_video ADM_videoFilter</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3268%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%0A%09ADM_userInterfaces/ADM_NONE/ADM_dialog%0A%09ADM_userInterfaces/ADM_QT4/ADM_dialog%0A%09ADM_userInterfaces/ADM_commonUI%20ADM_video%20ADM_videoFilter&In-Reply-To=%3C200706171543.l5HFhURH027205%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r3268 - in	branches/avidemux_2.4_branch/avidemux:	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_commonUI ADM_video ADM_videoFilter">mean at mail.berlios.de
       </A><BR>
    <I>Sun Jun 17 17:43:30 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000556.html">[Avidemux-svn-commit] r3267 - in	branches/avidemux_2.4_branch/avidemux: ADM_video ADM_videoFilter
</A></li>
        <LI>Next message: <A HREF="000558.html">[Avidemux-svn-commit] r3269 - branches/avidemux_2.4_branch/po
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#557">[ date ]</a>
              <a href="thread.html#557">[ thread ]</a>
              <a href="subject.html#557">[ subject ]</a>
              <a href="author.html#557">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2007-06-17 17:43:29 +0200 (Sun, 17 Jun 2007)
New Revision: 3268

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidMPLResize.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidResize25.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidTDeint_param.h
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidTdeint.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidTdeint_util.txt
Removed:
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidMPLResize.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidResize25.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTDeint_param.h
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTdeint.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTdeint_util.txt
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_tdeint.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_video/CMakeLists.txt
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/CMakeLists.txt
Log:
move more files

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2007-06-17 15:31:18 UTC (rev 3267)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2007-06-17 15:43:29 UTC (rev 3268)
@@ -42,7 +42,6 @@
 #include &quot;ADM_audiofilter/audioencoder_lame_param.h&quot;
 #include &quot;ADM_encoder/adm_encmjpeg_param.h&quot;
 #include &quot;ADM_video/ADM_vidPartial_param.h&quot;
-#include &quot;ADM_video/ADM_vidTDeint_param.h&quot;
 #include &quot;ADM_video/ADM_vidEqualizer.h&quot;
 #include &quot;ADM_video/ADM_vidHue.h&quot;
 #include &quot;ADM_video/ADM_vobsubinfo.h&quot;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-06-17 15:31:18 UTC (rev 3267)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-06-17 15:43:29 UTC (rev 3268)
@@ -42,7 +42,6 @@
 #include &quot;ADM_audiofilter/audioencoder_lame_param.h&quot;
 #include &quot;ADM_encoder/adm_encmjpeg_param.h&quot;
 #include &quot;ADM_video/ADM_vidPartial_param.h&quot;
-#include &quot;ADM_video/ADM_vidTDeint_param.h&quot;
 #include &quot;ADM_video/ADM_vidEqualizer.h&quot;
 #include &quot;ADM_video/ADM_vidHue.h&quot;
 #include &quot;ADM_video/ADM_vobsubinfo.h&quot;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_tdeint.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_tdeint.cpp	2007-06-17 15:31:18 UTC (rev 3267)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_tdeint.cpp	2007-06-17 15:43:29 UTC (rev 3268)
@@ -31,7 +31,7 @@
 
 #include &quot;ADM_userInterfaces/ADM_commonUI/DIA_factory.h&quot;
 #include &quot;ADM_assert.h&quot; 
-#include &quot;ADM_video/ADM_vidTDeint_param.h&quot;
+#include &quot;ADM_videoFilter/ADM_vidTDeint_param.h&quot;
 /**
       \fn DIA_tdeint
       \brief Dialog for tdeint filter

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidMPLResize.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidMPLResize.cpp	2007-06-17 15:31:18 UTC (rev 3267)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidMPLResize.cpp	2007-06-17 15:43:29 UTC (rev 3268)
@@ -1,353 +0,0 @@
-/***************************************************************************
-                          ADM_MPLvidResize.cpp  -  description
-                             -------------------
-
-			     Wrapper for Mplayer resizer by Michael Niedermayer
-			     See swscale* for the actual resizing code.
-
-
-    begin                : Thu Apr 16 2003
-    copyright            : (C) 2002 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;math.h&gt;
-#include &lt;ADM_assert.h&gt;
-
-#include &quot;fourcc.h&quot;
-#include &quot;avio.hxx&quot;
-#include &quot;avi_vars.h&quot;
-
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-#include &quot;ADM_editor/ADM_edit.hxx&quot;
-#include &quot;ADM_video/ADM_genvideo.hxx&quot;
-#include &quot;ADM_video/ADM_vidCommonFilter.h&quot;
-
-
-
-
-#if (defined( ARCH_X86)  || defined(ARCH_X86_64))
-extern &quot;C&quot; {
-#include &quot;ADM_lavcodec/avcodec.h&quot;
-}
-#endif
-
-#include &quot;../ADM_lavutil/avutil.h&quot;
-#include &quot;../ADM_libswscale/swscale.h&quot;
-#include &quot;ADM_osSupport/ADM_cpuCap.h&quot;
-#include &quot;ADM_filter/video_filters.h&quot;
-
-typedef struct alg
-{
-					int in;
-					char *name;
-}alg;
-#define DECLARE(y) {SWS_##y,(char *)#y}
-
-/**
-	Convert mplayer-resize numbering &lt;--&gt; avidemux one
-
-*/
-alg algs[]={
-				DECLARE(BILINEAR),
-				DECLARE(BICUBIC),
-				DECLARE(LANCZOS)
-		};
-
-
-
-
-class  AVDMVideoStreamMPResize:public AVDMGenericVideoStream
- {
-
- protected:
-				RESIZE_PARAMS 	*_param;
-				SwsContext	*_context;
-				uint8_t 	reset(uint32_t nw, uint32_t old,uint32_t algo);
-				uint8_t		clean( void );
- public:
-
-  				AVDMVideoStreamMPResize(  AVDMGenericVideoStream *in,CONFcouple *setup);
-				AVDMVideoStreamMPResize(	AVDMGenericVideoStream *in,uint32_t x,uint32_t y);
-  				virtual 		~AVDMVideoStreamMPResize();
-          virtual 		uint8_t getFrameNumberNoAlloc(uint32_t frame, uint32_t *len,
-          							ADMImage *data,uint32_t *flags);
-				uint8_t configure( AVDMGenericVideoStream *instream);
-	virtual 		char 	*printConf(void) ;
-
-          virtual uint8_t	getCoupledConf( CONFcouple **couples);
-
-
- }     ;
-static FILTER_PARAM mpresizeParam={3,{&quot;w&quot;,&quot;h&quot;,&quot;algo&quot;}};
-
-BUILD_CREATE(mpresize_create,AVDMVideoStreamMPResize);
-SCRIPT_CREATE(mpresize_script,AVDMVideoStreamMPResize,mpresizeParam);
-
-extern uint8_t DIA_resize(uint32_t *width,uint32_t *height,uint32_t *algo,uint32_t originalw, uint32_t originalh,uint32_t fps);
-static int getResizeParams(uint32_t * w, uint32_t * h, uint32_t * algo,uint32_t ow,uint32_t oh,uint32_t fps);
-
-
-uint8_t AVDMVideoStreamMPResize::configure(AVDMGenericVideoStream * instream)
-{
-    UNUSED_ARG(instream);
-
-    RESIZE_PARAMS *par;
-//    uint8_t ret=0;
-
-
-    par = _param;
-
-
-
-    if (!getResizeParams(&amp;par-&gt;w, &amp;par-&gt;h, &amp;par-&gt;algo,instream-&gt;getInfo()-&gt;width,instream-&gt;getInfo()-&gt;height,
-    				_info.fps1000))
-      {
-	  return 0;
-      }
-      printf(&quot;\n OK was selected \n&quot;);
-    // update other parameters
-    _info.width = _param-&gt;w;
-    _info.height = _param-&gt;h;
-	// do update the filter
-	reset(_param-&gt;w,_param-&gt;h,_param-&gt;algo);
-    return 1;
-
-}
-
-//
-//  
-//
-
-int getResizeParams(uint32_t * w, uint32_t * h, uint32_t * algo,uint32_t ow,uint32_t oh,uint32_t fps)
-{
-uint32_t ww,hh;
-	while(1)
-	{
-		ww=*w;
-		hh=*h;
-  		if(!DIA_resize(&amp;ww,&amp;hh,algo,ow,oh,fps)) return 0;
-                if(!ww || !hh) GUI_Error_HIG(_(&quot;Width and height cannot be 0&quot;), NULL);
-		else
-                  if( ww&amp;1 || hh &amp;1) GUI_Error_HIG(_(&quot;Width and height cannot be odd&quot;), NULL);
-			else
-			{
-				*w=ww;
-				*h=hh;
-				return 1;
-			}
-	}
-}
-uint8_t AVDMVideoStreamMPResize::clean(void)
-{
-		if(_context)
-		{
-			sws_freeContext(_context);
-		}
-		_context=NULL;
-		return 1;
-}
-
-uint8_t AVDMVideoStreamMPResize::reset(uint32_t nw, uint32_t old,uint32_t algo)
-{
- 				 SwsFilter 		    *srcFilter=NULL;
-				 SwsFilter		    *dstFilter=NULL;
-				 int 			   flags=0;
-
-
-				clean();
-
-				 // swsGetFlagsAndFilterFromCmdLine(&amp;flags, &amp;srcFilter, &amp;dstFilter);
-
-//SwsContext *getSwsContextFromCmdLine(int srcW, int srcH, int srcFormat, int dstW, int dstH, int dstFormat);
-
-					flags=algo;
-					switch(flags)
-					{
-						case 0: //bilinear
-								flags=SWS_BILINEAR;break;
-						case 1: //bicubic
-								flags=SWS_BICUBIC;break;
-						case 2: //Lanczos
-								flags=SWS_LANCZOS;break;
-						default:ADM_assert(0);
-
-					}
-#if (defined( ARCH_X86)  || defined(ARCH_X86_64))
-		
-		#define ADD(x,y) if( CpuCaps::has##x()) flags|=SWS_CPU_CAPS_##y;
-		ADD(MMX,MMX);		
-		ADD(3DNOW,3DNOW);
-		ADD(MMXEXT,MMX2);
-#endif	
-#ifdef USE_ALTIVEC
-		flags|=SWS_CPU_CAPS_ALTIVEC;
-#endif
-				    _context=sws_getContext(
-				    		_in-&gt;getInfo()-&gt;width,_in-&gt;getInfo()-&gt;height,
-						PIX_FMT_YUV420P,
-		 				nw,old,
-	   					PIX_FMT_YUV420P,
-	    					flags, srcFilter, dstFilter,NULL);
-
-				if(!_context) return 0;
-				return 1;
-
-
-}
-char *AVDMVideoStreamMPResize::printConf( void )
-{
- 	static char buf[50];
-
- 	sprintf((char *)buf,&quot; MPL Resize %lu x %lu --&gt; %lu x %lu (%s)&quot;,
- 				_in-&gt;getInfo()-&gt;width,
- 				_in-&gt;getInfo()-&gt;height,
- 				_info.width,
- 				_info.height,
-				algs[_param-&gt;algo].name);
-        return buf;
-}
-//_______________________________________________________________
-AVDMVideoStreamMPResize::AVDMVideoStreamMPResize(
-									AVDMGenericVideoStream *in,CONFcouple *couples)
-{
-
-  	_in=in;
-   	memcpy(&amp;_info,_in-&gt;getInfo(),sizeof(_info));
-	//_uncompressed=(uint8_t *)malloc(3*_info.width*_info.height);
-//	_uncompressed=new uint8_t[3*_info.width*_info.height];
-	_uncompressed=new ADMImage(_info.width,_info.height);
-
-		if(couples)
-		{
-			 _param=NEW(RESIZE_PARAMS);
-			GET(w);
-			GET(h);
-			GET(algo);
-			_info.width=_param-&gt;w;
-			_info.height=_param-&gt;h;
-
-		}
-			else
-			{
-				_param=NEW( RESIZE_PARAMS);
-				_param-&gt;w=_info.width;
-				_param-&gt;h = _info.height;
-			    _param-&gt;algo = 0;
-			}
-
-	_context=NULL;
-	reset(_param-&gt;w,_param-&gt;h,_param-&gt;algo);
-  _info.encoding=1;
-
-}
-#ifdef MPLAYER_RESIZE_PREFFERED
-AVDMGenericVideoStream *createResizeFromParam(AVDMGenericVideoStream *in,uint32_t x,uint32_t y)
-{
-
-	return new AVDMVideoStreamMPResize(in,x,y);
-}
-#endif
-AVDMVideoStreamMPResize::AVDMVideoStreamMPResize(
-									AVDMGenericVideoStream *in,uint32_t x,uint32_t y)
-{
-
-  	_in=in;
-   	memcpy(&amp;_info,_in-&gt;getInfo(),sizeof(_info));
-	_uncompressed=new ADMImage(_info.width,_info.height);
-	_param=NEW( RESIZE_PARAMS);
-	_param-&gt;w=x;
-	_param-&gt;h = y;
-	_info.width=_param-&gt;w;
-	_info.height=_param-&gt;h;
-	_param-&gt;algo = 0;
-
-	_context=NULL;
-	reset(_param-&gt;w,_param-&gt;h,_param-&gt;algo);
-
-}
-
-uint8_t	AVDMVideoStreamMPResize::getCoupledConf( CONFcouple **couples)
-{
-
-			ADM_assert(_param);
-			*couples=new CONFcouple(3);
-
-#define CSET(x)  (*couples)-&gt;setCouple((char *)#x,(_param-&gt;x))
-	CSET(w);
-	CSET(h);
-	CSET(algo);
-			return 1;
-
-}
-// ___ destructor_____________
-AVDMVideoStreamMPResize::~AVDMVideoStreamMPResize()
-{
- 	delete  _uncompressed;
-	_uncompressed=NULL;
-
-	DELETE(_param);
-	clean();
-
-}
-
-//
-//	Basically ask a uncompressed frame from editor and ask
-//		GUI to decompress it .
-//
-
-uint8_t AVDMVideoStreamMPResize::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-			if(frame&gt;=_info.nb_frames) 
-			{
-				printf(&quot;Filter : out of bound!\n&quot;);
-				return 0;
-			}
-	
-			ADM_assert(_param);
-
-       			if(!_in-&gt;getFrameNumberNoAlloc(frame, len,_uncompressed,flags)) return 0;
-
-			uint8_t *src[3];
-			uint8_t *dst[3];
-			int ssrc[3];
-			int ddst[3];
-
-			uint32_t page;
-
-			page=_in-&gt;getInfo()-&gt;width*_in-&gt;getInfo()-&gt;height;
-			src[0]=YPLANE(_uncompressed);
-			src[1]=UPLANE(_uncompressed);
-			src[2]=VPLANE(_uncompressed);
-
-			ssrc[0]=_in-&gt;getInfo()-&gt;width;
-			ssrc[1]=ssrc[2]=_in-&gt;getInfo()-&gt;width&gt;&gt;1;
-
-			page=_info.width*_info.height;
-			dst[0]=YPLANE(data);
-			dst[1]=UPLANE(data);
-			dst[2]=VPLANE(data);
-			ddst[0]=_info.width;
-			ddst[1]=ddst[2]=_info.width&gt;&gt;1;
-
-			sws_scale(_context,src,ssrc,0,_in-&gt;getInfo()-&gt;height,dst,ddst);
-			data-&gt;copyInfo(_uncompressed);
-	return 1;
-}
-

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidResize25.cpp
===================================================================

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTDeint_param.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTDeint_param.h	2007-06-17 15:31:18 UTC (rev 3267)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTDeint_param.h	2007-06-17 15:43:29 UTC (rev 3268)
@@ -1,314 +0,0 @@
-#ifndef ADM_VID_TDEINT_PARAM_H
-#define ADM_VID_TDEINT_PARAM_H
-typedef struct TDEINT_PARAM
-{
-    
-/*  mode:
-  
-      Sets the mode of operation.  Modes -2 and -1 require progressive input.
-
-         -2 - double height using modified ELA
-         -1 - double height using modified ELA-2
-          0 - same rate output
-          1 - double rate output (bobbing)
-
-      default -  0  (int)  &gt;&gt;&gt;&gt;&gt;&gt;&gt;FOR AVIDEMUX ONLY 0 IS SUPPORTED &lt;&lt;&lt;&lt;
-*/
-	int32_t mode; //int
-	
-/*
-      Sets the field order of the video.
-
-        -1 - use parity from AviSynth
-         0 - bottom field first (bff)
-         1 - top field first (tff)
-     
-      default -  -1  (int)
-      */
-	int32_t order; // int
-
-
-/*
-      When in mode 0, this sets the field to be interpolated (i.e. the other field is kept as 
-      is and this field will be constructed).  When in mode 1 this setting does nothing.
-
-        -1 - will set field to 1 if hints = false or 0 if hints is set to true
-         0 - interpolate top field (keep bottom field)
-         1 - interpolate bottom field (keep top field)
-  
-      default -  -1  (int)
-
-*/
-	int32_t field; //int
-/*
-   mthreshL/mthreshC:
-
-      The motion thresholds for luma and chroma (mthreshL for luma, mthreshC for chroma). If
-      the difference between two pixels is less then this value they are declared static.
-      Smaller values will reduce residual combing, larger values will decrease flicker and
-      increase the accuracy of field construction in static areas.  The spatially corresponding
-      parts of the luma and chroma planes are linked (if link != 0), so mthreshC and mthreshL 
-      may be somewhat interconnected.  Setting both values to 0 or below will disable motion 
-      adaptation (i.e. every pixel will be declared moving) allowing for a dumb bob.
-
-      default - mthreshL - 6  (int)
-                mthreshC - 6
-
-
-		*/
-	uint32_t mthreshL,mthreshC; //int
-/*
-	 map:
-
-      Displays an output map instead of the deinterlaced frame.  There are three possible
-      options.  **Note: the maps will not be displayed if the current frame is not being 
-      deinterlaced due to overrides, hints, full=false, or tryWeave=true.
-
-      **AP post-processing is currently not taken into account when using map = 1 or 2.
-
-         0 - no map
-         1 - value (binary) map.  This will output a frame in which all the pixels
-             have one of the following values (indicating how the frame is to be
-             constructed):
-                 0   (use pixel from current frame)
-                 51  (use pixel from previous frame)
-                 102 (use pixel from next frame)
-                 153 (use average of curr/next)
-                 204 (use average of curr/prev)
-                 255 (interpolate pixel)
-         2 - merged map.  This will output a frame in which all the static parts of the 
-             frame (values 0, 51, 102, 153, and 204 from map=1) have been constructed 
-             as they would appear in the deinterlaced frame, and the pixels that are to be 
-             interpolated are marked in white.
-
-      default - 0  (int)
-*/
-	uint32_t map; //int
-	/*
-	   type:
-
-      Sets the type of interpolation to use.  Cubic is the fastest, modified ELA and ELA2 will give
-      smoother, less &quot;jaggy&quot;, edges and are the slowest (ELA2 is faster), and kernel interpolation 
-      will cause significantly less flickering then cubic or ela when interpolation gets used in 
-      almost static areas.  Modified ELA/ELA2 works best with anime/cartoon type material... it is not
-      that great with real life sources (sometimes it is, test for yourself).
-
-         0 - cubic interpolation
-         1 - modified ELA interpolation
-         2 - kernel interpolation (can be normal or sharp, controlled by the sharp setting)
-         3 - modified ELA-2 interpolation
-
-      default - 2  (int)
-      */
-	uint32_t type; //
-/*
-	  debug:
-
-      Will enable debug output, which for each frame will list the values of order, field, 
-      mthreshL, mthreshC, and type if the frame is being deinterlaced.  If the frame is
-      not being deinterlaced (due to user overrides, hints, or full=false) it will simply 
-      say the frame is not being deinterlaced and list the specific reason. If the output
-      frame is weaved, then debug output will report which field the current field was
-      weaved with (PREV or NEXT).
-
-      default - false  (bool)
-      */
-	uint32_t debug; // int
-	/*
- mtnmode:
-
-      Controls whether a 4 field motion check or a 5 field motion check is used.  5 field 
-      will prevent more artifacts and can deal with duplicate interlaced frames, however
-      it is quite a bit slower then the 4 field motion check.  Modes 2 and 3 are like 0 and
-      1 except that in areas where an average of the prev and next field would have been
-      used in mode 0 or 1, the pixel value from the most similar field (computed via field 
-      differencing) is used instead (i.e. no averages are used).
-
-         0 - 4 field check
-         1 - 5 field check
-         2 - 4 field check (no averages, replace with most similar field)
-         3 - 5 field check (no averages, replace with most similar field)
-
-      default - 1  (int)
-*/
-	uint32_t mtnmode;
-/*
-   sharp:
-
-      Controls whether the sharp or normal kernel is used when using kernel interpolation (type
-      = 2).  The sharp kernel includes more pixels and produces a sharper result, but is
-      slightly slower.
- 
-         true - use sharp kernel
-         false - use normal kernel
-
-      default - true  (bool)
-*/
-	uint32_t sharp;
-	/*
-	  full:
-
-      If full is set to true, then all frames are processed as usual.  If full=false, all frames
-      are first checked to see if they are combed.  If a frame isn't combed then it is returned 
-      as is.  If a frame is combed then it is processed as usual.  The parameters that effect 
-      combed frame detection are cthresh, chroma, blockx, blocky, and MI.  Full=false allows 
-      TDeint to be an ivtc post-processor without the need for hints.
-
-         true - normal processing
-         false - check all input frames for combing first
-  
-      default - true  (bool)
-      */
-	uint32_t full;
-	/*
- cthresh:
-
-      Area combing threshold used for combed frame detection.  It is like dthresh or dthreshold
-      in telecide() and fielddeinterlace().  This essentially controls how &quot;strong&quot; or &quot;visible&quot;
-      combing must be to be detected.  Good values are from 6 to 12, if you know your source has 
-      a lot of combed frames set this towards the low end (6-7), if you know your source has
-      very few combed frames set this higher (10-12).  Going much lower then 5 to 6 or much 
-      higher then 12 is not recommended.
-
-      default - 6  (int)
-*/
-	uint32_t cthresh;
-/*
-   blockx -
-
-      Sets the x-axis size of the window used during combed frame detection.  This has to do with 
-      the size of the area in which MI number of pixels are required to be detected as combed for 
-      a frame to be declared combed.  See the MI parameter description for more info.  Possible 
-      values are any number that is a power of 2 starting at 4 and going to 2048 (i.e. 4, 8, 16, 
-      32, ... 2048).
-
-      Default:  16  (int)
-*/
-	uint32_t blockx;
-/*
-   blocky -
-
-      Sets the y-axis size of the window used during combed frame detection.  This has to do with 
-      the size of the area in which MI number of pixels are required to be detected as combed for 
-      a frame to be declared combed.  See the MI parameter description for more info.  Possible 
-      values are any number that is a power of 2 starting at 4 and going to 2048 (i.e. 4, 8, 16, 
-      32, ... 2048).
-
-      Default:  16  (int)
-*/
-	uint32_t blocky;
- /* 
-   chroma:
-
-      Includes chroma combing in the decision about whether a frame is combed.  Only use this if
-      you have one of those weird sources where the chroma can be temporally separated from the luma
-      (i.e. the chroma moves but the luma doesn't in a field).  Otherwise it will just end up 
-      screwing up the decision most of the time.
-
-         true - include chroma combing
-         false - don't
- 
-      default - false  (bool)
-      */
-	uint32_t chroma;
-/*
-	 MI:
-
-      # of combed pixels inside any of the blockx by blocky sized blocks on the frame for the 
-      frame to be considered combed.  While cthresh controls how &quot;visible&quot; or &quot;strong&quot; the combing 
-      must be, this setting controls how much combing there must be in any localized area (a 
-      blockx by blocky sized window) on the frame.  Min setting = 0, max setting = blockx x blocky
-      (at which point no frames will ever be detected as combed).
-
-      default - 64  (int)
-*/
-	uint32_t MI;
-/*
-   tryWeave:
-
-      If set to true, when TDeint deinterlaces a frame it will first calculate which field
-      (PREV or NEXT) is most similar to the current field.  It will then weave this field
-      to create a new frame and check this new frame for combing.  If the new frame is not
-      combed, then it returns it. If it is, then it deinterlaces using the usual per-pixel
-      motion adaptation.  Basically, this setting allows TDeint to try to use per-field
-      motion adaptation instead of per-pixel motion adaptation where possible.
-
-      default - false  (bool)
-*/
-	uint32_t tryWeave;
-  /* 
-   link:
-
-      Controls how the three planes (YUV) are linked during comb map creation. Possible
-      settings:
-
-        0 - no linking
-        1 - Full linking (each plane to every other)
-        2 - Y to UV (luma to chroma)
-        3 - UV to Y (chroma to luma)
-
-      default - 2  (int)
-*/
-	uint32_t link;
-/*
-   denoise:
-
-      Controls whether the comb map is denoised or not.  True enables denoising, false disables.
-
-      default - true  (bool)
-*/
-	uint32_t denoise;
-/*
-   AP:
-
-      Artifact protection threshold.  If AP is set to a value greater than or equal to 0, then
-      before outputting a deinterlaced frame TDeint will scan all weaved pixels to see if any
-      create a value greater then AP.  Any pixels that do will be interpolated.  Use this to
-      help prevent very obvious motion adaptive related artifacts, a large value is recommended
-      (25+, or as large as removes the artifacts that can be seen during full-speed playback) as 
-      smaller values will destroy the benefits of motion adaptivity in static, detailed areas.
-      The AP metric is the same as the cthresh metric so the scale is 0-255... at zero everything
-      but completely flat areas will be detected as combing, at 255 nothing will be detected.
-      Using AP will slow down processing. Set AP to a value less then 0 or greater than
-      254 to disable.
-
-      default - -1 (disabled)  (int)
-
-*/
-	int32_t AP;
-	/*
-   APType
-
-      When AP post-processing is being used (AP is set &gt;= 0 and &lt; 255), APType controls whether
-      the motion of surrounding pixels should be taken into account.  There are 3 possible 
-      settings:
-
-        0 = Don't take surrounding motion into account.  If a weaved pixel creates a value that
-            exceeds the AP threshold then it will be interpolated.
-
-        1 = If a weaved pixel creates a value that exceeds the AP threshold and at least half of
-            pixels in a 5x5 window centered on that pixel were detected as moving, then that
-            pixel will be interpolated.
-
-        2 = Exactly like 1, except instead of 1/2 only 1/3 of the pixels in the surrounding 5x5 
-            window must have been detected as moving.
-
-      Modes 1 and 2 provide a way to catch more artifacts (low AP values) without completely 
-      sacrificing static areas.
-
-
-      default -  1  (int)
-         */
-	uint32_t APType;
-
-}TDEINT_PARAM;
-#endif
-//EOF
-
-
-
-
-
-
-
-

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTdeint.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTdeint.cpp	2007-06-17 15:31:18 UTC (rev 3267)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTdeint.cpp	2007-06-17 15:43:29 UTC (rev 3268)
@@ -1,839 +0,0 @@
-
-/***************************************************************************
-                         
-        Tdeint
-
-    copyright            : Tritical, ported to avidemux by mean
-   <A HREF="http://bengal.missouri.edu/~kes25c/">http://bengal.missouri.edu/~kes25c/</A>
- ***************************************************************************/
-/*
-**                TDeinterlace v1.0b4 for AviSynth 2.5.x
-**
-**   TDeinterlace is a bi-directionally motion adaptive deinterlacer.
-**   It also uses a couple modified forms of ela interpolation which 
-**   help to reduce &quot;jaggy&quot; edges in places where interpolation must 
-**   be used. TDeinterlace currently supports YV12 and YUY2 colorspaces.
-**   
-**   Copyright (C) 2004-2005 Kevin Stone
-**
-**   This program is free software; you can redistribute it and/or modify
-**   it under the terms of the GNU General Public License as published by
-**   the Free Software Foundation; either version 2 of the License, or
-**   (at your option) any later version.
-**
-**   This program is distributed in the hope that it will be useful,
-**   but WITHOUT ANY WARRANTY; without even the implied warranty of
-**   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**   GNU General Public License for more details.
-**
-**   You should have received a copy of the GNU General Public License
-**   along with this program; if not, write to the Free Software
-**   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-*/
-
-#include &quot;config.h&quot;
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;ADM_assert.h&gt;
-
-#include &quot;config.h&quot;
-#include &quot;fourcc.h&quot;
-#include &quot;avio.hxx&quot;
-#include &quot;default.h&quot;
-#include &quot;math.h&quot;
-
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-#include &quot;ADM_editor/ADM_edit.hxx&quot;
-#include &quot;ADM_video/ADM_genvideo.hxx&quot;
-
-#include &quot;ADM_osSupport/ADM_debugID.h&quot;
-#define MODULE_NAME MODULE_FILTER
-#include &quot;ADM_osSupport/ADM_debug.h&quot;
-#include &quot;ADM_video/ADM_cache.h&quot;
-#include &quot;ADM_filter/video_filters.h&quot;
-#include &quot;ADM_userInterfaces/ADM_commonUI/DIA_enter.h&quot;
-#include &quot;ADM_osSupport/ADM_cpuCap.h&quot;
-
-#define min MIN
-#define max MAX
-
-#define MIN(a,b) a&lt;b ? a : b
-#define MAX(a,b) b&lt;a ? a : b
-#define child_GetParity(x) 0 //FIXME!!
-#define OutputDebugString printf
-
-#include &quot;ADM_vidTDeint_param.h&quot;
-#define PRM(x) x
-class vidTDeint:public AVDMGenericVideoStream
-{
-
-protected:
-virtual char          *printConf (void);
-VideoCache            *vidCache;
-ADMImage              *rebuild,*scratch,*scratch2;
-TDEINT_PARAM          *_param;
-/* Will go to param */
-int mode, order, field, ovrDefault, type, mtnmode;
-	int mthreshL, mthreshC, map, cthresh, MI, link;
-	int countOvr, nfrms, nfrms2, orderS, fieldS;
-	int mthreshLS, mthreshCS, typeS, cthresh6, AP;
-	int xhalf, yhalf, xshift, yshift, blockx, blocky;
-	int mntmode;
-	
-	int *input, *cArray, APType;
-	unsigned int passHint;
-	unsigned long accumN, accumP;
-	bool debug, sharp, hints, full, chroma;
-	bool autoFO, useClip2, tryWeave, denoise;
-	const char* ovr;
-	char buf[120];
-/* Will go to param */
-void  copyFrame(ADMImage *dst,ADMImage *src);
-
-unsigned char         cubicInt(unsigned char p1, unsigned char p2, unsigned char p3,unsigned char p4);
-void  copyForUpsize(ADMImage *dst, ADMImage *src, int np);
-void  setMaskForUpsize(ADMImage *msk, int np);
-void  createMotionMapYV12(ADMImage *prv2, ADMImage *prv, 
-	                       ADMImage *src, ADMImage *nxt, ADMImage *nxt2, ADMImage *mask, int n);
-void  createMotionMap2YV12(ADMImage *prv2, ADMImage *prv, 
-	                       ADMImage *src, ADMImage *nxt, ADMImage *nxt2, ADMImage *mask, int n)	;
-void  linkFULL_YV12(ADMImage *mask) ;	
-void  linkYtoUV_YV12(ADMImage *mask)  ;                                               
-void  linkUVtoY_YV12(ADMImage *mask) ;
-void  denoiseYV12(ADMImage *mask) ;
-bool  checkCombedYV12(ADMImage *src) ;
-void  subtractFieldsYV12(ADMImage *prv, ADMImage *src, ADMImage *nxt) ;
-void  mapColorsYV12(ADMImage *dst, ADMImage *mask);
-void  mapMergeYV12(ADMImage *dst, ADMImage *mask, 
-		ADMImage *prv, ADMImage *src, ADMImage *nxt);
-void  cubicDeintYV12(ADMImage *dst, ADMImage *mask, 
-		ADMImage *prv, ADMImage *src, ADMImage *nxt);
-void  ELADeintYV12(ADMImage *dst, ADMImage *mask, 
-		ADMImage *prv, ADMImage *src, ADMImage *nxt);
-void  kernelDeintYV12(ADMImage *dst, ADMImage *mask, 
-		ADMImage *prv, ADMImage *src, ADMImage *nxt);
-void  smartELADeintYV12(ADMImage *dst, ADMImage *mask, 
-		ADMImage *prv, ADMImage *src, ADMImage *nxt);
-void  createWeaveFrameYV12(ADMImage *dst, ADMImage *prv, 
-		ADMImage *src, ADMImage *nxt);
-int  getHint(ADMImage *src, unsigned int &amp;storeHint, int &amp;hintField);
-void putHint(ADMImage *src, unsigned int hint, int fieldt);
-void apPostCheck(ADMImage *dst, ADMImage *mask);
-void reset(void);
-public:
-
-                        vidTDeint (AVDMGenericVideoStream * in, CONFcouple * setup);
-        virtual         ~vidTDeint ();
-virtual uint8_t getFrameNumberNoAlloc (uint32_t frame, uint32_t * len,
-                                        ADMImage * data, uint32_t * flags);
-uint8_t configure (AVDMGenericVideoStream * instream);
-virtual uint8_t getCoupledConf (CONFcouple ** couples);
-
-};
-
-static FILTER_PARAM tdeint_template =
-  { 21,
-&quot;mode&quot;,
-&quot;order&quot;,
-&quot;field&quot;,
-&quot;mthreshL&quot;,
-&quot;mthreshC&quot;,
-&quot;map&quot;,
-&quot;type&quot;,
-&quot;debug&quot;,
-&quot;mtnmode&quot;,
-&quot;sharp&quot;,
-&quot;full&quot;,
-&quot;cthresh&quot;,
-&quot;blockx&quot;,
-&quot;blocky&quot;,
-&quot;chroma&quot;,
-&quot;MI&quot;,
-&quot;tryWeave&quot;,
-&quot;link&quot;,
-&quot;denoise&quot;,
-&quot;AP&quot;,
-&quot;APType&quot;
-
-  };
-
-BUILD_CREATE (tdeint_create, vidTDeint);
-SCRIPT_CREATE (tdeint_script, vidTDeint, tdeint_template);
-
-
-
-#include &quot;ADM_vidTdeint_util.txt&quot;
-extern uint8_t  DIA_tdeint(TDEINT_PARAM *param);
-//*************************************
-uint8_t vidTDeint::configure (AVDMGenericVideoStream * in)
-{
-uint8_t r;
-        r= DIA_tdeint(_param);
-        if(r) reset();
-        return r;
-}
-/*************************************/
-char *vidTDeint::printConf (void)
-{
-  static char buf[50];
-  sprintf ((char *) buf, &quot; Tritical TDeint&quot;);
-  return buf;
-}
-
-#define MAX_BLOCKS 50
-/*************************************/
-vidTDeint::vidTDeint (AVDMGenericVideoStream * in, CONFcouple * couples)
-{
-
-  _in = in;
-  memcpy (&amp;_info, _in-&gt;getInfo (), sizeof (_info));
-  _info.encoding = 1;
-  vidCache = new VideoCache (10, in);
-  _uncompressed=new ADMImage(_info.width,_info.height);
-  scratch=new ADMImage(_info.width,_info.height);
-  scratch2=new ADMImage(_info.width,_info.height);
-
-  	input = cArray = NULL;
-  _param=new TDEINT_PARAM;
-  if(!couples)
-  {
-  
-                _param-&gt;mode=0;
-                _param-&gt;order=-1;
-                _param-&gt;field=-1;
-                _param-&gt;mthreshL=6;
-                _param-&gt;mthreshC=6;
-                _param-&gt;map=0;
-                _param-&gt;type=2;
-                _param-&gt;debug=0;
-                _param-&gt;mtnmode=1;
-                _param-&gt;sharp=1;
-                _param-&gt;full=1;
-                _param-&gt;cthresh=6;
-                _param-&gt;blockx=16;
-                _param-&gt;blocky=16;
-                _param-&gt;chroma=0;
-                _param-&gt;MI=64;
-                _param-&gt;tryWeave=false;
-                _param-&gt;link=2;
-                _param-&gt;denoise=true;
-                _param-&gt;AP=254;
-                _param-&gt;APType=1;
-  }
-  else
-  {
-                GET(mode);
-                GET(order);
-                GET(field);
-                GET(mthreshL);
-                GET(mthreshC);
-                GET(map);
-                GET(type);
-                GET(debug);
-                GET(mtnmode);
-                GET(sharp);
-                GET(full);
-                GET(cthresh);
-                GET(blockx);
-                GET(blocky);
-                GET(chroma);
-                GET(MI);
-                GET(tryWeave);
-                GET(link);
-                GET(denoise);
-                GET(AP);
-                GET(APType);
-
-  
-  
-  }
-
-    order=1;
-    orderS=1;
-    mode=0;
-    field=0;
-    fieldS=0;
-    mthreshL=6;
-    mthreshLS=6;
-    mthreshC=6;
-    mthreshCS=6;
-    map=0;
-    ovrDefault=0;
-    type=2; // kernel deint
-    debug=true;
-    mntmode=1;
-    mtnmode=1;
-    sharp=true;
-    hints=false;
-    full=false;
-    cthresh=12;
-    ovr=NULL;
-    input=NULL;
-    blocky=16;
-    blockx=16;
-    chroma=false;
-    MI=64;
-    tryWeave=false;
-    link=2;
-    AP=254;
-    APType=254;
-    
-    reset();
-
-}
-void vidTDeint::reset (void)
-{
-
-#define CLONE(x) x=_param-&gt;x
-CLONE(mode);
-CLONE(order);
-CLONE(field);
-CLONE(mthreshL);
-CLONE(mthreshC);
-CLONE(map);
-CLONE(type);
-CLONE(debug);
-CLONE(mtnmode);
-CLONE(sharp);
-CLONE(full);
-CLONE(cthresh);
-CLONE(blockx);
-CLONE(blocky);
-CLONE(chroma);
-CLONE(MI);
-CLONE(tryWeave);
-CLONE(link);
-CLONE(denoise);
-CLONE(AP);
-CLONE(APType);
-
-orderS=order;
-fieldS=field;
-mthreshLS=  mthreshL;
-mthreshCS=mthreshC;
-
-
-         xhalf = blockx &gt;&gt; 1;
-        yhalf = blocky &gt;&gt; 1;
-        xshift = blockx == 4 ? 2 : blockx == 8 ? 3 : blockx == 16 ? 4 : blockx == 32 ? 5 :
-                blockx == 64 ? 6 : blockx == 128 ? 7 : blockx == 256 ? 8 : blockx == 512 ? 9 : 
-                blockx == 1024 ? 10 : 11;
-        yshift = blocky == 4 ? 2 : blocky == 8 ? 3 : blocky == 16 ? 4 : blocky == 32 ? 5 :
-                blocky == 64 ? 6 : blocky == 128 ? 7 : blocky == 256 ? 8 : blocky == 512 ? 9 : 
-                blocky == 1024 ? 10 : 11;
-        if (((!full &amp;&amp; mode == 0) || tryWeave) &amp;&amp; mode &gt;= 0)
-        {
-        int sz;
-        
-        sz=(((_info.width+xhalf)&gt;&gt;xshift)+1)*(((_info.height+yhalf)&gt;&gt;yshift)+1)*4;
-                if(cArray) delete [] cArray;
-                cArray = new int[sz];;
-                
-        }
-        
-        nfrms = nfrms2 = _info.nb_frames - 1;
-        accumP = accumN = 0;
-        cthresh6 = cthresh * 6;
-        passHint = 0xFFFFFFFF;
-        autoFO = false;
-        if (order == -1) autoFO = true;
-#if 0
-        if (mode &lt; 0) 
-        {
-                _info.height *= 2;
-                field = 1;
-        }
-        
-        if (mode == 1)
-        {
-                vi.num_frames *= 2;
-                nfrms2 = vi.num_frames - 1;
-                vi.SetFPS(vi.fps_numerator*2, vi.fps_denominator);
-        }
-        else
-#endif   
-        if (field == -1 &amp;&amp; mode!=1)
-        {
-                // telecide matches off the bottom field so we want field=0 in that case.
-                // tfm can match off top or bottom, but it will indicate which in its hints
-                // and field is adjusted appropriately then... so we use field=0 by default
-                // if hints=true.  Otherwise, if hints=false, we default to field = 1.
-                if (hints) field = 0;
-                else field = 1;
-        }
-        orderS = order; 
-        fieldS = field; 
-        mthreshLS = mthreshL; 
-        mthreshCS = mthreshC;
-        typeS = type;
-        if (debug)
-        {
-                sprintf(buf,&quot;TDeint:  %s (%s) by tritical\n&quot;, &quot;B4&quot;, &quot;08 2005&quot;);
-                OutputDebugString(buf);
-                sprintf(buf,&quot;TDeint:  mode = %d (%s)\n&quot;, mode, mode == 0 ? &quot;normal - same rate&quot; : 
-                                mode == 1 ? &quot;bob - double rate&quot; : mode == -2 ? &quot;upsize - ELA&quot; : &quot;upsize - ELA-2&quot;);
-                OutputDebugString(buf);
-        }
-}
-//____________________________________________________________________
-vidTDeint::~vidTDeint ()
-{
-
-  delete vidCache;
-  vidCache = NULL;
-  delete _uncompressed;
-  _uncompressed=NULL;
-  delete scratch;
-  scratch=NULL;
-  delete scratch2;
-  scratch2=NULL;
-  if(cArray) delete [] cArray;
-  cArray=NULL;
-}
-
-
-
-
-
-
-uint8_t vidTDeint::getCoupledConf (CONFcouple ** couples)
-{
-
-  ADM_assert (_param);
-  *couples = new CONFcouple (21);
-#undef CSET
-#define CSET(x)  (*couples)-&gt;setCouple(#x,(_param-&gt;x))
-CSET(mode);
-CSET(order);
-CSET(field);
-CSET(mthreshL);
-CSET(mthreshC);
-CSET(map);
-CSET(type);
-CSET(debug);
-CSET(mtnmode);
-CSET(sharp);
-CSET(full);
-CSET(cthresh);
-CSET(blockx);
-CSET(blocky);
-CSET(chroma);
-CSET(MI);
-CSET(tryWeave);
-CSET(link);
-CSET(denoise);
-CSET(AP);
-CSET(APType);
-
-  return 1;
-}
-
-//***************************************************
-uint8_t vidTDeint::getFrameNumberNoAlloc (uint32_t n,
-                                uint32_t * len,
-                                ADMImage * data, uint32_t * flags)
-{
-
-	int nfrms=_info.nb_frames;
-	ADMImage *srcP,*srcN,*src,*final,*display;
-        float distMerged, distN,distP,distM,distR,skip=0;
-        char txt[255];
-
-        if(n&gt;= _info.nb_frames) return 0;
-        if(n&lt;1 || n&gt;_info.nb_frames-3 )
-        {
-                skip=1;
-        }
-        
-        
-        if(skip)
-        {
-                data-&gt;duplicate(vidCache-&gt;getImage(n));
-                vidCache-&gt;unlockAll();
-                return 1;
-        }
-      
-	if (mode &lt; 0)
-	{
-		//PVideoFrame src2up = child-&gt;GetFrame(n, env);
-		//mask2up=new ADMImage(_info.width,_info.height);
-		ADMImage *src2up;
-		src2up=vidCache-&gt;getImage(n);
-		ADMImage *msk2up=scratch;
-		if(!src2up) return 0;
-		//PVideoFrame dst2up = env-&gt;NewVideoFrame(vi);
-		//PVideoFrame msk2up = env-&gt;NewVideoFrame(vi);
-		copyForUpsize(data, src2up, 3);
-		setMaskForUpsize(msk2up, 3);
-		if (mode == -2) smartELADeintYV12(data, msk2up, data, data, data);
-		else if (mode == -1) ELADeintYV12(data, msk2up, data, data, data);
-		//return dst2up;
-		//delete mask2up;
-		vidCache-&gt;unlockAll();
-		return 1;
-	}
-	if (mode == 1)
-	{
-		if (autoFO) PRM(order) = child_GetParity(n&gt;&gt;1) ? 1 : 0;
-		if (n&amp;1) PRM(field) = PRM(order) == 1 ? 0 : 1;
-		else PRM(field) = PRM(order);
-		n &gt;&gt;= 1;
-	}
-	else if (autoFO) PRM(order) = child_GetParity(n) ? 1 : 0;
-	//PVideoFrame prv2, prv, nxt, nxt2, dst, mask;
-	//PVideoFrame src = child-&gt;GetFrame(n, env);
-	src=vidCache-&gt;getImage(n);
-	if(!src)
-	{
-        vidCache-&gt;unlockAll();
-        return 0;	
-	}
-	ADMImage *prv2,*prv,*nxt,*nxt2,*dst,*mask;
-	bool found = false, fieldOVR = false;
-	int x, hintField = -1;
-	passHint = 0xFFFFFFFF;
-	if (input != NULL &amp;&amp; *ovr)
-	{
-		if (mode != 1) 
-		{
-			PRM(field) = PRM(fieldS); 
-			if (!autoFO) PRM(order) = PRM(orderS);
-		}
-		PRM(mthreshL) = PRM(mthreshLS);
-		mthreshC = mthreshCS;
-		type = typeS;
-		for (x=0; x&lt;countOvr; x+=4)
-		{
-			if (n &gt;= input[x+1] &amp;&amp; n &lt;= input[x+2])
-			{
-				if (input[x] == 45 &amp;&amp; mode != 1) // -
-				{
-					if (debug)
-					{
-						sprintf(buf,&quot;TDeint:  frame %d:  not deinterlacing\n&quot;, n);
-						OutputDebugString(buf);
-					}
-					data-&gt;duplicate(src);
-					vidCache-&gt;unlockAll();
-					return 1;
-					//return src;
-				}
-				else if (input[x] == 43 &amp;&amp; mode != 1) found = true;  // +
-				else if (input[x] == 102 &amp;&amp; mode != 1) { field = input[x+3]; fieldOVR = true; } // f
-				else if (input[x] == 111 &amp;&amp; mode != 1) PRM(order) = input[x+3]; // o
-				else if (input[x] == 108) mthreshL = input[x+3]; // l
-				else if (input[x] == 99) mthreshC = input[x+3]; // c
-				else if (input[x] == 116) type = input[x+3]; // t
-			}
-		}
-		if (!found &amp;&amp; ovrDefault == 1 &amp;&amp; mode != 1)
-		{
-			if (debug)
-			{
-				sprintf(buf,&quot;TDeint:  frame %d:  not deinterlacing\n&quot;, n);
-				OutputDebugString(buf);
-			}
-			data-&gt;duplicate(src);
-			vidCache-&gt;unlockAll();
-			return 1;
-			//return src;
-		}
-	}
-	if (mode == 0 &amp;&amp; hints &amp;&amp; vidTDeint::getHint(src, passHint, hintField) == 0 &amp;&amp; !found) 
-	{
-		if (debug)
-		{
-			sprintf(buf,&quot;TDeint:  frame %d:  not deinterlacing (HINTS)\n&quot;, n);
-			OutputDebugString(buf);
-		}
-		data-&gt;duplicate(src);
-			vidCache-&gt;unlockAll();
-			return 1;
-			//return src;
-	}
-	if (mode == 0 &amp;&amp; !full &amp;&amp; !found)
-	{
-		if (!checkCombedYV12(src))
-		{
-			if (debug)
-			{
-				sprintf(buf,&quot;TDeint:  frame %d:  not deinterlacing (full = false)\n&quot;, n);
-				OutputDebugString(buf);
-			}
-			data-&gt;duplicate(src);
-			vidCache-&gt;unlockAll();
-			return 1;
-			//return src;
-		}
-	}
-	if (!fieldOVR &amp;&amp; hintField &gt;= 0)
-	{
-		int tempf = field;
-		field = hintField;
-		hintField = tempf;
-	}
-	//if (!useClip2)
-	{
-		prv2 = vidCache-&gt;getImage(n&gt;1 ? n-2 : n&gt;0 ? n-1 : 0);//child-&gt;GetFrame(n&gt;1 ? n-2 : n&gt;0 ? n-1 : 0, env);
-		prv = vidCache-&gt;getImage(n&gt;0 ? n-1 : 0); //child-&gt;GetFrame(n&gt;0 ? n-1 : 0, env);
-		nxt = vidCache-&gt;getImage(n&lt;nfrms ? n+1: nfrms); //child-&gt;GetFrame(n&lt;nfrms ? n+1 : nfrms, env);
-		nxt2 = vidCache-&gt;getImage(n&lt;nfrms-1 ? n+2 : n&lt;nfrms ? n+1 : nfrms); //child-&gt;GetFrame(n&lt;nfrms-1 ? n+2 : n&lt;nfrms ? n+1 : nfrms, env);
-	}
-	
-	//dst = env-&gt;NewVideoFrame(vi);
-	dst=data;
-	if (type == 2 || mtnmode &gt; 1 || tryWeave) 
-	{
-		subtractFieldsYV12(prv, src, nxt);
-		if (debug)
-		{
-			sprintf(buf, &quot;TDeint:  frame %d:  accumP = %u  accumN = %u\n&quot;, n, accumP, accumN);
-			OutputDebugString(buf);
-		}
-	}
-	if (tryWeave &amp;&amp; (mode != 0 || full || found || (field^PRM(order) &amp;&amp; accumP &gt; accumN) || 
-			(!(field^PRM(order)) &amp;&amp; accumN &gt; accumP)))
-	{
-		createWeaveFrameYV12(dst, prv, src, nxt);
-		if (!checkCombedYV12(dst))
-		{
-			if (debug)
-			{
-				sprintf(buf,&quot;TDeint:  frame %d:  weaved with %s (tryWeave)\n&quot;, n, 
-					field^PRM(order) ? (accumP &lt;= accumN ? &quot;CURR&quot; : &quot;NEXT&quot;) : 
-					(accumN &lt;= accumP ? &quot;CURR&quot; : &quot;PREV&quot;));
-				OutputDebugString(buf);
-			}
-			if (hintField &gt;= 0 &amp;&amp; !fieldOVR) field = hintField;
-			vidCache-&gt;unlockAll();
-			return 1;//dst;
-		}
-	}
-	mask =scratch2 ; // env-&gt;NewVideoFrame(vi);
-	if (mthreshL &lt;= 0 &amp;&amp; mthreshC &lt;= 0) setMaskForUpsize(mask, 3);
-	else if (mtnmode == 0 || mtnmode == 2) createMotionMapYV12(prv2, prv, src, nxt, nxt2, mask, n);
-	else if (mtnmode == 1 || mtnmode == 3) createMotionMap2YV12(prv2, prv, src, nxt, nxt2, mask, n);
-	else {ADM_assert(0);}
-	if (denoise) denoiseYV12(mask);
-	if (link == 1) linkFULL_YV12(mask);
-	else if (link == 2) linkYtoUV_YV12(mask);
-	else if (link == 3) linkUVtoY_YV12(mask);
-	else if (link != 0) {ADM_assert(0);}//env-&gt;ThrowError(&quot;TDeint:  an unknown error occured (link)!&quot;);
-	if (map == 1) mapColorsYV12(dst, mask);
-	else if (map == 2) mapMergeYV12(dst, mask, prv, src, nxt);
-	else if (type == 0) cubicDeintYV12(dst, mask, prv, src, nxt);
-	else if (type == 1) smartELADeintYV12(dst, mask, prv, src, nxt);
-	else if (type == 2) kernelDeintYV12(dst, mask, prv, src, nxt);
-	else if (type == 3) ELADeintYV12(dst, mask, prv, src, nxt);
-	else {ADM_assert(0);}//env-&gt;ThrowError(&quot;TDeint:  an unknown error occured!&quot;);
-	if (AP &gt;= 0 &amp;&amp; AP &lt; 255 &amp;&amp; map == 0) apPostCheck(dst, mask);
-	if (!(passHint&amp;0xFFFFFF00)) vidTDeint::putHint(dst, passHint, field);
-	if (debug)
-	{
-		sprintf(buf,&quot;TDeint:  frame %d:  field = %s  order = %s\n&quot;, n, 
-			field == 1 ? &quot;bottom&quot; : &quot;top&quot;, PRM(order) == 1 ? &quot;tff&quot; : &quot;bff&quot;);
-		OutputDebugString(buf);
-		sprintf(buf,&quot;TDeint:  frame %d:  mthreshL = %d  mthreshC = %d  type = %d\n&quot;, n, 
-			mthreshL, mthreshC, type);
-		OutputDebugString(buf);
-	}
-	if (hintField &gt;= 0 &amp;&amp; !fieldOVR) field = hintField;
-	vidCache-&gt;unlockAll();
-	return 1;
-	//return dst;
-}
-
-//********************************************************************************************
-//********************************************************************************************
-//********************************************************************************************
-//********************************************************************************************
-//********************************************************************************************
-//********************************************************************************************
-
-#if 0
-AVSValue __cdecl Create_TDeinterlace(AVSValue args, void* user_data, IScriptEnvironment* env)
-{
-	int mode = 0;
-	int order = -1;
-	int field = -1;
-	int mthreshL = 6;
-	int mthreshC = 6;
-	int map = 0;
-	char* ovr = &quot;&quot;;
-	int ovrDefault = 0;
-	int type = 2;
-	bool debug = false;
-	int mtnmode = 1;
-	bool sharp = true;
-	bool hints = false;
-	bool full = true;
-	int cthresh = 6;
-	bool chroma = false;
-	int MI = 64;
-	bool tryWeave = false;
-	int link = 2;
-	bool denoise = true;
-	int AP = -1;
-	int blockx = 16, blocky = 16;
-	int APType = 1;
-	if (args[0].IsClip())
-	{
-		unsigned int temp;
-		int tfieldHint;
-		if (!args[13].IsBool() &amp;&amp;
-			TDeinterlace::getHint(args[0].AsClip()-&gt;GetFrame(0,env), temp, tfieldHint) != -1)
-			hints = true;
-	}
-	PClip v;
-	if (args[14].IsClip())
-	{
-		v = args[14].AsClip();
-		try
-		{ 
-			v = env-&gt;Invoke(&quot;InternalCache&quot;, v).AsClip();
-			v-&gt;SetCacheHints(CACHE_RANGE, 4);
-		} 
-		catch (IScriptEnvironment::NotFound) {  }
-	}
-    return new TDeinterlace(args[0].AsClip(),args[1].AsInt(mode),args[2].AsInt(order),
-		args[3].AsInt(field),args[4].AsInt(mthreshL),args[5].AsInt(mthreshC),args[6].AsInt(map),
-		args[7].AsString(ovr),args[8].AsInt(ovrDefault),args[9].AsInt(type),args[10].AsBool(debug),
-		args[11].AsInt(mtnmode),args[12].AsBool(sharp),args[13].AsBool(hints),args[14].IsClip() ? v : NULL,
-		args[15].AsBool(full),args[16].AsInt(cthresh),args[17].AsBool(chroma),args[18].AsInt(MI),
-		args[19].AsBool(tryWeave),args[20].AsInt(link),args[21].AsBool(denoise),args[22].AsInt(AP),
-		args[23].AsInt(blockx),args[24].AsInt(blocky),args[25].AsInt(APType),env);
-}
-
-extern &quot;C&quot; __declspec(dllexport) const char* __stdcall AvisynthPluginInit2(IScriptEnvironment* env) 
-{
-    env-&gt;AddFunction(&quot;TDeint&quot;, &quot;c[mode]i[order]i[field]i[mthreshL]i[mthreshC]i[map]i[ovr]s[ovrDefault]i&quot; \
-		                       &quot;[type]i[debug]b[mtnmode]i[sharp]b[hints]b[clip2]c[full]b[cthresh]i&quot; \
-							   &quot;[chroma]b[MI]i[tryWeave]b[link]i[denoise]b[AP]i[blockx]i[blocky]i[APType]i&quot;, 
-							   Create_TDeinterlace, 0);
-	return 0;
-}
-TDeinterlace::TDeinterlace(PClip _child, int _mode, int _order, int _field, int _mthreshL, 
-	int _mthreshC, int _map, const char* _ovr, int _ovrDefault, int _type, bool _debug, 
-	int _mtnmode, bool _sharp, bool _hints, PClip _clip2, bool _full, int _cthresh, 
-	bool _chroma, int _MI, bool _tryWeave, int _link, bool _denoise, int _AP, 
-	int _blockx, int _blocky, int _APType, IScriptEnvironment* env) :
-GenericVideoFilter(_child), mode(_mode), order(_order), field(_field), mthreshL(_mthreshL), 
-	mthreshC(_mthreshC), map(_map), ovr(_ovr), ovrDefault(_ovrDefault), type(_type), 
-	debug(_debug), mtnmode(_mtnmode), sharp(_sharp), hints(_hints), clip2(_clip2), full(_full),
-	cthresh(_cthresh), chroma(_chroma), MI(_MI), tryWeave(_tryWeave), link(_link), 
-	denoise(_denoise), AP(_AP), blockx(_blockx), blocky(_blocky), APType(_APType)
-{
-	int z, w, q, b, i, track, count;
-	char linein[81];
-	char *linep;
-	FILE *f = NULL;         ***** order mode field map type mntmode 
-	input = cArray = NULL;
-	if (!vi.IsYV12() &amp;&amp; !vi.IsYUY2()) 
-		env-&gt;ThrowError(&quot;TDeint:  YV12 and YUY2 data only!&quot;);
-	if (mode != 0 &amp;&amp; mode != 1 &amp;&amp; mode != -1 &amp;&amp; mode != -2)
-		env-&gt;ThrowError(&quot;TDeint:  mode must be set to -2, -1, 0, or 1!&quot;);
-	if (order != 0 &amp;&amp; order != 1 &amp;&amp; order != -1)
-		env-&gt;ThrowError(&quot;TDeint:  order must be set to 0, 1, or -1!&quot;);
-	if (field != 0 &amp;&amp; field != 1 &amp;&amp; field != -1)
-		env-&gt;ThrowError(&quot;TDeint:  field must be set to 0, 1, or -1!&quot;);
-	if (map &lt; 0 || map &gt; 2)
-		env-&gt;ThrowError(&quot;TDeint:  map option must be set to 0, 1, or 2!&quot;);
-	if (ovrDefault != 0 &amp;&amp; ovrDefault != 1)
-		env-&gt;ThrowError(&quot;TDeint:  ovrDefault must be set to either 0 or 1!&quot;);
-	if (type != 0 &amp;&amp; type != 1 &amp;&amp; type != 2 &amp;&amp; type != 3)
-		env-&gt;ThrowError(&quot;TDeint:  type must be set to either 0, 1, 2, or 3!&quot;);
-	if (mtnmode &lt; 0 || mtnmode &gt; 3)
-		env-&gt;ThrowError(&quot;TDeint:  mtnmode must be set to either 0, 1, 2, or 3!&quot;);
-	if (vi.height&amp;1 || vi.width&amp;1)
-		env-&gt;ThrowError(&quot;TDeint:  width and height must be multiples of 2!&quot;);
-	if (link &lt; 0 || link &gt; 3)
-		env-&gt;ThrowError(&quot;TDeint:  link must be set to 0, 1, 2, or 3!&quot;);
-	if (blockx != 4 &amp;&amp; blockx != 8 &amp;&amp; blockx != 16 &amp;&amp; blockx != 32 &amp;&amp; blockx != 64 &amp;&amp; 
-		blockx != 128 &amp;&amp; blockx != 256 &amp;&amp; blockx != 512 &amp;&amp; blockx != 1024 &amp;&amp; blockx != 2048)
-		env-&gt;ThrowError(&quot;TDeint:  illegal blockx size!&quot;);
-	if (blocky != 4 &amp;&amp; blocky != 8 &amp;&amp; blocky != 16 &amp;&amp; blocky != 32 &amp;&amp; blocky != 64 &amp;&amp; 
-		blocky != 128 &amp;&amp; blocky != 256 &amp;&amp; blocky != 512 &amp;&amp; blocky != 1024 &amp;&amp; blocky != 2048)
-		env-&gt;ThrowError(&quot;TDeint:  illegal blocky size!&quot;);
-	if (APType &lt; 0 || APType &gt; 2)
-		env-&gt;ThrowError(&quot;TDeint:  APType must be set to 0, 1, or 2!&quot;);
-	child-&gt;SetCacheHints(CACHE_RANGE, 4);
-	//useClip2 = false;
-	if ((hints || !full) &amp;&amp; mode == 0 &amp;&amp; clip2)
-	{
-		const VideoInfo&amp; vi1 = clip2-&gt;GetVideoInfo();
-		if (vi1.height != vi.height || vi1.width != vi.width)
-			env-&gt;ThrowError(&quot;TDeint:  width and height of clip2 must equal that of the input clip!&quot;);
-		if (!vi1.IsYV12() &amp;&amp; !vi1.IsYUY2())
-			env-&gt;ThrowError(&quot;TDeint:  YV12 and YUY2 data only (clip2)!&quot;);
-		if ((vi.IsYV12() &amp;&amp; vi1.IsYUY2()) || (vi.IsYUY2() &amp;&amp; vi1.IsYV12()))
-			env-&gt;ThrowError(&quot;TDeint:  colorspace of clip2 doesn't match that of the input clip!&quot;);
-		if (vi.num_frames != vi1.num_frames)
-			env-&gt;ThrowError(&quot;TDeint:  number of frames in clip2 doesn't match that of the input clip!&quot;);
-		useClip2 = true;
-	}
-	xhalf = blockx &gt;&gt; 1;
-	yhalf = blocky &gt;&gt; 1;
-	xshift = blockx == 4 ? 2 : blockx == 8 ? 3 : blockx == 16 ? 4 : blockx == 32 ? 5 :
-		blockx == 64 ? 6 : blockx == 128 ? 7 : blockx == 256 ? 8 : blockx == 512 ? 9 : 
-		blockx == 1024 ? 10 : 11;
-	yshift = blocky == 4 ? 2 : blocky == 8 ? 3 : blocky == 16 ? 4 : blocky == 32 ? 5 :
-		blocky == 64 ? 6 : blocky == 128 ? 7 : blocky == 256 ? 8 : blocky == 512 ? 9 : 
-		blocky == 1024 ? 10 : 11;
-	if (((!full &amp;&amp; mode == 0) || tryWeave) &amp;&amp; mode &gt;= 0)
-	{
-		cArray = (int *)_aligned_malloc((((vi.width+xhalf)&gt;&gt;xshift)+1)*(((vi.height+yhalf)&gt;&gt;yshift)+1)*4*sizeof(int), 32);
-		if (cArray == NULL) env-&gt;ThrowError(&quot;TDeint:  malloc failure!&quot;);
-	}
-	if (vi.IsYUY2())
-	{
-		xhalf *= 2;
-		++xshift;
-	}
-	vi.SetFieldBased(false);
-	nfrms = nfrms2 = vi.num_frames - 1;
-	accumP = accumN = 0;
-	cthresh6 = cthresh * 6;
-	passHint = 0xFFFFFFFF;
-	autoFO = false;
-	if (mode &lt; 0) 
-	{
-		vi.height *= 2;
-		field = 1;
-	}
-	if (order == -1) autoFO = true;
-	if (mode == 1)
-	{
-		vi.num_frames *= 2;
-		nfrms2 = vi.num_frames - 1;
-		vi.SetFPS(vi.fps_numerator*2, vi.fps_denominator);
-	}
-	else if (field == -1)
-	{
-		// telecide matches off the bottom field so we want field=0 in that case.
-		// tfm can match off top or bottom, but it will indicate which in its hints
-		// and field is adjusted appropriately then... so we use field=0 by default
-		// if hints=true.  Otherwise, if hints=false, we default to field = 1.
-		if (hints) field = 0;
-		else field = 1;
-	}
-	orderS = order; 
-	PRM(fieldS) = PRM(field); 
-	mthreshLS = mthreshL; 
-	mthreshCS = mthreshC;
-	typeS = type;
-	if (debug)
-	{
-		sprintf(buf,&quot;TDeint:  %s (%s) by tritical\n&quot;, VERSION, DATE);
-		OutputDebugString(buf);
-		sprintf(buf,&quot;TDeint:  mode = %d (%s)\n&quot;, mode, mode == 0 ? &quot;normal - same rate&quot; : 
-				mode == 1 ? &quot;bob - double rate&quot; : mode == -2 ? &quot;upsize - ELA&quot; : &quot;upsize - ELA-2&quot;);
-		OutputDebugString(buf);
-	}
-	
-noovrexit:
-	_asm emms;
-}
-#endif
-
-        //EOF

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTdeint_util.txt
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTdeint_util.txt	2007-06-17 15:31:18 UTC (rev 3267)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTdeint_util.txt	2007-06-17 15:43:29 UTC (rev 3268)
@@ -1,3144 +0,0 @@
-
-
- unsigned char vidTDeint::cubicInt(unsigned char p1, unsigned char p2, unsigned char p3, 
-	unsigned char p4)
-{
-	int temp = (int)((19*(p2+p3)-3*(p1+p4)+16)&gt;&gt;5);
-	if (temp&gt;255) temp = 255; 
-	else if (temp&lt;0) temp = 0;
-	return (unsigned char)temp;
-}
-
-void vidTDeint::createMotionMapYV12(ADMImage *prv2, ADMImage *prv, 
-	ADMImage *src, ADMImage *nxt, ADMImage *nxt2, ADMImage *mask, int n)
-{
-	const unsigned char *prv2pY = prv2-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *prv2pV = prv2-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *prv2pU = prv2-&gt;GetReadPtr(PLANAR_U);
-	int prv2_pitchY = prv2-&gt;GetPitch(PLANAR_Y);
-	int prv2_pitchUV = prv2-&gt;GetPitch(PLANAR_V);
-	prv2pY += prv2_pitchY*(2-PRM(field));
-	prv2pV += prv2_pitchUV*(2-PRM(field));
-	prv2pU += prv2_pitchUV*(2-PRM(field));
-	prv2_pitchY *= 2;
-	prv2_pitchUV *= 2;
-	const unsigned char *prvpY = prv-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *prvpV = prv-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *prvpU = prv-&gt;GetReadPtr(PLANAR_U);
-	int prv_pitchY = prv-&gt;GetPitch(PLANAR_Y);
-	int prv_pitchUV = prv-&gt;GetPitch(PLANAR_V);
-	prvpY += prv_pitchY*(2-PRM(field));
-	prvpV += prv_pitchUV*(2-PRM(field));
-	prvpU += prv_pitchUV*(2-PRM(field));
-	const unsigned char *prvppY = prvpY - prv_pitchY;
-	const unsigned char *prvppV = prvpV - prv_pitchUV;
-	const unsigned char *prvppU = prvpU - prv_pitchUV;
-	const unsigned char *prvpnY = prvpY + prv_pitchY;
-	const unsigned char *prvpnV = prvpV + prv_pitchUV;
-	const unsigned char *prvpnU = prvpU + prv_pitchUV;
-	prv_pitchY *= 2;
-	prv_pitchUV *= 2;
-	const unsigned char *srcpY = src-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *srcpV = src-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *srcpU = src-&gt;GetReadPtr(PLANAR_U);
-	int src_pitchY = src-&gt;GetPitch(PLANAR_Y);
-	int src_pitchUV = src-&gt;GetPitch(PLANAR_V);
-	int WidthY = src-&gt;GetRowSize(PLANAR_Y);
-	int HeightY = src-&gt;GetHeight(PLANAR_Y);
-	int WidthUV = src-&gt;GetRowSize(PLANAR_V);
-	int HeightUV = src-&gt;GetHeight(PLANAR_V);
-	srcpY += src_pitchY*(2-PRM(field));
-	srcpV += src_pitchUV*(2-PRM(field));
-	srcpU += src_pitchUV*(2-PRM(field));
-	const unsigned char *srcppY = srcpY - src_pitchY;
-	const unsigned char *srcppV = srcpV - src_pitchUV;
-	const unsigned char *srcppU = srcpU - src_pitchUV;
-	const unsigned char *srcpnY = srcpY + src_pitchY;
-	const unsigned char *srcpnV = srcpV + src_pitchUV;
-	const unsigned char *srcpnU = srcpU + src_pitchUV;
-	src_pitchY *= 2;
-	src_pitchUV *= 2;
-	const unsigned char *nxtpY = nxt-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *nxtpV = nxt-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *nxtpU = nxt-&gt;GetReadPtr(PLANAR_U);
-	int nxt_pitchY = nxt-&gt;GetPitch(PLANAR_Y);
-	int nxt_pitchUV = nxt-&gt;GetPitch(PLANAR_V);
-	nxtpY += nxt_pitchY*(2-PRM(field));
-	nxtpV += nxt_pitchUV*(2-PRM(field));
-	nxtpU += nxt_pitchUV*(2-PRM(field));
-	const unsigned char *nxtppY = nxtpY - nxt_pitchY;
-	const unsigned char *nxtppV = nxtpV - nxt_pitchUV;
-	const unsigned char *nxtppU = nxtpU - nxt_pitchUV;
-	const unsigned char *nxtpnY = nxtpY + nxt_pitchY;
-	const unsigned char *nxtpnV = nxtpV + nxt_pitchUV;
-	const unsigned char *nxtpnU = nxtpU + nxt_pitchUV;
-	nxt_pitchY *= 2;
-	nxt_pitchUV *= 2;
-	const unsigned char *nxt2pY = nxt2-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *nxt2pV = nxt2-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *nxt2pU = nxt2-&gt;GetReadPtr(PLANAR_U);
-	int nxt2_pitchY = nxt2-&gt;GetPitch(PLANAR_Y);
-	int nxt2_pitchUV = nxt2-&gt;GetPitch(PLANAR_V);
-	nxt2pY += nxt2_pitchY*(2-PRM(field));
-	nxt2pV += nxt2_pitchUV*(2-PRM(field));
-	nxt2pU += nxt2_pitchUV*(2-PRM(field));
-	nxt2_pitchY *= 2;
-	nxt2_pitchUV *= 2;
-	unsigned char *maskwY = mask-&gt;GetWritePtr(PLANAR_Y);
-	unsigned char *maskwV = mask-&gt;GetWritePtr(PLANAR_V);
-	unsigned char *maskwU = mask-&gt;GetWritePtr(PLANAR_U);
-	int mask_pitchY = mask-&gt;GetPitch(PLANAR_Y);
-	int mask_pitchUV = mask-&gt;GetPitch(PLANAR_V);
-	memset(maskwY,10,mask_pitchY*HeightY);
-	memset(maskwU,10,mask_pitchUV*HeightUV);
-	memset(maskwV,10,mask_pitchUV*HeightUV);
-	maskwY += mask_pitchY*(2-PRM(field));
-	maskwV += mask_pitchUV*(2-PRM(field));
-	maskwU += mask_pitchUV*(2-PRM(field));
-	mask_pitchY *= 2;
-	mask_pitchUV *= 2;
-	int x, y;
-	unsigned char val1;
-	bool t1, t2, t3, t4, t5, t6, t7;
-	if (PRM(field)^PRM(order))
-	{
-		val1 = PRM(mntmode) &gt; 1 ? (accumP &lt;= accumN ? 10 : 30) : 40;
-		if (n &lt;= 1 || n &gt;= nfrms-1)
-		{
-			for (y=1; y&lt;HeightY-1; y+=2)
-			{
-				for (x=0; x&lt;WidthY; ++x)
-				{
-					t1 = n == 0 ? false : (abs(srcppY[x] - prvppY[x]) &lt; mthreshL);
-					t2 = n == 0 ? false : (abs(srcpnY[x] - prvpnY[x]) &lt; mthreshL);
-					t3 = n == nfrms ? false : (abs(srcppY[x] - nxtppY[x]) &lt; mthreshL);
-					t4 = n == nfrms ? false : (abs(srcpnY[x] - nxtpnY[x]) &lt; mthreshL);
-					t5 = n == 0 ? false : (abs(srcpY[x] - prvpY[x]) &lt; mthreshL);
-					t6 = n == nfrms ? false : (abs(srcpY[x] - nxtpY[x]) &lt; mthreshL);
-					t7 = n &gt;= nfrms-1 ? false : (abs(nxtpY[x] - nxt2pY[x]) &lt; mthreshL);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2) || (t3 &amp;&amp; t4) || (t2 &amp;&amp; t4 &amp;&amp; (t5 || t7)) || (t1 &amp;&amp; t3 &amp;&amp; (t5 || t7))))
-						maskwY[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7) maskwY[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2) maskwY[x] = 10;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4) maskwY[x] = 30;
-					else if (abs(srcpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(srcpY[x]-srcpnY[x])&lt;4) maskwY[x] = 110;
-					else if (abs(nxtpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(nxtpY[x]-srcpnY[x])&lt;4) maskwY[x] = 130;
-					else maskwY[x] = 60;
-				}
-				prvppY += prv_pitchY;
-				prvpY += prv_pitchY;
-				prvpnY += prv_pitchY;
-				srcppY += src_pitchY;
-				srcpY += src_pitchY;
-				srcpnY += src_pitchY;
-				nxtppY += nxt_pitchY;
-				nxtpY += nxt_pitchY;
-				nxtpnY += nxt_pitchY;
-				nxt2pY += nxt2_pitchY;
-				maskwY += mask_pitchY;
-			}
-			for (y=1; y&lt;HeightUV-1; y+=2)
-			{
-				for (x=0; x&lt;WidthUV; ++x)
-				{
-					t1 = n == 0 ? false : (abs(srcppV[x] - prvppV[x]) &lt; mthreshC);
-					t2 = n == 0 ? false : (abs(srcpnV[x] - prvpnV[x]) &lt; mthreshC);
-					t3 = n == nfrms ? false : (abs(srcppV[x] - nxtppV[x]) &lt; mthreshC);
-					t4 = n == nfrms ? false : (abs(srcpnV[x] - nxtpnV[x]) &lt; mthreshC);
-					t5 = n == 0 ? false : (abs(srcpV[x] - prvpV[x]) &lt; mthreshC);
-					t6 = n == nfrms ? false : (abs(srcpV[x] - nxtpV[x]) &lt; mthreshC);
-					t7 = n &gt;= nfrms-1 ? false : (abs(nxtpV[x] - nxt2pV[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2) || (t3 &amp;&amp; t4) || (t2 &amp;&amp; t4 &amp;&amp; (t5 || t7)) || (t1 &amp;&amp; t3 &amp;&amp; (t5 || t7))))
-						maskwV[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7) maskwV[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2) maskwV[x] = 10;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4) maskwV[x] = 30;
-					else if (abs(srcpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(srcpV[x]-srcpnV[x])&lt;4) maskwV[x] = 110;
-					else if (abs(nxtpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(nxtpV[x]-srcpnV[x])&lt;4) maskwV[x] = 130;
-					else maskwV[x] = 60;
-					t1 = n == 0 ? false : (abs(srcppU[x] - prvppU[x]) &lt; mthreshC);
-					t2 = n == 0 ? false : (abs(srcpnU[x] - prvpnU[x]) &lt; mthreshC);
-					t3 = n == nfrms ? false : (abs(srcppU[x] - nxtppU[x]) &lt; mthreshC);
-					t4 = n == nfrms ? false : (abs(srcpnU[x] - nxtpnU[x]) &lt; mthreshC);
-					t5 = n == 0 ? false : (abs(srcpU[x] - prvpU[x]) &lt; mthreshC);
-					t6 = n == nfrms ? false : (abs(srcpU[x] - nxtpU[x]) &lt; mthreshC);
-					t7 = n &gt;= nfrms-1 ? false : (abs(nxtpU[x] - nxt2pU[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2) || (t3 &amp;&amp; t4) || (t2 &amp;&amp; t4 &amp;&amp; (t5 || t7)) || (t1 &amp;&amp; t3 &amp;&amp; (t5 || t7))))
-						maskwU[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7) maskwU[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2) maskwU[x] = 10;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4) maskwU[x] = 30;
-					else if (abs(srcpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(srcpU[x]-srcpnU[x])&lt;4) maskwU[x] = 110;
-					else if (abs(nxtpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(nxtpU[x]-srcpnU[x])&lt;4) maskwU[x] = 130;
-					else maskwU[x] = 60;
-				}
-				prvppV += prv_pitchUV;
-				prvpV += prv_pitchUV;
-				prvpnV += prv_pitchUV;
-				prvppU += prv_pitchUV;
-				prvpU += prv_pitchUV;
-				prvpnU += prv_pitchUV;
-				srcppV += src_pitchUV;
-				srcpV += src_pitchUV;
-				srcpnV += src_pitchUV;
-				srcppU += src_pitchUV;
-				srcpU += src_pitchUV;
-				srcpnU += src_pitchUV;
-				nxtppV += nxt_pitchUV;
-				nxtpV += nxt_pitchUV;
-				nxtpnV += nxt_pitchUV;
-				nxtppU += nxt_pitchUV;
-				nxtpU += nxt_pitchUV;
-				nxtpnU += nxt_pitchUV;
-				nxt2pV += nxt2_pitchUV;
-				nxt2pU += nxt2_pitchUV;
-				maskwV += mask_pitchUV;
-				maskwU += mask_pitchUV;
-			}
-		}
-		else
-		{
-			for (y=1; y&lt;HeightY-1; y+=2)
-			{
-				for (x=0; x&lt;WidthY; ++x)
-				{
-					t1 = (abs(srcppY[x] - prvppY[x]) &lt; mthreshL);
-					t2 = (abs(srcpnY[x] - prvpnY[x]) &lt; mthreshL);
-					t3 = (abs(srcppY[x] - nxtppY[x]) &lt; mthreshL);
-					t4 = (abs(srcpnY[x] - nxtpnY[x]) &lt; mthreshL);
-					t5 = (abs(srcpY[x] - prvpY[x]) &lt; mthreshL);
-					t6 = (abs(srcpY[x] - nxtpY[x]) &lt; mthreshL);
-					t7 = (abs(nxtpY[x] - nxt2pY[x]) &lt; mthreshL);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2) || (t3 &amp;&amp; t4) || (t2 &amp;&amp; t4 &amp;&amp; (t5 || t7)) || (t1 &amp;&amp; t3 &amp;&amp; (t5 || t7))))
-						maskwY[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7) maskwY[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2) maskwY[x] = 10;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4) maskwY[x] = 30;
-					else if (abs(srcpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(srcpY[x]-srcpnY[x])&lt;4) maskwY[x] = 110;
-					else if (abs(nxtpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(nxtpY[x]-srcpnY[x])&lt;4) maskwY[x] = 130;
-					else maskwY[x] = 60;
-				}
-				prvppY += prv_pitchY;
-				prvpY += prv_pitchY;
-				prvpnY += prv_pitchY;
-				srcppY += src_pitchY;
-				srcpY += src_pitchY;
-				srcpnY += src_pitchY;
-				nxtppY += nxt_pitchY;
-				nxtpY += nxt_pitchY;
-				nxtpnY += nxt_pitchY;
-				nxt2pY += nxt2_pitchY;
-				maskwY += mask_pitchY;
-			}
-			for (y=1; y&lt;HeightUV-1; y+=2)
-			{
-				for (x=0; x&lt;WidthUV; ++x)
-				{
-					t1 = (abs(srcppV[x] - prvppV[x]) &lt; mthreshC);
-					t2 = (abs(srcpnV[x] - prvpnV[x]) &lt; mthreshC);
-					t3 = (abs(srcppV[x] - nxtppV[x]) &lt; mthreshC);
-					t4 = (abs(srcpnV[x] - nxtpnV[x]) &lt; mthreshC);
-					t5 = (abs(srcpV[x] - prvpV[x]) &lt; mthreshC);
-					t6 = (abs(srcpV[x] - nxtpV[x]) &lt; mthreshC);
-					t7 = (abs(nxtpV[x] - nxt2pV[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2) || (t3 &amp;&amp; t4) || (t2 &amp;&amp; t4 &amp;&amp; (t5 || t7)) || (t1 &amp;&amp; t3 &amp;&amp; (t5 || t7))))
-						maskwV[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7) maskwV[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2) maskwV[x] = 10;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4) maskwV[x] = 30;
-					else if (abs(srcpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(srcpV[x]-srcpnV[x])&lt;4) maskwV[x] = 110;
-					else if (abs(nxtpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(nxtpV[x]-srcpnV[x])&lt;4) maskwV[x] = 130;
-					else maskwV[x] = 60;
-					t1 = (abs(srcppU[x] - prvppU[x]) &lt; mthreshC);
-					t2 = (abs(srcpnU[x] - prvpnU[x]) &lt; mthreshC);
-					t3 = (abs(srcppU[x] - nxtppU[x]) &lt; mthreshC);
-					t4 = (abs(srcpnU[x] - nxtpnU[x]) &lt; mthreshC);
-					t5 = (abs(srcpU[x] - prvpU[x]) &lt; mthreshC);
-					t6 = (abs(srcpU[x] - nxtpU[x]) &lt; mthreshC);
-					t7 = (abs(nxtpU[x] - nxt2pU[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2) || (t3 &amp;&amp; t4) || (t2 &amp;&amp; t4 &amp;&amp; (t5 || t7)) || (t1 &amp;&amp; t3 &amp;&amp; (t5 || t7))))
-						maskwU[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7) maskwU[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2) maskwU[x] = 10;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4) maskwU[x] = 30;
-					else if (abs(srcpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(srcpU[x]-srcpnU[x])&lt;4) maskwU[x] = 110;
-					else if (abs(nxtpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(nxtpU[x]-srcpnU[x])&lt;4) maskwU[x] = 130;
-					else maskwU[x] = 60;
-				}
-				prvppV += prv_pitchUV;
-				prvpV += prv_pitchUV;
-				prvpnV += prv_pitchUV;
-				prvppU += prv_pitchUV;
-				prvpU += prv_pitchUV;
-				prvpnU += prv_pitchUV;
-				srcppV += src_pitchUV;
-				srcpV += src_pitchUV;
-				srcpnV += src_pitchUV;
-				srcppU += src_pitchUV;
-				srcpU += src_pitchUV;
-				srcpnU += src_pitchUV;
-				nxtppV += nxt_pitchUV;
-				nxtpV += nxt_pitchUV;
-				nxtpnV += nxt_pitchUV;
-				nxtppU += nxt_pitchUV;
-				nxtpU += nxt_pitchUV;
-				nxtpnU += nxt_pitchUV;
-				nxt2pV += nxt2_pitchUV;
-				nxt2pU += nxt2_pitchUV;
-				maskwV += mask_pitchUV;
-				maskwU += mask_pitchUV;
-			}
-		}
-	}
-	else
-	{
-		val1 = PRM(mntmode) &gt; 1 ? (accumP &lt; accumN ? 20 : 10) : 50;
-		if (n &lt;= 1 || n &gt;= nfrms-1)
-		{
-			for (y=1; y&lt;HeightY-1; y+=2)
-			{
-				for (x=0; x&lt;WidthY; ++x)
-				{
-					t1 = n == 0 ? false : (abs(srcppY[x] - prvppY[x]) &lt; mthreshL);
-					t2 = n == 0 ? false : (abs(srcpnY[x] - prvpnY[x]) &lt; mthreshL);
-					t3 = n == nfrms ? false : (abs(srcppY[x] - nxtppY[x]) &lt; mthreshL);
-					t4 = n == nfrms ? false : (abs(srcpnY[x] - nxtpnY[x]) &lt; mthreshL);
-					t5 = n &lt;= 1 ? false : (abs(prvpY[x] - prv2pY[x]) &lt; mthreshL);
-					t6 = n == 0 ? false : (abs(srcpY[x] - prvpY[x]) &lt; mthreshL);
-					t7 = n == nfrms ? false : (abs(srcpY[x] - nxtpY[x]) &lt; mthreshL);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2) || (t3 &amp;&amp; t4) || (t2 &amp;&amp; t4 &amp;&amp; (t5 || t7)) || (t1 &amp;&amp; t3 &amp;&amp; (t5 || t7))))
-						maskwY[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7) maskwY[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2) maskwY[x] = 20;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4) maskwY[x] = 10;
-					else if (abs(prvpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(prvpY[x]-srcpnY[x])&lt;4) maskwY[x] = 120;
-					else if (abs(srcpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(srcpY[x]-srcpnY[x])&lt;4) maskwY[x] = 110;
-					else maskwY[x] = 60;
-				}
-				prv2pY += prv2_pitchY;
-				prvppY += prv_pitchY;
-				prvpY += prv_pitchY;
-				prvpnY += prv_pitchY;
-				srcppY += src_pitchY;
-				srcpY += src_pitchY;
-				srcpnY += src_pitchY;
-				nxtppY += nxt_pitchY;
-				nxtpY += nxt_pitchY;
-				nxtpnY += nxt_pitchY;
-				maskwY += mask_pitchY;
-			}
-			for (y=1; y&lt;HeightUV-1; y+=2)
-			{
-				for (x=0; x&lt;WidthUV; ++x)
-				{
-					t1 = n == 0 ? false : (abs(srcppV[x] - prvppV[x]) &lt; mthreshC);
-					t2 = n == 0 ? false : (abs(srcpnV[x] - prvpnV[x]) &lt; mthreshC);
-					t3 = n == nfrms ? false : (abs(srcppV[x] - nxtppV[x]) &lt; mthreshC);
-					t4 = n == nfrms ? false : (abs(srcpnV[x] - nxtpnV[x]) &lt; mthreshC);
-					t5 = n &lt;= 1 ? false : (abs(prvpV[x] - prv2pV[x]) &lt; mthreshC);
-					t6 = n == 0 ? false : (abs(srcpV[x] - prvpV[x]) &lt; mthreshC);
-					t7 = n == nfrms ? false : (abs(srcpV[x] - nxtpV[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2) || (t3 &amp;&amp; t4) || (t2 &amp;&amp; t4 &amp;&amp; (t5 || t7)) || (t1 &amp;&amp; t3 &amp;&amp; (t5 || t7))))
-						maskwV[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7) maskwV[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2) maskwV[x] = 20;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4) maskwV[x] = 10;
-					else if (abs(prvpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(prvpV[x]-srcpnV[x])&lt;4) maskwV[x] = 120;
-					else if (abs(srcpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(srcpV[x]-srcpnV[x])&lt;4) maskwV[x] = 110;
-					else maskwV[x] = 60;
-					t1 = n == 0 ? false : (abs(srcppU[x] - prvppU[x]) &lt; mthreshC);
-					t2 = n == 0 ? false : (abs(srcpnU[x] - prvpnU[x]) &lt; mthreshC);
-					t3 = n == nfrms ? false : (abs(srcppU[x] - nxtppU[x]) &lt; mthreshC);
-					t4 = n == nfrms ? false : (abs(srcpnU[x] - nxtpnU[x]) &lt; mthreshC);
-					t5 = n &lt;= 1 ? false : (abs(prvpU[x] - prv2pU[x]) &lt; mthreshC);
-					t6 = n == 0 ? false : (abs(srcpU[x] - prvpU[x]) &lt; mthreshC);
-					t7 = n == nfrms ? false : (abs(srcpU[x] - nxtpU[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2) || (t3 &amp;&amp; t4) || (t2 &amp;&amp; t4 &amp;&amp; (t5 || t7)) || (t1 &amp;&amp; t3 &amp;&amp; (t5 || t7))))
-						maskwU[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7) maskwU[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2) maskwU[x] = 20;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4) maskwU[x] = 10;
-					else if (abs(prvpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(prvpU[x]-srcpnU[x])&lt;4) maskwU[x] = 120;
-					else if (abs(srcpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(srcpU[x]-srcpnU[x])&lt;4) maskwU[x] = 110;
-					else maskwU[x] = 60;
-				}
-				prv2pV += prv2_pitchUV;
-				prv2pU += prv2_pitchUV;
-				prvppV += prv_pitchUV;
-				prvpV += prv_pitchUV;
-				prvpnV += prv_pitchUV;
-				prvppU += prv_pitchUV;
-				prvpU += prv_pitchUV;
-				prvpnU += prv_pitchUV;
-				srcppV += src_pitchUV;
-				srcpV += src_pitchUV;
-				srcpnV += src_pitchUV;
-				srcppU += src_pitchUV;
-				srcpU += src_pitchUV;
-				srcpnU += src_pitchUV;
-				nxtppV += nxt_pitchUV;
-				nxtpV += nxt_pitchUV;
-				nxtpnV += nxt_pitchUV;
-				nxtppU += nxt_pitchUV;
-				nxtpU += nxt_pitchUV;
-				nxtpnU += nxt_pitchUV;
-				maskwV += mask_pitchUV;
-				maskwU += mask_pitchUV;
-			}
-		}
-		else
-		{
-			for (y=1; y&lt;HeightY-1; y+=2)
-			{
-				for (x=0; x&lt;WidthY; ++x)
-				{
-					t1 = (abs(srcppY[x] - prvppY[x]) &lt; mthreshL);
-					t2 = (abs(srcpnY[x] - prvpnY[x]) &lt; mthreshL);
-					t3 = (abs(srcppY[x] - nxtppY[x]) &lt; mthreshL);
-					t4 = (abs(srcpnY[x] - nxtpnY[x]) &lt; mthreshL);
-					t5 = (abs(prvpY[x] - prv2pY[x]) &lt; mthreshL);
-					t6 = (abs(srcpY[x] - prvpY[x]) &lt; mthreshL);
-					t7 = (abs(srcpY[x] - nxtpY[x]) &lt; mthreshL);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2) || (t3 &amp;&amp; t4) || (t2 &amp;&amp; t4 &amp;&amp; (t5 || t7)) || (t1 &amp;&amp; t3 &amp;&amp; (t5 || t7))))
-						maskwY[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7) maskwY[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2) maskwY[x] = 20;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4) maskwY[x] = 10;
-					else if (abs(prvpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(prvpY[x]-srcpnY[x])&lt;4) maskwY[x] = 120;
-					else if (abs(srcpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(srcpY[x]-srcpnY[x])&lt;4) maskwY[x] = 110;
-					else maskwY[x] = 60;
-				}
-				prv2pY += prv2_pitchY;
-				prvppY += prv_pitchY;
-				prvpY += prv_pitchY;
-				prvpnY += prv_pitchY;
-				srcppY += src_pitchY;
-				srcpY += src_pitchY;
-				srcpnY += src_pitchY;
-				nxtppY += nxt_pitchY;
-				nxtpY += nxt_pitchY;
-				nxtpnY += nxt_pitchY;
-				maskwY += mask_pitchY;
-			}
-			for (y=1; y&lt;HeightUV-1; y+=2)
-			{
-				for (x=0; x&lt;WidthUV; ++x)
-				{
-					t1 = (abs(srcppV[x] - prvppV[x]) &lt; mthreshC);
-					t2 = (abs(srcpnV[x] - prvpnV[x]) &lt; mthreshC);
-					t3 = (abs(srcppV[x] - nxtppV[x]) &lt; mthreshC);
-					t4 = (abs(srcpnV[x] - nxtpnV[x]) &lt; mthreshC);
-					t5 = (abs(prvpV[x] - prv2pV[x]) &lt; mthreshC);
-					t6 = (abs(srcpV[x] - prvpV[x]) &lt; mthreshC);
-					t7 = (abs(srcpV[x] - nxtpV[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2) || (t3 &amp;&amp; t4) || (t2 &amp;&amp; t4 &amp;&amp; (t5 || t7)) || (t1 &amp;&amp; t3 &amp;&amp; (t5 || t7))))
-						maskwV[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7) maskwV[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2) maskwV[x] = 20;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4) maskwV[x] = 10;
-					else if (abs(prvpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(prvpV[x]-srcpnV[x])&lt;4) maskwV[x] = 120;
-					else if (abs(srcpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(srcpV[x]-srcpnV[x])&lt;4) maskwV[x] = 110;
-					else maskwV[x] = 60;
-					t1 = (abs(srcppU[x] - prvppU[x]) &lt; mthreshC);
-					t2 = (abs(srcpnU[x] - prvpnU[x]) &lt; mthreshC);
-					t3 = (abs(srcppU[x] - nxtppU[x]) &lt; mthreshC);
-					t4 = (abs(srcpnU[x] - nxtpnU[x]) &lt; mthreshC);
-					t5 = (abs(prvpU[x] - prv2pU[x]) &lt; mthreshC);
-					t6 = (abs(srcpU[x] - prvpU[x]) &lt; mthreshC);
-					t7 = (abs(srcpU[x] - nxtpU[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2) || (t3 &amp;&amp; t4) || (t2 &amp;&amp; t4 &amp;&amp; (t5 || t7)) || (t1 &amp;&amp; t3 &amp;&amp; (t5 || t7))))
-						maskwU[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7) maskwU[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2) maskwU[x] = 20;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4) maskwU[x] = 10;
-					else if (abs(prvpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(prvpU[x]-srcpnU[x])&lt;4) maskwU[x] = 120;
-					else if (abs(srcpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(srcpU[x]-srcpnU[x])&lt;4) maskwU[x] = 110;
-					else maskwU[x] = 60;
-				}
-				prv2pV += prv2_pitchUV;
-				prv2pU += prv2_pitchUV;
-				prvppV += prv_pitchUV;
-				prvpV += prv_pitchUV;
-				prvpnV += prv_pitchUV;
-				prvppU += prv_pitchUV;
-				prvpU += prv_pitchUV;
-				prvpnU += prv_pitchUV;
-				srcppV += src_pitchUV;
-				srcpV += src_pitchUV;
-				srcpnV += src_pitchUV;
-				srcppU += src_pitchUV;
-				srcpU += src_pitchUV;
-				srcpnU += src_pitchUV;
-				nxtppV += nxt_pitchUV;
-				nxtpV += nxt_pitchUV;
-				nxtpnV += nxt_pitchUV;
-				nxtppU += nxt_pitchUV;
-				nxtpU += nxt_pitchUV;
-				nxtpnU += nxt_pitchUV;
-				maskwV += mask_pitchUV;
-				maskwU += mask_pitchUV;
-			}
-		}
-	}
-}
-
-void vidTDeint::createMotionMap2YV12(ADMImage *prv2, ADMImage *prv, 
-	ADMImage *src, ADMImage *nxt, ADMImage *nxt2, ADMImage *mask, int n)
-{
-	const unsigned char *prv2pY = prv2-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *prv2pV = prv2-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *prv2pU = prv2-&gt;GetReadPtr(PLANAR_U);
-	int prv2_pitchY = prv2-&gt;GetPitch(PLANAR_Y);
-	int prv2_pitchUV = prv2-&gt;GetPitch(PLANAR_V);
-	prv2pY += prv2_pitchY*(2-PRM(field));
-	prv2pV += prv2_pitchUV*(2-PRM(field));
-	prv2pU += prv2_pitchUV*(2-PRM(field));
-	const unsigned char *prv2ppY = prv2pY - prv2_pitchY;
-	const unsigned char *prv2ppV = prv2pV - prv2_pitchUV;
-	const unsigned char *prv2ppU = prv2pU - prv2_pitchUV;
-	const unsigned char *prv2pnY = prv2pY + prv2_pitchY;
-	const unsigned char *prv2pnV = prv2pV + prv2_pitchUV;
-	const unsigned char *prv2pnU = prv2pU + prv2_pitchUV;
-	prv2_pitchY *= 2;
-	prv2_pitchUV *= 2;
-	const unsigned char *prvpY = prv-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *prvpV = prv-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *prvpU = prv-&gt;GetReadPtr(PLANAR_U);
-	int prv_pitchY = prv-&gt;GetPitch(PLANAR_Y);
-	int prv_pitchUV = prv-&gt;GetPitch(PLANAR_V);
-	prvpY += prv_pitchY*(2-PRM(field));
-	prvpV += prv_pitchUV*(2-PRM(field));
-	prvpU += prv_pitchUV*(2-PRM(field));
-	const unsigned char *prvppY = prvpY - prv_pitchY;
-	const unsigned char *prvppV = prvpV - prv_pitchUV;
-	const unsigned char *prvppU = prvpU - prv_pitchUV;
-	const unsigned char *prvpnY = prvpY + prv_pitchY;
-	const unsigned char *prvpnV = prvpV + prv_pitchUV;
-	const unsigned char *prvpnU = prvpU + prv_pitchUV;
-	prv_pitchY *= 2;
-	prv_pitchUV *= 2;
-	const unsigned char *srcpY = src-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *srcpV = src-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *srcpU = src-&gt;GetReadPtr(PLANAR_U);
-	int src_pitchY = src-&gt;GetPitch(PLANAR_Y);
-	int src_pitchUV = src-&gt;GetPitch(PLANAR_V);
-	int WidthY = src-&gt;GetRowSize(PLANAR_Y);
-	int HeightY = src-&gt;GetHeight(PLANAR_Y);
-	int WidthUV = src-&gt;GetRowSize(PLANAR_V);
-	int HeightUV = src-&gt;GetHeight(PLANAR_V);
-	srcpY += src_pitchY*(2-PRM(field));
-	srcpV += src_pitchUV*(2-PRM(field));
-	srcpU += src_pitchUV*(2-PRM(field));
-	const unsigned char *srcppY = srcpY - src_pitchY;
-	const unsigned char *srcppV = srcpV - src_pitchUV;
-	const unsigned char *srcppU = srcpU - src_pitchUV;
-	const unsigned char *srcpnY = srcpY + src_pitchY;
-	const unsigned char *srcpnV = srcpV + src_pitchUV;
-	const unsigned char *srcpnU = srcpU + src_pitchUV;
-	src_pitchY *= 2;
-	src_pitchUV *= 2;
-	const unsigned char *nxtpY = nxt-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *nxtpV = nxt-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *nxtpU = nxt-&gt;GetReadPtr(PLANAR_U);
-	int nxt_pitchY = nxt-&gt;GetPitch(PLANAR_Y);
-	int nxt_pitchUV = nxt-&gt;GetPitch(PLANAR_V);
-	nxtpY += nxt_pitchY*(2-PRM(field));
-	nxtpV += nxt_pitchUV*(2-PRM(field));
-	nxtpU += nxt_pitchUV*(2-PRM(field));
-	const unsigned char *nxtppY = nxtpY - nxt_pitchY;
-	const unsigned char *nxtppV = nxtpV - nxt_pitchUV;
-	const unsigned char *nxtppU = nxtpU - nxt_pitchUV;
-	const unsigned char *nxtpnY = nxtpY + nxt_pitchY;
-	const unsigned char *nxtpnV = nxtpV + nxt_pitchUV;
-	const unsigned char *nxtpnU = nxtpU + nxt_pitchUV;
-	nxt_pitchY *= 2;
-	nxt_pitchUV *= 2;
-	const unsigned char *nxt2pY = nxt2-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *nxt2pV = nxt2-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *nxt2pU = nxt2-&gt;GetReadPtr(PLANAR_U);
-	int nxt2_pitchY = nxt2-&gt;GetPitch(PLANAR_Y);
-	int nxt2_pitchUV = nxt2-&gt;GetPitch(PLANAR_V);
-	nxt2pY += nxt2_pitchY*(2-PRM(field));
-	nxt2pV += nxt2_pitchUV*(2-PRM(field));
-	nxt2pU += nxt2_pitchUV*(2-PRM(field));
-	const unsigned char *nxt2ppY = nxt2pY - nxt2_pitchY;
-	const unsigned char *nxt2ppV = nxt2pV - nxt2_pitchUV;
-	const unsigned char *nxt2ppU = nxt2pU - nxt2_pitchUV;
-	const unsigned char *nxt2pnY = nxt2pY + nxt2_pitchY;
-	const unsigned char *nxt2pnV = nxt2pV + nxt2_pitchUV;
-	const unsigned char *nxt2pnU = nxt2pU + nxt2_pitchUV;
-	nxt2_pitchY *= 2;
-	nxt2_pitchUV *= 2;
-	unsigned char *maskwY = mask-&gt;GetWritePtr(PLANAR_Y);
-	unsigned char *maskwV = mask-&gt;GetWritePtr(PLANAR_V);
-	unsigned char *maskwU = mask-&gt;GetWritePtr(PLANAR_U);
-	int mask_pitchY = mask-&gt;GetPitch(PLANAR_Y);
-	int mask_pitchUV = mask-&gt;GetPitch(PLANAR_V);
-	memset(maskwY,10,mask_pitchY*HeightY);
-	memset(maskwU,10,mask_pitchUV*HeightUV);
-	memset(maskwV,10,mask_pitchUV*HeightUV);
-	maskwY += mask_pitchY*(2-PRM(field));
-	maskwV += mask_pitchUV*(2-PRM(field));
-	maskwU += mask_pitchUV*(2-PRM(field));
-	mask_pitchY *= 2;
-	mask_pitchUV *= 2;
-	int x, y;
-	unsigned char val1;
-	bool t1, t2, t3, t4, t5, t6, t7, t8, t9, t10;
-	bool t11, t12, t13, t14, t15, t16, t17, t18, t19;
-	if (PRM(field)^PRM(order))
-	{
-		val1 = PRM(mntmode) &gt; 1 ? (accumP &lt;= accumN ? 10 : 30) : 40;
-		if (n &lt;= 1 || n &gt;= nfrms-1)
-		{
-			for (y=1; y&lt;HeightY-1; y+=2)
-			{
-				for (x=0; x&lt;WidthY; ++x)
-				{
-					t1 = n == 0 ? false : (abs(srcppY[x] - prvppY[x]) &lt; mthreshL);
-					t2 = n == 0 ? false : (abs(srcpnY[x] - prvpnY[x]) &lt; mthreshL);
-					t3 = n == nfrms ? false : (abs(srcppY[x] - nxtppY[x]) &lt; mthreshL);
-					t4 = n == nfrms ? false : (abs(srcpnY[x] - nxtpnY[x]) &lt; mthreshL);
-					t5 = n == 0 ? false : (abs(srcpY[x] - prvpY[x]) &lt; mthreshL);
-					t6 = n == nfrms ? false : (abs(srcpY[x] - nxtpY[x]) &lt; mthreshL);
-					t7 = n &gt;= nfrms-1 ? false : (abs(nxtpY[x] - nxt2pY[x]) &lt; mthreshL);
-					t8 = n &lt;= 1 ? false : (abs(prvppY[x] - prv2ppY[x]) &lt; mthreshL);
-					t9 = n &lt;= 1 ? false : (abs(prvpnY[x] - prv2pnY[x]) &lt; mthreshL);
-					t10 = n &gt;= nfrms-1 ? false : (abs(nxtppY[x] - nxt2ppY[x]) &lt; mthreshL);
-					t11 = n &gt;= nfrms-1 ? false : (abs(nxtpnY[x] - nxt2pnY[x]) &lt; mthreshL);
-					t12 = (abs(srcppY[x] - prv2ppY[x]) &lt; mthreshL);
-					t13 = (abs(srcpnY[x] - prv2pnY[x]) &lt; mthreshL);
-					t14 = (abs(nxtppY[x] - prvppY[x]) &lt; mthreshL);
-					t15 = (abs(nxtpnY[x] - prvpnY[x]) &lt; mthreshL);
-					t16 = (abs(nxt2ppY[x] - srcppY[x]) &lt; mthreshL);
-					t17 = (abs(nxt2pnY[x] - srcpnY[x]) &lt; mthreshL);
-					t18 = (abs(nxtpY[x] - prvpY[x]) &lt; mthreshL);
-					t19 = (abs(nxt2pY[x] - srcpY[x]) &lt; mthreshL);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2 &amp;&amp; ((t3 &amp;&amp; t4 &amp;&amp; t14 &amp;&amp; t15) || (t5 &amp;&amp; t18))) || 
-							(t3 &amp;&amp; t4 &amp;&amp; t7 &amp;&amp; t19) || 
-							(t5 &amp;&amp; t18 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t1 &amp;&amp; t8 &amp;&amp; t12) || (t2 &amp;&amp; t9 &amp;&amp; t13))) ||
-							(t7 &amp;&amp; t19 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t3 &amp;&amp; t10 &amp;&amp; t16) || (t4 &amp;&amp; t11 &amp;&amp; t17)))))
-						maskwY[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7 &amp;&amp; t14 &amp;&amp; t15) maskwY[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2 &amp;&amp; t8 &amp;&amp; t9 &amp;&amp; t12 &amp;&amp; t13) maskwY[x] = 10;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4 &amp;&amp; t10 &amp;&amp; t11 &amp;&amp; t16 &amp;&amp; t17) maskwY[x] = 30;
-					else if (abs(srcpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(srcpY[x]-srcpnY[x])&lt;4) maskwY[x] = 110;
-					else if (abs(nxtpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(nxtpY[x]-srcpnY[x])&lt;4) maskwY[x] = 130;
-					else maskwY[x] = 60;
-				}
-				prv2ppY += prv2_pitchY;
-				prv2pY += prv2_pitchY;
-				prv2pnY += prv2_pitchY;
-				prvppY += prv_pitchY;
-				prvpY += prv_pitchY;
-				prvpnY += prv_pitchY;
-				srcppY += src_pitchY;
-				srcpY += src_pitchY;
-				srcpnY += src_pitchY;
-				nxtppY += nxt_pitchY;
-				nxtpY += nxt_pitchY;
-				nxtpnY += nxt_pitchY;
-				nxt2ppY += nxt2_pitchY;
-				nxt2pY += nxt2_pitchY;
-				nxt2pnY += nxt2_pitchY;
-				maskwY += mask_pitchY;
-			}
-			for (y=1; y&lt;HeightUV-1; y+=2)
-			{
-				for (x=0; x&lt;WidthUV; ++x)
-				{
-					t1 = n == 0 ? false : (abs(srcppV[x] - prvppV[x]) &lt; mthreshC);
-					t2 = n == 0 ? false : (abs(srcpnV[x] - prvpnV[x]) &lt; mthreshC);
-					t3 = n == nfrms ? false : (abs(srcppV[x] - nxtppV[x]) &lt; mthreshC);
-					t4 = n == nfrms ? false : (abs(srcpnV[x] - nxtpnV[x]) &lt; mthreshC);
-					t5 = n == 0 ? false : (abs(srcpV[x] - prvpV[x]) &lt; mthreshC);
-					t6 = n == nfrms ? false : (abs(srcpV[x] - nxtpV[x]) &lt; mthreshC);
-					t7 = n &gt;= nfrms-1 ? false : (abs(nxtpV[x] - nxt2pV[x]) &lt; mthreshC);
-					t8 = n &lt;= 1 ? false : (abs(prvppV[x] - prv2ppV[x]) &lt; mthreshC);
-					t9 = n &lt;= 1 ? false : (abs(prvpnV[x] - prv2pnV[x]) &lt; mthreshC);
-					t10 = n &gt;= nfrms-1 ? false : (abs(nxtppV[x] - nxt2ppV[x]) &lt; mthreshC);
-					t11 = n &gt;= nfrms-1 ? false : (abs(nxtpnV[x] - nxt2pnV[x]) &lt; mthreshC);
-					t12 = (abs(srcppV[x] - prv2ppV[x]) &lt; mthreshC);
-					t13 = (abs(srcpnV[x] - prv2pnV[x]) &lt; mthreshC);
-					t14 = (abs(nxtppV[x] - prvppV[x]) &lt; mthreshC);
-					t15 = (abs(nxtpnV[x] - prvpnV[x]) &lt; mthreshC);
-					t16 = (abs(nxt2ppV[x] - srcppV[x]) &lt; mthreshC);
-					t17 = (abs(nxt2pnV[x] - srcpnV[x]) &lt; mthreshC);
-					t18 = (abs(nxtpV[x] - prvpV[x]) &lt; mthreshC);
-					t19 = (abs(nxt2pV[x] - srcpV[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2 &amp;&amp; ((t3 &amp;&amp; t4 &amp;&amp; t14 &amp;&amp; t15) || (t5 &amp;&amp; t18))) || 
-							(t3 &amp;&amp; t4 &amp;&amp; t7 &amp;&amp; t19) || 
-							(t5 &amp;&amp; t18 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t1 &amp;&amp; t8 &amp;&amp; t12) || (t2 &amp;&amp; t9 &amp;&amp; t13))) ||
-							(t7 &amp;&amp; t19 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t3 &amp;&amp; t10 &amp;&amp; t16) || (t4 &amp;&amp; t11 &amp;&amp; t17)))))
-						maskwV[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7 &amp;&amp; t14 &amp;&amp; t15) maskwV[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2 &amp;&amp; t8 &amp;&amp; t9 &amp;&amp; t12 &amp;&amp; t13) maskwV[x] = 10;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4 &amp;&amp; t10 &amp;&amp; t11 &amp;&amp; t16 &amp;&amp; t17) maskwV[x] = 30;
-					else if (abs(srcpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(srcpV[x]-srcpnV[x])&lt;4) maskwV[x] = 110;
-					else if (abs(nxtpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(nxtpV[x]-srcpnV[x])&lt;4) maskwV[x] = 130;
-					else maskwV[x] = 60;
-					t1 = n == 0 ? false : (abs(srcppU[x] - prvppU[x]) &lt; mthreshC);
-					t2 = n == 0 ? false : (abs(srcpnU[x] - prvpnU[x]) &lt; mthreshC);
-					t3 = n == nfrms ? false : (abs(srcppU[x] - nxtppU[x]) &lt; mthreshC);
-					t4 = n == nfrms ? false : (abs(srcpnU[x] - nxtpnU[x]) &lt; mthreshC);
-					t5 = n == 0 ? false : (abs(srcpU[x] - prvpU[x]) &lt; mthreshC);
-					t6 = n == nfrms ? false : (abs(srcpU[x] - nxtpU[x]) &lt; mthreshC);
-					t7 = n &gt;= nfrms-1 ? false : (abs(nxtpU[x] - nxt2pU[x]) &lt; mthreshC);
-					t8 = n &lt;= 1 ? false : (abs(prvppU[x] - prv2ppU[x]) &lt; mthreshC);
-					t9 = n &lt;= 1 ? false : (abs(prvpnU[x] - prv2pnU[x]) &lt; mthreshC);
-					t10 = n &gt;= nfrms-1 ? false : (abs(nxtppU[x] - nxt2ppU[x]) &lt; mthreshC);
-					t11 = n &gt;= nfrms-1 ? false : (abs(nxtpnU[x] - nxt2pnU[x]) &lt; mthreshC);
-					t12 = (abs(srcppU[x] - prv2ppU[x]) &lt; mthreshC);
-					t13 = (abs(srcpnU[x] - prv2pnU[x]) &lt; mthreshC);
-					t14 = (abs(nxtppU[x] - prvppU[x]) &lt; mthreshC);
-					t15 = (abs(nxtpnU[x] - prvpnU[x]) &lt; mthreshC);
-					t16 = (abs(nxt2ppU[x] - srcppU[x]) &lt; mthreshC);
-					t17 = (abs(nxt2pnU[x] - srcpnU[x]) &lt; mthreshC);
-					t18 = (abs(nxtpU[x] - prvpU[x]) &lt; mthreshC);
-					t19 = (abs(nxt2pU[x] - srcpU[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2 &amp;&amp; ((t3 &amp;&amp; t4 &amp;&amp; t14 &amp;&amp; t15) || (t5 &amp;&amp; t18))) || 
-							(t3 &amp;&amp; t4 &amp;&amp; t7 &amp;&amp; t19) || 
-							(t5 &amp;&amp; t18 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t1 &amp;&amp; t8 &amp;&amp; t12) || (t2 &amp;&amp; t9 &amp;&amp; t13))) ||
-							(t7 &amp;&amp; t19 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t3 &amp;&amp; t10 &amp;&amp; t16) || (t4 &amp;&amp; t11 &amp;&amp; t17)))))
-						maskwU[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7 &amp;&amp; t14 &amp;&amp; t15) maskwU[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2 &amp;&amp; t8 &amp;&amp; t9 &amp;&amp; t12 &amp;&amp; t13) maskwU[x] = 10;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4 &amp;&amp; t10 &amp;&amp; t11 &amp;&amp; t16 &amp;&amp; t17) maskwU[x] = 30;
-					else if (abs(srcpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(srcpU[x]-srcpnU[x])&lt;4) maskwU[x] = 110;
-					else if (abs(nxtpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(nxtpU[x]-srcpnU[x])&lt;4) maskwU[x] = 130;
-					else maskwU[x] = 60;
-				}
-				prv2ppV += prv2_pitchUV;
-				prv2pV += prv2_pitchUV;
-				prv2pnV += prv2_pitchUV;
-				prv2ppU += prv2_pitchUV;
-				prv2pU += prv2_pitchUV;
-				prv2pnU += prv2_pitchUV;
-				prvppV += prv_pitchUV;
-				prvpV += prv_pitchUV;
-				prvpnV += prv_pitchUV;
-				prvppU += prv_pitchUV;
-				prvpU += prv_pitchUV;
-				prvpnU += prv_pitchUV;
-				srcppV += src_pitchUV;
-				srcpV += src_pitchUV;
-				srcpnV += src_pitchUV;
-				srcppU += src_pitchUV;
-				srcpU += src_pitchUV;
-				srcpnU += src_pitchUV;
-				nxtppV += nxt_pitchUV;
-				nxtpV += nxt_pitchUV;
-				nxtpnV += nxt_pitchUV;
-				nxtppU += nxt_pitchUV;
-				nxtpU += nxt_pitchUV;
-				nxtpnU += nxt_pitchUV;
-				nxt2ppV += nxt2_pitchUV;
-				nxt2pV += nxt2_pitchUV;
-				nxt2pnV += nxt2_pitchUV;
-				nxt2ppU += nxt2_pitchUV;
-				nxt2pU += nxt2_pitchUV;
-				nxt2pnU += nxt2_pitchUV;
-				maskwV += mask_pitchUV;
-				maskwU += mask_pitchUV;
-			}
-		}
-		else
-		{
-			for (y=1; y&lt;HeightY-1; y+=2)
-			{
-				for (x=0; x&lt;WidthY; ++x)
-				{
-					t1 = (abs(srcppY[x] - prvppY[x]) &lt; mthreshL);
-					t2 = (abs(srcpnY[x] - prvpnY[x]) &lt; mthreshL);
-					t3 = (abs(srcppY[x] - nxtppY[x]) &lt; mthreshL);
-					t4 = (abs(srcpnY[x] - nxtpnY[x]) &lt; mthreshL);
-					t5 = (abs(srcpY[x] - prvpY[x]) &lt; mthreshL);
-					t6 = (abs(srcpY[x] - nxtpY[x]) &lt; mthreshL);
-					t7 = (abs(nxtpY[x] - nxt2pY[x]) &lt; mthreshL);
-					t8 = (abs(prvppY[x] - prv2ppY[x]) &lt; mthreshL);
-					t9 = (abs(prvpnY[x] - prv2pnY[x]) &lt; mthreshL);
-					t10 = (abs(nxtppY[x] - nxt2ppY[x]) &lt; mthreshL);
-					t11 = (abs(nxtpnY[x] - nxt2pnY[x]) &lt; mthreshL);
-					t12 = (abs(srcppY[x] - prv2ppY[x]) &lt; mthreshL);
-					t13 = (abs(srcpnY[x] - prv2pnY[x]) &lt; mthreshL);
-					t14 = (abs(nxtppY[x] - prvppY[x]) &lt; mthreshL);
-					t15 = (abs(nxtpnY[x] - prvpnY[x]) &lt; mthreshL);
-					t16 = (abs(nxt2ppY[x] - srcppY[x]) &lt; mthreshL);
-					t17 = (abs(nxt2pnY[x] - srcpnY[x]) &lt; mthreshL);
-					t18 = (abs(nxtpY[x] - prvpY[x]) &lt; mthreshL);
-					t19 = (abs(nxt2pY[x] - srcpY[x]) &lt; mthreshL);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2 &amp;&amp; ((t3 &amp;&amp; t4 &amp;&amp; t14 &amp;&amp; t15) || (t5 &amp;&amp; t18))) || 
-							(t3 &amp;&amp; t4 &amp;&amp; t7 &amp;&amp; t19) || 
-							(t5 &amp;&amp; t18 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t1 &amp;&amp; t8 &amp;&amp; t12) || (t2 &amp;&amp; t9 &amp;&amp; t13))) ||
-							(t7 &amp;&amp; t19 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t3 &amp;&amp; t10 &amp;&amp; t16) || (t4 &amp;&amp; t11 &amp;&amp; t17)))))
-						maskwY[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7 &amp;&amp; t14 &amp;&amp; t15) maskwY[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2 &amp;&amp; t8 &amp;&amp; t9 &amp;&amp; t12 &amp;&amp; t13) maskwY[x] = 10;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4 &amp;&amp; t10 &amp;&amp; t11 &amp;&amp; t16 &amp;&amp; t17) maskwY[x] = 30;
-					else if (abs(srcpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(srcpY[x]-srcpnY[x])&lt;4) maskwY[x] = 110;
-					else if (abs(nxtpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(nxtpY[x]-srcpnY[x])&lt;4) maskwY[x] = 130;
-					else maskwY[x] = 60;
-				}
-				prv2ppY += prv2_pitchY;
-				prv2pY += prv2_pitchY;
-				prv2pnY += prv2_pitchY;
-				prvppY += prv_pitchY;
-				prvpY += prv_pitchY;
-				prvpnY += prv_pitchY;
-				srcppY += src_pitchY;
-				srcpY += src_pitchY;
-				srcpnY += src_pitchY;
-				nxtppY += nxt_pitchY;
-				nxtpY += nxt_pitchY;
-				nxtpnY += nxt_pitchY;
-				nxt2ppY += nxt2_pitchY;
-				nxt2pY += nxt2_pitchY;
-				nxt2pnY += nxt2_pitchY;
-				maskwY += mask_pitchY;
-			}
-			for (y=1; y&lt;HeightUV-1; y+=2)
-			{
-				for (x=0; x&lt;WidthUV; ++x)
-				{
-					t1 = (abs(srcppV[x] - prvppV[x]) &lt; mthreshC);
-					t2 = (abs(srcpnV[x] - prvpnV[x]) &lt; mthreshC);
-					t3 = (abs(srcppV[x] - nxtppV[x]) &lt; mthreshC);
-					t4 = (abs(srcpnV[x] - nxtpnV[x]) &lt; mthreshC);
-					t5 = (abs(srcpV[x] - prvpV[x]) &lt; mthreshC);
-					t6 = (abs(srcpV[x] - nxtpV[x]) &lt; mthreshC);
-					t7 = (abs(nxtpV[x] - nxt2pV[x]) &lt; mthreshC);
-					t8 = (abs(prvppV[x] - prv2ppV[x]) &lt; mthreshC);
-					t9 = (abs(prvpnV[x] - prv2pnV[x]) &lt; mthreshC);
-					t10 = (abs(nxtppV[x] - nxt2ppV[x]) &lt; mthreshC);
-					t11 = (abs(nxtpnV[x] - nxt2pnV[x]) &lt; mthreshC);
-					t12 = (abs(srcppV[x] - prv2ppV[x]) &lt; mthreshC);
-					t13 = (abs(srcpnV[x] - prv2pnV[x]) &lt; mthreshC);
-					t14 = (abs(nxtppV[x] - prvppV[x]) &lt; mthreshC);
-					t15 = (abs(nxtpnV[x] - prvpnV[x]) &lt; mthreshC);
-					t16 = (abs(nxt2ppV[x] - srcppV[x]) &lt; mthreshC);
-					t17 = (abs(nxt2pnV[x] - srcpnV[x]) &lt; mthreshC);
-					t18 = (abs(nxtpV[x] - prvpV[x]) &lt; mthreshC);
-					t19 = (abs(nxt2pV[x] - srcpV[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2 &amp;&amp; ((t3 &amp;&amp; t4 &amp;&amp; t14 &amp;&amp; t15) || (t5 &amp;&amp; t18))) || 
-							(t3 &amp;&amp; t4 &amp;&amp; t7 &amp;&amp; t19) || 
-							(t5 &amp;&amp; t18 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t1 &amp;&amp; t8 &amp;&amp; t12) || (t2 &amp;&amp; t9 &amp;&amp; t13))) ||
-							(t7 &amp;&amp; t19 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t3 &amp;&amp; t10 &amp;&amp; t16) || (t4 &amp;&amp; t11 &amp;&amp; t17)))))
-						maskwV[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7 &amp;&amp; t14 &amp;&amp; t15) maskwV[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2 &amp;&amp; t8 &amp;&amp; t9 &amp;&amp; t12 &amp;&amp; t13) maskwV[x] = 10;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4 &amp;&amp; t10 &amp;&amp; t11 &amp;&amp; t16 &amp;&amp; t17) maskwV[x] = 30;
-					else if (abs(srcpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(srcpV[x]-srcpnV[x])&lt;4) maskwV[x] = 110;
-					else if (abs(nxtpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(nxtpV[x]-srcpnV[x])&lt;4) maskwV[x] = 130;
-					else maskwV[x] = 60;
-					t1 = (abs(srcppU[x] - prvppU[x]) &lt; mthreshC);
-					t2 = (abs(srcpnU[x] - prvpnU[x]) &lt; mthreshC);
-					t3 = (abs(srcppU[x] - nxtppU[x]) &lt; mthreshC);
-					t4 = (abs(srcpnU[x] - nxtpnU[x]) &lt; mthreshC);
-					t5 = (abs(srcpU[x] - prvpU[x]) &lt; mthreshC);
-					t6 = (abs(srcpU[x] - nxtpU[x]) &lt; mthreshC);
-					t7 = (abs(nxtpU[x] - nxt2pU[x]) &lt; mthreshC);
-					t8 = (abs(prvppU[x] - prv2ppU[x]) &lt; mthreshC);
-					t9 = (abs(prvpnU[x] - prv2pnU[x]) &lt; mthreshC);
-					t10 = (abs(nxtppU[x] - nxt2ppU[x]) &lt; mthreshC);
-					t11 = (abs(nxtpnU[x] - nxt2pnU[x]) &lt; mthreshC);
-					t12 = (abs(srcppU[x] - prv2ppU[x]) &lt; mthreshC);
-					t13 = (abs(srcpnU[x] - prv2pnU[x]) &lt; mthreshC);
-					t14 = (abs(nxtppU[x] - prvppU[x]) &lt; mthreshC);
-					t15 = (abs(nxtpnU[x] - prvpnU[x]) &lt; mthreshC);
-					t16 = (abs(nxt2ppU[x] - srcppU[x]) &lt; mthreshC);
-					t17 = (abs(nxt2pnU[x] - srcpnU[x]) &lt; mthreshC);
-					t18 = (abs(nxtpU[x] - prvpU[x]) &lt; mthreshC);
-					t19 = (abs(nxt2pU[x] - srcpU[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2 &amp;&amp; ((t3 &amp;&amp; t4 &amp;&amp; t14 &amp;&amp; t15) || (t5 &amp;&amp; t18))) || 
-							(t3 &amp;&amp; t4 &amp;&amp; t7 &amp;&amp; t19) || 
-							(t5 &amp;&amp; t18 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t1 &amp;&amp; t8 &amp;&amp; t12) || (t2 &amp;&amp; t9 &amp;&amp; t13))) ||
-							(t7 &amp;&amp; t19 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t3 &amp;&amp; t10 &amp;&amp; t16) || (t4 &amp;&amp; t11 &amp;&amp; t17)))))
-						maskwU[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7 &amp;&amp; t14 &amp;&amp; t15) maskwU[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2 &amp;&amp; t8 &amp;&amp; t9 &amp;&amp; t12 &amp;&amp; t13) maskwU[x] = 10;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4 &amp;&amp; t10 &amp;&amp; t11 &amp;&amp; t16 &amp;&amp; t17) maskwU[x] = 30;
-					else if (abs(srcpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(srcpU[x]-srcpnU[x])&lt;4) maskwU[x] = 110;
-					else if (abs(nxtpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(nxtpU[x]-srcpnU[x])&lt;4) maskwU[x] = 130;
-					else maskwU[x] = 60;
-				}
-				prv2ppV += prv2_pitchUV;
-				prv2pV += prv2_pitchUV;
-				prv2pnV += prv2_pitchUV;
-				prv2ppU += prv2_pitchUV;
-				prv2pU += prv2_pitchUV;
-				prv2pnU += prv2_pitchUV;
-				prvppV += prv_pitchUV;
-				prvpV += prv_pitchUV;
-				prvpnV += prv_pitchUV;
-				prvppU += prv_pitchUV;
-				prvpU += prv_pitchUV;
-				prvpnU += prv_pitchUV;
-				srcppV += src_pitchUV;
-				srcpV += src_pitchUV;
-				srcpnV += src_pitchUV;
-				srcppU += src_pitchUV;
-				srcpU += src_pitchUV;
-				srcpnU += src_pitchUV;
-				nxtppV += nxt_pitchUV;
-				nxtpV += nxt_pitchUV;
-				nxtpnV += nxt_pitchUV;
-				nxtppU += nxt_pitchUV;
-				nxtpU += nxt_pitchUV;
-				nxtpnU += nxt_pitchUV;
-				nxt2ppV += nxt2_pitchUV;
-				nxt2pV += nxt2_pitchUV;
-				nxt2pnV += nxt2_pitchUV;
-				nxt2ppU += nxt2_pitchUV;
-				nxt2pU += nxt2_pitchUV;
-				nxt2pnU += nxt2_pitchUV;
-				maskwV += mask_pitchUV;
-				maskwU += mask_pitchUV;
-			}
-		}
-	}
-	else
-	{
-		val1 = PRM(mntmode) &gt; 1 ? (accumP &lt; accumN ? 20 : 10) : 50;
-		if (n &lt;= 1 || n &gt;= nfrms-1)
-		{
-			for (y=1; y&lt;HeightY-1; y+=2)
-			{
-				for (x=0; x&lt;WidthY; ++x)
-				{
-					t1 = n == 0 ? false : (abs(srcppY[x] - prvppY[x]) &lt; mthreshL);
-					t2 = n == 0 ? false : (abs(srcpnY[x] - prvpnY[x]) &lt; mthreshL);
-					t3 = n == nfrms ? false : (abs(srcppY[x] - nxtppY[x]) &lt; mthreshL);
-					t4 = n == nfrms ? false : (abs(srcpnY[x] - nxtpnY[x]) &lt; mthreshL);
-					t5 = n &lt;= 1 ? false : (abs(prvpY[x] - prv2pY[x]) &lt; mthreshL);
-					t6 = n == 0 ? false : (abs(srcpY[x] - prvpY[x]) &lt; mthreshL);
-					t7 = n == nfrms ? false : (abs(srcpY[x] - nxtpY[x]) &lt; mthreshL);
-					t8 = n &lt;= 1 ? false : (abs(prvppY[x] - prv2ppY[x]) &lt; mthreshL);
-					t9 = n &lt;= 1 ? false : (abs(prvpnY[x] - prv2pnY[x]) &lt; mthreshL);
-					t10 = n &gt;= nfrms-1 ? false : (abs(nxtppY[x] - nxt2ppY[x]) &lt; mthreshL);
-					t11 = n &gt;= nfrms-1 ? false : (abs(nxtpnY[x] - nxt2pnY[x]) &lt; mthreshL);
-					t12 = (abs(srcppY[x] - prv2ppY[x]) &lt; mthreshL);
-					t13 = (abs(srcpnY[x] - prv2pnY[x]) &lt; mthreshL);
-					t14 = (abs(nxtppY[x] - prvppY[x]) &lt; mthreshL);
-					t15 = (abs(nxtpnY[x] - prvpnY[x]) &lt; mthreshL);
-					t16 = (abs(nxt2ppY[x] - srcppY[x]) &lt; mthreshL);
-					t17 = (abs(nxt2pnY[x] - srcpnY[x]) &lt; mthreshL);
-					t18 = (abs(srcpY[x] - prv2pY[x]) &lt; mthreshL);
-					t19 = (abs(nxtpY[x] - prvpY[x]) &lt; mthreshL);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2 &amp;&amp; ((t3 &amp;&amp; t4 &amp;&amp; t14 &amp;&amp; t15) || (t5 &amp;&amp; t18))) || 
-							(t3 &amp;&amp; t4 &amp;&amp; t7 &amp;&amp; t19) || 
-							(t5 &amp;&amp; t18 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t1 &amp;&amp; t8 &amp;&amp; t12) || (t2 &amp;&amp; t9 &amp;&amp; t13))) ||
-							(t7 &amp;&amp; t19 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t3 &amp;&amp; t10 &amp;&amp; t16) || (t4 &amp;&amp; t11 &amp;&amp; t17)))))
-						maskwY[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7 &amp;&amp; t14 &amp;&amp; t15) maskwY[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2 &amp;&amp; t8 &amp;&amp; t9 &amp;&amp; t12 &amp;&amp; t13) maskwY[x] = 20;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4 &amp;&amp; t10 &amp;&amp; t11 &amp;&amp; t16 &amp;&amp; t17) maskwY[x] = 10;
-					else if (abs(prvpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(prvpY[x]-srcpnY[x])&lt;4) maskwY[x] = 120;
-					else if (abs(srcpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(srcpY[x]-srcpnY[x])&lt;4) maskwY[x] = 110;
-					else maskwY[x] = 60;
-				}
-				prv2ppY += prv2_pitchY;
-				prv2pY += prv2_pitchY;
-				prv2pnY += prv2_pitchY;
-				prvppY += prv_pitchY;
-				prvpY += prv_pitchY;
-				prvpnY += prv_pitchY;
-				srcppY += src_pitchY;
-				srcpY += src_pitchY;
-				srcpnY += src_pitchY;
-				nxtppY += nxt_pitchY;
-				nxtpY += nxt_pitchY;
-				nxtpnY += nxt_pitchY;
-				nxt2ppY += nxt2_pitchY;
-				nxt2pY += nxt2_pitchY;
-				nxt2pnY += nxt2_pitchY;
-				maskwY += mask_pitchY;
-			}
-			for (y=1; y&lt;HeightUV-1; y+=2)
-			{
-				for (x=0; x&lt;WidthUV; ++x)
-				{
-					t1 = n == 0 ? false : (abs(srcppV[x] - prvppV[x]) &lt; mthreshC);
-					t2 = n == 0 ? false : (abs(srcpnV[x] - prvpnV[x]) &lt; mthreshC);
-					t3 = n == nfrms ? false : (abs(srcppV[x] - nxtppV[x]) &lt; mthreshC);
-					t4 = n == nfrms ? false : (abs(srcpnV[x] - nxtpnV[x]) &lt; mthreshC);
-					t5 = n &lt;= 1 ? false : (abs(prvpV[x] - prv2pV[x]) &lt; mthreshC);
-					t6 = n == 0 ? false : (abs(srcpV[x] - prvpV[x]) &lt; mthreshC);
-					t7 = n == nfrms ? false : (abs(srcpV[x] - nxtpV[x]) &lt; mthreshC);
-					t8 = n &lt;= 1 ? false : (abs(prvppV[x] - prv2ppV[x]) &lt; mthreshC);
-					t9 = n &lt;= 1 ? false : (abs(prvpnV[x] - prv2pnV[x]) &lt; mthreshC);
-					t10 = n &gt;= nfrms-1 ? false : (abs(nxtppV[x] - nxt2ppV[x]) &lt; mthreshC);
-					t11 = n &gt;= nfrms-1 ? false : (abs(nxtpnV[x] - nxt2pnV[x]) &lt; mthreshC);
-					t12 = (abs(srcppV[x] - prv2ppV[x]) &lt; mthreshC);
-					t13 = (abs(srcpnV[x] - prv2pnV[x]) &lt; mthreshC);
-					t14 = (abs(nxtppV[x] - prvppV[x]) &lt; mthreshC);
-					t15 = (abs(nxtpnV[x] - prvpnV[x]) &lt; mthreshC);
-					t16 = (abs(nxt2ppV[x] - srcppV[x]) &lt; mthreshC);
-					t17 = (abs(nxt2pnV[x] - srcpnV[x]) &lt; mthreshC);
-					t18 = (abs(srcpV[x] - prv2pV[x]) &lt; mthreshC);
-					t19 = (abs(nxtpV[x] - prvpV[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2 &amp;&amp; ((t3 &amp;&amp; t4 &amp;&amp; t14 &amp;&amp; t15) || (t5 &amp;&amp; t18))) || 
-							(t3 &amp;&amp; t4 &amp;&amp; t7 &amp;&amp; t19) || 
-							(t5 &amp;&amp; t18 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t1 &amp;&amp; t8 &amp;&amp; t12) || (t2 &amp;&amp; t9 &amp;&amp; t13))) ||
-							(t7 &amp;&amp; t19 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t3 &amp;&amp; t10 &amp;&amp; t16) || (t4 &amp;&amp; t11 &amp;&amp; t17)))))
-						maskwV[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7 &amp;&amp; t14 &amp;&amp; t15) maskwV[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2 &amp;&amp; t8 &amp;&amp; t9 &amp;&amp; t12 &amp;&amp; t13) maskwV[x] = 20;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4 &amp;&amp; t10 &amp;&amp; t11 &amp;&amp; t16 &amp;&amp; t17) maskwV[x] = 10;
-					else if (abs(prvpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(prvpV[x]-srcpnV[x])&lt;4) maskwV[x] = 120;
-					else if (abs(srcpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(srcpV[x]-srcpnV[x])&lt;4) maskwV[x] = 110;
-					else maskwV[x] = 60;
-					t1 = n == 0 ? false : (abs(srcppU[x] - prvppU[x]) &lt; mthreshC);
-					t2 = n == 0 ? false : (abs(srcpnU[x] - prvpnU[x]) &lt; mthreshC);
-					t3 = n == nfrms ? false : (abs(srcppU[x] - nxtppU[x]) &lt; mthreshC);
-					t4 = n == nfrms ? false : (abs(srcpnU[x] - nxtpnU[x]) &lt; mthreshC);
-					t5 = n &lt;= 1 ? false : (abs(prvpU[x] - prv2pU[x]) &lt; mthreshC);
-					t6 = n == 0 ? false : (abs(srcpU[x] - prvpU[x]) &lt; mthreshC);
-					t7 = n == nfrms ? false : (abs(srcpU[x] - nxtpU[x]) &lt; mthreshC);
-					t8 = n &lt;= 1 ? false : (abs(prvppU[x] - prv2ppU[x]) &lt; mthreshC);
-					t9 = n &lt;= 1 ? false : (abs(prvpnU[x] - prv2pnU[x]) &lt; mthreshC);
-					t10 = n &gt;= nfrms-1 ? false : (abs(nxtppU[x] - nxt2ppU[x]) &lt; mthreshC);
-					t11 = n &gt;= nfrms-1 ? false : (abs(nxtpnU[x] - nxt2pnU[x]) &lt; mthreshC);
-					t12 = (abs(srcppU[x] - prv2ppU[x]) &lt; mthreshC);
-					t13 = (abs(srcpnU[x] - prv2pnU[x]) &lt; mthreshC);
-					t14 = (abs(nxtppU[x] - prvppU[x]) &lt; mthreshC);
-					t15 = (abs(nxtpnU[x] - prvpnU[x]) &lt; mthreshC);
-					t16 = (abs(nxt2ppU[x] - srcppU[x]) &lt; mthreshC);
-					t17 = (abs(nxt2pnU[x] - srcpnU[x]) &lt; mthreshC);
-					t18 = (abs(srcpU[x] - prv2pU[x]) &lt; mthreshC);
-					t19 = (abs(nxtpU[x] - prvpU[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2 &amp;&amp; ((t3 &amp;&amp; t4 &amp;&amp; t14 &amp;&amp; t15) || (t5 &amp;&amp; t18))) || 
-							(t3 &amp;&amp; t4 &amp;&amp; t7 &amp;&amp; t19) || 
-							(t5 &amp;&amp; t18 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t1 &amp;&amp; t8 &amp;&amp; t12) || (t2 &amp;&amp; t9 &amp;&amp; t13))) ||
-							(t7 &amp;&amp; t19 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t3 &amp;&amp; t10 &amp;&amp; t16) || (t4 &amp;&amp; t11 &amp;&amp; t17)))))
-						maskwU[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7 &amp;&amp; t14 &amp;&amp; t15) maskwU[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2 &amp;&amp; t8 &amp;&amp; t9 &amp;&amp; t12 &amp;&amp; t13) maskwU[x] = 20;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4 &amp;&amp; t10 &amp;&amp; t11 &amp;&amp; t16 &amp;&amp; t17) maskwU[x] = 10;
-					else if (abs(prvpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(prvpU[x]-srcpnU[x])&lt;4) maskwU[x] = 120;
-					else if (abs(srcpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(srcpU[x]-srcpnU[x])&lt;4) maskwU[x] = 110;
-					else maskwU[x] = 60;
-				}
-				prv2ppV += prv2_pitchUV;
-				prv2pV += prv2_pitchUV;
-				prv2pnV += prv2_pitchUV;
-				prv2ppU += prv2_pitchUV;
-				prv2pU += prv2_pitchUV;
-				prv2pnU += prv2_pitchUV;
-				prvppV += prv_pitchUV;
-				prvpV += prv_pitchUV;
-				prvpnV += prv_pitchUV;
-				prvppU += prv_pitchUV;
-				prvpU += prv_pitchUV;
-				prvpnU += prv_pitchUV;
-				srcppV += src_pitchUV;
-				srcpV += src_pitchUV;
-				srcpnV += src_pitchUV;
-				srcppU += src_pitchUV;
-				srcpU += src_pitchUV;
-				srcpnU += src_pitchUV;
-				nxtppV += nxt_pitchUV;
-				nxtpV += nxt_pitchUV;
-				nxtpnV += nxt_pitchUV;
-				nxtppU += nxt_pitchUV;
-				nxtpU += nxt_pitchUV;
-				nxtpnU += nxt_pitchUV;
-				nxt2ppV += nxt2_pitchUV;
-				nxt2pV += nxt2_pitchUV;
-				nxt2pnV += nxt2_pitchUV;
-				nxt2ppU += nxt2_pitchUV;
-				nxt2pU += nxt2_pitchUV;
-				nxt2pnU += nxt2_pitchUV;
-				maskwV += mask_pitchUV;
-				maskwU += mask_pitchUV;
-			}
-		}
-		else
-		{
-			for (y=1; y&lt;HeightY-1; y+=2)
-			{
-				for (x=0; x&lt;WidthY; ++x)
-				{
-					t1 = (abs(srcppY[x] - prvppY[x]) &lt; mthreshL);
-					t2 = (abs(srcpnY[x] - prvpnY[x]) &lt; mthreshL);
-					t3 = (abs(srcppY[x] - nxtppY[x]) &lt; mthreshL);
-					t4 = (abs(srcpnY[x] - nxtpnY[x]) &lt; mthreshL);
-					t5 = (abs(prvpY[x] - prv2pY[x]) &lt; mthreshL);
-					t6 = (abs(srcpY[x] - prvpY[x]) &lt; mthreshL);
-					t7 = (abs(srcpY[x] - nxtpY[x]) &lt; mthreshL);
-					t8 = (abs(prvppY[x] - prv2ppY[x]) &lt; mthreshL);
-					t9 = (abs(prvpnY[x] - prv2pnY[x]) &lt; mthreshL);
-					t10 = (abs(nxtppY[x] - nxt2ppY[x]) &lt; mthreshL);
-					t11 = (abs(nxtpnY[x] - nxt2pnY[x]) &lt; mthreshL);
-					t12 = (abs(srcppY[x] - prv2ppY[x]) &lt; mthreshL);
-					t13 = (abs(srcpnY[x] - prv2pnY[x]) &lt; mthreshL);
-					t14 = (abs(nxtppY[x] - prvppY[x]) &lt; mthreshL);
-					t15 = (abs(nxtpnY[x] - prvpnY[x]) &lt; mthreshL);
-					t16 = (abs(nxt2ppY[x] - srcppY[x]) &lt; mthreshL);
-					t17 = (abs(nxt2pnY[x] - srcpnY[x]) &lt; mthreshL);
-					t18 = (abs(srcpY[x] - prv2pY[x]) &lt; mthreshL);
-					t19 = (abs(nxtpY[x] - prvpY[x]) &lt; mthreshL);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2 &amp;&amp; ((t3 &amp;&amp; t4 &amp;&amp; t14 &amp;&amp; t15) || (t5 &amp;&amp; t18))) || 
-							(t3 &amp;&amp; t4 &amp;&amp; t7 &amp;&amp; t19) || 
-							(t5 &amp;&amp; t18 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t1 &amp;&amp; t8 &amp;&amp; t12) || (t2 &amp;&amp; t9 &amp;&amp; t13))) ||
-							(t7 &amp;&amp; t19 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t3 &amp;&amp; t10 &amp;&amp; t16) || (t4 &amp;&amp; t11 &amp;&amp; t17)))))
-						maskwY[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7 &amp;&amp; t14 &amp;&amp; t15) maskwY[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2 &amp;&amp; t8 &amp;&amp; t9 &amp;&amp; t12 &amp;&amp; t13) maskwY[x] = 20;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4 &amp;&amp; t10 &amp;&amp; t11 &amp;&amp; t16 &amp;&amp; t17) maskwY[x] = 10;
-					else if (abs(prvpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(prvpY[x]-srcpnY[x])&lt;4) maskwY[x] = 120;
-					else if (abs(srcpY[x]-srcppY[x])&lt;4 &amp;&amp; abs(srcpY[x]-srcpnY[x])&lt;4) maskwY[x] = 110;
-					else maskwY[x] = 60;
-				}
-				prv2ppY += prv2_pitchY;
-				prv2pY += prv2_pitchY;
-				prv2pnY += prv2_pitchY;
-				prvppY += prv_pitchY;
-				prvpY += prv_pitchY;
-				prvpnY += prv_pitchY;
-				srcppY += src_pitchY;
-				srcpY += src_pitchY;
-				srcpnY += src_pitchY;
-				nxtppY += nxt_pitchY;
-				nxtpY += nxt_pitchY;
-				nxtpnY += nxt_pitchY;
-				nxt2ppY += nxt2_pitchY;
-				nxt2pY += nxt2_pitchY;
-				nxt2pnY += nxt2_pitchY;
-				maskwY += mask_pitchY;
-			}
-			for (y=1; y&lt;HeightUV-1; y+=2)
-			{
-				for (x=0; x&lt;WidthUV; ++x)
-				{
-					t1 = (abs(srcppV[x] - prvppV[x]) &lt; mthreshC);
-					t2 = (abs(srcpnV[x] - prvpnV[x]) &lt; mthreshC);
-					t3 = (abs(srcppV[x] - nxtppV[x]) &lt; mthreshC);
-					t4 = (abs(srcpnV[x] - nxtpnV[x]) &lt; mthreshC);
-					t5 = (abs(prvpV[x] - prv2pV[x]) &lt; mthreshC);
-					t6 = (abs(srcpV[x] - prvpV[x]) &lt; mthreshC);
-					t7 = (abs(srcpV[x] - nxtpV[x]) &lt; mthreshC);
-					t8 = (abs(prvppV[x] - prv2ppV[x]) &lt; mthreshC);
-					t9 = (abs(prvpnV[x] - prv2pnV[x]) &lt; mthreshC);
-					t10 = (abs(nxtppV[x] - nxt2ppV[x]) &lt; mthreshC);
-					t11 = (abs(nxtpnV[x] - nxt2pnV[x]) &lt; mthreshC);
-					t12 = (abs(srcppV[x] - prv2ppV[x]) &lt; mthreshC);
-					t13 = (abs(srcpnV[x] - prv2pnV[x]) &lt; mthreshC);
-					t14 = (abs(nxtppV[x] - prvppV[x]) &lt; mthreshC);
-					t15 = (abs(nxtpnV[x] - prvpnV[x]) &lt; mthreshC);
-					t16 = (abs(nxt2ppV[x] - srcppV[x]) &lt; mthreshC);
-					t17 = (abs(nxt2pnV[x] - srcpnV[x]) &lt; mthreshC);
-					t18 = (abs(srcpV[x] - prv2pV[x]) &lt; mthreshC);
-					t19 = (abs(nxtpV[x] - prvpV[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2 &amp;&amp; ((t3 &amp;&amp; t4 &amp;&amp; t14 &amp;&amp; t15) || (t5 &amp;&amp; t18))) || 
-							(t3 &amp;&amp; t4 &amp;&amp; t7 &amp;&amp; t19) || 
-							(t5 &amp;&amp; t18 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t1 &amp;&amp; t8 &amp;&amp; t12) || (t2 &amp;&amp; t9 &amp;&amp; t13))) ||
-							(t7 &amp;&amp; t19 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t3 &amp;&amp; t10 &amp;&amp; t16) || (t4 &amp;&amp; t11 &amp;&amp; t17)))))
-						maskwV[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7 &amp;&amp; t14 &amp;&amp; t15) maskwV[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2 &amp;&amp; t8 &amp;&amp; t9 &amp;&amp; t12 &amp;&amp; t13) maskwV[x] = 20;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4 &amp;&amp; t10 &amp;&amp; t11 &amp;&amp; t16 &amp;&amp; t17) maskwV[x] = 10;
-					else if (abs(prvpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(prvpV[x]-srcpnV[x])&lt;4) maskwV[x] = 120;
-					else if (abs(srcpV[x]-srcppV[x])&lt;4 &amp;&amp; abs(srcpV[x]-srcpnV[x])&lt;4) maskwV[x] = 110;
-					else maskwV[x] = 60;
-					t1 = (abs(srcppU[x] - prvppU[x]) &lt; mthreshC);
-					t2 = (abs(srcpnU[x] - prvpnU[x]) &lt; mthreshC);
-					t3 = (abs(srcppU[x] - nxtppU[x]) &lt; mthreshC);
-					t4 = (abs(srcpnU[x] - nxtpnU[x]) &lt; mthreshC);
-					t5 = (abs(prvpU[x] - prv2pU[x]) &lt; mthreshC);
-					t6 = (abs(srcpU[x] - prvpU[x]) &lt; mthreshC);
-					t7 = (abs(srcpU[x] - nxtpU[x]) &lt; mthreshC);
-					t8 = (abs(prvppU[x] - prv2ppU[x]) &lt; mthreshC);
-					t9 = (abs(prvpnU[x] - prv2pnU[x]) &lt; mthreshC);
-					t10 = (abs(nxtppU[x] - nxt2ppU[x]) &lt; mthreshC);
-					t11 = (abs(nxtpnU[x] - nxt2pnU[x]) &lt; mthreshC);
-					t12 = (abs(srcppU[x] - prv2ppU[x]) &lt; mthreshC);
-					t13 = (abs(srcpnU[x] - prv2pnU[x]) &lt; mthreshC);
-					t14 = (abs(nxtppU[x] - prvppU[x]) &lt; mthreshC);
-					t15 = (abs(nxtpnU[x] - prvpnU[x]) &lt; mthreshC);
-					t16 = (abs(nxt2ppU[x] - srcppU[x]) &lt; mthreshC);
-					t17 = (abs(nxt2pnU[x] - srcpnU[x]) &lt; mthreshC);
-					t18 = (abs(srcpU[x] - prv2pU[x]) &lt; mthreshC);
-					t19 = (abs(nxtpU[x] - prvpU[x]) &lt; mthreshC);
-					if (t6 &amp;&amp; ((t1 &amp;&amp; t2 &amp;&amp; ((t3 &amp;&amp; t4 &amp;&amp; t14 &amp;&amp; t15) || (t5 &amp;&amp; t18))) || 
-							(t3 &amp;&amp; t4 &amp;&amp; t7 &amp;&amp; t19) || 
-							(t5 &amp;&amp; t18 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t1 &amp;&amp; t8 &amp;&amp; t12) || (t2 &amp;&amp; t9 &amp;&amp; t13))) ||
-							(t7 &amp;&amp; t19 &amp;&amp; ((t1 &amp;&amp; t3 &amp;&amp; t14) || (t2 &amp;&amp; t4 &amp;&amp; t15) || (t3 &amp;&amp; t10 &amp;&amp; t16) || (t4 &amp;&amp; t11 &amp;&amp; t17)))))
-						maskwU[x] = val1;
-					else if (t1 &amp;&amp; t2 &amp;&amp; t3 &amp;&amp; t4 &amp;&amp; t5 &amp;&amp; t7 &amp;&amp; t14 &amp;&amp; t15) maskwU[x] = val1;
-					else if (t1 &amp;&amp; t5 &amp;&amp; t2 &amp;&amp; t8 &amp;&amp; t9 &amp;&amp; t12 &amp;&amp; t13) maskwU[x] = 20;
-					else if (t3 &amp;&amp; t7 &amp;&amp; t4 &amp;&amp; t10 &amp;&amp; t11 &amp;&amp; t16 &amp;&amp; t17) maskwU[x] = 10;
-					else if (abs(prvpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(prvpU[x]-srcpnU[x])&lt;4) maskwU[x] = 120;
-					else if (abs(srcpU[x]-srcppU[x])&lt;4 &amp;&amp; abs(srcpU[x]-srcpnU[x])&lt;4) maskwU[x] = 110;
-					else maskwU[x] = 60;
-				}
-				prv2ppV += prv2_pitchUV;
-				prv2pV += prv2_pitchUV;
-				prv2pnV += prv2_pitchUV;
-				prv2ppU += prv2_pitchUV;
-				prv2pU += prv2_pitchUV;
-				prv2pnU += prv2_pitchUV;
-				prvppV += prv_pitchUV;
-				prvpV += prv_pitchUV;
-				prvpnV += prv_pitchUV;
-				prvppU += prv_pitchUV;
-				prvpU += prv_pitchUV;
-				prvpnU += prv_pitchUV;
-				srcppV += src_pitchUV;
-				srcpV += src_pitchUV;
-				srcpnV += src_pitchUV;
-				srcppU += src_pitchUV;
-				srcpU += src_pitchUV;
-				srcpnU += src_pitchUV;
-				nxtppV += nxt_pitchUV;
-				nxtpV += nxt_pitchUV;
-				nxtpnV += nxt_pitchUV;
-				nxtppU += nxt_pitchUV;
-				nxtpU += nxt_pitchUV;
-				nxtpnU += nxt_pitchUV;
-				nxt2ppV += nxt2_pitchUV;
-				nxt2pV += nxt2_pitchUV;
-				nxt2pnV += nxt2_pitchUV;
-				nxt2ppU += nxt2_pitchUV;
-				nxt2pU += nxt2_pitchUV;
-				nxt2pnU += nxt2_pitchUV;
-				maskwV += mask_pitchUV;
-				maskwU += mask_pitchUV;
-			}
-		}
-	}
-}
-
-void vidTDeint::linkFULL_YV12(ADMImage *mask) 
-{
-	unsigned char *maskpY = mask-&gt;GetWritePtr(PLANAR_Y);
-	unsigned char *maskpV = mask-&gt;GetWritePtr(PLANAR_V);
-	unsigned char *maskpU = mask-&gt;GetWritePtr(PLANAR_U);
-	int mask_pitchY = mask-&gt;GetPitch(PLANAR_Y);
-	int mask_pitchY2 = mask_pitchY&lt;&lt;1;
-	int mask_pitchY4 = mask_pitchY&lt;&lt;2;
-	int mask_pitchUV = mask-&gt;GetPitch(PLANAR_V);
-	int mask_pitchUV2 = mask_pitchUV&lt;&lt;1;
-	int HeightUV = mask-&gt;GetHeight(PLANAR_V);
-	int WidthUV = mask-&gt;GetRowSize(PLANAR_V);
-	maskpY += mask_pitchY*PRM(field);
-	maskpV += mask_pitchUV*PRM(field);
-	maskpU += mask_pitchUV*PRM(field);
-	unsigned char *maskpnY = maskpY + mask_pitchY2;
-	int x, y;
-	for (y=PRM(field); y&lt;HeightUV; y+=2)
-	{
-		for (x=0; x&lt;WidthUV; ++x)
-		{
-			if (((((unsigned short*)maskpY)[x] == (unsigned short)0x3C3C) &amp;&amp; 
-				 (((unsigned short*)maskpnY)[x] == (unsigned short)0x3C3C)) ||
-				maskpV[x] == 0x3C || maskpU[x] == 0x3C)
-			{
-				((unsigned short*)maskpY)[x] = (unsigned short) 0x3C3C;
-				((unsigned short*)maskpnY)[x] = (unsigned short) 0x3C3C;
-				maskpV[x] = maskpU[x] = 0x3C;
-			}
-		}
-		maskpY += mask_pitchY4;
-		maskpnY += mask_pitchY4;
-		maskpV += mask_pitchUV2;
-		maskpU += mask_pitchUV2;
-	}
-}
-
-void vidTDeint::linkYtoUV_YV12(ADMImage *mask) 
-{
-	unsigned char *maskpY = mask-&gt;GetWritePtr(PLANAR_Y);
-	unsigned char *maskpV = mask-&gt;GetWritePtr(PLANAR_V);
-	unsigned char *maskpU = mask-&gt;GetWritePtr(PLANAR_U);
-	int mask_pitchY = mask-&gt;GetPitch(PLANAR_Y);
-	int mask_pitchY2 = mask_pitchY&lt;&lt;1;
-	int mask_pitchY4 = mask_pitchY&lt;&lt;2;
-	int mask_pitchUV = mask-&gt;GetPitch(PLANAR_V);
-	int mask_pitchUV2 = mask_pitchUV&lt;&lt;1;
-	int HeightUV = mask-&gt;GetHeight(PLANAR_V);
-	int WidthUV = mask-&gt;GetRowSize(PLANAR_V);
-	maskpY += mask_pitchY*PRM(field);
-	maskpV += mask_pitchUV*PRM(field);
-	maskpU += mask_pitchUV*PRM(field);
-	unsigned char *maskpnY = maskpY + mask_pitchY2;
-	int x, y;
-	for (y=PRM(field); y&lt;HeightUV; y+=2)
-	{
-		for (x=0; x&lt;WidthUV; ++x)
-		{
-			if (((unsigned short*)maskpY)[x] == (unsigned short)0x3C3C &amp;&amp; 
-				((unsigned short*)maskpnY)[x] == (unsigned short)0x3C3C)
-			{
-				maskpV[x] = maskpU[x] = 0x3C;
-			}
-		}
-		maskpY += mask_pitchY4;
-		maskpnY += mask_pitchY4;
-		maskpV += mask_pitchUV2;
-		maskpU += mask_pitchUV2;
-	}
-}
-
-void vidTDeint::linkUVtoY_YV12(ADMImage *mask) 
-{
-	unsigned char *maskpY = mask-&gt;GetWritePtr(PLANAR_Y);
-	unsigned char *maskpV = mask-&gt;GetWritePtr(PLANAR_V);
-	unsigned char *maskpU = mask-&gt;GetWritePtr(PLANAR_U);
-	int mask_pitchY = mask-&gt;GetPitch(PLANAR_Y);
-	int mask_pitchY2 = mask_pitchY&lt;&lt;1;
-	int mask_pitchY4 = mask_pitchY&lt;&lt;2;
-	int mask_pitchUV = mask-&gt;GetPitch(PLANAR_V);
-	int mask_pitchUV2 = mask_pitchUV&lt;&lt;1;
-	int HeightUV = mask-&gt;GetHeight(PLANAR_V);
-	int WidthUV = mask-&gt;GetRowSize(PLANAR_V);
-	maskpY += mask_pitchY*PRM(field);
-	maskpV += mask_pitchUV*PRM(field);
-	maskpU += mask_pitchUV*PRM(field);
-	unsigned char *maskpnY = maskpY + mask_pitchY2;
-	int x, y;
-	for (y=PRM(field); y&lt;HeightUV; y+=2)
-	{
-		for (x=0; x&lt;WidthUV; ++x)
-		{
-			if (maskpV[x] == 0x3C || maskpU[x] == 0x3C)
-			{
-				((unsigned short*)maskpY)[x] = (unsigned short) 0x3C3C;
-				((unsigned short*)maskpnY)[x] = (unsigned short) 0x3C3C;
-			}
-		}
-		maskpY += mask_pitchY4;
-		maskpnY += mask_pitchY4;
-		maskpV += mask_pitchUV2;
-		maskpU += mask_pitchUV2;
-	}
-}
-
-void vidTDeint::denoiseYV12(ADMImage *mask) 
-{
-	unsigned char *maskpY = mask-&gt;GetWritePtr(PLANAR_Y);
-	unsigned char *maskpV = mask-&gt;GetWritePtr(PLANAR_V);
-	unsigned char *maskpU = mask-&gt;GetWritePtr(PLANAR_U);
-	int mask_pitchY = mask-&gt;GetPitch(PLANAR_Y);
-	int mask_pitchY2 = mask_pitchY&lt;&lt;1;
-	int mask_pitchUV = mask-&gt;GetPitch(PLANAR_V);
-	int mask_pitchUV2 = mask_pitchUV&lt;&lt;1;
-	int HeightY = mask-&gt;GetHeight(PLANAR_Y);
-	int HeightUV = mask-&gt;GetHeight(PLANAR_V);
-	int WidthY = mask-&gt;GetRowSize(PLANAR_Y);
-	int WidthUV = mask-&gt;GetRowSize(PLANAR_V);
-	maskpY += mask_pitchY*(2+PRM(field));
-	maskpV += mask_pitchUV*(2+PRM(field));
-	maskpU += mask_pitchUV*(2+PRM(field));
-	unsigned char *maskppY = maskpY - mask_pitchY2;
-	unsigned char *maskppV = maskpV - mask_pitchUV2;
-	unsigned char *maskppU = maskpU - mask_pitchUV2;
-	unsigned char *maskpnY = maskpY + mask_pitchY2;
-	unsigned char *maskpnV = maskpV + mask_pitchUV2;
-	unsigned char *maskpnU = maskpU + mask_pitchUV2;
-	int sum, xhi, v, x, y;
-	for (y=2; y&lt;HeightY-2; y+=2)
-	{
-		for (x=1; x&lt;WidthY-1; ++x)
-		{
-			if (maskpY[x] == 0x3C)
-			{
-				for (sum=0,v=x-1,xhi=x+2; v&lt;xhi &amp;&amp; sum&lt;2; ++v)
-				{
-					if (maskppY[v] == 0x3C) ++sum;
-					if (maskpY[v] == 0x3C) ++sum;
-					if (maskpnY[v] == 0x3C) ++sum;
-				}
-				if (sum &lt; 2) maskpY[x] = (maskpY[x-1] == maskpY[x+1]) ? maskpY[x-1] :
-								(maskppY[x] == maskpnY[x]) ? maskppY[x] : maskpY[x-1];
-			}
-		}
-		maskppY += mask_pitchY2;
-		maskpY += mask_pitchY2;
-		maskpnY += mask_pitchY2;
-	}
-	for (y=2; y&lt;HeightUV-2; y+=2)
-	{
-		for (x=1; x&lt;WidthUV-1; ++x)
-		{
-			if (maskpV[x] == 0x3C)
-			{
-				for (sum=0,v=x-1,xhi=x+2; v&lt;xhi &amp;&amp; sum&lt;2; ++v)
-				{
-					if (maskppV[v] == 0x3C) ++sum;
-					if (maskpV[v] == 0x3C) ++sum;
-					if (maskpnV[v] == 0x3C) ++sum;
-				}
-				if (sum &lt; 2) maskpV[x] = (maskpV[x-1] == maskpV[x+1]) ? maskpV[x-1] :
-								(maskppV[x] == maskpnV[x]) ? maskppV[x] : maskpV[x-1];
-			}
-			if (maskpU[x] == 0x3C)
-			{
-				for (sum=0,v=x-1,xhi=x+2; v&lt;xhi &amp;&amp; sum&lt;2; ++v)
-				{
-					if (maskppU[v] == 0x3C) ++sum;
-					if (maskpU[v] == 0x3C) ++sum;
-					if (maskpnU[v] == 0x3C) ++sum;
-				}
-				if (sum &lt; 2) maskpU[x] = (maskpU[x-1] == maskpU[x+1]) ? maskpU[x-1] :
-								(maskppU[x] == maskpnU[x]) ? maskppU[x] : maskpU[x-1];
-			}
-		}
-		maskppV += mask_pitchUV2;
-		maskpV += mask_pitchUV2;
-		maskpnV += mask_pitchUV2;
-		maskppU += mask_pitchUV2;
-		maskpU += mask_pitchUV2;
-		maskpnU += mask_pitchUV2;
-	}
-}
-
-bool vidTDeint::checkCombedYV12(ADMImage *src) 
-{
-	ADMImage *cmask = scratch;
-	const unsigned char *srcp, *srcpp, *srcppp, *srcpn, *srcpnn;
-	unsigned char *cmkp, *cmkpp, *cmkpn, *cmkpV, *cmkpU;
-	unsigned char *cmkpnn, *cmkppV, *cmkppU, *cmkpnV, *cmkpnU;
-	int cmk_pitch, src_pitch, Width, Height,  box1, box2;
-	ADM_PLANE plane;
-	int xblocks, yblocks, xblocks4, arraysize, cmk_pitchUV;
-	int x, y, b, sFirst, sSecond, temp1, temp2;
-	for (b=chroma ? 3 : 1; b&gt;0; --b)
-	{
-		if (b == 3) plane = PLANAR_U;
-		else if (b == 2) plane = PLANAR_V;
-		else plane = PLANAR_Y;
-		srcp = src-&gt;GetReadPtr(plane);
-		src_pitch = src-&gt;GetPitch(plane);
-		Width = src-&gt;GetRowSize(plane);
-		Height = src-&gt;GetHeight(plane);
-		srcpp = srcp - src_pitch;
-		srcppp = srcpp - src_pitch;
-		srcpn = srcp + src_pitch;
-		srcpnn = srcpn + src_pitch;
-		cmkp = cmask-&gt;GetWritePtr(plane);
-		cmk_pitch = cmask-&gt;GetPitch(plane);
-		memset(cmkp,0,Height*cmk_pitch);
-		for (x=0; x&lt;Width; ++x)
-		{
-			sFirst = srcp[x] - srcpn[x];
-			if (sFirst &gt; cthresh || sFirst &lt; -cthresh)
-			{
-				sFirst = abs(srcpnn[x]+(srcp[x]&lt;&lt;2)+srcpnn[x]-(3*(srcpn[x]+srcpn[x])));
-				if (sFirst &gt; cthresh6) cmkp[x] = 0x3C;
-			}
-		}
-		srcppp += src_pitch;
-		srcpp += src_pitch;
-		srcp += src_pitch;
-		srcpn += src_pitch;
-		srcpnn += src_pitch;
-		cmkp += cmk_pitch;
-		for (x=0; x&lt;Width; ++x)
-		{
-			sFirst = srcp[x] - srcpp[x];
-			sSecond = srcp[x] - srcpn[x];
-			if ((sFirst &gt; cthresh &amp;&amp; sSecond &gt; cthresh) || (sFirst &lt; -cthresh &amp;&amp; sSecond &lt; -cthresh))
-			{
-				sFirst = abs(srcpnn[x]+(srcp[x]&lt;&lt;2)+srcpnn[x]-(3*(srcpp[x]+srcpn[x])));
-				if (sFirst &gt; cthresh6) cmkp[x] = 0x3C;
-			}
-		}
-		srcppp += src_pitch;
-		srcpp += src_pitch;
-		srcp += src_pitch;
-		srcpn += src_pitch;
-		srcpnn += src_pitch;
-		cmkp += cmk_pitch;
-		for (y=2; y&lt;Height-2; ++y)
-		{
-			for (x=0; x&lt;Width; ++x)
-			{
-				sFirst = srcp[x] - srcpp[x];
-				sSecond = srcp[x] - srcpn[x];
-				if ((sFirst &gt; cthresh &amp;&amp; sSecond &gt; cthresh) || (sFirst &lt; -cthresh &amp;&amp; sSecond &lt; -cthresh))
-				{
-					sFirst = abs(srcppp[x]+(srcp[x]&lt;&lt;2)+srcpnn[x]-(3*(srcpp[x]+srcpn[x])));
-					if (sFirst &gt; cthresh6) cmkp[x] = 0x3C;
-				}	
-			}
-			srcppp += src_pitch;
-			srcpp += src_pitch;
-			srcp += src_pitch;
-			srcpn += src_pitch;
-			srcpnn += src_pitch;
-			cmkp += cmk_pitch;
-		}
-		for (x=0; x&lt;Width; ++x)
-		{
-			sFirst = srcp[x] - srcpp[x];
-			sSecond = srcp[x] - srcpn[x];
-			if ((sFirst &gt; cthresh &amp;&amp; sSecond &gt; cthresh) || (sFirst &lt; -cthresh &amp;&amp; sSecond &lt; -cthresh))
-			{
-				sFirst = abs(srcppp[x]+(srcp[x]&lt;&lt;2)+srcppp[x]-(3*(srcpp[x]+srcpn[x])));
-				if (sFirst &gt; cthresh6) cmkp[x] = 0x3C;
-			}
-		}
-		srcppp += src_pitch;
-		srcpp += src_pitch;
-		srcp += src_pitch;
-		srcpn += src_pitch;
-		srcpnn += src_pitch;
-		cmkp += cmk_pitch;
-		for (x=0; x&lt;Width; ++x)
-		{
-			sFirst = srcp[x] - srcpp[x];
-			if (sFirst &gt; cthresh || sFirst &lt; -cthresh)
-			{
-				sFirst = abs(srcppp[x]+(srcp[x]&lt;&lt;2)+srcppp[x]-(3*(srcpp[x]+srcpp[x])));
-				if (sFirst &gt; cthresh6) cmkp[x] = 0x3C;
-			}
-		}
-	}
-	if (chroma) 
-	{
-		cmkp = cmask-&gt;GetWritePtr(PLANAR_Y);
-		cmkpU = cmask-&gt;GetWritePtr(PLANAR_U);
-		cmkpV = cmask-&gt;GetWritePtr(PLANAR_V);
-		Width = cmask-&gt;GetRowSize(PLANAR_V);
-		Height = cmask-&gt;GetHeight(PLANAR_V);
-		cmk_pitch = cmask-&gt;GetPitch(PLANAR_Y);
-		cmk_pitchUV = cmask-&gt;GetPitch(PLANAR_V);
-		cmkpp = cmkp - cmk_pitch;
-		cmkpn = cmkp + cmk_pitch;
-		cmkpnn = cmkpn + cmk_pitch;
-		cmkppU = cmkpU - cmk_pitchUV;
-		cmkpnU = cmkpU + cmk_pitchUV;
-		cmkppV = cmkpV - cmk_pitchUV;
-		cmkpnV = cmkpV + cmk_pitchUV;
-		cmk_pitch &lt;&lt;= 1;
-		for (y=1; y&lt;Height-1; ++y)
-		{
-			cmkpp += cmk_pitch;
-			cmkp += cmk_pitch;
-			cmkpn += cmk_pitch;
-			cmkpnn += cmk_pitch;
-			cmkppV += cmk_pitchUV;
-			cmkpV += cmk_pitchUV;
-			cmkpnV += cmk_pitchUV;
-			cmkppU += cmk_pitchUV;
-			cmkpU += cmk_pitchUV;
-			cmkpnU += cmk_pitchUV;
-			for (x=1; x&lt;Width-1; ++x)
-			{
-				if ((cmkpV[x] == 0x3C &amp;&amp; (cmkpV[x-1] == 0x3C || cmkpV[x+1] == 0x3C ||
-					 cmkppV[x-1] == 0x3C || cmkppV[x] == 0x3C || cmkppV[x+1] == 0x3C ||
-					 cmkpnV[x-1] == 0x3C || cmkpnV[x] == 0x3C || cmkpnV[x+1] == 0x3C)) || 
-					(cmkpU[x] == 0x3C &amp;&amp; (cmkpU[x-1] == 0x3C || cmkpU[x+1] == 0x3C ||
-					 cmkppU[x-1] == 0x3C || cmkppU[x] == 0x3C || cmkppU[x+1] == 0x3C ||
-					 cmkpnU[x-1] == 0x3C || cmkpnU[x] == 0x3C || cmkpnU[x+1] == 0x3C)))
-				{
-					((unsigned short*)cmkp)[x] = (unsigned short) 0x3C3C;
-					((unsigned short*)cmkpn)[x] = (unsigned short) 0x3C3C;
-					if (y&amp;1) ((unsigned short*)cmkpp)[x] = (unsigned short) 0x3C3C;
-					else ((unsigned short*)cmkpnn)[x] = (unsigned short) 0x3C3C;
-				}
-			}
-		}
-	}
-	cmk_pitch = cmask-&gt;GetPitch(PLANAR_Y);
-	cmkp = cmask-&gt;GetWritePtr(PLANAR_Y) + cmk_pitch;
-	cmkpp = cmkp - cmk_pitch;
-	cmkpn = cmkp + cmk_pitch;
-	Width = cmask-&gt;GetRowSize(PLANAR_Y);
-	Height = cmask-&gt;GetHeight(PLANAR_Y);
-	xblocks = ((Width+xhalf)&gt;&gt;xshift) + 1;
-	xblocks4 = xblocks&lt;&lt;2;
-	yblocks = ((Height+yhalf)&gt;&gt;yshift) + 1;
-	arraysize = (xblocks*yblocks)&lt;&lt;2;
-	memset(cArray,0,arraysize*sizeof(int));
-	for (y=1; y&lt;Height-1; ++y)
-	{
-		temp1 = (y&gt;&gt;yshift)*xblocks4;
-		temp2 = ((y+yhalf)&gt;&gt;yshift)*xblocks4;
-		for (x=0; x&lt;Width; ++x)
-		{
-			if (cmkpp[x] == 0x3C &amp;&amp; cmkp[x] == 0x3C &amp;&amp; cmkpn[x] == 0x3C)
-			{
-				box1 = (x&gt;&gt;xshift)&lt;&lt;2;
-				box2 = ((x+xhalf)&gt;&gt;xshift)&lt;&lt;2;
-				++cArray[temp1+box1+0];
-				++cArray[temp1+box2+1];
-				++cArray[temp2+box1+2];
-				++cArray[temp2+box2+3];
-			}
-		}
-		cmkpp += cmk_pitch;
-		cmkp += cmk_pitch;
-		cmkpn += cmk_pitch;
-	}
-	for (x=0; x&lt;arraysize; ++x)
-	{
-		if (cArray[x] &gt; MI) return true;
-	}
-	return false;
-}
-
-void vidTDeint::subtractFieldsYV12(ADMImage *prv, ADMImage *src, ADMImage *nxt) 
-{
-	const unsigned char *prvpY = prv-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *prvpV = prv-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *prvpU = prv-&gt;GetReadPtr(PLANAR_U);
-	int prv_pitchY = prv-&gt;GetPitch(PLANAR_Y);
-	int prv_pitchUV = prv-&gt;GetPitch(PLANAR_V);
-	const unsigned char *srcpY = src-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *srcpV = src-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *srcpU = src-&gt;GetReadPtr(PLANAR_U);
-	int src_pitchY = src-&gt;GetPitch(PLANAR_Y);
-	int src_pitchUV = src-&gt;GetPitch(PLANAR_V);
-	int WidthY = src-&gt;GetRowSize(PLANAR_Y)-8;
-	int HeightY = src-&gt;GetHeight(PLANAR_Y);
-	int WidthUV = src-&gt;GetRowSize(PLANAR_V)-4;
-	int HeightUV = src-&gt;GetHeight(PLANAR_V);
-	const unsigned char *nxtpY = nxt-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *nxtpV = nxt-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *nxtpU = nxt-&gt;GetReadPtr(PLANAR_U);
-	const unsigned char *prvpfY, *prvnfY, *nxtpfY, *nxtnfY;
-	const unsigned char *prvpfU, *prvnfU, *nxtpfU, *nxtnfU;
-	const unsigned char *prvpfV, *prvnfV, *nxtpfV, *nxtnfV;
-	const unsigned char *curpfY, *curfY, *curnfY;
-	const unsigned char *curpfU, *curfU, *curnfU;
-	const unsigned char *curpfV, *curfV, *curnfV;
-	int nxt_pitchY = nxt-&gt;GetPitch(PLANAR_Y);
-	int nxt_pitchUV = nxt-&gt;GetPitch(PLANAR_V);
-	int prvf_pitchY, prvf_pitchUV;
-	int curf_pitchY, curf_pitchUV;
-	int nxtf_pitchY, nxtf_pitchUV;
-	int x, y, temp, temp2;
-	accumP = accumN = 0;
-	if (PRM(field)^PRM(order))
-	{
-		prvf_pitchY = src_pitchY&lt;&lt;1;
-		prvf_pitchUV = src_pitchUV&lt;&lt;1;
-		curf_pitchY = src_pitchY&lt;&lt;1;
-		curf_pitchUV = src_pitchUV&lt;&lt;1;
-		nxtf_pitchY = nxt_pitchY&lt;&lt;1;
-		nxtf_pitchUV = nxt_pitchUV&lt;&lt;1;
-		prvpfY = srcpY + ((PRM(field) == 1 ? 1 : 2)*src_pitchY);
-		prvpfU = srcpU + ((PRM(field) == 1 ? 1 : 2)*src_pitchUV);
-		prvpfV = srcpV + ((PRM(field) == 1 ? 1 : 2)*src_pitchUV);
-		curfY = srcpY + ((3-PRM(field))*src_pitchY);
-		curfU = srcpU + ((3-PRM(field))*src_pitchUV);
-		curfV = srcpV + ((3-PRM(field))*src_pitchUV);
-		nxtpfY = nxtpY + ((PRM(field) == 1 ? 1 : 2)*nxt_pitchY);
-		nxtpfU = nxtpU + ((PRM(field) == 1 ? 1 : 2)*nxt_pitchUV);
-		nxtpfV = nxtpV + ((PRM(field) == 1 ? 1 : 2)*nxt_pitchUV);
-	}
-	else
-	{
-		prvf_pitchY = prv_pitchY&lt;&lt;1;
-		prvf_pitchUV = prv_pitchUV&lt;&lt;1;
-		curf_pitchY = src_pitchY&lt;&lt;1;
-		curf_pitchUV = src_pitchUV&lt;&lt;1;
-		nxtf_pitchY = src_pitchY&lt;&lt;1;
-		nxtf_pitchUV = src_pitchUV&lt;&lt;1;
-		prvpfY = prvpY + ((PRM(field) == 1 ? 1 : 2)*prv_pitchY);
-		prvpfU = prvpU + ((PRM(field) == 1 ? 1 : 2)*prv_pitchUV);
-		prvpfV = prvpV + ((PRM(field) == 1 ? 1 : 2)*prv_pitchUV);
-		curfY = srcpY + ((3-PRM(field))*src_pitchY);
-		curfU = srcpU + ((3-PRM(field))*src_pitchUV);
-		curfV = srcpV + ((3-PRM(field))*src_pitchUV);
-		nxtpfY = srcpY + ((PRM(field) == 1 ? 1 : 2)*src_pitchY);
-		nxtpfU = srcpU + ((PRM(field) == 1 ? 1 : 2)*src_pitchUV);
-		nxtpfV = srcpV + ((PRM(field) == 1 ? 1 : 2)*src_pitchUV);
-	}
-	prvnfY = prvpfY + prvf_pitchY;
-	prvnfU = prvpfU + prvf_pitchUV;
-	prvnfV = prvpfV + prvf_pitchUV;
-	curpfY = curfY - curf_pitchY;
-	curpfU = curfU - curf_pitchUV;
-	curpfV = curfV - curf_pitchUV;
-	curnfY = curfY + curf_pitchY;
-	curnfU = curfU + curf_pitchUV;
-	curnfV = curfV + curf_pitchUV;
-	nxtnfY = nxtpfY + nxtf_pitchY;
-	nxtnfU = nxtpfU + nxtf_pitchUV;
-	nxtnfV = nxtpfV + nxtf_pitchUV;
-	for (y=2; y&lt;HeightY-2; y+=2)
-	{
-		for (x=8; x&lt;WidthY; ++x)
-		{
-			if (abs(prvpfY[x]-nxtpfY[x]) &gt; 3 || abs(prvnfY[x]-nxtnfY[x]) &gt; 3)
-			{
-				temp = (curpfY[x]+(curfY[x]&lt;&lt;2)+curnfY[x]);
-				temp2 = abs(3*(prvpfY[x]+prvnfY[x])-temp);
-				if (temp2 &gt; 23) accumP += temp2;
-				temp2 = abs(3*(nxtpfY[x]+nxtnfY[x])-temp);
-				if (temp2 &gt; 23) accumN += temp2;
-			}
-		}
-		prvpfY += prvf_pitchY;
-		prvnfY += prvf_pitchY;
-		curpfY += curf_pitchY;
-		curfY += curf_pitchY;
-		curnfY += curf_pitchY;
-		nxtpfY += nxtf_pitchY;
-		nxtnfY += nxtf_pitchY;
-	}
-	for (y=2; y&lt;HeightUV-2; y+=2)
-	{
-		for (x=4; x&lt;WidthUV; ++x)
-		{
-			if (abs(prvpfU[x]-nxtpfU[x]) &gt; 3 || abs(prvnfU[x]-nxtnfU[x]) &gt; 3)
-			{
-				temp = (curpfU[x]+(curfU[x]&lt;&lt;2)+curnfU[x]);
-				temp2 = abs(3*(prvpfU[x]+prvnfU[x])-temp);
-				if (temp2 &gt; 23) accumP += temp2;
-				temp2 = abs(3*(nxtpfU[x]+nxtnfU[x])-temp);
-				if (temp2 &gt; 23) accumN += temp2;
-			}
-			if (abs(prvpfV[x]-nxtpfV[x]) &gt; 3 || abs(prvnfV[x]-nxtnfV[x]) &gt; 3)
-			{
-				temp = (curpfV[x]+(curfV[x]&lt;&lt;2)+curnfV[x]);
-				temp2 = abs(3*(prvpfV[x]+prvnfV[x])-temp);
-				if (temp2 &gt; 23) accumP += temp2;
-				temp2 = abs(3*(nxtpfV[x]+nxtnfV[x])-temp);
-				if (temp2 &gt; 23) accumN += temp2;
-			}
-		}
-		prvpfU += prvf_pitchUV;
-		prvnfU += prvf_pitchUV;
-		prvpfV += prvf_pitchUV;
-		prvnfV += prvf_pitchUV;
-		curpfU += curf_pitchUV;
-		curfU += curf_pitchUV;
-		curnfU += curf_pitchUV;
-		curpfV += curf_pitchUV;
-		curfV += curf_pitchUV;
-		curnfV += curf_pitchUV;
-		nxtpfU += nxtf_pitchUV;
-		nxtnfU += nxtf_pitchUV;
-		nxtpfV += nxtf_pitchUV;
-		nxtnfV += nxtf_pitchUV;
-	}
-}
-
-void vidTDeint::mapColorsYV12(ADMImage *dst, ADMImage *mask)
-{
-	const unsigned char *maskpY = mask-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *maskpV = mask-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *maskpU = mask-&gt;GetReadPtr(PLANAR_U);
-	int mask_pitchY = mask-&gt;GetPitch(PLANAR_Y);
-	int mask_pitchUV = mask-&gt;GetPitch(PLANAR_V);
-	int HeightY = mask-&gt;GetHeight(PLANAR_Y);
-	int HeightUV = mask-&gt;GetHeight(PLANAR_V);
-	int WidthY = mask-&gt;GetRowSize(PLANAR_Y);
-	int WidthUV = mask-&gt;GetRowSize(PLANAR_V);
-	unsigned char *dstpY = dst-&gt;GetWritePtr(PLANAR_Y);
-	unsigned char *dstpV = dst-&gt;GetWritePtr(PLANAR_V);
-	unsigned char *dstpU = dst-&gt;GetWritePtr(PLANAR_U);
-	int dst_pitchY = dst-&gt;GetPitch(PLANAR_Y);
-	int dst_pitchUV = dst-&gt;GetPitch(PLANAR_V);
-	int x, y;
-	for (y=0; y&lt;HeightY; ++y)
-	{
-		for (x=0; x&lt;WidthY; ++x)
-		{
-			if (maskpY[x] == 10 || maskpY[x] == 110) dstpY[x] = 0;
-			else if (maskpY[x] == 20 || maskpY[x] == 120) dstpY[x] = 51;
-			else if (maskpY[x] == 30 || maskpY[x] == 130) dstpY[x] = 102;
-			else if (maskpY[x] == 40) dstpY[x] = 153;
-			else if (maskpY[x] == 50) dstpY[x] = 204;
-			else if (maskpY[x] == 60) dstpY[x] = 255;
-		}
-		maskpY += mask_pitchY;
-		dstpY += dst_pitchY;
-	}
-	for (y=0; y&lt;HeightUV; ++y)
-	{
-		for (x=0; x&lt;WidthUV; ++x)
-		{
-			if (maskpV[x] == 10 || maskpV[x] == 110) dstpV[x] = 0;
-			else if (maskpV[x] == 20 || maskpV[x] == 120) dstpV[x] = 51;
-			else if (maskpV[x] == 30 || maskpV[x] == 130) dstpV[x] = 102;
-			else if (maskpV[x] == 40) dstpV[x] = 153;
-			else if (maskpV[x] == 50) dstpV[x] = 204;
-			else if (maskpV[x] == 60) dstpV[x] = 255;
-			if (maskpU[x] == 10 || maskpU[x] == 110) dstpU[x] = 0;
-			else if (maskpU[x] == 20 || maskpU[x] == 120) dstpU[x] = 51;
-			else if (maskpU[x] == 30 || maskpU[x] == 130) dstpU[x] = 102;
-			else if (maskpU[x] == 40) dstpU[x] = 153;
-			else if (maskpU[x] == 50) dstpU[x] = 204;
-			else if (maskpU[x] == 60) dstpU[x] = 255;
-		}
-		maskpV += mask_pitchUV;
-		maskpU += mask_pitchUV;
-		dstpV += dst_pitchUV;
-		dstpU += dst_pitchUV;
-	}
-}
-
-void vidTDeint::mapMergeYV12(ADMImage *dst, ADMImage *mask, 
-		ADMImage *prv, ADMImage *src, ADMImage *nxt)
-{
-	const unsigned char *maskpY = mask-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *maskpV = mask-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *maskpU = mask-&gt;GetReadPtr(PLANAR_U);
-	int mask_pitchY = mask-&gt;GetPitch(PLANAR_Y);
-	int mask_pitchUV = mask-&gt;GetPitch(PLANAR_V);
-	int HeightY = mask-&gt;GetHeight(PLANAR_Y);
-	int HeightUV = mask-&gt;GetHeight(PLANAR_V);
-	int WidthY = mask-&gt;GetRowSize(PLANAR_Y);
-	int WidthUV = mask-&gt;GetRowSize(PLANAR_V);
-	unsigned char *dstpY = dst-&gt;GetWritePtr(PLANAR_Y);
-	unsigned char *dstpV = dst-&gt;GetWritePtr(PLANAR_V);
-	unsigned char *dstpU = dst-&gt;GetWritePtr(PLANAR_U);
-	int dst_pitchY = dst-&gt;GetPitch(PLANAR_Y);
-	int dst_pitchUV = dst-&gt;GetPitch(PLANAR_V);
-	const unsigned char *prvpY = prv-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *prvpV = prv-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *prvpU = prv-&gt;GetReadPtr(PLANAR_U);
-	int prv_pitchY = prv-&gt;GetPitch(PLANAR_Y);
-	int prv_pitchUV = prv-&gt;GetPitch(PLANAR_V);
-	const unsigned char *srcpY = src-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *srcpV = src-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *srcpU = src-&gt;GetReadPtr(PLANAR_U);
-	int src_pitchY = src-&gt;GetPitch(PLANAR_Y);
-	int src_pitchUV = src-&gt;GetPitch(PLANAR_V);
-	const unsigned char *nxtpY = nxt-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *nxtpV = nxt-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *nxtpU = nxt-&gt;GetReadPtr(PLANAR_U);
-	int nxt_pitchY = nxt-&gt;GetPitch(PLANAR_Y);
-	int nxt_pitchUV = nxt-&gt;GetPitch(PLANAR_V);
-	int x, y;
-	for (y=0; y&lt;HeightY; ++y)
-	{
-		for (x=0; x&lt;WidthY; ++x)
-		{
-			if (maskpY[x] == 10 || maskpY[x] == 110) dstpY[x] = srcpY[x];
-			else if (maskpY[x] == 20 || maskpY[x] == 120) dstpY[x] = prvpY[x];
-			else if (maskpY[x] == 30 || maskpY[x] == 130) dstpY[x] = nxtpY[x];
-			else if (maskpY[x] == 40) dstpY[x] = (srcpY[x]+nxtpY[x]+1)&gt;&gt;1;
-			else if (maskpY[x] == 50) dstpY[x] = (srcpY[x]+prvpY[x]+1)&gt;&gt;1;
-			else if (maskpY[x] == 60) dstpY[x] = 255;
-		}
-		prvpY += prv_pitchY;
-		srcpY += src_pitchY;
-		nxtpY += nxt_pitchY;
-		maskpY += mask_pitchY;
-		dstpY += dst_pitchY;
-	}
-	for (y=0; y&lt;HeightUV; ++y)
-	{
-		for (x=0; x&lt;WidthUV; ++x)
-		{
-			if (maskpV[x] == 10 || maskpV[x] == 110) dstpV[x] = srcpV[x];
-			else if (maskpV[x] == 20 || maskpV[x] == 120) dstpV[x] = prvpV[x];
-			else if (maskpV[x] == 30 || maskpV[x] == 130) dstpV[x] = nxtpV[x];
-			else if (maskpV[x] == 40) dstpV[x] = (srcpV[x]+nxtpV[x]+1)&gt;&gt;1;
-			else if (maskpV[x] == 50) dstpV[x] = (srcpV[x]+prvpV[x]+1)&gt;&gt;1;
-			else if (maskpV[x] == 60) dstpV[x] = 255;
-			if (maskpU[x] == 10 || maskpU[x] == 110) dstpU[x] = srcpU[x];
-			else if (maskpU[x] == 20 || maskpU[x] == 120) dstpU[x] = prvpU[x];
-			else if (maskpU[x] == 30 || maskpU[x] == 130) dstpU[x] = nxtpU[x];
-			else if (maskpU[x] == 40) dstpU[x] = (srcpU[x]+nxtpU[x]+1)&gt;&gt;1;
-			else if (maskpU[x] == 50) dstpU[x] = (srcpU[x]+prvpU[x]+1)&gt;&gt;1;
-			else if (maskpU[x] == 60) dstpU[x] = 255;
-		}
-		prvpV += prv_pitchUV;
-		prvpU += prv_pitchUV;
-		srcpV += src_pitchUV;
-		srcpU += src_pitchUV;
-		nxtpV += nxt_pitchUV;
-		nxtpU += nxt_pitchUV;
-		maskpV += mask_pitchUV;
-		maskpU += mask_pitchUV;
-		dstpV += dst_pitchUV;
-		dstpU += dst_pitchUV;
-	}
-}
-
-void vidTDeint::cubicDeintYV12(ADMImage *dst, ADMImage *mask, 
-		ADMImage *prv, ADMImage *src, ADMImage *nxt)
-{
-	const unsigned char *prvpY = prv-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *prvpV = prv-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *prvpU = prv-&gt;GetReadPtr(PLANAR_U);
-	int prv_pitchY = prv-&gt;GetPitch(PLANAR_Y);
-	int prv_pitchUV = prv-&gt;GetPitch(PLANAR_V);
-	const unsigned char *srcpY = src-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *srcpV = src-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *srcpU = src-&gt;GetReadPtr(PLANAR_U);
-	int src_pitchY = src-&gt;GetPitch(PLANAR_Y);
-	int src_pitchY2 = src_pitchY&lt;&lt;1;
-	int src_pitchUV = src-&gt;GetPitch(PLANAR_V);
-	int src_pitchUV2 = src_pitchUV&lt;&lt;1;
-	int WidthY = src-&gt;GetRowSize(PLANAR_Y);
-	int WidthUV = src-&gt;GetRowSize(PLANAR_V);
-	int HeightY = src-&gt;GetHeight(PLANAR_Y);
-	int HeightUV = src-&gt;GetHeight(PLANAR_V);
-	const unsigned char *nxtpY = nxt-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *nxtpV = nxt-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *nxtpU = nxt-&gt;GetReadPtr(PLANAR_U);
-	int nxt_pitchY = nxt-&gt;GetPitch(PLANAR_Y);
-	int nxt_pitchUV = nxt-&gt;GetPitch(PLANAR_V);
-	unsigned char *dstpY = dst-&gt;GetWritePtr(PLANAR_Y);
-	unsigned char *dstpV = dst-&gt;GetWritePtr(PLANAR_V);
-	unsigned char *dstpU = dst-&gt;GetWritePtr(PLANAR_U);
-	int dst_pitchY = dst-&gt;GetPitch(PLANAR_Y);
-	int dst_pitchUV = dst-&gt;GetPitch(PLANAR_V);
-	const unsigned char *maskpY = mask-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *maskpV = mask-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *maskpU = mask-&gt;GetReadPtr(PLANAR_U);
-	int mask_pitchY = mask-&gt;GetPitch(PLANAR_Y);
-	int mask_pitchUV = mask-&gt;GetPitch(PLANAR_V);
-	const unsigned char *srcppY = srcpY - src_pitchY;
-	const unsigned char *srcpppY = srcppY - src_pitchY2;
-	const unsigned char *srcpnY = srcpY + src_pitchY;
-	const unsigned char *srcpnnY = srcpnY + src_pitchY2;
-	const unsigned char *srcppV = srcpV - src_pitchUV;
-	const unsigned char *srcpppV = srcppV - src_pitchUV2;
-	const unsigned char *srcpnV = srcpV + src_pitchUV;
-	const unsigned char *srcpnnV = srcpnV + src_pitchUV2;
-	const unsigned char *srcppU = srcpU - src_pitchUV;
-	const unsigned char *srcpppU = srcppU - src_pitchUV2;
-	const unsigned char *srcpnU = srcpU + src_pitchUV;
-	const unsigned char *srcpnnU = srcpnU + src_pitchUV2;
-	int x, y;
-	for (y=0; y&lt;HeightY; ++y)
-	{
-		for (x=0; x&lt;WidthY; ++x)
-		{
-			if (maskpY[x] == 10 || maskpY[x] == 110) dstpY[x] = srcpY[x];
-			else if (maskpY[x] == 20 || maskpY[x] == 120) dstpY[x] = prvpY[x];
-			else if (maskpY[x] == 30 || maskpY[x] == 130) dstpY[x] = nxtpY[x];
-			else if (maskpY[x] == 40) dstpY[x] = (srcpY[x]+nxtpY[x]+1)&gt;&gt;1;
-			else if (maskpY[x] == 50) dstpY[x] = (srcpY[x]+prvpY[x]+1)&gt;&gt;1;
-			else if (maskpY[x] == 60)
-			{
-				if (y&lt;3 || y&gt;HeightY-4) dstpY[x] = (srcpnY[x]+srcppY[x]+1)&gt;&gt;1;
-				else dstpY[x] = cubicInt(srcpppY[x],srcppY[x],srcpnY[x],srcpnnY[x]);
-			}
-		}
-		prvpY += prv_pitchY;
-		srcpppY += src_pitchY;
-		srcppY += src_pitchY;
-		srcpY += src_pitchY;
-		srcpnY += src_pitchY;
-		srcpnnY += src_pitchY;
-		nxtpY += nxt_pitchY;
-		maskpY += mask_pitchY;
-		dstpY += dst_pitchY;
-	}
-	for (y=0; y&lt;HeightUV; ++y)
-	{
-		for (x=0; x&lt;WidthUV; ++x)
-		{
-			if (maskpV[x] == 10 || maskpV[x] == 110) dstpV[x] = srcpV[x];
-			else if (maskpV[x] == 20 || maskpV[x] == 120) dstpV[x] = prvpV[x];
-			else if (maskpV[x] == 30 || maskpV[x] == 130) dstpV[x] = nxtpV[x];
-			else if (maskpV[x] == 40) dstpV[x] = (srcpV[x]+nxtpV[x]+1)&gt;&gt;1;
-			else if (maskpV[x] == 50) dstpV[x] = (srcpV[x]+prvpV[x]+1)&gt;&gt;1;
-			else if (maskpV[x] == 60)
-			{
-				if (y&lt;3 || y&gt;HeightUV-4) dstpV[x] = (srcpnV[x]+srcppV[x]+1)&gt;&gt;1;
-				else dstpV[x] = cubicInt(srcpppV[x],srcppV[x],srcpnV[x],srcpnnV[x]);
-			}
-			if (maskpU[x] == 10 || maskpU[x] == 110) dstpU[x] = srcpU[x];
-			else if (maskpU[x] == 20 || maskpU[x] == 120) dstpU[x] = prvpU[x];
-			else if (maskpU[x] == 30 || maskpU[x] == 130) dstpU[x] = nxtpU[x];
-			else if (maskpU[x] == 40) dstpU[x] = (srcpU[x]+nxtpU[x]+1)&gt;&gt;1;
-			else if (maskpU[x] == 50) dstpU[x] = (srcpU[x]+prvpU[x]+1)&gt;&gt;1;
-			else if (maskpU[x] == 60)
-			{
-				if (y&lt;3 || y&gt;HeightUV-4) dstpU[x] = (srcpnU[x]+srcppU[x]+1)&gt;&gt;1;
-				else dstpU[x] = cubicInt(srcpppU[x],srcppU[x],srcpnU[x],srcpnnU[x]);
-			}
-		}
-		prvpV += prv_pitchUV;
-		prvpU += prv_pitchUV;
-		srcpppV += src_pitchUV;
-		srcppV += src_pitchUV;
-		srcpV += src_pitchUV;
-		srcpnV += src_pitchUV;
-		srcpnnV += src_pitchUV;
-		srcpppU += src_pitchUV;
-		srcppU += src_pitchUV;
-		srcpU += src_pitchUV;
-		srcpnU += src_pitchUV;
-		srcpnnU += src_pitchUV;
-		nxtpV += nxt_pitchUV;
-		nxtpU += nxt_pitchUV;
-		maskpV += mask_pitchUV;
-		maskpU += mask_pitchUV;
-		dstpV += dst_pitchUV;
-		dstpU += dst_pitchUV;
-	}
-}
-
-void vidTDeint::ELADeintYV12(ADMImage *dst, ADMImage *mask, 
-		ADMImage *prv, ADMImage *src, ADMImage *nxt)
-{
-	const unsigned char *prvpY = prv-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *prvpV = prv-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *prvpU = prv-&gt;GetReadPtr(PLANAR_U);
-	int prv_pitchY = prv-&gt;GetPitch(PLANAR_Y);
-	int prv_pitchUV = prv-&gt;GetPitch(PLANAR_V);
-	const unsigned char *srcpY = src-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *srcpV = src-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *srcpU = src-&gt;GetReadPtr(PLANAR_U);
-	int src_pitchY = src-&gt;GetPitch(PLANAR_Y);
-	int src_pitchUV = src-&gt;GetPitch(PLANAR_V);
-	int WidthY = src-&gt;GetRowSize(PLANAR_Y);
-	int WidthUV = src-&gt;GetRowSize(PLANAR_V);
-	int HeightY = src-&gt;GetHeight(PLANAR_Y);
-	int HeightUV = src-&gt;GetHeight(PLANAR_V);
-	const unsigned char *nxtpY = nxt-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *nxtpV = nxt-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *nxtpU = nxt-&gt;GetReadPtr(PLANAR_U);
-	int nxt_pitchY = nxt-&gt;GetPitch(PLANAR_Y);
-	int nxt_pitchUV = nxt-&gt;GetPitch(PLANAR_V);
-	unsigned char *dstpY = dst-&gt;GetWritePtr(PLANAR_Y);
-	unsigned char *dstpV = dst-&gt;GetWritePtr(PLANAR_V);
-	unsigned char *dstpU = dst-&gt;GetWritePtr(PLANAR_U);
-	int dst_pitchY = dst-&gt;GetPitch(PLANAR_Y);
-	int dst_pitchUV = dst-&gt;GetPitch(PLANAR_V);
-	const unsigned char *maskpY = mask-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *maskpV = mask-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *maskpU = mask-&gt;GetReadPtr(PLANAR_U);
-	int mask_pitchY = mask-&gt;GetPitch(PLANAR_Y);
-	int mask_pitchUV = mask-&gt;GetPitch(PLANAR_V);
-	const unsigned char *srcppY = srcpY - src_pitchY;
-	const unsigned char *srcpnY = srcpY + src_pitchY;
-	const unsigned char *srcppV = srcpV - src_pitchUV;
-	const unsigned char *srcpnV = srcpV + src_pitchUV;
-	const unsigned char *srcppU = srcpU - src_pitchUV;
-	const unsigned char *srcpnU = srcpU + src_pitchUV;
-	int x, y, u, val, stop, temp1, temp2, min, minf, maxf, s1, s2;
-	for (y=0; y&lt;HeightY; ++y)
-	{
-		for (x=0; x&lt;WidthY; ++x)
-		{
-			if (maskpY[x] == 10 || maskpY[x] == 110) dstpY[x] = srcpY[x];
-			else if (maskpY[x] == 20 || maskpY[x] == 120) dstpY[x] = prvpY[x];
-			else if (maskpY[x] == 30 || maskpY[x] == 130) dstpY[x] = nxtpY[x];
-			else if (maskpY[x] == 40) dstpY[x] = (srcpY[x]+nxtpY[x]+1)&gt;&gt;1;
-			else if (maskpY[x] == 50) dstpY[x] = (srcpY[x]+prvpY[x]+1)&gt;&gt;1;
-			else if (maskpY[x] == 60)
-			{
-				if (x &lt; 2 || x &gt; WidthY-3 || (abs(srcppY[x]-srcpnY[x]) &lt; 10 &amp;&amp;
-					abs(srcppY[x-2]-srcppY[x+2]) &lt; 10 &amp;&amp; abs(srcpnY[x-2]-srcpnY[x+2]) &lt; 10))
-				{
-					dstpY[x] = (srcppY[x]+srcpnY[x]+1)&gt;&gt;1;
-				}
-				else
-				{
-					stop = min(x-1,min(8,WidthY-2-x));
-					minf = min(srcppY[x],srcpnY[x])-2;
-					maxf = max(srcppY[x],srcpnY[x])+2;
-					val = (srcppY[x]+srcpnY[x]+1)&gt;&gt;1;
-					for (min=450, u=0; u&lt;=stop; ++u)
-					{
-						s1 = srcppY[x+(u&gt;&gt;1)]+srcppY[x+((u+1)&gt;&gt;1)];
-						s2 = srcpnY[x-(u&gt;&gt;1)]+srcpnY[x-((u+1)&gt;&gt;1)];
-						temp1 = abs(s1-s2) + abs(srcppY[x-1]-srcpnY[x-1-u]) + 
-							(abs(srcppY[x]-srcpnY[x-u])&lt;&lt;1) + abs(srcppY[x+1]-srcpnY[x+1-u]) +
-							abs(srcpnY[x-1]-srcppY[x-1+u]) + (abs(srcpnY[x]-srcppY[x+u])&lt;&lt;1) + 
-							abs(srcpnY[x+1]-srcppY[x+1+u]);
-						temp2 = (s1+s2+2)&gt;&gt;2;
-						if (temp1 &lt; min &amp;&amp; temp2 &gt;= minf &amp;&amp; temp2 &lt;= maxf)
-						{
-							min = temp1;
-							val = temp2;
-						}
-						s1 = srcppY[x-(u&gt;&gt;1)]+srcppY[x-((u+1)&gt;&gt;1)];
-						s2 = srcpnY[x+(u&gt;&gt;1)]+srcpnY[x+((u+1)&gt;&gt;1)];
-						temp1 = abs(s1-s2) + abs(srcppY[x-1]-srcpnY[x-1+u]) + 
-							(abs(srcppY[x]-srcpnY[x+u])&lt;&lt;1) + abs(srcppY[x+1]-srcpnY[x+1+u])+
-							abs(srcpnY[x-1]-srcppY[x-1-u]) + (abs(srcpnY[x]-srcppY[x-u])&lt;&lt;1) +
-							abs(srcpnY[x+1]-srcppY[x+1-u]);
-						temp2 = (s1+s2+2)&gt;&gt;2;
-						if (temp1 &lt; min &amp;&amp; temp2 &gt;= minf &amp;&amp; temp2 &lt;= maxf)
-						{
-							min = temp1;
-							val = temp2;
-						}
-					}
-					dstpY[x] = val;
-				}
-			}
-		}
-		prvpY += prv_pitchY;
-		srcppY += src_pitchY;
-		srcpY += src_pitchY;
-		srcpnY += src_pitchY;
-		nxtpY += nxt_pitchY;
-		maskpY += mask_pitchY;
-		dstpY += dst_pitchY;
-	}
-	for (y=0; y&lt;HeightUV; ++y)
-	{
-		for (x=0; x&lt;WidthUV; ++x)
-		{
-			if (maskpV[x] == 10 || maskpV[x] == 110) dstpV[x] = srcpV[x];
-			else if (maskpV[x] == 20 || maskpV[x] == 120) dstpV[x] = prvpV[x];
-			else if (maskpV[x] == 30 || maskpV[x] == 130) dstpV[x] = nxtpV[x];
-			else if (maskpV[x] == 40) dstpV[x] = (srcpV[x]+nxtpV[x]+1)&gt;&gt;1;
-			else if (maskpV[x] == 50) dstpV[x] = (srcpV[x]+prvpV[x]+1)&gt;&gt;1;
-			else if (maskpV[x] == 60)
-			{
-				if (x &lt; 2 || x &gt; WidthUV-3 || (abs(srcppV[x]-srcpnV[x]) &lt; 10 &amp;&amp;
-					abs(srcppV[x-2]-srcppV[x+2]) &lt; 10 &amp;&amp; abs(srcpnV[x-2]-srcpnV[x+2]) &lt; 10)) 
-				{
-					dstpV[x] = (srcppV[x]+srcpnV[x]+1)&gt;&gt;1;
-				}
-				else
-				{
-					stop = min(x-1,min(4,WidthUV-2-x));
-					minf = min(srcppV[x],srcpnV[x])-2;
-					maxf = max(srcppV[x],srcpnV[x])+2;
-					val = (srcppV[x]+srcpnV[x]+1)&gt;&gt;1;
-					for (min=450, u=0; u&lt;=stop; ++u) 
-					{
-						s1 = srcppV[x+(u&gt;&gt;1)]+srcppV[x+((u+1)&gt;&gt;1)];
-						s2 = srcpnV[x-(u&gt;&gt;1)]+srcpnV[x-((u+1)&gt;&gt;1)];
-						temp1 = abs(s1-s2) + abs(srcppV[x-1]-srcpnV[x-1-u]) +
-							(abs(srcppV[x]-srcpnV[x-u])&lt;&lt;1) + abs(srcppV[x+1]-srcpnV[x+1-u]) +
-							abs(srcpnV[x-1]-srcppV[x-1+u]) + (abs(srcpnV[x]-srcppV[x+u])&lt;&lt;1) +
-							abs(srcpnV[x+1]-srcppV[x+1+u]);
-						temp2 = (s1+s2+2)&gt;&gt;2;
-						if (temp1 &lt; min &amp;&amp; temp2 &gt;= minf &amp;&amp; temp2 &lt;= maxf)
-						{
-							min = temp1;
-							val = temp2;
-						}
-						s1 = srcppV[x-(u&gt;&gt;1)]+srcppV[x-((u+1)&gt;&gt;1)];
-						s2 = srcpnV[x+(u&gt;&gt;1)]+srcpnV[x+((u+1)&gt;&gt;1)];
-						temp1 = abs(s1-s2) + abs(srcppV[x-1]-srcpnV[x-1+u]) + 
-							(abs(srcppV[x]-srcpnV[x+u])&lt;&lt;1) + abs(srcppV[x+1]-srcpnV[x+1+u]) +
-							abs(srcpnV[x-1]-srcppV[x-1-u]) + (abs(srcpnV[x]-srcppV[x-u])&lt;&lt;1) + 
-							abs(srcpnV[x+1]-srcppV[x+1-u]);
-						temp2 = (s1+s2+2)&gt;&gt;2;
-						if (temp1 &lt; min &amp;&amp; temp2 &gt;= minf &amp;&amp; temp2 &lt;= maxf)
-						{
-							min = temp1;
-							val = temp2;
-						}
-					}
-					dstpV[x] = val;
-				}
-			}
-			if (maskpU[x] == 10 || maskpU[x] == 110) dstpU[x] = srcpU[x];
-			else if (maskpU[x] == 20 || maskpU[x] == 120) dstpU[x] = prvpU[x];
-			else if (maskpU[x] == 30 || maskpU[x] == 130) dstpU[x] = nxtpU[x];
-			else if (maskpU[x] == 40) dstpU[x] = (srcpU[x]+nxtpU[x]+1)&gt;&gt;1;
-			else if (maskpU[x] == 50) dstpU[x] = (srcpU[x]+prvpU[x]+1)&gt;&gt;1;
-			else if (maskpU[x] == 60)
-			{
-				if (x &lt; 2 || x &gt; WidthUV-3 || (abs(srcppU[x]-srcpnU[x]) &lt; 10 &amp;&amp;
-					abs(srcppU[x-2]-srcppU[x+2]) &lt; 10 &amp;&amp; abs(srcpnU[x-2]-srcpnU[x+2]) &lt; 10)) 
-				{
-					dstpU[x] = (srcppU[x]+srcpnU[x]+1)&gt;&gt;1;
-				}
-				else
-				{
-					stop = min(x-1,min(4,WidthUV-2-x));
-					minf = min(srcppU[x],srcpnU[x])-2;
-					maxf = max(srcppU[x],srcpnU[x])+2;
-					val = (srcppU[x]+srcpnU[x]+1)&gt;&gt;1;
-					for (min=450, u=0; u&lt;=stop; ++u) 
-					{
-						s1 = srcppU[x+(u&gt;&gt;1)]+srcppU[x+((u+1)&gt;&gt;1)];
-						s2 = srcpnU[x-(u&gt;&gt;1)]+srcpnU[x-((u+1)&gt;&gt;1)];
-						temp1 = abs(s1-s2) + abs(srcppU[x-1]-srcpnU[x-1-u]) +
-							(abs(srcppU[x]-srcpnU[x-u])&lt;&lt;1) + abs(srcppU[x+1]-srcpnU[x+1-u]) +
-							abs(srcpnU[x-1]-srcppU[x-1+u]) + (abs(srcpnU[x]-srcppU[x+u])&lt;&lt;1) +
-							abs(srcpnU[x+1]-srcppU[x+1+u]);
-						temp2 = (s1+s2+2)&gt;&gt;2;
-						if (temp1 &lt; min &amp;&amp; temp2 &gt;= minf &amp;&amp; temp2 &lt;= maxf)
-						{
-							min = temp1;
-							val = temp2;
-						}
-						s1 = srcppU[x-(u&gt;&gt;1)]+srcppU[x-((u+1)&gt;&gt;1)];
-						s2 = srcpnU[x+(u&gt;&gt;1)]+srcpnU[x+((u+1)&gt;&gt;1)];
-						temp1 = abs(s1-s2) + abs(srcppU[x-1]-srcpnU[x-1+u]) + 
-							(abs(srcppU[x]-srcpnU[x+u])&lt;&lt;1) + abs(srcppU[x+1]-srcpnU[x+1+u]) +
-							abs(srcpnU[x-1]-srcppU[x-1-u]) + (abs(srcpnU[x]-srcppU[x-u])&lt;&lt;1) +
-							abs(srcpnU[x+1]-srcppU[x+1-u]);
-						temp2 = (s1+s2+2)&gt;&gt;2;
-						if (temp1 &lt; min &amp;&amp; temp2 &gt;= minf &amp;&amp; temp2 &lt;= maxf)
-						{
-							min = temp1;
-							val = temp2;
-						}
-					}
-					dstpU[x] = val;
-				}
-			}
-		}
-		prvpV += prv_pitchUV;
-		prvpU += prv_pitchUV;
-		srcppV += src_pitchUV;
-		srcpV += src_pitchUV;
-		srcpnV += src_pitchUV;
-		srcppU += src_pitchUV;
-		srcpU += src_pitchUV;
-		srcpnU += src_pitchUV;
-		nxtpV += nxt_pitchUV;
-		nxtpU += nxt_pitchUV;
-		maskpV += mask_pitchUV;
-		maskpU += mask_pitchUV;
-		dstpV += dst_pitchUV;
-		dstpU += dst_pitchUV;
-	}
-}
-
-void vidTDeint::kernelDeintYV12(ADMImage *dst, ADMImage *mask, 
-		ADMImage *prv, ADMImage *src, ADMImage *nxt)
-{
-	const unsigned char *prvpY = prv-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *prvpU = prv-&gt;GetReadPtr(PLANAR_U);
-	const unsigned char *prvpV = prv-&gt;GetReadPtr(PLANAR_V);
-	int prv_pitchY = prv-&gt;GetPitch(PLANAR_Y);
-	int prv_pitchY2 = prv_pitchY&lt;&lt;1;
-	int prv_pitchUV = prv-&gt;GetPitch(PLANAR_V);
-	int prv_pitchUV2 = prv_pitchUV&lt;&lt;1;
-	const unsigned char *srcpY = src-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *srcpU = src-&gt;GetReadPtr(PLANAR_U);
-	const unsigned char *srcpV = src-&gt;GetReadPtr(PLANAR_V);
-	int src_pitchY = src-&gt;GetPitch(PLANAR_Y);
-	int src_pitchUV = src-&gt;GetPitch(PLANAR_V);
-	int src_pitchY2 = src_pitchY&lt;&lt;1;
-	int src_pitchUV2 = src_pitchUV&lt;&lt;1;
-	int WidthY = src-&gt;GetRowSize(PLANAR_Y);
-	int WidthUV = src-&gt;GetRowSize(PLANAR_V);
-	int HeightY = src-&gt;GetHeight(PLANAR_Y);
-	int HeightUV = src-&gt;GetHeight(PLANAR_V);
-	const unsigned char *nxtpY = nxt-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *nxtpU = nxt-&gt;GetReadPtr(PLANAR_U);
-	const unsigned char *nxtpV = nxt-&gt;GetReadPtr(PLANAR_V);
-	int nxt_pitchY = nxt-&gt;GetPitch(PLANAR_Y);
-	int nxt_pitchY2 = nxt_pitchY&lt;&lt;1;
-	int nxt_pitchUV = nxt-&gt;GetPitch(PLANAR_V);
-	int nxt_pitchUV2 = nxt_pitchUV&lt;&lt;1;
-	unsigned char *dstpY = dst-&gt;GetWritePtr(PLANAR_Y);
-	unsigned char *dstpU = dst-&gt;GetWritePtr(PLANAR_U);
-	unsigned char *dstpV = dst-&gt;GetWritePtr(PLANAR_V);
-	int dst_pitchY = dst-&gt;GetPitch(PLANAR_Y);
-	int dst_pitchUV = dst-&gt;GetPitch(PLANAR_V);
-	const unsigned char *maskpY = mask-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *maskpU = mask-&gt;GetReadPtr(PLANAR_U);
-	const unsigned char *maskpV = mask-&gt;GetReadPtr(PLANAR_V);
-	int mask_pitchY = mask-&gt;GetPitch(PLANAR_Y);
-	int mask_pitchUV = mask-&gt;GetPitch(PLANAR_V);
-	const unsigned char *srcppY = srcpY - src_pitchY;
-	const unsigned char *srcppU = srcpU - src_pitchUV;
-	const unsigned char *srcppV = srcpV - src_pitchUV;
-	const unsigned char *srcpppY = srcppY - src_pitchY2;
-	const unsigned char *srcpppU = srcppU - src_pitchUV2;
-	const unsigned char *srcpppV = srcppV - src_pitchUV2;
-	const unsigned char *srcpnY = srcpY + src_pitchY;
-	const unsigned char *srcpnU = srcpU + src_pitchUV;
-	const unsigned char *srcpnV = srcpV + src_pitchUV;
-	const unsigned char *srcpnnY = srcpnY + src_pitchY2;
-	const unsigned char *srcpnnU = srcpnU + src_pitchUV2;
-	const unsigned char *srcpnnV = srcpnV + src_pitchUV2;
-	const unsigned char *kercY, *kerpY, *kerppY, *kernY, *kernnY;
-	const unsigned char *kercU, *kerpU, *kerppU, *kernU, *kernnU;
-	const unsigned char *kercV, *kerpV, *kerppV, *kernV, *kernnV;
-	int ker_pitchY, ker_pitchUV, x, y, temp;
-	if (accumP &lt;= accumN)
-	{
-		if (PRM(field)^PRM(order))
-		{
-			ker_pitchY = src_pitchY;
-			ker_pitchUV = src_pitchUV;
-			kerppY = srcpY - (src_pitchY2&lt;&lt;1);
-			kerppU = srcpU - (src_pitchUV2&lt;&lt;1);
-			kerppV = srcpV - (src_pitchUV2&lt;&lt;1);
-			kerpY = srcpY - src_pitchY2;
-			kerpU = srcpU - src_pitchUV2;
-			kerpV = srcpV - src_pitchUV2;
-			kercY = srcpY;
-			kercU = srcpU;
-			kercV = srcpV;
-			kernY = srcpY + src_pitchY2;
-			kernU = srcpU + src_pitchUV2;
-			kernV = srcpV + src_pitchUV2;
-			kernnY = srcpY + (src_pitchY2&lt;&lt;1);
-			kernnU = srcpU + (src_pitchUV2&lt;&lt;1);
-			kernnV = srcpV + (src_pitchUV2&lt;&lt;1);
-		}
-		else
-		{
-			ker_pitchY = prv_pitchY;
-			ker_pitchUV = prv_pitchUV;
-			kerppY = prvpY - (prv_pitchY2&lt;&lt;1);
-			kerppU = prvpU - (prv_pitchUV2&lt;&lt;1);
-			kerppV = prvpV - (prv_pitchUV2&lt;&lt;1);
-			kerpY = prvpY - prv_pitchY2;
-			kerpU = prvpU - prv_pitchUV2;
-			kerpV = prvpV - prv_pitchUV2;
-			kercY = prvpY;
-			kercU = prvpU;
-			kercV = prvpV;
-			kernY = prvpY + prv_pitchY2;
-			kernU = prvpU + prv_pitchUV2;
-			kernV = prvpV + prv_pitchUV2;
-			kernnY = prvpY + (prv_pitchY2&lt;&lt;1);
-			kernnU = prvpU + (prv_pitchUV2&lt;&lt;1);
-			kernnV = prvpV + (prv_pitchUV2&lt;&lt;1);
-		}
-	}
-	else
-	{
-		if (PRM(field)^PRM(order))
-		{
-			ker_pitchY = nxt_pitchY;
-			ker_pitchUV = nxt_pitchUV;
-			kerppY = nxtpY - (nxt_pitchY2&lt;&lt;1);
-			kerppU = nxtpU - (nxt_pitchUV2&lt;&lt;1);
-			kerppV = nxtpV - (nxt_pitchUV2&lt;&lt;1);
-			kerpY = nxtpY - nxt_pitchY2;
-			kerpU = nxtpU - nxt_pitchUV2;
-			kerpV = nxtpV - nxt_pitchUV2;
-			kercY = nxtpY;
-			kercU = nxtpU;
-			kercV = nxtpV;
-			kernY = nxtpY + nxt_pitchY2;
-			kernU = nxtpU + nxt_pitchUV2;
-			kernV = nxtpV + nxt_pitchUV2;
-			kernnY = nxtpY + (nxt_pitchY2&lt;&lt;1);
-			kernnU = nxtpU + (nxt_pitchUV2&lt;&lt;1);
-			kernnV = nxtpV + (nxt_pitchUV2&lt;&lt;1);
-		}
-		else
-		{
-			ker_pitchY = src_pitchY;
-			ker_pitchUV = src_pitchUV;
-			kerppY = srcpY - (src_pitchY2&lt;&lt;1);
-			kerppU = srcpU - (src_pitchUV2&lt;&lt;1);
-			kerppV = srcpV - (src_pitchUV2&lt;&lt;1);
-			kerpY = srcpY - src_pitchY2;
-			kerpU = srcpU - src_pitchUV2;
-			kerpV = srcpV - src_pitchUV2;
-			kercY = srcpY;
-			kercU = srcpU;
-			kercV = srcpV;
-			kernY = srcpY + src_pitchY2;
-			kernU = srcpU + src_pitchUV2;
-			kernV = srcpV + src_pitchUV2;
-			kernnY = srcpY + (src_pitchY2&lt;&lt;1);
-			kernnU = srcpU + (src_pitchUV2&lt;&lt;1);
-			kernnV = srcpV + (src_pitchUV2&lt;&lt;1);
-		}
-	}
-	for (y=0; y&lt;HeightY; ++y)
-	{
-		for (x=0; x&lt;WidthY; ++x)
-		{
-			if (maskpY[x] == 10 || maskpY[x] == 110) dstpY[x] = srcpY[x];
-			else if (maskpY[x] == 20 || maskpY[x] == 120) dstpY[x] = prvpY[x];
-			else if (maskpY[x] == 30 || maskpY[x] == 130) dstpY[x] = nxtpY[x];
-			else if (maskpY[x] == 40) dstpY[x] = (srcpY[x]+nxtpY[x]+1)&gt;&gt;1;
-			else if (maskpY[x] == 50) dstpY[x] = (srcpY[x]+prvpY[x]+1)&gt;&gt;1;
-			else if (maskpY[x] == 60)
-			{
-				if (sharp &amp;&amp; y&gt;3 &amp;&amp; y&lt;HeightY-4)
-				{
-					temp = (int)((0.526*(srcppY[x]+srcpnY[x]) + 
-								  0.170*(kercY[x]) - 
-								  0.116*(kerpY[x]+kernY[x]) - 
-								  0.026*(srcpppY[x]+srcpnnY[x]) + 
-								  0.031*(kerppY[x] + kernnY[x])) + 0.5f);
-					if (temp &gt; 255) dstpY[x] = 255;
-					else if (temp &lt; 0) dstpY[x] = 0;
-					else dstpY[x] = temp;
-				}
-				else if (y&gt;1 &amp;&amp; y&lt;HeightY-2)
-				{
-					temp = (((srcppY[x]+srcpnY[x])&lt;&lt;3)+
-							(kercY[x]&lt;&lt;1)-(kerpY[x]+kernY[x])+8) &gt;&gt; 4;
-					if (temp &gt; 255) dstpY[x] = 255;
-					else if (temp &lt; 0) dstpY[x] = 0;
-					else dstpY[x] = temp;
-				}
-				else dstpY[x] = (srcpnY[x]+srcppY[x]+1)&gt;&gt;1;
-			}
-		}
-		prvpY += prv_pitchY;
-		srcpppY += src_pitchY;
-		srcppY += src_pitchY;
-		srcpY += src_pitchY;
-		srcpnY += src_pitchY;
-		srcpnnY += src_pitchY;
-		kerppY += ker_pitchY;
-		kerpY += ker_pitchY;
-		kercY += ker_pitchY;
-		kernY += ker_pitchY;
-		kernnY += ker_pitchY;
-		nxtpY += nxt_pitchY;
-		maskpY += mask_pitchY;
-		dstpY += dst_pitchY;
-	}
-	for (y=0; y&lt;HeightUV; ++y)
-	{
-		for (x=0; x&lt;WidthUV; ++x)
-		{
-			if (maskpU[x] == 10 || maskpU[x] == 110) dstpU[x] = srcpU[x];
-			else if (maskpU[x] == 20 || maskpU[x] == 120) dstpU[x] = prvpU[x];
-			else if (maskpU[x] == 30 || maskpU[x] == 130) dstpU[x] = nxtpU[x];
-			else if (maskpU[x] == 40) dstpU[x] = (srcpU[x]+nxtpU[x]+1)&gt;&gt;1;
-			else if (maskpU[x] == 50) dstpU[x] = (srcpU[x]+prvpU[x]+1)&gt;&gt;1;
-			else if (maskpU[x] == 60)
-			{
-				if (sharp &amp;&amp; y&gt;3 &amp;&amp; y&lt;HeightUV-4)
-				{
-					temp = (int)((0.526*(srcppU[x]+srcpnU[x]) + 
-								  0.170*(kercU[x]) - 
-								  0.116*(kerpU[x]+kernU[x]) - 
-								  0.026*(srcpppU[x]+srcpnnU[x]) + 
-								  0.031*(kerppU[x] + kernnU[x])) + 0.5f);
-					if (temp &gt; 255) dstpU[x] = 255;
-					else if (temp &lt; 0) dstpU[x] = 0;
-					else dstpU[x] = temp;
-				}
-				else if (y&gt;1 &amp;&amp; y&lt;HeightUV-2)
-				{
-					temp = (((srcppU[x]+srcpnU[x])&lt;&lt;3)+
-							(kercU[x]&lt;&lt;1)-(kerpU[x]+kernU[x])+8) &gt;&gt; 4;
-					if (temp &gt; 255) dstpU[x] = 255;
-					else if (temp &lt; 0) dstpU[x] = 0;
-					else dstpU[x] = temp;
-				}
-				else dstpU[x] = (srcpnU[x]+srcppU[x]+1)&gt;&gt;1;
-			}
-			if (maskpV[x] == 10 || maskpV[x] == 110) dstpV[x] = srcpV[x];
-			else if (maskpV[x] == 20 || maskpV[x] == 120) dstpV[x] = prvpV[x];
-			else if (maskpV[x] == 30 || maskpV[x] == 130) dstpV[x] = nxtpV[x];
-			else if (maskpV[x] == 40) dstpV[x] = (srcpV[x]+nxtpV[x]+1)&gt;&gt;1;
-			else if (maskpV[x] == 50) dstpV[x] = (srcpV[x]+prvpV[x]+1)&gt;&gt;1;
-			else if (maskpV[x] == 60)
-			{
-				if (sharp &amp;&amp; y&gt;3 &amp;&amp; y&lt;HeightUV-4)
-				{
-					temp = (int)((0.526*(srcppV[x]+srcpnV[x]) + 
-								  0.170*(kercV[x]) - 
-								  0.116*(kerpV[x]+kernV[x]) - 
-								  0.026*(srcpppV[x]+srcpnnV[x]) + 
-								  0.031*(kerppV[x] + kernnV[x])) + 0.5f);
-					if (temp &gt; 255) dstpV[x] = 255;
-					else if (temp &lt; 0) dstpV[x] = 0;
-					else dstpV[x] = temp;
-				}
-				else if (y&gt;1 &amp;&amp; y&lt;HeightUV-2)
-				{
-					temp = (((srcppV[x]+srcpnV[x])&lt;&lt;3)+
-							(kercV[x]&lt;&lt;1)-(kerpV[x]+kernV[x])+8) &gt;&gt; 4;
-					if (temp &gt; 255) dstpV[x] = 255;
-					else if (temp &lt; 0) dstpV[x] = 0;
-					else dstpV[x] = temp;
-				}
-				else dstpV[x] = (srcpnV[x]+srcppV[x]+1)&gt;&gt;1;
-			}
-
-		}
-		prvpU += prv_pitchUV;
-		prvpV += prv_pitchUV;
-		srcpppU += src_pitchUV;
-		srcpppV += src_pitchUV;
-		srcppU += src_pitchUV;
-		srcppV += src_pitchUV;
-		srcpU += src_pitchUV;
-		srcpV += src_pitchUV;
-		srcpnU += src_pitchUV;
-		srcpnV += src_pitchUV;
-		srcpnnU += src_pitchUV;
-		srcpnnV += src_pitchUV;
-		kerppU += ker_pitchUV;
-		kerppV += ker_pitchUV;
-		kerpU += ker_pitchUV;
-		kerpV += ker_pitchUV;
-		kercU += ker_pitchUV;
-		kercV += ker_pitchUV;
-		kernU += ker_pitchUV;
-		kernV += ker_pitchUV;
-		kernnU += ker_pitchUV;
-		kernnV += ker_pitchUV;
-		nxtpU += nxt_pitchUV;
-		nxtpV += nxt_pitchUV;
-		maskpU += mask_pitchUV;
-		maskpV += mask_pitchUV;
-		dstpU += dst_pitchUV;
-		dstpV += dst_pitchUV;
-	}
-}
-
-void vidTDeint::smartELADeintYV12(ADMImage *dst, ADMImage *mask, 
-		ADMImage *prv, ADMImage *src, ADMImage *nxt)
-{
-	const unsigned char *prvpY = prv-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *prvpV = prv-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *prvpU = prv-&gt;GetReadPtr(PLANAR_U);
-	int prv_pitchY = prv-&gt;GetPitch(PLANAR_Y);
-	int prv_pitchUV = prv-&gt;GetPitch(PLANAR_V);
-	const unsigned char *srcpY = src-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *srcpV = src-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *srcpU = src-&gt;GetReadPtr(PLANAR_U);
-	int src_pitchY = src-&gt;GetPitch(PLANAR_Y);
-	int src_pitchY2 = src_pitchY&lt;&lt;1;
-	int src_pitchUV = src-&gt;GetPitch(PLANAR_V);
-	int src_pitchUV2 = src_pitchUV&lt;&lt;1;
-	int WidthY = src-&gt;GetRowSize(PLANAR_Y);
-	int WidthUV = src-&gt;GetRowSize(PLANAR_V);
-	int HeightY = src-&gt;GetHeight(PLANAR_Y);
-	int HeightUV = src-&gt;GetHeight(PLANAR_V);
-	const unsigned char *nxtpY = nxt-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *nxtpV = nxt-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *nxtpU = nxt-&gt;GetReadPtr(PLANAR_U);
-	int nxt_pitchY = nxt-&gt;GetPitch(PLANAR_Y);
-	int nxt_pitchUV = nxt-&gt;GetPitch(PLANAR_V);
-	unsigned char *dstpY = dst-&gt;GetWritePtr(PLANAR_Y);
-	unsigned char *dstpV = dst-&gt;GetWritePtr(PLANAR_V);
-	unsigned char *dstpU = dst-&gt;GetWritePtr(PLANAR_U);
-	int dst_pitchY = dst-&gt;GetPitch(PLANAR_Y);
-	int dst_pitchUV = dst-&gt;GetPitch(PLANAR_V);
-	const unsigned char *maskpY = mask-&gt;GetReadPtr(PLANAR_Y);
-	const unsigned char *maskpV = mask-&gt;GetReadPtr(PLANAR_V);
-	const unsigned char *maskpU = mask-&gt;GetReadPtr(PLANAR_U);
-	int mask_pitchY = mask-&gt;GetPitch(PLANAR_Y);
-	int mask_pitchUV = mask-&gt;GetPitch(PLANAR_V);
-	const unsigned char *srcppY = srcpY - src_pitchY;
-	const unsigned char *srcpppY = srcppY - src_pitchY2;
-	const unsigned char *srcpnY = srcpY + src_pitchY;
-	const unsigned char *srcpnnY = srcpnY + src_pitchY2;
-	const unsigned char *srcppV = srcpV - src_pitchUV;
-	const unsigned char *srcpppV = srcppV - src_pitchUV2;
-	const unsigned char *srcpnV = srcpV + src_pitchUV;
-	const unsigned char *srcpnnV = srcpnV + src_pitchUV2;
-	const unsigned char *srcppU = srcpU - src_pitchUV;
-	const unsigned char *srcpppU = srcppU - src_pitchUV2;
-	const unsigned char *srcpnU = srcpU + src_pitchUV;
-	const unsigned char *srcpnnU = srcpnU + src_pitchUV2;
-	int x, y, Iy1, Iy2, Iye, Ix1, Ix2, edgeS1, edgeS2;
-	int sum, sumsq, temp, temp1, temp2, minN, maxN;
-	double dir1, dir2, dir, dirF;
-	for (y=0; y&lt;HeightY; ++y)
-	{
-		for (x=0; x&lt;WidthY; ++x)
-		{
-			if (maskpY[x] == 10 || maskpY[x] == 110) dstpY[x] = srcpY[x];
-			else if (maskpY[x] == 20 || maskpY[x] == 120) dstpY[x] = prvpY[x];
-			else if (maskpY[x] == 30 || maskpY[x] == 130) dstpY[x] = nxtpY[x];
-			else if (maskpY[x] == 40) dstpY[x] = (srcpY[x]+nxtpY[x]+1)&gt;&gt;1;
-			else if (maskpY[x] == 50) dstpY[x] = (srcpY[x]+prvpY[x]+1)&gt;&gt;1;
-			else if (maskpY[x] == 60)
-			{
-				if (y&gt;2 &amp;&amp; y&lt;HeightY-3 &amp;&amp; x&gt;3 &amp;&amp; x&lt;WidthY-4)
-				{
-					Iy1 = srcpppY[x-1]+srcpppY[x]+srcpppY[x]+srcpppY[x+1]-srcpnY[x-1]-srcpnY[x]-srcpnY[x]-srcpnY[x+1];
-					Iy2 = srcppY[x-1]+srcppY[x]+srcppY[x]+srcppY[x+1]-srcpnnY[x-1]-srcpnnY[x]-srcpnnY[x]-srcpnnY[x+1];
-					Ix1 = srcpppY[x+1]+srcppY[x+1]+srcppY[x+1]+srcpnY[x+1]-srcpppY[x-1]-srcppY[x-1]-srcppY[x-1]-srcpnY[x-1];
-					Ix2 = srcppY[x+1]+srcpnY[x+1]+srcpnY[x+1]+srcpnnY[x+1]-srcppY[x-1]-srcpnY[x-1]-srcpnY[x-1]-srcpnnY[x-1];
-					edgeS1 = Ix1*Ix1 + Iy1*Iy1;
-					edgeS2 = Ix2*Ix2 + Iy2*Iy2;
-					if (edgeS1 &lt; 1600 &amp;&amp; edgeS2 &lt; 1600) 
-					{
-						dstpY[x] = (srcppY[x]+srcpnY[x]+1)&gt;&gt;1;
-						continue;
-					}
-					if (abs(srcppY[x]-srcpnY[x]) &lt; 10 &amp;&amp; (edgeS1 &lt; 1600 || edgeS2 &lt; 1600))
-					{
-						dstpY[x] = (srcppY[x]+srcpnY[x]+1)&gt;&gt;1;
-						continue;
-					}
-					sum = srcppY[x-1] + srcppY[x] + srcppY[x+1] + srcpnY[x-1] + srcpnY[x] + srcpnY[x+1];
-					sumsq = srcppY[x-1]*srcppY[x-1] + srcppY[x]*srcppY[x] + srcppY[x+1]*srcppY[x+1] +
-							srcpnY[x-1]*srcpnY[x-1] + srcpnY[x]*srcpnY[x] + srcpnY[x+1]*srcpnY[x+1];
-					if ((6*sumsq - sum*sum) &lt; 432)
-					{
-						dstpY[x] = (srcppY[x]+srcpnY[x]+1)&gt;&gt;1;
-						continue;
-					}
-					if (Ix1 == 0) dir1 = 3.1415926;
-					else
-					{
-						dir1 = atan(Iy1/(Ix1*2.0f)) + 1.5707963;
-						if (Iy1 &gt;= 0) { if (Ix1 &lt; 0) dir1 += 3.1415927; }
-						else { if (Ix1 &gt;= 0) dir1 += 3.1415927; }
-						if (dir1 &gt;= 3.1415927) dir1 -= 3.1415927;
-					}
-					if (Ix2 == 0) dir2 = 3.1415926;
-					else 
-					{
-						dir2 = atan(Iy2/(Ix2*2.0f)) + 1.5707963;
-						if (Iy2 &gt;= 0) { if (Ix2 &lt; 0) dir2 += 3.1415927; }
-						else { if (Ix2 &gt;= 0) dir2 += 3.1415927; }
-						if (dir2 &gt;= 3.1415927) dir2 -= 3.1415927;
-					}
-					if (fabs(dir1-dir2) &lt; 0.5)
-					{
-						if (edgeS1 &gt;= 3600 &amp;&amp; edgeS2 &gt;= 3600) dir = (dir1 + dir2) * 0.5f;
-						else dir = edgeS1 &gt;= edgeS2 ? dir1 : dir2;
-					}
-					else
-					{
-						if (edgeS1 &gt;= 5000 &amp;&amp; edgeS2 &gt;= 5000)
-						{
-							Iye = srcppY[x-1]+srcppY[x]+srcppY[x]+srcppY[x+1]-srcpnY[x-1]-srcpnY[x]-srcpnY[x]-srcpnY[x+1];
-							if ((Iy1*Iye &gt; 0) &amp;&amp; (Iy2*Iye &lt; 0)) dir = dir1;
-							else if ((Iy1*Iye &lt; 0) &amp;&amp; (Iy2*Iye &gt; 0)) dir = dir2;
-							else
-							{
-								if (abs(Iye-Iy1) &lt;= abs(Iye-Iy2)) dir = dir1;
-								else dir = dir2;
-							}
-						}
-						else dir = edgeS1 &gt;= edgeS2 ? dir1 : dir2;
-					}
-					dirF = 0.5f/tan(dir);
-					if (dirF &gt;= 0.0f)
-					{
-						if (dirF &gt;= 0.5f)
-						{
-							if (dirF &gt;= 1.0f)
-							{
-								if (dirF &gt;= 1.5f)
-								{
-									if (dirF &gt;= 2.0f)
-									{
-										if (dirF &lt;= 2.50f)
-										{
-											temp1 = srcppY[x+4];
-											temp2 = srcpnY[x-4];
-											temp = (srcppY[x+4]+srcpnY[x-4]+1)&gt;&gt;1;
-										}
-										else 
-										{
-											temp1 = temp2 = srcpnY[x];
-											temp = cubicInt(srcpppY[x],srcppY[x],srcpnY[x],srcpnnY[x]);
-										}
-									}
-									else 
-									{
-										temp1 = (int)((dirF-1.5f)*(srcppY[x+4]) + (2.0f-dirF)*(srcppY[x+3]) + 0.5f);
-										temp2 = (int)((dirF-1.5f)*(srcpnY[x-4]) + (2.0f-dirF)*(srcpnY[x-3]) + 0.5f);
-										temp = (int)((dirF-1.5f)*(srcppY[x+4]+srcpnY[x-4]) + (2.0f-dirF)*(srcppY[x+3]+srcpnY[x-3]) + 0.5f);
-									}
-								}
-								else 
-								{
-									temp1 = (int)((dirF-1.0f)*(srcppY[x+3]) + (1.5f-dirF)*(srcppY[x+2]) + 0.5f);
-									temp2 = (int)((dirF-1.0f)*(srcpnY[x-3]) + (1.5f-dirF)*(srcpnY[x-2]) + 0.5f);
-									temp = (int)((dirF-1.0f)*(srcppY[x+3]+srcpnY[x-3]) + (1.5f-dirF)*(srcppY[x+2]+srcpnY[x-2]) + 0.5f);
-								}
-							}
-							else 
-							{
-								temp1 = (int)((dirF-0.5f)*(srcppY[x+2]) + (1.0f-dirF)*(srcppY[x+1]) + 0.5f);
-								temp2 = (int)((dirF-0.5f)*(srcpnY[x-2]) + (1.0f-dirF)*(srcpnY[x-1]) + 0.5f);
-								temp = (int)((dirF-0.5f)*(srcppY[x+2]+srcpnY[x-2]) + (1.0f-dirF)*(srcppY[x+1]+srcpnY[x-1]) + 0.5f);
-							}
-						}
-						else 
-						{
-							temp1 = (int)(dirF*(srcppY[x+1]) + (0.5f-dirF)*(srcppY[x]) + 0.5f);
-							temp2 = (int)(dirF*(srcpnY[x-1]) + (0.5f-dirF)*(srcpnY[x]) + 0.5f);
-							temp = (int)(dirF*(srcppY[x+1]+srcpnY[x-1]) + (0.5f-dirF)*(srcppY[x]+srcpnY[x]) + 0.5f);
-						}
-					}
-					else
-					{
-						if (dirF &lt;= -0.5f)
-						{
-							if (dirF &lt;= -1.0f)
-							{
-								if (dirF &lt;= -1.5f)
-								{
-									if (dirF &lt;= -2.0f)
-									{
-										if (dirF &gt;= -2.50f) 
-										{
-											temp1 = srcppY[x-4];
-											temp2 = srcpnY[x+4];
-											temp = (srcppY[x-4]+srcpnY[x+4]+1)&gt;&gt;1;
-										}
-										else 
-										{
-											temp1 = temp2 = srcpnY[x];
-											temp = cubicInt(srcpppY[x],srcppY[x],srcpnY[x],srcpnnY[x]);
-										}
-									}
-									else
-									{
-										temp1 = (int)((-dirF-1.5f)*(srcppY[x-4]) + (2.0f+dirF)*(srcppY[x-3]) + 0.5f);
-										temp2 = (int)((-dirF-1.5f)*(srcpnY[x+4]) + (2.0f+dirF)*(srcpnY[x+3]) + 0.5f);
-										temp = (int)((-dirF-1.5f)*(srcppY[x-4]+srcpnY[x+4]) + (2.0f+dirF)*(srcppY[x-3]+srcpnY[x+3]) + 0.5f);
-									}
-								}
-								else 
-								{
-									temp1 = (int)((-dirF-1.0f)*(srcppY[x-3]) + (1.5f+dirF)*(srcppY[x-2]) + 0.5f);
-									temp2 = (int)((-dirF-1.0f)*(srcpnY[x+3]) + (1.5f+dirF)*(srcpnY[x+2]) + 0.5f);
-									temp = (int)((-dirF-1.0f)*(srcppY[x-3]+srcpnY[x+3]) + (1.5f+dirF)*(srcppY[x-2]+srcpnY[x+2]) + 0.5f);
-								}
-							}
-							else 
-							{
-								temp1 = (int)((-dirF-0.5f)*(srcppY[x-2]) + (1.0f+dirF)*(srcppY[x-1]) + 0.5f);
-								temp2 = (int)((-dirF-0.5f)*(srcpnY[x+2]) + (1.0f+dirF)*(srcpnY[x+1]) + 0.5f);
-								temp = (int)((-dirF-0.5f)*(srcppY[x-2]+srcpnY[x+2]) + (1.0f+dirF)*(srcppY[x-1]+srcpnY[x+1]) + 0.5f);
-							}
-						}
-						else 
-						{
-							temp1 = (int)((-dirF)*(srcppY[x-1]) + (0.5f+dirF)*(srcppY[x]) + 0.5f);
-							temp2 = (int)((-dirF)*(srcpnY[x+1]) + (0.5f+dirF)*(srcpnY[x]) + 0.5f);
-							temp = (int)((-dirF)*(srcppY[x-1]+srcpnY[x+1]) + (0.5f+dirF)*(srcppY[x]+srcpnY[x]) + 0.5f);
-						}
-					}
-					maxN = max(srcppY[x],srcpnY[x]) + 25;
-					minN = min(srcppY[x],srcpnY[x]) - 25;
-					if (abs(temp1-temp2) &gt; 20 || abs(srcppY[x]+srcpnY[x]-temp-temp) &gt; 60 || temp &lt; minN || temp &gt; maxN)
-					{
-						temp = cubicInt(srcpppY[x],srcppY[x],srcpnY[x],srcpnnY[x]);
-					}
-					if (temp &gt; 255) temp = 255;
-					else if (temp &lt; 0) temp = 0;
-					dstpY[x] = temp;
-				}
-				else
-				{
-					if (y&lt;3 || y&gt;HeightY-4) dstpY[x] = (srcpnY[x]+srcppY[x]+1)&gt;&gt;1;
-					else dstpY[x] = cubicInt(srcpppY[x],srcppY[x],srcpnY[x],srcpnnY[x]);
-				}
-			}
-		}
-		prvpY += prv_pitchY;
-		srcpppY += src_pitchY;
-		srcppY += src_pitchY;
-		srcpY += src_pitchY;
-		srcpnY += src_pitchY;
-		srcpnnY += src_pitchY;
-		nxtpY += nxt_pitchY;
-		maskpY += mask_pitchY;
-		dstpY += dst_pitchY;
-	}
-	for (y=0; y&lt;HeightUV; ++y)
-	{
-		for (x=0; x&lt;WidthUV; ++x)
-		{
-			if (maskpV[x] == 10 || maskpV[x] == 110) dstpV[x] = srcpV[x];
-			else if (maskpV[x] == 20 || maskpV[x] == 120) dstpV[x] = prvpV[x];
-			else if (maskpV[x] == 30 || maskpV[x] == 130) dstpV[x] = nxtpV[x];
-			else if (maskpV[x] == 40) dstpV[x] = (srcpV[x]+nxtpV[x]+1)&gt;&gt;1;
-			else if (maskpV[x] == 50) dstpV[x] = (srcpV[x]+prvpV[x]+1)&gt;&gt;1;
-			else if (maskpV[x] == 60)
-			{
-				if (y&lt;3 || y&gt;HeightUV-4) dstpV[x] = (srcpnV[x]+srcppV[x]+1)&gt;&gt;1;
-				else dstpV[x] = cubicInt(srcpppV[x],srcppV[x],srcpnV[x],srcpnnV[x]);
-			}
-			if (maskpU[x] == 10 || maskpU[x] == 110) dstpU[x] = srcpU[x];
-			else if (maskpU[x] == 20 || maskpU[x] == 120) dstpU[x] = prvpU[x];
-			else if (maskpU[x] == 30 || maskpU[x] == 130) dstpU[x] = nxtpU[x];
-			else if (maskpU[x] == 40) dstpU[x] = (srcpU[x]+nxtpU[x]+1)&gt;&gt;1;
-			else if (maskpU[x] == 50) dstpU[x] = (srcpU[x]+prvpU[x]+1)&gt;&gt;1;
-			else if (maskpU[x] == 60)
-			{
-				if (y&lt;3 || y&gt;HeightUV-4) dstpU[x] = (srcpnU[x]+srcppU[x]+1)&gt;&gt;1;
-				else dstpU[x] = cubicInt(srcpppU[x],srcppU[x],srcpnU[x],srcpnnU[x]);
-			}
-		}
-		prvpV += prv_pitchUV;
-		prvpU += prv_pitchUV;
-		srcpppV += src_pitchUV;
-		srcppV += src_pitchUV;
-		srcpV += src_pitchUV;
-		srcpnV += src_pitchUV;
-		srcpnnV += src_pitchUV;
-		srcpppU += src_pitchUV;
-		srcppU += src_pitchUV;
-		srcpU += src_pitchUV;
-		srcpnU += src_pitchUV;
-		srcpnnU += src_pitchUV;
-		nxtpV += nxt_pitchUV;
-		nxtpU += nxt_pitchUV;
-		maskpV += mask_pitchUV;
-		maskpU += mask_pitchUV;
-		dstpV += dst_pitchUV;
-		dstpU += dst_pitchUV;
-	}
-}
-
-void vidTDeint::createWeaveFrameYV12(ADMImage *dst, ADMImage *prv, 
-		ADMImage *src, ADMImage *nxt)
-{
-	int b;
-	ADM_PLANE plane;
-	for (b=0; b&lt;3; ++b)
-	{
-		if (b == 0) plane = PLANAR_Y;
-		else if (b == 1) plane = PLANAR_V;
-		else plane = PLANAR_U;
-		if (PRM(field)^PRM(order))
-		{
-			if (accumP &lt;= accumN)
-			{
-				BitBlit(dst-&gt;GetWritePtr(plane), dst-&gt;GetPitch(plane), src-&gt;GetReadPtr(plane), 
-					src-&gt;GetPitch(plane), src-&gt;GetRowSize(plane), src-&gt;GetHeight(plane));
-			}
-			else
-			{
-				BitBlit(dst-&gt;GetWritePtr(plane)+(1-PRM(field))*dst-&gt;GetPitch(plane), dst-&gt;GetPitch(plane)&lt;&lt;1,
-					src-&gt;GetReadPtr(plane)+(1-PRM(field))*src-&gt;GetPitch(plane), src-&gt;GetPitch(plane)&lt;&lt;1, 
-					src-&gt;GetRowSize(plane), src-&gt;GetHeight(plane)&gt;&gt;1);
-				BitBlit(dst-&gt;GetWritePtr(plane)+PRM(field)*dst-&gt;GetPitch(plane), dst-&gt;GetPitch(plane)&lt;&lt;1, 
-					nxt-&gt;GetReadPtr(plane)+PRM(field)*nxt-&gt;GetPitch(plane), nxt-&gt;GetPitch(plane)&lt;&lt;1, nxt-&gt;GetRowSize(plane),
-					nxt-&gt;GetHeight(plane)&gt;&gt;1);
-			}
-		}
-		else
-		{
-			if (accumN &lt;= accumP)
-			{
-				BitBlit(dst-&gt;GetWritePtr(plane), dst-&gt;GetPitch(plane), src-&gt;GetReadPtr(plane), 
-					src-&gt;GetPitch(plane), src-&gt;GetRowSize(plane), src-&gt;GetHeight(plane));
-			}
-			else
-			{
-				BitBlit(dst-&gt;GetWritePtr(plane)+(1-PRM(field))*dst-&gt;GetPitch(plane), dst-&gt;GetPitch(plane)&lt;&lt;1,
-					src-&gt;GetReadPtr(plane)+(1-PRM(field))*src-&gt;GetPitch(plane), src-&gt;GetPitch(plane)&lt;&lt;1, 
-					src-&gt;GetRowSize(plane), src-&gt;GetHeight(plane)&gt;&gt;1);
-				BitBlit(dst-&gt;GetWritePtr(plane)+PRM(field)*dst-&gt;GetPitch(plane), dst-&gt;GetPitch(plane)&lt;&lt;1, 
-					prv-&gt;GetReadPtr(plane)+PRM(field)*prv-&gt;GetPitch(plane), prv-&gt;GetPitch(plane)&lt;&lt;1, prv-&gt;GetRowSize(plane),
-					prv-&gt;GetHeight(plane)&gt;&gt;1);
-			}
-		}
-	}
-}
-
-//*********************************************************
-//*********************************************************
-//*********************************************************
-//*********************************************************
-int vidTDeint::getHint(ADMImage *src, unsigned int &amp;storeHint, int &amp;hintfield)
-{
-	hintfield = -1;
-	const unsigned char *p = YPLANE(src); //src-&gt;GetReadPtr(PLANAR_Y);
-	unsigned int i, magic_number = 0, hint = 0;
-	storeHint = 0xFFFFFFFF;
-	for (i=0; i&lt;32; ++i)
-	{
-		magic_number |= ((*p++ &amp; 1) &lt;&lt; i);
-	}
-	if (magic_number != 0xdeadbeef &amp;&amp; magic_number != 0xdeadfeed) return -1;
-	for (i=0; i&lt;32; ++i)
-	{
-		hint |= ((*p++ &amp; 1) &lt;&lt; i);
-	}
-	if (magic_number == 0xdeadbeef &amp;&amp; hint&amp;0xFFFFFF00) return -1;
-	if (magic_number == 0xdeadfeed &amp;&amp; hint&amp;0xFFFFFF00) return -1;
-	storeHint = hint;
-	if (magic_number == 0xdeadbeef)
-	{
-		storeHint |= 0x00100000;
-		if (hint&amp;0x00000001) return 0;
-		return 1;
-	}
-	if (hint&amp;0x00000008) hintfield = 1;
-	else hintfield = 0;
-	if (hint&amp;0x00000010) return 1;
-	return 0;
-}
-
-void vidTDeint::putHint(ADMImage *src, unsigned int hint, int fieldt)
-{
-	int type = hint&amp;0x00100000 ? 0 : 1;
-	hint &amp;= ~0x00100000;
-	if (hint&amp;0xFFFFFF00) return;
-	if (type == 1)
-	{
-		hint &amp;= 0x00000020;
-		if (fieldt == 1) hint |= 0x0000000E;
-		else hint |= 0x00000005;
-	}
-	unsigned char *p = YPLANE(src); //src-&gt;GetWritePtr(PLANAR_Y);
-	unsigned int i;
-	for (i=0; i&lt;32; ++i)
-	{
-		*p &amp;= ~1;
-		if (type == 0) *p++ |= ((0xdeadbeef &amp; (1 &lt;&lt; i)) &gt;&gt; i);
-		else *p++ |= ((0xdeadfeed &amp; (1 &lt;&lt; i)) &gt;&gt; i);
-	}
-	for (i=0; i&lt;32; ++i)
-	{
-		*p &amp;= ~1;
-		*p++ |= ((hint &amp; (1 &lt;&lt; i)) &gt;&gt; i);
-	}
-}
-/****************************************/
-void vidTDeint::copyFrame(ADMImage *dst,ADMImage *src)
-{
-	int b, stop =  3 ;
-	ADM_PLANE plane[3] = { PLANAR_Y, PLANAR_U, PLANAR_V };
-	for (b=0; b&lt;stop; ++b)
-	{
-		BitBlit(dst-&gt;GetWritePtr(plane[b]),dst-&gt;GetPitch(plane[b]),src-&gt;GetReadPtr(plane[b]),
-			src-&gt;GetPitch(plane[b]),src-&gt;GetRowSize(plane[b]),src-&gt;GetHeight(plane[b]));
-	}
-}
-/****************************************/
-  void vidTDeint::copyForUpsize(ADMImage *dst, ADMImage *src, int np)
-{
-	int b;
-	ADM_PLANE plane[3] = { PLANAR_Y, PLANAR_U, PLANAR_V };
-	for (b=0; b&lt;np; ++b)
-	{
-		BitBlit(dst-&gt;GetWritePtr(plane[b]),dst-&gt;GetPitch(plane[b])*2,src-&gt;GetReadPtr(plane[b]),
-			src-&gt;GetPitch(plane[b]),src-&gt;GetRowSize(plane[b]),src-&gt;GetHeight(plane[b]));
-		BitBlit(dst-&gt;GetWritePtr(plane[b])+(dst-&gt;GetPitch(plane[b])*(dst-&gt;GetHeight(plane[b])-1)),
-			dst-&gt;GetPitch(plane[b]),src-&gt;GetReadPtr(plane[b])+(src-&gt;GetPitch(plane[b])*(src-&gt;GetHeight(plane[b])-1)),
-			src-&gt;GetPitch(plane[b]),src-&gt;GetRowSize(plane[b]),1);
-	}	
-}
-/****************************************/
-void vidTDeint::setMaskForUpsize(ADMImage *msk, int np)
-{
-	unsigned char *maskwc, *maskwn;
-	int msk_pitch, height, width, y;
-	int b;
-	ADM_PLANE plane[3] = { PLANAR_Y, PLANAR_U, PLANAR_V };
-	for (b=0; b&lt;np; ++b)
-	{
-		maskwc = msk-&gt;GetWritePtr(plane[b]);
-		msk_pitch = msk-&gt;GetPitch(plane[b]);
-		height = msk-&gt;GetHeight(plane[b])&gt;&gt;1;
-		width = msk-&gt;GetRowSize(plane[b]);
-		maskwn = maskwc + msk_pitch;
-		msk_pitch &lt;&lt;= 1;
-		if (PRM(field) == 1)
-		{
-			for (y=0; y&lt;height-1; ++y)
-			{
-				memset(maskwc, 10, width);
-				memset(maskwn, 60, width);
-				maskwc += msk_pitch;
-				maskwn += msk_pitch;
-			}
-			memset(maskwc, 10, width);
-			memset(maskwn, 10, width);
-		}
-		else
-		{
-			memset(maskwc, 10, width);
-			memset(maskwn, 10, width);
-			for (y=0; y&lt;height-1; ++y)
-			{
-				maskwc += msk_pitch;
-				maskwn += msk_pitch;
-				memset(maskwc, 60, width);
-				memset(maskwn, 10, width);
-			}
-		}
-	}
-}
-//**************************************
-void vidTDeint::apPostCheck(ADMImage *dst, ADMImage *mask)
-{
-	ADMImage * maskt;
-	if (APType &gt; 0)
-	{
-		maskt = scratch; //_env-&gt;NewVideoFrame(vi);
-		copyFrame(maskt, mask);
-	}
-	unsigned char *maskw;
-	const unsigned char *dstp, *dstpp, *dstpn, *dstppp, *dstpnn, *maskp, *maskpT;
-	int dst_pitch, dst_pitch2, mask_pitch, mask_pitch2, Width, Height;
-	int x, y, b, stop =3 , count = 0, maskp_pitch, maskp_pitch2;
-	int sFirst, sSecond, AP6 = AP*6, moving, neighbors, u, v;
-	int starty, stopy, startx, stopx, inc;
-	ADM_PLANE plane;
-	
-	for (b=0; b&lt;stop; ++b)
-	{
-		if (b == 0) plane = PLANAR_Y;
-		else if (b == 1) plane = PLANAR_U;
-		else plane = PLANAR_V;
-		dstp = dst-&gt;GetReadPtr(plane);
-		dst_pitch = dst-&gt;GetPitch(plane);
-		dst_pitch2 = dst_pitch&lt;&lt;1;
-		Width = dst-&gt;GetRowSize(plane);
-		Height = dst-&gt;GetHeight(plane);
-		dstp += (2-PRM(field))*dst_pitch;
-		dstppp = dstp - dst_pitch2;
-		dstpp = dstp - dst_pitch;
-		dstpn = dstp + dst_pitch;
-		dstpnn = dstp + dst_pitch2;
-		maskw = mask-&gt;GetWritePtr(plane);
-		mask_pitch = mask-&gt;GetPitch(plane);
-		mask_pitch2 = mask_pitch&lt;&lt;1;
-		if (APType &gt; 0)
-		{
-			maskp = maskt-&gt;GetReadPtr(plane);
-			maskp_pitch = maskt-&gt;GetPitch(plane);
-			maskp_pitch2 = maskp_pitch&lt;&lt;1;
-		}
-		maskw += (2-PRM(field))*mask_pitch;
-		y = 2-PRM(field);
-		for (x=0; x&lt;Width; ++x)
-		{
-			if (maskw[x] == 60) { maskw[x] = 10; continue; };
-			maskw[x] = 10;
-			sFirst = dstp[x] - dstpp[x];
-			sSecond = dstp[x] - dstpn[x];
-			if ((sFirst &gt; AP &amp;&amp; sSecond &gt; AP) || (sFirst &lt; -AP &amp;&amp; sSecond &lt; -AP))
-			{
-				sFirst = abs(dstpnn[x]+(dstp[x]&lt;&lt;2)+dstpnn[x]-(3*(dstpp[x]+dstpn[x])));
-				if (sFirst &gt; AP6) 
-				{
-					if (APType &gt; 0)
-					{
-						inc = stop &gt; 1 ? 1 : x&amp;1 ? 4 : 2;
-						startx = x-(inc&lt;&lt;1) &lt; 0 ? x-inc &lt; 0 ? x : x-inc : x-(inc&lt;&lt;1);
-						stopx = x+(inc&lt;&lt;1) &gt; Width-1 ? x+inc &gt; Width-1 ? x : x+inc : x+(inc&lt;&lt;1);
-						starty = y-4 &lt; 0 ? y-2 &lt; 0 ? y : y-2 : y-4;
-						stopy = y+4 &gt; Height-1 ? y+2 &gt; Height-1 ? y : y+2 : y+4;
-						neighbors = moving = 0;
-						maskpT = maskp + starty*maskp_pitch;
-						for (u=starty; u&lt;=stopy; u+=2)
-						{
-							for (v=startx; v&lt;=stopx; v+=inc)
-							{
-								if (maskpT[v] &gt;= 60) ++moving;
-								++neighbors;
-							}
-							maskpT += maskp_pitch2;
-						}
-						if ((APType == 1 &amp;&amp; (moving&lt;&lt;1) &gt;= neighbors) ||
-							(APType == 2 &amp;&amp; (moving*3)  &gt;= neighbors))
-						{
-							maskw[x] = 60;
-							++count;
-						}
-					}
-					else
-					{
-						maskw[x] = 60;
-						++count;
-					}
-				}
-			}
-		}
-		dstppp += dst_pitch2;
-		dstpp += dst_pitch2;
-		dstp += dst_pitch2;
-		dstpn += dst_pitch2;
-		dstpnn += dst_pitch2;
-		maskw += mask_pitch2;
-		y += 2;
-		for (; y&lt;Height-3; y+=2)
-		{
-			starty = y-4 &lt; 0 ? y-2 &lt; 0 ? y : y-2 : y-4;
-			stopy = y+4 &gt; Height-1 ? y+2 &gt; Height-1 ? y : y+2 : y+4;
-			for (x=0; x&lt;Width; ++x)
-			{
-				if (maskw[x] == 60) { maskw[x] = 10; continue; }
-				maskw[x] = 10;
-				sFirst = dstp[x] - dstpp[x];
-				sSecond = dstp[x] - dstpn[x];
-				if ((sFirst &gt; AP &amp;&amp; sSecond &gt; AP) || (sFirst &lt; -AP &amp;&amp; sSecond &lt; -AP))
-				{
-					sFirst = abs(dstppp[x]+(dstp[x]&lt;&lt;2)+dstpnn[x]-(3*(dstpp[x]+dstpn[x])));
-					if (sFirst &gt; AP6) 
-					{ 
-						if (APType &gt; 0)
-						{
-							inc = stop &gt; 1 ? 1 : x&amp;1 ? 4 : 2;
-							startx = x-(inc&lt;&lt;1) &lt; 0 ? x-inc &lt; 0 ? x : x-inc : x-(inc&lt;&lt;1);
-							stopx = x+(inc&lt;&lt;1) &gt; Width-1 ? x+inc &gt; Width-1 ? x : x+inc : x+(inc&lt;&lt;1);
-							neighbors = moving = 0;
-							maskpT = maskp + starty*maskp_pitch;
-							for (u=starty; u&lt;=stopy; u+=2)
-							{
-								for (v=startx; v&lt;=stopx; v+=inc)
-								{
-									if (maskpT[v] &gt;= 60) ++moving;
-									++neighbors;
-								}
-								maskpT += maskp_pitch2;
-							}
-							if ((APType == 1 &amp;&amp; (moving&lt;&lt;1) &gt;= neighbors) ||
-								(APType == 2 &amp;&amp; (moving*3)  &gt;= neighbors))
-							{
-								maskw[x] = 60;
-								++count;
-							}
-						}
-						else
-						{
-							maskw[x] = 60;
-							++count;
-						}
-					}
-				}	
-			}
-			dstppp += dst_pitch2;
-			dstpp += dst_pitch2;
-			dstp += dst_pitch2;
-			dstpn += dst_pitch2;
-			dstpnn += dst_pitch2;
-			maskw += mask_pitch2;
-		}
-		for (x=0; x&lt;Width; ++x)
-		{
-			if (maskw[x] == 60) { maskw[x] = 10; continue; }
-			maskw[x] = 10;
-			sFirst = dstp[x] - dstpp[x];
-			sSecond = dstp[x] - dstpn[x];
-			if ((sFirst &gt; AP &amp;&amp; sSecond &gt; AP) || (sFirst &lt; -AP &amp;&amp; sSecond &lt; -AP))
-			{
-				sFirst = abs(dstppp[x]+(dstp[x]&lt;&lt;2)+dstppp[x]-(3*(dstpp[x]+dstpn[x])));
-				if (sFirst &gt; AP6) 
-				{ 
-					if (APType &gt; 0)
-					{
-						inc = stop &gt; 1 ? 1 : x&amp;1 ? 4 : 2;
-						startx = x-(inc&lt;&lt;1) &lt; 0 ? x-inc &lt; 0 ? x : x-inc : x-(inc&lt;&lt;1);
-						stopx = x+(inc&lt;&lt;1) &gt; Width-1 ? x+inc &gt; Width-1 ? x : x+inc : x+(inc&lt;&lt;1);
-						starty = y-4 &lt; 0 ? y-2 &lt; 0 ? y : y-2 : y-4;
-						stopy = y+4 &gt; Height-1 ? y+2 &gt; Height-1 ? y : y+2 : y+4;
-						neighbors = moving = 0;
-						maskpT = maskp + starty*maskp_pitch;
-						for (u=starty; u&lt;=stopy; u+=2)
-						{
-							for (v=startx; v&lt;=stopx; v+=inc)
-							{
-								if (maskpT[v] &gt;= 60) ++moving;
-								++neighbors;
-							}
-							maskpT += maskp_pitch2;
-						}
-						if ((APType == 1 &amp;&amp; (moving&lt;&lt;1) &gt;= neighbors) ||
-							(APType == 2 &amp;&amp; (moving*3)  &gt;= neighbors))
-						{
-							maskw[x] = 60;
-							++count;
-						}
-					}
-					else
-					{
-						maskw[x] = 60;
-						++count;
-					}
-				}
-			}
-		}
-	}
-	if (count &gt; 0)
-	{
-		//if (vi.IsYV12())
-		{
-			if (type == 0) cubicDeintYV12(dst, mask, dst, dst, dst);
-			else if (type == 1) smartELADeintYV12(dst, mask, dst, dst, dst);
-			else if (type == 2) kernelDeintYV12(dst, mask, dst, dst, dst);
-			else if (type == 3) ELADeintYV12(dst, mask, dst, dst, dst);
-		}
-		
-	}
-}
-

Modified: branches/avidemux_2.4_branch/avidemux/ADM_video/CMakeLists.txt
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/CMakeLists.txt	2007-06-17 15:31:18 UTC (rev 3267)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/CMakeLists.txt	2007-06-17 15:43:29 UTC (rev 3268)
@@ -1,11 +1,35 @@
 SET(ADM_video_SRCS 
-ADM_cache.cpp                  ADM_vidCNR2.cpp       ADM_vidFieldUnblend.cpp  ADM_vidPartial.cpp    ADM_vidTdeint.cpp
-ADM_confCouples.cpp            ADM_vidColorYuv.cpp   ADM_vidFieldUtil.cpp     ADM_vidRaw.cpp        ADM_vidUnblend.cpp
-ADM_genvideo.cpp         ADM_vidAnimated.cpp     ADM_vidContrast.cpp   ADM_vidFont.cpp          ADM_vidResize25.cpp   ADM_vidVobsub.cpp
- ADM_vidAsharp.cpp       ADM_vidCrop.cpp       ADM_vidHue.cpp               ADM_vidVobSubRender.cpp
-ADM_interlaced.cpp       ADM_vidCached.cpp       ADM_vidDelta.cpp      ADM_vidMPdelogo.cpp      ADM_vidSRT.cpp        ADM_vobsubinfo.cpp
-   ADM_vidChromaShift.cpp  ADM_vidEq2.cpp        ADM_vidMPLResize.cpp     ADM_vidSRTload.cpp
-ADM_vidClean.cpp        ADM_vidEqualizer.cpp  ADM_vidNull.cpp          ADM_vidSRTRender.cpp
+ADM_cache.cpp                  
+ADM_vidCNR2.cpp       
+ADM_vidFieldUnblend.cpp  
+ADM_vidPartial.cpp    
+ADM_confCouples.cpp            
+ADM_vidColorYuv.cpp   
+ADM_vidFieldUtil.cpp     
+ADM_vidRaw.cpp        
+ADM_vidUnblend.cpp
+ADM_genvideo.cpp         
+ADM_vidAnimated.cpp     
+ADM_vidContrast.cpp   
+ADM_vidFont.cpp
+ADM_vidVobsub.cpp
+ADM_vidAsharp.cpp       
+ADM_vidCrop.cpp       
+ADM_vidHue.cpp               
+ADM_vidVobSubRender.cpp
+ADM_interlaced.cpp       
+ADM_vidCached.cpp       
+ADM_vidDelta.cpp      
+ADM_vidMPdelogo.cpp      
+ADM_vidSRT.cpp        
+ADM_vobsubinfo.cpp
+ADM_vidChromaShift.cpp  
+ADM_vidEq2.cpp             
+ADM_vidSRTload.cpp
+ADM_vidClean.cpp        
+ADM_vidEqualizer.cpp  
+ADM_vidNull.cpp          
+ADM_vidSRTRender.cpp
 )
 ADD_LIBRARY(ADM_video STATIC ${ADM_video_SRCS})
 if(FT_FOUND)

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidMPLResize.cpp (from rev 3261, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidMPLResize.cpp)

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidResize25.cpp (from rev 3261, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidResize25.cpp)

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidTDeint_param.h (from rev 3261, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTDeint_param.h)

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidTdeint.cpp (from rev 3261, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTdeint.cpp)

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidTdeint_util.txt (from rev 3261, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidTdeint_util.txt)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/CMakeLists.txt
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/CMakeLists.txt	2007-06-17 15:31:18 UTC (rev 3267)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/CMakeLists.txt	2007-06-17 15:43:29 UTC (rev 3268)
@@ -18,5 +18,8 @@
 ADM_vidSwapFields.cpp
 ADM_vidYadif_asm.c
 ADM_guiResize.cpp  ADM_resizebis.cpp  ADM_resizeter.cpp  ADM_vidResize.cpp
+ADM_vidMPLResize.cpp  
+ADM_vidResize25.cpp
+ADM_vidTdeint.cpp
 )
 ADD_LIBRARY(ADM_videoFilter STATIC ${ADM_videoFilter_SRCS})


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000556.html">[Avidemux-svn-commit] r3267 - in	branches/avidemux_2.4_branch/avidemux: ADM_video ADM_videoFilter
</A></li>
	<LI>Next message: <A HREF="000558.html">[Avidemux-svn-commit] r3269 - branches/avidemux_2.4_branch/po
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#557">[ date ]</a>
              <a href="thread.html#557">[ thread ]</a>
              <a href="subject.html#557">[ subject ]</a>
              <a href="author.html#557">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
