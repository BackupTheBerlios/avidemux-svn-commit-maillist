<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r3267 - in	branches/avidemux_2.4_branch/avidemux: ADM_video ADM_videoFilter
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2007-June/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3267%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%20ADM_video%20ADM_videoFilter&In-Reply-To=%3C200706171531.l5HFVJGs026423%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000555.html">
   <LINK REL="Next"  HREF="000557.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r3267 - in	branches/avidemux_2.4_branch/avidemux: ADM_video ADM_videoFilter</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3267%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%20ADM_video%20ADM_videoFilter&In-Reply-To=%3C200706171531.l5HFVJGs026423%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r3267 - in	branches/avidemux_2.4_branch/avidemux: ADM_video ADM_videoFilter">mean at mail.berlios.de
       </A><BR>
    <I>Sun Jun 17 17:31:19 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000555.html">[Avidemux-svn-commit] r3265 -	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory
</A></li>
        <LI>Next message: <A HREF="000557.html">[Avidemux-svn-commit] r3268 - in	branches/avidemux_2.4_branch/avidemux:	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_commonUI ADM_video ADM_videoFilter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#556">[ date ]</a>
              <a href="thread.html#556">[ thread ]</a>
              <a href="subject.html#556">[ subject ]</a>
              <a href="author.html#556">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2007-06-17 17:31:18 +0200 (Sun, 17 Jun 2007)
New Revision: 3267

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_guiResize.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_resizebis.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_resizebis.hxx
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_resizeter.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidResize.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADMmpdetc.cpp
Removed:
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_guiResize.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_mpdetc.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizebis.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizebis.hxx
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizeter.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidResize.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_video/CMakeLists.txt
   branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/CMakeLists.txt
Log:
move files in proper subdirs

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_guiResize.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_guiResize.cpp	2007-06-17 13:36:53 UTC (rev 3266)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_guiResize.cpp	2007-06-17 15:31:18 UTC (rev 3267)
@@ -1,109 +0,0 @@
-/***************************************************************************
-                          ADM_guiResize.cpp  -  description
-                             -------------------
-
-GUI part of resize.
-			     
-    begin                : Thu Mar 21 2002
-    copyright            : (C) 2002 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#include &quot;config.h&quot;
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-
-#include &lt;time.h&gt;
-#include &lt;sys/time.h&gt;
-#include &quot;config.h&quot;
-#include &quot;fourcc.h&quot;
-#include &quot;avio.hxx&quot;
-
-#include &quot;avi_vars.h&quot;
-#ifdef HAVE_ENCODER
-
-
-#include &quot;ADM_editor/ADM_edit.hxx&quot;
-#include &quot;ADM_video/ADM_genvideo.hxx&quot;
-#include &quot;ADM_video/ADM_resizebis.hxx&quot;
-#include &quot;ADM_video/ADM_vidCommonFilter.h&quot;
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-#include &lt;ADM_assert.h&gt;
-
-
-static int getResizeParams(uint32_t * w, uint32_t * h, uint32_t * algo,uint32_t w,uint32_t h,uint32_t fps);
-
-
-extern uint8_t DIA_resize(uint32_t *width,uint32_t *height,uint32_t *algo,uint32_t originalw, uint32_t originalh,uint32_t fps1000);
-
-uint8_t AVDMVideoStreamResize::configure(AVDMGenericVideoStream * instream)
-{
-    UNUSED_ARG(instream);
-
-    RESIZE_PARAMS *par;
-//    uint8_t ret=0;
-
-    _init = 0;			// force recompute
-    par = _param;
-
-
-
-    if (!getResizeParams(&amp;par-&gt;w, &amp;par-&gt;h, &amp;par-&gt;algo,instream-&gt;getInfo()-&gt;width,instream-&gt;getInfo()-&gt;height,_info.fps1000))
-      {
-	  return 0;
-      }
-      printf(&quot;\n OK was selected \n&quot;);
-    // update other parameters
-    _info.width = _param-&gt;w;
-    _info.height = _param-&gt;h;
-    // intermediate buffer
-    if (_intermediate_buffer)
-      {
-	  delete  [] _intermediate_buffer;
-	  _intermediate_buffer = NULL;
-      }
-    //_intermediate_buffer=(uint8_t *)malloc(3*_info.width*_in-&gt;getInfo()-&gt;height);
-    _intermediate_buffer =
-	new uint8_t[3 * _info.width * _in-&gt;getInfo()-&gt;height];
-
-    return 1;
-
-}
-
-//
-//  
-//
-//
-//   static GtkWidget *resi;
-int getResizeParams(uint32_t * w, uint32_t * h, uint32_t * algo,uint32_t ow,uint32_t oh,uint32_t fps)
-{
-uint32_t ww,hh;
-	while(1)
-	{
-		ww=*w;
-		hh=*h;
-  		if(!DIA_resize(&amp;ww,&amp;hh,algo,ow,oh,fps)) return 0;
-                if(!ww || !hh) GUI_Error_HIG(_(&quot;Width and height cannot be 0&quot;), NULL);
-		else
-                  if( ww&amp;1 || hh &amp;1) GUI_Error_HIG(_(&quot;Width and height cannot be odd&quot;), NULL);
-			else
-			{
-				*w=ww;
-				*h=hh;
-				return 1;
-			}
-	}
-}
-
-
-#endif

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_mpdetc.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_mpdetc.cpp	2007-06-17 13:36:53 UTC (rev 3266)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_mpdetc.cpp	2007-06-17 15:31:18 UTC (rev 3267)
@@ -1,755 +0,0 @@
-//
-//
-// C++ Implementation: ADM_mpdetc
-//
-// Description: 
-//
-//	This is a port of mplayer ivtc filter by Richard 
-//	Copyright Richard Felker
-//
-// Author:Richard Felker, port to avidemux2 by  mean &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>&gt;, (C) 2003
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-//
-#define HAVE_DETC
-#ifdef HAVE_DETC
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;ADM_assert.h&gt;
-
-#include &quot;config.h&quot;
-
-#include &quot;ADM_lavcodec.h&quot;
-
-#include &quot;fourcc.h&quot;
-#include &quot;avio.hxx&quot;
-#include &quot;config.h&quot;
-#include &quot;avi_vars.h&quot;
-
-
-
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-#include &quot;ADM_editor/ADM_edit.hxx&quot;
-#include &quot;ADM_video/ADM_genvideo.hxx&quot;
-#include &quot;ADM_video/ADM_mpdetc.h&quot;
-
-#include &quot;ADM_osSupport/ADM_debugID.h&quot;
-#define MODULE_NAME MODULE_FILTER
-#include &quot;ADM_osSupport/ADM_debug.h&quot;
-
-
-//static void decimate(uint8_t *src,uint8_t *target, uint32_t linessrc, uint32_t width);
-#include &quot;ADM_filter/video_filters.h&quot;
-
-
-static FILTER_PARAM flipParam={0,{&quot;&quot;}};
-
-
-SCRIPT_CREATE(mpdetc_script,AVDMVideoMPDetc,flipParam);
-BUILD_CREATE(mpdetc_create,AVDMVideoMPDetc);
-
-
-void 		*my_memcpy_pic(uint8_t * dst, uint8_t * src, int bytesPerLine, int height, 
-						int dstStride, int srcStride);
-unsigned int 	hash_pic(unsigned char *img, int w, int h, int stride);
-static void 	block_diffs_C(struct metrics *m, unsigned char *old, unsigned char *nw, int os, int ns);
-#if defined( ARCH_X86)  || defined(ARCH_X86_64)
-void block_diffs_MMX(struct metrics *m, unsigned char *old, unsigned char *ew, int os, int ns);
-#endif
-static void 	diff_planes(struct metrics *m, unsigned char *old, unsigned char *nw, int w, int h, int os, int ns);
-static void 	diff_fields(struct frameinfo *fi, uint8_t  *old, uint8_t  *nw);
-static void 	status(struct frameinfo *f);
-static void 	copy_image(ADMImage  *sdest, ADMImage  *ssrc, int field);
-
-static uint32_t 	myw,myh;
-static struct vf_priv_s *myparam; // UGLY FIXME BURK
-
-
-
-
-char *AVDMVideoMPDetc::printConf( void )
-{
- 	static char buf[50];
-
- 	sprintf((char *)buf,&quot; Mplayer ivtc&quot;);
-        return buf;
-}
-
-//_______________________________________________________________
-AVDMVideoMPDetc::AVDMVideoMPDetc(
-				AVDMGenericVideoStream *in,CONFcouple *setup)
-{
-UNUSED_ARG(setup);
-  	_in=in;
-   	memcpy(&amp;_info,_in-&gt;getInfo(),sizeof(_info));
-	
-	// We alter frame rate here and # of frames
-	aprintf(&quot;Frame in : %lu fpsin: %lu\n&quot;,_info.nb_frames,_info.fps1000);
-	_info.fps1000=(_info.fps1000*4)/5;	
-	_info.nb_frames=_info.nb_frames/5;
-	_info.nb_frames=_info.nb_frames*4;
-	aprintf(&quot;Frame out : %lu fpout: %lu\n&quot;,_info.nb_frames,_info.fps1000);
-//	_uncompressed=new uint8_t[(3*_info.width*_info.height)&gt;&gt;1];
-//	_lastFrame=new uint8_t[(3*_info.width*_info.height)&gt;&gt;1];
-	_uncompressed=new ADMImage(_info.width,_info.height);
-	_lastFrame=new ADMImage(_info.width,_info.height);
-	
-	_param=new vf_priv_s;
-	_param-&gt;drop = 0;
-	_param-&gt;first = 1;
-	_inFrame=0;
-	_lastAsked=0xffffff0;
-		
-}
-
-// ___ destructor_____________
-AVDMVideoMPDetc::~AVDMVideoMPDetc()
-{
- 	delete  _uncompressed;
-	delete  _lastFrame;
-	if(myparam)
-	{
-		delete _param;
-		_param=NULL;
-	}
-	
-
-}
-
-int foo(struct vf_priv_s *p, uint8_t  *nw, uint8_t *cur)
-{
-	struct frameinfo *f = p-&gt;fi;
-
-	f[0] = f[1];
-	diff_fields(&amp;(f[1]), cur, nw);
-	status(&amp;(f[1]));
-
-	// Immediately drop this frame if it's already been used.
-	if (p-&gt;dropnext) {
-		p-&gt;dropnext = 0;
-		return F_DROP;
-	}
-	
-	// Sometimes a pulldown frame comes all by itself, so both
-	// its top and bottom field are duplicates from the adjacent
-	// two frames. We can just drop such a frame, but we
-	// immediately show the next frame instead to keep the frame
-	// drops evenly spaced during normal 3:2 pulldown sequences.
-	if ((3*f[1].r.o &lt; f[1].r.e) &amp;&amp; (f[1].r.s &lt; f[1].r.d)) {
-		p-&gt;dropnext = 1;
-		return F_NEXT;
-	}
-	
-	// If none of these conditions hold, we will consider the frame
-	// progressive and just show it as-is.
-	if (!(  (3*f[0].r.e &lt; f[0].r.o) ||
-		((2*f[0].r.d &lt; f[0].r.s) &amp;&amp; (f[0].r.s &gt; 1200)) ||
-		((2*f[1].r.t &lt; f[1].r.p) &amp;&amp; (f[1].r.p &gt; 1200))  ))
-		return F_SHOW;
-
-	// Otherwise, we have to decide whether to merge or drop.
-	// If the noise metric only increases minimally, we're off
-	// to a good start...
-	if (((2*f[1].r.t &lt; 3*f[1].r.p) &amp;&amp; (f[1].r.t &lt; 3600)) ||
-		(f[1].r.t &lt; 900) || (f[1].r.d &lt; 900)) {
-		// ...and if noise decreases or the duplicate even field
-		// is detected, we go ahead with the merge.
-		if ((3*f[0].r.e &lt; f[0].r.o) || (2*f[1].r.t &lt; f[1].r.p)) {
-			p-&gt;dropnext = 1;
-			return F_MERGE;
-		}
-	}
-	return F_DROP;
-}
-
-//
-//	Basically ask a uncompressed frame from editor and ask
-//		GUI to decompress it .
-//
-
-#define clear(x) {memset(x,0,page);memset(x+page,128,page&gt;&gt;1);}
-
-uint8_t AVDMVideoMPDetc::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-uint32_t page=_info.width*_info.height;
-
-		if(frame&gt;=_info.nb_frames) return 0;
-		
-       				
-		myw=_info.width;
-		myh=_info.height; // UGLY!!!
-		myparam=_param;
-		aprintf(&quot;Request for %lu frames (last %lu)\n&quot;,frame,_lastAsked);
-		// First frame or out of order, we copy it to prefill buffer
-		if(_lastAsked+1!=frame) 
-		{
-			// Convert to source filter frame no
-		  uint32_t off;			
-			aprintf(&quot;--Out of order access\n&quot;);
-			off=frame%4;	
-			frame=frame-off;		
-			_inFrame=(frame*5)&gt;&gt;2;
-			// 4 frame -&gt; 5 frame
-			_inFrame+=off;
-			// Init buffer
-			// Clear refimage
-			clear(_lastFrame);	
-			_param-&gt;lastdrop=0;
-			_param-&gt;inframes = 1;
-			_param-&gt;outframes=1;					
-			_param-&gt;first=0;
-			_copy=0;
-			_lastAsked=frame;
-			if(!_in-&gt;getFrameNumberNoAlloc(_inFrame, len,data,flags)) return 0;	
-			return 1;
-		}
-		// Sequential access, we have the previous frame pre-filled		
-		uint8_t frame_ready=0;
-		int off;
-		
-		_lastAsked=frame;
-		while(!frame_ready )
-		{
-			
-			
-			if(!_in-&gt;getFrameNumberNoAlloc(_inFrame, len,_uncompressed,flags))
-			{
-				// be nice and return 1 if it does not seem to stupid
-				if(_param-&gt;inframes*4-_param-&gt;outframes*5 &lt; 30)
-				{
-					_param-&gt;outframes++;
-					printf(&quot;Skew ignored\n&quot;);
-					return 1;
-				}
-				 return 0;
-			}
-		
-			_inFrame++;
-			myparam-&gt;inframes++;
-			off=4*_param-&gt;inframes - 5*(_param-&gt;outframes+1);
-			aprintf(&quot;**** Inframe : %lu / outframe : %lu / Off: %d (in: %lu)\n&quot;,
-				 _param-&gt;inframes,_param-&gt;outframes,off,_inFrame);
-/*				 
-			if(off&gt;11)
-			{
-				_copy=9;
-			}
-			if(_copy)
-			{
-				_copy--;
-				aprintf(&quot;Too much drops!\n&quot;);
-				_param-&gt;outframes++;
-				_param-&gt;lastdrop=0;
-				if(!_copy)
-					copy_image(_lastFrame, _uncompressed, 2);
-				copy_image(data, _uncompressed, 2);
-				
-				return 1;				
-			}				 
-			
-*/			
-			
-			switch (foo(_param, _uncompressed-&gt;data, _lastFrame-&gt;data)) 
-			{
-			case F_DROP:
-				copy_image(_lastFrame, _uncompressed, 2);
-				frame_ready = 0;
-				_param-&gt;lastdrop = 0;
-				aprintf(&quot;MPivtc DROP\n&quot;);				
-				// we are dropping too much frames!
-				if(off&gt;6)
-				{
-					aprintf(&quot;Cancelled dropout!, deinterlacing in place----------\n&quot;);
-					memcpy(data-&gt;data,_lastFrame,(page*3)&gt;&gt;1);
-					frame_ready=1;
-					_param-&gt;outframes++;
-					_param-&gt;dropnext=0;
-					// we deinterlace it in place
-					AVPicture src;
-					uint32_t page=_info.width*_info.height;
-		
-					src.data[0]=data-&gt;data;
-					src.data[1]=data-&gt;data+page;
-					src.data[2]=data-&gt;data+((page*5)&gt;&gt;2);
-  					
-		
-					src.linesize[0]=_info.width;
-					src.linesize[1]=_info.width&gt;&gt;1;
-					src.linesize[2]=_info.width&gt;&gt;1;
-  
-					if (avpicture_deinterlace(&amp;src,&amp;src,
-						PIX_FMT_YUV420P,_info.width,_info.height)&lt;0)
-					{
-						printf(&quot;Error in avpicture deinterlace!\n&quot;);
-						return 0;
-					} 		
-				}
-				
-				break;
-			case F_MERGE:
-				copy_image(_lastFrame, _uncompressed, 0);
-				frame_ready = do_put_image(_lastFrame);
-				if(frame_ready) memcpy(data-&gt;data,_lastFrame-&gt;data,(page*3)&gt;&gt;1);
-				copy_image(_lastFrame, _uncompressed, 1);
-				aprintf(&quot;MPivtc MERGE\n&quot;);
-				//clear(_lastFrame);
-				break;
-			case F_NEXT:
-				copy_image(_lastFrame, _uncompressed, 2);
-				frame_ready = do_put_image(_lastFrame);
-				if(frame_ready) memcpy(data-&gt;data,_lastFrame-&gt;data,(page*3)&gt;&gt;1);
-				aprintf(&quot;MPivtc NEXT\n&quot;);
-				//clear(_lastFrame);
-				break;
-			case F_SHOW:
-				frame_ready = do_put_image(_lastFrame);
-				if(frame_ready) memcpy(data-&gt;data,_lastFrame-&gt;data,(page*3)&gt;&gt;1);
-				copy_image(_lastFrame, _uncompressed, 2);
-				aprintf(&quot;MPivtc OK\n&quot;);
-				//clear(_lastFrame);
-				break;
-			}
-		}
-	if(!frame_ready) return 0;	
-	return 1;
-}
-		
-
-/*
-	Return 1 if ok, 0 if dropped
-*/
-uint8_t AVDMVideoMPDetc::do_put_image(ADMImage *data)
-{
-	int dropflag;
-	int off=0;
-/*
-	switch (_param-&gt;drop &amp;&amp; !_param-&gt;dropnext) 
-	{
-	case 0:
-		dropflag = 0;
-		break;
-	case 1:
-		dropflag = (++_param-&gt;lastdrop &gt;= 5);
-		break;
-	case 2:
-		dropflag = (++_param-&gt;lastdrop &gt;= 5) &amp;&amp; (4*_param-&gt;inframes &lt;= 5*_param-&gt;outframes);
-		break;
-	}
-*/
-	off=4*_param-&gt;inframes - 5*(_param-&gt;outframes+1);
-	aprintf(&quot;Dropnext : %d lastdrop  : %d off : %d \n&quot;,_param-&gt;dropnext,_param-&gt;lastdrop,off);
-		
-	dropflag = ((_param-&gt;dropnext)||(++_param-&gt;lastdrop &gt;= 5)) &amp;&amp; off&lt; 0;
-	
-	if (dropflag) {
-		aprintf(&quot;--&gt;drop! [%d/%d=%g]\n&quot;,
-			_param-&gt;outframes, _param-&gt;inframes, (float)_param-&gt;outframes/_param-&gt;inframes);
-		_param-&gt;lastdrop = 0;
-		return 0;
-	}
-
-	_param-&gt;outframes++;
-	return 1;
-
-
-}
-
-
-
-
-
-
-void *my_memcpy_pic(uint8_t  * dst, uint8_t * src, int bytesPerLine, int height, int dstStride, int srcStride)
-{
-	int i;
-	void *retval=dst;
-
-	for(i=0; i&lt;height; i++)
-	{
-		memcpy(dst, src, bytesPerLine);
-		src+= srcStride;
-		dst+= dstStride;
-	}
-
-	return retval;
-}
-
-unsigned int hash_pic(unsigned char *img, int w, int h, int stride)
-{
-	int step = w*h/1024;
-	unsigned int hash=0;
-	int x=0, y;
-
-	step -= step % 3;
-
-	for (y=0; y&lt;h; y++) {
-		for (; x&lt;w; x+=step) {
-			hash = hash ^ (hash&lt;&lt;4) ^ img[x];
-		}
-		x -= w;
-		img += stride;
-	}
-	
-	return hash;
-}
-#define MAG(a) (((a)^((a)&gt;&gt;31))-((a)&gt;&gt;31))
-#define LOWPASS(s) ((s)[0])
-
-
- void block_diffs_C(struct metrics *m, unsigned char *old, unsigned char *nw, int os, int ns)
-{
-	int x, y, e=0, o=0, s=0, p=0, t=0;
-	unsigned char *oldp, *newp;
-	m-&gt;s = m-&gt;p = m-&gt;t = 0;
-	for (x = 8; x; x--) {
-		oldp = old++;
-		newp = nw++;
-		s = p = t = 0;
-		for (y = 4; y; y--) {
-			e += MAG(newp[0]-oldp[0]);
-			o += MAG(newp[ns]-oldp[os]);
-			s += newp[ns]-newp[0];
-			p += oldp[os]-oldp[0];
-			t += oldp[os]-newp[0];
-			oldp += os&lt;&lt;1;
-			newp += ns&lt;&lt;1;
-		}
-		m-&gt;s += MAG(s);
-		m-&gt;p += MAG(p);
-		m-&gt;t += MAG(t);
-	}
-	m-&gt;e = e;
-	m-&gt;o = o;
-	m-&gt;d = e+o;
-}
-#define MAXUP(a,b) ((a) = ((a)&gt;(b)) ? (a) : (b))
-
-static void diff_planes(struct frameinfo *fi,
-	unsigned char *old, unsigned char *nw, int w, int h, int os, int ns)
-{
-	int x, y;
-	struct metrics l;
-	struct metrics *peak=&amp;fi-&gt;p, *rel=&amp;fi-&gt;r, *mean=&amp;fi-&gt;m;
-	memset(peak, 0, sizeof(struct metrics));
-	memset(rel, 0, sizeof(struct metrics));
-	memset(mean, 0, sizeof(struct metrics));
-	for (y = 0; y &lt; h-7; y += 8) {
-		for (x = 8; x &lt; w-8-7; x += 8) {
-#if 00 //FIXME def USE_MMX	
-	#define block_diffs block_diffs_MMX
-#else
-	#define block_diffs block_diffs_C
-#endif	
-			block_diffs(&amp;l, old+x+y*os, nw+x+y*ns, os, ns);
-			mean-&gt;d += l.d;
-			mean-&gt;e += l.e;
-			mean-&gt;o += l.o;
-			mean-&gt;s += l.s;
-			mean-&gt;p += l.p;
-			mean-&gt;t += l.t;
-			MAXUP(peak-&gt;d, l.d);
-			MAXUP(peak-&gt;e, l.e);
-			MAXUP(peak-&gt;o, l.o);
-			MAXUP(peak-&gt;s, l.s);
-			MAXUP(peak-&gt;p, l.p);
-			MAXUP(peak-&gt;t, l.t);
-			MAXUP(rel-&gt;e, l.e-l.o);
-			MAXUP(rel-&gt;o, l.o-l.e);
-			MAXUP(rel-&gt;s, l.s-l.t);
-			MAXUP(rel-&gt;p, l.p-l.t);
-			MAXUP(rel-&gt;t, l.t-l.p);
-			MAXUP(rel-&gt;d, l.t-l.s); /* hack */
-	
-		}
-	}
-	x = (w/8-2)*(h/8);
-	mean-&gt;d /= x;
-	mean-&gt;e /= x;
-	mean-&gt;o /= x;
-	mean-&gt;s /= x;
-	mean-&gt;p /= x;
-	mean-&gt;t /= x;
-}
-void diff_fields(struct frameinfo *fi, uint8_t  *old, uint8_t  *nw)
-{
-	diff_planes(fi, old, nw,
-		myw, myh, myw, myw);
-}
-
-
-
- void status(struct frameinfo *f)
-{
-	aprintf(&quot;       pd=%d re=%d ro=%d rp=%d rt=%d rs=%d rd=%d pp=%d pt=%d ps=%d\n&quot;,
-		f-&gt;p.d, f-&gt;r.e, f-&gt;r.o, f-&gt;r.p, f-&gt;r.t, f-&gt;r.s, f-&gt;r.d, f-&gt;p.p, f-&gt;p.t, f-&gt;p.s);
-}
-
-
-
-//void copy_image(mp_image_t *dmpi, mp_image_t *mpi, int field)
-void copy_image(ADMImage  *sdest, ADMImage  *ssrc, int field)
-{
-	uint32_t page;
-	page=myw*myh;
-	uint8_t *src,*dest;
-	src=ssrc-&gt;data;
-	dest=sdest-&gt;data;
-	switch (field) {
-	case 0:
-		my_memcpy_pic(dest, src, myw, myh&gt;&gt;1,
-			myw*2, myw*2);
-		//if (mpi-&gt;flags &amp; MP_IMGFLAG_PLANAR) {
-		if(1){
-			src+=page;
-			dest+=page;
-			/*my_memcpy_pic(dmpi-&gt;planes[1], mpi-&gt;planes[1],
-				mpi-&gt;chroma_width, mpi-&gt;chroma_height/2,
-				dmpi-&gt;stride[1]*2, mpi-&gt;stride[1]*2);
-			my_memcpy_pic(dmpi-&gt;planes[2], mpi-&gt;planes[2],
-				mpi-&gt;chroma_width, mpi-&gt;chroma_height/2,
-				dmpi-&gt;stride[2]*2, mpi-&gt;stride[2]*2);*/
-			my_memcpy_pic(dest, src, myw&gt;&gt;1, myh&gt;&gt;2,
-						myw, myw);
-			src+=page&gt;&gt;2;
-			dest+=page&gt;&gt;2;
-			my_memcpy_pic(dest, src, myw&gt;&gt;1, myh&gt;&gt;2,
-					myw, myw);
-		}
-		break;
-	case 1:
-		/*my_memcpy_pic(dmpi-&gt;planes[0]+dmpi-&gt;stride[0],
-			mpi-&gt;planes[0]+mpi-&gt;stride[0], mpi-&gt;w, mpi-&gt;h/2,
-			dmpi-&gt;stride[0]*2, mpi-&gt;stride[0]*2);*/
-		my_memcpy_pic(dest+myw, src+myw, myw, myh&gt;&gt;1,
-			myw*2, myw*2);	
-		//if (mpi-&gt;flags &amp; MP_IMGFLAG_PLANAR) {
-		if(1){/*
-			my_memcpy_pic(dmpi-&gt;planes[1]+dmpi-&gt;stride[1],
-				mpi-&gt;planes[1]+mpi-&gt;stride[1],
-				mpi-&gt;chroma_width, mpi-&gt;chroma_height/2,
-				dmpi-&gt;stride[1]*2, mpi-&gt;stride[1]*2);
-			my_memcpy_pic(dmpi-&gt;planes[2]+dmpi-&gt;stride[2],
-				mpi-&gt;planes[2]+mpi-&gt;stride[2],
-				mpi-&gt;chroma_width, mpi-&gt;chroma_height/2,
-				dmpi-&gt;stride[2]*2, mpi-&gt;stride[2]*2);*/
-			src+=page;
-			dest+=page;
-			/*my_memcpy_pic(dmpi-&gt;planes[1], mpi-&gt;planes[1],
-				mpi-&gt;chroma_width, mpi-&gt;chroma_height/2,
-				dmpi-&gt;stride[1]*2, mpi-&gt;stride[1]*2);
-			my_memcpy_pic(dmpi-&gt;planes[2], mpi-&gt;planes[2],
-				mpi-&gt;chroma_width, mpi-&gt;chroma_height/2,
-				dmpi-&gt;stride[2]*2, mpi-&gt;stride[2]*2);*/
-			my_memcpy_pic(dest+myw/2, src+myw/2, myw&gt;&gt;1, myh&gt;&gt;2,
-					myw, myw);
-			src+=page&gt;&gt;2;
-			dest+=page&gt;&gt;2;
-			my_memcpy_pic(dest+myw/2, src+myw/2, myw&gt;&gt;1, myh&gt;&gt;2,
-					myw, myw);				
-		}
-		break;
-	case 2:
-		/*
-		memcpy_pic(dmpi-&gt;planes[0], mpi-&gt;planes[0], mpi-&gt;w, mpi-&gt;h,
-			dmpi-&gt;stride[0], mpi-&gt;stride[0]);
-		if (mpi-&gt;flags &amp; MP_IMGFLAG_PLANAR) {
-			memcpy_pic(dmpi-&gt;planes[1], mpi-&gt;planes[1],
-				mpi-&gt;chroma_width, mpi-&gt;chroma_height,
-				dmpi-&gt;stride[1], mpi-&gt;stride[1]);
-			memcpy_pic(dmpi-&gt;planes[2], mpi-&gt;planes[2],
-				mpi-&gt;chroma_width, mpi-&gt;chroma_height,
-				dmpi-&gt;stride[2], mpi-&gt;stride[2]);
-		}*/
-		memcpy(dest,src,(page*3)&gt;&gt;1);
-		break;
-	}
-}
-#if 0 // FIXME USE_MMX
- void block_diffs_MMX(struct metrics *m, unsigned char *old, unsigned char *nw, int os, int ns)
-{
-	int i;
-	short out[24]; // output buffer for the partial metrics from the mmx code
-	
-	__asm__ (
-		&quot;movl $4, %%ecx \n\t&quot;
-		&quot;pxor %%mm4, %%mm4 \n\t&quot; // 4 even difference sums
-		&quot;pxor %%mm5, %%mm5 \n\t&quot; // 4 odd difference sums
-		&quot;pxor %%mm7, %%mm7 \n\t&quot; // all zeros
-		
-		&quot;.balign 16 \n\t&quot;
-		&quot;1: \n\t&quot;
-		
-		// Even difference
-		&quot;movq (%%esi), %%mm0 \n\t&quot;
-		&quot;movq (%%esi), %%mm2 \n\t&quot;
-		&quot;addl %%eax, %%esi \n\t&quot;
-		&quot;movq (%%edi), %%mm1 \n\t&quot;
-		&quot;addl %%ebx, %%edi \n\t&quot;
-		&quot;psubusb %%mm1, %%mm2 \n\t&quot;
-		&quot;psubusb %%mm0, %%mm1 \n\t&quot;
-		&quot;movq %%mm2, %%mm0 \n\t&quot;
-		&quot;movq %%mm1, %%mm3 \n\t&quot;
-		&quot;punpcklbw %%mm7, %%mm0 \n\t&quot;
-		&quot;punpcklbw %%mm7, %%mm1 \n\t&quot;
-		&quot;punpckhbw %%mm7, %%mm2 \n\t&quot;
-		&quot;punpckhbw %%mm7, %%mm3 \n\t&quot;
-		&quot;paddw %%mm0, %%mm4 \n\t&quot;
-		&quot;paddw %%mm1, %%mm4 \n\t&quot;
-		&quot;paddw %%mm2, %%mm4 \n\t&quot;
-		&quot;paddw %%mm3, %%mm4 \n\t&quot;
-		
-		// Odd difference
-		&quot;movq (%%esi), %%mm0 \n\t&quot;
-		&quot;movq (%%esi), %%mm2 \n\t&quot;
-		&quot;addl %%eax, %%esi \n\t&quot;
-		&quot;movq (%%edi), %%mm1 \n\t&quot;
-		&quot;addl %%ebx, %%edi \n\t&quot;
-		&quot;psubusb %%mm1, %%mm2 \n\t&quot;
-		&quot;psubusb %%mm0, %%mm1 \n\t&quot;
-		&quot;movq %%mm2, %%mm0 \n\t&quot;
-		&quot;movq %%mm1, %%mm3 \n\t&quot;
-		&quot;punpcklbw %%mm7, %%mm0 \n\t&quot;
-		&quot;punpcklbw %%mm7, %%mm1 \n\t&quot;
-		&quot;punpckhbw %%mm7, %%mm2 \n\t&quot;
-		&quot;punpckhbw %%mm7, %%mm3 \n\t&quot;
-		&quot;paddw %%mm0, %%mm5 \n\t&quot;
-		&quot;paddw %%mm1, %%mm5 \n\t&quot;
-		&quot;paddw %%mm2, %%mm5 \n\t&quot;
-		&quot;paddw %%mm3, %%mm5 \n\t&quot;
-			
-		&quot;decl %%ecx \n\t&quot;
-		&quot;jnz 1b \n\t&quot;
-		&quot;movq %%mm4, (%%edx) \n\t&quot;
-		&quot;movq %%mm5, 8(%%edx) \n\t&quot;
-		: 
-		: &quot;S&quot; (old), &quot;D&quot; (nw), &quot;a&quot; (os), &quot;b&quot; (ns), &quot;d&quot; (out)
-		: &quot;memory&quot;
-		);
-	m-&gt;e = out[0]+out[1]+out[2]+out[3];
-	m-&gt;o = out[4]+out[5]+out[6]+out[7];
-	m-&gt;d = m-&gt;e + m-&gt;o;
-
-	asm (
-		// First loop to measure first four columns
-		&quot;movl $4, %%ecx \n\t&quot;
-		&quot;pxor %%mm4, %%mm4 \n\t&quot; // Past spacial noise
-		&quot;pxor %%mm5, %%mm5 \n\t&quot; // Temporal noise
-		&quot;pxor %%mm6, %%mm6 \n\t&quot; // Current spacial noise
-		
-		&quot;.balign 16 \n\t&quot;
-		&quot;2: \n\t&quot;
-		
-		&quot;movq (%%esi), %%mm0 \n\t&quot;
-		&quot;movq (%%esi,%%eax), %%mm1 \n\t&quot;
-		&quot;addl %%eax, %%esi \n\t&quot;
-		&quot;addl %%eax, %%esi \n\t&quot;
-		&quot;movq (%%edi), %%mm2 \n\t&quot;
-		&quot;movq (%%edi,%%ebx), %%mm3 \n\t&quot;
-		&quot;addl %%ebx, %%edi \n\t&quot;
-		&quot;addl %%ebx, %%edi \n\t&quot;
-		&quot;punpcklbw %%mm7, %%mm0 \n\t&quot;
-		&quot;punpcklbw %%mm7, %%mm1 \n\t&quot;
-		&quot;punpcklbw %%mm7, %%mm2 \n\t&quot;
-		&quot;punpcklbw %%mm7, %%mm3 \n\t&quot;
-		&quot;paddw %%mm1, %%mm4 \n\t&quot;
-		&quot;paddw %%mm1, %%mm5 \n\t&quot;
-		&quot;paddw %%mm3, %%mm6 \n\t&quot;
-		&quot;psubw %%mm0, %%mm4 \n\t&quot;
-		&quot;psubw %%mm2, %%mm5 \n\t&quot;
-		&quot;psubw %%mm2, %%mm6 \n\t&quot;
-		
-		&quot;decl %%ecx \n\t&quot;
-		&quot;jnz 2b \n\t&quot;
-		
-		&quot;movq %%mm0, %%mm1 \n\t&quot;
-		&quot;movq %%mm0, %%mm2 \n\t&quot;
-		&quot;movq %%mm0, %%mm3 \n\t&quot;
-		&quot;pcmpgtw %%mm4, %%mm1 \n\t&quot;
-		&quot;pcmpgtw %%mm5, %%mm2 \n\t&quot;
-		&quot;pcmpgtw %%mm6, %%mm3 \n\t&quot;
-		&quot;pxor %%mm1, %%mm4 \n\t&quot;
-		&quot;pxor %%mm2, %%mm5 \n\t&quot;
-		&quot;pxor %%mm3, %%mm6 \n\t&quot;
-		&quot;psubw %%mm1, %%mm4 \n\t&quot;
-		&quot;psubw %%mm2, %%mm5 \n\t&quot;
-		&quot;psubw %%mm3, %%mm6 \n\t&quot;
-		&quot;movq %%mm4, (%%edx) \n\t&quot;
-		&quot;movq %%mm5, 16(%%edx) \n\t&quot;
-		&quot;movq %%mm6, 32(%%edx) \n\t&quot;
-
-		&quot;movl %%eax, %%ecx \n\t&quot;
-		&quot;shll $3, %%ecx \n\t&quot;
-		&quot;subl %%ecx, %%esi \n\t&quot;
-		&quot;movl %%ebx, %%ecx \n\t&quot;
-		&quot;shll $3, %%ecx \n\t&quot;
-		&quot;subl %%ecx, %%edi \n\t&quot;
-
-		// Second loop for the last four columns
-		&quot;movl $4, %%ecx \n\t&quot;
-		&quot;pxor %%mm4, %%mm4 \n\t&quot;
-		&quot;pxor %%mm5, %%mm5 \n\t&quot;
-		&quot;pxor %%mm6, %%mm6 \n\t&quot;
-		
-		&quot;.balign 16 \n\t&quot;
-		&quot;3: \n\t&quot;
-		
-		&quot;movq (%%esi), %%mm0 \n\t&quot;
-		&quot;movq (%%esi,%%eax), %%mm1 \n\t&quot;
-		&quot;addl %%eax, %%esi \n\t&quot;
-		&quot;addl %%eax, %%esi \n\t&quot;
-		&quot;movq (%%edi), %%mm2 \n\t&quot;
-		&quot;movq (%%edi,%%ebx), %%mm3 \n\t&quot;
-		&quot;addl %%ebx, %%edi \n\t&quot;
-		&quot;addl %%ebx, %%edi \n\t&quot;
-		&quot;punpckhbw %%mm7, %%mm0 \n\t&quot;
-		&quot;punpckhbw %%mm7, %%mm1 \n\t&quot;
-		&quot;punpckhbw %%mm7, %%mm2 \n\t&quot;
-		&quot;punpckhbw %%mm7, %%mm3 \n\t&quot;
-		&quot;paddw %%mm1, %%mm4 \n\t&quot;
-		&quot;paddw %%mm1, %%mm5 \n\t&quot;
-		&quot;paddw %%mm3, %%mm6 \n\t&quot;
-		&quot;psubw %%mm0, %%mm4 \n\t&quot;
-		&quot;psubw %%mm2, %%mm5 \n\t&quot;
-		&quot;psubw %%mm2, %%mm6 \n\t&quot;
-		
-		&quot;decl %%ecx \n\t&quot;
-		&quot;jnz 3b \n\t&quot;
-		
-		&quot;movq %%mm0, %%mm1 \n\t&quot;
-		&quot;movq %%mm0, %%mm2 \n\t&quot;
-		&quot;movq %%mm0, %%mm3 \n\t&quot;
-		&quot;pcmpgtw %%mm4, %%mm1 \n\t&quot;
-		&quot;pcmpgtw %%mm5, %%mm2 \n\t&quot;
-		&quot;pcmpgtw %%mm6, %%mm3 \n\t&quot;
-		&quot;pxor %%mm1, %%mm4 \n\t&quot;
-		&quot;pxor %%mm2, %%mm5 \n\t&quot;
-		&quot;pxor %%mm3, %%mm6 \n\t&quot;
-		&quot;psubw %%mm1, %%mm4 \n\t&quot;
-		&quot;psubw %%mm2, %%mm5 \n\t&quot;
-		&quot;psubw %%mm3, %%mm6 \n\t&quot;
-		&quot;movq %%mm4, 8(%%edx) \n\t&quot;
-		&quot;movq %%mm5, 24(%%edx) \n\t&quot;
-		&quot;movq %%mm6, 40(%%edx) \n\t&quot;
-
-		&quot;emms \n\t&quot;
-		: 
-		: &quot;S&quot; (old), &quot;D&quot; (nw), &quot;a&quot; (os), &quot;b&quot; (ns), &quot;d&quot; (out)
-		: &quot;memory&quot;
-		);
-	m-&gt;p = m-&gt;t = m-&gt;s = 0;
-	for (i=0; i&lt;8; i++) {
-		m-&gt;p += out[i];
-		m-&gt;t += out[8+i];
-		m-&gt;s += out[16+i];
-	}
-	//printf(&quot;e=%d o=%d d=%d p=%d t=%d s=%d\n&quot;, m-&gt;e, m-&gt;o, m-&gt;d, m-&gt;p, m-&gt;t, m-&gt;s);
-}
-#endif
-#endif

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizebis.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizebis.cpp	2007-06-17 13:36:53 UTC (rev 3266)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizebis.cpp	2007-06-17 15:31:18 UTC (rev 3267)
@@ -1,366 +0,0 @@
-/***************************************************************************
-                          ADM_resizebis.cpp  -  description
-                             -------------------
-
-      Strongly derivated from avisynth
-
-      Seems that int on VC++ is a long integer, hence the INT cast.
-
-
-    begin                : Sun Mar 24 2002
-    copyright            : (C) 2002 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;ADM_assert.h&gt;
-#include &lt;math.h&gt;
-#include &quot;config.h&quot;
-#include &quot;fourcc.h&quot;
-#include &quot;avio.hxx&quot;
-#include &quot;config.h&quot;
- #include &quot;avi_vars.h&quot;
-#ifdef HAVE_ENCODER
-
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-#include &quot;ADM_editor/ADM_edit.hxx&quot;
-#include &quot;ADM_video/ADM_genvideo.hxx&quot;
-#include &quot;ADM_video/ADM_vidCommonFilter.h&quot;
-#include &quot;ADM_video/ADM_resizebis.hxx&quot;
-
-#define SLOW
-
-// General purpose, no need to put them inside class
-// declare static as it could lead to some optimizations
-// the original file was plain C
-
-double TriangleFunc(double x);
-double MitchellFunc(double x);
-double Lanczos3f(double x);
-double Lanczos3sinc(double x);
-
-
-ResampleFunc TriangleFilter = {
-    TriangleFunc, 1.0
-};
-
-ResampleFunc MitchellFilter = {
-    MitchellFunc, 2.0
-};
-
-ResampleFunc LanczosFilter = {
-    Lanczos3f, 3.0
-};
-
-
-
-ResampleFunc RFuncs[3] = {
-    TriangleFilter, MitchellFilter,LanczosFilter
-};
-
-
-//________________________________________________
-
-double TriangleFunc(double x)
-{
-    x = fabs(x);
-    return (x &lt; 1.0) ? 1.0 - x : 0.0;
-}
-
-
-#define bbb (1./3.)
-#define ccc (1./3.)
-#define p0  ((6. - 2. * bbb) / 6.)
-#define p2  ((-18. + 12. * bbb + 6. * ccc) / 6.)
-#define p3  ((12. - 9. * bbb - 6. * ccc) / 6. )
-#define q0  ((8. * bbb + 24. * ccc) / 6.   )
-#define q1  ((-12. * bbb - 48. * ccc) / 6.)
-#define q2  ((6. * bbb + 30. * ccc) / 6.)
-#define   q3 ( (     -     bbb -  6.*ccc) / 6.)
-double MitchellFunc(double x)
-{
-    x = fabs(x);
-    return (x &lt; 1.0) ? (p0 + x * x * (p2 + x * p3)) :
-      (x &lt;  2.) ? (q0 +     x * (q1 +  x *  (q2   +   x   *   q3))): 0.0;
-}
-double Lanczos3sinc(double value)
-{
-	if (value != 0.0)
-	{
-		value *= M_PI;
-		return sin(value) / value;
-	}
-	else
-	{
-		return 1.0;
-	}
-}
-
-double Lanczos3f(double value)
-{
-	if (value &lt; 0.0)
-	{
-		value = -value;
-	}
-	if (value &lt; 3.0)
-	{
-		return (Lanczos3sinc(value) * Lanczos3sinc(value / 3.0));
-	}
-	else
-	{
-		return 0.0;
-	}
-}
-
-
-
-// This function returns a resampling &quot;program&quot; which is interpreted by the
-// FilteredResize filters.  It handles edge conditions so FilteredResize
-// doesn't have to.
-//____________________________________________________________________________
-
-INT *GetResamplingPattern(uint32_t original_width,
-			      uint32_t target_width, ResampleFunc * func)
-{
-    double scale, filter_step,filter_support;
-    double pos_step ;
-
-    scale = double (target_width);
-    scale/= (double)original_width;
-    if (scale &lt; 1.0)
-	filter_step = scale;
-
-    else
-	filter_step = 1.0;
-    filter_support = func-&gt;support;
-    filter_support /= filter_step;
-    int fir_filter_size = int (ceil(filter_support * 2));
-    INT *result = new INT[1 + target_width * (1 + fir_filter_size)];
-    INT *cur = result;
-    
-    *cur++ = fir_filter_size;
-   
-    printf(&quot;\n Fir size : %d&quot;,fir_filter_size);
-    pos_step=original_width;
-    pos_step /= target_width;
-
- 
-
-    // the following translates such that the image center remains fixed
-    double pos = original_width;
-
-       pos-= target_width ;
-       pos/= (target_width * 2);
-
-//   printf(&quot;\n In width : %lu out width : %lu pos_step : %lf pos_initial : %lf&quot;,original_width,target_width, pos_step,pos);
-
-    for (uint32_t i = 0; i &lt; target_width; ++i)
-
-      {
-	  INT end_pos = (INT) (pos + filter_support);
-	  if (end_pos &gt; (INT)original_width - 1)
-	      end_pos = original_width - 1;
-	  INT start_pos = end_pos - fir_filter_size + 1;
-	  if (start_pos &lt; 0)
-	      start_pos = 0;
-	  *cur++ = start_pos;
-
-	  // the following code ensures that the coefficients add to exactly 65536
-	  double total = 0.0;
-	  for (int j = 0; j &lt; fir_filter_size; ++j)
-	      total += func-&gt;f((start_pos + j - pos) * filter_step);
-	  double total2 = 0.0;
-	  for (int k = 0; k &lt; fir_filter_size; ++k)
-
-	    {
-		double total3 =
-		    total2 +func-&gt;f((start_pos + k - pos) * filter_step) / total;
-		    *cur++ =int (total3 * 65536 + 0.5) - int (total2 * 65536 +
-						      0.5);
-		total2 = total3;
-	    } 
-            pos += pos_step;
-      } 
-      return result;
-}
-
-//
-//      Vertical resizing
-//              Resized one plane also
-//_______________________________
-void AVDMVideoStreamResize::ResizeV(Image * iin, Image * iout,
-				    INT *pattern)
-{
-    INT *cur = pattern;
-    int fir_filter_width = *cur++;
-    int row_size = iin-&gt;width;
-    unsigned char *out = iout-&gt;data;
-    unsigned char *srcbuffer = iin-&gt;data;
-    unsigned char *base ,*base2;
-	int total;
-
-    for (uint32_t y = 0; y &lt; iout-&gt;height; ++y)
-
-      {
-	  			base = srcbuffer + row_size * (*cur++);
-	  			for (int x = 0; x &lt; row_size; ++x)
-				  {
-					 total = 0;
-					 base2 = base + x;
-					for (int b = 0; b &lt; fir_filter_width; ++b)
-				  	{	
-				      		total += *base2 * cur[b];
-		      				base2 += row_size;
-					  }
-					  *out++ = ScaledPixelClip(total);
-	  			  } 
-				cur += fir_filter_width;
-	}
-}
-
-//____________________________________
-//      Perform horizontal resizing
-//              On one plane
-//              Must be called 3 times for RGB or 3 times for YV12
-//____________________________________
-void AVDMVideoStreamResize::ResizeH(Image * iin, Image * iout,
-				    INT  *pattern)
-{
-    unsigned char *base = iin-&gt;data;
-    unsigned char *out = iout-&gt;data;
-    int src_row_size = iin-&gt;width;
-    int dst_row_size = iout-&gt;width;
-	uint8_t *ptr;
-	INT *cur;
-	int32_t total;
-   INT ofs;
-    
-    for (uint32_t y =  iin-&gt;height; y&gt;0; y--)
-      {
-	  	cur = pattern + 1;
-	  for (int x = 0; x &lt; dst_row_size ; x++)
-	    {
-			total=0;
-			ofs = *cur++;
-			ptr= &amp;(base[(ofs )]);
-
-			for (int a =   pattern[0];a&gt;0; a--)
-			  {
-			      total += (*ptr++) * (*cur++);
-		  		}
-		   		out[x] = ScaledPixelClip(total);
-	    } // next line...
-	     base += src_row_size;
-	  	out += dst_row_size;
-	}
-
-}
-
-///_____________
-
-/*  ____________________________________________________________________
-	zoom()
-
-	Resizes bitmaps while resampling them.
-	Returns -1 if error, 0 if success.
-*/
-void AVDMVideoStreamResize::precompute(Image * dst, Image * src,
-				       uint8_t algo)
-//____________________________________________________________________
-{
-
-#define FREE_USED(x) if(x) { delete [] x;x=NULL;}
-	FREE_USED(Hpattern_luma);
-	FREE_USED(Hpattern_chroma);
-	FREE_USED(Vpattern_luma);
-	FREE_USED(Vpattern_chroma);
-	
-#ifdef SLOW	 
-	#define MakePattern GetResamplingPattern
-#else
-	#define MakePattern GetResamplingPatternFIR4
-#endif
-
-    Hpattern_luma = MakePattern(src-&gt;width,  dst-&gt;width, &amp;RFuncs[algo]);
-    Hpattern_chroma =MakePattern(src-&gt;width &gt;&gt; 1,  dst-&gt;width &gt;&gt; 1, &amp;RFuncs[algo]);
-    Vpattern_luma =MakePattern(src-&gt;height,  dst-&gt;height,&amp;RFuncs[algo]);
-    Vpattern_chroma =MakePattern(src-&gt;height &gt;&gt; 1,   dst-&gt;height &gt;&gt; 1, &amp;RFuncs[algo]);
-
-
-}
-
-//__________________________________________________________________
-uint8_t AVDMVideoStreamResize::zoom(Image * dst, Image * src)				
-//__________________________________________________________________
-{
-  // First Horizontal resize from src -&gt; intermediate
-  Image tmpin;
-                      tmpin.width=dst-&gt;width;
-                      tmpin.height=src-&gt;height;
-                      tmpin.data=_intermediate_buffer;
-		      
-
-#ifdef SLOW		 											
-					#define DORES(src,dst,patH,patV)   	ResizeH(src, &amp;tmpin,patH)    ;  \
-													        		        ResizeV(&amp;tmpin,dst,patV);        
-#else                     
-					#define DORES(src,dst,patH,patV)    ResizeHFIR4(src, &amp;tmpin,patH)    ; \
-													           					ResizeVFIR4(&amp;tmpin,dst,patV);      
-#endif
-		      
-		      
-		      //---------Y---------------
-		      
-		      	DORES(src,dst,Hpattern_luma, Vpattern_luma);
-    				
-
-				// update fields, 
-    				src-&gt;data+=src-&gt;width*src-&gt;height;
-    				dst-&gt;data+=dst-&gt;width*dst-&gt;height;
-    				
-    		    src-&gt;width&gt;&gt;=1;
-    		    src-&gt;height&gt;&gt;=1;
-    		    dst-&gt;width&gt;&gt;=1;
-    		    dst-&gt;height&gt;&gt;=1;
-          
-		       	tmpin.height=src-&gt;height;
-		       	tmpin.width=dst-&gt;width;
-		       	tmpin.data+= tmpin.height*tmpin.width;
-
-		       // --------- U -------------
-		      	DORES(src,dst,Hpattern_chroma, Vpattern_chroma);
-		          				
-    		    src-&gt;data+=src-&gt;width*src-&gt;height;
-    				dst-&gt;data+=dst-&gt;width*dst-&gt;height;
-    				tmpin.data+= tmpin.height*tmpin.width;
-		       // --------- V -------------
-		      
-		      	DORES(src,dst,Hpattern_chroma, Vpattern_chroma);    				
-    		       
-    return 1;
-}				/* zoom */
-
-
-// clean up insiders datas
-//
-void AVDMVideoStreamResize::endcompute(void)
-{
-	FREE_USED(Hpattern_luma);
-	FREE_USED(Hpattern_chroma);
-	FREE_USED(Vpattern_luma);
-	FREE_USED(Vpattern_chroma);
-}
-
-
-#endif

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizebis.hxx
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizebis.hxx	2007-06-17 13:36:53 UTC (rev 3266)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizebis.hxx	2007-06-17 15:31:18 UTC (rev 3267)
@@ -1,52 +0,0 @@
-/***************************************************************************
-                          ADM_resizebis.hxx  -  description
-                             -------------------
-    begin                : Sun Mar 24 2002
-    copyright            : (C) 2002 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#ifndef __RESIZE_B_SUPPORT
-#define __RESIZE_B_SUPPORT
-
-typedef struct {
-    double (*f) (double x);
-    double support;
-} ResampleFunc;
-
-INT *GetResamplingPattern(uint32_t original_width,
-			      uint32_t target_width, ResampleFunc * func);
-
-INT *GetResamplingPatternFIR4(uint32_t original_width,
-			      uint32_t target_width, ResampleFunc * func);
-		
-static inline uint8_t PixelClip(int16_t in)
-{
-    if (in &gt; 255)
-	in = 255;
-   if(in&lt;0)
-   	in=0;
-    return (uint8_t) in;
-};
-			   	   
-static inline unsigned char ScaledPixelClip(INT i)
-{
-    return PixelClip(((i +32768) &gt;&gt; 16)); //  + 32768
-};
-
-static inline unsigned char ScaledPixelClip8(int16_t i)
-{
-    return PixelClip(((i +256) &gt;&gt; 8)); //  + 32768
-};
-
-			         
-#endif

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizeter.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizeter.cpp	2007-06-17 13:36:53 UTC (rev 3266)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizeter.cpp	2007-06-17 15:31:18 UTC (rev 3267)
@@ -1,206 +0,0 @@
-/***************************************************************************
-                          ADM_resizeter.cpp  -  description
-                             -------------------
-                             
-		This is an optimised with FIR size=4
-		of vidResizebis
-		
-    Faster but lesser quality		
-    (nb sample to compute is potentially smaller)                                                          
-                             
-    begin                : Sat Sep 21 2002
-    copyright            : (C) 2002 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;ADM_assert.h&gt;
-#include &lt;math.h&gt;
-#include &quot;config.h&quot;
-#include &quot;fourcc.h&quot;
-#include &quot;avio.hxx&quot;
-#include &quot;config.h&quot;
-#include &quot;avi_vars.h&quot;
-
-
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-#include &quot;ADM_editor/ADM_edit.hxx&quot;
-#include &quot;ADM_video/ADM_genvideo.hxx&quot;
-#include &quot;ADM_video/ADM_vidCommonFilter.h&quot;
-#include&quot;ADM_video/ADM_resizebis.hxx&quot;
- 
- 
- /*
-  	Same as above but use a fixed size FIR size of 4
-   	Good until ~ half width
-
-
-*/
-INT *GetResamplingPatternFIR4(uint32_t original_width,
-			      uint32_t target_width, ResampleFunc * func)
-{
-    double scale, filter_step,filter_support;
-    double pos_step ;
-
-    scale = double (target_width);
-    scale/= (double)original_width;
-    if (scale &lt; 1.0)
-	filter_step = scale;
-
-    else
-	filter_step = 1.0;
-    filter_support = func-&gt;support;
-    filter_support /= filter_step;
-    
-    int fir_filter_size = 3;
-    
-    
-    int16_t  *result = new int16_t[1 + target_width * (1 + fir_filter_size)];
-    int16_t  *cur = result;
-    
-    *cur++ = fir_filter_size;
-   
-    printf(&quot;\n Fixed Fir size : %d&quot;,fir_filter_size);
-    pos_step=original_width;
-    pos_step /= target_width;
-
- 
-
-    // the following translates such that the image center remains fixed
-    double pos = original_width;
-
-       pos-= target_width ;
-       pos/= (target_width * 2);
-
-//   printf(&quot;\n In width : %lu out width : %lu pos_step : %lf pos_initial : %lf&quot;,original_width,target_width, pos_step,pos);
-
-    for (uint32_t i = 0; i &lt; target_width; ++i)
-
-      {
-	  INT end_pos = (INT) (pos + filter_support);
-	  if (end_pos &gt; (INT)original_width - 1)
-	      end_pos = original_width - 1;
-	  INT start_pos = end_pos - fir_filter_size + 1;
-	  if (start_pos &lt; 0)
-	      start_pos = 0;
-	  *cur++ = start_pos;
-
-	  // the following code ensures that the coefficients add to exactly 65536
-	  double total = 0.0;
-	  for (int j = 0; j &lt; fir_filter_size; ++j)
-	      total += func-&gt;f((start_pos + j - pos) * filter_step);
-	  double total2 = 0.0;
-	  for (int k = 0; k &lt; fir_filter_size; ++k)
-
-	    {
-		double total3 =
-		    total2 +func-&gt;f((start_pos + k - pos) * filter_step) / total;
-		    *cur++ =int (total3 * 256 + 0.5) - int (total2 * 256 +
-						      0.5);
-		total2 = total3;
-	    } 
-            pos += pos_step;
-      } 
-      return (INT *)result;
-}
-
-
-
-
-/*
-      Vertical resizing
-
-  		Fast resample, FIR= 4 hardcoded
-    
-    	the input is byte
-     	the coef are signed 16 bits integere
-
-*/
-void AVDMVideoStreamResize::ResizeVFIR4(Image * iin, Image * iout,
-				    INT *intpattern)
-{
-    int16_t *pattern = (int16_t *)intpattern;
-
-    int16_t *cur = pattern;
-    /*int fir_filter_width = *cur++*/cur++;
-    int row_size = iin-&gt;width;
-    unsigned char *out = iout-&gt;data;
-    unsigned char *srcbuffer = iin-&gt;data;
-    unsigned char *base ,*base2;
-		int total;
-		
-			
-
-    for (uint32_t y = 0; y &lt; iout-&gt;height; ++y)
-
-      {
-	  			base = srcbuffer + row_size * (*cur++);
-	  			for (int x = 0; x &lt; row_size; ++x)
-				  {
-					
-					 base2 = base + x;
-					 
-					    		total = *base2 							 * cur[0];
-					    		total += *(base2+row_size) 		 * cur[1];
-					    		total += *(base2+(row_size&lt;&lt;1)) * cur[2];		      			
-					    		//total += *(base2 + row_size*3) * cur[3];
-								  *out++ = ScaledPixelClip8(total);
-	  			  } 
-				cur += 3;
-		}
-}
-
-
-/*
-  		Fast resample, FIR= 4 hardcoded
-    
-    	the input is byte
-     	the coef are signed 16 bits integere
-
-*/
-void AVDMVideoStreamResize::ResizeHFIR4(Image * iin, Image * iout,
-				    INT  *bigpattern)
-{
-    uint8_t *base = iin-&gt;data;
-    uint8_t *out 	= iout-&gt;data;
-  
-    int src_row_size = iin-&gt;width;
-    int dst_row_size = iout-&gt;width;
-    int16_t *pattern=(int16_t *)bigpattern;
-    
-		uint8_t 				*ptr;
-		int16_t 				*cur;
-		static int32_t 	total;
-		//int32_t					*t=&total;
-  	int16_t 				ofs;
-   
-	for (uint32_t y =  iin-&gt;height; y&gt;0; y--)
-      {
-	  	cur = pattern + 1;	   
-		  for (int x = 0; x &lt; dst_row_size ; x++)
-	    {
-				ofs = *cur++;
-				ptr= &amp;(base[(ofs )]);
-      	total=0;
-	
-				total =  *(ptr) 	* *(cur);
-				total += *(ptr+1) * *(cur+1);
-		  	total += *(ptr+2) * *(cur+2);
-//		  	total += *(ptr+3) * *(cur+3);   		   		
-      	cur+=3;
-		  	*out++ = ScaledPixelClip8(total);
-	    } // next line...
-	     base += src_row_size;
-	}
-}

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidResize.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidResize.cpp	2007-06-17 13:36:53 UTC (rev 3266)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidResize.cpp	2007-06-17 15:31:18 UTC (rev 3267)
@@ -1,197 +0,0 @@
-/***************************************************************************
-                          ADM_vidResize.cpp  -  description
-                             -------------------
-   Resize a picture in YUV12
-
-   w,h 		size of final picture
-   dw,dh  size of black bordered picture
-
-
-    begin                : Thu Mar 21 2002
-    copyright            : (C) 2002 by mean
-    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;ADM_assert.h&gt;
-
-#include &quot;config.h&quot;
-#include &quot;fourcc.h&quot;
-#include &quot;avio.hxx&quot;
-#include &quot;config.h&quot;
-#include &quot;avi_vars.h&quot;
-#ifdef HAVE_ENCODER
-
-
-#include &quot;ADM_toolkit/toolkit.hxx&quot;
-#include &quot;ADM_editor/ADM_edit.hxx&quot;
-#include &quot;ADM_video/ADM_genvideo.hxx&quot;
-#include &quot;ADM_video/ADM_resizebis.hxx&quot;
-#include &quot;ADM_video/ADM_vidCommonFilter.h&quot;
-#include &quot;ADM_filter/video_filters.h&quot;
-
-
-static FILTER_PARAM mpresizeParam={3,{&quot;w&quot;,&quot;h&quot;,&quot;algo&quot;}};
-SCRIPT_CREATE(resize_script,AVDMVideoStreamResize,mpresizeParam);
-BUILD_CREATE(resize_create,AVDMVideoStreamResize);
-
-char *AVDMVideoStreamResize::printConf( void )
-{
- 	static char buf[50];
- 	
- 	sprintf((char *)buf,&quot; Resize %lu x %lu --&gt; %lu x %lu&quot;,
- 				_in-&gt;getInfo()-&gt;width,
- 				_in-&gt;getInfo()-&gt;height,
- 				_info.width,
- 				_info.height);
-        return buf;
-}
-//_______________________________________________________________
-AVDMVideoStreamResize::AVDMVideoStreamResize(
-									AVDMGenericVideoStream *in,CONFcouple *couples)
-{
-
-  	_in=in;
-   	memcpy(&amp;_info,_in-&gt;getInfo(),sizeof(_info));
-	_uncompressed=new ADMImage(_info.width,_info.height);
-
-		if(couples)
-		{
-			 _param=NEW(RESIZE_PARAMS);
-			GET(w);
-			GET(h);
-			GET(algo);
-			_info.width=_param-&gt;w;
-			_info.height=_param-&gt;h;
-
-		}
-			else
-			{
-				_param=NEW( RESIZE_PARAMS);
-				_param-&gt;w=_info.width;
-				_param-&gt;h = _info.height;
-				_param-&gt;algo = 0;
-			}			
-			_intermediate_buffer=new uint8_t [3*_info.width*_in-&gt;getInfo()-&gt;height];	
-
-  _info.encoding=1;
-  _init=0;
-	Vpattern_luma=NULL;
-    Vpattern_chroma=NULL;
-	Hpattern_luma=NULL;
-    Hpattern_chroma=NULL;
-}
-#if !defined(MPLAYER_RESIZE_PREFFERED) 
-AVDMGenericVideoStream *createResizeFromParam(AVDMGenericVideoStream *in,uint32_t x,uint32_t y)
-{
-
-	return new AVDMVideoStreamResize(in,x,y);
-}
-#endif
-AVDMVideoStreamResize::AVDMVideoStreamResize(
-									AVDMGenericVideoStream *in,uint32_t x,uint32_t y)
-{
-
-  	_in=in;
-   	memcpy(&amp;_info,_in-&gt;getInfo(),sizeof(_info));
-	_uncompressed=new ADMImage(_info.width,_info.height);
-	_param=NEW( RESIZE_PARAMS);
-	_param-&gt;w=x;
-	_param-&gt;h = y;
-	_info.width=_param-&gt;w;
-	_info.height=_param-&gt;h;
-	_param-&gt;algo = 0;
-	_intermediate_buffer=new uint8_t [3*_info.width*_in-&gt;getInfo()-&gt;height];
-
-	_info.encoding=1;
-	_init=0;
-	Vpattern_luma=NULL;
-	Vpattern_chroma=NULL;
-	Hpattern_luma=NULL;
-	Hpattern_chroma=NULL;
-}
-
-uint8_t	AVDMVideoStreamResize::getCoupledConf( CONFcouple **couples)
-{
-
-			ADM_assert(_param);
-			*couples=new CONFcouple(3);
-
-#define CSET(x)  (*couples)-&gt;setCouple((char *)#x,(_param-&gt;x))
-	CSET(w);
-	CSET(h);
-	CSET(algo);
-			return 1;
-
-}
-// ___ destructor_____________
-AVDMVideoStreamResize::~AVDMVideoStreamResize()
-{
- 	delete  _uncompressed;
-	delete [] _intermediate_buffer;
-	DELETE(_param);
-	_uncompressed=NULL;
-	_intermediate_buffer=NULL;
- 	endcompute();
-}
-
-//
-//	Basically ask a uncompressed frame from editor and ask
-//		GUI to decompress it .
-//
-
-uint8_t AVDMVideoStreamResize::getFrameNumberNoAlloc(uint32_t frame,
-				uint32_t *len,
-   				ADMImage *data,
-				uint32_t *flags)
-{
-static Image in,out;
-	if(frame&gt;=_info.nb_frames) 
-	{
-		printf(&quot;Filter : out of bound!\n&quot;);
-		return 0;
-	}
-	
-	ADM_assert(_param);	
-	if(!_in-&gt;getFrameNumberNoAlloc(frame, len,_uncompressed,flags)) return 0;
-       		
-	// do the resize in 3 passes, Y, U then V
-	in.width=_in-&gt;getInfo()-&gt;width;
-	in.height=_in-&gt;getInfo()-&gt;height;
-	in.data=_uncompressed-&gt;data;
-
-	out.width=_info.width;
-	out.height=_info.height;
-	out.data=data-&gt;data;	
-	if(!_init)
-	{
-		_init=1;
-		printf(&quot;\n Precomputing with algo :%lu\n&quot;,_param-&gt;algo);
-		if(_param-&gt;algo&gt;2)
-                {
-			printf(&quot;\n Wrong algorithm selection&quot;);
-			ADM_assert(0);
-		}
-		precompute(&amp;out,&amp;in, _param-&gt;algo );
-	}
-       	zoom(&amp;out,&amp;in)         ;       
-       data-&gt;flags=*flags=_uncompressed-&gt;flags;
-
-       *len= _info.width*_info.height+(_info.width*_info.height&gt;&gt;1);
-       data-&gt;copyInfo(_uncompressed);	
-      return 1;
-}
-
-
-#endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_video/CMakeLists.txt
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/CMakeLists.txt	2007-06-17 13:36:53 UTC (rev 3266)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/CMakeLists.txt	2007-06-17 15:31:18 UTC (rev 3267)
@@ -1,14 +1,14 @@
 SET(ADM_video_SRCS 
-ADM_cache.cpp            ADM_resizebis.cpp       ADM_vidCNR2.cpp       ADM_vidFieldUnblend.cpp  ADM_vidPartial.cpp    ADM_vidTdeint.cpp
-ADM_confCouples.cpp      ADM_resizeter.cpp       ADM_vidColorYuv.cpp   ADM_vidFieldUtil.cpp     ADM_vidRaw.cpp        ADM_vidUnblend.cpp
+ADM_cache.cpp                  ADM_vidCNR2.cpp       ADM_vidFieldUnblend.cpp  ADM_vidPartial.cpp    ADM_vidTdeint.cpp
+ADM_confCouples.cpp            ADM_vidColorYuv.cpp   ADM_vidFieldUtil.cpp     ADM_vidRaw.cpp        ADM_vidUnblend.cpp
 ADM_genvideo.cpp         ADM_vidAnimated.cpp     ADM_vidContrast.cpp   ADM_vidFont.cpp          ADM_vidResize25.cpp   ADM_vidVobsub.cpp
-ADM_guiResize.cpp        ADM_vidAsharp.cpp       ADM_vidCrop.cpp       ADM_vidHue.cpp           ADM_vidResize.cpp     ADM_vidVobSubRender.cpp
+ ADM_vidAsharp.cpp       ADM_vidCrop.cpp       ADM_vidHue.cpp               ADM_vidVobSubRender.cpp
 ADM_interlaced.cpp       ADM_vidCached.cpp       ADM_vidDelta.cpp      ADM_vidMPdelogo.cpp      ADM_vidSRT.cpp        ADM_vobsubinfo.cpp
-ADM_mpdetc.cpp           ADM_vidChromaShift.cpp  ADM_vidEq2.cpp        ADM_vidMPLResize.cpp     ADM_vidSRTload.cpp
+   ADM_vidChromaShift.cpp  ADM_vidEq2.cpp        ADM_vidMPLResize.cpp     ADM_vidSRTload.cpp
 ADM_vidClean.cpp        ADM_vidEqualizer.cpp  ADM_vidNull.cpp          ADM_vidSRTRender.cpp
 )
 ADD_LIBRARY(ADM_video STATIC ${ADM_video_SRCS})
 if(FT_FOUND)
 add_definitions(${FT_CFLAGS})
 endif(FT_FOUND)
-include_directories(../ADM_inputs)
\ No newline at end of file
+include_directories(../ADM_inputs)

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_guiResize.cpp (from rev 3261, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_guiResize.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_guiResize.cpp	2007-06-16 16:47:26 UTC (rev 3261)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_guiResize.cpp	2007-06-17 15:31:18 UTC (rev 3267)
@@ -0,0 +1,109 @@
+/***************************************************************************
+                          ADM_guiResize.cpp  -  description
+                             -------------------
+
+GUI part of resize.
+			     
+    begin                : Thu Mar 21 2002
+    copyright            : (C) 2002 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;config.h&quot;
+
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+
+#include &lt;time.h&gt;
+#include &lt;sys/time.h&gt;
+#include &quot;config.h&quot;
+#include &quot;fourcc.h&quot;
+#include &quot;avio.hxx&quot;
+
+#include &quot;avi_vars.h&quot;
+#ifdef HAVE_ENCODER
+
+
+#include &quot;ADM_editor/ADM_edit.hxx&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+#include &quot;ADM_resizebis.hxx&quot;
+#include &quot;ADM_video/ADM_vidCommonFilter.h&quot;
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+#include &lt;ADM_assert.h&gt;
+
+
+static int getResizeParams(uint32_t * w, uint32_t * h, uint32_t * algo,uint32_t w,uint32_t h,uint32_t fps);
+
+
+extern uint8_t DIA_resize(uint32_t *width,uint32_t *height,uint32_t *algo,uint32_t originalw, uint32_t originalh,uint32_t fps1000);
+
+uint8_t AVDMVideoStreamResize::configure(AVDMGenericVideoStream * instream)
+{
+    UNUSED_ARG(instream);
+
+    RESIZE_PARAMS *par;
+//    uint8_t ret=0;
+
+    _init = 0;			// force recompute
+    par = _param;
+
+
+
+    if (!getResizeParams(&amp;par-&gt;w, &amp;par-&gt;h, &amp;par-&gt;algo,instream-&gt;getInfo()-&gt;width,instream-&gt;getInfo()-&gt;height,_info.fps1000))
+      {
+	  return 0;
+      }
+      printf(&quot;\n OK was selected \n&quot;);
+    // update other parameters
+    _info.width = _param-&gt;w;
+    _info.height = _param-&gt;h;
+    // intermediate buffer
+    if (_intermediate_buffer)
+      {
+	  delete  [] _intermediate_buffer;
+	  _intermediate_buffer = NULL;
+      }
+    //_intermediate_buffer=(uint8_t *)malloc(3*_info.width*_in-&gt;getInfo()-&gt;height);
+    _intermediate_buffer =
+	new uint8_t[3 * _info.width * _in-&gt;getInfo()-&gt;height];
+
+    return 1;
+
+}
+
+//
+//  
+//
+//
+//   static GtkWidget *resi;
+int getResizeParams(uint32_t * w, uint32_t * h, uint32_t * algo,uint32_t ow,uint32_t oh,uint32_t fps)
+{
+uint32_t ww,hh;
+	while(1)
+	{
+		ww=*w;
+		hh=*h;
+  		if(!DIA_resize(&amp;ww,&amp;hh,algo,ow,oh,fps)) return 0;
+                if(!ww || !hh) GUI_Error_HIG(_(&quot;Width and height cannot be 0&quot;), NULL);
+		else
+                  if( ww&amp;1 || hh &amp;1) GUI_Error_HIG(_(&quot;Width and height cannot be odd&quot;), NULL);
+			else
+			{
+				*w=ww;
+				*h=hh;
+				return 1;
+			}
+	}
+}
+
+
+#endif

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_resizebis.cpp (from rev 3261, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizebis.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizebis.cpp	2007-06-16 16:47:26 UTC (rev 3261)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_resizebis.cpp	2007-06-17 15:31:18 UTC (rev 3267)
@@ -0,0 +1,366 @@
+/***************************************************************************
+                          ADM_resizebis.cpp  -  description
+                             -------------------
+
+      Strongly derivated from avisynth
+
+      Seems that int on VC++ is a long integer, hence the INT cast.
+
+
+    begin                : Sun Mar 24 2002
+    copyright            : (C) 2002 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+#include &lt;ADM_assert.h&gt;
+#include &lt;math.h&gt;
+#include &quot;config.h&quot;
+#include &quot;fourcc.h&quot;
+#include &quot;avio.hxx&quot;
+#include &quot;config.h&quot;
+ #include &quot;avi_vars.h&quot;
+#ifdef HAVE_ENCODER
+
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+#include &quot;ADM_editor/ADM_edit.hxx&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+#include &quot;ADM_video/ADM_vidCommonFilter.h&quot;
+#include &quot;ADM_resizebis.hxx&quot;
+
+#define SLOW
+
+// General purpose, no need to put them inside class
+// declare static as it could lead to some optimizations
+// the original file was plain C
+
+double TriangleFunc(double x);
+double MitchellFunc(double x);
+double Lanczos3f(double x);
+double Lanczos3sinc(double x);
+
+
+ResampleFunc TriangleFilter = {
+    TriangleFunc, 1.0
+};
+
+ResampleFunc MitchellFilter = {
+    MitchellFunc, 2.0
+};
+
+ResampleFunc LanczosFilter = {
+    Lanczos3f, 3.0
+};
+
+
+
+ResampleFunc RFuncs[3] = {
+    TriangleFilter, MitchellFilter,LanczosFilter
+};
+
+
+//________________________________________________
+
+double TriangleFunc(double x)
+{
+    x = fabs(x);
+    return (x &lt; 1.0) ? 1.0 - x : 0.0;
+}
+
+
+#define bbb (1./3.)
+#define ccc (1./3.)
+#define p0  ((6. - 2. * bbb) / 6.)
+#define p2  ((-18. + 12. * bbb + 6. * ccc) / 6.)
+#define p3  ((12. - 9. * bbb - 6. * ccc) / 6. )
+#define q0  ((8. * bbb + 24. * ccc) / 6.   )
+#define q1  ((-12. * bbb - 48. * ccc) / 6.)
+#define q2  ((6. * bbb + 30. * ccc) / 6.)
+#define   q3 ( (     -     bbb -  6.*ccc) / 6.)
+double MitchellFunc(double x)
+{
+    x = fabs(x);
+    return (x &lt; 1.0) ? (p0 + x * x * (p2 + x * p3)) :
+      (x &lt;  2.) ? (q0 +     x * (q1 +  x *  (q2   +   x   *   q3))): 0.0;
+}
+double Lanczos3sinc(double value)
+{
+	if (value != 0.0)
+	{
+		value *= M_PI;
+		return sin(value) / value;
+	}
+	else
+	{
+		return 1.0;
+	}
+}
+
+double Lanczos3f(double value)
+{
+	if (value &lt; 0.0)
+	{
+		value = -value;
+	}
+	if (value &lt; 3.0)
+	{
+		return (Lanczos3sinc(value) * Lanczos3sinc(value / 3.0));
+	}
+	else
+	{
+		return 0.0;
+	}
+}
+
+
+
+// This function returns a resampling &quot;program&quot; which is interpreted by the
+// FilteredResize filters.  It handles edge conditions so FilteredResize
+// doesn't have to.
+//____________________________________________________________________________
+
+INT *GetResamplingPattern(uint32_t original_width,
+			      uint32_t target_width, ResampleFunc * func)
+{
+    double scale, filter_step,filter_support;
+    double pos_step ;
+
+    scale = double (target_width);
+    scale/= (double)original_width;
+    if (scale &lt; 1.0)
+	filter_step = scale;
+
+    else
+	filter_step = 1.0;
+    filter_support = func-&gt;support;
+    filter_support /= filter_step;
+    int fir_filter_size = int (ceil(filter_support * 2));
+    INT *result = new INT[1 + target_width * (1 + fir_filter_size)];
+    INT *cur = result;
+    
+    *cur++ = fir_filter_size;
+   
+    printf(&quot;\n Fir size : %d&quot;,fir_filter_size);
+    pos_step=original_width;
+    pos_step /= target_width;
+
+ 
+
+    // the following translates such that the image center remains fixed
+    double pos = original_width;
+
+       pos-= target_width ;
+       pos/= (target_width * 2);
+
+//   printf(&quot;\n In width : %lu out width : %lu pos_step : %lf pos_initial : %lf&quot;,original_width,target_width, pos_step,pos);
+
+    for (uint32_t i = 0; i &lt; target_width; ++i)
+
+      {
+	  INT end_pos = (INT) (pos + filter_support);
+	  if (end_pos &gt; (INT)original_width - 1)
+	      end_pos = original_width - 1;
+	  INT start_pos = end_pos - fir_filter_size + 1;
+	  if (start_pos &lt; 0)
+	      start_pos = 0;
+	  *cur++ = start_pos;
+
+	  // the following code ensures that the coefficients add to exactly 65536
+	  double total = 0.0;
+	  for (int j = 0; j &lt; fir_filter_size; ++j)
+	      total += func-&gt;f((start_pos + j - pos) * filter_step);
+	  double total2 = 0.0;
+	  for (int k = 0; k &lt; fir_filter_size; ++k)
+
+	    {
+		double total3 =
+		    total2 +func-&gt;f((start_pos + k - pos) * filter_step) / total;
+		    *cur++ =int (total3 * 65536 + 0.5) - int (total2 * 65536 +
+						      0.5);
+		total2 = total3;
+	    } 
+            pos += pos_step;
+      } 
+      return result;
+}
+
+//
+//      Vertical resizing
+//              Resized one plane also
+//_______________________________
+void AVDMVideoStreamResize::ResizeV(Image * iin, Image * iout,
+				    INT *pattern)
+{
+    INT *cur = pattern;
+    int fir_filter_width = *cur++;
+    int row_size = iin-&gt;width;
+    unsigned char *out = iout-&gt;data;
+    unsigned char *srcbuffer = iin-&gt;data;
+    unsigned char *base ,*base2;
+	int total;
+
+    for (uint32_t y = 0; y &lt; iout-&gt;height; ++y)
+
+      {
+	  			base = srcbuffer + row_size * (*cur++);
+	  			for (int x = 0; x &lt; row_size; ++x)
+				  {
+					 total = 0;
+					 base2 = base + x;
+					for (int b = 0; b &lt; fir_filter_width; ++b)
+				  	{	
+				      		total += *base2 * cur[b];
+		      				base2 += row_size;
+					  }
+					  *out++ = ScaledPixelClip(total);
+	  			  } 
+				cur += fir_filter_width;
+	}
+}
+
+//____________________________________
+//      Perform horizontal resizing
+//              On one plane
+//              Must be called 3 times for RGB or 3 times for YV12
+//____________________________________
+void AVDMVideoStreamResize::ResizeH(Image * iin, Image * iout,
+				    INT  *pattern)
+{
+    unsigned char *base = iin-&gt;data;
+    unsigned char *out = iout-&gt;data;
+    int src_row_size = iin-&gt;width;
+    int dst_row_size = iout-&gt;width;
+	uint8_t *ptr;
+	INT *cur;
+	int32_t total;
+   INT ofs;
+    
+    for (uint32_t y =  iin-&gt;height; y&gt;0; y--)
+      {
+	  	cur = pattern + 1;
+	  for (int x = 0; x &lt; dst_row_size ; x++)
+	    {
+			total=0;
+			ofs = *cur++;
+			ptr= &amp;(base[(ofs )]);
+
+			for (int a =   pattern[0];a&gt;0; a--)
+			  {
+			      total += (*ptr++) * (*cur++);
+		  		}
+		   		out[x] = ScaledPixelClip(total);
+	    } // next line...
+	     base += src_row_size;
+	  	out += dst_row_size;
+	}
+
+}
+
+///_____________
+
+/*  ____________________________________________________________________
+	zoom()
+
+	Resizes bitmaps while resampling them.
+	Returns -1 if error, 0 if success.
+*/
+void AVDMVideoStreamResize::precompute(Image * dst, Image * src,
+				       uint8_t algo)
+//____________________________________________________________________
+{
+
+#define FREE_USED(x) if(x) { delete [] x;x=NULL;}
+	FREE_USED(Hpattern_luma);
+	FREE_USED(Hpattern_chroma);
+	FREE_USED(Vpattern_luma);
+	FREE_USED(Vpattern_chroma);
+	
+#ifdef SLOW	 
+	#define MakePattern GetResamplingPattern
+#else
+	#define MakePattern GetResamplingPatternFIR4
+#endif
+
+    Hpattern_luma = MakePattern(src-&gt;width,  dst-&gt;width, &amp;RFuncs[algo]);
+    Hpattern_chroma =MakePattern(src-&gt;width &gt;&gt; 1,  dst-&gt;width &gt;&gt; 1, &amp;RFuncs[algo]);
+    Vpattern_luma =MakePattern(src-&gt;height,  dst-&gt;height,&amp;RFuncs[algo]);
+    Vpattern_chroma =MakePattern(src-&gt;height &gt;&gt; 1,   dst-&gt;height &gt;&gt; 1, &amp;RFuncs[algo]);
+
+
+}
+
+//__________________________________________________________________
+uint8_t AVDMVideoStreamResize::zoom(Image * dst, Image * src)				
+//__________________________________________________________________
+{
+  // First Horizontal resize from src -&gt; intermediate
+  Image tmpin;
+                      tmpin.width=dst-&gt;width;
+                      tmpin.height=src-&gt;height;
+                      tmpin.data=_intermediate_buffer;
+		      
+
+#ifdef SLOW		 											
+					#define DORES(src,dst,patH,patV)   	ResizeH(src, &amp;tmpin,patH)    ;  \
+													        		        ResizeV(&amp;tmpin,dst,patV);        
+#else                     
+					#define DORES(src,dst,patH,patV)    ResizeHFIR4(src, &amp;tmpin,patH)    ; \
+													           					ResizeVFIR4(&amp;tmpin,dst,patV);      
+#endif
+		      
+		      
+		      //---------Y---------------
+		      
+		      	DORES(src,dst,Hpattern_luma, Vpattern_luma);
+    				
+
+				// update fields, 
+    				src-&gt;data+=src-&gt;width*src-&gt;height;
+    				dst-&gt;data+=dst-&gt;width*dst-&gt;height;
+    				
+    		    src-&gt;width&gt;&gt;=1;
+    		    src-&gt;height&gt;&gt;=1;
+    		    dst-&gt;width&gt;&gt;=1;
+    		    dst-&gt;height&gt;&gt;=1;
+          
+		       	tmpin.height=src-&gt;height;
+		       	tmpin.width=dst-&gt;width;
+		       	tmpin.data+= tmpin.height*tmpin.width;
+
+		       // --------- U -------------
+		      	DORES(src,dst,Hpattern_chroma, Vpattern_chroma);
+		          				
+    		    src-&gt;data+=src-&gt;width*src-&gt;height;
+    				dst-&gt;data+=dst-&gt;width*dst-&gt;height;
+    				tmpin.data+= tmpin.height*tmpin.width;
+		       // --------- V -------------
+		      
+		      	DORES(src,dst,Hpattern_chroma, Vpattern_chroma);    				
+    		       
+    return 1;
+}				/* zoom */
+
+
+// clean up insiders datas
+//
+void AVDMVideoStreamResize::endcompute(void)
+{
+	FREE_USED(Hpattern_luma);
+	FREE_USED(Hpattern_chroma);
+	FREE_USED(Vpattern_luma);
+	FREE_USED(Vpattern_chroma);
+}
+
+
+#endif

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_resizebis.hxx (from rev 3261, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizebis.hxx)

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_resizeter.cpp (from rev 3261, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizeter.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_resizeter.cpp	2007-06-16 16:47:26 UTC (rev 3261)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_resizeter.cpp	2007-06-17 15:31:18 UTC (rev 3267)
@@ -0,0 +1,206 @@
+/***************************************************************************
+                          ADM_resizeter.cpp  -  description
+                             -------------------
+                             
+		This is an optimised with FIR size=4
+		of vidResizebis
+		
+    Faster but lesser quality		
+    (nb sample to compute is potentially smaller)                                                          
+                             
+    begin                : Sat Sep 21 2002
+    copyright            : (C) 2002 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+#include &lt;ADM_assert.h&gt;
+#include &lt;math.h&gt;
+#include &quot;config.h&quot;
+#include &quot;fourcc.h&quot;
+#include &quot;avio.hxx&quot;
+#include &quot;config.h&quot;
+#include &quot;avi_vars.h&quot;
+
+
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+#include &quot;ADM_editor/ADM_edit.hxx&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+#include &quot;ADM_video/ADM_vidCommonFilter.h&quot;
+#include &quot;ADM_resizebis.hxx&quot;
+ 
+ 
+ /*
+  	Same as above but use a fixed size FIR size of 4
+   	Good until ~ half width
+
+
+*/
+INT *GetResamplingPatternFIR4(uint32_t original_width,
+			      uint32_t target_width, ResampleFunc * func)
+{
+    double scale, filter_step,filter_support;
+    double pos_step ;
+
+    scale = double (target_width);
+    scale/= (double)original_width;
+    if (scale &lt; 1.0)
+	filter_step = scale;
+
+    else
+	filter_step = 1.0;
+    filter_support = func-&gt;support;
+    filter_support /= filter_step;
+    
+    int fir_filter_size = 3;
+    
+    
+    int16_t  *result = new int16_t[1 + target_width * (1 + fir_filter_size)];
+    int16_t  *cur = result;
+    
+    *cur++ = fir_filter_size;
+   
+    printf(&quot;\n Fixed Fir size : %d&quot;,fir_filter_size);
+    pos_step=original_width;
+    pos_step /= target_width;
+
+ 
+
+    // the following translates such that the image center remains fixed
+    double pos = original_width;
+
+       pos-= target_width ;
+       pos/= (target_width * 2);
+
+//   printf(&quot;\n In width : %lu out width : %lu pos_step : %lf pos_initial : %lf&quot;,original_width,target_width, pos_step,pos);
+
+    for (uint32_t i = 0; i &lt; target_width; ++i)
+
+      {
+	  INT end_pos = (INT) (pos + filter_support);
+	  if (end_pos &gt; (INT)original_width - 1)
+	      end_pos = original_width - 1;
+	  INT start_pos = end_pos - fir_filter_size + 1;
+	  if (start_pos &lt; 0)
+	      start_pos = 0;
+	  *cur++ = start_pos;
+
+	  // the following code ensures that the coefficients add to exactly 65536
+	  double total = 0.0;
+	  for (int j = 0; j &lt; fir_filter_size; ++j)
+	      total += func-&gt;f((start_pos + j - pos) * filter_step);
+	  double total2 = 0.0;
+	  for (int k = 0; k &lt; fir_filter_size; ++k)
+
+	    {
+		double total3 =
+		    total2 +func-&gt;f((start_pos + k - pos) * filter_step) / total;
+		    *cur++ =int (total3 * 256 + 0.5) - int (total2 * 256 +
+						      0.5);
+		total2 = total3;
+	    } 
+            pos += pos_step;
+      } 
+      return (INT *)result;
+}
+
+
+
+
+/*
+      Vertical resizing
+
+  		Fast resample, FIR= 4 hardcoded
+    
+    	the input is byte
+     	the coef are signed 16 bits integere
+
+*/
+void AVDMVideoStreamResize::ResizeVFIR4(Image * iin, Image * iout,
+				    INT *intpattern)
+{
+    int16_t *pattern = (int16_t *)intpattern;
+
+    int16_t *cur = pattern;
+    /*int fir_filter_width = *cur++*/cur++;
+    int row_size = iin-&gt;width;
+    unsigned char *out = iout-&gt;data;
+    unsigned char *srcbuffer = iin-&gt;data;
+    unsigned char *base ,*base2;
+		int total;
+		
+			
+
+    for (uint32_t y = 0; y &lt; iout-&gt;height; ++y)
+
+      {
+	  			base = srcbuffer + row_size * (*cur++);
+	  			for (int x = 0; x &lt; row_size; ++x)
+				  {
+					
+					 base2 = base + x;
+					 
+					    		total = *base2 							 * cur[0];
+					    		total += *(base2+row_size) 		 * cur[1];
+					    		total += *(base2+(row_size&lt;&lt;1)) * cur[2];		      			
+					    		//total += *(base2 + row_size*3) * cur[3];
+								  *out++ = ScaledPixelClip8(total);
+	  			  } 
+				cur += 3;
+		}
+}
+
+
+/*
+  		Fast resample, FIR= 4 hardcoded
+    
+    	the input is byte
+     	the coef are signed 16 bits integere
+
+*/
+void AVDMVideoStreamResize::ResizeHFIR4(Image * iin, Image * iout,
+				    INT  *bigpattern)
+{
+    uint8_t *base = iin-&gt;data;
+    uint8_t *out 	= iout-&gt;data;
+  
+    int src_row_size = iin-&gt;width;
+    int dst_row_size = iout-&gt;width;
+    int16_t *pattern=(int16_t *)bigpattern;
+    
+		uint8_t 				*ptr;
+		int16_t 				*cur;
+		static int32_t 	total;
+		//int32_t					*t=&total;
+  	int16_t 				ofs;
+   
+	for (uint32_t y =  iin-&gt;height; y&gt;0; y--)
+      {
+	  	cur = pattern + 1;	   
+		  for (int x = 0; x &lt; dst_row_size ; x++)
+	    {
+				ofs = *cur++;
+				ptr= &amp;(base[(ofs )]);
+      	total=0;
+	
+				total =  *(ptr) 	* *(cur);
+				total += *(ptr+1) * *(cur+1);
+		  	total += *(ptr+2) * *(cur+2);
+//		  	total += *(ptr+3) * *(cur+3);   		   		
+      	cur+=3;
+		  	*out++ = ScaledPixelClip8(total);
+	    } // next line...
+	     base += src_row_size;
+	}
+}

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidResize.cpp (from rev 3261, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidResize.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidResize.cpp	2007-06-16 16:47:26 UTC (rev 3261)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADM_vidResize.cpp	2007-06-17 15:31:18 UTC (rev 3267)
@@ -0,0 +1,197 @@
+/***************************************************************************
+                          ADM_vidResize.cpp  -  description
+                             -------------------
+   Resize a picture in YUV12
+
+   w,h 		size of final picture
+   dw,dh  size of black bordered picture
+
+
+    begin                : Thu Mar 21 2002
+    copyright            : (C) 2002 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+#include &lt;ADM_assert.h&gt;
+
+#include &quot;config.h&quot;
+#include &quot;fourcc.h&quot;
+#include &quot;avio.hxx&quot;
+#include &quot;config.h&quot;
+#include &quot;avi_vars.h&quot;
+#ifdef HAVE_ENCODER
+
+
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+#include &quot;ADM_editor/ADM_edit.hxx&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+#include &quot;ADM_resizebis.hxx&quot;
+#include &quot;ADM_video/ADM_vidCommonFilter.h&quot;
+#include &quot;ADM_filter/video_filters.h&quot;
+
+
+static FILTER_PARAM mpresizeParam={3,{&quot;w&quot;,&quot;h&quot;,&quot;algo&quot;}};
+SCRIPT_CREATE(resize_script,AVDMVideoStreamResize,mpresizeParam);
+BUILD_CREATE(resize_create,AVDMVideoStreamResize);
+
+char *AVDMVideoStreamResize::printConf( void )
+{
+ 	static char buf[50];
+ 	
+ 	sprintf((char *)buf,&quot; Resize %lu x %lu --&gt; %lu x %lu&quot;,
+ 				_in-&gt;getInfo()-&gt;width,
+ 				_in-&gt;getInfo()-&gt;height,
+ 				_info.width,
+ 				_info.height);
+        return buf;
+}
+//_______________________________________________________________
+AVDMVideoStreamResize::AVDMVideoStreamResize(
+									AVDMGenericVideoStream *in,CONFcouple *couples)
+{
+
+  	_in=in;
+   	memcpy(&amp;_info,_in-&gt;getInfo(),sizeof(_info));
+	_uncompressed=new ADMImage(_info.width,_info.height);
+
+		if(couples)
+		{
+			 _param=NEW(RESIZE_PARAMS);
+			GET(w);
+			GET(h);
+			GET(algo);
+			_info.width=_param-&gt;w;
+			_info.height=_param-&gt;h;
+
+		}
+			else
+			{
+				_param=NEW( RESIZE_PARAMS);
+				_param-&gt;w=_info.width;
+				_param-&gt;h = _info.height;
+				_param-&gt;algo = 0;
+			}			
+			_intermediate_buffer=new uint8_t [3*_info.width*_in-&gt;getInfo()-&gt;height];	
+
+  _info.encoding=1;
+  _init=0;
+	Vpattern_luma=NULL;
+    Vpattern_chroma=NULL;
+	Hpattern_luma=NULL;
+    Hpattern_chroma=NULL;
+}
+#if !defined(MPLAYER_RESIZE_PREFFERED) 
+AVDMGenericVideoStream *createResizeFromParam(AVDMGenericVideoStream *in,uint32_t x,uint32_t y)
+{
+
+	return new AVDMVideoStreamResize(in,x,y);
+}
+#endif
+AVDMVideoStreamResize::AVDMVideoStreamResize(
+									AVDMGenericVideoStream *in,uint32_t x,uint32_t y)
+{
+
+  	_in=in;
+   	memcpy(&amp;_info,_in-&gt;getInfo(),sizeof(_info));
+	_uncompressed=new ADMImage(_info.width,_info.height);
+	_param=NEW( RESIZE_PARAMS);
+	_param-&gt;w=x;
+	_param-&gt;h = y;
+	_info.width=_param-&gt;w;
+	_info.height=_param-&gt;h;
+	_param-&gt;algo = 0;
+	_intermediate_buffer=new uint8_t [3*_info.width*_in-&gt;getInfo()-&gt;height];
+
+	_info.encoding=1;
+	_init=0;
+	Vpattern_luma=NULL;
+	Vpattern_chroma=NULL;
+	Hpattern_luma=NULL;
+	Hpattern_chroma=NULL;
+}
+
+uint8_t	AVDMVideoStreamResize::getCoupledConf( CONFcouple **couples)
+{
+
+			ADM_assert(_param);
+			*couples=new CONFcouple(3);
+
+#define CSET(x)  (*couples)-&gt;setCouple((char *)#x,(_param-&gt;x))
+	CSET(w);
+	CSET(h);
+	CSET(algo);
+			return 1;
+
+}
+// ___ destructor_____________
+AVDMVideoStreamResize::~AVDMVideoStreamResize()
+{
+ 	delete  _uncompressed;
+	delete [] _intermediate_buffer;
+	DELETE(_param);
+	_uncompressed=NULL;
+	_intermediate_buffer=NULL;
+ 	endcompute();
+}
+
+//
+//	Basically ask a uncompressed frame from editor and ask
+//		GUI to decompress it .
+//
+
+uint8_t AVDMVideoStreamResize::getFrameNumberNoAlloc(uint32_t frame,
+				uint32_t *len,
+   				ADMImage *data,
+				uint32_t *flags)
+{
+static Image in,out;
+	if(frame&gt;=_info.nb_frames) 
+	{
+		printf(&quot;Filter : out of bound!\n&quot;);
+		return 0;
+	}
+	
+	ADM_assert(_param);	
+	if(!_in-&gt;getFrameNumberNoAlloc(frame, len,_uncompressed,flags)) return 0;
+       		
+	// do the resize in 3 passes, Y, U then V
+	in.width=_in-&gt;getInfo()-&gt;width;
+	in.height=_in-&gt;getInfo()-&gt;height;
+	in.data=_uncompressed-&gt;data;
+
+	out.width=_info.width;
+	out.height=_info.height;
+	out.data=data-&gt;data;	
+	if(!_init)
+	{
+		_init=1;
+		printf(&quot;\n Precomputing with algo :%lu\n&quot;,_param-&gt;algo);
+		if(_param-&gt;algo&gt;2)
+                {
+			printf(&quot;\n Wrong algorithm selection&quot;);
+			ADM_assert(0);
+		}
+		precompute(&amp;out,&amp;in, _param-&gt;algo );
+	}
+       	zoom(&amp;out,&amp;in)         ;       
+       data-&gt;flags=*flags=_uncompressed-&gt;flags;
+
+       *len= _info.width*_info.height+(_info.width*_info.height&gt;&gt;1);
+       data-&gt;copyInfo(_uncompressed);	
+      return 1;
+}
+
+
+#endif

Copied: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/ADMmpdetc.cpp (from rev 3261, branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_mpdetc.cpp)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/CMakeLists.txt
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/CMakeLists.txt	2007-06-17 13:36:53 UTC (rev 3266)
+++ branches/avidemux_2.4_branch/avidemux/ADM_videoFilter/CMakeLists.txt	2007-06-17 15:31:18 UTC (rev 3267)
@@ -1,13 +1,22 @@
 
 SET(ADM_videoFilter_SRCS 
-ADM_lavpp_deint.cpp      ADM_vidDecTelecide.cpp      ADM_vidFields.cpp           ADM_vidMcDeint.cpp    ADM_vidPulldown.cpp       ADM_vidSwapSmart.cpp
-ADM_vidAddBorder.cpp     ADM_vidDeintASM.cpp         ADM_vidFlipV.cpp            ADM_vidMosaic.cpp     ADM_vidResampleFPS.cpp    ADM_vidUVSwap.cpp
-ADM_vidASS.cpp           ADM_vidDeinterlace.cpp      ADM_vidFlux.cpp             ADM_vidMPLD3D.cpp     ADM_vidReverse.cpp        ADM_vidVlad.cpp
-ADM_vidBlend.cpp         ADM_vidDenoise.cpp          ADM_vidForcedPP.cpp         ADM_vidMPLD3Dlow.cpp  ADM_vidRotate.cpp         ADM_vidWhirl.cpp
-ADM_vidBlendRemoval.cpp  ADM_vidDGbob.cpp            ADM_vidHardIvtcRemoval.cpp  ADM_vidMSharpen.cpp   ADM_vidSeparateField.cpp  ADM_vidYadif.cpp
-ADM_vidBSmear.cpp        ADM_vidDropOut.cpp          ADM_vidKernelDeint.cpp      ADM_vidMsmooth.cpp    ADM_vidSoften.cpp
-ADM_vidChroma.cpp        ADM_vidFade.cpp             ADM_vidLargeMedian.cpp      ADM_vidPalShift.cpp   ADM_vidStabilize.cpp
-ADM_vidDecDec.cpp        ADM_vidFastConvolution.cpp  ADM_vidLuma.cpp             ADM_vidPalSmart.cpp   ADM_vidSwapFields.cpp
+ADM_lavpp_deint.cpp      ADM_vidDecTelecide.cpp      ADM_vidFields.cpp           ADM_vidMcDeint.cpp    
+ADM_vidPulldown.cpp       ADM_vidSwapSmart.cpp
+ADM_vidAddBorder.cpp     ADM_vidDeintASM.cpp         ADM_vidFlipV.cpp            ADM_vidMosaic.cpp     
+ADM_vidResampleFPS.cpp    ADM_vidUVSwap.cpp
+ADM_vidASS.cpp           ADM_vidDeinterlace.cpp      ADM_vidFlux.cpp             ADM_vidMPLD3D.cpp     
+ADM_vidReverse.cpp        ADM_vidVlad.cpp
+ADM_vidBlend.cpp         ADM_vidDenoise.cpp          ADM_vidForcedPP.cpp         ADM_vidMPLD3Dlow.cpp  
+ADM_vidRotate.cpp         ADM_vidWhirl.cpp
+ADM_vidBlendRemoval.cpp  ADM_vidDGbob.cpp            ADM_vidHardIvtcRemoval.cpp  ADM_vidMSharpen.cpp   
+ADM_vidSeparateField.cpp  ADM_vidYadif.cpp
+ADM_vidBSmear.cpp        ADM_vidDropOut.cpp          ADM_vidKernelDeint.cpp      ADM_vidMsmooth.cpp    
+ADM_vidSoften.cpp
+ADM_vidChroma.cpp        ADM_vidFade.cpp             ADM_vidLargeMedian.cpp      ADM_vidPalShift.cpp   
+ADM_vidStabilize.cpp
+ADM_vidDecDec.cpp        ADM_vidFastConvolution.cpp  ADM_vidLuma.cpp             ADM_vidPalSmart.cpp   
+ADM_vidSwapFields.cpp
 ADM_vidYadif_asm.c
+ADM_guiResize.cpp  ADM_resizebis.cpp  ADM_resizeter.cpp  ADM_vidResize.cpp
 )
 ADD_LIBRARY(ADM_videoFilter STATIC ${ADM_videoFilter_SRCS})


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000555.html">[Avidemux-svn-commit] r3265 -	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory
</A></li>
	<LI>Next message: <A HREF="000557.html">[Avidemux-svn-commit] r3268 - in	branches/avidemux_2.4_branch/avidemux:	ADM_userInterfaces/ADM_NONE/ADM_dialog	ADM_userInterfaces/ADM_QT4/ADM_dialog	ADM_userInterfaces/ADM_commonUI ADM_video ADM_videoFilter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#556">[ date ]</a>
              <a href="thread.html#556">[ thread ]</a>
              <a href="subject.html#556">[ subject ]</a>
              <a href="author.html#556">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
