From mean at mail.berlios.de  Sat Oct  1 10:27:53 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat,  1 Oct 2011 10:27:53 +0200
Subject: [Avidemux-svn-commit] r7592 - in branches/avidemux_2.6_branch_mean:
	. avidemux/common/ADM_render avidemux_core/ADM_core/include
	avidemux_core/ADM_core/src
	avidemux_core/ffmpeg_package/patches cmake
Message-ID: <20111001082754.0700D481123@sheep.berlios.de>

Author: mean
Date: 2011-10-01 10:27:53 +0200 (Sat, 01 Oct 2011)
New Revision: 7592

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/config.mak.mac.diff
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_crashdump_apple.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_crashdump_apple.cpp
   branches/avidemux_2.6_branch_mean/bootStrapCrossMac106.sh
   branches/avidemux_2.6_branch_mean/cmake/admCheckOpenGl.cmake
   branches/avidemux_2.6_branch_mean/cmake/admCheckQt4.cmake
Log:
[Build] Cross max, part2, Qt4

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt	2011-09-30 05:29:44 UTC (rev 7591)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/CMakeLists.txt	2011-10-01 08:27:53 UTC (rev 7592)
@@ -13,7 +13,9 @@
 ENDIF (USE_OPENGL)
 
 IF (APPLE)
-	SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS} GUI_sdlRenderHelper.m)
+	IF(USE_SDL)
+		SET(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS} GUI_sdlRenderHelper.m)
+	ENDIF(USE_SDL)
 ENDIF (APPLE)
 
 ADD_LIBRARY(${ADM_LIB} SHARED ${${ADM_LIB}_SRCS})

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_crashdump_apple.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_crashdump_apple.h	2011-09-30 05:29:44 UTC (rev 7591)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_crashdump_apple.h	2011-10-01 08:27:53 UTC (rev 7592)
@@ -1,7 +1,7 @@
-#if defined(APPLE) && !defined ADM_CRASHDUMP_APPLE_H
+#if defined(__APPLE__) && !defined ADM_CRASHDUMP_APPLE_H
 #define ADM_CRASHDUMP_APPLE_H
 
 void installSigHandler(void);
-#define uninstallSigHandler()
+void uninstallSigHandler(void);
 
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_crashdump_apple.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_crashdump_apple.cpp	2011-09-30 05:29:44 UTC (rev 7591)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_crashdump_apple.cpp	2011-10-01 08:27:53 UTC (rev 7592)
@@ -37,6 +37,7 @@
 }
 
 void installSigHandler() {}
+void uninstallSigHandler() {}
 
 void ADM_backTrack(const char *info,int lineno,const char *file)
 {

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/config.mak.mac.diff
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/config.mak.mac.diff	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/config.mak.mac.diff	2011-10-01 08:27:53 UTC (rev 7592)
@@ -0,0 +1,11 @@
+--- config.mak	2011-09-29 06:16:53.420423396 +0000
++++ config.mak.new	2011-09-29 06:14:20.571908964 +0000
+@@ -59,7 +59,7 @@
+ LIBTARGET=
+-SLIBNAME=$(SLIBPREF)$(FULLNAME)$(SLIBSUF)
++SLIBNAME=$(SLIBPREF)ADM6$(FULLNAME)$(SLIBSUF)
+-SLIBNAME_WITH_VERSION=$(SLIBPREF)$(FULLNAME).$(LIBVERSION)$(SLIBSUF)
++SLIBNAME_WITH_VERSION=$(SLIBPREF)ADM6$(FULLNAME).$(LIBVERSION)$(SLIBSUF)
+-SLIBNAME_WITH_MAJOR=$(SLIBPREF)$(FULLNAME).$(LIBMAJOR)$(SLIBSUF)
++SLIBNAME_WITH_MAJOR=$(SLIBPREF)ADM6$(FULLNAME).$(LIBMAJOR)$(SLIBSUF)
+ SLIB_CREATE_DEF_CMD=

Modified: branches/avidemux_2.6_branch_mean/bootStrapCrossMac106.sh
===================================================================
--- branches/avidemux_2.6_branch_mean/bootStrapCrossMac106.sh	2011-09-30 05:29:44 UTC (rev 7591)
+++ branches/avidemux_2.6_branch_mean/bootStrapCrossMac106.sh	2011-10-01 08:27:53 UTC (rev 7592)
@@ -4,7 +4,7 @@
 export SDLDIR=/opt/mac
 export TOOLCHAIN_DIR=/opt/mac/bin
 export XSDK=/opt/mac/SDKs/MacOSX10.6.sdk/usr
-export QT_HOME=/opt/mac/Qt/4.5.2
+export QT_HOME=/opt/mac/SDKs/MacOSX10.6.sdk/Library/Frameworks/
 # ** Put your config here **
 
 fail()
@@ -22,7 +22,8 @@
         mkdir $BUILDDIR || fail mkdir
         cd $BUILDDIR 
         sh $TOP/foreignBuilds/$SCRIPT || fail cmake
-        make -j 2 > /tmp/log$BUILDDIR || fail make
+        make   || fail make
+        #make -j 2 > /tmp/log$BUILDDIR || fail make
         make install || fail make_install
 }
 
@@ -31,16 +32,17 @@
 echo "Top dir : $TOP"
 echo "** CORE **"
 cd $TOP
-Process buildMingwCore cross_mac104_core
+Process buildMacCore cross_mac104_core
 echo "** QT4 **"
 cd $TOP
-Process buildMingwQt4 cross_mac104_qt4 
+Process buildMacQt4 cross_mac104_qt4 
 #echo "** GTK **"
 #cd $TOP
-#Process buildGtk ../avidemux/gtk
+Process buildMacGtk ../avidemux/gtk
 echo "** Plugins **"
 cd $TOP
-Process buildMingwPlugins cross_mac104_plugins 
+#Process buildMacPluginsCommon cross_mingw_plugins -DPLUGIN_UI=COMMON
+#Process buildMacPluginsQt4 cross_mingw_plugins -DPLUGIN_UI=QT4
 echo "** All done **"
 cd $TOP
 echo "** ALL DONE **"

Modified: branches/avidemux_2.6_branch_mean/cmake/admCheckOpenGl.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admCheckOpenGl.cmake	2011-09-30 05:29:44 UTC (rev 7591)
+++ branches/avidemux_2.6_branch_mean/cmake/admCheckOpenGl.cmake	2011-10-01 08:27:53 UTC (rev 7592)
@@ -11,9 +11,14 @@
                IF (QT_QTOPENGL_FOUND)
                        MESSAGE(STATUS "Found QtOpenGL")
                        IF(CROSS)
-                                SET(OPENGL_INCLUDE_DIR  "${MINGW}/include" )
-                                SET(OPENGL_LIBRARIES "-lopengl32 -lglu32")
-                                SET(OPENGL_FOUND 1)
+				IF(NOT APPLE)
+                                	SET(OPENGL_FOUND 1)
+                                	SET(OPENGL_INCLUDE_DIR  "${MINGW}/include" )
+                                	SET(OPENGL_LIBRARIES "-lopengl32 -lglu32")
+				ELSE(NOT APPLE)
+                                	SET(OPENGL_INCLUDE_DIR  "${MINGW}/include" )
+                                	SET(OPENGL_LIBRARIES "-framework OpenGL ")
+				ENDIF(NOT APPLE)
                                 MESSAGE(STATUS "Cross compilation override, Skipping openGl search")
                        ELSE(CROSS)
                        	        FIND_PACKAGE(OpenGL)

Modified: branches/avidemux_2.6_branch_mean/cmake/admCheckQt4.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admCheckQt4.cmake	2011-09-30 05:29:44 UTC (rev 7591)
+++ branches/avidemux_2.6_branch_mean/cmake/admCheckQt4.cmake	2011-10-01 08:27:53 UTC (rev 7592)
@@ -6,27 +6,44 @@
 		MESSAGE(STATUS "*****************")
                 IF(CROSS)
                         MESSAGE(STATUS "Cross compiling override for QT4")
-                        SET(QT_QTOPENGL_FOUND 1)
-                        SET(QT_VERSION_MINOR 7)
+			IF(APPLE)
+                        	SET(QT_VERSION_MINOR 6)
+                        	SET(QT_INCLUDE_DIR "/opt/mac/SDKs/MacOSX10.6.sdk/Library/Frameworks/")
+                        	SET(OPENGL_INCLUDE_DIR "/opt/mac/SDKs/MacOSX10.6.sdk/Library/Frameworks/")
+                        	SET(QT_HEADERS_DIR "${QT_INCLUDE_DIR}")
+                        	SET(QT_INCLUDES "-I${QT_INCLUDE_DIR}")
 
-                        SET(QT_QTOPENGL_LIBRARY ${QT_HOME}/lib/libQtOpenGL4.a)
-                        SET(QT_QTOPENGL_INCLUDE_DIR ${QT_HOME}/include/QtOpenGL)
+                        	SET(QT_QTOPENGL_LIBRARY "-framework QtOpenGL")
+                        	SET(QT_QTOPENGL_INCLUDE_DIR "/opt/mac/SDKs/MacOSX10.6.sdk/Library/Frameworks/Qt4/QtOpenGL")
+                        	SET(QT_LIBRARY_DIR ${QT_HOME}/lib)
 
-                        SET(QT_HEADERS_DIR "${QT_HOME}/include/")
+                        	SET(QT_QTCORE_LIBRARY "-framework QtCore")
+                        	SET(QT_QTGUI_LIBRARY  "-framework QtGui -framework Cocoa")
 
-                        SET(QT_INCLUDES "-I${QT_HOME}/include")
-                        SET(QT_INCLUDE_DIR "${QT_HOME}/include")
-                        SET(QT_BINARY_DIR ${QT_HOME}/bin)
-                        SET(QT_LIBRARY_DIR ${QT_HOME}/lib)
-                        SET(QT4_FOUND 1)
-                        SET(QT_RCC_EXECUTABLE rcc)
-                        SET(QT_MOC_EXECUTABLE moc-qt4)
-                        SET(QT_UIC_EXECUTABLE uic-qt4)
-                        SET(QT_QTCORE_LIBRARY ${QT_HOME}/lib/libQtCore4.a)
-                        SET(QT_QTGUI_LIBRARY ${QT_HOME}/lib/libQtGui4.a)
-                        MESSAGE(STATUS "[QT4Include] ${QT_INCLUDES}")
-                        MESSAGE(STATUS "[QT4IncludeDir] ${QT_INCLUDE_DIR}")
-                        include(admCrossQt4)
+                        	MESSAGE(STATUS "[QT4IncludeDir] ${QT_INCLUDE_DIR}")
+			ELSE(APPLE)
+                        	SET(QT_QTOPENGL_FOUND 1)
+                        	SET(QT_VERSION_MINOR 7)
+	
+                        	SET(QT_QTOPENGL_LIBRARY ${QT_HOME}/lib/libQtOpenGL4.a)
+                        	SET(QT_QTOPENGL_INCLUDE_DIR ${QT_HOME}/include/QtOpenGL)
+
+                        	SET(QT_HEADERS_DIR "${QT_HOME}/include/")
+
+                        	SET(QT_INCLUDES "-I${QT_HOME}/include")
+                        	SET(QT_INCLUDE_DIR "${QT_HOME}/include")
+                        	SET(QT_BINARY_DIR ${QT_HOME}/bin)
+                        	SET(QT_LIBRARY_DIR ${QT_HOME}/lib)
+                        	SET(QT_QTCORE_LIBRARY ${QT_HOME}/lib/libQtCore4.a)
+                        	SET(QT_QTGUI_LIBRARY ${QT_HOME}/lib/libQtGui4.a)
+			ENDIF(APPLE)
+                        	SET(QT4_FOUND 1)
+                        	SET(QT_RCC_EXECUTABLE rcc)
+                        	SET(QT_MOC_EXECUTABLE moc-qt4)
+                        	SET(QT_UIC_EXECUTABLE uic-qt4)
+                        	MESSAGE(STATUS "[QT4Include] ${QT_INCLUDES}")
+                        	MESSAGE(STATUS "[QT4IncludeDir] ${QT_INCLUDE_DIR}")
+                        	include(admCrossQt4)
                         
                                
 



From mean at mail.berlios.de  Sun Oct  2 18:41:49 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  2 Oct 2011 18:41:49 +0200
Subject: [Avidemux-svn-commit] r7593 -
	branches/avidemux_2.6_branch_mean/foreignBuilds
Message-ID: <20111002164149.86C6C481229@sheep.berlios.de>

Author: mean
Date: 2011-10-02 18:41:49 +0200 (Sun, 02 Oct 2011)
New Revision: 7593

Added:
   branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_plugins
   branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_qt4
Modified:
   branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_core
Log:
 [build] Cross Mac part 3, plugins

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_core
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_core	2011-10-01 08:27:53 UTC (rev 7592)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_core	2011-10-02 16:41:49 UTC (rev 7593)
@@ -5,14 +5,14 @@
 export CFLAGS="$CXXFLAGS"
 export CPPFLAGS="$CXXFLAGS"
 export LDFLAGS="-L$XSDK/lib"
-export PATH=$XSDK/bin:$PATH:$TOOLCHAIN_DIR
+export PATH=$PATH:$XSDK/bin:$TOOLCHAIN_DIR
 pkg-config --list-all
 #export DEBUG="-DVERBOSE=1 -DDEBUG=1  -DCMAKE_BUILD_TYPE=Debug    "
 echo "<<<<<<<<<<<<Cross compiling core ($XSDK)>>>>>>>>>>>>>>>>"
 cmake   -DCROSS=$XSDK \
-	-DCROSS_MAC=104 \
+	-DFAKEROOT=$DST/ \
 	-DCMAKE_SYSTEM_NAME=Darwin  \
-        -DCMAKE_INSTALL_PREFIX=$XSDK/Release \
+        -DCMAKE_INSTALL_PREFIX=/Release \
 	-DCMAKE_CROSS_PREFIX=$CROSS_PREFIX \
         -DCMAKE_C_COMPILER:STRING=$CROSS_PREFIX-gcc \
         -DCMAKE_CXX_COMPILER:STRING=$CROSS_PREFIX-g++ \

Added: branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_plugins
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_plugins	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_plugins	2011-10-02 16:41:49 UTC (rev 7593)
@@ -0,0 +1,26 @@
+#!/bin/bash
+#
+export PKG_CONFIG_PATH=$wXSDK/lib/pkgconfig
+export PKG_CONFIG_LIBDIR=$XSDK/lib/pkgconfig
+export CXXFLAGS="-arch i386"
+export CFLAGS="$CXXFLAGS"
+export CPPFLAGS="$CXXFLAGS"
+export LDFLAGS="-L$XSDK/lib"
+export PATH=$PATH:$XSDK/bin:$TOOLCHAIN_DIR
+pkg-config --list-all
+pkg-config --list-all
+#export DEBUG="-DVERBOSE=1   -DCMAKE_BUILD_TYPE=Debug -G \"CodeBlocks - Unix Makefiles\"   "
+echo "<<<<<<<<<<<<Cross compiling plugins>>>>>>>>>>>>>>>"
+cmake   -DCROSS=$XSDK \
+        -DCMAKE_INSTALL_PREFIX=/Release \
+	-DFAKEROOT=$DST/ \
+        -DCMAKE_C_COMPILER:STRING=$CROSS_PREFIX-gcc \
+        -DCMAKE_CXX_COMPILER:STRING=$CROSS_PREFIX-g++ \
+        -DCMAKE_LINKER:STRING=$CROSS_PREFIX-ld \
+        -DCMAKE_AR:STRING=$CROSS_PREFIX-ar \
+        -DCMAKE_SYSTEM_NAME:STRING=Darwin \
+        -DQT_HOME:STRING=$QT_HOME \
+         $DEBUG -G "CodeBlocks - Unix Makefiles"  \
+        -DAVIDEMUX_SOURCE_DIR="$TOP"  \
+        $@ \
+        $TOP/avidemux_plugins

Copied: branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_qt4 (from rev 7592, branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_core)
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_qt4	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/cross_mac104_qt4	2011-10-02 16:41:49 UTC (rev 7593)
@@ -0,0 +1,27 @@
+#!/bin/bash
+#
+export PKG_CONFIG_PATH=$wXSDK/lib/pkgconfig
+export PKG_CONFIG_LIBDIR=$XSDK/lib/pkgconfig
+export CXXFLAGS="-arch i386"
+export CFLAGS="$CXXFLAGS"
+export CPPFLAGS="$CXXFLAGS"
+export LDFLAGS="-L$XSDK/lib"
+export PATH=$PATH:$XSDK/bin:$TOOLCHAIN_DIR
+pkg-config --list-all
+#export DEBUG="-DVERBOSE=1   -DCMAKE_BUILD_TYPE=Debug -G \"CodeBlocks - Unix Makefiles\"   "
+echo "<<<<<<<<<<<<Cross compiling core>>>>>>>>>>>>>>>"
+cmake   -DCROSS=$XSDK \
+	-DCROSS_MAC=104 \
+	-DFAKEROOT=$DST/ \
+	-DCMAKE_SYSTEM_NAME=Darwin  \
+        -DCMAKE_INSTALL_PREFIX=/Release \
+        -DQT_HOME:STRING=$QT_HOME \
+	-DCMAKE_CROSS_PREFIX=$CROSS_PREFIX \
+        -DCMAKE_WINDRES=$CROSS_PREFIX-windres \
+        -DCMAKE_C_COMPILER:STRING=$CROSS_PREFIX-gcc \
+        -DCMAKE_CXX_COMPILER:STRING=$CROSS_PREFIX-g++ \
+        -DCMAKE_LINKER:STRING=$CROSS_PREFIX-ld \
+        -DCMAKE_AR:STRING=$CROSS_PREFIX-ar \
+        $DEBUG \
+        -DAVIDEMUX_TOP_SOURCE_DIR="$TOP"  \
+        $TOP/avidemux/qt4



From mean at mail.berlios.de  Mon Oct 10 08:19:08 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 10 Oct 2011 08:19:08 +0200
Subject: [Avidemux-svn-commit] r7594 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska
Message-ID: <20111010061909.07ECB481390@sheep.berlios.de>

Author: mean
Date: 2011-10-10 08:19:08 +0200 (Mon, 10 Oct 2011)
New Revision: 7594

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvTrackType.cpp
Log:
[mkv/demux] Add support for ACM Header in MKV

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp	2011-10-02 16:41:49 UTC (rev 7593)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvEntries.cpp	2011-10-10 06:19:08 UTC (rev 7594)
@@ -95,6 +95,8 @@
 
       entryWalk(  (ADM_ebml_file *)head,headlen,&entry);
       entry.dump();
+
+      //***************** First video track *****************
       if(entry.trackType==1 &&  !_isvideopresent)
       {
         _isvideopresent=1;
@@ -167,11 +169,43 @@
         
         return 1;
       }
+      //***************** Audio tracks *****************
       if(entry.trackType==2 && _nbAudioTrack<ADM_MKV_MAX_TRACKS)
       {
          uint32_t  streamIndex;
          mkvTrak *t=&(_tracks[1+_nbAudioTrack]);
 
+        // MS/ACM : ACMX
+        if(0x100001==entry.fcc)
+        {
+            int l=entry.extraDataLen;
+            int wavSize=sizeof(WAVHeader);
+            ADM_info("Found ACM compatibility header (%d / %d)\n",l,wavSize);
+            if(l>=wavSize) // we need at least a wavheader
+            {
+                mixDump(entry.extraData,l); printf("\n");
+                memcpy(&(t->wavHeader),entry.extraData,wavSize);
+                ADM_info("Encoding : %d\n",t->wavHeader.encoding);
+                int x=l-wavSize;
+                
+                if(x>0) // If we have more than a wavheader, it is extradata
+                {
+                    t->extraData=new uint8_t[x];
+                    t->extraDataLen=x;
+                    memcpy(t->extraData,entry.extraData+wavSize,x);
+                }
+                delete [] entry.extraData;
+                t->streamIndex=entry.trackNo;
+                if(entry.defaultDuration)
+                    t->_defaultFrameDuration=entry.defaultDuration;
+                else
+                    t->_defaultFrameDuration=0;
+                // In ACM mode we should not have the stripped header stuff..
+                _nbAudioTrack++;
+                return 1;
+            }
+        }
+
          t->wavHeader.encoding=entry.fcc;
          t->wavHeader.channels=entry.chan;
          t->wavHeader.frequency=entry.fq;
@@ -194,6 +228,7 @@
         _nbAudioTrack++;
         return 1;
       }
+      // Other tracks, ignored...
       if(entry.extraData) delete [] entry.extraData;
       return 1;
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvTrackType.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvTrackType.cpp	2011-10-02 16:41:49 UTC (rev 7593)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Matroska/ADM_mkvTrackType.cpp	2011-10-10 06:19:08 UTC (rev 7594)
@@ -49,6 +49,8 @@
   {"A_DTS",0,WAV_DTS,""},
   {"A_MPEG/L2",0,WAV_MP2,""},
   {"A_MPEG/L1",0,WAV_MP2,""},
+  {"A_MS/ACM",0,0x100001,"ACMX"}, 
+
   // Video
   {"V_VP8",1,0,"VP8 "}, // Mpeg2
   {"V_MPEG2",1,0,"MPEG"}, // Mpeg2



From mean at mail.berlios.de  Mon Oct 10 08:19:10 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 10 Oct 2011 08:19:10 +0200
Subject: [Avidemux-svn-commit] r7595 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog
Message-ID: <20111010061910.40F22481390@sheep.berlios.de>

Author: mean
Date: 2011-10-10 08:19:09 +0200 (Mon, 10 Oct 2011)
New Revision: 7595

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/Q_props.cpp
Log:
[UI/Qt4] Make sure packed vop, gmc & friends have a sane default value

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/Q_props.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/Q_props.cpp	2011-10-10 06:19:08 UTC (rev 7594)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_dialog/Q_props.cpp	2011-10-10 06:19:09 UTC (rev 7595)
@@ -26,7 +26,7 @@
 propWindow::propWindow(QWidget *parent) : QDialog(parent)
  {
      ui.setupUi(this);
-     uint8_t gmc, qpel,vop;
+     uint8_t gmc=0, qpel=0,vop=0;
  uint32_t info=0;
  uint32_t war,har;
  uint32_t hh, mm, ss, ms;



From mean at mail.berlios.de  Mon Oct 10 08:19:11 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 10 Oct 2011 08:19:11 +0200
Subject: [Avidemux-svn-commit] r7596 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111010061911.6F321481390@sheep.berlios.de>

Author: mean
Date: 2011-10-10 08:19:11 +0200 (Mon, 10 Oct 2011)
New Revision: 7596

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
Log:
[wmv] Plainly fail if no image found

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-10 06:19:09 UTC (rev 7595)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-10 06:19:11 UTC (rev 7596)
@@ -168,6 +168,11 @@
         _audioAccess[i]=new asfAudioAccess(this,i);
         _audioStreams[i]=ADM_audioCreateStream(&(_allAudioTracks[i].wavHeader), _audioAccess[i]);
   }
+  if(!nbImage)
+    {
+        ADM_error("No image found \n");
+        return 0;
+    }
   return 1;
 }
 /**



From mean at mail.berlios.de  Mon Oct 10 08:19:12 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 10 Oct 2011 08:19:12 +0200
Subject: [Avidemux-svn-commit] r7597 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <20111010061912.907B2481390@sheep.berlios.de>

Author: mean
Date: 2011-10-10 08:19:12 +0200 (Mon, 10 Oct 2011)
New Revision: 7597

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edAudioPacket.cpp
Log:
[Editor] Flush PCM decoder after seek

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edAudioPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edAudioPacket.cpp	2011-10-10 06:19:11 UTC (rev 7596)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edAudioPacket.cpp	2011-10-10 06:19:12 UTC (rev 7597)
@@ -213,6 +213,7 @@
     {
         _audioSeg=seg;
         setDts(ustime);
+        packetBufferSize=0; // Flush PCM decoder
         return true;
     }
     ADM_warning("Go to time failed\n");



From mean at mail.berlios.de  Mon Oct 10 08:19:13 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 10 Oct 2011 08:19:13 +0200
Subject: [Avidemux-svn-commit] r7598 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include
Message-ID: <20111010061913.B1932481390@sheep.berlios.de>

Author: mean
Date: 2011-10-10 08:19:13 +0200 (Mon, 10 Oct 2011)
New Revision: 7598

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStreamConstantChunk.h
Log:
[CoreAudio] Fix Constant chunk

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStreamConstantChunk.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStreamConstantChunk.h	2011-10-10 06:19:12 UTC (rev 7597)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioStreamConstantChunk.h	2011-10-10 06:19:13 UTC (rev 7598)
@@ -16,9 +16,7 @@
 #ifndef ADM_audioStreamConstantChunk_H
 #define ADM_audioStreamConstantChunk_H
 
-#include "ADM_audioStreamBuffered.h"
-#include <vector>
-using namespace std;
+#include "ADM_audioStream.h"
 
 
 /**
@@ -26,11 +24,11 @@
         \brief Class to handle MP3/MP3 streams
 
 */
-class ADM_audioStreamConstantChunk : public ADM_audioStreamBuffered
+class ADM_audioStreamConstantChunk : public ADM_audioStream
 {
         protected:
                         uint32_t  chunkSize;
-                        uint32_t samplesPerChunk;
+                        uint32_t  samplesPerChunk;
         public:
 /// Default constructor
                        ADM_audioStreamConstantChunk(WAVHeader *header,ADM_audioAccess *access);  



From mean at mail.berlios.de  Mon Oct 10 08:19:14 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 10 Oct 2011 08:19:14 +0200
Subject: [Avidemux-svn-commit] r7599 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src
Message-ID: <20111010061914.CE467481390@sheep.berlios.de>

Author: mean
Date: 2011-10-10 08:19:14 +0200 (Mon, 10 Oct 2011)
New Revision: 7599

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamConstantChunk.cpp
Log:
[CoreAudio] Fix Constant chunk

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamConstantChunk.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamConstantChunk.cpp	2011-10-10 06:19:13 UTC (rev 7598)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStreamConstantChunk.cpp	2011-10-10 06:19:14 UTC (rev 7599)
@@ -8,29 +8,31 @@
 #include "ADM_default.h"
 #include "ADM_audioStreamConstantChunk.h"
 #include "DIA_working.h"
+#include "ADM_vidMisc.h"
 /**
     \fn ADM_audioStreamConstantChunk
     \brief constructor
 */
-ADM_audioStreamConstantChunk::ADM_audioStreamConstantChunk(WAVHeader *header,ADM_audioAccess *access) : ADM_audioStreamBuffered(header,access)
+ADM_audioStreamConstantChunk::ADM_audioStreamConstantChunk(WAVHeader *header,ADM_audioAccess *access) 
+    : ADM_audioStream(header,access)
 {
     //
     chunkSize=header->blockalign;
     if(!chunkSize)
     {
-        printf("[ADM_audioStreamConstantChunk] Blockalign is null expect problems\n");
+        ADM_warning("[ADM_audioStreamConstantChunk] Blockalign is null expect problems\n");
         chunkSize=8192; // dummy value
     }
-    printf("[ADM_audioStreamConstantChunk] Chunk size %"LU"\n",chunkSize);
-    printf("[ADM_audioStreamConstantChunk] Byterate   %"LU"\n",header->byterate);
+    ADM_info("[ADM_audioStreamConstantChunk] Chunk size %"LU"\n",chunkSize);
+    ADM_info("[ADM_audioStreamConstantChunk] Byterate   %"LU"\n",header->byterate);
     // Compute sample per chunk from wavHeader...
     float f;
     f=chunkSize;
     f/=header->byterate; // F is in seconds
     f*=header->frequency; // in sample
     samplesPerChunk=(uint32_t)f;
-    printf("[ADM_audioStreamConstantChunk] About %"LU" samples per chunk\n",samplesPerChunk);
-
+    ADM_info("[ADM_audioStreamConstantChunk] About %"LU" samples per chunk\n",samplesPerChunk);
+    //samplesPerChunk=16;
     // If hinted..., compute the duration ourselves
     if(access->isCBR()==true && access->canSeekOffset()==true)
     {
@@ -40,6 +42,7 @@
               size*=1000;
               size*=1000; // s->us
               durationInUs=(uint64_t)size;
+              ADM_info("Computed duration %s\n",ADM_us2plain(durationInUs));
               return;
     }
 // Time based
@@ -62,21 +65,32 @@
 */
 uint8_t ADM_audioStreamConstantChunk::getPacket(uint8_t *buffer,uint32_t *size, uint32_t sizeMax,uint32_t *nbSample,uint64_t *dts)
 {
+    *size=0;
+    *nbSample=0;
+    if(sizeMax>=chunkSize)
+    {
+        uint32_t mSize;
+        uint64_t mDts;
+        if(!access->getPacket(buffer,&mSize,sizeMax,&mDts)) 
+        {
+                ADM_warning("Cant get packet\n");
+                return 0;
+        }
+        ADM_info("Got packet : chunk=%d size=%d dts=%s\n",chunkSize,mSize,ADM_us2plain(mDts));
+        if(!*size)
+            *dts=mDts;
 
-        // Do we have enough ? Refill if needed ?
-        if(needBytes(chunkSize)==false) return 0;
-        if(sizeMax<chunkSize)
+        *size+=mSize;
+        *nbSample+=samplesPerChunk;
+        if(mSize!=chunkSize)
         {
-            printf("[ADM_audioStreamConstantChunk] Buffer too small %"LU", need %"LU"\n",sizeMax,chunkSize);
-            return 0;
+            ADM_warning("Expected chunk of size =%d, got %d\n",chunkSize,mSize);
         }
-        *size=chunkSize;
-        read(chunkSize,buffer);
-        start+=chunkSize;
-        *nbSample=samplesPerChunk;
-        *dts=lastDts;
-        advanceDtsBySample(samplesPerChunk);
-        return 1;
-            
+
+        buffer+=mSize;
+        sizeMax-=mSize;
+     }
+     if(!*size) return 0;
+     return 1;
 }
 



From mean at mail.berlios.de  Mon Oct 10 08:19:16 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 10 Oct 2011 08:19:16 +0200
Subject: [Avidemux-svn-commit] r7600 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20111010061916.15982481390@sheep.berlios.de>

Author: mean
Date: 2011-10-10 08:19:15 +0200 (Mon, 10 Oct 2011)
New Revision: 7600

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsAudioProbe.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp
Log:
[TsDemux] In case of TRP, make sure video track is the 1st one when brute scanning stream

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsAudioProbe.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsAudioProbe.cpp	2011-10-10 06:19:14 UTC (rev 7599)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsAudioProbe.cpp	2011-10-10 06:19:15 UTC (rev 7600)
@@ -66,7 +66,7 @@
             case ADM_TS_AAC_LATM:
                         break;
             default:
-                ADM_warning("Unsupported audio track\n");
+                ADM_warning("Unsupported audio track (%d)\n",trackInfo->trackType);
                 return false;
         }
         // Go back where we were

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp	2011-10-10 06:19:14 UTC (rev 7599)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp	2011-10-10 06:19:15 UTC (rev 7600)
@@ -95,7 +95,7 @@
                 tracks[validTracks].trackPid=listOfPid[i];
                 tracks[validTracks].trackType=trackType;
                 validTracks++;
-            }        
+            }  else ADM_info("Cannot identify type\n");
         }
         if(!validTracks)
         {
@@ -112,6 +112,35 @@
     ts=NULL;
     delete [] buffer;
     buffer=NULL;
+    // Swap tracks if needed, track [0] must be video...
+    int videoIndex=-1;
+    for(int i=0;i<*nbTracks;i++)
+    {
+        ADM_TS_TRACK_TYPE type=tracks[i].trackType;
+        switch(type)
+        {
+            case ADM_TS_MPEG2:
+            case ADM_TS_VC1:
+            case ADM_TS_H264:
+                    videoIndex=i;
+                    break;
+            default: break;
+        }
+    }
+    if(videoIndex>0)
+    {
+        // Swap!
+        ADM_TS_TRACK trk=tracks[0];
+        tracks[0]=tracks[videoIndex];
+        tracks[videoIndex]=trk;
+    }
+    ADM_info("Summary : found %d tracks\n",(int)*nbTracks);
+    for(int i=0;i<*nbTracks;i++)
+    {
+        ADM_info("  Track : %d, pid=%d, type =%d\n",
+                    i,tracks[i].trackPid,tracks[i].trackType);
+    }
+    ADM_info("End of summary.\n");
     return result;
 }
 /**



From mean at mail.berlios.de  Tue Oct 11 08:03:30 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 11 Oct 2011 08:03:30 +0200
Subject: [Avidemux-svn-commit] r7601 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20111011060330.C42C9481377@sheep.berlios.de>

Author: mean
Date: 2011-10-11 08:03:30 +0200 (Tue, 11 Oct 2011)
New Revision: 7601

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp
Log:
[TS/TRP] Retry 10 times to get sync on mp2, not really good still

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp	2011-10-10 06:19:15 UTC (rev 7600)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp	2011-10-11 06:03:30 UTC (rev 7601)
@@ -210,6 +210,17 @@
     ADM_warning("dont know what it is...\n");
     return false;
 }
+
+static bool mp2Match(const MpegAudioInfo *array,int a, int b)
+{
+    const MpegAudioInfo *x=array+a;
+    const MpegAudioInfo *y=array+b;
+    if(x->bitrate<=32) return false;
+    if(x->bitrate!=y->bitrate) return false;
+    if(x->mode!=y->mode) return false;
+    if(x->samplerate!=y->samplerate) return false;
+    return true;
+}
 /**
     \fn idContent
 */
@@ -228,9 +239,6 @@
         uint32_t len=pes.payloadSize;
 
 
-        // 
-       
-
         if(!ptr[0] && !ptr[1] && ptr[2]==1 && ptr[3]==0xe0) // probably video
         {
           return idContentE0(pid,ts,trackType);
@@ -250,7 +258,7 @@
         uint32_t fq,br,chan,syncoff;
         uint32_t fq2,br2,chan2,syncoff2;
 
-        // Is it AC3 ??
+        // Is it AC3 ?? No false positive with A52/AC3..
         if( ADM_AC3GetInfo(ptr,len, &fq, &br, &chan,&syncoff))
         {
                 ADM_info("Maybe AC3... \n");
@@ -267,23 +275,54 @@
 
         }
         // We easily have false positive with mp2...
-        MpegAudioInfo minfo,minfo2;
-        if( getMpegFrameInfo(ptr,len,&minfo,NULL,&syncoff))
+        // Let's get 10 samples, and say it's ok if we have MP2_THRESHOLD that match
+#define MP2_NB_TRY    10
+#define MP2_THRESHOLD 3
+        MpegAudioInfo mp2info[MP2_NB_TRY];
+        for(int i=0;i<MP2_NB_TRY;i++)
         {
-                    if(minfo.bitrate>=128)
-                    {
-                        ADM_info("Maybe MP2... \n");
-                        if( getMpegFrameInfo(ptr2,len2,&minfo2,&minfo,&syncoff))
-                        {
-                            ADM_warning("\tProbably MP2 : Fq=%d br=%d chan=%d\n", (int)minfo.samplerate,
+              if(false==ts->getNextPES( &pes2)) 
+            {
+                ADM_warning("\tCannot get PES2\n");
+                return false;
+            }
+            ptr2=pes2.payload;
+            len2=pes2.payloadSize;
+            if( !getMpegFrameInfo(ptr2,len2,mp2info+i,NULL,&syncoff))
+            {
+                ADM_warning("Cannot find mp2 header (try %d)\n",i);
+                return false;
+            }
+            ADM_info("\t\t%d : fq=%d br=%d\n",i,mp2info[i].samplerate,mp2info[i].bitrate);
+        }
+        int match=0,maxMatch=0,mp2index=0;
+        for(int j=0;j<MP2_NB_TRY;j++)
+        {
+            match=0;
+            for(int i=0;i<MP2_NB_TRY;i++)
+            {
+                    if(mp2Match(mp2info,i,j)) match++;
+            }
+            if(match>maxMatch) 
+            {
+                maxMatch=match;
+                mp2index=j;
+            }
+        }
+        if(maxMatch>=MP2_THRESHOLD)
+        {
+                MpegAudioInfo minfo;
+                ADM_info("Found %d matches out of %d samples\n",maxMatch,MP2_NB_TRY);
+                minfo=mp2info[mp2index];
+                ADM_warning("\tProbably MP2 : Fq=%d br=%d chan=%d\n", (int)minfo.samplerate,
                                                                         (int)minfo.bitrate,
                                                                         (int)minfo.mode);
-                            trackType=ADM_TS_MPEG_AUDIO;
-                            return true;
-                        }
-                    }
+                trackType=ADM_TS_MPEG_AUDIO;
+                return true;
+
         }
-    return false;
+        ADM_info("MP2:Only %d matches out of %d tries, dont know what that track is\n",maxMatch,MP2_NB_TRY);
+        return false;
 }
         
 



From mean at mail.berlios.de  Tue Oct 11 08:03:31 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 11 Oct 2011 08:03:31 +0200
Subject: [Avidemux-svn-commit] r7602 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20111011060331.C8599481377@sheep.berlios.de>

Author: mean
Date: 2011-10-11 08:03:31 +0200 (Tue, 11 Oct 2011)
New Revision: 7602

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp
Log:
[Trp/demux] Accept as video track PES=0xE? and not only 0xE0

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp	2011-10-11 06:03:30 UTC (rev 7601)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp	2011-10-11 06:03:31 UTC (rev 7602)
@@ -238,8 +238,8 @@
         uint8_t *ptr=pes.payload;
         uint32_t len=pes.payloadSize;
 
-
-        if(!ptr[0] && !ptr[1] && ptr[2]==1 && ptr[3]==0xe0) // probably video
+        ADM_info("PES start : %02x%02x%02x%02x\n",ptr[0],ptr[1],ptr[2],ptr[3]);
+        if(!ptr[0] && !ptr[1] && ptr[2]==1 && (ptr[3]&0xe0)==0xe0) // probably video
         {
           return idContentE0(pid,ts,trackType);
         }



From gruntster at mail.berlios.de  Tue Oct 11 19:51:15 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 11 Oct 2011 19:51:15 +0200
Subject: [Avidemux-svn-commit] r7603 - in branches/avidemux_2.6_branch_mean:
	avidemux/winInstaller foreignBuilds/mswin
	foreignBuilds/mswin/avidemux foreignBuilds/mswin/faac
	foreignBuilds/mswin/faad foreignBuilds/mswin/js
	foreignBuilds/mswin/lame foreignBuilds/mswin/libvpx
	foreignBuilds/mswin/nspr
Message-ID: <20111011175115.B44AB4814A2@sheep.berlios.de>

Author: gruntster
Date: 2011-10-11 19:51:15 +0200 (Tue, 11 Oct 2011)
New Revision: 7603

Added:
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/configure32.patch
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/configure64.patch
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/winInstaller/avidemux.nsi
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/Set Common Environment Variables.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Package Notes.xml
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faac/makefile
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faad/makefile
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/js/Perform Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/js/WINNT6.1.mk
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/lame/Perform Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/libvpx/Perform Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/Perform Build.bat
Log:
[mswin] upgrade build scripts to support multilib compiler

Modified: branches/avidemux_2.6_branch_mean/avidemux/winInstaller/avidemux.nsi
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/winInstaller/avidemux.nsi	2011-10-11 06:03:31 UTC (rev 7602)
+++ branches/avidemux_2.6_branch_mean/avidemux/winInstaller/avidemux.nsi	2011-10-11 17:51:15 UTC (rev 7603)
@@ -277,19 +277,21 @@
     ${File} "Build Info.txt"
     ${File} "Change Log.html"
     ${File} zlib1.dll
-    ${File} libstdc++*.dll
 
 !if ${BUILD_BITS} == 32
     ${File} freetype6.dll
 	${File} pthreadGC2-w32.dll
+	${File} libgcc_s_sjlj-1.dll
+	${File} libstdc++-6.dll
 !endif
 
 !if ${BUILD_BITS} == 64
     ${File} libfreetype-6.dll
 	${File} pthreadGC2-w64.dll
+	${File} libgcc_s_sjlj_64-1.dll
+	${File} libstdc++_64-6.dll
 !endif
 
-    ${File} libgcc_s_sjlj-1.dll
 	${File} nspr4.dll
     ${File} libjs.dll
 	${File} libADM_audioParser6.dll

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/Set Common Environment Variables.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/Set Common Environment Variables.bat	2011-10-11 06:03:31 UTC (rev 7602)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/Set Common Environment Variables.bat	2011-10-11 17:51:15 UTC (rev 7603)
@@ -12,7 +12,7 @@
 goto error
 
 :setVars
-set mingwDir=%devDir%\MinGW%BuildBits%
+set mingwDir=%devDir%\MinGW64
 set usrLocalDir=%msysDir%/local%BuildBits%
 set qtDir=%devDir%\Qt%BuildBits%
 set CMAKE_INCLUDE_PATH=%usrLocalDir%/include
@@ -21,10 +21,16 @@
 set SDLDIR=%usrLocalDir%
 set CFLAGS=%CFLAGS% -I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
 set CXXFLAGS=%CXXFLAGS% -I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
-set LDFLAGS=%LDFLAGS% -shared-libgcc -lstdc++ -L%CMAKE_LIBRARY_PATH%
+set LDFLAGS=%LDFLAGS% -s -shared-libgcc -shared-libstdc++ -L%CMAKE_LIBRARY_PATH%
 set admBuildDir=%devDir%\avidemux_2.6_build%BuildBits%
 set admSdkBuildDir=%devDir%\avidemux_2.6_build%BuildBits%_sdk
 
+if "%BuildBits%" == "32" (
+	set CFLAGS=%CFLAGS% -m32
+	set CXXFLAGS=%CXXFLAGS% -m32
+	set LDFLAGS=%LDFLAGS% -m32
+)
+
 if exist "%qtDir%" (
 	for /f %%d in ('dir /b /ad /on %qtDir%') do set qtVer=%%d
 ) else (

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Package Notes.xml
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Package Notes.xml	2011-10-11 06:03:31 UTC (rev 7602)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Package Notes.xml	2011-10-11 17:51:15 UTC (rev 7603)
@@ -1,259 +1,8 @@
 <?xml version="1.0"?>
 <log>
-	<buildentry revision="6587" date="2010-09-05">
-		<comment>Compiled with GCC 4.5.1.</comment>
-		<comment>Updated Cairo to version 1.8.10-4.</comment>
-		<comment>Updated Freetype to version 2.4.2-1.</comment>
-		<comment>Updated GLib to version 2.24.2-1.</comment>
-		<comment>Updated libvpx to version 0.9.2.</comment>
-		<comment>Updated NSPR to version 4.8.6.</comment>
-		<comment>Updated Pango to version 1.28.1-1.</comment>
-		<comment>Updated x264 to r1713.</comment>
-		<comment>Updated zlib to version 1.2.5-2.</comment>
-	</buildentry>
-	<buildentry revision="6502" date="2010-08-03">
-		<comment>Updated x264 to r1688.</comment>
-	</buildentry>
-	<buildentry revision="6442" date="2010-07-06">
-		<comment>Compiled with GCC 4.4.5 pre-release (r161668).</comment>
-		<comment>Updated libvpx to version 0.9.1.</comment>
-		<comment>Updated x264 to r1666.</comment>
-	</buildentry>
-	<buildentry revision="6370" date="2010-06-13">
-		<comment>Added libvpx, git version (commit: 5ef25a9728507d259c6ccd05064ce1208e7abd9f).</comment>
-		<comment>Updated x264 to r1624.</comment>
-	</buildentry>
-	<buildentry revision="6340" date="2010-06-07">
-	</buildentry>
-	<buildentry revision="6303" date="2010-06-04">
-	</buildentry>
-	<buildentry revision="6288" date="2010-06-01">
-	</buildentry>
-	<buildentry revision="6261" date="2010-05-27">
-		<comment>Updated x264 to r1613.</comment>
-	</buildentry>
-	<buildentry revision="6195" date="2010-05-16">
-		<comment>Updated Freetype to version 2.3.12-1.</comment>
-		<comment>Updated GLib to version 2.24.1-1.</comment>
-		<comment>Updated GTK+ to version 2.20.1-1.</comment>
-		<comment>Updated x264 to r1583.</comment>
-	</buildentry>
-	<buildentry revision="6161 [2.5.3 Final]" date="2010-05-16">
-		<comment>Updated Avisynth Proxy GUI to version 2.12.</comment>
-	</buildentry>
-	<buildentry revision="6129" date="2010-04-15">
-		<comment>Updated x264 to r1542.</comment>
-	</buildentry>
-	<buildentry revision="6121" date="2010-04-11">
-		<comment>Updated ATK to version 1.30.0-1.</comment>
-		<comment>Updated Cairo to version 1.8.10-3.</comment>
-		<comment>Updated GLib to version 2.24.0-2.</comment>
-		<comment>Updated GTK+ to version 2.20.0-1.</comment>
-		<comment>Updated Libxml2 to version 2.7.7-1.</comment>
-		<comment>Updated Pango to version 1.28.0-1.</comment>
-		<comment>Updated x264 to r1523.</comment>
-		<comment>Updated zlib to version 1.2.4-2.</comment>
-	</buildentry>
-	<buildentry revision="6083" date="2010-04-06">
-	</buildentry>
-	<buildentry revision="6064" date="2010-04-05">
-		<comment>Updated x264 to r1510.</comment>
-	</buildentry>
-	<buildentry revision="6028" date="2010-03-27">
-		<comment>Updated Avisynth Proxy GUI to version 2.11.</comment>
-		<comment>Updated GLib to version 2.22.5-1.</comment>
-		<comment>Updated GTK+ to version 2.18.9-1.</comment>
-		<comment>Updated LAME to version 3.98.4.</comment>
-		<comment>Updated Ogg to version 1.2.0.</comment>
-		<comment>Updated NSPR to version 4.8.4.</comment>
-		<comment>Updated Vorbis to version 1.3.1.</comment>
-	</buildentry>
-	<buildentry revision="5955" date="2010-02-28">
-		<comment>Compiled with GCC 4.4.3.</comment>
-		<comment>Updated Cairo to version 1.8.10-1.</comment>
-		<comment>Updated Freetype to version 2.3.11-2.</comment>
-		<comment>Updated GTK+ to version 2.18.7-1.</comment>
-		<comment>Updated LAME to version 3.98.3.</comment>
-		<comment>Updated libpng to version 1.4.0-1.</comment>
-		<comment>Updated NSPR to version 4.8.3.</comment>
-		<comment>Updated Pango to version 1.26.2-1.</comment>
-		<comment>Updated Qt to version 4.6.2.</comment>
-		<comment>Updated x264 to r1471.</comment>
-	</buildentry>
-	<buildentry revision="5869" date="2010-01-23">
-		<comment>Updated GLib to version 2.22.4-1.</comment>
-		<comment>Updated Qt to version 4.6.1.</comment>
-		<comment>Updated x264 to r1400.</comment>
-	</buildentry>
-	<buildentry revision="5830" date="2010-01-07">
-		<comment>Compiled with GCC 4.4.3 pre-release (r155431).</comment>
-	</buildentry>
-	<buildentry revision="5810" date="2010-01-02">
-	</buildentry>
-	<buildentry revision="5801" date="2009-12-31">
-	</buildentry>
-	<buildentry revision="5775" date="2009-12-29">
-	</buildentry>
-	<buildentry revision="5747" date="2009-12-28">
-	</buildentry>
-	<buildentry revision="5676" date="2009-12-20">
-		<comment>Packaged using NSIS 2.46.</comment>
-		<comment>Updated GTK+ to version 2.18.5-1.</comment>
-		<comment>Updated libpng to version 1.2.40-1.</comment>
-		<comment>Updated Pango to version 1.26.1-1.</comment>
-		<comment>Updated Qt to version 4.6.0.</comment>
-		<comment>Updated x264 to r1376.</comment>
-	</buildentry>
-	<buildentry revision="5660 [2.5.2 Final]" date="2009-12-19">
-	</buildentry>
-	<buildentry revision="5636 [2.5.2 RC1]" date="2009-12-12">
-	</buildentry>
-	<buildentry revision="5602" date="2009-11-30">
-	</buildentry>
-	<buildentry revision="5590" date="2009-11-28">
-		<comment>Updated Cairo to version 1.8.8-3.</comment>
-		<comment>Updated Fontconfig to version 2.8.0-1.</comment>
-		<comment>Updated Freetype to version 2.3.11-1.</comment>
-		<comment>Updated GLib to version 2.22.2-1.</comment>
-		<comment>Updated GTK+ to version 2.18.3-1.</comment>
-		<comment>Updated Pango to version 1.26.0-1.</comment>
-		<comment>Updated x264 to r1352.</comment>
-	</buildentry>
-	<buildentry revision="5567" date="2009-11-26">
-	</buildentry>
-	<buildentry revision="5558" date="2009-11-24">
-	</buildentry>
-	<buildentry revision="5546" date="2009-11-23">
-		<comment>Updated x264 to r1347.</comment>
-	</buildentry>
-	<buildentry revision="5530" date="2009-11-19">
-		<comment>Updated x264 to r1342.</comment>
-	</buildentry>
-	<buildentry revision="5422" date="2009-10-27">
-		<comment>Updated SDL to version 1.2.14.</comment>
-		<comment>Updated x264 to r1310.</comment>
-	</buildentry>
-	<buildentry revision="5369" date="2009-10-05">
-		<comment>Updated ATK to version 1.28.0-1.</comment>
-		<comment>Updated Fontconfig to version 2.7.3-1.</comment>
-		<comment>Updated GLib to version 2.22.1-1.</comment>
-		<comment>Updated GTK+ to version 2.18.1-1.</comment>
-		<comment>Updated libpng to version 1.2.39-1.</comment>
-		<comment>Updated Libxml2 to version 2.7.4-1.</comment>
-		<comment>Updated NSPR to version 4.8.</comment>
-		<comment>Updated opencore-amr to version 0.1.2.</comment>
-		<comment>Updated Qt to version 4.5.3.</comment>
-		<comment>Updated x264 to r1271.</comment>
-	</buildentry>
-	<buildentry revision="5341" date="2009-09-17">
-		<comment>Updated x264 to r1259.</comment>
-	</buildentry>
-	<buildentry revision="5327" date="2009-09-09">
-		<comment>Updated x264 to r1251.</comment>
-	</buildentry>
-	<buildentry revision="5281" date="2009-08-29">
-		<comment>Updated x264 to r1240.</comment>
-	</buildentry>
-	<buildentry revision="5273" date="2009-08-27">
-		<comment>Updated x264 to r1235.</comment>
-		<comment>Updated Xvid to version 1.2.2.</comment>
-	</buildentry>
-	<buildentry revision="5268" date="2009-08-23">
-		<comment>Updated x264 to r1222.</comment>
-	</buildentry>
-	<buildentry revision="5249 [2.5.1 Final]" date="2009-08-16">
-		<comment>Updated Fontconfig to version 2.7.1-2.</comment>
-	</buildentry>
-	<buildentry revision="5234" date="2009-08-12">
-		<comment>Updated Cairo to version 1.8.8-1.</comment>
-		<comment>Updated Fontconfig to version 2.7.1-1.</comment>
-		<comment>Updated Freetype to version 2.3.9-1.</comment>
-		<comment>Updated GLib to version 2.20.4-1.</comment>
-		<comment>Updated GTK+ to version 2.16.5-1.</comment>
-		<comment>Updated libpng to version 1.2.38-1.</comment>
-		<comment>Updated Pango to version 1.24.5-1.</comment>
-		<comment>Updated x264 to r1206.</comment>
-	</buildentry>
-	<buildentry revision="5204" date="2009-08-03">
-	</buildentry>
-	<buildentry revision="5181" date="2009-07-30">
-		<comment>Updated x264 to r1195.</comment>
-	</buildentry>
-	<buildentry revision="5152" date="2009-07-25">
-		<comment>Updated Avisynth Proxy GUI to version 2.09d.</comment>
-		<comment>Updated x264 to r1185.</comment>
-	</buildentry>
-	<buildentry revision="5104" date="2009-07-17">
-		<comment>Added opencore-amr version 0.1.1.</comment>
-		<comment>Updated x264 to r1183.</comment>
-	</buildentry>
-	<buildentry revision="5087" date="2009-07-13">
-	</buildentry>
-	<buildentry revision="5065" date="2009-07-12">
-		<comment>Updated Vorbis to version 1.2.3.</comment>
-		<comment>Updated x264 to r1181.</comment>
-	</buildentry>
-	<buildentry revision="5031" date="2009-07-10">
-		<comment>Recompiled FAAC with MinGW's GCC 4.2.1-sjlj-2.</comment>
-		<comment>Updated x264 to r1179.</comment>
-	</buildentry>
-	<buildentry revision="5010" date="2009-07-06">
-	</buildentry>
-	<buildentry revision="4997" date="2009-07-05">
-	</buildentry>
-	<buildentry revision="4992" date="2009-07-04">
-		<comment>Updated FAAC to version 1.28.</comment>
-		<comment>Updated FAAD2 to version 2.7.</comment>
-	</buildentry>
-	<buildentry revision="4968" date="2009-06-27">
-		<comment>Updated ATK to version 1.26.0-1.</comment>
-		<comment>Updated GLib to version 2.20.3-1.</comment>
-		<comment>Updated GTK+ to version 2.16.2-1.</comment>
-		<comment>Updated libpng to version 1.2.37-1.</comment>
-		<comment>Updated Ogg to version 1.1.4.</comment>
-		<comment>Updated Pango to version 1.24.2-1.</comment>
-		<comment>Updated Qt to version 4.5.2.</comment>
-		<comment>Updated Vorbis to version 1.2.2.</comment>
-		<comment>Updated x264 to r1173.</comment>
-	</buildentry>
-	<buildentry revision="4944 [2.5.0 Final]" date="2009-06-23">
-		<comment>Updated x264 to r1170.</comment>
-	</buildentry>
-	<buildentry revision="4871" date="2009-05-25">
-		<comment>Updated x264 to r1159.</comment>
-	</buildentry>
-	<buildentry revision="4763" date="2009-04-26">
-		<comment>Added Netscape Portable Runtime version 4.7.4.</comment>
-		<comment>Updated Pango to version 1.24.1-1.</comment>
-		<comment>Updated Qt to version 4.5.1.</comment>
-		<comment>Updated SpiderMonkey to version 1.7.0.</comment>
-	</buildentry>
-	<buildentry revision="4758" date="2009-04-22">
-		<comment>Updated Avisynth Proxy GUI to version 2.08.</comment>
-		<comment>Updated x264 to r1145.</comment>
-	</buildentry>
-	<buildentry revision="4741" date="2009-04-20">
-		<comment>Updated GLib to version 2.20.1-1.</comment>
-		<comment>Updated GTK+ to version 2.16.1-1.</comment>
-		<comment>Updated Pango to version 1.24.0-1.</comment>
-	</buildentry>
-	<buildentry revision="4685" date="2009-03-14">
-	</buildentry>
-	<buildentry revision="4658" date="2009-03-05">
-		<comment>Updated Qt to version 4.5.0.</comment>
-	</buildentry>
-	<buildentry revision="4648" date="2009-03-02">
-		<comment>Updated x264 to r1115.</comment>
-	</buildentry>
-	<buildentry revision="4629" date="2009-02-24">
-	</buildentry>
-	<buildentry revision="4618" date="2009-02-21">
-		<comment>Updated x264 to r1114.</comment>
-	</buildentry>
-	<buildentry revision="4609" date="2009-02-16">
-		<comment>Packaged using NSIS 2.43.</comment>
-		<comment>Updated Avisynth Proxy GUI to version 2.07 (2nd release).</comment>
-		<comment>Updated Libxml2 to version 2.7.3.</comment>
-		<comment>Updated x264 to r1113.</comment>
-	</buildentry>
+  <buildentry revision="7590" date="2011-09-28" />
+  <buildentry revision="7573" date="2011-09-22">
+    <comment>Updated x264 to r2085.</comment>
+  </buildentry>
+  <buildentry revision="7566" date="2011-09-16" />
 </log>

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faac/makefile
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faac/makefile	2011-10-11 06:03:31 UTC (rev 7602)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faac/makefile	2011-10-11 17:51:15 UTC (rev 7603)
@@ -2,4 +2,4 @@
 SRC=$(wildcard *.c)
 
 libfaac.dll: $(SRC)
-	gcc -o $@ $^ $(CFLAGS)
\ No newline at end of file
+	gcc -o $@ $^ $(CFLAGS) $(LDFLAGS)
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faad/makefile
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faad/makefile	2011-10-11 06:03:31 UTC (rev 7602)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faad/makefile	2011-10-11 17:51:15 UTC (rev 7603)
@@ -2,4 +2,4 @@
 SRC=$(wildcard *.c)
 
 libfaad2.dll: $(SRC)
-	gcc -o $@ $^ $(CFLAGS)
\ No newline at end of file
+	gcc -o $@ $^ $(CFLAGS) $(LDFLAGS)
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/js/Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/js/Perform Build.bat	2011-10-11 06:03:31 UTC (rev 7602)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/js/Perform Build.bat	2011-10-11 17:51:15 UTC (rev 7603)
@@ -58,7 +58,9 @@
 
 echo.
 cd src
-windres -i js3240.rc -o jsres.o -O coff
+if "%BuildBits%" == "32" windres -i js3240.rc -o jsres.o -O coff -F pe-i386
+if "%BuildBits%" == "64" windres -i js3240.rc -o jsres.o -O coff
+
 set CFLAGS=%CFLAGS% -I"%usrLocalDir%/include/nspr"
 make -f Makefile.ref JS_DIST="%usrLocalDir%" BUILD_OPT=1 JS_HAS_FILE_OBJECT=1 XLDFLAGS="%LDFLAGS% jsres.o -L%usrLocalDir%/lib -lnspr4"
 if errorlevel 1 goto end

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/js/WINNT6.1.mk
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/js/WINNT6.1.mk	2011-10-11 06:03:31 UTC (rev 7602)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/js/WINNT6.1.mk	2011-10-11 17:51:15 UTC (rev 7603)
@@ -10,7 +10,7 @@
 MKSHLIB = $(LD) -shared $(XMKSHLIBOPTS)
 
 ifdef BUILD_OPT
-OS_CFLAGS += -s
+OS_CFLAGS += -O2 -s
 endif
 
 #.c.o:

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/lame/Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/lame/Perform Build.bat	2011-10-11 06:03:31 UTC (rev 7602)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/lame/Perform Build.bat	2011-10-11 17:51:15 UTC (rev 7603)
@@ -49,6 +49,7 @@
 
 echo.
 echo Configuring
+set CFLAGS=%CFLAGS% -O2
 
 if "%BuildBits%" == "32" sh ./configure --prefix="%usrLocalDir%" --disable-static --enable-nasm
 if "%BuildBits%" == "64" sh ./configure --prefix="%usrLocalDir%" --disable-static

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/libvpx/Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/libvpx/Perform Build.bat	2011-10-11 06:03:31 UTC (rev 7602)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/libvpx/Perform Build.bat	2011-10-11 17:51:15 UTC (rev 7603)
@@ -55,7 +55,7 @@
 echo.
 echo Configuring
 
-if "%BuildBits%" == "32" sh ./configure --prefix="%usrLocalDir%" --disable-vp8-encoder
+if "%BuildBits%" == "32" sh ./configure --prefix="%usrLocalDir%" --disable-vp8-encoder --target=x86-win32-gcc
 if "%BuildBits%" == "64" sh ./configure --prefix="%usrLocalDir%" --disable-vp8-encoder --target=x86_64-win64-gcc
 
 if errorlevel 1 goto end

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/Perform Build.bat	2011-10-11 06:03:31 UTC (rev 7602)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/Perform Build.bat	2011-10-11 17:51:15 UTC (rev 7603)
@@ -51,6 +51,10 @@
 )
 
 echo.
+echo Patching
+patch -p0 -i "%curDir%\configure%BuildBits%.patch"
+
+echo.
 echo Configuring
 cd mozilla\nsprpub
 sh ./configure --prefix="%usrLocalDir%" --enable-strip --enable-win32-target=WIN95 --enable-optimize --disable-debug
@@ -69,7 +73,8 @@
 copy "%usrLocalDir%\bin\nspr4.dll" "%admBuildDir%"
 
 pexports "%usrLocalDir%/bin/nspr4.dll" > nspr4.def
-dlltool -d nspr4.def -l "%usrLocalDir%/lib/nspr4.dll.a"
+if "%BuildBits%" == "32" dlltool -d nspr4.def -l "%usrLocalDir%/lib/nspr4.dll.a" -m i386 --as-flags=--32
+if "%BuildBits%" == "64" dlltool -d nspr4.def -l "%usrLocalDir%/lib/nspr4.dll.a"
 
 goto end
 

Added: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/configure32.patch
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/configure32.patch	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/configure32.patch	2011-10-11 17:51:15 UTC (rev 7603)
@@ -0,0 +1,12 @@
+--- mozilla/nsprpub/configure.org	2011-07-28 14:08:33 +0100
++++ mozilla/nsprpub/configure	2011-10-10 21:27:45 +0100
+@@ -4412,8 +4412,8 @@
+         CXX="$CXX -mwindows"
+         DLL_SUFFIX=dll
+-        MKSHLIB='$(CC) -shared -Wl,--export-all-symbols -Wl,--out-implib -Wl,$(IMPORT_LIBRARY) $(DLLBASE) -o $(subst $(OBJDIR)/,,$(SHARED_LIBRARY))'
+-        RC=$WINDRES
++		 MKSHLIB='$(CC) $(CFLAGS) -shared -Wl,--export-all-symbols -Wl,--out-implib -Wl,$(IMPORT_LIBRARY) $(DLLBASE) -o $(subst $(OBJDIR)/,,$(SHARED_LIBRARY))'
++        RC=$WINDRES -F pe-i386
+         # Use temp file for windres (bug 213281)
+         RCFLAGS='-O coff --use-temp-file'
+     else

Added: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/configure64.patch
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/configure64.patch	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/configure64.patch	2011-10-11 17:51:15 UTC (rev 7603)
@@ -0,0 +1,11 @@
+--- mozilla/nsprpub/configure	2011-07-28 14:08:33 +0100
++++ mozilla/nsprpub/configure	2011-10-10 22:03:36 +0100
+@@ -743,7 +743,7 @@
+ USE_IPV6=
+ USE_MDUPDATE=
+ _MACOSX_DEPLOYMENT_TARGET=
+-_OPTIMIZE_FLAGS=-O
++_OPTIMIZE_FLAGS=-O2
+ _DEBUG_FLAGS=-g
+ MOZ_DEBUG=1
+ MOZ_OPTIMIZE=



From gruntster at mail.berlios.de  Tue Oct 11 19:51:48 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 11 Oct 2011 19:51:48 +0200
Subject: [Avidemux-svn-commit] r7604 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4
Message-ID: <20111011175148.71E054814A2@sheep.berlios.de>

Author: gruntster
Date: 2011-10-11 19:51:48 +0200 (Tue, 11 Oct 2011)
New Revision: 7604

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.cpp
Log:
[x264] include missing header

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.cpp	2011-10-11 17:51:15 UTC (rev 7603)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/qt4/Q_x264.cpp	2011-10-11 17:51:48 UTC (rev 7604)
@@ -6,6 +6,7 @@
     copyright            : (C) 2011 gruntster/mean
  ***************************************************************************/
 #include <math.h>
+#include <vector>
 #include <QtGui/QFileDialog>
 #include <QtGui/QDialog>
 #include <QtGui/QTextEdit>



From gruntster at mail.berlios.de  Tue Oct 11 23:52:22 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 11 Oct 2011 23:52:22 +0200
Subject: [Avidemux-svn-commit] r7605 - in
	branches/avidemux_2.5_branch_gruntster/avidemux:
	ADM_UIs/ADM_QT4/include ADM_UIs/ADM_QT4/src
	ADM_userInterfaces/ADM_QT4 ADM_userInterfaces/ADM_QT4/ADM_dialog
	ADM_userInterfaces/ADM_QT4/ADM_gui
Message-ID: <20111011215222.D4C8F4814A4@sheep.berlios.de>

Author: gruntster
Date: 2011-10-11 23:52:22 +0200 (Tue, 11 Oct 2011)
New Revision: 7605

Added:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/include/Q_mswin.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/Q_mswin.cpp
Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_encoding.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_encoding.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.h
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/CMakeLists.txt
Log:
[mswin] update Windows 7 taskbar with encoding progress

Added: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/include/Q_mswin.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/include/Q_mswin.h	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/include/Q_mswin.h	2011-10-11 21:52:22 UTC (rev 7605)
@@ -0,0 +1,21 @@
+#ifndef Q_MSWIN_H
+#define Q_MSWIN_H
+
+#include <QtGui/QWidget>
+#include <shobjidl.h>
+
+class Q_mswin
+{
+public:
+	Q_mswin();
+	void init(WId wid);
+	bool winEvent(MSG * message, long * result);
+	void setProgressValue(int value, int max);
+	void setProgressState(TBPFLAG state);
+
+private:
+	ITaskbarList3 *_taskbar;
+	UINT _taskbarMessageId;
+	WId _windowId;
+};
+#endif
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/CMakeLists.txt	2011-10-11 17:51:48 UTC (rev 7604)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/CMakeLists.txt	2011-10-11 21:52:22 UTC (rev 7605)
@@ -11,7 +11,7 @@
 )
 
 SET(${ADM_LIB}_SRCS
-	FAC_bar.cpp    FAC_frame.cpp  FAC_integer.cpp  FAC_aspectRatio.cpp
+	FAC_bar.cpp    FAC_frame.cpp  FAC_integer.cpp  FAC_aspectRatio.cpp  Q_mswin.cpp
 	FAC_float.cpp  FAC_hex.cpp    FAC_readOnlyText.cpp  toolkit.cpp
 	FAC_matrix.cpp  DIA_color.cpp  ${${ADM_LIB}_source}  ${${ADM_LIB}_T})
 

Added: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/Q_mswin.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/Q_mswin.cpp	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/Q_mswin.cpp	2011-10-11 21:52:22 UTC (rev 7605)
@@ -0,0 +1,44 @@
+#include "Q_mswin.h"
+
+Q_mswin::Q_mswin()
+{
+    _taskbar = NULL;
+}
+
+void Q_mswin::init(WId wid)
+{
+    _windowId = wid;
+    _taskbarMessageId = RegisterWindowMessageW(L"TaskbarButtonCreated");
+}
+
+bool Q_mswin::winEvent(MSG *message, long *result)
+{
+	bool stopEvent = false;
+
+    if (message->message == _taskbarMessageId)
+    {
+        *result = CoCreateInstance(
+			CLSID_TaskbarList, 0, CLSCTX_INPROC_SERVER,
+			IID_ITaskbarList3, reinterpret_cast<void**> (&(_taskbar)));
+
+        stopEvent = true;
+    }
+
+    return stopEvent;
+}
+
+void Q_mswin::setProgressValue(int value, int max)
+{
+    if (_taskbar)
+	{
+		_taskbar->SetProgressValue(_windowId, value, max);
+	}
+}
+
+void Q_mswin::setProgressState(TBPFLAG state)
+{
+    if (_taskbar)
+	{
+		_taskbar->SetProgressState(_windowId, state);
+	}
+}
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/CMakeLists.txt	2011-10-11 17:51:48 UTC (rev 7604)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/CMakeLists.txt	2011-10-11 21:52:22 UTC (rev 7605)
@@ -19,6 +19,8 @@
 	alert_qt4.cpp  DIA_busy.cpp  DIA_none.cpp  OCR_none.cpp)
 
 ADD_DEFINITIONS(-DADM_SUBVERSION=${ADM_SUBVERSION})
-INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})
+INCLUDE_DIRECTORIES("${CMAKE_CURRENT_BINARY_DIR}")
+INCLUDE_DIRECTORIES("${CMAKE_CURRENT_BINARY_DIR}/../ADM_gui")
+INCLUDE_DIRECTORIES("${CMAKE_CURRENT_SOURCE_DIR}/../ADM_gui")
 INCLUDE_DIRECTORIES("${CMAKE_SOURCE_DIR}/avidemux/ADM_UIs/ADM_QT4/include")
 ADD_ADM_LIB_QT4_TARGET(${ADM_LIB} ${${ADM_LIB}_SRCS})

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_encoding.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_encoding.cpp	2011-10-11 17:51:48 UTC (rev 7604)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_encoding.cpp	2011-10-11 21:52:22 UTC (rev 7605)
@@ -24,14 +24,17 @@
 #include "ADM_video/ADM_vidMisc.h"
 #include "../ADM_gui/ADM_qtray.h"
 #include "ADM_toolkitQt.h"
+#include "Q_gui2.h"
 
 extern void UI_iconify(void);
 extern void UI_deiconify(void);
 extern void UI_purge(void);
+extern MainWindow *QuiMainWindows;
 static int stopReq=0;
 
 encodingWindow::encodingWindow(QWidget *parent, bool useTray) : QDialog(parent, Qt::WindowTitleHint | Qt::WindowSystemMenuHint | Qt::WindowMinimizeButtonHint)
 {
+	this->_phase = 0;
 	this->useTray = useTray;
 	ui.setupUi(this);
 
@@ -92,9 +95,16 @@
 
 void encodingWindow::closeEvent(QCloseEvent *event)
 {
+#ifdef __WIN32
+	QuiMainWindows->mswin.setProgressState(TBPF_PAUSED);
+#endif
+
 	if (GUI_Alternate((char*)encodingWindow::tr("The encoding is paused. Do you want to resume or abort?").toUtf8().constData(),
 		(char*)encodingWindow::tr("Resume").toUtf8().constData(), (char*)encodingWindow::tr("Abort").toUtf8().constData()))
 	{
+#ifdef __WIN32
+		QuiMainWindows->mswin.setProgressState(TBPF_NORMAL);
+#endif
 		stopReq = 0;
 		event->ignore();
 	}
@@ -149,7 +159,7 @@
 /*************************************/
 static char string[80];
 static encodingWindow *window=NULL;
-extern QDialog *QuiMainWindows;
+
 DIA_encoding::DIA_encoding( uint32_t fps1000 )
 {
 	uint32_t useTray = 0;
@@ -209,6 +219,10 @@
 }
 DIA_encoding::~DIA_encoding( )
 {
+#ifdef __WIN32
+	QuiMainWindows->mswin.setProgressState(TBPF_NOPROGRESS);
+#endif
+
 	bool shutdownRequired = (window->ui.checkBoxShutdown->checkState() == Qt::Checked);
 
 	setpriority(PRIO_PROCESS, 0, _originalPriority);
@@ -255,6 +269,14 @@
           ADM_assert(window);
           WRITEM(labelPhasis,n);
 
+		  if (strcmp(n, QT_TR_NOOP("1st Pass")) == 0)
+		  {
+			  window->_phase = 1;
+		  }
+		  else if (strcmp(n, QT_TR_NOOP("2nd Pass")) == 0)
+		  {
+			  window->_phase = 2;
+		  }
 }
 /**
     \fn setAudioCodec(const char *n)
@@ -435,6 +457,17 @@
             f=f/_total;
             WIDGET(progressBar)->setValue((int)f);
 
+#ifdef __WIN32
+			if (window->_phase == 0)
+			{
+				QuiMainWindows->mswin.setProgressValue((int)(f * 100), 10000);
+			}
+			else
+			{
+				QuiMainWindows->mswin.setProgressValue(((int)(f * 50)) + ((window->_phase - 1) * 5000), 10000);
+			}
+#endif
+
 			if(tray)
 				tray->setPercent((int)f);
           

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_encoding.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_encoding.h	2011-10-11 17:51:48 UTC (rev 7604)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_encoding.h	2011-10-11 21:52:22 UTC (rev 7605)
@@ -17,6 +17,7 @@
  public:
      encodingWindow(QWidget *parent, bool useTray);
      Ui_encodingDialog ui;
+	 int _phase;
 
  public slots:
 	void buttonPressed(void);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2011-10-11 17:51:48 UTC (rev 7604)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2011-10-11 21:52:22 UTC (rev 7605)
@@ -243,6 +243,10 @@
 	qtRegisterDialog(this);
 	ui.setupUi(this);
 
+#ifdef __WIN32
+	mswin.init(this->winId());
+#endif
+
 	this->setStatusBar(0);
 	this->adjustSize();
 
@@ -692,6 +696,14 @@
 	clearCustomMenu();
 	renderDestroy();
 }
+
+#ifdef __WIN32
+bool MainWindow::winEvent(MSG *message, long *result)
+{
+    return mswin.winEvent(message, result);
+}
+#endif
+
 static const UI_FUNCTIONS_T UI_Hooks=
     {
         ADM_RENDER_API_VERSION_NUMBER,

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.h	2011-10-11 17:51:48 UTC (rev 7604)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.h	2011-10-11 21:52:22 UTC (rev 7605)
@@ -11,6 +11,10 @@
 #include "T_thumbSlider.h"
 #include "ui_gui2.h"
 
+#ifdef __WIN32
+#include "Q_mswin.h"
+#endif
+
 class MainWindow : public QMainWindow
 {
 	Q_OBJECT
@@ -23,6 +27,11 @@
 
 	Ui_MainWindow ui;
 
+#ifdef __WIN32
+	Q_mswin mswin;
+	bool winEvent(MSG *message, long *result);
+#endif
+
 public slots:
 	void timeChanged(int);
 	void buttonPressed(void);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/CMakeLists.txt	2011-10-11 17:51:48 UTC (rev 7604)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/CMakeLists.txt	2011-10-11 21:52:22 UTC (rev 7605)
@@ -4,7 +4,7 @@
 ADD_ADM_LIB_QT4_TARGET(${ADM_LIB} ${${ADM_LIB}_SRCS})
 INCLUDE_DIRECTORIES(${QT_INCLUDE_DIR}  ${CMAKE_CURRENT_SOURCE_DIR}/../../ADM_UIs/ADM_QT4/include)
 
+ADD_SUBDIRECTORY(ADM_gui)
 ADD_SUBDIRECTORY(ADM_dialog)
 ADD_SUBDIRECTORY(ADM_filters)
-ADD_SUBDIRECTORY(ADM_gui)
 ADD_SUBDIRECTORY(ADM_ocr)



From gruntster at mail.berlios.de  Wed Oct 12 00:05:51 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 12 Oct 2011 00:05:51 +0200
Subject: [Avidemux-svn-commit] r7606 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src
Message-ID: <20111011220551.7252B4814A4@sheep.berlios.de>

Author: gruntster
Date: 2011-10-12 00:05:50 +0200 (Wed, 12 Oct 2011)
New Revision: 7606

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/CMakeLists.txt
Log:
[mswin] unix fix

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/CMakeLists.txt	2011-10-11 21:52:22 UTC (rev 7605)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_UIs/ADM_QT4/src/CMakeLists.txt	2011-10-11 22:05:50 UTC (rev 7606)
@@ -11,10 +11,14 @@
 )
 
 SET(${ADM_LIB}_SRCS
-	FAC_bar.cpp    FAC_frame.cpp  FAC_integer.cpp  FAC_aspectRatio.cpp  Q_mswin.cpp
+	FAC_bar.cpp    FAC_frame.cpp  FAC_integer.cpp  FAC_aspectRatio.cpp
 	FAC_float.cpp  FAC_hex.cpp    FAC_readOnlyText.cpp  toolkit.cpp
 	FAC_matrix.cpp  DIA_color.cpp  ${${ADM_LIB}_source}  ${${ADM_LIB}_T})
 
+if (MINGW)
+	set(${ADM_LIB}_SRCS ${${ADM_LIB}_SRCS} Q_mswin.cpp)
+endif (MINGW)
+
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR} ${QT_INCLUDE_DIR})
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/../include)
 ADD_LIBRARY(${ADM_LIB} SHARED ${${ADM_LIB}_SRCS})



From mean at mail.berlios.de  Wed Oct 12 08:06:25 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed, 12 Oct 2011 08:06:25 +0200
Subject: [Avidemux-svn-commit] r7607 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20111012060625.C0B5B48135A@sheep.berlios.de>

Author: mean
Date: 2011-10-12 08:06:25 +0200 (Wed, 12 Oct 2011)
New Revision: 7607

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp
Log:
[trp/probe] More reliable way of probing mpeg2 audio tracks

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp	2011-10-11 22:05:50 UTC (rev 7606)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp	2011-10-12 06:06:25 UTC (rev 7607)
@@ -31,7 +31,7 @@
 #define MAX_BUFFER_SIZE (10*1024)
 
 static bool idContent(int pid,tsPacket *ts,ADM_TS_TRACK_TYPE & trackType);
-
+static bool idMP2(int pid,tsPacket *ts);
 /**
     \fn scanForPrograms
     \brief Lookup PAT & PMT to get tracks
@@ -274,54 +274,77 @@
                 }
 
         }
-        // We easily have false positive with mp2...
-        // Let's get 10 samples, and say it's ok if we have MP2_THRESHOLD that match
-#define MP2_NB_TRY    10
-#define MP2_THRESHOLD 3
-        MpegAudioInfo mp2info[MP2_NB_TRY];
-        for(int i=0;i<MP2_NB_TRY;i++)
+        if(idMP2(pid,ts))
         {
-              if(false==ts->getNextPES( &pes2)) 
+                ADM_info("\t probably MP2\n");
+                trackType=ADM_TS_MPEG_AUDIO;
+                return true;
+        }
+        ADM_info("Cannot identify track\n");
+        return false;
+}
+/**
+    \fn idMP2
+    \brief return true if the tracks is mp2
+*/
+bool idMP2(int pid,tsPacket *ts)
+{
+#define MP2_PROBE_SIZE (16*1024)
+uint8_t  mp2Buffer[MP2_PROBE_SIZE*2];
+
+        int limit=0;
+        TS_PESpacket pes(pid);
+        while(limit<MP2_PROBE_SIZE)
+        {
+            if(!ts->getNextPES(&pes))
             {
-                ADM_warning("\tCannot get PES2\n");
+                ADM_warning("Cannot get PES for pid=%d\n",pid);
                 return false;
             }
-            ptr2=pes2.payload;
-            len2=pes2.payloadSize;
-            if( !getMpegFrameInfo(ptr2,len2,mp2info+i,NULL,&syncoff))
-            {
-                ADM_warning("Cannot find mp2 header (try %d)\n",i);
-                return false;
-            }
-            ADM_info("\t\t%d : fq=%d br=%d\n",i,mp2info[i].samplerate,mp2info[i].bitrate);
+            int left=pes.payloadSize-pes.offset;
+            memcpy(mp2Buffer+limit,pes.payload+pes.offset,left);
+            limit+=left;
         }
-        int match=0,maxMatch=0,mp2index=0;
-        for(int j=0;j<MP2_NB_TRY;j++)
+        ADM_info("\t read % bytes\n",limit);
+        // Now read buffer until we have 3 correctly decoded packet
+        int probeIndex=0;
+        while(probeIndex<limit)
         {
-            match=0;
-            for(int i=0;i<MP2_NB_TRY;i++)
+
+            uint8_t *ptr=mp2Buffer+probeIndex;
+            int     len=limit-probeIndex;
+            if(len<4)
             {
-                    if(mp2Match(mp2info,i,j)) match++;
+                    ADM_info("\t no sync(3)\n");
+                    return false;
             }
-            if(match>maxMatch) 
+            uint32_t syncoff,syncoff2;
+            MpegAudioInfo mp2info,confirm;
+            if( !getMpegFrameInfo(ptr,len,&mp2info,NULL,&syncoff))
             {
-                maxMatch=match;
-                mp2index=j;
+                    ADM_info("\t no sync\n");
+                    return false;
             }
+          // Skip this packet
+            int next=probeIndex+syncoff+mp2info.size;
+            len=limit-next;
+            if(len<4)
+            {
+                    ADM_info("\t no sync(2)\n");
+                    return false;
+            }
+            if(getMpegFrameInfo(mp2Buffer+next,len,&confirm,&mp2info,&syncoff2))
+            {
+                    if(!syncoff2)
+                    {
+                            ADM_warning("\tProbably MP2 : Fq=%d br=%d chan=%d\n", (int)mp2info.samplerate,
+                                                                (int)mp2info.bitrate,
+                                                                (int)mp2info.mode);
+                            return true;
+                    }
+            }
+            probeIndex+=syncoff+1;
         }
-        if(maxMatch>=MP2_THRESHOLD)
-        {
-                MpegAudioInfo minfo;
-                ADM_info("Found %d matches out of %d samples\n",maxMatch,MP2_NB_TRY);
-                minfo=mp2info[mp2index];
-                ADM_warning("\tProbably MP2 : Fq=%d br=%d chan=%d\n", (int)minfo.samplerate,
-                                                                        (int)minfo.bitrate,
-                                                                        (int)minfo.mode);
-                trackType=ADM_TS_MPEG_AUDIO;
-                return true;
-
-        }
-        ADM_info("MP2:Only %d matches out of %d tries, dont know what that track is\n",maxMatch,MP2_NB_TRY);
         return false;
 }
         



From gruntster at mail.berlios.de  Wed Oct 12 15:13:47 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 12 Oct 2011 15:13:47 +0200
Subject: [Avidemux-svn-commit] r7608 - in
	branches/avidemux_2.5_branch_gruntster/platforms/windows:
	build_scripts build_scripts/avidemux build_scripts/faac
	build_scripts/faad build_scripts/js build_scripts/lame
	build_scripts/libvpx build_scripts/nspr installer
Message-ID: <20111012131347.8F1444814CB@sheep.berlios.de>

Author: gruntster
Date: 2011-10-12 15:13:47 +0200 (Wed, 12 Oct 2011)
New Revision: 7608

Added:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure32.patch
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure64.patch
Removed:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure.patch
Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faac/makefile
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faad/makefile
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/WINNT6.1.mk
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
Log:
[mswin] upgrade build scripts to support multilib compiler

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat	2011-10-12 06:06:25 UTC (rev 7607)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat	2011-10-12 13:13:47 UTC (rev 7608)
@@ -12,7 +12,7 @@
 goto error
 
 :setVars
-set mingwDir=%devDir%\MinGW%BuildBits%
+set mingwDir=%devDir%\MinGW64
 set usrLocalDir=%msysDir%/local%BuildBits%
 set qtDir=%devDir%\Qt%BuildBits%
 set CMAKE_INCLUDE_PATH=%usrLocalDir%/include
@@ -21,10 +21,17 @@
 set SDLDIR=%usrLocalDir%
 set CFLAGS=%CFLAGS% -I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
 set CXXFLAGS=%CXXFLAGS% -I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
-set LDFLAGS=%LDFLAGS% -shared-libgcc -lstdc++ -L%CMAKE_LIBRARY_PATH%
+set LDFLAGS=%LDFLAGS% -s -shared-libgcc -shared-libstdc++ -L%CMAKE_LIBRARY_PATH%
+set RC=windres -F pe-i386
 set admBuildDir=%devDir%\avidemux_2.5_build%BuildBits%
 set admSdkBuildDir=%devDir%\avidemux_2.5_build%BuildBits%_sdk
 
+if "%BuildBits%" == "32" (
+	set CFLAGS=%CFLAGS% -m32
+	set CXXFLAGS=%CXXFLAGS% -m32
+	set LDFLAGS=%LDFLAGS% -m32
+)
+
 if exist "%qtDir%" (
 	for /f %%d in ('dir /b /ad /on %qtDir%') do set qtVer=%%d
 ) else (

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml	2011-10-12 06:06:25 UTC (rev 7607)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml	2011-10-12 13:13:47 UTC (rev 7608)
@@ -1,5 +1,22 @@
 <?xml version="1.0"?>
 <log>
+  <buildentry revision="7573" date="2011-09-22">
+    <comment>Updated x264 to r2085.</comment>
+  </buildentry>
+  <buildentry revision="7515" date="2011-09-12">
+    <comment>Updated Qt to version 4.7.4.</comment>
+    <comment>Updated x264 to r2074.</comment>
+  </buildentry>
+  <buildentry revision="7428" date="2011-08-18">
+    <comment>Updated libvpx to version 0.9.7-p1.</comment>
+    <comment>Updated NSPR to version 4.8.9.</comment>
+    <comment>Updated x264 to r2057.</comment>
+  </buildentry>
+  <buildentry revision="7389" date="2011-08-05">
+    <comment>Updated libogg to version 1.3.0.</comment>
+    <comment>Updated libvpx to version 0.9.7.</comment>
+    <comment>Updated x264 to r2044.</comment>
+  </buildentry>
   <buildentry revision="7317" date="2011-07-10">
     <comment>Compiled with GCC 4.6.1.</comment>
     <comment>Updated x264 to r2019.</comment>

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faac/makefile
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faac/makefile	2011-10-12 06:06:25 UTC (rev 7607)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faac/makefile	2011-10-12 13:13:47 UTC (rev 7608)
@@ -2,4 +2,4 @@
 SRC=$(wildcard *.c)
 
 libfaac.dll: $(SRC)
-	gcc -o $@ $^ $(CFLAGS)
\ No newline at end of file
+	gcc -o $@ $^ $(CFLAGS) $(LDFLAGS)
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faad/makefile
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faad/makefile	2011-10-12 06:06:25 UTC (rev 7607)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faad/makefile	2011-10-12 13:13:47 UTC (rev 7608)
@@ -2,4 +2,4 @@
 SRC=$(wildcard *.c)
 
 libfaad2.dll: $(SRC)
-	gcc -o $@ $^ $(CFLAGS)
\ No newline at end of file
+	gcc -o $@ $^ $(CFLAGS) $(LDFLAGS)
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/Perform Build.bat	2011-10-12 06:06:25 UTC (rev 7607)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/Perform Build.bat	2011-10-12 13:13:47 UTC (rev 7608)
@@ -58,7 +58,9 @@
 
 echo.
 cd src
-windres -i js3240.rc -o jsres.o -O coff
+if "%BuildBits%" == "32" windres -i js3240.rc -o jsres.o -O coff -F pe-i386
+if "%BuildBits%" == "64" windres -i js3240.rc -o jsres.o -O coff
+
 set CFLAGS=%CFLAGS% -I"%usrLocalDir%/include/nspr"
 make -f Makefile.ref JS_DIST="%usrLocalDir%" BUILD_OPT=1 JS_HAS_FILE_OBJECT=1 XLDFLAGS="%LDFLAGS% jsres.o -L%usrLocalDir%/lib -lnspr4"
 if errorlevel 1 goto end

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/WINNT6.1.mk
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/WINNT6.1.mk	2011-10-12 06:06:25 UTC (rev 7607)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/WINNT6.1.mk	2011-10-12 13:13:47 UTC (rev 7608)
@@ -10,7 +10,7 @@
 MKSHLIB = $(LD) -shared $(XMKSHLIBOPTS)
 
 ifdef BUILD_OPT
-OS_CFLAGS += -s
+OS_CFLAGS += -O2 -s
 endif
 
 #.c.o:

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/Perform Build.bat	2011-10-12 06:06:25 UTC (rev 7607)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/Perform Build.bat	2011-10-12 13:13:47 UTC (rev 7608)
@@ -49,6 +49,7 @@
 
 echo.
 echo Configuring
+set CFLAGS=%CFLAGS% -O2
 
 if "%BuildBits%" == "32" sh ./configure --prefix="%usrLocalDir%" --disable-static --enable-nasm
 if "%BuildBits%" == "64" sh ./configure --prefix="%usrLocalDir%" --disable-static

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/Perform Build.bat	2011-10-12 06:06:25 UTC (rev 7607)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/Perform Build.bat	2011-10-12 13:13:47 UTC (rev 7608)
@@ -17,9 +17,9 @@
 call "../Set Common Environment Variables"
 if errorlevel 1 goto end
 
-set package=libvpx-v0.9.7.tar.bz2
-set sourceFolder=libvpx-0.9.7-%BuildBits%
-set tarFolder=libvpx-v0.9.7
+set package=libvpx-v0.9.7-p1.tar.bz2
+set sourceFolder=libvpx-0.9.7-p1-%BuildBits%
+set tarFolder=libvpx-v0.9.7-p1
 set curDir=%CD%
 
 if not exist %package% (
@@ -55,7 +55,7 @@
 echo.
 echo Configuring
 
-if "%BuildBits%" == "32" sh ./configure --prefix="%usrLocalDir%" --disable-vp8-encoder
+if "%BuildBits%" == "32" sh ./configure --prefix="%usrLocalDir%" --disable-vp8-encoder --target=x86-win32-gcc
 if "%BuildBits%" == "64" sh ./configure --prefix="%usrLocalDir%" --disable-vp8-encoder --target=x86_64-win64-gcc
 
 if errorlevel 1 goto end

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/Perform Build.bat	2011-10-12 06:06:25 UTC (rev 7607)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/Perform Build.bat	2011-10-12 13:13:47 UTC (rev 7608)
@@ -20,15 +20,15 @@
 call "../Set Common Environment Variables"
 if errorlevel 1 goto end
 
-set package=nspr-4.8.8.tar.gz
-set sourceFolder=nspr-4.8.8-%BuildBits%
-set tarFolder=nspr-4.8.8
+set package=nspr-4.8.9.tar.gz
+set sourceFolder=nspr-4.8.9-%BuildBits%
+set tarFolder=nspr-4.8.9
 set curDir=%CD%
 
 if not exist %package% (
 	echo.
 	echo Downloading
-	wget ftp://ftp.mozilla.org/pub/mozilla.org/nspr/releases/v4.8.8/src/%package%
+	wget ftp://ftp.mozilla.org/pub/mozilla.org/nspr/releases/v4.8.9/src/%package%
 )
 
 if errorlevel 1 goto end
@@ -52,7 +52,7 @@
 
 echo.
 echo Patching
-patch -p0 -i "%curDir%\configure.patch"
+patch -p0 -i "%curDir%\configure%BuildBits%.patch"
 
 echo.
 echo Configuring
@@ -73,7 +73,8 @@
 copy "%usrLocalDir%\bin\nspr4.dll" "%admBuildDir%"
 
 pexports "%usrLocalDir%/bin/nspr4.dll" > nspr4.def
-dlltool -d nspr4.def -l "%usrLocalDir%/lib/nspr4.dll.a"
+if "%BuildBits%" == "32" dlltool -d nspr4.def -l "%usrLocalDir%/lib/nspr4.dll.a" -m i386 --as-flags=--32
+if "%BuildBits%" == "64" dlltool -d nspr4.def -l "%usrLocalDir%/lib/nspr4.dll.a"
 
 goto end
 

Deleted: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure.patch	2011-10-12 06:06:25 UTC (rev 7607)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure.patch	2011-10-12 13:13:47 UTC (rev 7608)
@@ -1,11 +0,0 @@
---- mozilla/nsprpub/configure.orig	2011-05-04 23:26:56 +0100
-+++ mozilla/nsprpub/configure	2011-05-22 11:32:30 +0100
-@@ -4206,8 +4206,6 @@
-     RESOLVE_LINK_SYMBOLS=1
- 
-     if test -n "$GNU_CC"; then
--        CC="$CC -mno-cygwin"
--        CXX="$CXX -mno-cygwin"
-         DLL_SUFFIX=dll
-         MKSHLIB='$(CC) -shared -Wl,--export-all-symbols -Wl,--out-implib -Wl,$(IMPORT_LIBRARY) $(DLLBASE) -o $(subst $(OBJDIR)/,,$(SHARED_LIBRARY))'
-         RC=$WINDRES

Copied: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure32.patch (from rev 7593, branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure.patch)
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure32.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure32.patch	2011-10-12 13:13:47 UTC (rev 7608)
@@ -0,0 +1,12 @@
+--- mozilla/nsprpub/configure.org	2011-07-28 14:08:33 +0100
++++ mozilla/nsprpub/configure	2011-10-10 21:27:45 +0100
+@@ -4412,8 +4412,8 @@
+         CXX="$CXX -mwindows"
+         DLL_SUFFIX=dll
+-        MKSHLIB='$(CC) -shared -Wl,--export-all-symbols -Wl,--out-implib -Wl,$(IMPORT_LIBRARY) $(DLLBASE) -o $(subst $(OBJDIR)/,,$(SHARED_LIBRARY))'
+-        RC=$WINDRES
++		 MKSHLIB='$(CC) $(CFLAGS) -shared -Wl,--export-all-symbols -Wl,--out-implib -Wl,$(IMPORT_LIBRARY) $(DLLBASE) -o $(subst $(OBJDIR)/,,$(SHARED_LIBRARY))'
++        RC=$WINDRES -F pe-i386
+         # Use temp file for windres (bug 213281)
+         RCFLAGS='-O coff --use-temp-file'
+     else

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure64.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure64.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/configure64.patch	2011-10-12 13:13:47 UTC (rev 7608)
@@ -0,0 +1,11 @@
+--- mozilla/nsprpub/configure	2011-07-28 14:08:33 +0100
++++ mozilla/nsprpub/configure	2011-10-10 22:03:36 +0100
+@@ -743,7 +743,7 @@
+ USE_IPV6=
+ USE_MDUPDATE=
+ _MACOSX_DEPLOYMENT_TARGET=
+-_OPTIMIZE_FLAGS=-O
++_OPTIMIZE_FLAGS=-O2
+ _DEBUG_FLAGS=-g
+ MOZ_DEBUG=1
+ MOZ_OPTIMIZE=

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2011-10-12 06:06:25 UTC (rev 7607)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2011-10-12 13:13:47 UTC (rev 7608)
@@ -280,19 +280,21 @@
     ${File} "Build Info.txt"
     ${File} "Change Log.html"
     ${File} zlib1.dll
-    ${File} libstdc++*.dll
 
 !if ${BUILD_BITS} == 32
     ${File} freetype6.dll
 	${File} pthreadGC2-w32.dll
+	${File} libgcc_s_sjlj-1.dll
+	${File} libstdc++-6.dll
 !endif
 
 !if ${BUILD_BITS} == 64
     ${File} libfreetype-6.dll
 	${File} pthreadGC2-w64.dll
+	${File} libgcc_s_sjlj_64-1.dll
+	${File} libstdc++_64-6.dll
 !endif
 
-    ${File} libgcc_s_sjlj-1.dll
 	${File} nspr4.dll
     ${File} libjs.dll
     ${File} libADM_core.dll



From gruntster at mail.berlios.de  Wed Oct 12 21:15:33 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Wed, 12 Oct 2011 21:15:33 +0200
Subject: [Avidemux-svn-commit] r7609 - in
	branches/avidemux_2.5_branch_gruntster:
	avidemux/ADM_libraries cmake cmake/patches
Message-ID: <20111012191534.09A104814CB@sheep.berlios.de>

Author: gruntster
Date: 2011-10-12 21:15:32 +0200 (Wed, 12 Oct 2011)
New Revision: 7609

Added:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.5.tar.bz2
Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.4.tar.bz2
Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo_enc.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
Log:
[ffmpeg] upgrade ffmpeg to 0.8.5

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.4.tar.bz2
===================================================================
(Binary files differ)

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.5.tar.bz2 (from rev 7604, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.4.tar.bz2)
===================================================================
(Binary files differ)

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2011-10-12 13:13:47 UTC (rev 7608)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2011-10-12 19:15:32 UTC (rev 7609)
@@ -1,6 +1,6 @@
 include(admFFmpegUtil)
 
-set(FFMPEG_VERSION 0.8.4)
+set(FFMPEG_VERSION 0.8.5)
 set(FFMPEG_SOURCE_ARCHIVE "ffmpeg-${FFMPEG_VERSION}.tar.bz2")
 set(FFMPEG_SOURCE_ARCHIVE_DIR "ffmpeg-${FFMPEG_VERSION}")
 

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2011-10-12 13:13:47 UTC (rev 7608)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2011-10-12 19:15:32 UTC (rev 7609)
@@ -2,7 +2,7 @@
 
 export curDir=$PWD
 export ffmpegPath=../../avidemux/ADM_libraries/ffmpeg
-export origFfmpegPath=../ffmpeg-0.8.4
+export origFfmpegPath=../ffmpeg-0.8.5
 
 function updatePatch {
 	#cd $ffmpegPath

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2011-10-12 13:13:47 UTC (rev 7608)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2011-10-12 19:15:32 UTC (rev 7609)
@@ -1,6 +1,6 @@
---- ../ffmpeg-0.8.4/libavcodec/h264.c	2011-09-22 20:39:58 +0100
-+++ libavcodec/h264.c	2011-09-22 20:39:58 +0100
-@@ -4217,6 +4217,20 @@
+--- ../ffmpeg-0.8.5/libavcodec/h264.c	2011-10-11 22:27:47 +0100
++++ libavcodec/h264.c	2011-10-11 22:27:47 +0100
+@@ -4241,6 +4241,20 @@
      { FF_PROFILE_UNKNOWN },
  };
  

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo_enc.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo_enc.c.patch	2011-10-12 13:13:47 UTC (rev 7608)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_mpegvideo_enc.c.patch	2011-10-12 19:15:32 UTC (rev 7609)
@@ -1,5 +1,5 @@
---- libavcodec/mpegvideo_enc.c.orig	2011-05-10 22:40:30 +0100
-+++ libavcodec/mpegvideo_enc.c	2011-05-10 22:40:30 +0100
+--- ../ffmpeg-0.8.5/libavcodec/mpegvideo_enc.c	2011-10-11 22:27:47 +0100
++++ libavcodec/mpegvideo_enc.c	2011-10-11 22:27:47 +0100
 @@ -376,12 +376,14 @@
  
          av_log(avctx, AV_LOG_INFO, "Warning vbv_delay will be set to 0xFFFF (=VBR) as the specified vbv buffer is too large for the given bitrate!\n");
@@ -15,7 +15,7 @@
  
      if(s->obmc && s->avctx->mb_decision != FF_MB_DECISION_SIMPLE){
          av_log(avctx, AV_LOG_ERROR, "OBMC is only supported with simple mb decision\n");
-@@ -422,10 +424,12 @@
+@@ -423,10 +425,12 @@
          return -1;
      }
  

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2011-10-12 13:13:47 UTC (rev 7608)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2011-10-12 19:15:32 UTC (rev 7609)
@@ -1,6 +1,6 @@
---- ../ffmpeg-0.8.1/libavcodec/utils.c	2011-08-05 21:20:17 +0100
-+++ libavcodec/utils.c	2011-08-05 21:20:17 +0100
-@@ -787,10 +787,12 @@
+--- ../ffmpeg-0.8.5/libavcodec/utils.c	2011-10-11 22:27:47 +0100
++++ libavcodec/utils.c	2011-10-11 22:27:47 +0100
+@@ -792,10 +792,12 @@
  
      if((avctx->codec->capabilities & CODEC_CAP_DELAY) || avpkt->size){
          //FIXME remove the check below _after_ ensuring that all audio check that the available space is enough



From mean at mail.berlios.de  Mon Oct 17 07:34:13 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 17 Oct 2011 07:34:13 +0200
Subject: [Avidemux-svn-commit] r7610 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111017053413.7F4344815AB@sheep.berlios.de>

Author: mean
Date: 2011-10-17 07:34:12 +0200 (Mon, 17 Oct 2011)
New Revision: 7610

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfChunk.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
Log:
[ASF/Demux] Better support for streamable wmv file

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-12 19:15:32 UTC (rev 7609)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-17 05:34:12 UTC (rev 7610)
@@ -159,6 +159,10 @@
   {
     return 0; 
   }
+  ADM_info("Stream Video: index=%d, sid=%d\n",(int)_videoIndex,(int)_videoStreamId);
+  for(int i=0;i<_nbAudioTrack;i++)
+    ADM_info("Stream Audio: index=%d, sid=%d\n",
+                (int)_allAudioTracks[i].streamIndex,(int)_allAudioTracks[i].streamIndex);
   buildIndex();
   fseeko(_fd,_dataStartOffset,SEEK_SET);
   _packet=new asfPacket(_fd,_nbPackets,_packetSize,&readQueue,_dataStartOffset);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-12 19:15:32 UTC (rev 7609)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-17 05:34:12 UTC (rev 7610)
@@ -53,7 +53,10 @@
   ADM_CHUNK_CLOCK_TYPE_EX,
   ADM_CHUNK_LANGUAGE_LIST_EX,
   ADM_CHUNK_EXTENDED_STREAM_PROP,
-  ADM_CHUNK_UNKNOWN_CHUNK
+  ADM_CHUNK_CONTENT_DESC,
+  ADM_CHUNK_EXT_CONTENT_DESC,
+  ADM_CHUNK_UNKNOWN_CHUNK,
+  
 }ADM_KNOWN_CHUNK;
 
 typedef struct 
@@ -63,7 +66,9 @@
   uint8_t val[16];
   ADM_KNOWN_CHUNK id; 
 }chunky;
-
+/**
+    \class asfChunk
+*/
 class asfChunk
 {
   protected:
@@ -85,6 +90,7 @@
   uint32_t  read32(void);
   uint32_t  read16(void);
   uint8_t   read8(void);
+  uint64_t  endPos(void) {return _chunkStart+chunkLen;}
   uint8_t   read(uint8_t *where, uint32_t how);
   const chunky    *chunkId(void);
   uint8_t   skip(uint32_t skip);
@@ -151,7 +157,8 @@
     uint8_t                 buildIndex(void);
     uint8_t                 loadVideo(asfChunk *s);
     bool                    loadAudio(asfChunk *s,uint32_t sid);
-    
+    bool                    decodeExtHeader(asfChunk *s);
+    bool                    decodeStreamHeader(asfChunk *s);
     ADM_queue               readQueue;
     uint32_t                curSeq;
     asfPacket               *_packet;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfChunk.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfChunk.cpp	2011-10-12 19:15:32 UTC (rev 7609)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfChunk.cpp	2011-10-17 05:34:12 UTC (rev 7610)
@@ -50,7 +50,10 @@
   {0xcb,0xa5,0xe6,0x14,0x72,0xc6,0x32,0x43,0x83,0x99,0xa9,0x69,0x52,0x06,0x5b,0x5a},ADM_CHUNK_EXTENDED_STREAM_PROP},
   {"MetaData Object",0,
   {0xea,0xcb,0xf8,0xc5,0xaf,0x5b,0x77,0x48,0x84,0x67,0xaa,0x8c,0x44,0xfa,0x4c,0xca},ADM_CHUNK_UNKNOWN_CHUNK},
-  
+  {"Content Desc",0,
+  {0x33,0x26,0xb2,0x75,0x8e,0x66,0xcf,0x11,0xa6,0xd9,0x00,0xaa,0x00,0x62,0xce,0x6c},ADM_CHUNK_CONTENT_DESC},
+  {"Extended Content Desc",0,
+  {0x40,0xa4,0xd0,0xd2,0x07,0xe3,0xd2,0x11,0x97,0xf0,0x00,0xa0,0xc9,0x5e,0xa8,0x50},ADM_CHUNK_EXT_CONTENT_DESC},
   {"zz",0,{0x30,0x26,0xb2,0x75,0x8e,0x66,0xcf,0x11,0xa6,0xd9,0x00,0xaa,0x00,0x62,0xce,0x6c},ADM_CHUNK_HEADER_CHUNK}
   
 };
@@ -181,6 +184,7 @@
   printf("Chunk type  : <<<<%s>>>>\n",id->name);
   printf("Chunk Start : %"LX"\n",_chunkStart);
   printf("Chunk Len   : %"LU"\n",(uint32_t)chunkLen);
+  printf("%02x%02x%02x%02x-%02x%02x-xxxx",guId[3],guId[2],guId[1],guId[0],guId[5],guId[4]);
   for(int i=0;i<16;i++) printf("%02x ",guId[i]);
   printf("\n");
   return 1;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-12 19:15:32 UTC (rev 7609)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-17 05:34:12 UTC (rev 7610)
@@ -32,6 +32,114 @@
 static const uint8_t asf_audio[16]={0x40,0x9e,0x69,0xf8,0x4d,0x5b,0xcf,0x11,0xa8,0xfd,0x00,0x80,0x5f,0x5c,0x44,0x2b};
 static const uint8_t asf_video[16]={0xc0,0xef,0x19,0xbc,0x4d,0x5b,0xcf,0x11,0xa8,0xfd,0x00,0x80,0x5f,0x5c,0x44,0x2b};
 
+/**
+    \fn decodeStreamHeader
+*/
+bool asfHeader::decodeStreamHeader(asfChunk *s)
+{
+uint8_t gid[16];
+    // Client GID
+        uint32_t audiovideo=0; // video=1, audio=2, 0=unknown
+        uint32_t sid;
+        s->read(gid,16);
+        printf("Type            :");
+        for(int z=0;z<16;z++) printf("0x%02x,",gid[z]);
+        if(!memcmp(gid,asf_video,16))
+        {
+          printf("(video)");
+          audiovideo=1;
+        } else
+        {
+          if(!memcmp(gid,asf_audio,16))
+          {
+            printf("(audio)"); 
+            audiovideo=2;
+          } else printf("(? ? ? ?)"); 
+        }
+        printf("\nConceal       :");
+        for(int z=0;z<16;z++) printf(":%02x",s->read8());
+        printf("\n");
+        printf("Reserved    : %08"LLX"\n",s->read64());
+        printf("Total Size  : %04"LX"\n",s->read32());
+        printf("Size        : %04"LX"\n",s->read32());
+        sid=s->read16();
+        printf("Stream nb   : %04d\n",sid);
+        printf("Reserved    : %04"LX"\n",s->read32());
+        switch(audiovideo)
+        {
+          case 1: // Video
+             {
+                if(_videoIndex==-1) // take the 1st video track
+                {
+                    _videoIndex=sid;
+                    _videoStreamId= sid;
+                    if(!loadVideo(s))
+                    {
+                      return 0; 
+                    }
+                }else printf("Already have a video track, skipping\n");
+              } 
+              break;
+          case 2: // audio
+            loadAudio(s,sid);
+            break;
+          default: 
+            break;
+        }
+        return true;
+}
+/**
+    \fn decodeExtHeader
+    \brief we must decode it as it may contain a video stream (e.g. france2 wmv files)
+*/ 
+bool asfHeader::decodeExtHeader(asfChunk *s)
+{
+            s->read32();s->read32(); // start time
+            s->read32();s->read32(); // end time
+            s->read32(); // bitrate
+            s->read32(); // buffer size
+            s->read32(); //Initial buffer fullness
+            s->read32(); // alt bitrate
+            s->read32(); // alt buffer size
+            s->read32(); // alt Initial buffer fullness
+            s->read32(); // max object size
+            s->read32(); // flags
+            s->read16(); // Stream #
+            s->read16(); // stream lang index
+            s->read32();;s->read32(); // avg time / frame
+            int streamNameCount=s->read16(); // stream name count
+            int payloadExtCount=s->read16(); // payload ext system count
+            printf("\tName       count : %d\n",streamNameCount);
+            printf("\tPayloadExt count : %d\n",payloadExtCount);
+            // stream names
+            for(int i=0;i<streamNameCount;i++)
+            {
+                    printf("\t lang %d\n",s->read16());
+                    int size=s->read16();
+                    s->skip(size);
+            }
+            // payload system count
+            for(int i=0;i<payloadExtCount;i++)
+            {
+                // GUID
+                s->read32();s->read32();s->read32();s->read32();
+                printf("\tExt data size %d\n",s->read16());
+                int sz=s->read32();
+                s->skip(sz);
+            }
+            // stream properties object
+            if(ftello(_fd)+16+4<s->endPos())
+            {       uint8_t gid[16];
+                    asfChunk *x=new asfChunk(_fd);
+                    x->nextChunk();
+                    x->dump();
+                    if(x->chunkId()->id==ADM_CHUNK_STREAM_HEADER_CHUNK)
+                        decodeStreamHeader(x);
+                    x->skipChunk();
+                    delete x;
+            }
+            return true;
+}
 /** *****************************************
     \fn getHeaders
     \brief Read Headers to collect information 
@@ -40,7 +148,6 @@
 {
   uint32_t i=0,nbSubChunk,hi,lo;
   const chunky *id;
-  uint8_t gid[16];
   uint32_t mn=0,mx=0;
   asfChunk chunk(_fd);
   // The first header is header chunk
@@ -67,70 +174,29 @@
     s->dump();
     switch(id->id)
     {
-   
       case ADM_CHUNK_HEADER_EXTENSION_CHUNK:
       {
         printf("Got header extension chunk\n");
-        s->skipChunk();
+        // 128+16 reserved=
+        s->read32();s->read32();s->read32();s->read32();s->read16();
+        int x=s->read32();
+        printf("Dumping object ext : %d data bytes\n",x);
+        asfChunk *son=new asfChunk(_fd);
+        do
+        {
+            son->nextChunk();
+            son->dump();
+            if(son->chunkId()->id==ADM_CHUNK_EXTENDED_STREAM_PROP)
+            {
+                decodeExtHeader(s);
+            }
+            son->skipChunk();
+            
+        }while(son->endPos()+24<s->endPos());
+        delete son;
         break;
         }
-#if 0   
-        s->skip(16); // Clock type extension ????
-        printf("?? %d\n",s->read16());
-        printf("?? %d\n",s->read32());
-          
-        uint32_t streamNameCount;
-        uint32_t payloadCount;
-          
-          asfChunk *u=new asfChunk(_fd);
-          for(int zzz=0;zzz<8;zzz++)
-          {
-              u->nextChunk();
-              u->dump();
-              id=u->chunkId();
-              if(id->id==ADM_CHUNK_EXTENDED_STREAM_PROP)
-              {
-                  s->skip(8); // start time 
-                  s->skip(8); // end time
-                  printf("Bitrate         %u :\n",u->read32());
-                  printf("Buffer Size     %u :\n",u->read32());
-                  printf("BFill           %u :\n",u->read32());
-                  printf("Alt Bitrate     %u :\n",u->read32());
-                  printf("Alt Bsize       %u :\n",u->read32());
-                  printf("Alt Bfullness   %u :\n",u->read32());
-                  printf("Max object Size %u :\n",u->read32());
-                  printf("Flags           0x%x :\n",u->read32());
-                  printf("Stream no       %u :\n",u->read16());
-                  printf("Stream lang     %u :\n",u->read16());
-                  printf("Stream time/fra %lu :\n",u->read64());
-                  streamNameCount=u->read16();
-                  payloadCount=u->read16();
-                  printf("Stream Nm Count %u :\n",streamNameCount);
-                  printf("Payload count   %u :\n",payloadCount);
-                  for(int stream=0;stream<streamNameCount;stream++)
-                  {
-                    u->read16();
-                    skip=u->read16();
-                    u->skip(skip);
-                  }
-                  uint32_t size;
-                  for(int payload=0;payload<payloadCount;payload++)
-                  {
-                    for(int pp=0;pp<16;pp++) printf("0x%02x,",u->read8());
-                    printf("\n");
-                    skip=u->read16();
-                    size=u->read32();
-                    u->skip(size);
-                    printf("Extra Data : %d, skipd %d\n",size,skip);
-                  }
-                  printf("We are at %x\n",ftello(_fd));
-                }
-                u->skipChunk();
-          }
-          delete u;
-      }
-      break;
-#endif      
+
       case ADM_CHUNK_FILE_HEADER_CHUNK:
         {
             // Client GID
@@ -162,59 +228,10 @@
           break;
       case ADM_CHUNK_STREAM_HEADER_CHUNK:
       {
-         // Client GID
-        uint32_t audiovideo=0; // video=1, audio=2, 0=unknown
-        uint32_t sid;
-        s->read(gid,16);
-        printf("Type            :");
-        for(int z=0;z<16;z++) printf("0x%02x,",gid[z]);
-        if(!memcmp(gid,asf_video,16))
-        {
-          printf("(video)");
-          audiovideo=1;
-        } else
-        {
-          if(!memcmp(gid,asf_audio,16))
-          {
-            printf("(audio)"); 
-            audiovideo=2;
-          } else printf("(? ? ? ?)"); 
-        }
-        printf("\nConceal       :");
-        for(int z=0;z<16;z++) printf(":%02x",s->read8());
-        printf("\n");
-        printf("Reserved    : %08"LLX"\n",s->read64());
-        printf("Total Size  : %04"LX"\n",s->read32());
-        printf("Size        : %04"LX"\n",s->read32());
-        sid=s->read16();
-        printf("Stream nb   : %04d\n",sid);
-        printf("Reserved    : %04"LX"\n",s->read32());
-        switch(audiovideo)
-        {
-          case 1: // Video
-          {
-                    _videoStreamId=sid;
-                    if(!loadVideo(s))
-                    {
-                      delete s;
-                      return 0; 
-                    }
-                    break;
-          }
-              break;
-          case 2: // audio
-          {
-            loadAudio(s,sid);
-          
-            
-          }
+          decodeStreamHeader(s);
           break;
-          default:break; 
-          
-        }
       }
-      break;
-       default:
+      default:
          break;
     }
     s->skipChunk();
@@ -259,6 +276,7 @@
 uint8_t asfHeader::loadVideo(asfChunk *s)
 {
   uint32_t w,h,x;
+            printf("--\n");
             w=s->read32();
             h=s->read32();
             s->read8();
@@ -309,6 +327,8 @@
             {
                 ADM_info("No extra data for video\n");
             }
+            uint64_t l=ftello(_fd);
+            printf("Bytes left : %d\n",(int)(s->endPos()-l));
             return 1;
 }
 /**
@@ -485,7 +505,8 @@
 
   _videostream.dwLength=_mainaviheader.dwTotalFrames=nbImage;
   if(!nbImage) return 0;
-  
+  _index[0].flags=AVI_KEY_FRAME;
+  if(_index[0].pts==ADM_NO_PTS) _index[0].pts=_index[0].dts;
   // Update fps
   // In fact it is an average fps
   //

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-12 19:15:32 UTC (rev 7609)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-17 05:34:12 UTC (rev 7610)
@@ -29,6 +29,7 @@
 
 #if 0
 #define aprintf printf
+#define ASF_VERBOSE
 #else
 #define aprintf(...) {}
 #endif
@@ -112,12 +113,11 @@
    }
 #endif
    _offset=0;
-   if(read8()!=0x82) 
+   int r82=read8();
+   if(r82!=0x82) 
    {
      printf("[ASF PACKET]At pos 0x%"LLX" \n",(uint64_t)ftello(_fd));
-     printf("[ASF PACKET]not a 82 packet\n");
-     printf("[ASF PACKET]not a 82 packet\n");
-     printf("[ASF PACKET]not a 82 packet\n");
+     printf("[ASF PACKET]not a 82 packet but 0x%x\n",r82);
      return 0;
    }
    
@@ -258,6 +258,7 @@
 #ifdef ASF_VERBOSE     
 //    if(streamId==1)
     {
+     printf("StreamId               %d\n",streamId);
      printf("This segment %d bytes, %d /%d\n",packetLen,seg,nbSeg);
      printf("Offset                 %d\n",offset);
      printf("sequence               %d\n",sequence);



From mean at mail.berlios.de  Mon Oct 17 07:34:15 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 17 Oct 2011 07:34:15 +0200
Subject: [Avidemux-svn-commit] r7611 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111017053415.5934B4815AB@sheep.berlios.de>

Author: mean
Date: 2011-10-17 07:34:15 +0200 (Mon, 17 Oct 2011)
New Revision: 7611

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
Log:
[ASF/Demux] Use bvector, faster

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-17 05:34:12 UTC (rev 7610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-17 05:34:15 UTC (rev 7611)
@@ -17,12 +17,10 @@
  
 #ifndef ADM_ASF_H
 #define ADM_ASF_H
-#include <vector>
-using std::vector;
 #include "ADM_Video.h"
 #include "ADM_queue.h"
 #include "ADM_asfPacket.h"
-
+#include "BVector.h"
 #define ASF_MAX_AUDIO_TRACK 8
 
 
@@ -39,7 +37,7 @@
   uint64_t audioDts[ASF_MAX_AUDIO_TRACK];
 }asfIndex;
 
-typedef  vector <asfIndex> AsfVectorIndex;
+typedef  BVector <asfIndex> AsfVectorIndex;
 
 typedef enum 
 {

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-17 05:34:12 UTC (rev 7610)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-17 05:34:15 UTC (rev 7611)
@@ -422,7 +422,7 @@
             if(first==false)
             {
                 indexEntry.frameLen=len;
-                _index.push_back(indexEntry);
+                _index.append(indexEntry);
             }
             first=false;
             aprintf("New sequence\n");



From mean at mail.berlios.de  Mon Oct 17 07:34:16 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 17 Oct 2011 07:34:16 +0200
Subject: [Avidemux-svn-commit] r7612 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111017053416.E9CB04815AB@sheep.berlios.de>

Author: mean
Date: 2011-10-17 07:34:16 +0200 (Mon, 17 Oct 2011)
New Revision: 7612

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
Log:
[ASF/Demux] Add indexing progress bar

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-17 05:34:15 UTC (rev 7611)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-17 05:34:16 UTC (rev 7612)
@@ -22,6 +22,7 @@
 #include "DIA_coreToolkit.h"
 #include "ADM_asf.h"
 #include "ADM_asfPacket.h"
+#include "DIA_working.h"
 
 #if 0
 #define aprintf printf
@@ -406,12 +407,15 @@
   asfIndex indexEntry;
   memset(&indexEntry,0,sizeof(indexEntry));
   bool first=true;
+  DIA_workingBase *progressBar=createWorking("Indexing");
+  uint32_t fileSizeMB=(uint32_t)(fSize>>10);
   while(packet<_nbPackets)
   {
     while(!readQueue.isEmpty())
     {
       asfBit *bit=NULL;
-      
+      uint32_t curPos=(uint32_t)(ftello(_fd)>>10);
+      progressBar->update(curPos,fileSizeMB);
       ADM_assert(readQueue.pop((void**)&bit));
       uint64_t dts=bit->dts;
       if(bit->stream==_videoStreamId)
@@ -429,19 +433,6 @@
             if( ((sequence+1)&0xff)!=(bit->sequence&0xff))
             {
                 printf("!!!!!!!!!!!! non continuous sequence %u %u\n",sequence,bit->sequence); 
-    #if 0         
-                // Let's insert a couple of null frame
-                int32_t delta,start,end;
-                
-                start=256+bit->sequence-sequence-1;
-                start&=0xff;
-                printf("!!!!!!!!!!!! Delta %d\n",start);
-                
-                for(int filler=0;filler<start;filler++)
-                {
-                  tmpIndex[++nbImage].frameLen=0;
-                }
-    #endif            
             }
             
             
@@ -493,6 +484,7 @@
     aPacket->nextPacket(0xff); // All packets
     aPacket->skipPacket();
   }
+  delete progressBar;
   delete aPacket;
   //delete working;
   /* Compact index */



From mean at mail.berlios.de  Tue Oct 18 07:50:10 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 18 Oct 2011 07:50:10 +0200
Subject: [Avidemux-svn-commit] r7614 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices:
	. AudioCore
Message-ID: <20111018055011.2896F4815C8@sheep.berlios.de>

Author: mean
Date: 2011-10-18 07:50:10 +0200 (Tue, 18 Oct 2011)
New Revision: 7614

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/CMakeLists.txt
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/CMakeLists.txt
Log:
[audioCore] Re-add audioCore audio device, untested

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/CMakeLists.txt	2011-10-17 05:35:34 UTC (rev 7613)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/CMakeLists.txt	2011-10-18 05:50:10 UTC (rev 7614)
@@ -0,0 +1,9 @@
+INCLUDE(av_plugin)
+
+
+SET(ADM_av_audiocore_SRCS ADM_deviceAudioCore.cpp)
+
+ADD_LIBRARY(ADM_av_audiocore SHARED ${ADM_av_audiocore_SRCS})
+TARGET_LINK_LIBRARIES(ADM_av_audiocore winmm ADM_core ADM_coreAudio)
+INIT_AUDIO_DEVICE(ADM_av_audiocore)
+INSTALL_AUDIODEVICE(ADM_av_audiocore)

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/CMakeLists.txt	2011-10-17 05:35:34 UTC (rev 7613)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/CMakeLists.txt	2011-10-18 05:50:10 UTC (rev 7614)
@@ -31,3 +31,6 @@
 ADD_SUBDIRECTORY(Win32)
 endif(WIN32)
 #
+IF(APPLE)
+ADD_SUBDIRECTORY(AudioCore)
+ENDIF(APPLE)



From mean at mail.berlios.de  Sat Oct 22 09:23:01 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 22 Oct 2011 09:23:01 +0200
Subject: [Avidemux-svn-commit] r7615 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore
Message-ID: <20111022072301.4FA484814D8@sheep.berlios.de>

Author: mean
Date: 2011-10-22 09:23:00 +0200 (Sat, 22 Oct 2011)
New Revision: 7615

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/CMakeLists.txt
Log:
[audioCoreDevice] Patch by Nibbles

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/CMakeLists.txt	2011-10-18 05:50:10 UTC (rev 7614)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/CMakeLists.txt	2011-10-22 07:23:00 UTC (rev 7615)
@@ -4,6 +4,7 @@
 SET(ADM_av_audiocore_SRCS ADM_deviceAudioCore.cpp)
 
 ADD_LIBRARY(ADM_av_audiocore SHARED ${ADM_av_audiocore_SRCS})
-TARGET_LINK_LIBRARIES(ADM_av_audiocore winmm ADM_core ADM_coreAudio)
+INCLUDE_DIRECTORIES("${AVIDEMUX_SOURCE_DIR}/avidemux")
+TARGET_LINK_LIBRARIES(ADM_av_audiocore ADM_core ADM_coreAudio "-Wl,-framework,Carbon" "-Wl,-framework,AudioUnit")
 INIT_AUDIO_DEVICE(ADM_av_audiocore)
 INSTALL_AUDIODEVICE(ADM_av_audiocore)



From mean at mail.berlios.de  Sat Oct 22 09:23:02 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 22 Oct 2011 09:23:02 +0200
Subject: [Avidemux-svn-commit] r7616 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore
Message-ID: <20111022072302.B82E24814D8@sheep.berlios.de>

Author: mean
Date: 2011-10-22 09:23:02 +0200 (Sat, 22 Oct 2011)
New Revision: 7616

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.h
Log:
[audioCoreDevice] Update to newer audioDevice api, patch by Nibbles

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.cpp	2011-10-22 07:23:00 UTC (rev 7615)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.cpp	2011-10-22 07:23:02 UTC (rev 7616)
@@ -14,7 +14,6 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#include "config.h"
 
 #ifdef __APPLE__
 #include <stdio.h>
@@ -25,11 +24,14 @@
 #include "ADM_default.h"
 #include "ADM_assert.h"
 #include "ADM_audiodevice.h"
-#include "ADM_audiodevice/ADM_deviceAudioCore.h"
+#include "ADM_audioDeviceInternal.h"
+#include "ADM_deviceAudioCore.h"
 #include "ADM_osSupport/ADM_debugID.h"
 #define MODULE_NAME  MODULE_ADEVICE
 #include "ADM_osSupport/ADM_debug.h"
 
+ADM_DECLARE_AUDIODEVICE(CoreAudio,coreAudioDevice,1,0,0,"CoreAudio audio device (c) mean");
+
 #define BUFFER_SIZE (500*48000)
 
 static Component comp = NULL;
@@ -135,7 +137,7 @@
         return 0; \
     }
 
-uint8_t coreAudioDevice::init(uint8_t channels, uint32_t fq) 
+uint8_t coreAudioDevice::init(uint32_t channels, uint32_t fq) 
 {
 	_channels = channels;
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.h	2011-10-22 07:23:00 UTC (rev 7615)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.h	2011-10-22 07:23:02 UTC (rev 7616)
@@ -17,7 +17,7 @@
 					uint8_t				_inUse;
 		  public:
 		  				coreAudioDevice(void);
-		     		virtual uint8_t init(uint8_t channels, uint32_t fq);
+		     		virtual uint8_t init(uint32_t channels, uint32_t fq);
 	    			virtual uint8_t play(uint32_t len, float *data);
 		      		virtual uint8_t stop(void);
 					virtual uint8_t setVolume(int volume);



From mean at mail.berlios.de  Fri Oct 28 08:28:52 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:28:52 +0200
Subject: [Avidemux-svn-commit] r7617 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028062852.8CE15481404@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:28:51 +0200 (Fri, 28 Oct 2011)
New Revision: 7617

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h
Log:
[asf] cosmetic

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-22 07:23:02 UTC (rev 7616)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:28:51 UTC (rev 7617)
@@ -291,9 +291,6 @@
   uint32_t delta;
   while(1)
   {
-   
-    
-    
     while(!readQueue.isEmpty())
     {
       asfBit *bit;
@@ -363,8 +360,4 @@
   aprintf(">>Len %d seq %d\n",len,curSeq);
   return 1; 
 }
-/*
-    __________________________________________________________
-*/
-
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-22 07:23:02 UTC (rev 7616)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:28:51 UTC (rev 7617)
@@ -34,7 +34,9 @@
 #define aprintf(...) {}
 #endif
 
- 
+/**
+    \fn asfPacket ctor
+*/ 
 asfPacket::asfPacket(FILE *f,uint32_t nb,uint32_t pSize,ADM_queue *q,uint32_t startDataOffset)
  {
    _fd=f;
@@ -49,20 +51,16 @@
    _nbPackets=nb;
    _startDataOffset=startDataOffset;
  }
+/**
+    \fn asfPacket dtor
+*/
  asfPacket::~asfPacket()
  {
 	 purge();
  }
- uint8_t   asfPacket::readChunkPayload(uint8_t *data, uint32_t *dataLen)
- {
-   uint32_t remaining;
-   *dataLen=0;
-   ADM_assert(0);
-   purge();
-   return 1;
-  
- }
- 
+ /**
+    \fn goToPacket
+*/
  uint8_t asfPacket::goToPacket(uint32_t packet)
  {
    uint32_t offset=_startDataOffset+packet*pakSize;
@@ -94,7 +92,8 @@
  */
 uint8_t   asfPacket::nextPacket(uint8_t streamWanted)
 {
-   uint32_t atime,aduration,nbSeg,segType=0x80;
+   uint64_t atime;
+   uint32_t aduration,nbSeg,segType=0x80;
    uint32_t sequenceLen,len,streamId;
    int32_t   packetLen=0;
    uint32_t  paddingLen;
@@ -153,7 +152,7 @@
 
    
   
-   atime=read32(); // Send time (ms)
+   atime=1000*read32(); // Send time (ms)
    aduration=read16(); // Duration (ms)
    
    if(flags &1) // Multiseg
@@ -180,7 +179,7 @@
    
    
    printf("packetLen :           %d\n",packetLen);
-   printf("Send      :           %d\n",atime);
+   printf("Send      :           %d\n",atime/1000);
    printf("Duration  :           %d\n",aduration);
    printf("# of seg  :           %d %x\n",nbSeg,segType);
 #endif
@@ -282,7 +281,8 @@
            printf("oops exceeding %d/%d\n",l,payloadLen);
            if(streamId==streamWanted || streamWanted==0xff)
            {
-             pushPacket(keyframe,currentPacket,offset,sequence,payloadLen,streamId,atime*1000);
+             pushPacket(keyframe,currentPacket,offset,sequence,payloadLen,streamId,atime);
+             atime=ADM_NO_PTS;
              
            }else
            {
@@ -298,7 +298,8 @@
      { // else we read "payloadLen" bytes and put them at offset "offset"
        if(streamId==streamWanted|| streamWanted==0xff)
        {
-         pushPacket(keyframe,currentPacket,offset,sequence,payloadLen,streamId,atime*1000);    
+         pushPacket(keyframe,currentPacket,offset,sequence,payloadLen,streamId,atime);   
+         atime=ADM_NO_PTS;
        }else
         skip(payloadLen);
        aprintf("Reading %d bytes\n",payloadLen);
@@ -329,7 +330,7 @@
  uint8_t asfPacket::pushPacket(uint32_t keyframe,uint32_t packetnb,uint32_t offset,uint32_t sequence,uint32_t payloadLen,uint32_t stream,uint64_t dts)
  {
    asfBit *bit=new asfBit;
-   //printf("Pushing packet stream=%d len=%d seq=%d dts=%d ms\n",stream,payloadLen,sequence,dts/1000);
+   printf("Pushing packet stream=%d len=%d seq=%d dts=%d ms\n",stream,payloadLen,sequence,dts/1000);
    bit->sequence=sequence;
    bit->offset=offset;
    bit->len=payloadLen;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h	2011-10-22 07:23:02 UTC (rev 7616)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h	2011-10-28 06:28:51 UTC (rev 7617)
@@ -18,7 +18,9 @@
 #define ASF_PACKET_H
 
 #include "ADM_queue.h"
-
+/**
+    \struct asfBit
+*/
 typedef struct 
 {
   uint32_t sequence;
@@ -31,7 +33,9 @@
   uint8_t  *data;
   
 }asfBit;
-
+/**
+    \class asfPacket
+*/
 class asfPacket
 {
   protected:
@@ -57,7 +61,6 @@
     
     uint8_t   goToPacket(uint32_t packet);
   
-    uint8_t   readChunkPayload(uint8_t *data, uint32_t *dataLen);
     uint8_t   nextPacket(uint8_t streamWanted);
     uint8_t   skipPacket(void);
     



From mean at mail.berlios.de  Fri Oct 28 08:28:53 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:28:53 +0200
Subject: [Avidemux-svn-commit] r7618 -
	branches/avidemux_2.6_branch_mean/avidemux/gtk
Message-ID: <20111028062853.6305E481415@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:28:53 +0200 (Fri, 28 Oct 2011)
New Revision: 7618

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt
Log:
[gtk] osSupport seems to be needed in some cases

Modified: branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt	2011-10-28 06:28:51 UTC (rev 7617)
+++ branches/avidemux_2.6_branch_mean/avidemux/gtk/CMakeLists.txt	2011-10-28 06:28:53 UTC (rev 7618)
@@ -101,6 +101,7 @@
 	ADM_shellGtk
 	ADM_UIGtk6
 	ADM_coreAudioDevice6
+        ADM_osSupport6
 )
 
 ###########################################



From mean at mail.berlios.de  Fri Oct 28 08:28:54 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:28:54 +0200
Subject: [Avidemux-svn-commit] r7619 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028062854.A6088481404@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:28:54 +0200 (Fri, 28 Oct 2011)
New Revision: 7619

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
Log:
[Asf] Cleanup

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:28:53 UTC (rev 7618)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:28:54 UTC (rev 7619)
@@ -23,6 +23,7 @@
 #include "ADM_asf.h"
 #include "ADM_asfPacket.h"
 #include "DIA_working.h"
+#include "ADM_vidMisc.h"
 
 #if 0
 #define aprintf printf
@@ -393,7 +394,6 @@
   _dataStartOffset=ftello(_fd);
   
   // Here we go
-  //DIA_working *working=new DIA_working("indexing asf");
   asfPacket *aPacket=new asfPacket(_fd,_nbPackets,_packetSize,
                                    &readQueue,_dataStartOffset);
   uint32_t packet=1;
@@ -414,13 +414,18 @@
     while(!readQueue.isEmpty())
     {
       asfBit *bit=NULL;
+
+      // update UI
       uint32_t curPos=(uint32_t)(ftello(_fd)>>10);
       progressBar->update(curPos,fileSizeMB);
       ADM_assert(readQueue.pop((void**)&bit));
+      // --
       uint64_t dts=bit->dts;
       if(bit->stream==_videoStreamId)
       {
-          aprintf(">found packet of size %d seq %d, while curseq =%d\n",bit->len,bit->sequence,curSeq);
+          printf(">found packet of size=%d off=%d seq %d, while curseq =%d, dts=%s\n",
+                        bit->len,bit->offset,  bit->sequence,curSeq,
+                        ADM_us2plain(dts));
           if(bit->sequence!=sequence || first==true)
           {
             if(first==false)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:28:53 UTC (rev 7618)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:28:54 UTC (rev 7619)
@@ -23,8 +23,8 @@
 #include "ADM_Video.h"
 
 #include "fourcc.h"
+#include "ADM_vidMisc.h"
 
-
 #include "ADM_asfPacket.h"
 
 #if 0
@@ -69,8 +69,9 @@
    purge();
    return 1;
  }
- /*
-      Read ASF packet & segments 
+ /**
+    \fn     nextPacket
+    \brief  Read ASF packet & segments 
  
     Flags are bitwise OR of:
    
@@ -92,25 +93,17 @@
  */
 uint8_t   asfPacket::nextPacket(uint8_t streamWanted)
 {
-   uint64_t atime;
-   uint32_t aduration,nbSeg,segType=0x80;
+   uint64_t sendTime;
+   uint32_t aduration,nbSeg,payloadLengthType=0x80;
    uint32_t sequenceLen,len,streamId;
    int32_t   packetLen=0;
    uint32_t  paddingLen;
-   uint8_t   flags;
+   int   lengthTypeFlags,propertyFlags,multiplePayloadPresent;
+   int sequenceType,sequence,offsetLenType,replicaLenType,streamNumberLenType,mediaObjectNumberLenType;
+   
+
     
    packetStart=ftello(_fd);
-#ifdef ASF_VERBOSE
-   uint32_t round=packetStart-_startDataOffset;
-   if(round % pakSize)
-   {
-     printf("[ASF PACKET] we are starting a new packet at 0x%x\n",packetStart); 
-     printf("[ASF PACKET]but data starts at  0x%x\n",_startDataOffset);
-     printf("[ASF PACKET]and offset is not a multiple of length = %d\n",pakSize);
-     ADM_assert(0);
-     
-   }
-#endif
    _offset=0;
    int r82=read8();
    if(r82!=0x82) 
@@ -122,190 +115,139 @@
    
    aprintf("============== New packet ===============\n");
    read16();          // Always 0 ????
-   flags=read8();
-   segmentId=read8();
+
+    // / end of error correction
+    // Payload parsing information
    packetLen=0;
    paddingLen=0;
-   
-
+   sequenceType=0;
+   sequenceLen=0;
+   sequence=0;
+   offsetLenType=0;
+   replicaLenType=0;
+   streamNumberLenType=0;
+   mediaObjectNumberLenType=0;
+   lengthTypeFlags=read8();
+   propertyFlags=read8();
+   multiplePayloadPresent=lengthTypeFlags&1;
    // Read packetLen
-   packetLen=readVCL(flags>>5,pakSize);
+   packetLen=readVCL(lengthTypeFlags>>5,pakSize);
    // Sequence len
-   sequenceLen=readVCL(flags>>1,0);
+   sequenceLen=readVCL(lengthTypeFlags>>1,0);
    // Read padding size (padding):
-   paddingLen=readVCL(flags>>3,0);
+   paddingLen=readVCL(lengthTypeFlags>>3,0);
+   //
+   replicaLenType=(propertyFlags>>0)&3;
+   offsetLenType=(propertyFlags>>2)&3;
+   mediaObjectNumberLenType=(propertyFlags>>4)&3;
+   streamNumberLenType=(propertyFlags>>6)&3;
    
-   aprintf("paddingLen :         %d\n",paddingLen);
-   
-// Explicit (absolute) packet size	    
-   if(((flags>>5)&3))
-   {
-     //printf("## Explicit packet size %d\n",packetLen);
-     if(packetLen>pakSize) printf("**************Len > packet size!! (%d /%d)\n",packetLen,pakSize);
-   } 
+   // Send time
+   sendTime=1000*read32(); // Send time (ms)
+   aduration=read16(); // Duration (ms)
+   printf(":: Time 1 %s\n",ADM_us2plain(sendTime));
    if(!packetLen)
    {
      // Padding (relative) size
      packetLen=pakSize-_offset;
      packetLen=packetLen-paddingLen;
    }
-
-   
-  
-   atime=1000*read32(); // Send time (ms)
-   aduration=read16(); // Duration (ms)
-   
-   if(flags &1) // Multiseg
-   {
-     uint8_t r=read8();
-     nbSeg=r&0x3f;
-     segType=r>>6;
-   }
-   else
-   {
-     nbSeg=1; 
-   }
-#ifdef ASF_VERBOSE   
-   printf("-----------------------\n");
-   printf("Flags     :           0X%x",flags);
-   
-   if(flags & 0x40) printf(" Packet Len Specified  ");
-   if(flags & 0x10) printf(" Padding 16bits ");
-   if(flags & 0x8) printf(" Padding 8bits ");
-   if(flags & 0x1) printf(" Multiseg ");
-   printf("\n");
-   printf("SegmentId :           %d\n",segmentId);
-   printf("sequenceLen :         %d\n",sequenceLen);
-   
-   
-   printf("packetLen :           %d\n",packetLen);
-   printf("Send      :           %d\n",atime/1000);
-   printf("Duration  :           %d\n",aduration);
-   printf("# of seg  :           %d %x\n",nbSeg,segType);
-#endif
-   // Now read Segments....
-   //
-   uint32_t sequence, offset,replica,r;
+   int mediaObjectNumber, offset,replica,r;
    int32_t remaining;
    uint32_t payloadLen;
    uint32_t keyframe;
-   for(int seg=0;seg<nbSeg;seg++)
-   {
-     r=read8(); // Read stream Id
-     if(r&0x80) keyframe=AVI_KEY_FRAME;
-     else       keyframe=0;
-     streamId=r&0x7f;
-     //printf(">>>>>Stream Id : %x, duration %d ms, send time:%d ms <<<<<\n",streamId,aduration,atime);
-     if(r&0x80) 
-     {
-       aprintf("KeyFrame\n");
-     }
-     sequence=readVCL(segmentId>>4,0);
-     offset=readVCL(segmentId>>2,0);
-     replica=readVCL(segmentId,0);
-     aprintf("replica                %d\n",replica);
-     // Skip replica data_len
-     if(replica>=8) // Grab timestamp
-     {
-        uint32_t time1=read32();
-        
-        //printf("Time 1 : %"LU"\n",time1);
-         if(replica >= 8+38+4)
-         {
-            uint64_t time2;
-            uint32_t a,b;
-            skip(10);
-            a=read32();
-            b=read32();
-            time2=b;
-            time2=a+(time2<<32);
-            skip(8); 
-            skip(12);
-            skip(4);
-            skip(replica - 8 - 38 - 4);
-            printf("Time 2 : %"LLU"\n",time2);
-            }else
-            skip(replica-4);
-     }
-      else 
-        skip(replica);
-     
-     payloadLen=0;
-     if(flags &1)  // multi seg
-     {
-       payloadLen=readVCL(segType,0);
-       if(payloadLen)
-        aprintf("##len                    %d\n",payloadLen);
-       
-     }
-     remaining=pakSize-_offset;
-     remaining=remaining-paddingLen;
-     aprintf("Remaining %d asked %d\n",remaining,payloadLen);
-     if(remaining<=0) 
-     {
-       printf("** Err: No data left (%d)\n",remaining); 
-     }
-     if(!payloadLen)
-     {
-       payloadLen=remaining;
-     }
-     if(remaining<payloadLen)
-     {
-       printf("** WARNING too big %d %d\n", remaining,packetLen);
-       payloadLen=remaining;
-     }
-#ifdef ASF_VERBOSE     
-//    if(streamId==1)
+   // Multi payload
+   if(multiplePayloadPresent)
     {
-     printf("StreamId               %d\n",streamId);
-     printf("This segment %d bytes, %d /%d\n",packetLen,seg,nbSeg);
-     printf("Offset                 %d\n",offset);
-     printf("sequence               %d\n",sequence);
-     printf("Grouping               %d\n",replica==1);
-     printf("payloadLen             %d\n",payloadLen);
-    }
-#endif
-     // Frag
-     if(replica==1) // Grouping
-     {
-       // Each tiny packet starts with 
-       // 1 byte = packet Len
-       // Data and we read them until "payloadLen" is comsumed
-       while(payloadLen>0)
+        uint8_t r=read8();
+        nbSeg=r&0x3f;
+        payloadLengthType=r>>6;
+        printf("Multiple Payload :%d\n",(int)nbSeg);
+       // Now read Segments....
+       //
+       for(int seg=0;seg<nbSeg;seg++)
        {
-         uint8_t l=read8();
-         payloadLen--;
-         if(l>payloadLen)
+         r=read8(); // Read stream Id
+         if(r&0x80) 
          {
-           
-           printf("oops exceeding %d/%d\n",l,payloadLen);
-           if(streamId==streamWanted || streamWanted==0xff)
+            keyframe=AVI_KEY_FRAME;
+            aprintf("KeyFrame\n");
+         }
+         else       keyframe=0;
+         streamId=r&0x7f;
+         //printf(">>>>>Stream Id : %x, duration %d ms, send time:%d ms <<<<<\n",streamId,aduration,sendTime);
+         mediaObjectNumber=readVCL(mediaObjectNumberLenType,0); // Media object number
+         offset=readVCL(offsetLenType,0);
+         replica=readVCL(replicaLenType,0);
+         if(replica==1) ADM_error("Replica==1 : Compressed data!\n");
+         printf("replica                %d\n",replica);
+         skip(replica);
+         payloadLen=readVCL(payloadLengthType,0);
+         remaining=pakSize-_offset;
+         remaining=remaining-paddingLen;
+         if(remaining<=0) 
+         {
+           printf("** Err: No data left (%d)\n",remaining); 
+         }
+         if(!payloadLen)
+         {
+           payloadLen=remaining;
+         }
+         if(remaining<payloadLen)
+         {
+           printf("** WARNING too big %d %d\n", remaining,packetLen);
+           payloadLen=remaining;
+         }
+           // else we read "payloadLen" bytes and put them at offset "offset"
+           if(streamId==streamWanted|| streamWanted==0xff)
            {
-             pushPacket(keyframe,currentPacket,offset,sequence,payloadLen,streamId,atime);
-             atime=ADM_NO_PTS;
-             
+             pushPacket(keyframe,currentPacket,offset,mediaObjectNumber,payloadLen,streamId,sendTime);   
+             sendTime=ADM_NO_PTS;
            }else
-           {
             skip(payloadLen);
-           }
-           break;
+        }
+    }
+   else
+    {  // single payload
+         int r;
+         r=read8(); // Read stream Id
+         if(r&0x80) 
+         {
+            keyframe=AVI_KEY_FRAME;
+            aprintf("KeyFrame\n");
          }
-         skip(l);
-         payloadLen-=l;
-       }
-       
-     }else
-     { // else we read "payloadLen" bytes and put them at offset "offset"
-       if(streamId==streamWanted|| streamWanted==0xff)
-       {
-         pushPacket(keyframe,currentPacket,offset,sequence,payloadLen,streamId,atime);   
-         atime=ADM_NO_PTS;
-       }else
-        skip(payloadLen);
-       aprintf("Reading %d bytes\n",payloadLen);
-     }
-     
-   }
+         else       
+            keyframe=0;
+         streamId=r&0x7f;
+         //printf(">>>>>Stream Id : %x, duration %d ms, send time:%d ms <<<<<\n",streamId,aduration,sendTime);
+         mediaObjectNumber=readVCL(mediaObjectNumberLenType,0); // Media object number
+         offset=readVCL(offsetLenType,0);
+         replica=readVCL(replicaLenType,0);
+         printf("replica                %d\n",replica);
+         skip(replica);
+         remaining=pakSize-_offset;
+         remaining=remaining-paddingLen;
+         if(remaining<=0) 
+         {
+           printf("** Err: No data left (%d)\n",remaining); 
+         }
+         if(!payloadLen)
+         {
+           payloadLen=remaining;
+         }
+         if(remaining<payloadLen)
+         {
+           printf("** WARNING too big %d %d\n", remaining,packetLen);
+           payloadLen=remaining;
+         }
+           // else we read "payloadLen" bytes and put them at offset "offset"
+           if(streamId==streamWanted|| streamWanted==0xff)
+           {
+             pushPacket(keyframe,currentPacket,offset,mediaObjectNumber,payloadLen,streamId,sendTime);   
+             sendTime=ADM_NO_PTS;
+           }else
+            skip(payloadLen);
+    }
    // Do some sanity check
    if(_offset+paddingLen!=pakSize)
    {
@@ -319,8 +261,9 @@
    return 1;
   
  }
- /*
-    Push a packet down the queue
+ /**
+    \fn pushPacket
+    \brief     Push a packet down the queue
     The packet could be a complete one or a fragement
     To know that, either look at the offset field which will be != for fragements
     Or look if the sequence number is increasing
@@ -330,7 +273,8 @@
  uint8_t asfPacket::pushPacket(uint32_t keyframe,uint32_t packetnb,uint32_t offset,uint32_t sequence,uint32_t payloadLen,uint32_t stream,uint64_t dts)
  {
    asfBit *bit=new asfBit;
-   printf("Pushing packet stream=%d len=%d seq=%d dts=%d ms\n",stream,payloadLen,sequence,dts/1000);
+   printf("Pushing packet stream=%d len=%d offset=%d seq=%d packet=%d dts=%s \n",
+                stream,payloadLen,offset,sequence,packetnb,ADM_us2plain(dts));
    bit->sequence=sequence;
    bit->offset=offset;
    bit->len=payloadLen;
@@ -363,7 +307,9 @@
    }
    return r;
  }
-
+/**
+   \fn skipPacket
+*/
  uint8_t   asfPacket::skipPacket(void)
  {
    uint32_t go;



From mean at mail.berlios.de  Fri Oct 28 08:28:55 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:28:55 +0200
Subject: [Avidemux-svn-commit] r7620 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028062855.D5D76481404@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:28:55 +0200 (Fri, 28 Oct 2011)
New Revision: 7620

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
Log:
[asf] Take timing info from replica

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:28:54 UTC (rev 7619)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:28:55 UTC (rev 7620)
@@ -168,6 +168,7 @@
        for(int seg=0;seg<nbSeg;seg++)
        {
          r=read8(); // Read stream Id
+         uint64_t pts=ADM_NO_PTS;
          if(r&0x80) 
          {
             keyframe=AVI_KEY_FRAME;
@@ -180,8 +181,14 @@
          offset=readVCL(offsetLenType,0);
          replica=readVCL(replicaLenType,0);
          if(replica==1) ADM_error("Replica==1 : Compressed data!\n");
-         printf("replica                %d\n",replica);
-         skip(replica);
+         if(replica>=8)
+         {
+            read32(); // size
+            pts=read32()*1000; // PTS
+            skip(replica-8);
+         }
+         else
+            skip(replica);
          payloadLen=readVCL(payloadLengthType,0);
          remaining=pakSize-_offset;
          remaining=remaining-paddingLen;
@@ -201,8 +208,7 @@
            // else we read "payloadLen" bytes and put them at offset "offset"
            if(streamId==streamWanted|| streamWanted==0xff)
            {
-             pushPacket(keyframe,currentPacket,offset,mediaObjectNumber,payloadLen,streamId,sendTime);   
-             sendTime=ADM_NO_PTS;
+             pushPacket(keyframe,currentPacket,offset,mediaObjectNumber,payloadLen,streamId,pts);   
            }else
             skip(payloadLen);
         }
@@ -224,7 +230,14 @@
          offset=readVCL(offsetLenType,0);
          replica=readVCL(replicaLenType,0);
          printf("replica                %d\n",replica);
-         skip(replica);
+         if(replica>8)
+         {
+            printf("replica size:1=%d\n",read32());
+            printf("replica pts :2=%d\n",read32());
+            skip(replica-8);
+         }
+            else
+                skip(replica);
          remaining=pakSize-_offset;
          remaining=remaining-paddingLen;
          if(remaining<=0) 
@@ -270,7 +283,8 @@
  
  */
 
- uint8_t asfPacket::pushPacket(uint32_t keyframe,uint32_t packetnb,uint32_t offset,uint32_t sequence,uint32_t payloadLen,uint32_t stream,uint64_t dts)
+ uint8_t asfPacket::pushPacket(uint32_t keyframe,uint32_t packetnb,
+                uint32_t offset,uint32_t sequence,uint32_t payloadLen,uint32_t stream,uint64_t dts)
  {
    asfBit *bit=new asfBit;
    printf("Pushing packet stream=%d len=%d offset=%d seq=%d packet=%d dts=%s \n",
@@ -283,7 +297,6 @@
    bit->packet=packetnb;
    bit->flags=keyframe;
    bit->dts=dts;
-
    if(!read(bit->data,bit->len))
    {
 		delete[] bit->data;



From mean at mail.berlios.de  Fri Oct 28 08:28:57 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:28:57 +0200
Subject: [Avidemux-svn-commit] r7621 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028062857.1A44D481404@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:28:56 +0200 (Fri, 28 Oct 2011)
New Revision: 7621

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
Log:
[asf] DTS ok for video, audio ko, pts ko

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:28:55 UTC (rev 7620)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:28:56 UTC (rev 7621)
@@ -423,7 +423,7 @@
       uint64_t dts=bit->dts;
       if(bit->stream==_videoStreamId)
       {
-          printf(">found packet of size=%d off=%d seq %d, while curseq =%d, dts=%s\n",
+          aprintf(">found packet of size=%d off=%d seq %d, while curseq =%d, dts=%s\n",
                         bit->len,bit->offset,  bit->sequence,curSeq,
                         ADM_us2plain(dts));
           if(bit->sequence!=sequence || first==true)
@@ -437,7 +437,7 @@
             aprintf("New sequence\n");
             if( ((sequence+1)&0xff)!=(bit->sequence&0xff))
             {
-                printf("!!!!!!!!!!!! non continuous sequence %u %u\n",sequence,bit->sequence); 
+                ADM_warning("!!!!!!!!!!!! non continuous sequence %u %u\n",sequence,bit->sequence); 
             }
             
             

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:28:55 UTC (rev 7620)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:28:56 UTC (rev 7621)
@@ -145,7 +145,7 @@
    // Send time
    sendTime=1000*read32(); // Send time (ms)
    aduration=read16(); // Duration (ms)
-   printf(":: Time 1 %s\n",ADM_us2plain(sendTime));
+   aprintf(":: Time 1 %s\n",ADM_us2plain(sendTime));
    if(!packetLen)
    {
      // Padding (relative) size
@@ -162,7 +162,7 @@
         uint8_t r=read8();
         nbSeg=r&0x3f;
         payloadLengthType=r>>6;
-        printf("Multiple Payload :%d\n",(int)nbSeg);
+        aprintf("Multiple Payload :%d\n",(int)nbSeg);
        // Now read Segments....
        //
        for(int seg=0;seg<nbSeg;seg++)
@@ -194,7 +194,7 @@
          remaining=remaining-paddingLen;
          if(remaining<=0) 
          {
-           printf("** Err: No data left (%d)\n",remaining); 
+           ADM_warning("** Err: No data left (%d)\n",remaining); 
          }
          if(!payloadLen)
          {
@@ -202,7 +202,7 @@
          }
          if(remaining<payloadLen)
          {
-           printf("** WARNING too big %d %d\n", remaining,packetLen);
+           ADM_warning("** WARNING too big %d %d\n", remaining,packetLen);
            payloadLen=remaining;
          }
            // else we read "payloadLen" bytes and put them at offset "offset"
@@ -229,11 +229,14 @@
          mediaObjectNumber=readVCL(mediaObjectNumberLenType,0); // Media object number
          offset=readVCL(offsetLenType,0);
          replica=readVCL(replicaLenType,0);
-         printf("replica                %d\n",replica);
+         aprintf("replica                %d\n",replica);
          if(replica>8)
          {
-            printf("replica size:1=%d\n",read32());
-            printf("replica pts :2=%d\n",read32());
+            int ssize=read32();
+            int stime=read32();
+            aprintf("replica size:1=%d\n",ssize);
+            aprintf("replica pts :2=%d\n",stime);
+            sendTime=stime; // in fact PTS
             skip(replica-8);
          }
             else
@@ -242,7 +245,7 @@
          remaining=remaining-paddingLen;
          if(remaining<=0) 
          {
-           printf("** Err: No data left (%d)\n",remaining); 
+           ADM_warning("** Err: No data left (%d)\n",remaining); 
          }
          if(!payloadLen)
          {
@@ -250,7 +253,7 @@
          }
          if(remaining<payloadLen)
          {
-           printf("** WARNING too big %d %d\n", remaining,packetLen);
+           ADM_warning("** WARNING too big %d %d\n", remaining,packetLen);
            payloadLen=remaining;
          }
            // else we read "payloadLen" bytes and put them at offset "offset"
@@ -277,7 +280,7 @@
  /**
     \fn pushPacket
     \brief     Push a packet down the queue
-    The packet could be a complete one or a fragement
+    The packet could be a complete one or a fragment
     To know that, either look at the offset field which will be != for fragements
     Or look if the sequence number is increasing
  
@@ -287,7 +290,7 @@
                 uint32_t offset,uint32_t sequence,uint32_t payloadLen,uint32_t stream,uint64_t dts)
  {
    asfBit *bit=new asfBit;
-   printf("Pushing packet stream=%d len=%d offset=%d seq=%d packet=%d dts=%s \n",
+   aprintf("Pushing packet stream=%d len=%d offset=%d seq=%d packet=%d dts=%s \n",
                 stream,payloadLen,offset,sequence,packetnb,ADM_us2plain(dts));
    bit->sequence=sequence;
    bit->offset=offset;
@@ -338,7 +341,7 @@
  
    if(1!=fread(where,how,1,_fd))
    {
-     printf("[AsfPacket] Read error\n");
+     ADM_warning("[AsfPacket] Read error\n");
      return 0; 
    }
    _offset+=how;



From mean at mail.berlios.de  Fri Oct 28 08:28:58 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:28:58 +0200
Subject: [Avidemux-svn-commit] r7622 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028062858.77A0B481404@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:28:58 +0200 (Fri, 28 Oct 2011)
New Revision: 7622

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h
Log:
[ASF] Partial handling of PTS/DTS, incomplete

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:28:56 UTC (rev 7621)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:28:58 UTC (rev 7622)
@@ -217,7 +217,7 @@
 uint64_t                   asfHeader::getTime(uint32_t frameNum)
 {
      if(frameNum>=nbImage) return 0;
-     return _index[frameNum].dts; // ??PTS??
+     return _index[frameNum].pts; // ??PTS??
 }
 /**
     \fn getTime
@@ -355,7 +355,7 @@
   img->demuxerPts=_index[framenum].pts;
   if(len!=_index[framenum].frameLen)
   {
-    printf("[ASF] Frame=%u :-> Mismatch found len : %u expected %u\n",framenum,len, _index[framenum].frameLen);
+    ADM_error("[ASF] Frame=%u :-> Mismatch found len : %u expected %u\n",framenum,len, _index[framenum].frameLen);
   }
   aprintf(">>Len %d seq %d\n",len,curSeq);
   return 1; 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp	2011-10-28 06:28:56 UTC (rev 7621)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp	2011-10-28 06:28:58 UTC (rev 7622)
@@ -147,7 +147,7 @@
       // still same sequence ...add
       memcpy(dest,bit->data,bit->len);
       *len=bit->len;
-      *dts=ADM_NO_PTS;
+      *dts=bit->dts;
       delete[] bit->data;
       delete bit;
       return 1;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:28:56 UTC (rev 7621)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:28:58 UTC (rev 7622)
@@ -421,6 +421,7 @@
       ADM_assert(readQueue.pop((void**)&bit));
       // --
       uint64_t dts=bit->dts;
+      uint64_t pts=bit->pts;
       if(bit->stream==_videoStreamId)
       {
           aprintf(">found packet of size=%d off=%d seq %d, while curseq =%d, dts=%s\n",
@@ -446,7 +447,7 @@
             indexEntry.packetNb=bit->packet;
             indexEntry.flags=bit->flags;
             indexEntry.dts=dts;
-            indexEntry.pts=ADM_NO_PTS;
+            indexEntry.pts=pts;
 
             for(int z=0;z<_nbAudioTrack;z++)
             {
@@ -468,10 +469,8 @@
         {
           if(bit->stream == _allAudioTracks[i].streamIndex)
           {
-            
             _allAudioTracks[i].length+=bit->len;
             _allAudioTracks[i].lastDts=bit->dts;
-            
             found=1;
           }
         }

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:28:56 UTC (rev 7621)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:28:58 UTC (rev 7622)
@@ -93,7 +93,7 @@
  */
 uint8_t   asfPacket::nextPacket(uint8_t streamWanted)
 {
-   uint64_t sendTime;
+   uint64_t dts;
    uint32_t aduration,nbSeg,payloadLengthType=0x80;
    uint32_t sequenceLen,len,streamId;
    int32_t   packetLen=0;
@@ -143,9 +143,9 @@
    streamNumberLenType=(propertyFlags>>6)&3;
    
    // Send time
-   sendTime=1000*read32(); // Send time (ms)
+   dts=1000*read32(); // Send time (ms)
    aduration=read16(); // Duration (ms)
-   aprintf(":: Time 1 %s\n",ADM_us2plain(sendTime));
+   aprintf(":: Time 1 %s\n",ADM_us2plain(dts));
    if(!packetLen)
    {
      // Padding (relative) size
@@ -172,11 +172,11 @@
          if(r&0x80) 
          {
             keyframe=AVI_KEY_FRAME;
-            aprintf("KeyFrame\n");
+            aprintf(">>>KeyFrame\n");
          }
          else       keyframe=0;
          streamId=r&0x7f;
-         //printf(">>>>>Stream Id : %x, duration %d ms, send time:%d ms <<<<<\n",streamId,aduration,sendTime);
+         //printf(">>>>>Stream Id : %x, duration %d ms, send time:%d ms <<<<<\n",streamId,aduration,dts);
          mediaObjectNumber=readVCL(mediaObjectNumberLenType,0); // Media object number
          offset=readVCL(offsetLenType,0);
          replica=readVCL(replicaLenType,0);
@@ -208,7 +208,8 @@
            // else we read "payloadLen" bytes and put them at offset "offset"
            if(streamId==streamWanted|| streamWanted==0xff)
            {
-             pushPacket(keyframe,currentPacket,offset,mediaObjectNumber,payloadLen,streamId,pts);   
+             pushPacket(keyframe,currentPacket,offset,mediaObjectNumber,payloadLen,streamId,dts,pts);   
+             dts=ADM_NO_PTS;
            }else
             skip(payloadLen);
         }
@@ -216,16 +217,17 @@
    else
     {  // single payload
          int r;
+         uint64_t pts=ADM_NO_PTS;
          r=read8(); // Read stream Id
          if(r&0x80) 
          {
             keyframe=AVI_KEY_FRAME;
-            aprintf("KeyFrame\n");
+            aprintf(">>>KeyFrame\n");
          }
          else       
             keyframe=0;
          streamId=r&0x7f;
-         //printf(">>>>>Stream Id : %x, duration %d ms, send time:%d ms <<<<<\n",streamId,aduration,sendTime);
+         //printf(">>>>>Stream Id : %x, duration %d ms, send time:%d ms <<<<<\n",streamId,aduration,dts);
          mediaObjectNumber=readVCL(mediaObjectNumberLenType,0); // Media object number
          offset=readVCL(offsetLenType,0);
          replica=readVCL(replicaLenType,0);
@@ -236,7 +238,7 @@
             int stime=read32();
             aprintf("replica size:1=%d\n",ssize);
             aprintf("replica pts :2=%d\n",stime);
-            sendTime=stime; // in fact PTS
+            pts=stime; // in fact PTS
             skip(replica-8);
          }
             else
@@ -259,8 +261,8 @@
            // else we read "payloadLen" bytes and put them at offset "offset"
            if(streamId==streamWanted|| streamWanted==0xff)
            {
-             pushPacket(keyframe,currentPacket,offset,mediaObjectNumber,payloadLen,streamId,sendTime);   
-             sendTime=ADM_NO_PTS;
+             pushPacket(keyframe,currentPacket,offset,mediaObjectNumber,payloadLen,streamId,dts,pts);   
+             dts=ADM_NO_PTS;
            }else
             skip(payloadLen);
     }
@@ -287,7 +289,8 @@
  */
 
  uint8_t asfPacket::pushPacket(uint32_t keyframe,uint32_t packetnb,
-                uint32_t offset,uint32_t sequence,uint32_t payloadLen,uint32_t stream,uint64_t dts)
+                uint32_t offset,uint32_t sequence,uint32_t payloadLen,uint32_t stream,
+                uint64_t dts,uint64_t pts)
  {
    asfBit *bit=new asfBit;
    aprintf("Pushing packet stream=%d len=%d offset=%d seq=%d packet=%d dts=%s \n",
@@ -300,6 +303,7 @@
    bit->packet=packetnb;
    bit->flags=keyframe;
    bit->dts=dts;
+   bit->pts=pts;
    if(!read(bit->data,bit->len))
    {
 		delete[] bit->data;
@@ -310,7 +314,10 @@
    queue->push((void *)bit);
    return 1;
  }
- 
+ /**
+    \fn readVCL
+    \brief read variable lenth code, def is the default value
+*/
  uint32_t asfPacket::readVCL(uint32_t bitwise,uint32_t def)
  {
    uint32_t r;
@@ -336,6 +343,10 @@
   
    return 1; 
  }
+/**
+    \fn read
+    \brief read N bytes
+*/
  uint8_t   asfPacket::read(uint8_t *where, uint32_t how)
  {
  
@@ -348,9 +359,11 @@
    ADM_assert(_offset<=pakSize);
 
    return 1;
-
-  
  }
+/**
+     \fn skip
+    \brief skip N bytes
+*/
  uint8_t   asfPacket::skip( uint32_t how)
  {
    fseeko(_fd,how,SEEK_CUR);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h	2011-10-28 06:28:56 UTC (rev 7621)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h	2011-10-28 06:28:58 UTC (rev 7622)
@@ -30,6 +30,7 @@
   uint32_t packet;
   uint32_t flags;
   uint64_t dts; // in us
+  uint64_t pts; // in us
   uint8_t  *data;
   
 }asfBit;
@@ -42,7 +43,7 @@
     uint32_t        readVCL(uint32_t bitwise,uint32_t defaultValue);
     uint8_t         pushPacket(uint32_t flags,uint32_t packetnb,
                                 uint32_t offset,uint32_t sequence,uint32_t payloadLen,uint32_t stream,
-                                uint64_t dtsus);
+                                uint64_t dtsus,uint64_t ptsus);
     uint8_t         skip( uint32_t how);
     FILE            *_fd;
     uint32_t        packetStart;



From mean at mail.berlios.de  Fri Oct 28 08:28:59 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:28:59 +0200
Subject: [Avidemux-svn-commit] r7623 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028062859.C660C481404@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:28:59 +0200 (Fri, 28 Oct 2011)
New Revision: 7623

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
Log:
[ASF/Demux] Bettet audio timing support, correct duration

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:28:58 UTC (rev 7622)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:28:59 UTC (rev 7623)
@@ -225,7 +225,7 @@
 
 uint64_t                   asfHeader::getVideoDuration(void)
 {
-    return _index[nbImage-1].dts;
+    return _duration;
 }
 /**
     \fn getTime

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-28 06:28:58 UTC (rev 7622)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-28 06:28:59 UTC (rev 7623)
@@ -23,7 +23,13 @@
 #include "BVector.h"
 #define ASF_MAX_AUDIO_TRACK 8
 
+typedef struct
+{
+    uint64_t pts;
+    uint64_t packetNb;
+}asfAudioSeekPoint;
 
+typedef BVector <asfAudioSeekPoint> listOfAudioSeekPoint;
 
 typedef struct 
 {
@@ -33,8 +39,6 @@
   uint32_t flags;
   uint64_t dts;
   uint64_t pts;
-  uint32_t audioSeen[ASF_MAX_AUDIO_TRACK];
-  uint64_t audioDts[ASF_MAX_AUDIO_TRACK];
 }asfIndex;
 
 typedef  BVector <asfIndex> AsfVectorIndex;
@@ -122,12 +126,13 @@
     uint32_t                _packetSize;
     class asfHeader         *_father;
     asfAudioTrak            *_track;
+    listOfAudioSeekPoint    *_seekPoints;
   public:
                                 asfAudioAccess(asfHeader *father,uint32_t rank);
     virtual                     ~asfAudioAccess();
 
     virtual bool      canSeekTime(void) {return true;};
-    virtual bool      canSeekOffset(void) {return true;};
+    virtual bool      canSeekOffset(void) {return false;};
     virtual bool      canGetDuration(void) {return true;};
     
     virtual uint32_t  getLength(void) {return _track->length;}
@@ -174,12 +179,12 @@
     
   public: // Shared with audio track
     char                    *myName;
-    
     uint32_t                nbImage;
     AsfVectorIndex          _index;
     uint32_t                _packetSize;
     uint32_t                _dataStartOffset;
     uint32_t                _nbAudioTrack;
+    listOfAudioSeekPoint    audioSeekPoints[ASF_MAX_AUDIO_TRACK];
     asfAudioAccess          *_audioAccess[ASF_MAX_AUDIO_TRACK];
     asfAudioTrak             _allAudioTracks[ASF_MAX_AUDIO_TRACK];
     ADM_audioStream         *_audioStreams[ASF_MAX_AUDIO_TRACK];

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp	2011-10-28 06:28:58 UTC (rev 7622)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp	2011-10-28 06:28:59 UTC (rev 7623)
@@ -23,6 +23,7 @@
 */
 uint64_t  asfAudioAccess::getDurationInUs(void)
 {
+    // could use that : father->getVideoDuration()...
     return 0;
 }
 /**
@@ -63,10 +64,12 @@
     _packetSize=_father->_packetSize;
     _packet=new asfPacket(_fd,_father->_nbPackets,_packetSize,
                           &readQueue,_dataStart);
-    
+    _seekPoints=&(_father->audioSeekPoints[myRank]);
     printf("[asfAudio] Length %u\n",getLength());
 }
-
+/**
+    \fn getPos
+*/
 uint64_t  asfAudioAccess::getPos(void)
 {
     return 0;
@@ -78,49 +81,27 @@
 
 bool   asfAudioAccess::setPos(uint64_t newoffset)
 {
-  // Look into the index until we find the audio
-  // just after the wanted value
-  for(int i=0;i<_father->nbImage;i++)
-  {
-    if(!_father->_index[i].audioSeen[_myRank]) continue;
-    if(_father->_index[i].audioSeen[_myRank]>=newoffset)
-    {
-      // Flush queue
-      _packet->purge();
-      // Seek
-      if(!_packet->goToPacket(_father->_index[i].packetNb))
-      {
-        printf("[asfAudio] Cannot seek to frame %u\n",i);
-        return 0; 
-      }
-      printf("[asfAudio]For audio %"LLU", seeking to packet %"LU"\n",newoffset,_father->_index[i].packetNb);
-      _packet->nextPacket(_streamId);
-      _packet->skipPacket();
-      return 1;
-    }
-  }
-  printf("[asfAudio] Seek failed for offset=%"LLU"\n",newoffset);
-  return 1; 
+  return false; 
 }
 
 /**
     \fn goToTime
 */
 
-bool   asfAudioAccess::goToTime(uint64_t dts_us)
+bool   asfAudioAccess::goToTime(uint64_t dts_us) // PTS!
 {
-    AsfVectorIndex     *idx=&(_father->_index);
     // Search
-    int size=idx->size();
-    if(dts_us<=(*idx)[0].audioDts[_myRank])
+    int size=_seekPoints->size();
+    if(dts_us<=(*_seekPoints)[0].pts || size<2)
     {
           return setPos( 0);
     }
-    for(int i=0;i<size-1;i++)
+
+    for(int i=size-2;i>=0;i--)
     {
-        if(dts_us>=(*idx)[i].audioDts[_myRank] && dts_us<(*idx)[i+1].audioDts[_myRank])
+        if(dts_us>=(*_seekPoints)[i].pts && dts_us<(*_seekPoints)[i+1].pts)
         {
-            return _packet->goToPacket( (*idx)[i].packetNb);
+            return _packet->goToPacket( (*_seekPoints)[i].packetNb);
         }
     }
     return false;
@@ -147,7 +128,7 @@
       // still same sequence ...add
       memcpy(dest,bit->data,bit->len);
       *len=bit->len;
-      *dts=bit->dts;
+      *dts=bit->pts; // for audio PTS=DTS...
       delete[] bit->data;
       delete bit;
       return 1;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:28:58 UTC (rev 7622)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:28:59 UTC (rev 7623)
@@ -201,18 +201,20 @@
 
       case ADM_CHUNK_FILE_HEADER_CHUNK:
         {
+            uint64_t playDuration,sendDuration;
             // Client GID
             printf("Client        :");
             for(int z=0;z<16;z++) printf(":%02x",s->read8());
             printf("\n");
-            printf("File size     : %08"LLX"\n",s->read64());
-            printf("Creation time : %08"LLX"\n",s->read64());
-            printf("Number of pack: %08"LLX"\n",s->read64());
-            printf("Timestamp 1   : %08"LLX"\n",s->read64());
-            _duration=s->read64();
-            printf("Timestamp 2   : %08"LLX"\n",_duration);
-            printf("Timestamp 3   : %04"LX"\n",s->read32());
-            printf("Preload       : %04"LX"\n",s->read32());
+            printf("File size     : %08"LLU"\n",s->read64());
+            printf("Creation time : %08"LLU"\n",s->read64());
+            printf("Number of pack: %08"LLU"\n",s->read64());
+            playDuration=s->read64()/10LL;
+            sendDuration=s->read64()/10LL;
+            _duration=playDuration;
+            printf("Play duration : %s\n",ADM_us2plain(playDuration));
+            printf("Send duration : %s\n",ADM_us2plain(sendDuration));
+            printf("Preroll   3   : %s\n",ADM_us2plain(s->read64()/10LL));
             printf("Flags         : %04"LX"\n",s->read32());
             mx=s->read32();
             mn=s->read32();
@@ -409,6 +411,14 @@
   bool first=true;
   DIA_workingBase *progressBar=createWorking("Indexing");
   uint32_t fileSizeMB=(uint32_t)(fSize>>10);
+
+  uint64_t lastDts[ASF_MAX_AUDIO_TRACK];
+  for(int i=0;i<ASF_MAX_AUDIO_TRACK;i++)
+  {
+        lastDts[i]=0;
+  }
+
+
   while(packet<_nbPackets)
   {
     while(!readQueue.isEmpty())
@@ -449,11 +459,6 @@
             indexEntry.dts=dts;
             indexEntry.pts=pts;
 
-            for(int z=0;z<_nbAudioTrack;z++)
-            {
-              indexEntry.audioSeen[z]=_allAudioTracks[z].length;
-              indexEntry.audioDts[z]=_allAudioTracks[z].lastDts;
-            }
             readQueue.pushBack(bit);
     
             sequence=bit->sequence;
@@ -469,8 +474,19 @@
         {
           if(bit->stream == _allAudioTracks[i].streamIndex)
           {
-            _allAudioTracks[i].length+=bit->len;
-            _allAudioTracks[i].lastDts=bit->dts;
+            if(bit->pts!=ADM_NO_PTS)
+            {
+                if(!lastDts[i] || (bit->pts>lastDts[i]+500000L)) // seek point every 500 ms
+                {
+                    asfAudioSeekPoint seek;
+                        seek.pts=bit->pts;
+                        seek.packetNb=bit->packet;
+                        (audioSeekPoints[i]).append(seek);
+                        lastDts[i]=bit->pts;
+                        printf("Adding seek point for track %d at %s (packet=%d)\n",
+                            i,ADM_us2plain(bit->pts),(int)seek.packetNb);
+                }
+            }
             found=1;
           }
         }



From mean at mail.berlios.de  Fri Oct 28 08:29:01 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:29:01 +0200
Subject: [Avidemux-svn-commit] r7624 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028062901.10A6B481404@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:29:00 +0200 (Fri, 28 Oct 2011)
New Revision: 7624

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h
Log:
[asf] Remplace alloc/free for each packet by  storing already made packet into a storage queue

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:28:59 UTC (rev 7623)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:29:00 UTC (rev 7624)
@@ -23,7 +23,7 @@
 #include "ADM_asf.h"
 #include "ADM_asfPacket.h"
 
-#if 0
+#if 1
 #define aprintf printf
 #else
 #define aprintf(...) {}
@@ -165,7 +165,7 @@
                 (int)_allAudioTracks[i].streamIndex,(int)_allAudioTracks[i].streamIndex);
   buildIndex();
   fseeko(_fd,_dataStartOffset,SEEK_SET);
-  _packet=new asfPacket(_fd,_nbPackets,_packetSize,&readQueue,_dataStartOffset);
+  _packet=new asfPacket(_fd,_nbPackets,_packetSize,&readQueue,&storageQueue,_dataStartOffset);
   curSeq=1;
   for(int i=0;i<_nbAudioTrack;i++)
   {
@@ -291,10 +291,11 @@
   uint32_t delta;
   while(1)
   {
-    while(!readQueue.isEmpty())
+    while(readQueue.size())
     {
       asfBit *bit;
-      ADM_assert(readQueue.pop((void**)&bit));
+      bit=readQueue.front();
+      readQueue.pop_front();
       aprintf(">found packet of size %d seq %d, while curseq =%d wanted seg=%u current offset=%u\n",bit->len,bit->sequence,curSeq,_index[framenum].segNb,len);
       // Here it is tricky
       // if len==0 we are reading the first part of our frame
@@ -309,8 +310,8 @@
           {
             aprintf("Dropping seq=%u too old for %u delta %d\n",
                   bit->sequence,_index[framenum].segNb,delta);
-            delete[] bit->data;
-            delete bit;
+            storageQueue.push_back(bit);
+            bit=NULL;
             if(delta<230)
             {
               printf("[ASF] Very suspicious delta :%"LU"\n",delta);
@@ -331,15 +332,15 @@
       {
         aprintf("New sequence %u->%u while loading %u frame\n",curSeq,bit->sequence,framenum);
         img->dataLength=len;
-        readQueue.pushBack(bit); // don't delete it, we will use it later...
+        readQueue.push_front(bit);
         curSeq=bit->sequence;
         goto gotcha;
       }
       // still same sequence ...add
       memcpy(img->data+len,bit->data,bit->len);
       len+=bit->len;
-	  delete[] bit->data;
-      delete bit;
+      storageQueue.push_back(bit);
+      bit=NULL;
     }
     if(!_packet->nextPacket(_videoStreamId))
     {

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-28 06:28:59 UTC (rev 7623)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-28 06:29:00 UTC (rev 7624)
@@ -21,6 +21,7 @@
 #include "ADM_queue.h"
 #include "ADM_asfPacket.h"
 #include "BVector.h"
+#include <vector>
 #define ASF_MAX_AUDIO_TRACK 8
 
 typedef struct
@@ -122,7 +123,8 @@
     uint32_t                _dataStart;
     asfPacket               *_packet;
     FILE                    *_fd;
-    ADM_queue               readQueue;
+    queueOfAsfBits          readQueue;
+    queueOfAsfBits          storageQueue;
     uint32_t                _packetSize;
     class asfHeader         *_father;
     asfAudioTrak            *_track;
@@ -162,7 +164,9 @@
     bool                    loadAudio(asfChunk *s,uint32_t sid);
     bool                    decodeExtHeader(asfChunk *s);
     bool                    decodeStreamHeader(asfChunk *s);
-    ADM_queue               readQueue;
+    queueOfAsfBits          readQueue;
+    queueOfAsfBits          storageQueue;
+               
     uint32_t                curSeq;
     asfPacket               *_packet;
     //uint32_t                _currentAudioStream;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp	2011-10-28 06:28:59 UTC (rev 7623)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp	2011-10-28 06:29:00 UTC (rev 7624)
@@ -63,7 +63,7 @@
     fseeko(_fd,_dataStart,SEEK_SET);
     _packetSize=_father->_packetSize;
     _packet=new asfPacket(_fd,_father->_nbPackets,_packetSize,
-                          &readQueue,_dataStart);
+                          &readQueue,&storageQueue,_dataStart);
     _seekPoints=&(_father->audioSeekPoints[myRank]);
     printf("[asfAudio] Length %u\n",getLength());
 }
@@ -119,18 +119,17 @@
   while(1)
   {
    
-    while(!readQueue.isEmpty())
+    while(readQueue.size())
     {
       asfBit *bit;
-      ADM_assert(readQueue.pop((void**)&bit));
-      //printf("[Asf] Audio found packet of size %d seq %d\n",bit->len,bit->sequence);
-      
+      bit=readQueue.front();
+      readQueue.pop_front();
       // still same sequence ...add
       memcpy(dest,bit->data,bit->len);
       *len=bit->len;
       *dts=bit->pts; // for audio PTS=DTS...
-      delete[] bit->data;
-      delete bit;
+      storageQueue.push_back(bit);
+      bit=NULL;
       return 1;
     }
     r=_packet->nextPacket(_streamId);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:28:59 UTC (rev 7623)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:29:00 UTC (rev 7624)
@@ -397,7 +397,7 @@
   
   // Here we go
   asfPacket *aPacket=new asfPacket(_fd,_nbPackets,_packetSize,
-                                   &readQueue,_dataStartOffset);
+                                   &readQueue,&storageQueue,_dataStartOffset);
   uint32_t packet=1;
 #define MAXIMAGE (_nbPackets)
   uint32_t sequence=1;
@@ -421,14 +421,17 @@
 
   while(packet<_nbPackets)
   {
-    while(!readQueue.isEmpty())
+    while(readQueue.size())
     {
       asfBit *bit=NULL;
 
       // update UI
       uint32_t curPos=(uint32_t)(ftello(_fd)>>10);
       progressBar->update(curPos,fileSizeMB);
-      ADM_assert(readQueue.pop((void**)&bit));
+
+      bit=readQueue.front();
+      readQueue.pop_front();
+
       // --
       uint64_t dts=bit->dts;
       uint64_t pts=bit->pts;
@@ -459,7 +462,7 @@
             indexEntry.dts=dts;
             indexEntry.pts=pts;
 
-            readQueue.pushBack(bit);
+            readQueue.push_front(bit); // reuse it next time
     
             sequence=bit->sequence;
             len=0;
@@ -495,8 +498,7 @@
           printf("Unmapped stream %u\n",bit->stream); 
         }
       }
-     delete[] bit->data;
-     delete bit;
+      storageQueue.push_back(bit);
     }
     //working->update(packet,_nbPackets);
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:28:59 UTC (rev 7623)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:29:00 UTC (rev 7624)
@@ -37,7 +37,7 @@
 /**
     \fn asfPacket ctor
 */ 
-asfPacket::asfPacket(FILE *f,uint32_t nb,uint32_t pSize,ADM_queue *q,uint32_t startDataOffset)
+asfPacket::asfPacket(FILE *f,uint32_t nb,uint32_t pSize,queueOfAsfBits *q,queueOfAsfBits *s,uint32_t startDataOffset)
  {
    _fd=f;
    pakSize=pSize;
@@ -46,6 +46,7 @@
    aprintf("Packet created at %x\n",packetStart);
    ADM_assert(_fd);
    queue=q;
+   storage=s;
    ADM_assert(q);
    currentPacket=0;
    _nbPackets=nb;
@@ -56,7 +57,7 @@
 */
  asfPacket::~asfPacket()
  {
-	 purge();
+	 
  }
  /**
     \fn goToPacket
@@ -292,7 +293,19 @@
                 uint32_t offset,uint32_t sequence,uint32_t payloadLen,uint32_t stream,
                 uint64_t dts,uint64_t pts)
  {
-   asfBit *bit=new asfBit;
+
+    // Get a packet...
+    asfBit *bit;
+
+    if(storage->empty())
+    {
+        bit=new asfBit();
+    }else
+    {
+        bit=storage->front();
+        storage->pop_front();
+    }
+
    aprintf("Pushing packet stream=%d len=%d offset=%d seq=%d packet=%d dts=%s \n",
                 stream,payloadLen,offset,sequence,packetnb,ADM_us2plain(dts));
    bit->sequence=sequence;
@@ -306,12 +319,12 @@
    bit->pts=pts;
    if(!read(bit->data,bit->len))
    {
-		delete[] bit->data;
-		delete bit;
+        storage->push_back(bit);
+        bit=NULL;
 		return 0; 
    }
 
-   queue->push((void *)bit);
+   queue->push_back(bit);
    return 1;
  }
  /**
@@ -379,19 +392,23 @@
    return 1;
   
  }
- //****************************
+ /**
+    \fn purge
+    \brief empty queue to storage
+*/
  uint8_t asfPacket::purge(void)
  {
     // Flush queue
-   while(!queue->isEmpty())
+   while(!queue->size())
    {
      asfBit *bit;
-     ADM_assert(queue->pop((void**)&bit));
-     delete[] bit->data;
-     delete bit;
+     bit=queue->front();
+     queue->pop_front();
+     storage->push_back(bit);
    }
    return 1; 
  }
+#if 0
  //****************************
  uint8_t   asfPacket::packTo(uint8_t *buffer,uint32_t *len)
  {
@@ -407,8 +424,8 @@
    }
    return 1;
  }
+#endif 
  
- 
 #ifndef ASF_INLINE
 #include "ADM_asfIo.h"
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h	2011-10-28 06:28:59 UTC (rev 7623)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h	2011-10-28 06:29:00 UTC (rev 7624)
@@ -18,6 +18,7 @@
 #define ASF_PACKET_H
 
 #include "ADM_queue.h"
+#include <list>
 /**
     \struct asfBit
 */
@@ -34,6 +35,9 @@
   uint8_t  *data;
   
 }asfBit;
+
+typedef std::list <asfBit *>  queueOfAsfBits;
+
 /**
     \class asfPacket
 */
@@ -49,14 +53,15 @@
     uint32_t        packetStart;
     uint8_t         segmentId;
     uint32_t        pakSize;
-    ADM_queue       *queue;
+    queueOfAsfBits  *queue;
+    queueOfAsfBits  *storage;
     uint32_t        _offset;
     uint32_t        currentPacket;
     uint32_t        _startDataOffset;
     uint32_t        _nbPackets;
   public:
     
-    asfPacket(FILE *f,uint32_t nbElem,uint32_t pSize,ADM_queue *q,uint32_t startDataOffset);
+    asfPacket(FILE *f,uint32_t nbElem,uint32_t pSize,queueOfAsfBits *q,queueOfAsfBits *s,uint32_t startDataOffset);
     ~asfPacket();
     uint8_t   dump(void);
     



From mean at mail.berlios.de  Fri Oct 28 08:29:02 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:29:02 +0200
Subject: [Avidemux-svn-commit] r7625 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028062902.73987481404@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:29:02 +0200 (Fri, 28 Oct 2011)
New Revision: 7625

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h
Log:
[asf] Clear queue at exit

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:29:00 UTC (rev 7624)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:29:02 UTC (rev 7625)
@@ -110,6 +110,8 @@
     delete _audioStreams[i];
     _audioStreams[i]=NULL;    
   }
+  freeQueue(&readQueue);
+  freeQueue(&storageQueue);
   return 1;
 }
 /**
@@ -275,7 +277,7 @@
   // Seeking ?
   if(_index[framenum].segNb!=curSeq)
   {
-    printf("Seeking.. curseq:%u wanted seq:%u\n",curSeq,_index[framenum].segNb);
+    printf("Seeking.. curseq:%u wanted seq:%u packet=%d\n",curSeq,_index[framenum].segNb,_index[framenum].packetNb);
     if(!_packet->goToPacket(_index[framenum].packetNb))
     {
       printf("[ASF] Cannot seek to frame %u\n",framenum);
@@ -283,7 +285,7 @@
     }
     _packet->purge();
     curSeq=_index[framenum].segNb;
-    printf("Seeking starting at seq=%u\n",curSeq);
+    printf("Seeking done, starting at seq=%u\n",curSeq);
   }
   
   
@@ -296,7 +298,8 @@
       asfBit *bit;
       bit=readQueue.front();
       readQueue.pop_front();
-      aprintf(">found packet of size %d seq %d, while curseq =%d wanted seg=%u current offset=%u\n",bit->len,bit->sequence,curSeq,_index[framenum].segNb,len);
+      aprintf(">found packet of size %d seq %d, while curseq =%d wanted seg=%u current offset=%u, packet=%u\n",
+                    bit->len,bit->sequence,curSeq,_index[framenum].segNb,len,bit->packet);
       // Here it is tricky
       // if len==0 we are reading the first part of our frame
       // The packet may starts with segments from the previous frame

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp	2011-10-28 06:29:00 UTC (rev 7624)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp	2011-10-28 06:29:02 UTC (rev 7625)
@@ -40,6 +40,8 @@
 
 	delete _packet;
 
+  freeQueue(&readQueue);
+  freeQueue(&storageQueue);
 
 	_packet = NULL;
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:29:00 UTC (rev 7624)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:29:02 UTC (rev 7625)
@@ -398,7 +398,7 @@
   // Here we go
   asfPacket *aPacket=new asfPacket(_fd,_nbPackets,_packetSize,
                                    &readQueue,&storageQueue,_dataStartOffset);
-  uint32_t packet=1;
+  uint32_t packet=0;
 #define MAXIMAGE (_nbPackets)
   uint32_t sequence=1;
   uint32_t ceilImage=MAXIMAGE;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:29:00 UTC (rev 7624)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 06:29:02 UTC (rev 7625)
@@ -35,6 +35,19 @@
 #endif
 
 /**
+    \fn freeQueue
+*/
+bool freeQueue(queueOfAsfBits *q)
+{
+    while(q->size())
+    {
+        asfBit *bit=q->front();
+        q->pop_front();
+        delete bit;
+    }
+    return true;
+}
+/**
     \fn asfPacket ctor
 */ 
 asfPacket::asfPacket(FILE *f,uint32_t nb,uint32_t pSize,queueOfAsfBits *q,queueOfAsfBits *s,uint32_t startDataOffset)
@@ -385,7 +398,9 @@
 
    return 1;
  }
- //****************************
+ /**
+    \fn dump
+*/
  uint8_t   asfPacket::dump(void)
  {
   
@@ -399,7 +414,7 @@
  uint8_t asfPacket::purge(void)
  {
     // Flush queue
-   while(!queue->size())
+   while(queue->size())
    {
      asfBit *bit;
      bit=queue->front();
@@ -408,23 +423,6 @@
    }
    return 1; 
  }
-#if 0
- //****************************
- uint8_t   asfPacket::packTo(uint8_t *buffer,uint32_t *len)
- {
-   *len=0;
-   while(!queue->isEmpty())
-   {
-     asfBit *bit;
-     ADM_assert(queue->pop((void**)&bit));
-     memcpy(buffer,bit->data,bit->len);
-     *len+=bit->len;
-     delete[] bit->data;
-     delete bit;
-   }
-   return 1;
- }
-#endif 
  
 #ifndef ASF_INLINE
 #include "ADM_asfIo.h"

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h	2011-10-28 06:29:00 UTC (rev 7624)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h	2011-10-28 06:29:02 UTC (rev 7625)
@@ -85,5 +85,6 @@
     uint8_t   packTo(uint8_t *buffer,uint32_t *len);
 };
 
+bool freeQueue(queueOfAsfBits *q);
 #endif
 



From mean at mail.berlios.de  Fri Oct 28 08:29:03 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:29:03 +0200
Subject: [Avidemux-svn-commit] r7626 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028062903.E6BF9481404@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:29:03 +0200 (Fri, 28 Oct 2011)
New Revision: 7626

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
Log:
[Asf] revert previous one

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:29:02 UTC (rev 7625)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:29:03 UTC (rev 7626)
@@ -134,6 +134,7 @@
   memset(&(_audioAccess[0]),0,sizeof(_audioAccess));
   memset(&(_audioStreams[0]),0,sizeof(_audioStreams));
   _nbAudioTrack=0;
+  _videostream.dwRate=0;
 
 }
 /**
@@ -258,6 +259,7 @@
 {
   img->dataLength=0;
   img->flags=AVI_KEY_FRAME;
+  uint32_t len=0;
   if(framenum>=nbImage)
   {
     printf("[ASF] Going out of bound %u %u\n",framenum, nbImage);
@@ -265,12 +267,12 @@
   }
   if(!_index[framenum].frameLen)
   {
-    return 1; // Empty frame 
+    goto gotcha;
   }
   // In case curSeq is stored as one byte..
   curSeq&=0xff;
   //
-  uint32_t len=0;
+  
   aprintf("Framenum %u len: %u curSeq %u frameSeq=%u packetnb=%u \n",
          framenum,_index[framenum].frameLen,curSeq,
          _index[framenum].segNb,_index[framenum].packetNb);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-28 06:29:02 UTC (rev 7625)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-28 06:29:03 UTC (rev 7626)
@@ -179,7 +179,7 @@
     uint32_t                _videoStreamId;
 
     uint8_t                 close(void);
-
+    bool                    setFps(uint64_t usPerFrame);
     
   public: // Shared with audio track
     char                    *myName;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:29:02 UTC (rev 7625)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:29:03 UTC (rev 7626)
@@ -34,7 +34,21 @@
 static const uint8_t asf_audio[16]={0x40,0x9e,0x69,0xf8,0x4d,0x5b,0xcf,0x11,0xa8,0xfd,0x00,0x80,0x5f,0x5c,0x44,0x2b};
 static const uint8_t asf_video[16]={0xc0,0xef,0x19,0xbc,0x4d,0x5b,0xcf,0x11,0xa8,0xfd,0x00,0x80,0x5f,0x5c,0x44,0x2b};
 
+
 /**
+    \fn setFps
+*/
+bool asfHeader::setFps(uint64_t usPerFrame)
+{
+    if(!usPerFrame) return false;
+    double f=usPerFrame;
+    if(f<10) f=10;
+    f=1000000.*1000./f;
+    _videostream.dwRate=(uint32_t)f;
+    ADM_info("AverageFps=%d\n",(int)_videostream.dwRate);
+    return true;
+}
+/**
     \fn decodeStreamHeader
 */
 bool asfHeader::decodeStreamHeader(asfChunk *s)
@@ -79,7 +93,8 @@
                     {
                       return 0; 
                     }
-                }else printf("Already have a video track, skipping\n");
+                    ADM_info("Average fps available from ext header\n");
+                }
               } 
               break;
           case 2: // audio
@@ -96,6 +111,10 @@
 */ 
 bool asfHeader::decodeExtHeader(asfChunk *s)
 {
+            int streamNumber=0xff;
+            int streamLangIndex=0xff;
+            uint64_t avgTimePerFrameUs=0;
+
             s->read32();s->read32(); // start time
             s->read32();s->read32(); // end time
             s->read32(); // bitrate
@@ -106,9 +125,14 @@
             s->read32(); // alt Initial buffer fullness
             s->read32(); // max object size
             s->read32(); // flags
-            s->read16(); // Stream #
-            s->read16(); // stream lang index
-            s->read32();;s->read32(); // avg time / frame
+            streamNumber=s->read16(); // Stream #
+            streamLangIndex=s->read16(); // stream lang index
+            printf("\tstream number     :%d\n",streamNumber);
+            printf("\tstream langIndex  :%d\n",streamLangIndex);
+            uint64_t avg=s->read64();
+            avg/=10.;
+            printf("\t avg time/frame  : %"LLU" us\n",avg);
+            avgTimePerFrameUs=avg;
             int streamNameCount=s->read16(); // stream name count
             int payloadExtCount=s->read16(); // payload ext system count
             printf("\tName       count : %d\n",streamNameCount);
@@ -182,6 +206,7 @@
         // 128+16 reserved=
         s->read32();s->read32();s->read32();s->read32();s->read16();
         int x=s->read32();
+        uint64_t avgTimePerFrame;
         printf("Dumping object ext : %d data bytes\n",x);
         asfChunk *son=new asfChunk(_fd);
         do
@@ -301,8 +326,6 @@
 			Endian_BitMapInfo(&_video_bih);
 		#endif
 
-            _videostream.dwScale=1000;
-            _videostream.dwRate=30000;
 
             _videostream.fccHandler=_video_bih.biCompression;
             printf("Codec : <%s> (%04x)\n",
@@ -516,7 +539,20 @@
   printf("[ASF] ******** End of buildindex *******\n");
 
   nbImage=_index.size();;
-
+  if(nbImage)
+    {
+        ADM_info("First image pts: %s, dts: %s\n",ADM_us2plain(_index[0].pts),
+                ADM_us2plain(_index[0].dts));
+        for(int i=0;i<_nbAudioTrack;i++)
+        {
+            if(!audioSeekPoints[i].size())
+            {
+                ADM_info("audio track : %d, no seek\n",i);
+                continue;
+            }
+            ADM_info("audio track : %d, %s\n",i,ADM_us2plain(audioSeekPoints[i][0].pts));
+        }
+    }
   _videostream.dwLength=_mainaviheader.dwTotalFrames=nbImage;
   if(!nbImage) return 0;
   _index[0].flags=AVI_KEY_FRAME;
@@ -524,16 +560,25 @@
   // Update fps
   // In fact it is an average fps
   //
-  float f=_index[nbImage-1].dts;
-   f/=nbImage; // average duration of 1 image in us
-    if(f<10) f=10;
-   f=1000000.*1000./f;
-  uint32_t avgFps=(uint32_t) f;
-    printf("[Asf] Average fps=%d\n",avgFps);
-  
   _videostream.dwScale=1000;
-  _videostream.dwRate=(uint32_t)avgFps;;
-
+  if(!_videostream.dwRate)
+  {
+      ADM_info("Fps not provided, guessing it from nbFrame and duration\n");
+      uint32_t avgFps;
+      if(_index[nbImage-1].pts!=ADM_NO_PTS && _index[0].pts!=ADM_NO_PTS)
+      {
+          float f=(_index[nbImage-1].pts-_index[0].pts);
+            f/=nbImage; // average duration of 1 image in us
+            setFps((uint64_t) f);
+      }else
+        {
+            printf("[Asf] No pts, setting 30 fps hardcoded\n");
+            _videostream.dwRate=(uint32_t)30000;;
+        }
+  }else
+    {
+        ADM_info("Already got fps (%d/1000)\n",_videostream.dwRate);
+    }
   return 1;
   
 }



From mean at mail.berlios.de  Fri Oct 28 08:29:05 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:29:05 +0200
Subject: [Avidemux-svn-commit] r7627 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028062905.257FD481404@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:29:04 +0200 (Fri, 28 Oct 2011)
New Revision: 7627

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
Log:
[ASF/demux] Use the provided usperframe to compute fps

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-28 06:29:03 UTC (rev 7626)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-28 06:29:04 UTC (rev 7627)
@@ -109,6 +109,15 @@
   uint64_t     lastDts;
   WAVHeader    wavHeader;
 }asfAudioTrak;
+/**
+    \class ADM_usPerFrameMapping
+*/
+class ADM_usPerFrameMapping
+{
+public:
+    int         streamNb;
+    uint64_t    usPerFrame;
+};
 
 /**
     \class asfAudioAccess
@@ -158,11 +167,12 @@
 class asfHeader         :public vidHeader
 {
   protected:
+    std::vector             <ADM_usPerFrameMapping> frameDurationMapping;
     uint8_t                 getHeaders( void);
     uint8_t                 buildIndex(void);
     uint8_t                 loadVideo(asfChunk *s);
     bool                    loadAudio(asfChunk *s,uint32_t sid);
-    bool                    decodeExtHeader(asfChunk *s);
+    bool                    decodeExtHeader(asfChunk *a);
     bool                    decodeStreamHeader(asfChunk *s);
     queueOfAsfBits          readQueue;
     queueOfAsfBits          storageQueue;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:29:03 UTC (rev 7626)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:29:04 UTC (rev 7627)
@@ -114,7 +114,7 @@
             int streamNumber=0xff;
             int streamLangIndex=0xff;
             uint64_t avgTimePerFrameUs=0;
-
+            ADM_usPerFrameMapping map;
             s->read32();s->read32(); // start time
             s->read32();s->read32(); // end time
             s->read32(); // bitrate
@@ -164,6 +164,9 @@
                     x->skipChunk();
                     delete x;
             }
+            map.streamNb=streamNumber;
+            map.usPerFrame=avg;
+            frameDurationMapping.push_back(map);
             return true;
 }
 /** *****************************************
@@ -560,9 +563,22 @@
   // Update fps
   // In fact it is an average fps
   //
-  _videostream.dwScale=1000;
-  if(!_videostream.dwRate)
-  {
+    _videostream.dwScale=1000;
+    // check if we have a duration per frame for video...
+    int n=frameDurationMapping.size();
+    int dex=-1;
+    for(int i=0;i<n;i++)
+    {
+        if(frameDurationMapping[i].streamNb==_videoStreamId)
+            dex=i;
+    }
+    if(dex!=-1)
+    {
+        ADM_info("Average fps provided\n");
+        setFps(frameDurationMapping[dex].usPerFrame);
+    }
+    else
+    {
       ADM_info("Fps not provided, guessing it from nbFrame and duration\n");
       uint32_t avgFps;
       if(_index[nbImage-1].pts!=ADM_NO_PTS && _index[0].pts!=ADM_NO_PTS)
@@ -575,10 +591,7 @@
             printf("[Asf] No pts, setting 30 fps hardcoded\n");
             _videostream.dwRate=(uint32_t)30000;;
         }
-  }else
-    {
-        ADM_info("Already got fps (%d/1000)\n",_videostream.dwRate);
     }
-  return 1;
+    return 1;
   
 }



From mean at mail.berlios.de  Fri Oct 28 08:29:06 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:29:06 +0200
Subject: [Avidemux-svn-commit] r7628 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028062906.91929481404@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:29:06 +0200 (Fri, 28 Oct 2011)
New Revision: 7628

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
Log:
[ASF/demux] Try to shift audio and video so that they start near zero

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:29:04 UTC (rev 7627)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:29:06 UTC (rev 7628)
@@ -135,6 +135,7 @@
   memset(&(_audioStreams[0]),0,sizeof(_audioStreams));
   _nbAudioTrack=0;
   _videostream.dwRate=0;
+  _shiftUs=0;
 
 }
 /**

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-28 06:29:04 UTC (rev 7627)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-28 06:29:06 UTC (rev 7628)
@@ -190,7 +190,7 @@
 
     uint8_t                 close(void);
     bool                    setFps(uint64_t usPerFrame);
-    
+    bool                    shiftAudioVideoBy(uint64_t s);
   public: // Shared with audio track
     char                    *myName;
     uint32_t                nbImage;
@@ -203,8 +203,9 @@
     asfAudioTrak             _allAudioTracks[ASF_MAX_AUDIO_TRACK];
     ADM_audioStream         *_audioStreams[ASF_MAX_AUDIO_TRACK];
     uint32_t                 _nbPackets;
+    uint64_t                 _shiftUs;
+    uint64_t                 getShift(void) { return _shiftUs;}
     
-    
     // / Shared
   public:
                                         asfHeader(void);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp	2011-10-28 06:29:04 UTC (rev 7627)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfAudio.cpp	2011-10-28 06:29:06 UTC (rev 7628)
@@ -92,6 +92,7 @@
 
 bool   asfAudioAccess::goToTime(uint64_t dts_us) // PTS!
 {
+    dts_us+=_father->getShift();
     // Search
     int size=_seekPoints->size();
     if(dts_us<=(*_seekPoints)[0].pts || size<2)
@@ -118,6 +119,7 @@
   *len=0;
   uint32_t delta;
   uint8_t r;
+  uint64_t shift=_father->getShift();
   while(1)
   {
    
@@ -130,6 +132,12 @@
       memcpy(dest,bit->data,bit->len);
       *len=bit->len;
       *dts=bit->pts; // for audio PTS=DTS...
+      if(*dts>shift) *dts-=shift;
+        else
+        {
+            ADM_error("ASF audio : Cannot shift, DTS=%"LLU", shift=%"LLU"\n",*dts,shift);
+            *dts=ADM_NO_PTS;
+        }
       storageQueue.push_back(bit);
       bit=NULL;
       return 1;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:29:04 UTC (rev 7627)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:29:06 UTC (rev 7628)
@@ -33,9 +33,41 @@
 
 static const uint8_t asf_audio[16]={0x40,0x9e,0x69,0xf8,0x4d,0x5b,0xcf,0x11,0xa8,0xfd,0x00,0x80,0x5f,0x5c,0x44,0x2b};
 static const uint8_t asf_video[16]={0xc0,0xef,0x19,0xbc,0x4d,0x5b,0xcf,0x11,0xa8,0xfd,0x00,0x80,0x5f,0x5c,0x44,0x2b};
-
-
 /**
+    \fn shiftAudioVideoBy
+    \brief shift audio and video so that they start close to zero
+*/
+bool asfHeader::shiftAudioVideoBy(uint64_t s)
+{
+    int n=_index.size();
+    ADM_info("Shifting by %s\n",ADM_us2plain(s));
+    for(int i=0;i<n;i++)
+    {
+        if(_index[i].pts!=ADM_NO_PTS)
+        {
+            if(_index[i].pts<s)
+            {
+                ADM_error("Shifting too big for frame %d PTS: %s\n",i,ADM_us2plain(_index[i].pts));
+            }else
+                _index[i].pts-=s;
+        }
+        _index[i].dts=ADM_NO_PTS;
+/*
+        if(_index[i].dts!=ADM_NO_PTS)
+        {
+            if(_index[i].dts<s)
+            {
+                ADM_error("Shifting too big for frame %d DTS: %s\n",i,ADM_us2plain(_index[i].dts));
+                _index[i].dts=ADM_NO_PTS;
+            }else
+                _index[i].dts-=s;
+        }
+*/
+    }
+    _shiftUs=s;
+    return true;
+}
+/**
     \fn setFps
 */
 bool asfHeader::setFps(uint64_t usPerFrame)
@@ -426,7 +458,7 @@
                                    &readQueue,&storageQueue,_dataStartOffset);
   uint32_t packet=0;
 #define MAXIMAGE (_nbPackets)
-  uint32_t sequence=1;
+  uint32_t sequence=0;
   uint32_t ceilImage=MAXIMAGE;
 
   nbImage=0;
@@ -461,19 +493,24 @@
       // --
       uint64_t dts=bit->dts;
       uint64_t pts=bit->pts;
+        printf("** DTS=%s\n",ADM_us2plain(dts));
+        printf("** PDTS=%s\n",ADM_us2plain(pts));
       if(bit->stream==_videoStreamId)
       {
-          aprintf(">found packet of size=%d off=%d seq %d, while curseq =%d, dts=%s\n",
-                        bit->len,bit->offset,  bit->sequence,curSeq,
-                        ADM_us2plain(dts));
+          printf(">found video packet of size=%d off=%d seq %d, while curseq =%d, dts=%s",
+                        bit->len,bit->offset,  bit->sequence,curSeq, ADM_us2plain(dts));
+          printf(" pts=%s\n",ADM_us2plain(pts));
           if(bit->sequence!=sequence || first==true)
           {
             if(first==false)
             {
                 indexEntry.frameLen=len;
+                ADM_info("Pushing video frame seq=%d pts=%s \n",
+                        indexEntry.segNb,ADM_us2plain(indexEntry.pts));
+                ADM_info("dts=%s\n",ADM_us2plain(indexEntry.dts));
                 _index.append(indexEntry);
             }
-            first=false;
+            
             aprintf("New sequence\n");
             if( ((sequence+1)&0xff)!=(bit->sequence&0xff))
             {
@@ -487,9 +524,9 @@
             indexEntry.flags=bit->flags;
             indexEntry.dts=dts;
             indexEntry.pts=pts;
-
-            readQueue.push_front(bit); // reuse it next time
-    
+            if(first==false)
+                readQueue.push_front(bit); // reuse it next time
+            first=false;
             sequence=bit->sequence;
             len=0;
             continue;
@@ -511,8 +548,14 @@
                         seek.pts=bit->pts;
                         seek.packetNb=bit->packet;
                         (audioSeekPoints[i]).append(seek);
+      
+#if 1
+                        if(!lastDts[i])
+                            printf("Adding seek point for track %d at %s (packet=%d)\n",
+                            i,ADM_us2plain(bit->pts),(int)seek.packetNb);
+#endif
                         lastDts[i]=bit->pts;
-                        printf("Adding seek point for track %d at %s (packet=%d)\n",
+                        aprintf("Adding seek point for track %d at %s (packet=%d)\n",
                             i,ADM_us2plain(bit->pts),(int)seek.packetNb);
                 }
             }
@@ -542,22 +585,42 @@
   printf("[ASF] ******** End of buildindex *******\n");
 
   nbImage=_index.size();;
-  if(nbImage)
+  if(!nbImage) return 0;
+  
+  uint64_t shift=60*1000*1000;
+  bool canShift=false;
+  uint64_t tPts;
+  tPts=_index[0].pts;
+    ADM_info("First image pts: %s, dts: %s\n",ADM_us2plain(tPts), ADM_us2plain(_index[0].dts));
+   if(tPts != ADM_NO_PTS)
     {
-        ADM_info("First image pts: %s, dts: %s\n",ADM_us2plain(_index[0].pts),
-                ADM_us2plain(_index[0].dts));
-        for(int i=0;i<_nbAudioTrack;i++)
+        shift=tPts;
+        ADM_info("Video shift = %s\n",ADM_us2plain(tPts));
+        canShift=true;
+    }else
+        canShift=false;
+    for(int i=0;i<_nbAudioTrack;i++)
+    {
+        if(!audioSeekPoints[i].size())
         {
-            if(!audioSeekPoints[i].size())
-            {
-                ADM_info("audio track : %d, no seek\n",i);
-                continue;
-            }
-            ADM_info("audio track : %d, %s\n",i,ADM_us2plain(audioSeekPoints[i][0].pts));
+            ADM_info("audio track : %d, no seek\n",i);
+            canShift=false;
+            continue;
         }
+        tPts=audioSeekPoints[i][0].pts;
+        ADM_info("audio track : %d, %s\n",i,ADM_us2plain(tPts));
+        if(tPts<shift) shift=tPts;
     }
+    if(canShift)
+    {
+            ADM_info("Shifting a/v raw=%s\n",ADM_us2plain(shift));
+    }else
+    {
+            ADM_info("Can t shift\n");
+            shift=0;
+    }
   _videostream.dwLength=_mainaviheader.dwTotalFrames=nbImage;
-  if(!nbImage) return 0;
+  
   _index[0].flags=AVI_KEY_FRAME;
   if(_index[0].pts==ADM_NO_PTS) _index[0].pts=_index[0].dts;
   // Update fps
@@ -592,6 +655,18 @@
             _videostream.dwRate=(uint32_t)30000;;
         }
     }
+    if(shift)
+    {
+        double frames3=_videostream.dwScale;
+                frames3/=_videostream.dwRate;
+                frames3*=3*1000*1000; // 
+            ADM_info("3 frames time = %s\n",ADM_us2plain((uint64_t)frames3));
+        uint64_t frame64=(uint64_t)frames3;
+        if(frame64<shift) shift=shift-frame64;
+        else shift=0;
+
+        shiftAudioVideoBy(shift);
+    }
     return 1;
   
 }



From mean at mail.berlios.de  Fri Oct 28 08:29:07 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 08:29:07 +0200
Subject: [Avidemux-svn-commit] r7629 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028062907.AE161481404@sheep.berlios.de>

Author: mean
Date: 2011-10-28 08:29:07 +0200 (Fri, 28 Oct 2011)
New Revision: 7629

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
Log:
[asf] Go to 1st seg = real seeking

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:29:06 UTC (rev 7628)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 06:29:07 UTC (rev 7629)
@@ -278,7 +278,7 @@
          framenum,_index[framenum].frameLen,curSeq,
          _index[framenum].segNb,_index[framenum].packetNb);
   // Seeking ?
-  if(_index[framenum].segNb!=curSeq)
+  if(_index[framenum].segNb!=curSeq || _index[framenum].segNb==1)
   {
     printf("Seeking.. curseq:%u wanted seq:%u packet=%d\n",curSeq,_index[framenum].segNb,_index[framenum].packetNb);
     if(!_packet->goToPacket(_index[framenum].packetNb))



From mean at mail.berlios.de  Fri Oct 28 21:45:23 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 28 Oct 2011 21:45:23 +0200
Subject: [Avidemux-svn-commit] r7630 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111028194523.62879481468@sheep.berlios.de>

Author: mean
Date: 2011-10-28 21:45:22 +0200 (Fri, 28 Oct 2011)
New Revision: 7630

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
Log:
[asf] Fix length of 1st frame

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 06:29:07 UTC (rev 7629)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 19:45:22 UTC (rev 7630)
@@ -525,11 +525,18 @@
             indexEntry.dts=dts;
             indexEntry.pts=pts;
             if(first==false)
+            {
+                sequence=bit->sequence;
                 readQueue.push_front(bit); // reuse it next time
-            first=false;
-            sequence=bit->sequence;
-            len=0;
-            continue;
+                len=0;
+                continue;
+
+            }else
+            {
+                sequence=bit->sequence;
+                first=false; // first packet
+            }
+            
           }
           len+=bit->len;
       } // End of video stream Id



From mean at mail.berlios.de  Sat Oct 29 08:38:16 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 29 Oct 2011 08:38:16 +0200
Subject: [Avidemux-svn-commit] r7631 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf
Message-ID: <20111029063816.744A6481375@sheep.berlios.de>

Author: mean
Date: 2011-10-29 08:38:15 +0200 (Sat, 29 Oct 2011)
New Revision: 7631

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h
Log:
[Asf] Fix PTS when single payload + silence

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-28 19:45:22 UTC (rev 7630)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.cpp	2011-10-29 06:38:15 UTC (rev 7631)
@@ -23,7 +23,7 @@
 #include "ADM_asf.h"
 #include "ADM_asfPacket.h"
 
-#if 1
+#if 0
 #define aprintf printf
 #else
 #define aprintf(...) {}

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-28 19:45:22 UTC (rev 7630)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asf.h	2011-10-29 06:38:15 UTC (rev 7631)
@@ -206,6 +206,7 @@
     uint64_t                 _shiftUs;
     uint64_t                 getShift(void) { return _shiftUs;}
     
+    
     // / Shared
   public:
                                         asfHeader(void);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-28 19:45:22 UTC (rev 7630)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfHeaders.cpp	2011-10-29 06:38:15 UTC (rev 7631)
@@ -493,21 +493,22 @@
       // --
       uint64_t dts=bit->dts;
       uint64_t pts=bit->pts;
-        printf("** DTS=%s\n",ADM_us2plain(dts));
-        printf("** PDTS=%s\n",ADM_us2plain(pts));
+        aprintf("** DTS=%s\n",ADM_us2plain(dts));
+        aprintf("** PDTS=%s\n",ADM_us2plain(pts));
       if(bit->stream==_videoStreamId)
       {
-          printf(">found video packet of size=%d off=%d seq %d, while curseq =%d, dts=%s",
+          aprintf(">found video packet of size=%d off=%d seq %d, while curseq =%d, dts=%s",
                         bit->len,bit->offset,  bit->sequence,curSeq, ADM_us2plain(dts));
-          printf(" pts=%s\n",ADM_us2plain(pts));
+          aprintf(" pts=%s\n",ADM_us2plain(pts));
           if(bit->sequence!=sequence || first==true)
           {
             if(first==false)
             {
                 indexEntry.frameLen=len;
-                ADM_info("Pushing video frame seq=%d pts=%s \n",
+                aprintf("Pushing video frame index=%d seq=%d pts=%s \n",
+                        _index.size(),
                         indexEntry.segNb,ADM_us2plain(indexEntry.pts));
-                ADM_info("dts=%s\n",ADM_us2plain(indexEntry.dts));
+                aprintf("dts=%s\n",ADM_us2plain(indexEntry.dts));
                 _index.append(indexEntry);
             }
             

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-28 19:45:22 UTC (rev 7630)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.cpp	2011-10-29 06:38:15 UTC (rev 7631)
@@ -83,6 +83,28 @@
    purge();
    return 1;
  }
+/**
+    \fn readReplica
+    \brief read pts from replica if any
+*/
+uint64_t   asfPacket::readPtsFromReplica(int replica)
+{
+    uint64_t pts=ADM_NO_PTS;
+    if(replica==1) 
+    {
+        ADM_error("Replica==1 : Compressed data!\n");
+     }else
+     if(replica>=8)
+     {
+        read32(); // size
+        pts=read32()*1000; // PTS
+        skip(replica-8);
+     }
+     else
+        skip(replica);
+    return pts;
+}
+
  /**
     \fn     nextPacket
     \brief  Read ASF packet & segments 
@@ -194,15 +216,7 @@
          mediaObjectNumber=readVCL(mediaObjectNumberLenType,0); // Media object number
          offset=readVCL(offsetLenType,0);
          replica=readVCL(replicaLenType,0);
-         if(replica==1) ADM_error("Replica==1 : Compressed data!\n");
-         if(replica>=8)
-         {
-            read32(); // size
-            pts=read32()*1000; // PTS
-            skip(replica-8);
-         }
-         else
-            skip(replica);
+         pts=readPtsFromReplica(replica);
          payloadLen=readVCL(payloadLengthType,0);
          remaining=pakSize-_offset;
          remaining=remaining-paddingLen;
@@ -245,18 +259,7 @@
          mediaObjectNumber=readVCL(mediaObjectNumberLenType,0); // Media object number
          offset=readVCL(offsetLenType,0);
          replica=readVCL(replicaLenType,0);
-         aprintf("replica                %d\n",replica);
-         if(replica>8)
-         {
-            int ssize=read32();
-            int stime=read32();
-            aprintf("replica size:1=%d\n",ssize);
-            aprintf("replica pts :2=%d\n",stime);
-            pts=stime; // in fact PTS
-            skip(replica-8);
-         }
-            else
-                skip(replica);
+         pts=readPtsFromReplica(replica);
          remaining=pakSize-_offset;
          remaining=remaining-paddingLen;
          if(remaining<=0) 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h	2011-10-28 19:45:22 UTC (rev 7630)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Asf/ADM_asfPacket.h	2011-10-29 06:38:15 UTC (rev 7631)
@@ -59,6 +59,7 @@
     uint32_t        currentPacket;
     uint32_t        _startDataOffset;
     uint32_t        _nbPackets;
+    uint64_t        readPtsFromReplica(int sz);
   public:
     
     asfPacket(FILE *f,uint32_t nbElem,uint32_t pSize,queueOfAsfBits *q,queueOfAsfBits *s,uint32_t startDataOffset);



From mean at mail.berlios.de  Sat Oct 29 08:59:28 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 29 Oct 2011 08:59:28 +0200
Subject: [Avidemux-svn-commit] r7632 - in branches/avidemux_2.6_branch_mean:
	avidemux_core/ADM_coreAudio/include avidemux_core/ADM_coreAudio/src
	avidemux_plugins/ADM_audioDecoders/ADM_ad_lav cmake
Message-ID: <20111029065929.3733D481375@sheep.berlios.de>

Author: mean
Date: 2011-10-29 08:59:28 +0200 (Sat, 29 Oct 2011)
New Revision: 7632

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioCodecEnum.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStream.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
   branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake
Log:
[audio decoder] Support for wmapro (untested)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioCodecEnum.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioCodecEnum.h	2011-10-29 06:38:15 UTC (rev 7631)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/include/ADM_audioCodecEnum.h	2011-10-29 06:59:28 UTC (rev 7632)
@@ -7,6 +7,7 @@
 #define WAV_MP3 	85
 #define WAV_MP2 	80
 #define WAV_WMA 	353
+#define WAV_WMAPRO 	354
 #define WAV_PCM 	1
 #define WAV_MSADPCM 	2
 #define WAV_LPCM 	3

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStream.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStream.cpp	2011-10-29 06:38:15 UTC (rev 7631)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreAudio/src/ADM_audioStream.cpp	2011-10-29 06:59:28 UTC (rev 7632)
@@ -185,6 +185,7 @@
               case WAV_PCM: return QT_TR_NOOP("PCM");
               case WAV_MP2: return QT_TR_NOOP("MP2");
               case WAV_MP3: return QT_TR_NOOP("MP3");
+              case WAV_WMAPRO:  return QT_TR_NOOP("WMAPRO");
               case WAV_WMA:  return QT_TR_NOOP("WMA");
               case WAV_LPCM: return QT_TR_NOOP("LPCM");
               case WAV_AC3:  return QT_TR_NOOP("AC3");

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp	2011-10-29 06:38:15 UTC (rev 7631)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp	2011-10-29 06:59:28 UTC (rev 7632)
@@ -55,6 +55,7 @@
 
 static  ad_supportedFormat Formats[]={
         {WAV_WMA,AD_MEDIUM_QUAL},
+        {WAV_WMAPRO,AD_MEDIUM_QUAL},
         {WAV_QDM2,AD_MEDIUM_QUAL},
         {WAV_AMV_ADPCM,AD_MEDIUM_QUAL},
         {WAV_NELLYMOSER,AD_MEDIUM_QUAL},
@@ -117,6 +118,9 @@
     bool wantFloat=true;
     switch(fourcc)
     {
+      case WAV_WMAPRO:
+        _context->codec_id = CODEC_ID_WMAPRO;
+        break;
       case WAV_WMA:
         _context->codec_id = CODEC_ID_WMAV2;
         break;

Modified: branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake	2011-10-29 06:38:15 UTC (rev 7631)
+++ branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake	2011-10-29 06:59:28 UTC (rev 7632)
@@ -15,7 +15,7 @@
 set(FFMPEG_DECODERS  aac ac3 eac3 adpcm_ima_amv  amv  bmp  cinepak  cyuv  dca  dvbsub  dvvideo  ffv1  ffvhuff  flv  fraps  h263  h264  huffyuv  mjpeg
 					 mjpegb  mpeg2video  mpeg4  msmpeg4v2  msmpeg4v3  msvideo1  nellymoser  png  qdm2  rawvideo  snow
 					 svq3  theora  tscc  mp2 mp3 mp2_float mp3_float
-					 vc1  vp3  vp6  vp6a  vp6f  wmav2  wmv1  wmv2  wmv3)
+					 vc1  vp3  vp6  vp6a  vp6f  wmapro wmav2  wmv1  wmv2  wmv3)
 set(FFMPEG_ENCODERS  ac3  ac3_float dvvideo  ffv1  ffvhuff  flv  h263  huffyuv  mjpeg  mp2  mpeg1video  mpeg2video  mpeg4  snow aac)
 set(FFMPEG_MUXERS  flv  matroska  mpeg1vcd  mpeg2dvd  mpeg2svcd  mpegts  mov  mp4  psp)
 set(FFMPEG_PARSERS  ac3  h263  h264  mpeg4video)



From mean at mail.berlios.de  Sat Oct 29 10:42:57 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 29 Oct 2011 10:42:57 +0200
Subject: [Avidemux-svn-commit] r7633 -
	branches/avidemux_2.5_branch_gruntster/po
Message-ID: <20111029084258.4D5FE481375@sheep.berlios.de>

Author: mean
Date: 2011-10-29 10:42:57 +0200 (Sat, 29 Oct 2011)
New Revision: 7633

Modified:
   branches/avidemux_2.5_branch_gruntster/po/hu.po
Log:
[i18n] hu update by Laszlo Andrassy

Modified: branches/avidemux_2.5_branch_gruntster/po/hu.po
===================================================================
--- branches/avidemux_2.5_branch_gruntster/po/hu.po	2011-10-29 06:59:28 UTC (rev 7632)
+++ branches/avidemux_2.5_branch_gruntster/po/hu.po	2011-10-29 08:42:57 UTC (rev 7633)
@@ -1,19 +1,19 @@
 # Translation of Avidemux to Hungarian
 # Copyright (C) 2009 THE PACKAGE'S COPYRIGHT HOLDER
 # This file is distributed under the same license as the Avidemux package.
-# L?szl? Andr?ssy <andrassy.laszlo at gmail.com>, 2009-2010.
+# L?szl? Andr?ssy <andrassy.laszlo at gmail.com>, 2009-2011.
 #
 msgid ""
 msgstr ""
-"Project-Id-Version: Avidemux_SVN_6997\n"
+"Project-Id-Version: Avidemux_SVN_7629\n"
 "Report-Msgid-Bugs-To: \n"
 "POT-Creation-Date: 2010-06-14 19:03+0100\n"
-"PO-Revision-Date: 2011-02-16 09:29+0100\n"
+"PO-Revision-Date: 2011-10-28 08:40+0100\n"
 "Last-Translator: Andr?ssy L?szl? <andrassy.laszlo at gmail.com>\n"
-"Language-Team: Hungarian\n"
+"Language-Team: Hungarian <andrassy.laszlo at gmail.com>\n"
 "Language: \n"
 "MIME-Version: 1.0\n"
-"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Type: text/plain; charset=utf-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 "PO-Creation-Date: 2009-10-19 09:25+0100\n"
 "Plural-Forms: nplurals=2; plural=(n != 1);\n"
@@ -4156,7 +4156,7 @@
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:888
 msgid "Go to _Time..."
-msgstr "Id?ponthoz _ugr?s..."
+msgstr "Ugr?s _id?ponthoz..."
 
 #: avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_main2.cpp:899
 msgid "_Custom"



From mean at mail.berlios.de  Sun Oct 30 08:19:59 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 30 Oct 2011 08:19:59 +0100
Subject: [Avidemux-svn-commit] r7634 -
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore
Message-ID: <20111030072000.28B0E48140C@sheep.berlios.de>

Author: mean
Date: 2011-10-30 08:19:59 +0100 (Sun, 30 Oct 2011)
New Revision: 7634

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.cpp
Log:
[audioDevice/OSX] More patch by nibbles

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.cpp	2011-10-29 08:42:57 UTC (rev 7633)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_audioDevices/AudioCore/ADM_deviceAudioCore.cpp	2011-10-30 07:19:59 UTC (rev 7634)
@@ -20,6 +20,7 @@
 #include <stdlib.h>
 #include <pthread.h>
 #include <AudioUnit/AudioUnit.h>
+#include <CoreServices/CoreServices.h>
 
 #include "ADM_default.h"
 #include "ADM_assert.h"



From mean at mail.berlios.de  Sun Oct 30 17:38:55 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 30 Oct 2011 17:38:55 +0100
Subject: [Avidemux-svn-commit] r7635 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20111030163855.E7B9F48140C@sheep.berlios.de>

Author: mean
Date: 2011-10-30 17:38:55 +0100 (Sun, 30 Oct 2011)
New Revision: 7635

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp
Log:
[TS demux] Try to detect adts through bruteForce

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp	2011-10-30 07:19:59 UTC (rev 7634)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsBruteForce.cpp	2011-10-30 16:38:55 UTC (rev 7635)
@@ -29,7 +29,7 @@
 #define TS_NB_PACKET_THRESHOLD 5
 #define MAX_PID (1<<17)
 #define MAX_BUFFER_SIZE (10*1024)
-
+static bool idAAC_ADTS(int pid,tsPacket *ts);
 static bool idContent(int pid,tsPacket *ts,ADM_TS_TRACK_TYPE & trackType);
 static bool idMP2(int pid,tsPacket *ts);
 /**
@@ -280,6 +280,14 @@
                 trackType=ADM_TS_MPEG_AUDIO;
                 return true;
         }
+
+        if(idAAC_ADTS(pid,ts))
+        {
+                ADM_info("\t probably AAC/ADTS\n");
+                trackType=ADM_TS_AAC_ADTS;
+                return true;
+        }
+
         ADM_info("Cannot identify track\n");
         return false;
 }
@@ -347,6 +355,41 @@
         }
         return false;
 }
+        /**
+    \fn idMP2
+    \brief return true if the tracks is AAC/ADTS
+*/
+bool idAAC_ADTS(int pid,tsPacket *ts)
+{
+#define ADTS_NB_PACKET 10
+#define ADTS_MIN_MATCH 7
+        int match=0;
+        TS_PESpacket pes(pid);
+        for(int i=0;i<ADTS_NB_PACKET;i++)
+        {
+            if(!ts->getNextPES(&pes))
+            {
+                ADM_warning("ADTS:Cannot get PES for pid=%d\n",pid);
+                return false;
+            }
+            uint8_t *p=pes.payload+pes.offset;
+            printf("%02x %02x\n",p[0],p[1]);
+            if((*p)!=0xff)
+            {
+                continue;
+            }
+            if((p[1]&0xF0)!=0xF0)
+                continue;
+            match++;
+        }
+        ADM_info("\t Adts match : %d/%d\n",match,ADTS_NB_PACKET);
+        if(match>=ADTS_MIN_MATCH) 
+        {
+            
+            return true;
+        }
         
+        return false;
+}
 
 //EOF



From mean at mail.berlios.de  Sun Oct 30 17:38:56 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 30 Oct 2011 17:38:56 +0100
Subject: [Avidemux-svn-commit] r7636 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <20111030163856.F064C48140C@sheep.berlios.de>

Author: mean
Date: 2011-10-30 17:38:56 +0100 (Sun, 30 Oct 2011)
New Revision: 7636

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_main.cpp
Log:
[main] Set a project name !=NULL when using avsproxy

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_main.cpp	2011-10-30 16:38:55 UTC (rev 7635)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_main.cpp	2011-10-30 16:38:56 UTC (rev 7636)
@@ -993,7 +993,7 @@
   GUI_close();
   res = video_body->addFile (AVS_PROXY_DUMMY_FILE);
   // forget last project file
-  video_body->setProjectName(NULL);
+  video_body->setProjectName("avsproxy");
   if (res!=ADM_OK)			// an error occured
     {
         currentaudiostream = NULL;



From mean at mail.berlios.de  Sun Oct 30 17:38:58 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 30 Oct 2011 17:38:58 +0100
Subject: [Avidemux-svn-commit] r7637 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/AvsProxy
Message-ID: <20111030163858.2045948140C@sheep.berlios.de>

Author: mean
Date: 2011-10-30 17:38:57 +0100 (Sun, 30 Oct 2011)
New Revision: 7637

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/AvsProxy/ADM_avsproxy.cpp
Log:
[avsproxy] Be more robust if version mismatches

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/AvsProxy/ADM_avsproxy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/AvsProxy/ADM_avsproxy.cpp	2011-10-30 16:38:56 UTC (rev 7636)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/AvsProxy/ADM_avsproxy.cpp	2011-10-30 16:38:57 UTC (rev 7637)
@@ -100,6 +100,17 @@
 
 #define CLR(x)              memset(& x,0,sizeof(  x));
 
+    if(!info.width || !info.fps1000 || !info.height)
+    {
+        ADM_error("Wrong width/height/fps\n");
+        return false;
+    }
+    if(info.version!=AVSHEADER_API_VERSION)
+    {
+        GUI_Error_HIG("","Wrong API version, expected %d, got %d\n",AVSHEADER_API_VERSION,info.version);
+        return false;
+    }
+
     CLR(_videostream);
     CLR(_mainaviheader);
 



From mean at mail.berlios.de  Mon Oct 31 07:54:31 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 31 Oct 2011 07:54:31 +0100
Subject: [Avidemux-svn-commit] r7638 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv
Message-ID: <20111031065432.29C7148140E@sheep.berlios.de>

Author: mean
Date: 2011-10-31 07:54:31 +0100 (Mon, 31 Oct 2011)
New Revision: 7638

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp
Log:
[Flv] Fix parsing of metadata in some cases

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp	2011-10-30 16:38:57 UTC (rev 7637)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp	2011-10-31 06:54:31 UTC (rev 7638)
@@ -24,7 +24,11 @@
 #include "ADM_flv.h"
 
 #include <math.h>
-
+#if 0
+    #define aprintf printf
+#else
+    #define aprintf(...) {}
+#endif
 // Borrowed from lavformt/flv.h
 #include "libavformat/flv.h"
 // Borrowed from lavformt/flv.h
@@ -85,13 +89,27 @@
     \fn     readFlvString
     \brief  read pascal like string
 */
+#define FLV_MAX_STRING 255
 char *flvHeader::readFlvString(void)
 {
-static char stringz[255];
+static uint8_t stringz[FLV_MAX_STRING+1];
     int size=read16();
-    read(size,(uint8_t *)stringz);
+    if(size>FLV_MAX_STRING)
+    {
+        int pre=FLV_MAX_STRING;
+        read(pre,stringz);
+        ADM_warning("String way too large :%d\n",size);
+        mixDump(stringz,pre);
+        stringz[0]='X';
+        stringz[1]='X';
+        stringz[2]=0;
+        stringz[FLV_MAX_STRING]=0;
+        Skip(size-FLV_MAX_STRING);
+        return (char *)stringz;
+    }
+    read(size,stringz);
     stringz[size]=0;
-    return stringz;
+    return (char *)stringz;
 }
 extern "C" {
 double av_int2dbl(int64_t v);
@@ -121,7 +139,7 @@
 /**
     \fn parseOneMeta
 */
-bool flvHeader::parseOneMeta(const char *s,uint64_t endPos)
+bool flvHeader::parseOneMeta(const char *stri,uint64_t endPos)
 {
             int type=read8();
             printf("type :%d : ",type);
@@ -176,7 +194,7 @@
                                             hi=(hi<<32)+lo;
                                             val=(float)av_int2dbl(hi);
                                             printf("->%f",val);
-                                            setProperties(s,val);
+                                            setProperties(stri,val);
                                         }
                                         ;break;
                 case AMF_DATA_TYPE_STRING: {int r=read16();Skip(r);}break;
@@ -210,25 +228,20 @@
 uint8_t flvHeader::parseMetaData(uint32_t remaining)
 {
     uint32_t endPos=ftello(_fd)+remaining;
+    // Check the first one is onMetaData...
+    uint8_t type=read8();
+    char *z;
+    if(type!=AMF_DATA_TYPE_STRING) // String!
+        goto endit;
+    z=readFlvString();
+    printf("[FlashString] %s\n",z);
+    if(z && strncmp(z,"onMetaData",10)) goto endit;
+    // Normally the next one is mixed array
+    while(ftello(_fd)<endPos-4)
     {
-        // Check the first one is onMetaData...
-        uint8_t type=read8();
-        if(type!=AMF_DATA_TYPE_STRING) // String!
-            goto endit;
-        char *z=readFlvString();
-        printf("[FlashString] %s\n",z);
-        if(z && strncmp(z,"onMetaData",10)) goto endit;
-        // Normally the next one is mixed array
-        Skip(4);
-        Skip(1);
-        while(ftello(_fd)<endPos-4)
-        {
-            char *s=readFlvString();
-            printf("[FlvType]  String : %s ",s);
-            
-            if(false==parseOneMeta(s,endPos)) goto endit;
-        }
+        if(false==parseOneMeta("meta",endPos)) goto endit;
     }
+
 endit:
     fseeko(_fd,endPos,SEEK_SET);
     updateDimensionWithMeta(videoCodec);
@@ -346,8 +359,6 @@
   uint32_t skip=read32();
   fseeko(_fd,skip,SEEK_SET);
   printf("[FLV] Skipping %u header bytes\n",skip);
-
-
   pos=ftello(_fd);;
   printf("pos:%u/%u\n",pos,fileSize);
   // Create our video index
@@ -368,6 +379,11 @@
     size=read24();
     dts=read24();
     read32(); // ???
+    aprintf("--------\n");
+    aprintf("prevLen=%d\n",(int)prevLen);
+    aprintf("type  =%d\n",(int)type);
+    aprintf("size  =%d\n",(int)size);
+    aprintf("dts   =%d\n",(int)dts);
     if(!size) continue;
     uint32_t remaining=size;
     //printf("[FLV] At %08x found type %x size %u pts%u\n",pos,type,size,dts);
@@ -375,6 +391,7 @@
     {
       case FLV_TAG_TYPE_AUDIO:
           {
+            aprintf("** Audio **\n");
             if(!_isaudiopresent)
             {
                 audioTrack=new flvTrak(50);
@@ -400,13 +417,14 @@
           }
           break;
       case FLV_TAG_TYPE_META:
+                aprintf("** Meta **\n");
                 parseMetaData(remaining);
                 remaining=0;
                 break;
       case FLV_TAG_TYPE_VIDEO:
           {
             int of=1+4+3+3+1+4;
-            
+            aprintf("** Video **\n");
             uint8_t flags=read8();
             remaining--;
             int frameType=flags>>4;



