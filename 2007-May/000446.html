<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r3151 - in	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces:	ADM_GTK/ADM_dialog ADM_GTK/ADM_dialogFactory	ADM_NONE/ADM_dialog ADM_QT4/ADM_dialog ADM_commonUI
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2007-May/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3151%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces%3A%0A%09ADM_GTK/ADM_dialog%20ADM_GTK/ADM_dialogFactory%0A%09ADM_NONE/ADM_dialog%20ADM_QT4/ADM_dialog%20ADM_commonUI&In-Reply-To=%3C200705270912.l4R9CcA3016382%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000445.html">
   <LINK REL="Next"  HREF="000447.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r3151 - in	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces:	ADM_GTK/ADM_dialog ADM_GTK/ADM_dialogFactory	ADM_NONE/ADM_dialog ADM_QT4/ADM_dialog ADM_commonUI</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r3151%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces%3A%0A%09ADM_GTK/ADM_dialog%20ADM_GTK/ADM_dialogFactory%0A%09ADM_NONE/ADM_dialog%20ADM_QT4/ADM_dialog%20ADM_commonUI&In-Reply-To=%3C200705270912.l4R9CcA3016382%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r3151 - in	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces:	ADM_GTK/ADM_dialog ADM_GTK/ADM_dialogFactory	ADM_NONE/ADM_dialog ADM_QT4/ADM_dialog ADM_commonUI">mean at mail.berlios.de
       </A><BR>
    <I>Sun May 27 11:12:38 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000445.html">[Avidemux-svn-commit] r3150 - in	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4:	ADM_dialog ADM_gui
</A></li>
        <LI>Next message: <A HREF="000447.html">[Avidemux-svn-commit] r3152 - in	branches/avidemux_2.4_branch/avidemux: . ADM_video
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#446">[ date ]</a>
              <a href="thread.html#446">[ thread ]</a>
              <a href="subject.html#446">[ subject ]</a>
              <a href="author.html#446">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2007-05-27 11:12:35 +0200 (Sun, 27 May 2007)
New Revision: 3151

Added:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_color.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_srt.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_srt.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_srt.cpp
Removed:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_color.cpp
Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_srt.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_button.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Makefile.am
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am
Log:
new dialog for srt subtitles, GTK &amp; QT

Deleted: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_color.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_color.cpp	2007-05-26 15:12:41 UTC (rev 3150)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_color.cpp	2007-05-27 09:12:35 UTC (rev 3151)
@@ -1,99 +0,0 @@
-
-
-/*
- * DO NOT EDIT THIS FILE - it is generated by Glade.
- */
-
-#include &quot;config.h&quot;
-
-#include &lt;sys/types.h&gt;
-#include &lt;sys/stat.h&gt;
-#include &lt;unistd.h&gt;
-#include &lt;string.h&gt;
-#include &lt;stdio.h&gt;
-
-#include &lt;gdk/gdkkeysyms.h&gt;
-#include &lt;gtk/gtk.h&gt;
-
-
-#include &quot;default.h&quot;
-
-
-#include &quot;ADM_toolkit_gtk/ADM_gladeSupport.h&quot;
-#include &quot;ADM_toolkit_gtk/toolkit_gtk.h&quot;
-#include &quot;ADM_toolkit_gtk/toolkit_gtk_include.h&quot;
-#include &lt;ADM_assert.h&gt;
-
- #define WID(x) lookup_widget(dialog,#x)
-
-static GtkWidget	*create_colorselectiondialog1 (void);
-
-int DIA_colorSel(uint8_t *r, uint8_t *g, uint8_t *b)
-{
-GtkWidget *dialog;
-int ret=0;
-
-GdkColor color;
-
-	dialog=create_colorselectiondialog1();
-
-	color.red=*r&lt;&lt;8;
-	color.green=*g&lt;&lt;8;
-	color.blue=*b&lt;&lt;8;
-
-	gtk_color_selection_set_current_color    (GTK_COLOR_SELECTION(WID(color_selection1)),&amp;color);
-
-
-	if(GTK_RESPONSE_OK==gtk_dialog_run(GTK_DIALOG(dialog)))
-	{
-
-  		gtk_color_selection_get_current_color    (GTK_COLOR_SELECTION(WID(color_selection1)),&amp;color);
-		*r=color.red&gt;&gt;8;
-		*g=color.green&gt;&gt;8;
-		*b=color.blue&gt;&gt;8;
-		ret=1;
-	}
-
-	gtk_widget_destroy(dialog);
-	return ret;
-
-}
-
-GtkWidget*
-create_colorselectiondialog1 (void)
-{
-  GtkWidget *colorselectiondialog1;
-  GtkWidget *ok_button1;
-  GtkWidget *cancel_button1;
-  GtkWidget *help_button1;
-  GtkWidget *color_selection1;
-
-  colorselectiondialog1 = gtk_color_selection_dialog_new (_(&quot;Select Color&quot;));
-  gtk_window_set_resizable (GTK_WINDOW (colorselectiondialog1), FALSE);
-
-  ok_button1 = GTK_COLOR_SELECTION_DIALOG (colorselectiondialog1)-&gt;ok_button;
-  gtk_widget_show (ok_button1);
-  GTK_WIDGET_SET_FLAGS (ok_button1, GTK_CAN_DEFAULT);
-
-  cancel_button1 = GTK_COLOR_SELECTION_DIALOG (colorselectiondialog1)-&gt;cancel_button;
-  gtk_widget_show (cancel_button1);
-  GTK_WIDGET_SET_FLAGS (cancel_button1, GTK_CAN_DEFAULT);
-
-  help_button1 = GTK_COLOR_SELECTION_DIALOG (colorselectiondialog1)-&gt;help_button;
-  gtk_widget_show (help_button1);
-  GTK_WIDGET_SET_FLAGS (help_button1, GTK_CAN_DEFAULT);
-
-  color_selection1 = GTK_COLOR_SELECTION_DIALOG (colorselectiondialog1)-&gt;colorsel;
-  gtk_widget_show (color_selection1);
-  gtk_color_selection_set_has_opacity_control (GTK_COLOR_SELECTION (color_selection1), FALSE);
-
-  /* Store pointers to all widgets, for use by lookup_widget(). */
-  GLADE_HOOKUP_OBJECT_NO_REF (colorselectiondialog1, colorselectiondialog1, &quot;colorselectiondialog1&quot;);
-  GLADE_HOOKUP_OBJECT_NO_REF (colorselectiondialog1, ok_button1, &quot;ok_button1&quot;);
-  GLADE_HOOKUP_OBJECT_NO_REF (colorselectiondialog1, cancel_button1, &quot;cancel_button1&quot;);
-  GLADE_HOOKUP_OBJECT_NO_REF (colorselectiondialog1, help_button1, &quot;help_button1&quot;);
-  GLADE_HOOKUP_OBJECT_NO_REF (colorselectiondialog1, color_selection1, &quot;color_selection1&quot;);
-
-  return colorselectiondialog1;
-}
-

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_srt.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_srt.cpp	2007-05-26 15:12:41 UTC (rev 3150)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_srt.cpp	2007-05-27 09:12:35 UTC (rev 3151)
@@ -55,424 +55,173 @@
 #define MODULE_NAME MODULE_FILTER
 #include &quot;ADM_osSupport/ADM_debug.h&quot;
 
-#include &quot;prototype.h&quot;
-#include &quot;prefs.h&quot;
 #include &lt;ADM_assert.h&gt;
+#include &quot;DIA_flyDialog.h&quot;
+#include &quot;DIA_flySrtPos.h&quot;
 
 
-    
-typedef struct unicd
-{
-	char *display,*name;
-}unicd;
-#define CHECKSPIN(x,y) y= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(x)) ;
-//
-//	If you want to add languages just add them here, nothing else to do
-//	First is the displayed name, second is the iconv --list name use internally
-//
-static unicd  names[]=
-{
-	{(char *)&quot;Ascii&quot;	,(char *)&quot;ISO-8859-1&quot;},
-	{(char *)&quot;Cyrillic&quot;	,(char *)&quot;WINDOWS-1251&quot;}, // ru
-	{(char *)&quot;Czech&quot;	,(char *)&quot;ISO-8859-2&quot;},	// cz
-	{(char *)&quot;German&quot;	,(char *)&quot;ISO-8859-9&quot;}		// german ?
-	,{(char *)&quot;Slovene&quot;	,(char *)&quot;CP1250&quot;}		// UTF8
-	,{(char *)&quot;UTF8&quot;	,(char *)&quot;UTF8&quot;}		// UTF8
-	,{(char *)&quot;Chinese Traditionnal(Big5)&quot;	,(char *)&quot;CP950&quot;}		// UTF8
-	,{(char *)&quot;Chinese Simplified (GB2312)&quot;	,(char *)&quot;CP936&quot;}		// UTF8
-};
-
-
-
-static void on_callback_sub(GtkButton * button, gpointer user_data);
-static void on_callback_font(GtkButton * button, gpointer user_data);
-static void on_callback_color(GtkButton * button, gpointer user_data);
-
-static gboolean on_slider( void );
-
-static void indexSUB(char *name);
-static void update(uint32_t value);
-static void read(void);
-
-static GtkWidget* create_dialog1 (void);
-static GtkWidget *dialog=NULL;
-static GtkWidget *drawing=NULL;
-static GtkAdjustment *sliderAdjustment;
-
-static uint32_t glob_font=0;
-static uint32_t glob_base=0;
-
-
-static int  GUI_subtitleParam(char *font,char *sub,int  *charset,int *size,uint32_t *baseline,
-                              int32_t *coly,int32_t *colu,int32_t *colv,uint32_t *autocut,int32_t *delay
-			      ,uint32_t *bg);
-
+static void read( void );
+static void upload ( void );
+static gboolean slider_update( void );
+static gboolean gui_update( void);
 static gboolean gui_draw( void );
-static void draw( void);
+static GtkWidget *create_dialog1 (void);
 
-#define MAX_STRING 300
-static char subString[MAX_STRING];
-static char fontString[MAX_STRING];
-
-static ADMImage  *sourceImage=NULL;
-static uint8_t *targetImage=NULL;
-static uint8_t *targetImageRGB=NULL;
-
-static uint32_t _w,_h;
-static int32_t myY,myU,myV;
-
-extern int DIA_colorSel(uint8_t *r, uint8_t *g, uint8_t *b);
-ColYuvRgb *rgbConv=NULL;
-
-
-uint8_t DIA_srt(ADMImage *source, SUBCONF *param)
+static GtkWidget *dialog=NULL;
+static flySrtPos *myCrop=NULL;
+static int lock=0;
+/**
+      \fn DIA_srtPos
+      \brief Dialog that handles subtitle size and position
+*/
+int DIA_srtPos(AVDMGenericVideoStream *in,uint32_t *size,uint32_t *position)
 {
-
-//char c;
-uint8_t ret=0;
-int charset=0;
-uint32_t l,f;
-
-          // look up old one
-          if(param-&gt;_charset)
-          {
-                  for(uint32_t j=0;j&lt;sizeof(names)/sizeof(unicd);j++)
-                    if(!strcmp(param-&gt;_charset,names[j].name)) charset=j;
-          }
-          _w=source-&gt;_width;
-          _h=source-&gt;_height;
-
-          sourceImage     =source;
-          targetImage     =new uint8_t[_w*_h*2];
-          targetImageRGB  =new uint8_t[_w*_h*4];
-
-          rgbConv=new ColYuvRgb(_w,_h);
-          rgbConv-&gt;reset(_w,_h);
-          //*****************************
-          ret= GUI_subtitleParam( (char *)param-&gt;_fontname,
-                        (char *)param-&gt;_subname,
-                        &amp;charset,
-                        (int *)&amp;param-&gt;_fontsize,
-                        &amp;(param-&gt;_baseLine),
-                        &amp;(param-&gt;_Y_percent),
-                        &amp;(param-&gt;_U_percent),
-                        &amp;(param-&gt;_V_percent),
-                        &amp;(param-&gt;_selfAdjustable),
-                        &amp;(param-&gt;_delay),
-                        &amp;(param-&gt;_useBackgroundColor));
-
-          //*****************************
-          delete [] targetImage;
-          delete [] targetImageRGB;
-
-          targetImage=targetImageRGB=NULL;
-          delete rgbConv;
-          rgbConv=NULL;
-
-          if(ret==1)
-          {
-            if(charset&lt;(int)(sizeof(names)/sizeof(unicd)))
-            {
-                strcpy(param-&gt;_charset,names[charset].name    );
-                printf(&quot;\n Charset : %s\n&quot;,   names[charset].name    );
-            } 
-          }
-    
-}
-
-int  GUI_subtitleParam(char *font,char *sub,int  *charset,int *size,uint32_t *baseline,
-                       int32_t *coly,int32_t *colu,int32_t *colv,uint32_t *autocut,int32_t *delay,
-		       uint32_t *bgcolor)
-{
-
+  uint8_t ret=0;
   
+        uint32_t width,height;
 
-int ret=0;
-gint answer;
-#define WID(x) lookup_widget(dialog,#x)
-#define CHECK_GET(x,y) {y=gtk_toggle_button_get_active( GTK_TOGGLE_BUTTON(WID(x)));}
-#define CHECK_SET(x,y) {gtk_toggle_button_set_active( GTK_TOGGLE_BUTTON(WID(x)),y);}		
+        // Allocate space for green-ised video
+        width=in-&gt;getInfo()-&gt;width;
+        height=in-&gt;getInfo()-&gt;height;
 
-	printf(&quot;In:Y:%d U:%d V:%d\n&quot;,*coly,*colu,*colv);
-
-       	dialog = create_dialog1();
-	    gtk_register_dialog(dialog);
+        dialog=create_dialog1();
+        gtk_register_dialog(dialog);
+        
+        gtk_widget_set_usize(WID(drawingarea1), width,height);
+        gtk_window_set_title (GTK_WINDOW (dialog), _(&quot;Subtitle Size and Position&quot;));
+        gtk_widget_show(dialog);
 	
-	if(sub)    	strcpy( subString, sub);
-	if(font) 	 strcpy( fontString, font);
+        myCrop=new flySrtPos( width, height,in,WID(drawingarea1),WID(hscale1));
+        myCrop-&gt;param.fontSize=*size;
+        myCrop-&gt;param.position=*position;
+        
+           gtk_range_set_range(GTK_RANGE(WID(vscale1)),0,height-1);
+        
+        
+        myCrop-&gt;upload();
+        myCrop-&gt;sliderChanged();
+        
+        gtk_signal_connect(GTK_OBJECT(WID(drawingarea1)), &quot;expose_event&quot;,
+            GTK_SIGNAL_FUNC(gui_draw),
+            NULL);
+        
+        gtk_signal_connect (GTK_OBJECT(WID( spinbutton1)), &quot;value_changed&quot;,
+                    GTK_SIGNAL_FUNC (gui_update),
+                    NULL);
+        
+         gtk_signal_connect (GTK_OBJECT(WID( hscale1)), &quot;value_changed&quot;,
+                    GTK_SIGNAL_FUNC (slider_update),
+                    NULL);
 
-	myY=*coly;
-	myU=*colu;
-	myV=*colv;
+          gtk_signal_connect (GTK_OBJECT(WID( vscale1)), &quot;value_changed&quot;,
+                    GTK_SIGNAL_FUNC (gui_update),
+                    NULL);
+       
+        ret=0;
+        int response;
+        response=gtk_dialog_run(GTK_DIALOG(dialog));
 
-
-
-        gtk_label_set_text(GTK_LABEL(WID(label_sub)),sub);
-        gtk_label_set_text(GTK_LABEL(WID(label_font)),font);
-        gtk_spin_button_set_value(GTK_SPIN_BUTTON(WID(spinbutton_fontsize)),(gfloat)*size) ;
-	CHECK_SET(checkbutton_autosplit,*autocut);
-	CHECK_SET(checkbuttonbg,*bgcolor);
-	
-	gtk_write_entry(WID(entry_delay), *delay);
-	
-	int nb=sizeof(names)/sizeof(unicd);
-
-	GtkWidget *w;
-	for(uint32_t j=1;j&lt;(uint32_t)nb;j++)
-	{
-
- 		w = gtk_menu_item_new_with_mnemonic ( names[j].display  );
-  		gtk_widget_show (w);
-  		gtk_container_add (GTK_CONTAINER (WID(menu1)),w);
-	}
-
-	 gtk_option_menu_set_history (GTK_OPTION_MENU (WID(optionmenu1)), *charset);
-
-  	 gtk_signal_connect(GTK_OBJECT(WID(button_sub)), &quot;clicked&quot;,
-		       GTK_SIGNAL_FUNC(on_callback_sub), (void *) 1);
-     	gtk_signal_connect(GTK_OBJECT(WID(button_font)), &quot;clicked&quot;,
-		       GTK_SIGNAL_FUNC(on_callback_font), (void *) 1);
-
- 	gtk_signal_connect(GTK_OBJECT(WID(button_color)), &quot;clicked&quot;,
-		       GTK_SIGNAL_FUNC(on_callback_color), (void *) 1);
-
-	// Draw a green square to show where it's gonna be
-	CHECKSPIN( WID(spinbutton_fontsize),glob_font);
-
-
-	drawing=WID(drawingarea1);
-
-	gtk_widget_set_usize(drawing, _w,_h);
-
-	gtk_widget_show(dialog);
-
-	glob_font=*size;
-	glob_base=*baseline;
-
-	sliderAdjustment=gtk_range_get_adjustment (GTK_RANGE(WID(vscale1)));
-  	gtk_adjustment_set_value( GTK_ADJUSTMENT(sliderAdjustment),(  gdouble  ) glob_base );
-/*-------*/
-
-	gtk_signal_connect(GTK_OBJECT(sliderAdjustment),&quot;value_changed&quot;, \
-		       GTK_SIGNAL_FUNC(on_slider), NULL);
-
-
-/*-------*/
-
-
-	update(*baseline);
-	draw();
-
-	 gtk_signal_connect(GTK_OBJECT(WID(drawingarea1)), &quot;expose_event&quot;,
-		       GTK_SIGNAL_FUNC(gui_draw),
-		       NULL);
-
-	ret=0;
-	gtk_register_dialog(dialog);
-	while( (answer=gtk_dialog_run(GTK_DIALOG(dialog)))==GTK_RESPONSE_APPLY)
-	{
-		read();
-		update(glob_base);
-		draw();
-	}
-	gtk_unregister_dialog(dialog);
-	if(answer==GTK_RESPONSE_OK)
-	{
-				strcpy(sub,subString);
-				strcpy(font,fontString);
-				*charset= getRangeInMenu(WID(optionmenu1));;
-
-          			read();
-				*size=glob_font;
-				*baseline=glob_base;
-
-				*coly=myY;
-				*colu=myU;
-				*colv=myV;
-				printf(&quot;Y:%d U:%d V:%d\n&quot;,*coly,*colu,*colv);
-				CHECK_GET(checkbutton_autosplit,*autocut);
-				CHECK_GET(checkbuttonbg,*bgcolor);
-				*delay= (int32_t)gtk_read_entry(WID(entry_delay));
-				ret=1;
-	}
-	gtk_unregister_dialog(dialog);
-	gtk_widget_destroy(dialog);
-	dialog=NULL;
-	return ret;
-
+        if(response==GTK_RESPONSE_OK)
+        {
+            myCrop-&gt;download();
+            *size=myCrop-&gt;param.fontSize;
+            *position=myCrop-&gt;param.position;
+            ret=1;
+        }
+        gtk_unregister_dialog(dialog);
+        gtk_widget_destroy(dialog);
+        delete myCrop;
+        return ret;
 }
-void on_callback_color(GtkButton * button, gpointer user_data)
+/**********************************/
+void read( void )
 {
-	uint8_t r,g,b;
-	uint8_t y;
-	int8_t u,v;
-
-		y=(myY);
-		u=(myU);
-		v=(myV);
-
-
-	aprintf(&quot;YUV: %d %d %d \n&quot;,y,u,v);
-	COL_YuvToRgb(   y,  u,  v, &amp;b,&amp;g,&amp;r);
-	aprintf(&quot;RGB %d %d %d --&gt;\n\n&quot;,r,g,b);
-
-
-	if(DIA_colorSel(&amp;r,&amp;g,&amp;b))
-	{
-		aprintf(&quot;RGB %d %d %d --&gt;\n&quot;,r,g,b);
-		COL_RgbToYuv(b,  g,  r, &amp;y, &amp;u,&amp;v);
-		aprintf(&quot;YUV:%d %d %d \n&quot;,y,u,v);
-		myY=y;
-		myU=(u);
-		myV=(v);
-
-		if(abs(myU)&lt;2) myU=0;
-		if(abs(myV)&lt;2) myV=0;
-
-	}
-
+	myCrop-&gt;download();
 }
-
-gboolean on_slider( void )
+gboolean slider_update( void )
 {
-		read();
-		update(glob_base);
-		draw();
-	return TRUE;
+        myCrop-&gt;sliderChanged();
+        return true;
 }
-void on_callback_sub(GtkButton * button, gpointer user_data)
+gboolean gui_update( void)
 {
-	      UNUSED_ARG(button);
-	UNUSED_ARG(user_data);
-        //GUI_FileSelRead(&quot;TTF font to use&quot;, fontCB);
-        FileSel_SelectRead(_(&quot;Subtitle to load&quot;), subString,
-		MAX_STRING,subString);
-	gtk_label_set_text(GTK_LABEL(WID(label_sub)),subString);
+  if(lock) return true;
+      myCrop-&gt;update();
+  return true;
 }
-
-void on_callback_font(GtkButton * button, gpointer user_data)
-{
-        UNUSED_ARG(button);
-	UNUSED_ARG(user_data);
-        //GUI_FileSelRead(&quot;TTF font to use&quot;, fontCB);
-        FileSel_SelectRead(_(&quot;TTF font to use&quot;), fontString,
-		MAX_STRING,fontString);
-	gtk_label_set_text(GTK_LABEL(WID(label_font)),fontString);
-	
-}
-/*--------------------------------------*/
 gboolean gui_draw( void )
 {
-	draw();
+	myCrop-&gt;display();
 	return true;
 }
-void draw (void  )
-{
-	GUI_RGBDisplay(targetImageRGB, _w,_h, (void *)drawing);
-}
 
-void read ( void )
-{
+/******************************/
+#define SPIN_GET(x,y) {y= gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(lookup_widget(dialog,#x))) ;\
+				printf(#x&quot;:%d\n&quot;, y);}
 
-	// Draw a green square to show where it's gonna be
-	CHECKSPIN( WID(spinbutton_fontsize),glob_font);
+#define SPIN_SET(x,y)  {gtk_spin_button_set_value(GTK_SPIN_BUTTON(lookup_widget(dialog,#x)),(gfloat)y) ; printf(#x&quot;:%d\n&quot;, y);}
 
-	glob_base=(uint32_t)GTK_ADJUSTMENT(sliderAdjustment)-&gt;value;
 
-	if(glob_base&lt;1) glob_base=1;
-	if(glob_base&gt;(_h - glob_font*SRT_MAX_LINE)) glob_base=_h - glob_font*SRT_MAX_LINE;
-
-
+uint8_t    flySrtPos::upload(void)
+{
+        SPIN_SET(spinbutton1,param.fontSize);
+        
+        int32_t max=_h;
+        max-=(SRT_MAX_LINE)*param.fontSize;
+        if(max&lt;0) max=0;
+        if(param.position&gt;=max)
+        {
+          param.position=max;
+        }
+        
+        GtkAdjustment *adj=gtk_range_get_adjustment (GTK_RANGE(WID(vscale1)));
+        GTK_ADJUSTMENT(adj)-&gt;value=param.position;
+        return 1;
 }
-
-/*
-	Add our stuff and display the result
-*/
-void update(uint32_t value)
+uint8_t    flySrtPos::download(void)
 {
-uint32_t h;
-uint32_t page=_w*_h;
-	//printf(&quot;\n Updating with %lu base line\n&quot;,value);
-	// grab it
-	
-	memcpy(targetImage,YPLANE(sourceImage),(_w*_h));
-	memcpy(targetImage+page,UPLANE(sourceImage),(_w*_h)&gt;&gt;2);
-	memcpy(targetImage+((page*5)&gt;&gt;2),VPLANE(sourceImage),(_w*_h)&gt;&gt;2);
-	
-	h=glob_font;
-	if(h&gt;8) h-=4;
-
-	for(uint32_t line=0;line&lt;SRT_MAX_LINE;line++)
-	{
-		uint8_t *src=targetImage+(glob_base+line*glob_font)*_w;
-
-		for(uint32_t y=0;y&lt;h;y+=2)
-		{
-			memset(src,255,_w);
-			src+=2*_w;
-		}
-	}
-	// convert to rgb
-	//ADM_assert(COL_yv12rgb(_w,_h,targetImage,targetImageRGB));
-	rgbConv-&gt;scale(targetImage,targetImageRGB);
-
+        SPIN_GET(spinbutton1,param.fontSize);
+        GtkAdjustment *adj=gtk_range_get_adjustment (GTK_RANGE(WID(vscale1)));
+        param.position=(uint32_t)GTK_ADJUSTMENT(adj)-&gt;value;
+        
+        int32_t max=_h;
+        max-=(SRT_MAX_LINE)*param.fontSize;
+        if(max&lt;0) max=0;
+        if(param.position&gt;=max)
+        {
+          param.position=max;
+          upload(); 
+        }
+        
+        return 1;
 }
 
-
 /*
 	Almost straigh out of glade2
 
 */
 
-//-------------------------------
-
-
 GtkWidget*
 create_dialog1 (void)
 {
   GtkWidget *dialog1;
   GtkWidget *dialog_vbox1;
   GtkWidget *vbox1;
-  GtkWidget *table1;
-  GtkWidget *label1;
-  GtkWidget *label2;
-  GtkWidget *label3;
-  GtkWidget *label4;
   GtkWidget *hbox1;
-  GtkWidget *label_sub;
-  GtkWidget *button_sub;
-  GtkWidget *image1;
+  GtkWidget *label1;
+  GtkObject *spinbutton1_adj;
+  GtkWidget *spinbutton1;
+  GtkWidget *hscale1;
   GtkWidget *hbox2;
-  GtkWidget *label_font;
-  GtkWidget *button_font;
-  GtkWidget *image2;
-  GtkWidget *optionmenu1;
-  GtkWidget *menu1;
-  GtkWidget *enc_ascii;
-  /*
-  GtkWidget *enc_8859;
-  GtkWidget *ebc_cyrillic;
-  GtkWidget *enc_german;
-  */
-  GtkObject *spinbutton_fontsize_adj;
-  GtkWidget *spinbutton_fontsize;
-  GtkWidget *label5;
-  GtkWidget *hbox4;
-  GtkWidget *button_color;
-  GtkWidget *checkbutton_autosplit;
-  GtkWidget *label6;
-  GtkWidget *entry_delay;
-  GtkWidget *checkbuttonbg;
-  GtkWidget *hbox3;
   GtkWidget *drawingarea1;
   GtkWidget *vscale1;
   GtkWidget *dialog_action_area1;
   GtkWidget *cancelbutton1;
-  GtkWidget *applybutton1;
   GtkWidget *okbutton1;
 
   dialog1 = gtk_dialog_new ();
-  gtk_window_set_title (GTK_WINDOW (dialog1), _(&quot;Subtitle selector&quot;));
+  gtk_window_set_title (GTK_WINDOW (dialog1), _(&quot;Subtitle Size and Position&quot;));
+  gtk_window_set_type_hint (GTK_WINDOW (dialog1), GDK_WINDOW_TYPE_HINT_DIALOG);
 
   dialog_vbox1 = GTK_DIALOG (dialog1)-&gt;vbox;
   gtk_widget_show (dialog_vbox1);
@@ -481,164 +230,36 @@
   gtk_widget_show (vbox1);
   gtk_box_pack_start (GTK_BOX (dialog_vbox1), vbox1, TRUE, TRUE, 0);
 
-  table1 = gtk_table_new (7, 2, FALSE);
-  gtk_widget_show (table1);
-  gtk_box_pack_start (GTK_BOX (vbox1), table1, TRUE, TRUE, 0);
-
-  label1 = gtk_label_new (_(&quot;Subtitle file &quot;));
-  gtk_widget_show (label1);
-  gtk_table_attach (GTK_TABLE (table1), label1, 0, 1, 0, 1,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label1), 0, 0.5);
-
-  label2 = gtk_label_new (_(&quot;Font (TTF)&quot;));
-  gtk_widget_show (label2);
-  gtk_table_attach (GTK_TABLE (table1), label2, 0, 1, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label2), 0, 0.5);
-
-  label3 = gtk_label_new (_(&quot;Encoding &quot;));
-  gtk_widget_show (label3);
-  gtk_table_attach (GTK_TABLE (table1), label3, 0, 1, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label3), 0, 0.5);
-
-  label4 = gtk_label_new (_(&quot;Font Size&quot;));
-  gtk_widget_show (label4);
-  gtk_table_attach (GTK_TABLE (table1), label4, 0, 1, 3, 4,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label4), 0, 0.5);
-
   hbox1 = gtk_hbox_new (FALSE, 0);
   gtk_widget_show (hbox1);
-  gtk_table_attach (GTK_TABLE (table1), hbox1, 1, 2, 0, 1,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (GTK_FILL), 0, 0);
+  gtk_box_pack_start (GTK_BOX (vbox1), hbox1, FALSE, FALSE, 0);
 
-  label_sub = gtk_label_new (_(&quot;sub&quot;));
-  gtk_widget_show (label_sub);
-  gtk_box_pack_start (GTK_BOX (hbox1), label_sub, TRUE, FALSE, 0);
+  label1 = gtk_label_new (_(&quot;Font Size:&quot;));
+  gtk_widget_show (label1);
+  gtk_box_pack_start (GTK_BOX (hbox1), label1, FALSE, FALSE, 0);
 
-  button_sub = gtk_button_new ();
-  gtk_widget_show (button_sub);
-  gtk_box_pack_start (GTK_BOX (hbox1), button_sub, FALSE, FALSE, 0);
+  spinbutton1_adj = gtk_adjustment_new (1, 6, 99, 1, 10, 10);
+  spinbutton1 = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton1_adj), 1, 2);
+  gtk_widget_show (spinbutton1);
+  gtk_box_pack_start (GTK_BOX (hbox1), spinbutton1, FALSE, FALSE, 0);
+  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton1), TRUE);
 
-  image1 = gtk_image_new_from_stock (&quot;gtk-open&quot;, GTK_ICON_SIZE_BUTTON);
-  gtk_widget_show (image1);
-  gtk_container_add (GTK_CONTAINER (button_sub), image1);
+  hscale1 = gtk_hscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 0, 99, 1, 1, 1)));
+  gtk_widget_show (hscale1);
+  gtk_box_pack_start (GTK_BOX (vbox1), hscale1, FALSE, FALSE, 0);
 
   hbox2 = gtk_hbox_new (FALSE, 0);
   gtk_widget_show (hbox2);
-  gtk_table_attach (GTK_TABLE (table1), hbox2, 1, 2, 1, 2,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (GTK_FILL), 0, 0);
+  gtk_box_pack_start (GTK_BOX (vbox1), hbox2, TRUE, TRUE, 0);
 
-  label_font = gtk_label_new (_(&quot;font&quot;));
-  gtk_widget_show (label_font);
-  gtk_box_pack_start (GTK_BOX (hbox2), label_font, TRUE, FALSE, 0);
-
-  button_font = gtk_button_new ();
-  gtk_widget_show (button_font);
-  gtk_box_pack_start (GTK_BOX (hbox2), button_font, FALSE, FALSE, 0);
-
-  image2 = gtk_image_new_from_stock (&quot;gtk-open&quot;, GTK_ICON_SIZE_BUTTON);
-  gtk_widget_show (image2);
-  gtk_container_add (GTK_CONTAINER (button_font), image2);
-
-  optionmenu1 = gtk_option_menu_new ();
-  gtk_widget_show (optionmenu1);
-  gtk_table_attach (GTK_TABLE (table1), optionmenu1, 1, 2, 2, 3,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  menu1 = gtk_menu_new ();
-
-  enc_ascii = gtk_menu_item_new_with_mnemonic (_(&quot;Ascii&quot;));
-  gtk_widget_show (enc_ascii);
-  gtk_container_add (GTK_CONTAINER (menu1), enc_ascii);
-/*
-  enc_8859 = gtk_menu_item_new_with_mnemonic (_(&quot;Iso 8859-1 (Czech...)&quot;));
-  gtk_widget_show (enc_8859);
-  gtk_container_add (GTK_CONTAINER (menu1), enc_8859);
-
-  ebc_cyrillic = gtk_menu_item_new_with_mnemonic (_(&quot;Cyrillic&quot;));
-  gtk_widget_show (ebc_cyrillic);
-  gtk_container_add (GTK_CONTAINER (menu1), ebc_cyrillic);
-
-  enc_german = gtk_menu_item_new_with_mnemonic (_(&quot;German&quot;));
-  gtk_widget_show (enc_german);
-  gtk_container_add (GTK_CONTAINER (menu1), enc_german);
-*/
-  gtk_option_menu_set_menu (GTK_OPTION_MENU (optionmenu1), menu1);
-
-  spinbutton_fontsize_adj = gtk_adjustment_new (26, 8, 100, 1, 10, 10);
-  spinbutton_fontsize = gtk_spin_button_new (GTK_ADJUSTMENT (spinbutton_fontsize_adj), 1, 0);
-  gtk_widget_show (spinbutton_fontsize);
-  gtk_table_attach (GTK_TABLE (table1), spinbutton_fontsize, 1, 2, 3, 4,
-                    (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_spin_button_set_numeric (GTK_SPIN_BUTTON (spinbutton_fontsize), TRUE);
-
-  label5 = gtk_label_new (_(&quot;Select color&quot;));
-  gtk_widget_show (label5);
-  gtk_table_attach (GTK_TABLE (table1), label5, 0, 1, 4, 5,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label5), 0, 0.5);
-
-  hbox4 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox4);
-  gtk_table_attach (GTK_TABLE (table1), hbox4, 1, 2, 4, 5,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (GTK_FILL), 0, 0);
-
-  button_color = gtk_button_new_with_mnemonic (_(&quot;Select&quot;));
-  gtk_widget_show (button_color);
-  gtk_box_pack_start (GTK_BOX (hbox4), button_color, FALSE, FALSE, 0);
-
-  checkbutton_autosplit = gtk_check_button_new_with_mnemonic (_(&quot;Auto split&quot;));
-  gtk_widget_show (checkbutton_autosplit);
-  gtk_table_attach (GTK_TABLE (table1), checkbutton_autosplit, 0, 1, 5, 6,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  label6 = gtk_label_new (_(&quot;Delay in ms&quot;));
-  gtk_widget_show (label6);
-  gtk_table_attach (GTK_TABLE (table1), label6, 0, 1, 6, 7,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_misc_set_alignment (GTK_MISC (label6), 0, 0.5);
-
-  entry_delay = gtk_entry_new ();
-  gtk_widget_show (entry_delay);
-  gtk_table_attach (GTK_TABLE (table1), entry_delay, 1, 2, 6, 7,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-  gtk_widget_set_size_request (entry_delay, 90, -1);
-  gtk_entry_set_text (GTK_ENTRY (entry_delay), _(&quot;0&quot;));
-
-  checkbuttonbg = gtk_check_button_new_with_mnemonic (_(&quot;Force background&quot;));
-  gtk_widget_show (checkbuttonbg);
-  gtk_table_attach (GTK_TABLE (table1), checkbuttonbg, 1, 2, 5, 6,
-                    (GtkAttachOptions) (GTK_FILL),
-                    (GtkAttachOptions) (0), 0, 0);
-
-  hbox3 = gtk_hbox_new (FALSE, 0);
-  gtk_widget_show (hbox3);
-  gtk_box_pack_start (GTK_BOX (vbox1), hbox3, TRUE, TRUE, 0);
-
   drawingarea1 = gtk_drawing_area_new ();
   gtk_widget_show (drawingarea1);
-  gtk_box_pack_start (GTK_BOX (hbox3), drawingarea1, TRUE, TRUE, 0);
-  gtk_widget_set_size_request (drawingarea1, 352, 288);
+  gtk_box_pack_start (GTK_BOX (hbox2), drawingarea1, TRUE, TRUE, 0);
 
-  vscale1 = gtk_vscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 1, 576, 1, 1, 1)));
+  vscale1 = gtk_vscale_new (GTK_ADJUSTMENT (gtk_adjustment_new (0, 100, 1, 1, 1, 1)));
   gtk_widget_show (vscale1);
-  gtk_box_pack_start (GTK_BOX (hbox3), vscale1, FALSE, TRUE, 0);
+  gtk_box_pack_start (GTK_BOX (hbox2), vscale1, FALSE, FALSE, 0);
+  gtk_scale_set_digits (GTK_SCALE (vscale1), 0);
 
   dialog_action_area1 = GTK_DIALOG (dialog1)-&gt;action_area;
   gtk_widget_show (dialog_action_area1);
@@ -649,11 +270,6 @@
   gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), cancelbutton1, GTK_RESPONSE_CANCEL);
   GTK_WIDGET_SET_FLAGS (cancelbutton1, GTK_CAN_DEFAULT);
 
-  applybutton1 = gtk_button_new_from_stock (&quot;gtk-apply&quot;);
-  gtk_widget_show (applybutton1);
-  gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), applybutton1, GTK_RESPONSE_APPLY);
-  GTK_WIDGET_SET_FLAGS (applybutton1, GTK_CAN_DEFAULT);
-
   okbutton1 = gtk_button_new_from_stock (&quot;gtk-ok&quot;);
   gtk_widget_show (okbutton1);
   gtk_dialog_add_action_widget (GTK_DIALOG (dialog1), okbutton1, GTK_RESPONSE_OK);
@@ -663,44 +279,19 @@
   GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog1, &quot;dialog1&quot;);
   GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_vbox1, &quot;dialog_vbox1&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, vbox1, &quot;vbox1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, table1, &quot;table1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label1, &quot;label1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label2, &quot;label2&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label3, &quot;label3&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label4, &quot;label4&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, hbox1, &quot;hbox1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label_sub, &quot;label_sub&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, button_sub, &quot;button_sub&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, image1, &quot;image1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, label1, &quot;label1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, spinbutton1, &quot;spinbutton1&quot;);
+  GLADE_HOOKUP_OBJECT (dialog1, hscale1, &quot;hscale1&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, hbox2, &quot;hbox2&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label_font, &quot;label_font&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, button_font, &quot;button_font&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, image2, &quot;image2&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, optionmenu1, &quot;optionmenu1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, menu1, &quot;menu1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, enc_ascii, &quot;enc_ascii&quot;);
-  /*
-  GLADE_HOOKUP_OBJECT (dialog1, enc_8859, &quot;enc_8859&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, ebc_cyrillic, &quot;ebc_cyrillic&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, enc_german, &quot;enc_german&quot;);
-  */
-  GLADE_HOOKUP_OBJECT (dialog1, spinbutton_fontsize, &quot;spinbutton_fontsize&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label5, &quot;label5&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hbox4, &quot;hbox4&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, button_color, &quot;button_color&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, checkbutton_autosplit, &quot;checkbutton_autosplit&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, label6, &quot;label6&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, entry_delay, &quot;entry_delay&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, checkbuttonbg, &quot;checkbuttonbg&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, hbox3, &quot;hbox3&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, drawingarea1, &quot;drawingarea1&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, vscale1, &quot;vscale1&quot;);
   GLADE_HOOKUP_OBJECT_NO_REF (dialog1, dialog_action_area1, &quot;dialog_action_area1&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, cancelbutton1, &quot;cancelbutton1&quot;);
-  GLADE_HOOKUP_OBJECT (dialog1, applybutton1, &quot;applybutton1&quot;);
   GLADE_HOOKUP_OBJECT (dialog1, okbutton1, &quot;okbutton1&quot;);
 
   return dialog1;
 }
 
+//-------------------------------
 #endif //FREETYPE

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am	2007-05-26 15:12:41 UTC (rev 3150)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/Makefile.am	2007-05-27 09:12:35 UTC (rev 3151)
@@ -12,7 +12,7 @@
 	DIA_properties.cpp  DIA_about.cpp DIA_recent.cpp \
 	DIA_resize.cpp DIA_working.cpp \
 	DIA_working.h DIA_busy.cpp DIA_busy.h DIA_exLame.cpp DIA_pipe.cpp  \
-	DIA_xvid.cpp DIA_crop.cpp DIA_color.cpp DIA_encoding.cpp   \
+	DIA_xvid.cpp DIA_crop.cpp  DIA_encoding.cpp   \
 	DIA_xvid4.cpp  \
 	DIA_pause.cpp \
 	DIA_calculator.cpp DIA_equalizer.cpp \

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/DIA_color.cpp (from rev 3098, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialog/DIA_color.cpp)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_button.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_button.cpp	2007-05-26 15:12:41 UTC (rev 3150)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/FAC_button.cpp	2007-05-27 09:12:35 UTC (rev 3151)
@@ -27,8 +27,8 @@
 #include &quot;ADM_commonUI/DIA_factory.h&quot;
 #include &quot;ADM_assert.h&quot;
 
+static void cb_button (GtkWidget *widget,gpointer callback_data);
 
-
 diaElemButton:: diaElemButton(const char *toggleTitle, ADM_FAC_CALLBACK *cb,void *cookie,const char *tip)
   : diaElem(ELEM_BUTTON)
 {
@@ -37,6 +37,7 @@
   this-&gt;tip=tip;
   _cookie=cookie;
   _callBack=cb;
+  
 }
 
 diaElemButton::~diaElemButton()
@@ -54,8 +55,9 @@
                     (GtkAttachOptions) (GTK_EXPAND | GTK_FILL),
                     (GtkAttachOptions) (0), 0, 0);
   /* Add callback ...*/
+  
   g_signal_connect(GTK_OBJECT(button), &quot;clicked&quot;,
-                    GTK_SIGNAL_FUNC(_callBack),  _cookie);
+                    GTK_SIGNAL_FUNC(cb_button),  this);
   myWidget=button;
 }
 void diaElemButton::getMe(void)
@@ -67,5 +69,10 @@
   gtk_widget_set_sensitive(GTK_WIDGET(myWidget),onoff);  
 }
 
+void cb_button (GtkWidget *widget,gpointer callback_data)
+{
+  diaElemButton *button=(diaElemButton *)callback_data;
+  button-&gt;_callBack(button-&gt;_cookie);
+}
 
 //EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-05-26 15:12:41 UTC (rev 3150)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_GTK/ADM_dialogFactory/Makefile.am	2007-05-27 09:12:35 UTC (rev 3151)
@@ -20,6 +20,7 @@
 FAC_notch.cpp \
 FAC_frame.cpp \
 FAC_hex.cpp \
-FAC_button.cpp
+FAC_button.cpp \
+DIA_color.cpp
 
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2007-05-26 15:12:41 UTC (rev 3150)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_NONE/ADM_dialog/DIA_none.cpp	2007-05-27 09:12:35 UTC (rev 3151)
@@ -130,9 +130,13 @@
 uint8_t DIA_dnr(uint32_t *llock,uint32_t *lthresh, uint32_t *clock,
 			uint32_t *cthresh, uint32_t *scene) {return 0;}
 			
-uint8_t DIA_srt(ADMImage *source, SUBCONF *param) {return 0;}			
+int DIA_srtPos(AVDMGenericVideoStream *source,uint32_t *size,uint32_t *position)
+{
+  return 0; 
+}
+
+int DIA_colorSel(uint8_t *r, uint8_t *g, uint8_t *b) {return 0;}			
 			
-			
 extern int global_argc;
 extern char **global_argv;
 int UI_Init(int nargc,char **nargv)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-05-26 15:12:41 UTC (rev 3150)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_none.cpp	2007-05-27 09:12:35 UTC (rev 3151)
@@ -88,7 +88,7 @@
 uint8_t DIA_job(uint32_t nb,char **name){return 0;}
 uint8_t DIA_videoCodec (SelectCodecType * codec){return 0;}
 uint8_t DIA_audioCodec( AUDIOENCODER *codec ) {return 0;}
-uint8_t DIA_srt(ADMImage *source, SUBCONF *param) {return 0;}			
+//uint8_t DIA_srt(ADMImage *source, SUBCONF *param) {return 0;}			
 uint8_t DIA_quota(char *) {return 0;}
 uint8_t  DIA_job_select(char **jobname, char **filename) {return 0;}
 //const char * GUI_getCustomScript(uint32_t nb) {return 0;}
@@ -97,5 +97,9 @@
 void    DIA_Calculator(uint32_t *sizeInMeg, uint32_t *avgBitrate ){return ;}
 uint8_t initFileSelector(void){return 0;}
 uint8_t initGUI( void ){return 1;}
+int DIA_colorSel(uint8_t *r, uint8_t *g, uint8_t *b) {return 0;}
+
+
+
 //EOF
 

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_srt.cpp (from rev 3123, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_x264.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_x264.cpp	2007-05-21 09:42:07 UTC (rev 3123)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/DIA_srt.cpp	2007-05-27 09:12:35 UTC (rev 3151)
@@ -0,0 +1,163 @@
+
+// Author: mean &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>&gt;, (C) 2007
+//
+// Copyright: See COPYING file that comes with this distribution
+//
+//
+#include &quot;config.h&quot;
+
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+#include &lt;ADM_assert.h&gt;
+#include &lt;math.h&gt;
+#include &lt;iconv.h&gt;
+#include &quot;default.h&quot;
+
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+
+#include &quot;ADM_userInterfaces/ADM_commonUI/DIA_factory.h&quot;
+#include &quot;ADM_assert.h&quot; 
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+#include &quot;ADM_toolkit/filesel.h&quot;
+
+
+
+#include &quot;ADM_editor/ADM_edit.hxx&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+
+#include &quot;ADM_encoder/ADM_vidEncode.hxx&quot;
+#include &quot;ADM_video/ADM_vidFont.h&quot;
+#include &quot;ADM_video/ADM_vidSRT.h&quot;
+/**
+      \fn DIA_x264
+      \brief Dialog for x264 codec settings
+*/
+uint8_t DIA_srt(ADMImage *source, SUBCONF *param)
+{
+#if 0
+int b;
+int ret=0;
+int code;
+      ADM_x264Param localParam;
+      ADM_assert(config-&gt;extraSettingsLen==sizeof(localParam));
+      memcpy(&amp;localParam,config-&gt;extraSettings,sizeof(localParam));
+#define PX(x) &amp;(localParam.x)
+         
+      
+      // Our tabs
+         /* Tab 1 main */
+           diaElemBitrate bitrate(config,NULL);
+           bitrate.setMaxQz(51);
+           diaElem *main[]={&amp;bitrate};
+           diaElemTabs tabMain(&quot;Main&quot;,1,main);
+
+           
+        /* Tab 2 Motion */
+
+
+         diaMenuEntry partitionM[] = {
+                  {0,   _(&quot;1  - Extremely Low (Fastest)&quot;)}
+                ,{1,    _(&quot;2  - Very Low&quot;)}
+                ,{3,    _(&quot;3  - Low&quot;)}
+                ,{4,    _(&quot;4  - Medium&quot;)}
+                ,{5,    _(&quot;5  - High (Default)&quot;)}
+                ,{6,    _(&quot;6  - Very High&quot;)}
+                ,{7,    _(&quot;6B - Very High (RDO on Bframes)&quot;)}
+                ,{8,    _(&quot;7 - Ultra High&quot;)}
+                ,{9,    _(&quot;7B - Ultra High (RDO on Bframes)&quot;)}};
+
+                            
+        diaElemMenu parition(PX(PartitionDecision),_(&quot;Partition Decision&quot;),10,partitionM);
+        
+         diaMenuEntry meM[] = {
+                             {0,    _(&quot;Diamond search&quot;)},
+                             {1,    _(&quot;Hexagonal search&quot;)},
+                             {2,    _(&quot;Uneven multi hexagon&quot;)},
+                             {3,    _(&quot;Exhaustive search&quot;)}}
+                             ;
+         diaElemMenu      me(PX(Method),_(&quot;VHQ Mode&quot;),4,meM);
+         diaElemUInteger  rframe(PX(MaxRefFrames),_(&quot;Max Ref Frames&quot;),0,15);
+         diaElemUInteger  range(PX(Range),_(&quot;Max B Frames&quot;),0,64);
+         diaElemToggle    chromaMe(PX(ChromaME),_(&quot;Chroma ME&quot;));
+         diaElemToggle    mixedRef(PX(MixedRefs),_(&quot;Mixed Refs&quot;));
+         diaElemToggle    fastPSkip(PX(fastPSkip),_(&quot;Fast P Skip&quot;));
+         diaElemToggle    dctDecimate(PX(DCTDecimate),_(&quot;DCT Decimate&quot;));
+         diaElemToggle    interlaced(PX(interlaced),_(&quot;Interlaced&quot;));
+         
+         diaElemFrame  frameMe(_(&quot;Motion Estimation&quot;));
+         frameMe.swallow(&amp;parition);
+         frameMe.swallow(&amp;me);
+         frameMe.swallow(&amp;rframe);
+         frameMe.swallow(&amp;range);
+         frameMe.swallow(&amp;chromaMe);
+         frameMe.swallow(&amp;mixedRef);
+         frameMe.swallow(&amp;fastPSkip);
+         frameMe.swallow(&amp;dctDecimate);
+         frameMe.swallow(&amp;interlaced);
+         
+           diaElem *motions[]={&amp;frameMe};
+          diaElemTabs tabMotion(&quot;Motion&quot;,1,motions);
+         
+         
+        /* Tab3-Misc  */
+           diaMenuEntry trellisM[] = {
+                  {0,   _(&quot;Disabled&quot;)}
+                ,{1,    _(&quot;Low&quot;)}
+                ,{2,    _(&quot;High&quot;)}};
+           
+          diaElemMenu trellis(PX(Trellis),_(&quot;Trellis&quot;),3,trellisM);
+          diaElemToggle    cabac(PX(CABAC),_(&quot;CABAC&quot;));
+          diaElemUInteger  noise(PX(NoiseReduction),_(&quot;Noise Reduction&quot;),0,255);
+          diaElemToggle    deblock(PX(DeblockingFilter),_(&quot;Deblocking Filter&quot;));
+          diaElemInteger  deblockStrength(PX(Strength),_(&quot;Strength&quot;),-6,6);
+          diaElemInteger  deblockThreshold(PX(Threshold),_(&quot;Threshold&quot;),-6,6);
+          deblock.link(1,&amp;deblockStrength);
+          deblock.link(1,&amp;deblockThreshold);
+          
+          
+          diaElemFrame  frameMisc(_(&quot;Misc&quot;));
+          frameMisc.swallow(&amp;trellis);
+          frameMisc.swallow(&amp;cabac);
+          frameMisc.swallow(&amp;noise);
+          frameMisc.swallow(&amp;deblock);
+          frameMisc.swallow(&amp;deblockStrength);
+          frameMisc.swallow(&amp;deblockThreshold);
+            
+           diaElem *misc[]={&amp;frameMisc};
+          diaElemTabs tabMisc(&quot;Misc&quot;,1,misc);
+        /* Tab 4 Partition &amp; frame*/
+         
+             diaElemToggle    _8x8(PX(_8x8),_(&quot;8x8 Transform&quot;));
+             diaElemToggle    _8x8P(PX(_8x8P),_(&quot;8x8P Transform&quot;));
+             diaElemToggle    _8x8B(PX(_8x8B),_(&quot;8x8B Transform&quot;));
+             diaElemToggle    _4x4(PX(_4x4),_(&quot;_4x4 Transform&quot;));
+             diaElemToggle    _8x8I(PX(_8x8I),_(&quot;_8x8I Transform&quot;));
+             diaElemToggle    _4x4I(PX(_4x4I),_(&quot;_4x4I Transform&quot;));
+          diaElemFrame  frameTransform(_(&quot;Transform&quot;));
+           frameTransform.swallow(&amp;_8x8);
+           frameTransform.swallow(&amp;_8x8P);
+           frameTransform.swallow(&amp;_8x8B);
+           frameTransform.swallow(&amp;_4x4);
+           frameTransform.swallow(&amp;_8x8I);
+           frameTransform.swallow(&amp;_4x4I);
+          
+           diaElemUInteger  bframe(PX(MaxBFrame),_(&quot;Max B Frames&quot;),0,3);
+           diaElemFrame frameB(_(&quot;B Frames&quot;));
+           frameB.swallow(&amp;bframe);
+           
+            diaElem *bfr[]={&amp;frameTransform,&amp;frameB};
+          diaElemTabs tabTransform(_(&quot;Transform&quot;),2,bfr);
+           
+          /* End of tabs */
+        diaElemTabs *tabs[4]={&amp;tabMain,&amp;tabMotion,&amp;tabMisc,&amp;tabTransform};
+        if( diaFactoryRunTabs(_(&quot;X264 Configuration&quot;),4,tabs))
+	{
+           memcpy(config-&gt;extraSettings,&amp;localParam,sizeof(localParam));
+           return 1;
+        }
+#endif
+         return 0;
+}
+
+// EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Makefile.am	2007-05-26 15:12:41 UTC (rev 3150)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Makefile.am	2007-05-27 09:12:35 UTC (rev 3151)
@@ -5,7 +5,9 @@
 AQ_crop.cpp AT_QCanvas.cpp \
 AQ_asharp.cpp AQ_chromashift.cpp \
 AQ_contrast.cpp AQ_hue.cpp \
-AT_index_pg.cpp DIA_x264.cpp
+AQ_srt.cpp \
+AT_index_pg.cpp DIA_x264.cpp \
+DIA_srt.cpp
 
 INCLUDES = $(all_includes)  $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \
 		-I../../../ADM_libraries/ADM_utilities \

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_srt.cpp (from rev 3098, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_hue.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_hue.cpp	2007-05-15 15:15:31 UTC (rev 3098)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4/ADM_dialog/Q_srt.cpp	2007-05-27 09:12:35 UTC (rev 3151)
@@ -0,0 +1,180 @@
+/***************************************************************************
+                          Q_SRT.cpp  -  description
+                             -------------------
+
+    Handle the QT specific part of the fontsize &amp; position dialog box
+    copyright            : (C) 2002/2007 by mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include &lt;config.h&gt;
+#include &lt;string.h&gt;
+#include &lt;stdio.h&gt;
+#include &lt;math.h&gt;
+
+#define Ui_Dialog Ui_srtDialog
+#include &quot;ui_srt.h&quot;
+#undef Ui_Dialog
+
+#include &quot;default.h&quot;
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+#include &quot;ADM_image.h&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+#include &quot;ADM_colorspace/ADM_rgb.h&quot;
+#include &quot;ADM_assert.h&quot;
+#include &quot;DIA_flyDialog.h&quot;
+#include &quot;DIA_flyDialogQt4.h&quot;
+
+#include &quot;ADM_video/ADM_vidFont.h&quot;
+#include &quot;ADM_video/ADM_vidSRT.h&quot;
+
+#include &quot;DIA_flySrtPos.h&quot;
+
+//
+//	Video is in YV12 Colorspace
+//
+//
+class Ui_srtWindow : public QDialog
+ {
+     Q_OBJECT
+ protected : 
+    int lock;
+ public:
+     flySrtPos *myCrop;
+     ADM_QCanvas *canvas;
+     Ui_srtWindow(SRT_POS_PARAM *param,AVDMGenericVideoStream *in);
+     ~Ui_srtWindow();
+     Ui_srtDialog ui;
+ public slots:
+      void gather(SRT_POS_PARAM *param);
+      //void update(int i);
+ private slots:
+   void sliderUpdate(int foo);
+   void valueChanged(int foo);
+
+ private:
+     
+ };
+  Ui_srtWindow::Ui_srtWindow(SRT_POS_PARAM *param,AVDMGenericVideoStream *in)
+  {
+    uint32_t width,height;
+        ui.setupUi(this);
+        lock=0;
+        // Allocate space for green-ised video
+        width=in-&gt;getInfo()-&gt;width;
+        height=in-&gt;getInfo()-&gt;height;
+        ui.graphicsView-&gt;resize(width,height);
+        canvas=new ADM_QCanvas(ui.graphicsView,width,height);
+        
+        myCrop=new flySrtPos( width, height,in,canvas,ui.horizontalSlider);
+        memcpy(&amp;(myCrop-&gt;param),param,sizeof(SRT_POS_PARAM));
+        myCrop-&gt;_cookie=&ui;
+        myCrop-&gt;upload();
+        myCrop-&gt;sliderChanged();
+
+        ui.verticalSlider-&gt;setMaximum(height-1);
+        
+        connect( ui.horizontalSlider,SIGNAL(valueChanged(int)),this,SLOT(sliderUpdate(int)));
+        connect( ui.verticalSlider,SIGNAL(valueChanged(int)),this,SLOT(valueChanged(int)));
+        connect( ui.spinBox,SIGNAL(valueChanged(int)),this,SLOT(valueChanged(int)));  
+        
+          
+
+  }
+  void Ui_srtWindow::sliderUpdate(int foo)
+  {
+    myCrop-&gt;sliderChanged();
+  }
+  void Ui_srtWindow::gather(SRT_POS_PARAM *param)
+  {
+    
+        myCrop-&gt;download();
+        memcpy(param,&amp;(myCrop-&gt;param),sizeof(SRT_POS_PARAM));
+  }
+Ui_srtWindow::~Ui_srtWindow()
+{
+  if(myCrop) delete myCrop;
+  myCrop=NULL; 
+  if(canvas) delete canvas;
+  canvas=NULL;
+}
+void Ui_srtWindow::valueChanged( int f )
+{
+  if(lock) return;
+  lock++;
+  myCrop-&gt;update();
+  lock--;
+}
+
+#define MYSPIN(x) w-&gt;x
+#define MYCHECK(x) w-&gt;checkBox##x
+//************************
+uint8_t flySrtPos::upload(void)
+{
+      Ui_srtDialog *w=(Ui_srtDialog *)_cookie;
+
+        MYSPIN(spinBox)-&gt;setValue(param.fontSize);
+        int32_t max=_h;
+        max-=(SRT_MAX_LINE)*param.fontSize;
+        if(max&lt;0) max=0;
+        if(param.position&gt;=max)
+        {
+          param.position=max;
+        }
+        QSlider  *slide=w-&gt;verticalSlider;
+        slide-&gt;setValue(param.position);
+        return 1;
+}
+uint8_t flySrtPos::download(void)
+{
+       Ui_srtDialog *w=(Ui_srtDialog *)_cookie;
+         param.fontSize=MYSPIN(spinBox)-&gt;value();
+         int32_t max=_h;
+        max-=(SRT_MAX_LINE)*param.fontSize;
+        if(max&lt;0) max=0;
+        
+        QSlider  *slide=w-&gt;verticalSlider;
+        param.position=slide-&gt;value();
+        
+        if(param.position&gt;=max)
+        {
+          param.position=max;
+          upload();
+        }
+         
+return 1;
+}
+
+/**
+      \fn     DIA_srtPos
+      \brief  Handle srt fontsize/position dialog
+*/
+int DIA_srtPos(AVDMGenericVideoStream *in,uint32_t *size,uint32_t *position)
+{
+        uint8_t ret=0;
+        SRT_POS_PARAM param;
+        param.fontSize=*size;
+        param.position=*position;
+        Ui_srtWindow dialog(&amp;param,in);        
+        if(dialog.exec()==QDialog::Accepted)
+        {
+            dialog.gather(&amp;param);
+            *size=param.fontSize;
+            *position=param.position;
+            ret=1;
+        }
+        return ret;
+}
+//____________________________________
+// EOF
+
+

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-05-26 15:12:41 UTC (rev 3150)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_factory.h	2007-05-27 09:12:35 UTC (rev 3151)
@@ -79,10 +79,9 @@
 class diaElemButton : public diaElem
 {
   protected:
-    
+  public:
     void            *_cookie;
     ADM_FAC_CALLBACK *_callBack;
-public:
             diaElemButton(const char *toggleTitle, ADM_FAC_CALLBACK *cb,void *cookie,const char *tip=NULL);
   virtual   ~diaElemButton() ;
   void      setMe(void *dialog, void *opaque,uint32_t line);

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.cpp (from rev 3098, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyChromaShift.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyChromaShift.cpp	2007-05-15 15:15:31 UTC (rev 3098)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.cpp	2007-05-27 09:12:35 UTC (rev 3151)
@@ -0,0 +1,66 @@
+/***************************************************************************
+                       FlyDialog for Subtitles
+    copyright            : (C) 2007 Mean
+    email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;config.h&quot;
+#ifdef USE_FREETYPE
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+
+#include &lt;math.h&gt;
+#include &quot;default.h&quot;
+#include &quot;ADM_colorspace/ADM_rgb.h&quot;
+#include &quot;ADM_image.h&quot;
+
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+#include &quot;ADM_video/ADM_vidFont.h&quot;
+#include &quot;ADM_video/ADM_vidSRT.h&quot;
+
+#include &quot;DIA_flyDialog.h&quot;
+#include &quot;DIA_flySrtPos.h&quot;
+/*********  COMMON PART *********/
+uint8_t    flySrtPos::process(void)
+{
+  uint32_t h;
+        // First copy Y
+        memcpy(_yuvBufferOut-&gt;data,_yuvBuffer-&gt;data,(_w*_h));
+        // then shift u
+        memcpy(UPLANE(_yuvBufferOut),UPLANE(_yuvBuffer),(_w*_h)/4);
+        memcpy(VPLANE(_yuvBufferOut),VPLANE(_yuvBuffer),(_w*_h)/4);
+        // Mark 
+        h=param.fontSize;
+        if(h&gt;8) h-=4;
+  
+        for(uint32_t line=0;line&lt;SRT_MAX_LINE;line++)
+        {
+                uint8_t *src=YPLANE(_yuvBufferOut)+(param.position+line*param.fontSize)*_w;
+  
+                for(uint32_t y=0;y&lt;h;y+=2)
+                {
+                        memset(src,255,_w);
+                        src+=2*_w;
+                }
+        }
+        return 1;
+}
+uint8_t    flySrtPos::update(void)
+{
+    download();
+    process();
+    _rgb-&gt;scale(_yuvBufferOut-&gt;data,_rgbBufferOut);
+    display();
+}
+#endif
+//EOF
+

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.h (from rev 3098, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyAsharp.h)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flyAsharp.h	2007-05-15 15:15:31 UTC (rev 3098)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_flySrtPos.h	2007-05-27 09:12:35 UTC (rev 3151)
@@ -0,0 +1,28 @@
+
+
+#ifndef FLY_SRTPOS_H
+#define FLY_SRTPOS_H
+typedef struct
+{
+    uint32_t fontSize;
+    uint32_t position;
+}SRT_POS_PARAM;
+
+class flySrtPos : public ADM_flyDialog
+{
+  
+  public:
+   SRT_POS_PARAM  param;
+  public:
+   uint8_t    process(void);
+   uint8_t    download(void);
+   uint8_t    upload(void);
+   uint8_t    update(void);
+   flySrtPos (uint32_t width,uint32_t height,AVDMGenericVideoStream *in,
+                                    void *canvas, void *slider) : ADM_flyDialog(width, height,in,canvas, slider,1) 
+                    {
+                      
+                    };
+};
+
+#endif

Copied: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_srt.cpp (from rev 3098, branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_lavcodec.cpp)
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_lavcodec.cpp	2007-05-15 15:15:31 UTC (rev 3098)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/DIA_srt.cpp	2007-05-27 09:12:35 UTC (rev 3151)
@@ -0,0 +1,163 @@
+//
+// C++ Implementation: ADM_vidForcedPP
+//
+// Description: 
+//
+//	Force postprocessing assuming constant quant &amp; image type
+//	Uselefull on some badly authored DVD for example
+//
+// Author: mean &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>&gt;, (C) 2004
+//
+// Copyright: See COPYING file that comes with this distribution
+//
+//
+#include &quot;config.h&quot;
+#ifdef USE_FREETYPE
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+#include &lt;math.h&gt;
+#include &lt;iconv.h&gt;
+
+#include &quot;default.h&quot;
+#include &quot;ADM_commonUI//GUI_render.h&quot;
+#include &quot;ADM_video/ADM_genvideo.hxx&quot;
+#include &quot;DIA_flyDialog.h&quot;
+
+#include &quot;ADM_assert.h&quot;
+
+#include &quot;ADM_toolkit/toolkit.hxx&quot;
+
+#include &quot;ADM_userInterfaces/ADM_commonUI/DIA_factory.h&quot;
+#include &quot;ADM_encoder/ADM_vidEncode.hxx&quot;
+#include &quot;ADM_video/ADM_vidFont.h&quot;
+#include &quot;ADM_video/ADM_vidSRT.h&quot;
+#include &quot;ADM_colorspace/colorspace.h&quot;
+/*****************************************************************/
+extern int DIA_colorSel(uint8_t *r, uint8_t *g, uint8_t *b);
+extern int DIA_srtPos(AVDMGenericVideoStream *source,uint32_t *size,uint32_t *position);
+static void colorCallBack(void *cookie);
+static void sizePositionCallback(void *cookie);
+/*****************************************************************/
+typedef struct unicd
+{
+	char *display,*name;
+}unicd;
+
+  static unicd  names[]=
+{
+	{(char *)&quot;Ascii&quot;	,(char *)&quot;ISO-8859-1&quot;},
+	{(char *)&quot;Cyrillic&quot;	,(char *)&quot;WINDOWS-1251&quot;}, // ru
+	{(char *)&quot;Czech&quot;	,(char *)&quot;ISO-8859-2&quot;},	// cz
+	{(char *)&quot;German&quot;	,(char *)&quot;ISO-8859-9&quot;}		// german ?
+	,{(char *)&quot;Slovene&quot;	,(char *)&quot;CP1250&quot;}		// UTF8
+        
+        ,{(char *)&quot;UTF16&quot;	,(char *)&quot;UTF16&quot;}		// UTF8
+	,{(char *)&quot;UTF8&quot;	,(char *)&quot;UTF8&quot;}		// UTF8
+	,{(char *)&quot;Chinese Traditionnal(Big5)&quot;	,(char *)&quot;CP950&quot;}		// UTF8
+	,{(char *)&quot;Chinese Simplified (GB2312)&quot;	,(char *)&quot;CP936&quot;}		// UTF8
+};
+typedef struct 
+{
+  AVDMGenericVideoStream *source;
+  uint32_t               *size;
+  uint32_t               *position;
+}sizePosition;
+
+/**
+      \fn    DIA_srt
+      \brief Dialog to handle srt, generic part
+*/
+uint8_t DIA_srt(AVDMGenericVideoStream *source, SUBCONF *param)
+{
+#define item(x) _(names[x].display)
+#define Mitem(x) {x,item(x)}
+diaMenuEntry encoding[]={
+  Mitem(0),
+  Mitem(1),
+  Mitem(2),
+  Mitem(3),
+  Mitem(4),
+  Mitem(5),
+  Mitem(6),
+  Mitem(7),
+};       
+
+#define PX(x) &amp;(param-&gt;x)
+  diaElemFile subtitle(0,(char **)PX(_subname),_(&quot;_Subtitle File:&quot;));
+  diaElemFile font(0,(char **)PX(_fontname),_(&quot;_Font (TTF):&quot;));
+  int colors[3]={param-&gt;_Y_percent,param-&gt;_U_percent,param-&gt;_V_percent};
+  
+  uint32_t fontSize=param-&gt;_fontsize;
+  uint32_t baseLine=param-&gt;_baseLine;
+  
+  sizePosition sizePos={source,&amp;fontSize,&amp;baseLine};
+  
+  uint32_t myEncoding=0;
+      // convert internal to display
+      if(param-&gt;_charset)
+      for(int i=0;i&lt;sizeof(names)/sizeof(unicd);i++)
+      {
+          if(!strcmp(param-&gt;_charset,names[i].name)) myEncoding=i;
+      }
+      diaElemMenu      encodingM(&amp;myEncoding,_(&quot;Encoding:&quot;),8,encoding);
+    //  diaElemUInteger  fontSize(PX(_fontsize),_(&quot;Font Si_Ze:&quot;),8,120);
+      diaElemButton    color(_(&quot;Color&quot;), colorCallBack,&amp;(colors[0]));
+      diaElemButton    setBase(_(&quot;_Size and Position&quot;), sizePositionCallback,&amp;sizePos);
+      diaElemToggle    autoSplit(PX(_selfAdjustable),_(&quot;_Auto Split:&quot;));
+      diaElemInteger   delay(PX(_delay),_(&quot;_Delay (ms):&quot;),-100000,100000);
+         
+      diaElem *tabs[]={&amp;subtitle,&amp;font,&amp;encodingM,&amp;color,&amp;setBase,&amp;autoSplit,&amp;delay};
+      if( diaFactoryRun(_(&quot;Subtitles&quot;),7,tabs))
+	{
+          if(param-&gt;_charset) ADM_dealloc(param-&gt;_charset);
+          param-&gt;_charset=ADM_strdup(names[myEncoding].name);
+            param-&gt;_Y_percent=colors[0];
+            param-&gt;_U_percent=colors[1];
+            param-&gt;_V_percent=colors[2];
+            param-&gt;_fontsize=fontSize;
+            param-&gt;_baseLine=baseLine;
+          return 1;
+        }
+         return 0;
+}
+/**
+      \fn colorCallBack
+      \brief Callback used to select a color
+*/
+void colorCallBack(void *cookie)
+{
+  
+      int32_t *colors=(int32_t *)cookie;
+        
+        uint8_t r,g,b;
+        uint8_t y;
+        int8_t u,v;
+  
+        y=colors[0];
+        u=colors[1];
+        v=colors[2];
+
+        COL_YuvToRgb(   y,  u,  v, &amp;b,&amp;g,&amp;r);
+        if(DIA_colorSel(&amp;r,&amp;g,&amp;b))
+        {
+                COL_RgbToYuv(b,  g,  r, &amp;y, &amp;u,&amp;v);
+                colors[0]=y;
+                if(abs(u)&lt;2) u=0;
+                if(abs(v)&lt;2) v=0;
+                colors[1]=u;
+                colors[2]=v;
+        }
+}
+/**
+      \fn sizePositionCallback
+      \brief Callback used to set size and position
+*/
+void sizePositionCallback(void *cookie)
+{
+    sizePosition *sz=(sizePosition *)cookie;
+    printf(&quot;Size and position invoked\n&quot;);
+    DIA_srtPos(sz-&gt;source,sz-&gt;size,sz-&gt;position);
+}
+#endif
+// EOF

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am	2007-05-26 15:12:41 UTC (rev 3150)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/Makefile.am	2007-05-27 09:12:35 UTC (rev 3151)
@@ -8,8 +8,9 @@
 DIA_audioFilter.cpp DIA_flyDialog.cpp DIA_flyCrop.cpp \
 DIA_flyAsharp.cpp DIA_flyChromaShift.cpp DIA_flyContrast.cpp \
 DIA_flyHue.cpp \
+DIA_flySrtPos.cpp \
 DIA_tdeint.cpp DIA_v2v.cpp \
-DIA_lavDecoder.cpp 
+DIA_lavDecoder.cpp  DIA_srt.cpp
 
 
 INCLUDES = $(all_includes) $(GTK_CFLAGS) $(XML_CFLAGS)  $(FREETYPE_CFLAGS) -DADM_SUBVERSION=@ADM_SUBVERSION@ \


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000445.html">[Avidemux-svn-commit] r3150 - in	branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_QT4:	ADM_dialog ADM_gui
</A></li>
	<LI>Next message: <A HREF="000447.html">[Avidemux-svn-commit] r3152 - in	branches/avidemux_2.4_branch/avidemux: . ADM_video
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#446">[ date ]</a>
              <a href="thread.html#446">[ thread ]</a>
              <a href="subject.html#446">[ subject ]</a>
              <a href="author.html#446">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
