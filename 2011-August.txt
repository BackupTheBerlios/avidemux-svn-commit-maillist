From mean at mail.berlios.de  Mon Aug  1 20:22:04 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  1 Aug 2011 20:22:04 +0200
Subject: [Avidemux-svn-commit] r7377 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui
Message-ID: <20110801182204.4B1A44833A6@sheep.berlios.de>

Author: mean
Date: 2011-08-01 20:22:03 +0200 (Mon, 01 Aug 2011)
New Revision: 7377

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
Log:
[openGl] Try to show GL widget before poking for GL shader support

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2011-07-31 17:19:08 UTC (rev 7376)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2011-08-01 18:22:03 UTC (rev 7377)
@@ -843,13 +843,12 @@
 	setupMenus();
     ADM_setCrashHook(&saveCrashProject, &FatalFunctionQt);
 	checkCrashFile();
-
     // Create an openGL context
 #ifdef USE_OPENGL
     ADM_info("Creating openGl dummy widget\n");
     topGlWidgetRoot=new dummyGLWidget(VuMeter);
     ADM_setGlWidget(topGlWidgetRoot);
-
+    topGlWidgetRoot->show();
 #ifndef QT_OPENGL_ES
     GlActiveTexture_Type *tex= (GlActiveTexture_Type *)topGlWidgetRoot->context()->getProcAddress(QLatin1String("glActiveTexture"));
 
@@ -858,7 +857,7 @@
 		ADM_error("[GL Render] Active Texture function not found!\n");
 	}else
     {
-        ADM_error("[GL Render] Active Texture function found (Not openGL_ES)\n");
+        ADM_warning("[GL Render] Active Texture function found (Not openGL_ES)\n");
         ADM_setActiveTexture(tex);
     }
 #else



From mean at mail.berlios.de  Tue Aug  2 07:53:35 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue,  2 Aug 2011 07:53:35 +0200
Subject: [Avidemux-svn-commit] r7378 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui
Message-ID: <20110802055335.E82534833AF@sheep.berlios.de>

Author: mean
Date: 2011-08-02 07:53:35 +0200 (Tue, 02 Aug 2011)
New Revision: 7378

Added:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2GL.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
Log:
[GL/Qt4] split GL related init into its own file

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/CMakeLists.txt	2011-08-01 18:22:03 UTC (rev 7377)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/CMakeLists.txt	2011-08-02 05:53:35 UTC (rev 7378)
@@ -5,7 +5,7 @@
 QT4_ADD_RESOURCES(${ADM_LIB}_resource  avidemux.qrc)
 
 SET(${ADM_LIB}_SRCS
-	Q_gui2.cpp  
+	Q_gui2.cpp   Q_gui2GL.cpp
 	Q_gui2_menu.cpp  
         T_preview.cpp  
         T_vumeter.cpp  

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2011-08-01 18:22:03 UTC (rev 7377)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2011-08-02 05:53:35 UTC (rev 7378)
@@ -20,14 +20,6 @@
 #include <QtGui/QKeyEvent>
 #include <QtGui/QGraphicsView>
 
-#ifdef USE_OPENGL
-#include <QtOpenGL/QGLWidget>
-#endif
-
-#ifdef USE_OPENGL
-#include "T_openGL.h"
-#endif
-
 #define MENU_DECLARE
 #include "Q_gui2.h"
 #include "ADM_default.h"
@@ -43,6 +35,11 @@
 #include "T_vumeter.h"
 #include "DIA_coreToolkit.h"
 
+#ifdef USE_OPENGL
+void UI_Qt4InitGl(void);
+void UI_Qt4CleanGl(void);
+#endif
+
 extern int global_argc;
 extern char **global_argv;
 
@@ -92,13 +89,6 @@
 #define DECLARE_VAR(object,signal_name) {#object,signal_name},
 
 #include "translation_table.h"   
-
-#ifdef USE_OPENGL
-#include "T_openGLFilter.h"
-#include "Q_dummyWidget.h"
-dummyGLWidget *topGlWidget=NULL;
-dummyGLWidget *topGlWidgetRoot=NULL;
-#endif
 /*
     Declare the table converting widget name to our internal signal           
 */
@@ -845,38 +835,15 @@
 	checkCrashFile();
     // Create an openGL context
 #ifdef USE_OPENGL
-    ADM_info("Creating openGl dummy widget\n");
-    topGlWidgetRoot=new dummyGLWidget(VuMeter);
-    ADM_setGlWidget(topGlWidgetRoot);
-    topGlWidgetRoot->show();
-#ifndef QT_OPENGL_ES
-    GlActiveTexture_Type *tex= (GlActiveTexture_Type *)topGlWidgetRoot->context()->getProcAddress(QLatin1String("glActiveTexture"));
-
-	if (!tex)
-	{
-		ADM_error("[GL Render] Active Texture function not found!\n");
-	}else
-    {
-        ADM_warning("[GL Render] Active Texture function found (Not openGL_ES)\n");
-        ADM_setActiveTexture(tex);
-    }
-#else
-    ADM_setActiveTexture(glActiveTexture);
+    UI_Qt4InitGl();
 #endif
-
-	printf("[GL Render] OpenGL Vendor: %s\n", glGetString(GL_VENDOR));
-	printf("[GL Render] OpenGL Renderer: %s\n", glGetString(GL_RENDERER));
-	printf("[GL Render] OpenGL Version: %s\n", glGetString(GL_VERSION));
-	printf("[GL Render] OpenGL Extensions: %s\n", glGetString(GL_EXTENSIONS));
 
-#endif
 	if (global_argc >= 2)
 		automation();
 
     myApplication->exec();
 #ifdef USE_OPENGL
-    if(topGlWidgetRoot) delete topGlWidgetRoot;
-    topGlWidgetRoot=NULL;
+   UI_Qt4CleanGl();
 #endif
 	destroyTranslator();
     delete myApplication;

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2GL.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2GL.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2GL.cpp	2011-08-02 05:53:35 UTC (rev 7378)
@@ -0,0 +1,75 @@
+/***************************************************************************
+    copyright            : (C) 2001 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "config.h"
+#ifdef USE_OPENGL
+
+#include "ADM_inttype.h"
+#include "T_openGL.h"
+
+#include <QtCore/QFileInfo>
+#include <QtCore/QUrl>
+#include <QtGui/QKeyEvent>
+#include <QtGui/QGraphicsView>
+
+#include <QtOpenGL/QGLWidget>
+#include "Q_dummyWidget.h"
+
+
+#include "T_openGLFilter.h"
+#include "ADM_default.h"
+dummyGLWidget *topGlWidget=NULL;
+dummyGLWidget *topGlWidgetRoot=NULL;
+extern QWidget *VuMeter;
+/**
+    \fn UI_Qt4InitGl
+*/
+void UI_Qt4InitGl(void)
+{
+    ADM_info("Creating openGl dummy widget\n");
+    topGlWidgetRoot=new dummyGLWidget(VuMeter);
+    ADM_setGlWidget(topGlWidgetRoot);
+    topGlWidgetRoot->show();
+#ifndef QT_OPENGL_ES
+    GlActiveTexture_Type *tex= (GlActiveTexture_Type *)topGlWidgetRoot->context()->getProcAddress(QLatin1String("glActiveTexture"));
+
+	if (!tex)
+	{
+		ADM_error("[GL Render] Active Texture function not found!\n");
+	}else
+    {
+        ADM_warning("[GL Render] Active Texture function found (Not openGL_ES)\n");
+        ADM_setActiveTexture(tex);
+    }
+#else
+    ADM_setActiveTexture(glActiveTexture);
+#endif
+
+	printf("[GL Render] OpenGL Vendor: %s\n", glGetString(GL_VENDOR));
+	printf("[GL Render] OpenGL Renderer: %s\n", glGetString(GL_RENDERER));
+	printf("[GL Render] OpenGL Version: %s\n", glGetString(GL_VERSION));
+	printf("[GL Render] OpenGL Extensions: %s\n", glGetString(GL_EXTENSIONS));
+
+}
+/**
+    \fn UI_Qt4CleanGl
+*/
+void UI_Qt4CleanGl(void)
+{
+    if(topGlWidgetRoot) delete topGlWidgetRoot;
+    topGlWidgetRoot=NULL;
+}
+#endif
+//********************************************
+//EOF



From mean at mail.berlios.de  Tue Aug  2 07:53:36 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue,  2 Aug 2011 07:53:36 +0200
Subject: [Avidemux-svn-commit] r7379 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2
Message-ID: <20110802055337.0158B4833AF@sheep.berlios.de>

Author: mean
Date: 2011-08-02 07:53:36 +0200 (Tue, 02 Aug 2011)
New Revision: 7379

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp
Log:
[FragGl2] End up with the larger plane (Y)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp	2011-08-02 05:53:35 UTC (rev 7378)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp	2011-08-02 05:53:36 UTC (rev 7379)
@@ -232,7 +232,7 @@
 void openGlSample::multiUploadTex(ADMImage *image)
 {
           // Activate texture unit "tex"
-        for(int xplane=0;xplane<3;xplane++)
+        for(int xplane=2;xplane>=0;xplane--)
         {
             myGlActiveTexture(GL_TEXTURE0+xplane);
             ADM_PLANE plane=(ADM_PLANE)xplane;



From mean at mail.berlios.de  Wed Aug  3 21:20:11 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  3 Aug 2011 21:20:11 +0200
Subject: [Avidemux-svn-commit] r7380 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2
Message-ID: <20110803192011.6148D4833A6@sheep.berlios.de>

Author: mean
Date: 2011-08-03 21:20:09 +0200 (Wed, 03 Aug 2011)
New Revision: 7380

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.h
Log:
[multiTexture] Workish example

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp	2011-08-02 05:53:36 UTC (rev 7379)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp	2011-08-03 19:20:09 UTC (rev 7380)
@@ -63,6 +63,7 @@
 protected:
                         uint8_t *uBuffer;
                         uint8_t *vBuffer;
+                        GLuint  texName[3];
 protected:
                         //bool uploadTexture(ADMImage *image, ADM_PLANE plane);
                         bool render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo);
@@ -120,6 +121,7 @@
         }
         uBuffer=new uint8_t[info.width*info.height];
         vBuffer=new uint8_t[info.width*info.height];
+        glGenTextures(3,texName);
         fboY->release();
         widget->doneCurrent();
 
@@ -132,6 +134,7 @@
 {
     delete [] uBuffer;
     delete [] vBuffer;
+    glDeleteTextures(3,texName);
     uBuffer=NULL;
     vBuffer=NULL;
 
@@ -151,23 +154,22 @@
     }
     widget->makeCurrent();
     glPushMatrix();
+    // size is the last one...
+    fboY->bind();
+
     float angle=*fn;
     angle=angle/40;
-    glProgramY->setUniformValue("teta", angle); 
-    glProgramY->setUniformValue("teta", angle); 
-    
+    glProgramY->setUniformValue("teta", angle);     
     glProgramY->setUniformValue("myTextureU", 1); 
     glProgramY->setUniformValue("myTextureV", 2); 
     glProgramY->setUniformValue("myTextureY", 0); 
     glProgramY->setUniformValue("myWidth", image->GetWidth(PLANAR_Y)); 
     glProgramY->setUniformValue("myHeight", image->GetHeight(PLANAR_Y)); 
 
-    // size is the last one...
-    fboY->bind();
 #if 0
-    tinyUploadTex(image,PLANAR_V,GL_TEXTURE2,2);
-    tinyUploadTex(image,PLANAR_U,GL_TEXTURE1,1);
-    tinyUploadTex(image,PLANAR_Y,GL_TEXTURE0,0);
+    tinyUploadTex(image,PLANAR_V,GL_TEXTURE2,texName[2]);
+    tinyUploadTex(image,PLANAR_U,GL_TEXTURE1,texName[1]);
+    tinyUploadTex(image,PLANAR_Y,GL_TEXTURE0,texName[0]);
 #else
     multiUploadTex(image);
 #endif
@@ -236,7 +238,7 @@
         {
             myGlActiveTexture(GL_TEXTURE0+xplane);
             ADM_PLANE plane=(ADM_PLANE)xplane;
-            glBindTexture(GL_TEXTURE_RECTANGLE_NV, xplane); // Use texture "texNum"
+            glBindTexture(GL_TEXTURE_RECTANGLE_NV, texName[xplane]); // Use tex engine "texNum"
             glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
             glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
             glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.h	2011-08-02 05:53:36 UTC (rev 7379)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.h	2011-08-03 19:20:09 UTC (rev 7380)
@@ -1,16 +1,18 @@
 // Invert x & y
 static const char *myShaderY =
 	"#extension GL_ARB_texture_rectangle: enable\n"
-	"uniform sampler2DRect myTextureY;\n"
-    "uniform sampler2DRect myTextureU;\n"
-    "uniform sampler2DRect myTextureV;\n"
+	"uniform sampler2DRect myTextureY;\n" // tex unit 0
+    "uniform sampler2DRect myTextureU;\n" // tex unit 1
+    "uniform sampler2DRect myTextureV;\n" // tex unit 2
     "uniform float myWidth;\n"
     "uniform float myHeight;\n"
 
 	"void main(void) {\n"
-    "  vec4 texvalV = texture2DRect(myTextureV, vec2(gl_TexCoord[2]));\n"
-    "  vec4 texvalU = texture2DRect(myTextureU, vec2(gl_TexCoord[1]));\n"
-	"  vec4 texvalY = texture2DRect(myTextureY, vec2(gl_TexCoord[0]));\n"
-	"  gl_FragColor = vec4(texvalY.r, texvalU.r, texvalV.r, 1.0);\n"
+    "  float nx = gl_TexCoord[0].x;\n"
+	"  float ny = gl_TexCoord[0].y;\n"
+    "  vec4 texvalV = texture2DRect(myTextureV, vec2(nx,ny));\n"
+    "  vec4 texvalU = texture2DRect(myTextureU, vec2(nx,ny));\n"
+	"  vec4 texvalY = texture2DRect(myTextureY, vec2(nx,ny));\n"
+	"  gl_FragColor = vec4(texvalY.r, texvalU.g, texvalV.b, 1.0);\n"
 	"}\n";
 



From mean at mail.berlios.de  Wed Aug  3 21:20:12 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  3 Aug 2011 21:20:12 +0200
Subject: [Avidemux-svn-commit] r7381 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2
Message-ID: <20110803192012.5C0FC4833A6@sheep.berlios.de>

Author: mean
Date: 2011-08-03 21:20:12 +0200 (Wed, 03 Aug 2011)
New Revision: 7381

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.h
Log:
[gl2] simplify

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp	2011-08-03 19:20:09 UTC (rev 7380)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp	2011-08-03 19:20:12 UTC (rev 7381)
@@ -244,8 +244,7 @@
             glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
             glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
             glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
-            if(plane==PLANAR_Y) // take Y as it is..
-            {
+
                 if(!firstRun)
                 {
                     glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, 
@@ -260,46 +259,6 @@
                         GL_LUMINANCE, GL_UNSIGNED_BYTE, 
                         image->GetReadPtr(plane));
                 }
-            }else
-            {
-                    uint8_t *buffer,*src,*tmp,*tgt;
-                    int stride;
-                    // expand into U or V buffer... 
-                    if(plane==PLANAR_U) 
-                            buffer=uBuffer;
-                        else buffer=vBuffer;
-                    
-                    src=image->GetReadPtr(plane);
-                    stride=image->GetPitch(plane);
-
-                    tmp=src;
-                    tgt=buffer;
-                    for(int y=0;y<info.height;y+=2)
-                    {
-                        for(int x=0;x<info.width;x+=2)
-                        {
-                                tgt[x]=tgt[x+stride]=tmp[x/2];
-                                tgt[x+1]=tgt[x+1+stride]=tmp[x/2];
-                        }
-                        tmp+=stride;
-                        tgt+=2*info.width;
-                    }
-                    // upload
-                    if(!firstRun)
-                    {
-                        glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, 
-                                    info.width,
-                                    info.height, 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, 
-                                    buffer);
-                    }else
-                    {
-                        glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, 
-                        info.width,
-                        info.height,
-                        GL_LUMINANCE, GL_UNSIGNED_BYTE, 
-                        buffer);
-                    } 
-            }
         }
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.h	2011-08-03 19:20:09 UTC (rev 7380)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.h	2011-08-03 19:20:12 UTC (rev 7381)
@@ -6,13 +6,18 @@
     "uniform sampler2DRect myTextureV;\n" // tex unit 2
     "uniform float myWidth;\n"
     "uniform float myHeight;\n"
+    "uniform float teta;\n"
 
 	"void main(void) {\n"
-    "  float nx = gl_TexCoord[0].x;\n"
-	"  float ny = gl_TexCoord[0].y;\n"
-    "  vec4 texvalV = texture2DRect(myTextureV, vec2(nx,ny));\n"
-    "  vec4 texvalU = texture2DRect(myTextureU, vec2(nx,ny));\n"
+    "  float mx = gl_TexCoord[0].x;\n"
+	"  float my = gl_TexCoord[0].y;\n"
+    "  float c=cos(teta); \n"
+    "  float s=sin(teta); \n"
+    "  float nx=mx*c-my*s;\n"
+    "  float ny=mx*s+my*c;\n"
+    "  vec4 texvalV = texture2DRect(myTextureV, vec2(nx/2,ny/2));\n"
+    "  vec4 texvalU = texture2DRect(myTextureU, vec2(nx/2,ny/2));\n"
 	"  vec4 texvalY = texture2DRect(myTextureY, vec2(nx,ny));\n"
-	"  gl_FragColor = vec4(texvalY.r, texvalU.g, texvalV.b, 1.0);\n"
+	"  gl_FragColor = vec4(texvalY.r, texvalU.r, texvalV.r, 1.0);\n"
 	"}\n";
 



From mean at mail.berlios.de  Wed Aug  3 21:20:13 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed,  3 Aug 2011 21:20:13 +0200
Subject: [Avidemux-svn-commit] r7382 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src
Message-ID: <20110803192015.0AA414833A6@sheep.berlios.de>

Author: mean
Date: 2011-08-03 21:20:13 +0200 (Wed, 03 Aug 2011)
New Revision: 7382

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
Log:
[openGl/qt4] Remove dump if received picture

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-03 19:20:12 UTC (rev 7381)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-03 19:20:13 UTC (rev 7382)
@@ -183,7 +183,7 @@
             ADM_error("Can t get pointer to openGl texture\n");
             return false;
         }
-#if 1
+#if 0
     printf("RGB");
     const uchar *src2=src;
     for(int i=0;i<10;i++)



From mean at mail.berlios.de  Thu Aug  4 07:54:24 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu,  4 Aug 2011 07:54:24 +0200
Subject: [Avidemux-svn-commit] r7383 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render
Message-ID: <20110804055424.96488481364@sheep.berlios.de>

Author: mean
Date: 2011-08-04 07:54:24 +0200 (Thu, 04 Aug 2011)
New Revision: 7383

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.h
Log:
[qtGl render] Allocate texture name, dont hardcode them

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.cpp	2011-08-03 19:20:13 UTC (rev 7382)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.cpp	2011-08-04 05:54:24 UTC (rev 7383)
@@ -66,7 +66,8 @@
 	imageWidth = w;
 	imageHeight = h;
 	firstRun = true;
-	glProgram = NULL;
+	glProgram = NULL;
+    glGenTextures(3,textureName);
 }
 /**
 
@@ -83,6 +84,7 @@
 */
 QtGlAccelWidget::~QtGlAccelWidget()
 {
+    glDeleteTextures(3,textureName);
 }
 /**
 
@@ -138,6 +140,8 @@
 	printf("[GL Render] OpenGL Renderer: %s\n", glGetString(GL_RENDERER));
 	printf("[GL Render] OpenGL Version: %s\n", glGetString(GL_VERSION));
 	printf("[GL Render] OpenGL Extensions: %s\n", glGetString(GL_EXTENSIONS));
+
+
 
 	glProgram = new QGLShaderProgram(this);
 
@@ -186,7 +190,7 @@
 
 	// U
 	glActiveTexture(GL_TEXTURE1);
-	glBindTexture(GL_TEXTURE_RECTANGLE_NV, 1);
+	glBindTexture(GL_TEXTURE_RECTANGLE_NV, textureName[1]);
 	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
 	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
 	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
@@ -200,7 +204,7 @@
 
 	// V
 	glActiveTexture(GL_TEXTURE2);
-	glBindTexture(GL_TEXTURE_RECTANGLE_NV, 2);
+	glBindTexture(GL_TEXTURE_RECTANGLE_NV, textureName[2]);
 	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
 	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
 	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
@@ -214,7 +218,7 @@
 
 	// Y
 	glActiveTexture(GL_TEXTURE0);
-	glBindTexture(GL_TEXTURE_RECTANGLE_NV, 3);
+	glBindTexture(GL_TEXTURE_RECTANGLE_NV, textureName[0]);
 	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
 	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
 	glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.h	2011-08-03 19:20:13 UTC (rev 7382)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_qtGlRender.h	2011-08-04 05:54:24 UTC (rev 7383)
@@ -32,7 +32,7 @@
     GLsizei textureStrides[3];
 	GLsizei textureHeights[3];
 	uint8_t *textureOffsets[3];
-
+    GLuint  textureName[3];
 #ifndef QT_OPENGL_ES
 	typedef void (*_glActiveTexture) (GLenum);
 	_glActiveTexture glActiveTexture;



From mean at mail.berlios.de  Thu Aug  4 07:54:25 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu,  4 Aug 2011 07:54:25 +0200
Subject: [Avidemux-svn-commit] r7384 - in branches/avidemux_2.6_branch_mean:
	avidemux/qt4/ADM_UIs/include avidemux/qt4/ADM_UIs/src
	avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2
Message-ID: <20110804055426.0578F481364@sheep.berlios.de>

Author: mean
Date: 2011-08-04 07:54:25 +0200 (Thu, 04 Aug 2011)
New Revision: 7384

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/T_openGLFilter.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp
Log:
[qtGl Filter] Move allocation of texture name to base class

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/T_openGLFilter.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/T_openGLFilter.h	2011-08-04 05:54:24 UTC (rev 7383)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/T_openGLFilter.h	2011-08-04 05:54:25 UTC (rev 7384)
@@ -34,7 +34,11 @@
                             QGLShaderProgram     *glProgramUV;
                             int                   firstRun;
                             GlActiveTexture_Type *myGlActiveTexture;
+                            GLuint                texName[3];
 protected:
+                            // image <--> texture
+                            void uploadAllPlanes(ADMImage *image);
+                            void uploadOnePlane(ADMImage *image, ADM_PLANE plane, GLuint tex,int texNum );
                             bool downloadTexture(ADMImage *target, ADM_PLANE plane,QGLFramebufferObject *fbo);
                             bool downloadTextures(ADMImage *target, QGLFramebufferObject *fbo);
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-04 05:54:24 UTC (rev 7383)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-04 05:54:25 UTC (rev 7384)
@@ -71,6 +71,7 @@
         GUI_Error_HIG("","Cannot get glActiveTexture");
         ADM_assert(0);
     }
+    glGenTextures(3,texName);
     widget->doneCurrent();
     // glTexture TODO
 
@@ -81,6 +82,7 @@
 ADM_coreVideoFilterQtGl::~ADM_coreVideoFilterQtGl()
 {
     ADM_info("Gl filter : Destroying..\n");
+    glDeleteTextures(3,texName);
     if(glProgramY) delete glProgramY;
     glProgramY=NULL;
     if(glProgramUV) delete glProgramUV;
@@ -224,4 +226,66 @@
     }
     return true;
 }
+/**
+    \fn uploadTexture
+*/
+void ADM_coreVideoFilterQtGl::uploadOnePlane(ADMImage *image, ADM_PLANE plane, GLuint tex,int texNum )
+{
+        myGlActiveTexture(tex);  // Activate texture unit "tex"
+        glBindTexture(GL_TEXTURE_RECTANGLE_NV, texNum); // Use texture "texNum"
+
+        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
+        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
+        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
+        glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
+        if(!firstRun)
+        {
+            glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, 
+                            image->GetPitch(plane),
+                            image->GetHeight(plane), 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, 
+                            image->GetReadPtr(plane));
+        }else
+        {
+            glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, 
+                image->GetPitch(plane),
+                image->GetHeight(plane),
+                GL_LUMINANCE, GL_UNSIGNED_BYTE, 
+                image->GetReadPtr(plane));
+        }
+}
+/**
+    \fn uploadTexture
+*/
+void ADM_coreVideoFilterQtGl::uploadAllPlanes(ADMImage *image)
+{
+          // Activate texture unit "tex"
+        for(int xplane=2;xplane>=0;xplane--)
+        {
+            myGlActiveTexture(GL_TEXTURE0+xplane);
+            ADM_PLANE plane=(ADM_PLANE)xplane;
+            glBindTexture(GL_TEXTURE_RECTANGLE_NV, texName[xplane]); // Use tex engine "texNum"
+            glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
+            glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
+            glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+            glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
+            glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
+
+                if(!firstRun)
+                {
+                    glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, 
+                                    image->GetPitch(plane),
+                                    image->GetHeight(plane), 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, 
+                                    image->GetReadPtr(plane));
+                }else
+                {
+                    glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, 
+                        image->GetPitch(plane),
+                        image->GetHeight(plane),
+                        GL_LUMINANCE, GL_UNSIGNED_BYTE, 
+                        image->GetReadPtr(plane));
+                }
+        }
+}
+
 // EOF
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp	2011-08-04 05:54:24 UTC (rev 7383)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp	2011-08-04 05:54:25 UTC (rev 7384)
@@ -61,21 +61,15 @@
 class openGlSample : public  ADM_coreVideoFilterQtGl
 {
 protected:
-                        uint8_t *uBuffer;
-                        uint8_t *vBuffer;
-                        GLuint  texName[3];
+
 protected:
-                        //bool uploadTexture(ADMImage *image, ADM_PLANE plane);
                         bool render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo);
-                        void tinyUploadTex(ADMImage *img, ADM_PLANE plane, GLuint tex,int texNum );
-                        void multiUploadTex(ADMImage *image);
 public:
                              openGlSample(ADM_coreVideoFilter *previous,CONFcouple *conf);
                             ~openGlSample();
 
         virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
         virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
-	 //  virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
         virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
         virtual bool         configure(void) {return true;}             /// Start graphical user interface
 };
@@ -119,9 +113,7 @@
                 ADM_error("[GL Render] Binding FAILED\n");
                 ADM_assert(0);
         }
-        uBuffer=new uint8_t[info.width*info.height];
-        vBuffer=new uint8_t[info.width*info.height];
-        glGenTextures(3,texName);
+
         fboY->release();
         widget->doneCurrent();
 
@@ -132,11 +124,6 @@
 */
 openGlSample::~openGlSample()
 {
-    delete [] uBuffer;
-    delete [] vBuffer;
-    glDeleteTextures(3,texName);
-    uBuffer=NULL;
-    vBuffer=NULL;
 
 }
 
@@ -166,15 +153,12 @@
     glProgramY->setUniformValue("myWidth", image->GetWidth(PLANAR_Y)); 
     glProgramY->setUniformValue("myHeight", image->GetHeight(PLANAR_Y)); 
 
-#if 0
-    tinyUploadTex(image,PLANAR_V,GL_TEXTURE2,texName[2]);
-    tinyUploadTex(image,PLANAR_U,GL_TEXTURE1,texName[1]);
-    tinyUploadTex(image,PLANAR_Y,GL_TEXTURE0,texName[0]);
-#else
-    multiUploadTex(image);
-#endif
+    uploadAllPlanes(image);
+
     render(image,PLANAR_Y,fboY);
+
     downloadTextures(image,fboY);
+
     fboY->release();
     firstRun=false;
     glPopMatrix();
@@ -200,68 +184,7 @@
     
     return "openGl Sample.";
 }
-/**
-    \fn uploadTexture
-*/
-void openGlSample::tinyUploadTex(ADMImage *image, ADM_PLANE plane, GLuint tex,int texNum )
-{
-        myGlActiveTexture(tex);  // Activate texture unit "tex"
-        glBindTexture(GL_TEXTURE_RECTANGLE_NV, texNum); // Use texture "texNum"
 
-        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
-        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
-        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
-        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
-        glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
-        if(!firstRun)
-        {
-            glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, 
-                            image->GetPitch(plane),
-                            image->GetHeight(plane), 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, 
-                            image->GetReadPtr(plane));
-        }else
-        {
-            glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, 
-                image->GetPitch(plane),
-                image->GetHeight(plane),
-                GL_LUMINANCE, GL_UNSIGNED_BYTE, 
-                image->GetReadPtr(plane));
-        }
-}
-/**
-    \fn uploadTexture
-*/
-void openGlSample::multiUploadTex(ADMImage *image)
-{
-          // Activate texture unit "tex"
-        for(int xplane=2;xplane>=0;xplane--)
-        {
-            myGlActiveTexture(GL_TEXTURE0+xplane);
-            ADM_PLANE plane=(ADM_PLANE)xplane;
-            glBindTexture(GL_TEXTURE_RECTANGLE_NV, texName[xplane]); // Use tex engine "texNum"
-            glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
-            glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
-            glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
-            glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
-            glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
-
-                if(!firstRun)
-                {
-                    glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, 
-                                    image->GetPitch(plane),
-                                    image->GetHeight(plane), 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, 
-                                    image->GetReadPtr(plane));
-                }else
-                {
-                    glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, 
-                        image->GetPitch(plane),
-                        image->GetHeight(plane),
-                        GL_LUMINANCE, GL_UNSIGNED_BYTE, 
-                        image->GetReadPtr(plane));
-                }
-        }
-}
-
 
 /**
     \fn render



From mean at mail.berlios.de  Fri Aug  5 07:57:09 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri,  5 Aug 2011 07:57:09 +0200
Subject: [Avidemux-svn-commit] r7385 - in branches/avidemux_2.6_branch_mean:
	avidemux/common/ADM_commonUI avidemux/qt4/ADM_UIs/include
	avidemux/qt4/ADM_UIs/src avidemux/qt4/ADM_userInterfaces/ADM_gui
	avidemux_core/ADM_coreUtils/include avidemux_core/ADM_coreUtils/src
Message-ID: <20110805055709.B203A480F4A@sheep.berlios.de>

Author: mean
Date: 2011-08-05 07:57:09 +0200 (Fri, 05 Aug 2011)
New Revision: 7385

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/GUI_ui.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/T_openGL.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/prefs2_list.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2.conf
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2_desc.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2_json.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2_pref.h
Log:
[QT4] Add a toggle to enable/disable openGL support

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp	2011-08-04 05:54:25 UTC (rev 7384)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp	2011-08-05 05:57:09 UTC (rev 7385)
@@ -69,7 +69,11 @@
 bool     bvdpau=false;
 bool     hzd,vzd,dring;
 bool     capsMMX,capsMMXEXT,caps3DNOW,caps3DNOWEXT,capsSSE,capsSSE2,capsSSE3,capsSSSE3,capsAll;
+bool     hasOpenGl=false;
 
+#ifdef USE_OPENGL
+          prefs->get(FEATURES_ENABLE_OPENGL,&hasOpenGl);
+#endif
 
 	olddevice=newdevice=AVDM_getCurrentDevice();
 
@@ -157,7 +161,12 @@
         olddevice=newdevice=AVDM_getCurrentDevice();
         // Audio device
         /************************ Build diaelems ****************************************/
-        diaElemToggle useVdpau(&bvdpau,QT_TR_NOOP("_Use VDPAU for decoding H264"));
+        diaElemToggle useVdpau(&bvdpau,QT_TR_NOOP("Decode video using VDPAU"));
+        diaElemToggle useOpenGl(&hasOpenGl,QT_TR_NOOP("Enable openGl support"));
+#ifndef USE_OPENGL
+        useOpenGl.disable();
+#endif
+        
         diaElemToggle useSysTray(&useTray,QT_TR_NOOP("_Use systray while encoding"));
         diaElemToggle allowAnyMpeg(&mpeg_no_limit,QT_TR_NOOP("_Accept non-standard audio frequency for DVD"));
         diaElemToggle openDml(&use_odml,QT_TR_NOOP("Create _OpenDML files"));
@@ -324,8 +333,8 @@
 
         
         /* Video */
-        diaElem *diaVideo[]={&menuVideoMode,&framePP,&useVdpau};
-        diaElemTabs tabVideo(QT_TR_NOOP("Video"),3,(diaElem **)diaVideo);
+        diaElem *diaVideo[]={&menuVideoMode,&framePP,&useVdpau,&useOpenGl};
+        diaElemTabs tabVideo(QT_TR_NOOP("Video"),4,(diaElem **)diaVideo);
         
         /* CPU tab */
 		diaElem *diaCpu[]={&frameSimd};
@@ -342,7 +351,10 @@
         diaElemTabs *tabs[]={&tabUser,&tabOutput,&tabAudio,&tabVideo,&tabCpu,&tabThreading};
         if( diaFactoryRunTabs(QT_TR_NOOP("Preferences"),6,tabs))
 	{
-        	
+        	//
+#ifdef USE_OPENGL
+          prefs->set(FEATURES_ENABLE_OPENGL,hasOpenGl);
+#endif
         	// cpu caps
         		if(capsAll)
         		{

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/GUI_ui.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/GUI_ui.h	2011-08-04 05:54:25 UTC (rev 7384)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/GUI_ui.h	2011-08-05 05:57:09 UTC (rev 7385)
@@ -52,5 +52,6 @@
 
 bool UI_setVUMeter( uint32_t volume[6]); // Volume between 0 and 255.
 bool UI_setDecoderName(const char *name);
+bool UI_hasOpenGl(void);
 #endif
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/T_openGL.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/T_openGL.h	2011-08-04 05:54:25 UTC (rev 7384)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/T_openGL.h	2011-08-05 05:57:09 UTC (rev 7385)
@@ -31,5 +31,6 @@
 typedef void APIENTRY (GlActiveTexture_Type)(GLenum texture);
 bool ADM_setActiveTexture(GlActiveTexture_Type *set);
 GlActiveTexture_Type *ADM_getActiveTexture(void);
+bool ADM_hasActiveTexture(void);
 #endif
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-04 05:54:25 UTC (rev 7384)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-05 05:57:09 UTC (rev 7385)
@@ -28,7 +28,16 @@
 }
 
 /**
+    \fn ADM_hasActiveTexture
+*/
+bool ADM_hasActiveTexture(void)
+{
+    if(!myActiveTexture) return false;
+    return true;
+}
 
+/**
+
 */
 bool ADM_setGlWidget(QGLWidget *w)
 {

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2011-08-04 05:54:25 UTC (rev 7384)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2011-08-05 05:57:09 UTC (rev 7385)
@@ -36,6 +36,7 @@
 #include "DIA_coreToolkit.h"
 
 #ifdef USE_OPENGL
+extern bool ADM_hasActiveTexture(void);
 void UI_Qt4InitGl(void);
 void UI_Qt4CleanGl(void);
 #endif
@@ -835,7 +836,10 @@
 	checkCrashFile();
     // Create an openGL context
 #ifdef USE_OPENGL
-    UI_Qt4InitGl();
+    bool enabled;
+    prefs->get(FEATURES_ENABLE_OPENGL,&enabled);
+    if(enabled)
+        UI_Qt4InitGl();
 #endif
 
 	if (global_argc >= 2)
@@ -843,7 +847,8 @@
 
     myApplication->exec();
 #ifdef USE_OPENGL
-   UI_Qt4CleanGl();
+    if(enabled)
+        UI_Qt4CleanGl();
 #endif
 	destroyTranslator();
     delete myApplication;
@@ -1228,5 +1233,19 @@
     WIDGET(labelVideoDecoder)->setText(name);	
     return true;
 }
+/**
+    \fn UI_hasOpengl
+*/
+bool UI_hasOpenGl(void)
+{
+#ifndef USE_OPENGL
+    return false;
+#else
+    if(!ADM_hasActiveTexture()) return false; // ADM_setActiveTexure
+    bool enabled;
+    prefs->get(FEATURES_ENABLE_OPENGL,&enabled);
+    return enabled;
+#endif
+}
 //********************************************
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/prefs2_list.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/prefs2_list.h	2011-08-04 05:54:25 UTC (rev 7384)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/include/prefs2_list.h	2011-08-05 05:57:09 UTC (rev 7385)
@@ -10,6 +10,7 @@
 FEATURES_MPEG_NO_LIMIT, 	//bool
 FEATURES_ALTERNATE_MP3_TAG, 	//bool
 FEATURES_VDPAU, 	//bool
+FEATURES_ENABLE_OPENGL, 	//bool
 LASTFILES_LASTDIR_READ, 	//string
 LASTFILES_LASTDIR_WRITE, 	//string
 LASTFILES_FILE1, 	//string

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2.conf	2011-08-04 05:54:25 UTC (rev 7384)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2.conf	2011-08-05 05:57:09 UTC (rev 7385)
@@ -26,6 +26,7 @@
 bool:mpeg_no_limit,                    0,      0,      1
 bool:alternate_mp3_tag,                1,      0,      1
 bool:vdpau,                            0,      0,      1
+bool:enable_opengl,                    0,      0,      1
 }
 #
 lastfiles{

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2.h	2011-08-04 05:54:25 UTC (rev 7384)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2.h	2011-08-05 05:57:09 UTC (rev 7385)
@@ -15,6 +15,7 @@
 	bool mpeg_no_limit;
 	bool alternate_mp3_tag;
 	bool vdpau;
+	bool enable_opengl;
 }features;
 struct  {
 	char * lastdir_read;

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2_desc.cpp	2011-08-04 05:54:25 UTC (rev 7384)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2_desc.cpp	2011-08-05 05:57:09 UTC (rev 7385)
@@ -12,6 +12,7 @@
  {"features.mpeg_no_limit",offsetof(my_prefs_struct,features.mpeg_no_limit),"bool",ADM_param_bool},
  {"features.alternate_mp3_tag",offsetof(my_prefs_struct,features.alternate_mp3_tag),"bool",ADM_param_bool},
  {"features.vdpau",offsetof(my_prefs_struct,features.vdpau),"bool",ADM_param_bool},
+ {"features.enable_opengl",offsetof(my_prefs_struct,features.enable_opengl),"bool",ADM_param_bool},
  {"lastfiles.lastdir_read",offsetof(my_prefs_struct,lastfiles.lastdir_read),"char *",ADM_param_string},
  {"lastfiles.lastdir_write",offsetof(my_prefs_struct,lastfiles.lastdir_write),"char *",ADM_param_string},
  {"lastfiles.file1",offsetof(my_prefs_struct,lastfiles.file1),"char *",ADM_param_string},

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2_json.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2_json.cpp	2011-08-04 05:54:25 UTC (rev 7384)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2_json.cpp	2011-08-05 05:57:09 UTC (rev 7385)
@@ -18,6 +18,7 @@
 json.addBool("mpeg_no_limit",key->features.mpeg_no_limit);
 json.addBool("alternate_mp3_tag",key->features.alternate_mp3_tag);
 json.addBool("vdpau",key->features.vdpau);
+json.addBool("enable_opengl",key->features.enable_opengl);
 json.endNode();
 json.addNode("lastfiles");
 json.addString("lastdir_read",key->lastfiles.lastdir_read);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2_pref.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2_pref.h	2011-08-04 05:54:25 UTC (rev 7384)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUtils/src/prefs2_pref.h	2011-08-05 05:57:09 UTC (rev 7385)
@@ -23,6 +23,7 @@
 { FEATURES_MPEG_NO_LIMIT,"features.mpeg_no_limit"                     ,ADM_param_bool    	,"0",	0,	1},
 { FEATURES_ALTERNATE_MP3_TAG,"features.alternate_mp3_tag"             ,ADM_param_bool    	,"1",	0,	1},
 { FEATURES_VDPAU,"features.vdpau"                                     ,ADM_param_bool    	,"0",	0,	1},
+{ FEATURES_ENABLE_OPENGL,"features.enable_opengl"                     ,ADM_param_bool    	,"0",	0,	1},
 { LASTFILES_LASTDIR_READ,"lastfiles.lastdir_read"                     ,ADM_param_string  	,"",	0,	0},
 { LASTFILES_LASTDIR_WRITE,"lastfiles.lastdir_write"                   ,ADM_param_string  	,"",	0,	0},
 { LASTFILES_FILE1,"lastfiles.file1"                                   ,ADM_param_string  	,"",	0,	0},



From gruntster at mail.berlios.de  Fri Aug  5 22:10:26 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Fri,  5 Aug 2011 22:10:26 +0200
Subject: [Avidemux-svn-commit] r7386 - in
	branches/avidemux_2.5_branch_gruntster/avidemux: . ADM_script
	ADM_toolkit ADM_userInterfaces/ADM_GTK/ADM_gui2
	ADM_userInterfaces/ADM_QT4/ADM_gui
Message-ID: <20110805201026.807F548122E@sheep.berlios.de>

Author: gruntster
Date: 2011-08-05 22:10:26 +0200 (Fri, 05 Aug 2011)
New Revision: 7386

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemux.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/automation.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp
Log:
[qt] fix appending video with drag and drop (regression introduced 7317)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemux.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemux.cpp	2011-08-05 05:57:09 UTC (rev 7385)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_script/ADM_JSAvidemux.cpp	2011-08-05 20:10:26 UTC (rev 7386)
@@ -26,7 +26,7 @@
 
 extern int A_openAvi (const char *name);
 extern int A_Save (const char *name);
-extern int A_appendAvi (const char *name);
+extern int A_appendAvi (const char *name, bool silent = 0);
 extern uint8_t ogmSave(char *name);
 extern int GUI_GoToFrame(uint32_t frame);
 extern int filterLoadXml(const char *docname,uint8_t silent);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/automation.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/automation.cpp	2011-08-05 05:57:09 UTC (rev 7385)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_toolkit/automation.cpp	2011-08-05 20:10:26 UTC (rev 7386)
@@ -49,7 +49,7 @@
 extern uint8_t loadVideoCodecConf( const char *name);
 extern int A_saveBunchJpg(const char *name);
 extern void filterLoadXml(const char *n);
-extern int A_appendAvi (const char *name);
+extern int A_appendAvi (const char *name, bool silent = 0);
 extern void A_saveAudio(char *name);
 extern int A_loadNone( void );
 extern void A_saveAudioDecodedTest(char *name);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2011-08-05 05:57:09 UTC (rev 7385)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_GTK/ADM_gui2/GUI_bindings.cpp	2011-08-05 20:10:26 UTC (rev 7386)
@@ -76,7 +76,7 @@
 static uint32_t ADM_nbCustom=0;
 // Needed for DND
 // extern int A_openAvi (char *name);
-extern int A_appendAvi (const char *name);
+extern int A_appendAvi (const char *name, bool silent = 0);
 extern bool A_parseECMAScript(const char *name);
 
 static void on_audio_change(void);

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2011-08-05 05:57:09 UTC (rev 7385)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_userInterfaces/ADM_QT4/ADM_gui/Q_gui2.cpp	2011-08-05 20:10:26 UTC (rev 7386)
@@ -53,7 +53,7 @@
 extern void destroyTranslator(void);
 extern ADM_RENDER_TYPE UI_getPreferredRender(void);
 extern int A_openAvi(const char *name);
-extern int A_appendAvi(const char *name);
+extern int A_appendAvi(const char *name, bool silent);
 extern char *actual_workbench_file;
 extern void FileSel_ReadWrite(SELFILE_CB *cb, int rw, const char *name, const char *actual_workbench_file);
 extern bool A_parseECMAScript(const char *name);
@@ -530,9 +530,9 @@
 		{
 			if (avifileinfo)
 			{
-				if (!loadAudio(fileName.toUtf8().constData()))
+				if (!A_appendAvi(fileName.toUtf8().constData(), 1))
 				{
-					FileSel_ReadWrite(reinterpret_cast <void (*)(const char *)> (A_appendAvi), 0, fileName.toUtf8().data(), actual_workbench_file);
+					loadAudio(fileName.toUtf8().constData());
 				}
 			}
 			else

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp	2011-08-05 05:57:09 UTC (rev 7385)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/gtk_gui.cpp	2011-08-05 20:10:26 UTC (rev 7386)
@@ -76,7 +76,7 @@
 int A_loadNone( void );
 void A_saveAudioDecodedTest (char *name);
 int A_openAvi2 (const char *name, uint8_t mode);
-int A_appendAvi (const char *name);
+int A_appendAvi (const char *name, bool silent = 0);
 void A_externalAudioTrack( void );
 
 void HandleAction (Action action);
@@ -1121,35 +1121,42 @@
 //___________________________________________
 //  Append an AVI to the existing one
 //___________________________________________
-int
-A_appendAvi (const char *name)
+int	A_appendAvi (const char *name, bool silent)
 {
 	char *path = ADM_fixupPath(name);
 
-  if (playing)
-    return 0;
-  DIA_StartBusy ();
-  if (!video_body->addFile (path))
-    {
-      DIA_StopBusy ();
-      GUI_Error_HIG (QT_TR_NOOP("Something failed when appending"), NULL);
-	  delete [] path;
-      return 0;
-    }
-  delete [] path;
-  DIA_StopBusy ();
+	if (playing)
+		return 0;
 
+	DIA_StartBusy ();
 
-  video_body->dumpSeg ();
-  if (!video_body->updateVideoInfo (avifileinfo))
-    {
-      GUI_Error_HIG (QT_TR_NOOP("Something bad happened (II)"), NULL);
-      return 0;
-    }
+	if (!video_body->addFile (path))
+	{
+		DIA_StopBusy ();
 
-  ReSync ();
-  UI_setMarkers (frameStart, frameEnd);
-  return 1;
+		if (!silent)
+			GUI_Error_HIG (QT_TR_NOOP("Something failed when appending"), NULL);
+
+		delete [] path;
+		return 0;
+	}
+
+	delete [] path;
+	DIA_StopBusy ();
+
+	video_body->dumpSeg ();
+	if (!video_body->updateVideoInfo (avifileinfo))
+	{
+		if (!silent)
+			GUI_Error_HIG (QT_TR_NOOP("Something bad happened (II)"), NULL);
+
+		return 0;
+	}
+
+	ReSync ();
+	UI_setMarkers (frameStart, frameEnd);
+
+	return 1;
 }
 
 //



From gruntster at mail.berlios.de  Fri Aug  5 22:31:00 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Fri,  5 Aug 2011 22:31:00 +0200
Subject: [Avidemux-svn-commit] r7387 - in
	branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts:
	avidemux libogg libvpx
Message-ID: <20110805203100.D56C5481298@sheep.berlios.de>

Author: gruntster
Date: 2011-08-05 22:31:00 +0200 (Fri, 05 Aug 2011)
New Revision: 7387

Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libogg/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/Perform Build.bat
Log:
[mswin] update build scripts

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml	2011-08-05 20:10:26 UTC (rev 7386)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Package Notes.xml	2011-08-05 20:31:00 UTC (rev 7387)
@@ -1,284 +1,309 @@
 <?xml version="1.0"?>
 <log>
-	<buildentry revision="6796" date="2010-11-28">
-		<comment>Updated aften to version git version (commit: c0bd512c93b1186c28b45cc66f6e4f70fd41191c).</comment>
-		<comment>Updated libogg to version 1.2.1.</comment>
-		<comment>Updated libvorbis to version 1.3.2.</comment>
-		<comment>Updated libvpx to version 0.9.5.</comment>
-		<comment>Updated Qt to version 4.7.1.</comment>
-		<comment>Updated x264 to r1804.</comment>
-	</buildentry>
-	<buildentry revision="6714 [2.5.4 Final]" date="2010-11-01">
-		<comment>Updated Avisynth Proxy GUI to version 2.20.</comment>
-	</buildentry>
-	<buildentry revision="6689" date="2010-09-29">
-		<comment>Updated ATK to version 1.32.0-1.</comment>
-		<comment>Updated GLib to version 2.26.0-2.</comment>
-		<comment>Updated GTK+ to version 2.20.1-3.</comment>
-		<comment>Updated Pango to version 1.28.1-2.</comment>
-		<comment>Updated Qt to version 4.7.0.</comment>
-		<comment>Updated x264 to r1732.</comment>
-	</buildentry>
-	<buildentry revision="6636" date="2010-09-21">
-		<comment>Updated Cairo to version 1.10.0-1.</comment>
-		<comment>Compiled with GCC 4.5.2 pre-release (20100917)</comment>
-		<comment>Updated Qt to version 4.6.3.</comment>
-		<comment>Updated x264 to r1724.</comment>
-	</buildentry>
-	<buildentry revision="6587" date="2010-09-05">
-		<comment>Compiled with GCC 4.5.1.</comment>
-		<comment>Updated Cairo to version 1.8.10-4.</comment>
-		<comment>Updated Freetype to version 2.4.2-1.</comment>
-		<comment>Updated GLib to version 2.24.2-1.</comment>
-		<comment>Updated libvpx to version 0.9.2.</comment>
-		<comment>Updated NSPR to version 4.8.6.</comment>
-		<comment>Updated Pango to version 1.28.1-1.</comment>
-		<comment>Updated x264 to r1713.</comment>
-		<comment>Updated zlib to version 1.2.5-2.</comment>
-	</buildentry>
-	<buildentry revision="6502" date="2010-08-03">
-		<comment>Updated x264 to r1688.</comment>
-	</buildentry>
-	<buildentry revision="6442" date="2010-07-06">
-		<comment>Compiled with GCC 4.4.5 pre-release (r161668).</comment>
-		<comment>Updated libvpx to version 0.9.1.</comment>
-		<comment>Updated x264 to r1666.</comment>
-	</buildentry>
-	<buildentry revision="6370" date="2010-06-13">
-		<comment>Added libvpx, git version (commit: 5ef25a9728507d259c6ccd05064ce1208e7abd9f).</comment>
-		<comment>Updated x264 to r1624.</comment>
-	</buildentry>
-	<buildentry revision="6340" date="2010-06-07">
-	</buildentry>
-	<buildentry revision="6303" date="2010-06-04">
-	</buildentry>
-	<buildentry revision="6288" date="2010-06-01">
-	</buildentry>
-	<buildentry revision="6261" date="2010-05-27">
-		<comment>Updated x264 to r1613.</comment>
-	</buildentry>
-	<buildentry revision="6195" date="2010-05-16">
-		<comment>Updated Freetype to version 2.3.12-1.</comment>
-		<comment>Updated GLib to version 2.24.1-1.</comment>
-		<comment>Updated GTK+ to version 2.20.1-1.</comment>
-		<comment>Updated x264 to r1583.</comment>
-	</buildentry>
-	<buildentry revision="6161 [2.5.3 Final]" date="2010-05-16">
-		<comment>Updated Avisynth Proxy GUI to version 2.12.</comment>
-	</buildentry>
-	<buildentry revision="6129" date="2010-04-15">
-		<comment>Updated x264 to r1542.</comment>
-	</buildentry>
-	<buildentry revision="6121" date="2010-04-11">
-		<comment>Updated ATK to version 1.30.0-1.</comment>
-		<comment>Updated Cairo to version 1.8.10-3.</comment>
-		<comment>Updated GLib to version 2.24.0-2.</comment>
-		<comment>Updated GTK+ to version 2.20.0-1.</comment>
-		<comment>Updated Libxml2 to version 2.7.7-1.</comment>
-		<comment>Updated Pango to version 1.28.0-1.</comment>
-		<comment>Updated x264 to r1523.</comment>
-		<comment>Updated zlib to version 1.2.4-2.</comment>
-	</buildentry>
-	<buildentry revision="6083" date="2010-04-06">
-	</buildentry>
-	<buildentry revision="6064" date="2010-04-05">
-		<comment>Updated x264 to r1510.</comment>
-	</buildentry>
-	<buildentry revision="6028" date="2010-03-27">
-		<comment>Updated Avisynth Proxy GUI to version 2.11.</comment>
-		<comment>Updated GLib to version 2.22.5-1.</comment>
-		<comment>Updated GTK+ to version 2.18.9-1.</comment>
-		<comment>Updated LAME to version 3.98.4.</comment>
-		<comment>Updated Ogg to version 1.2.0.</comment>
-		<comment>Updated NSPR to version 4.8.4.</comment>
-		<comment>Updated Vorbis to version 1.3.1.</comment>
-	</buildentry>
-	<buildentry revision="5955" date="2010-02-28">
-		<comment>Compiled with GCC 4.4.3.</comment>
-		<comment>Updated Cairo to version 1.8.10-1.</comment>
-		<comment>Updated Freetype to version 2.3.11-2.</comment>
-		<comment>Updated GTK+ to version 2.18.7-1.</comment>
-		<comment>Updated LAME to version 3.98.3.</comment>
-		<comment>Updated libpng to version 1.4.0-1.</comment>
-		<comment>Updated NSPR to version 4.8.3.</comment>
-		<comment>Updated Pango to version 1.26.2-1.</comment>
-		<comment>Updated Qt to version 4.6.2.</comment>
-		<comment>Updated x264 to r1471.</comment>
-	</buildentry>
-	<buildentry revision="5869" date="2010-01-23">
-		<comment>Updated GLib to version 2.22.4-1.</comment>
-		<comment>Updated Qt to version 4.6.1.</comment>
-		<comment>Updated x264 to r1400.</comment>
-	</buildentry>
-	<buildentry revision="5830" date="2010-01-07">
-		<comment>Compiled with GCC 4.4.3 pre-release (r155431).</comment>
-	</buildentry>
-	<buildentry revision="5810" date="2010-01-02">
-	</buildentry>
-	<buildentry revision="5801" date="2009-12-31">
-	</buildentry>
-	<buildentry revision="5775" date="2009-12-29">
-	</buildentry>
-	<buildentry revision="5747" date="2009-12-28">
-	</buildentry>
-	<buildentry revision="5676" date="2009-12-20">
-		<comment>Packaged using NSIS 2.46.</comment>
-		<comment>Updated GTK+ to version 2.18.5-1.</comment>
-		<comment>Updated libpng to version 1.2.40-1.</comment>
-		<comment>Updated Pango to version 1.26.1-1.</comment>
-		<comment>Updated Qt to version 4.6.0.</comment>
-		<comment>Updated x264 to r1376.</comment>
-	</buildentry>
-	<buildentry revision="5660 [2.5.2 Final]" date="2009-12-19">
-	</buildentry>
-	<buildentry revision="5636 [2.5.2 RC1]" date="2009-12-12">
-	</buildentry>
-	<buildentry revision="5602" date="2009-11-30">
-	</buildentry>
-	<buildentry revision="5590" date="2009-11-28">
-		<comment>Updated Cairo to version 1.8.8-3.</comment>
-		<comment>Updated Fontconfig to version 2.8.0-1.</comment>
-		<comment>Updated Freetype to version 2.3.11-1.</comment>
-		<comment>Updated GLib to version 2.22.2-1.</comment>
-		<comment>Updated GTK+ to version 2.18.3-1.</comment>
-		<comment>Updated Pango to version 1.26.0-1.</comment>
-		<comment>Updated x264 to r1352.</comment>
-	</buildentry>
-	<buildentry revision="5567" date="2009-11-26">
-	</buildentry>
-	<buildentry revision="5558" date="2009-11-24">
-	</buildentry>
-	<buildentry revision="5546" date="2009-11-23">
-		<comment>Updated x264 to r1347.</comment>
-	</buildentry>
-	<buildentry revision="5530" date="2009-11-19">
-		<comment>Updated x264 to r1342.</comment>
-	</buildentry>
-	<buildentry revision="5422" date="2009-10-27">
-		<comment>Updated SDL to version 1.2.14.</comment>
-		<comment>Updated x264 to r1310.</comment>
-	</buildentry>
-	<buildentry revision="5369" date="2009-10-05">
-		<comment>Updated ATK to version 1.28.0-1.</comment>
-		<comment>Updated Fontconfig to version 2.7.3-1.</comment>
-		<comment>Updated GLib to version 2.22.1-1.</comment>
-		<comment>Updated GTK+ to version 2.18.1-1.</comment>
-		<comment>Updated libpng to version 1.2.39-1.</comment>
-		<comment>Updated Libxml2 to version 2.7.4-1.</comment>
-		<comment>Updated NSPR to version 4.8.</comment>
-		<comment>Updated opencore-amr to version 0.1.2.</comment>
-		<comment>Updated Qt to version 4.5.3.</comment>
-		<comment>Updated x264 to r1271.</comment>
-	</buildentry>
-	<buildentry revision="5341" date="2009-09-17">
-		<comment>Updated x264 to r1259.</comment>
-	</buildentry>
-	<buildentry revision="5327" date="2009-09-09">
-		<comment>Updated x264 to r1251.</comment>
-	</buildentry>
-	<buildentry revision="5281" date="2009-08-29">
-		<comment>Updated x264 to r1240.</comment>
-	</buildentry>
-	<buildentry revision="5273" date="2009-08-27">
-		<comment>Updated x264 to r1235.</comment>
-		<comment>Updated Xvid to version 1.2.2.</comment>
-	</buildentry>
-	<buildentry revision="5268" date="2009-08-23">
-		<comment>Updated x264 to r1222.</comment>
-	</buildentry>
-	<buildentry revision="5249 [2.5.1 Final]" date="2009-08-16">
-		<comment>Updated Fontconfig to version 2.7.1-2.</comment>
-	</buildentry>
-	<buildentry revision="5234" date="2009-08-12">
-		<comment>Updated Cairo to version 1.8.8-1.</comment>
-		<comment>Updated Fontconfig to version 2.7.1-1.</comment>
-		<comment>Updated Freetype to version 2.3.9-1.</comment>
-		<comment>Updated GLib to version 2.20.4-1.</comment>
-		<comment>Updated GTK+ to version 2.16.5-1.</comment>
-		<comment>Updated libpng to version 1.2.38-1.</comment>
-		<comment>Updated Pango to version 1.24.5-1.</comment>
-		<comment>Updated x264 to r1206.</comment>
-	</buildentry>
-	<buildentry revision="5204" date="2009-08-03">
-	</buildentry>
-	<buildentry revision="5181" date="2009-07-30">
-		<comment>Updated x264 to r1195.</comment>
-	</buildentry>
-	<buildentry revision="5152" date="2009-07-25">
-		<comment>Updated Avisynth Proxy GUI to version 2.09d.</comment>
-		<comment>Updated x264 to r1185.</comment>
-	</buildentry>
-	<buildentry revision="5104" date="2009-07-17">
-		<comment>Added opencore-amr version 0.1.1.</comment>
-		<comment>Updated x264 to r1183.</comment>
-	</buildentry>
-	<buildentry revision="5087" date="2009-07-13">
-	</buildentry>
-	<buildentry revision="5065" date="2009-07-12">
-		<comment>Updated Vorbis to version 1.2.3.</comment>
-		<comment>Updated x264 to r1181.</comment>
-	</buildentry>
-	<buildentry revision="5031" date="2009-07-10">
-		<comment>Recompiled FAAC with MinGW's GCC 4.2.1-sjlj-2.</comment>
-		<comment>Updated x264 to r1179.</comment>
-	</buildentry>
-	<buildentry revision="5010" date="2009-07-06">
-	</buildentry>
-	<buildentry revision="4997" date="2009-07-05">
-	</buildentry>
-	<buildentry revision="4992" date="2009-07-04">
-		<comment>Updated FAAC to version 1.28.</comment>
-		<comment>Updated FAAD2 to version 2.7.</comment>
-	</buildentry>
-	<buildentry revision="4968" date="2009-06-27">
-		<comment>Updated ATK to version 1.26.0-1.</comment>
-		<comment>Updated GLib to version 2.20.3-1.</comment>
-		<comment>Updated GTK+ to version 2.16.2-1.</comment>
-		<comment>Updated libpng to version 1.2.37-1.</comment>
-		<comment>Updated Ogg to version 1.1.4.</comment>
-		<comment>Updated Pango to version 1.24.2-1.</comment>
-		<comment>Updated Qt to version 4.5.2.</comment>
-		<comment>Updated Vorbis to version 1.2.2.</comment>
-		<comment>Updated x264 to r1173.</comment>
-	</buildentry>
-	<buildentry revision="4944 [2.5.0 Final]" date="2009-06-23">
-		<comment>Updated x264 to r1170.</comment>
-	</buildentry>
-	<buildentry revision="4871" date="2009-05-25">
-		<comment>Updated x264 to r1159.</comment>
-	</buildentry>
-	<buildentry revision="4763" date="2009-04-26">
-		<comment>Added Netscape Portable Runtime version 4.7.4.</comment>
-		<comment>Updated Pango to version 1.24.1-1.</comment>
-		<comment>Updated Qt to version 4.5.1.</comment>
-		<comment>Updated SpiderMonkey to version 1.7.0.</comment>
-	</buildentry>
-	<buildentry revision="4758" date="2009-04-22">
-		<comment>Updated Avisynth Proxy GUI to version 2.08.</comment>
-		<comment>Updated x264 to r1145.</comment>
-	</buildentry>
-	<buildentry revision="4741" date="2009-04-20">
-		<comment>Updated GLib to version 2.20.1-1.</comment>
-		<comment>Updated GTK+ to version 2.16.1-1.</comment>
-		<comment>Updated Pango to version 1.24.0-1.</comment>
-	</buildentry>
-	<buildentry revision="4685" date="2009-03-14">
-	</buildentry>
-	<buildentry revision="4658" date="2009-03-05">
-		<comment>Updated Qt to version 4.5.0.</comment>
-	</buildentry>
-	<buildentry revision="4648" date="2009-03-02">
-		<comment>Updated x264 to r1115.</comment>
-	</buildentry>
-	<buildentry revision="4629" date="2009-02-24">
-	</buildentry>
-	<buildentry revision="4618" date="2009-02-21">
-		<comment>Updated x264 to r1114.</comment>
-	</buildentry>
-	<buildentry revision="4609" date="2009-02-16">
-		<comment>Packaged using NSIS 2.43.</comment>
-		<comment>Updated Avisynth Proxy GUI to version 2.07 (2nd release).</comment>
-		<comment>Updated Libxml2 to version 2.7.3.</comment>
-		<comment>Updated x264 to r1113.</comment>
-	</buildentry>
+  <buildentry revision="7317" date="2011-07-10">
+    <comment>Compiled with GCC 4.6.1.</comment>
+    <comment>Updated x264 to r2019.</comment>
+  </buildentry>
+  <buildentry revision="7296" date="2011-06-19">
+    <comment>Compiled with GCC 4.6.1 pre-release (20110618).</comment>
+    <comment>Updated x264 to r2008.</comment>
+    <comment>Updated Xvid to version 1.3.2.</comment>
+  </buildentry>
+  <buildentry revision="7200" date="2011-05-12" />
+  <buildentry revision="7194" date="2011-05-08">
+    <comment>Compiled with GCC 4.5.2</comment>
+    <comment>Updated Freetype to version 2.4.4-1.</comment>
+    <comment>Updated GLib to version 2.28.1-1.</comment>
+    <comment>Updated libvpx to version 0.9.6.</comment>
+    <comment>Updated NSPR to version 4.8.8.</comment>
+    <comment>Updated Pango to version 1.28.1-3.</comment>
+    <comment>Updated Qt to version 4.7.3.</comment>
+    <comment>Updated x264 to r1947.</comment>
+    <comment>Updated Xvid to version 1.3.1.</comment>
+  </buildentry>
+  <buildentry revision="6854" date="2010-12-20">
+    <comment>Updated libogg to version 1.2.2.</comment>
+    <comment>Updated x264 to r1834.</comment>
+  </buildentry>
+  <buildentry revision="6796" date="2010-11-28">
+    <comment>Updated aften to version git version (commit: c0bd512c93b1186c28b45cc66f6e4f70fd41191c).</comment>
+    <comment>Updated libogg to version 1.2.1.</comment>
+    <comment>Updated libvorbis to version 1.3.2.</comment>
+    <comment>Updated libvpx to version 0.9.5.</comment>
+    <comment>Updated Qt to version 4.7.1.</comment>
+    <comment>Updated x264 to r1804.</comment>
+  </buildentry>
+  <buildentry revision="6714 [2.5.4 Final]" date="2010-11-01">
+    <comment>Updated Avisynth Proxy GUI to version 2.20.</comment>
+  </buildentry>
+  <buildentry revision="6689" date="2010-09-29">
+    <comment>Updated ATK to version 1.32.0-1.</comment>
+    <comment>Updated GLib to version 2.26.0-2.</comment>
+    <comment>Updated GTK+ to version 2.20.1-3.</comment>
+    <comment>Updated Pango to version 1.28.1-2.</comment>
+    <comment>Updated Qt to version 4.7.0.</comment>
+    <comment>Updated x264 to r1732.</comment>
+  </buildentry>
+  <buildentry revision="6636" date="2010-09-21">
+    <comment>Updated Cairo to version 1.10.0-1.</comment>
+    <comment>Compiled with GCC 4.5.2 pre-release (20100917)</comment>
+    <comment>Updated Qt to version 4.6.3.</comment>
+    <comment>Updated x264 to r1724.</comment>
+  </buildentry>
+  <buildentry revision="6587" date="2010-09-05">
+    <comment>Compiled with GCC 4.5.1.</comment>
+    <comment>Updated Cairo to version 1.8.10-4.</comment>
+    <comment>Updated Freetype to version 2.4.2-1.</comment>
+    <comment>Updated GLib to version 2.24.2-1.</comment>
+    <comment>Updated libvpx to version 0.9.2.</comment>
+    <comment>Updated NSPR to version 4.8.6.</comment>
+    <comment>Updated Pango to version 1.28.1-1.</comment>
+    <comment>Updated x264 to r1713.</comment>
+    <comment>Updated zlib to version 1.2.5-2.</comment>
+  </buildentry>
+  <buildentry revision="6502" date="2010-08-03">
+    <comment>Updated x264 to r1688.</comment>
+  </buildentry>
+  <buildentry revision="6442" date="2010-07-06">
+    <comment>Compiled with GCC 4.4.5 pre-release (r161668).</comment>
+    <comment>Updated libvpx to version 0.9.1.</comment>
+    <comment>Updated x264 to r1666.</comment>
+  </buildentry>
+  <buildentry revision="6370" date="2010-06-13">
+    <comment>Added libvpx, git version (commit: 5ef25a9728507d259c6ccd05064ce1208e7abd9f).</comment>
+    <comment>Updated x264 to r1624.</comment>
+  </buildentry>
+  <buildentry revision="6340" date="2010-06-07">
+  </buildentry>
+  <buildentry revision="6303" date="2010-06-04">
+  </buildentry>
+  <buildentry revision="6288" date="2010-06-01">
+  </buildentry>
+  <buildentry revision="6261" date="2010-05-27">
+    <comment>Updated x264 to r1613.</comment>
+  </buildentry>
+  <buildentry revision="6195" date="2010-05-16">
+    <comment>Updated Freetype to version 2.3.12-1.</comment>
+    <comment>Updated GLib to version 2.24.1-1.</comment>
+    <comment>Updated GTK+ to version 2.20.1-1.</comment>
+    <comment>Updated x264 to r1583.</comment>
+  </buildentry>
+  <buildentry revision="6161 [2.5.3 Final]" date="2010-05-16">
+    <comment>Updated Avisynth Proxy GUI to version 2.12.</comment>
+  </buildentry>
+  <buildentry revision="6129" date="2010-04-15">
+    <comment>Updated x264 to r1542.</comment>
+  </buildentry>
+  <buildentry revision="6121" date="2010-04-11">
+    <comment>Updated ATK to version 1.30.0-1.</comment>
+    <comment>Updated Cairo to version 1.8.10-3.</comment>
+    <comment>Updated GLib to version 2.24.0-2.</comment>
+    <comment>Updated GTK+ to version 2.20.0-1.</comment>
+    <comment>Updated Libxml2 to version 2.7.7-1.</comment>
+    <comment>Updated Pango to version 1.28.0-1.</comment>
+    <comment>Updated x264 to r1523.</comment>
+    <comment>Updated zlib to version 1.2.4-2.</comment>
+  </buildentry>
+  <buildentry revision="6083" date="2010-04-06">
+  </buildentry>
+  <buildentry revision="6064" date="2010-04-05">
+    <comment>Updated x264 to r1510.</comment>
+  </buildentry>
+  <buildentry revision="6028" date="2010-03-27">
+    <comment>Updated Avisynth Proxy GUI to version 2.11.</comment>
+    <comment>Updated GLib to version 2.22.5-1.</comment>
+    <comment>Updated GTK+ to version 2.18.9-1.</comment>
+    <comment>Updated LAME to version 3.98.4.</comment>
+    <comment>Updated Ogg to version 1.2.0.</comment>
+    <comment>Updated NSPR to version 4.8.4.</comment>
+    <comment>Updated Vorbis to version 1.3.1.</comment>
+  </buildentry>
+  <buildentry revision="5955" date="2010-02-28">
+    <comment>Compiled with GCC 4.4.3.</comment>
+    <comment>Updated Cairo to version 1.8.10-1.</comment>
+    <comment>Updated Freetype to version 2.3.11-2.</comment>
+    <comment>Updated GTK+ to version 2.18.7-1.</comment>
+    <comment>Updated LAME to version 3.98.3.</comment>
+    <comment>Updated libpng to version 1.4.0-1.</comment>
+    <comment>Updated NSPR to version 4.8.3.</comment>
+    <comment>Updated Pango to version 1.26.2-1.</comment>
+    <comment>Updated Qt to version 4.6.2.</comment>
+    <comment>Updated x264 to r1471.</comment>
+  </buildentry>
+  <buildentry revision="5869" date="2010-01-23">
+    <comment>Updated GLib to version 2.22.4-1.</comment>
+    <comment>Updated Qt to version 4.6.1.</comment>
+    <comment>Updated x264 to r1400.</comment>
+  </buildentry>
+  <buildentry revision="5830" date="2010-01-07">
+    <comment>Compiled with GCC 4.4.3 pre-release (r155431).</comment>
+  </buildentry>
+  <buildentry revision="5810" date="2010-01-02">
+  </buildentry>
+  <buildentry revision="5801" date="2009-12-31">
+  </buildentry>
+  <buildentry revision="5775" date="2009-12-29">
+  </buildentry>
+  <buildentry revision="5747" date="2009-12-28">
+  </buildentry>
+  <buildentry revision="5676" date="2009-12-20">
+    <comment>Packaged using NSIS 2.46.</comment>
+    <comment>Updated GTK+ to version 2.18.5-1.</comment>
+    <comment>Updated libpng to version 1.2.40-1.</comment>
+    <comment>Updated Pango to version 1.26.1-1.</comment>
+    <comment>Updated Qt to version 4.6.0.</comment>
+    <comment>Updated x264 to r1376.</comment>
+  </buildentry>
+  <buildentry revision="5660 [2.5.2 Final]" date="2009-12-19">
+  </buildentry>
+  <buildentry revision="5636 [2.5.2 RC1]" date="2009-12-12">
+  </buildentry>
+  <buildentry revision="5602" date="2009-11-30">
+  </buildentry>
+  <buildentry revision="5590" date="2009-11-28">
+    <comment>Updated Cairo to version 1.8.8-3.</comment>
+    <comment>Updated Fontconfig to version 2.8.0-1.</comment>
+    <comment>Updated Freetype to version 2.3.11-1.</comment>
+    <comment>Updated GLib to version 2.22.2-1.</comment>
+    <comment>Updated GTK+ to version 2.18.3-1.</comment>
+    <comment>Updated Pango to version 1.26.0-1.</comment>
+    <comment>Updated x264 to r1352.</comment>
+  </buildentry>
+  <buildentry revision="5567" date="2009-11-26">
+  </buildentry>
+  <buildentry revision="5558" date="2009-11-24">
+  </buildentry>
+  <buildentry revision="5546" date="2009-11-23">
+    <comment>Updated x264 to r1347.</comment>
+  </buildentry>
+  <buildentry revision="5530" date="2009-11-19">
+    <comment>Updated x264 to r1342.</comment>
+  </buildentry>
+  <buildentry revision="5422" date="2009-10-27">
+    <comment>Updated SDL to version 1.2.14.</comment>
+    <comment>Updated x264 to r1310.</comment>
+  </buildentry>
+  <buildentry revision="5369" date="2009-10-05">
+    <comment>Updated ATK to version 1.28.0-1.</comment>
+    <comment>Updated Fontconfig to version 2.7.3-1.</comment>
+    <comment>Updated GLib to version 2.22.1-1.</comment>
+    <comment>Updated GTK+ to version 2.18.1-1.</comment>
+    <comment>Updated libpng to version 1.2.39-1.</comment>
+    <comment>Updated Libxml2 to version 2.7.4-1.</comment>
+    <comment>Updated NSPR to version 4.8.</comment>
+    <comment>Updated opencore-amr to version 0.1.2.</comment>
+    <comment>Updated Qt to version 4.5.3.</comment>
+    <comment>Updated x264 to r1271.</comment>
+  </buildentry>
+  <buildentry revision="5341" date="2009-09-17">
+    <comment>Updated x264 to r1259.</comment>
+  </buildentry>
+  <buildentry revision="5327" date="2009-09-09">
+    <comment>Updated x264 to r1251.</comment>
+  </buildentry>
+  <buildentry revision="5281" date="2009-08-29">
+    <comment>Updated x264 to r1240.</comment>
+  </buildentry>
+  <buildentry revision="5273" date="2009-08-27">
+    <comment>Updated x264 to r1235.</comment>
+    <comment>Updated Xvid to version 1.2.2.</comment>
+  </buildentry>
+  <buildentry revision="5268" date="2009-08-23">
+    <comment>Updated x264 to r1222.</comment>
+  </buildentry>
+  <buildentry revision="5249 [2.5.1 Final]" date="2009-08-16">
+    <comment>Updated Fontconfig to version 2.7.1-2.</comment>
+  </buildentry>
+  <buildentry revision="5234" date="2009-08-12">
+    <comment>Updated Cairo to version 1.8.8-1.</comment>
+    <comment>Updated Fontconfig to version 2.7.1-1.</comment>
+    <comment>Updated Freetype to version 2.3.9-1.</comment>
+    <comment>Updated GLib to version 2.20.4-1.</comment>
+    <comment>Updated GTK+ to version 2.16.5-1.</comment>
+    <comment>Updated libpng to version 1.2.38-1.</comment>
+    <comment>Updated Pango to version 1.24.5-1.</comment>
+    <comment>Updated x264 to r1206.</comment>
+  </buildentry>
+  <buildentry revision="5204" date="2009-08-03">
+  </buildentry>
+  <buildentry revision="5181" date="2009-07-30">
+    <comment>Updated x264 to r1195.</comment>
+  </buildentry>
+  <buildentry revision="5152" date="2009-07-25">
+    <comment>Updated Avisynth Proxy GUI to version 2.09d.</comment>
+    <comment>Updated x264 to r1185.</comment>
+  </buildentry>
+  <buildentry revision="5104" date="2009-07-17">
+    <comment>Added opencore-amr version 0.1.1.</comment>
+    <comment>Updated x264 to r1183.</comment>
+  </buildentry>
+  <buildentry revision="5087" date="2009-07-13">
+  </buildentry>
+  <buildentry revision="5065" date="2009-07-12">
+    <comment>Updated Vorbis to version 1.2.3.</comment>
+    <comment>Updated x264 to r1181.</comment>
+  </buildentry>
+  <buildentry revision="5031" date="2009-07-10">
+    <comment>Recompiled FAAC with MinGW's GCC 4.2.1-sjlj-2.</comment>
+    <comment>Updated x264 to r1179.</comment>
+  </buildentry>
+  <buildentry revision="5010" date="2009-07-06">
+  </buildentry>
+  <buildentry revision="4997" date="2009-07-05">
+  </buildentry>
+  <buildentry revision="4992" date="2009-07-04">
+    <comment>Updated FAAC to version 1.28.</comment>
+    <comment>Updated FAAD2 to version 2.7.</comment>
+  </buildentry>
+  <buildentry revision="4968" date="2009-06-27">
+    <comment>Updated ATK to version 1.26.0-1.</comment>
+    <comment>Updated GLib to version 2.20.3-1.</comment>
+    <comment>Updated GTK+ to version 2.16.2-1.</comment>
+    <comment>Updated libpng to version 1.2.37-1.</comment>
+    <comment>Updated Ogg to version 1.1.4.</comment>
+    <comment>Updated Pango to version 1.24.2-1.</comment>
+    <comment>Updated Qt to version 4.5.2.</comment>
+    <comment>Updated Vorbis to version 1.2.2.</comment>
+    <comment>Updated x264 to r1173.</comment>
+  </buildentry>
+  <buildentry revision="4944 [2.5.0 Final]" date="2009-06-23">
+    <comment>Updated x264 to r1170.</comment>
+  </buildentry>
+  <buildentry revision="4871" date="2009-05-25">
+    <comment>Updated x264 to r1159.</comment>
+  </buildentry>
+  <buildentry revision="4763" date="2009-04-26">
+    <comment>Added Netscape Portable Runtime version 4.7.4.</comment>
+    <comment>Updated Pango to version 1.24.1-1.</comment>
+    <comment>Updated Qt to version 4.5.1.</comment>
+    <comment>Updated SpiderMonkey to version 1.7.0.</comment>
+  </buildentry>
+  <buildentry revision="4758" date="2009-04-22">
+    <comment>Updated Avisynth Proxy GUI to version 2.08.</comment>
+    <comment>Updated x264 to r1145.</comment>
+  </buildentry>
+  <buildentry revision="4741" date="2009-04-20">
+    <comment>Updated GLib to version 2.20.1-1.</comment>
+    <comment>Updated GTK+ to version 2.16.1-1.</comment>
+    <comment>Updated Pango to version 1.24.0-1.</comment>
+  </buildentry>
+  <buildentry revision="4685" date="2009-03-14">
+  </buildentry>
+  <buildentry revision="4658" date="2009-03-05">
+    <comment>Updated Qt to version 4.5.0.</comment>
+  </buildentry>
+  <buildentry revision="4648" date="2009-03-02">
+    <comment>Updated x264 to r1115.</comment>
+  </buildentry>
+  <buildentry revision="4629" date="2009-02-24">
+  </buildentry>
+  <buildentry revision="4618" date="2009-02-21">
+    <comment>Updated x264 to r1114.</comment>
+  </buildentry>
+  <buildentry revision="4609" date="2009-02-16">
+    <comment>Packaged using NSIS 2.43.</comment>
+    <comment>Updated Avisynth Proxy GUI to version 2.07 (2nd release).</comment>
+    <comment>Updated Libxml2 to version 2.7.3.</comment>
+    <comment>Updated x264 to r1113.</comment>
+  </buildentry>
 </log>

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libogg/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libogg/Perform Build.bat	2011-08-05 20:10:26 UTC (rev 7386)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libogg/Perform Build.bat	2011-08-05 20:31:00 UTC (rev 7387)
@@ -17,9 +17,9 @@
 call "../Set Common Environment Variables"
 if errorlevel 1 goto end
 
-set package=libogg-1.2.2.tar.gz
-set sourceFolder=libogg-1.2.2-%BuildBits%
-set tarFolder=libogg-1.2.2
+set package=libogg-1.3.0.tar.gz
+set sourceFolder=libogg-1.3.0-%BuildBits%
+set tarFolder=libogg-1.3.0
 set curDir=%CD%
 
 if not exist %package% (

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/Perform Build.bat	2011-08-05 20:10:26 UTC (rev 7386)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/Perform Build.bat	2011-08-05 20:31:00 UTC (rev 7387)
@@ -17,9 +17,9 @@
 call "../Set Common Environment Variables"
 if errorlevel 1 goto end
 
-set package=libvpx-v0.9.6.tar.bz2
-set sourceFolder=libvpx-0.9.6-%BuildBits%
-set tarFolder=libvpx-v0.9.6
+set package=libvpx-v0.9.7.tar.bz2
+set sourceFolder=libvpx-0.9.7-%BuildBits%
+set tarFolder=libvpx-v0.9.7
 set curDir=%CD%
 
 if not exist %package% (



From gruntster at mail.berlios.de  Fri Aug  5 22:33:41 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Fri,  5 Aug 2011 22:33:41 +0200
Subject: [Avidemux-svn-commit] r7388 - in
	branches/avidemux_2.5_branch_gruntster:
	avidemux/ADM_libraries cmake cmake/patches
Message-ID: <20110805203342.3DBA8481298@sheep.berlios.de>

Author: gruntster
Date: 2011-08-05 22:33:41 +0200 (Fri, 05 Aug 2011)
New Revision: 7388

Added:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.1.tar.bz2
Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.tar.bz2
Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegPrepareTar.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
Log:
[ffmpeg] upgrade ffmpeg to 0.8.1

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.1.tar.bz2 (from rev 7385, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.tar.bz2)
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.tar.bz2
===================================================================
(Binary files differ)

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2011-08-05 20:31:00 UTC (rev 7387)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2011-08-05 20:33:41 UTC (rev 7388)
@@ -1,6 +1,6 @@
 include(admFFmpegUtil)
 
-set(FFMPEG_VERSION 0.8)
+set(FFMPEG_VERSION 0.8.1)
 set(FFMPEG_SOURCE_ARCHIVE "ffmpeg-${FFMPEG_VERSION}.tar.bz2")
 set(FFMPEG_SOURCE_ARCHIVE_DIR "ffmpeg-${FFMPEG_VERSION}")
 

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegPrepareTar.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegPrepareTar.cmake	2011-08-05 20:31:00 UTC (rev 7387)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegPrepareTar.cmake	2011-08-05 20:33:41 UTC (rev 7388)
@@ -6,7 +6,7 @@
 #set(SWSCALE_SOURCE_ARCHIVE "libswscale_r${SWSCALE_VERSION}.tar.gz")
 
 if (EXISTS "${LIBRARY_SOURCE_DIR}/${FFMPEG_SOURCE_ARCHIVE}") # AND EXISTS "${LIBRARY_SOURCE_DIR}/${SWSCALE_SOURCE_ARCHIVE}")
-	if (NOT EXISTS "${FFMPEG_SOURCE_DIR}/ffmpeg.c" OR NOT "${LAST_FFMPEG_VERSION}" EQUAL "${FFMPEG_VERSION}")
+	if (NOT EXISTS "${FFMPEG_SOURCE_DIR}/ffmpeg.c" OR NOT "${LAST_FFMPEG_VERSION}" STREQUAL "${FFMPEG_VERSION}")
 		find_package(Tar)
 		message(STATUS "Extracting FFmpeg")
 
@@ -22,7 +22,7 @@
 
 		set(FFMPEG_PERFORM_PATCH 1)
 		set(FFMPEG_PERFORM_BUILD 1)
-	endif (NOT EXISTS "${FFMPEG_SOURCE_DIR}/ffmpeg.c" OR NOT "${LAST_FFMPEG_VERSION}" EQUAL "${FFMPEG_VERSION}")
+	endif (NOT EXISTS "${FFMPEG_SOURCE_DIR}/ffmpeg.c" OR NOT "${LAST_FFMPEG_VERSION}" STREQUAL "${FFMPEG_VERSION}")
 
 	#if (NOT EXISTS "${FFMPEG_SOURCE_DIR}/libswscale/swscale.c" OR NOT ${LAST_SWSCALE_VERSION} EQUAL ${SWSCALE_VERSION})
 		#find_package(Tar)

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2011-08-05 20:31:00 UTC (rev 7387)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2011-08-05 20:33:41 UTC (rev 7388)
@@ -2,7 +2,7 @@
 
 export curDir=$PWD
 export ffmpegPath=../../avidemux/ADM_libraries/ffmpeg
-export origFfmpegPath=../ffmpeg-0.8
+export origFfmpegPath=../ffmpeg-0.8.1
 
 function updatePatch {
 	#cd $ffmpegPath

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2011-08-05 20:31:00 UTC (rev 7387)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2011-08-05 20:33:41 UTC (rev 7388)
@@ -1,6 +1,6 @@
---- ../ffmpeg-0.8/libavcodec/h264.c	2011-06-23 20:23:54 +0100
-+++ libavcodec/h264.c	2011-06-23 20:23:54 +0100
-@@ -4178,6 +4178,20 @@
+--- ../ffmpeg-0.8.1/libavcodec/h264.c	2011-08-05 21:20:16 +0100
++++ libavcodec/h264.c	2011-08-05 21:20:16 +0100
+@@ -4179,6 +4179,20 @@
      { FF_PROFILE_UNKNOWN },
  };
  

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2011-08-05 20:31:00 UTC (rev 7387)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2011-08-05 20:33:41 UTC (rev 7388)
@@ -1,6 +1,6 @@
---- ../ffmpeg-0.8/libavcodec/utils.c	2011-06-23 20:23:55 +0100
-+++ libavcodec/utils.c	2011-06-23 20:23:55 +0100
-@@ -783,10 +783,12 @@
+--- ../ffmpeg-0.8.1/libavcodec/utils.c	2011-08-05 21:20:17 +0100
++++ libavcodec/utils.c	2011-08-05 21:20:17 +0100
+@@ -787,10 +787,12 @@
  
      if((avctx->codec->capabilities & CODEC_CAP_DELAY) || avpkt->size){
          //FIXME remove the check below _after_ ensuring that all audio check that the available space is enough



From gruntster at mail.berlios.de  Fri Aug  5 22:58:36 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Fri,  5 Aug 2011 22:58:36 +0200
Subject: [Avidemux-svn-commit] r7389 -
	branches/avidemux_2.5_branch_gruntster/cmake
Message-ID: <20110805205836.7F767481298@sheep.berlios.de>

Author: gruntster
Date: 2011-08-05 22:58:36 +0200 (Fri, 05 Aug 2011)
New Revision: 7389

Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
Log:
[ffmpeg] remove ffmpeg 0.8 build kludge

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2011-08-05 20:33:41 UTC (rev 7388)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2011-08-05 20:58:36 UTC (rev 7389)
@@ -18,7 +18,6 @@
 set(FFMPEG_MUXERS  flv  matroska  mpeg1vcd  mpeg2dvd  mpeg2svcd  mpegts  mov  mp4  psp)
 set(FFMPEG_PARSERS  ac3  h263  h264  mpeg4video)
 set(FFMPEG_PROTOCOLS  file)
-set(FFMPEG_FILTERS  buffersink)
 set(FFMPEG_FLAGS  --enable-shared --disable-static --disable-everything --enable-hwaccels --enable-postproc --enable-gpl 
 				  --enable-runtime-cpudetect --disable-network --disable-ffplay --disable-ffprobe --prefix=${CMAKE_INSTALL_PREFIX})
 
@@ -71,10 +70,6 @@
 	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-protocol=${protocol})
 endforeach (protocol)
 
-foreach (filter ${FFMPEG_FILTERS})
-	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-filter=${filter})
-endforeach (filter)
-
 if (WIN32)
 	if (ADM_CPU_X86_32)
 		set(FFMPEG_FLAGS ${FFMPEG_FLAGS} --enable-memalign-hack)



From mean at mail.berlios.de  Sun Aug  7 08:55:10 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Aug 2011 08:55:10 +0200
Subject: [Avidemux-svn-commit] r7390 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl:
	. glSmooth
Message-ID: <20110807065510.F1BE2483391@sheep.berlios.de>

Author: mean
Date: 2011-08-07 08:55:10 +0200 (Sun, 07 Aug 2011)
New Revision: 7390

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.ui
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth.conf
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth_desc.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth_json.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt
Log:
[openGl/filter] Smoothing filter

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt	2011-08-05 20:58:36 UTC (rev 7389)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt	2011-08-07 06:55:10 UTC (rev 7390)
@@ -1,3 +1,4 @@
+ADD_SUBDIRECTORY(glSmooth)
 ADD_SUBDIRECTORY(sample_fragment)
 ADD_SUBDIRECTORY(sample_fragment2)
 ADD_SUBDIRECTORY(sample_vertex)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/CMakeLists.txt	2011-08-07 06:55:10 UTC (rev 7390)
@@ -0,0 +1,7 @@
+INCLUDE(vf_plugin)
+INCLUDE(vf_plugin_qt4gl)
+
+
+SET(ADM_vf_glSmooth_SRCS glSmooth.cpp)
+INIT_VIDEO_FILTER_GLQT4(ADM_vf_glSmooth "${ADM_vf_glSmooth_SRCS}" "glSmooth.h" "glSmooth" "${ADM_vf_glSmooth_SRCS}")
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.cpp	2011-08-07 06:55:10 UTC (rev 7390)
@@ -0,0 +1,216 @@
+/** *************************************************************************
+                    \fn       openGlFragmentSample.cpp  
+                    \brief    simple fragment shader
+
+    This one is combining the 3 textures and apply the shader once
+
+
+    copyright            : (C) 2011 by mean
+
+bench : 1280*720, null shader, 20 ms, 95% of it in download texture.
+            Download Texture
+                RGB2Y=5ms               (MMX it)
+                toQimage=14 ms  <<==    TOO SLOW
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#define GL_GLEXT_PROTOTYPES
+
+#include <QtGui/QPainter>
+
+#ifdef __APPLE__
+#       include <OpenGL/gl.h>
+#       include <OpenGL/glext.h>
+#       define GL_TEXTURE_RECTANGLE_NV GL_TEXTURE_RECTANGLE_EXT
+#else
+#       include <GL/gl.h>
+#       include <GL/glext.h>
+#endif
+
+#include <QtGui/QImage>
+#include <QtOpenGL/QtOpenGL>
+#include <QtOpenGL/QGLShader>
+
+
+#define ADM_LEGACY_PROGGY
+#include "ADM_default.h"
+#include "ADM_coreVideoFilterInternal.h"
+#include "T_openGL.h"
+#include "T_openGLFilter.h"
+#include "glSmooth.h"
+#include "ADM_clock.h"
+/**
+
+*/
+
+//#define BENCH 1
+//#define BENCH_READTEXTURE
+
+
+/**
+    \class glSmooth
+*/
+class glSmooth : public  ADM_coreVideoFilterQtGl
+{
+protected:
+
+protected:
+                        bool render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo);
+public:
+                             glSmooth(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                            ~glSmooth();
+
+        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) {return true;}             /// Start graphical user interface
+};
+
+// Add the hook to make it valid plugin
+DECLARE_VIDEO_FILTER(   glSmooth,   // Class
+                        1,0,0,              // Version
+                        ADM_UI_QT4+ADM_UI_GL,         // UI
+                        VF_OPENGL,            // Category
+                        "glsampleFragment2",            // internal name (must be uniq!)
+                        "OpenGl Fragment Shader Sample2",            // Display name
+                        "Run a fragment shader." // Description
+                    );
+
+// Now implements the interesting parts
+/**
+    \fn glSmooth
+    \brief constructor
+*/
+glSmooth::glSmooth(  ADM_coreVideoFilter *in,CONFcouple *setup) : ADM_coreVideoFilterQtGl(in,setup)
+{
+UNUSED_ARG(setup);
+        widget->makeCurrent();
+        fboY->bind();
+        printf("Compiling shader \n");
+        glProgramY = new QGLShaderProgram(context);
+        ADM_assert(glProgramY);
+        if ( !glProgramY->addShaderFromSourceCode(QGLShader::Fragment, myShaderY))
+        {
+                ADM_error("[GL Render] Fragment log: %s\n", glProgramY->log().toUtf8().constData());
+                ADM_assert(0);
+        }
+        if ( !glProgramY->link())
+        {
+            ADM_error("[GL Render] Link log: %s\n", glProgramY->log().toUtf8().constData());
+            ADM_assert(0);
+        }
+
+        if ( !glProgramY->bind())
+        {
+                ADM_error("[GL Render] Binding FAILED\n");
+                ADM_assert(0);
+        }
+
+        fboY->release();
+        widget->doneCurrent();
+
+}
+/**
+    \fn glSmooth
+    \brief destructor
+*/
+glSmooth::~glSmooth()
+{
+
+}
+
+/**
+    \fn getFrame
+    \brief Get a processed frame
+*/
+bool glSmooth::getNextFrame(uint32_t *fn,ADMImage *image)
+{
+    // since we do nothing, just get the output of previous filter
+    if(false==previousFilter->getNextFrame(fn,image))
+    {
+        ADM_warning("FlipFilter : Cannot get frame\n");
+        return false;
+    }
+    widget->makeCurrent();
+    glPushMatrix();
+    // size is the last one...
+    fboY->bind();
+
+    float angle=*fn;
+    angle=angle/40;
+    glProgramY->setUniformValue("teta", angle);     
+    glProgramY->setUniformValue("myTextureU", 1); 
+    glProgramY->setUniformValue("myTextureV", 2); 
+    glProgramY->setUniformValue("myTextureY", 0); 
+    glProgramY->setUniformValue("myWidth", image->GetWidth(PLANAR_Y)); 
+    glProgramY->setUniformValue("myHeight", image->GetHeight(PLANAR_Y)); 
+
+    uploadAllPlanes(image);
+
+    render(image,PLANAR_Y,fboY);
+
+    downloadTextures(image,fboY);
+
+    fboY->release();
+    firstRun=false;
+    glPopMatrix();
+    widget->doneCurrent();
+    
+    return true;
+}
+/**
+    \fn getCoupledConf
+    \brief Return our current configuration as couple name=value
+*/
+bool         glSmooth::getCoupledConf(CONFcouple **couples)
+{
+    *couples=new CONFcouple(0); // Even if we dont have configuration we must allocate one 
+    return true;
+}
+/**
+    \fn getConfiguration
+    \brief Return current setting as a string
+*/
+const char *glSmooth::getConfiguration(void)
+{
+    
+    return "openGl Sample.";
+}
+
+
+/**
+    \fn render
+*/
+bool glSmooth::render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo)
+{
+    int width=image->GetWidth(plane);
+    int height=image->GetHeight(plane);
+
+    glClear(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);
+	glViewport(0, 0, width, height);
+    glMatrixMode(GL_PROJECTION);
+    glLoadIdentity();
+    glOrtho(0, width, 0, height, -1, 1);
+
+    //
+    glBegin(GL_QUADS);
+	glTexCoord2i(0, 0);
+	glVertex2i(0, 0);
+	glTexCoord2i(width, 0);
+	glVertex2i(width, 0);
+	glTexCoord2i(width, height);
+	glVertex2i(width ,height);
+	glTexCoord2i(0, height);
+	glVertex2i(0, height);
+	glEnd();	// draw cube background
+    return true;
+}
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.h	2011-08-07 06:55:10 UTC (rev 7390)
@@ -0,0 +1,23 @@
+// Invert x & y
+static const char *myShaderY =
+	"#extension GL_ARB_texture_rectangle: enable\n"
+	"uniform sampler2DRect myTextureY;\n" // tex unit 0
+    "uniform sampler2DRect myTextureU;\n" // tex unit 1
+    "uniform sampler2DRect myTextureV;\n" // tex unit 2
+    "uniform float myWidth;\n"
+    "uniform float myHeight;\n"
+    "uniform float teta;\n"
+
+	"void main(void) {\n"
+    "  float mx = gl_TexCoord[0].x;\n"
+	"  float my = gl_TexCoord[0].y;\n"
+    "  float c=cos(teta); \n"
+    "  float s=sin(teta); \n"
+    "  float nx=mx*c-my*s;\n"
+    "  float ny=mx*s+my*c;\n"
+    "  vec4 texvalV = texture2DRect(myTextureV, vec2(nx/2,ny/2));\n"
+    "  vec4 texvalU = texture2DRect(myTextureU, vec2(nx/2,ny/2));\n"
+	"  vec4 texvalY = texture2DRect(myTextureY, vec2(nx,ny));\n"
+	"  gl_FragColor = vec4(texvalY.r, texvalU.r, texvalV.r, 1.0);\n"
+	"}\n";
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.ui	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.ui	2011-08-07 06:55:10 UTC (rev 7390)
@@ -0,0 +1,724 @@
+<ui version="4.0" >
+ <class>resizeDialog</class>
+ <widget class="QDialog" name="resizeDialog" >
+  <property name="geometry" >
+   <rect>
+    <x>0</x>
+    <y>0</y>
+    <width>350</width>
+    <height>342</height>
+   </rect>
+  </property>
+  <property name="windowTitle" >
+   <string>Resize</string>
+  </property>
+  <layout class="QVBoxLayout" >
+   <property name="margin" >
+    <number>9</number>
+   </property>
+   <property name="spacing" >
+    <number>6</number>
+   </property>
+   <item>
+    <widget class="QGroupBox" name="groupBox_2" >
+     <property name="title" >
+      <string>Aspect Ratio</string>
+     </property>
+     <layout class="QVBoxLayout" >
+      <property name="margin" >
+       <number>9</number>
+      </property>
+      <property name="spacing" >
+       <number>6</number>
+      </property>
+      <item>
+       <widget class="QCheckBox" name="lockArCheckBox" >
+        <property name="text" >
+         <string>Lock Aspect Ratio</string>
+        </property>
+        <property name="checked" >
+         <bool>true</bool>
+        </property>
+       </widget>
+      </item>
+      <item>
+       <layout class="QHBoxLayout" >
+        <property name="margin" >
+         <number>0</number>
+        </property>
+        <property name="spacing" >
+         <number>6</number>
+        </property>
+        <item>
+         <widget class="QLabel" name="label_4" >
+          <property name="text" >
+           <string>Source:</string>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <widget class="QComboBox" name="comboBoxSource" >
+          <item>
+           <property name="text" >
+            <string>1:1</string>
+           </property>
+          </item>
+          <item>
+           <property name="text" >
+            <string>4:3</string>
+           </property>
+          </item>
+          <item>
+           <property name="text" >
+            <string>16:9</string>
+           </property>
+          </item>
+         </widget>
+        </item>
+        <item>
+         <spacer>
+          <property name="orientation" >
+           <enum>Qt::Horizontal</enum>
+          </property>
+          <property name="sizeType" >
+           <enum>QSizePolicy::Fixed</enum>
+          </property>
+          <property name="sizeHint" >
+           <size>
+            <width>30</width>
+            <height>20</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+        <item>
+         <widget class="QLabel" name="label_3" >
+          <property name="text" >
+           <string>Destination:</string>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <widget class="QComboBox" name="comboBoxDestination" >
+          <item>
+           <property name="text" >
+            <string>1:1</string>
+           </property>
+          </item>
+          <item>
+           <property name="text" >
+            <string>4:3</string>
+           </property>
+          </item>
+          <item>
+           <property name="text" >
+            <string>16:9</string>
+           </property>
+          </item>
+         </widget>
+        </item>
+        <item>
+         <spacer>
+          <property name="orientation" >
+           <enum>Qt::Horizontal</enum>
+          </property>
+          <property name="sizeHint" >
+           <size>
+            <width>40</width>
+            <height>20</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+       </layout>
+      </item>
+     </layout>
+    </widget>
+   </item>
+   <item>
+    <widget class="QGroupBox" name="groupBox" >
+     <property name="title" >
+      <string>Resize Dimensions</string>
+     </property>
+     <layout class="QVBoxLayout" >
+      <property name="margin" >
+       <number>9</number>
+      </property>
+      <property name="spacing" >
+       <number>6</number>
+      </property>
+      <item>
+       <layout class="QHBoxLayout" >
+        <property name="margin" >
+         <number>0</number>
+        </property>
+        <property name="spacing" >
+         <number>6</number>
+        </property>
+        <item>
+         <widget class="QLabel" name="label" >
+          <property name="text" >
+           <string>Width:</string>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <widget class="QSpinBox" name="spinBoxWidth" >
+          <property name="maximum" >
+           <number>2900</number>
+          </property>
+          <property name="minimum" >
+           <number>16</number>
+          </property>
+          <property name="singleStep" >
+           <number>2</number>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <spacer>
+          <property name="orientation" >
+           <enum>Qt::Horizontal</enum>
+          </property>
+          <property name="sizeType" >
+           <enum>QSizePolicy::Fixed</enum>
+          </property>
+          <property name="sizeHint" >
+           <size>
+            <width>30</width>
+            <height>20</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+        <item>
+         <widget class="QLabel" name="label_2" >
+          <property name="text" >
+           <string>Height:</string>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <widget class="QSpinBox" name="spinBoxHeight" >
+          <property name="maximum" >
+           <number>2000</number>
+          </property>
+          <property name="minimum" >
+           <number>16</number>
+          </property>
+          <property name="singleStep" >
+           <number>2</number>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <spacer>
+          <property name="orientation" >
+           <enum>Qt::Horizontal</enum>
+          </property>
+          <property name="sizeHint" >
+           <size>
+            <width>40</width>
+            <height>20</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+       </layout>
+      </item>
+      <item>
+       <widget class="QCheckBox" name="checkBoxRoundup" >
+        <property name="text" >
+         <string>Round to the Nearest Multiple of 16</string>
+        </property>
+       </widget>
+      </item>
+      <item>
+       <spacer>
+        <property name="orientation" >
+         <enum>Qt::Vertical</enum>
+        </property>
+        <property name="sizeType" >
+         <enum>QSizePolicy::Fixed</enum>
+        </property>
+        <property name="sizeHint" >
+         <size>
+          <width>312</width>
+          <height>4</height>
+         </size>
+        </property>
+       </spacer>
+      </item>
+      <item>
+       <layout class="QVBoxLayout" >
+        <property name="margin" >
+         <number>0</number>
+        </property>
+        <property name="spacing" >
+         <number>6</number>
+        </property>
+        <item>
+         <layout class="QHBoxLayout" >
+          <property name="margin" >
+           <number>0</number>
+          </property>
+          <property name="spacing" >
+           <number>12</number>
+          </property>
+          <item>
+           <layout class="QVBoxLayout" >
+            <property name="margin" >
+             <number>0</number>
+            </property>
+            <property name="spacing" >
+             <number>6</number>
+            </property>
+            <item>
+             <layout class="QHBoxLayout" >
+              <property name="margin" >
+               <number>0</number>
+              </property>
+              <property name="spacing" >
+               <number>6</number>
+              </property>
+              <item>
+               <widget class="QLabel" name="label_8" >
+                <property name="text" >
+                 <string>1%</string>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <spacer>
+                <property name="orientation" >
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" >
+                 <size>
+                  <width>40</width>
+                  <height>20</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
+              <item>
+               <widget class="QLabel" name="label_5" >
+                <property name="text" >
+                 <string>Percent</string>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <spacer>
+                <property name="orientation" >
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" >
+                 <size>
+                  <width>40</width>
+                  <height>20</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
+              <item>
+               <widget class="QLabel" name="label_9" >
+                <property name="text" >
+                 <string>200%</string>
+                </property>
+               </widget>
+              </item>
+             </layout>
+            </item>
+            <item>
+             <widget class="QSlider" name="horizontalSlider" >
+              <property name="minimum" >
+               <number>1</number>
+              </property>
+              <property name="maximum" >
+               <number>200</number>
+              </property>
+              <property name="value" >
+               <number>100</number>
+              </property>
+              <property name="orientation" >
+               <enum>Qt::Horizontal</enum>
+              </property>
+             </widget>
+            </item>
+           </layout>
+          </item>
+          <item>
+           <widget class="QSpinBox" name="percentageSpinBox" >
+            <property name="maximum" >
+             <number>200</number>
+            </property>
+            <property name="minimum" >
+             <number>1</number>
+            </property>
+            <property name="value" >
+             <number>100</number>
+            </property>
+           </widget>
+          </item>
+         </layout>
+        </item>
+        <item>
+         <layout class="QHBoxLayout" >
+          <property name="margin" >
+           <number>0</number>
+          </property>
+          <property name="spacing" >
+           <number>6</number>
+          </property>
+          <item>
+           <widget class="QLabel" name="label_10" >
+            <property name="text" >
+             <string>Error X / Y:</string>
+            </property>
+           </widget>
+          </item>
+          <item>
+           <widget class="QLabel" name="labelErrorXY" >
+            <property name="text" >
+             <string>0.00 / 0.00</string>
+            </property>
+           </widget>
+          </item>
+          <item>
+           <spacer>
+            <property name="orientation" >
+             <enum>Qt::Horizontal</enum>
+            </property>
+            <property name="sizeHint" >
+             <size>
+              <width>40</width>
+              <height>20</height>
+             </size>
+            </property>
+           </spacer>
+          </item>
+         </layout>
+        </item>
+       </layout>
+      </item>
+     </layout>
+    </widget>
+   </item>
+   <item>
+    <spacer>
+     <property name="orientation" >
+      <enum>Qt::Vertical</enum>
+     </property>
+     <property name="sizeType" >
+      <enum>QSizePolicy::Fixed</enum>
+     </property>
+     <property name="sizeHint" >
+      <size>
+       <width>332</width>
+       <height>6</height>
+      </size>
+     </property>
+    </spacer>
+   </item>
+   <item>
+    <layout class="QHBoxLayout" >
+     <property name="margin" >
+      <number>0</number>
+     </property>
+     <property name="spacing" >
+      <number>6</number>
+     </property>
+     <item>
+      <widget class="QLabel" name="label_6" >
+       <property name="text" >
+        <string>Resize Method:</string>
+       </property>
+      </widget>
+     </item>
+     <item>
+      <widget class="QComboBox" name="comboBoxAlgo" >
+       <item>
+        <property name="text" >
+         <string>Bilinear</string>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>Bicubic</string>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>Lanzcos3</string>
+        </property>
+       </item>
+      </widget>
+     </item>
+     <item>
+      <spacer>
+       <property name="orientation" >
+        <enum>Qt::Horizontal</enum>
+       </property>
+       <property name="sizeHint" >
+        <size>
+         <width>40</width>
+         <height>20</height>
+        </size>
+       </property>
+      </spacer>
+     </item>
+    </layout>
+   </item>
+   <item>
+    <spacer>
+     <property name="orientation" >
+      <enum>Qt::Vertical</enum>
+     </property>
+     <property name="sizeType" >
+      <enum>QSizePolicy::MinimumExpanding</enum>
+     </property>
+     <property name="sizeHint" >
+      <size>
+       <width>20</width>
+       <height>16</height>
+      </size>
+     </property>
+    </spacer>
+   </item>
+   <item>
+    <widget class="QDialogButtonBox" name="buttonBox" >
+     <property name="orientation" >
+      <enum>Qt::Horizontal</enum>
+     </property>
+     <property name="standardButtons" >
+      <set>QDialogButtonBox::Cancel|QDialogButtonBox::NoButton|QDialogButtonBox::Ok</set>
+     </property>
+    </widget>
+   </item>
+  </layout>
+ </widget>
+ <tabstops>
+  <tabstop>lockArCheckBox</tabstop>
+  <tabstop>comboBoxSource</tabstop>
+  <tabstop>comboBoxDestination</tabstop>
+  <tabstop>spinBoxWidth</tabstop>
+  <tabstop>spinBoxHeight</tabstop>
+  <tabstop>checkBoxRoundup</tabstop>
+  <tabstop>horizontalSlider</tabstop>
+  <tabstop>percentageSpinBox</tabstop>
+  <tabstop>comboBoxAlgo</tabstop>
+  <tabstop>buttonBox</tabstop>
+ </tabstops>
+ <resources/>
+ <connections>
+  <connection>
+   <sender>buttonBox</sender>
+   <signal>rejected()</signal>
+   <receiver>resizeDialog</receiver>
+   <slot>reject()</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>316</x>
+     <y>260</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>286</x>
+     <y>274</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_8</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>39</x>
+     <y>148</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_5</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>150</x>
+     <y>148</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_9</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>267</x>
+     <y>148</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>horizontalSlider</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>156</x>
+     <y>164</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>percentageSpinBox</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>317</x>
+     <y>155</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>checkBoxRoundup</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>95</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_10</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>155</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>55</x>
+     <y>251</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>labelErrorXY</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>155</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>114</x>
+     <y>251</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_4</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>69</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>46</x>
+     <y>95</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>comboBoxSource</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>69</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>94</x>
+     <y>95</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_3</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>69</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>188</x>
+     <y>95</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>comboBoxDestination</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>69</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>247</x>
+     <y>95</y>
+    </hint>
+   </hints>
+  </connection>
+ </connections>
+</ui>

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth.conf	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth.conf	2011-08-07 06:55:10 UTC (rev 7390)
@@ -0,0 +1,4 @@
+smooth{
+uint32_t:threshold;
+bool:showMask;
+}

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth.h	2011-08-07 06:55:10 UTC (rev 7390)
@@ -0,0 +1,8 @@
+// automatically generated by admSerialization.py do not edit
+#ifndef ADM_smooth_CONF_H
+#define ADM_smooth_CONF_H
+typedef struct {
+uint32_t threshold;
+bool showMask;
+}smooth;
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth_desc.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth_desc.cpp	2011-08-07 06:55:10 UTC (rev 7390)
@@ -0,0 +1,6 @@
+// automatically generated by admSerialization.py, do not edit!
+extern const ADM_paramList smooth_param[]={
+ {"threshold",offsetof(smooth,threshold),"uint32_t",ADM_param_uint32_t},
+ {"showMask",offsetof(smooth,showMask),"bool",ADM_param_bool},
+{NULL,0,NULL}
+};

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth_json.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth_json.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/smooth_json.cpp	2011-08-07 06:55:10 UTC (rev 7390)
@@ -0,0 +1,19 @@
+// automatically generated by admSerialization.py, do not edit!
+#include "ADM_default.h"
+#include "ADM_paramList.h"
+#include "ADM_coreJson.h"
+#include "smooth.h"
+bool  smooth_jserialize(const char *file, const smooth *key){
+admJson json;
+json.addUint32("threshold",key->threshold);
+json.addBool("showMask",key->showMask);
+return json.dumpToFile(file);
+};
+bool  smooth_jdeserialize(const char *file, const ADM_paramList *tmpl,smooth *key){
+admJsonToCouple json;
+CONFcouple *c=json.readFromFile(file);
+if(!c) {ADM_error("Cannot read json file");return false;}
+bool r= ADM_paramLoadPartial(c,tmpl,key);
+delete c;
+return r;
+};



From mean at mail.berlios.de  Sun Aug  7 08:55:12 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Aug 2011 08:55:12 +0200
Subject: [Avidemux-svn-commit] r7391 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth
Message-ID: <20110807065512.9B553483391@sheep.berlios.de>

Author: mean
Date: 2011-08-07 08:55:12 +0200 (Sun, 07 Aug 2011)
New Revision: 7391

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.h
Log:
[glSmooth] Simple blur filter for the moment

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.cpp	2011-08-07 06:55:10 UTC (rev 7390)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.cpp	2011-08-07 06:55:12 UTC (rev 7391)
@@ -1,17 +1,12 @@
 /** *************************************************************************
-                    \fn       openGlFragmentSample.cpp  
+                    \fn       glSmooth Filter.cpp  
                     \brief    simple fragment shader
 
-    This one is combining the 3 textures and apply the shader once
+    Smoothing filter
+    Do a 3x3 convolution on a image to get a mask
+    Depending on the mask we let through or do convolution
 
-
-    copyright            : (C) 2011 by mean
-
-bench : 1280*720, null shader, 20 ms, 95% of it in download texture.
-            Download Texture
-                RGB2Y=5ms               (MMX it)
-                toQimage=14 ms  <<==    TOO SLOW
-
+    
  ***************************************************************************/
 
 /***************************************************************************
@@ -79,9 +74,9 @@
                         1,0,0,              // Version
                         ADM_UI_QT4+ADM_UI_GL,         // UI
                         VF_OPENGL,            // Category
-                        "glsampleFragment2",            // internal name (must be uniq!)
-                        "OpenGl Fragment Shader Sample2",            // Display name
-                        "Run a fragment shader." // Description
+                        "glSmooth",            // internal name (must be uniq!)
+                        "OpenGl Smooth",            // Display name
+                        "Smooth image while preserving edge." // Description
                     );
 
 // Now implements the interesting parts

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.h	2011-08-07 06:55:10 UTC (rev 7390)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.h	2011-08-07 06:55:12 UTC (rev 7391)
@@ -9,15 +9,23 @@
     "uniform float teta;\n"
 
 	"void main(void) {\n"
-    "  float mx = gl_TexCoord[0].x;\n"
-	"  float my = gl_TexCoord[0].y;\n"
-    "  float c=cos(teta); \n"
-    "  float s=sin(teta); \n"
-    "  float nx=mx*c-my*s;\n"
-    "  float ny=mx*s+my*c;\n"
-    "  vec4 texvalV = texture2DRect(myTextureV, vec2(nx/2,ny/2));\n"
-    "  vec4 texvalU = texture2DRect(myTextureU, vec2(nx/2,ny/2));\n"
-	"  vec4 texvalY = texture2DRect(myTextureY, vec2(nx,ny));\n"
-	"  gl_FragColor = vec4(texvalY.r, texvalU.r, texvalV.r, 1.0);\n"
+    "  float mmin=255,mmax=0,r;\n"
+    "  float nx = gl_TexCoord[0].x;\n"
+	"  float ny = gl_TexCoord[0].y;\n"
+    "  vec4 texvalV = vec4(0,0,0,0);\n"
+    "  vec4 texvalU = vec4(0,0,0,0);\n"
+	"  vec4 texvalY = vec4(0,0,0,0);\n"
+    "  int x=0,y=0;\n"
+    "  for(y=-1;y<2;y++)\n"
+    "   for(x=-1;x<2;x++)\n"
+    "  { \n"
+    "   r=texture2DRect(myTextureY, vec2(x+nx,y+ny));\n"
+    "   texvalV += texture2DRect(myTextureV, vec2(x+nx/2,y+ny/2));\n"
+    "   texvalU += texture2DRect(myTextureU, vec2(x+nx/2,y+ny/2));\n"
+	"   texvalY += r;\n"
+    "  }"
+    "  float t=texvalY.r/9;\n"
+    "  r=t;"
+	"  gl_FragColor = vec4(r, texvalU.r/9, texvalV.r/9, 1.0);\n"
 	"}\n";
 



From mean at mail.berlios.de  Sun Aug  7 08:55:14 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Aug 2011 08:55:14 +0200
Subject: [Avidemux-svn-commit] r7392 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2:
	. include/mp4v2 libplatform
Message-ID: <20110807065514.53A00483391@sheep.berlios.de>

Author: mean
Date: 2011-08-07 08:55:14 +0200 (Sun, 07 Aug 2011)
New Revision: 7392

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/include/mp4v2/platform.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/platform.h
Log:
[mp4v2] Try to remove win32 stuff and use avidemux adaptation layer

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/CMakeLists.txt	2011-08-07 06:55:12 UTC (rev 7391)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/CMakeLists.txt	2011-08-07 06:55:14 UTC (rev 7392)
@@ -87,16 +87,16 @@
 	./src/rtphint.cpp
 	./src/text.cpp	)
 # Platform files
-if(WIN32)
-	SET(PLATFORM
-		libplatform/io/File_win32.cpp
-		libplatform/io/FileSystem_win32.cpp
-		libplatform/number/random_win32.cpp
-		libplatform/process/process_win32.cpp
-		libplatform/time/time_win32.cpp
-	
- 	)
-else(WIN32)
+#if(WIN32)
+#	SET(PLATFORM
+		#libplatform/io/File_win32.cpp
+		#libplatform/io/FileSystem_win32.cpp
+		#libplatform/number/random_win32.cpp
+		#libplatform/process/process_win32.cpp
+		#libplatform/time/time_win32.cpp
+#	
+ 	#)
+#else(WIN32)
 		SET(PLATFORM
 			libplatform/io/File_posix.cpp
 			libplatform/io/FileSystem_posix.cpp
@@ -105,7 +105,7 @@
 			libplatform/time/time_posix.cpp
 	
  		)
-endif(WIN32)
+#endif(WIN32)
 
 SET(PLATFORM ${PLATFORM}
 	libplatform/io/File.cpp

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/include/mp4v2/platform.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/include/mp4v2/platform.h	2011-08-07 06:55:12 UTC (rev 7391)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/include/mp4v2/platform.h	2011-08-07 06:55:14 UTC (rev 7392)
@@ -7,7 +7,7 @@
 #include <stdio.h>
 #include <stdarg.h>
 
-#if defined( _WIN32 ) && !defined( __MINGW32__ )
+#if  0 // MEANX defined( _WIN32 ) && !defined( __MINGW32__ )
     typedef char      int8_t;
     typedef short     int16_t;
     typedef int       int32_t;
@@ -21,7 +21,9 @@
 #   include <stdint.h>
 #endif
 
-#if defined( _WIN32 ) || defined( __MINGW32__ )
+#include "ADM_cpp.h" // MEANX
+
+#if 0 // MEANX defined( _WIN32 ) || defined( __MINGW32__ )
 #   if defined( _WINDLL ) || defined( DLL_EXPORT )
 #       define MP4V2_EXPORT __declspec(dllexport)
 #   elif defined( DLL_IMPORT ) 
@@ -84,7 +86,8 @@
 #endif
 #endif
 #endif
-
+#define ADM_LEGACY_PROGGY
+#include "ADM_default.h"
 /*****************************************************************************/
 
 #endif /* MP4V2_PLATFORM_H */

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/platform.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/platform.h	2011-08-07 06:55:12 UTC (rev 7391)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/platform.h	2011-08-07 06:55:14 UTC (rev 7392)
@@ -18,11 +18,11 @@
 
 ///////////////////////////////////////////////////////////////////////////////
 
-#if defined( _WIN32 )
-#   include "libplatform/platform_win32.h"
-#else
+// MEANX #if defined( _WIN32 )
+// MEANX #   include "libplatform/platform_win32.h"
+// MEANX #else
 #   include "libplatform/platform_posix.h"
-#endif
+// MEANX #endif
 
 ///////////////////////////////////////////////////////////////////////////////
 



From mean at mail.berlios.de  Sun Aug  7 09:11:41 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Aug 2011 09:11:41 +0200
Subject: [Avidemux-svn-commit] r7393 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2
Message-ID: <20110807071141.E1BB4483391@sheep.berlios.de>

Author: mean
Date: 2011-08-07 09:11:41 +0200 (Sun, 07 Aug 2011)
New Revision: 7393

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/CMakeLists.txt
Log:
[mp4v2] need time and process and random win32 flavor

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/CMakeLists.txt	2011-08-07 06:55:14 UTC (rev 7392)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/CMakeLists.txt	2011-08-07 07:11:41 UTC (rev 7393)
@@ -87,27 +87,28 @@
 	./src/rtphint.cpp
 	./src/text.cpp	)
 # Platform files
-#if(WIN32)
-#	SET(PLATFORM
-		#libplatform/io/File_win32.cpp
-		#libplatform/io/FileSystem_win32.cpp
-		#libplatform/number/random_win32.cpp
-		#libplatform/process/process_win32.cpp
-		#libplatform/time/time_win32.cpp
-#	
- 	#)
-#else(WIN32)
+if(WIN32)
+	SET(PLATFORM
+		libplatform/number/random_win32.cpp
+		libplatform/process/process_win32.cpp
+		libplatform/time/time_win32.cpp
+	
+ 	)
+else(WIN32)
 		SET(PLATFORM
-			libplatform/io/File_posix.cpp
-			libplatform/io/FileSystem_posix.cpp
 			libplatform/number/random_posix.cpp
 			libplatform/process/process_posix.cpp
 			libplatform/time/time_posix.cpp
 	
  		)
-#endif(WIN32)
+endif(WIN32)
 
 SET(PLATFORM ${PLATFORM}
+
+			libplatform/io/File_posix.cpp
+			libplatform/io/FileSystem_posix.cpp
+
+
 	libplatform/io/File.cpp
 	libplatform/io/FileSystem.cpp
 	libplatform/prog/option.cpp



From mean at mail.berlios.de  Sun Aug  7 11:09:50 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Aug 2011 11:09:50 +0200
Subject: [Avidemux-svn-commit] r7394 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io
Message-ID: <20110807090950.CB4CA4833AA@sheep.berlios.de>

Author: mean
Date: 2011-08-07 11:09:50 +0200 (Sun, 07 Aug 2011)
New Revision: 7394

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/FileSystem_posix.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/File_posix.cpp
Log:
[mp4v2] Use our wrapper to deal with non ascii filename on win32

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/FileSystem_posix.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/FileSystem_posix.cpp	2011-08-07 07:11:41 UTC (rev 7393)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/FileSystem_posix.cpp	2011-08-07 09:09:50 UTC (rev 7394)
@@ -1,6 +1,13 @@
+#include "ADM_cpp.h"
+
 #include "libplatform/impl.h"
 #include <sys/stat.h>
 
+#define ADM_LEGACY_PROGGY
+#include "ADM_default.h"
+
+// MEANX : Switch to our own wrappers
+
 namespace mp4v2 { namespace platform { namespace io {
 
 ///////////////////////////////////////////////////////////////////////////////
@@ -8,8 +15,11 @@
 bool
 FileSystem::exists( string path_ )
 {
+    return ADM_fileExist(path_.c_str());
+/*
     struct stat buf;
     return stat( path_.c_str(), &buf ) == 0;
+*/
 }
 
 ///////////////////////////////////////////////////////////////////////////////
@@ -39,12 +49,16 @@
 bool
 FileSystem::getFileSize( string path_, File::Size& size_ )
 {
+/*
     size_ = 0;
     struct stat buf;
     if( stat( path_.c_str(), &buf ))
         return true;
     size_ = buf.st_size;
     return false;
+*/
+    size_=ADM_fileSize(path_.c_str());
+    return false;
 }
 
 ///////////////////////////////////////////////////////////////////////////////
@@ -52,7 +66,17 @@
 bool
 FileSystem::rename( string from, string to )
 {
-    return ::rename( from.c_str(), to.c_str() ) != 0;
+    if(false==ADM_copyFile(from.c_str(),to.c_str()))
+    {
+        ADM_error("Cannot copy %s to %s\n",from.c_str(),to.c_str());
+        return true;
+    }
+    if(false==ADM_eraseFile(from.c_str()))
+    {
+        ADM_error("Cannot delete %s\n",from.c_str());
+        return true;
+    }
+    return false;
 }
 
 ///////////////////////////////////////////////////////////////////////////////

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/File_posix.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/File_posix.cpp	2011-08-07 07:11:41 UTC (rev 7393)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/File_posix.cpp	2011-08-07 09:09:50 UTC (rev 7394)
@@ -1,5 +1,10 @@
+#include "ADM_cpp.h"
 #include "libplatform/impl.h"
+#define ADM_LEGACY_PROGGY
+#include "ADM_default.h"
 
+// MEANX : Change fstream based io to FILE based io to be compatible with avidemux wrapper
+
 namespace mp4v2 { namespace platform { namespace io {
 
 ///////////////////////////////////////////////////////////////////////////////
@@ -18,7 +23,7 @@
 private:
     bool         _seekg;
     bool         _seekp;
-    std::fstream _fstream;
+    FILE         *_file;
 };
 
 ///////////////////////////////////////////////////////////////////////////////
@@ -27,73 +32,85 @@
     : _seekg ( false )
     , _seekp ( false )
 {
+    _file=NULL;
 }
 
 bool
 StandardFileProvider::open( std::string name, Mode mode )
 {
     ios::openmode om = ios::binary;
+    std::string fmode;
     switch( mode ) {
         case MODE_UNDEFINED:
         case MODE_READ:
         default:
-            om |= ios::in;
+            fmode+=std::string("r");
             _seekg = true;
             _seekp = false;
             break;
 
         case MODE_MODIFY:
-            om |= ios::in | ios::out;
+            fmode+=std::string("rw");
             _seekg = true;
             _seekp = true;
             break;
 
         case MODE_CREATE:
-            om |= ios::in | ios::out | ios::trunc;
+            fmode+=std::string("w");
             _seekg = true;
             _seekp = true;
             break;
     }
-
-    _fstream.open( name.c_str(), om );
-    return _fstream.fail();
+    fmode+=std::string("b");
+    _file=fopen(name.c_str(),fmode.c_str());
+    if(!_file) 
+    {
+        ADM_error("Cannot create file %s mode %s\n",name.c_str(),fmode.c_str());
+        return true;
+    }
+    ADM_info("Created file %s mode %s\n",name.c_str(),fmode.c_str());
+    return false;
 }
 
 bool
 StandardFileProvider::seek( Size pos )
 {
+int er=1;
     if( _seekg )
-        _fstream.seekg( pos, ios::beg );
+        er=fseeko(_file,pos,SEEK_SET);
     if( _seekp )
-        _fstream.seekp( pos, ios::beg );
-    return _fstream.fail();
+        er=fseeko(_file,pos,SEEK_SET);
+    if(er)
+    {
+        ADM_error("Seek to %d failed\n",(int)pos);
+        return true;
+    }
+    return false;
 }
 
 bool
 StandardFileProvider::read( void* buffer, Size size, Size& nin, Size maxChunkSize )
 {
-    _fstream.read( (char*)buffer, size );
-    if( _fstream.fail() )
-        return true;
-    nin = _fstream.gcount();
+    nin=fread(buffer,1,size,_file);
+    if(nin<=0) return true;
     return false;
 }
 
 bool
 StandardFileProvider::write( const void* buffer, Size size, Size& nout, Size maxChunkSize )
 {
-    _fstream.write( (const char*)buffer, size );
-    if( _fstream.fail() )
-        return true;
-    nout = size;
+    nout=fwrite(buffer,1,size,_file);
+    if(nout<=0) return true;
     return false;
 }
 
 bool
 StandardFileProvider::close()
 {
-    _fstream.close();
-    return _fstream.fail();
+    if(_file)
+        fclose(_file);
+    _file=NULL;
+    return true;
 }
 
 ///////////////////////////////////////////////////////////////////////////////



From mean at mail.berlios.de  Sun Aug  7 12:49:47 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Aug 2011 12:49:47 +0200
Subject: [Avidemux-svn-commit] r7395 - in branches/avidemux_2.6_branch_mean:
	avidemux_core/ADM_core/include avidemux_core/ADM_core/src
	avidemux_plugins/ADM_muxers/muxerMp4v2
	avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io
Message-ID: <20110807104948.26535480F7E@sheep.berlios.de>

Author: mean
Date: 2011-08-07 12:49:47 +0200 (Sun, 07 Aug 2011)
New Revision: 7395

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_files.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/FileSystem_posix.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.cpp
Log:
[mp4v2] Add a ADM_fileRename function that works with avidemux/win32. USe that functionin libmp4v2

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_files.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_files.h	2011-08-07 09:09:50 UTC (rev 7394)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_files.h	2011-08-07 10:49:47 UTC (rev 7395)
@@ -29,6 +29,7 @@
 const char *ADM_getSystemPluginSettingsDir(void);
 //
 uint8_t ADM_copyFile(const char *source, const char *target);
+uint8_t ADM_renameFile(const char *source, const char *target);
 #ifdef __cplusplus
 /* Returns the full path relative to install dir i.e. /usr +base1/base2, needs to be deleted [] by caller */
 char *ADM_getInstallRelativePath(const char *base1, const char *base2=NULL,const char *base3=NULL);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp	2011-08-07 09:09:50 UTC (rev 7394)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_fileio.cpp	2011-08-07 10:49:47 UTC (rev 7395)
@@ -784,4 +784,28 @@
     fclose(fin);
     fclose(fout);
     return true;
-}
\ No newline at end of file
+}
+
+/**
+    \fn ADM_copyFile
+*/
+uint8_t ADM_renameFile(const char *source, const char *target)
+{
+#ifdef __MINGW32__
+	int sourceFileNameLength = utf8StringToWideChar(source, -1, NULL);
+    int targetFileNameLength = utf8StringToWideChar(target, -1, NULL);
+    wchar_t wcFileSource[sourceFileNameLength];
+    wchar_t wcFileTarget[targetFileNameLength];
+    
+    utf8StringToWideChar(source, -1, wcFileSource);
+    utf8StringToWideChar(target, -1, wcFileTarget);
+   
+    if(!_wrename(wcFileSource,wcFileTarget)) return true;
+    ADM_error("Failed to rename %s to %s\n",source,target);
+    return false;
+#else
+    if(!rename(source,target)) return true;
+    return false;
+#endif
+}
+// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/FileSystem_posix.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/FileSystem_posix.cpp	2011-08-07 09:09:50 UTC (rev 7394)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/FileSystem_posix.cpp	2011-08-07 10:49:47 UTC (rev 7395)
@@ -66,16 +66,11 @@
 bool
 FileSystem::rename( string from, string to )
 {
-    if(false==ADM_copyFile(from.c_str(),to.c_str()))
+    if(!ADM_renameFile(from.c_str(),to.c_str()))
     {
-        ADM_error("Cannot copy %s to %s\n",from.c_str(),to.c_str());
+        ADM_error("Cannot rename %s to %s\n",from.c_str(),to.c_str());
         return true;
     }
-    if(false==ADM_eraseFile(from.c_str()))
-    {
-        ADM_error("Cannot delete %s\n",from.c_str());
-        return true;
-    }
     return false;
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.cpp	2011-08-07 09:09:50 UTC (rev 7394)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.cpp	2011-08-07 10:49:47 UTC (rev 7395)
@@ -255,7 +255,7 @@
     if(muxerConfig.optimize && result==true)
     {
         string tmpTargetFileName=targetFileName+string(".tmp");
-        if(rename(targetFileName.c_str(),tmpTargetFileName.c_str()))
+        if(!ADM_renameFile(targetFileName.c_str(),tmpTargetFileName.c_str()))
         {
             GUI_Error_HIG("","Cannot rename file (optimize)");
             return false;



From mean at mail.berlios.de  Sun Aug  7 17:19:14 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Aug 2011 17:19:14 +0200
Subject: [Avidemux-svn-commit] r7396 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src
Message-ID: <20110807151914.503CB48125B@sheep.berlios.de>

Author: mean
Date: 2011-08-07 17:19:13 +0200 (Sun, 07 Aug 2011)
New Revision: 7396

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp
Log:
[core/color] Handle RGB555 (cram), fixes #124. U & V are inverted.

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp	2011-08-07 10:49:47 UTC (rev 7395)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_colorspace.cpp	2011-08-07 15:19:13 UTC (rev 7396)
@@ -90,6 +90,7 @@
     case ADM_COLOR_YUV422: return PIX_FMT_YUYV422;
     case ADM_COLOR_YV12: return PIX_FMT_YUV420P;
     case ADM_COLOR_YUV422P: return PIX_FMT_YUV422P;
+    case ADM_COLOR_RGB555: return PIX_FMT_RGB555LE;
     case ADM_COLOR_RGB32A: return PIX_FMT_RGBA;
     case ADM_COLOR_BGR32A: return PIX_FMT_RGBA; // Faster that way...PIX_FMT_BGR32;
     case ADM_COLOR_RGB24: return PIX_FMT_RGB24;
@@ -119,6 +120,14 @@
     }
   switch(fromColor)
   {
+    case ADM_COLOR_RGB555: 
+            srcData[0]=from;
+            srcData[1]=NULL;
+            srcData[2]=NULL;
+            srcStride[0]=width*2;
+            srcStride[1]=0;
+            srcStride[2]=0;
+            break;
     case ADM_COLOR_RGB24:
     case ADM_COLOR_BGR24:
             srcData[0]=from;



From mean at mail.berlios.de  Wed Aug 10 08:11:43 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed, 10 Aug 2011 08:11:43 +0200
Subject: [Avidemux-svn-commit] r7397 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src
Message-ID: <20110810061143.97A404812D3@sheep.berlios.de>

Author: mean
Date: 2011-08-10 08:11:43 +0200 (Wed, 10 Aug 2011)
New Revision: 7397

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
Log:
[openGL] When reading back texture, yuv=0.0.0 means black not green

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-07 15:19:13 UTC (rev 7396)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-10 06:11:43 UTC (rev 7397)
@@ -227,8 +227,17 @@
         }
         for(int x=0;x<width;x+=2) // Stupid subsample: 1 out of 4
         {
-            toU[x/2]  =  src[x*4+TEX_U_OFFSET];
-            toV[x/2]  =  src[x*4+TEX_V_OFFSET];
+            const uchar *p=src+x*4;
+            uint32_t v=*(uint32_t *)p;
+            if(!v)
+            {
+                    toU[x/2]=128;
+                    toV[x/2]=128;
+            }else
+            {
+                toU[x/2]  =  p[TEX_U_OFFSET];
+                toV[x/2]  =  p[TEX_V_OFFSET];
+            }
         }
         toU+=strideU;
         toV+=strideV;



From mean at mail.berlios.de  Wed Aug 10 08:11:44 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed, 10 Aug 2011 08:11:44 +0200
Subject: [Avidemux-svn-commit] r7398 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex
Message-ID: <20110810061144.AD9054812D3@sheep.berlios.de>

Author: mean
Date: 2011-08-10 08:11:44 +0200 (Wed, 10 Aug 2011)
New Revision: 7398

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.h
Log:
[openGl] Simple vertex shader

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp	2011-08-10 06:11:43 UTC (rev 7397)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp	2011-08-10 06:11:44 UTC (rev 7398)
@@ -1,14 +1,8 @@
 /** *************************************************************************
-                    \fn       openGlSample.cpp  
-                    \brief simplest of all video filters, it does nothing
+                    \fn       openGlFragmentSample.cpp  
+                    \brief    simple fragment shader
 
-    copyright            : (C) 2009 by mean
-
-bench : 1280*720, null shader, 20 ms, 95% of it in download texture.
-            Download Texture
-                RGB2Y=5ms               (MMX it)
-                toQimage=14 ms  <<==    TOO SLOW
-
+    Simple vertex shader
  ***************************************************************************/
 
 /***************************************************************************
@@ -43,6 +37,7 @@
 #include "T_openGL.h"
 #include "T_openGLFilter.h"
 #include "sampleGl.h"
+#include "sampleGlvertex.h"
 #include "ADM_clock.h"
 /**
 
@@ -53,48 +48,58 @@
 
 
 /**
-    \class openGlSample
+    \class openGlVertex
 */
-class openGlSample : public  ADM_coreVideoFilterQtGl
+class openGlVertex : public  ADM_coreVideoFilterQtGl
 {
 protected:
+
 protected:
-                        //bool uploadTexture(ADMImage *image, ADM_PLANE plane);
                         bool render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo);
-                        void tinyUploadTex(ADMImage *img, ADM_PLANE plane, GLuint tex,int texNum );
 public:
-                             openGlSample(ADM_coreVideoFilter *previous,CONFcouple *conf);
-                            ~openGlSample();
+                             openGlVertex(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                            ~openGlVertex();
 
         virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
         virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
-	 //  virtual FilterInfo  *getInfo(void);                             /// Return picture parameters after this filter
         virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
         virtual bool         configure(void) {return true;}             /// Start graphical user interface
 };
 
 // Add the hook to make it valid plugin
-DECLARE_VIDEO_FILTER(   openGlSample,   // Class
+DECLARE_VIDEO_FILTER(   openGlVertex,   // Class
                         1,0,0,              // Version
                         ADM_UI_QT4+ADM_UI_GL,         // UI
                         VF_OPENGL,            // Category
-                        "glsample",            // internal name (must be uniq!)
-                        "OpenGl Sample",            // Display name
-                        "Run a fragment shader." // Description
+                        "glSampleVertex",            // internal name (must be uniq!)
+                        "OpenGl Vertex Shader",            // Display name
+                        "Run a simple vertex shader." // Description
                     );
 
 // Now implements the interesting parts
 /**
-    \fn openGlSample
+    \fn openGlVertex
     \brief constructor
 */
-openGlSample::openGlSample(  ADM_coreVideoFilter *in,CONFcouple *setup) : ADM_coreVideoFilterQtGl(in,setup)
+openGlVertex::openGlVertex(  ADM_coreVideoFilter *in,CONFcouple *setup) : ADM_coreVideoFilterQtGl(in,setup)
 {
 UNUSED_ARG(setup);
+        widget->makeCurrent();
         fboY->bind();
         printf("Compiling shader \n");
+        // vertex shader 
+       
+        // frag shader
         glProgramY = new QGLShaderProgram(context);
         ADM_assert(glProgramY);
+#if 1
+        if ( !glProgramY->addShaderFromSourceCode(QGLShader::Vertex, myVertex))
+        {
+                ADM_error("[GL Render] Vertex log: %s\n", glProgramY->log().toUtf8().constData());
+                ADM_assert(0);
+        }
+
+#endif
         if ( !glProgramY->addShaderFromSourceCode(QGLShader::Fragment, myShaderY))
         {
                 ADM_error("[GL Render] Fragment log: %s\n", glProgramY->log().toUtf8().constData());
@@ -111,36 +116,16 @@
                 ADM_error("[GL Render] Binding FAILED\n");
                 ADM_assert(0);
         }
+
         fboY->release();
-//
-        fboUV->bind();
-        printf("Compiling shader \n");
-        glProgramUV = new QGLShaderProgram(context);
-        ADM_assert(glProgramUV);
-        if ( !glProgramUV->addShaderFromSourceCode(QGLShader::Fragment, myShaderY))
-        {
-                ADM_error("[GL Render] Fragment log: %s\n", glProgramUV->log().toUtf8().constData());
-                ADM_assert(0);
-        }
-        if ( !glProgramUV->link())
-        {
-            ADM_error("[GL Render] Link log: %s\n", glProgramUV->log().toUtf8().constData());
-            ADM_assert(0);
-        }
+        widget->doneCurrent();
 
-        if ( !glProgramUV->bind())
-        {
-                ADM_error("[GL Render] Binding FAILED\n");
-                ADM_assert(0);
-        }
-        fboUV->release();
-
 }
 /**
-    \fn openGlSample
+    \fn openGlVertex
     \brief destructor
 */
-openGlSample::~openGlSample()
+openGlVertex::~openGlVertex()
 {
 
 }
@@ -149,7 +134,7 @@
     \fn getFrame
     \brief Get a processed frame
 */
-bool openGlSample::getNextFrame(uint32_t *fn,ADMImage *image)
+bool openGlVertex::getNextFrame(uint32_t *fn,ADMImage *image)
 {
     // since we do nothing, just get the output of previous filter
     if(false==previousFilter->getNextFrame(fn,image))
@@ -157,37 +142,39 @@
         ADM_warning("FlipFilter : Cannot get frame\n");
         return false;
     }
-    float angle=*fn;
-    angle=0.3+angle/40;
-    glProgramY->setUniformValue("teta", angle); 
-    glProgramUV->setUniformValue("teta", angle); 
-        // size is the last one...
+    widget->makeCurrent();
+    glPushMatrix();
+    // size is the last one...
     fboY->bind();
-    tinyUploadTex(image,PLANAR_Y,GL_TEXTURE0,0);
-    
+    int pulse=*fn;
+    pulse&=63;
+    float angle=pulse;
+    angle=1+((angle-64)/64)/2;
+    glProgramY->setUniformValue("skew", angle);     
+    glProgramY->setUniformValue("myTextureU", 1); 
+    glProgramY->setUniformValue("myTextureV", 2); 
+    glProgramY->setUniformValue("myTextureY", 0); 
+    glProgramY->setUniformValue("myWidth", image->GetWidth(PLANAR_Y)); 
+    glProgramY->setUniformValue("myHeight", image->GetHeight(PLANAR_Y)); 
+
+    uploadAllPlanes(image);
+
     render(image,PLANAR_Y,fboY);
-    downloadTexture(image,PLANAR_Y,fboY);
-    fboY->release();
 
-    fboUV->bind();
-    tinyUploadTex(image,PLANAR_U,GL_TEXTURE1,1);
-    glProgramUV->setUniformValue("myTexture", 1); 
-    render(image,PLANAR_U,fboUV);
-    downloadTexture(image,PLANAR_U,fboUV);
-    
-    tinyUploadTex(image,PLANAR_V,GL_TEXTURE2,2);
-    glProgramUV->setUniformValue("myTexture", 2); 
-    render(image,PLANAR_V,fboUV);
-    downloadTexture(image,PLANAR_V,fboUV);
-    fboUV->release();
+    downloadTextures(image,fboY);
+
+    fboY->release();
     firstRun=false;
+    glPopMatrix();
+    widget->doneCurrent();
+    
     return true;
 }
 /**
     \fn getCoupledConf
     \brief Return our current configuration as couple name=value
 */
-bool         openGlSample::getCoupledConf(CONFcouple **couples)
+bool         openGlVertex::getCoupledConf(CONFcouple **couples)
 {
     *couples=new CONFcouple(0); // Even if we dont have configuration we must allocate one 
     return true;
@@ -196,48 +183,17 @@
     \fn getConfiguration
     \brief Return current setting as a string
 */
-const char *openGlSample::getConfiguration(void)
+const char *openGlVertex::getConfiguration(void)
 {
     
     return "openGl Sample.";
 }
-/**
-    \fn uploadTexture
-*/
-void openGlSample::tinyUploadTex(ADMImage *image, ADM_PLANE plane, GLuint tex,int texNum )
-{
-        myGlActiveTexture(tex);
-        glBindTexture(GL_TEXTURE_RECTANGLE_NV, texNum);
-        glProgramY->setUniformValue("myTexture", texNum); 
-        glProgramY->setUniformValue("myWidth", image->GetWidth(plane)); 
-        glProgramY->setUniformValue("myHeight", image->GetHeight(plane)); 
 
-        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP);
-        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP);
-        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
-        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
-        glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
-        if(!firstRun)
-        {
-            glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_LUMINANCE, 
-                            image->GetPitch(plane),
-                            image->GetHeight(plane), 0, GL_LUMINANCE, GL_UNSIGNED_BYTE, 
-                            image->GetReadPtr(plane));
-        }else
-        {
-            glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, 
-                image->GetPitch(plane),
-                image->GetHeight(plane),
-                GL_LUMINANCE, GL_UNSIGNED_BYTE, 
-                image->GetReadPtr(plane));
-        }
-}
-
 
 /**
     \fn render
 */
-bool openGlSample::render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo)
+bool openGlVertex::render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo)
 {
     int width=image->GetWidth(plane);
     int height=image->GetHeight(plane);
@@ -249,16 +205,23 @@
     glOrtho(0, width, 0, height, -1, 1);
 
     //
-    glBegin(GL_QUADS);
-	glTexCoord2i(0, 0);
-	glVertex2i(0, 0);
-	glTexCoord2i(width, 0);
-	glVertex2i(width, 0);
-	glTexCoord2i(width, height);
-	glVertex2i(width ,height);
-	glTexCoord2i(0, height);
-	glVertex2i(0, height);
-	glEnd();	// draw cube background
+    // Split our image into 16 pixels quad
+    int roundW=width>>4;
+    int roundH=height>>4;
+    for(int y=0;y<roundH;y++)
+        for(int x=0;x<roundW;x++)
+        {
+            int startx=x*16;
+            int starty=y*16;
+            float z=0;//abs(x-roundW/2)+100;    
+            int offset=0;
+            glBegin(GL_QUADS);
+            glVertex3i(startx+offset, starty+offset,z);
+            glVertex3i(startx+offset+16, starty+offset,z);
+            glVertex3i(startx+offset+16 ,starty+16+offset,z);
+            glVertex3i(startx+offset, starty+16+offset,z);
+            glEnd();	
+        }
     return true;
 }
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.h	2011-08-10 06:11:43 UTC (rev 7397)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.h	2011-08-10 06:11:44 UTC (rev 7398)
@@ -1,24 +1,19 @@
 // Invert x & y
 static const char *myShaderY =
 	"#extension GL_ARB_texture_rectangle: enable\n"
-	"uniform sampler2DRect myTexture;\n"
-    "uniform float teta;\n"
+	"uniform sampler2DRect myTextureY;\n" // tex unit 0
+    "uniform sampler2DRect myTextureU;\n" // tex unit 1
+    "uniform sampler2DRect myTextureV;\n" // tex unit 2
     "uniform float myWidth;\n"
     "uniform float myHeight;\n"
+    "uniform float teta;\n"
 
 	"void main(void) {\n"
-    "  float angle=teta;\n" //"0.2;"
-	"  float nx = gl_TexCoord[0].x;\n"
+    "  float nx = gl_TexCoord[0].x;\n"
 	"  float ny = gl_TexCoord[0].y;\n"
-    "  float s= sin(angle);\n"
-    "  float c= cos(angle);\n"
-    "  nx=nx-myWidth/2;\n"
-    "  ny=ny-myHeight/2;\n"
-    "  float my= nx*s+ny*c+myWidth/2;\n"
-    "  float mx= nx*c-ny*s+myHeight/2;\n"
-	"  float t =  texture2DRect(myTexture, vec2(mx, my)).r;\n"
-       // no op
-	"  gl_FragColor = vec4(t, t, t, 1.0);\n"
-	//"  gl_FragColor = vec4(t, 1.0-t, 2*t, 1.0);\n"
+    "  vec4 texvalV = texture2DRect(myTextureV, vec2(nx/2,ny/2));\n"
+    "  vec4 texvalU = texture2DRect(myTextureU, vec2(nx/2,ny/2));\n"
+	"  vec4 texvalY = texture2DRect(myTextureY, vec2(nx,ny));\n"
+	"  gl_FragColor = vec4(texvalY.r, texvalU.r, texvalV.r, 1.0);\n"
 	"}\n";
 



From mean at mail.berlios.de  Thu Aug 11 07:55:03 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Aug 2011 07:55:03 +0200
Subject: [Avidemux-svn-commit] r7399 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex
Message-ID: <20110811055503.4A87148125A@sheep.berlios.de>

Author: mean
Date: 2011-08-11 07:55:02 +0200 (Thu, 11 Aug 2011)
New Revision: 7399

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGlvertex.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp
Log:
[vertex] Simple bump effect

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp	2011-08-10 06:11:44 UTC (rev 7398)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp	2011-08-11 05:55:02 UTC (rev 7399)
@@ -146,16 +146,17 @@
     glPushMatrix();
     // size is the last one...
     fboY->bind();
-    int pulse=*fn;
+    int pulse=(*fn)*4;;
     pulse&=63;
+    if(pulse<32) pulse=64-pulse;
     float angle=pulse;
-    angle=1+((angle-64)/64)/2;
-    glProgramY->setUniformValue("skew", angle);     
+    angle=1+(angle-32)/160;
+    glProgramY->setUniformValue("skew", (GLfloat)angle);     
     glProgramY->setUniformValue("myTextureU", 1); 
     glProgramY->setUniformValue("myTextureV", 2); 
     glProgramY->setUniformValue("myTextureY", 0); 
-    glProgramY->setUniformValue("myWidth", image->GetWidth(PLANAR_Y)); 
-    glProgramY->setUniformValue("myHeight", image->GetHeight(PLANAR_Y)); 
+    glProgramY->setUniformValue("myWidth", (GLfloat)image->GetWidth(PLANAR_Y)); 
+    glProgramY->setUniformValue("myHeight",(GLfloat)image->GetHeight(PLANAR_Y)); 
 
     uploadAllPlanes(image);
 

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGlvertex.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGlvertex.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGlvertex.h	2011-08-11 05:55:02 UTC (rev 7399)
@@ -0,0 +1,25 @@
+//void main()
+//	gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;
+
+static const char *myVertex=
+//"#version 130\n"
+"uniform float myWidth;\n"
+"uniform float myHeight;\n"
+"uniform float skew;\n"
+"void main(void)\n"
+"{\n"
+    "vec4 a = gl_Vertex;\n"
+    "vec4 pos=a;\n" //"vec4(a.x,a.y,0,0);"
+    "gl_TexCoord[0] = pos;\n"
+    "float nx=(a.x-myWidth/2);\n"
+    "float ny=(a.y-myHeight/2);\n"
+    "nx=nx*skew;\n"
+    "ny=ny*skew;\n"
+    "a.x=nx+myWidth/2;\n"
+    "a.y=ny+myHeight/2;\n"
+    "gl_Position = gl_ModelViewProjectionMatrix * a;\n"
+"\n"
+"}   \n";
+
+// EOF
+



From mean at mail.berlios.de  Thu Aug 11 07:55:04 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Aug 2011 07:55:04 +0200
Subject: [Avidemux-svn-commit] r7400 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex
Message-ID: <20110811055504.64D3248125A@sheep.berlios.de>

Author: mean
Date: 2011-08-11 07:55:04 +0200 (Thu, 11 Aug 2011)
New Revision: 7400

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGlvertex.h
Log:
[vertex] Simple working vertex shader

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp	2011-08-11 05:55:02 UTC (rev 7399)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp	2011-08-11 05:55:04 UTC (rev 7400)
@@ -214,7 +214,10 @@
         {
             int startx=x*16;
             int starty=y*16;
-            float z=0;//abs(x-roundW/2)+100;    
+            float z=x-roundW/2;    
+            z=z/roundW;
+            z/=5;
+            if(z<0) z=-z;
             int offset=0;
             glBegin(GL_QUADS);
             glVertex3i(startx+offset, starty+offset,z);

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGlvertex.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGlvertex.h	2011-08-11 05:55:02 UTC (rev 7399)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGlvertex.h	2011-08-11 05:55:04 UTC (rev 7400)
@@ -13,10 +13,11 @@
     "gl_TexCoord[0] = pos;\n"
     "float nx=(a.x-myWidth/2);\n"
     "float ny=(a.y-myHeight/2);\n"
-    "nx=nx*skew;\n"
-    "ny=ny*skew;\n"
+    //"nx=nx*skew;\n"
+    //"ny=ny*skew;\n"
     "a.x=nx+myWidth/2;\n"
     "a.y=ny+myHeight/2;\n"
+    "a.z=a.z*skew;"
     "gl_Position = gl_ModelViewProjectionMatrix * a;\n"
 "\n"
 "}   \n";



From mean at mail.berlios.de  Fri Aug 12 08:04:56 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 12 Aug 2011 08:04:56 +0200
Subject: [Avidemux-svn-commit] r7401 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex
Message-ID: <20110812060456.CEC614814E0@sheep.berlios.de>

Author: mean
Date: 2011-08-12 08:04:56 +0200 (Fri, 12 Aug 2011)
New Revision: 7401

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp
Log:
[vertex] Use a compiled quad list

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp	2011-08-11 05:55:04 UTC (rev 7400)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp	2011-08-12 06:04:56 UTC (rev 7401)
@@ -42,7 +42,7 @@
 /**
 
 */
-
+#define DEPTH 300
 //#define BENCH 1
 //#define BENCH_READTEXTURE
 
@@ -53,7 +53,8 @@
 class openGlVertex : public  ADM_coreVideoFilterQtGl
 {
 protected:
-
+                        GLuint  glList;
+                        bool    buildVertex(void);
 protected:
                         bool render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo);
 public:
@@ -116,7 +117,8 @@
                 ADM_error("[GL Render] Binding FAILED\n");
                 ADM_assert(0);
         }
-
+        glList=glGenLists(1);
+        buildVertex();
         fboY->release();
         widget->doneCurrent();
 
@@ -127,7 +129,7 @@
 */
 openGlVertex::~openGlVertex()
 {
-
+    glDeleteLists(glList,1);
 }
 
 /**
@@ -150,7 +152,8 @@
     pulse&=63;
     if(pulse<32) pulse=64-pulse;
     float angle=pulse;
-    angle=1+(angle-32)/160;
+    //angle=1+(angle-32)/160;
+    angle=angle/64;
     glProgramY->setUniformValue("skew", (GLfloat)angle);     
     glProgramY->setUniformValue("myTextureU", 1); 
     glProgramY->setUniformValue("myTextureV", 2); 
@@ -189,7 +192,34 @@
     
     return "openGl Sample.";
 }
+/**
+    \fn buildVertex
+    \brief Build a grid mapping of the image using 16x16 quads
+*/
+bool openGlVertex::buildVertex(void)
+{
+  int width=info.width;
+  int height=info.height;
+  glNewList(glList,GL_COMPILE);
+  glBegin(GL_QUADS);
+  int roundW=width>>4;
+    int roundH=height>>4;
+    for(int y=0;y<roundH;y++)
+        for(int x=0;x<roundW;x++)
+        {
+            int startx=x*16;
+            int starty=y*16;
+            int offset=0,z=0;
 
+            glVertex3i(startx+offset, starty+offset,0);
+            glVertex3i(startx+offset+16, starty+offset,z);
+            glVertex3i(startx+offset+16 ,starty+16+offset,z);
+            glVertex3i(startx+offset, starty+16+offset,0);
+            	
+        }
+    glEnd();
+    glEndList();
+}
 
 /**
     \fn render
@@ -203,29 +233,9 @@
 	glViewport(0, 0, width, height);
     glMatrixMode(GL_PROJECTION);
     glLoadIdentity();
-    glOrtho(0, width, 0, height, -1, 1);
-
-    //
-    // Split our image into 16 pixels quad
-    int roundW=width>>4;
-    int roundH=height>>4;
-    for(int y=0;y<roundH;y++)
-        for(int x=0;x<roundW;x++)
-        {
-            int startx=x*16;
-            int starty=y*16;
-            float z=x-roundW/2;    
-            z=z/roundW;
-            z/=5;
-            if(z<0) z=-z;
-            int offset=0;
-            glBegin(GL_QUADS);
-            glVertex3i(startx+offset, starty+offset,z);
-            glVertex3i(startx+offset+16, starty+offset,z);
-            glVertex3i(startx+offset+16 ,starty+16+offset,z);
-            glVertex3i(startx+offset, starty+16+offset,z);
-            glEnd();	
-        }
+    int depth=1;
+    glOrtho(0, width, 0, height, -depth, depth);
+    glCallList(glList);
     return true;
 }
 //EOF



From mean at mail.berlios.de  Fri Aug 12 08:04:57 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 12 Aug 2011 08:04:57 +0200
Subject: [Avidemux-svn-commit] r7402 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex
Message-ID: <20110812060457.E863C4814E0@sheep.berlios.de>

Author: mean
Date: 2011-08-12 08:04:57 +0200 (Fri, 12 Aug 2011)
New Revision: 7402

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGlvertex.h
Log:
[vertex] Simple rotation

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGlvertex.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGlvertex.h	2011-08-12 06:04:56 UTC (rev 7401)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGlvertex.h	2011-08-12 06:04:57 UTC (rev 7402)
@@ -9,18 +9,23 @@
 "void main(void)\n"
 "{\n"
     "vec4 a = gl_Vertex;\n"
-    "vec4 pos=a;\n" //"vec4(a.x,a.y,0,0);"
-    "gl_TexCoord[0] = pos;\n"
-    "float nx=(a.x-myWidth/2);\n"
-    "float ny=(a.y-myHeight/2);\n"
-    //"nx=nx*skew;\n"
-    //"ny=ny*skew;\n"
-    "a.x=nx+myWidth/2;\n"
-    "a.y=ny+myHeight/2;\n"
-    "a.z=a.z*skew;"
-    "gl_Position = gl_ModelViewProjectionMatrix * a;\n"
+    "gl_TexCoord[0] = a;\n"
+
+    "vec4 shift=vec4(myWidth/2,myHeight/2,0,0);\n"
+
+
+    "a=a-shift;\n"
+    "mat3 rotation = mat3(\n"
+    "   vec3( cos(skew),  sin(skew),  0.0),\n"
+    "   vec3(-sin(skew),  cos(skew),  0.0),\n"
+    "   vec3(       0.0,        0.0,  1.0)\n"
+    ");\n"
+
+    "vec4 xout=vec4(rotation * a.xyz, 1.0);\n"
+    "xout=xout+shift;\n"
+
+    "gl_Position = gl_ModelViewProjectionMatrix * xout;\n"
 "\n"
 "}   \n";
 
 // EOF
-



From mean at mail.berlios.de  Sun Aug 14 15:28:46 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Aug 2011 15:28:46 +0200
Subject: [Avidemux-svn-commit] r7403 - in
	branches/avidemux_2.6_branch_mean/autononreg/py: . editor
	sample_script
Message-ID: <20110814132846.65691481366@sheep.berlios.de>

Author: mean
Date: 2011-08-14 15:28:46 +0200 (Sun, 14 Aug 2011)
New Revision: 7403

Added:
   branches/avidemux_2.6_branch_mean/autononreg/py/editor/
   branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyDumpAllSegs.py
   branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyDumpSegment0.py
   branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyDumpTiming.py
   branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyGetNbSegment.py
   branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyHexDump.py
   branches/avidemux_2.6_branch_mean/autononreg/py/sample_script/remux_ts_2_ps.py
Log:
[py] Add some test case related to editor

Added: branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyDumpAllSegs.py
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyDumpAllSegs.py	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyDumpAllSegs.py	2011-08-14 13:28:46 UTC (rev 7403)
@@ -0,0 +1,7 @@
+adm=Avidemux()
+editor=Editor()
+if(0==adm.loadVideo("/work/samples/avi/2mn.avi")):
+   throw("cannot load file")
+editor.dumpAllSegments()
+print("Done . ")
+

Added: branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyDumpSegment0.py
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyDumpSegment0.py	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyDumpSegment0.py	2011-08-14 13:28:46 UTC (rev 7403)
@@ -0,0 +1,7 @@
+adm=Avidemux()
+editor=Editor()
+if(0==adm.loadVideo("/work/samples/avi/2mn.avi")):
+   throw("cannot load file")
+editor.dumpSegment(0)
+print("Done . ")
+

Added: branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyDumpTiming.py
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyDumpTiming.py	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyDumpTiming.py	2011-08-14 13:28:46 UTC (rev 7403)
@@ -0,0 +1,8 @@
+adm=Avidemux()
+editor=Editor()
+if(0==adm.loadVideo("/work/samples/avi/2mn.avi")):
+   throw("cannot load file")
+for i in range(0,10):
+        editor.printTiming(i)
+print("Done . ")
+

Added: branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyGetNbSegment.py
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyGetNbSegment.py	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyGetNbSegment.py	2011-08-14 13:28:46 UTC (rev 7403)
@@ -0,0 +1,7 @@
+adm=Avidemux()
+editor=Editor()
+if(0==adm.loadVideo("/work/samples/avi/2mn.avi")):
+   throw("cannot load file")
+i=editor.nbSegments()
+print("Nb Segments : "+str(i))
+

Added: branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyHexDump.py
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyHexDump.py	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/autononreg/py/editor/pyHexDump.py	2011-08-14 13:28:46 UTC (rev 7403)
@@ -0,0 +1,14 @@
+adm=Avidemux()
+editor=Editor()
+teger = DFInteger("Integer(0/2000):",0,2000);
+dlgWizard = DialogFactory("Frame to dump ");
+
+
+teger.value=0;
+dlgWizard.addControl(teger);
+
+res=dlgWizard.show()
+
+editor.hexDumpFrame(teger.value)
+print("Done . ")
+

Added: branches/avidemux_2.6_branch_mean/autononreg/py/sample_script/remux_ts_2_ps.py
===================================================================
--- branches/avidemux_2.6_branch_mean/autononreg/py/sample_script/remux_ts_2_ps.py	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/autononreg/py/sample_script/remux_ts_2_ps.py	2011-08-14 13:28:46 UTC (rev 7403)
@@ -0,0 +1,31 @@
+# convert all ts file in intputFolder ending with extention to PS folder with _conv.ps extension
+# ...
+#
+ext="mpg"
+inputFolder="/tmp/ts"
+#
+def convert(filein):
+    fileout=filein+".converted.ps"
+    print(filein+"=>"+fileout)
+    if(0 == adm.loadVideo(filein)):
+        ui.displayError("oops","cannot load "+filein)
+        raise
+    adm.save(fileout)
+    print("Done")
+    
+#
+# Main
+#
+ui=Gui()
+adm=Avidemux()
+adm.audioReset()
+adm.audioCodec("copy",28152032)
+adm.videoCodec("Copy")
+adm.setContainer("ffPS","muxingType=3","acceptNonCompliant=False","muxRatekBits=30000","videoRatekBits=25000","bufferSizekBytes=500")
+#
+list=get_folder_content(inputFolder,ext)
+if(list is None):
+    raise
+for i in list:
+        convert(i)
+print("Done")



From mean at mail.berlios.de  Sun Aug 14 15:28:47 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Aug 2011 15:28:47 +0200
Subject: [Avidemux-svn-commit] r7404 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl:
	. glVdpau
Message-ID: <20110814132847.DCEB2481366@sheep.berlios.de>

Author: mean
Date: 2011-08-14 15:28:47 +0200 (Sun, 14 Aug 2011)
New Revision: 7404

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vf_vdpauGl.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vf_vdpauGl.ui
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint.conf
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint_desc.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint_json.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt
Log:
[vdpau] Make openGl version

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt	2011-08-14 13:28:46 UTC (rev 7403)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt	2011-08-14 13:28:47 UTC (rev 7404)
@@ -2,3 +2,4 @@
 ADD_SUBDIRECTORY(sample_fragment)
 ADD_SUBDIRECTORY(sample_fragment2)
 ADD_SUBDIRECTORY(sample_vertex)
+ADD_SUBDIRECTORY(glVdpau)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vf_vdpauGl.h
===================================================================
Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vf_vdpauGl.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vf_vdpauGl.ui	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vf_vdpauGl.ui	2011-08-14 13:28:47 UTC (rev 7404)
@@ -0,0 +1,724 @@
+<ui version="4.0" >
+ <class>resizeDialog</class>
+ <widget class="QDialog" name="resizeDialog" >
+  <property name="geometry" >
+   <rect>
+    <x>0</x>
+    <y>0</y>
+    <width>350</width>
+    <height>342</height>
+   </rect>
+  </property>
+  <property name="windowTitle" >
+   <string>Resize</string>
+  </property>
+  <layout class="QVBoxLayout" >
+   <property name="margin" >
+    <number>9</number>
+   </property>
+   <property name="spacing" >
+    <number>6</number>
+   </property>
+   <item>
+    <widget class="QGroupBox" name="groupBox_2" >
+     <property name="title" >
+      <string>Aspect Ratio</string>
+     </property>
+     <layout class="QVBoxLayout" >
+      <property name="margin" >
+       <number>9</number>
+      </property>
+      <property name="spacing" >
+       <number>6</number>
+      </property>
+      <item>
+       <widget class="QCheckBox" name="lockArCheckBox" >
+        <property name="text" >
+         <string>Lock Aspect Ratio</string>
+        </property>
+        <property name="checked" >
+         <bool>true</bool>
+        </property>
+       </widget>
+      </item>
+      <item>
+       <layout class="QHBoxLayout" >
+        <property name="margin" >
+         <number>0</number>
+        </property>
+        <property name="spacing" >
+         <number>6</number>
+        </property>
+        <item>
+         <widget class="QLabel" name="label_4" >
+          <property name="text" >
+           <string>Source:</string>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <widget class="QComboBox" name="comboBoxSource" >
+          <item>
+           <property name="text" >
+            <string>1:1</string>
+           </property>
+          </item>
+          <item>
+           <property name="text" >
+            <string>4:3</string>
+           </property>
+          </item>
+          <item>
+           <property name="text" >
+            <string>16:9</string>
+           </property>
+          </item>
+         </widget>
+        </item>
+        <item>
+         <spacer>
+          <property name="orientation" >
+           <enum>Qt::Horizontal</enum>
+          </property>
+          <property name="sizeType" >
+           <enum>QSizePolicy::Fixed</enum>
+          </property>
+          <property name="sizeHint" >
+           <size>
+            <width>30</width>
+            <height>20</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+        <item>
+         <widget class="QLabel" name="label_3" >
+          <property name="text" >
+           <string>Destination:</string>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <widget class="QComboBox" name="comboBoxDestination" >
+          <item>
+           <property name="text" >
+            <string>1:1</string>
+           </property>
+          </item>
+          <item>
+           <property name="text" >
+            <string>4:3</string>
+           </property>
+          </item>
+          <item>
+           <property name="text" >
+            <string>16:9</string>
+           </property>
+          </item>
+         </widget>
+        </item>
+        <item>
+         <spacer>
+          <property name="orientation" >
+           <enum>Qt::Horizontal</enum>
+          </property>
+          <property name="sizeHint" >
+           <size>
+            <width>40</width>
+            <height>20</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+       </layout>
+      </item>
+     </layout>
+    </widget>
+   </item>
+   <item>
+    <widget class="QGroupBox" name="groupBox" >
+     <property name="title" >
+      <string>Resize Dimensions</string>
+     </property>
+     <layout class="QVBoxLayout" >
+      <property name="margin" >
+       <number>9</number>
+      </property>
+      <property name="spacing" >
+       <number>6</number>
+      </property>
+      <item>
+       <layout class="QHBoxLayout" >
+        <property name="margin" >
+         <number>0</number>
+        </property>
+        <property name="spacing" >
+         <number>6</number>
+        </property>
+        <item>
+         <widget class="QLabel" name="label" >
+          <property name="text" >
+           <string>Width:</string>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <widget class="QSpinBox" name="spinBoxWidth" >
+          <property name="maximum" >
+           <number>2900</number>
+          </property>
+          <property name="minimum" >
+           <number>16</number>
+          </property>
+          <property name="singleStep" >
+           <number>2</number>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <spacer>
+          <property name="orientation" >
+           <enum>Qt::Horizontal</enum>
+          </property>
+          <property name="sizeType" >
+           <enum>QSizePolicy::Fixed</enum>
+          </property>
+          <property name="sizeHint" >
+           <size>
+            <width>30</width>
+            <height>20</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+        <item>
+         <widget class="QLabel" name="label_2" >
+          <property name="text" >
+           <string>Height:</string>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <widget class="QSpinBox" name="spinBoxHeight" >
+          <property name="maximum" >
+           <number>2000</number>
+          </property>
+          <property name="minimum" >
+           <number>16</number>
+          </property>
+          <property name="singleStep" >
+           <number>2</number>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <spacer>
+          <property name="orientation" >
+           <enum>Qt::Horizontal</enum>
+          </property>
+          <property name="sizeHint" >
+           <size>
+            <width>40</width>
+            <height>20</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+       </layout>
+      </item>
+      <item>
+       <widget class="QCheckBox" name="checkBoxRoundup" >
+        <property name="text" >
+         <string>Round to the Nearest Multiple of 16</string>
+        </property>
+       </widget>
+      </item>
+      <item>
+       <spacer>
+        <property name="orientation" >
+         <enum>Qt::Vertical</enum>
+        </property>
+        <property name="sizeType" >
+         <enum>QSizePolicy::Fixed</enum>
+        </property>
+        <property name="sizeHint" >
+         <size>
+          <width>312</width>
+          <height>4</height>
+         </size>
+        </property>
+       </spacer>
+      </item>
+      <item>
+       <layout class="QVBoxLayout" >
+        <property name="margin" >
+         <number>0</number>
+        </property>
+        <property name="spacing" >
+         <number>6</number>
+        </property>
+        <item>
+         <layout class="QHBoxLayout" >
+          <property name="margin" >
+           <number>0</number>
+          </property>
+          <property name="spacing" >
+           <number>12</number>
+          </property>
+          <item>
+           <layout class="QVBoxLayout" >
+            <property name="margin" >
+             <number>0</number>
+            </property>
+            <property name="spacing" >
+             <number>6</number>
+            </property>
+            <item>
+             <layout class="QHBoxLayout" >
+              <property name="margin" >
+               <number>0</number>
+              </property>
+              <property name="spacing" >
+               <number>6</number>
+              </property>
+              <item>
+               <widget class="QLabel" name="label_8" >
+                <property name="text" >
+                 <string>1%</string>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <spacer>
+                <property name="orientation" >
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" >
+                 <size>
+                  <width>40</width>
+                  <height>20</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
+              <item>
+               <widget class="QLabel" name="label_5" >
+                <property name="text" >
+                 <string>Percent</string>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <spacer>
+                <property name="orientation" >
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" >
+                 <size>
+                  <width>40</width>
+                  <height>20</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
+              <item>
+               <widget class="QLabel" name="label_9" >
+                <property name="text" >
+                 <string>200%</string>
+                </property>
+               </widget>
+              </item>
+             </layout>
+            </item>
+            <item>
+             <widget class="QSlider" name="horizontalSlider" >
+              <property name="minimum" >
+               <number>1</number>
+              </property>
+              <property name="maximum" >
+               <number>200</number>
+              </property>
+              <property name="value" >
+               <number>100</number>
+              </property>
+              <property name="orientation" >
+               <enum>Qt::Horizontal</enum>
+              </property>
+             </widget>
+            </item>
+           </layout>
+          </item>
+          <item>
+           <widget class="QSpinBox" name="percentageSpinBox" >
+            <property name="maximum" >
+             <number>200</number>
+            </property>
+            <property name="minimum" >
+             <number>1</number>
+            </property>
+            <property name="value" >
+             <number>100</number>
+            </property>
+           </widget>
+          </item>
+         </layout>
+        </item>
+        <item>
+         <layout class="QHBoxLayout" >
+          <property name="margin" >
+           <number>0</number>
+          </property>
+          <property name="spacing" >
+           <number>6</number>
+          </property>
+          <item>
+           <widget class="QLabel" name="label_10" >
+            <property name="text" >
+             <string>Error X / Y:</string>
+            </property>
+           </widget>
+          </item>
+          <item>
+           <widget class="QLabel" name="labelErrorXY" >
+            <property name="text" >
+             <string>0.00 / 0.00</string>
+            </property>
+           </widget>
+          </item>
+          <item>
+           <spacer>
+            <property name="orientation" >
+             <enum>Qt::Horizontal</enum>
+            </property>
+            <property name="sizeHint" >
+             <size>
+              <width>40</width>
+              <height>20</height>
+             </size>
+            </property>
+           </spacer>
+          </item>
+         </layout>
+        </item>
+       </layout>
+      </item>
+     </layout>
+    </widget>
+   </item>
+   <item>
+    <spacer>
+     <property name="orientation" >
+      <enum>Qt::Vertical</enum>
+     </property>
+     <property name="sizeType" >
+      <enum>QSizePolicy::Fixed</enum>
+     </property>
+     <property name="sizeHint" >
+      <size>
+       <width>332</width>
+       <height>6</height>
+      </size>
+     </property>
+    </spacer>
+   </item>
+   <item>
+    <layout class="QHBoxLayout" >
+     <property name="margin" >
+      <number>0</number>
+     </property>
+     <property name="spacing" >
+      <number>6</number>
+     </property>
+     <item>
+      <widget class="QLabel" name="label_6" >
+       <property name="text" >
+        <string>Resize Method:</string>
+       </property>
+      </widget>
+     </item>
+     <item>
+      <widget class="QComboBox" name="comboBoxAlgo" >
+       <item>
+        <property name="text" >
+         <string>Bilinear</string>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>Bicubic</string>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>Lanzcos3</string>
+        </property>
+       </item>
+      </widget>
+     </item>
+     <item>
+      <spacer>
+       <property name="orientation" >
+        <enum>Qt::Horizontal</enum>
+       </property>
+       <property name="sizeHint" >
+        <size>
+         <width>40</width>
+         <height>20</height>
+        </size>
+       </property>
+      </spacer>
+     </item>
+    </layout>
+   </item>
+   <item>
+    <spacer>
+     <property name="orientation" >
+      <enum>Qt::Vertical</enum>
+     </property>
+     <property name="sizeType" >
+      <enum>QSizePolicy::MinimumExpanding</enum>
+     </property>
+     <property name="sizeHint" >
+      <size>
+       <width>20</width>
+       <height>16</height>
+      </size>
+     </property>
+    </spacer>
+   </item>
+   <item>
+    <widget class="QDialogButtonBox" name="buttonBox" >
+     <property name="orientation" >
+      <enum>Qt::Horizontal</enum>
+     </property>
+     <property name="standardButtons" >
+      <set>QDialogButtonBox::Cancel|QDialogButtonBox::NoButton|QDialogButtonBox::Ok</set>
+     </property>
+    </widget>
+   </item>
+  </layout>
+ </widget>
+ <tabstops>
+  <tabstop>lockArCheckBox</tabstop>
+  <tabstop>comboBoxSource</tabstop>
+  <tabstop>comboBoxDestination</tabstop>
+  <tabstop>spinBoxWidth</tabstop>
+  <tabstop>spinBoxHeight</tabstop>
+  <tabstop>checkBoxRoundup</tabstop>
+  <tabstop>horizontalSlider</tabstop>
+  <tabstop>percentageSpinBox</tabstop>
+  <tabstop>comboBoxAlgo</tabstop>
+  <tabstop>buttonBox</tabstop>
+ </tabstops>
+ <resources/>
+ <connections>
+  <connection>
+   <sender>buttonBox</sender>
+   <signal>rejected()</signal>
+   <receiver>resizeDialog</receiver>
+   <slot>reject()</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>316</x>
+     <y>260</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>286</x>
+     <y>274</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_8</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>39</x>
+     <y>148</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_5</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>150</x>
+     <y>148</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_9</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>267</x>
+     <y>148</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>horizontalSlider</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>156</x>
+     <y>164</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>percentageSpinBox</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>317</x>
+     <y>155</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>checkBoxRoundup</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>95</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_10</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>155</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>55</x>
+     <y>251</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>labelErrorXY</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>155</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>114</x>
+     <y>251</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_4</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>69</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>46</x>
+     <y>95</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>comboBoxSource</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>69</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>94</x>
+     <y>95</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_3</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>69</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>188</x>
+     <y>95</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>comboBoxDestination</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>69</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>247</x>
+     <y>95</y>
+    </hint>
+   </hints>
+  </connection>
+ </connections>
+</ui>

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp	2011-08-14 13:28:47 UTC (rev 7404)
@@ -0,0 +1,674 @@
+/**
+    \brief VDPAU filters Deinterlacer
+    \author mean (C) 2010
+    This is slow as we copy back and forth data to/from the video cards
+    
+    On a Q6600
+
+    FullHD: 
+            Readback ~ 5 ms, RGB 2 YUV ~ 20 ms : 100% CPU
+    720
+            Readback ~ 2 ms, RGB2YUV ~ 10 ms  : 50% CPU
+            
+
+
+*/
+#include "ADM_cpp.h"
+#include <list>
+#include "ADM_default.h"
+#ifdef USE_VDPAU
+extern "C" {
+#include "libavcodec/avcodec.h"
+#include "libavcodec/vdpau.h"
+}
+
+#include "ADM_coreVideoFilterInternal.h"
+#include "ADM_videoFilterCache.h"
+#include "DIA_factory.h"
+#include "ADM_vidMisc.h"
+#include "vdpauFilterDeint.h"
+#include "vdpauFilterDeint_desc.cpp"
+
+#include "ADM_coreVdpau/include/ADM_coreVdpau.h"
+//
+#define ADM_INVALID_FRAME_NUM 0x80000000
+#define ADM_NB_SURFACES 5
+
+//#define DO_BENCHMARK
+#define NB_BENCH 100
+
+#if 0
+#define aprintf printf
+#else
+#define aprintf(...) {}
+#endif
+
+enum
+{
+    ADM_KEEP_TOP=0,
+    ADM_KEEP_BOTTOM=1,
+    ADM_KEEP_BOTH=2
+};
+/**
+    \class VDPSlot
+*/
+class VDPSlot
+{
+public:
+                              VDPSlot() ;
+                             ~VDPSlot();
+            VdpVideoSurface   surface;
+            bool              isExternal;
+            uint64_t          pts;
+            uint32_t          frameNumber;
+            ADMImage          *image;
+};
+
+VDPSlot::VDPSlot()
+{
+    surface=VDP_INVALID_HANDLE;
+    image=NULL;
+}
+VDPSlot::~VDPSlot()
+{
+    if(image) delete image;
+    image=NULL;
+    if(surface!=VDP_INVALID_HANDLE)
+    {
+        // will be freed by the pool..
+    }
+    surface=VDP_INVALID_HANDLE;
+}
+
+/**
+    \class vdpauVideoFilterDeint
+*/
+class vdpauVideoFilterDeint : public  ADM_coreVideoFilter
+{
+protected:
+                    VDPSlot              slots[3];
+                    bool                 eof;
+                    bool                 secondField;
+                    uint64_t             nextPts;
+                    ADMColorScalerSimple *scaler;
+                    bool                 passThrough;
+                    bool                 setupVdpau(void);
+                    bool                 cleanupVdpau(void);
+                    bool                 updateConf(void);
+                    uint8_t             *tempBuffer;
+                    vdpauFilterDeint     configuration;
+                    VdpOutputSurface     outputSurface;
+                    std::list <VdpVideoSurface> freeSurface;
+                    VdpVideoSurface      surfacePool[ADM_NB_SURFACES];
+                    VdpVideoMixer        mixer;
+protected:
+                    bool                 rotateSlots(void);
+                    bool                 clearSlots(void);
+                    bool                 uploadImage(ADMImage *next,const VdpVideoSurface surface) ;
+                    bool                 fillSlot(int slot,ADMImage *image);
+                    bool                 getResult(ADMImage *image);
+                    bool                 sendField(bool topField);
+
+public:
+        virtual bool         goToTime(uint64_t usSeek); 
+                             vdpauVideoFilterDeint(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                             ~vdpauVideoFilterDeint();
+
+        virtual const char   *getConfiguration(void);                 /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);           /// Return the next image
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) ;                        /// Start graphical user interface
+};
+
+// Add the hook to make it valid plugin
+DECLARE_VIDEO_FILTER(   vdpauVideoFilterDeint,   // Class
+                        1,0,0,              // Version
+                        ADM_UI_GTK+ADM_UI_QT4,     // We need a display for VDPAU; so no cli...
+                        VF_INTERLACING,            // Category
+                        "vdpauDeint",            // internal name (must be uniq!)
+                        "vdpauDeint",            // Display name
+                        "VDPAU deinterlacer (+resize)." // Description
+                    );
+
+//
+
+/**
+    \fn updateConf
+*/
+bool vdpauVideoFilterDeint::updateConf(void)
+{
+    if(passThrough)
+    {
+        ADM_warning("PassThrough mode\n");
+        info=*(previousFilter->getInfo());
+        return true;
+    }
+    if(configuration.resizeToggle)
+    {
+        info.width=configuration.targetWidth;
+        info.height=configuration.targetHeight;
+    }else
+    {
+            info=*(previousFilter->getInfo());
+    }
+    uint64_t prev=previousFilter->getInfo()->frameIncrement;
+    if(configuration.deintMode==ADM_KEEP_BOTH)
+        info.frameIncrement=prev/2;
+    else
+        info.frameIncrement=prev;
+    return true;
+}
+/**
+    \fn goToTime
+    \brief called when seeking. Need to cleanup our stuff.
+*/
+bool         vdpauVideoFilterDeint::goToTime(uint64_t usSeek)
+{
+    secondField=false;
+    eof=false;
+    clearSlots();
+    return ADM_coreVideoFilter::goToTime(usSeek);
+}
+
+/**
+    \fn resetVdpau
+*/
+bool vdpauVideoFilterDeint::setupVdpau(void)
+{
+    scaler=NULL;
+    secondField=false;
+    nextFrame=0;
+    if(!admVdpau::isOperationnal())
+    {
+        ADM_warning("Vdpau not operationnal\n");
+        return false;
+    }   
+    if(VDP_STATUS_OK!=admVdpau::outputSurfaceCreate(VDP_RGBA_FORMAT_B8G8R8A8,
+                        info.width,info.height,&outputSurface)) 
+    {
+        ADM_error("Cannot create outputSurface0\n");
+        return false;
+    }
+    for(int i=0;i<ADM_NB_SURFACES;i++) surfacePool[i]=VDP_INVALID_HANDLE;
+    for(int i=0;i<ADM_NB_SURFACES;i++)
+    {
+        if(VDP_STATUS_OK!=admVdpau::surfaceCreate(   previousFilter->getInfo()->width,
+                                                    previousFilter->getInfo()->height,
+                                                    &(surfacePool[i]))) 
+        {
+            ADM_error("Cannot create input Surface %d\n",i);
+            goto badInit;
+        }
+        aprintf("Created surface %d\n",(int)surfacePool[i]);
+    }
+    // allocate our (dummy) images
+    for(int i=0;i<3;i++)
+        slots[i].image=new ADMImageDefault( previousFilter->getInfo()->width, 
+                                            previousFilter->getInfo()->height);
+                                            
+    if(VDP_STATUS_OK!=admVdpau::mixerCreate(previousFilter->getInfo()->width,
+                                            previousFilter->getInfo()->height,&mixer,true)) 
+    {
+        ADM_error("Cannot create mixer\n");
+        goto badInit;
+    } 
+    tempBuffer=new uint8_t[info.width*info.height*4];
+    scaler=new ADMColorScalerSimple( info.width,info.height, ADM_COLOR_BGR32A,ADM_COLOR_YV12);
+
+    freeSurface.clear();
+    for(int i=0;i<ADM_NB_SURFACES;i++)  
+            freeSurface.push_back(surfacePool[i]);
+
+    ADM_info("VDPAU setup ok\n");
+    return true;
+badInit:
+    cleanupVdpau();
+    passThrough=true;
+    return false;
+}
+/**
+    \fn cleanupVdpau
+*/
+bool vdpauVideoFilterDeint::cleanupVdpau(void)
+{
+    for(int i=0;i<ADM_NB_SURFACES;i++)
+        if(surfacePool[i]!=VDP_INVALID_HANDLE) admVdpau::surfaceDestroy(surfacePool[i]);
+    if(outputSurface!=VDP_INVALID_HANDLE)  admVdpau::outputSurfaceDestroy(outputSurface);
+    if(mixer!=VDP_INVALID_HANDLE) admVdpau::mixerDestroy(mixer);
+    outputSurface=VDP_INVALID_HANDLE;
+    for(int i=0;i<ADM_NB_SURFACES;i++)
+        surfacePool[i]=VDP_INVALID_HANDLE;
+    mixer=VDP_INVALID_HANDLE;
+    if(tempBuffer) delete [] tempBuffer;
+    tempBuffer=NULL;
+    if(scaler) delete scaler;
+    scaler=NULL;
+    for(int i=0;i<3;i++)
+       if(slots[i].image)
+        {
+            delete slots[i].image;
+            slots[i].image=NULL;
+        }
+
+    return true;
+}
+
+/**
+    \fn constructor
+*/
+vdpauVideoFilterDeint::vdpauVideoFilterDeint(ADM_coreVideoFilter *in, CONFcouple *setup): ADM_coreVideoFilter(in,setup)
+{
+    eof=false;
+    for(int i=0;i<ADM_NB_SURFACES;i++)
+        surfacePool[i]=VDP_INVALID_HANDLE;
+    mixer=VDP_INVALID_HANDLE;
+    outputSurface=VDP_INVALID_HANDLE;
+    if(!setup || !ADM_paramLoad(setup,vdpauFilterDeint_param,&configuration))
+    {
+        // Default value
+        configuration.resizeToggle=false;
+        configuration.deintMode=ADM_KEEP_TOP;
+        configuration.targetWidth=info.width;
+        configuration.targetHeight=info.height;
+    }
+    vidCache = new VideoCache (5, in);
+    myName="vdpauDeint";
+    tempBuffer=NULL;
+    passThrough=false;
+    updateConf();    
+    passThrough=!setupVdpau();
+    
+}
+/**
+    \fn destructor
+*/
+vdpauVideoFilterDeint::~vdpauVideoFilterDeint()
+{
+//        delete original;
+        delete vidCache;
+        vidCache = NULL;
+        cleanupVdpau();
+}
+/**
+    \fn updateInfo
+*/
+bool vdpauVideoFilterDeint::configure( void) 
+{
+     
+     diaMenuEntry tMode[]={
+                             {ADM_KEEP_TOP,      QT_TR_NOOP("Keep Top Field"),NULL},
+                             {ADM_KEEP_BOTTOM,   QT_TR_NOOP("Keep Bottom Field"),NULL},
+                             {ADM_KEEP_BOTH,      QT_TR_NOOP("Double framerate"),NULL}
+                             
+          };
+     bool doResize=configuration.resizeToggle;
+     diaElemToggle    tResize(&(doResize),   QT_TR_NOOP("_Resize:"));
+     diaElemMenu      mMode(&(configuration.deintMode),   QT_TR_NOOP("_Deint Mode:"), 3,tMode);
+     diaElemUInteger  tWidth(&(configuration.targetWidth),QT_TR_NOOP("Width :"),16,2048);
+     diaElemUInteger  tHeight(&(configuration.targetHeight),QT_TR_NOOP("Height :"),16,2048);
+     
+     diaElem *elems[]={&mMode,&tResize,&tWidth,&tHeight};
+     
+     if(diaFactoryRun(QT_TR_NOOP("vdpau"),sizeof(elems)/sizeof(diaElem *),elems))
+     {
+                configuration.resizeToggle=(bool)doResize;
+                info.width=configuration.targetWidth;
+                info.height=configuration.targetHeight;
+                ADM_info("New dimension : %d x %d\n",info.width,info.height);
+                updateConf();
+                cleanupVdpau();
+                passThrough=!setupVdpau();
+                
+                return 1;
+     }
+     return 0;
+     
+}
+/**
+    \fn getCoupledConf
+    \brief Return our current configuration as couple name=value
+*/
+bool         vdpauVideoFilterDeint::getCoupledConf(CONFcouple **couples)
+{
+   return ADM_paramSave(couples, vdpauFilterDeint_param,&configuration);
+}
+/**
+    \fn getConfiguration
+    \brief Return current setting as a string
+*/
+const char *vdpauVideoFilterDeint::getConfiguration(void)
+{
+    static char conf[80];
+    sprintf(conf,"Vdpau Deinterlace mode=%d, %d x %d",configuration.deintMode,info.width,info.height);
+    conf[79]=0;
+    return conf;
+}
+/**
+    \fn uploadImage
+    \brief upload an image to a vdpau surface
+*/
+bool vdpauVideoFilterDeint::uploadImage(ADMImage *next,VdpVideoSurface surface) 
+{
+    if(!next) // empty image
+    {
+        ADM_warning("VdpauDeint:No image to upload\n");
+        return true;
+    }
+    if(surface==VDP_INVALID_HANDLE)
+    {
+        ADM_error("Surface provided is invalid\n");
+        return false;
+    }
+  // Blit our image to surface
+    uint32_t pitches[3];
+    uint8_t *planes[3];
+    next->GetPitches(pitches);
+    next->GetReadPlanes(planes);
+
+    aprintf("Putting image in surface %d\n",(int)surface);
+    // Put out stuff in input...
+#if VDP_DEBUG
+    printf("Uploading image to surface %d\n",surfaceIndex%ADM_NB_SURFACES);
+#endif
+    if(VDP_STATUS_OK!=admVdpau::surfacePutBits( 
+            surface,
+            planes,pitches))
+    {
+        ADM_warning("[Vdpau] video surface : Cannot putbits\n");
+        return false;
+    }
+    return true;
+}
+/**
+    \fn fillSlot
+    \brief upload the image to the slot. 
+*/
+bool vdpauVideoFilterDeint::fillSlot(int slot,ADMImage *image)
+{
+    VdpVideoSurface tgt;
+    bool external=false;
+    if(image->refType!=ADM_HW_VDPAU)
+    {   // Need to allocate a surface
+        ADM_assert(freeSurface.size());
+        tgt=freeSurface.front();
+        freeSurface.pop_front();  
+        aprintf("FillSlot : Popped %d\n",tgt);
+        //
+        if(false==uploadImage(image,tgt)) 
+        {
+            return false;
+        }
+        external=false;
+    }else
+    {   // use the provided surface
+        aprintf("Deint Image is already vdpau, slot %d \n",slot);
+        ADMImage *img=slots[slot].image;
+        img->duplicateFull(image); // increment ref count
+        // get surface
+        img->hwDownloadFromRef();
+        vdpau_render_state *render=(vdpau_render_state *)img->refDescriptor.refCookie;
+        ADM_assert(render->refCount);
+        tgt=render->surface;
+        external=true;
+    }
+    nextPts=image->Pts;
+    slots[slot].pts=image->Pts;
+    slots[slot].surface=tgt;
+    slots[slot].isExternal=external;
+    return true;
+}
+
+/**
+    \fn rotateSlots
+*/
+bool vdpauVideoFilterDeint::rotateSlots(void)
+{
+    VDPSlot *s=&(slots[0]);
+    ADMImage *img=slots[0].image;
+    if(s->surface!=VDP_INVALID_HANDLE)
+        if(!s->isExternal)
+        {
+            freeSurface.push_back(s->surface);
+            s->surface=VDP_INVALID_HANDLE;
+        }else
+        {
+            // Ref couting dec..
+            s->image->hwDecRefCount();
+            s->surface=VDP_INVALID_HANDLE;
+        }
+    slots[0]=slots[1];
+    slots[1]=slots[2];
+    slots[2].surface=VDP_INVALID_HANDLE;
+    slots[2].image=img;
+    return true;
+}
+/**
+    \fn clearSlots
+*/
+bool vdpauVideoFilterDeint::clearSlots(void)
+{
+    for(int i=0;i<3;i++)
+    {
+           VDPSlot *s=&(slots[i]);  
+           if(s->surface!=VDP_INVALID_HANDLE)
+            {
+                if(s->isExternal)
+                {
+                    s->image->hwDecRefCount();
+                }else
+                {
+                    freeSurface.push_back(s->surface);
+                }
+            }
+            s->surface=VDP_INVALID_HANDLE;
+    }
+    return true;
+}
+/**
+    \fn sendField
+    \brief Process a field (top or bottom). If null the next param means there is no successor (next image)
+*/
+bool vdpauVideoFilterDeint::sendField(bool topField)
+{
+ // Call mixer...
+    VdpVideoSurface in[3];
+    bool r=true;
+    // PREVIOUS
+    for(int i=0;i<3;i++)
+    {
+        in[i]=slots[i].surface;
+        aprintf("Mixing %d %d\n",i,(int)in[i]);
+    }
+    //
+
+#ifdef DO_BENCHMARK
+    ADMBenchmark bmark;
+    for(int i=0;i<NB_BENCH;i++)
+    {
+        bmark.start();
+#endif
+    
+       
+    // ---------- Top field ------------
+    if(VDP_STATUS_OK!=admVdpau::mixerRenderWithPastAndFuture(topField, 
+                mixer,
+                in,
+                outputSurface, 
+                previousFilter->getInfo()->width,previousFilter->getInfo()->height))
+
+    {
+        ADM_warning("[Vdpau] Cannot mixerRender\n");
+        r= false;
+    }   
+                     
+#ifdef DO_BENCHMARK
+        bmark.end();
+    }
+    ADM_warning("Mixer Benchmark\n");
+    bmark.printResult();
+#endif 
+    return r;
+}
+/**
+    \fn     getResult
+    \brief  Convert the output surface into an ADMImage
+*/
+bool vdpauVideoFilterDeint::getResult(ADMImage *image)
+{
+
+#ifdef DO_BENCHMARK
+    ADMBenchmark bmark;
+    for(int i=0;i<NB_BENCH;i++)
+    {
+        bmark.start();
+#endif
+  
+    if(VDP_STATUS_OK!=admVdpau::outputSurfaceGetBitsNative(outputSurface,
+                                                            tempBuffer, 
+                                                            info.width,info.height))
+    {
+        ADM_warning("[Vdpau] Cannot copy back data from output surface\n");
+        return false;
+    }
+  
+                     
+#ifdef DO_BENCHMARK
+        bmark.end();
+    }
+    ADM_warning("Read surface Benchmark\n");
+    bmark.printResult();
+#endif 
+    // Convert from VDP_RGBA_FORMAT_B8G8R8A8 to YV12
+    uint32_t sourceStride[3]={info.width*4,0,0};
+    uint8_t  *sourceData[3]={tempBuffer,NULL,NULL};
+    uint32_t destStride[3];
+    uint8_t  *destData[3];
+
+    image->GetPitches(destStride);
+    image->GetWritePlanes(destData);
+
+    // Invert U&V
+    uint32_t ts;
+    uint8_t  *td;
+#if 0
+    ts=destStride[2];destStride[2]=destStride[1];destStride[1]=ts;
+    td=destData[1];destData[2]=destData[2];destData[1]=td;
+#endif
+
+
+#ifdef DO_BENCHMARK
+    ADMBenchmark bmark2;
+    for(int i=0;i<NB_BENCH;i++)
+    {
+        bmark2.start();
+#endif
+    scaler->convertPlanes(  sourceStride,destStride,     
+                            sourceData,destData);
+#ifdef DO_BENCHMARK
+        bmark2.end();
+    }
+    ADM_warning("RGB->YUV Benchmark\n");
+    bmark2.printResult();
+#endif
+
+    return true;
+}
+/**
+    \fn getNextFrame
+    \brief 
+
+*/
+bool vdpauVideoFilterDeint::getNextFrame(uint32_t *fn,ADMImage *image)
+{
+bool r=true;
+    if(eof)
+    {
+        ADM_warning("[VdpauDeint] End of stream\n");
+        return false;
+    }
+#define FAIL {r=false;goto endit;}
+     if(passThrough) return previousFilter->getNextFrame(fn,image);
+    // top field has already been sent, grab bottom field
+    if((secondField)&&(configuration.deintMode==ADM_KEEP_BOTH))
+        {
+            secondField=false;
+            *fn=nextFrame*2+1;
+            if(false==getResult(image)) return false;
+            if(ADM_NO_PTS==nextPts) image->Pts=nextPts;
+                else image->Pts=nextPts-info.frameIncrement;
+            aprintf("2ndField : Pts=%s\n",ADM_us2plain(image->Pts));
+            return true;
+        }
+     // shift frames;... free slot[0]
+    rotateSlots();
+
+    // our first frame, we need to preload one frame
+    if(!nextFrame)
+    {
+            aprintf("This is our first image, filling slot 1\n");
+            ADMImage *prev= vidCache->getImageAs(ADM_HW_VDPAU,0);
+            if(false==fillSlot(1,prev))
+            {
+                    vidCache->unlockAll();
+                    return false;
+            }
+            
+    }
+    // regular image, in fact we get the next image here
+    ADMImage *next= vidCache->getImageAs(ADM_HW_VDPAU,nextFrame+1);
+    if(next)
+    {
+            if(false==fillSlot(2,next))
+            {
+                vidCache->unlockAll();
+                FAIL
+            }
+    }
+    if(!next) eof=true; // End of stream
+
+    // now we have slot 0 : prev Image, slot 1=current image, slot 2=next image
+
+    // Now get our image back from surface...
+    sendField(true); // always send top field
+    if(configuration.deintMode==ADM_KEEP_TOP || configuration.deintMode==ADM_KEEP_BOTH)
+    {
+          if(false==getResult(image)) 
+          {
+               FAIL
+          }
+          aprintf("TOP/BOTH : Pts=%s\n",ADM_us2plain(image->Pts));
+    }
+    // Send 2nd field
+    sendField(false); 
+    if(configuration.deintMode==ADM_KEEP_BOTTOM)
+    {
+          if(false==getResult(image)) 
+          {
+               FAIL
+          }
+          aprintf("BOTTOM : Pts=%s\n",ADM_us2plain(image->Pts));
+    }
+    // Top Field..
+endit:  
+    vidCache->unlockAll();
+    if(configuration.deintMode==ADM_KEEP_BOTH) 
+    {
+        *fn=nextFrame*2;
+        secondField=true;
+    }
+        else    *fn=nextFrame;
+    nextFrame++;
+    image->Pts=nextPts;
+    if(next) nextPts=next->Pts;
+   // printf("VDPAU OUT PTS= %"LLU"\n",image->Pts);
+    return r;
+}
+#else // USE_VDPAU
+static void dummy_fun(void)
+{
+    return ;
+}
+#endif // use VDPAU
+
+//****************
+// EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/CMakeLists.txt	2011-08-14 13:28:47 UTC (rev 7404)
@@ -0,0 +1,6 @@
+INCLUDE(vf_plugin)
+INCLUDE(vf_plugin_qt4gl)
+IF(NOT WIN32 AND NOT APPLE)
+        SET(ADM_vf_vdpauFilterDeint_SRCS ADM_vidVdpauFilterDeint.cpp )
+        INIT_VIDEO_FILTER_GLQT4(ADM_vf_vdpauGl "${ADM_vf_vdpauFilterDeint_SRCS}" "ADM_vf_vdpauGl.h" "ADM_vf_vdpauGl" "${ADM_vf_vdpauFilterDeint_SRCS}")
+ENDIF(NOT WIN32 AND NOT APPLE)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint.conf	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint.conf	2011-08-14 13:28:47 UTC (rev 7404)
@@ -0,0 +1,6 @@
+vdpauFilterDeint{
+bool:resizeToggle;
+uint32_t:deintMode;
+uint32_t:targetWidth;
+uint32_t:targetHeight;
+}

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint.h	2011-08-14 13:28:47 UTC (rev 7404)
@@ -0,0 +1,10 @@
+// automatically generated by admSerialization.py do not edit
+#ifndef ADM_vdpauFilterDeint_CONF_H
+#define ADM_vdpauFilterDeint_CONF_H
+typedef struct {
+bool resizeToggle;
+uint32_t deintMode;
+uint32_t targetWidth;
+uint32_t targetHeight;
+}vdpauFilterDeint;
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint_desc.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint_desc.cpp	2011-08-14 13:28:47 UTC (rev 7404)
@@ -0,0 +1,8 @@
+// automatically generated by admSerialization.py, do not edit!
+extern const ADM_paramList vdpauFilterDeint_param[]={
+ {"resizeToggle",offsetof(vdpauFilterDeint,resizeToggle),"bool",ADM_param_bool},
+ {"deintMode",offsetof(vdpauFilterDeint,deintMode),"uint32_t",ADM_param_uint32_t},
+ {"targetWidth",offsetof(vdpauFilterDeint,targetWidth),"uint32_t",ADM_param_uint32_t},
+ {"targetHeight",offsetof(vdpauFilterDeint,targetHeight),"uint32_t",ADM_param_uint32_t},
+{NULL,0,NULL}
+};

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint_json.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint_json.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/vdpauFilterDeint_json.cpp	2011-08-14 13:28:47 UTC (rev 7404)
@@ -0,0 +1,21 @@
+// automatically generated by admSerialization.py, do not edit!
+#include "ADM_default.h"
+#include "ADM_paramList.h"
+#include "ADM_coreJson.h"
+#include "vdpauFilterDeint.h"
+bool  vdpauFilterDeint_jserialize(const char *file, const vdpauFilterDeint *key){
+admJson json;
+json.addBool("resizeToggle",key->resizeToggle);
+json.addUint32("deintMode",key->deintMode);
+json.addUint32("targetWidth",key->targetWidth);
+json.addUint32("targetHeight",key->targetHeight);
+return json.dumpToFile(file);
+};
+bool  vdpauFilterDeint_jdeserialize(const char *file, const ADM_paramList *tmpl,vdpauFilterDeint *key){
+admJsonToCouple json;
+CONFcouple *c=json.readFromFile(file);
+if(!c) {ADM_error("Cannot read json file");return false;}
+bool r= ADM_paramLoadPartial(c,tmpl,key);
+delete c;
+return r;
+};



From mean at mail.berlios.de  Sun Aug 14 15:28:49 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Aug 2011 15:28:49 +0200
Subject: [Avidemux-svn-commit] r7405 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau
Message-ID: <20110814132849.50590481366@sheep.berlios.de>

Author: mean
Date: 2011-08-14 15:28:49 +0200 (Sun, 14 Aug 2011)
New Revision: 7405

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/CMakeLists.txt
Log:
[vdpau] Begin splitting openGL part

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp	2011-08-14 13:28:47 UTC (rev 7404)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp	2011-08-14 13:28:49 UTC (rev 7405)
@@ -1,38 +1,47 @@
 /**
     \brief VDPAU filters Deinterlacer
     \author mean (C) 2010
-    This is slow as we copy back and forth data to/from the video cards
-    
-    On a Q6600
+  
+    This version uses openGL to convert the output surface to YV12
 
-    FullHD: 
-            Readback ~ 5 ms, RGB 2 YUV ~ 20 ms : 100% CPU
-    720
-            Readback ~ 2 ms, RGB2YUV ~ 10 ms  : 50% CPU
-            
 
-
 */
-#include "ADM_cpp.h"
+#define __STDC_CONSTANT_MACROS
+#define GL_GLEXT_PROTOTYPES
+
+#include <QtGui/QPainter>
+
+#include <GL/gl.h>
+#include <GL/glext.h>
+
+#include <QtGui/QImage>
+#include <QtOpenGL/QtOpenGL>
+#include <QtOpenGL/QGLShader>
 #include <list>
-#include "ADM_default.h"
+
+#include "ADM_coreConfig.h"
 #ifdef USE_VDPAU
 extern "C" {
 #include "libavcodec/avcodec.h"
 #include "libavcodec/vdpau.h"
 }
 
+#define ADM_LEGACY_PROGGY
+#include "ADM_default.h"
+
 #include "ADM_coreVideoFilterInternal.h"
 #include "ADM_videoFilterCache.h"
 #include "DIA_factory.h"
 #include "ADM_vidMisc.h"
+
+#include "T_openGL.h"
+#include "T_openGLFilter.h"
+
+
 #include "vdpauFilterDeint.h"
 #include "vdpauFilterDeint_desc.cpp"
 
 #include "ADM_coreVdpau/include/ADM_coreVdpau.h"
-//
-#define ADM_INVALID_FRAME_NUM 0x80000000
-#define ADM_NB_SURFACES 5
 
 //#define DO_BENCHMARK
 #define NB_BENCH 100
@@ -43,32 +52,19 @@
 #define aprintf(...) {}
 #endif
 
-enum
-{
-    ADM_KEEP_TOP=0,
-    ADM_KEEP_BOTTOM=1,
-    ADM_KEEP_BOTH=2
-};
+#include "ADM_vidVdpauFilterDeint.h"
+
 /**
-    \class VDPSlot
+    \fn
 */
-class VDPSlot
-{
-public:
-                              VDPSlot() ;
-                             ~VDPSlot();
-            VdpVideoSurface   surface;
-            bool              isExternal;
-            uint64_t          pts;
-            uint32_t          frameNumber;
-            ADMImage          *image;
-};
-
 VDPSlot::VDPSlot()
 {
     surface=VDP_INVALID_HANDLE;
     image=NULL;
 }
+/**
+    \fn
+*/
 VDPSlot::~VDPSlot()
 {
     if(image) delete image;
@@ -80,54 +76,14 @@
     surface=VDP_INVALID_HANDLE;
 }
 
-/**
-    \class vdpauVideoFilterDeint
-*/
-class vdpauVideoFilterDeint : public  ADM_coreVideoFilter
-{
-protected:
-                    VDPSlot              slots[3];
-                    bool                 eof;
-                    bool                 secondField;
-                    uint64_t             nextPts;
-                    ADMColorScalerSimple *scaler;
-                    bool                 passThrough;
-                    bool                 setupVdpau(void);
-                    bool                 cleanupVdpau(void);
-                    bool                 updateConf(void);
-                    uint8_t             *tempBuffer;
-                    vdpauFilterDeint     configuration;
-                    VdpOutputSurface     outputSurface;
-                    std::list <VdpVideoSurface> freeSurface;
-                    VdpVideoSurface      surfacePool[ADM_NB_SURFACES];
-                    VdpVideoMixer        mixer;
-protected:
-                    bool                 rotateSlots(void);
-                    bool                 clearSlots(void);
-                    bool                 uploadImage(ADMImage *next,const VdpVideoSurface surface) ;
-                    bool                 fillSlot(int slot,ADMImage *image);
-                    bool                 getResult(ADMImage *image);
-                    bool                 sendField(bool topField);
-
-public:
-        virtual bool         goToTime(uint64_t usSeek); 
-                             vdpauVideoFilterDeint(ADM_coreVideoFilter *previous,CONFcouple *conf);
-                             ~vdpauVideoFilterDeint();
-
-        virtual const char   *getConfiguration(void);                 /// Return  current configuration as a human readable string
-        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);           /// Return the next image
-        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
-        virtual bool         configure(void) ;                        /// Start graphical user interface
-};
-
 // Add the hook to make it valid plugin
 DECLARE_VIDEO_FILTER(   vdpauVideoFilterDeint,   // Class
                         1,0,0,              // Version
-                        ADM_UI_GTK+ADM_UI_QT4,     // We need a display for VDPAU; so no cli...
-                        VF_INTERLACING,            // Category
-                        "vdpauDeint",            // internal name (must be uniq!)
-                        "vdpauDeint",            // Display name
-                        "VDPAU deinterlacer (+resize)." // Description
+                        ADM_UI_QT4+ADM_UI_GL,         // UI
+                        VF_OPENGL,            // Category Category
+                        "vdpauDeintGl",            // internal name (must be uniq!)
+                        "vdpauDeintGl",            // Display name
+                        "VDPAU deinterlacer+resize, openGl version (faster)." // Description
                     );
 
 //
@@ -203,7 +159,7 @@
     }
     // allocate our (dummy) images
     for(int i=0;i<3;i++)
-        slots[i].image=new ADMImageDefault( previousFilter->getInfo()->width, 
+        xslots[i].image=new ADMImageDefault( previousFilter->getInfo()->width, 
                                             previousFilter->getInfo()->height);
                                             
     if(VDP_STATUS_OK!=admVdpau::mixerCreate(previousFilter->getInfo()->width,
@@ -244,10 +200,10 @@
     if(scaler) delete scaler;
     scaler=NULL;
     for(int i=0;i<3;i++)
-       if(slots[i].image)
+       if(xslots[i].image)
         {
-            delete slots[i].image;
-            slots[i].image=NULL;
+            delete xslots[i].image;
+            xslots[i].image=NULL;
         }
 
     return true;
@@ -402,7 +358,7 @@
     }else
     {   // use the provided surface
         aprintf("Deint Image is already vdpau, slot %d \n",slot);
-        ADMImage *img=slots[slot].image;
+        ADMImage *img=xslots[slot].image;
         img->duplicateFull(image); // increment ref count
         // get surface
         img->hwDownloadFromRef();
@@ -412,9 +368,9 @@
         external=true;
     }
     nextPts=image->Pts;
-    slots[slot].pts=image->Pts;
-    slots[slot].surface=tgt;
-    slots[slot].isExternal=external;
+    xslots[slot].pts=image->Pts;
+    xslots[slot].surface=tgt;
+    xslots[slot].isExternal=external;
     return true;
 }
 
@@ -423,8 +379,8 @@
 */
 bool vdpauVideoFilterDeint::rotateSlots(void)
 {
-    VDPSlot *s=&(slots[0]);
-    ADMImage *img=slots[0].image;
+    VDPSlot *s=&(xslots[0]);
+    ADMImage *img=xslots[0].image;
     if(s->surface!=VDP_INVALID_HANDLE)
         if(!s->isExternal)
         {
@@ -436,10 +392,10 @@
             s->image->hwDecRefCount();
             s->surface=VDP_INVALID_HANDLE;
         }
-    slots[0]=slots[1];
-    slots[1]=slots[2];
-    slots[2].surface=VDP_INVALID_HANDLE;
-    slots[2].image=img;
+    xslots[0]=xslots[1];
+    xslots[1]=xslots[2];
+    xslots[2].surface=VDP_INVALID_HANDLE;
+    xslots[2].image=img;
     return true;
 }
 /**
@@ -449,7 +405,7 @@
 {
     for(int i=0;i<3;i++)
     {
-           VDPSlot *s=&(slots[i]);  
+           VDPSlot *s=&(xslots[i]);  
            if(s->surface!=VDP_INVALID_HANDLE)
             {
                 if(s->isExternal)
@@ -476,7 +432,7 @@
     // PREVIOUS
     for(int i=0;i<3;i++)
     {
-        in[i]=slots[i].surface;
+        in[i]=xslots[i].surface;
         aprintf("Mixing %d %d\n",i,(int)in[i]);
     }
     //
@@ -509,70 +465,7 @@
 #endif 
     return r;
 }
-/**
-    \fn     getResult
-    \brief  Convert the output surface into an ADMImage
-*/
-bool vdpauVideoFilterDeint::getResult(ADMImage *image)
-{
 
-#ifdef DO_BENCHMARK
-    ADMBenchmark bmark;
-    for(int i=0;i<NB_BENCH;i++)
-    {
-        bmark.start();
-#endif
-  
-    if(VDP_STATUS_OK!=admVdpau::outputSurfaceGetBitsNative(outputSurface,
-                                                            tempBuffer, 
-                                                            info.width,info.height))
-    {
-        ADM_warning("[Vdpau] Cannot copy back data from output surface\n");
-        return false;
-    }
-  
-                     
-#ifdef DO_BENCHMARK
-        bmark.end();
-    }
-    ADM_warning("Read surface Benchmark\n");
-    bmark.printResult();
-#endif 
-    // Convert from VDP_RGBA_FORMAT_B8G8R8A8 to YV12
-    uint32_t sourceStride[3]={info.width*4,0,0};
-    uint8_t  *sourceData[3]={tempBuffer,NULL,NULL};
-    uint32_t destStride[3];
-    uint8_t  *destData[3];
-
-    image->GetPitches(destStride);
-    image->GetWritePlanes(destData);
-
-    // Invert U&V
-    uint32_t ts;
-    uint8_t  *td;
-#if 0
-    ts=destStride[2];destStride[2]=destStride[1];destStride[1]=ts;
-    td=destData[1];destData[2]=destData[2];destData[1]=td;
-#endif
-
-
-#ifdef DO_BENCHMARK
-    ADMBenchmark bmark2;
-    for(int i=0;i<NB_BENCH;i++)
-    {
-        bmark2.start();
-#endif
-    scaler->convertPlanes(  sourceStride,destStride,     
-                            sourceData,destData);
-#ifdef DO_BENCHMARK
-        bmark2.end();
-    }
-    ADM_warning("RGB->YUV Benchmark\n");
-    bmark2.printResult();
-#endif
-
-    return true;
-}
 /**
     \fn getNextFrame
     \brief 

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h	2011-08-14 13:28:49 UTC (rev 7405)
@@ -0,0 +1,75 @@
+/**
+    \brief VDPAU filters Deinterlacer
+    \author mean (C) 2010
+  
+    This version uses openGL to convert the output surface to YV12
+
+
+*/
+
+//
+#define ADM_INVALID_FRAME_NUM 0x80000000
+#define ADM_NB_SURFACES 5
+
+
+enum
+{
+    ADM_KEEP_TOP=0,
+    ADM_KEEP_BOTTOM=1,
+    ADM_KEEP_BOTH=2
+};
+/**
+    \class VDPSlot
+*/
+class VDPSlot
+{
+public:
+                              VDPSlot() ;
+                             ~VDPSlot();
+            VdpVideoSurface   surface;
+            bool              isExternal;
+            uint64_t          pts;
+            uint32_t          frameNumber;
+            ADMImage          *image;
+};
+
+/**
+    \class vdpauVideoFilterDeint
+*/
+class vdpauVideoFilterDeint : public  ADM_coreVideoFilter
+{
+protected:
+                    VDPSlot              xslots[3];
+                    bool                 eof;
+                    bool                 secondField;
+                    uint64_t             nextPts;
+                    ADMColorScalerSimple *scaler;
+                    bool                 passThrough;
+                    bool                 setupVdpau(void);
+                    bool                 cleanupVdpau(void);
+                    bool                 updateConf(void);
+                    uint8_t             *tempBuffer;
+                    vdpauFilterDeint     configuration;
+                    VdpOutputSurface     outputSurface;
+                    std::list <VdpVideoSurface> freeSurface;
+                    VdpVideoSurface      surfacePool[ADM_NB_SURFACES];
+                    VdpVideoMixer        mixer;
+protected:
+                    bool                 rotateSlots(void);
+                    bool                 clearSlots(void);
+                    bool                 uploadImage(ADMImage *next,const VdpVideoSurface surface) ;
+                    bool                 fillSlot(int slot,ADMImage *image);
+                    bool                 getResult(ADMImage *image);
+                    bool                 sendField(bool topField);
+
+public:
+        virtual bool         goToTime(uint64_t usSeek); 
+                             vdpauVideoFilterDeint(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                             ~vdpauVideoFilterDeint();
+
+        virtual const char   *getConfiguration(void);                 /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);           /// Return the next image
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) ;                        /// Start graphical user interface
+};
+// EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 13:28:49 UTC (rev 7405)
@@ -0,0 +1,128 @@
+/**
+    \brief VDPAU filters Deinterlacer
+    \author mean (C) 2010
+  
+    This version uses openGL to convert the output surface to YV12
+
+
+*/
+
+
+#define __STDC_CONSTANT_MACROS
+#define GL_GLEXT_PROTOTYPES
+
+#       include <GL/gl.h>
+#       include <GL/glext.h>
+
+#include <QtGui/QImage>
+#include <QtOpenGL/QtOpenGL>
+#include <QtOpenGL/QGLShader>
+#include <list>
+
+#include "ADM_coreConfig.h"
+#ifdef USE_VDPAU
+extern "C" {
+#include "libavcodec/avcodec.h"
+#include "libavcodec/vdpau.h"
+}
+
+#define ADM_LEGACY_PROGGY
+#include "ADM_default.h"
+
+#include "ADM_coreVideoFilterInternal.h"
+#include "ADM_videoFilterCache.h"
+#include "DIA_factory.h"
+#include "ADM_vidMisc.h"
+
+#include "T_openGL.h"
+#include "T_openGLFilter.h"
+
+
+#include "vdpauFilterDeint.h"
+#include "ADM_vidVdpauFilterDeint.h"
+#include "ADM_coreVdpau/include/ADM_coreVdpau.h"
+//
+#define ADM_INVALID_FRAME_NUM 0x80000000
+#define ADM_NB_SURFACES 5
+
+//#define DO_BENCHMARK
+#define NB_BENCH 100
+
+#if 0
+#define aprintf printf
+#else
+#define aprintf(...) {}
+#endif
+/**
+    \fn     getResult
+    \brief  Convert the output surface into an ADMImage
+*/
+bool vdpauVideoFilterDeint::getResult(ADMImage *image)
+{
+
+#ifdef DO_BENCHMARK
+    ADMBenchmark bmark;
+    for(int i=0;i<NB_BENCH;i++)
+    {
+        bmark.start();
+#endif
+  
+    if(VDP_STATUS_OK!=admVdpau::outputSurfaceGetBitsNative(outputSurface,
+                                                            tempBuffer, 
+                                                            info.width,info.height))
+    {
+        ADM_warning("[Vdpau] Cannot copy back data from output surface\n");
+        return false;
+    }
+  
+                     
+#ifdef DO_BENCHMARK
+        bmark.end();
+    }
+    ADM_warning("Read surface Benchmark\n");
+    bmark.printResult();
+#endif 
+    // Convert from VDP_RGBA_FORMAT_B8G8R8A8 to YV12
+    uint32_t sourceStride[3]={info.width*4,0,0};
+    uint8_t  *sourceData[3]={tempBuffer,NULL,NULL};
+    uint32_t destStride[3];
+    uint8_t  *destData[3];
+
+    image->GetPitches(destStride);
+    image->GetWritePlanes(destData);
+
+    // Invert U&V
+    uint32_t ts;
+    uint8_t  *td;
+#if 0
+    ts=destStride[2];destStride[2]=destStride[1];destStride[1]=ts;
+    td=destData[1];destData[2]=destData[2];destData[1]=td;
+#endif
+
+
+#ifdef DO_BENCHMARK
+    ADMBenchmark bmark2;
+    for(int i=0;i<NB_BENCH;i++)
+    {
+        bmark2.start();
+#endif
+    scaler->convertPlanes(  sourceStride,destStride,     
+                            sourceData,destData);
+#ifdef DO_BENCHMARK
+        bmark2.end();
+    }
+    ADM_warning("RGB->YUV Benchmark\n");
+    bmark2.printResult();
+#endif
+
+    return true;
+}
+#else // USE_VDPAU
+static void dummy_fun(void)
+{
+    return ;
+}
+#endif // use VDPAU
+
+//****************
+// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/CMakeLists.txt	2011-08-14 13:28:47 UTC (rev 7404)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/CMakeLists.txt	2011-08-14 13:28:49 UTC (rev 7405)
@@ -1,6 +1,6 @@
 INCLUDE(vf_plugin)
 INCLUDE(vf_plugin_qt4gl)
 IF(NOT WIN32 AND NOT APPLE)
-        SET(ADM_vf_vdpauFilterDeint_SRCS ADM_vidVdpauFilterDeint.cpp )
+        SET(ADM_vf_vdpauFilterDeint_SRCS ADM_vidVdpauFilterDeint.cpp ADM_vidVdpauFilterDeintGl.cpp)
         INIT_VIDEO_FILTER_GLQT4(ADM_vf_vdpauGl "${ADM_vf_vdpauFilterDeint_SRCS}" "ADM_vf_vdpauGl.h" "ADM_vf_vdpauGl" "${ADM_vf_vdpauFilterDeint_SRCS}")
 ENDIF(NOT WIN32 AND NOT APPLE)



From mean at mail.berlios.de  Sun Aug 14 15:28:50 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Aug 2011 15:28:50 +0200
Subject: [Avidemux-svn-commit] r7406 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau:
	include src
Message-ID: <20110814132850.B1EAC481366@sheep.berlios.de>

Author: mean
Date: 2011-08-14 15:28:50 +0200 (Sun, 14 Aug 2011)
New Revision: 7406

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp
Log:
[vdpau] Add hook for openGL-Vdpau exchange

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h	2011-08-14 13:28:49 UTC (rev 7405)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h	2011-08-14 13:28:50 UTC (rev 7406)
@@ -40,6 +40,8 @@
     static bool         cleanup(void);
     /* Surface */
 #ifdef USE_VDPAU
+    static  void        *getVdpDevice(void);
+    static  void        *getProcAddress(void);
     static  const char  *getErrorString(VdpStatus er);
     static  bool        mixerIsFeatureEnabled( VdpVideoMixer mixer,VdpVideoMixerFeature feature);
     static  VdpStatus   surfaceCreate(uint32_t width,uint32_t height,VdpVideoSurface *surface);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp	2011-08-14 13:28:49 UTC (rev 7405)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp	2011-08-14 13:28:50 UTC (rev 7406)
@@ -32,6 +32,8 @@
 static VdpGetProcAddress     *vdpProcAddress;
 static bool                  coreVdpWorking=false;
 static VdpPresentationQueueTarget  queueX11;
+
+
 /**
     \fn getFunc
     \brief vdpau function pointers from ID
@@ -42,8 +44,22 @@
     if(VDP_STATUS_OK!=vdpProcAddress(ADM_coreVdpau::vdpDevice,id,&f)) return NULL;
     return (void *)f;
 }
+/**
 
+*/
+void        *admVdpau::getVdpDevice(void)
+{
+        return (void *)ADM_coreVdpau::vdpDevice;
+}
 /**
+
+*/
+void        *admVdpau::getProcAddress(void)
+{
+    return (void *)vdpProcAddress;
+}
+
+/**
     \fn     init
     \brief
 */



From mean at mail.berlios.de  Sun Aug 14 15:28:51 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Aug 2011 15:28:51 +0200
Subject: [Avidemux-svn-commit] r7407 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau
Message-ID: <20110814132852.00A0E481366@sheep.berlios.de>

Author: mean
Date: 2011-08-14 15:28:51 +0200 (Sun, 14 Aug 2011)
New Revision: 7407

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
Log:
[vdpau/gl] Add an openGl version of vdpau deint

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp	2011-08-14 13:28:50 UTC (rev 7406)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp	2011-08-14 13:28:51 UTC (rev 7407)
@@ -112,6 +112,7 @@
         info.frameIncrement=prev/2;
     else
         info.frameIncrement=prev;
+    initGl();
     return true;
 }
 /**
@@ -175,7 +176,14 @@
     for(int i=0;i<ADM_NB_SURFACES;i++)  
             freeSurface.push_back(surfacePool[i]);
 
+    
     ADM_info("VDPAU setup ok\n");
+    if(initGl()==false)
+    {
+        ADM_error("Cannot setup openGL\n");
+        goto badInit;
+    }
+    ADM_info("VDPAU setup ok\n");
     return true;
 badInit:
     cleanupVdpau();
@@ -205,7 +213,7 @@
             delete xslots[i].image;
             xslots[i].image=NULL;
         }
-
+    deInitGl();
     return true;
 }
 
@@ -215,6 +223,7 @@
 vdpauVideoFilterDeint::vdpauVideoFilterDeint(ADM_coreVideoFilter *in, CONFcouple *setup): ADM_coreVideoFilter(in,setup)
 {
     eof=false;
+    rgb=NULL;
     for(int i=0;i<ADM_NB_SURFACES;i++)
         surfacePool[i]=VDP_INVALID_HANDLE;
     mixer=VDP_INVALID_HANDLE;
@@ -234,6 +243,7 @@
     updateConf();    
     passThrough=!setupVdpau();
     
+    
 }
 /**
     \fn destructor

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h	2011-08-14 13:28:50 UTC (rev 7406)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h	2011-08-14 13:28:51 UTC (rev 7407)
@@ -32,7 +32,28 @@
             uint32_t          frameNumber;
             ADMImage          *image;
 };
+/**
+    \class glRGB
+*/
+class glRGB : public  ADM_coreVideoFilterQtGl
+{
+protected:
 
+protected:
+                            bool render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo);
+                    
+public:
+                             glRGB(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                            ~glRGB();
+
+        virtual const char   *getConfiguration(void) {return "none";};                   /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) {return true;}             /// Start graphical user interface
+
+        bool                 surfaceToImage(VdpOutputSurface surf,ADMImage *image);
+};
+
 /**
     \class vdpauVideoFilterDeint
 */
@@ -54,7 +75,12 @@
                     std::list <VdpVideoSurface> freeSurface;
                     VdpVideoSurface      surfacePool[ADM_NB_SURFACES];
                     VdpVideoMixer        mixer;
+                    glRGB                *rgb;
 protected:
+                    bool                initGl(void);
+                    bool                initOnceGl(void);
+                    bool                deInitGl(void);
+protected:
                     bool                 rotateSlots(void);
                     bool                 clearSlots(void);
                     bool                 uploadImage(ADMImage *next,const VdpVideoSurface surface) ;
@@ -72,4 +98,7 @@
         virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
         virtual bool         configure(void) ;                        /// Start graphical user interface
 };
+
+//EOF
+
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 13:28:50 UTC (rev 7406)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 13:28:51 UTC (rev 7407)
@@ -53,13 +53,123 @@
 #else
 #define aprintf(...) {}
 #endif
+
+static int nbNvInit=0;
+static const char *glShaderRgb =
+	"#extension GL_ARB_texture_rectangle: enable\n"
+	"uniform sampler2DRect myTextureY;\n" // tex unit 0
+    "uniform float myWidth;\n"
+    "uniform float myHeight;\n"
+    
+	"void main(void) {\n"
+    "  float nx = gl_TexCoord[0].x;\n"
+	"  float ny = gl_TexCoord[0].y;\n"
+	"  vec4 texvalY = texture2DRect(myTextureY, vec2(nx,ny));\n" 
+	"  gl_FragColor = vec4(texvalY.g, 128,128,1);\n" //texvalU.r, texvalV.r, 1.0);\n"
+	"}\n";
+
+//--------------------------------------------------------------------------------------
+/***/
+typedef GLintptr GLvdpauSurfaceNV;
+
+
+
+typedef void            typeVDPAUInitNV(const void *vdpDevice,      const void *getProcAddress);
+typedef GLvdpauSurfaceNV typeVDPAURegisterOutputSurfaceNV (const void *vdpSurface,
+                                                 GLenum      target,
+                                                 GLsizei     numTextureNames,
+                                                 const GLuint *textureNames);
+typedef void   typeVDPAUUnregisterSurfaceNV (GLvdpauSurfaceNV surface);
+typedef void   typeVDPAUMapSurfacesNV (GLsizei numSurfaces,const GLvdpauSurfaceNV *surfaces);
+typedef void   typeVDPAUUnmapSurfacesNV (GLsizei numSurface, const GLvdpauSurfaceNV *surfaces);
+typedef void   typeVDPAUSurfaceAccessNV (GLvdpauSurfaceNV surface,   int           access);
+typedef void   typeVDPAUFiniNV(void);
+/***/
+typeVDPAUInitNV                     *VDPAUInitNV=NULL;
+typeVDPAURegisterOutputSurfaceNV    *VDPAURegisterOutputSurfaceNV=NULL;
+typeVDPAUUnregisterSurfaceNV        *VDPAUUnregisterSurfaceNV=NULL;
+typeVDPAUMapSurfacesNV              *VDPAUMapSurfacesNV=NULL;
+typeVDPAUUnmapSurfacesNV            *VDPAUUnmapSurfacesNV=NULL;
+typeVDPAUSurfaceAccessNV            *VDPAUSurfaceAccessNV=NULL;
+typeVDPAUFiniNV                     *VDPAUFiniNV=NULL;
+/***/
+#define GETFUNC(x)   x = (type##x *)ADM_getGlWidget()->context()->getProcAddress(QLatin1String("gl"#x));\
+    if(!x) \
+    {\
+            ADM_error("Cannot get "#x"\n");\
+            exit(-1);\
+    }
 /**
+    \fn processError
+*/
+static void processError(const char *e)
+{
+    int x=glGetError();
+    if(x!=GL_NO_ERROR)
+    {
+        ADM_error("%s: Error : %d %s\n",e,x,gluErrorString(x));
+    }
+}
+/**
+    \fn initGl
+*/
+bool vdpauVideoFilterDeint::initOnceGl(void)
+{
+    ADM_info("Initializing VDPAU<->openGl\n");
+    if(nbNvInit)
+    {
+        ADM_info("Already done..\n");
+        nbNvInit++;
+        return true;
+    }
+    GETFUNC(VDPAUInitNV);
+    GETFUNC(VDPAURegisterOutputSurfaceNV);
+    GETFUNC(VDPAUUnregisterSurfaceNV);  
+    GETFUNC(VDPAUMapSurfacesNV);  
+    GETFUNC(VDPAUUnmapSurfacesNV);  
+    GETFUNC(VDPAUSurfaceAccessNV);  
+    GETFUNC(VDPAUFiniNV);
+    VDPAUInitNV(admVdpau::getVdpDevice(),admVdpau::getProcAddress());
+    processError("InitNv");
+    nbNvInit++;
+    return true;
+}
+/**
+     \fn initGl
+*/
+bool vdpauVideoFilterDeint::initGl(void)
+{
+   initOnceGl();
+   rgb=new glRGB(this,NULL);
+   return true;
+}
+
+/**
+    \fn deInitGl
+*/
+bool vdpauVideoFilterDeint::deInitGl(void)
+{
+    ADM_info("De-Initializing VDPAU<->openGl\n");
+    delete rgb;
+    rgb=NULL;
+    if(nbNvInit!=1)
+    {
+        ADM_info("still used..\n");
+        if(nbNvInit) nbNvInit--;
+        return true;
+    }
+    VDPAUFiniNV();
+    nbNvInit--;
+    return true;
+}
+
+/**
     \fn     getResult
     \brief  Convert the output surface into an ADMImage
 */
 bool vdpauVideoFilterDeint::getResult(ADMImage *image)
 {
-
+    return rgb->surfaceToImage(outputSurface,image);
 #ifdef DO_BENCHMARK
     ADMBenchmark bmark;
     for(int i=0;i<NB_BENCH;i++)
@@ -123,6 +233,120 @@
     return ;
 }
 #endif // use VDPAU
+//-----------------------------------------------------------------
+/**
+    \fn render
+*/
+bool glRGB::render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo)
+{
+    int width=image->GetWidth(plane);
+    int height=image->GetHeight(plane);
 
+    glClear(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);
+	glViewport(0, 0, width, height);
+    glMatrixMode(GL_PROJECTION);
+    glLoadIdentity();
+    glOrtho(0, width, 0, height, -1, 1);
+
+    //
+    glBegin(GL_QUADS);
+	glTexCoord2i(0, 0);
+	glVertex2i(0, 0);
+	glTexCoord2i(width, 0);
+	glVertex2i(width, 0);
+	glTexCoord2i(width, height);
+	glVertex2i(width ,height);
+	glTexCoord2i(0, height);
+	glVertex2i(0, height);
+	glEnd();	// draw cube background
+    return true;
+}
+/**
+    \fn ctor
+*/
+glRGB::glRGB(ADM_coreVideoFilter *previous,CONFcouple *conf) 
+            :  ADM_coreVideoFilterQtGl(previous,conf)
+{
+        widget->makeCurrent();
+        fboY->bind();
+        printf("Compiling shader \n");
+        glProgramY = new QGLShaderProgram(context);
+        ADM_assert(glShaderRgb);
+        if ( !glProgramY->addShaderFromSourceCode(QGLShader::Fragment, glShaderRgb))
+        {
+                ADM_error("[GL Render] Fragment log: %s\n", glProgramY->log().toUtf8().constData());
+                ADM_assert(0);
+        }
+        if ( !glProgramY->link())
+        {
+            ADM_error("[GL Render] Link log: %s\n", glProgramY->log().toUtf8().constData());
+            ADM_assert(0);
+        }
+
+        if ( !glProgramY->bind())
+        {
+                ADM_error("[GL Render] Binding FAILED\n");
+                ADM_assert(0);
+        }
+
+        fboY->release();
+        widget->doneCurrent();
+}
+/**
+    \fn dtor
+*/
+glRGB::~glRGB()
+{
+
+}
+/**
+
+*/
+bool         glRGB::getNextFrame(uint32_t *fn,ADMImage *image) {ADM_assert(0);return false;}
+bool         glRGB::getCoupledConf(CONFcouple **couples) {ADM_assert(0);return false;};   
+/**
+    \fn surfaceToImage
+*/
+bool   glRGB::surfaceToImage(VdpOutputSurface surf,ADMImage *image)
+{
+    widget->makeCurrent();
+    glPushMatrix();
+    // size is the last one...
+    fboY->bind();
+    processError("Bind");
+    glProgramY->setUniformValue("myTextureY", 0); 
+    glProgramY->setUniformValue("myWidth", image->GetWidth(PLANAR_Y)); 
+    glProgramY->setUniformValue("myHeight", image->GetHeight(PLANAR_Y)); 
+
+    myGlActiveTexture(GL_TEXTURE0);
+    processError("Active Texture");
+    glBindTexture(GL_TEXTURE_RECTANGLE_NV, texName[0]); 
+    processError("Bind Texture");
+    //---
+    GLvdpauSurfaceNV s=VDPAURegisterOutputSurfaceNV((const void *)surf,
+                                                        GL_TEXTURE_2D,1,texName);
+    printf("S=%x\n",(int)s);
+    processError("Register");
+    VDPAUSurfaceAccessNV(s,GL_READ_ONLY);
+    VDPAUMapSurfacesNV(1,&s);
+    processError("Map");
+
+    render(image,PLANAR_Y,fboY);
+    downloadTextures(image,fboY);
+
+    VDPAUUnmapSurfacesNV(1,&s);
+    processError("Unmap");
+    VDPAUUnregisterSurfaceNV(s);
+    processError("Unregister");
+    fboY->release();
+    firstRun=false;
+    glPopMatrix();
+    widget->doneCurrent();
+  
+
+    return true;
+}
+
+
 //****************
 // EOF



From mean at mail.berlios.de  Sun Aug 14 15:28:53 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Aug 2011 15:28:53 +0200
Subject: [Avidemux-svn-commit] r7408 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau
Message-ID: <20110814132853.37BB5481366@sheep.berlios.de>

Author: mean
Date: 2011-08-14 15:28:52 +0200 (Sun, 14 Aug 2011)
New Revision: 7408

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp
Log:
[vdpaugl] Use glext.h native types and prototypes

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp	2011-08-14 13:28:51 UTC (rev 7407)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp	2011-08-14 13:28:52 UTC (rev 7408)
@@ -112,7 +112,6 @@
         info.frameIncrement=prev/2;
     else
         info.frameIncrement=prev;
-    initGl();
     return true;
 }
 /**



From mean at mail.berlios.de  Sun Aug 14 15:28:54 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Aug 2011 15:28:54 +0200
Subject: [Avidemux-svn-commit] r7409 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau
Message-ID: <20110814132854.66086481366@sheep.berlios.de>

Author: mean
Date: 2011-08-14 15:28:54 +0200 (Sun, 14 Aug 2011)
New Revision: 7409

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
Log:
[vdpaugl] Use glext.h native types and prototypes

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 13:28:52 UTC (rev 7408)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 13:28:54 UTC (rev 7409)
@@ -14,7 +14,7 @@
 #       include <GL/gl.h>
 #       include <GL/glext.h>
 
-#include <QtGui/QImage>
+#include <QtGui/QImage> 
 #include <QtOpenGL/QtOpenGL>
 #include <QtOpenGL/QGLShader>
 #include <list>
@@ -42,9 +42,6 @@
 #include "ADM_vidVdpauFilterDeint.h"
 #include "ADM_coreVdpau/include/ADM_coreVdpau.h"
 //
-#define ADM_INVALID_FRAME_NUM 0x80000000
-#define ADM_NB_SURFACES 5
-
 //#define DO_BENCHMARK
 #define NB_BENCH 100
 
@@ -54,7 +51,8 @@
 #define aprintf(...) {}
 #endif
 
-static int nbNvInit=0;
+
+
 static const char *glShaderRgb =
 	"#extension GL_ARB_texture_rectangle: enable\n"
 	"uniform sampler2DRect myTextureY;\n" // tex unit 0
@@ -70,35 +68,31 @@
 
 //--------------------------------------------------------------------------------------
 /***/
-typedef GLintptr GLvdpauSurfaceNV;
 
 
+/***/
+PFNGLVDPAUINITNVPROC                VDPAUInitNV=NULL;
+PFNGLVDPAUFININVPROC                VDPAUFiniNV=NULL;
 
-typedef void            typeVDPAUInitNV(const void *vdpDevice,      const void *getProcAddress);
-typedef GLvdpauSurfaceNV typeVDPAURegisterOutputSurfaceNV (const void *vdpSurface,
-                                                 GLenum      target,
-                                                 GLsizei     numTextureNames,
-                                                 const GLuint *textureNames);
-typedef void   typeVDPAUUnregisterSurfaceNV (GLvdpauSurfaceNV surface);
-typedef void   typeVDPAUMapSurfacesNV (GLsizei numSurfaces,const GLvdpauSurfaceNV *surfaces);
-typedef void   typeVDPAUUnmapSurfacesNV (GLsizei numSurface, const GLvdpauSurfaceNV *surfaces);
-typedef void   typeVDPAUSurfaceAccessNV (GLvdpauSurfaceNV surface,   int           access);
-typedef void   typeVDPAUFiniNV(void);
+PFNGLVDPAUREGISTEROUTPUTSURFACENVPROC VDPAURegisterOutputSurfaceNV=NULL;
+PFNGLVDPAUREGISTERVIDEOSURFACENVPROC  VDPAURegisterVideoSurfaceNV=NULL;
+PFNGLVDPAUUNREGISTERSURFACENVPROC     VDPAUUnregisterSurfaceNV=NULL;
+
+PFNGLVDPAUMAPSURFACESNVPROC         VDPAUMapSurfacesNV=NULL;
+PFNGLVDPAUUNMAPSURFACESNVPROC       VDPAUUnmapSurfacesNV=NULL;
+PFNGLVDPAUSURFACEACCESSNVPROC       VDPAUSurfaceAccessNV=NULL;
+
+
 /***/
-typeVDPAUInitNV                     *VDPAUInitNV=NULL;
-typeVDPAURegisterOutputSurfaceNV    *VDPAURegisterOutputSurfaceNV=NULL;
-typeVDPAUUnregisterSurfaceNV        *VDPAUUnregisterSurfaceNV=NULL;
-typeVDPAUMapSurfacesNV              *VDPAUMapSurfacesNV=NULL;
-typeVDPAUUnmapSurfacesNV            *VDPAUUnmapSurfacesNV=NULL;
-typeVDPAUSurfaceAccessNV            *VDPAUSurfaceAccessNV=NULL;
-typeVDPAUFiniNV                     *VDPAUFiniNV=NULL;
-/***/
-#define GETFUNC(x)   x = (type##x *)ADM_getGlWidget()->context()->getProcAddress(QLatin1String("gl"#x));\
+#define GETFUNC(x)   x = (typeof(x) )ADM_getGlWidget()->context()->getProcAddress(QLatin1String("gl"#x));\
     if(!x) \
     {\
             ADM_error("Cannot get "#x"\n");\
             exit(-1);\
     }
+
+
+static bool vdpauGlInited=false;
 /**
     \fn processError
 */
@@ -116,14 +110,14 @@
 bool vdpauVideoFilterDeint::initOnceGl(void)
 {
     ADM_info("Initializing VDPAU<->openGl\n");
-    if(nbNvInit)
+    if(vdpauGlInited)
     {
         ADM_info("Already done..\n");
-        nbNvInit++;
         return true;
     }
     GETFUNC(VDPAUInitNV);
     GETFUNC(VDPAURegisterOutputSurfaceNV);
+    GETFUNC(VDPAURegisterVideoSurfaceNV);
     GETFUNC(VDPAUUnregisterSurfaceNV);  
     GETFUNC(VDPAUMapSurfacesNV);  
     GETFUNC(VDPAUUnmapSurfacesNV);  
@@ -131,7 +125,7 @@
     GETFUNC(VDPAUFiniNV);
     VDPAUInitNV(admVdpau::getVdpDevice(),admVdpau::getProcAddress());
     processError("InitNv");
-    nbNvInit++;
+    vdpauGlInited=true;
     return true;
 }
 /**
@@ -152,14 +146,6 @@
     ADM_info("De-Initializing VDPAU<->openGl\n");
     delete rgb;
     rgb=NULL;
-    if(nbNvInit!=1)
-    {
-        ADM_info("still used..\n");
-        if(nbNvInit) nbNvInit--;
-        return true;
-    }
-    VDPAUFiniNV();
-    nbNvInit--;
     return true;
 }
 
@@ -169,6 +155,7 @@
 */
 bool vdpauVideoFilterDeint::getResult(ADMImage *image)
 {
+    
     return rgb->surfaceToImage(outputSurface,image);
 #ifdef DO_BENCHMARK
     ADMBenchmark bmark;
@@ -269,7 +256,7 @@
 {
         widget->makeCurrent();
         fboY->bind();
-        printf("Compiling shader \n");
+        ADM_info("Compiling shader \n");
         glProgramY = new QGLShaderProgram(context);
         ADM_assert(glShaderRgb);
         if ( !glProgramY->addShaderFromSourceCode(QGLShader::Fragment, glShaderRgb))
@@ -314,23 +301,24 @@
     // size is the last one...
     fboY->bind();
     processError("Bind");
-    glProgramY->setUniformValue("myTextureY", 0); 
-    glProgramY->setUniformValue("myWidth", image->GetWidth(PLANAR_Y)); 
-    glProgramY->setUniformValue("myHeight", image->GetHeight(PLANAR_Y)); 
+    glProgramY->setUniformValue("myTextureY", (GLfloat)0); 
+    glProgramY->setUniformValue("myWidth", (GLfloat)image->GetWidth(PLANAR_Y)); 
+    glProgramY->setUniformValue("myHeight", (GLfloat)image->GetHeight(PLANAR_Y)); 
 
-    myGlActiveTexture(GL_TEXTURE0);
-    processError("Active Texture");
-    glBindTexture(GL_TEXTURE_RECTANGLE_NV, texName[0]); 
-    processError("Bind Texture");
-    //---
-    GLvdpauSurfaceNV s=VDPAURegisterOutputSurfaceNV((const void *)surf,
-                                                        GL_TEXTURE_2D,1,texName);
-    printf("S=%x\n",(int)s);
+    //
+    GLvdpauSurfaceNV s=VDPAURegisterOutputSurfaceNV((GLvoid *)surf,GL_TEXTURE_2D,1,texName);
+    printf("Surface =%d, GlSurface=%x, texName : %d\n",(int)surf,(int)s,(int)texName[0]);
     processError("Register");
     VDPAUSurfaceAccessNV(s,GL_READ_ONLY);
     VDPAUMapSurfacesNV(1,&s);
     processError("Map");
 
+    myGlActiveTexture(GL_TEXTURE0);
+    processError("Active Texture");
+    glBindTexture(GL_TEXTURE_RECTANGLE_NV, texName[0]); 
+    processError("Bind Texture");
+
+
     render(image,PLANAR_Y,fboY);
     downloadTextures(image,fboY);
 



From mean at mail.berlios.de  Sun Aug 14 18:48:43 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Aug 2011 18:48:43 +0200
Subject: [Avidemux-svn-commit] r7410 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau
Message-ID: <20110814164843.6AE804815AB@sheep.berlios.de>

Author: mean
Date: 2011-08-14 18:48:42 +0200 (Sun, 14 Aug 2011)
New Revision: 7410

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
Log:
[vdpauGl] Do RGB2YUV through CPU if VDPAU2GL does not work

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h	2011-08-14 13:28:54 UTC (rev 7409)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h	2011-08-14 16:48:42 UTC (rev 7410)
@@ -51,7 +51,9 @@
         virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
         virtual bool         configure(void) {return true;}             /// Start graphical user interface
 
-        bool                 surfaceToImage(VdpOutputSurface surf,ADMImage *image);
+        bool                 surfaceToImage(VdpOutputSurface surf,ADMImage *image); /// VDPAU->openGL
+        bool                 imageToImage(const char *buffer,ADMImage *image);      /// VDPAU->CPU->OpenGL (slow)
+        bool                 probe(VdpOutputSurface surf,ADMImage *image);
 };
 
 /**
@@ -86,6 +88,7 @@
                     bool                 uploadImage(ADMImage *next,const VdpVideoSurface surface) ;
                     bool                 fillSlot(int slot,ADMImage *image);
                     bool                 getResult(ADMImage *image);
+                    bool                 getResultSlow(ADMImage *image);
                     bool                 sendField(bool topField);
 
 public:

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 13:28:54 UTC (rev 7409)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 16:48:42 UTC (rev 7410)
@@ -63,7 +63,12 @@
     "  float nx = gl_TexCoord[0].x;\n"
 	"  float ny = gl_TexCoord[0].y;\n"
 	"  vec4 texvalY = texture2DRect(myTextureY, vec2(nx,ny));\n" 
-	"  gl_FragColor = vec4(texvalY.g, 128,128,1);\n" //texvalU.r, texvalV.r, 1.0);\n"
+    "  float yy=0.299*texvalY.r+0.587*texvalY.g+0.114*texvalY.b;\n"
+    "  float zz=-0.14713*texvalY.r-0.2886*texvalY.g+0.436*texvalY.b;\n"
+    "  float tt=0.615*texvalY.r-0.51499*texvalY.g-0.1001*texvalY.b;\n"
+    "  zz=zz+0.5;\n"
+    "  tt=tt+0.5;\n"
+	"  gl_FragColor = vec4(yy,zz,tt,1);\n" //texvalU.r, texvalV.r, 1.0);\n"
 	"}\n";
 
 //--------------------------------------------------------------------------------------
@@ -96,13 +101,15 @@
 /**
     \fn processError
 */
-static void processError(const char *e)
+static bool processError(const char *e)
 {
     int x=glGetError();
     if(x!=GL_NO_ERROR)
     {
         ADM_error("%s: Error : %d %s\n",e,x,gluErrorString(x));
+        return false;
     }
+    return true;
 }
 /**
     \fn initGl
@@ -123,8 +130,11 @@
     GETFUNC(VDPAUUnmapSurfacesNV);  
     GETFUNC(VDPAUSurfaceAccessNV);  
     GETFUNC(VDPAUFiniNV);
-    VDPAUInitNV(admVdpau::getVdpDevice(),admVdpau::getProcAddress());
-    processError("InitNv");
+    const void *device=admVdpau::getVdpDevice();
+    const void *proc=admVdpau::getProcAddress();
+    ADM_info("VDPAU InitNv with device=%lx, proc=%lx\n",(long int)device,(long int)proc);
+    VDPAUInitNV(device,proc);
+    if(false==processError("InitNv")) return false;
     vdpauGlInited=true;
     return true;
 }
@@ -134,7 +144,9 @@
 bool vdpauVideoFilterDeint::initGl(void)
 {
    initOnceGl();
+   ADM_info("Creating VDPAU GL wrapper\n");
    rgb=new glRGB(this,NULL);
+   rgb->probe(outputSurface,NULL);
    return true;
 }
 
@@ -143,26 +155,16 @@
 */
 bool vdpauVideoFilterDeint::deInitGl(void)
 {
-    ADM_info("De-Initializing VDPAU<->openGl\n");
+    ADM_info("Destroying VDPAU GL wrapper\n");
     delete rgb;
     rgb=NULL;
     return true;
 }
-
 /**
-    \fn     getResult
-    \brief  Convert the output surface into an ADMImage
+    \fn getResultSlow
 */
-bool vdpauVideoFilterDeint::getResult(ADMImage *image)
+bool vdpauVideoFilterDeint::getResultSlow(ADMImage *image)
 {
-    
-    return rgb->surfaceToImage(outputSurface,image);
-#ifdef DO_BENCHMARK
-    ADMBenchmark bmark;
-    for(int i=0;i<NB_BENCH;i++)
-    {
-        bmark.start();
-#endif
   
     if(VDP_STATUS_OK!=admVdpau::outputSurfaceGetBitsNative(outputSurface,
                                                             tempBuffer, 
@@ -172,46 +174,18 @@
         return false;
     }
   
-                     
-#ifdef DO_BENCHMARK
-        bmark.end();
-    }
-    ADM_warning("Read surface Benchmark\n");
-    bmark.printResult();
-#endif 
-    // Convert from VDP_RGBA_FORMAT_B8G8R8A8 to YV12
-    uint32_t sourceStride[3]={info.width*4,0,0};
-    uint8_t  *sourceData[3]={tempBuffer,NULL,NULL};
-    uint32_t destStride[3];
-    uint8_t  *destData[3];
-
-    image->GetPitches(destStride);
-    image->GetWritePlanes(destData);
-
-    // Invert U&V
-    uint32_t ts;
-    uint8_t  *td;
-#if 0
-    ts=destStride[2];destStride[2]=destStride[1];destStride[1]=ts;
-    td=destData[1];destData[2]=destData[2];destData[1]=td;
-#endif
-
-
-#ifdef DO_BENCHMARK
-    ADMBenchmark bmark2;
-    for(int i=0;i<NB_BENCH;i++)
-    {
-        bmark2.start();
-#endif
-    scaler->convertPlanes(  sourceStride,destStride,     
-                            sourceData,destData);
-#ifdef DO_BENCHMARK
-        bmark2.end();
-    }
-    ADM_warning("RGB->YUV Benchmark\n");
-    bmark2.printResult();
-#endif
-
+    // tempBuffer                
+    return rgb->imageToImage((const char *)tempBuffer,image);
+}
+/**
+    \fn     getResult
+    \brief  Convert the output surface into an ADMImage
+*/
+bool vdpauVideoFilterDeint::getResult(ADMImage *image)
+{
+    
+    if(false==rgb->surfaceToImage(outputSurface,image))
+            return getResultSlow(image);
     return true;
 }
 #else // USE_VDPAU
@@ -292,10 +266,29 @@
 bool         glRGB::getNextFrame(uint32_t *fn,ADMImage *image) {ADM_assert(0);return false;}
 bool         glRGB::getCoupledConf(CONFcouple **couples) {ADM_assert(0);return false;};   
 /**
+    \fn probe
+*/
+bool   glRGB::probe(VdpOutputSurface surf,ADMImage *image)
+{
+    widget->makeCurrent();
+    glPushMatrix();
+    // size is the last one...
+    fboY->bind();
+    processError("Bind");
+    GLvdpauSurfaceNV s=VDPAURegisterOutputSurfaceNV((GLvoid *)surf,GL_TEXTURE_2D,1,texName);
+    VDPAUUnregisterSurfaceNV(s);
+    processError("Unregister");
+    fboY->release();
+    firstRun=false;
+    glPopMatrix();
+    widget->doneCurrent();
+}
+/**
     \fn surfaceToImage
 */
 bool   glRGB::surfaceToImage(VdpOutputSurface surf,ADMImage *image)
 {
+    bool r=true;
     widget->makeCurrent();
     glPushMatrix();
     // size is the last one...
@@ -308,7 +301,11 @@
     //
     GLvdpauSurfaceNV s=VDPAURegisterOutputSurfaceNV((GLvoid *)surf,GL_TEXTURE_2D,1,texName);
     printf("Surface =%d, GlSurface=%x, texName : %d\n",(int)surf,(int)s,(int)texName[0]);
-    processError("Register");
+    if(false==processError("Register"))
+    {
+            r=false;
+            goto skip;
+    }
     VDPAUSurfaceAccessNV(s,GL_READ_ONLY);
     VDPAUMapSurfacesNV(1,&s);
     processError("Map");
@@ -326,15 +323,69 @@
     processError("Unmap");
     VDPAUUnregisterSurfaceNV(s);
     processError("Unregister");
+skip:
     fboY->release();
     firstRun=false;
     glPopMatrix();
     widget->doneCurrent();
   
 
-    return true;
+    return r;
 }
+/**
+    \fn image2image
+*/
+bool glRGB::imageToImage(const char *buffer,ADMImage *image)
+{
+    bool r=true;
+    int width=image->GetWidth(PLANAR_Y);
+    int height=image->GetHeight(PLANAR_Y);
+    widget->makeCurrent();
+    glPushMatrix();
+    // size is the last one...
+    fboY->bind();
+    processError("Bind");
+    glProgramY->setUniformValue("myTextureY", (GLfloat)0); 
+    glProgramY->setUniformValue("myWidth", (GLfloat)width); 
+    glProgramY->setUniformValue("myHeight", (GLfloat)height); 
 
+    myGlActiveTexture(GL_TEXTURE0);
+    processError("Active Texture");
+    glBindTexture(GL_TEXTURE_RECTANGLE_NV, texName[0]); 
+    processError("Bind Texture");
 
+    // upload image
+        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
+        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
+        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+        glTexParameteri(GL_TEXTURE_RECTANGLE_NV, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
+        glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
+        if(!firstRun)
+        {
+            glTexImage2D(GL_TEXTURE_RECTANGLE_NV, 0, GL_RGBA, 
+                            width,
+                            height, 0, GL_RGBA, GL_UNSIGNED_BYTE, 
+                            buffer);
+        }else
+        {
+            glTexSubImage2D(GL_TEXTURE_RECTANGLE_NV, 0, 0, 0, 
+                width,
+                height,
+                GL_RGBA, GL_UNSIGNED_BYTE, 
+                buffer);
+        }
+    //-----------------
+    render(image,PLANAR_Y,fboY);
+    downloadTextures(image,fboY);
+
+    fboY->release();
+    firstRun=false;
+    glPopMatrix();
+    widget->doneCurrent();
+  
+
+    return r;
+}
+
 //****************
 // EOF



From mean at mail.berlios.de  Sun Aug 14 18:48:44 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Aug 2011 18:48:44 +0200
Subject: [Avidemux-svn-commit] r7411 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau
Message-ID: <20110814164844.B438B4815AB@sheep.berlios.de>

Author: mean
Date: 2011-08-14 18:48:44 +0200 (Sun, 14 Aug 2011)
New Revision: 7411

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp
Log:
[vdpau] Fix 1st frame processing, use itself as previous frame

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp	2011-08-14 16:48:42 UTC (rev 7410)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.cpp	2011-08-14 16:48:44 UTC (rev 7411)
@@ -514,6 +514,11 @@
                     vidCache->unlockAll();
                     return false;
             }
+            if(false==fillSlot(0,prev))
+            {
+                    vidCache->unlockAll();
+                    return false;
+            }
             
     }
     // regular image, in fact we get the next image here



From mean at mail.berlios.de  Sun Aug 14 18:48:45 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Aug 2011 18:48:45 +0200
Subject: [Avidemux-svn-commit] r7412 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau
Message-ID: <20110814164845.B52854815AB@sheep.berlios.de>

Author: mean
Date: 2011-08-14 18:48:45 +0200 (Sun, 14 Aug 2011)
New Revision: 7412

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
Log:
[vdpauGl] Use a matrix for RGB->yuv coeff

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h	2011-08-14 16:48:44 UTC (rev 7411)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeint.h	2011-08-14 16:48:45 UTC (rev 7412)
@@ -45,7 +45,7 @@
 public:
                              glRGB(ADM_coreVideoFilter *previous,CONFcouple *conf);
                             ~glRGB();
-
+                qreal        realMatrix[4*4];
         virtual const char   *getConfiguration(void) {return "none";};                   /// Return  current configuration as a human readable string
         virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
         virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 16:48:44 UTC (rev 7411)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 16:48:45 UTC (rev 7412)
@@ -56,19 +56,18 @@
 static const char *glShaderRgb =
 	"#extension GL_ARB_texture_rectangle: enable\n"
 	"uniform sampler2DRect myTextureY;\n" // tex unit 0
+    "uniform mat4 metrix;\n"
     "uniform float myWidth;\n"
     "uniform float myHeight;\n"
-    
+    "const vec4 offset=vec4(0,0.5,0.5,0);\n"
 	"void main(void) {\n"
     "  float nx = gl_TexCoord[0].x;\n"
 	"  float ny = gl_TexCoord[0].y;\n"
-	"  vec4 texvalY = texture2DRect(myTextureY, vec2(nx,ny));\n" 
-    "  float yy=0.299*texvalY.r+0.587*texvalY.g+0.114*texvalY.b;\n"
-    "  float zz=-0.14713*texvalY.r-0.2886*texvalY.g+0.436*texvalY.b;\n"
-    "  float tt=0.615*texvalY.r-0.51499*texvalY.g-0.1001*texvalY.b;\n"
-    "  zz=zz+0.5;\n"
-    "  tt=tt+0.5;\n"
-	"  gl_FragColor = vec4(yy,zz,tt,1);\n" //texvalU.r, texvalV.r, 1.0);\n"
+	"  vec4 texin = texture2DRect(myTextureY, vec2(nx,ny));\n" 
+    "  vec4 texout;\n"
+    "  texout=metrix*texin ;\n"
+    "  texout=texout+offset;\n"
+    "  gl_FragColor=texout;"
 	"}\n";
 
 //--------------------------------------------------------------------------------------
@@ -252,6 +251,20 @@
 
         fboY->release();
         widget->doneCurrent();
+        //
+        memset(realMatrix,0,sizeof(realMatrix));
+        realMatrix[0]=0.299;
+        realMatrix[1]=0.587;
+        realMatrix[2]=0.114;
+
+        realMatrix[4]=-0.14713;
+        realMatrix[5]=-0.2886;
+        realMatrix[6]=+0.436;
+
+        realMatrix[8]=+0.615;
+        realMatrix[9]=-0.51499;
+        realMatrix[10]=-0.1001;
+
 }
 /**
     \fn dtor
@@ -297,7 +310,8 @@
     glProgramY->setUniformValue("myTextureY", (GLfloat)0); 
     glProgramY->setUniformValue("myWidth", (GLfloat)image->GetWidth(PLANAR_Y)); 
     glProgramY->setUniformValue("myHeight", (GLfloat)image->GetHeight(PLANAR_Y)); 
-
+    QMatrix4x4 quadmat(realMatrix);
+    glProgramY->setUniformValue("metrix",quadmat);
     //
     GLvdpauSurfaceNV s=VDPAURegisterOutputSurfaceNV((GLvoid *)surf,GL_TEXTURE_2D,1,texName);
     printf("Surface =%d, GlSurface=%x, texName : %d\n",(int)surf,(int)s,(int)texName[0]);
@@ -348,6 +362,8 @@
     glProgramY->setUniformValue("myTextureY", (GLfloat)0); 
     glProgramY->setUniformValue("myWidth", (GLfloat)width); 
     glProgramY->setUniformValue("myHeight", (GLfloat)height); 
+    QMatrix4x4 quadmat(realMatrix);
+    glProgramY->setUniformValue("metrix",quadmat);
 
     myGlActiveTexture(GL_TEXTURE0);
     processError("Active Texture");



From mean at mail.berlios.de  Sun Aug 14 18:48:46 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Aug 2011 18:48:46 +0200
Subject: [Avidemux-svn-commit] r7413 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau
Message-ID: <20110814164846.EE0494815AB@sheep.berlios.de>

Author: mean
Date: 2011-08-14 18:48:46 +0200 (Sun, 14 Aug 2011)
New Revision: 7413

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
Log:
[vdpauGl] Do RGB2YUV through CPU if VDPAU2GL does not work

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 16:48:45 UTC (rev 7412)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 16:48:46 UTC (rev 7413)
@@ -258,12 +258,12 @@
         realMatrix[2]=0.114;
 
         realMatrix[4]=-0.14713;
-        realMatrix[5]=-0.2886;
+        realMatrix[5]=-0.28886;
         realMatrix[6]=+0.436;
 
         realMatrix[8]=+0.615;
         realMatrix[9]=-0.51499;
-        realMatrix[10]=-0.1001;
+        realMatrix[10]=-0.10001;
 
 }
 /**



From mean at mail.berlios.de  Sun Aug 14 18:48:48 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Aug 2011 18:48:48 +0200
Subject: [Avidemux-svn-commit] r7414 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau
Message-ID: <20110814164848.D1F9C4815AB@sheep.berlios.de>

Author: mean
Date: 2011-08-14 18:48:48 +0200 (Sun, 14 Aug 2011)
New Revision: 7414

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
Log:
[vdpauDeint/Gl] simplify

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 16:48:46 UTC (rev 7413)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glVdpau/ADM_vidVdpauFilterDeintGl.cpp	2011-08-14 16:48:48 UTC (rev 7414)
@@ -145,7 +145,7 @@
    initOnceGl();
    ADM_info("Creating VDPAU GL wrapper\n");
    rgb=new glRGB(this,NULL);
-   rgb->probe(outputSurface,NULL);
+   //rgb->probe(outputSurface,NULL);
    return true;
 }
 
@@ -304,14 +304,17 @@
     bool r=true;
     widget->makeCurrent();
     glPushMatrix();
-    // size is the last one...
     fboY->bind();
     processError("Bind");
-    glProgramY->setUniformValue("myTextureY", (GLfloat)0); 
-    glProgramY->setUniformValue("myWidth", (GLfloat)image->GetWidth(PLANAR_Y)); 
-    glProgramY->setUniformValue("myHeight", (GLfloat)image->GetHeight(PLANAR_Y)); 
+    glProgramY->setUniformValue("myTextureY", 0); 
+    processError("setUniform myTexture0");
     QMatrix4x4 quadmat(realMatrix);
     glProgramY->setUniformValue("metrix",quadmat);
+    processError("setUniform Matrix");
+    myGlActiveTexture(GL_TEXTURE0);
+    processError("Active Texture");
+    glBindTexture(GL_TEXTURE_RECTANGLE_NV, texName[0]); 
+    processError("Bind Texture");
     //
     GLvdpauSurfaceNV s=VDPAURegisterOutputSurfaceNV((GLvoid *)surf,GL_TEXTURE_2D,1,texName);
     printf("Surface =%d, GlSurface=%x, texName : %d\n",(int)surf,(int)s,(int)texName[0]);
@@ -326,7 +329,7 @@
 
     myGlActiveTexture(GL_TEXTURE0);
     processError("Active Texture");
-    glBindTexture(GL_TEXTURE_RECTANGLE_NV, texName[0]); 
+    glBindTexture(GL_TEXTURE_RECTANGLE_NV, texName[0]);  
     processError("Bind Texture");
 
 
@@ -359,12 +362,11 @@
     // size is the last one...
     fboY->bind();
     processError("Bind");
-    glProgramY->setUniformValue("myTextureY", (GLfloat)0); 
-    glProgramY->setUniformValue("myWidth", (GLfloat)width); 
-    glProgramY->setUniformValue("myHeight", (GLfloat)height); 
+    glProgramY->setUniformValue("myTextureY", 0); 
+    processError("setUniform myTexture0");
     QMatrix4x4 quadmat(realMatrix);
     glProgramY->setUniformValue("metrix",quadmat);
-
+    processError("setUniform Matrix");
     myGlActiveTexture(GL_TEXTURE0);
     processError("Active Texture");
     glBindTexture(GL_TEXTURE_RECTANGLE_NV, texName[0]); 



From mean at mail.berlios.de  Mon Aug 15 16:06:19 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Aug 2011 16:06:19 +0200
Subject: [Avidemux-svn-commit] r7415 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage:
	include src
Message-ID: <20110815140620.16FBE481298@sheep.berlios.de>

Author: mean
Date: 2011-08-15 16:06:19 +0200 (Mon, 15 Aug 2011)
New Revision: 7415

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_image.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp
Log:
[coreImage] Add yuv444 to yuv420 function to ADMImage

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_image.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_image.h	2011-08-14 16:48:48 UTC (rev 7414)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/include/ADM_image.h	2011-08-15 14:06:19 UTC (rev 7415)
@@ -164,6 +164,7 @@
         bool    printString(uint32_t x,uint32_t y, const char *strng);
 static  bool    copyPlane(ADMImage *s, ADMImage *d, ADM_PLANE plane);
 static  uint32_t lumaDiff(ADMImage *src1,ADMImage *src2,uint32_t noise);
+        bool    convertFromYUV444(uint8_t *from);
 };
 
 /**

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp	2011-08-14 16:48:48 UTC (rev 7414)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp	2011-08-15 14:06:19 UTC (rev 7415)
@@ -579,4 +579,48 @@
         BitBlit(dst,dPitch,src,sPitch,w,h);
         return true;
 }
+/**
+    \fn convertFromYUV444
+*/
+bool ADMImage::convertFromYUV444(uint8_t *from)
+{
+    int stride=this->GetPitch(PLANAR_Y);
+    int width=this->GetWidth(PLANAR_Y);
+    int height=this->GetHeight(PLANAR_Y);
+    uint8_t *dst=this->GetWritePtr(PLANAR_Y);
+    uint8_t *src=from+2;
+    for(int y=0;y<height;y++)
+    {
+        for(int x=0;x<width;x++)
+                dst[x]=src[4*x];
+        dst+=stride;
+        src+=4*width;
+    }
+    //
+    stride=this->GetPitch(PLANAR_U);
+    width=this->GetWidth(PLANAR_U);
+    height=this->GetHeight(PLANAR_U);
+    dst=this->GetWritePtr(PLANAR_U);
+    src=from+0;
+    for(int y=0;y<height;y++)
+    {
+        for(int x=0;x<width;x++)
+                dst[x]=src[8*x];
+        dst+=stride;
+        src+=4*width*2*2;
+    }
+    stride=this->GetPitch(PLANAR_V);
+    width=this->GetWidth(PLANAR_V);
+    height=this->GetHeight(PLANAR_V);
+    dst=this->GetWritePtr(PLANAR_V);
+    src=from+1;
+    for(int y=0;y<height;y++)
+    {
+        for(int x=0;x<width;x++)
+                dst[x]=src[8*x];
+        dst+=stride;
+        src+=16*width;
+    }
+    return true;
+}
 //EOF



From mean at mail.berlios.de  Mon Aug 15 16:06:21 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Aug 2011 16:06:21 +0200
Subject: [Avidemux-svn-commit] r7416 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau:
	include src
Message-ID: <20110815140621.4DCF6481298@sheep.berlios.de>

Author: mean
Date: 2011-08-15 16:06:21 +0200 (Mon, 15 Aug 2011)
New Revision: 7416

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpauInternal.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpauMixer.cpp
Log:
[coreVdpau] Add set/get attribute value, used to set color conversion matrix

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h	2011-08-15 14:06:19 UTC (rev 7415)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h	2011-08-15 14:06:21 UTC (rev 7416)
@@ -90,7 +90,16 @@
                                 VdpVideoSurface sourceSurface[3], // Past present future
                                 VdpOutputSurface targetOutputSurface,
                                 uint32_t targetWidth, uint32_t targetHeight );
+    static VdpStatus mixerGetAttributesValue(VdpVideoMixer mixer,
+                                uint32_t attrCount,
+                                const  VdpVideoMixerAttribute *xkeys,
+                                void * const* values);
+    static VdpStatus mixerSetAttributesValue(VdpVideoMixer mixer,
+                                uint32_t attrCount,
+                                const  VdpVideoMixerAttribute *xkeys,
+                                void * const* values);
 
+
 #endif
 };
 #endif
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpauInternal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpauInternal.h	2011-08-15 14:06:19 UTC (rev 7415)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpauInternal.h	2011-08-15 14:06:21 UTC (rev 7416)
@@ -54,6 +54,8 @@
     VdpVideoMixerSetFeatureEnables    *mixerEnableFeatures;
     VdpVideoMixerGetFeatureEnables    *mixerGetFeaturesEnabled;
     VdpVideoMixerQueryFeatureSupport  *mixerQueryFeatureSupported;
+    VdpVideoMixerGetAttributeValues   *mixerGetAttributesValue;
+    VdpVideoMixerSetAttributeValues   *mixerSetAttributesValue;
 
     VdpPresentationQueueTargetCreateX11 *presentationQueueDisplayX11Create;
 }VdpFunctions;

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp	2011-08-15 14:06:19 UTC (rev 7415)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp	2011-08-15 14:06:21 UTC (rev 7416)
@@ -115,7 +115,11 @@
     GetMe(mixerRender,VDP_FUNC_ID_VIDEO_MIXER_RENDER);
     GetMe(mixerEnableFeatures,VDP_FUNC_ID_VIDEO_MIXER_SET_FEATURE_ENABLES);
     GetMe(mixerQueryFeatureSupported,VDP_FUNC_ID_VIDEO_MIXER_QUERY_FEATURE_SUPPORT);
-    GetMe(mixerGetFeaturesEnabled,VDP_FUNC_ID_VIDEO_MIXER_GET_FEATURE_ENABLES)
+    GetMe(mixerGetFeaturesEnabled,VDP_FUNC_ID_VIDEO_MIXER_GET_FEATURE_ENABLES);
+
+    GetMe(mixerGetAttributesValue,VDP_FUNC_ID_VIDEO_MIXER_GET_ATTRIBUTE_VALUES);
+    GetMe(mixerSetAttributesValue,VDP_FUNC_ID_VIDEO_MIXER_SET_ATTRIBUTE_VALUES);
+
     if(VDP_STATUS_OK!=ADM_coreVdpau::funcs.presentationQueueDisplayX11Create(ADM_coreVdpau::vdpDevice,x->window,&queueX11))
     {
         ADM_warning("Cannot create X11 Presentation Queue\n");

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpauMixer.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpauMixer.cpp	2011-08-15 14:06:19 UTC (rev 7415)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpauMixer.cpp	2011-08-15 14:06:21 UTC (rev 7416)
@@ -141,8 +141,44 @@
     }
     return e;
 }
+/**
+    \fn mixerGetAttributesValue
+*/
 
+VdpStatus admVdpau::mixerGetAttributesValue(VdpVideoMixer mixer,
+                                uint32_t attrCount,
+                                const  VdpVideoMixerAttribute  *keys,
+                                  void * const *         values)
+{
+                
+    VdpStatus e=ADM_coreVdpau::funcs.mixerGetAttributesValue(mixer,attrCount,keys,values);
+    if(VDP_STATUS_OK!=e)
+    {
+        
+        ADM_warning("MixerGetAttributes  failed :%s\n",getErrorString(e));
+        
+    }
+    return e;
+}
 /**
+    \fn mixerSetAttributesValue
+*/
+VdpStatus admVdpau::mixerSetAttributesValue(VdpVideoMixer mixer,
+                                uint32_t attrCount,
+                                const  VdpVideoMixerAttribute *xkeys,
+                                void * const* values)
+{
+    VdpStatus e=ADM_coreVdpau::funcs.mixerSetAttributesValue(mixer,attrCount,xkeys,values);
+    if(VDP_STATUS_OK!=e)
+    {
+        
+        ADM_warning("MixerSetAttributes  failed :%s\n",getErrorString(e));
+        
+    }
+    return e;
+}
+
+/**
     \fn mixerRenderWithPastAndFuture
 */
 



From mean at mail.berlios.de  Mon Aug 15 16:06:22 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Aug 2011 16:06:22 +0200
Subject: [Avidemux-svn-commit] r7417 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/vdpauFilters
Message-ID: <20110815140622.9962D481298@sheep.berlios.de>

Author: mean
Date: 2011-08-15 16:06:22 +0200 (Mon, 15 Aug 2011)
New Revision: 7417

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/vdpauFilters/ADM_vidVdpauFilterDeint.cpp
Log:
[vdpauDeint] Use the identity matrix, fix first frame

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/vdpauFilters/ADM_vidVdpauFilterDeint.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/vdpauFilters/ADM_vidVdpauFilterDeint.cpp	2011-08-15 14:06:21 UTC (rev 7416)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/vdpauFilters/ADM_vidVdpauFilterDeint.cpp	2011-08-15 14:06:22 UTC (rev 7417)
@@ -108,6 +108,7 @@
                     bool                 fillSlot(int slot,ADMImage *image);
                     bool                 getResult(ADMImage *image);
                     bool                 sendField(bool topField);
+                    bool                 setIdentityCSC(void);
 
 public:
         virtual bool         goToTime(uint64_t usSeek); 
@@ -169,8 +170,24 @@
     clearSlots();
     return ADM_coreVideoFilter::goToTime(usSeek);
 }
-
 /**
+    \fn setIdentityCSC
+    \brief set the RGB/YUV matrix to identity so that data are still YUV at the end
+            Should not work, but it does.
+*/
+bool vdpauVideoFilterDeint::setIdentityCSC(void)
+{
+    ADM_info("Setting custom CSC\n");
+    const VdpCSCMatrix   matrix={{1.,0,0,0},{0,1.,0,0},{0,0,1.,0}};    
+    VdpVideoMixerAttribute attributes_key[]={VDP_VIDEO_MIXER_ATTRIBUTE_CSC_MATRIX};
+    const void * attribute_values[] = {&matrix};
+    
+    VdpStatus st = admVdpau::mixerSetAttributesValue(mixer, 1,attributes_key, (void * const *)attribute_values);
+    if(st!=VDP_STATUS_OK)
+        ADM_error("Cannot set custom matrix (CSC)\n");
+    return true;
+}
+/**
     \fn resetVdpau
 */
 bool vdpauVideoFilterDeint::setupVdpau(void)
@@ -218,7 +235,7 @@
     freeSurface.clear();
     for(int i=0;i<ADM_NB_SURFACES;i++)  
             freeSurface.push_back(surfacePool[i]);
-
+    setIdentityCSC();
     ADM_info("VDPAU setup ok\n");
     return true;
 badInit:
@@ -479,6 +496,8 @@
         in[i]=slots[i].surface;
         aprintf("Mixing %d %d\n",i,(int)in[i]);
     }
+    if(in[0]==VDP_INVALID_HANDLE)
+            in[0]=in[1];
     //
 
 #ifdef DO_BENCHMARK
@@ -516,12 +535,6 @@
 bool vdpauVideoFilterDeint::getResult(ADMImage *image)
 {
 
-#ifdef DO_BENCHMARK
-    ADMBenchmark bmark;
-    for(int i=0;i<NB_BENCH;i++)
-    {
-        bmark.start();
-#endif
   
     if(VDP_STATUS_OK!=admVdpau::outputSurfaceGetBitsNative(outputSurface,
                                                             tempBuffer, 
@@ -530,48 +543,7 @@
         ADM_warning("[Vdpau] Cannot copy back data from output surface\n");
         return false;
     }
-  
-                     
-#ifdef DO_BENCHMARK
-        bmark.end();
-    }
-    ADM_warning("Read surface Benchmark\n");
-    bmark.printResult();
-#endif 
-    // Convert from VDP_RGBA_FORMAT_B8G8R8A8 to YV12
-    uint32_t sourceStride[3]={info.width*4,0,0};
-    uint8_t  *sourceData[3]={tempBuffer,NULL,NULL};
-    uint32_t destStride[3];
-    uint8_t  *destData[3];
-
-    image->GetPitches(destStride);
-    image->GetWritePlanes(destData);
-
-    // Invert U&V
-    uint32_t ts;
-    uint8_t  *td;
-#if 0
-    ts=destStride[2];destStride[2]=destStride[1];destStride[1]=ts;
-    td=destData[1];destData[2]=destData[2];destData[1]=td;
-#endif
-
-
-#ifdef DO_BENCHMARK
-    ADMBenchmark bmark2;
-    for(int i=0;i<NB_BENCH;i++)
-    {
-        bmark2.start();
-#endif
-    scaler->convertPlanes(  sourceStride,destStride,     
-                            sourceData,destData);
-#ifdef DO_BENCHMARK
-        bmark2.end();
-    }
-    ADM_warning("RGB->YUV Benchmark\n");
-    bmark2.printResult();
-#endif
-
-    return true;
+    return image->convertFromYUV444(tempBuffer);
 }
 /**
     \fn getNextFrame



From mean at mail.berlios.de  Mon Aug 15 16:06:23 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Aug 2011 16:06:23 +0200
Subject: [Avidemux-svn-commit] r7418 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl
Message-ID: <20110815140623.BF16A481298@sheep.berlios.de>

Author: mean
Date: 2011-08-15 16:06:23 +0200 (Mon, 15 Aug 2011)
New Revision: 7418

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt
Log:
[glVdpau] Disable, using the CSC matrix is faster and simpler

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt	2011-08-15 14:06:22 UTC (rev 7417)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt	2011-08-15 14:06:23 UTC (rev 7418)
@@ -2,4 +2,4 @@
 ADD_SUBDIRECTORY(sample_fragment)
 ADD_SUBDIRECTORY(sample_fragment2)
 ADD_SUBDIRECTORY(sample_vertex)
-ADD_SUBDIRECTORY(glVdpau)
+#ADD_SUBDIRECTORY(glVdpau)



From mean at mail.berlios.de  Mon Aug 15 16:06:24 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Aug 2011 16:06:24 +0200
Subject: [Avidemux-svn-commit] r7419 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src
Message-ID: <20110815140624.E78B0481298@sheep.berlios.de>

Author: mean
Date: 2011-08-15 16:06:24 +0200 (Mon, 15 Aug 2011)
New Revision: 7419

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp
Log:
[CoreUtil] MMX YUV444 to yv12, part 1

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp	2011-08-15 14:06:23 UTC (rev 7418)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp	2011-08-15 14:06:24 UTC (rev 7419)
@@ -582,45 +582,174 @@
 /**
     \fn convertFromYUV444
 */
+static inline void yuv444_C(uint8_t *src,uint8_t *dst,int w,int h,int s)
+{
+    src+=2;
+    for(int y=0;y<h;y++)
+    {
+        for(int x=0;x<w;x++)
+                dst[x]=src[4*x];
+        dst+=s;
+        src+=4*w;
+    }
+}
+#ifdef ADM_CPU_X86
+static inline void yuv444_MMX(uint8_t *src,uint8_t *dst,int w,int h,int s)
+{
+static uint64_t FUNNY_MANGLE(mask);
+    mask=0x00ff000000ff0000LL;
+  //mask=0x0000ff000000ff00LL;
+    __asm__(" movq "Mangle(mask)", %%mm7\n" ::);
+    __asm__(" pxor %%mm6,%%mm6\n" ::);
+    
+    int step=w/8;
+    int left=w-8*step;
+    uint8_t *xsrc=src;
+    uint8_t *xdst=dst;
+
+    for(int y=0;y<h;y++)
+    {
+        xsrc=src;
+        xdst=dst;
+        for(int x=0;x<step;x++)
+        {
+                        __asm__(
+                        "movq           (%0),%%mm0 \n"
+                        "pand           %%mm7,%%mm0\n"
+                        "movq           8(%0),%%mm1 \n"
+                        "pand           %%mm7,%%mm1\n"
+
+                        "movq           16(%0),%%mm2 \n"
+                        "pand           %%mm7,%%mm2\n"
+                        "movq           24(%0),%%mm3 \n"
+                        "pand           %%mm7,%%mm3\n"
+
+                        "packuswb       %%mm1,%%mm0\n"
+                        "packuswb       %%mm3,%%mm2\n"
+                        "psrlw          $8,%%mm0\n"
+                        "psrlw          $8,%%mm2\n"
+                        "packuswb       %%mm2,%%mm0\n"
+
+                        "movq           %%mm0,(%1) \n"                       
+                        
+                        
+                        :: "r"(xsrc),"r"(xdst)
+                        );
+                        xsrc+=32;
+                        xdst+=8;
+            }
+        for(int i=0;i<left;i++)
+             xdst[i]=xsrc[4*i];
+        dst+=s;
+        src+=4*w;
+    }
+     __asm__( "emms\n"::  );
+
+}
+#endif
+#ifdef ADM_CPU_X86
+static inline void YUV444_chroma_MMX(uint8_t *src,uint8_t *dst,int w,int h,int s)
+{
+static uint64_t FUNNY_MANGLE(mask2);
+    mask2=0x000000FF000000FFLL;
+    __asm__(" movq "Mangle(mask2)", %%mm7\n" ::);
+    __asm__(" pxor %%mm6,%%mm6\n" ::);
+    int step=w/8;
+    int left=w-8*step;
+    uint8_t *xsrc=src;
+    uint8_t *xdst=dst;
+
+    for(int y=0;y<h;y++)
+    {
+        xsrc=src;
+        xdst=dst;
+        for(int x=0;x<step;x++)
+        {
+                        __asm__(
+                        "movq           (%0),%%mm0 \n"
+                        "movq           8(%0),%%mm1 \n"
+                        "movq           16(%0),%%mm2 \n"
+                        "movq           24(%0),%%mm3 \n"
+
+                        "pand           %%mm7,%%mm0\n"
+                        "pand           %%mm7,%%mm1\n"
+                        "pand           %%mm7,%%mm2\n"
+                        "pand           %%mm7,%%mm3\n"
+
+                        "packuswb       %%mm0,%%mm1\n"
+                        "packuswb       %%mm2,%%mm3\n"
+                        "packuswb       %%mm1,%%mm3\n"
+                        
+                        "movq           %%mm3,(%1) \n"                       
+                        :: "r"(xsrc),"r"(xdst)
+                        );
+                        xsrc+=64;
+                        xdst+=8;
+            }
+        for(int i=0;i<left;i++)
+             xdst[i]=xsrc[4*i];
+        dst+=s;
+        src+=4*w*4;
+    }
+     __asm__( "emms\n"::  );
+
+}
+#endif
+/**
+    \fn YUV444_chroma_C
+*/
+static inline void YUV444_chroma_C(uint8_t *src,uint8_t *dst,int w,int h,int s)
+{
+    for(int y=0;y<h;y++)
+    {
+        for(int x=0;x<w;x++)
+                dst[x]=src[8*x];
+        dst+=s;
+        src+=4*w*2*2;
+    }
+}
+
+
 bool ADMImage::convertFromYUV444(uint8_t *from)
 {
     int stride=this->GetPitch(PLANAR_Y);
     int width=this->GetWidth(PLANAR_Y);
     int height=this->GetHeight(PLANAR_Y);
     uint8_t *dst=this->GetWritePtr(PLANAR_Y);
-    uint8_t *src=from+2;
-    for(int y=0;y<height;y++)
-    {
-        for(int x=0;x<width;x++)
-                dst[x]=src[4*x];
-        dst+=stride;
-        src+=4*width;
-    }
+    uint8_t *src=from;
+
+    #ifdef ADM_CPU_X86
+        if(CpuCaps::hasMMX())
+            yuv444_MMX(src,dst,width,height,stride);            
+        else
+    #endif
+            yuv444_C(src,dst,width,height,stride);
+    
+
     //
     stride=this->GetPitch(PLANAR_U);
     width=this->GetWidth(PLANAR_U);
     height=this->GetHeight(PLANAR_U);
     dst=this->GetWritePtr(PLANAR_U);
     src=from+0;
-    for(int y=0;y<height;y++)
-    {
-        for(int x=0;x<width;x++)
-                dst[x]=src[8*x];
-        dst+=stride;
-        src+=4*width*2*2;
-    }
+    #ifdef ADM_CPU_X86
+        if( 0 && CpuCaps::hasMMX())
+            YUV444_chroma_MMX(src,dst,width,height,stride);            
+        else
+    #endif
+            YUV444_chroma_C(src,dst,width,height,stride);
+
     stride=this->GetPitch(PLANAR_V);
     width=this->GetWidth(PLANAR_V);
     height=this->GetHeight(PLANAR_V);
     dst=this->GetWritePtr(PLANAR_V);
     src=from+1;
-    for(int y=0;y<height;y++)
-    {
-        for(int x=0;x<width;x++)
-                dst[x]=src[8*x];
-        dst+=stride;
-        src+=16*width;
-    }
+    #ifdef ADM_CPU_X86
+        if( 0 &&CpuCaps::hasMMX())
+            YUV444_chroma_MMX(src,dst,width,height,stride);            
+        else
+    #endif
+            YUV444_chroma_C(src,dst,width,height,stride);
     return true;
 }
 //EOF



From mean at mail.berlios.de  Mon Aug 15 16:06:26 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Aug 2011 16:06:26 +0200
Subject: [Avidemux-svn-commit] r7420 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src
Message-ID: <20110815140626.1D8F0481298@sheep.berlios.de>

Author: mean
Date: 2011-08-15 16:06:25 +0200 (Mon, 15 Aug 2011)
New Revision: 7420

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp
Log:
[CoreUtil] MMX YUV444 to yv12, part 2

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp	2011-08-15 14:06:24 UTC (rev 7419)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp	2011-08-15 14:06:25 UTC (rev 7420)
@@ -654,8 +654,8 @@
     mask2=0x000000FF000000FFLL;
     __asm__(" movq "Mangle(mask2)", %%mm7\n" ::);
     __asm__(" pxor %%mm6,%%mm6\n" ::);
-    int step=w/8;
-    int left=w-8*step;
+    int step=w/4;
+    int left=w-4*step;
     uint8_t *xsrc=src;
     uint8_t *xdst=dst;
 
@@ -676,15 +676,15 @@
                         "pand           %%mm7,%%mm2\n"
                         "pand           %%mm7,%%mm3\n"
 
-                        "packuswb       %%mm0,%%mm1\n"
-                        "packuswb       %%mm2,%%mm3\n"
-                        "packuswb       %%mm1,%%mm3\n"
+                        "punpcklbw       %%mm1,%%mm0\n"
+                        "punpcklbw       %%mm3,%%mm2\n"
+                        "punpcklbw       %%mm2,%%mm0\n"
                         
-                        "movq           %%mm3,(%1) \n"                       
+                        "movd           %%mm0,(%1) \n"                       
                         :: "r"(xsrc),"r"(xdst)
                         );
-                        xsrc+=64;
-                        xdst+=8;
+                        xsrc+=32;
+                        xdst+=4;
             }
         for(int i=0;i<left;i++)
              xdst[i]=xsrc[4*i];
@@ -733,7 +733,7 @@
     dst=this->GetWritePtr(PLANAR_U);
     src=from+0;
     #ifdef ADM_CPU_X86
-        if( 0 && CpuCaps::hasMMX())
+        if(  CpuCaps::hasMMX())
             YUV444_chroma_MMX(src,dst,width,height,stride);            
         else
     #endif
@@ -745,7 +745,7 @@
     dst=this->GetWritePtr(PLANAR_V);
     src=from+1;
     #ifdef ADM_CPU_X86
-        if( 0 &&CpuCaps::hasMMX())
+        if( CpuCaps::hasMMX())
             YUV444_chroma_MMX(src,dst,width,height,stride);            
         else
     #endif



From mean at mail.berlios.de  Mon Aug 15 16:06:27 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Aug 2011 16:06:27 +0200
Subject: [Avidemux-svn-commit] r7421 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src
Message-ID: <20110815140627.3A791481298@sheep.berlios.de>

Author: mean
Date: 2011-08-15 16:06:27 +0200 (Mon, 15 Aug 2011)
New Revision: 7421

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp
Log:
[VDPAU yuv444] MMX part3

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp	2011-08-15 14:06:25 UTC (rev 7420)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp	2011-08-15 14:06:27 UTC (rev 7421)
@@ -648,21 +648,20 @@
 }
 #endif
 #ifdef ADM_CPU_X86
-static inline void YUV444_chroma_MMX(uint8_t *src,uint8_t *dst,int w,int h,int s)
+static inline void YUV444_chroma_MMX(uint8_t *src,uint8_t *dst,uint8_t *dst2,int w,int h,int s,int s2)
 {
-static uint64_t FUNNY_MANGLE(mask2);
-    mask2=0x000000FF000000FFLL;
-    __asm__(" movq "Mangle(mask2)", %%mm7\n" ::);
-    __asm__(" pxor %%mm6,%%mm6\n" ::);
     int step=w/4;
     int left=w-4*step;
     uint8_t *xsrc=src;
     uint8_t *xdst=dst;
+    uint8_t *xdst2=dst2;
+    
 
     for(int y=0;y<h;y++)
     {
         xsrc=src;
         xdst=dst;
+        xdst2=dst2;
         for(int x=0;x<step;x++)
         {
                         __asm__(
@@ -670,25 +669,42 @@
                         "movq           8(%0),%%mm1 \n"
                         "movq           16(%0),%%mm2 \n"
                         "movq           24(%0),%%mm3 \n"
+        
+                        "movq           %%mm0,%%mm4\n"
+                        "movq           %%mm1,%%mm5\n"
+                        "movq           %%mm2,%%mm6\n"
+                        "movq           %%mm3,%%mm7\n"
 
-                        "pand           %%mm7,%%mm0\n"
-                        "pand           %%mm7,%%mm1\n"
-                        "pand           %%mm7,%%mm2\n"
-                        "pand           %%mm7,%%mm3\n"
-
                         "punpcklbw       %%mm1,%%mm0\n"
                         "punpcklbw       %%mm3,%%mm2\n"
                         "punpcklbw       %%mm2,%%mm0\n"
                         
                         "movd           %%mm0,(%1) \n"                       
-                        :: "r"(xsrc),"r"(xdst)
+
+                        "psrlw          $8,%%mm4\n"
+                        "psrlw          $8,%%mm5\n"
+                        "psrlw          $8,%%mm6\n"
+                        "psrlw          $8,%%mm7\n"
+
+                        "punpcklbw       %%mm5,%%mm4\n"
+                        "punpcklbw       %%mm7,%%mm6\n"
+                        "punpcklbw       %%mm6,%%mm4\n"
+
+
+                        "movd           %%mm4,(%2) \n"                       
+                        :: "r"(xsrc),"r"(xdst),"r"(xdst2)
                         );
                         xsrc+=32;
                         xdst+=4;
+                        xdst2+=4;
             }
         for(int i=0;i<left;i++)
-             xdst[i]=xsrc[4*i];
+        {
+             xdst[i]=xsrc[8*i];
+             xdst2[i]=xsrc[8*i+1];
+        }
         dst+=s;
+        dst2+=s2;
         src+=4*w*4;
     }
      __asm__( "emms\n"::  );
@@ -731,25 +747,21 @@
     width=this->GetWidth(PLANAR_U);
     height=this->GetHeight(PLANAR_U);
     dst=this->GetWritePtr(PLANAR_U);
+    int stride2=this->GetPitch(PLANAR_V);
+    uint8_t * dst2=this->GetWritePtr(PLANAR_V);
     src=from+0;
     #ifdef ADM_CPU_X86
         if(  CpuCaps::hasMMX())
-            YUV444_chroma_MMX(src,dst,width,height,stride);            
+        {
+            YUV444_chroma_MMX(src,dst,dst2,width,height,stride,stride2); 
+        }
         else
     #endif
+        {
             YUV444_chroma_C(src,dst,width,height,stride);
+            YUV444_chroma_C(src+1,dst2,width,height,stride2);
+        }
 
-    stride=this->GetPitch(PLANAR_V);
-    width=this->GetWidth(PLANAR_V);
-    height=this->GetHeight(PLANAR_V);
-    dst=this->GetWritePtr(PLANAR_V);
-    src=from+1;
-    #ifdef ADM_CPU_X86
-        if( CpuCaps::hasMMX())
-            YUV444_chroma_MMX(src,dst,width,height,stride);            
-        else
-    #endif
-            YUV444_chroma_C(src,dst,width,height,stride);
     return true;
 }
 //EOF



From mean at mail.berlios.de  Mon Aug 15 16:06:28 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Aug 2011 16:06:28 +0200
Subject: [Avidemux-svn-commit] r7422 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui
Message-ID: <20110815140628.714D9481298@sheep.berlios.de>

Author: mean
Date: 2011-08-15 16:06:28 +0200 (Mon, 15 Aug 2011)
New Revision: 7422

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2GL.cpp
Log:
[QT/GL] Resize dummy GL widget

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2GL.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2GL.cpp	2011-08-15 14:06:27 UTC (rev 7421)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2GL.cpp	2011-08-15 14:06:28 UTC (rev 7422)
@@ -40,7 +40,9 @@
     ADM_info("Creating openGl dummy widget\n");
     topGlWidgetRoot=new dummyGLWidget(VuMeter);
     ADM_setGlWidget(topGlWidgetRoot);
-    topGlWidgetRoot->show();
+    topGlWidgetRoot->resize(4,4);
+    topGlWidgetRoot->show();
+    
 #ifndef QT_OPENGL_ES
     GlActiveTexture_Type *tex= (GlActiveTexture_Type *)topGlWidgetRoot->context()->getProcAddress(QLatin1String("glActiveTexture"));
 



From mean at mail.berlios.de  Mon Aug 15 16:06:30 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Aug 2011 16:06:30 +0200
Subject: [Avidemux-svn-commit] r7423 - in branches/avidemux_2.6_branch_mean:
	avidemux/qt4/ADM_UIs/include avidemux/qt4/ADM_UIs/src
	avidemux_plugins/ADM_videoFilters6_openGl/glSmooth
	avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment
	avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2
	avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex
Message-ID: <20110815140630.4C8B4481298@sheep.berlios.de>

Author: mean
Date: 2011-08-15 16:06:29 +0200 (Mon, 15 Aug 2011)
New Revision: 7423

Added:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/ADM_openGL.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment/sampleGl.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp
Log:
[GL] Simplify includes

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/ADM_openGL.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/ADM_openGL.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/include/ADM_openGL.h	2011-08-15 14:06:29 UTC (rev 7423)
@@ -0,0 +1,32 @@
+/***************************************************************************
+  \file T_openGL.h
+  \brief OpenGL related filters
+  \author (C) 2011 Mean Fixounet at free.fr 
+***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_OPENGL_H
+#define ADM_OPENGL_H
+#define GL_GLEXT_PROTOTYPES
+#ifdef __APPLE__
+#	include <OpenGL/gl.h>
+#	include <OpenGL/glext.h>
+#	define GL_TEXTURE_RECTANGLE_NV GL_TEXTURE_RECTANGLE_EXT
+#else
+#	include <GL/gl.h>
+#	include <GL/glext.h>
+#endif
+
+#include <QtGui/QImage>
+#include <QtOpenGL/QtOpenGL>
+#include <QtOpenGL/QGLShader>
+
+#endif
+

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-15 14:06:28 UTC (rev 7422)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-15 14:06:29 UTC (rev 7423)
@@ -194,16 +194,6 @@
             ADM_error("Can t get pointer to openGl texture\n");
             return false;
         }
-#if 0
-    printf("RGB");
-    const uchar *src2=src;
-    for(int i=0;i<10;i++)
-    {
-        printf("%d %d %d %d:",src2[i*4],src2[i*4+1],src2[i*4+2],src2[i*4+3]);
-        src2+=4;
-    }
-    printf("\n");
-#endif
         for(int x=0;x<width;x++)
         {
             toY[x]  = src[x*4+TEX_Y_OFFSET];

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.cpp	2011-08-15 14:06:28 UTC (rev 7422)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glSmooth/glSmooth.cpp	2011-08-15 14:06:29 UTC (rev 7423)
@@ -17,24 +17,7 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#define GL_GLEXT_PROTOTYPES
-
-#include <QtGui/QPainter>
-
-#ifdef __APPLE__
-#       include <OpenGL/gl.h>
-#       include <OpenGL/glext.h>
-#       define GL_TEXTURE_RECTANGLE_NV GL_TEXTURE_RECTANGLE_EXT
-#else
-#       include <GL/gl.h>
-#       include <GL/glext.h>
-#endif
-
-#include <QtGui/QImage>
-#include <QtOpenGL/QtOpenGL>
-#include <QtOpenGL/QGLShader>
-
-
+#include "ADM_openGL.h"
 #define ADM_LEGACY_PROGGY
 #include "ADM_default.h"
 #include "ADM_coreVideoFilterInternal.h"

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment/sampleGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment/sampleGl.cpp	2011-08-15 14:06:28 UTC (rev 7422)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment/sampleGl.cpp	2011-08-15 14:06:29 UTC (rev 7423)
@@ -22,24 +22,7 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#define GL_GLEXT_PROTOTYPES
-
-#include <QtGui/QPainter>
-
-#ifdef __APPLE__
-#       include <OpenGL/gl.h>
-#       include <OpenGL/glext.h>
-#       define GL_TEXTURE_RECTANGLE_NV GL_TEXTURE_RECTANGLE_EXT
-#else
-#       include <GL/gl.h>
-#       include <GL/glext.h>
-#endif
-
-#include <QtGui/QImage>
-#include <QtOpenGL/QtOpenGL>
-#include <QtOpenGL/QGLShader>
-
-
+#include "ADM_openGL.h"
 #define ADM_LEGACY_PROGGY
 #include "ADM_default.h"
 #include "ADM_coreVideoFilterInternal.h"

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp	2011-08-15 14:06:28 UTC (rev 7422)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp	2011-08-15 14:06:29 UTC (rev 7423)
@@ -22,24 +22,7 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#define GL_GLEXT_PROTOTYPES
-
-#include <QtGui/QPainter>
-
-#ifdef __APPLE__
-#       include <OpenGL/gl.h>
-#       include <OpenGL/glext.h>
-#       define GL_TEXTURE_RECTANGLE_NV GL_TEXTURE_RECTANGLE_EXT
-#else
-#       include <GL/gl.h>
-#       include <GL/glext.h>
-#endif
-
-#include <QtGui/QImage>
-#include <QtOpenGL/QtOpenGL>
-#include <QtOpenGL/QGLShader>
-
-
+#include "ADM_openGL.h"
 #define ADM_LEGACY_PROGGY
 #include "ADM_default.h"
 #include "ADM_coreVideoFilterInternal.h"

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp	2011-08-15 14:06:28 UTC (rev 7422)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_vertex/sampleGl.cpp	2011-08-15 14:06:29 UTC (rev 7423)
@@ -13,24 +13,7 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#define GL_GLEXT_PROTOTYPES
-
-#include <QtGui/QPainter>
-
-#ifdef __APPLE__
-#       include <OpenGL/gl.h>
-#       include <OpenGL/glext.h>
-#       define GL_TEXTURE_RECTANGLE_NV GL_TEXTURE_RECTANGLE_EXT
-#else
-#       include <GL/gl.h>
-#       include <GL/glext.h>
-#endif
-
-#include <QtGui/QImage>
-#include <QtOpenGL/QtOpenGL>
-#include <QtOpenGL/QGLShader>
-
-
+#include "ADM_openGL.h"
 #define ADM_LEGACY_PROGGY
 #include "ADM_default.h"
 #include "ADM_coreVideoFilterInternal.h"



From mean at mail.berlios.de  Mon Aug 15 16:06:31 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Aug 2011 16:06:31 +0200
Subject: [Avidemux-svn-commit] r7424 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src
Message-ID: <20110815140631.AC9C9481298@sheep.berlios.de>

Author: mean
Date: 2011-08-15 16:06:31 +0200 (Mon, 15 Aug 2011)
New Revision: 7424

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
Log:
[Gl/readback] MMX optimize reading processed texture

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-15 14:06:29 UTC (rev 7423)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-15 14:06:31 UTC (rev 7424)
@@ -169,7 +169,55 @@
 #endif
     return true;
 }
+typedef void typeGlYv444(const uint8_t *src,uint8_t *dst,const int width);
+#ifdef ADM_CPU_X86
+static inline void glYUV444_MMXInit(void)
+{
+   static uint64_t FUNNY_MANGLE(mask);
+    mask=0x00ff000000ff0000LL;
+  //mask=0x0000ff000000ff00LL;
+    __asm__(" movq "Mangle(mask)", %%mm7\n" ::);
+}
+static inline void glYUV444_MMX(const uint8_t *src, uint8_t *dst, const int width)
+{
+ 
+    int count=width/8;
+                    __asm__(
+                        "1:\n"
+                        "movq           (%0),%%mm0 \n"
+                        "pand           %%mm7,%%mm0\n"
+                        "movq           8(%0),%%mm1 \n"
+                        "pand           %%mm7,%%mm1\n"
 
+                        "movq           16(%0),%%mm2 \n"
+                        "pand           %%mm7,%%mm2\n"
+                        "movq           24(%0),%%mm3 \n"
+                        "pand           %%mm7,%%mm3\n"
+
+                        "packuswb       %%mm1,%%mm0\n"
+                        "packuswb       %%mm3,%%mm2\n"
+                        "psrlw          $8,%%mm0\n"
+                        "psrlw          $8,%%mm2\n"
+                        "packuswb       %%mm2,%%mm0\n"
+
+                        "movq           %%mm0,(%1)  \n"  
+                        "add            $32,%0      \n"
+                        "add            $8,%1       \n"
+                        "sub            $1,%2        \n"
+                        "jnz             1b         \n"
+                        
+                        :: "r"(src),"r"(dst),"r"(count)
+                        );
+}
+#endif
+static inline void glYUV444_C(const uint8_t *src, uint8_t *dst, const int width)
+{
+       for(int x=0;x<width;x++)
+        {
+            dst[x]  = src[x*4+TEX_Y_OFFSET];
+        }
+}
+
 /**
     \fn downloadTexture
     \brief Download YUVA texture into a YV12 image
@@ -181,57 +229,57 @@
     // Assume RGB32, read R or A
     int strideY=image->GetPitch(PLANAR_Y);
     uint8_t *toY=image->GetWritePtr(PLANAR_Y);
-    
-    int width=image->GetWidth(PLANAR_Y);
-    int height=image->GetHeight(PLANAR_Y);
-
-    // Do Y
-    for(int y=1;y<=height;y++)
-    {
-        const uchar *src=qimg.constScanLine(height-y);
-        if(!src)
-        {
-            ADM_error("Can t get pointer to openGl texture\n");
-            return false;
-        }
-        for(int x=0;x<width;x++)
-        {
-            toY[x]  = src[x*4+TEX_Y_OFFSET];
-            
-        }
-        toY+=strideY;
-    }
-    // do U & V
     uint8_t *toU=image->GetWritePtr(PLANAR_U);
     uint8_t *toV=image->GetWritePtr(PLANAR_V);
     int      strideU=image->GetPitch(PLANAR_U);
     int      strideV=image->GetPitch(PLANAR_V);
 
-    for(int y=1;y<=height;y+=2)
+    int width=image->GetWidth(PLANAR_Y);
+    int height=image->GetHeight(PLANAR_Y);
+    typeGlYv444 *luma=glYUV444_C;
+#ifdef ADM_CPU_X86
+      if(CpuCaps::hasMMX())
+      {
+            glYUV444_MMXInit();
+            luma=glYUV444_MMX;
+      }
+#endif
+    // Do Y
+    for(int y=1;y<=height;y++)
     {
         const uchar *src=qimg.constScanLine(height-y);
+        
+        
         if(!src)
         {
             ADM_error("Can t get pointer to openGl texture\n");
             return false;
         }
-        for(int x=0;x<width;x+=2) // Stupid subsample: 1 out of 4
-        {
-            const uchar *p=src+x*4;
-            uint32_t v=*(uint32_t *)p;
-            if(!v)
+       luma(src,toY,width);
+       toY+=strideY;
+       if(y&1)
+       {
+            for(int x=0;x<width;x+=2) // Stupid subsample: 1 out of 4
             {
-                    toU[x/2]=128;
-                    toV[x/2]=128;
-            }else
-            {
-                toU[x/2]  =  p[TEX_U_OFFSET];
-                toV[x/2]  =  p[TEX_V_OFFSET];
+                const uchar *p=src+x*4;
+                uint32_t v=*(uint32_t *)p;
+                if(!v)
+                {
+                        toU[x/2]=128;
+                        toV[x/2]=128;
+                }else
+                {
+                    toU[x/2]  =  p[TEX_U_OFFSET];
+                    toV[x/2]  =  p[TEX_V_OFFSET];
+                }
             }
-        }
-        toU+=strideU;
-        toV+=strideV;
+            toU+=strideU;
+            toV+=strideV;
+       }
     }
+#ifdef ADM_CPU_X86
+    __asm__( "emms\n"::  );
+#endif
     return true;
 }
 /**



From mean at mail.berlios.de  Mon Aug 15 16:06:32 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Aug 2011 16:06:32 +0200
Subject: [Avidemux-svn-commit] r7425 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src
Message-ID: <20110815140632.DB14E481298@sheep.berlios.de>

Author: mean
Date: 2011-08-15 16:06:32 +0200 (Mon, 15 Aug 2011)
New Revision: 7425

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
Log:
[QT/GL] Simplify read back

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-15 14:06:31 UTC (rev 7424)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/T_openGL.cpp	2011-08-15 14:06:32 UTC (rev 7425)
@@ -208,6 +208,11 @@
                         
                         :: "r"(src),"r"(dst),"r"(count)
                         );
+    if(width&7)
+    {
+        for(int i=count*8;i<width;i++)
+            dst[i]  = src[i*4+TEX_Y_OFFSET];
+    }
 }
 #endif
 static inline void glYUV444_C(const uint8_t *src, uint8_t *dst, const int width)



From mean at mail.berlios.de  Wed Aug 17 07:50:29 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Wed, 17 Aug 2011 07:50:29 +0200
Subject: [Avidemux-svn-commit] r7426 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264
Message-ID: <20110817055030.13540481301@sheep.berlios.de>

Author: mean
Date: 2011-08-17 07:50:29 +0200 (Wed, 17 Aug 2011)
New Revision: 7426

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/ADM_x264.cpp
Log:
[x264] Make it verbose

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/ADM_x264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/ADM_x264.cpp	2011-08-15 14:06:32 UTC (rev 7425)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/ADM_x264.cpp	2011-08-17 05:50:29 UTC (rev 7426)
@@ -217,7 +217,7 @@
         //return false;
     }else
     {
-        aprintf("x264 Incoming : %"LLU"us \n",image->Pts);    
+        printf("[PPPP] x264 Incoming : %"LLU"us \n",image->Pts);    
         // 2-preamble   
         if(false==preAmble(image))
         {
@@ -366,6 +366,7 @@
           ADM_error ("[x264] Unknown image type: %d\n", picout->i_type);
           //ADM_assert(0);
         }
+        printf("[OOOO] x264 Outgoing : %"LLU"us \n",out->dts);    
         out->out_quantizer = picout->i_qpplus1;
         return true;
 }



From mean at mail.berlios.de  Thu Aug 18 07:49:46 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 18 Aug 2011 07:49:46 +0200
Subject: [Avidemux-svn-commit] r7427 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264
Message-ID: <20110818054946.DED424813B7@sheep.berlios.de>

Author: mean
Date: 2011-08-18 07:49:46 +0200 (Thu, 18 Aug 2011)
New Revision: 7427

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/ADM_x264.cpp
Log:
[x264] Revert verbose patch

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/ADM_x264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/ADM_x264.cpp	2011-08-17 05:50:29 UTC (rev 7426)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoEncoder/x264/ADM_x264.cpp	2011-08-18 05:49:46 UTC (rev 7427)
@@ -217,7 +217,7 @@
         //return false;
     }else
     {
-        printf("[PPPP] x264 Incoming : %"LLU"us \n",image->Pts);    
+        //printf("[PPPP] x264 Incoming : %"LLU"us \n",image->Pts);    
         // 2-preamble   
         if(false==preAmble(image))
         {
@@ -366,7 +366,7 @@
           ADM_error ("[x264] Unknown image type: %d\n", picout->i_type);
           //ADM_assert(0);
         }
-        printf("[OOOO] x264 Outgoing : %"LLU"us \n",out->dts);    
+        //printf("[OOOO] x264 Outgoing : %"LLU"us \n",out->dts);    
         out->out_quantizer = picout->i_qpplus1;
         return true;
 }



From gruntster at mail.berlios.de  Thu Aug 18 19:29:32 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Thu, 18 Aug 2011 19:29:32 +0200
Subject: [Avidemux-svn-commit] r7428 - in
	branches/avidemux_2.5_branch_gruntster: avidemux/ADM_libraries cmake
Message-ID: <20110818172932.79953481287@sheep.berlios.de>

Author: gruntster
Date: 2011-08-18 19:29:31 +0200 (Thu, 18 Aug 2011)
New Revision: 7428

Added:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.2.tar.bz2
Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.1.tar.bz2
Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
Log:
[ffmpeg] upgrade ffmpeg to 0.8.2

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.1.tar.bz2
===================================================================
(Binary files differ)

Copied: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.2.tar.bz2 (from rev 7388, branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg-0.8.1.tar.bz2)
===================================================================
(Binary files differ)

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2011-08-18 05:49:46 UTC (rev 7427)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2011-08-18 17:29:31 UTC (rev 7428)
@@ -1,6 +1,6 @@
 include(admFFmpegUtil)
 
-set(FFMPEG_VERSION 0.8.1)
+set(FFMPEG_VERSION 0.8.2)
 set(FFMPEG_SOURCE_ARCHIVE "ffmpeg-${FFMPEG_VERSION}.tar.bz2")
 set(FFMPEG_SOURCE_ARCHIVE_DIR "ffmpeg-${FFMPEG_VERSION}")
 



From gruntster at mail.berlios.de  Fri Aug 19 20:57:54 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Fri, 19 Aug 2011 20:57:54 +0200
Subject: [Avidemux-svn-commit] r7429 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src
Message-ID: <20110819185754.5FB234812FF@sheep.berlios.de>

Author: gruntster
Date: 2011-08-19 20:57:53 +0200 (Fri, 19 Aug 2011)
New Revision: 7429

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_win32.cpp
Log:
[mswin] apply r5665 & r7292

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_win32.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_win32.cpp	2011-08-18 17:29:31 UTC (rev 7428)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_win32.cpp	2011-08-19 18:57:53 UTC (rev 7429)
@@ -1,504 +1,511 @@
-#ifdef __WIN32
-#include <stdio.h>
-#include <stdlib.h>
-#include <windows.h>
-
-#ifdef __MINGW32__
-#include <winsock2.h>
-#endif
-
-#include "ADM_default.h" 
-
-extern char *ADM_getBaseDir(void);
-
-void ADM_usleep(unsigned long us)
-{
-	Sleep(us/1000);
-}
-
-#ifdef __MINGW32__
-uint8_t win32_netInit(void)
-{
-	WSADATA wsaData;
-	int iResult;
-
-	printf("Initializing WinSock\n");
-	iResult = WSAStartup(MAKEWORD(2,2), &wsaData);
-
-	if (iResult != NO_ERROR)
-	{
-		printf("Error at WSAStartup()\n");
-		return 0;
-	}	
-
-	printf("WinSock ok\n");
-	return 1;
-}
-#endif
-
-#ifndef HAVE_GETTIMEOFDAY
-extern "C"
-{
-void gettimeofday(struct timeval *p, void *tz);
-}
-
-void gettimeofday(struct timeval *p, void *tz)
-{
-    unsigned long int sec;
-    SYSTEMTIME  tme;
-
-    GetSystemTime(&tme);
-
-    sec=tme.wSecond;
-    sec+=60*tme.wMinute;
-    sec+=60*60*tme.wHour;
-    
-	p->tv_sec=sec;
-	p->tv_usec=tme.wMilliseconds*1000;
-
-	return;
-}
-#endif	// HAVE_GETTIMEOFDAY
-
-int getpriority(int which, int who)
-{
-	unsigned int priorityClass;
-
-	ADM_assert(which == PRIO_PROCESS);
-	ADM_assert(who == 0);
-
-	priorityClass = GetPriorityClass(GetCurrentProcess());
-
-	switch (priorityClass)
-	{
-		case HIGH_PRIORITY_CLASS:
-			return -18;
-			break;
-		case ABOVE_NORMAL_PRIORITY_CLASS:
-			return -10;
-			break;
-		case NORMAL_PRIORITY_CLASS:
-			return 0;
-			break;
-		case BELOW_NORMAL_PRIORITY_CLASS:
-			return 10;
-			break;
-		case IDLE_PRIORITY_CLASS:
-			return 18;
-			break;
-		default:
-			ADM_assert(0);
-	}
-}
-
-int setpriority(int which, int who, int value)
-{
-	unsigned int priorityClass;
-
-	ADM_assert(which == PRIO_PROCESS);
-	ADM_assert(who == 0);
-	ADM_assert(value >= PRIO_MIN && value <= PRIO_MAX);
-
-	if (value >= -20 && value <= -16)
-	{
-		priorityClass = HIGH_PRIORITY_CLASS;
-	}
-	else if (value >= -15 && value <= -6)
-	{
-		priorityClass = ABOVE_NORMAL_PRIORITY_CLASS;
-	}
-	else if (value >= -5 && value <= 4)
-	{
-		priorityClass = NORMAL_PRIORITY_CLASS;
-	}
-	else if (value >= 6 && value <= 15)
-	{
-		priorityClass = BELOW_NORMAL_PRIORITY_CLASS;
-	}
-	else if (value >= 16 && value <= 20)
-	{
-		priorityClass = IDLE_PRIORITY_CLASS;
-	}
-
-	if (!SetPriorityClass(GetCurrentProcess(), priorityClass))
-	{
-		return -1;
-	}
-
-	return 0;
-}
-
-int shutdown_win32(void)
-{
-	HANDLE hToken;
-	TOKEN_PRIVILEGES tkp;
-
-	// Get a token for this process. 
-	if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken))
-	{
-		return -1;
-	}
-
-	// Get the LUID for the shutdown privilege.
-	LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME, &tkp.Privileges[0].Luid);
-
-	tkp.PrivilegeCount = 1;  // one privilege to set
-	tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
-
-	// Get the shutdown privilege for this process.
-	AdjustTokenPrivileges(hToken, FALSE, &tkp, 0, (PTOKEN_PRIVILEGES)NULL, 0);
-
-	if (GetLastError() != ERROR_SUCCESS)
-	{
-		return -1;
-	}
-
-	// Shut down the system and force all applications to close.
-	if (!ExitWindowsEx(EWX_POWEROFF | EWX_FORCE, SHTDN_REASON_FLAG_PLANNED))
-	{
-		return -1;
-	}
-
-	return 0;
-}
-
-#ifndef PRODUCT_BUSINESS
-#define PRODUCT_BUSINESS 0x00000006
-#endif
-
-#ifndef PRODUCT_BUSINESS_N
-#define PRODUCT_BUSINESS_N 0x00000010
-#endif
-
-#ifndef PRODUCT_HOME_BASIC
-#define PRODUCT_HOME_BASIC 0x00000002
-#endif
-
-#ifndef PRODUCT_HOME_BASIC_N
-#define PRODUCT_HOME_BASIC_N 0x00000005
-#endif
-
-#ifndef PRODUCT_HOME_PREMIUM
-#define PRODUCT_HOME_PREMIUM 0x00000003
-#endif 
-
-#ifndef PRODUCT_STARTER
-#define PRODUCT_STARTER 0x0000000B
-#endif
-
-#ifndef PRODUCT_ENTERPRISE
-#define PRODUCT_ENTERPRISE 0x00000004
-#endif 
-
-#ifndef PRODUCT_ULTIMATE
-#define PRODUCT_ULTIMATE 0x00000001
-#endif
-
-bool getWindowsVersion(char* version)
-{
-	int index = 0;
-	OSVERSIONINFOEX osvi = {};
-
-	osvi.dwOSVersionInfoSize = sizeof(OSVERSIONINFOEX);
-
-	if (!GetVersionEx((OSVERSIONINFO*)&osvi))
-		return false;
-
-	if (osvi.dwPlatformId != VER_PLATFORM_WIN32_NT)
-		return false;
-// Vista
-	if (osvi.dwMajorVersion == 6 && osvi.dwMinorVersion == 0)
-	{
-		if (osvi.wProductType == VER_NT_WORKSTATION)
-		{
-			index += sprintf(version + index, "Microsoft Windows Vista");
-
-			uint32_t productType = 0;
-
-			HMODULE hKernel = GetModuleHandle("KERNEL32.DLL");
-
-			if (hKernel)
-			{
-				typedef bool (__stdcall *funcGetProductInfo)(uint32_t, uint32_t, uint32_t, uint32_t, uint32_t*);
-				funcGetProductInfo pGetProductInfo = (funcGetProductInfo)GetProcAddress(hKernel, "GetProductInfo"); 
-
-				if (pGetProductInfo)
-					pGetProductInfo(6, 0, 0, 0, &productType);
-	  
-				switch (productType)
-				{
-				case PRODUCT_STARTER:
-				{
-					index += sprintf(version + index, " Starter");
-					break;
-				}
-				case PRODUCT_HOME_BASIC_N:
-				{
-					index += sprintf(version + index, " Home Basic N");
-					break;
-				}
-				case PRODUCT_HOME_BASIC:
-				{
-					index += sprintf(version + index, " Home Basic");
-					break;
-				}
-				case PRODUCT_HOME_PREMIUM:
-				{
-					index += sprintf(version + index, " Home Premium");
-					break;
-				}
-				case PRODUCT_BUSINESS_N:
-				{
-					index += sprintf(version + index, " Business N");
-					break;
-				}
-				case PRODUCT_BUSINESS:
-				{
-					index += sprintf(version + index, " Business");
-					break;
-				}
-				case PRODUCT_ENTERPRISE:
-				{
-					index += sprintf(version + index, " Enterprise");
-					break;
-				}
-				case PRODUCT_ULTIMATE:
-				{
-					index += sprintf(version + index, " Ultimate");
-					break;
-				}
-				default:
-					break;
-				}
-			}
-		}
-		else if (osvi.wProductType == VER_NT_SERVER)
-		{
-			index += sprintf(version + index, "Microsoft Windows Server 2008");
-
-			if (osvi.wSuiteMask & VER_SUITE_DATACENTER)
-				index += sprintf(version + index, " Datacenter Edition");
-			else if (osvi.wSuiteMask & VER_SUITE_ENTERPRISE)
-				index += sprintf(version + index, " Enterprise Edition");
-			else if (osvi.wSuiteMask == VER_SUITE_BLADE)
-				index += sprintf(version + index, " Web Edition");
-			else
-				index += sprintf(version + index, " Standard Edition");
-		}
-	}
-// Windows Server 2003
-	else if (osvi.dwMajorVersion == 5 && osvi.dwMinorVersion == 2)
-	{
-		index += sprintf(version + index, "Microsoft Windows Server 2003");
-
-		if (GetSystemMetrics(SM_SERVERR2))
-			index += sprintf(version + index, " R2");
-
-		if (osvi.wSuiteMask & VER_SUITE_DATACENTER)
-			index += sprintf(version + index, " Datacenter Edition");
-		else if (osvi.wSuiteMask & VER_SUITE_ENTERPRISE)
-			index += sprintf(version + index, " Enterprise Edition");
-		else if (osvi.wSuiteMask == VER_SUITE_BLADE)
-			index += sprintf(version + index, " Web Edition");
-		else
-			index += sprintf(version + index, " Standard Edition");
-	}
-// Windows XP
-	else if (osvi.dwMajorVersion == 5 && osvi.dwMinorVersion == 1)
-	{
-		index += sprintf(version + index, "Microsoft Windows XP");
-
-		if (GetSystemMetrics(SM_MEDIACENTER))
-			index += sprintf(version + index, " Media Center Edition");
-		else if (GetSystemMetrics(SM_STARTER))
-			index += sprintf(version + index, " Starter Edition");
-		else if (GetSystemMetrics(SM_TABLETPC))
-			index += sprintf(version + index, " Tablet PC Edition");
-		else if (osvi.wSuiteMask & VER_SUITE_PERSONAL)
-			index += sprintf(version + index, " Home Edition");
-		else
-			index += sprintf(version + index, " Professional");
-	}
-// Windows 2000
-	else if (osvi.dwMajorVersion == 5 && osvi.dwMinorVersion == 0)
-	{
-		index += sprintf(version + index, "Microsoft Windows 2000");
-
-		if (osvi.wProductType == VER_NT_WORKSTATION)
-		{
-			index += sprintf(version + index, " Professional");
-		}
-		else if (osvi.wProductType == VER_NT_SERVER)
-		{
-			if (osvi.wSuiteMask & VER_SUITE_DATACENTER)
-				index += sprintf(version + index, " Datacenter Server");
-			else if (osvi.wSuiteMask & VER_SUITE_ENTERPRISE)
-				index += sprintf(version + index, " Advanced Server");
-			else
-				index += sprintf(version + index, " Server");
-		}
-	}
-// Windows NT 4
-	else if (osvi.dwMajorVersion == 4)
-	{
-		index += sprintf(version + index, "Microsoft Windows NT 4");
-
-		if (osvi.wProductType == VER_NT_WORKSTATION)
-		{
-			index += sprintf(version + index, " Workstation");
-		}
-		else if (osvi.wProductType == VER_NT_SERVER)
-		{
-			if (osvi.wSuiteMask & VER_SUITE_ENTERPRISE)
-				index += sprintf(version + index, " Server, Enterprise Edition");
-			else
-				index += sprintf(version + index, " Server");
-		}
-	}
-	else
-	{
-		index += sprintf(version + index, "Microsoft Windows");
-	}
-
-// Service pack and full version info
-	if (strlen(osvi.szCSDVersion) > 0)
-	{
-		index += sprintf(version + index, " %s", osvi.szCSDVersion);
-	}
-
-	index += sprintf(version + index, " (%d.%d.%d", osvi.dwMajorVersion, osvi.dwMinorVersion, osvi.dwBuildNumber & 0xFFFF);
-
-// 64-bit Windows
-#ifdef __WIN64
-	index += sprintf(version + index, "; 64-bit");
-#else
-	bool isWow64 = false;
-	HMODULE hKernel = GetModuleHandle("kernel32.dll");
-
-	if (hKernel)
-	{
-		typedef bool (*funcIsWow64Process)(void*, bool*);  
-
-	    funcIsWow64Process pIsWow64Process = (funcIsWow64Process)GetProcAddress(hKernel, "IsWow64Process"); 
-
-	    if (pIsWow64Process)
-	    {
-			pIsWow64Process(GetCurrentProcess(), &isWow64);
-		}
-	}
-
-	if (isWow64)
-		index += sprintf(version + index, "; 64-bit");
-	else
-		index += sprintf(version + index, "; 32-bit");
-#endif
-	index += sprintf(version + index, ")");
-	
-	return true;
-}
-
-void redirectStdoutToFile(void)
-{
-	// Don't redirect stdout and stderr if SDL hasn't already hijacked it.
-	// This allows us to optionally compile all EXEs as console applications
-	// so the output can be printed to the terminal for debugging purposes.
-
- 	// Close SDL generated logs and briefly redirect to NUL
- 	freopen("NUL", "w", stdout);
- 	freopen("NUL", "w", stderr);
-
-	// Remove SDL logs to avoid confusion
-	char path[MAX_PATH];
-	char stdoutPath[MAX_PATH];
-	char stderrPath[MAX_PATH];
-	DWORD pathlen = GetModuleFileName(NULL, path, MAX_PATH);
-
-	while (pathlen > 0 && path[pathlen] != '\\')
-		pathlen--;
-
-	path[pathlen] = '\0';
-
-	strcpy(stdoutPath, path);
-	strcat(stdoutPath, "\\stdout.txt");
-	strcpy(stderrPath, path);
-	strcat(stderrPath, "\\stderr.txt");
-
-	remove(stdoutPath);
-	remove(stderrPath);
-
-	// Redirect output to log file in the user's profile directory
-	const char* logFile = "admlog.txt";
-	char* baseDir = ADM_getBaseDir();
-	char *logPath = new char[strlen(baseDir) + 2 + strlen(logFile)];
-
-	strcpy(logPath, baseDir);
-	strcat(logPath, "/");
-	strcat(logPath, logFile);
-
-	FILE *stream = fopen(logPath, "w");
-
-	if (stream)
-	{
-		fclose(stdout);
-		fclose(stderr);
-
-		*stdout = *stream;
-		*stderr = *stream;
-	}
-
-	// Line buffering
-	setvbuf(stdout, NULL, _IONBF, BUFSIZ); 
-	setvbuf(stderr, NULL, _IONBF, BUFSIZ);
-
-	delete[] logPath;
-}
-
-// Convert string from ANSI code page to wide char
-int ansiStringToWideChar(const char *ansiString, int ansiStringLength, wchar_t *wideCharString)
-{
-	int wideCharStringLen = MultiByteToWideChar(CP_ACP, 0, ansiString, ansiStringLength, NULL, 0);
-
-	if (wideCharString)
-		MultiByteToWideChar(CP_ACP, 0, ansiString, ansiStringLength, wideCharString, wideCharStringLen);
-
-	return wideCharStringLen;
-}
-
-// Convert UTF-8 string to wide char
-int utf8StringToWideChar(const char *utf8String, int utf8StringLength, wchar_t *wideCharString)
-{
-	int wideCharStringLength = MultiByteToWideChar(CP_UTF8, 0, utf8String, utf8StringLength, NULL, 0);
-
-	if (wideCharString)
-		MultiByteToWideChar(CP_UTF8, 0, utf8String, utf8StringLength, wideCharString, wideCharStringLength);
-
-	return wideCharStringLength;
-}
-
-// Convert Wide Char string to UTF-8
-int wideCharStringToUtf8(const wchar_t *wideCharString, int wideCharStringLength, char *utf8String)
-{
-	int utf8StringLen = WideCharToMultiByte(CP_UTF8, 0, wideCharString, wideCharStringLength, NULL, 0, NULL, NULL);
-
-	if (utf8String)
-		WideCharToMultiByte(CP_UTF8, 0, wideCharString, wideCharStringLength, utf8String, utf8StringLen, NULL, NULL);
-
-	return utf8StringLen;
-}
-
-// Convert string from ANSI code page to UTF-8
-int ansiStringToUtf8(const char *ansiString, int ansiStringLength, char *utf8String)
-{
-	int wideCharStringLen = ansiStringToWideChar(ansiString, ansiStringLength, NULL);
-	wchar_t wideCharString[wideCharStringLen];
-
-	ansiStringToWideChar(ansiString, ansiStringLength, wideCharString);
-
-	int multiByteStringLen = wideCharStringToUtf8(wideCharString, wideCharStringLen, NULL);
-
-	if (utf8String)
-		wideCharStringToUtf8(wideCharString, wideCharStringLen, utf8String);
-
-	return multiByteStringLen;
-}
-#endif	// __WIN32
+#ifdef __WIN32
+#include <stdio.h>
+#include <stdlib.h>
+#include <windows.h>
+
+#ifdef __MINGW32__
+#include <winsock2.h>
+#endif
+
+#include "ADM_default.h" 
+
+extern char *ADM_getBaseDir(void);
+
+void ADM_usleep(unsigned long us)
+{
+	Sleep(us/1000);
+}
+
+#ifdef __MINGW32__
+uint8_t win32_netInit(void)
+{
+	WSADATA wsaData;
+	int iResult;
+
+	printf("Initializing WinSock\n");
+	iResult = WSAStartup(MAKEWORD(2,2), &wsaData);
+
+	if (iResult != NO_ERROR)
+	{
+		printf("Error at WSAStartup()\n");
+		return 0;
+	}	
+
+	printf("WinSock ok\n");
+	return 1;
+}
+#endif
+
+#ifndef HAVE_GETTIMEOFDAY
+extern "C"
+{
+void gettimeofday(struct timeval *p, void *tz);
+}
+
+void gettimeofday(struct timeval *p, void *tz)
+{
+    unsigned long int sec;
+    SYSTEMTIME  tme;
+
+    GetSystemTime(&tme);
+
+    sec=tme.wSecond;
+    sec+=60*tme.wMinute;
+    sec+=60*60*tme.wHour;
+    
+	p->tv_sec=sec;
+	p->tv_usec=tme.wMilliseconds*1000;
+
+	return;
+}
+#endif	// HAVE_GETTIMEOFDAY
+
+int getpriority(int which, int who)
+{
+	unsigned int priorityClass;
+
+	ADM_assert(which == PRIO_PROCESS);
+	ADM_assert(who == 0);
+
+	priorityClass = GetPriorityClass(GetCurrentProcess());
+
+	switch (priorityClass)
+	{
+		case HIGH_PRIORITY_CLASS:
+			return -18;
+			break;
+		case ABOVE_NORMAL_PRIORITY_CLASS:
+			return -10;
+			break;
+		case NORMAL_PRIORITY_CLASS:
+			return 0;
+			break;
+		case BELOW_NORMAL_PRIORITY_CLASS:
+			return 10;
+			break;
+		case IDLE_PRIORITY_CLASS:
+			return 18;
+			break;
+		default:
+			ADM_assert(0);
+	}
+}
+
+int setpriority(int which, int who, int value)
+{
+	unsigned int priorityClass;
+
+	ADM_assert(which == PRIO_PROCESS);
+	ADM_assert(who == 0);
+	ADM_assert(value >= PRIO_MIN && value <= PRIO_MAX);
+
+	if (value >= -20 && value <= -16)
+	{
+		priorityClass = HIGH_PRIORITY_CLASS;
+	}
+	else if (value >= -15 && value <= -6)
+	{
+		priorityClass = ABOVE_NORMAL_PRIORITY_CLASS;
+	}
+	else if (value >= -5 && value <= 4)
+	{
+		priorityClass = NORMAL_PRIORITY_CLASS;
+	}
+	else if (value >= 6 && value <= 15)
+	{
+		priorityClass = BELOW_NORMAL_PRIORITY_CLASS;
+	}
+	else if (value >= 16 && value <= 20)
+	{
+		priorityClass = IDLE_PRIORITY_CLASS;
+	}
+
+	if (!SetPriorityClass(GetCurrentProcess(), priorityClass))
+	{
+		return -1;
+	}
+
+	return 0;
+}
+
+int shutdown_win32(void)
+{
+	HANDLE hToken;
+	TOKEN_PRIVILEGES tkp;
+
+	// Get a token for this process. 
+	if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken))
+	{
+		return -1;
+	}
+
+	// Get the LUID for the shutdown privilege.
+	LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME, &tkp.Privileges[0].Luid);
+
+	tkp.PrivilegeCount = 1;  // one privilege to set
+	tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
+
+	// Get the shutdown privilege for this process.
+	AdjustTokenPrivileges(hToken, FALSE, &tkp, 0, (PTOKEN_PRIVILEGES)NULL, 0);
+
+	if (GetLastError() != ERROR_SUCCESS)
+	{
+		return -1;
+	}
+
+	// Shut down the system and force all applications to close.
+	if (!ExitWindowsEx(EWX_POWEROFF | EWX_FORCE, SHTDN_REASON_FLAG_PLANNED))
+	{
+		return -1;
+	}
+
+	return 0;
+}
+
+#ifndef PRODUCT_BUSINESS
+#define PRODUCT_BUSINESS 0x00000006
+#endif
+
+#ifndef PRODUCT_BUSINESS_N
+#define PRODUCT_BUSINESS_N 0x00000010
+#endif
+
+#ifndef PRODUCT_HOME_BASIC
+#define PRODUCT_HOME_BASIC 0x00000002
+#endif
+
+#ifndef PRODUCT_HOME_BASIC_N
+#define PRODUCT_HOME_BASIC_N 0x00000005
+#endif
+
+#ifndef PRODUCT_HOME_PREMIUM
+#define PRODUCT_HOME_PREMIUM 0x00000003
+#endif 
+
+#ifndef PRODUCT_STARTER
+#define PRODUCT_STARTER 0x0000000B
+#endif
+
+#ifndef PRODUCT_ENTERPRISE
+#define PRODUCT_ENTERPRISE 0x00000004
+#endif 
+
+#ifndef PRODUCT_ULTIMATE
+#define PRODUCT_ULTIMATE 0x00000001
+#endif
+
+bool getWindowsVersion(char* version)
+{
+	int index = 0;
+	OSVERSIONINFOEX osvi = {};
+
+	osvi.dwOSVersionInfoSize = sizeof(OSVERSIONINFOEX);
+
+	if (!GetVersionEx((OSVERSIONINFO*)&osvi))
+		return false;
+
+	if (osvi.dwPlatformId != VER_PLATFORM_WIN32_NT)
+		return false;
+// Windows Vista / Windows 7
+	if (osvi.dwMajorVersion == 6 && osvi.dwMinorVersion <= 1)
+	{
+		if (osvi.wProductType == VER_NT_WORKSTATION)
+		{
+			if (osvi.dwMinorVersion == 1)
+				index += sprintf(version + index, "Microsoft Windows 7");
+			else
+				index += sprintf(version + index, "Microsoft Windows Vista");
+
+			uint32_t productType = 0;
+
+			HMODULE hKernel = GetModuleHandle("KERNEL32.DLL");
+
+			if (hKernel)
+			{
+				typedef bool (__stdcall *funcGetProductInfo)(uint32_t, uint32_t, uint32_t, uint32_t, uint32_t*);
+				funcGetProductInfo pGetProductInfo = (funcGetProductInfo)GetProcAddress(hKernel, "GetProductInfo"); 
+
+				if (pGetProductInfo)
+					pGetProductInfo(6, 0, 0, 0, &productType);
+	  
+				switch (productType)
+				{
+				case PRODUCT_STARTER:
+				{
+					index += sprintf(version + index, " Starter");
+					break;
+				}
+				case PRODUCT_HOME_BASIC_N:
+				{
+					index += sprintf(version + index, " Home Basic N");
+					break;
+				}
+				case PRODUCT_HOME_BASIC:
+				{
+					index += sprintf(version + index, " Home Basic");
+					break;
+				}
+				case PRODUCT_HOME_PREMIUM:
+				{
+					index += sprintf(version + index, " Home Premium");
+					break;
+				}
+				case PRODUCT_BUSINESS_N:
+				{
+					index += sprintf(version + index, " Business N");
+					break;
+				}
+				case PRODUCT_BUSINESS:
+				{
+					index += sprintf(version + index, " Business");
+					break;
+				}
+				case PRODUCT_ENTERPRISE:
+				{
+					index += sprintf(version + index, " Enterprise");
+					break;
+				}
+				case PRODUCT_ULTIMATE:
+				{
+					index += sprintf(version + index, " Ultimate");
+					break;
+				}
+				default:
+					break;
+				}
+			}
+		}
+		else if (osvi.wProductType == VER_NT_SERVER)
+		{
+			if (osvi.dwMinorVersion == 1)
+				index += sprintf(version + index, "Microsoft Windows Server 2008 R2");
+			else
+				index += sprintf(version + index, "Microsoft Windows Server 2008");
+
+			if (osvi.wSuiteMask & VER_SUITE_DATACENTER)
+				index += sprintf(version + index, " Datacenter Edition");
+			else if (osvi.wSuiteMask & VER_SUITE_ENTERPRISE)
+				index += sprintf(version + index, " Enterprise Edition");
+			else if (osvi.wSuiteMask == VER_SUITE_BLADE)
+				index += sprintf(version + index, " Web Edition");
+			else
+				index += sprintf(version + index, " Standard Edition");
+		}
+	}
+// Windows Server 2003
+	else if (osvi.dwMajorVersion == 5 && osvi.dwMinorVersion == 2)
+	{
+		index += sprintf(version + index, "Microsoft Windows Server 2003");
+
+		if (GetSystemMetrics(SM_SERVERR2))
+			index += sprintf(version + index, " R2");
+
+		if (osvi.wSuiteMask & VER_SUITE_DATACENTER)
+			index += sprintf(version + index, " Datacenter Edition");
+		else if (osvi.wSuiteMask & VER_SUITE_ENTERPRISE)
+			index += sprintf(version + index, " Enterprise Edition");
+		else if (osvi.wSuiteMask == VER_SUITE_BLADE)
+			index += sprintf(version + index, " Web Edition");
+		else
+			index += sprintf(version + index, " Standard Edition");
+	}
+// Windows XP
+	else if (osvi.dwMajorVersion == 5 && osvi.dwMinorVersion == 1)
+	{
+		index += sprintf(version + index, "Microsoft Windows XP");
+
+		if (GetSystemMetrics(SM_MEDIACENTER))
+			index += sprintf(version + index, " Media Center Edition");
+		else if (GetSystemMetrics(SM_STARTER))
+			index += sprintf(version + index, " Starter Edition");
+		else if (GetSystemMetrics(SM_TABLETPC))
+			index += sprintf(version + index, " Tablet PC Edition");
+		else if (osvi.wSuiteMask & VER_SUITE_PERSONAL)
+			index += sprintf(version + index, " Home Edition");
+		else
+			index += sprintf(version + index, " Professional");
+	}
+// Windows 2000
+	else if (osvi.dwMajorVersion == 5 && osvi.dwMinorVersion == 0)
+	{
+		index += sprintf(version + index, "Microsoft Windows 2000");
+
+		if (osvi.wProductType == VER_NT_WORKSTATION)
+		{
+			index += sprintf(version + index, " Professional");
+		}
+		else if (osvi.wProductType == VER_NT_SERVER)
+		{
+			if (osvi.wSuiteMask & VER_SUITE_DATACENTER)
+				index += sprintf(version + index, " Datacenter Server");
+			else if (osvi.wSuiteMask & VER_SUITE_ENTERPRISE)
+				index += sprintf(version + index, " Advanced Server");
+			else
+				index += sprintf(version + index, " Server");
+		}
+	}
+// Windows NT 4
+	else if (osvi.dwMajorVersion == 4)
+	{
+		index += sprintf(version + index, "Microsoft Windows NT 4");
+
+		if (osvi.wProductType == VER_NT_WORKSTATION)
+		{
+			index += sprintf(version + index, " Workstation");
+		}
+		else if (osvi.wProductType == VER_NT_SERVER)
+		{
+			if (osvi.wSuiteMask & VER_SUITE_ENTERPRISE)
+				index += sprintf(version + index, " Server, Enterprise Edition");
+			else
+				index += sprintf(version + index, " Server");
+		}
+	}
+	else
+	{
+		index += sprintf(version + index, "Microsoft Windows");
+	}
+
+// Service pack and full version info
+	if (strlen(osvi.szCSDVersion) > 0)
+	{
+		index += sprintf(version + index, " %s", osvi.szCSDVersion);
+	}
+
+	index += sprintf(version + index, " (%d.%d.%d", osvi.dwMajorVersion, osvi.dwMinorVersion, osvi.dwBuildNumber & 0xFFFF);
+
+// 64-bit Windows
+#ifdef __WIN64
+	index += sprintf(version + index, "; 64-bit");
+#else
+	bool isWow64 = false;
+	HMODULE hKernel = GetModuleHandle("kernel32.dll");
+
+	if (hKernel)
+	{
+		typedef bool (__stdcall *funcIsWow64Process)(void*, bool*);  
+
+	    funcIsWow64Process pIsWow64Process = (funcIsWow64Process)GetProcAddress(hKernel, "IsWow64Process"); 
+
+	    if (pIsWow64Process)
+	    {
+			pIsWow64Process(GetCurrentProcess(), &isWow64);
+		}
+	}
+
+	if (isWow64)
+		index += sprintf(version + index, "; 64-bit");
+	else
+		index += sprintf(version + index, "; 32-bit");
+#endif
+
+	index += sprintf(version + index, ")");
+	
+	return true;
+}
+
+void redirectStdoutToFile(void)
+{
+	// Don't redirect stdout and stderr if SDL hasn't already hijacked it.
+	// This allows us to optionally compile all EXEs as console applications
+	// so the output can be printed to the terminal for debugging purposes.
+
+ 	// Close SDL generated logs and briefly redirect to NUL
+ 	freopen("NUL", "w", stdout);
+ 	freopen("NUL", "w", stderr);
+
+	// Remove SDL logs to avoid confusion
+	char path[MAX_PATH];
+	char stdoutPath[MAX_PATH];
+	char stderrPath[MAX_PATH];
+	DWORD pathlen = GetModuleFileName(NULL, path, MAX_PATH);
+
+	while (pathlen > 0 && path[pathlen] != '\\')
+		pathlen--;
+
+	path[pathlen] = '\0';
+
+	strcpy(stdoutPath, path);
+	strcat(stdoutPath, "\\stdout.txt");
+	strcpy(stderrPath, path);
+	strcat(stderrPath, "\\stderr.txt");
+
+	remove(stdoutPath);
+	remove(stderrPath);
+
+	// Redirect output to log file in the user's profile directory
+	const char* logFile = "admlog.txt";
+	char* baseDir = ADM_getBaseDir();
+	char *logPath = new char[strlen(baseDir) + 2 + strlen(logFile)];
+
+	strcpy(logPath, baseDir);
+	strcat(logPath, "/");
+	strcat(logPath, logFile);
+
+	FILE *stream = fopen(logPath, "w");
+
+	if (stream)
+	{
+		fclose(stdout);
+		fclose(stderr);
+
+		*stdout = *stream;
+		*stderr = *stream;
+	}
+
+	// Line buffering
+	setvbuf(stdout, NULL, _IONBF, BUFSIZ); 
+	setvbuf(stderr, NULL, _IONBF, BUFSIZ);
+
+	delete[] logPath;
+}
+
+// Convert string from ANSI code page to wide char
+int ansiStringToWideChar(const char *ansiString, int ansiStringLength, wchar_t *wideCharString)
+{
+	int wideCharStringLen = MultiByteToWideChar(CP_ACP, 0, ansiString, ansiStringLength, NULL, 0);
+
+	if (wideCharString)
+		MultiByteToWideChar(CP_ACP, 0, ansiString, ansiStringLength, wideCharString, wideCharStringLen);
+
+	return wideCharStringLen;
+}
+
+// Convert UTF-8 string to wide char
+int utf8StringToWideChar(const char *utf8String, int utf8StringLength, wchar_t *wideCharString)
+{
+	int wideCharStringLength = MultiByteToWideChar(CP_UTF8, 0, utf8String, utf8StringLength, NULL, 0);
+
+	if (wideCharString)
+		MultiByteToWideChar(CP_UTF8, 0, utf8String, utf8StringLength, wideCharString, wideCharStringLength);
+
+	return wideCharStringLength;
+}
+
+// Convert Wide Char string to UTF-8
+int wideCharStringToUtf8(const wchar_t *wideCharString, int wideCharStringLength, char *utf8String)
+{
+	int utf8StringLen = WideCharToMultiByte(CP_UTF8, 0, wideCharString, wideCharStringLength, NULL, 0, NULL, NULL);
+
+	if (utf8String)
+		WideCharToMultiByte(CP_UTF8, 0, wideCharString, wideCharStringLength, utf8String, utf8StringLen, NULL, NULL);
+
+	return utf8StringLen;
+}
+
+// Convert string from ANSI code page to UTF-8
+int ansiStringToUtf8(const char *ansiString, int ansiStringLength, char *utf8String)
+{
+	int wideCharStringLen = ansiStringToWideChar(ansiString, ansiStringLength, NULL);
+	wchar_t wideCharString[wideCharStringLen];
+
+	ansiStringToWideChar(ansiString, ansiStringLength, wideCharString);
+
+	int multiByteStringLen = wideCharStringToUtf8(wideCharString, wideCharStringLen, NULL);
+
+	if (utf8String)
+		wideCharStringToUtf8(wideCharString, wideCharStringLen, utf8String);
+
+	return multiByteStringLen;
+}
+#endif	// __WIN32



From gruntster at mail.berlios.de  Fri Aug 19 22:46:22 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Fri, 19 Aug 2011 22:46:22 +0200
Subject: [Avidemux-svn-commit] r7430 -
	branches/avidemux_2.6_branch_mean/avidemux/cli
Message-ID: <20110819204623.1AB45481300@sheep.berlios.de>

Author: gruntster
Date: 2011-08-19 22:46:22 +0200 (Fri, 19 Aug 2011)
New Revision: 7430

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt
Log:
[mswin] restore r3784

Modified: branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt	2011-08-19 18:57:53 UTC (rev 7429)
+++ branches/avidemux_2.6_branch_mean/avidemux/cli/CMakeLists.txt	2011-08-19 20:46:22 UTC (rev 7430)
@@ -94,12 +94,7 @@
 ###########################################
 IF (WIN32)
 	target_link_libraries(ADM_osSupport)
-
-	IF (MINGW)
-		target_link_libraries(avidemux3_cli -mno-cygwin)
-	ENDIF (MINGW)
-
-	target_link_libraries(avidemux3_cli winmm -mwindows)
+	target_link_libraries(avidemux3_cli winmm -mwindows -Wl,-subsystem,console)
 ENDIF (WIN32)
 
 ###########################################



From mean at mail.berlios.de  Sat Aug 20 08:40:13 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 20 Aug 2011 08:40:13 +0200
Subject: [Avidemux-svn-commit] r7431 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI
Message-ID: <20110820064013.6E4D5481368@sheep.berlios.de>

Author: mean
Date: 2011-08-20 08:40:12 +0200 (Sat, 20 Aug 2011)
New Revision: 7431

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp
Log:
[UI] Fix disabling openGl when it is not built with openGL support (JM)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp	2011-08-19 20:46:22 UTC (rev 7430)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp	2011-08-20 06:40:12 UTC (rev 7431)
@@ -164,7 +164,7 @@
         diaElemToggle useVdpau(&bvdpau,QT_TR_NOOP("Decode video using VDPAU"));
         diaElemToggle useOpenGl(&hasOpenGl,QT_TR_NOOP("Enable openGl support"));
 #ifndef USE_OPENGL
-        useOpenGl.disable();
+        useOpenGl.enable(0);
 #endif
         
         diaElemToggle useSysTray(&useTray,QT_TR_NOOP("_Use systray while encoding"));



From mean at mail.berlios.de  Sat Aug 20 11:56:22 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 20 Aug 2011 11:56:22 +0200
Subject: [Avidemux-svn-commit] r7432 - in
	branches/avidemux_2.6_branch_mean/avidemux:
	common/ADM_commonUI qt4/ADM_UIs/src
Message-ID: <20110820095622.CCAF8481368@sheep.berlios.de>

Author: mean
Date: 2011-08-20 11:56:22 +0200 (Sat, 20 Aug 2011)
New Revision: 7432

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt
Log:
[Build] Build without openGl

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp	2011-08-20 06:40:12 UTC (rev 7431)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_prefs.cpp	2011-08-20 09:56:22 UTC (rev 7432)
@@ -164,7 +164,7 @@
         diaElemToggle useVdpau(&bvdpau,QT_TR_NOOP("Decode video using VDPAU"));
         diaElemToggle useOpenGl(&hasOpenGl,QT_TR_NOOP("Enable openGl support"));
 #ifndef USE_OPENGL
-        useOpenGl.enable(0);
+        //useOpenGl.enable(0);
 #endif
         
         diaElemToggle useSysTray(&useTray,QT_TR_NOOP("_Use systray while encoding"));

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt	2011-08-20 06:40:12 UTC (rev 7431)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_UIs/src/CMakeLists.txt	2011-08-20 09:56:22 UTC (rev 7432)
@@ -9,8 +9,12 @@
 	T_slider.cpp  T_threadCount.cpp  T_toggle.cpp  T_notch.cpp
         T_flyDialogQt4.cpp 
         T_QCanvas.cpp
-        T_openGL.cpp
 )
+if(USE_OPENGL)
+        SET(${ADM_LIB}_T
+                ${${ADM_LIB}_T}
+                T_openGL.cpp)
+endif(USE_OPENGL)
 
 SET(${ADM_LIB}_SRCS
 	FAC_bar.cpp    FAC_frame.cpp  FAC_integer.cpp  FAC_aspectRatio.cpp



From mean at mail.berlios.de  Sun Aug 21 18:27:41 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 21 Aug 2011 18:27:41 +0200
Subject: [Avidemux-svn-commit] r7433 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <20110821162741.4C5174815BB@sheep.berlios.de>

Author: mean
Date: 2011-08-21 18:27:40 +0200 (Sun, 21 Aug 2011)
New Revision: 7433

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
Log:
[Main] Free created filters at exit

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2011-08-20 09:56:22 UTC (rev 7432)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2011-08-21 16:27:40 UTC (rev 7433)
@@ -89,6 +89,7 @@
 extern bool ADM_mx_cleanup(void);
 extern bool ADM_vf_cleanup(void);
 extern bool ADM_dm_cleanup(void);
+extern bool ADM_vf_clearFilters(void);
 
 extern bool vdpauProbe(void);
 extern bool vdpauCleanup(void);
@@ -388,6 +389,7 @@
     ADM_ad_cleanup();
     ADM_ae_cleanup();
     ADM_mx_cleanup();
+    ADM_vf_clearFilters();
     ADM_vf_cleanup();
     ADM_dm_cleanup();
 #if defined( USE_VDPAU) 



From mean at mail.berlios.de  Sun Aug 21 18:27:42 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 21 Aug 2011 18:27:42 +0200
Subject: [Avidemux-svn-commit] r7434 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <20110821162742.56E2C4815BB@sheep.berlios.de>

Author: mean
Date: 2011-08-21 18:27:42 +0200 (Sun, 21 Aug 2011)
New Revision: 7434

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
Log:
 [Main] Clear filters when loading a new video

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2011-08-21 16:27:40 UTC (rev 7433)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2011-08-21 16:27:42 UTC (rev 7434)
@@ -40,6 +40,8 @@
 //#include "ADM_outputfmt.h"
 #include "ADM_edPtsDts.h"
 #include "ADM_vidMisc.h"
+#include "ADM_confCouple.h"
+#include "ADM_videoFilters.h"
 
 vidHeader *ADM_demuxerSpawn(uint32_t magic,const char *name);
 
@@ -236,6 +238,10 @@
         _imageBuffer->quant=new uint8_t[_imageBuffer->_qSize];
         memset(_imageBuffer->quant,0,_imageBuffer->_qSize);
         _imageBuffer->_qStride=(info.width+15)>>4;
+
+        // We also clear the filter queue...
+        ADM_info("Clearing video filters\n");
+        ADM_vf_clearFilters();
     }
 
 



From mean at mail.berlios.de  Sun Aug 21 18:27:43 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 21 Aug 2011 18:27:43 +0200
Subject: [Avidemux-svn-commit] r7435 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
Message-ID: <20110821162743.95ABF4815BB@sheep.berlios.de>

Author: mean
Date: 2011-08-21 18:27:43 +0200 (Sun, 21 Aug 2011)
New Revision: 7435

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edAudioPacket.cpp
Log:
[audio] Display a warning if seek fails

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edAudioPacket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edAudioPacket.cpp	2011-08-21 16:27:42 UTC (rev 7434)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edAudioPacket.cpp	2011-08-21 16:27:43 UTC (rev 7435)
@@ -215,6 +215,7 @@
         setDts(ustime);
         return true;
     }
+    ADM_warning("Go to time failed\n");
     return false;
 }
 



From mean at mail.berlios.de  Sun Aug 21 18:27:44 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 21 Aug 2011 18:27:44 +0200
Subject: [Avidemux-svn-commit] r7436 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml
Message-ID: <20110821162744.CD8A74815BB@sheep.berlios.de>

Author: mean
Date: 2011-08-21 18:27:44 +0200 (Sun, 21 Aug 2011)
New Revision: 7436

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.cpp
Log:
[avi] Fix seeking to 0

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.cpp	2011-08-21 16:27:43 UTC (rev 7435)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/OpenDml/ADM_odml_audio.cpp	2011-08-21 16:27:44 UTC (rev 7436)
@@ -110,7 +110,12 @@
 bool  ADM_aviAudioAccess::updatePos(void)
 {
  uint64_t total=0;
-    if(currentIndex==0) return 0;
+    if(currentIndex==0) 
+    {
+        currentPosition=0;
+        return true;
+    }
+    
     if(currentIndex>=nbIndex) return length;
     for(int i=0;i<currentIndex;i++)
     {



From mean at mail.berlios.de  Sun Aug 21 18:27:45 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 21 Aug 2011 18:27:45 +0200
Subject: [Avidemux-svn-commit] r7437 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/vdpauFilters
Message-ID: <20110821162746.01ABA4815BB@sheep.berlios.de>

Author: mean
Date: 2011-08-21 18:27:45 +0200 (Sun, 21 Aug 2011)
New Revision: 7437

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/vdpauFilters/ADM_vidVdpauFilterDeint.cpp
Log:
[vdpau] nitpick about width/height

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/vdpauFilters/ADM_vidVdpauFilterDeint.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/vdpauFilters/ADM_vidVdpauFilterDeint.cpp	2011-08-21 16:27:44 UTC (rev 7436)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6/vdpauFilters/ADM_vidVdpauFilterDeint.cpp	2011-08-21 16:27:45 UTC (rev 7437)
@@ -329,8 +329,15 @@
      if(diaFactoryRun(QT_TR_NOOP("vdpau"),sizeof(elems)/sizeof(diaElem *),elems))
      {
                 configuration.resizeToggle=(bool)doResize;
-                info.width=configuration.targetWidth;
-                info.height=configuration.targetHeight;
+                if(doResize)
+                {
+                    info.width=configuration.targetWidth;
+                    info.height=configuration.targetHeight;
+                }else
+                {
+                    info.width=previousFilter->getInfo()->width;
+                    info.height=previousFilter->getInfo()->height;
+                }
                 ADM_info("New dimension : %d x %d\n",info.width,info.height);
                 updateConf();
                 cleanupVdpau();
@@ -535,7 +542,8 @@
 bool vdpauVideoFilterDeint::getResult(ADMImage *image)
 {
 
-  
+    ADM_assert(image->GetWidth(PLANAR_Y)==info.width);
+    ADM_assert(image->GetHeight(PLANAR_Y)==info.height);
     if(VDP_STATUS_OK!=admVdpau::outputSurfaceGetBitsNative(outputSurface,
                                                             tempBuffer, 
                                                             info.width,info.height))



From mean at mail.berlios.de  Mon Aug 22 07:03:12 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 22 Aug 2011 07:03:12 +0200
Subject: [Avidemux-svn-commit] r7438 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src
Message-ID: <20110822050313.120F24815C0@sheep.berlios.de>

Author: mean
Date: 2011-08-22 07:03:12 +0200 (Mon, 22 Aug 2011)
New Revision: 7438

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp
Log:
[imageUtils] Fix mmx yuv444 => yv12, used by vdpauDeint

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp	2011-08-21 16:27:45 UTC (rev 7437)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreImage/src/ADM_imageUtils.cpp	2011-08-22 05:03:12 UTC (rev 7438)
@@ -675,9 +675,9 @@
                         "movq           %%mm2,%%mm6\n"
                         "movq           %%mm3,%%mm7\n"
 
+                        "punpcklbw       %%mm2,%%mm0\n"
+                        "punpcklbw       %%mm3,%%mm1\n"
                         "punpcklbw       %%mm1,%%mm0\n"
-                        "punpcklbw       %%mm3,%%mm2\n"
-                        "punpcklbw       %%mm2,%%mm0\n"
                         
                         "movd           %%mm0,(%1) \n"                       
 
@@ -686,9 +686,9 @@
                         "psrlw          $8,%%mm6\n"
                         "psrlw          $8,%%mm7\n"
 
+                        "punpcklbw       %%mm6,%%mm4\n"
+                        "punpcklbw       %%mm7,%%mm5\n"
                         "punpcklbw       %%mm5,%%mm4\n"
-                        "punpcklbw       %%mm7,%%mm6\n"
-                        "punpcklbw       %%mm6,%%mm4\n"
 
 
                         "movd           %%mm4,(%2) \n"                       



From mean at mail.berlios.de  Mon Aug 22 08:09:24 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 22 Aug 2011 08:09:24 +0200
Subject: [Avidemux-svn-commit] r7439 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl:
	. glYadif
Message-ID: <20110822060924.EC0B64815C0@sheep.berlios.de>

Author: mean
Date: 2011-08-22 08:09:24 +0200 (Mon, 22 Aug 2011)
New Revision: 7439

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.ui
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/yadif.conf
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt
Log:
[Video Filter] Skeleton for glYadif

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt	2011-08-22 05:03:12 UTC (rev 7438)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/CMakeLists.txt	2011-08-22 06:09:24 UTC (rev 7439)
@@ -1,5 +1,6 @@
-ADD_SUBDIRECTORY(glSmooth)
-ADD_SUBDIRECTORY(sample_fragment)
+#ADD_SUBDIRECTORY(glSmooth)
+ADD_SUBDIRECTORY(glYadif)
+#ADD_SUBDIRECTORY(sample_fragment)
 ADD_SUBDIRECTORY(sample_fragment2)
-ADD_SUBDIRECTORY(sample_vertex)
+#ADD_SUBDIRECTORY(sample_vertex)
 #ADD_SUBDIRECTORY(glVdpau)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/CMakeLists.txt	2011-08-22 06:09:24 UTC (rev 7439)
@@ -0,0 +1,7 @@
+INCLUDE(vf_plugin)
+INCLUDE(vf_plugin_qt4gl)
+
+
+SET(ADM_vf_glSmooth_SRCS glSmooth.cpp)
+INIT_VIDEO_FILTER_GLQT4(ADM_vf_glSmooth "${ADM_vf_glSmooth_SRCS}" "glSmooth.h" "glSmooth" "${ADM_vf_glSmooth_SRCS}")
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.cpp	2011-08-22 06:09:24 UTC (rev 7439)
@@ -0,0 +1,194 @@
+/** *************************************************************************
+                    \fn       glSmooth Filter.cpp  
+                    \brief    simple fragment shader
+
+    Smoothing filter
+    Do a 3x3 convolution on a image to get a mask
+    Depending on the mask we let through or do convolution
+
+    
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_openGL.h"
+#define ADM_LEGACY_PROGGY
+#include "ADM_default.h"
+#include "ADM_coreVideoFilterInternal.h"
+#include "T_openGL.h"
+#include "T_openGLFilter.h"
+#include "glSmooth.h"
+#include "ADM_clock.h"
+/**
+
+*/
+
+//#define BENCH 1
+//#define BENCH_READTEXTURE
+
+
+/**
+    \class glSmooth
+*/
+class glSmooth : public  ADM_coreVideoFilterQtGl
+{
+protected:
+
+protected:
+                        bool render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo);
+public:
+                             glSmooth(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                            ~glSmooth();
+
+        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
+        virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
+        virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
+        virtual bool         configure(void) {return true;}             /// Start graphical user interface
+};
+
+// Add the hook to make it valid plugin
+DECLARE_VIDEO_FILTER(   glSmooth,   // Class
+                        1,0,0,              // Version
+                        ADM_UI_QT4+ADM_UI_GL,         // UI
+                        VF_OPENGL,            // Category
+                        "glSmooth",            // internal name (must be uniq!)
+                        "OpenGl Smooth",            // Display name
+                        "Smooth image while preserving edge." // Description
+                    );
+
+// Now implements the interesting parts
+/**
+    \fn glSmooth
+    \brief constructor
+*/
+glSmooth::glSmooth(  ADM_coreVideoFilter *in,CONFcouple *setup) : ADM_coreVideoFilterQtGl(in,setup)
+{
+UNUSED_ARG(setup);
+        widget->makeCurrent();
+        fboY->bind();
+        printf("Compiling shader \n");
+        glProgramY = new QGLShaderProgram(context);
+        ADM_assert(glProgramY);
+        if ( !glProgramY->addShaderFromSourceCode(QGLShader::Fragment, myShaderY))
+        {
+                ADM_error("[GL Render] Fragment log: %s\n", glProgramY->log().toUtf8().constData());
+                ADM_assert(0);
+        }
+        if ( !glProgramY->link())
+        {
+            ADM_error("[GL Render] Link log: %s\n", glProgramY->log().toUtf8().constData());
+            ADM_assert(0);
+        }
+
+        if ( !glProgramY->bind())
+        {
+                ADM_error("[GL Render] Binding FAILED\n");
+                ADM_assert(0);
+        }
+
+        fboY->release();
+        widget->doneCurrent();
+
+}
+/**
+    \fn glSmooth
+    \brief destructor
+*/
+glSmooth::~glSmooth()
+{
+
+}
+
+/**
+    \fn getFrame
+    \brief Get a processed frame
+*/
+bool glSmooth::getNextFrame(uint32_t *fn,ADMImage *image)
+{
+    // since we do nothing, just get the output of previous filter
+    if(false==previousFilter->getNextFrame(fn,image))
+    {
+        ADM_warning("FlipFilter : Cannot get frame\n");
+        return false;
+    }
+    widget->makeCurrent();
+    glPushMatrix();
+    // size is the last one...
+    fboY->bind();
+
+    float angle=*fn;
+    angle=angle/40;
+    glProgramY->setUniformValue("teta", angle);     
+    glProgramY->setUniformValue("myTextureU", 1); 
+    glProgramY->setUniformValue("myTextureV", 2); 
+    glProgramY->setUniformValue("myTextureY", 0); 
+    glProgramY->setUniformValue("myWidth", image->GetWidth(PLANAR_Y)); 
+    glProgramY->setUniformValue("myHeight", image->GetHeight(PLANAR_Y)); 
+
+    uploadAllPlanes(image);
+
+    render(image,PLANAR_Y,fboY);
+
+    downloadTextures(image,fboY);
+
+    fboY->release();
+    firstRun=false;
+    glPopMatrix();
+    widget->doneCurrent();
+    
+    return true;
+}
+/**
+    \fn getCoupledConf
+    \brief Return our current configuration as couple name=value
+*/
+bool         glSmooth::getCoupledConf(CONFcouple **couples)
+{
+    *couples=new CONFcouple(0); // Even if we dont have configuration we must allocate one 
+    return true;
+}
+/**
+    \fn getConfiguration
+    \brief Return current setting as a string
+*/
+const char *glSmooth::getConfiguration(void)
+{
+    
+    return "openGl Sample.";
+}
+
+
+/**
+    \fn render
+*/
+bool glSmooth::render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo)
+{
+    int width=image->GetWidth(plane);
+    int height=image->GetHeight(plane);
+
+    glClear(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);
+	glViewport(0, 0, width, height);
+    glMatrixMode(GL_PROJECTION);
+    glLoadIdentity();
+    glOrtho(0, width, 0, height, -1, 1);
+
+    //
+    glBegin(GL_QUADS);
+	glTexCoord2i(0, 0);
+	glVertex2i(0, 0);
+	glTexCoord2i(width, 0);
+	glVertex2i(width, 0);
+	glTexCoord2i(width, height);
+	glVertex2i(width ,height);
+	glTexCoord2i(0, height);
+	glVertex2i(0, height);
+	glEnd();	// draw cube background
+    return true;
+}
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.h	2011-08-22 06:09:24 UTC (rev 7439)
@@ -0,0 +1,31 @@
+// Invert x & y
+static const char *myShaderY =
+	"#extension GL_ARB_texture_rectangle: enable\n"
+	"uniform sampler2DRect myTextureY;\n" // tex unit 0
+    "uniform sampler2DRect myTextureU;\n" // tex unit 1
+    "uniform sampler2DRect myTextureV;\n" // tex unit 2
+    "uniform float myWidth;\n"
+    "uniform float myHeight;\n"
+    "uniform float teta;\n"
+
+	"void main(void) {\n"
+    "  float mmin=255,mmax=0,r;\n"
+    "  float nx = gl_TexCoord[0].x;\n"
+	"  float ny = gl_TexCoord[0].y;\n"
+    "  vec4 texvalV = vec4(0,0,0,0);\n"
+    "  vec4 texvalU = vec4(0,0,0,0);\n"
+	"  vec4 texvalY = vec4(0,0,0,0);\n"
+    "  int x=0,y=0;\n"
+    "  for(y=-1;y<2;y++)\n"
+    "   for(x=-1;x<2;x++)\n"
+    "  { \n"
+    "   r=texture2DRect(myTextureY, vec2(x+nx,y+ny));\n"
+    "   texvalV += texture2DRect(myTextureV, vec2(x+nx/2,y+ny/2));\n"
+    "   texvalU += texture2DRect(myTextureU, vec2(x+nx/2,y+ny/2));\n"
+	"   texvalY += r;\n"
+    "  }"
+    "  float t=texvalY.r/9;\n"
+    "  r=t;"
+	"  gl_FragColor = vec4(r, texvalU.r/9, texvalV.r/9, 1.0);\n"
+	"}\n";
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.ui	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.ui	2011-08-22 06:09:24 UTC (rev 7439)
@@ -0,0 +1,724 @@
+<ui version="4.0" >
+ <class>resizeDialog</class>
+ <widget class="QDialog" name="resizeDialog" >
+  <property name="geometry" >
+   <rect>
+    <x>0</x>
+    <y>0</y>
+    <width>350</width>
+    <height>342</height>
+   </rect>
+  </property>
+  <property name="windowTitle" >
+   <string>Resize</string>
+  </property>
+  <layout class="QVBoxLayout" >
+   <property name="margin" >
+    <number>9</number>
+   </property>
+   <property name="spacing" >
+    <number>6</number>
+   </property>
+   <item>
+    <widget class="QGroupBox" name="groupBox_2" >
+     <property name="title" >
+      <string>Aspect Ratio</string>
+     </property>
+     <layout class="QVBoxLayout" >
+      <property name="margin" >
+       <number>9</number>
+      </property>
+      <property name="spacing" >
+       <number>6</number>
+      </property>
+      <item>
+       <widget class="QCheckBox" name="lockArCheckBox" >
+        <property name="text" >
+         <string>Lock Aspect Ratio</string>
+        </property>
+        <property name="checked" >
+         <bool>true</bool>
+        </property>
+       </widget>
+      </item>
+      <item>
+       <layout class="QHBoxLayout" >
+        <property name="margin" >
+         <number>0</number>
+        </property>
+        <property name="spacing" >
+         <number>6</number>
+        </property>
+        <item>
+         <widget class="QLabel" name="label_4" >
+          <property name="text" >
+           <string>Source:</string>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <widget class="QComboBox" name="comboBoxSource" >
+          <item>
+           <property name="text" >
+            <string>1:1</string>
+           </property>
+          </item>
+          <item>
+           <property name="text" >
+            <string>4:3</string>
+           </property>
+          </item>
+          <item>
+           <property name="text" >
+            <string>16:9</string>
+           </property>
+          </item>
+         </widget>
+        </item>
+        <item>
+         <spacer>
+          <property name="orientation" >
+           <enum>Qt::Horizontal</enum>
+          </property>
+          <property name="sizeType" >
+           <enum>QSizePolicy::Fixed</enum>
+          </property>
+          <property name="sizeHint" >
+           <size>
+            <width>30</width>
+            <height>20</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+        <item>
+         <widget class="QLabel" name="label_3" >
+          <property name="text" >
+           <string>Destination:</string>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <widget class="QComboBox" name="comboBoxDestination" >
+          <item>
+           <property name="text" >
+            <string>1:1</string>
+           </property>
+          </item>
+          <item>
+           <property name="text" >
+            <string>4:3</string>
+           </property>
+          </item>
+          <item>
+           <property name="text" >
+            <string>16:9</string>
+           </property>
+          </item>
+         </widget>
+        </item>
+        <item>
+         <spacer>
+          <property name="orientation" >
+           <enum>Qt::Horizontal</enum>
+          </property>
+          <property name="sizeHint" >
+           <size>
+            <width>40</width>
+            <height>20</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+       </layout>
+      </item>
+     </layout>
+    </widget>
+   </item>
+   <item>
+    <widget class="QGroupBox" name="groupBox" >
+     <property name="title" >
+      <string>Resize Dimensions</string>
+     </property>
+     <layout class="QVBoxLayout" >
+      <property name="margin" >
+       <number>9</number>
+      </property>
+      <property name="spacing" >
+       <number>6</number>
+      </property>
+      <item>
+       <layout class="QHBoxLayout" >
+        <property name="margin" >
+         <number>0</number>
+        </property>
+        <property name="spacing" >
+         <number>6</number>
+        </property>
+        <item>
+         <widget class="QLabel" name="label" >
+          <property name="text" >
+           <string>Width:</string>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <widget class="QSpinBox" name="spinBoxWidth" >
+          <property name="maximum" >
+           <number>2900</number>
+          </property>
+          <property name="minimum" >
+           <number>16</number>
+          </property>
+          <property name="singleStep" >
+           <number>2</number>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <spacer>
+          <property name="orientation" >
+           <enum>Qt::Horizontal</enum>
+          </property>
+          <property name="sizeType" >
+           <enum>QSizePolicy::Fixed</enum>
+          </property>
+          <property name="sizeHint" >
+           <size>
+            <width>30</width>
+            <height>20</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+        <item>
+         <widget class="QLabel" name="label_2" >
+          <property name="text" >
+           <string>Height:</string>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <widget class="QSpinBox" name="spinBoxHeight" >
+          <property name="maximum" >
+           <number>2000</number>
+          </property>
+          <property name="minimum" >
+           <number>16</number>
+          </property>
+          <property name="singleStep" >
+           <number>2</number>
+          </property>
+         </widget>
+        </item>
+        <item>
+         <spacer>
+          <property name="orientation" >
+           <enum>Qt::Horizontal</enum>
+          </property>
+          <property name="sizeHint" >
+           <size>
+            <width>40</width>
+            <height>20</height>
+           </size>
+          </property>
+         </spacer>
+        </item>
+       </layout>
+      </item>
+      <item>
+       <widget class="QCheckBox" name="checkBoxRoundup" >
+        <property name="text" >
+         <string>Round to the Nearest Multiple of 16</string>
+        </property>
+       </widget>
+      </item>
+      <item>
+       <spacer>
+        <property name="orientation" >
+         <enum>Qt::Vertical</enum>
+        </property>
+        <property name="sizeType" >
+         <enum>QSizePolicy::Fixed</enum>
+        </property>
+        <property name="sizeHint" >
+         <size>
+          <width>312</width>
+          <height>4</height>
+         </size>
+        </property>
+       </spacer>
+      </item>
+      <item>
+       <layout class="QVBoxLayout" >
+        <property name="margin" >
+         <number>0</number>
+        </property>
+        <property name="spacing" >
+         <number>6</number>
+        </property>
+        <item>
+         <layout class="QHBoxLayout" >
+          <property name="margin" >
+           <number>0</number>
+          </property>
+          <property name="spacing" >
+           <number>12</number>
+          </property>
+          <item>
+           <layout class="QVBoxLayout" >
+            <property name="margin" >
+             <number>0</number>
+            </property>
+            <property name="spacing" >
+             <number>6</number>
+            </property>
+            <item>
+             <layout class="QHBoxLayout" >
+              <property name="margin" >
+               <number>0</number>
+              </property>
+              <property name="spacing" >
+               <number>6</number>
+              </property>
+              <item>
+               <widget class="QLabel" name="label_8" >
+                <property name="text" >
+                 <string>1%</string>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <spacer>
+                <property name="orientation" >
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" >
+                 <size>
+                  <width>40</width>
+                  <height>20</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
+              <item>
+               <widget class="QLabel" name="label_5" >
+                <property name="text" >
+                 <string>Percent</string>
+                </property>
+               </widget>
+              </item>
+              <item>
+               <spacer>
+                <property name="orientation" >
+                 <enum>Qt::Horizontal</enum>
+                </property>
+                <property name="sizeHint" >
+                 <size>
+                  <width>40</width>
+                  <height>20</height>
+                 </size>
+                </property>
+               </spacer>
+              </item>
+              <item>
+               <widget class="QLabel" name="label_9" >
+                <property name="text" >
+                 <string>200%</string>
+                </property>
+               </widget>
+              </item>
+             </layout>
+            </item>
+            <item>
+             <widget class="QSlider" name="horizontalSlider" >
+              <property name="minimum" >
+               <number>1</number>
+              </property>
+              <property name="maximum" >
+               <number>200</number>
+              </property>
+              <property name="value" >
+               <number>100</number>
+              </property>
+              <property name="orientation" >
+               <enum>Qt::Horizontal</enum>
+              </property>
+             </widget>
+            </item>
+           </layout>
+          </item>
+          <item>
+           <widget class="QSpinBox" name="percentageSpinBox" >
+            <property name="maximum" >
+             <number>200</number>
+            </property>
+            <property name="minimum" >
+             <number>1</number>
+            </property>
+            <property name="value" >
+             <number>100</number>
+            </property>
+           </widget>
+          </item>
+         </layout>
+        </item>
+        <item>
+         <layout class="QHBoxLayout" >
+          <property name="margin" >
+           <number>0</number>
+          </property>
+          <property name="spacing" >
+           <number>6</number>
+          </property>
+          <item>
+           <widget class="QLabel" name="label_10" >
+            <property name="text" >
+             <string>Error X / Y:</string>
+            </property>
+           </widget>
+          </item>
+          <item>
+           <widget class="QLabel" name="labelErrorXY" >
+            <property name="text" >
+             <string>0.00 / 0.00</string>
+            </property>
+           </widget>
+          </item>
+          <item>
+           <spacer>
+            <property name="orientation" >
+             <enum>Qt::Horizontal</enum>
+            </property>
+            <property name="sizeHint" >
+             <size>
+              <width>40</width>
+              <height>20</height>
+             </size>
+            </property>
+           </spacer>
+          </item>
+         </layout>
+        </item>
+       </layout>
+      </item>
+     </layout>
+    </widget>
+   </item>
+   <item>
+    <spacer>
+     <property name="orientation" >
+      <enum>Qt::Vertical</enum>
+     </property>
+     <property name="sizeType" >
+      <enum>QSizePolicy::Fixed</enum>
+     </property>
+     <property name="sizeHint" >
+      <size>
+       <width>332</width>
+       <height>6</height>
+      </size>
+     </property>
+    </spacer>
+   </item>
+   <item>
+    <layout class="QHBoxLayout" >
+     <property name="margin" >
+      <number>0</number>
+     </property>
+     <property name="spacing" >
+      <number>6</number>
+     </property>
+     <item>
+      <widget class="QLabel" name="label_6" >
+       <property name="text" >
+        <string>Resize Method:</string>
+       </property>
+      </widget>
+     </item>
+     <item>
+      <widget class="QComboBox" name="comboBoxAlgo" >
+       <item>
+        <property name="text" >
+         <string>Bilinear</string>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>Bicubic</string>
+        </property>
+       </item>
+       <item>
+        <property name="text" >
+         <string>Lanzcos3</string>
+        </property>
+       </item>
+      </widget>
+     </item>
+     <item>
+      <spacer>
+       <property name="orientation" >
+        <enum>Qt::Horizontal</enum>
+       </property>
+       <property name="sizeHint" >
+        <size>
+         <width>40</width>
+         <height>20</height>
+        </size>
+       </property>
+      </spacer>
+     </item>
+    </layout>
+   </item>
+   <item>
+    <spacer>
+     <property name="orientation" >
+      <enum>Qt::Vertical</enum>
+     </property>
+     <property name="sizeType" >
+      <enum>QSizePolicy::MinimumExpanding</enum>
+     </property>
+     <property name="sizeHint" >
+      <size>
+       <width>20</width>
+       <height>16</height>
+      </size>
+     </property>
+    </spacer>
+   </item>
+   <item>
+    <widget class="QDialogButtonBox" name="buttonBox" >
+     <property name="orientation" >
+      <enum>Qt::Horizontal</enum>
+     </property>
+     <property name="standardButtons" >
+      <set>QDialogButtonBox::Cancel|QDialogButtonBox::NoButton|QDialogButtonBox::Ok</set>
+     </property>
+    </widget>
+   </item>
+  </layout>
+ </widget>
+ <tabstops>
+  <tabstop>lockArCheckBox</tabstop>
+  <tabstop>comboBoxSource</tabstop>
+  <tabstop>comboBoxDestination</tabstop>
+  <tabstop>spinBoxWidth</tabstop>
+  <tabstop>spinBoxHeight</tabstop>
+  <tabstop>checkBoxRoundup</tabstop>
+  <tabstop>horizontalSlider</tabstop>
+  <tabstop>percentageSpinBox</tabstop>
+  <tabstop>comboBoxAlgo</tabstop>
+  <tabstop>buttonBox</tabstop>
+ </tabstops>
+ <resources/>
+ <connections>
+  <connection>
+   <sender>buttonBox</sender>
+   <signal>rejected()</signal>
+   <receiver>resizeDialog</receiver>
+   <slot>reject()</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>316</x>
+     <y>260</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>286</x>
+     <y>274</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_8</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>39</x>
+     <y>148</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_5</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>150</x>
+     <y>148</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_9</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>267</x>
+     <y>148</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>horizontalSlider</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>156</x>
+     <y>164</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>percentageSpinBox</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>317</x>
+     <y>155</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>checkBoxRoundup</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>184</x>
+     <y>95</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>184</x>
+     <y>117</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_10</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>155</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>55</x>
+     <y>251</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>labelErrorXY</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>155</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>114</x>
+     <y>251</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_4</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>69</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>46</x>
+     <y>95</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>comboBoxSource</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>69</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>94</x>
+     <y>95</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>label_3</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>69</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>188</x>
+     <y>95</y>
+    </hint>
+   </hints>
+  </connection>
+  <connection>
+   <sender>lockArCheckBox</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>comboBoxDestination</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel" >
+     <x>182</x>
+     <y>69</y>
+    </hint>
+    <hint type="destinationlabel" >
+     <x>247</x>
+     <y>95</y>
+    </hint>
+   </hints>
+  </connection>
+ </connections>
+</ui>

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/yadif.conf
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/yadif.conf	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/yadif.conf	2011-08-22 06:09:24 UTC (rev 7439)
@@ -0,0 +1,4 @@
+yadif{
+uint32_t:mode
+uint32_t:order
+}



From mean at mail.berlios.de  Mon Aug 22 08:09:26 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 22 Aug 2011 08:09:26 +0200
Subject: [Avidemux-svn-commit] r7440 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2
Message-ID: <20110822060926.66CDA4815C0@sheep.berlios.de>

Author: mean
Date: 2011-08-22 08:09:26 +0200 (Mon, 22 Aug 2011)
New Revision: 7440

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.h
Log:
[glSample2] Let s make it a rotate

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp	2011-08-22 06:09:24 UTC (rev 7439)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.cpp	2011-08-22 06:09:26 UTC (rev 7440)
@@ -133,8 +133,8 @@
     glProgramY->setUniformValue("myTextureU", 1); 
     glProgramY->setUniformValue("myTextureV", 2); 
     glProgramY->setUniformValue("myTextureY", 0); 
-    glProgramY->setUniformValue("myWidth", image->GetWidth(PLANAR_Y)); 
-    glProgramY->setUniformValue("myHeight", image->GetHeight(PLANAR_Y)); 
+    glProgramY->setUniformValue("myWidth", (GLfloat)image->GetWidth(PLANAR_Y)); 
+    glProgramY->setUniformValue("myHeight", (GLfloat)image->GetHeight(PLANAR_Y)); 
 
     uploadAllPlanes(image);
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.h	2011-08-22 06:09:24 UTC (rev 7439)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/sample_fragment2/sampleGl.h	2011-08-22 06:09:26 UTC (rev 7440)
@@ -9,15 +9,15 @@
     "uniform float teta;\n"
 
 	"void main(void) {\n"
-    "  float mx = gl_TexCoord[0].x;\n"
-	"  float my = gl_TexCoord[0].y;\n"
+    "  float mx = gl_TexCoord[0].x-myWidth/2;\n"
+	"  float my = gl_TexCoord[0].y-myHeight/2;\n"
     "  float c=cos(teta); \n"
     "  float s=sin(teta); \n"
     "  float nx=mx*c-my*s;\n"
     "  float ny=mx*s+my*c;\n"
-    "  vec4 texvalV = texture2DRect(myTextureV, vec2(nx/2,ny/2));\n"
-    "  vec4 texvalU = texture2DRect(myTextureU, vec2(nx/2,ny/2));\n"
-	"  vec4 texvalY = texture2DRect(myTextureY, vec2(nx,ny));\n"
+    "  vec4 texvalV = texture2DRect(myTextureV, vec2(nx/2+myWidth/4,ny/2+myHeight/4));\n"
+    "  vec4 texvalU = texture2DRect(myTextureU, vec2(nx/2+myWidth/4,ny/2+myHeight/4));\n"
+	"  vec4 texvalY = texture2DRect(myTextureY, vec2(nx+myWidth/2,ny+myHeight/2));\n"
 	"  gl_FragColor = vec4(texvalY.r, texvalU.r, texvalV.r, 1.0);\n"
 	"}\n";
 



From mean at mail.berlios.de  Mon Aug 22 08:09:27 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 22 Aug 2011 08:09:27 +0200
Subject: [Avidemux-svn-commit] r7441 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif
Message-ID: <20110822060927.CAF7E4815C0@sheep.berlios.de>

Author: mean
Date: 2011-08-22 08:09:27 +0200 (Mon, 22 Aug 2011)
New Revision: 7441

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.cpp
Log:
[glYadig] Skeleton (working)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/CMakeLists.txt	2011-08-22 06:09:26 UTC (rev 7440)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/CMakeLists.txt	2011-08-22 06:09:27 UTC (rev 7441)
@@ -2,6 +2,6 @@
 INCLUDE(vf_plugin_qt4gl)
 
 
-SET(ADM_vf_glSmooth_SRCS glSmooth.cpp)
-INIT_VIDEO_FILTER_GLQT4(ADM_vf_glSmooth "${ADM_vf_glSmooth_SRCS}" "glSmooth.h" "glSmooth" "${ADM_vf_glSmooth_SRCS}")
+SET(ADM_vf_glYadif_SRCS glYadif.cpp)
+INIT_VIDEO_FILTER_GLQT4(ADM_vf_glYadif "${ADM_vf_glYadif_SRCS}" "glYadif.h" "glYadif" "${ADM_vf_glYadif_SRCS}")
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.cpp	2011-08-22 06:09:26 UTC (rev 7440)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.cpp	2011-08-22 06:09:27 UTC (rev 7441)
@@ -1,5 +1,5 @@
 /** *************************************************************************
-                    \fn       glSmooth Filter.cpp  
+                    \fn       glYadif Filter.cpp  
                     \brief    simple fragment shader
 
     Smoothing filter
@@ -21,10 +21,22 @@
 #define ADM_LEGACY_PROGGY
 #include "ADM_default.h"
 #include "ADM_coreVideoFilterInternal.h"
+#include "DIA_factory.h"
 #include "T_openGL.h"
 #include "T_openGLFilter.h"
-#include "glSmooth.h"
+#include "glYadif.h"
 #include "ADM_clock.h"
+#include "yadif.h"
+#include "yadif_desc.cpp"
+//************************************************
+#define MIN(a,b) ((a) > (b) ? (b) : (a))
+#define MAX(a,b) ((a) < (b) ? (b) : (a))
+#define ABS(a) ((a) > 0 ? (a) : (-(a)))
+
+#define MIN3(a,b,c) MIN(MIN(a,b),c)
+#define MAX3(a,b,c) MAX(MAX(a,b),c)
+
+static void filter_plane(int mode, uint8_t *dst, int dst_stride, const uint8_t *prev0, const uint8_t *cur0, const uint8_t *next0, int refs, int w, int h, int parity, int tff, int mmx);
 /**
 
 */
@@ -34,40 +46,44 @@
 
 
 /**
-    \class glSmooth
+    \class glYadif
 */
-class glSmooth : public  ADM_coreVideoFilterQtGl
+class glYadif : public  ADM_coreVideoFilterQtGl
 {
 protected:
+                    ADMImage    *original;
 
+                    yadif       configuration;
+                    void        updateInfo(void);
+                    bool        getNextFrame2(uint32_t *fn,ADMImage *image);
 protected:
                         bool render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo);
 public:
-                             glSmooth(ADM_coreVideoFilter *previous,CONFcouple *conf);
-                            ~glSmooth();
+                             glYadif(ADM_coreVideoFilter *previous,CONFcouple *conf);
+                            ~glYadif();
 
-        virtual const char   *getConfiguration(void);                   /// Return  current configuration as a human readable string
+        virtual const char   *getConfiguration(void);                 /// Return  current configuration as a human readable string
         virtual bool         getNextFrame(uint32_t *fn,ADMImage *image);    /// Return the next image
         virtual bool         getCoupledConf(CONFcouple **couples) ;   /// Return the current filter configuration
-        virtual bool         configure(void) {return true;}             /// Start graphical user interface
+        virtual bool         configure(void) ;                        /// Start graphical user interface
 };
 
 // Add the hook to make it valid plugin
-DECLARE_VIDEO_FILTER(   glSmooth,   // Class
+DECLARE_VIDEO_FILTER(   glYadif,   // Class
                         1,0,0,              // Version
                         ADM_UI_QT4+ADM_UI_GL,         // UI
                         VF_OPENGL,            // Category
-                        "glSmooth",            // internal name (must be uniq!)
-                        "OpenGl Smooth",            // Display name
-                        "Smooth image while preserving edge." // Description
+                        "glYadif",            // internal name (must be uniq!)
+                        "Yadif (openGl)",            // Display name
+                        "Yet another deinterlacer, using shaders." // Description
                     );
 
 // Now implements the interesting parts
 /**
-    \fn glSmooth
+    \fn glYadif
     \brief constructor
 */
-glSmooth::glSmooth(  ADM_coreVideoFilter *in,CONFcouple *setup) : ADM_coreVideoFilterQtGl(in,setup)
+glYadif::glYadif(  ADM_coreVideoFilter *in,CONFcouple *setup) : ADM_coreVideoFilterQtGl(in,setup)
 {
 UNUSED_ARG(setup);
         widget->makeCurrent();
@@ -95,21 +111,50 @@
         fboY->release();
         widget->doneCurrent();
 
+        original=new ADMImageDefault(in->getInfo()->width,in->getInfo()->height);
+        if(!setup || !ADM_paramLoad(setup,yadif_param,&configuration))
+        {
+            // Default value
+            configuration.mode=0;
+            configuration.order=1;
+        }
+        vidCache = new VideoCache (10, in);
+        updateInfo();
+        myName="yadif";
+
+
 }
 /**
-    \fn glSmooth
+    \fn glYadif
     \brief destructor
 */
-glSmooth::~glSmooth()
+glYadif::~glYadif()
 {
+        delete  original;
+        original=NULL;
+       
+        delete vidCache;
+        vidCache = NULL;
+}
+/**
+    \fn updateInfo
+*/
 
+void glYadif::updateInfo(void)
+{
+   memcpy(&info,previousFilter->getInfo(),sizeof(info)); 
+  if(configuration.mode &1 ) // Bob
+  {
+    info.totalDuration*=2;
+    info.frameIncrement/=2;
+  }
 }
 
 /**
     \fn getFrame
     \brief Get a processed frame
 */
-bool glSmooth::getNextFrame(uint32_t *fn,ADMImage *image)
+bool glYadif::getNextFrame(uint32_t *fn,ADMImage *image)
 {
     // since we do nothing, just get the output of previous filter
     if(false==previousFilter->getNextFrame(fn,image))
@@ -144,30 +189,11 @@
     
     return true;
 }
-/**
-    \fn getCoupledConf
-    \brief Return our current configuration as couple name=value
-*/
-bool         glSmooth::getCoupledConf(CONFcouple **couples)
-{
-    *couples=new CONFcouple(0); // Even if we dont have configuration we must allocate one 
-    return true;
-}
-/**
-    \fn getConfiguration
-    \brief Return current setting as a string
-*/
-const char *glSmooth::getConfiguration(void)
-{
-    
-    return "openGl Sample.";
-}
-
 
 /**
     \fn render
 */
-bool glSmooth::render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo)
+bool glYadif::render(ADMImage *image,ADM_PLANE plane,QGLFramebufferObject *fbo)
 {
     int width=image->GetWidth(plane);
     int height=image->GetHeight(plane);
@@ -191,4 +217,278 @@
 	glEnd();	// draw cube background
     return true;
 }
+/**
+    \fn updateInfo
+*/
+bool glYadif::configure( void) 
+{
+    
+     diaMenuEntry tMode[]={
+                             {0,      QT_TR_NOOP("Temporal & spatial check"),NULL},
+                             {1,   QT_TR_NOOP("Bob, temporal & spatial check"),NULL},
+                             {2,      QT_TR_NOOP("Skip spatial temporal check"),NULL},
+                             {3,  QT_TR_NOOP("Bob, skip spatial temporal check"),NULL}
+          };
+     diaMenuEntry tOrder[]={
+                             {0,      QT_TR_NOOP("Bottom field first"),NULL},
+                             {1,   QT_TR_NOOP("Top field first"),NULL}
+          };
+  
+     diaElemMenu mMode(&(configuration.mode),   QT_TR_NOOP("_Mode:"), 4,tMode);
+     diaElemMenu morder(&(configuration.order),   QT_TR_NOOP("_Order:"), 2,tOrder);
+     
+     diaElem *elems[]={&mMode,&morder};
+     
+     if(diaFactoryRun(QT_TR_NOOP("yadif"),sizeof(elems)/sizeof(diaElem *),elems))
+     {
+        updateInfo();
+        return 1;
+     }
+     return 0;
+}
+/**
+    \fn getCoupledConf
+    \brief Return our current configuration as couple name=value
+*/
+bool         glYadif::getCoupledConf(CONFcouple **couples)
+{
+    return ADM_paramSave(couples, yadif_param,&configuration);
+}
+/**
+    \fn getConfiguration
+    \brief Return current setting as a string
+*/
+const char *glYadif::getConfiguration(void)
+{
+    static char conf[80];
+    conf[0]=0;
+    snprintf(conf,80,"yadif : mode=%d, order=%d\n",
+                (int)configuration.mode, (int)configuration.order);
+    return conf;
+}
+
+/**
+    \fn getConfiguration
+    \brief Return current setting as a string
+*/
+bool glYadif::getNextFrame2(uint32_t *fn,ADMImage *image)
+{
+
+        int mode;
+        int parity;
+        int tff;
+        int iplane;
+        int cpu;
+        int n;
+        ADMImage *src, *dst, * prev, *next;
+        
+    
+        mode = configuration.mode;
+
+        if (mode & 1) 
+        {
+                n = (nextFrame>>1); // bob
+        }
+        else
+                n = nextFrame;
+
+        src = vidCache->getImage(n);
+        *fn=n;
+        if(!src) return false;
+        
+  
+        // If possible get previous image...
+        if (n>0)
+                prev =  vidCache->getImage( n-1); // get previous frame
+        else
+                prev= src; // get very first frame
+
+        ADM_assert(prev);
+        next=vidCache->getImage(n+1);
+        if(!next) next=src;
+        ADM_assert(next);
+        
+        dst = image;
+        dst->copyInfo(src);
+
+        if(!prev || !src || !next)
+        {
+            printf("Failed to read frame for frame %u\n",nextFrame);
+            vidCache->unlockAll();
+            return 0;
+        }
+        
+  // Construct a frame based on the information of the current frame
+  // contained in the "vi" struct.
+#if 0 //MEANX
+        if (configuration.order == -1)
+//		tff = avs_is_tff(&p->vi) == 0 ? 0 : 1; // 0 or 1
+                tff = avs_get_parity(p->child, n) ? 1 : 0; // 0 or 1
+        else
+#endif
+                tff = configuration.order;	
+        
+        parity = (mode & 1) ? (nextFrame & 1) ^ (1^tff) : (tff ^ 1);  // 0 or 1
+
+      //MEANX  cpu = avs_get_cpu_flags(p->env);
+
+        for (iplane = 0; iplane<3; iplane++)
+        {
+                ADM_PLANE plane = (iplane==0) ? PLANAR_Y : (iplane==1) ? PLANAR_U : PLANAR_V;
+
+                const unsigned char* srcp = src->GetWritePtr(plane);
+          // Request a Read pointer from the current source frame
+
+                const unsigned char* prevp0 = prev->GetWritePtr( plane);
+                unsigned char* prevp = (unsigned char*) prevp0; // with same pitch
+          // Request a Read pointer from the prev source frame.
+
+                const unsigned char* nextp0 = next->GetWritePtr( plane);
+                unsigned char* nextp = (unsigned char*) nextp0; // with same pitch
+          // Request a Read pointer from the next source frame.
+
+                unsigned char* dstp = dst->GetWritePtr( plane);
+                // Request a Write pointer from the newly created destination image.
+          // You can request a writepointer to images that have just been
+
+                const int dst_pitch = dst->GetPitch( plane);
+          // Requests pitch (length of a line) of the destination image.
+          // For more information on pitch see: http://www.avisynth.org/index.php?page=WorkingWithImages
+                // (short version - pitch is always equal to or greater than width to allow for seriously fast assembly code)
+
+                const int width =dst->GetPitch( plane);
+          // Requests rowsize (number of used bytes in a line.
+          // See the link above for more information.
+
+                const int height = dst->GetHeight( plane);
+          // Requests the height of the destination image.
+
+                const int src_pitch = src->GetPitch(plane);
+                const int prev_pitch = prev->GetPitch(plane);
+                const int next_pitch = next->GetPitch(plane);
+
+                // in v.0.1-0.3  all source pitches are  assumed equal (for simplicity)
+                                // consider other (rare) case
+                if (prev_pitch != src_pitch)
+                {
+                    prevp = (unsigned char *)ADM_alloc(height*src_pitch);
+                    int h;
+                    for (h=0; h<0; h++)
+                      memcpy(prevp+h*src_pitch, prevp0+h*prev_pitch, width);
+                }
+                    
+                if (next_pitch != src_pitch)
+                {
+                    nextp = (unsigned char *)ADM_alloc(height*src_pitch);
+                    int h;
+                    for (h=0; h<0; h++)
+                      memcpy(nextp+h*src_pitch, nextp0+h*next_pitch, width);
+                }
+                    
+                filter_plane(mode, dstp, dst_pitch, prevp, srcp, nextp, src_pitch, width, height, parity, tff, 0);
+                if (prev_pitch != src_pitch)
+                        ADM_dealloc(prevp);
+                if (next_pitch != src_pitch)
+                        ADM_dealloc(nextp);
+        }
+      vidCache->unlockAll();
+      
+      if (mode & 1) 
+      {
+            if(nextFrame&1)
+                image->Pts+= info.frameIncrement;
+      }
+      //printf("out PTs=%"LLU", nextFrame=%d,inc=%d\n",image->Pts,(int)nextFrame,(int)info.frameIncrement);
+      nextFrame++;
+      
+      return 1;
+}
+
+/**
+    \fn filter_line_c
+*/
+static void filter_line_c(int mode, uint8_t *dst, const uint8_t *prev, const uint8_t *cur, const uint8_t *next, int w, int refs, int parity){
+    int x;
+    const uint8_t *prev2= parity ? prev : cur ;
+    const uint8_t *next2= parity ? cur  : next;
+    for(x=0; x<w; x++){
+        int c= cur[-refs];
+        int d= (prev2[0] + next2[0])>>1;
+        int e= cur[+refs];
+        int temporal_diff0= ABS(prev2[0] - next2[0]);
+        int temporal_diff1=( ABS(prev[-refs] - c) + ABS(prev[+refs] - e) )>>1;
+        int temporal_diff2=( ABS(next[-refs] - c) + ABS(next[+refs] - e) )>>1;
+        int diff= MAX3(temporal_diff0>>1, temporal_diff1, temporal_diff2);
+        int spatial_pred= (c+e)>>1;
+        int spatial_score= ABS(cur[-refs-1] - cur[+refs-1]) + ABS(c-e)
+                         + ABS(cur[-refs+1] - cur[+refs+1]) - 1;
+
+#define CHECK(j)\
+    {   int score= ABS(cur[-refs-1+ j] - cur[+refs-1- j])\
+                 + ABS(cur[-refs  + j] - cur[+refs  - j])\
+                 + ABS(cur[-refs+1+ j] - cur[+refs+1- j]);\
+        if(score < spatial_score){\
+            spatial_score= score;\
+            spatial_pred= (cur[-refs  + j] + cur[+refs  - j])>>1;\
+
+        CHECK(-1) CHECK(-2) }} }}
+        CHECK( 1) CHECK( 2) }} }}
+
+        if(mode<2){
+            int b= (prev2[-2*refs] + next2[-2*refs])>>1;
+            int f= (prev2[+2*refs] + next2[+2*refs])>>1;
+#if 0
+            int a= cur[-3*refs];
+            int g= cur[+3*refs];
+            int max= MAX3(d-e, d-c, MIN3(MAX(b-c,f-e),MAX(b-c,b-a),MAX(f-g,f-e)) );
+            int min= MIN3(d-e, d-c, MAX3(MIN(b-c,f-e),MIN(b-c,b-a),MIN(f-g,f-e)) );
+#else
+            int max= MAX3(d-e, d-c, MIN(b-c, f-e));
+            int min= MIN3(d-e, d-c, MAX(b-c, f-e));
+#endif
+
+            diff= MAX3(diff, min, -max);
+        }
+
+        if(spatial_pred > d + diff)
+           spatial_pred = d + diff;
+        else if(spatial_pred < d - diff)
+           spatial_pred = d - diff;
+
+        dst[0] = spatial_pred;
+
+        dst++;
+        cur++;
+        prev++;
+        next++;
+        prev2++;
+        next2++;
+    }
+}
+/**
+    \fn  filter_plane
+*/
+void filter_plane(int mode, uint8_t *dst, int dst_stride, const uint8_t *prev0, const uint8_t *cur0, const uint8_t *next0, int refs, int w, int h, int parity, int tff, int mmx)
+{
+void (*filter_line)(int mode, uint8_t *dst, const uint8_t *prev, const uint8_t *cur, const uint8_t *next, int w, int refs, int parity);
+	int y;
+	filter_line = filter_line_c;
+
+        memcpy(dst, cur0, w);
+        memcpy(dst + dst_stride, cur0 + refs, w);
+        for(y=2; y<h-1; y++){
+            if(((y ^ parity) & 1)){
+                const uint8_t *prev= prev0 + y*refs;
+                const uint8_t *cur = cur0 + y*refs;
+                const uint8_t *next= next0 + y*refs;
+                uint8_t *dst2= dst + y*dst_stride;
+                filter_line(mode, dst2, prev, cur, next, w, refs, (parity ^ tff));
+            }else{
+                memcpy(dst + y*dst_stride, cur0 + y*refs, w);
+            }
+        }
+        memcpy(dst + (h-1)*dst_stride, cur0 + (h-1)*refs, w);
+
+}
+
 //EOF



From mean at mail.berlios.de  Tue Aug 23 06:49:34 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 23 Aug 2011 06:49:34 +0200
Subject: [Avidemux-svn-commit] r7442 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif
Message-ID: <20110823044934.84058481429@sheep.berlios.de>

Author: mean
Date: 2011-08-23 06:49:34 +0200 (Tue, 23 Aug 2011)
New Revision: 7442

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/yadif.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/yadif_desc.cpp
Log:
[glYadif] Auto gen files

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/yadif.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/yadif.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/yadif.h	2011-08-23 04:49:34 UTC (rev 7442)
@@ -0,0 +1,8 @@
+// automatically generated by admSerialization.py do not edit
+#ifndef ADM_yadif_CONF_H
+#define ADM_yadif_CONF_H
+typedef struct {
+uint32_t mode;
+uint32_t order;
+}yadif;
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/yadif_desc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/yadif_desc.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/yadif_desc.cpp	2011-08-23 04:49:34 UTC (rev 7442)
@@ -0,0 +1,6 @@
+// automatically generated by admSerialization.py, do not edit!
+extern const ADM_paramList yadif_param[]={
+ {"mode",offsetof(yadif,mode),"uint32_t",ADM_param_uint32_t},
+ {"order",offsetof(yadif,order),"uint32_t",ADM_param_uint32_t},
+{NULL,0,NULL}
+};



From gruntster at mail.berlios.de  Tue Aug 23 21:12:25 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 23 Aug 2011 21:12:25 +0200
Subject: [Avidemux-svn-commit] r7443 -
	branches/avidemux_2.6_branch_mean/cmake
Message-ID: <20110823191226.15534480EA9@sheep.berlios.de>

Author: gruntster
Date: 2011-08-23 21:12:25 +0200 (Tue, 23 Aug 2011)
New Revision: 7443

Modified:
   branches/avidemux_2.6_branch_mean/cmake/admFFmpegPrepareTar.cmake
Log:
[ffmpeg] make extraction of ffmpeg sources compatible with MinGW

Modified: branches/avidemux_2.6_branch_mean/cmake/admFFmpegPrepareTar.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admFFmpegPrepareTar.cmake	2011-08-23 04:49:34 UTC (rev 7442)
+++ branches/avidemux_2.6_branch_mean/cmake/admFFmpegPrepareTar.cmake	2011-08-23 19:12:25 UTC (rev 7443)
@@ -2,19 +2,23 @@
 	set(ffmpegExtractOutput OUTPUT_VARIABLE FFMPEG_EXTRACT_OUTPUT)
 endif (NOT VERBOSE)
 
-if (EXISTS "${FFMPEG_ROOT_DIR}/${FFMPEG_SOURCE_ARCHIVE}" AND EXISTS "${FFMPEG_ROOT_DIR}/${SWSCALE_SOURCE_ARCHIVE}")
+if (EXISTS "${FFMPEG_ROOT_DIR}/${FFMPEG_SOURCE_ARCHIVE}")
 	MESSAGE(STATUS "Creating ${FFMPEG_BASE_DIR}")
 	file(MAKE_DIRECTORY "${FFMPEG_BASE_DIR}")
 	if (NOT EXISTS "${FFMPEG_SOURCE_DIR}/ffmpeg.c" OR NOT ${LAST_FFMPEG_VERSION} EQUAL ${FFMPEG_VERSION})
 		find_package(Tar)
 		MESSAGE(STATUS "Unpacking ffmpeg from ${FFMPEG_ROOT_DIR} to ${FFMPEG_BASE_DIR}")
-		execute_process(COMMAND ${TAR_EXECUTABLE} xvf ${FFMPEG_ROOT_DIR}/${FFMPEG_SOURCE_ARCHIVE} -C ${FFMPEG_BASE_DIR}
-					${ffmpegExtractOutput})
 
+		execute_process(COMMAND ${CMAKE_COMMAND} -E copy "${FFMPEG_ROOT_DIR}/${FFMPEG_SOURCE_ARCHIVE}" "${FFMPEG_BASE_DIR}")
+
+		execute_process(COMMAND ${TAR_EXECUTABLE} xvf "${FFMPEG_SOURCE_ARCHIVE}"
+			WORKING_DIRECTORY "${FFMPEG_BASE_DIR}"
+			${ffmpegExtractOutput})
+
 		set(FFMPEG_PERFORM_PATCH 1)
 		set(FFMPEG_PERFORM_BUILD 1)
 	endif (NOT EXISTS "${FFMPEG_SOURCE_DIR}/ffmpeg.c" OR NOT ${LAST_FFMPEG_VERSION} EQUAL ${FFMPEG_VERSION})
 
 	set(FFMPEG_PREPARED 1)
 	set(LAST_FFMPEG_VERSION "${FFMPEG_VERSION}" CACHE STRING "" FORCE)
-endif (EXISTS "${FFMPEG_ROOT_DIR}/${FFMPEG_SOURCE_ARCHIVE}" AND EXISTS "${FFMPEG_ROOT_DIR}/${SWSCALE_SOURCE_ARCHIVE}")
+endif (EXISTS "${FFMPEG_ROOT_DIR}/${FFMPEG_SOURCE_ARCHIVE}")



From gruntster at mail.berlios.de  Tue Aug 23 21:43:20 2011
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Tue, 23 Aug 2011 21:43:20 +0200
Subject: [Avidemux-svn-commit] r7444 -
	branches/avidemux_2.6_branch_mean/cmake
Message-ID: <20110823194320.DEF0C481429@sheep.berlios.de>

Author: gruntster
Date: 2011-08-23 21:43:20 +0200 (Tue, 23 Aug 2011)
New Revision: 7444

Added:
   branches/avidemux_2.6_branch_mean/cmake/FindOpenGL.cmake
   branches/avidemux_2.6_branch_mean/cmake/FindPackageHandleStandardArgs.cmake
Log:
[mingw] detect Open GL include dir when using MinGW

Added: branches/avidemux_2.6_branch_mean/cmake/FindOpenGL.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/FindOpenGL.cmake	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/cmake/FindOpenGL.cmake	2011-08-23 19:43:20 UTC (rev 7444)
@@ -0,0 +1,160 @@
+# - Try to find OpenGL
+# Once done this will define
+#  
+#  OPENGL_FOUND        - system has OpenGL
+#  OPENGL_XMESA_FOUND  - system has XMESA
+#  OPENGL_GLU_FOUND    - system has GLU
+#  OPENGL_INCLUDE_DIR  - the GL include directory
+#  OPENGL_LIBRARIES    - Link these to use OpenGL and GLU
+#   
+# If you want to use just GL you can use these values
+#  OPENGL_gl_LIBRARY   - Path to OpenGL Library
+#  OPENGL_glu_LIBRARY  - Path to GLU Library
+#  
+# On OSX default to using the framework version of opengl
+# People will have to change the cache values of OPENGL_glu_LIBRARY 
+# and OPENGL_gl_LIBRARY to use OpenGL with X11 on OSX
+
+#=============================================================================
+# Copyright 2001-2009 Kitware, Inc.
+#
+# Distributed under the OSI-approved BSD License (the "License");
+# see accompanying file Copyright.txt for details.
+#
+# This software is distributed WITHOUT ANY WARRANTY; without even the
+# implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
+# See the License for more information.
+#=============================================================================
+# (To distribute this file outside of CMake, substitute the full
+#  License text for the above reference.)
+
+IF (WIN32)
+  FIND_PATH(OPENGL_INCLUDE_DIR GL/gl.h )
+
+  IF (CYGWIN)
+
+    FIND_LIBRARY(OPENGL_gl_LIBRARY opengl32 )
+
+    FIND_LIBRARY(OPENGL_glu_LIBRARY glu32 )
+
+  ELSE (CYGWIN)
+
+    IF(BORLAND)
+      SET (OPENGL_gl_LIBRARY import32 CACHE STRING "OpenGL library for win32")
+      SET (OPENGL_glu_LIBRARY import32 CACHE STRING "GLU library for win32")
+    ELSE(BORLAND)
+      SET (OPENGL_gl_LIBRARY opengl32 CACHE STRING "OpenGL library for win32")
+      SET (OPENGL_glu_LIBRARY glu32 CACHE STRING "GLU library for win32")
+    ENDIF(BORLAND)
+
+  ENDIF (CYGWIN)
+
+ELSE (WIN32)
+
+  IF (APPLE)
+
+    FIND_LIBRARY(OPENGL_gl_LIBRARY OpenGL DOC "OpenGL lib for OSX")
+    FIND_LIBRARY(OPENGL_glu_LIBRARY AGL DOC "AGL lib for OSX")
+    FIND_PATH(OPENGL_INCLUDE_DIR OpenGL/gl.h DOC "Include for OpenGL on OSX")
+
+  ELSE(APPLE)
+    # Handle HP-UX cases where we only want to find OpenGL in either hpux64
+    # or hpux32 depending on if we're doing a 64 bit build.
+    IF(CMAKE_SIZEOF_VOID_P EQUAL 4)
+      SET(HPUX_IA_OPENGL_LIB_PATH /opt/graphics/OpenGL/lib/hpux32/)
+    ELSE(CMAKE_SIZEOF_VOID_P EQUAL 4)
+      SET(HPUX_IA_OPENGL_LIB_PATH 
+        /opt/graphics/OpenGL/lib/hpux64/
+        /opt/graphics/OpenGL/lib/pa20_64)
+    ENDIF(CMAKE_SIZEOF_VOID_P EQUAL 4)
+
+    # The first line below is to make sure that the proper headers
+    # are used on a Linux machine with the NVidia drivers installed.
+    # They replace Mesa with NVidia's own library but normally do not
+    # install headers and that causes the linking to
+    # fail since the compiler finds the Mesa headers but NVidia's library.
+    # Make sure the NVIDIA directory comes BEFORE the others.
+    #  - Atanas Georgiev <atanas at cs.columbia.edu>
+
+    FIND_PATH(OPENGL_INCLUDE_DIR GL/gl.h
+      /usr/share/doc/NVIDIA_GLX-1.0/include
+      /usr/openwin/share/include
+      /opt/graphics/OpenGL/include /usr/X11R6/include
+    )
+
+    FIND_PATH(OPENGL_xmesa_INCLUDE_DIR GL/xmesa.h
+      /usr/share/doc/NVIDIA_GLX-1.0/include
+      /usr/openwin/share/include
+      /opt/graphics/OpenGL/include /usr/X11R6/include
+    )
+
+    FIND_LIBRARY(OPENGL_gl_LIBRARY
+      NAMES GL MesaGL
+      PATHS /opt/graphics/OpenGL/lib
+            /usr/openwin/lib
+            /usr/shlib /usr/X11R6/lib
+            ${HPUX_IA_OPENGL_LIB_PATH}
+    )
+
+    # On Unix OpenGL most certainly always requires X11.
+    # Feel free to tighten up these conditions if you don't 
+    # think this is always true.
+    # It's not true on OSX.
+
+    IF (OPENGL_gl_LIBRARY)
+      IF(NOT X11_FOUND)
+        INCLUDE(FindX11)
+      ENDIF(NOT X11_FOUND)
+      IF (X11_FOUND)
+        IF (NOT APPLE)
+          SET (OPENGL_LIBRARIES ${X11_LIBRARIES})
+        ENDIF (NOT APPLE)
+      ENDIF (X11_FOUND)
+    ENDIF (OPENGL_gl_LIBRARY)
+
+    FIND_LIBRARY(OPENGL_glu_LIBRARY
+      NAMES GLU MesaGLU
+      PATHS ${OPENGL_gl_LIBRARY}
+            /opt/graphics/OpenGL/lib
+            /usr/openwin/lib
+            /usr/shlib /usr/X11R6/lib
+    )
+
+  ENDIF(APPLE)
+ENDIF (WIN32)
+
+IF(OPENGL_gl_LIBRARY)
+
+    IF(OPENGL_xmesa_INCLUDE_DIR)
+      SET( OPENGL_XMESA_FOUND "YES" )
+    ELSE(OPENGL_xmesa_INCLUDE_DIR)
+      SET( OPENGL_XMESA_FOUND "NO" )
+    ENDIF(OPENGL_xmesa_INCLUDE_DIR)
+
+    SET( OPENGL_LIBRARIES  ${OPENGL_gl_LIBRARY} ${OPENGL_LIBRARIES})
+    IF(OPENGL_glu_LIBRARY)
+      SET( OPENGL_GLU_FOUND "YES" )
+      SET( OPENGL_LIBRARIES ${OPENGL_glu_LIBRARY} ${OPENGL_LIBRARIES} )
+    ELSE(OPENGL_glu_LIBRARY)
+      SET( OPENGL_GLU_FOUND "NO" )
+    ENDIF(OPENGL_glu_LIBRARY)
+
+    # This deprecated setting is for backward compatibility with CMake1.4
+    SET (OPENGL_LIBRARY ${OPENGL_LIBRARIES})
+
+ENDIF(OPENGL_gl_LIBRARY)
+
+# This deprecated setting is for backward compatibility with CMake1.4
+SET(OPENGL_INCLUDE_PATH ${OPENGL_INCLUDE_DIR})
+
+# handle the QUIETLY and REQUIRED arguments and set OPENGL_FOUND to TRUE if
+# all listed variables are TRUE
+INCLUDE(${CMAKE_CURRENT_LIST_DIR}/FindPackageHandleStandardArgs.cmake)
+FIND_PACKAGE_HANDLE_STANDARD_ARGS(OpenGL DEFAULT_MSG OPENGL_gl_LIBRARY)
+
+MARK_AS_ADVANCED(
+  OPENGL_INCLUDE_DIR
+  OPENGL_xmesa_INCLUDE_DIR
+  OPENGL_glu_LIBRARY
+  OPENGL_gl_LIBRARY
+)

Added: branches/avidemux_2.6_branch_mean/cmake/FindPackageHandleStandardArgs.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/FindPackageHandleStandardArgs.cmake	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/cmake/FindPackageHandleStandardArgs.cmake	2011-08-23 19:43:20 UTC (rev 7444)
@@ -0,0 +1,260 @@
+# FIND_PACKAGE_HANDLE_STANDARD_ARGS(<name> ... )
+#
+# This function is intended to be used in FindXXX.cmake modules files.
+# It handles the REQUIRED, QUIET and version-related arguments to FIND_PACKAGE().
+# It also sets the <UPPERCASED_NAME>_FOUND variable.
+# The package is considered found if all variables <var1>... listed contain
+# valid results, e.g. valid filepaths.
+#
+# There are two modes of this function. The first argument in both modes is
+# the name of the Find-module where it is called (in original casing).
+#
+# The first simple mode looks like this:
+#    FIND_PACKAGE_HANDLE_STANDARD_ARGS(<name> (DEFAULT_MSG|"Custom failure message") <var1>...<varN> )
+# If the variables <var1> to <varN> are all valid, then <UPPERCASED_NAME>_FOUND
+# will be set to TRUE.
+# If DEFAULT_MSG is given as second argument, then the function will generate
+# itself useful success and error messages. You can also supply a custom error message
+# for the failure case. This is not recommended.
+#
+# The second mode is more powerful and also supports version checking:
+#    FIND_PACKAGE_HANDLE_STANDARD_ARGS(NAME [REQUIRED_VARS <var1>...<varN>]
+#                                           [VERSION_VAR   <versionvar>
+#                                           [CONFIG_MODE]
+#                                           [FAIL_MESSAGE "Custom failure message"] )
+#
+# As above, if <var1> through <varN> are all valid, <UPPERCASED_NAME>_FOUND
+# will be set to TRUE.
+# After REQUIRED_VARS the variables which are required for this package are listed.
+# Following VERSION_VAR the name of the variable can be specified which holds
+# the version of the package which has been found. If this is done, this version
+# will be checked against the (potentially) specified required version used
+# in the find_package() call. The EXACT keyword is also handled. The default
+# messages include information about the required version and the version
+# which has been actually found, both if the version is ok or not.
+# Use the option CONFIG_MODE if your FindXXX.cmake module is a wrapper for
+# a find_package(... NO_MODULE) call, in this case all the information
+# provided by the config-mode of find_package() will be evaluated
+# automatically.
+# Via FAIL_MESSAGE a custom failure message can be specified, if this is not
+# used, the default message will be displayed.
+#
+# Example for mode 1:
+#
+#    FIND_PACKAGE_HANDLE_STANDARD_ARGS(LibXml2  DEFAULT_MSG  LIBXML2_LIBRARY LIBXML2_INCLUDE_DIR)
+#
+# LibXml2 is considered to be found, if both LIBXML2_LIBRARY and
+# LIBXML2_INCLUDE_DIR are valid. Then also LIBXML2_FOUND is set to TRUE.
+# If it is not found and REQUIRED was used, it fails with FATAL_ERROR,
+# independent whether QUIET was used or not.
+# If it is found, success will be reported, including the content of <var1>.
+# On repeated Cmake runs, the same message won't be printed again.
+#
+# Example for mode 2:
+#
+#    FIND_PACKAGE_HANDLE_STANDARD_ARGS(BISON  REQUIRED_VARS BISON_EXECUTABLE
+#                                             VERSION_VAR BISON_VERSION)
+# In this case, BISON is considered to be found if the variable(s) listed
+# after REQUIRED_VAR are all valid, i.e. BISON_EXECUTABLE in this case.
+# Also the version of BISON will be checked by using the version contained
+# in BISON_VERSION.
+# Since no FAIL_MESSAGE is given, the default messages will be printed.
+#
+# Another example for mode 2:
+#
+#    FIND_PACKAGE(Automoc4 QUIET NO_MODULE HINTS /opt/automoc4)
+#    FIND_PACKAGE_HANDLE_STANDARD_ARGS(Automoc4  CONFIG_MODE)
+# In this case, FindAutmoc4.cmake wraps a call to FIND_PACKAGE(Automoc4 NO_MODULE)
+# and adds an additional search directory for automoc4.
+# The following FIND_PACKAGE_HANDLE_STANDARD_ARGS() call produces a proper
+# success/error message.
+
+#=============================================================================
+# Copyright 2007-2009 Kitware, Inc.
+#
+# Distributed under the OSI-approved BSD License (the "License");
+# see accompanying file Copyright.txt for details.
+#
+# This software is distributed WITHOUT ANY WARRANTY; without even the
+# implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
+# See the License for more information.
+#=============================================================================
+# (To distribute this file outside of CMake, substitute the full
+#  License text for the above reference.)
+
+INCLUDE(FindPackageMessage)
+INCLUDE(CMakeParseArguments)
+
+# internal helper macro
+MACRO(_FPHSA_FAILURE_MESSAGE _msg)
+  IF (${_NAME}_FIND_REQUIRED)
+    MESSAGE(FATAL_ERROR "${_msg}")
+  ELSE (${_NAME}_FIND_REQUIRED)
+    IF (NOT ${_NAME}_FIND_QUIETLY)
+      MESSAGE(STATUS "${_msg}")
+    ENDIF (NOT ${_NAME}_FIND_QUIETLY)
+  ENDIF (${_NAME}_FIND_REQUIRED)
+ENDMACRO(_FPHSA_FAILURE_MESSAGE _msg)
+
+
+# internal helper macro to generate the failure message when used in CONFIG_MODE:
+MACRO(_FPHSA_HANDLE_FAILURE_CONFIG_MODE)
+  # <name>_CONFIG is set, but FOUND is false, this means that some other of the REQUIRED_VARS was not found:
+  IF(${_NAME}_CONFIG)
+    _FPHSA_FAILURE_MESSAGE("${FPHSA_FAIL_MESSAGE}: missing: ${MISSING_VARS} (found ${${_NAME}_CONFIG} ${VERSION_MSG})")
+  ELSE(${_NAME}_CONFIG)
+    # If _CONSIDERED_CONFIGS is set, the config-file has been found, but no suitable version.
+    # List them all in the error message:
+    IF(${_NAME}_CONSIDERED_CONFIGS)
+      SET(configsText "")
+      LIST(LENGTH ${_NAME}_CONSIDERED_CONFIGS configsCount)
+      MATH(EXPR configsCount "${configsCount} - 1")
+      FOREACH(currentConfigIndex RANGE ${configsCount})
+        LIST(GET ${_NAME}_CONSIDERED_CONFIGS ${currentConfigIndex} filename)
+        LIST(GET ${_NAME}_CONSIDERED_VERSIONS ${currentConfigIndex} version)
+        SET(configsText "${configsText}    ${filename} (version ${version})\n")
+      ENDFOREACH(currentConfigIndex)
+      _FPHSA_FAILURE_MESSAGE("${FPHSA_FAIL_MESSAGE} ${VERSION_MSG}, checked the following files:\n${configsText}")
+
+    ELSE(${_NAME}_CONSIDERED_CONFIGS)
+      # Simple case: No Config-file was found at all:
+      _FPHSA_FAILURE_MESSAGE("${FPHSA_FAIL_MESSAGE}: found neither ${_NAME}Config.cmake nor ${_NAME_LOWER}-config.cmake ${VERSION_MSG}")
+    ENDIF(${_NAME}_CONSIDERED_CONFIGS)
+  ENDIF(${_NAME}_CONFIG)
+ENDMACRO(_FPHSA_HANDLE_FAILURE_CONFIG_MODE)
+
+
+FUNCTION(FIND_PACKAGE_HANDLE_STANDARD_ARGS _NAME _FIRST_ARG)
+
+# set up the arguments for CMAKE_PARSE_ARGUMENTS and check whether we are in
+# new extended or in the "old" mode:
+  SET(options CONFIG_MODE)
+  SET(oneValueArgs FAIL_MESSAGE VERSION_VAR)
+  SET(multiValueArgs REQUIRED_VARS)
+  SET(_KEYWORDS_FOR_EXTENDED_MODE  ${options} ${oneValueArgs} ${multiValueArgs} )
+  LIST(FIND _KEYWORDS_FOR_EXTENDED_MODE "${_FIRST_ARG}" INDEX)
+
+  IF(${INDEX} EQUAL -1)
+    SET(FPHSA_FAIL_MESSAGE ${_FIRST_ARG})
+    SET(FPHSA_REQUIRED_VARS ${ARGN})
+    SET(FPHSA_VERSION_VAR)
+  ELSE(${INDEX} EQUAL -1)
+
+    CMAKE_PARSE_ARGUMENTS(FPHSA "${options}" "${oneValueArgs}" "${multiValueArgs}"  ${_FIRST_ARG} ${ARGN})
+
+    IF(FPHSA_UNPARSED_ARGUMENTS)
+      MESSAGE(FATAL_ERROR "Unknown keywords given to FIND_PACKAGE_HANDLE_STANDARD_ARGS(): \"${FPHSA_UNPARSED_ARGUMENTS}\"")
+    ENDIF(FPHSA_UNPARSED_ARGUMENTS)
+
+    IF(NOT FPHSA_FAIL_MESSAGE)
+      SET(FPHSA_FAIL_MESSAGE  "DEFAULT_MSG")
+    ENDIF(NOT FPHSA_FAIL_MESSAGE)
+  ENDIF(${INDEX} EQUAL -1)
+
+# now that we collected all arguments, process them
+
+  IF("${FPHSA_FAIL_MESSAGE}" STREQUAL "DEFAULT_MSG")
+    SET(FPHSA_FAIL_MESSAGE "Could NOT find ${_NAME}")
+  ENDIF("${FPHSA_FAIL_MESSAGE}" STREQUAL "DEFAULT_MSG")
+
+  # In config-mode, we rely on the variable <package>_CONFIG, which is set by find_package()
+  # when it successfully found the config-file, including version checking:
+  IF(FPHSA_CONFIG_MODE)
+    LIST(INSERT FPHSA_REQUIRED_VARS 0 ${_NAME}_CONFIG)
+    LIST(REMOVE_DUPLICATES FPHSA_REQUIRED_VARS)
+    SET(FPHSA_VERSION_VAR ${_NAME}_VERSION)
+  ENDIF(FPHSA_CONFIG_MODE)
+
+  IF(NOT FPHSA_REQUIRED_VARS)
+    MESSAGE(FATAL_ERROR "No REQUIRED_VARS specified for FIND_PACKAGE_HANDLE_STANDARD_ARGS()")
+  ENDIF(NOT FPHSA_REQUIRED_VARS)
+
+  LIST(GET FPHSA_REQUIRED_VARS 0 _FIRST_REQUIRED_VAR)
+
+  STRING(TOUPPER ${_NAME} _NAME_UPPER)
+  STRING(TOLOWER ${_NAME} _NAME_LOWER)
+
+  # collect all variables which were not found, so they can be printed, so the
+  # user knows better what went wrong (#6375)
+  SET(MISSING_VARS "")
+  SET(DETAILS "")
+  SET(${_NAME_UPPER}_FOUND TRUE)
+  # check if all passed variables are valid
+  FOREACH(_CURRENT_VAR ${FPHSA_REQUIRED_VARS})
+    IF(NOT ${_CURRENT_VAR})
+      SET(${_NAME_UPPER}_FOUND FALSE)
+      SET(MISSING_VARS "${MISSING_VARS} ${_CURRENT_VAR}")
+    ELSE(NOT ${_CURRENT_VAR})
+      SET(DETAILS "${DETAILS}[${${_CURRENT_VAR}}]")
+    ENDIF(NOT ${_CURRENT_VAR})
+  ENDFOREACH(_CURRENT_VAR)
+
+
+  # version handling:
+  SET(VERSION_MSG "")
+  SET(VERSION_OK TRUE)
+  SET(VERSION ${${FPHSA_VERSION_VAR}} )
+  IF (${_NAME}_FIND_VERSION)
+
+    IF(VERSION)
+
+      IF(${_NAME}_FIND_VERSION_EXACT)       # exact version required
+        IF (NOT "${${_NAME}_FIND_VERSION}" VERSION_EQUAL "${VERSION}")
+          SET(VERSION_MSG "Found unsuitable version \"${VERSION}\", but required is exact version \"${${_NAME}_FIND_VERSION}\"")
+          SET(VERSION_OK FALSE)
+        ELSE (NOT "${${_NAME}_FIND_VERSION}" VERSION_EQUAL "${VERSION}")
+          SET(VERSION_MSG "(found suitable exact version \"${VERSION}\")")
+        ENDIF (NOT "${${_NAME}_FIND_VERSION}" VERSION_EQUAL "${VERSION}")
+
+      ELSE(${_NAME}_FIND_VERSION_EXACT)     # minimum version specified:
+        IF ("${${_NAME}_FIND_VERSION}" VERSION_GREATER "${VERSION}")
+          SET(VERSION_MSG "Found unsuitable version \"${VERSION}\", but required is at least \"${${_NAME}_FIND_VERSION}\"")
+          SET(VERSION_OK FALSE)
+        ELSE ("${${_NAME}_FIND_VERSION}" VERSION_GREATER "${VERSION}")
+          SET(VERSION_MSG "(found suitable version \"${VERSION}\", required is \"${${_NAME}_FIND_VERSION}\")")
+        ENDIF ("${${_NAME}_FIND_VERSION}" VERSION_GREATER "${VERSION}")
+      ENDIF(${_NAME}_FIND_VERSION_EXACT)
+
+    ELSE(VERSION)
+
+      # if the package was not found, but a version was given, add that to the output:
+      IF(${_NAME}_FIND_VERSION_EXACT)
+         SET(VERSION_MSG "(Required is exact version \"${${_NAME}_FIND_VERSION}\")")
+      ELSE(${_NAME}_FIND_VERSION_EXACT)
+         SET(VERSION_MSG "(Required is at least version \"${${_NAME}_FIND_VERSION}\")")
+      ENDIF(${_NAME}_FIND_VERSION_EXACT)
+
+    ENDIF(VERSION)
+  ELSE (${_NAME}_FIND_VERSION)
+    IF(VERSION)
+      SET(VERSION_MSG "(found version \"${VERSION}\")")
+    ENDIF(VERSION)
+  ENDIF (${_NAME}_FIND_VERSION)
+
+  IF(VERSION_OK)
+    SET(DETAILS "${DETAILS}[v${VERSION}(${${_NAME}_FIND_VERSION})]")
+  ELSE(VERSION_OK)
+    SET(${_NAME_UPPER}_FOUND FALSE)
+  ENDIF(VERSION_OK)
+
+
+  # print the result:
+  IF (${_NAME_UPPER}_FOUND)
+    FIND_PACKAGE_MESSAGE(${_NAME} "Found ${_NAME}: ${${_FIRST_REQUIRED_VAR}} ${VERSION_MSG}" "${DETAILS}")
+  ELSE (${_NAME_UPPER}_FOUND)
+
+    IF(FPHSA_CONFIG_MODE)
+      _FPHSA_HANDLE_FAILURE_CONFIG_MODE()
+    ELSE(FPHSA_CONFIG_MODE)
+      IF(NOT VERSION_OK)
+        _FPHSA_FAILURE_MESSAGE("${FPHSA_FAIL_MESSAGE}: ${VERSION_MSG} (found ${${_FIRST_REQUIRED_VAR}})")
+      ELSE(NOT VERSION_OK)
+        _FPHSA_FAILURE_MESSAGE("${FPHSA_FAIL_MESSAGE} (missing: ${MISSING_VARS}) ${VERSION_MSG}")
+      ENDIF(NOT VERSION_OK)
+    ENDIF(FPHSA_CONFIG_MODE)
+
+  ENDIF (${_NAME_UPPER}_FOUND)
+
+  SET(${_NAME_UPPER}_FOUND ${${_NAME_UPPER}_FOUND} PARENT_SCOPE)
+
+ENDFUNCTION(FIND_PACKAGE_HANDLE_STANDARD_ARGS _FIRST_ARG)



From mean at mail.berlios.de  Fri Aug 26 08:04:25 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 26 Aug 2011 08:04:25 +0200
Subject: [Avidemux-svn-commit] r7445 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif
Message-ID: <20110826060425.D1BA6480B11@sheep.berlios.de>

Author: mean
Date: 2011-08-26 08:04:25 +0200 (Fri, 26 Aug 2011)
New Revision: 7445

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.h
Log:
[glYadif] Begin the shader...

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.cpp	2011-08-23 19:43:20 UTC (rev 7444)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.cpp	2011-08-26 06:04:25 UTC (rev 7445)
@@ -149,44 +149,77 @@
     info.frameIncrement/=2;
   }
 }
-
 /**
     \fn getFrame
     \brief Get a processed frame
 */
 bool glYadif::getNextFrame(uint32_t *fn,ADMImage *image)
 {
-    // since we do nothing, just get the output of previous filter
-    if(false==previousFilter->getNextFrame(fn,image))
+    ADMImage *src, *dst, * prev, *next;
+    int mode = configuration.mode;
+    int n;
+    if (mode & 1) 
+                n = (nextFrame>>1); // bob
+    else
+                n = nextFrame;
+
+    src = vidCache->getImage(n);
+    *fn=n;
+    if(!src) return false;  
+    // If possible get previous image...
+    if (n>0)
+            prev =  vidCache->getImage( n-1); // get previous frame
+    else
+            prev= src; // get very first frame
+
+    ADM_assert(prev);
+    next=vidCache->getImage(n+1);
+    if(!next) next=src;
+    ADM_assert(next);
+    
+    dst = image;
+    dst->copyInfo(src);
+
+    if(!prev || !src || !next)
     {
-        ADM_warning("FlipFilter : Cannot get frame\n");
+        printf("Failed to read frame for frame %u\n",nextFrame);
+        vidCache->unlockAll();
         return false;
     }
+
+
     widget->makeCurrent();
     glPushMatrix();
     // size is the last one...
     fboY->bind();
 
-    float angle=*fn;
-    angle=angle/40;
-    glProgramY->setUniformValue("teta", angle);     
-    glProgramY->setUniformValue("myTextureU", 1); 
-    glProgramY->setUniformValue("myTextureV", 2); 
-    glProgramY->setUniformValue("myTextureY", 0); 
+    glProgramY->setUniformValue("myTexturePrev", 0); 
+    glProgramY->setUniformValue("myTextureCur",  1); 
+    glProgramY->setUniformValue("myTextureNext", 2); 
     glProgramY->setUniformValue("myWidth", image->GetWidth(PLANAR_Y)); 
     glProgramY->setUniformValue("myHeight", image->GetHeight(PLANAR_Y)); 
 
-    uploadAllPlanes(image);
+    int tff = configuration.order;	
+    int parity = (mode & 1) ? (nextFrame & 1) ^ (1^tff) : (tff ^ 1); 
+    glProgramY->setUniformValue("myParity", parity); 
 
+    // upload the 3 Y Plane ..
+    uploadOnePlane(prev,PLANAR_Y,GL_TEXTURE0+0,texName[0]);
+    uploadOnePlane(src, PLANAR_Y,GL_TEXTURE0+1,texName[1]);
+    uploadOnePlane(next,PLANAR_Y,GL_TEXTURE0+2,texName[2]);
+
     render(image,PLANAR_Y,fboY);
 
-    downloadTextures(image,fboY);
+    downloadTexture(image,PLANAR_Y,fboY);
 
     fboY->release();
     firstRun=false;
     glPopMatrix();
     widget->doneCurrent();
     
+    ADMImage::copyPlane(src,image,PLANAR_U);
+    ADMImage::copyPlane(src,image,PLANAR_V);
+
     return true;
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.h	2011-08-23 19:43:20 UTC (rev 7444)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.h	2011-08-26 06:04:25 UTC (rev 7445)
@@ -1,31 +1,16 @@
-// Invert x & y
+//
 static const char *myShaderY =
 	"#extension GL_ARB_texture_rectangle: enable\n"
-	"uniform sampler2DRect myTextureY;\n" // tex unit 0
-    "uniform sampler2DRect myTextureU;\n" // tex unit 1
-    "uniform sampler2DRect myTextureV;\n" // tex unit 2
+	"uniform sampler2DRect myTexturePrev;\n" // tex unit 0
+    "uniform sampler2DRect myTextureCur;\n" // tex unit 1
+    "uniform sampler2DRect myTextureNext;\n" // tex unit 2
     "uniform float myWidth;\n"
     "uniform float myHeight;\n"
-    "uniform float teta;\n"
+    "uniform int   myParity;\n"
 
 	"void main(void) {\n"
-    "  float mmin=255,mmax=0,r;\n"
     "  float nx = gl_TexCoord[0].x;\n"
 	"  float ny = gl_TexCoord[0].y;\n"
-    "  vec4 texvalV = vec4(0,0,0,0);\n"
-    "  vec4 texvalU = vec4(0,0,0,0);\n"
-	"  vec4 texvalY = vec4(0,0,0,0);\n"
-    "  int x=0,y=0;\n"
-    "  for(y=-1;y<2;y++)\n"
-    "   for(x=-1;x<2;x++)\n"
-    "  { \n"
-    "   r=texture2DRect(myTextureY, vec2(x+nx,y+ny));\n"
-    "   texvalV += texture2DRect(myTextureV, vec2(x+nx/2,y+ny/2));\n"
-    "   texvalU += texture2DRect(myTextureU, vec2(x+nx/2,y+ny/2));\n"
-	"   texvalY += r;\n"
-    "  }"
-    "  float t=texvalY.r/9;\n"
-    "  r=t;"
-	"  gl_FragColor = vec4(r, texvalU.r/9, texvalV.r/9, 1.0);\n"
+	"  gl_FragColor = texture2DRect(myTextureCur,vec2(nx,ny));\n"
 	"}\n";
 



From mean at mail.berlios.de  Fri Aug 26 08:04:43 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 26 Aug 2011 08:04:43 +0200
Subject: [Avidemux-svn-commit] r7446 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif
Message-ID: <20110826060443.D6E86480B11@sheep.berlios.de>

Author: mean
Date: 2011-08-26 08:04:43 +0200 (Fri, 26 Aug 2011)
New Revision: 7446

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.h
Log:
[glYadif] Dummy shader, process one line out of two

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.h	2011-08-26 06:04:25 UTC (rev 7445)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoFilters6_openGl/glYadif/glYadif.h	2011-08-26 06:04:43 UTC (rev 7446)
@@ -1,6 +1,7 @@
 //
 static const char *myShaderY =
 	"#extension GL_ARB_texture_rectangle: enable\n"
+    "#extension GL_EXT_gpu_shader4 : enable\n"
 	"uniform sampler2DRect myTexturePrev;\n" // tex unit 0
     "uniform sampler2DRect myTextureCur;\n" // tex unit 1
     "uniform sampler2DRect myTextureNext;\n" // tex unit 2
@@ -11,6 +12,16 @@
 	"void main(void) {\n"
     "  float nx = gl_TexCoord[0].x;\n"
 	"  float ny = gl_TexCoord[0].y;\n"
-	"  gl_FragColor = texture2DRect(myTextureCur,vec2(nx,ny));\n"
+    "  int lineno=ny;\n"
+    "  int odd=lineno&1;\n"
+    "  if(odd)\n"
+    "  {  \n"
+    "           gl_FragColor = texture2DRect(myTextureCur,vec2(nx,ny));\n"
+    "  }  \n"
+    "  else \n"
+    " {\n"
+    "           gl_FragColor = vec4(0,0,0,0);\n"
+    " }\n"
+	
 	"}\n";
 



From mean at mail.berlios.de  Fri Aug 26 08:05:21 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Fri, 26 Aug 2011 08:05:21 +0200
Subject: [Avidemux-svn-commit] r7448 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2
Message-ID: <20110826060521.C122F480B11@sheep.berlios.de>

Author: mean
Date: 2011-08-26 08:05:21 +0200 (Fri, 26 Aug 2011)
New Revision: 7448

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.cpp
Log:
[mp4v2] dont recompute bitrate

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.cpp	2011-08-26 06:04:58 UTC (rev 7447)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.cpp	2011-08-26 06:05:21 UTC (rev 7448)
@@ -35,6 +35,9 @@
 
 #endif
 
+#define ADM_MP4_OPTIONS_OPEN  (MP4_CREATE_64BIT_DATA)
+#define ADM_MP4_OPTIONS_CLOSE (MP4_CLOSE_DO_NOT_COMPUTE_BITRATE )
+
 mp4v2_muxer muxerConfig=
 {
    1, // uint32_t optimize;
@@ -146,7 +149,7 @@
 //------Verify everything is ok : Accept Mp4 & H264 for video, AAC for audio ----
         
         // Create file
-        handle=MP4Create( file,  MP4_CREATE_64BIT_DATA);
+        handle=MP4Create( file,  ADM_MP4_OPTIONS_OPEN);
         if(MP4_INVALID_FILE_HANDLE==handle)
         {
             ADM_error("[mp4v2]Cannot create output file %s\n",file);
@@ -277,7 +280,7 @@
 {
     if(handle)
     {
-            MP4Close(handle);
+            MP4Close(handle,ADM_MP4_OPTIONS_CLOSE);
 #warning run MP4Optimize
     }
     handle=NULL;



From mean at mail.berlios.de  Sat Aug 27 08:49:04 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Aug 2011 08:49:04 +0200
Subject: [Avidemux-svn-commit] r7449 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/include/mp4v2
Message-ID: <20110827064904.588A748115E@sheep.berlios.de>

Author: mean
Date: 2011-08-27 08:49:03 +0200 (Sat, 27 Aug 2011)
New Revision: 7449

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/include/mp4v2/platform.h
Log:
[mp4v2] Remove DLL_EXPRT, we dont need it

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/include/mp4v2/platform.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/include/mp4v2/platform.h	2011-08-26 06:05:21 UTC (rev 7448)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/include/mp4v2/platform.h	2011-08-27 06:49:03 UTC (rev 7449)
@@ -25,7 +25,7 @@
         #include <stdint.h>
     #endif
 #endif
-
+#if 0 // MEANX
 #if defined( _WIN32 ) || defined( __MINGW32__ )
 #   if defined( MP4V2_EXPORTS )
 #       define MP4V2_EXPORT __declspec(dllexport)
@@ -37,7 +37,15 @@
 #else
 #   define MP4V2_EXPORT __attribute__((visibility("default")))
 #endif
+#else
+        #if defined( _WIN32 ) || defined( __MINGW32__ )
+                #       define MP4V2_EXPORT
+        #else
+                #   define MP4V2_EXPORT __attribute__((visibility("default")))
+        #endif
 
+#endif
+
 #if defined( __GNUC__ )
 #   define MP4V2_DEPRECATED __attribute__((deprecated))
 #else



From mean at mail.berlios.de  Sat Aug 27 19:15:09 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Aug 2011 19:15:09 +0200
Subject: [Avidemux-svn-commit] r7450 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src
Message-ID: <20110827171509.A2FDE481164@sheep.berlios.de>

Author: mean
Date: 2011-08-27 19:15:09 +0200 (Sat, 27 Aug 2011)
New Revision: 7450

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp
Log:
[tinypy] Add get_file_size to tinypy

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp	2011-08-27 06:49:03 UTC (rev 7449)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp	2011-08-27 17:15:09 UTC (rev 7450)
@@ -30,9 +30,11 @@
 pyLoggerFunc *pyLog=NULL;
 static tp_obj    tinyPy_dumpBuiltin(tp_vm *vm);
 static tp_obj    tinyPy_getFolderContent(tp_vm *vm);
+static tp_obj    tinyPy_getFileSize(tp_vm *vm);
 static pyFuncs addons[]={
                                 {"help",tinyPy_dumpBuiltin},
                                 {"get_folder_content",tinyPy_getFolderContent},
+                                {"get_file_size",tinyPy_getFileSize},
                                 {NULL,NULL}
                         };
 static vector <admPyClassDescriptor> listOfPyClass;;
@@ -199,6 +201,20 @@
 
 }
 /**
+    \fn tinyPy_getFileSize
+    \brief returns file size in bytes
+*/
+tp_obj tinyPy_getFileSize(tp_vm *tp)
+{
+    tinyParams pm(tp);
+    const char *file= pm.asString();
+    
+    uint32_t size=ADM_fileSize(file);
+    tp_obj v=tp_number(size);
+    return v;
+}
+
+/**
     \fn getFolderContent
     \brief get_folder_content(root, ext) : Return a list of files in  root with extention ext
 */



From mean at mail.berlios.de  Sat Aug 27 19:15:11 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Aug 2011 19:15:11 +0200
Subject: [Avidemux-svn-commit] r7451 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io
Message-ID: <20110827171511.25C74481164@sheep.berlios.de>

Author: mean
Date: 2011-08-27 19:15:10 +0200 (Sat, 27 Aug 2011)
New Revision: 7451

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/FileSystem_posix.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/File_posix.cpp
Log:
[mp4v2] put back our changes for win32

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/FileSystem_posix.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/FileSystem_posix.cpp	2011-08-27 17:15:09 UTC (rev 7450)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/FileSystem_posix.cpp	2011-08-27 17:15:10 UTC (rev 7451)
@@ -1,6 +1,13 @@
+#include "ADM_cpp.h"
+
 #include "libplatform/impl.h"
 #include <sys/stat.h>
 
+#define ADM_LEGACY_PROGGY
+#include "ADM_default.h"
+
+// MEANX : Switch to our own wrappers
+
 namespace mp4v2 { namespace platform { namespace io {
 
 ///////////////////////////////////////////////////////////////////////////////
@@ -8,8 +15,11 @@
 bool
 FileSystem::exists( string path_ )
 {
+    return ADM_fileExist(path_.c_str());
+/*
     struct stat buf;
     return stat( path_.c_str(), &buf ) == 0;
+*/
 }
 
 ///////////////////////////////////////////////////////////////////////////////
@@ -39,12 +49,16 @@
 bool
 FileSystem::getFileSize( string path_, File::Size& size_ )
 {
+/*
     size_ = 0;
     struct stat buf;
     if( stat( path_.c_str(), &buf ))
         return true;
     size_ = buf.st_size;
     return false;
+*/
+    size_=ADM_fileSize(path_.c_str());
+    return false;
 }
 
 ///////////////////////////////////////////////////////////////////////////////
@@ -52,7 +66,12 @@
 bool
 FileSystem::rename( string from, string to )
 {
-    return ::rename( from.c_str(), to.c_str() ) != 0;
+    if(!ADM_renameFile(from.c_str(),to.c_str()))
+    {
+        ADM_error("Cannot rename %s to %s\n",from.c_str(),to.c_str());
+        return true;
+    }
+    return false;
 }
 
 ///////////////////////////////////////////////////////////////////////////////

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/File_posix.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/File_posix.cpp	2011-08-27 17:15:09 UTC (rev 7450)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/libplatform/io/File_posix.cpp	2011-08-27 17:15:10 UTC (rev 7451)
@@ -1,5 +1,10 @@
+#include "ADM_cpp.h"
 #include "libplatform/impl.h"
+#define ADM_LEGACY_PROGGY
+#include "ADM_default.h"
 
+// MEANX : Change fstream based io to FILE based io to be compatible with avidemux wrapper
+
 namespace mp4v2 { namespace platform { namespace io {
 
 ///////////////////////////////////////////////////////////////////////////////
@@ -18,7 +23,7 @@
 private:
     bool         _seekg;
     bool         _seekp;
-    std::fstream _fstream;
+    FILE         *_file;
 };
 
 ///////////////////////////////////////////////////////////////////////////////
@@ -27,73 +32,82 @@
     : _seekg ( false )
     , _seekp ( false )
 {
+    _file=NULL;
 }
 
 bool
 StandardFileProvider::open( std::string name, Mode mode )
 {
     ios::openmode om = ios::binary;
+    std::string fmode;
     switch( mode ) {
         case MODE_UNDEFINED:
         case MODE_READ:
         default:
-            om |= ios::in;
+            fmode=std::string("r");
             _seekg = true;
             _seekp = false;
             break;
 
         case MODE_MODIFY:
-            om |= ios::in | ios::out;
+            fmode=std::string("rw");
             _seekg = true;
             _seekp = true;
             break;
 
         case MODE_CREATE:
-            om |= ios::in | ios::out | ios::trunc;
+            fmode=std::string("w");
             _seekg = true;
             _seekp = true;
             break;
     }
-
-    _fstream.open( name.c_str(), om );
-    return _fstream.fail();
+    fmode+=std::string("b");
+    _file=fopen(name.c_str(),fmode.c_str());
+    if(!_file) 
+    {
+        ADM_error("Cannot create file %s mode %s\n",name.c_str(),fmode.c_str());
+        return true;
+    }
+    ADM_info("Created file %s mode %s\n",name.c_str(),fmode.c_str());
+    return false;
 }
 
 bool
 StandardFileProvider::seek( Size pos )
 {
-    if( _seekg )
-        _fstream.seekg( pos, ios::beg );
-    if( _seekp )
-        _fstream.seekp( pos, ios::beg );
-    return _fstream.fail();
+int er=1;
+    er=fseeko(_file,pos,SEEK_SET);
+    if(er)
+    {
+        ADM_error("Seek to %d failed\n",(int)pos);
+        return true;
+    }
+    return false;
 }
 
 bool
 StandardFileProvider::read( void* buffer, Size size, Size& nin, Size maxChunkSize )
 {
-    _fstream.read( (char*)buffer, size );
-    if( _fstream.fail() )
-        return true;
-    nin = _fstream.gcount();
+    nin=fread(buffer,1,size,_file);
+    if(nin<=0) return true;
     return false;
 }
 
 bool
 StandardFileProvider::write( const void* buffer, Size size, Size& nout, Size maxChunkSize )
 {
-    _fstream.write( (const char*)buffer, size );
-    if( _fstream.fail() )
-        return true;
-    nout = size;
+    nout=fwrite(buffer,1,size,_file);
+    if(nout<=0) return true;
     return false;
 }
 
 bool
 StandardFileProvider::close()
 {
-    _fstream.close();
-    return _fstream.fail();
+    if(_file)
+        fclose(_file);
+    _file=NULL;
+    return true;
 }
 
 ///////////////////////////////////////////////////////////////////////////////



From mean at mail.berlios.de  Mon Aug 29 08:02:37 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 29 Aug 2011 08:02:37 +0200
Subject: [Avidemux-svn-commit] r7452 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2:
	. libmp4v2/src patches
Message-ID: <20110829060237.C05B64811B0@sheep.berlios.de>

Author: mean
Date: 2011-08-29 08:02:37 +0200 (Mon, 29 Aug 2011)
New Revision: 7452

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/patches/progress_callback_when_optimizing.patch
Removed:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/patches/disable_get_max_bitrate_way_too_slow.diff
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/src/mp4file.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.h
Log:
[mp4v2] Progress bar when optimizing

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/src/mp4file.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/src/mp4file.cpp	2011-08-27 17:15:10 UTC (rev 7451)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/src/mp4file.cpp	2011-08-29 06:02:37 UTC (rev 7452)
@@ -30,6 +30,8 @@
 
 #include "src/impl.h"
 
+extern void ADM_MP4_progressCallback(int p); // MEANX
+
 namespace mp4v2 { namespace impl {
 
 ///////////////////////////////////////////////////////////////////////////////
@@ -330,6 +332,8 @@
     MP4ChunkId* maxChunkIds = new MP4ChunkId[numTracks];
     MP4Timestamp* nextChunkTimes = new MP4Timestamp[numTracks];
 
+    uint64_t sourceSize=src.size;
+
     for( uint32_t i = 0; i < numTracks; i++ ) {
         chunkIds[i] = 1;
         maxChunkIds[i] = m_pTracks[i]->GetNumberOfChunks();
@@ -374,6 +378,17 @@
 
         // point back at the new mp4 file for write chunk
         m_file = &dst;
+
+        {
+            uint64_t destSize=dst.position; //MEANX
+            if(sourceSize>10)
+            {
+                    double p=sourceSize;
+                    p=(destSize*100)/sourceSize;
+                    ADM_MP4_progressCallback((int)p);
+            }
+            
+        }
         m_pTracks[nextTrackIndex]->RewriteChunk( chunkIds[nextTrackIndex], pChunk, chunkSize );
 
         MP4Free( pChunk );

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.cpp	2011-08-27 17:15:10 UTC (rev 7451)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.cpp	2011-08-29 06:02:37 UTC (rev 7452)
@@ -17,7 +17,7 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-
+#include <stdarg.h>
 #include "ADM_default.h"
 #include "ADM_cpp.h"
 #include "fourcc.h"
@@ -38,12 +38,43 @@
 #define ADM_MP4_OPTIONS_OPEN  (MP4_CREATE_64BIT_DATA)
 #define ADM_MP4_OPTIONS_CLOSE (MP4_CLOSE_DO_NOT_COMPUTE_BITRATE )
 
+// We should only have one valid at at time...
+muxerMp4v2 *currentMuxer=NULL;
+
 mp4v2_muxer muxerConfig=
 {
    1, // uint32_t optimize;
    0  //uint32_t add_itunes_metadata;
 };
+extern "C"
+{
+static   void callback(MP4LogLevel level, const char *fmt, va_list ap)
+{
+        static char print_buffer[1024];
+		vsnprintf(print_buffer,1023,fmt,ap);
+		print_buffer[1023]=0; // ensure the string is terminated
+        ADM_info("<mp4v2>%s",print_buffer);
+}
+}
 /**
+    \fn ADM_MP4_progressCallback
+    \brief callback from MP4V2 to get the optimizing progress
+*/
+void ADM_MP4_progressCallback(int p)
+{
+    if(currentMuxer)
+        currentMuxer->setPercent(p);
+           
+}
+/**
+    \fn setPercent
+*/
+void muxerMp4v2::setPercent(int percent)
+{
+    if(encoding)
+        encoding->setPercent(percent);
+}
+/**
     \fn setMaxDurationPerChunk
     \brief Max chunk duration is 1 sec par default; set it to ~ 4 frames
 */
@@ -93,6 +124,8 @@
         nextWrite=0;
         needToConvertFromAnnexB=false;
         lastVideoDts=0;
+        MP4SetLogCallback(callback);
+        currentMuxer=this;
 };
 /**
     \fn     muxerMp4v2
@@ -105,6 +138,7 @@
     close();
     if(handle)
         ADM_error("MP4V2: File still opened\n");
+    currentMuxer=NULL;
 }
 /**
     \fn open
@@ -254,10 +288,12 @@
                         0 // Sync Sample
                         );
 theEnd:
-    closeUI();
     close();
+    
+    
     if(muxerConfig.optimize && result==true)
     {
+        encoding->setPhasis("Optimizing");
         string tmpTargetFileName=targetFileName+string(".tmp");
         if(!ADM_renameFile(targetFileName.c_str(),tmpTargetFileName.c_str()))
         {
@@ -270,6 +306,7 @@
         // delete
         unlink(tmpTargetFileName.c_str());
     }
+    closeUI();
     return result;
 }
 /**

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.h	2011-08-27 17:15:10 UTC (rev 7451)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/muxerMp4v2.h	2011-08-29 06:02:37 UTC (rev 7452)
@@ -69,6 +69,7 @@
         uint8_t         *scratchBuffer;
         string          targetFileName;
         uint64_t        lastVideoDts;
+
 protected: // video
         bool            initMpeg4(void);
         bool            initH264(void);
@@ -91,6 +92,7 @@
         virtual bool save(void) ;
         virtual bool close(void) ;
         virtual bool useGlobalHeader(void) {return true;}
+                void setPercent(int percent);
 
 };
 

Deleted: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/patches/disable_get_max_bitrate_way_too_slow.diff
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/patches/disable_get_max_bitrate_way_too_slow.diff	2011-08-27 17:15:10 UTC (rev 7451)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/patches/disable_get_max_bitrate_way_too_slow.diff	2011-08-29 06:02:37 UTC (rev 7452)
@@ -1,20 +0,0 @@
-diff --git a/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/src/mp4track.cpp b/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/src/mp4track.cpp
-index cc4fdfc..c2a3de6 100644
---- a/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/src/mp4track.cpp
-+++ b/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/src/mp4track.cpp
-@@ -534,13 +534,13 @@ void MP4Track::FinishWrite()
-     }
- 
-     MP4Integer32Property* pBitrateProperty;
--
-+#if 0 // MEANX : Way too slow!
-     if (m_trakAtom.FindProperty(
-                 "trak.mdia.minf.stbl.stsd.*.esds.decConfigDescr.maxBitrate",
-                 (MP4Property**)&pBitrateProperty)) {
-         pBitrateProperty->SetValue(GetMaxBitrate());
-     }
--
-+#endif
-     if (m_trakAtom.FindProperty(
-                 "trak.mdia.minf.stbl.stsd.*.esds.decConfigDescr.avgBitrate",
-                 (MP4Property**)&pBitrateProperty)) {

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/patches/progress_callback_when_optimizing.patch
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/patches/progress_callback_when_optimizing.patch	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerMp4v2/patches/progress_callback_when_optimizing.patch	2011-08-29 06:02:37 UTC (rev 7452)
@@ -0,0 +1,40 @@
+diff --git a/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/src/mp4file.cpp b/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/src/mp4file.cpp
+index cdab917..d4e0162 100644
+--- a/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/src/mp4file.cpp
++++ b/avidemux_plugins/ADM_muxers/muxerMp4v2/libmp4v2/src/mp4file.cpp
+@@ -30,6 +30,8 @@
+ 
+ #include "src/impl.h"
+ 
++extern void ADM_MP4_progressCallback(int p); // MEANX
++
+ namespace mp4v2 { namespace impl {
+ 
+ ///////////////////////////////////////////////////////////////////////////////
+@@ -330,6 +332,8 @@ void MP4File::RewriteMdat( File& src, File& dst )
+     MP4ChunkId* maxChunkIds = new MP4ChunkId[numTracks];
+     MP4Timestamp* nextChunkTimes = new MP4Timestamp[numTracks];
+ 
++    uint64_t sourceSize=src.size;
++
+     for( uint32_t i = 0; i < numTracks; i++ ) {
+         chunkIds[i] = 1;
+         maxChunkIds[i] = m_pTracks[i]->GetNumberOfChunks();
+@@ -374,6 +378,17 @@ void MP4File::RewriteMdat( File& src, File& dst )
+ 
+         // point back at the new mp4 file for write chunk
+         m_file = &dst;
++
++        {
++            uint64_t destSize=dst.position; //MEANX
++            if(sourceSize>10)
++            {
++                    double p=sourceSize;
++                    p=(destSize*100)/sourceSize;
++                    ADM_MP4_progressCallback((int)p);
++            }
++            
++        }
+         m_pTracks[nextTrackIndex]->RewriteChunk( chunkIds[nextTrackIndex], pChunk, chunkSize );
+ 
+         MP4Free( pChunk );



From mean at mail.berlios.de  Mon Aug 29 08:02:39 2011
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 29 Aug 2011 08:02:39 +0200
Subject: [Avidemux-svn-commit] r7453 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include
Message-ID: <20110829060239.16F384811B0@sheep.berlios.de>

Author: mean
Date: 2011-08-29 08:02:38 +0200 (Mon, 29 Aug 2011)
New Revision: 7453

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/DIA_encoding.h
Log:
[UI] SetPercent is now public in DIA_encoding

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/DIA_encoding.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/DIA_encoding.h	2011-08-29 06:02:37 UTC (rev 7452)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/DIA_encoding.h	2011-08-29 06:02:38 UTC (rev 7453)
@@ -58,7 +58,7 @@
                 virtual void reset( void );
 protected:
                 virtual void setFps(uint32_t fps1000)=0;
-                virtual void setPercent(uint32_t percent)=0;
+                
                 virtual void setAudioSize(uint64_t size)=0;
                 virtual void setVideoSize(uint64_t size)=0;
                 virtual void setTotalSize(uint64_t size)=0;
@@ -70,6 +70,8 @@
             
 
 public:
+                virtual void setPercent(uint32_t percent)=0;
+public:
                 virtual void setPhasis(const char *n)=0;
                 virtual void setVideoCodec(const char *n)=0;
                 virtual void setAudioCodec(const char *n)=0;



