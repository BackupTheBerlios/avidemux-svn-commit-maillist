<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r7521 - in branches/avidemux_2.6_branch_mean:	avidemux/winInstaller foreignBuilds/mswin/avidemux	foreignBuilds/mswin/avidemux/Tools foreignBuilds/mswin/faac	foreignBuilds/mswin/faad foreignBuilds/mswin/libogg	foreignBuilds/mswin/libvpx foreignBuilds/mswin/nspr	foreignBuilds/mswin/x264 foreignBuilds/mswin/xvid
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2011-September/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r7521%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/winInstaller%20foreignBuilds/mswin/avidemux%0A%09foreignBuilds/mswin/avidemux/Tools%20foreignBuilds/mswin/faac%0A%09foreignBuilds/mswin/faad%20foreignBuilds/mswin/libogg%0A%09foreignBuilds/mswin/libvpx%20foreignBuilds/mswin/nspr%0A%09foreignBuilds/mswin/x264%20foreignBuilds/mswin/xvid&In-Reply-To=%3C20110913160905.D19E648125B%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004668.html">
   <LINK REL="Next"  HREF="004670.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r7521 - in branches/avidemux_2.6_branch_mean:	avidemux/winInstaller foreignBuilds/mswin/avidemux	foreignBuilds/mswin/avidemux/Tools foreignBuilds/mswin/faac	foreignBuilds/mswin/faad foreignBuilds/mswin/libogg	foreignBuilds/mswin/libvpx foreignBuilds/mswin/nspr	foreignBuilds/mswin/x264 foreignBuilds/mswin/xvid</H1>
    <B>gruntster at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r7521%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/winInstaller%20foreignBuilds/mswin/avidemux%0A%09foreignBuilds/mswin/avidemux/Tools%20foreignBuilds/mswin/faac%0A%09foreignBuilds/mswin/faad%20foreignBuilds/mswin/libogg%0A%09foreignBuilds/mswin/libvpx%20foreignBuilds/mswin/nspr%0A%09foreignBuilds/mswin/x264%20foreignBuilds/mswin/xvid&In-Reply-To=%3C20110913160905.D19E648125B%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r7521 - in branches/avidemux_2.6_branch_mean:	avidemux/winInstaller foreignBuilds/mswin/avidemux	foreignBuilds/mswin/avidemux/Tools foreignBuilds/mswin/faac	foreignBuilds/mswin/faad foreignBuilds/mswin/libogg	foreignBuilds/mswin/libvpx foreignBuilds/mswin/nspr	foreignBuilds/mswin/x264 foreignBuilds/mswin/xvid">gruntster at mail.berlios.de
       </A><BR>
    <I>Tue Sep 13 18:09:05 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004668.html">[Avidemux-svn-commit] r7520 - in	branches/avidemux_2.6_branch_mean/avidemux_core:	ADM_coreImage/src ADM_coreUtils/src
</A></li>
        <LI>Next message: <A HREF="004670.html">[Avidemux-svn-commit] r7522 -	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4669">[ date ]</a>
              <a href="thread.html#4669">[ thread ]</a>
              <a href="subject.html#4669">[ subject ]</a>
              <a href="author.html#4669">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: gruntster
Date: 2011-09-13 18:09:05 +0200 (Tue, 13 Sep 2011)
New Revision: 7521

Added:
   branches/avidemux_2.6_branch_mean/avidemux/winInstaller/PageHeaderGtk.bmp
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faac/makefile
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faad/makefile
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/winInstaller/PageHeader.bmp
   branches/avidemux_2.6_branch_mean/avidemux/winInstaller/avidemux.nsi
   branches/avidemux_2.6_branch_mean/avidemux/winInstaller/genlog.sh
   branches/avidemux_2.6_branch_mean/avidemux/winInstaller/svnlog.xslt
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/1b. Perform Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2. Create Packages.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2a. Update Notes.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2b. Package SDK.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2c. Package Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Set Avidemux Environment Variables.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/Get Revision Number.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/gentouch.sh
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/package_notes.xslt
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faac/Perform Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faad/Perform Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/libogg/Perform Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/libvpx/Perform Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/Perform Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/x264/Perform Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/xvid/Perform Build.bat
   branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/xvid/configure.patch
Log:
[mswin] update build scripts

Modified: branches/avidemux_2.6_branch_mean/avidemux/winInstaller/PageHeader.bmp
===================================================================
(Binary files differ)

Added: branches/avidemux_2.6_branch_mean/avidemux/winInstaller/PageHeaderGtk.bmp
===================================================================
(Binary files differ)


Property changes on: branches/avidemux_2.6_branch_mean/avidemux/winInstaller/PageHeaderGtk.bmp
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Modified: branches/avidemux_2.6_branch_mean/avidemux/winInstaller/avidemux.nsi
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/winInstaller/avidemux.nsi	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/avidemux/winInstaller/avidemux.nsi	2011-09-13 16:09:05 UTC (rev 7521)
@@ -2,42 +2,86 @@
 # Included files
 ##########################
 !include Sections.nsh
-!include MUI.nsh
-!include WinMessages.nsh
-!include revision.nsh
+!include MUI2.nsh
+!include nsDialogs.nsh
+!include Memento.nsh
+!include FileFunc.nsh
+!include WordFunc.nsh
+!include ${NSIDIR}\revision.nsh
 
-Name &quot;Avidemux 2.4.2 r${REVISION}&quot;
-
 SetCompressor /SOLID lzma
 SetCompressorDictSize 96
 
 ##########################
 # Defines
 ##########################
-!define INTERNALNAME &quot;Avidemux 2.4&quot;
-!define REGKEY &quot;SOFTWARE\${INTERNALNAME}&quot;
-!define UNINST_REGKEY &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${INTERNALNAME}&quot;
-!define VERSION 2.4.2.${REVISION}
+
+!define PRODUCT_VERSION &quot;2.6.0.${REVISION}&quot;
+!define PRODUCT_NAME &quot;Avidemux 2.6&quot;
+!define PRODUCT_FULLNAME &quot;Avidemux ${PRODUCT_VERSION} (${BUILD_BITS}-bit beta)&quot;
+
+!if ${BUILD_BITS} == 64
+	!define SHORTCUT_NAME &quot;${PRODUCT_NAME}&quot;
+	!define REG_GROUPNAME &quot;${PRODUCT_NAME} (${BUILD_BITS}-bit)&quot;
+!else
+	!define SHORTCUT_NAME &quot;${PRODUCT_NAME} (${BUILD_BITS}-bit)&quot;
+	!define REG_GROUPNAME &quot;${PRODUCT_NAME}&quot;
+!endif
+
+!define REGKEY &quot;SOFTWARE\${REG_GROUPNAME}&quot;
+!define UNINST_REGKEY &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${REG_GROUPNAME}&quot;
 !define COMPANY &quot;Free Software Foundation&quot;
 !define URL &quot;<A HREF="http://www.avidemux.org">http://www.avidemux.org</A>&quot;
 
-!define INSTALL_OPTS_INI &quot;InstallOptions.ini&quot;
+!ifndef INST_GTK
+!ifndef INST_QT
+!define INST_GTK
+!define INST_QT
+!endif
+!endif
 
+!ifdef INST_GTK
+!ifdef INST_QT
+!define INST_BOTH
+!endif
+!endif
+
+!ifdef INST_BOTH
+OutFile &quot;${EXEDIR}\avidemux_2.6_r${REVISION}_full_win${BUILD_BITS}.exe&quot;
+Name &quot;${PRODUCT_FULLNAME} Full&quot;
+!else ifdef INST_QT
+OutFile &quot;${EXEDIR}\avidemux_2.6_r${REVISION}_win${BUILD_BITS}.exe&quot;
+Name &quot;${PRODUCT_FULLNAME}&quot;
+!else ifdef INST_GTK
+OutFile &quot;${EXEDIR}\avidemux_2.6_r${REVISION}_gtk_win${BUILD_BITS}.exe&quot;
+Name &quot;${PRODUCT_FULLNAME} GTK+&quot;
+!endif
+
 ##########################
+# Memento defines
+##########################
+!define MEMENTO_REGISTRY_ROOT HKLM
+!define MEMENTO_REGISTRY_KEY &quot;${REGKEY}&quot;
+
+##########################
 # MUI defines
 ##########################
 !define MUI_ICON &quot;${NSISDIR}\Contrib\Graphics\Icons\modern-install-blue-full.ico&quot;
 !define MUI_HEADERIMAGE
 !define MUI_HEADERIMAGE_RIGHT
-!define MUI_HEADERIMAGE_BITMAP &quot;PageHeader.bmp&quot;
+!ifdef INST_GTK
+!define MUI_HEADERIMAGE_BITMAP &quot;${NSIDIR}\PageHeaderGtk.bmp&quot;
+!else
+!define MUI_HEADERIMAGE_BITMAP &quot;${NSIDIR}\PageHeader.bmp&quot;
+!endif
 !define MUI_STARTMENUPAGE_REGISTRY_ROOT HKLM
 !define MUI_STARTMENUPAGE_REGISTRY_KEY &quot;${REGKEY}&quot;
 !define MUI_STARTMENUPAGE_REGISTRY_VALUENAME StartMenuGroup
 !define MUI_STARTMENUPAGE_DEFAULTFOLDER Avidemux
 !define MUI_STARTMENUPAGE_NODISABLE
-!define MUI_WELCOMEFINISHPAGE_BITMAP &quot;WelcomeFinishStrip.bmp&quot;
-!define MUI_UNICON &quot;..\xpm\adm.ico&quot;
-!define MUI_UNFINISHPAGE_NOAUTOCLOSE
+!define MUI_WELCOMEFINISHPAGE_BITMAP &quot;${NSIDIR}\WelcomeFinishStrip.bmp&quot;
+!define MUI_UNWELCOMEFINISHPAGE_BITMAP &quot;${NSIDIR}\WelcomeFinishStrip.bmp&quot;
+!define MUI_UNICON &quot;${NSIDIR}\..\common\xpm\adm.ico&quot;
 !define MUI_COMPONENTSPAGE_NODESC
 
 ##########################
@@ -47,32 +91,44 @@
 Var CreateStartMenuGroup
 Var CreateQuickLaunchIcon
 Var StartMenuGroup
+Var PreviousVersion
+Var PreviousVersionState
+Var ReinstallUninstall
 
 ##########################
 # Installer pages
 ##########################
+!define MUI_WELCOMEPAGE_TITLE &quot;${PRODUCT_FULLNAME} Setup Wizard&quot;
 !insertmacro MUI_PAGE_WELCOME
-!insertmacro MUI_PAGE_LICENSE License.rtf
+!insertmacro MUI_PAGE_LICENSE &quot;${NSIDIR}\License.rtf&quot;
+ Page custom ReinstallPage ReinstallPageLeave
+!ifdef INST_BOTH
 !define MUI_PAGE_CUSTOMFUNCTION_LEAVE CheckSelectedUIs
+!endif
 !insertmacro MUI_PAGE_COMPONENTS
 Page custom InstallOptionsPage
 !define MUI_PAGE_CUSTOMFUNCTION_PRE IsStartMenuRequired
 !insertmacro MUI_PAGE_STARTMENU Application $StartMenuGroup
 !insertmacro MUI_PAGE_DIRECTORY
 !define MUI_PAGE_CUSTOMFUNCTION_PRE ActivateInternalSections
+!define MUI_PAGE_CUSTOMFUNCTION_SHOW InstFilesPageShow
+!define MUI_PAGE_CUSTOMFUNCTION_LEAVE InstFilesPageLeave
 !insertmacro MUI_PAGE_INSTFILES
 !define MUI_FINISHPAGE_RUN
 !define MUI_FINISHPAGE_RUN_FUNCTION RunAvidemux
-!define MUI_FINISHPAGE_RUN_TEXT &quot;Run ${INTERNALNAME} now&quot;
+!define MUI_FINISHPAGE_RUN_TEXT &quot;Run ${PRODUCT_NAME} now&quot;
 !define MUI_FINISHPAGE_SHOWREADME &quot;$INSTDIR\Change Log.html&quot;
 !define MUI_FINISHPAGE_SHOWREADME_TEXT &quot;View Change Log now&quot;
-!define MUI_FINISHPAGE_LINK &quot;Visit the Avidemux Win32 Builds website&quot;
-!define MUI_FINISHPAGE_LINK_LOCATION &quot;<A HREF="http://www.razorbyte.com.au/avidemux/">http://www.razorbyte.com.au/avidemux/</A>&quot;
+!define MUI_FINISHPAGE_LINK &quot;Visit the Avidemux Builds for Windows website&quot;
+!define MUI_FINISHPAGE_LINK_LOCATION &quot;<A HREF="http://avidemux.razorbyte.com.au/">http://avidemux.razorbyte.com.au/</A>&quot;
 !define MUI_PAGE_CUSTOMFUNCTION_PRE ConfigureFinishPage
-!define MUI_PAGE_CUSTOMFUNCTION_SHOW OnShowFinishPage
 !insertmacro MUI_PAGE_FINISH
+
+!define MUI_PAGE_CUSTOMFUNCTION_PRE un.ConfirmPagePre
 !insertmacro MUI_UNPAGE_CONFIRM
 !insertmacro MUI_UNPAGE_INSTFILES
+!define MUI_PAGE_CUSTOMFUNCTION_PRE un.FinishPagePre
+!insertmacro MUI_UNPAGE_FINISH
 
 ##########################
 # Installer languages
@@ -80,574 +136,1055 @@
 !insertmacro MUI_LANGUAGE English
 
 ##########################
-#Reserve files
+# Installer attributes
 ##########################
-ReserveFile &quot;${INSTALL_OPTS_INI}&quot;
-!insertmacro MUI_RESERVEFILE_INSTALLOPTIONS
+!if ${BUILD_BITS} == 64
+	InstallDir &quot;$PROGRAMFILES64\${PRODUCT_NAME}&quot;
+!else
+	InstallDir &quot;$PROGRAMFILES\${PRODUCT_NAME}&quot;
+!endif
 
-##########################
-# Installer attributes
-##########################
-OutFile avidemux_2.4_r${REVISION}_win32.exe
-InstallDir &quot;$PROGRAMFILES\Avidemux 2.4&quot;
 CRCCheck on
 XPStyle on
 ShowInstDetails nevershow
-VIProductVersion 2.4.2.${REVISION}
+ShowUninstDetails nevershow
+VIProductVersion ${PRODUCT_VERSION}
 VIAddVersionKey ProductName Avidemux
-VIAddVersionKey ProductVersion &quot;${VERSION}&quot;
+VIAddVersionKey ProductVersion &quot;${PRODUCT_VERSION}&quot;
 VIAddVersionKey FileVersion &quot;&quot;
 VIAddVersionKey FileDescription &quot;&quot;
 VIAddVersionKey LegalCopyright &quot;&quot;
 InstallDirRegKey HKLM &quot;${REGKEY}&quot; Path
-ShowUninstDetails nevershow
 BrandingText &quot;Packaged by Gruntster&quot;
 InstType Standard
 InstType Full
 
 ##########################
+# Uninstaller macros
+##########################
+!insertmacro un.GetOptions
+!insertmacro un.GetParameters
+
+!define UninstallLogPath &quot;$INSTDIR\uninstall.log&quot;
+Var UninstallLogHandle
+
+; Uninstall log file missing.
+LangString UninstallLogMissing ${LANG_ENGLISH} &quot;uninstall.log not found!$\r$\nUninstallation cannot proceed!&quot;
+
+!macro InstallFile FILEREGEX
+	File &quot;${FILEREGEX}&quot;
+	!define Index 'Line${__LINE__}'
+	${GetFileName} &quot;${FILEREGEX}&quot; $R0
+	FindFirst $0 $1 &quot;$OUTDIR\$R0&quot;
+	StrCmp $0 &quot;&quot; &quot;${Index}-End&quot;
+&quot;${Index}-Loop:&quot;
+	StrCmp $1 &quot;&quot; &quot;${Index}-End&quot;
+	FileWrite $UninstallLogHandle &quot;$OUTDIR\$1$\r$\n&quot;
+	FindNext $0 $1
+	Goto &quot;${Index}-Loop&quot;
+&quot;${Index}-End:&quot;
+	!undef Index
+!macroend
+!define File &quot;!insertmacro InstallFile&quot;
+ 
+!macro InstallFolder FILEREGEX
+	File /r &quot;${FILEREGEX}\*&quot;
+	Push &quot;$OUTDIR&quot;
+	Call InstallFolderInternal
+!macroend
+!define Folder &quot;!insertmacro InstallFolder&quot;
+ 
+Function InstallFolderInternal
+	Pop $9
+	!define Index 'Line${__LINE__}'
+	FindFirst $0 $1 &quot;$9\*&quot;
+	StrCmp $0 &quot;&quot; &quot;${Index}-End&quot;
+&quot;${Index}-Loop:&quot;
+	StrCmp $1 &quot;&quot; &quot;${Index}-End&quot;
+	StrCmp $1 &quot;.&quot; &quot;${Index}-Next&quot;
+	StrCmp $1 &quot;..&quot; &quot;${Index}-Next&quot;
+	IfFileExists &quot;$9\$1\*&quot; 0 &quot;${Index}-Write&quot;
+		Push $0
+		Push $9
+		Push &quot;$9\$1&quot;
+		Call InstallFolderInternal
+		Pop $9
+		Pop $0
+		Goto &quot;${Index}-Next&quot;
+&quot;${Index}-Write:&quot;
+	FileWrite $UninstallLogHandle &quot;$9\$1$\r$\n&quot;
+&quot;${Index}-Next:&quot;
+	FindNext $0 $1
+	Goto &quot;${Index}-Loop&quot;
+&quot;${Index}-End:&quot;
+	!undef Index
+FunctionEnd
+
+; WriteUninstaller macro
+!macro WriteUninstaller Path
+	WriteUninstaller &quot;${Path}&quot;
+	FileWrite $UninstallLogHandle &quot;${Path}$\r$\n&quot;
+!macroend
+!define WriteUninstaller &quot;!insertmacro WriteUninstaller&quot;
+
+##########################
 # Macros
 ##########################
 !macro InstallGtkLanguage LANG_NAME LANG_CODE
+!ifdef INST_GTK
 	SetOverwrite on
 
 	!insertmacro SectionFlagIsSet ${SecUiGtk} ${SF_SELECTED} installGtk${LANG_CODE} endGtk${LANG_CODE}
 
 installGtk${LANG_CODE}:
     SetOutPath $INSTDIR\share\locale\${LANG_CODE}\LC_MESSAGES
-    File ..\..\..\avidemux_2.4_build\share\locale\${LANG_CODE}\LC_MESSAGES\avidemux.mo
-    File ..\..\..\avidemux_2.4_build\share\locale\${LANG_CODE}\LC_MESSAGES\gtk20.mo
+    ${File} share\locale\${LANG_CODE}\LC_MESSAGES\avidemux.mo
+    ${File} share\locale\${LANG_CODE}\LC_MESSAGES\gtk20.mo
 
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; ${LANG_NAME} 1
 endGtk${LANG_CODE}:
+!endif
 !macroend
 
-!macro InstallQt4Language LANG_NAME LANG_CODE
+!macro InstallQtLanguage LANG_NAME LANG_CODE
+!ifdef INST_QT
 	SetOverwrite on
 
-	!insertmacro SectionFlagIsSet ${SecUiQt4} ${SF_SELECTED} installQt4${LANG_CODE} endQt4${LANG_CODE}
+	!insertmacro SectionFlagIsSet ${SecUiQt} ${SF_SELECTED} installQt${LANG_CODE} endQt${LANG_CODE}
 
-installQt4${LANG_CODE}:	
+installQt${LANG_CODE}:
 	SetOutPath $INSTDIR\i18n
-    File ..\..\..\avidemux_2.4_build\i18n\avidemux_${LANG_CODE}.qm
-    File ..\..\..\avidemux_2.4_build\i18n\qt_${LANG_CODE}.qm
-    
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; ${LANG_NAME} 1
-endQt4${LANG_CODE}:    
-!macroend
+    ${File} i18n\avidemux_${LANG_CODE}.qm
+    ${File} i18n\qt_${LANG_CODE}.qm
 
-!macro UninstallLanguage LANG_NAME LANG_CODE
-    RmDir /r /REBOOTOK $INSTDIR\share\locale\${LANG_CODE}
-    Delete /REBOOTOK $INSTDIR\i18n\avidemux_${LANG_CODE}.qm
-    Delete /REBOOTOK $INSTDIR\i18n\qt_${LANG_CODE}.qm
-    
-    DeleteRegValue HKLM &quot;${REGKEY}\Components&quot; ${LANG_NAME}
+endQt${LANG_CODE}:
+!endif
 !macroend
 
-# Macro for selecting sections based on registry setting
-!macro SELECT_SECTION SECTION_NAME SECTION_ID
-    Push $R0
-    ReadRegStr $R0 HKLM &quot;${REGKEY}\Components&quot; &quot;${SECTION_NAME}&quot;
-    StrCmp $R0 1 0 next${SECTION_ID}
-    !insertmacro SelectSection &quot;${SECTION_ID}&quot;
-    GoTo done${SECTION_ID}
-next${SECTION_ID}:
-    !insertmacro UnselectSection &quot;${SECTION_ID}&quot;
-done${SECTION_ID}:
-    Pop $R0
-!macroend
-
 ##########################
 # Installer sections
 ##########################
-Section &quot;Core files (required)&quot; SecCore
+Section -OpenLogFile
+	CreateDirectory &quot;$INSTDIR&quot;
+	FileOpen $UninstallLogHandle ${UninstallLogPath} a
+	FileSeek $UninstallLogHandle 0 END
+SectionEnd
+
+Section &quot;Avidemux Core&quot; SecCore
     SectionIn 1 2 RO
     SetOutPath $INSTDIR
     SetOverwrite on
-    File &quot;..\..\..\avidemux_2.4_build\Build Info.txt&quot;
-    File &quot;..\..\..\avidemux_2.4_build\Change Log.html&quot;
-    File ..\..\..\avidemux_2.4_build\zlib1.dll
-    File ..\..\..\avidemux_2.4_build\freetype6.dll
-    File ..\..\..\avidemux_2.4_build\iconv.dll
-    File ..\..\..\avidemux_2.4_build\intl.dll
-    File ..\..\..\avidemux_2.4_build\libaften.dll
-    File ..\..\..\avidemux_2.4_build\libexpat.dll
-    File ..\..\..\avidemux_2.4_build\libfaac.dll
-    File ..\..\..\avidemux_2.4_build\libfaad2.dll
-    File ..\..\..\avidemux_2.4_build\libfontconfig-1.dll
-    File ..\..\..\avidemux_2.4_build\libglib-2.0-0.dll
-    File ..\..\..\avidemux_2.4_build\libmp3lame-0.dll
-    File ..\..\..\avidemux_2.4_build\libpng12-0.dll
-    File ..\..\..\avidemux_2.4_build\libx264.dll
-    File ..\..\..\avidemux_2.4_build\libxml2.dll
-    File ..\..\..\avidemux_2.4_build\ogg.dll
-    File ..\..\..\avidemux_2.4_build\pthreadGC2.dll
-    File ..\..\..\avidemux_2.4_build\SDL.dll
-    File ..\..\..\avidemux_2.4_build\vorbis.dll
-    File ..\..\..\avidemux_2.4_build\vorbisenc.dll
-    File ..\..\..\avidemux_2.4_build\xmltok.dll
-    File ..\..\..\avidemux_2.4_build\xvidcore.dll
-    SetOutPath $INSTDIR\etc\fonts
-    File /r ..\..\..\avidemux_2.4_build\etc\fonts\*
+    ${File} &quot;Build Info.txt&quot;
+    ${File} &quot;Change Log.html&quot;
+    ${File} zlib1.dll
+    ${File} libstdc++*.dll
 
-    # if $PROFILE\avidemux exists and $APPDATA\avidemux doesn't, then move it
-    IfFileExists &quot;$PROFILE\avidemux&quot; 0 end
-    IfFileExists &quot;$APPDATA\avidemux&quot; end
+!if ${BUILD_BITS} == 32
+    ${File} freetype6.dll
+	${File} pthreadGC2-w32.dll
+!endif
 
-    Rename &quot;$PROFILE\avidemux&quot; &quot;$APPDATA\avidemux&quot;
+!if ${BUILD_BITS} == 64
+    ${File} libfreetype-6.dll
+	${File} pthreadGC2-w64.dll
+!endif
 
-end:
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; &quot;Core files (required)&quot; 1
+    ${File} libgcc_s_sjlj-1.dll
+	${File} nspr4.dll
+    ${File} libjs.dll
+    ${File} libADM_core6.dll
+    ${File} libADM_coreAudio6.dll
+	${File} libADM_coreAudioDevice6.dll
+	${File} libADM_coreAudioEncoder6.dll
+	${File} libADM_coreAudioFilterAPI6.dll
+	${File} libADM_coreDemuxer6.dll
+	${File} libADM_coreDemuxerMpeg6.dll
+    ${File} libADM_coreImage6.dll
+	${File} libADM_coreImageLoader6.dll
+	${File} libADM_coreJobs.dll
+	${File} libADM_coreMuxer6.dll
+	${File} libADM_coreSocket6.dll
+	${File} libADM_coreSqlLight3.dll
+	${File} libADM_coreTinyPy6.dll
+    ${File} libADM_coreUI6.dll
+	${File} libADM_coreUtils6.dll
+	${File} libADM_coreVideoCodec6.dll
+	${File} libADM_coreVideoEncoder6.dll
+	${File} libADM_coreVideoFilter6.dll
+    ${File} libxml2-*.dll
+    ${File} AUTHORS.
+    ${File} COPYING.
+    ${File} README.
+    ${File} avcodec-*.dll
+    ${File} avformat-*.dll
+    ${File} avutil-*.dll
+    ${File} postproc-*.dll
+    ${File} swscale-*.dll
 SectionEnd
 
 SectionGroup /e &quot;User interfaces&quot; SecGrpUI
-    Section &quot;Command line&quot; SecUiCli
-        SectionIn 1 2
+    ${MementoUnselectedSection} &quot;Command Line&quot; SecUiCli
+        SectionIn 2
         SetOutPath $INSTDIR
         SetOverwrite on
-        File ..\..\..\avidemux_2.4_build\avidemux2_cli.exe
-        WriteRegStr HKLM &quot;${REGKEY}\Components&quot; &quot;Command line&quot; 1
-    SectionEnd
+        ${File} avidemux3_cli.exe
+        ${File} libADM_render6_cli.dll
+        ${File} libADM_UI_Cli6.dll
+    ${MementoSectionEnd}
 
-    Section GTK+ SecUiGtk
-        SectionIn 1 2
+!ifdef INST_BOTH
+	${MementoUnselectedSection} GTK+ SecUiGtk
+	SectionIn 2
+!else ifdef INST_GTK
+	${MementoSection} GTK+ SecUiGtk
+	SectionIn 1 2 RO
+!endif
+!ifdef INST_BOTH | INST_GTK
         SetOverwrite on
         SetOutPath $INSTDIR\etc\gtk-2.0
-        File /r ..\..\..\avidemux_2.4_build\etc\gtk-2.0\*
+        ${Folder} etc\gtk-2.0
         SetOutPath $INSTDIR\etc\pango
-        File /r ..\..\..\avidemux_2.4_build\etc\pango\*
+        ${Folder} etc\pango
         SetOutPath $INSTDIR\lib\gtk-2.0
-        File /r ..\..\..\avidemux_2.4_build\lib\gtk-2.0\*
+        ${Folder} lib\gtk-2.0
         SetOutPath $INSTDIR\share\themes
-        File /r ..\..\..\avidemux_2.4_build\share\themes\*
+        ${Folder} share\themes
         SetOutPath $INSTDIR
-        File ..\..\..\avidemux_2.4_build\avidemux2_gtk.exe
-        File ..\..\..\avidemux_2.4_build\gtk2_prefs.exe
-        File ..\..\..\avidemux_2.4_build\libatk-1.0-0.dll
-        File ..\..\..\avidemux_2.4_build\libcairo-2.dll
-        File ..\..\..\avidemux_2.4_build\libgdk_pixbuf-2.0-0.dll
-        File ..\..\..\avidemux_2.4_build\libgdk-win32-2.0-0.dll
-        File ..\..\..\avidemux_2.4_build\libgmodule-2.0-0.dll
-        File ..\..\..\avidemux_2.4_build\libgobject-2.0-0.dll
-        File ..\..\..\avidemux_2.4_build\libgthread-2.0-0.dll
-        File ..\..\..\avidemux_2.4_build\libgtk-win32-2.0-0.dll
-        File ..\..\..\avidemux_2.4_build\libpango-1.0-0.dll
-        File ..\..\..\avidemux_2.4_build\libpangocairo-1.0-0.dll
-        File ..\..\..\avidemux_2.4_build\libpangowin32-1.0-0.dll
-        WriteRegStr HKLM &quot;${REGKEY}\Components&quot; GTK+ 1
-    SectionEnd
-    
-    Section Qt4 SecUiQt4
-        SectionIn 2
+        ${File} avidemux3_gtk.exe
+        ${File} gtk2_prefs.exe
+		${File} intl.dll
+        ${File} libADM_render_gtk.dll
+        ${File} libADM_UIGtk.dll
+        ${File} libatk-1.0-0.dll
+        ${File} libcairo-2.dll
+        ${File} libgdk_pixbuf-2.0-0.dll
+        ${File} libgdk-win32-2.0-0.dll
+        ${File} libgio-2.0-0.dll
+        ${File} libglib-2.0-0.dll
+        ${File} libgmodule-2.0-0.dll
+        ${File} libgobject-2.0-0.dll
+        ${File} libgthread-2.0-0.dll
+        ${File} libgtk-win32-2.0-0.dll
+        ${File} libpango-1.0-0.dll
+        ${File} libpangocairo-1.0-0.dll
+        ${File} libpangoft2-1.0-0.dll
+        ${File} libpangowin32-1.0-0.dll
+        ${File} libpng14-14.dll
+		${File} SDL.dll
+    ${MementoSectionEnd}
+!endif
+
+!ifdef INST_QT
+    ${MementoSection} Qt SecUiQt
+!ifdef INST_BOTH
+        SectionIn 1 2
+!else
+		SectionIn 1 2 RO
+!endif
         SetOutPath $INSTDIR
         SetOverwrite on
-        File ..\..\..\avidemux_2.4_build\QtGui4.dll
-        File ..\..\..\avidemux_2.4_build\avidemux2_qt4.exe
-        File ..\..\..\avidemux_2.4_build\mingwm10.dll
-        File ..\..\..\avidemux_2.4_build\QtCore4.dll
-        WriteRegStr HKLM &quot;${REGKEY}\Components&quot; Qt4 1
-    SectionEnd    
+        ${File} avidemux3_qt4.exe
+		${File} avidemux3_jobs.exe
+        ${File} libADM_render6_qt4.dll
+        ${File} libADM_UIQT46.dll
+        ${File} QtCore4.dll
+		${File} QtGui4.dll
+		${File} QtOpenGL4.dll
+    ${MementoSectionEnd}
+!endif
 SectionGroupEnd
 
-SectionGroup &quot;Additional languages&quot; SecGrpLang
-    Section &quot;Catalan (GTK+ only)&quot; SecLangCatalan
-        SectionIn 2
-        !insertmacro InstallGtkLanguage Catalan ca
-    SectionEnd
+SectionGroup Plugins SecGrpPlugin
+	SectionGroup &quot;Audio Decoders&quot; SecGrpAudioDecoder
+		${MementoSection} &quot;&#181;-law&quot; SecAudDecUlaw
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioDecoder
+			${File} plugins\audioDecoder\libADM_ad_ulaw.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;AAC (FAAD)&quot; SecAudDecFaad
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioDecoder
+			${File} plugins\audioDecoder\libADM_ad_faad.dll
+			SetOutPath $INSTDIR
+			${File} libfaad2.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;AAC, AC-3, ADPCM IMA AMV, DTS, E-AC-3, MP2, MP3, Nellymoser, QDesign, WMA (libavcodec)&quot; SecAudDecAvcodec
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioDecoder
+			${File} plugins\audioDecoder\libADM_ad_lav.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;AC-3 (liba52)&quot; SecAudDecA52
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioDecoder
+			${File} plugins\audioDecoder\libADM_ad_a52.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;ADPCM IMA&quot; SecAudDecImaAdpcm
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioDecoder
+			${File} plugins\audioDecoder\libADM_ad_ima_adpcm.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;ADPCM Microsoft&quot; SecAudDecMsAdpcm
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioDecoder
+			${File} plugins\audioDecoder\libADM_ad_ms_adpcm.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;AMR-NB&quot; SecAudDecOpencoreAmrNb
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioDecoder
+			${File} plugins\audioDecoder\libADM_ad_opencore_amrnb.dll
+			SetOutPath $INSTDIR
+			${File} libopencore-amrnb-*.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;AMR-WB&quot; SecAudDecOpencoreAmrWb
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioDecoder
+			${File} plugins\audioDecoder\libADM_ad_opencore_amrwb.dll
+			SetOutPath $INSTDIR
+			${File} libopencore-amrwb-*.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MP2, MP3 (MAD)&quot; SecAudDecMad
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioDecoder
+			${File} plugins\audioDecoder\libADM_ad_Mad.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;Vorbis&quot; SecAudDecVorbis
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioDecoder
+			${File} plugins\audioDecoder\libADM_ad_vorbis.dll
+			SetOutPath $INSTDIR
+			${File} libogg-0.dll
+			${File} libvorbis-0.dll
+		${MementoSectionEnd}
+	SectionGroupEnd
+	SectionGroup &quot;Audio Devices&quot; SecGrpAudioDevice
+		${MementoSection} &quot;Waveform&quot; SecAudDevWaveform
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioDevices
+			${File} plugins\audioDevices\libADM_av_win32.dll
+		${MementoSectionEnd}
+	SectionGroupEnd
+	SectionGroup &quot;Audio Encoders&quot; SecGrpAudioEncoder
+		${MementoSection} &quot;AAC (FAAC)&quot; SecAudEncFaac
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioEncoders
+			${File} plugins\audioEncoders\libADM_ae_faac.dll
+			SetOutPath $INSTDIR
+			${File} libfaac.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;AAC (libavcodec)&quot; SecAudEncLavAac
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioEncoders
+			${File} plugins\audioEncoders\libADM_ae_lav_aac.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;AC-3 (Aften)&quot; SecAudDecAften
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioEncoders
+			${File} plugins\audioEncoders\libADM_ae_aften.dll
+			SetOutPath $INSTDIR
+			${File} aften.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;AC-3 (libavcodec)&quot; SecAudEncLavAc3
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioEncoders
+			${File} plugins\audioEncoders\libADM_ae_lav_ac3.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MP2 (libavcodec)&quot; SecAudEncLavMp2
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioEncoders
+			${File} plugins\audioEncoders\libADM_ae_lav_mp2.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MP2 (TwoLAME)&quot; SecAudEncTwoLame
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioEncoders
+			${File} plugins\audioEncoders\libADM_ae_twolame.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MP3&quot; SecAudEncLame
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioEncoders
+			${File} plugins\audioEncoders\libADM_ae_lame.dll
+			SetOutPath $INSTDIR
+			${File} libmp3lame-0.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;PCM&quot; SecAudEncPcm
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioEncoders
+			${File} plugins\audioEncoders\libADM_ae_pcm.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;Vorbis&quot; SecAudEncVorbis
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\audioEncoders
+			${File} plugins\audioEncoders\libADM_ae_vorbis.dll
+			SetOutPath $INSTDIR
+			${File} libogg-0.dll
+			${File} libvorbis-0.dll
+			${File} libvorbisenc-2.dll
+		${MementoSectionEnd}
+	SectionGroupEnd
+	SectionGroup &quot;Demuxers&quot; SecGrpDemuxers
+		${MementoSection} &quot;ASF&quot; SecDemuxAsf
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\demuxers
+			${File} plugins\demuxers\libADM_dm_asf.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;Avisynth Proxy&quot; SecDemuxAvisynth
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\demuxers
+			${File} plugins\demuxers\libADM_dm_avsproxy.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;BMP, JPEG, PNG Images&quot; SecDemuxImage
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\demuxers
+			${File} plugins\demuxers\libADM_dm_pic.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;Flash Video&quot; SecDemuxFlv
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\demuxers
+			${File} plugins\demuxers\libADM_dm_flv.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;Matroska&quot; SecDemuxMatroska
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\demuxers
+			${File} plugins\demuxers\libADM_dm_matroska.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MP4&quot; SecDemuxMp4
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\demuxers
+			${File} plugins\demuxers\libADM_dm_mp4.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MPEG-PS&quot; SecDemuxMpegPs
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\demuxers
+			${File} plugins\demuxers\libADM_dm_ps.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MPEG-TS&quot; SecDemuxMpegTs
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\demuxers
+			${File} plugins\demuxers\libADM_dm_ts.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MXF&quot; SecDemuxMxf
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\demuxers
+			${File} plugins\demuxers\libADM_dm_mxf.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;OpenDML AVI&quot; SecDemuxOpenDml
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\demuxers
+			${File} plugins\demuxers\libADM_dm_opendml.dll
+		${MementoSectionEnd}
+	SectionGroupEnd
+	SectionGroup &quot;Muxers&quot; SecGrpMuxers
+		${MementoSection} &quot;Dummy [Raw Audio/Video]&quot; SecMuxDummy
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\muxers
+			${File} plugins\muxers\libADM_mx_dummy.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;Flash Video&quot; SecMuxLavFlv
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\muxers
+			${File} plugins\muxers\libADM_mx_flv.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;Matroska&quot; SecMuxLavMatroska
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\muxers
+			${File} plugins\muxers\libADM_mx_Mkv.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MP4 (libavcodec)&quot; SecMuxLavMp4
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\muxers
+			${File} plugins\muxers\libADM_mx_mp4.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MP4 (MP4v2)&quot; SecMuxMp4v2
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\muxers
+			${File} plugins\muxers\libADM_mx_mp4v2.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MPEG-PS&quot; SecMuxLavMpegPs
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\muxers
+			${File} plugins\muxers\libADM_mx_ffPS.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MPEG-TS&quot; SecMuxLavMpegTs
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\muxers
+			${File} plugins\muxers\libADM_mx_ffTS.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;OpenDML AVI&quot; SecMuxOpenDml
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\muxers
+			${File} plugins\muxers\libADM_mx_avi.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;Raw Video&quot; SecMuxRaw
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\muxers
+			${File} plugins\muxers\libADM_mx_raw.dll
+		${MementoSectionEnd}
+	SectionGroupEnd
+	SectionGroup &quot;Video Decoders&quot; SecGrpVideoDecoder
+		${MementoSection} &quot;VP8&quot; SecVidDecVpx
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\videoDecoders
+			${File} plugins\videoDecoders\libADM_vd_vpx.dll
+		${MementoSectionEnd}
+	SectionGroupEnd
+	SectionGroup &quot;Video Encoders&quot; SecGrpVideoEncoder
+		${MementoSection} &quot;[Null]&quot; SecVidEncNull
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\videoEncoders
+			${File} plugins\videoEncoders\libADM_ve_null.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;Huffyuv, FFVHuff&quot; SecVidEncLavHuffyuv
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\videoEncoders
+			${File} plugins\videoEncoders\libADM_ve_huff.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;JPEG&quot; SecVidEncLavJpeg
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\videoEncoders
+			${File} plugins\videoEncoders\libADM_ve_jpeg.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MPEG-2&quot; SecVidEncLavMpeg2
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\videoEncoders
+			${File} plugins\videoEncoders\libADM_ve_ffMpeg2.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MPEG-4 ASP (libavcodec)&quot; SecVidEncLavMpeg4asp
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\videoEncoders
+			${File} plugins\videoEncoders\libADM_ve_ffMpeg4.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MPEG-4 ASP (Xvid)&quot; SecVidEncXvid
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\videoEncoders
+			${File} plugins\videoEncoders\libADM_ve_xvid4.dll
+			SetOutPath $INSTDIR
+			${File} xvidcore.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;MPEG-4 AVC&quot; SecVidEncX264
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\videoEncoders
 
-    Section &quot;Czech (GTK+ only)&quot; SecLangCzech
-        SectionIn 2
-        !insertmacro InstallGtkLanguage Czech cs
-    SectionEnd
-
-    Section &quot;French&quot; SecLangFrench
-        SectionIn 2
-        !insertmacro InstallGtkLanguage French fr
-        !insertmacro InstallQt4Language French fr
-    SectionEnd
-
-    Section &quot;German (GTK+ only)&quot; SecLangGerman
-        SectionIn 2
-        !insertmacro InstallGtkLanguage German de
-    SectionEnd
-
-    Section &quot;Greek (GTK+ only)&quot; SecLangGreek
-        SectionIn 2
-        !insertmacro InstallGtkLanguage Greek el
-    SectionEnd
-
-    Section &quot;Italian&quot; SecLangItalian
-        SectionIn 2
-        !insertmacro InstallGtkLanguage Italian it
-        !insertmacro InstallQt4Language Italian it
-    SectionEnd
-
-    Section &quot;Japanese (GTK+ only)&quot; SecLangJapanese
-        SectionIn 2
-        !insertmacro InstallGtkLanguage Japanese ja
-    SectionEnd
-
-    Section &quot;Russian (GTK+ only)&quot; SecLangRussian
-        SectionIn 2
-        !insertmacro InstallGtkLanguage Russian ru
-    SectionEnd
-
-    Section &quot;Serbian Cyrillic (GTK+ only)&quot; SecLangSerbianCyrillic
-        SectionIn 2
-        !insertmacro InstallGtkLanguage SerbianCyrillic sr
-    SectionEnd
-
-    Section &quot;Serbian Latin (GTK+ only)&quot; SecLangSerbianLatin
-        SectionIn 2
-        !insertmacro InstallGtkLanguage SerbianLatin <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">sr at latin</A>
-    SectionEnd
-
-    Section &quot;Spanish (GTK+ only)&quot; SecLangSpanish
-        SectionIn 2
-        !insertmacro InstallGtkLanguage Spanish es
-    SectionEnd
-
-    Section &quot;Turkish (GTK+ only)&quot; SecLangTurkish
-        SectionIn 2
-        !insertmacro InstallGtkLanguage Turkish tr
-    SectionEnd
+			!insertmacro SectionFlagIsSet ${SecUiCli} ${SF_SELECTED} InstallCli CheckGtk
+InstallCli:
+			${File} plugins\videoEncoders\libADM_ve_x264_other.dll
+CheckGtk:
+!ifdef INST_GTK
+			!insertmacro SectionFlagIsSet ${SecUiGtk} ${SF_SELECTED} InstallGtk CheckQt
+InstallGtk:
+			${File} plugins\videoEncoders\libADM_vidEnc_x264_Gtk.dll
+CheckQt:
+!endif
+!ifdef INST_QT
+			!insertmacro SectionFlagIsSet ${SecUiQt} ${SF_SELECTED} InstallQt End
+InstallQt:
+			${File} plugins\videoEncoders\libADM_ve_x264_qt4.dll
+End:
+!endif
+			SetOutPath $INSTDIR
+			${File} libx264-*.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;PNG&quot; SecVidEncLavPng
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\videoEncoders
+			${File} plugins\videoEncoders\libADM_ve_png.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;Sorenson Spark&quot; SecVidEncSorenson
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\videoEncoders
+			${File} plugins\videoEncoders\libADM_ve_ffFlv1.dll
+		${MementoSectionEnd}
+		${MementoSection} &quot;YV12&quot; SecVidEncYv12
+			SectionIn 1 2
+			SetOverwrite on
+			SetOutPath $INSTDIR\plugins\videoEncoders
+			${File} plugins\videoEncoders\libADM_ve_yv12.dll
+		${MementoSectionEnd}
+	SectionGroupEnd
+	SectionGroup &quot;Video Filters&quot; SecGrpVideoFilter
+		SectionGroup &quot;Transform Filters&quot; SecGrpVideoFilterTransform
+			${MementoSection} &quot;Add Black Borders&quot; SecVidFltBlackBorders
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_addBorders.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Add Logo&quot; SecVidFltLogo
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_logo.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Blacken Borders&quot; SecVidFltBlackenBorders
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_blackenBorders.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Change FPS&quot; SecVidFltChangeFps
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_changeFps.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Crop&quot; SecVidFltCrop
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				!insertmacro SectionFlagIsSet ${SecUiCli} ${SF_SELECTED} InstallCli CheckGtk
+InstallCli:
+				${File} plugins\videoFilters\libADM_vf_CropCli.dll
+CheckGtk:
+!ifdef INST_GTK
+				!insertmacro SectionFlagIsSet ${SecUiGtk} ${SF_SELECTED} InstallGtk CheckQt
+InstallGtk:
+				${File} plugins\videoFilters\libADM_vf_CropGtk.dll
+CheckQt:
+!endif
+!ifdef INST_QT
+				!insertmacro SectionFlagIsSet ${SecUiQt} ${SF_SELECTED} InstallQt End
+InstallQt:
+				${File} plugins\videoFilters\libADM_vf_cropQt4.dll
+End:
+!endif
+			${MementoSectionEnd}
+			${MementoSection} &quot;Greyscale&quot; SecVidFltLumaOnly
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_lumaOnly.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Horizontal Flip&quot; SecVidFltHorizontalFlip
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_hf_hflip.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;libswscale Resize&quot; SecVidFltSwscaleResize
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				!insertmacro SectionFlagIsSet ${SecUiCli} ${SF_SELECTED} InstallCli CheckGtk
+InstallCli:
+				${File} plugins\videoFilters\libADM_vf_swscaleResize_cli.dll
+CheckGtk:
+!ifdef INST_GTK
+				!insertmacro SectionFlagIsSet ${SecUiGtk} ${SF_SELECTED} InstallGtk CheckQt
+InstallGtk:
+				${File} plugins\videoFilters\libADM_vf_swscaleResize_gtk.dll
+CheckQt:
+!endif
+!ifdef INST_QT
+				!insertmacro SectionFlagIsSet ${SecUiQt} ${SF_SELECTED} InstallQt End
+InstallQt:
+				${File} plugins\videoFilters\libADM_vf_swscaleResize_qt4.dll
+End:
+!endif
+			${MementoSectionEnd}
+			${MementoSection} &quot;Resample FPS&quot; SecVidFltResampleFps
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_resampleFps.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Rotate&quot; SecVidFltRotate
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_rotate.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Vertical Flip&quot; SecVidFltVerticalFlip
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_vflip.dll
+			${MementoSectionEnd}
+		SectionGroupEnd
+		SectionGroup &quot;Interlacing Filters&quot; SecGrpVideoFilterInterlacing
+			${MementoSection} &quot;Decomb Decimate&quot; SecVidFltDecombDecimate
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_decimate.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Decomb Telecide&quot; SecVidFltDecombTelecide
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_telecide.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Kernel Deint&quot; SecVidFltKernelDeint
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_kernelDeint.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;libavcodec Deinterlacers&quot; SecVidFltLavDeinterlacers
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_lavDeint.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Stack Fields&quot; SecVidFltStackFields
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_stackField.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Unstack Fields&quot; SecVidFltUnstackFields
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_unstackField.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Yadif&quot; SecVidFltYadif
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_yadif.dll
+			${MementoSectionEnd}
+		SectionGroupEnd
+		SectionGroup &quot;Colour Filters&quot; SecGrpVideoFilterColour
+			${MementoSection} &quot;Avisynth Colour YUV&quot; SecVidFltAvisynthColourYuv
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_colorYuv.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Remove Plane&quot; SecVidFltRemovePlane
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_removePlane.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Swap U and V&quot; SecVidFltSwapUandV
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_swapUV.dll
+			${MementoSectionEnd}
+		SectionGroupEnd
+		SectionGroup &quot;Noise Filters&quot; SecGrpVideoFilterNoise
+			${MementoSection} &quot;Gaussian Convolution&quot; SecVidFltGauss
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_gauss.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Large Median (5x5)&quot; SecVidFltMediam5x5
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_largeMedian.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Mean Convolution&quot; SecVidFltMean
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_mean.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Median Convolution&quot; SecVidFltMedian
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_median.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;MPlayer Denoise 3D&quot; SecVidFltMPlayerDenoise3d
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_denoise3d.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;MPlayer Denoise 3D HQ&quot; SecVidFltMPlayerHqdn3d
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_denoise3dhq.dll
+			${MementoSectionEnd}
+		SectionGroupEnd
+		SectionGroup &quot;Sharpness Filters&quot; SecGrpVideoFilterSharpness
+			${MementoSection} &quot;Sharpen&quot; SecVidFltSharpen
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_sharpen.dll
+			${MementoSectionEnd}
+		SectionGroupEnd
+		SectionGroup &quot;Subtitle Filters&quot; SecGrpVideoFilterSubtitle
+			${MementoSection} &quot;ASS, SSA&quot; SecVidFltAssSsa
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_ssa.dll
+				SetOutPath $INSTDIR
+				${File} libfontconfig-1.dll
+				SetOutPath $INSTDIR\etc\fonts
+				${Folder} etc\fonts
+			${MementoSectionEnd}
+		SectionGroupEnd
+		SectionGroup &quot;OpenGL Filters&quot; SecGrpVideoFilterOpenGl
+			${MementoSection} &quot;Fragment Shader&quot; SecVidFltOpenGlFragmentShader
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_sampleGlFrag2.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Read Back Benchmark&quot; SecVidFltOpenGlReadBack
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_glBenchmark.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Resize&quot; SecVidFltOpenGlResize
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_glResize.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Wave&quot; SecVidFltOpenGlWave
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_sampleGlVertex.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Yadif&quot; SecVidFltOpenGlYadif
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_glYadif.dll
+			${MementoSectionEnd}
+		SectionGroupEnd
+		SectionGroup &quot;Miscellaneous Filters&quot; SecGrpVideoFilterMiscellaneous
+			${MementoUnselectedSection} &quot;Dummy&quot; SecVidFltDummy
+				SectionIn 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_dummy.dll
+			${MementoSectionEnd}
+			${MementoSection} &quot;Print Information&quot; SecVidFltPrintInfo
+				SectionIn 1 2
+				SetOverwrite on
+				SetOutPath $INSTDIR\plugins\videoFilters
+				${File} plugins\videoFilters\libADM_vf_printInfo.dll
+			${MementoSectionEnd}
+		SectionGroupEnd
+	SectionGroupEnd
 SectionGroupEnd
 
-Section AvsProxy SecAvsProxy
+${MementoUnselectedSection} &quot;Avisynth Proxy&quot; SecAvsProxy
     SectionIn 2
     SetOutPath $INSTDIR
     SetOverwrite on
-    File /r ..\..\..\avidemux_2.4_build\avsproxy.exe
-    File /r ..\..\..\avidemux_2.4_build\avsproxy_gui.exe
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; &quot;AvsProxy&quot; 1
-SectionEnd
+    ${File} avsproxy.exe
+    ${File} avsproxy_gui.exe
+${MementoSectionEnd}
 
-Section &quot;Sample external filter&quot; SecFilter
-    SectionIn 2
-    SetOutPath $INSTDIR\plugin
-    SetOverwrite on
-    File /r ..\..\..\avidemux_2.4_build\plugin\*
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; &quot;Sample external filter&quot; 1
-SectionEnd
-
-Section &quot;-Start menu Change Log&quot; SecStartMenuChangeLog
+${MementoSection} &quot;-Start menu Change Log&quot; SecStartMenuChangeLog
     CreateDirectory $SMPROGRAMS\$StartMenuGroup
     !insertmacro MUI_STARTMENU_WRITE_BEGIN Application
     SetOutPath $INSTDIR
     CreateShortcut &quot;$SMPROGRAMS\$StartMenuGroup\Change Log.lnk&quot; &quot;$INSTDIR\Change Log.html&quot;
     !insertmacro MUI_STARTMENU_WRITE_END
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; &quot;Start menu&quot; 1
-SectionEnd
+${MementoSectionEnd}
 
-Section &quot;-Start menu GTK+&quot; SecStartMenuGtk
+${MementoSection} &quot;-Start menu GTK+&quot; SecStartMenuGtk
+!ifdef INST_GTK
     CreateDirectory $SMPROGRAMS\$StartMenuGroup
     !insertmacro MUI_STARTMENU_WRITE_BEGIN Application
     SetOutPath $INSTDIR
-    CreateShortcut &quot;$SMPROGRAMS\$StartMenuGroup\${INTERNALNAME} GTK+.lnk&quot; $INSTDIR\avidemux2_gtk.exe
+    CreateShortcut &quot;$SMPROGRAMS\$StartMenuGroup\${SHORTCUT_NAME} GTK+.lnk&quot; $INSTDIR\avidemux2_gtk.exe
     !insertmacro MUI_STARTMENU_WRITE_END
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; &quot;Start menu&quot; 1
-SectionEnd
+!endif
+${MementoSectionEnd}
 
-Section &quot;-Start menu Qt4&quot; SecStartMenuQt4
+${MementoSection} &quot;-Start menu Qt&quot; SecStartMenuQt
+!ifdef INST_QT
     CreateDirectory $SMPROGRAMS\$StartMenuGroup
     !insertmacro MUI_STARTMENU_WRITE_BEGIN Application
     SetOutPath $INSTDIR
-    CreateShortcut &quot;$SMPROGRAMS\$StartMenuGroup\${INTERNALNAME} Qt4.lnk&quot; $INSTDIR\avidemux2_qt4.exe
+    CreateShortcut &quot;$SMPROGRAMS\$StartMenuGroup\${SHORTCUT_NAME}.lnk&quot; $INSTDIR\avidemux2.exe
     !insertmacro MUI_STARTMENU_WRITE_END
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; &quot;Start menu&quot; 1
-SectionEnd
+!endif
+${MementoSectionEnd}
 
-Section &quot;-Start menu AVS Proxy GUI&quot; SecStartMenuAvsProxyGui
+${MementoSection} &quot;-Start menu AVS Proxy GUI&quot; SecStartMenuAvsProxyGui
     CreateDirectory $SMPROGRAMS\$StartMenuGroup
     !insertmacro MUI_STARTMENU_WRITE_BEGIN Application
     SetOutPath $INSTDIR
     CreateShortcut &quot;$SMPROGRAMS\$StartMenuGroup\AVS Proxy GUI.lnk&quot; &quot;$INSTDIR\avsproxy_gui.exe&quot;
     !insertmacro MUI_STARTMENU_WRITE_END
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; &quot;Start menu&quot; 1
-SectionEnd
+${MementoSectionEnd}
 
-Section &quot;-Quick Launch GTK+&quot; SecQuickLaunchGtk
+${MementoSection} &quot;-Quick Launch GTK+&quot; SecQuickLaunchGtk
+!ifdef INST_GTK
     SetOutPath $INSTDIR
-    CreateShortcut &quot;$QUICKLAUNCH\${INTERNALNAME} GTK+.lnk&quot; $INSTDIR\avidemux2_gtk.exe
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; &quot;Quick Launch&quot; 1
-SectionEnd
+    CreateShortcut &quot;$QUICKLAUNCH\${SHORTCUT_NAME} GTK+.lnk&quot; $INSTDIR\avidemux2_gtk.exe
+!endif
+${MementoSectionEnd}
 
-Section &quot;-Quick Launch Qt4&quot; SecQuickLaunchQt4
+${MementoSection} &quot;-Quick Launch Qt&quot; SecQuickLaunchQt
+!ifdef INST_QT
     SetOutPath $INSTDIR
-    CreateShortcut &quot;$QUICKLAUNCH\${INTERNALNAME} Qt4.lnk&quot; $INSTDIR\avidemux2_qt4.exe
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; &quot;Quick Launch&quot; 1
-SectionEnd
+    CreateShortcut &quot;$QUICKLAUNCH\${SHORTCUT_NAME}.lnk&quot; $INSTDIR\avidemux2.exe
+!endif
+${MementoSectionEnd}
 
-Section &quot;-Desktop GTK+&quot; SecDesktopGtk
+${MementoSection} &quot;-Desktop GTK+&quot; SecDesktopGtk
+!ifdef INST_GTK
     SetOutPath $INSTDIR
-    CreateShortcut &quot;$DESKTOP\${INTERNALNAME} GTK+.lnk&quot; $INSTDIR\avidemux2_gtk.exe
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; &quot;Desktop&quot; 1
-SectionEnd
+    CreateShortcut &quot;$DESKTOP\${SHORTCUT_NAME} GTK+.lnk&quot; $INSTDIR\avidemux2_gtk.exe
+!endif
+${MementoSectionEnd}
 
-Section &quot;-Desktop Qt4&quot; SecDesktopQt4
+${MementoSection} &quot;-Desktop Qt&quot; SecDesktopQt
+!ifdef INST_QT
     SetOutPath $INSTDIR
-    CreateShortcut &quot;$DESKTOP\${INTERNALNAME} Qt4.lnk&quot; $INSTDIR\avidemux2_qt4.exe
-    WriteRegStr HKLM &quot;${REGKEY}\Components&quot; &quot;Desktop&quot; 1
-SectionEnd
+    CreateShortcut &quot;$DESKTOP\${SHORTCUT_NAME}.lnk&quot; $INSTDIR\avidemux2.exe
+!endif
+${MementoSectionEnd}
 
+${MementoSectionDone}
+
 Section -post SecUninstaller
     SectionIn 1 2
     WriteRegStr HKLM &quot;${REGKEY}&quot; Path $INSTDIR
+    WriteRegStr HKLM &quot;${REGKEY}&quot; Version ${PRODUCT_VERSION}
     SetOutPath $INSTDIR
     WriteUninstaller $INSTDIR\uninstall.exe
-    WriteRegStr HKLM &quot;${UNINST_REGKEY}&quot; DisplayName &quot;${INTERNALNAME}&quot;
-    WriteRegStr HKLM &quot;${UNINST_REGKEY}&quot; DisplayVersion &quot;${VERSION}&quot;
+    WriteRegStr HKLM &quot;${UNINST_REGKEY}&quot; DisplayName &quot;${SHORTCUT_NAME}&quot;
+    WriteRegStr HKLM &quot;${UNINST_REGKEY}&quot; DisplayVersion &quot;${PRODUCT_VERSION}&quot;
     WriteRegStr HKLM &quot;${UNINST_REGKEY}&quot; DisplayIcon $INSTDIR\uninstall.exe
     WriteRegStr HKLM &quot;${UNINST_REGKEY}&quot; UninstallString $INSTDIR\uninstall.exe
     WriteRegDWORD HKLM &quot;${UNINST_REGKEY}&quot; NoModify 1
     WriteRegDWORD HKLM &quot;${UNINST_REGKEY}&quot; NoRepair 1
 SectionEnd
 
-##########################
-# Uninstaller sections
-##########################
-Section /o &quot;un.Sample external filter&quot; UnSecFilter
-    RmDir /r /REBOOTOK $INSTDIR\plugin
-    DeleteRegValue HKLM &quot;${REGKEY}\Components&quot; &quot;Sample external filter&quot;
+Section -CloseLogFile
+	FileClose $UninstallLogHandle
+	SetFileAttributes ${UninstallLogPath} HIDDEN
 SectionEnd
+ 
+Section Uninstall
+	!insertmacro MUI_STARTMENU_GETFOLDER Application $StartMenuGroup	
 
-Section /o &quot;un.AvsProxy&quot; UnSecAvsProxy
-    Delete /REBOOTOK $INSTDIR\avsproxy.exe
-    Delete /REBOOTOK $INSTDIR\avsproxy_gui.exe
-    DeleteRegValue HKLM &quot;${REGKEY}\Components&quot; &quot;AvsProxy&quot;
-SectionEnd
+!ifdef INST_GTK
+	Delete /REBOOTOK &quot;$QUICKLAUNCH\${SHORTCUT_NAME} GTK+.lnk&quot;
+    Delete /REBOOTOK &quot;$DESKTOP\${SHORTCUT_NAME} GTK+.lnk&quot;
+    Delete /REBOOTOK &quot;$SMPROGRAMS\$StartMenuGroup\${SHORTCUT_NAME} GTK+.lnk&quot;
+!endif
 
-Section /o un.Catalan UnSecLangCatalan
-	!insertmacro UninstallLanguage Catalan ca
-SectionEnd
+!ifdef INST_QT
+    Delete /REBOOTOK &quot;$QUICKLAUNCH\${SHORTCUT_NAME}.lnk&quot;
+    Delete /REBOOTOK &quot;$DESKTOP\${SHORTCUT_NAME}.lnk&quot;
+    Delete /REBOOTOK &quot;$SMPROGRAMS\$StartMenuGroup\${SHORTCUT_NAME}.lnk&quot;
+!endif
 
-Section /o un.Czech UnSecLangCzech
-	!insertmacro UninstallLanguage Czech cs
-SectionEnd
-
-Section /o un.French UnSecLangFrench
-	!insertmacro UninstallLanguage French fr
-SectionEnd
-
-Section /o un.German UnSecLangGerman
-	!insertmacro UninstallLanguage German de
-SectionEnd
-
-Section /o un.Greek UnSecLangGreek
-	!insertmacro UninstallLanguage Greek el
-SectionEnd
-
-Section /o un.Italian UnSecLangItalian
-	!insertmacro UninstallLanguage Italian it
-SectionEnd
-
-Section /o un.Japanese UnSecLangJapanese
-	!insertmacro UninstallLanguage Japanese ja
-SectionEnd
-
-Section /o un.Russian UnSecLangRussian
-	!insertmacro UninstallLanguage Russian ru
-SectionEnd
-
-Section /o un.Serbian UnSecLangSerbianCyrillic
-	!insertmacro UninstallLanguage SerbianCyrillic sr
-SectionEnd
-
-Section /o un.SerbianLatin UnSecLangSerbianLatin
-	!insertmacro UninstallLanguage SerbianLatin <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">sr at latin</A>
-SectionEnd
-
-Section /o un.Spanish UnSecLangSpanish
-	!insertmacro UninstallLanguage Spanish es
-SectionEnd
-
-Section /o un.Turkish UnSecLangTurkish
-	!insertmacro UninstallLanguage Turkish tr
-SectionEnd
-
-Section /o un.GTK+ UnSecUiGtk
-    Delete /REBOOTOK $INSTDIR\libpangowin32-1.0-0.dll
-    Delete /REBOOTOK $INSTDIR\libpangocairo-1.0-0.dll
-    Delete /REBOOTOK $INSTDIR\libpango-1.0-0.dll
-    Delete /REBOOTOK $INSTDIR\libgtk-win32-2.0-0.dll
-    Delete /REBOOTOK $INSTDIR\libgthread-2.0-0.dll
-    Delete /REBOOTOK $INSTDIR\libgobject-2.0-0.dll
-    Delete /REBOOTOK $INSTDIR\libgmodule-2.0-0.dll
-    Delete /REBOOTOK $INSTDIR\libgdk-win32-2.0-0.dll
-    Delete /REBOOTOK $INSTDIR\libgdk_pixbuf-2.0-0.dll
-    Delete /REBOOTOK $INSTDIR\libcairo-2.dll
-    Delete /REBOOTOK $INSTDIR\libatk-1.0-0.dll
-    Delete /REBOOTOK $INSTDIR\gtk2_prefs.exe
-    Delete /REBOOTOK $INSTDIR\avidemux2_gtk.exe
-    RmDir /r /REBOOTOK $INSTDIR\share\themes
-    RmDir /r /REBOOTOK $INSTDIR\lib\gtk-2.0
-    RmDir /r /REBOOTOK $INSTDIR\etc\gtk-2.0
-    RmDir /r /REBOOTOK $INSTDIR\etc\pango
-    DeleteRegValue HKLM &quot;${REGKEY}\Components&quot; GTK+
-SectionEnd
-
-Section /o un.Qt4 UnSecUiQt4
-    Delete /REBOOTOK $INSTDIR\QtCore4.dll
-    Delete /REBOOTOK $INSTDIR\mingwm10.dll
-    Delete /REBOOTOK $INSTDIR\avidemux2_qt4.exe
-    Delete /REBOOTOK $INSTDIR\QtGui4.dll
-    DeleteRegValue HKLM &quot;${REGKEY}\Components&quot; Qt4
-SectionEnd
-
-Section /o &quot;un.Command line&quot; UnSecUiCli
-    Delete /REBOOTOK $INSTDIR\avidemux2_cli.exe
-    DeleteRegValue HKLM &quot;${REGKEY}\Components&quot; &quot;Command line&quot;
-SectionEnd
-
-Section /o &quot;un.Core files (required)&quot; UnSecCore
-    Delete /REBOOTOK $INSTDIR\xvidcore.dll
-    Delete /REBOOTOK $INSTDIR\xmltok.dll
-    Delete /REBOOTOK $INSTDIR\vorbisenc.dll
-    Delete /REBOOTOK $INSTDIR\vorbis.dll
-    Delete /REBOOTOK $INSTDIR\SDL.dll
-    Delete /REBOOTOK $INSTDIR\pthreadGC2.dll
-    Delete /REBOOTOK $INSTDIR\ogg.dll
-    Delete /REBOOTOK $INSTDIR\libxml2.dll
-    Delete /REBOOTOK $INSTDIR\libx264.dll
-    Delete /REBOOTOK $INSTDIR\libpng12-0.dll
-    Delete /REBOOTOK $INSTDIR\libmp3lame-0.dll
-    Delete /REBOOTOK $INSTDIR\libglib-2.0-0.dll
-    Delete /REBOOTOK $INSTDIR\libfontconfig-1.dll
-    Delete /REBOOTOK $INSTDIR\libfaad2.dll
-    Delete /REBOOTOK $INSTDIR\libfaac.dll
-    Delete /REBOOTOK $INSTDIR\libexpat.dll
-    Delete /REBOOTOK $INSTDIR\libaften.dll
-    Delete /REBOOTOK $INSTDIR\intl.dll
-    Delete /REBOOTOK $INSTDIR\iconv.dll
-    Delete /REBOOTOK $INSTDIR\freetype6.dll
-    Delete /REBOOTOK $INSTDIR\zlib1.dll
-    Delete /REBOOTOK &quot;$INSTDIR\Build Info.txt&quot;
-    Delete /REBOOTOK &quot;$INSTDIR\Change Log.html&quot;
-    Delete /REBOOTOK &quot;$INSTDIR\stdout.txt&quot;
-    Delete /REBOOTOK &quot;$INSTDIR\stderr.txt&quot;
-    RmDir /r /REBOOTOK $INSTDIR\etc\fonts
-    DeleteRegValue HKLM &quot;${REGKEY}\Components&quot; Avidemux
-    
-    RmDir /REBOOTOK $INSTDIR\share\gettext
-    RmDir /REBOOTOK $INSTDIR\share
-SectionEnd
-
-Section /o &quot;un.Start menu&quot; UnSecStartMenu
-    Delete /REBOOTOK &quot;$SMPROGRAMS\$StartMenuGroup\Change Log.lnk&quot;
-    Delete /REBOOTOK &quot;$SMPROGRAMS\$StartMenuGroup\${INTERNALNAME} GTK+.lnk&quot;
-    Delete /REBOOTOK &quot;$SMPROGRAMS\$StartMenuGroup\${INTERNALNAME} Qt4.lnk&quot;
+	Delete /REBOOTOK &quot;$SMPROGRAMS\$StartMenuGroup\Change Log.lnk&quot;
     Delete /REBOOTOK &quot;$SMPROGRAMS\$StartMenuGroup\AVS Proxy GUI.lnk&quot;
-SectionEnd
-
-Section /o &quot;un.Quick Launch&quot; UnSecQuickLaunch
-    Delete /REBOOTOK &quot;$QUICKLAUNCH\${INTERNALNAME} GTK+.lnk&quot;
-    Delete /REBOOTOK &quot;$QUICKLAUNCH\${INTERNALNAME} Qt4.lnk&quot;
-SectionEnd
-
-Section /o &quot;un.Desktop&quot; UnSecDesktop
-    Delete /REBOOTOK &quot;$DESKTOP\${INTERNALNAME} GTK+.lnk&quot;
-    Delete /REBOOTOK &quot;$DESKTOP\${INTERNALNAME} Qt4.lnk&quot;
-SectionEnd
-
-Section un.post UnSecUninstaller
-    RmDir /REBOOTOK $INSTDIR\etc
-    RmDir /REBOOTOK $INSTDIR\i18n
-    RmDir /REBOOTOK $INSTDIR\lib
-    RmDir /REBOOTOK $INSTDIR\share\locale
-    RmDir /REBOOTOK $INSTDIR\share
+    RmDir /REBOOTOK $SMPROGRAMS\$StartMenuGroup
+    DeleteRegValue HKLM &quot;${REGKEY}&quot; StartMenuGroup
     
     DeleteRegKey HKLM &quot;${UNINST_REGKEY}&quot;
-    Delete /REBOOTOK $INSTDIR\uninstall.exe
-    DeleteRegValue HKLM &quot;${REGKEY}&quot; StartMenuGroup
     DeleteRegValue HKLM &quot;${REGKEY}&quot; Path
-    DeleteRegKey /IfEmpty HKLM &quot;${REGKEY}\Components&quot;
     DeleteRegKey /IfEmpty HKLM &quot;${REGKEY}&quot;
-    RmDir /REBOOTOK $SMPROGRAMS\$StartMenuGroup
-    RmDir /REBOOTOK $INSTDIR
-    Push $R0
-    StrCpy $R0 $StartMenuGroup 1
-    StrCmp $R0 &quot;&gt;&quot; no_smgroup
-no_smgroup:
+
+	FileOpen $UninstallLogHandle &quot;${UninstallLogPath}&quot; r
+UninstallLoop:
+    ClearErrors
+    FileRead $UninstallLogHandle $R0
+    IfErrors UninstallEnd
+	Push $R0
+    Call un.TrimNewLines
     Pop $R0
+    Delete &quot;$R0&quot;
+    Goto UninstallLoop
+UninstallEnd:
+	FileClose $UninstallLogHandle
+	Delete &quot;${UninstallLogPath}&quot;
+	Delete &quot;$INSTDIR\uninstall.exe&quot;
+	Push &quot;\&quot;
+	Call un.RemoveEmptyDirs
+	RMDir &quot;$INSTDIR&quot;
 SectionEnd
 
 ##########################
 # Installer functions
 ##########################
 Function .onInit
-    ReadRegStr $R0  HKLM &quot;${UNINST_REGKEY}&quot; &quot;UninstallString&quot;
-    StrCmp $R0 &quot;&quot; startInstall
- 
-    MessageBox MB_YESNO|MB_ICONEXCLAMATION &quot;${INTERNALNAME} has already been installed. $\n$\nDo you want to remove \
-      the previous version before installing $(^Name)?&quot; IDNO startInstall
-  
-    # Run the uninstaller
-    ClearErrors
-    ExecWait '$R0 _?=$INSTDIR' ; Do not copy the uninstaller to a temp file
+	Call LoadPreviousSettings
 
-startInstall:
+	ReadRegStr $PreviousVersion HKLM &quot;${REGKEY}&quot; Version
+
+	${If} $PreviousVersion != &quot;&quot;
+		${VersionCompare} ${PRODUCT_VERSION} $PreviousVersion $PreviousVersionState
+	${EndIf}
+	
     InitPluginsDir
-    
-    !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;${INSTALL_OPTS_INI}&quot;
+    SetShellVarContext all
+FunctionEnd
 
-    # Make sure a User Interface is selected in previous install preferences
-    ReadRegStr $0 HKLM &quot;${REGKEY}\Components&quot; &quot;Command line&quot;
-    StrCmp $0 1 populate
-    ReadRegStr $0 HKLM &quot;${REGKEY}\Components&quot; &quot;GTK+&quot;
-    StrCmp $0 1 populate
-    ReadRegStr $0 HKLM &quot;${REGKEY}\Components&quot; &quot;Qt4&quot;
-    StrCmp $0 1 populate
-
-    # No UI exists, so go with defaults
-    Goto end
-
-    #Select sections based on last install
-populate:
-    !insertmacro MUI_STARTMENU_GETFOLDER Application $StartMenuGroup
-    !insertmacro SELECT_SECTION &quot;Command line&quot; ${SecUiCli}
-    !insertmacro SELECT_SECTION Qt4 ${SecUiQt4}
-    !insertmacro SELECT_SECTION GTK+ ${SecUiGtk}
-    !insertmacro SELECT_SECTION Catalan ${SecLangCatalan}
-    !insertmacro SELECT_SECTION Czech ${SecLangCzech}
-    !insertmacro SELECT_SECTION French ${SecLangFrench}
-    !insertmacro SELECT_SECTION German ${SecLangGerman}
-    !insertmacro SELECT_SECTION Greek ${SecLangGreek}
-    !insertmacro SELECT_SECTION Italian ${SecLangItalian}
-    !insertmacro SELECT_SECTION Japanese ${SecLangJapanese}
-    !insertmacro SELECT_SECTION Russian ${SecLangRussian}
-    !insertmacro SELECT_SECTION SerbianCyrillic ${SecLangSerbianCyrillic}
-    !insertmacro SELECT_SECTION SerbianLatin ${SecLangSerbianLatin}
-    !insertmacro SELECT_SECTION Spanish ${SecLangSpanish}
-    !insertmacro SELECT_SECTION Turkish ${SecLangTurkish}
-    !insertmacro SELECT_SECTION &quot;Sample external filter&quot; ${SecFilter}
-    !insertmacro SELECT_SECTION AvsProxy ${SecAvsProxy}
-
-    #startMenu:
-    ReadRegStr $0 HKLM &quot;${REGKEY}\Components&quot; &quot;Start menu&quot;
-    !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;${INSTALL_OPTS_INI}&quot; &quot;Field 3&quot; &quot;State&quot; $0
-    
-    #desktop:
-    ReadRegStr $0 HKLM &quot;${REGKEY}\Components&quot; &quot;Desktop&quot;
-    !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;${INSTALL_OPTS_INI}&quot; &quot;Field 2&quot; &quot;State&quot; $0
-    
-    #quickLaunch:
-    ReadRegStr $0 HKLM &quot;${REGKEY}\Components&quot; &quot;Quick Launch&quot;
-    !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;${INSTALL_OPTS_INI}&quot; &quot;Field 4&quot; &quot;State&quot; $0
-    
-end:
+Function .onInstSuccess
+	${MementoSectionSave}
 FunctionEnd
 
+!ifdef INST_BOTH
 Function .onSelChange
 	!insertmacro SectionFlagIsSet ${SecUiGtk} ${SF_SELECTED} end checkCLI
 checkCLI:
 	!insertmacro SectionFlagIsSet ${SecUiCli} ${SF_SELECTED} end disable
-	
+
 disable:  # GTK langs only
 	SectionSetFlags ${SecLangCatalan} SF_RO
 	SectionSetFlags ${SecLangCzech} SF_RO
 	SectionSetFlags ${SecLangFrench} SF_RO
 	SectionSetFlags ${SecLangGerman} SF_RO
-	SectionSetFlags ${SecLangGreek} SF_RO	
+	SectionSetFlags ${SecLangGreek} SF_RO
 	SectionSetFlags ${SecLangJapanese} SF_RO
 	SectionSetFlags ${SecLangRussian} SF_RO
 	SectionSetFlags ${SecLangSerbianCyrillic} SF_RO
@@ -656,7 +1193,66 @@
 	SectionSetFlags ${SecLangTurkish} SF_RO
 end:
 FunctionEnd
+!endif
 
+Function LoadPreviousSettings
+    ${MementoSectionRestore}
+	!insertmacro MUI_STARTMENU_GETFOLDER Application $StartMenuGroup
+
+#checkStartMenuGtk:
+	!insertmacro SectionFlagIsSet ${SecStartMenuGtk} ${SF_SELECTED} enableStartMenu checkStartMenuQt
+checkStartMenuQt:
+	!insertmacro SectionFlagIsSet ${SecStartMenuQt} ${SF_SELECTED} enableStartMenu checkDesktopGtk
+
+enableStartMenu:
+	StrCpy $CreateStartMenuGroup 1
+
+checkDesktopGtk:
+	!insertmacro SectionFlagIsSet ${SecDesktopGtk} ${SF_SELECTED} enableDesktop checkDesktopQt
+checkDesktopQt:
+	!insertmacro SectionFlagIsSet ${SecDesktopQt} ${SF_SELECTED} enableDesktop checkQuickLaunchGtk
+
+enableDesktop:
+	StrCpy $CreateDesktopIcon 1
+	
+checkQuickLaunchGtk:
+	!insertmacro SectionFlagIsSet ${SecQuickLaunchGtk} ${SF_SELECTED} enableQuickLaunch checkQuickLaunchQt
+checkQuickLaunchQt:
+	!insertmacro SectionFlagIsSet ${SecQuickLaunchQt} ${SF_SELECTED} enableQuickLaunch end
+
+enableQuickLaunch:
+	StrCpy $CreateQuickLaunchIcon 1	
+
+end:
+FunctionEnd
+
+Function RunUninstaller
+    ReadRegStr $R1  HKLM &quot;${UNINST_REGKEY}&quot; &quot;UninstallString&quot;
+
+	${If} $R1 == &quot;&quot;
+		Return
+	${EndIf}
+
+	;Run uninstaller
+	HideWindow
+	ClearErrors
+	
+	${If} $PreviousVersionState == 0
+	${AndIf} $ReinstallUninstall == 1
+		ExecWait '$R1 _?=$INSTDIR'
+	${Else}
+		ExecWait '$R1 /frominstall _?=$INSTDIR'
+	${EndIf}
+
+	IfErrors NoRemoveUninstaller
+	IfFileExists &quot;$INSTDIR\uninstall.exe&quot; 0 NoRemoveUninstaller
+		Delete &quot;$R1&quot;
+		RMDir $INSTDIR
+
+NoRemoveUninstaller:
+FunctionEnd
+
+!ifdef INST_BOTH
 Function CheckSelectedUIs
 	!insertmacro SectionFlagIsSet ${SecGrpUI} ${SF_SELECTED} end checkPartial
 checkPartial:
@@ -666,24 +1262,67 @@
     Abort
 end:
 FunctionEnd
+!endif
 
 LangString INSTALL_OPTS_PAGE_TITLE ${LANG_ENGLISH} &quot;Choose Install Options&quot;
 LangString INSTALL_OPTS_PAGE_SUBTITLE ${LANG_ENGLISH} &quot;Choose where to install Avidemux icons.&quot;
+Var dlgInstallOptions
+Var lblCreateIcons
+Var chkDesktop
+Var chkStartMenu
+Var chkQuickLaunch
 
 Function InstallOptionsPage
-    Call IsInstallOptionsRequired
+	Call IsInstallOptionsRequired
+	!insertmacro MUI_HEADER_TEXT &quot;$(INSTALL_OPTS_PAGE_TITLE)&quot; &quot;$(INSTALL_OPTS_PAGE_SUBTITLE)&quot;
 
-    !insertmacro MUI_HEADER_TEXT &quot;$(INSTALL_OPTS_PAGE_TITLE)&quot; &quot;$(INSTALL_OPTS_PAGE_SUBTITLE)&quot;
-    !insertmacro MUI_INSTALLOPTIONS_DISPLAY &quot;${INSTALL_OPTS_INI}&quot;
-    
-    Call ReadInstallOptions
+	nsDialogs::Create 1018
+	Pop $dlgInstallOptions
+
+	${If} $dlgInstallOptions == error
+		Abort
+	${EndIf}
+
+	${NSD_CreateLabel} 0 0u 100% 12u &quot;Create icons for Avidemux:&quot;
+	Pop $lblCreateIcons
+
+	${NSD_CreateCheckBox} 0 18u 100% 12u &quot;On my &amp;Desktop&quot;
+	Pop $chkDesktop
+	${NSD_SetState} $chkDesktop $CreateDesktopIcon
+	${NSD_OnClick} $chkDesktop UpdateInstallOptions
+
+	${NSD_CreateCheckBox} 0 36u 100% 12u &quot;In my &amp;Start Menu Programs folder&quot;
+	Pop $chkStartMenu
+	${NSD_SetState} $chkStartMenu $CreateStartMenuGroup
+	${NSD_OnClick} $chkStartMenu UpdateInstallOptions
+
+	${NSD_CreateCheckBox} 0 54u 100% 12u &quot;In my &amp;Quick Launch bar&quot;
+	Pop $chkQuickLaunch
+	${NSD_SetState} $chkQuickLaunch $CreateQuickLaunchIcon
+	${NSD_OnClick} $chkQuickLaunch UpdateInstallOptions
+
+	nsDialogs::Show
 FunctionEnd
 
+Function UpdateInstallOptions
+	${NSD_GetState} $chkDesktop $CreateDesktopIcon
+	${NSD_GetState} $chkStartMenu $CreateStartMenuGroup
+	${NSD_GetState} $chkQuickLaunch $CreateQuickLaunchIcon
+FunctionEnd
+
 Function IsInstallOptionsRequired
-	!insertmacro SectionFlagIsSet ${SecUiGtk} ${SF_SELECTED} end resetOptions
-	!insertmacro SectionFlagIsSet ${SecUiQt4} ${SF_SELECTED} end resetOptions
+!ifdef INST_GTK
+	!insertmacro SectionFlagIsSet ${SecUiGtk} ${SF_SELECTED} end checkQt
+checkQt:
+!ifndef INST_BOTH
+Goto end
+!endif
+!endif
+!ifdef INST_QT
+	!insertmacro SectionFlagIsSet ${SecUiQt} ${SF_SELECTED} end resetOptions
+resetOptions:
+!endif
 
-resetOptions:
     StrCpy $CreateDesktopIcon 0
     StrCpy $CreateStartMenuGroup 0
     StrCpy $CreateQuickLaunchIcon 0
@@ -692,15 +1331,9 @@
 end:
 FunctionEnd
 
-Function ReadInstallOptions
-    !insertmacro MUI_INSTALLOPTIONS_READ $CreateDesktopIcon &quot;${INSTALL_OPTS_INI}&quot; &quot;Field 2&quot; &quot;State&quot;
-    !insertmacro MUI_INSTALLOPTIONS_READ $CreateStartMenuGroup &quot;${INSTALL_OPTS_INI}&quot; &quot;Field 3&quot; &quot;State&quot;
-    !insertmacro MUI_INSTALLOPTIONS_READ $CreateQuickLaunchIcon &quot;${INSTALL_OPTS_INI}&quot; &quot;Field 4&quot; &quot;State&quot;
-FunctionEnd
-
 Function IsStartMenuRequired
     StrCmp $CreateStartMenuGroup 1 +2
-        Abort    
+        Abort
 FunctionEnd
 
 Function ActivateInternalSections
@@ -709,105 +1342,260 @@
     IntOp $0 $0 &amp; ${SF_SELECTED}
     IntOp $0 $0 &amp; $CreateStartMenuGroup
     SectionSetFlags ${SecStartMenuAvsProxyGui} $0
-    
+
     #Change Log shortcut:
     SectionSetFlags ${SecStartMenuChangeLog} $CreateStartMenuGroup
 
+!ifdef INST_GTK
     #GTK shortcuts:
     SectionGetFlags ${SecUiGtk} $0
     IntOp $0 $0 &amp; ${SF_SELECTED}
 
     IntOp $1 $0 &amp; $CreateDesktopIcon
     SectionSetFlags ${SecDesktopGtk} $1
-    
+
     IntOp $1 $0 &amp; $CreateQuickLaunchIcon
     SectionSetFlags ${SecQuickLaunchGtk} $1
-    
+
     IntOp $1 $0 &amp; $CreateStartMenuGroup
     SectionSetFlags ${SecStartMenuGtk} $1
-    
-    #Qt4 shortcuts:
-    SectionGetFlags ${SecUiQt4} $0
+!endif
+
+!ifdef INST_QT
+    #Qt shortcuts:
+    SectionGetFlags ${SecUiQt} $0
     IntOp $0 $0 &amp; ${SF_SELECTED}
-    
+
     IntOp $1 $0 &amp; $CreateDesktopIcon
-    SectionSetFlags ${SecDesktopQt4} $1
-    
+    SectionSetFlags ${SecDesktopQt} $1
+
     IntOp $1 $0 &amp; $CreateQuickLaunchIcon
-    SectionSetFlags ${SecQuickLaunchQt4} $1
-    
+    SectionSetFlags ${SecQuickLaunchQt} $1
+
     IntOp $1 $0 &amp; $CreateStartMenuGroup
-    SectionSetFlags ${SecStartMenuQt4} $1
+    SectionSetFlags ${SecStartMenuQt} $1
+!endif
 FunctionEnd
 
+Function InstFilesPageShow
+	${If} $ReinstallUninstall != &quot;&quot;
+		Call RunUninstaller
+		BringToFront
+	${EndIf}
+FunctionEnd
+
+Function InstFilesPageLeave
+	; Don't advance automatically if details expanded
+	FindWindow $R0 &quot;#32770&quot; &quot;&quot; $HWNDPARENT
+	GetDlgItem $R0 $R0 1016
+	System::Call user32::IsWindowVisible(i$R0)i.s
+	Pop $R0
+
+	StrCmp $R0 0 +2
+	SetAutoClose false
+FunctionEnd
+
 Function ConfigureFinishPage
+!ifdef INST_GTK
     SectionGetFlags ${SecUiGtk} $0
     IntOp $0 $0 &amp; ${SF_SELECTED}
     StrCmp $0 ${SF_SELECTED} end
-    
-    SectionGetFlags ${SecUiQt4} $0
+!endif
+
+!ifdef INST_QT
+    SectionGetFlags ${SecUiQt} $0
     IntOp $0 $0 &amp; ${SF_SELECTED}
     StrCmp $0 ${SF_SELECTED} end
+!endif
 
     DeleteINISec &quot;$PLUGINSDIR\ioSpecial.ini&quot; &quot;Field 4&quot;
-        
+
 end:
 FunctionEnd
 
-Function OnShowFinishPage
-    # Make hyperlink underlined to keep it consistent with web browsers
-    GetDlgItem $0 $MUI_HWND 1205
-    CreateFont $1 &quot;$(^Font)&quot; 9 500 /UNDERLINE
-    SendMessage $0 ${WM_SETFONT} $1 0    
-FunctionEnd
-
 Function RunAvidemux
     SetOutPath $INSTDIR
 
-#GTK:
-    SectionGetFlags ${SecUiGtk} $0
+!ifdef INST_QT
+#Qt:
+    SectionGetFlags ${SecUiQt} $0
     IntOp $0 $0 &amp; ${SF_SELECTED}
-    
-    StrCmp $0 ${SF_SELECTED} 0 Qt4
-        Exec &quot;$INSTDIR\avidemux2_gtk.exe&quot;
 
+    StrCmp $0 ${SF_SELECTED} 0 GTK
+        Exec &quot;$INSTDIR\avidemux3_qt4.exe&quot;
+
     Goto end
-    
-Qt4:
-    SectionGetFlags ${SecUiQt4} $0
+GTK:
+!endif
+
+!ifdef INST_GTK
+    SectionGetFlags ${SecUiGtk} $0
     IntOp $0 $0 &amp; ${SF_SELECTED}
-    
+
     StrCmp $0 ${SF_SELECTED} 0 End
-        Exec &quot;$INSTDIR\avidemux2_qt4.exe&quot;    
-    
+        Exec &quot;$INSTDIR\avidemux3_gtk.exe&quot;
+!endif
+
 end:
 FunctionEnd
 
+Var ReinstallUninstallButton
+
+Function ReinstallPage
+	${If} $PreviousVersion == &quot;&quot;
+		Abort
+	${EndIf}
+
+	nsDialogs::Create /NOUNLOAD 1018
+	Pop $0
+
+	${If} $PreviousVersionState == 1
+		!insertmacro MUI_HEADER_TEXT &quot;Already Installed&quot; &quot;Choose how you want to install ${PRODUCT_FULLNAME}.&quot;
+		nsDialogs::CreateItem /NOUNLOAD STATIC ${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS} 0 0 0 100% 40 &quot;An older version of Avidemux is installed on your system.  Select the operation you want to perform and click Next to continue.&quot;
+		Pop $R0
+		nsDialogs::CreateItem /NOUNLOAD BUTTON ${BS_AUTORADIOBUTTON}|${BS_VCENTER}|${BS_MULTILINE}|${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS}|${WS_GROUP}|${WS_TABSTOP} 0 10 55 100% 30 &quot;Upgrade Avidemux using previous settings (recommended)&quot;
+		Pop $ReinstallUninstallButton
+		nsDialogs::CreateItem /NOUNLOAD BUTTON ${BS_AUTORADIOBUTTON}|${BS_TOP}|${BS_MULTILINE}|${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS} 0 10 85 100% 50 &quot;Change settings (advanced)&quot;
+		Pop $R0
+
+		${If} $ReinstallUninstall == &quot;&quot;
+			StrCpy $ReinstallUninstall 1
+		${EndIf}
+	${ElseIf} $PreviousVersionState == 2
+		!insertmacro MUI_HEADER_TEXT &quot;Already Installed&quot; &quot;Choose how you want to install ${PRODUCT_FULLNAME}.&quot;
+		nsDialogs::CreateItem /NOUNLOAD STATIC ${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS} 0 0 0 100% 40 &quot;A newer version of Avidemux is already installed! It is not recommended that you downgrade to an older version. Select the operation you want to perform and click Next to continue.&quot;
+		Pop $R0
+		nsDialogs::CreateItem /NOUNLOAD BUTTON ${BS_AUTORADIOBUTTON}|${BS_VCENTER}|${BS_MULTILINE}|${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS}|${WS_GROUP}|${WS_TABSTOP} 0 10 55 100% 30 &quot;Downgrade Avidemux using previous settings (recommended)&quot;
+		Pop $ReinstallUninstallButton
+		nsDialogs::CreateItem /NOUNLOAD BUTTON ${BS_AUTORADIOBUTTON}|${BS_TOP}|${BS_MULTILINE}|${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS} 0 10 85 100% 50 &quot;Change settings (advanced)&quot;
+		Pop $R0
+
+		${If} $ReinstallUninstall == &quot;&quot;
+			StrCpy $ReinstallUninstall 1
+		${EndIf}
+	${ElseIf} $PreviousVersionState == 0
+		!insertmacro MUI_HEADER_TEXT &quot;Already Installed&quot; &quot;Choose the maintenance option to perform.&quot;
+		nsDialogs::CreateItem /NOUNLOAD STATIC ${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS} 0 0 0 100% 40 &quot;${PRODUCT_FULLNAME} is already installed. Select the operation you want to perform and click Next to continue.&quot;
+		Pop $R0
+		nsDialogs::CreateItem /NOUNLOAD BUTTON ${BS_AUTORADIOBUTTON}|${BS_VCENTER}|${BS_MULTILINE}|${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS}|${WS_GROUP}|${WS_TABSTOP} 0 10 55 100% 30 &quot;Add/Remove/Reinstall components&quot;
+		Pop $R0
+		nsDialogs::CreateItem /NOUNLOAD BUTTON ${BS_AUTORADIOBUTTON}|${BS_TOP}|${BS_MULTILINE}|${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS} 0 10 85 100% 50 &quot;Uninstall Avidemux&quot;
+		Pop $ReinstallUninstallButton
+
+		${If} $ReinstallUninstall == &quot;&quot;
+			StrCpy $ReinstallUninstall 2
+		${EndIf}
+	${Else}
+		MessageBox MB_ICONSTOP &quot;Unknown value of PreviousVersionState, aborting&quot; /SD IDOK
+		Abort
+	${EndIf}
+
+	${If} $ReinstallUninstall == &quot;1&quot;
+		SendMessage $ReinstallUninstallButton ${BM_SETCHECK} 1 0
+	${Else}
+		SendMessage $R0 ${BM_SETCHECK} 1 0
+	${EndIf}
+
+	nsDialogs::Show
+FunctionEnd
+
+Function ReinstallPageLeave
+	SendMessage $ReinstallUninstallButton ${BM_GETCHECK} 0 0 $R0
+
+	${If} $R0 == 1
+		; Option to uninstall old version selected
+		StrCpy $ReinstallUninstall 1
+	${Else}
+		; Custom up/downgrade or add/remove/reinstall
+		StrCpy $ReinstallUninstall 2
+	${EndIf}
+
+	${If} $ReinstallUninstall == 1
+		${If} $PreviousVersionState == 0
+			Call RunUninstaller
+			Quit
+		${Else}
+			; Need to reload defaults. User could have
+			; chosen custom, change something, went back and selected
+			; the express option.
+			Call LoadPreviousSettings
+		${EndIf}
+	${EndIf}
+FunctionEnd
+
+
 ##########################
 # Uninstaller functions
 ##########################
 Function un.onInit
-    ReadRegStr $INSTDIR HKLM &quot;${REGKEY}&quot; Path
-    !insertmacro MUI_STARTMENU_GETFOLDER Application $StartMenuGroup
-    !insertmacro SELECT_SECTION &quot;Core files (required)&quot; ${UnSecCore}
-    !insertmacro SELECT_SECTION &quot;Command line&quot; ${UnSecUiCli}
-    !insertmacro SELECT_SECTION Qt4 ${UnSecUiQt4}
-    !insertmacro SELECT_SECTION GTK+ ${UnSecUiGtk}
-    !insertmacro SELECT_SECTION Catalan ${UnSecLangCatalan}
-    !insertmacro SELECT_SECTION Czech ${UnSecLangCzech}
-    !insertmacro SELECT_SECTION French ${UnSecLangFrench}
-    !insertmacro SELECT_SECTION German ${UnSecLangGerman}
-    !insertmacro SELECT_SECTION Greek ${UnSecLangGreek}
-    !insertmacro SELECT_SECTION Italian ${UnSecLangItalian}
-    !insertmacro SELECT_SECTION Japanese ${UnSecLangJapanese}
-    !insertmacro SELECT_SECTION Russian ${UnSecLangRussian}
-    !insertmacro SELECT_SECTION SerbianCyrillic ${UnSecLangSerbianCyrillic}
-    !insertmacro SELECT_SECTION SerbianLatin ${UnSecLangSerbianLatin}
-    !insertmacro SELECT_SECTION Spanish ${UnSecLangSpanish}
-    !insertmacro SELECT_SECTION Turkish ${UnSecLangTurkish}
-    !insertmacro SELECT_SECTION AvsProxy ${UnSecAvsProxy}
-    !insertmacro SELECT_SECTION &quot;Sample external filter&quot; ${UnSecFilter}
-    !insertmacro SELECT_SECTION &quot;Start menu&quot; ${UnSecStartMenu}
-    !insertmacro SELECT_SECTION &quot;Quick Launch&quot; ${UnSecQuickLaunch}
-    !insertmacro SELECT_SECTION &quot;Desktop&quot; ${UnSecDesktop}
+	SetShellVarContext all
 FunctionEnd
+
+; TrimNewlines (copied from NSIS documentation)
+; input, top of stack  (e.g. whatever$\r$\n)
+; output, top of stack (replaces, with e.g. whatever)
+; modifies no other variables.
+Function un.TrimNewlines
+	Exch $R0
+	Push $R1
+	Push $R2
+	StrCpy $R1 0
+
+loop:
+	IntOp $R1 $R1 - 1
+	StrCpy $R2 $R0 1 $R1
+	StrCmp $R2 &quot;$\r&quot; loop
+	StrCmp $R2 &quot;$\n&quot; loop
+	IntOp $R1 $R1 + 1
+	IntCmp $R1 0 no_trim_needed
+	StrCpy $R0 $R0 $R1
+
+no_trim_needed:
+	Pop $R2
+	Pop $R1
+	Exch $R0
+FunctionEnd
+ 
+Function un.RemoveEmptyDirs
+	Pop $9
+	!define Index 'Line${__LINE__}'
+	FindFirst $0 $1 &quot;$INSTDIR$9*&quot;
+	StrCmp $0 &quot;&quot; &quot;${Index}-End&quot;
+&quot;${Index}-Loop:&quot;
+	StrCmp $1 &quot;&quot; &quot;${Index}-End&quot;
+	StrCmp $1 &quot;.&quot; &quot;${Index}-Next&quot;
+	StrCmp $1 &quot;..&quot; &quot;${Index}-Next&quot;
+	Push $0
+	Push $1
+	Push $9
+	Push &quot;$9$1\&quot;
+	Call un.RemoveEmptyDirs
+	Pop $9
+	Pop $1
+	Pop $0
+;&quot;${Index}-Remove:&quot;
+	RMDir &quot;$INSTDIR$9$1&quot;
+&quot;${Index}-Next:&quot;
+	FindNext $0 $1
+	Goto &quot;${Index}-Loop&quot;
+&quot;${Index}-End:&quot;
+	FindClose $0
+	!undef Index
+FunctionEnd
+
+Function un.ConfirmPagePre
+	${un.GetParameters} $R0
+	${un.GetOptions} $R0 &quot;/frominstall&quot; $R1
+	${Unless} ${Errors}
+		Abort
+	${EndUnless}
+FunctionEnd
+
+Function un.FinishPagePre
+	${un.GetParameters} $R0
+	${un.GetOptions} $R0 &quot;/frominstall&quot; $R1
+	${Unless} ${Errors}
+		SetRebootFlag false
+		Abort
+	${EndUnless}
+FunctionEnd

Modified: branches/avidemux_2.6_branch_mean/avidemux/winInstaller/genlog.sh
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/winInstaller/genlog.sh	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/avidemux/winInstaller/genlog.sh	2011-09-13 16:09:05 UTC (rev 7521)
@@ -1,4 +1,4 @@
-svn log --stop-on-copy --xml ../.. &gt; svn.xml
-xsltproc svnlog.xslt svn.xml &gt; &quot;../../../avidemux_2.4_build/Change Log.html&quot;
-xsltproc revision.xslt svn.xml &gt; revision.nsh
-rm svn.xml
+svn log --stop-on-copy --xml $SOURCEDIR &gt; &quot;svn [$BUILDBITS].xml&quot;
+xsltproc svnlog.xslt &quot;svn [$BUILDBITS].xml&quot; &gt; &quot;$BUILDDIR/Change Log.html&quot;
+xsltproc revision.xslt &quot;svn [$BUILDBITS].xml&quot; &gt; revision.nsh
+rm &quot;svn [$BUILDBITS].xml&quot;

Modified: branches/avidemux_2.6_branch_mean/avidemux/winInstaller/svnlog.xslt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/winInstaller/svnlog.xslt	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/avidemux/winInstaller/svnlog.xslt	2011-09-13 16:09:05 UTC (rev 7521)
@@ -53,10 +53,10 @@
           padding-bottom: 5px;
           }
         &lt;/style&gt;
-        &lt;title&gt;Avidemux 2.4 Change Log&lt;/title&gt;
+        &lt;title&gt;Avidemux 2.6 Change Log&lt;/title&gt;
       &lt;/head&gt;
       &lt;body&gt;
-        &lt;h1&gt;Avidemux 2.4 Change Log&lt;/h1&gt;
+        &lt;h1&gt;Avidemux 2.6 Change Log&lt;/h1&gt;
         &lt;div align=&quot;center&quot;&gt;
           &lt;table class=&quot;build&quot;&gt;
             &lt;tr&gt;

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/1b. Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/1b. Perform Build.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/1b. Perform Build.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -4,24 +4,36 @@
 if errorlevel 1 goto error
 pause
 
+make install
+if errorlevel 1 goto error
+
 cd &quot;%sourceDir%\%buildCliFolder%&quot;
 cmake -G&quot;MSYS Makefiles&quot; -DCMAKE_INSTALL_PREFIX=&quot;%buildDir%&quot; -DUSE_SYSTEM_SPIDERMONKEY=ON -DCMAKE_INCLUDE_PATH=&quot;%SpiderMonkeySourceDir%&quot; -DCMAKE_LIBRARY_PATH=&quot;%SpiderMonkeyLibDir%&quot; %DebugFlags% ../../avidemux/cli
 
 if errorlevel 1 goto error
 pause
 
+make install
+if errorlevel 1 goto error
+
 cd &quot;%sourceDir%\%buildGtkFolder%&quot;
-cmake -G&quot;MSYS Makefiles&quot; -DCMAKE_INSTALL_PREFIX=&quot;%buildDir%&quot; -DUSE_SYSTEM_SPIDERMONKEY=ON -DCMAKE_INCLUDE_PATH=&quot;%SpiderMonkeySourceDir%&quot; -DCMAKE_LIBRARY_PATH=&quot;%SpiderMonkeyLibDir%&quot; %DebugFlags% ../../avidemux/gtk
+rem cmake -G&quot;MSYS Makefiles&quot; -DCMAKE_INSTALL_PREFIX=&quot;%buildDir%&quot; -DUSE_SYSTEM_SPIDERMONKEY=ON -DCMAKE_INCLUDE_PATH=&quot;%SpiderMonkeySourceDir%&quot; -DCMAKE_LIBRARY_PATH=&quot;%SpiderMonkeyLibDir%&quot; %DebugFlags% ../../avidemux/gtk
 
 if errorlevel 1 goto error
-pause
+rem pause
 
+rem make install
+if errorlevel 1 goto error
+
 cd &quot;%sourceDir%\%buildQtFolder%&quot;
 cmake -G&quot;MSYS Makefiles&quot; -DCMAKE_INSTALL_PREFIX=&quot;%buildDir%&quot; -DUSE_SYSTEM_SPIDERMONKEY=ON -DCMAKE_INCLUDE_PATH=&quot;%SpiderMonkeySourceDir%&quot; -DCMAKE_LIBRARY_PATH=&quot;%SpiderMonkeyLibDir%&quot; %DebugFlags% ../../avidemux/qt4
 
 if errorlevel 1 goto error
 pause
 
+make install
+if errorlevel 1 goto error
+
 set msysSourceDir=%sourceDir:\=/%
 cd &quot;%sourceDir%\%buildPluginFolder%&quot;
 cmake -G&quot;MSYS Makefiles&quot; -DCMAKE_INSTALL_PREFIX=&quot;%buildDir%&quot; -DAVIDEMUX_SOURCE_DIR=&quot;%msysSourceDir%&quot; -DPLUGIN_UI=ALL %DebugFlags% ../../avidemux_plugins
@@ -29,30 +41,8 @@
 if errorlevel 1 goto error
 pause
 
-cd &quot;%sourceDir%\%buildCoreFolder%&quot;
-make install
-
-if errorlevel 1 goto error
-
-cd &quot;%sourceDir%\%buildCliFolder%&quot;
-make install
-
-if errorlevel 1 goto error
-
-cd &quot;%sourceDir%\%buildGtkFolder%&quot;
-make install
-
-if errorlevel 1 goto error
-
-cd &quot;%sourceDir%\%buildQtFolder%&quot;
-make install
-
-if errorlevel 1 goto error
-
-cd &quot;%sourceDir%\%buildPluginFolder%&quot;
 rmdir /s /q &quot;%buildDir%\plugins&quot; 2&gt; NUL
 make install
-
 if errorlevel 1 goto error
 goto :EOF
 

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2. Create Packages.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2. Create Packages.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2. Create Packages.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -43,7 +43,5 @@
 goto end
 
 :error
-exit /b 1
-
 :end
 pause
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2a. Update Notes.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2a. Update Notes.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2a. Update Notes.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -1,7 +1,7 @@
 set PATH=%msysDir%\bin;%PATH%
 
 echo -- Generating Change Log.html --
-cd &quot;..\..\installer&quot;
+cd &quot;..\..\..\avidemux\wininstaller&quot;
 sh genlog.sh
 
 echo -- Generating Package Notes.html --

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2b. Package SDK.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2b. Package SDK.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2b. Package SDK.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -1,4 +1,4 @@
-set zipFile=avidemux_sdk_2.5_r%revisionNo%_win.zip
+set zipFile=avidemux_sdk_2.6_r%revisionNo%_win.zip
 
 if &quot;%BuildBits%&quot; == &quot;32&quot; (
 	set sdk32BuildDir=%sdkBuildDir%

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2c. Package Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2c. Package Build.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/2c. Package Build.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -1,17 +1,17 @@
-set baseFile=avidemux_2.5_r%revisionNo%_win%BuildBits%
+set baseFile=avidemux_2.6_r%revisionNo%_win%BuildBits%
 set zipFile=%baseFile%.zip
 
 copy &quot;%buildDir%\Change Log.html&quot; &quot;%packageDir%&quot;
 move &quot;Tools\Package Notes [%BuildBits%].html&quot; &quot;%packageDir%\Package Notes.html&quot;
 
 cd %buildDir%
-if &quot;%BuildBits%&quot; == &quot;32&quot; (
-	echo -- Generating GTK+ Installer --
-	&quot;%nsisDir%\makensis&quot; /V2 /NOCD /DINST_GTK /DBUILD_BITS=%BuildBits% /DNSIDIR=&quot;%curDir%\..\..\installer&quot; /DEXEDIR=&quot;%packageDir%&quot; &quot;%curDir%\..\..\installer\avidemux.nsi&quot;
-)
+rem if &quot;%BuildBits%&quot; == &quot;32&quot; (
+rem	echo -- Generating GTK+ Installer --
+rem	&quot;%nsisDir%\makensis&quot; /V2 /NOCD /DINST_GTK /DBUILD_BITS=%BuildBits% /DNSIDIR=&quot;%curDir%\..\..\..\avidemux\wininstaller&quot; /DEXEDIR=&quot;%packageDir%&quot; &quot;%curDir%\..\..\..\avidemux\wininstaller\avidemux.nsi&quot;
+rem )
 
 echo -- Generating Qt Installer --
-&quot;%nsisDir%\makensis&quot; /V2 /NOCD /DINST_QT /DBUILD_BITS=%BuildBits% /DNSIDIR=&quot;%curDir%\..\..\installer&quot; /DEXEDIR=&quot;%packageDir%&quot; &quot;%curDir%\..\..\installer\avidemux.nsi&quot;
+&quot;%nsisDir%\makensis&quot; /V2 /NOCD /DINST_QT /DBUILD_BITS=%BuildBits% /DNSIDIR=&quot;%curDir%\..\..\..\avidemux\wininstaller&quot; /DEXEDIR=&quot;%packageDir%&quot; &quot;%curDir%\..\..\..\avidemux\wininstaller\avidemux.nsi&quot;
 
 mkdir &quot;%packageDir%\temp&quot;
 cd &quot;%packageDir%\temp&quot;

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Set Avidemux Environment Variables.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Set Avidemux Environment Variables.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Set Avidemux Environment Variables.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -26,8 +26,8 @@
 	goto error
 )
 
-if exist &quot;%ProgramFiles32%\7-zip&quot; (
-	set SevenZipDir=%ProgramFiles32%\7-zip
+if exist &quot;%ProgramFiles%\7-zip&quot; (
+	set SevenZipDir=%ProgramFiles%\7-zip
 ) else (
 	echo 7-zip could not be found.  Please download from <A HREF="http://www.7-zip.org">http://www.7-zip.org</A>
 	goto error

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/Get Revision Number.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/Get Revision Number.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/Get Revision Number.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -1,6 +1,6 @@
-if not exist &quot;..\..\..\installer\revision.nsh&quot; goto end
+if not exist &quot;..\..\..\..\avidemux\wininstaller\revision.nsh&quot; goto end
 
-copy &quot;Revision No template.bat&quot; + &quot;..\..\..\installer\revision.nsh&quot; temp.bat &gt; NUL
+copy &quot;Revision No template.bat&quot; + &quot;..\..\..\..\avidemux\wininstaller\revision.nsh&quot; temp.bat &gt; NUL
 
 call temp.bat
 del temp.bat

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/gentouch.sh
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/gentouch.sh	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/gentouch.sh	2011-09-13 16:09:05 UTC (rev 7521)
@@ -1 +1 @@
-xsltproc touch_files.xslt &quot;../Package Notes.xml&quot; &gt; &quot;../Touch 2.5 Files [$BUILDBITS].html&quot;
\ No newline at end of file
+xsltproc touch_files.xslt &quot;../Package Notes.xml&quot; &gt; &quot;../Touch 2.6 Files [$BUILDBITS].html&quot;
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/package_notes.xslt
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/package_notes.xslt	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/avidemux/Tools/package_notes.xslt	2011-09-13 16:09:05 UTC (rev 7521)
@@ -54,10 +54,10 @@
           padding-bottom: 5px;
           }
         &lt;/style&gt;
-        &lt;title&gt;Avidemux 2.5 Win32 Package Notes&lt;/title&gt;
+        &lt;title&gt;Avidemux 2.6 Windows Package Notes&lt;/title&gt;
       &lt;/head&gt;
       &lt;body&gt;
-        &lt;h1&gt;Avidemux 2.5 Win32 Package Notes&lt;/h1&gt;
+        &lt;h1&gt;Avidemux 2.6 Windows Package Notes&lt;/h1&gt;
         &lt;div&gt;
           &lt;xsl:apply-templates select=&quot;buildentry&quot; /&gt;
         &lt;/div&gt;

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faac/Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faac/Perform Build.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faac/Perform Build.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -49,10 +49,15 @@
 
 copy &quot;.\include\*.h&quot; &quot;%usrLocalDir%\include&quot;
 cd libfaac
-gcc -s -O3 -shared -I../include *.c -o&quot;%usrLocalDir%/bin/libfaac.dll&quot; -Wl,--out-implib,&quot;%usrLocalDir%/lib/libfaac.a&quot;
+copy &quot;%curDir%\makefile.&quot;
+
+make
 if errorlevel 1 goto end
 
+copy libfaac.dll &quot;%usrLocalDir%/bin&quot;
+copy libfaac.a &quot;%usrLocalDir%/lib&quot;
 copy &quot;%usrLocalDir%\bin\libfaac.dll&quot; &quot;%admBuildDir%&quot;
+
 goto end
 
 :error

Added: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faac/makefile
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faac/makefile	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faac/makefile	2011-09-13 16:09:05 UTC (rev 7521)
@@ -0,0 +1,5 @@
+CFLAGS =-s -O3 -shared -I../include -Wl,--out-implib,libfaac.a
+SRC=$(wildcard *.c)
+
+libfaac.dll: $(SRC)
+	gcc -o $@ $^ $(CFLAGS)
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faad/Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faad/Perform Build.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faad/Perform Build.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -49,10 +49,15 @@
 
 copy &quot;.\include\*.h&quot; &quot;%usrLocalDir%\include&quot;
 cd libfaad
-gcc -s -O3 -DHAVE_MEMCPY=1 -DHAVE_STRING_H=1 -DHAVE_STDINT_H=1 -I../include -I&quot;.&quot; *.c -shared -o &quot;%usrLocalDir%/bin/libfaad2.dll&quot; -Wl,--out-implib,&quot;%usrLocalDir%/lib/libfaad.a&quot;
+copy &quot;%curDir%\makefile.&quot;
+
+make
 if errorlevel 1 goto end
 
+copy libfaad2.dll &quot;%usrLocalDir%/bin&quot;
+copy libfaad.a &quot;%usrLocalDir%/lib&quot;
 copy &quot;%usrLocalDir%\bin\libfaad2.dll&quot; &quot;%admBuildDir%&quot;
+
 goto end
 
 :error

Added: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faad/makefile
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faad/makefile	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/faad/makefile	2011-09-13 16:09:05 UTC (rev 7521)
@@ -0,0 +1,5 @@
+CFLAGS =-s -O3 -shared -DHAVE_MEMCPY=1 -DHAVE_STRING_H=1 -DHAVE_STDINT_H=1 -I../include -I&quot;.&quot; -Wl,--out-implib,libfaad.a
+SRC=$(wildcard *.c)
+
+libfaad2.dll: $(SRC)
+	gcc -o $@ $^ $(CFLAGS)
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/libogg/Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/libogg/Perform Build.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/libogg/Perform Build.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -17,9 +17,9 @@
 call &quot;../Set Common Environment Variables&quot;
 if errorlevel 1 goto end
 
-set package=libogg-1.2.1.tar.gz
-set sourceFolder=libogg-1.2.1-%BuildBits%
-set tarFolder=libogg-1.2.1
+set package=libogg-1.3.0.tar.gz
+set sourceFolder=libogg-1.3.0-%BuildBits%
+set tarFolder=libogg-1.3.0
 set curDir=%CD%
 
 if not exist %package% (

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/libvpx/Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/libvpx/Perform Build.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/libvpx/Perform Build.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -17,9 +17,9 @@
 call &quot;../Set Common Environment Variables&quot;
 if errorlevel 1 goto end
 
-set package=libvpx-v0.9.5.tar.bz2
-set sourceFolder=libvpx-0.9.5-%BuildBits%
-set tarFolder=libvpx-v0.9.5
+set package=libvpx-v0.9.7-p1.tar.bz2
+set sourceFolder=libvpx-0.9.7-p1-%BuildBits%
+set tarFolder=libvpx-v0.9.7-p1
 set curDir=%CD%
 
 if not exist %package% (

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/Perform Build.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/nspr/Perform Build.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -20,15 +20,15 @@
 call &quot;../Set Common Environment Variables&quot;
 if errorlevel 1 goto end
 
-set package=nspr-4.8.6.tar.gz
-set sourceFolder=nspr-4.8.6-%BuildBits%
-set tarFolder=nspr-4.8.6
+set package=nspr-4.8.9.tar.gz
+set sourceFolder=nspr-4.8.9-%BuildBits%
+set tarFolder=nspr-4.8.9
 set curDir=%CD%
 
 if not exist %package% (
 	echo.
 	echo Downloading
-	wget <A HREF="ftp://ftp.mozilla.org/pub/mozilla.org/nspr/releases/v4.8.6/src/%package%">ftp://ftp.mozilla.org/pub/mozilla.org/nspr/releases/v4.8.6/src/%package%</A>
+	wget <A HREF="ftp://ftp.mozilla.org/pub/mozilla.org/nspr/releases/v4.8.9/src/%package%">ftp://ftp.mozilla.org/pub/mozilla.org/nspr/releases/v4.8.9/src/%package%</A>
 )
 
 if errorlevel 1 goto end

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/x264/Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/x264/Perform Build.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/x264/Perform Build.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -29,13 +29,13 @@
 if errorlevel 1 goto end
 
 echo Downloading from git
-git clone <A HREF="git://git.videolan.org/x264.git">git://git.videolan.org/x264.git</A> %sourceFolder%
+call git clone <A HREF="git://git.videolan.org/x264.git">git://git.videolan.org/x264.git</A> %sourceFolder%
 if errorlevel 1 goto end
 
 cd &quot;%devDir%/%sourceFolder%&quot;
 
-if &quot;%BuildBits%&quot; == &quot;32&quot; sh ./configure --prefix=%usrLocalDir% --enable-shared
-if &quot;%BuildBits%&quot; == &quot;64&quot; sh ./configure --prefix=%usrLocalDir% --enable-shared --host=x86_64-pc-mingw32
+if &quot;%BuildBits%&quot; == &quot;32&quot; sh ./configure --prefix=%usrLocalDir% --enable-shared --enable-win32thread
+if &quot;%BuildBits%&quot; == &quot;64&quot; sh ./configure --prefix=%usrLocalDir% --enable-shared --enable-win32thread --host=x86_64-pc-mingw32
 
 if errorlevel 1 goto end
 

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/xvid/Perform Build.bat
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/xvid/Perform Build.bat	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/xvid/Perform Build.bat	2011-09-13 16:09:05 UTC (rev 7521)
@@ -17,8 +17,8 @@
 call &quot;../Set Common Environment Variables&quot;
 if errorlevel 1 goto end
 
-set package=xvidcore-1.2.2.tar.gz
-set sourceFolder=xvidcore-1.2.2-%BuildBits%
+set package=xvidcore-1.3.2.tar.gz
+set sourceFolder=xvidcore-1.3.2-%BuildBits%
 set curDir=%CD%
 
 if not exist %package% (

Modified: branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/xvid/configure.patch
===================================================================
--- branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/xvid/configure.patch	2011-09-13 12:38:23 UTC (rev 7520)
+++ branches/avidemux_2.6_branch_mean/foreignBuilds/mswin/xvid/configure.patch	2011-09-13 16:09:05 UTC (rev 7521)
@@ -1,11 +1,12 @@
---- build/generic/configure.orig	2009-05-28 18:13:31 +0100
-+++ build/generic/configure	2010-11-27 10:25:35 +0000
-@@ -1319,7 +1319,7 @@
- API_MAJOR=&quot;4&quot;
- API_MINOR=&quot;2&quot;
- 
--minimum_yasm_minor_version=8
-+minimum_yasm_minor_version=1
- minimum_nasm_minor_version=0
- minimum_nasm_major_version=2
- nasm_prog=&quot;nasm&quot;
+--- build/generic/configure.orig	2011-03-17 14:31:52 +0000
++++ build/generic/configure	2011-05-21 16:22:55 +0100
+@@ -4325,8 +4325,7 @@
+ $as_echo &quot;ok&quot; &gt;&amp;6; }
+ 	STATIC_LIB=&quot;xvidcore.\$(STATIC_EXTENSION)&quot;
+ 	SHARED_LIB=&quot;xvidcore.\$(SHARED_EXTENSION)&quot;
+-	SPECIFIC_LDFLAGS=&quot;-mno-cygwin -shared -Wl,--dll,--out-implib,\$@.a libxvidcore.def&quot;
+-	SPECIFIC_CFLAGS=&quot;-mno-cygwin&quot;
++	SPECIFIC_LDFLAGS=&quot;-shared -Wl,--dll,--out-implib,\$@.a libxvidcore.def&quot;
+ 	;;
+      darwin*|raphsody*)
+ 	STATIC_LIB=&quot;libxvidcore.\$(STATIC_EXTENSION)&quot;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004668.html">[Avidemux-svn-commit] r7520 - in	branches/avidemux_2.6_branch_mean/avidemux_core:	ADM_coreImage/src ADM_coreUtils/src
</A></li>
	<LI>Next message: <A HREF="004670.html">[Avidemux-svn-commit] r7522 -	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4669">[ date ]</a>
              <a href="thread.html#4669">[ thread ]</a>
              <a href="subject.html#4669">[ subject ]</a>
              <a href="author.html#4669">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
