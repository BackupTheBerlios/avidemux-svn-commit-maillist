<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r7155 - in branches/avidemux_2.6_branch_mean:	avidemux_core/ADM_core/src avidemux_core/ADM_coreMuxer/src	avidemux_core/ADM_coreVideoCodec/include	avidemux_core/ADM_coreVideoCodec/src	avidemux_core/ADM_coreVideoEncoder/src	avidemux_core/ffmpeg_package/patches	avidemux_plugins/ADM_audioDecoders/ADM_ad_lav	avidemux_plugins/ADM_audioEncoders/lavcodec cmake
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2011-April/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r7155%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux_core/ADM_core/src%20avidemux_core/ADM_coreMuxer/src%0A%09avidemux_core/ADM_coreVideoCodec/include%0A%09avidemux_core/ADM_coreVideoCodec/src%0A%09avidemux_core/ADM_coreVideoEncoder/src%0A%09avidemux_core/ffmpeg_package/patches%0A%09avidemux_plugins/ADM_audioDecoders/ADM_ad_lav%0A%09avidemux_plugins/ADM_audioEncoders/lavcodec%20cmake&In-Reply-To=%3C20110422083701.A30494813DE%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004312.html">
   <LINK REL="Next"  HREF="004314.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r7155 - in branches/avidemux_2.6_branch_mean:	avidemux_core/ADM_core/src avidemux_core/ADM_coreMuxer/src	avidemux_core/ADM_coreVideoCodec/include	avidemux_core/ADM_coreVideoCodec/src	avidemux_core/ADM_coreVideoEncoder/src	avidemux_core/ffmpeg_package/patches	avidemux_plugins/ADM_audioDecoders/ADM_ad_lav	avidemux_plugins/ADM_audioEncoders/lavcodec cmake</H1>
    <B>mean at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r7155%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux_core/ADM_core/src%20avidemux_core/ADM_coreMuxer/src%0A%09avidemux_core/ADM_coreVideoCodec/include%0A%09avidemux_core/ADM_coreVideoCodec/src%0A%09avidemux_core/ADM_coreVideoEncoder/src%0A%09avidemux_core/ffmpeg_package/patches%0A%09avidemux_plugins/ADM_audioDecoders/ADM_ad_lav%0A%09avidemux_plugins/ADM_audioEncoders/lavcodec%20cmake&In-Reply-To=%3C20110422083701.A30494813DE%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r7155 - in branches/avidemux_2.6_branch_mean:	avidemux_core/ADM_core/src avidemux_core/ADM_coreMuxer/src	avidemux_core/ADM_coreVideoCodec/include	avidemux_core/ADM_coreVideoCodec/src	avidemux_core/ADM_coreVideoEncoder/src	avidemux_core/ffmpeg_package/patches	avidemux_plugins/ADM_audioDecoders/ADM_ad_lav	avidemux_plugins/ADM_audioEncoders/lavcodec cmake">mean at mail.berlios.de
       </A><BR>
    <I>Fri Apr 22 10:37:01 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004312.html">[Avidemux-svn-commit] r7153 -	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit
</A></li>
        <LI>Next message: <A HREF="004314.html">[Avidemux-svn-commit] r7157 - in	branches/avidemux_2.6_branch_mean/autononreg/py: . codec_out
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4313">[ date ]</a>
              <a href="thread.html#4313">[ thread ]</a>
              <a href="subject.html#4313">[ subject ]</a>
              <a href="author.html#4313">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2011-04-22 10:37:01 +0200 (Fri, 22 Apr 2011)
New Revision: 7155

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_memcpy.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_ffmp43.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/libavformat_matroskaenc.c.patch
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.h
   branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.6_branch_mean/cmake/admFFmpegPrepareGit.cmake
   branches/avidemux_2.6_branch_mean/cmake/admFFmpegUtil.cmake
Log:
[lav] update lavcodec

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_memcpy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_memcpy.cpp	2011-04-20 14:48:26 UTC (rev 7154)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_memcpy.cpp	2011-04-22 08:37:01 UTC (rev 7155)
@@ -389,9 +389,9 @@
 #if defined(ADM_CPU_X86)
   { &quot;linux kernel memcpy()&quot;, linux_kernel_memcpy, 0, 0 },
 #if defined(ADM_CPU_X86)
-  { &quot;MMX optimized memcpy()&quot;, mmx_memcpy, 0, FF_MM_MMX },
-  { &quot;MMXEXT optimized memcpy()&quot;, mmx2_memcpy, 0, FF_MM_MMXEXT },
-  { &quot;SSE optimized memcpy()&quot;, sse_memcpy, 0, FF_MM_MMXEXT|FF_MM_SSE },
+  { &quot;MMX optimized memcpy()&quot;, mmx_memcpy, 0, 0 },
+  { &quot;MMXEXT optimized memcpy()&quot;, mmx2_memcpy, 0, 0 },
+  { &quot;SSE optimized memcpy()&quot;, sse_memcpy, 0, 0|0 },
 #endif
 #endif /* ARCH_X86 */
 #if 0 &amp;&amp; defined(ADM_CPU_PPC) &amp;&amp; !defined (__APPLE__)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2011-04-20 14:48:26 UTC (rev 7154)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreMuxer/src/ADM_coreMuxerFfmpeg.cpp	2011-04-22 08:37:01 UTC (rev 7155)
@@ -95,7 +95,7 @@
 */
 bool muxerFFmpeg::setupMuxer(const char *format,const char *filename)
 {
-    fmt=guess_format(format, NULL, NULL);
+    fmt=av_guess_format(format, NULL, NULL);
     if(!fmt)
     {
             printf(&quot;[FF] guess format failed\n&quot;);
@@ -111,9 +111,11 @@
 	snprintf(oc-&gt;filename,1000,&quot;<A HREF="file://%s">file://%s</A>&quot;,filename);
     // probably a memeleak here
     char *foo=ADM_strdup(filename);
-
+#warning use AV METADATA
+#if 0
     strcpy(oc-&gt;title,ADM_GetFileName(foo));
     strcpy(oc-&gt;author,&quot;Avidemux&quot;);
+#endif
     printf(&quot;[FF] Muxer opened\n&quot;);
     return true;
 }
@@ -150,12 +152,12 @@
         c-&gt;rc_max_rate=9500*1000;
         c-&gt;rc_min_rate=0;
         c-&gt;bit_rate=9000*1000;
-        c-&gt;codec_type = CODEC_TYPE_VIDEO;
+        c-&gt;codec_type = AVMEDIA_TYPE_VIDEO;
         c-&gt;flags=CODEC_FLAG_QSCALE;
         c-&gt;width = stream-&gt;getWidth();
         c-&gt;height =stream-&gt;getHeight();
         uint32_t fcc=stream-&gt;getFCC();
-        
+
         if(isMpeg4Compatible(fcc))
         {
                 c-&gt;codec_id = CODEC_ID_MPEG4;
@@ -233,7 +235,7 @@
                                             }else
                                             {
                                                 uint32_t id=stream-&gt;getFCC();
-            
+
                                                 CodecID cid=ADM_codecIdFindByFourcc(fourCC::tostring(id));
                                                 if(cid==CODEC_ID_NONE)
                                                 {
@@ -252,7 +254,7 @@
             {
                 ADM_info(&quot;Video has extradata and muxer requires globalHeader, assuming it is done so.\n&quot;);
                 c-&gt;flags|=CODEC_FLAG_GLOBAL_HEADER;
-            }else       
+            }else
             {
                 ADM_warning(&quot;Video has no extradata but muxer requires globalHeader.\n&quot;);
             }
@@ -324,7 +326,7 @@
                                  return false;
                           break;
           }
-          c-&gt;codec_type = CODEC_TYPE_AUDIO;
+          c-&gt;codec_type = AVMEDIA_TYPE_AUDIO;
           c-&gt;bit_rate = audioheader-&gt;byterate*8;
           c-&gt;rc_buffer_size=(c-&gt;bit_rate/(2*8)); // 500 ms worth
           c-&gt;channels = audioheader-&gt;channels;
@@ -334,7 +336,7 @@
             {
                 ADM_info(&quot;Audio has extradata and muxer requires globalHeader, assuming it is done so.\n&quot;);
                 c-&gt;flags|=CODEC_FLAG_GLOBAL_HEADER;
-            }else       
+            }else
             {
                 ADM_warning(&quot;Audio has no extradata but muxer requires globalHeader.\n&quot;);
             }
@@ -378,8 +380,8 @@
     f*=1000000;
     videoIncrement=(uint64_t)f;
 
-    
 
+
     ADM_info(&quot;avg fps=%u\n&quot;,vStream-&gt;getAvgFps1000());
     AVRational *scale=&amp;(video_st-&gt;codec-&gt;time_base);
     uint64_t videoDuration=vStream-&gt;getVideoDuration();
@@ -435,7 +437,7 @@
             pkt.data= buffer;
             pkt.size= out.len;
             if(out.flags &amp; 0x10) // FIXME AVI_KEY_FRAME
-                        pkt.flags |= PKT_FLAG_KEY;
+                        pkt.flags |= AV_PKT_FLAG_KEY;
             ret =writePacket( &amp;pkt);
             aprintf(&quot;[FF]Frame:%u, DTS=%08lu PTS=%08lu\n&quot;,written,out.dts,out.pts);
             if(false==ret)
@@ -491,7 +493,7 @@
                     pkt.stream_index=1+audio;
                     pkt.data= audioTrack-&gt;buffer;
                     pkt.size= audioTrack-&gt;size;
-                    pkt.flags |= PKT_FLAG_KEY; // Assume all audio are keyframe, which is slightly wrong
+                    pkt.flags |= AV_PKT_FLAG_KEY; // Assume all audio are keyframe, which is slightly wrong
                     ret =writePacket( &amp;pkt);
                     audioTrack-&gt;present=false; // consumed
                     if(false==ret)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_ffmp43.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_ffmp43.h	2011-04-20 14:48:26 UTC (rev 7154)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_ffmp43.h	2011-04-22 08:37:01 UTC (rev 7155)
@@ -1,9 +1,9 @@
 /***************************************************************************
                           ADM_ffmp43.h  -  description
                              -------------------
-                             
+
 	Mpeg4 ****decoder******** using ffmpeg
-	                              
+
     begin                : Wed Sep 25 2002
     copyright            : (C) 2002 by mean
     email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
@@ -33,7 +33,7 @@
 class decoderFF:public decoders
 {
 protected:
-
+  bool  hurryUp;
   int codecId;
   uint8_t _refCopy;
   AVCodecContext *_context;

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2011-04-20 14:48:26 UTC (rev 7154)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/src/ADM_ffmp43.cpp	2011-04-22 08:37:01 UTC (rev 7155)
@@ -103,7 +103,7 @@
     //printf(&quot;[LAVC] Old pts :%&quot;LLD&quot; new pts :%&quot;LLD&quot;\n&quot;,out-&gt;Pts, (uint64_t)(src-&gt;reordered_opaque));
     //printf(&quot;[LAVC] pts: %&quot;LLU&quot;\n&quot;,src-&gt;pts);
     out-&gt;Pts= (uint64_t)(src-&gt;reordered_opaque);
- 
+
     return 1;
 }
 /**
@@ -126,11 +126,8 @@
   if (threads)
   {
       printf (&quot;[lavc] Enabling MT decoder with %u threads\n&quot;, threads);
-
-      if (avcodec_thread_init (_context, threads) == -1)
-	      printf (&quot;[lavc] Failed!!\n&quot;);
-	  else
-          _usingMT = 1;
+      _context-&gt;thread_count=threads;
+      _usingMT = 1;
   }
 }
 uint8_t decoderFF::getPARWidth (void)
@@ -156,6 +153,7 @@
 decoderFF::decoderFF (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp)
             :decoders (w, h,fcc,extraDataLen,extraData,bpp)
 {
+  hurryUp=false;
   codecId = 0;
 //                              memset(&amp;_context,0,sizeof(_context));
   _allowNull = 0;
@@ -190,7 +188,7 @@
   printf (&quot;[lavc] Build: %d\n&quot;, LIBAVCODEC_BUILD);
   _context-&gt;debug_mv |= FF_SHOW;
   _context-&gt;debug |= FF_DEBUG_VIS_MB_TYPE + FF_DEBUG_VIS_QP;
-  
+
 }
 
 //_____________________________________________________
@@ -200,7 +198,6 @@
   if (_usingMT)
     {
       printf (&quot;[lavc] Killing decoding threads\n&quot;);
-      avcodec_thread_free (_context);
       _usingMT = 0;
     }
 
@@ -274,16 +271,17 @@
 }
 bool decoderFF::decodeHeaderOnly (void)
 {
-  if (codecId == CODEC_ID_H264)
-    _context-&gt;hurry_up = 4;
-  else
-    _context-&gt;hurry_up = 5;
+  hurryUp=true;
+  _context-&gt;skip_frame=AVDISCARD_ALL;
+  _context-&gt;skip_idct=AVDISCARD_ALL;
   printf (&quot;\n[lavc] Hurry up\n&quot;);
   return 1;
 }
 bool decoderFF::decodeFull (void)
 {
-  _context-&gt;hurry_up = 0;
+  _context-&gt;skip_frame=AVDISCARD_DEFAULT;
+  _context-&gt;skip_idct=AVDISCARD_DEFAULT;
+  hurryUp=false;
   printf (&quot;\n[lavc] full decoding\n&quot;);
   return 1;
 }
@@ -321,14 +319,14 @@
       _context-&gt;debug &amp;= ~(FF_DEBUG_VIS_MB_TYPE + FF_DEBUG_VIS_QP);
     }
 
-   
-    
+
+
   if (in-&gt;dataLength == 0 &amp;&amp; !_allowNull)	// Null frame, silently skipped
     {
-      
+
       printf (&quot;[Codec] null frame\n&quot;);
         // search the last image
-        if (_context-&gt;coded_frame &amp;&amp; 
+        if (_context-&gt;coded_frame &amp;&amp;
             _context-&gt;coded_frame-&gt;data &amp;&amp;
             _context-&gt;coded_frame-&gt;data[0]
             )
@@ -358,7 +356,7 @@
     pkt.flags=AV_PKT_FLAG_KEY;
   else
     pkt.flags=0;
-  
+
   ret = avcodec_decode_video2 (_context, &amp;_frame, &amp;got_picture, &amp;pkt);
   if(!bFramePossible())
   {
@@ -366,15 +364,15 @@
     _context-&gt;reordered_opaque=(int64_t)in-&gt;demuxerPts;
   }
   out-&gt;_qStride = 0;		//Default = no quant
-  if (0 &gt; ret &amp;&amp; !_context-&gt;hurry_up)
+  if (0 &gt; ret &amp;&amp; !hurryUp)
     {
       printf (&quot;\n[lavc] error in lavcodec decoder!\n&quot;);
       printf (&quot;[lavc] Err: %d, size :%d\n&quot;, ret, in-&gt;dataLength);
       return 0;
     }
-  if (!got_picture &amp;&amp; !_context-&gt;hurry_up)
+  if (!got_picture &amp;&amp; !hurryUp)
     {
-      // Some encoder code a vop header with the 
+      // Some encoder code a vop header with the
       // vop flag set to 0
       // it is meant to mean frame skipped but very dubious
       if (in-&gt;dataLength &lt;= 8 &amp;&amp; codecId == CODEC_ID_MPEG4)
@@ -412,7 +410,7 @@
       //return 1;
       return 0;
     }
-  if (_context-&gt;hurry_up)
+  if (hurryUp)
     {
       out-&gt;flags = frameType ();
       return 1;
@@ -486,7 +484,7 @@
 {
 // force low delay as avidemux don't handle B-frames
   ADM_info (&quot;[lavc] Using %d bytes of extradata for MPEG4 decoder\n&quot;, (int)extraDataLen);
-  
+
   _refCopy = 1;			// YUV420 only
   _context-&gt;extradata = (uint8_t *) extraData;
   _context-&gt;extradata_size = (int)extraDataLen  ;
@@ -557,9 +555,9 @@
 */
 bool   decoderFFH264::uncompress (ADMCompressedImage * in, ADMImage * out)
 {
-  if(!_context-&gt;hurry_up) return decoderFF::uncompress (in, out);
+  if(!hurryUp) return decoderFF::uncompress (in, out);
     ADM_assert(0);
-#if 0  
+#if 0
   uint32_t nalSize, isAvc;
   av_getAVCStreamInfo(_context,&amp;nalSize,&amp;isAvc);
   if(isAvc)
@@ -607,7 +605,7 @@
 {
    // if(level&gt;1) return;
     char buf[256];
-  
+
     vsnprintf(buf, sizeof(buf), fmt, list);
     if(level&lt;=AV_LOG_INFO)
         ADM_info(&quot;[lavc] %s&quot;,buf);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2011-04-20 14:48:26 UTC (rev 7154)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoEncoder/src/ADM_coreVideoEncoderFFmpeg.cpp	2011-04-22 08:37:01 UTC (rev 7155)
@@ -2,7 +2,7 @@
                           \fn ADM_coreVideoEncoder
                           \brief Base class for video encoder plugin
                              -------------------
-    
+
     copyright            : (C) 2002/2009 by mean
     email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
  ***************************************************************************/
@@ -34,7 +34,7 @@
 
 */
 
-ADM_coreVideoEncoderFFmpeg::ADM_coreVideoEncoderFFmpeg(ADM_coreVideoFilter *src,FFcodecSettings *set,bool globalHeader) 
+ADM_coreVideoEncoderFFmpeg::ADM_coreVideoEncoderFFmpeg(ADM_coreVideoFilter *src,FFcodecSettings *set,bool globalHeader)
                     : ADM_coreVideoEncoder(src)
 {
 uint32_t w,h;
@@ -42,9 +42,9 @@
     targetColorSpace=ADM_COLOR_YV12;
     w=getWidth();
     h=getHeight();
-    
+
     image=new ADMImageDefault(w,h);
-    _context = avcodec_alloc_context2 (CODEC_TYPE_VIDEO);
+    _context = avcodec_alloc_context2 (AVMEDIA_TYPE_VIDEO);
     ADM_assert (_context);
     memset (&amp;_frame, 0, sizeof (_frame));
     _frame.pts = AV_NOPTS_VALUE;
@@ -75,7 +75,7 @@
                 ADM_info(&quot;Codec configured to use global header\n&quot;);
                 _context-&gt;flags|=CODEC_FLAG_GLOBAL_HEADER;
     }
-    
+
 }
 /**
     \fn ADM_coreVideoEncoderFFmpeg
@@ -88,7 +88,6 @@
         if (_isMT )
         {
           printf (&quot;[lavc] killing threads\n&quot;);
-          avcodec_thread_free (_context);
           _isMT = false;
         }
         if(_context-&gt;codec)
@@ -100,7 +99,7 @@
     {
         delete colorSpace;
         colorSpace=NULL;
-    }   
+    }
     if(rgbBuffer)
     {
         delete [] rgbBuffer;
@@ -126,11 +125,11 @@
 
   switch(targetColorSpace)
     {
-        case ADM_COLOR_YV12:    _frame.linesize[0] = w; 
-                                _frame.linesize[1] = w&gt;&gt;1; 
-                                _frame.linesize[2] = w&gt;&gt;1; 
+        case ADM_COLOR_YV12:    _frame.linesize[0] = w;
+                                _frame.linesize[1] = w&gt;&gt;1;
+                                _frame.linesize[2] = w&gt;&gt;1;
                                 _context-&gt;pix_fmt =PIX_FMT_YUV420P;break;
-        case ADM_COLOR_YUV422P: _frame.linesize[0] = w; 
+        case ADM_COLOR_YUV422P: _frame.linesize[0] = w;
                                 _frame.linesize[1] = w&gt;&gt;1;
                                 _frame.linesize[2] = w&gt;&gt;1;
                                 _context-&gt;pix_fmt =PIX_FMT_YUV422P;break;
@@ -141,18 +140,18 @@
         default: ADM_assert(0);
 
     }
-    
+
     // Eval fps
     uint64_t f=source-&gt;getInfo()-&gt;frameIncrement;
     // Let's put 100 us as time  base
-    
+
 #ifdef TIME_TENTH_MILLISEC
     _context-&gt;time_base.num=1;
     _context-&gt;time_base.den=10000LL;
 #else
 
     int n,d;
-    
+
     usSecondsToFrac(f,&amp;n,&amp;d);
  //   printf(&quot;[ff] Converted a time increment of %d ms to %d /%d seconds\n&quot;,f/1000,n,d);
     _context-&gt;time_base.num=n;
@@ -166,7 +165,7 @@
 */
 int64_t          ADM_coreVideoEncoderFFmpeg::timingToLav(uint64_t val)
 {
-  int64_t v= floor( ((float)val+timeScaler/2.) /timeScaler);    
+  int64_t v= floor( ((float)val+timeScaler/2.) /timeScaler);
   return v;
 }
 /**
@@ -180,7 +179,7 @@
 
 /**
     \fn pre-encoder
-    
+
 */
 bool             ADM_coreVideoEncoderFFmpeg::preEncode(void)
 {
@@ -211,7 +210,7 @@
     //
     switch(targetColorSpace)
     {
-        case ADM_COLOR_YV12:      
+        case ADM_COLOR_YV12:
                 _frame.data[0] = image-&gt;GetWritePtr(PLANAR_Y);
                 _frame.data[2] = image-&gt;GetWritePtr(PLANAR_U);
                 _frame.data[1] = image-&gt;GetWritePtr(PLANAR_V);
@@ -255,7 +254,7 @@
 {
     int res;
     AVCodec *codec=avcodec_find_encoder(codecId);
-    if(!codec) 
+    if(!codec)
     {
         printf(&quot;[ff] Cannot find codec\n&quot;);
         return false;
@@ -266,12 +265,12 @@
     {
         encoderMT();
     }
-   res=avcodec_open(_context, codec); 
-   if(res&lt;0) 
+   res=avcodec_open(_context, codec);
+   if(res&lt;0)
     {   printf(&quot;[ff] Cannot open codec\n&quot;);
         return false;
     }
-   
+
     // Now allocate colorspace
     int w,h;
     FilterInfo *info=source-&gt;getInfo();
@@ -355,11 +354,11 @@
     aprintf(&quot;[ffMpeg4] Out Quant :%d, pic type %d keyf %d\n&quot;,out-&gt;out_quantizer,pict_type,keyframe);
     out-&gt;len=size;
     out-&gt;flags=0;
-    if(keyframe) 
+    if(keyframe)
         out-&gt;flags=AVI_KEY_FRAME;
     else if(pict_type==FF_B_TYPE)
         out-&gt;flags=AVI_B_FRAME;
-    
+
     // Update PTS/Dts
     if(!_context-&gt;max_b_frames)
     {
@@ -370,17 +369,17 @@
     getRealPtsFromInternal(_context-&gt;coded_frame-&gt;pts,&amp;(out-&gt;dts),&amp;(out-&gt;pts));
     // update lastDts
     lastDts=out-&gt;dts;
-    
-    aprintf(&quot;Codec&gt;Out pts=%&quot;LLU&quot; us, out Dts=%&quot;LLU&quot;\n&quot;,out-&gt;pts,out-&gt;dts);    
 
+    aprintf(&quot;Codec&gt;Out pts=%&quot;LLU&quot; us, out Dts=%&quot;LLU&quot;\n&quot;,out-&gt;pts,out-&gt;dts);
+
     // Update quant
     if(!_context-&gt;coded_frame-&gt;quality)
       out-&gt;out_quantizer=(int) floor (_frame.quality / (float) FF_QP2LAMBDA);
     else
       out-&gt;out_quantizer =(int) floor (_context-&gt;coded_frame-&gt;quality / (float) FF_QP2LAMBDA);
 
-    
 
+
     // Update stats
     if(Settings.params.mode==COMPRESS_2PASS   || Settings.params.mode==COMPRESS_2PASS_BITRATE)
     {
@@ -398,7 +397,7 @@
 bool ADM_coreVideoEncoderFFmpeg::presetContext(FFcodecSettings *set)
 {
 	  //_context-&gt;gop_size = 250;
-	
+
 #define SETX(x) _context-&gt;x=set-&gt;lavcSettings.x; printf(&quot;[LAVCODEC]&quot;#x&quot; : %d\n&quot;,set-&gt;lavcSettings.x);
 #define SETX_COND(x) if(set-&gt;lavcSettings.is_##x) {_context-&gt;x=set-&gt;lavcSettings.x; printf(&quot;[LAVCODEC]&quot;#x&quot; : %d\n&quot;,set-&gt;lavcSettings.x);} else\
 		{ printf(#x&quot; is not activated\n&quot;);}
@@ -446,7 +445,7 @@
         default:
           ADM_assert (0);
 	}
-      
+
       SETX (_4MV);
       SETX (_QPEL);
       if(set-&gt;lavcSettings._TRELLIS_QUANT) _context-&gt;trellis=1;
@@ -461,7 +460,7 @@
 
         }
 #undef SETX
-    
+
   _context-&gt;bit_rate_tolerance = 8000000;
   _context-&gt;b_quant_factor = 1.25;
   _context-&gt;rc_strategy = 2;
@@ -508,7 +507,7 @@
 bool ADM_coreVideoEncoderFFmpeg::setupPass(void)
 {
     int averageBitrate; // Fixme
-   
+
     // Compute average bitrate
 
         if(Settings.params.mode==COMPRESS_2PASS_BITRATE) averageBitrate=Settings.params.avg_bitrate*1000;
@@ -560,10 +559,10 @@
 /**
     \fn encoderMT
     \brief handle multithreaded encoding
-*/  
+*/
 bool ADM_coreVideoEncoderFFmpeg::encoderMT (void)
 {
- 
+
   uint32_t threads =    LAVS(MultiThreaded);
   switch(threads)
   {
@@ -574,11 +573,8 @@
   if (threads)
   {
       printf (&quot;[lavc] Enabling MT encoder with %u threads\n&quot;, threads);
-
-      if (avcodec_thread_init (_context, threads) == -1)
-	      printf (&quot;[lavc] Failed!!\n&quot;);
-	  else
-          _isMT = 1;
+      _context-&gt;thread_count=threads;
+      _isMT = 1;
   }
   return true;
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/libavformat_matroskaenc.c.patch
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/libavformat_matroskaenc.c.patch	2011-04-20 14:48:26 UTC (rev 7154)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ffmpeg_package/patches/libavformat_matroskaenc.c.patch	2011-04-22 08:37:01 UTC (rev 7155)
@@ -42,7 +42,7 @@
          put_ebml_uint (pb, MATROSKA_ID_TRACKFLAGLACING , 0);    // no lacing (yet)
  
 + 		/**  MEANX : Add a default duration for video **/
-+ 		if(codec-&gt;codec_type==CODEC_TYPE_VIDEO)
++ 		if(codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO)
 + 		{
 + 			if(codec-&gt;time_base.den &amp;&amp; codec-&gt;time_base.num)
 + 			{

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp	2011-04-20 14:48:26 UTC (rev 7154)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp	2011-04-22 08:37:01 UTC (rev 7155)
@@ -18,6 +18,7 @@
 
 extern &quot;C&quot; {
 #include &quot;libavcodec/avcodec.h&quot;
+#include &quot;libavutil/audioconvert.h&quot;
 }
 
 #include &quot;ADM_ad_plugin.h&quot;
@@ -27,11 +28,12 @@
 class ADM_AudiocoderLavcodec : public     ADM_Audiocodec
 {
 	protected:
-		void *_contextVoid;
-		uint8_t _buffer[ ADMWA_BUF];
-		uint32_t _tail,_head;
-		uint32_t _blockalign;
-        uint32_t channels;
+	    bool        useFloat;
+		void      *_contextVoid;
+		uint8_t    _buffer[ ADMWA_BUF];
+		uint32_t   _tail,_head;
+		uint32_t   _blockalign;
+        uint32_t    channels;
         bool        decodeToS16(float *outptr,uint32_t *nbOut);
         bool        decodeToFloat(float *outptr,uint32_t *nbOut);
 	public:
@@ -59,9 +61,9 @@
         {WAV_MP2,AD_MEDIUM_QUAL},
         {WAV_AC3,AD_LOW_QUAL},   // liba52 preferred ???
         {WAV_AAC,AD_LOW_QUAL},   // libfaad preferred ???
-        {0x706D,AD_LOW_QUAL}, 
+        {0x706D,AD_LOW_QUAL},
         {WAV_EAC3,AD_MEDIUM_QUAL}
-  
+
 };
 
 DECLARE_AUDIO_DECODER(ADM_AudiocoderLavcodec,						// Class
@@ -97,8 +99,8 @@
  ADM_AudiocoderLavcodec::ADM_AudiocoderLavcodec(uint32_t fourcc,WAVHeader *info,uint32_t l,uint8_t *d)
        :  ADM_Audiocodec(fourcc)
  {
-    printf(&quot; [ADM_AD_LAV] Using decoder for type 0x%x\n&quot;,info-&gt;encoding);
-    printf(&quot; [ADM_AD_LAV] #of channels %d\n&quot;,info-&gt;channels);
+    ADM_info(&quot; [ADM_AD_LAV] Using decoder for type 0x%x\n&quot;,info-&gt;encoding);
+    ADM_info(&quot; [ADM_AD_LAV] #of channels %d\n&quot;,info-&gt;channels);
     _tail=_head=0;
     channels=info-&gt;channels;
     _contextVoid=(void *)avcodec_alloc_context();
@@ -109,7 +111,6 @@
     _context-&gt;channels = info-&gt;channels;
     _blockalign=_context-&gt;block_align = info-&gt;blockalign;
     _context-&gt;bit_rate = info-&gt;byterate*8;
-    _context-&gt;sample_fmt=AV_SAMPLE_FMT_S16;
     switch(fourcc)
     {
       case WAV_WMA:
@@ -158,9 +159,6 @@
     }
 
 
-
-
-
     _context-&gt;extradata=(uint8_t *)d;
     _context-&gt;extradata_size=(int)l;
     printf(&quot;[ADM_AD_LAV] Using %d bytes of extra header data\n&quot;, _context-&gt;extradata_size);
@@ -168,23 +166,41 @@
 
    AVCodec *codec=avcodec_find_decoder(_context-&gt;codec_id);
    if(!codec) {ADM_assert(0);}
+
+    useFloat=false;
+    _context-&gt;sample_fmt=AV_SAMPLE_FMT_FLT;
     if (avcodec_open(_context, codec) &lt; 0)
     {
-        printf(&quot;[audioCodec] Lavc audio decoder init failed !\n&quot;);
-        ADM_assert(0);
+         ADM_warning(&quot;[audioCodec] Cannot use float, retrying with int16 \n&quot;);
+         _context-&gt;sample_fmt=AV_SAMPLE_FMT_S16;
+         if (avcodec_open(_context, codec) &lt; 0)
+          {
+              ADM_warning(&quot;[audioCodec] int16 failed also. Crashing.. \n&quot;);
+              ADM_assert(0);
+          }
+          ADM_info(&quot;Decoder created using i..\n&quot;);
+    }else
+    {
+        useFloat=true;
+        ADM_info(&quot;Decoder created using float..\n&quot;);
     }
+
+
     if(!_blockalign)
     {
       if(_context-&gt;block_align) _blockalign=_context-&gt;block_align;
       else
       {
-        printf(&quot;[ADM_ad_lav] : no blockalign taking 378\n&quot;);
+        ADM_info(&quot;[ADM_ad_lav] : no blockalign taking 378\n&quot;);
         _blockalign=378;
       }
     }
-    printf(&quot;[ADM_ad_lav] init successful (blockalign %d)\n&quot;,info-&gt;blockalign);
-  
+    ADM_info(&quot;[ADM_ad_lav] init successful (blockalign %d)\n&quot;,info-&gt;blockalign);
+
 }
+/**
+    \fn dtor
+*/
  ADM_AudiocoderLavcodec::~ADM_AudiocoderLavcodec()
  {
         avcodec_close(_context);
@@ -205,8 +221,12 @@
         {
           nbChunk=(_tail-_head)/_blockalign;
           pout=SCRATCH_PAD_SIZE;
-          out=avcodec_decode_audio2(_context,(int16_t *)scratchPad,
-                                   &amp;pout,_buffer+_head,nbChunk*_blockalign);
+          AVPacket pkt;
+          av_init_packet(&amp;pkt);
+          pkt.size=nbChunk*_blockalign;
+          pkt.data=_buffer+_head;
+          out=avcodec_decode_audio3(_context,(int16_t *)scratchPad,
+                                   &amp;pout,&amp;pkt);
 
           if(out&lt;0)
           {
@@ -252,36 +272,31 @@
         {
           nbChunk=(_tail-_head)/_blockalign;
           pout=SCRATCH_PAD_SIZE;
-          out=avcodec_decode_audio2(_context,(int16_t *)outptr,
-                                   &amp;pout,_buffer+_head,nbChunk*_blockalign);
+
+          AVPacket pkt;
+          av_init_packet(&amp;pkt);
+          pkt.size=nbChunk*_blockalign;
+          pkt.data=_buffer+_head;
+
+          out=avcodec_decode_audio3(_context,(int16_t *)outptr,
+                                   &amp;pout,&amp;pkt);
             //ADM_info(&quot;in %d out %d\n&quot;,out,pout);
 
           if(out&lt;0)
           {
-            printf( &quot;[ADM_ad_lav] *** decoding error (%u)***\n&quot;,_blockalign);
+            ADM_warning( &quot;[ADM_ad_lav] *** decoding error (%u)***\n&quot;,_blockalign);
             _head+=1; // Try skipping some bytes
             continue;
           }
           if(pout&gt;=SCRATCH_PAD_SIZE)
           {
-            printf(&quot;[ADM_ad_lav]Produced : %u, buffer %u,in%u\n&quot;,pout,SCRATCH_PAD_SIZE,_tail-_head);
+            ADM_error(&quot;[ADM_ad_lav]Produced : %u, buffer %u,in%u\n&quot;,pout,SCRATCH_PAD_SIZE,_tail-_head);
             ADM_assert(0);
           }
 
           _head+=out; // consumed bytes
           pout/=sizeof(float); // size in bytes -&gt; nb float
-          // convert float[+-32767] to float[+-1]...
-#if 0
-          for(int i=0;i&lt;pout;i++)
-          {
-            float f=*outptr;
-            f/=32767.;
-            *outptr=f;
-            outptr++;
-          }
-#else
-            outptr+=pout;
-#endif          
+          outptr+=pout;
           *nbOut+=pout;
         }
     return true;
@@ -305,34 +320,27 @@
         ADM_assert(nbIn+_tail&lt;ADMWA_BUF);
         memcpy(_buffer+_tail,inptr,nbIn);
         _tail+=nbIn;
-        //---------------
-        switch(_context-&gt;codec_id)
-        {
-            case CODEC_ID_AC3:
-            case CODEC_ID_EAC3:
-            case CODEC_ID_DTS:
-                    decodeToFloat(outptr,nbOut);
-                    break;
-            default:
-                    decodeToS16(outptr,nbOut);
-                    break;
-         }
+        if(useFloat)
+         decodeToFloat(outptr,nbOut);
+        else
+         decodeToS16(outptr,nbOut);
+
         //------------------
           if(channels&gt;=5 )
             {
             CHANNEL_TYPE *p_ch_type = channelMapping;
-#define DOIT(x,y) if(_context-&gt;channel_layout &amp; CH_##x) *(p_ch_type++)=ADM_CH_##y;
-                    
+#define DOIT(x,y) if(_context-&gt;channel_layout &amp; AV_CH_##x) *(p_ch_type++)=ADM_CH_##y;
+
                     DOIT(FRONT_LEFT,FRONT_LEFT);
                     DOIT(FRONT_RIGHT,FRONT_RIGHT);
-                    DOIT(FRONT_CENTER,FRONT_CENTER);                    
+                    DOIT(FRONT_CENTER,FRONT_CENTER);
                     DOIT(LOW_FREQUENCY,LFE);
                     DOIT(SIDE_LEFT,REAR_LEFT);
-                    DOIT(SIDE_RIGHT,REAR_RIGHT);
+                    DOIT(SIDE_RIGHT,REAR_RIGHT); // AV_CH_SIDE_LEFT
             }
-        
+
         return 1;
 }
-//---
+//--- EOF
 
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2011-04-20 14:48:26 UTC (rev 7154)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.cpp	2011-04-22 08:37:01 UTC (rev 7155)
@@ -1,10 +1,10 @@
 /***************************************************************************
-                        
+
     copyright            : (C) 2002-2006 by mean
     email                : <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
-    
+
     Interface to FFmpeg mpeg1/2 audio encoder
-    
+
  ***************************************************************************/
 
 /***************************************************************************
@@ -20,6 +20,7 @@
 
 extern &quot;C&quot; {
 #include &quot;libavcodec/avcodec.h&quot;
+#include &quot;libavutil/error.h&quot;
 }
 
 #include &quot;DIA_factory.h&quot;
@@ -36,7 +37,7 @@
 /********************* Declare Plugin *****************************************************/
 ADM_DECLARE_AUDIO_ENCODER_PREAMBLE(AUDMEncoder_Lavcodec);
 
-static ADM_audioEncoder encoderDesc = { 
+static ADM_audioEncoder encoderDesc = {
   ADM_AUDIO_ENCODER_API_VERSION,
   create,			// Defined by macro automatically
   destroy,			// Defined by macro automatically
@@ -53,7 +54,7 @@
   setConfigurationData,  // Defined by macro automatically
 
   getBitrate,           // Defined by macro automatically
-  setBitrate,            // Defined by macro automatically 
+  setBitrate,            // Defined by macro automatically
 
   NULL,         //** put your own function here**
 
@@ -70,7 +71,7 @@
 */
 AUDMEncoder_Lavcodec::AUDMEncoder_Lavcodec(AUDMAudioFilter * instream,bool globalHeader)  :ADM_AudioEncoder    (instream)
 {
-  
+
   _context=NULL;
   _globalHeader=globalHeader;
    printf(&quot;[Lavcodec] Creating Lavcodec audio encoder (0x%x)\n&quot;,makeName(WAV));
@@ -96,7 +97,7 @@
         *d=CONTEXT-&gt;extradata;
         *l=(uint32_t)size;
     }
-    else    
+    else
     {
         *d=NULL;
         *l=0;
@@ -125,24 +126,24 @@
 {
   int ret;
   _context=( void *)avcodec_alloc_context();
-  
+  _useFloat=true;
 
   if( _incoming-&gt;getInfo()-&gt;channels&gt;ADM_LAV_MAX_CHANNEL)
   {
     ADM_error(&quot;[Lavcodec]Too many channels\n&quot;);
-    return 0; 
+    return 0;
   }
-  wavheader.byterate=(lavBitrate*1000)&gt;&gt;3;         
-      
+  wavheader.byterate=(lavBitrate*1000)&gt;&gt;3;
+
   _chunk = ADM_LAV_SAMPLE_PER_P*wavheader.channels; // AC3
   ADM_info(&quot;[Lavcodec]Incoming : fq : %&quot;LU&quot;, channel : %&quot;LU&quot; bitrate: %&quot;LU&quot; \n&quot;,
   wavheader.frequency,wavheader.channels,lavBitrate);
-  
-  
+
+
   CONTEXT-&gt;channels     =  wavheader.channels;
   CONTEXT-&gt;sample_rate  =  wavheader.frequency;
   CONTEXT-&gt;bit_rate     = (lavBitrate*1000); // bits -&gt; kbits
-
+  CONTEXT-&gt;sample_fmt   =  AV_SAMPLE_FMT_FLT;
   if(true==_globalHeader)
   {
     ADM_info(&quot;Configuring audio codec to use global headers\n&quot;);
@@ -152,21 +153,39 @@
   AVCodec *codec;
   CodecID codecID;
 
-  
+
   codecID=makeName(CODEC_ID);
   codec = avcodec_find_encoder(codecID);
   ADM_assert(codec);
-  
+  // Try float...
   ret = avcodec_open(CONTEXT, codec);
-  if (0&gt; ret) 
+  if (0&gt; ret)
   {
-    ADM_error(&quot;[Lavcodec] init failed err : %d!\n&quot;,ret);
-    return 0;
-  }
+    char er[256]={0};
+    av_strerror(ret, er, sizeof(er));
+    ADM_info(&quot;[Lavcodec] init failed err : %d %s!\n&quot;,ret,er);
+    ADM_info(&quot;Float failed, retrying with int16\n&quot;);
+    CONTEXT-&gt;sample_fmt   =  AV_SAMPLE_FMT_S16;
+    ret = avcodec_open(CONTEXT, codec);
+    if (0&gt; ret)
+    {
+        char er[256]={0};
+        av_strerror(ret, er, sizeof(er));
+        ADM_error(&quot;[Lavcodec] init failed err : %d %s!\n&quot;,ret,er);
+        ADM_info(&quot;s16 failed\n&quot;);
+        return 0;
+    }
+    _useFloat=false;
+    ADM_info(&quot;Using int16 samples\n&quot;);
+  }else
+     {
+         _useFloat=true;
+         ADM_info(&quot;Using float samples\n&quot;);
+     }
 
 
   ADM_info(&quot;[Lavcodec]Lavcodec successfully initialized,wavTag : 0x%x\n&quot;,makeName(WAV));
-  return 1;       
+  return 1;
 }
 /**
     \fn encode
@@ -188,12 +207,13 @@
         {
             if(left) // Last block
             {
-               dither16(&amp;(tmpbuffer[tmphead]),left,channels);
+               if(_useFloat==false)
+                    dither16(&amp;(tmpbuffer[tmphead]),left,channels);
                ADM_assert(tmptail&gt;=tmphead);
 #warning buffer overread
                nbout = avcodec_encode_audio(CONTEXT, dest, 5000, (short *) &amp;(tmpbuffer[tmphead]));
                tmphead=tmptail;
-               *samples = left/channels; 
+               *samples = left/channels;
                *len=nbout;
                ADM_info(&quot;[Lav] Last audio block\n&quot;);
                goto cnt;
@@ -204,14 +224,14 @@
               if(CONTEXT-&gt;codec-&gt;capabilities &amp; CODEC_CAP_DELAY)
               {
                   nbout=avcodec_encode_audio(CONTEXT, dest, 5000,NULL);
-                  if(nbout&lt;0) 
+                  if(nbout&lt;0)
                   {
                         ADM_warning(&quot;Error while flushing lame\n&quot;);
-                        return false;   
+                        return false;
                   }
-                        
+
                   *len=nbout;
-                  *samples=_chunk/channels;  
+                  *samples=_chunk/channels;
                   ADM_info(&quot;[Lav] Flushing, last block is %d bytes\n&quot;,nbout);
                   return true;
               }else
@@ -222,20 +242,21 @@
         }
     }
 
+  if(_useFloat==false)
+    dither16(&amp;(tmpbuffer[tmphead]),_chunk,channels);
 
-  dither16(&amp;(tmpbuffer[tmphead]),_chunk,channels);
-
   ADM_assert(tmptail&gt;=tmphead);
   nbout = avcodec_encode_audio(CONTEXT, dest, 5000, (short *) &amp;(tmpbuffer[tmphead]));
 
   tmphead+=_chunk;
 cnt:
-  if (nbout &lt; 0) 
+  if (nbout &lt; 0)
   {
     ADM_error(&quot;[Lavcodec] Error !!! : %&quot;LD&quot;\n&quot;, nbout);
     return 0;
   }
   *len=nbout;
+  *samples=_chunk/channels;
   return true;
 }
 #define SZT(x) sizeof(x)/sizeof(diaMenuEntry )
@@ -261,13 +282,13 @@
                               BITRATE(384)
                           };
     diaElemMenu bitrate(&amp;(lavBitrate),   QT_TR_NOOP(&quot;_Bitrate:&quot;), SZT(bitrateM),bitrateM);
-  
-    
 
+
+
     diaElem *elems[]={&amp;bitrate};
-    
+
     return ( diaFactoryRun(QT_TR_NOOP(ADM_LAV_MENU&quot; (lav) Configuration&quot;),1,elems));
-    
-}	
 
+}
+
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.h	2011-04-20 14:48:26 UTC (rev 7154)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioEncoders/lavcodec/audioencoder_lavcodec.h	2011-04-22 08:37:01 UTC (rev 7155)
@@ -18,12 +18,12 @@
 class AUDMEncoder_Lavcodec : public ADM_AudioEncoder
 {
   protected:
-   
+    bool               _useFloat;
     void              *_context;
     uint32_t            _chunk;
     bool               _globalHeader;
-    
-         
+
+
   public:
             bool        initialize(void);
    virtual             ~AUDMEncoder_Lavcodec();

Modified: branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake	2011-04-20 14:48:26 UTC (rev 7154)
+++ branches/avidemux_2.6_branch_mean/cmake/admFFmpegBuild.cmake	2011-04-22 08:37:01 UTC (rev 7155)
@@ -1,5 +1,7 @@
-set(FFMPEG_VERSION &quot;8cb3c557a9f3b24bc55325e3f64a2150b983305c&quot;)	# <A HREF="http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz">http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz</A>
+set(FFMPEG_VERSION &quot;efb5fa79f5ca34140db357a00c999286097ab53e&quot;)	# <A HREF="http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz">http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz</A>
+#set(FFMPEG_VERSION &quot;8cb3c557a9f3b24bc55325e3f64a2150b983305c&quot;)	# <A HREF="http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz">http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=2be4fa05c5528073bcfc472d1c23f2d77b679a9d;sf=tgz</A>
 
+
 set(FFMPEG_ROOT_DIR &quot;${AVIDEMUX_TOP_SOURCE_DIR}/avidemux_core/ffmpeg_package&quot;)
 set(FFMPEG_PATCH_DIR  &quot;${FFMPEG_ROOT_DIR}/patches/&quot;)
 set(FFMPEG_SOURCE_ARCHIVE &quot;ffmpeg_r${FFMPEG_VERSION}.tar.gz&quot;)
@@ -13,12 +15,15 @@
 					 mjpegb  mpeg2video  mpeg4  msmpeg4v2  msmpeg4v3  msvideo1  nellymoser  png  qdm2  rawvideo  snow
 					 svq3  theora  tscc 
 					 vc1  vp3  vp6  vp6a  vp6f  wmav2  wmv1  wmv2  wmv3)
-set(FFMPEG_ENCODERS  ac3  dvvideo  ffv1  ffvhuff  flv  h263  huffyuv  mjpeg  mp2  mpeg1video  mpeg2video  mpeg4  snow aac)
+set(FFMPEG_ENCODERS  ac3  ac3_float dvvideo  ffv1  ffvhuff  flv  h263  huffyuv  mjpeg  mp2  mpeg1video  mpeg2video  mpeg4  snow aac)
 set(FFMPEG_MUXERS  flv  matroska  mpeg1vcd  mpeg2dvd  mpeg2svcd  mpegts  mov  mp4  psp)
 set(FFMPEG_PARSERS  ac3  h263  h264  mpeg4video)
 set(FFMPEG_PROTOCOLS  file)
-set(FFMPEG_FLAGS  --enable-shared --disable-static --disable-everything --disable-avfilter --enable-hwaccels --enable-postproc --enable-gpl 
-				  --enable-runtime-cpudetect --disable-network --disable-ffplay --disable-ffprobe)
+set(FFMPEG_FLAGS  --enable-shared --disable-static --disable-everything --disable-avfilter )
+set(FFMPEG_FLAGS  ${FFMPEG_FLAGS} --enable-hwaccels --enable-postproc --enable-gpl )
+set(FFMPEG_FLAGS  ${FFMPEG_FLAGS} --enable-runtime-cpudetect --disable-network )
+set(FFMPEG_FLAGS  ${FFMPEG_FLAGS} --disable-ffplay --disable-ffprobe)
+set(FFMPEG_FLAGS  ${FFMPEG_FLAGS} --enable-audio-float)
 
 MACRO (xadd opt)
 	set(FFMPEG_FLAGS ${FFMPEG_FLAGS} ${opt})
@@ -219,7 +224,6 @@
 
 add_custom_command(OUTPUT
 						&quot;${FFMPEG_BINARY_DIR}/libavcodec/${LIBAVCODEC_LIB}&quot;
-						&quot;${FFMPEG_BINARY_DIR}/libavcore/${LIBAVCORE_LIB}&quot;
 						&quot;${FFMPEG_BINARY_DIR}/libavformat/${LIBAVFORMAT_LIB}&quot;
 						&quot;${FFMPEG_BINARY_DIR}/libavutil/${LIBAVUTIL_LIB}&quot;
 						&quot;${FFMPEG_BINARY_DIR}/libpostproc/${LIBPOSTPROC_LIB}&quot;
@@ -237,14 +241,12 @@
 ADM_INSTALL_LIB_FILES(&quot;${FFMPEG_BINARY_DIR}/libavutil/${LIBAVUTIL_LIB}&quot;)
 ADM_INSTALL_LIB_FILES(&quot;${FFMPEG_BINARY_DIR}/libavcodec/${LIBAVCODEC_LIB}&quot;)
 ADM_INSTALL_LIB_FILES(&quot;${FFMPEG_BINARY_DIR}/libavformat/${LIBAVFORMAT_LIB}&quot;)
-ADM_INSTALL_LIB_FILES(&quot;${FFMPEG_BINARY_DIR}/libavcore/${LIBAVCORE_LIB}&quot;)
 
 install(FILES &quot;${FFMPEG_BINARY_DIR}/libavutil/avconfig.h&quot; DESTINATION &quot;${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/libavutil&quot;) 
 
 install(FILES &quot;${FFMPEG_SOURCE_DIR}/libavcodec/avcodec.h&quot; &quot;${FFMPEG_SOURCE_DIR}/libavcodec/vdpau.h&quot;
+	&quot;${FFMPEG_SOURCE_DIR}/libavcodec/version.h&quot; 
 	DESTINATION &quot;${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/libavcodec&quot;)
-install(FILES &quot;${FFMPEG_SOURCE_DIR}/libavcore/audioconvert.h&quot; &quot;${FFMPEG_SOURCE_DIR}/libavcore/avcore.h&quot; 
-	&quot;${FFMPEG_SOURCE_DIR}/libavcore/samplefmt.h&quot; DESTINATION &quot;${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/libavcore&quot;)
 install(FILES &quot;${FFMPEG_SOURCE_DIR}/libavformat/avformat.h&quot; &quot;${FFMPEG_SOURCE_DIR}/libavformat/avio.h&quot;
 	&quot;${FFMPEG_SOURCE_DIR}/libavformat/version.h&quot; 
 	&quot;${FFMPEG_SOURCE_DIR}/libavformat/flv.h&quot; DESTINATION &quot;${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/libavformat&quot;)
@@ -253,6 +255,7 @@
 	&quot;${FFMPEG_SOURCE_DIR}/libavutil/cpu.h&quot; &quot;${FFMPEG_SOURCE_DIR}/libavutil/intfloat_readwrite.h&quot;
 	&quot;${FFMPEG_SOURCE_DIR}/libavutil/log.h&quot; &quot;${FFMPEG_SOURCE_DIR}/libavutil/mathematics.h&quot;
 	&quot;${FFMPEG_SOURCE_DIR}/libavutil/mem.h&quot; &quot;${FFMPEG_SOURCE_DIR}/libavutil/pixfmt.h&quot;
+	&quot;${FFMPEG_SOURCE_DIR}/libavutil/samplefmt.h&quot; &quot;${FFMPEG_SOURCE_DIR}/libavutil/audioconvert.h&quot;
 	&quot;${FFMPEG_SOURCE_DIR}/libavutil/rational.h&quot; DESTINATION &quot;${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/libavutil&quot;)
 install(FILES &quot;${FFMPEG_SOURCE_DIR}/libpostproc/postprocess.h&quot; DESTINATION &quot;${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/libpostproc&quot;)
 install(FILES &quot;${FFMPEG_SOURCE_DIR}/libswscale/swscale.h&quot; DESTINATION &quot;${AVIDEMUX_INCLUDE_DIR}/avidemux/2.6/libswscale&quot;)

Modified: branches/avidemux_2.6_branch_mean/cmake/admFFmpegPrepareGit.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admFFmpegPrepareGit.cmake	2011-04-20 14:48:26 UTC (rev 7154)
+++ branches/avidemux_2.6_branch_mean/cmake/admFFmpegPrepareGit.cmake	2011-04-22 08:37:01 UTC (rev 7155)
@@ -8,7 +8,7 @@
 # Checkout FFmpeg source and patch it
 if (NOT EXISTS  &quot;${FFMPEG_SOURCE_DIR}/${FFMPEG_VERSION}&quot;)
 	message(STATUS &quot;Checking out FFmpeg from git repository&quot;)
-	execute_process(COMMAND ${GIT_EXECUTABLE} clone --depth 20 <A HREF="git://git.ffmpeg.org/ffmpeg.git">git://git.ffmpeg.org/ffmpeg.git</A>  &quot;${FFMPEG_SOURCE_DIR}&quot;
+	execute_process(COMMAND ${GIT_EXECUTABLE} clone --depth 20 <A HREF="git://git.videolan.org/ffmpeg.git">git://git.videolan.org/ffmpeg.git</A>  &quot;${FFMPEG_SOURCE_DIR}&quot;
 					${ffmpegGitOutput})
 	MESSAGE(STATUS &quot;Going to revision ${FFMPEG_VERSION}&quot;)
 	execute_process(COMMAND ${GIT_EXECUTABLE} checkout   ${FFMPEG_VERSION}

Modified: branches/avidemux_2.6_branch_mean/cmake/admFFmpegUtil.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admFFmpegUtil.cmake	2011-04-20 14:48:26 UTC (rev 7154)
+++ branches/avidemux_2.6_branch_mean/cmake/admFFmpegUtil.cmake	2011-04-22 08:37:01 UTC (rev 7155)
@@ -5,38 +5,34 @@
 ENDMACRO (getFfmpegVersionFromHeader)
 
 MACRO (getFfmpegLibNames sourceDir)
-	getFfmpegVersionFromHeader(&quot;libavcodec&quot; &quot;${sourceDir}/libavcodec/avcodec.h&quot; LIBAVCODEC_VERSION_MAJOR LIBAVCODEC_VERSION)
-	getFfmpegVersionFromHeader(&quot;libavcore&quot; &quot;${sourceDir}/libavcore/avcore.h&quot; LIBAVCORE_VERSION_MAJOR LIBAVCORE_VERSION)	
+	getFfmpegVersionFromHeader(&quot;libavcodec&quot; &quot;${sourceDir}/libavcodec/version.h&quot; LIBAVCODEC_VERSION_MAJOR LIBAVCODEC_VERSION)
 	getFfmpegVersionFromHeader(&quot;libavformat&quot; &quot;${sourceDir}/libavformat/version.h&quot; LIBAVFORMAT_VERSION_MAJOR LIBAVFORMAT_VERSION)
 	getFfmpegVersionFromHeader(&quot;libavutil&quot; &quot;${sourceDir}/libavutil/avutil.h&quot; LIBAVUTIL_VERSION_MAJOR LIBAVUTIL_VERSION)
 	getFfmpegVersionFromHeader(&quot;libpostproc&quot; &quot;${sourceDir}/libpostproc/postprocess.h&quot; LIBPOSTPROC_VERSION_MAJOR LIBPOSTPROC_VERSION)
 	getFfmpegVersionFromHeader(&quot;libswscale&quot; &quot;${sourceDir}/libswscale/swscale.h&quot; LIBSWSCALE_VERSION_MAJOR LIBSWSCALE_VERSION)
-	#MESSAGE(STATUS &quot;AVFORMAT : ${LIBAVFORMAT_VERSION}, Major : ${LIBAVFORMAT_VERSION_MAJOR}&quot;)
-	#MESSAGE(STATUS &quot;AVCODEC  : ${LIBAVCODEC_VERSION}, Major : ${LIBAVCODEC_VERSION_MAJOR}&quot;)
-	#MESSAGE(STATUS &quot;AVUTIL   : ${LIBAVUTIL_VERSION}, Major : ${LIBAVUTIL_VERSION_MAJOR}&quot;)
-	#MESSAGE(STATUS &quot;POSTPRC  : ${LIBPOSTPROC_VERSION}, Major : ${LIBPOSTPROC_VERSION_MAJOR}&quot;)
-	#MESSAGE(STATUS &quot;SWSCALE  : ${LIBSWSCALE_VERSION}, Major : ${LIBSWSCALE_VERSION_MAJOR}&quot;)
+	MESSAGE(STATUS &quot;AVFORMAT : ${LIBAVFORMAT_VERSION}, Major : ${LIBAVFORMAT_VERSION_MAJOR}&quot;)
+	MESSAGE(STATUS &quot;AVCODEC  : ${LIBAVCODEC_VERSION}, Major : ${LIBAVCODEC_VERSION_MAJOR}&quot;)
+	MESSAGE(STATUS &quot;AVUTIL   : ${LIBAVUTIL_VERSION}, Major : ${LIBAVUTIL_VERSION_MAJOR}&quot;)
+	MESSAGE(STATUS &quot;POSTPRC  : ${LIBPOSTPROC_VERSION}, Major : ${LIBPOSTPROC_VERSION_MAJOR}&quot;)
+	MESSAGE(STATUS &quot;SWSCALE  : ${LIBSWSCALE_VERSION}, Major : ${LIBSWSCALE_VERSION_MAJOR}&quot;)
 	if (UNIX)
 		set(LIBAVCODEC_ADM ADM6)
 	endif (UNIX)
 
 	if (APPLE)
 		set(LIBAVCODEC_LIB lib${LIBAVCODEC_ADM}avcodec.${LIBAVCODEC_VERSION}${CMAKE_SHARED_LIBRARY_SUFFIX})
-		set(LIBAVCORE_LIB lib${LIBAVCODEC_ADM}avcore.${LIBAVCORE_VERSION}${CMAKE_SHARED_LIBRARY_SUFFIX})
 		set(LIBAVFORMAT_LIB lib${LIBAVCODEC_ADM}avformat.${LIBAVFORMAT_VERSION}${CMAKE_SHARED_LIBRARY_SUFFIX})
 		set(LIBAVUTIL_LIB lib${LIBAVCODEC_ADM}avutil.${LIBAVUTIL_VERSION}${CMAKE_SHARED_LIBRARY_SUFFIX})
 		set(LIBPOSTPROC_LIB lib${LIBAVCODEC_ADM}postproc.${LIBPOSTPROC_VERSION}${CMAKE_SHARED_LIBRARY_SUFFIX})
 		set(LIBSWSCALE_LIB lib${LIBAVCODEC_ADM}swscale.${LIBSWSCALE_VERSION}${CMAKE_SHARED_LIBRARY_SUFFIX})
 	elseif (UNIX)
 		set(LIBAVCODEC_LIB lib${LIBAVCODEC_ADM}avcodec${CMAKE_SHARED_LIBRARY_SUFFIX}.${LIBAVCODEC_VERSION})
-		set(LIBAVCORE_LIB lib${LIBAVCODEC_ADM}avcore${CMAKE_SHARED_LIBRARY_SUFFIX}.${LIBAVCORE_VERSION})
 		set(LIBAVFORMAT_LIB lib${LIBAVCODEC_ADM}avformat${CMAKE_SHARED_LIBRARY_SUFFIX}.${LIBAVFORMAT_VERSION})
 		set(LIBAVUTIL_LIB lib${LIBAVCODEC_ADM}avutil${CMAKE_SHARED_LIBRARY_SUFFIX}.${LIBAVUTIL_VERSION})
 		set(LIBPOSTPROC_LIB lib${LIBAVCODEC_ADM}postproc${CMAKE_SHARED_LIBRARY_SUFFIX}.${LIBPOSTPROC_VERSION})
 		set(LIBSWSCALE_LIB lib${LIBAVCODEC_ADM}swscale${CMAKE_SHARED_LIBRARY_SUFFIX}.${LIBSWSCALE_VERSION})
 	else (APPLE)
 		set(LIBAVCODEC_LIB ${LIBAVCODEC_ADM}avcodec-${LIBAVCODEC_VERSION}${CMAKE_SHARED_LIBRARY_SUFFIX})
-		set(LIBAVCORE_LIB ${LIBAVCODEC_ADM}avcore-${LIBAVCORE_VERSION}${CMAKE_SHARED_LIBRARY_SUFFIX})
 		set(LIBAVFORMAT_LIB ${LIBAVCODEC_ADM}avformat-${LIBAVFORMAT_VERSION}${CMAKE_SHARED_LIBRARY_SUFFIX})
 		set(LIBAVUTIL_LIB ${LIBAVCODEC_ADM}avutil-${LIBAVUTIL_VERSION}${CMAKE_SHARED_LIBRARY_SUFFIX})
 		set(LIBPOSTPROC_LIB ${LIBAVCODEC_ADM}postproc-${LIBPOSTPROC_VERSION}${CMAKE_SHARED_LIBRARY_SUFFIX})
@@ -52,7 +48,6 @@
 	add_library(ADM_libavutil UNKNOWN IMPORTED)
 	add_library(ADM_libavcodec UNKNOWN IMPORTED)
 	add_library(ADM_libavformat UNKNOWN IMPORTED)
-	add_library(ADM_libavcore UNKNOWN IMPORTED)
 
 	if (${installed})
 		set_property(TARGET ADM_libswscale PROPERTY IMPORTED_LOCATION &quot;${binaryDir}/${LIBSWSCALE_LIB}&quot;)
@@ -60,17 +55,14 @@
 		set_property(TARGET ADM_libavutil PROPERTY IMPORTED_LOCATION &quot;${binaryDir}/${LIBAVUTIL_LIB}&quot;)
 		set_property(TARGET ADM_libavcodec PROPERTY IMPORTED_LOCATION &quot;${binaryDir}/${LIBAVCODEC_LIB}&quot;)
 		set_property(TARGET ADM_libavformat PROPERTY IMPORTED_LOCATION &quot;${binaryDir}/${LIBAVFORMAT_LIB}&quot;)
-		set_property(TARGET ADM_libavcore PROPERTY IMPORTED_LOCATION &quot;${binaryDir}/${LIBAVCORE_LIB}&quot;)
 	else (${installed})
 		set_property(TARGET ADM_libswscale PROPERTY IMPORTED_LOCATION &quot;${binaryDir}/libswscale/${LIBSWSCALE_LIB}&quot;)
 		set_property(TARGET ADM_libpostproc PROPERTY IMPORTED_LOCATION &quot;${binaryDir}/libpostproc/${LIBPOSTPROC_LIB}&quot;)
 		set_property(TARGET ADM_libavutil PROPERTY IMPORTED_LOCATION &quot;${binaryDir}/libavutil/${LIBAVUTIL_LIB}&quot;)
 		set_property(TARGET ADM_libavcodec PROPERTY IMPORTED_LOCATION &quot;${binaryDir}/libavcodec/${LIBAVCODEC_LIB}&quot;)
 		set_property(TARGET ADM_libavformat PROPERTY IMPORTED_LOCATION &quot;${binaryDir}/libavformat/${LIBAVFORMAT_LIB}&quot;)
-		set_property(TARGET ADM_libavcore PROPERTY IMPORTED_LOCATION &quot;${binaryDir}/libavcore/${LIBAVCORE_LIB}&quot;)
 
 		add_custom_target(libavcodec DEPENDS &quot;${binaryDir}/libavcodec/${LIBAVCODEC_LIB}&quot;)
-		add_custom_target(libavcore DEPENDS &quot;${binaryDir}/libavcore/${LIBAVCORE_LIB}&quot;)
 		add_custom_target(libavformat DEPENDS &quot;${binaryDir}/libavformat/${LIBAVFORMAT_LIB}&quot;)
 		add_custom_target(libavutil DEPENDS &quot;${binaryDir}/libavutil/${LIBAVUTIL_LIB}&quot;)
 		add_custom_target(libpostproc DEPENDS &quot;${binaryDir}/libpostproc/${LIBAVPOSTPROC_LIB}&quot;)
@@ -79,7 +71,6 @@
 
 		if (${CMAKE_VERSION} VERSION_GREATER 2.8.3)
 			add_dependencies(ADM_libavcodec libavcodec)
-			add_dependencies(ADM_libavcore libavcore)
 			add_dependencies(ADM_libavformat libavformat)
 			add_dependencies(ADM_libavutil libavutil)
 			add_dependencies(ADM_libpostproc libpostproc)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004312.html">[Avidemux-svn-commit] r7153 -	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit
</A></li>
	<LI>Next message: <A HREF="004314.html">[Avidemux-svn-commit] r7157 - in	branches/avidemux_2.6_branch_mean/autononreg/py: . codec_out
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4313">[ date ]</a>
              <a href="thread.html#4313">[ thread ]</a>
              <a href="subject.html#4313">[ subject ]</a>
              <a href="author.html#4313">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
