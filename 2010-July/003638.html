<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r6450 - in branches/avidemux_2.6_branch_mean:	avidemux avidemux/common/ADM_render	avidemux/common/ADM_videoCodec/include	avidemux/common/ADM_videoCodec/src avidemux_core	avidemux_core/ADM_coreUI/include avidemux_core/ADM_coreVdpau	avidemux_core/ADM_coreVdpau/include avidemux_core/ADM_coreVdpau/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2010-July/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6450%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux%20avidemux/common/ADM_render%0A%09avidemux/common/ADM_videoCodec/include%0A%09avidemux/common/ADM_videoCodec/src%20avidemux_core%0A%09avidemux_core/ADM_coreUI/include%20avidemux_core/ADM_coreVdpau%0A%09avidemux_core/ADM_coreVdpau/include%20avidemux_core/ADM_coreVdpau/src&In-Reply-To=%3C20100714121720.D6129480BDF%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003637.html">
   <LINK REL="Next"  HREF="003639.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r6450 - in branches/avidemux_2.6_branch_mean:	avidemux avidemux/common/ADM_render	avidemux/common/ADM_videoCodec/include	avidemux/common/ADM_videoCodec/src avidemux_core	avidemux_core/ADM_coreUI/include avidemux_core/ADM_coreVdpau	avidemux_core/ADM_coreVdpau/include avidemux_core/ADM_coreVdpau/src</H1>
    <B>mean at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6450%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux%20avidemux/common/ADM_render%0A%09avidemux/common/ADM_videoCodec/include%0A%09avidemux/common/ADM_videoCodec/src%20avidemux_core%0A%09avidemux_core/ADM_coreUI/include%20avidemux_core/ADM_coreVdpau%0A%09avidemux_core/ADM_coreVdpau/include%20avidemux_core/ADM_coreVdpau/src&In-Reply-To=%3C20100714121720.D6129480BDF%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r6450 - in branches/avidemux_2.6_branch_mean:	avidemux avidemux/common/ADM_render	avidemux/common/ADM_videoCodec/include	avidemux/common/ADM_videoCodec/src avidemux_core	avidemux_core/ADM_coreUI/include avidemux_core/ADM_coreVdpau	avidemux_core/ADM_coreVdpau/include avidemux_core/ADM_coreVdpau/src">mean at mail.berlios.de
       </A><BR>
    <I>Wed Jul 14 14:17:20 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="003637.html">[Avidemux-svn-commit] r6449 -	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs
</A></li>
        <LI>Next message: <A HREF="003639.html">[Avidemux-svn-commit] r6451 - in	branches/avidemux_2.6_branch_mean/avidemux/common:	ADM_audioFilter/src/ADM_libsamplerate ADM_commonUI ADM_ocr
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3638">[ date ]</a>
              <a href="thread.html#3638">[ thread ]</a>
              <a href="subject.html#3638">[ subject ]</a>
              <a href="author.html#3638">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2010-07-14 14:17:20 +0200 (Wed, 14 Jul 2010)
New Revision: 6450

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/ADM_windowInfo.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/CMakeLists.txt
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/include/ADM_ffmpeg_vdpau_internal.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_ffmpeg_vdpau.cpp
   branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
   branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
Log:
[vdpau] Add abstraction layer

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.h	2010-07-12 17:30:37 UTC (rev 6449)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_render/GUI_render.h	2010-07-14 12:17:20 UTC (rev 6450)
@@ -21,18 +21,8 @@
 
 #include &quot;ADM_image.h&quot;
 typedef bool (*refreshSB)(void);
+#include &quot;ADM_windowInfo.h&quot;
 
-typedef struct
-{
-    void *display;
-    int  window;
-	int x;
-	int y;
-	int width;
-	int height;
-} GUI_WindowInfo;
-
-
 typedef enum 
 {
         ZOOM_1_4,

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/include/ADM_ffmpeg_vdpau_internal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/include/ADM_ffmpeg_vdpau_internal.h	2010-07-12 17:30:37 UTC (rev 6449)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/include/ADM_ffmpeg_vdpau_internal.h	2010-07-14 12:17:20 UTC (rev 6450)
@@ -39,24 +39,7 @@
 
 #define VDPAU ((vdpauContext *)vdpau)
 
-// VDPAU internal linker
 
-typedef struct 
-{
-    VdpGetErrorString       *getErrorString;
-    VdpGetApiVersion        *getApiVersion;
-    VdpGetInformationString *getInformationString;
-
-    VdpVideoSurfaceCreate   *createSurface;
-    VdpVideoSurfaceDestroy  *destroySurface;
-    VdpVideoSurfaceGetBitsYCbCr *getDataSurface;
-
-    VdpDecoderCreate        *decoderCreate;
-    VdpDecoderDestroy       *decoderDestroy;
-    VdpDecoderRender        *decoderRender;
-
-}VdpFunctions;
-
 #define WRAP_Open_Template(funcz,argz,display,codecid) \
 {\
 AVCodec *codec=funcz(argz);\

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_ffmpeg_vdpau.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_ffmpeg_vdpau.cpp	2010-07-12 17:30:37 UTC (rev 6449)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_ffmpeg_vdpau.cpp	2010-07-14 12:17:20 UTC (rev 6450)
@@ -30,8 +30,6 @@
  #include &quot;ADM_ffmpeg/libavcodec/vdpau.h&quot;
 }
 
-#include &quot;vdpau/vdpau_x11.h&quot;
-#include &quot;vdpau/vdpau.h&quot;
 #include &quot;ADM_codec.h&quot;
 #include &quot;ADM_ffmp43.h&quot;
 #include &quot;DIA_coreToolkit.h&quot;
@@ -39,16 +37,13 @@
 #include &quot;ADM_render/GUI_render.h&quot;
 #include &quot;ADM_ffmpeg_vdpau_internal.h&quot;
 #include &quot;prefs.h&quot;
+#include &quot;ADM_coreVdpau/include/ADM_coreVdpau.h&quot;
 #include &quot;ADM_codecVdpau.h&quot;
 
-static VdpFunctions funcs;
 
+
 static bool vdpauWorking=false;
 
-static ADM_LibWrapper        vdpauDynaLoader;
-static VdpDeviceCreateX11    *ADM_createVdpX11;
-static VdpDevice             vdpDevice;
-static VdpGetProcAddress     *vdpProcAddress;
 
 #define aprintf(...) {}
 
@@ -72,63 +67,16 @@
     return v;
 }
 /**
-    \fn getFunc
-    \brief vdpau function pointers from ID
-*/
-static void *getFunc(uint32_t id)
-{
-    void *f;
-    if(VDP_STATUS_OK!=vdpProcAddress(vdpDevice,id,&amp;f)) return NULL;
-    return (void *)f;
-}
-/**
     \fn vdpauProbe
     \brief Try loading vdpau...
 */
 bool vdpauProbe(void)
 {
-    memset(&amp;funcs,0,sizeof(funcs));
-    if(false==vdpauDynaLoader.loadLibrary(&quot;/usr/lib/libvdpau.so&quot;))
-    {
-        return false;
-    }
-    ADM_createVdpX11=(VdpDeviceCreateX11*)vdpauDynaLoader.getSymbol(&quot;vdp_device_create_x11&quot;);
-    if(!ADM_createVdpX11) return false;
-
-    //
     GUI_WindowInfo xinfo;
     void *draw;
     draw=UI_getDrawWidget();
     UI_getWindowInfo(draw,&amp;xinfo );
-    
-    // try to create....
-    if( VDP_STATUS_OK!=ADM_createVdpX11((Display*)xinfo.display,0,&amp;vdpDevice,&amp;vdpProcAddress))
-    {
-        return false;
-    }
-    // Now that we have the vdpProcAddress, time to get the functions....
-#define GetMe(fun,id)         funcs.fun= (typeof(funcs.fun))getFunc(id);ADM_assert(funcs.fun); 
-        
-    GetMe(getErrorString,VDP_FUNC_ID_GET_ERROR_STRING);
-    GetMe(getApiVersion,VDP_FUNC_ID_GET_API_VERSION);
-    GetMe(getInformationString,VDP_FUNC_ID_GET_INFORMATION_STRING);
-
-    GetMe(createSurface,VDP_FUNC_ID_VIDEO_SURFACE_CREATE);
-    GetMe(destroySurface,VDP_FUNC_ID_VIDEO_SURFACE_DESTROY);
-    GetMe(getDataSurface,VDP_FUNC_ID_VIDEO_SURFACE_GET_BITS_Y_CB_CR);
-
-    GetMe(decoderCreate,VDP_FUNC_ID_DECODER_CREATE);
-    GetMe(decoderDestroy,VDP_FUNC_ID_DECODER_DESTROY);
-    GetMe(decoderRender,VDP_FUNC_ID_DECODER_RENDER);
-
-
-
-    const char *versionString=NULL;
-    uint32_t version=0xff;
-        funcs.getInformationString(&amp;versionString);
-        funcs.getApiVersion(&amp;version);
-        ADM_info(&quot;[VDPAU] API : 0x%x, info : %s\n&quot;,version,versionString);
-
+    if(false==admVdpau::init(&amp;xinfo)) return false;
     vdpauWorking=true;
     return true;
 }
@@ -287,8 +235,7 @@
         for(int i=0;i&lt;NB_SURFACE;i++)
             VDPAU-&gt;renders[i]=NULL;
         
-        if(VDP_STATUS_OK!=funcs.decoderCreate(vdpDevice,vdpDecoder,
-                                w,h,15,&amp;(VDPAU-&gt;vdpDecoder)))
+        if(VDP_STATUS_OK!=admVdpau::decoderCreate(vdpDecoder, w,h,15,&amp;(VDPAU-&gt;vdpDecoder)))
         {
             ADM_error(&quot;Cannot create VDPAU decoder\n&quot;);
             alive=false;
@@ -299,7 +246,7 @@
         {
             VDPAU-&gt;renders[i]=new vdpau_render_state;
             memset(VDPAU-&gt;renders[i],0,sizeof( vdpau_render_state));
-            if(VDP_STATUS_OK!=funcs.createSurface(vdpDevice,VDP_CHROMA_TYPE_420,w,h,&amp;(VDPAU-&gt;renders[i]-&gt;surface)))
+            if(VDP_STATUS_OK!=admVdpau::surfaceCreate(w,h,&amp;(VDPAU-&gt;renders[i]-&gt;surface)))
             {
                 ADM_error(&quot;Cannot create surface %d/%d\n&quot;,i,NB_SURFACE);
                 alive=false;
@@ -325,14 +272,14 @@
                 if(VDPAU-&gt;renders[i]-&gt;surface)
                 {
                     if(VDPAU-&gt;renders[i]-&gt;surface)
-                        if(VDP_STATUS_OK!=funcs.destroySurface((VDPAU-&gt;renders[i]-&gt;surface)))
+                        if(VDP_STATUS_OK!=admVdpau::surfaceDestroy((VDPAU-&gt;renders[i]-&gt;surface)))
                                 ADM_error(&quot;Error destroying surface %d\n&quot;,i);
                 }
                 delete VDPAU-&gt;renders[i];
             }
         }
          ADM_info(&quot;[VDPAU] Destroying decoder\n&quot;);
-         if(VDP_STATUS_OK!=funcs.decoderDestroy(VDPAU-&gt;vdpDecoder))
+         if(VDP_STATUS_OK!=admVdpau::decoderDestroy(VDPAU-&gt;vdpDecoder))
                 ADM_error(&quot;Error destroying VDPAU decoder\n&quot;);
          delete VDPAU;
          vdpau=NULL;
@@ -370,16 +317,11 @@
     
    // Copy back the decoded image to our output ADM_image
    aprintf(&quot;[VDPAU] Getting datas from surface %d\n&quot;,surface);
-    status=funcs.getDataSurface(
-                surface,
-                VDP_YCBCR_FORMAT_YV12, //VdpYCbCrFormat   destination_ycbcr_format,
-                ( void * const *)planes, //void * const *   destination_data,
-                stride //destination_pitches
-                );
+    status=admVdpau::getDataSurface(surface,planes, stride );
     if(VDP_STATUS_OK!=status)
     {
         
-        printf(&quot;[VDPAU] Cannot get data from surface &lt;%s&gt;\n&quot;,funcs.getErrorString(status));
+        printf(&quot;[VDPAU] Cannot get data from surface &lt;%s&gt;\n&quot;,admVdpau::getErrorString(status));
         decode_status=false;
         return 0 ;
     }
@@ -401,11 +343,11 @@
     vdpau_pts=d-&gt;reordered_opaque; // Retrieve our PTS
 
      aprintf(&quot;[VDPAU] Decoding Using surface %d\n&quot;, surface);
-    status=funcs.decoderRender(VDPAU-&gt;vdpDecoder, surface,
-                            (void * const *)&amp;rndr-&gt;info, rndr-&gt;bitstream_buffers_used, rndr-&gt;bitstream_buffers);
+    status=admVdpau::decoderRender(VDPAU-&gt;vdpDecoder, surface,
+                            &amp;rndr-&gt;info, rndr-&gt;bitstream_buffers_used, rndr-&gt;bitstream_buffers);
     if(VDP_STATUS_OK!=status)
     {
-        printf(&quot;[VDPAU] No data after decoderRender &lt;%s&gt;\n&quot;,funcs.getErrorString(status));
+        printf(&quot;[VDPAU] No data after decoderRender &lt;%s&gt;\n&quot;,admVdpau::getErrorString(status));
         decode_status=false;
         return ;
     }

Modified: branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-07-12 17:30:37 UTC (rev 6449)
+++ branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-07-14 12:17:20 UTC (rev 6450)
@@ -90,6 +90,7 @@
 ADM_editor6
 ADM_audiocodec6 
 ADM_videocodec6 
+ADM_coreVDPAU6 
 ADM_coreVideoCodec6 
 ADM_commonUI6
 )

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/ADM_windowInfo.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/ADM_windowInfo.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreUI/include/ADM_windowInfo.h	2010-07-14 12:17:20 UTC (rev 6450)
@@ -0,0 +1,12 @@
+#ifndef ADM_WINDOW_INFO_H
+#define ADM_WINDOW_INFO_H
+typedef struct
+{
+    void *display;
+    int  window;
+        int x;
+        int y;
+        int width;
+        int height;
+} GUI_WindowInfo;
+#endif

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/CMakeLists.txt	2010-07-14 12:17:20 UTC (rev 6450)
@@ -0,0 +1 @@
+ADD_SUBDIRECTORY(src)

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/include/ADM_coreVdpau.h	2010-07-14 12:17:20 UTC (rev 6450)
@@ -0,0 +1,43 @@
+/***************************************************************************
+    \file             : ADM_coreVdpau.cpp
+    \brief            : Wrapper around vdpau functions
+    \author           : (C) 2010 by mean <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifndef ADM_CORE_VDPAU_H
+#define ADM_CORE_VDPAU_H
+#include &quot;vdpau/vdpau_x11.h&quot;
+#include &quot;vdpau/vdpau.h&quot;
+#include &quot;ADM_windowInfo.h&quot;
+/**
+    \class admVdpau
+*/
+class admVdpau
+{
+public:
+    static bool         init(GUI_WindowInfo *x);
+    static const char  *getErrorString(VdpStatus er);
+    static bool         isOperationnal(void);
+    static  VdpStatus   decoderCreate( VdpDecoderProfile profile,    uint32_t          width,    uint32_t          height,    uint32_t          max_references,       VdpDecoder *      decoder);
+    static  VdpStatus   decoderDestroy(VdpDecoder decoder);
+    static  VdpStatus   surfaceCreate(uint32_t width,uint32_t height,VdpVideoSurface *surface);
+    static  VdpStatus   surfaceDestroy(VdpVideoSurface surface);
+    static  VdpStatus   getDataSurface(VdpVideoSurface surface,uint8_t *planes[3],uint32_t stride[3]);
+    static  VdpStatus   decoderRender(
+            VdpDecoder                 decoder,
+            VdpVideoSurface            target,
+            const void                 *info,
+            uint32_t                   bitstream_buffer_count,
+            VdpBitstreamBuffer const * bitstream_buffers);
+
+};
+#endif
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/ADM_coreVdpau.cpp	2010-07-14 12:17:20 UTC (rev 6450)
@@ -0,0 +1,203 @@
+/***************************************************************************
+    \file             : ADM_coreVdpau.cpp
+    \brief            : Wrapper around vdpau functions
+    \author           : (C) 2010 by mean <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A>
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;ADM_default.h&quot;
+#include &quot;../include/ADM_coreVdpau.h&quot;
+#include &quot;ADM_dynamicLoading.h&quot;
+
+#ifdef USE_VDPAU
+/**
+    \fn VdpFunctions
+    
+*/
+typedef struct 
+{
+    VdpGetErrorString       *getErrorString;
+    VdpGetApiVersion        *getApiVersion;
+    VdpGetInformationString *getInformationString;
+
+    VdpVideoSurfaceCreate   *createSurface;
+    VdpVideoSurfaceDestroy  *destroySurface;
+    VdpVideoSurfaceGetBitsYCbCr *getDataSurface;
+
+    VdpDecoderCreate        *decoderCreate;
+    VdpDecoderDestroy       *decoderDestroy;
+    VdpDecoderRender        *decoderRender;
+}VdpFunctions;
+
+static VdpFunctions          funcs;
+static ADM_LibWrapper        vdpauDynaLoader;
+static VdpDeviceCreateX11    *ADM_createVdpX11;
+static VdpDevice             vdpDevice;
+static VdpGetProcAddress     *vdpProcAddress;
+static bool                  coreVdpWorking=false;
+/**
+    \fn getFunc
+    \brief vdpau function pointers from ID
+*/
+static void *getFunc(uint32_t id)
+{
+    void *f;
+    if(VDP_STATUS_OK!=vdpProcAddress(vdpDevice,id,&amp;f)) return NULL;
+    return (void *)f;
+}
+
+/**
+    \fn     init
+    \brief
+*/
+bool admVdpau::init(GUI_WindowInfo *x)
+{
+    memset(&amp;funcs,0,sizeof(funcs));
+    if(false==vdpauDynaLoader.loadLibrary(&quot;/usr/lib/libvdpau.so&quot;))
+    {
+        ADM_info(&quot;Cannot load libvdpau.so\n&quot;);
+        return false;
+    }
+    ADM_createVdpX11=(VdpDeviceCreateX11*)vdpauDynaLoader.getSymbol(&quot;vdp_device_create_x11&quot;);
+    if(!ADM_createVdpX11) return false;
+
+    //    
+    // try to create....
+    if( VDP_STATUS_OK!=ADM_createVdpX11((Display*)x-&gt;display,0,&amp;vdpDevice,&amp;vdpProcAddress))
+    {
+        return false;
+    }
+    // Now that we have the vdpProcAddress, time to get the functions....
+#define GetMe(fun,id)         funcs.fun= (typeof(funcs.fun))getFunc(id);ADM_assert(funcs.fun); 
+        
+    GetMe(getErrorString,VDP_FUNC_ID_GET_ERROR_STRING);
+    GetMe(getApiVersion,VDP_FUNC_ID_GET_API_VERSION);
+    GetMe(getInformationString,VDP_FUNC_ID_GET_INFORMATION_STRING);
+
+    GetMe(createSurface,VDP_FUNC_ID_VIDEO_SURFACE_CREATE);
+    GetMe(destroySurface,VDP_FUNC_ID_VIDEO_SURFACE_DESTROY);
+    GetMe(getDataSurface,VDP_FUNC_ID_VIDEO_SURFACE_GET_BITS_Y_CB_CR);
+
+    GetMe(decoderCreate,VDP_FUNC_ID_DECODER_CREATE);
+    GetMe(decoderDestroy,VDP_FUNC_ID_DECODER_DESTROY);
+    GetMe(decoderRender,VDP_FUNC_ID_DECODER_RENDER);
+
+
+
+    const char *versionString=NULL;
+    uint32_t version=0xff;
+        funcs.getInformationString(&amp;versionString);
+        funcs.getApiVersion(&amp;version);
+        ADM_info(&quot;[VDPAU] API : 0x%x, info : %s\n&quot;,version,versionString);
+
+    coreVdpWorking=true;
+    return true;
+}
+/**
+    \fn isOperationnal
+*/
+bool admVdpau::isOperationnal(void)
+{
+    return coreVdpWorking;
+}
+
+VdpStatus admVdpau::decoderCreate( VdpDecoderProfile profile,    uint32_t  width,uint32_t  height,
+            uint32_t  max_references,VdpDecoder *      decoder)
+{
+    return funcs.decoderCreate(vdpDevice,profile,width,height,max_references,decoder);
+}
+VdpStatus  admVdpau::decoderDestroy(VdpDecoder decoder)
+{
+    return funcs.decoderDestroy(decoder);
+}
+VdpStatus  admVdpau::surfaceCreate(uint32_t width,uint32_t height,VdpVideoSurface *surface)
+{
+return funcs.createSurface(vdpDevice,VDP_CHROMA_TYPE_420,width,height,surface);
+}
+VdpStatus  admVdpau::surfaceDestroy(VdpVideoSurface surface)
+{
+    return funcs.destroySurface(surface);
+}
+VdpStatus  admVdpau::getDataSurface(VdpVideoSurface surface,uint8_t *planes[3],uint32_t stride[3])
+{
+  return funcs.getDataSurface(
+                surface,
+                VDP_YCBCR_FORMAT_YV12, //VdpYCbCrFormat   destination_ycbcr_format,
+                ( void * const *)planes, //void * const *   destination_data,
+                stride //destination_pitches
+                );
+}
+const char *admVdpau::getErrorString(VdpStatus er)
+{
+    return funcs.getErrorString(er);
+}
+VdpStatus admVdpau::decoderRender(
+    VdpDecoder                 decoder,
+    VdpVideoSurface            target,
+    const void                 *info,
+    uint32_t                   bitstream_buffer_count,
+    VdpBitstreamBuffer const * bitstream_buffers)
+{
+    return funcs.decoderRender(decoder, target, (void * const *)info,bitstream_buffer_count, bitstream_buffers);
+}
+#else // Dummy when vdpau is not there...
+
+static bool                  coreVdpWorking=false;
+bool admVdpau::init(GUI_WindowInfo *x)
+{
+          return false;
+}
+  
+/**
+    \fn isOperationnal
+*/
+bool admVdpau::isOperationnal(void)
+{
+    ADM_warning(&quot;This binary has no VPDAU support\n&quot;);
+    return coreVdpWorking;
+}
+
+VdpStatus admVdpau::decoderCreate( VdpDecoderProfile profile,    uint32_t  width,uint32_t  height,
+            uint32_t  max_references,VdpDecoder *      decoder)
+{
+    ADM_assert(0);
+}
+VdpStatus  admVdpau::decoderDestroy(VdpDecoder decoder)
+{
+    ADM_assert(0);
+}
+VdpStatus  admVdpau::surfaceCreate(uint32_t width,uint32_t height,VdpVideoSurface *surface)
+{
+ADM_assert(0);
+}
+VdpStatus  admVdpau::surfaceDestroy(VdpVideoSurface surface)
+{
+    ADM_assert(0);
+}
+VdpStatus  admVdpau::getDataSurface(VdpVideoSurface surface,uint8_t *planes[3],uint32_t stride[3])
+{
+  ADM_assert(0);
+}
+const char *admVdpau::getErrorString(VdpStatus er)
+{
+ADM_assert(0);
+}
+VdpStatus admVdpau::decoderRender(
+    VdpDecoder                 decoder,
+    VdpVideoSurface            target,
+    const void                 *info,
+    uint32_t                   bitstream_buffer_count,
+    VdpBitstreamBuffer const * bitstream_buffers)
+{
+    ADM_assert(0);
+}
+
+#endif
+// EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVdpau/src/CMakeLists.txt	2010-07-14 12:17:20 UTC (rev 6450)
@@ -0,0 +1,11 @@
+
+SET(ADM_vdpau_SRCS
+ADM_coreVdpau.cpp
+)	
+#*************************************************
+#*************************************************
+ADD_LIBRARY(ADM_coreVDPAU6 SHARED ${ADM_vdpau_SRCS})
+INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/avidemux/ADM_coreVdpau/include)
+TARGET_LINK_LIBRARIES(ADM_coreVDPAU6 ADM_core6 ADM_coreUI6 )
+
+ADM_INSTALL_LIB(ADM_coreVDPAU6)

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-07-12 17:30:37 UTC (rev 6449)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-07-14 12:17:20 UTC (rev 6450)
@@ -70,6 +70,9 @@
 ADD_SUBDIRECTORY(ADM_ffmpeg)
 ADD_SUBDIRECTORY(ADM_smjs)
 ADD_SUBDIRECTORY(ADM_coreImageLoader)
+
+ADD_SUBDIRECTORY(ADM_coreVdpau)
+
 ########################################
 # Config Summary
 ########################################


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003637.html">[Avidemux-svn-commit] r6449 -	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_codecs
</A></li>
	<LI>Next message: <A HREF="003639.html">[Avidemux-svn-commit] r6451 - in	branches/avidemux_2.6_branch_mean/avidemux/common:	ADM_audioFilter/src/ADM_libsamplerate ADM_commonUI ADM_ocr
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3638">[ date ]</a>
              <a href="thread.html#3638">[ thread ]</a>
              <a href="subject.html#3638">[ subject ]</a>
              <a href="author.html#3638">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
