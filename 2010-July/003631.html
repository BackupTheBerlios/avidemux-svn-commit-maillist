<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r6443 - in branches/avidemux_2.6_branch_mean:	avidemux/common avidemux/common/ADM_editor	avidemux/common/ADM_script2/binding	avidemux/common/ADM_script2/include	avidemux/common/ADM_script2/js avidemux/common/ADM_script2/py	avidemux/common/ADM_script2/src	avidemux/qt4/ADM_userInterfaces/ADM_shell	avidemux_core/ADM_coreTinyPy/include	avidemux_core/ADM_coreTinyPy/src cmake
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2010-July/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6443%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common%20avidemux/common/ADM_editor%0A%09avidemux/common/ADM_script2/binding%0A%09avidemux/common/ADM_script2/include%0A%09avidemux/common/ADM_script2/js%20avidemux/common/ADM_script2/py%0A%09avidemux/common/ADM_script2/src%0A%09avidemux/qt4/ADM_userInterfaces/ADM_shell%0A%09avidemux_core/ADM_coreTinyPy/include%0A%09avidemux_core/ADM_coreTinyPy/src%20cmake&In-Reply-To=%3C20100709052647.C23A1480B01%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003630.html">
   <LINK REL="Next"  HREF="003632.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r6443 - in branches/avidemux_2.6_branch_mean:	avidemux/common avidemux/common/ADM_editor	avidemux/common/ADM_script2/binding	avidemux/common/ADM_script2/include	avidemux/common/ADM_script2/js avidemux/common/ADM_script2/py	avidemux/common/ADM_script2/src	avidemux/qt4/ADM_userInterfaces/ADM_shell	avidemux_core/ADM_coreTinyPy/include	avidemux_core/ADM_coreTinyPy/src cmake</H1>
    <B>mean at mail.berlios.de</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6443%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common%20avidemux/common/ADM_editor%0A%09avidemux/common/ADM_script2/binding%0A%09avidemux/common/ADM_script2/include%0A%09avidemux/common/ADM_script2/js%20avidemux/common/ADM_script2/py%0A%09avidemux/common/ADM_script2/src%0A%09avidemux/qt4/ADM_userInterfaces/ADM_shell%0A%09avidemux_core/ADM_coreTinyPy/include%0A%09avidemux_core/ADM_coreTinyPy/src%20cmake&In-Reply-To=%3C20100709052647.C23A1480B01%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r6443 - in branches/avidemux_2.6_branch_mean:	avidemux/common avidemux/common/ADM_editor	avidemux/common/ADM_script2/binding	avidemux/common/ADM_script2/include	avidemux/common/ADM_script2/js avidemux/common/ADM_script2/py	avidemux/common/ADM_script2/src	avidemux/qt4/ADM_userInterfaces/ADM_shell	avidemux_core/ADM_coreTinyPy/include	avidemux_core/ADM_coreTinyPy/src cmake">mean at mail.berlios.de
       </A><BR>
    <I>Fri Jul  9 07:26:47 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="003630.html">[Avidemux-svn-commit] r6442 - in	branches/avidemux_2.5_branch_gruntster:	avidemux/ADM_coreImage/src cmake cmake/patches
</A></li>
        <LI>Next message: <A HREF="003632.html">[Avidemux-svn-commit] r6444 -	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3631">[ date ]</a>
              <a href="thread.html#3631">[ thread ]</a>
              <a href="subject.html#3631">[ subject ]</a>
              <a href="author.html#3631">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2010-07-09 07:26:47 +0200 (Fri, 09 Jul 2010)
New Revision: 6443

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/adm_print.patch
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/print_stat.patch
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/binding/adm.admPyClass
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/binding/editor.admPyClass
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptCommon.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptEditor.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsEditor.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/ADM_pyAdm.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/editor_gen.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptAvidemux.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/include/ADM_tinypy.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/tinypy.cpp
   branches/avidemux_2.6_branch_mean/cmake/admPyClass.pl
Log:
[py] Merge print patch + editor func + switch float to double, incomplete as tinypy still uses float internally

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.cpp	2010-07-09 05:26:47 UTC (rev 6443)
@@ -602,6 +602,11 @@
     _segments.dump();
     return true;
 }
+bool                ADM_Composer::dumpSegment(int i)
+{
+    _segments.dumpSegment(i);
+    return true;
+}
 /**
 
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_edit.hxx	2010-07-09 05:26:47 UTC (rev 6443)
@@ -228,6 +228,7 @@
 // For js
                     bool                dumpRefVideos(void);
                     bool                dumpSegments(void);
+                    bool                dumpSegment(int i);
                     bool                dumpTiming(void);
                     bool                getVideoPtsDts(uint32_t frame, uint32_t *flags,uint64_t *pts, uint64_t *dts);
 /******************************* /Editing **********************************/										

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.cpp	2010-07-09 05:26:47 UTC (rev 6443)
@@ -376,7 +376,8 @@
 */
 static bool TimeToFrame(_VIDEOS *v,uint64_t time,uint32_t *frame,uint32_t *oflags)
 {
-    vidHeader 							*demuxer=v-&gt;_aviheader;  
+    vidHeader *demuxer=v-&gt;_aviheader;  
+    bool warn=false;
     int nb=demuxer-&gt;getMainHeader()-&gt;dwTotalFrames;
     for(int i=0;i&lt;nb;i++)
     {
@@ -390,6 +391,15 @@
                 *oflags=flags;
                 return true;
             }
+            if(dts!=ADM_NO_PTS &amp;&amp; warn==false)
+            {
+                if(dts&gt;time)
+                {
+                    ADM_error(&quot;We reached frame %d with a PTS of %&quot;LLU&quot; when looking for PTS %&quot;LLU&quot;\n&quot;,
+                                            i,dts,time);
+                    warn=true;
+                }
+            }
     }
     return false;
 }
@@ -490,6 +500,17 @@
     printf(&quot;We have %d segments\n&quot;,n);
     for(int i=0;i&lt;n;i++)
     {
+      dumpSegment(i);
+    }
+}
+void       ADM_EditorSegment::dumpSegment(int i)
+{
+    int n=segments.size();
+    if(i&gt;=n)
+    {
+        ADM_error(&quot;Segment %d too big (%d)\n&quot;,i,(int)n);
+        return ;
+    }
         _SEGMENT *s=getSegment(i);
         
         jsLog(&quot;Segment :%d/%d&quot;,i,n);
@@ -498,7 +519,6 @@
         jsLog( &quot;\tduration     :%08&quot;LLU&quot; %s&quot;,s-&gt;_durationUs,ADM_us2plain(s-&gt;_durationUs));
         jsLog( &quot;\trefStartPts  :%08&quot;LLU&quot; %s&quot;,s-&gt;_refStartTimeUs,ADM_us2plain(s-&gt;_refStartTimeUs));
         jsLog( &quot;\trefStartDts  :%08&quot;LLU&quot; %s&quot;,s-&gt;_refStartDts,ADM_us2plain(s-&gt;_refStartDts));
-    }
 }
 /**
     \fn dumpRefVideos

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.h	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor/ADM_segment.h	2010-07-09 05:26:47 UTC (rev 6443)
@@ -105,6 +105,8 @@
 
 public:
             void        dump(void);
+            void        dumpSegment(int i);
+
             void        dumpRefVideos(void);
                         ADM_EditorSegment(void);
                         ~ADM_EditorSegment();

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/binding/adm.admPyClass
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/binding/adm.admPyClass	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/binding/adm.admPyClass	2010-07-09 05:26:47 UTC (rev 6443)
@@ -5,7 +5,7 @@
 /* METHOD */ int scriptLoadVideo:loadVideo          (str ) 
 /* METHOD */ int scriptClearSegments:clearSegments  (void) 
 /* METHOD */ int scriptAppendVideo:appendVideo      (str ) 
-/* METHOD */ int scriptAddSegment:addSegment        (int ,float , float ) 
+/* METHOD */ int scriptAddSegment:addSegment        (int ,double , double ) 
 /* METHOD */ int scriptSetPostProc:setPostProc      (int ,int , int ) 
 /* METHOD */ int scriptGetWidth:getWidth            (void) 
 /* METHOD */ int scriptGetHeight:getHeight          (void) 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/binding/editor.admPyClass
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/binding/editor.admPyClass	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/binding/editor.admPyClass	2010-07-09 05:26:47 UTC (rev 6443)
@@ -1,7 +1,10 @@
 #              cname:pyname
 /* CLASS */ pyEditor : void : ADM_PYID_EDITOR
 /* METHOD */ int jsPrintTiming:printTiming      (int ) 
-/* METHOD */ int jsDumpSegments:dumpSegment     (void) 
+/* METHOD */ int scriptGetNbSegment:nbSegments  (void)
+/* METHOD */ int jsDumpSegments:dumpAllSegments    (void) 
+/* METHOD */ void scriptDumpSegment:dumpSegment     (int) 
+/* METHOD */ double scriptGetVideoDuration:getVideoDuration  (void) 
 /* METHOD */ int jsDumpRefVideos:dumpRefVideo   (void) 
 /* METHOD */ int jsHexDumpFrame:hexDumpFrame    (int) 
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptCommon.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptCommon.h	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptCommon.h	2010-07-09 05:26:47 UTC (rev 6443)
@@ -43,6 +43,8 @@
 int scriptSetPostProc (int a,int b, int c);
 char *scriptGetVideoCodec ( void);
 
+int  scriptGetNbSegment(void);
+void scriptDumpSegment(int i);
 #ifdef __cplusplus
 };
 #endif 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptEditor.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptEditor.h	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/include/ADM_scriptEditor.h	2010-07-09 05:26:47 UTC (rev 6443)
@@ -23,6 +23,7 @@
 int jsHexDumpFrame(int framenumber );
 int jsDumpSegments (void);
 int jsDumpRefVideos (void);
+float scriptGetVideoDuration(void);
 #ifdef __cplusplus
 };
 #endif

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsEditor.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsEditor.cpp	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/js/ADM_jsEditor.cpp	2010-07-09 05:26:47 UTC (rev 6443)
@@ -92,4 +92,12 @@
         
         return 0;
 }// end PostProcess
+/**
+    \fn scriptGetVideoDuration
+*/
+float scriptGetVideoDuration(void)
+{
+    uint64_t d=video_body-&gt;getVideoDuration();
+    return (float)d;
+}
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/ADM_pyAdm.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/ADM_pyAdm.cpp	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/ADM_pyAdm.cpp	2010-07-09 05:26:47 UTC (rev 6443)
@@ -53,8 +53,7 @@
 #include &quot;pyDFMenu_gen.cpp&quot;
 #include &quot;pyDialogFactory_gen.cpp&quot;
 
-extern pyRegisterClass initClasspyAdm;
-extern pyRegisterClass initClasspyEditor;
+
 /**
 
 */
@@ -69,13 +68,13 @@
 static bool initPy(tinyPy *py)
 {
     py-&gt;init();
-    py-&gt;registerClass(&quot;Avidemux&quot;,initClasspyAdm);
-    py-&gt;registerClass(&quot;Editor&quot;,initClasspyEditor);
-    py-&gt;registerClass(&quot;Gui&quot;,initClasspyGui);
-    py-&gt;registerClass(&quot;DFToggle&quot;,initClasspyDFToggle);
-    py-&gt;registerClass(&quot;DFInteger&quot;,initClasspyDFInteger);
-    py-&gt;registerClass(&quot;DFMenu&quot;,initClasspyDFMenu);
-    py-&gt;registerClass(&quot;DialogFactory&quot;,initClasspyDialogFactory);
+    py-&gt;registerClass(&quot;Avidemux&quot;,initClasspyAdm,&quot;avidemux class&quot;);
+    py-&gt;registerClass(&quot;Editor&quot;,initClasspyEditor,&quot;add, remove videos&quot;);
+    py-&gt;registerClass(&quot;Gui&quot;,initClasspyGui,&quot;widget, alert boxes,..&quot;);
+    py-&gt;registerClass(&quot;DFToggle&quot;,initClasspyDFToggle,&quot;UI element : toggle&quot;);
+    py-&gt;registerClass(&quot;DFInteger&quot;,initClasspyDFInteger,&quot;UI element : integer&quot;);
+    py-&gt;registerClass(&quot;DFMenu&quot;,initClasspyDFMenu,&quot;UI element : drop down menu&quot;);
+    py-&gt;registerClass(&quot;DialogFactory&quot;,initClasspyDialogFactory, &quot;UI manager, handle all UI elements&quot;);
 
     py-&gt;registerFuncs(&quot;test&quot;,pyHelpers_functions);
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp	2010-07-09 05:26:47 UTC (rev 6443)
@@ -144,15 +144,15 @@
   int r=  scriptGetWidth(); 
   return tp_number(r);
 }
-// addSegment -&gt; int scriptAddSegment (int  float   float  ) 
+// addSegment -&gt; int scriptAddSegment (int  double   double  ) 
 static tp_obj zzpy_addSegment(TP)
  {
   tp_obj self=tp_getraw( tp);
   tinyParams pm(tp);
   void *me=(void *)pm.asThis(&amp;self,ADM_PYID_AVIDEMUX);
   int p0= pm.asInt();
-  float p1= pm.asFloat();
-  float p2= pm.asFloat();
+  double p1= pm.asDouble();
+  double p2= pm.asDouble();
   int r=  scriptAddSegment(p0,p1,p2); 
   return tp_number(r);
 }
@@ -366,7 +366,7 @@
   jsLog(&quot;saveAudio(str)&quot;);
   jsLog(&quot;videoCodec(str,couples)&quot;);
   jsLog(&quot;getWidth(void)&quot;);
-  jsLog(&quot;addSegment(int ,float , float )&quot;);
+  jsLog(&quot;addSegment(int ,double , double )&quot;);
   jsLog(&quot;clearVideoFilters(void)&quot;);
   jsLog(&quot;saveJpeg(str)&quot;);
   jsLog(&quot;setContainer(str,couples)&quot;);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/editor_gen.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/editor_gen.cpp	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/editor_gen.cpp	2010-07-09 05:26:47 UTC (rev 6443)
@@ -1,4 +1,22 @@
 // Generated by admPyClass.pl do not edit !
+// nbSegments -&gt; int scriptGetNbSegment (void ) 
+static tp_obj zzpy_nbSegments(TP)
+ {
+  tp_obj self=tp_getraw( tp);
+  tinyParams pm(tp);
+  void *me=(void *)pm.asThis(&amp;self,ADM_PYID_EDITOR);
+  int r=  scriptGetNbSegment(); 
+  return tp_number(r);
+}
+// dumpAllSegments -&gt; int jsDumpSegments (void ) 
+static tp_obj zzpy_dumpAllSegments(TP)
+ {
+  tp_obj self=tp_getraw( tp);
+  tinyParams pm(tp);
+  void *me=(void *)pm.asThis(&amp;self,ADM_PYID_EDITOR);
+  int r=  jsDumpSegments(); 
+  return tp_number(r);
+}
 // printTiming -&gt; int jsPrintTiming (int  ) 
 static tp_obj zzpy_printTiming(TP)
  {
@@ -19,15 +37,25 @@
   int r=  jsHexDumpFrame(p0); 
   return tp_number(r);
 }
-// dumpSegment -&gt; int jsDumpSegments (void ) 
-static tp_obj zzpy_dumpSegment(TP)
+// getVideoDuration -&gt; double scriptGetVideoDuration (void ) 
+static tp_obj zzpy_getVideoDuration(TP)
  {
   tp_obj self=tp_getraw( tp);
   tinyParams pm(tp);
   void *me=(void *)pm.asThis(&amp;self,ADM_PYID_EDITOR);
-  int r=  jsDumpSegments(); 
+  double r=  scriptGetVideoDuration(); 
   return tp_number(r);
 }
+// dumpSegment -&gt; void scriptDumpSegment (int ) 
+static tp_obj zzpy_dumpSegment(TP)
+ {
+  tp_obj self=tp_getraw( tp);
+  tinyParams pm(tp);
+  void *me=(void *)pm.asThis(&amp;self,ADM_PYID_EDITOR);
+  int p0= pm.asInt();
+  scriptDumpSegment(p0); 
+
+}
 // dumpRefVideo -&gt; int jsDumpRefVideos (void ) 
 static tp_obj zzpy_dumpRefVideo(TP)
  {
@@ -43,6 +71,14 @@
   tinyParams pm(vm);
   void *me=(void *)pm.asThis(&amp;self,ADM_PYID_EDITOR);
   char const *key = pm.asString();
+  if (!strcmp(key, &quot;nbSegments&quot;))
+  {
+     return tp_method(vm,self,zzpy_nbSegments);
+  }
+  if (!strcmp(key, &quot;dumpAllSegments&quot;))
+  {
+     return tp_method(vm,self,zzpy_dumpAllSegments);
+  }
   if (!strcmp(key, &quot;printTiming&quot;))
   {
      return tp_method(vm,self,zzpy_printTiming);
@@ -51,6 +87,10 @@
   {
      return tp_method(vm,self,zzpy_hexDumpFrame);
   }
+  if (!strcmp(key, &quot;getVideoDuration&quot;))
+  {
+     return tp_method(vm,self,zzpy_getVideoDuration);
+  }
   if (!strcmp(key, &quot;dumpSegment&quot;))
   {
      return tp_method(vm,self,zzpy_dumpSegment);
@@ -86,9 +126,12 @@
 }
 static tp_obj zzpy__pyEditor_help(TP)
  {
+  jsLog(&quot;nbSegments(void)&quot;);
+  jsLog(&quot;dumpAllSegments(void)&quot;);
   jsLog(&quot;printTiming(int )&quot;);
   jsLog(&quot;hexDumpFrame(int)&quot;);
-  jsLog(&quot;dumpSegment(void)&quot;);
+  jsLog(&quot;getVideoDuration(void)&quot;);
+  jsLog(&quot;dumpSegment(int)&quot;);
   jsLog(&quot;dumpRefVideo(void)&quot;);
 };
 tp_obj initClasspyEditor(tp_vm *vm)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptAvidemux.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptAvidemux.cpp	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/src/ADM_scriptAvidemux.cpp	2010-07-09 05:26:47 UTC (rev 6443)
@@ -93,6 +93,17 @@
     }
     return 0;
 }
+/**
+    \fn scriptGetNbSegment()
 
-
+*/
+int  scriptGetNbSegment(void)
+{
+   return video_body-&gt;getNbSegment() ;
+}
+void scriptDumpSegment(int i)
+{
+        video_body-&gt;dumpSegment(i);
+        return ;
+}
 // EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-07-09 05:26:47 UTC (rev 6443)
@@ -876,10 +876,12 @@
   bool ret;
   ADM_info(&quot;Executing tinyPy script :%s\n&quot;,name);
   char *longname = ADM_PathCanonize(name);
-   if (playing){
-      GUI_PlayAvi();
+   if (playing)
+   {
+        return false;
    }
    ret = parseTinyPyScript(longname);
+   A_Resync(); // total duration &amp; stuff
    if( ret == true )
    {
       video_body-&gt;setProjectName(longname);
@@ -893,10 +895,12 @@
 bool A_parseECMAScript(const char *name){
   bool ret;
   char *longname = ADM_PathCanonize(name);
-   if (playing){
-      GUI_PlayAvi();
+   if (playing)
+    {
+      return false;
    }
    ret = parseECMAScript(longname);
+   A_Resync(); // total duration &amp; stuff
    if( ret == true )
    {
       video_body-&gt;setProjectName(longname);

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_shell/Q_shell.cpp	2010-07-09 05:26:47 UTC (rev 6443)
@@ -94,7 +94,7 @@
         case SCRIPT_LOG_NORMAL: ui.textBrowser-&gt;setTextColor(QColor(0,0,0));break;
         case SCRIPT_LOG_ERROR : ui.textBrowser-&gt;setTextColor(QColor(255,0,0));break;
     }
-    ui.textBrowser-&gt;append(string.toAscii());
+    ui.textBrowser-&gt;append(string);
     ui.textBrowser-&gt;setTextColor(QColor(0,0,0));
     return true;
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/include/ADM_tinypy.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/include/ADM_tinypy.h	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/include/ADM_tinypy.h	2010-07-09 05:26:47 UTC (rev 6443)
@@ -15,8 +15,19 @@
  ***************************************************************************/
 #ifndef ADM_TINYPY_H
 #define ADM_TINYPY_H
+#include &quot;ADM_cpp.h&quot;
 #include &quot;tinypy.h&quot;
 #include &quot;ADM_confCouple.h&quot;
+
+
+typedef struct
+{
+    string className;
+    string desc;
+}admPyClassDescriptor;
+
+
+
 /**
     \struct tyFunc
 */
@@ -40,7 +51,7 @@
                 tinyPy(void);
         bool    init(void);
         bool    registerFuncs(const char *group,pyFuncs *funcs);
-        bool    registerClass(const char *className,pyRegisterClass *pyclass);
+        bool    registerClass(const char *className,pyRegisterClass *pyclass,const char *desc);
                 ~tinyPy(void);
         bool    execString(const char *s);
         bool    execFile(const char *f);
@@ -63,7 +74,7 @@
 public:
         tinyParams(tp_vm *i) {tp=i;}
         int    asInt(void);
-        float  asFloat(void);
+       // float  asFloat(void);
         double asDouble(void);
 const   char  *asString(void);
         void  *asThis(tp_obj *self,int id);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp	2010-07-09 05:26:47 UTC (rev 6443)
@@ -21,12 +21,14 @@
 #include &quot;tinypy.h&quot;
 #include &quot;init_math.cpp&quot;
 //}
+#include &quot;ADM_cpp.h&quot;
 #define INSTANCE ((tp_vm *)instance)
 #define SCRIPT   ((tp_obj *)script)
 
 pyLoggerFunc *pyLog=NULL;
 static tp_obj    tinyPy_dumpBuiltin(tp_vm *vm);
 static pyFuncs addons[]={{&quot;help&quot;,tinyPy_dumpBuiltin},{NULL,NULL}};
+static vector &lt;admPyClassDescriptor&gt; listOfPyClass;;
 /**
 
 */
@@ -66,6 +68,7 @@
 tinyPy::tinyPy(void)
 {
     instance=NULL;
+    listOfPyClass.clear();
 }
 /**
     \fn tinypy
@@ -79,6 +82,7 @@
         tp_deinit(INSTANCE);
         instance=NULL;
     }
+    listOfPyClass.clear();
 }
 /**
     \fn tinypy
@@ -170,9 +174,14 @@
 /**
     \fn registerClass
 */
-bool    tinyPy::registerClass(const char *className,pyRegisterClass classPy)
+bool    tinyPy::registerClass(const char *className,pyRegisterClass classPy, const char *desc)
 {
     ADM_info(&quot;Registering class:%s\n&quot;,className);
+    admPyClassDescriptor  classDesc;
+    classDesc.className=string(className);
+    classDesc.desc=string(desc);
+    listOfPyClass.push_back(classDesc);
+    
     tp_set(INSTANCE, INSTANCE-&gt;builtins, tp_string(className), classPy(INSTANCE));
     return true;
 
@@ -182,6 +191,7 @@
 */
 tp_obj    tinyPy_dumpBuiltin(tp_vm *vm)
 {
+#if 0
     ADM_info(&quot;Dumping builtins\n&quot;);
     tp_obj builtins=vm-&gt;builtins;
     // It is a dict..
@@ -195,6 +205,14 @@
             pyPrintf(&quot;%s\n&quot;,str);
     }
     return tp_None;
+#endif
+    int n=listOfPyClass.size();
+    pyPrintf(&quot;You can get more help using CLASSNAME.help()\n&quot;);
+    for(int i=0;i&lt;n;i++)
+    {
+        pyPrintf(&quot;%s \t%s\n&quot;,listOfPyClass[i].className.c_str(),listOfPyClass[i].desc.c_str());
+    }
+    return tp_None;
 }
 //*********************************************
 #define preamble(xtype) tp_obj obj=TP_OBJ();\
@@ -213,11 +231,13 @@
 /**
    \fn  asFloat
 */
+#if 0
 float    tinyParams::asFloat(void)
 {
     preamble(TP_NUMBER);
     return (float)obj.number.val;
 }
+#endif
 /**
    \fn  asDouble
 */

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/adm_print.patch
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/adm_print.patch	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/adm_print.patch	2010-07-09 05:26:47 UTC (rev 6443)
@@ -0,0 +1,95 @@
+--- tinypy.c.org	2010-05-20 17:21:34.195371840 +0200
++++ tinypy.cpp	2010-07-06 20:49:12.780690579 +0200
+@@ -119,6 +119,10 @@
+ #ifndef tp_inline
+ #error &quot;Unsuported compiler&quot;
+ #endif
++// MEANX : Redirect printf
++bool pyPrintf(const char *fmt,...);
++#define printf pyPrintf
++// ************************
+ 
+ /*  #define tp_malloc(x) calloc((x),1)
+     #define tp_realloc(x,y) realloc(x,y)
+@@ -462,7 +466,8 @@
+ 
+ tp_inline static void tp_echo(TP,tp_obj e) {
+     e = tp_str(tp,e);
+-    fwrite(e.string.val,1,e.string.len,stdout);
++    //fwrite(e.string.val,1,e.string.len,stdout); // MEANX
++    printf(&quot;%s&quot;,e.string.val);
+ }
+ 
+ /* Function: tp_string_n
+@@ -980,12 +985,14 @@
+  * This is how you can create a tinypy function object which, when called in
+  * the script, calls the provided C function.
+  */
++
++//tp_obj tp_fnc_new(TP,int t, void *v, tp_obj c,tp_obj s, tp_obj g) ;
+ tp_obj tp_fnc(TP,tp_obj v(TP)) {
+-    return tp_fnc_new(tp,0,v,tp_None,tp_None,tp_None);
++    return tp_fnc_new(tp,0,(void *)v,tp_None,tp_None, tp_None);
+ }
+ 
+ tp_obj tp_method(TP,tp_obj self,tp_obj v(TP)) {
+-    return tp_fnc_new(tp,2,v,tp_None,self,tp_None);
++    return tp_fnc_new(tp,2,(void*)v,tp_None,self,tp_None);
+ }
+ 
+ /* Function: tp_data
+@@ -2198,6 +2205,7 @@
+         exit(-1);
+ #else
+         tp-&gt;ex = e;
++        printf(&quot;\nException:\n&quot;); tp_echo(tp,e); printf(&quot;\n&quot;);
+         longjmp(tp-&gt;nextexpr,1);
+ #endif
+     }
+@@ -2234,6 +2242,7 @@
+     tp_print_stack(tp);
+     exit(-1);
+ #else
++    tp_print_stack(tp);
+     longjmp(tp-&gt;nextexpr,1);
+ #endif
+ }
+@@ -2425,6 +2434,7 @@
+             #ifdef TP_SANDBOX
+             tp_bounds(tp,cur,SVBC);
+             #endif
++            {
+             int a = (*(cur+1)).string.val-f-&gt;code.string.val;
+             RA = tp_def(tp,
+                 /*tp_string_n((*(cur+1)).string.val,(SVBC-1)*4),*/
+@@ -2432,6 +2442,7 @@
+                 f-&gt;globals);
+             cur += SVBC; continue;
+             }
++            }
+             break;
+ 
+         case TP_IRETURN: tp_return(tp,RA); SR(0); break;
+@@ -2445,11 +2456,13 @@
+             tp_bounds(tp,cur,VA);
+             #endif
+             ;
++            {
+             int a = (*(cur+1)).string.val-f-&gt;code.string.val;
+ /*            f-&gt;line = tp_string_n((*(cur+1)).string.val,VA*4-1);*/
+             f-&gt;line = tp_string_sub(tp,f-&gt;code,a,a+VA*4-1);
+ /*             fprintf(stderr,&quot;%7d: %s\n&quot;,UVBC,f-&gt;line.string.val);*/
+             cur += VA; f-&gt;lineno = UVBC;
++            }
+             break;
+         case TP_IFILE: f-&gt;fname = RA; break;
+         case TP_INAME: f-&gt;name = RA; break;
+@@ -2558,7 +2571,7 @@
+ 
+ void tp_builtins(TP) {
+     tp_obj o;
+-    struct {const char *s;void *f;} b[] = {
++    struct {const char *s;tp_obj (*f)(TP);} b[] = {
+     {&quot;print&quot;,tp_print}, {&quot;range&quot;,tp_range}, {&quot;min&quot;,tp_min},
+     {&quot;max&quot;,tp_max}, {&quot;bind&quot;,tp_bind}, {&quot;copy&quot;,tp_copy},
+     {&quot;import&quot;,tp_import_}, {&quot;len&quot;,tp_len_}, {&quot;assert&quot;,tp_assert},

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/print_stat.patch
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/print_stat.patch	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/print_stat.patch	2010-07-09 05:26:47 UTC (rev 6443)
@@ -0,0 +1,49 @@
+Index: encode.py
+===================================================================
+--- encode.py	(revision 148)
++++ encode.py	(working copy)
+@@ -348,6 +348,10 @@
+             mod]))
+         mod.type = 'name'
+         do_set_ctx(mod,Token(t.pos,'reg',v))
++def do_print(t):
++    r = do_call(Token(t.pos,'call',None,[
++        Token(t.pos,'name','print')] + t.items))
++    free_tmp(r)
+ def do_from(t):
+     mod = t.items[0]
+     mod.type = 'string'
+@@ -628,7 +632,7 @@
+     'module':do_module,'statements':do_statements,'def':do_def,
+     'return':do_return,'while':do_while,'if':do_if,
+     'break':do_break,'pass':do_pass,'continue':do_continue,'for':do_for,
+-    'class':do_class,'raise':do_raise,'try':do_try,'import':do_import,
++    'class':do_class,'raise':do_raise,'try':do_try,'import':do_import,'print':do_print,
+     'globals':do_globals,'del':do_del,'from':do_from,
+ }
+ rmap = {
+Index: parse.py
+===================================================================
+--- parse.py	(revision 148)
++++ parse.py	(working copy)
+@@ -374,6 +374,7 @@
+     'raise':{'lbp':0,'nud':prefix_nud0,'type':'raise','bp':20,},
+     'return':{'lbp':0,'nud':prefix_nud0,'type':'return','bp':10,},
+     'import':{'lbp':0,'nud':prefix_nuds,'type':'import','bp':20,},
++    'print':{'lbp':0,'nud':prefix_nuds,'type':'print','bp':20,},
+     'from':{'lbp':0,'nud':from_nud,'type':'from','bp':20,},
+     'del':{'lbp':0,'nud':prefix_nuds,'type':'del','bp':10,},
+     'global':{'lbp':0,'nud':prefix_nuds,'type':'globals','bp':20,},
+Index: tokenize.py
+===================================================================
+--- tokenize.py	(revision 148)
++++ tokenize.py	(working copy)
+@@ -14,7 +14,7 @@
+ 
+ ISYMBOLS = '`-=[];,./~!@$%^&amp;*()+{}:&lt;&gt;?|'
+ SYMBOLS = [
+-    'def','class','yield','return','pass','and','or','not','in','import',
++    'def','class','yield','return','pass','and','or','not','in','import','print',
+     'is','while','break','for','continue','if','else','elif','try',
+     'except','raise','True','False','None','global','del','from',
+     '-','+','*','**','/','%','&lt;&lt;','&gt;&gt;',

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/tinypy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/tinypy.cpp	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/tinypy.cpp	2010-07-09 05:26:47 UTC (rev 6443)
@@ -122,7 +122,6 @@
 // MEANX : Redirect printf
 bool pyPrintf(const char *fmt,...);
 #define printf pyPrintf
-// ************************
 
 /*  #define tp_malloc(x) calloc((x),1)
     #define tp_realloc(x,y) realloc(x,y)
@@ -466,8 +465,8 @@
 
 tp_inline static void tp_echo(TP,tp_obj e) {
     e = tp_str(tp,e);
-    //fwrite(e.string.val,1,e.string.len,stdout); // MEANX
-    printf(&quot;%s&quot;,e.string.val);
+    //fwrite(e.string.val,1,e.string.len,stdout);
+    printf(&quot;%s&quot;,e.string.val); // MEANX
 }
 
 /* Function: tp_string_n
@@ -985,14 +984,14 @@
  * This is how you can create a tinypy function object which, when called in
  * the script, calls the provided C function.
  */
-
-//tp_obj tp_fnc_new(TP,int t, void *v, tp_obj c,tp_obj s, tp_obj g) ;
 tp_obj tp_fnc(TP,tp_obj v(TP)) {
-    return tp_fnc_new(tp,0,(void *)v,tp_None,tp_None, tp_None);
+    // MEANX return tp_fnc_new(tp,0,v,tp_None,tp_None,tp_None);
+    return tp_fnc_new(tp,0,(void *)v,tp_None,tp_None,tp_None);
 }
 
 tp_obj tp_method(TP,tp_obj self,tp_obj v(TP)) {
-    return tp_fnc_new(tp,2,(void*)v,tp_None,self,tp_None);
+    // MEANX return tp_fnc_new(tp,2,v,tp_None,self,tp_None);
+    return tp_fnc_new(tp,2,(void *)v,tp_None,self,tp_None);
 }
 
 /* Function: tp_data
@@ -2205,7 +2204,9 @@
         exit(-1);
 #else
         tp-&gt;ex = e;
-        printf(&quot;\nException:\n&quot;); tp_echo(tp,e); printf(&quot;\n&quot;);
+        // MEANX
+         printf(&quot;\nException:\n&quot;); tp_echo(tp,e); printf(&quot;\n&quot;);
+        // /MEANX
         longjmp(tp-&gt;nextexpr,1);
 #endif
     }
@@ -2242,7 +2243,9 @@
     tp_print_stack(tp);
     exit(-1);
 #else
+        // MEANX
     tp_print_stack(tp);
+        // /MEANX
     longjmp(tp-&gt;nextexpr,1);
 #endif
 }
@@ -2456,13 +2459,13 @@
             tp_bounds(tp,cur,VA);
             #endif
             ;
-            {
+             {
             int a = (*(cur+1)).string.val-f-&gt;code.string.val;
 /*            f-&gt;line = tp_string_n((*(cur+1)).string.val,VA*4-1);*/
             f-&gt;line = tp_string_sub(tp,f-&gt;code,a,a+VA*4-1);
 /*             fprintf(stderr,&quot;%7d: %s\n&quot;,UVBC,f-&gt;line.string.val);*/
             cur += VA; f-&gt;lineno = UVBC;
-            }
+                }
             break;
         case TP_IFILE: f-&gt;fname = RA; break;
         case TP_INAME: f-&gt;name = RA; break;
@@ -2571,6 +2574,7 @@
 
 void tp_builtins(TP) {
     tp_obj o;
+    //MEANX struct {const char *s;void *f;} b[] = {
     struct {const char *s;tp_obj (*f)(TP);} b[] = {
     {&quot;print&quot;,tp_print}, {&quot;range&quot;,tp_range}, {&quot;min&quot;,tp_min},
     {&quot;max&quot;,tp_max}, {&quot;bind&quot;,tp_bind}, {&quot;copy&quot;,tp_copy},

Modified: branches/avidemux_2.6_branch_mean/cmake/admPyClass.pl
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admPyClass.pl	2010-07-06 20:55:50 UTC (rev 6442)
+++ branches/avidemux_2.6_branch_mean/cmake/admPyClass.pl	2010-07-09 05:26:47 UTC (rev 6443)
@@ -187,6 +187,10 @@
         {
                 return &quot;  return tp_number(r);&quot;;
         }
+        if($retType=~m/double/)
+        {
+                return &quot;  return tp_number(r);&quot;;
+        }
         if($retType=~m/float/)
         {
                 return &quot;  return tp_number(r);&quot;;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003630.html">[Avidemux-svn-commit] r6442 - in	branches/avidemux_2.5_branch_gruntster:	avidemux/ADM_coreImage/src cmake cmake/patches
</A></li>
	<LI>Next message: <A HREF="003632.html">[Avidemux-svn-commit] r6444 -	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_editor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3631">[ date ]</a>
              <a href="thread.html#3631">[ thread ]</a>
              <a href="subject.html#3631">[ subject ]</a>
              <a href="author.html#3631">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
