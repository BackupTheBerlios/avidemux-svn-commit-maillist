<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r6283 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_script2/py avidemux_core/ADM_coreTinyPy/include	avidemux_core/ADM_coreTinyPy/src cmake
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2010-June/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6283%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common/ADM_script2/py%20avidemux_core/ADM_coreTinyPy/include%0A%09avidemux_core/ADM_coreTinyPy/src%20cmake&In-Reply-To=%3C201006011815.o51IFIdn009863%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003476.html">
   <LINK REL="Next"  HREF="003478.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r6283 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_script2/py avidemux_core/ADM_coreTinyPy/include	avidemux_core/ADM_coreTinyPy/src cmake</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6283%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common/ADM_script2/py%20avidemux_core/ADM_coreTinyPy/include%0A%09avidemux_core/ADM_coreTinyPy/src%20cmake&In-Reply-To=%3C201006011815.o51IFIdn009863%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r6283 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_script2/py avidemux_core/ADM_coreTinyPy/include	avidemux_core/ADM_coreTinyPy/src cmake">mean at mail.berlios.de
       </A><BR>
    <I>Tue Jun  1 20:15:18 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="003476.html">[Avidemux-svn-commit] r6282 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_script2/py avidemux_core/ADM_coreTinyPy/include	avidemux_core/ADM_coreTinyPy/src cmake
</A></li>
        <LI>Next message: <A HREF="003478.html">[Avidemux-svn-commit] r6284 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_editor avidemux/common/ADM_script2/py cmake
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3477">[ date ]</a>
              <a href="thread.html#3477">[ thread ]</a>
              <a href="subject.html#3477">[ subject ]</a>
              <a href="author.html#3477">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2010-06-01 20:15:17 +0200 (Tue, 01 Jun 2010)
New Revision: 6283

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/ADM_pyAdm.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm.admPyClass
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/include/ADM_tinypy.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp
   branches/avidemux_2.6_branch_mean/cmake/admPyClass.pl
Log:
[py] Commit before class change

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/ADM_pyAdm.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/ADM_pyAdm.cpp	2010-06-01 18:15:15 UTC (rev 6282)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/ADM_pyAdm.cpp	2010-06-01 18:15:17 UTC (rev 6283)
@@ -26,8 +26,11 @@
 #include &quot;ADM_scriptEditor.h&quot;
 #include &quot;ADM_scriptUtils.h&quot;
 
+#undef free
+
 #include &quot;adm_gen.cpp&quot;
 #include &quot;editor_gen.cpp&quot;
+
 extern pyRegisterClass initClasspyAdm;
 extern pyRegisterClass initClasspyEditor;
 /**

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm.admPyClass
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm.admPyClass	2010-06-01 18:15:15 UTC (rev 6282)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm.admPyClass	2010-06-01 18:15:17 UTC (rev 6283)
@@ -1,5 +1,6 @@
+#           name    cookie id
+/* CLASS */ pyAdm : void : 100
 #              cname:pyname
-/* CLASS */ pyAdm : void
 /* STATICFUNC */ int scriptLoadVideo:loadVideo          (str ) 
 /* STATICFUNC */ int scriptClearSegments:clearSegments  (void) 
 /* STATICFUNC */ int scriptAppendVideo:appendVideo      (str ) 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp	2010-06-01 18:15:15 UTC (rev 6282)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_script2/py/adm_gen.cpp	2010-06-01 18:15:17 UTC (rev 6283)
@@ -2,6 +2,7 @@
 // audioCodec -&gt; int scriptSetAudioCodec (str int couples ) 
 static tp_obj zzpy_audioCodec(TP)
  {
+jsLog(&quot;audioCodec invoked\n&quot;);
   tinyParams pm(tp);
   const char *p0= pm.asString();
   int p1= pm.asDouble();
@@ -13,6 +14,7 @@
 // addVideoFilter -&gt; int scriptAddVideoFilter (str couples ) 
 static tp_obj zzpy_addVideoFilter(TP)
  {
+jsLog(&quot;addVideoFilter invoked\n&quot;);
   tinyParams pm(tp);
   const char *p0= pm.asString();
   CONFcouple *p1=NULL;
@@ -23,6 +25,7 @@
 // loadVideo -&gt; int scriptLoadVideo (str  ) 
 static tp_obj zzpy_loadVideo(TP)
  {
+jsLog(&quot;loadVideo invoked\n&quot;);
   tinyParams pm(tp);
   const char *p0= pm.asString();
   int r=  scriptLoadVideo(p0); 
@@ -31,18 +34,21 @@
 // clearSegments -&gt; int scriptClearSegments (void ) 
 static tp_obj zzpy_clearSegments(TP)
  {
+jsLog(&quot;clearSegments invoked\n&quot;);
   int r=  scriptClearSegments(); 
   return tp_number(r);
 }
 // getHeight -&gt; int scriptGetHeight (void ) 
 static tp_obj zzpy_getHeight(TP)
  {
+jsLog(&quot;getHeight invoked\n&quot;);
   int r=  scriptGetHeight(); 
   return tp_number(r);
 }
 // setPostProc -&gt; int scriptSetPostProc (int  int   int  ) 
 static tp_obj zzpy_setPostProc(TP)
  {
+jsLog(&quot;setPostProc invoked\n&quot;);
   tinyParams pm(tp);
   int p0= pm.asDouble();
   int p1= pm.asDouble();
@@ -53,6 +59,7 @@
 // appendVideo -&gt; int scriptAppendVideo (str  ) 
 static tp_obj zzpy_appendVideo(TP)
  {
+jsLog(&quot;appendVideo invoked\n&quot;);
   tinyParams pm(tp);
   const char *p0= pm.asString();
   int r=  scriptAppendVideo(p0); 
@@ -61,6 +68,7 @@
 // audioMixer -&gt; int scriptAudioMixer (str  ) 
 static tp_obj zzpy_audioMixer(TP)
  {
+jsLog(&quot;audioMixer invoked\n&quot;);
   tinyParams pm(tp);
   const char *p0= pm.asString();
   int r=  scriptAudioMixer(p0); 
@@ -69,12 +77,14 @@
 // getFps1000 -&gt; int scriptGetFps1000 (void ) 
 static tp_obj zzpy_getFps1000(TP)
  {
+jsLog(&quot;getFps1000 invoked\n&quot;);
   int r=  scriptGetFps1000(); 
   return tp_number(r);
 }
 // videoCodec -&gt; int scriptSetVideoCodec (str couples ) 
 static tp_obj zzpy_videoCodec(TP)
  {
+jsLog(&quot;videoCodec invoked\n&quot;);
   tinyParams pm(tp);
   const char *p0= pm.asString();
   CONFcouple *p1=NULL;
@@ -85,12 +95,14 @@
 // getWidth -&gt; int scriptGetWidth (void ) 
 static tp_obj zzpy_getWidth(TP)
  {
+jsLog(&quot;getWidth invoked\n&quot;);
   int r=  scriptGetWidth(); 
   return tp_number(r);
 }
 // addSegment -&gt; int scriptAddSegment (int  float   float  ) 
 static tp_obj zzpy_addSegment(TP)
  {
+jsLog(&quot;addSegment invoked\n&quot;);
   tinyParams pm(tp);
   int p0= pm.asDouble();
   float p1= pm.asFloat();
@@ -101,12 +113,14 @@
 // clearVideoFilters -&gt; int scriptClearVideoFilters (void ) 
 static tp_obj zzpy_clearVideoFilters(TP)
  {
+jsLog(&quot;clearVideoFilters invoked\n&quot;);
   int r=  scriptClearVideoFilters(); 
   return tp_number(r);
 }
 // setContainer -&gt; int scriptSetContainer (str couples ) 
 static tp_obj zzpy_setContainer(TP)
  {
+jsLog(&quot;setContainer invoked\n&quot;);
   tinyParams pm(tp);
   const char *p0= pm.asString();
   CONFcouple *p1=NULL;
@@ -117,19 +131,23 @@
 // audioReset -&gt; int scriptAudioReset (void ) 
 static tp_obj zzpy_audioReset(TP)
  {
+jsLog(&quot;audioReset invoked\n&quot;);
   int r=  scriptAudioReset(); 
   return tp_number(r);
 }
 // getVideoCodec -&gt; str scriptGetVideoCodec (void ) 
 static tp_obj zzpy_getVideoCodec(TP)
  {
+jsLog(&quot;getVideoCodec invoked\n&quot;);
   char *r=  scriptGetVideoCodec(); 
   return tp_string(r);
 }
 tp_obj zzpy__pyAdm_get(tp_vm *vm)
 {
+jsLog(&quot;zzpy__pyAdm_get invoked\n&quot;);
+  tp_obj self=tp_getraw( vm);
   tinyParams pm(vm);
-  void *me=pm.asThis(0);
+  void *me=pm.asThis(&amp;self,100);
   char const *key = pm.asString();
   if (!strcmp(key, &quot;audioResample&quot;))
   {
@@ -143,13 +161,14 @@
   {
      return tp_number(scriptGetMarkerB());
   }
-  pm.raise(&quot;No such attribute %s&quot;,key);
-  return tp_None;
+  return tp_get(vm,self,tp_string(key));
 }
 tp_obj zzpy__pyAdm_set(tp_vm *vm)
 {
+jsLog(&quot;zzpy__pyAdm_set invoked\n&quot;);
+  tp_obj self=tp_getraw( vm);
   tinyParams pm(vm);
-  void *me=pm.asThis(0);
+  void *me=pm.asThis(&amp;self,100);
   char const *key = pm.asString();
   if (!strcmp(key, &quot;audioResample&quot;))
   {
@@ -169,11 +188,21 @@
      scriptSetMarkerB(val);
      return tp_None;
   }
-  pm.raise(&quot;No such attribute %s&quot;,key);
   return tp_None;
 }
+static void myDtorpyAdm(tp_vm *vm,tp_obj self)
+{
+jsLog(&quot;myDtorpyAdm invoked\n&quot;);
+}
 static tp_obj myCtorpyAdm(tp_vm *vm)
 {
+jsLog(&quot;ctor of pyAdm invoked\n&quot;);
+  tp_obj self = tp_getraw(vm);
+  void *me=NULL;
+  tp_obj cdata = tp_data(vm, 100, me);
+  cdata.data.info-&gt;xfree = myDtorpyAdm;
+  tp_set(vm, self, tp_string(&quot;cdata&quot;), cdata);
+  return tp_None;
 }
 static tp_obj zzpy__pyAdm_help(TP)
  {

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/include/ADM_tinypy.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/include/ADM_tinypy.h	2010-06-01 18:15:15 UTC (rev 6282)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/include/ADM_tinypy.h	2010-06-01 18:15:17 UTC (rev 6283)
@@ -66,7 +66,7 @@
         float  asFloat(void);
         double asDouble(void);
 const   char  *asString(void);
-        void  *asThis(int id);
+        void  *asThis(tp_obj *self,int id);
         int    nbParam(void);
         void   raise(const char *fmt,...);
         const char *typeAsString(int type);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp	2010-06-01 18:15:15 UTC (rev 6282)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreTinyPy/src/ADM_tinypy.cpp	2010-06-01 18:15:17 UTC (rev 6283)
@@ -240,10 +240,9 @@
    \fn  asThis
 */
 
-void  *tinyParams::asThis(int id)
+void  *tinyParams::asThis(tp_obj *self,int id)
 {
-    tp_obj self = tp_getraw(tp);
-    tp_obj cdata = tp_get(tp, self, tp_string(&quot;cdata&quot;));
+    tp_obj cdata = tp_get(tp, *self, tp_string(&quot;cdata&quot;));
     if(cdata.data.magic!=id) 
     { 
         raise(&quot;Bad class : Expected %d, got %d\n&quot;,id,cdata.data.magic); \

Modified: branches/avidemux_2.6_branch_mean/cmake/admPyClass.pl
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/admPyClass.pl	2010-06-01 18:15:15 UTC (rev 6282)
+++ branches/avidemux_2.6_branch_mean/cmake/admPyClass.pl	2010-06-01 18:15:17 UTC (rev 6283)
@@ -22,6 +22,7 @@
 my $functionPrefix=&quot;&quot;;
 my $className;
 my $cookieName;
+my $cookieId;
 my $staticClass=0;
 #
 my %cFuncs;
@@ -33,6 +34,13 @@
 my %setVar;
 my %typeVars;
 
+sub debug
+{
+        my $str=shift;
+        chomp($str);
+        print OUTPUT &quot;jsLog(\&quot;$str\\n\&quot;);\n&quot;;
+
+}
 #
 # processClass
 #
@@ -43,8 +51,8 @@
         $proto=~s%.*\*/%%g;
         $proto=~s/ //g;
         #print &quot;**$proto**\n&quot;;
-        ($className,$cookieName)=split &quot;:&quot;,$proto; 
-        print &quot;Processing class $className (with cookie=$cookieName)\n&quot;; 
+        ($className,$cookieName,$cookieId)=split &quot;:&quot;,$proto; 
+        print &quot;Processing class $className (with cookie=$cookieName,id=$cookieId)\n&quot;; 
         if($cookieName=~m/void/)
         {
                 $staticClass=1;
@@ -253,7 +261,7 @@
                 # start our function
                 print OUTPUT &quot;static tp_obj &quot;.$glueprefix.$f.&quot;(TP)\n {\n&quot;;
 
-
+                debug(&quot;$f invoked\n&quot;);
                 if($params[0]=~m/^void$/)
                 {
                         $nb=0;
@@ -302,8 +310,10 @@
 # Get
         print OUTPUT &quot;tp_obj &quot;.$getName.&quot;(tp_vm *vm)\n&quot;;
         print OUTPUT &quot;{\n&quot;;
+        debug(&quot;$getName invoked\n&quot;);
+        print OUTPUT &quot;  tp_obj self=tp_getraw( vm);\n&quot;;
         print OUTPUT &quot;  tinyParams pm(vm);\n&quot;;
-        print OUTPUT &quot;  void *me=pm.asThis(0);\n&quot;;
+        print OUTPUT &quot;  void *me=pm.asThis(&amp;self,$cookieId);\n&quot;;
         print OUTPUT &quot;  char const *key = pm.asString();\n&quot;;
         my @k=keys %typeVars;
         my $v;
@@ -314,15 +324,17 @@
           print OUTPUT &quot;     return tp_number(&quot;.$getVar{$v}.&quot;());\n&quot;;
           print OUTPUT &quot;  }\n&quot;;
         }
-        print OUTPUT &quot;  pm.raise(\&quot;No such attribute %s\&quot;,key);\n&quot;;
-        print OUTPUT &quot;  return tp_None;\n&quot;;
+        #print OUTPUT &quot;  pm.raise(\&quot;No such attribute %s\&quot;,key);\n&quot;;
+        print OUTPUT &quot;  return tp_get(vm,self,tp_string(key));\n&quot;;
         print OUTPUT &quot;}\n&quot;;
 
 # Set
         print OUTPUT &quot;tp_obj &quot;.$setName.&quot;(tp_vm *vm)\n&quot;;
         print OUTPUT &quot;{\n&quot;;
+        debug(&quot;$setName invoked\n&quot;);
+        print OUTPUT &quot;  tp_obj self=tp_getraw( vm);\n&quot;;
         print OUTPUT &quot;  tinyParams pm(vm);\n&quot;;
-        print OUTPUT &quot;  void *me=pm.asThis(0);\n&quot;;
+        print OUTPUT &quot;  void *me=pm.asThis(&amp;self,$cookieId);\n&quot;;
         print OUTPUT &quot;  char const *key = pm.asString();\n&quot;;
         my @k=keys %typeVars;
         my $v;
@@ -336,7 +348,7 @@
           print OUTPUT &quot;  }\n&quot;;
         }
     #if (!strcmp(key, &quot;prize&quot;)) return tp_number(fruit-&gt;prize);
-        print OUTPUT &quot;  pm.raise(\&quot;No such attribute %s\&quot;,key);\n&quot;;
+        #print OUTPUT &quot;  pm.raise(\&quot;No such attribute %s\&quot;,key);\n&quot;;
         print OUTPUT &quot;  return tp_None;\n&quot;;
         print OUTPUT &quot;}\n&quot;;
 
@@ -346,13 +358,38 @@
 #
 sub genTables
 {
+   my $dtor=  &quot;myDtor&quot;.$className;
+# Dtor
+        print OUTPUT &quot;static void &quot;.$dtor.&quot;(tp_vm *vm,tp_obj self)\n&quot;;
+        print OUTPUT &quot;{\n&quot;;
+        debug(&quot;$dtor invoked\n&quot;);
+        if($staticClass==1)
+        {
+        }else
+        {
+                #free(self.data.val);
+        }
+        print OUTPUT &quot;}\n&quot;;
+        # end
+#
+# Ctor
+#
         # ctor
         print OUTPUT &quot;static tp_obj myCtor&quot;.$className.&quot;(tp_vm *vm)\n&quot;;
         print OUTPUT &quot;{\n&quot;;
-        if($staticClass==0)
+        debug(&quot;ctor of $className invoked\n&quot;);
+        print OUTPUT &quot;  tp_obj self = tp_getraw(vm);\n&quot;;
+        if($staticClass==1)
         {
-                #todo allocate cookie
+                print OUTPUT &quot;  void *me=NULL;\n&quot;;
+        }else
+        {
+
         }
+        print OUTPUT &quot;  tp_obj cdata = tp_data(vm, $cookieId, me);\n&quot;;
+        print OUTPUT &quot;  cdata.data.info-&gt;xfree = $dtor;\n&quot;;
+        print OUTPUT &quot;  tp_set(vm, self, tp_string(\&quot;cdata\&quot;), cdata);\n&quot;;
+        print OUTPUT &quot;  return tp_None;\n&quot;;
         print OUTPUT &quot;}\n&quot;;
         # end
 #


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003476.html">[Avidemux-svn-commit] r6282 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_script2/py avidemux_core/ADM_coreTinyPy/include	avidemux_core/ADM_coreTinyPy/src cmake
</A></li>
	<LI>Next message: <A HREF="003478.html">[Avidemux-svn-commit] r6284 - in branches/avidemux_2.6_branch_mean:	avidemux/common/ADM_editor avidemux/common/ADM_script2/py cmake
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3477">[ date ]</a>
              <a href="thread.html#3477">[ thread ]</a>
              <a href="subject.html#3477">[ subject ]</a>
              <a href="author.html#3477">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
