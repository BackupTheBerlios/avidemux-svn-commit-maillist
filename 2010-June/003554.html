<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r6363 - in branches/avidemux_2.6_branch_mean:	avidemux/common avidemux/common/ADM_commonUI	avidemux/common/ADM_videoCodec/include	avidemux/common/ADM_videoCodec/src avidemux/qt4	avidemux_core/ADM_coreVideoCodec/include avidemux_plugins	avidemux_plugins/ADM_videoDecoder	avidemux_plugins/ADM_videoDecoder/vpx
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2010-June/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6363%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common%20avidemux/common/ADM_commonUI%0A%09avidemux/common/ADM_videoCodec/include%0A%09avidemux/common/ADM_videoCodec/src%20avidemux/qt4%0A%09avidemux_core/ADM_coreVideoCodec/include%20avidemux_plugins%0A%09avidemux_plugins/ADM_videoDecoder%0A%09avidemux_plugins/ADM_videoDecoder/vpx&In-Reply-To=%3C201006121544.o5CFi01i001513%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003553.html">
   <LINK REL="Next"  HREF="003555.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r6363 - in branches/avidemux_2.6_branch_mean:	avidemux/common avidemux/common/ADM_commonUI	avidemux/common/ADM_videoCodec/include	avidemux/common/ADM_videoCodec/src avidemux/qt4	avidemux_core/ADM_coreVideoCodec/include avidemux_plugins	avidemux_plugins/ADM_videoDecoder	avidemux_plugins/ADM_videoDecoder/vpx</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r6363%20-%20in%20branches/avidemux_2.6_branch_mean%3A%0A%09avidemux/common%20avidemux/common/ADM_commonUI%0A%09avidemux/common/ADM_videoCodec/include%0A%09avidemux/common/ADM_videoCodec/src%20avidemux/qt4%0A%09avidemux_core/ADM_coreVideoCodec/include%20avidemux_plugins%0A%09avidemux_plugins/ADM_videoDecoder%0A%09avidemux_plugins/ADM_videoDecoder/vpx&In-Reply-To=%3C201006121544.o5CFi01i001513%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r6363 - in branches/avidemux_2.6_branch_mean:	avidemux/common avidemux/common/ADM_commonUI	avidemux/common/ADM_videoCodec/include	avidemux/common/ADM_videoCodec/src avidemux/qt4	avidemux_core/ADM_coreVideoCodec/include avidemux_plugins	avidemux_plugins/ADM_videoDecoder	avidemux_plugins/ADM_videoDecoder/vpx">mean at mail.berlios.de
       </A><BR>
    <I>Sat Jun 12 17:44:00 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="003553.html">[Avidemux-svn-commit] r6362 -	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/xml
</A></li>
        <LI>Next message: <A HREF="003555.html">[Avidemux-svn-commit] r6364 -	branches/avidemux_2.6_branch_mean/cmake
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3554">[ date ]</a>
              <a href="thread.html#3554">[ thread ]</a>
              <a href="subject.html#3554">[ subject ]</a>
              <a href="author.html#3554">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2010-06-12 17:43:59 +0200 (Sat, 12 Jun 2010)
New Revision: 6363

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_dynVideoDecoder.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_coreVideoDecoderInternal.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/ADM_vpx.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/ADM_vpx.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/vpxPlugin.cpp
Removed:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/include/ADM_vpx.h
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_vpx.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_plugins.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_videoCodec.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_plugins/CMakeLists.txt
Log:
[videoDecoder] Add possibility to use plugin for video decoder

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_plugins.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_plugins.cpp	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/DIA_plugins.cpp	2010-06-12 15:43:59 UTC (rev 6363)
@@ -32,6 +32,8 @@
 bool     ADM_mx_getMuxerInfo(int filter, const char **name, uint32_t *major,uint32_t *minor,uint32_t *patch);
 bool     ADM_ve6_getEncoderInfo(int filter, const char **name, uint32_t *major,uint32_t *minor,uint32_t *patch);
 uint32_t ADM_ve6_getNbEncoders(void);
+uint32_t ADM_vd6_getNbEncoders(void);
+bool     ADM_vd6_getEncoderInfo(int filter, const char **name, uint32_t *major,uint32_t *minor,uint32_t *patch);
 #define QT_TR_NOOP(x) x
 
 /* /Functions */
@@ -48,6 +50,7 @@
     uint32_t dmNbPlugin=ADM_dm_getNbDemuxers();
     uint32_t mxNbPlugin=ADM_mx_getNbMuxers();
     uint32_t ve6NbPlugin=ADM_ve6_getNbEncoders();
+    uint32_t vd6NbPlugin=ADM_vd6_getNbEncoders();
 
     // Audio Plugins
 
@@ -107,7 +110,36 @@
 
     diaElem *diaVE[]={&amp;frameVE};
     diaElemTabs tabVE(QT_TR_NOOP(&quot;Video Encoder&quot;),1,diaVE);
+    // /Encoder
+// VideoDecoder
+    printf(&quot;[VideoDecoder6 Plugins] Found %u plugins\n&quot;,vd6NbPlugin);
+    diaElemReadOnlyText **vdText=new diaElemReadOnlyText *[vd6NbPlugin];
+    diaElemFrame frameVD(QT_TR_NOOP(&quot;Video Decoder Plugins&quot;));
+        
+       
+    for(int i=0;i&lt;vd6NbPlugin;i++)
+    {
+        const char *name;
+        uint32_t major,minor,patch;
+        char versionString[256];
+        char infoString[256];
+        char *end;
+            ADM_vd6_getEncoderInfo(i, &amp;name,&amp;major,&amp;minor,&amp;patch);
+            snprintf(versionString,255,&quot;%02d.%02d.%02d&quot;,major,minor,patch);
+            strncpy(infoString,name,255);
+            if(strlen(infoString))
+            {
+                end=strlen(infoString)+infoString-1;
+                // Remove trailing line feed
+                while(*end==0x0a || *end==0x0d) *end--=0;
+            }
+            vdText[i]=new diaElemReadOnlyText(infoString,versionString);
+            frameVD.swallow(vdText[i]);
+    }
 
+    diaElem *diaVD[]={&amp;frameVD};
+    diaElemTabs tabVD(QT_TR_NOOP(&quot;Video Decoder&quot;),1,diaVD);
+    // /VideoDecoder
     // Audio Device
     printf(&quot;[AudioDevice Plugins] Found %u plugins\n&quot;,avNbPlugin);
     diaElemReadOnlyText **avText=new diaElemReadOnlyText *[avNbPlugin];
@@ -225,13 +257,15 @@
 
     // /muxer Encoder
 
-    diaElemTabs *tabs[]={&amp;tabAudio,&amp;tabVE,&amp;tabAV,&amp;tabAE,&amp;tabDM,&amp;tabMX};
-    diaFactoryRunTabs(QT_TR_NOOP(&quot;Plugins Info&quot;),6,tabs);
+    diaElemTabs *tabs[]={&amp;tabAudio,&amp;tabVE,&amp;tabVD,&amp;tabAV,&amp;tabAE,&amp;tabDM,&amp;tabMX};
+    diaFactoryRunTabs(QT_TR_NOOP(&quot;Plugins Info&quot;),7,tabs);
 
     for(int i=0;i&lt;aNbPlugin;i++)
         delete aText[i];
     for(int i=0;i&lt;ve6NbPlugin;i++)
         delete veText[i];
+    for(int i=0;i&lt;vd6NbPlugin;i++)
+        delete vdText[i];
     for(int i=0;i&lt;avNbPlugin;i++)
         delete avText[i];
     for(int i=0;i&lt;aeNbPlugin;i++)

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/include/ADM_vpx.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/include/ADM_vpx.h	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/include/ADM_vpx.h	2010-06-12 15:43:59 UTC (rev 6363)
@@ -1,50 +0,0 @@
-/***************************************************************************
-            \file  ADM_vpx.h
-            \brief I/f to libvpx (decoder)
-
-    The ffmpeg part is to preformat inputs for VDPAU
-    VDPAU is loaded dynamically to be able to make a binary
-        and have something working even if the target machine
-        does not have vdpau
-    Some part, especially get/buffer and ip_age borrowed from xbmc
-        as the api from ffmpeg is far from clear....
-
-
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef ADM_VPX_H
-#define ADM_VPX_H
-#include &quot;ADM_codec.h&quot;
-/**
-    \class decoderVpx
-*/
-class decoderVPX:public decoders
-{
-protected:
-                    bool alive;
-                    void     *vpx;
-public:
-            // public API
-                    decoderVPX (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp);
-                    ~decoderVPX();
-    virtual bool    uncompress (ADMCompressedImage * in, ADMImage * out);
-    virtual bool bFramePossible (void)
-      {
-        return 0;
-      }
-    virtual const char *getDecoderName(void) {return &quot;LibVPX&quot;;}
-    virtual bool  initializedOk(void)        {return alive;};
-    virtual bool dontcopy (void)             {return true;}
-};
-
-#endif
-//EOF
-

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_dynVideoDecoder.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_dynVideoDecoder.cpp	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_dynVideoDecoder.cpp	2010-06-12 15:43:59 UTC (rev 6363)
@@ -0,0 +1,192 @@
+/***************************************************************************
+    \file       ADM_dynVideoDecoder.cpp
+    \brief      Handle video decoder plugins
+    \author     mean/gruntster <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A> (C) 2010
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;ADM_default.h&quot;
+#include &lt;vector&gt;
+
+#include &quot;DIA_fileSel.h&quot;
+#include &quot;ADM_coreVideoDecoderInternal.h&quot;
+#include &quot;ADM_dynamicLoading.h&quot;
+
+/**
+    \class ADM_videoEncoder6
+    \brief Plugin Wrapper Class
+
+*/
+class ADM_videoDecoder6 :public ADM_LibWrapper
+{
+public:
+        int                  initialised;
+        ADM_videoDecoderDesc *desc;
+        ADM_videoDecoderDesc  *(*getInfo)();
+        ADM_videoDecoder6(const char *file) : ADM_LibWrapper()
+        {
+                initialised = (loadLibrary(file) &amp;&amp; getSymbols(1,
+				&amp;getInfo, &quot;getInfo&quot;));
+                if(initialised)
+                {
+                    desc=getInfo();
+                    printf(&quot;[videoDecoder6]Name :%s ApiVersion :%d Description :%s\n&quot;,
+                                                        desc-&gt;decoderName,
+                                                        desc-&gt;apiVersion,
+                                                        desc-&gt;description);
+                }else
+                {
+                    printf(&quot;[videoDecoder6]Symbol loading failed for %s\n&quot;,file);
+                }
+        }
+};
+
+std::vector &lt;ADM_videoDecoder6 *&gt; ListOfDecoders;
+// 
+
+/**
+        \fn ADM_vd6_getNbEncoders
+        \brief Returns the number of demuxers plugins except one
+*/
+uint32_t ADM_vd6_getNbEncoders(void)
+{
+    return ListOfDecoders.size();
+}
+/**
+    \fn     ADM_ve6_getEncoderInfo
+    \brief  Get Infos about the demuxer #th plugin
+*/
+bool     ADM_vd6_getEncoderInfo(int filter, const char **name, uint32_t *major,uint32_t *minor,uint32_t *patch)
+{
+    ADM_assert(filter&lt;ListOfDecoders.size());
+    ADM_videoDecoderDesc *desc=ListOfDecoders[filter]-&gt;desc;
+    ADM_assert(desc);
+    *name=desc-&gt;menuName;
+    *major=desc-&gt;major;
+    *minor=desc-&gt;minor;
+    *patch=desc-&gt;patch;
+    return true;
+}
+/**
+    \fn tryLoadingFilterPlugin
+    \brief Try loading the file given as argument as an audio device plugin
+
+*/
+#define Fail(x) {printf(&quot;%s:&quot;#x&quot;\n&quot;,file);goto er;}
+static bool tryLoadingEncoderPlugin(const char *file)
+{
+	ADM_videoDecoder6 *dll=new ADM_videoDecoder6(file);
+    if(!dll-&gt;initialised) Fail(CannotLoad);
+    if(dll-&gt;desc-&gt;apiVersion!=ADM_VIDEO_DECODER_API_VERSION) Fail(WrongApiVersion);
+//fixme todo also check uiType    
+    ListOfDecoders.push_back(dll); // Needed for cleanup. FIXME TODO Delete it.
+    printf(&quot;[VideoDecoder6] Registered filter %s as  %s\n&quot;,file,dll-&gt;desc-&gt;description);
+    return true;
+	// Fail!
+er:
+	delete dll;
+	return false;
+
+}
+/**
+ * 	\fn ADM_vd6_loadPlugins
+ *  \brief load all video decoder plugins
+ */
+uint8_t ADM_vd6_loadPlugins(const char *path)
+{
+#define MAX_EXTERNAL_FILTER 100
+// FIXME Factorize
+
+	char *files[MAX_EXTERNAL_FILTER];
+	uint32_t nbFile;
+
+	memset(files,0,sizeof(char *)*MAX_EXTERNAL_FILTER);
+	printf(&quot;[ADM_vd6_plugin] Scanning directory %s\n&quot;,path);
+
+	if(!buildDirectoryContent(&amp;nbFile, path, files, MAX_EXTERNAL_FILTER, SHARED_LIB_EXT))
+	{
+		printf(&quot;[ADM_vd6_plugin] Cannot parse plugin\n&quot;);
+		return 0;
+	}
+
+	for(int i=0;i&lt;nbFile;i++)
+		tryLoadingEncoderPlugin(files[i]);
+    
+	printf(&quot;[ADM_vd6_plugin] Scanning done\n&quot;);
+
+	return 1;
+}
+/**
+        \fn ADM_ve6_cleanup
+        \brief Current device is no longer used, delete
+*/
+void ADM_vd6_cleanup(void)
+{
+        int nb=ListOfDecoders.size();
+        for(int i=0;i&lt;nb;i++)
+                {
+                        if(ListOfDecoders[i]) delete ListOfDecoders[i];
+                        ListOfDecoders[i]=NULL;
+                }
+}
+
+/**
+    \fn ADM_vd6_getMenuName
+    \brief 
+*/
+const char *ADM_vd6_getMenuName(uint32_t i)
+{
+	 int nb=ListOfDecoders.size();
+
+	ADM_assert(i &lt; nb);
+
+	return ListOfDecoders[i]-&gt;desc-&gt;menuName;
+}
+/**
+    \fn createVideoEncoder
+*/
+static decoders *createVideoDecoderFromIndex(int index,uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen,
+                    uint8_t *extra, uint32_t bpp)
+{
+    int nb=ListOfDecoders.size();
+	ADM_assert(index &lt; nb);
+    ADM_videoDecoder6 *plugin=ListOfDecoders[index];
+
+    decoders *dec=plugin-&gt;desc-&gt;create(w,h,fcc,extraDataLen,extra,bpp);
+    return dec;
+}
+/**
+    \fn createVideoEncoderFromIndex
+    \brief Spawn a decoder. If not possible returns NULL.
+*/
+decoders *tryCreatingVideoDecoder(uint32_t w, uint32_t h, uint32_t fcc,uint32_t extraDataLen,
+                    uint8_t *extra, uint32_t bpp)
+{
+
+     int nb=ListOfDecoders.size();
+     for(int i=0;i&lt;nb;i++)
+     {
+            ADM_videoDecoder6 *plugin=ListOfDecoders[i];
+            uint32_t *f=plugin-&gt;desc-&gt;fccs;
+            if(!f) continue;
+            while(*f)
+            {
+                if(fcc==*f)
+                {
+                    decoders *dec=createVideoDecoderFromIndex(i,w,h,fcc,extraDataLen,extra,bpp);
+                    if(dec) return dec;
+                }
+                f++;
+            }
+     }
+     ADM_info(&quot;No decoder found in plugin\n&quot;);
+     return false;
+}
+//EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_videoCodec.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_videoCodec.cpp	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_videoCodec.cpp	2010-06-12 15:43:59 UTC (rev 6363)
@@ -21,7 +21,6 @@
 #include &quot;ADM_lavcodec.h&quot;
 };
 #include &quot;ADM_default.h&quot;
-#include &quot;config.h&quot;
 #include &quot;ADM_codec.h&quot;
 #include &quot;ADM_ffmp43.h&quot;
 #include &quot;avidemutils.h&quot;
@@ -35,13 +34,18 @@
 
 
 extern bool vdpauUsable(void);
-
+decoders *tryCreatingVideoDecoder(uint32_t w, uint32_t h, uint32_t fcc,uint32_t extraDataLen,
+                    uint8_t *extra, uint32_t bpp);
 /**
     \fn getDecoder
     \brief returns the correct decoder for a stream w,h,fcc,extraLen,extraData,bpp
 */
-decoders *ADM_getDecoder (uint32_t fcc, uint32_t w, uint32_t h, uint32_t extraLen, uint8_t * extraData,uint32_t bpp)
+decoders *ADM_getDecoder (uint32_t fcc, uint32_t w, uint32_t h, uint32_t extraLen, 
+            uint8_t * extraData,uint32_t bpp)
 {
+  decoders *fromPlugin=tryCreatingVideoDecoder(w,h,fcc,extraLen,extraData,bpp);
+  if(fromPlugin) return fromPlugin;
+
   ADM_info(&quot;Searching decoder in coreVideoCodec(%d x %d, extradataSize:%d)...\n&quot;,w,h,extraLen);
   if (isH264Compatible (fcc) || isMpeg12Compatible(fcc))
     {

Deleted: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_vpx.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_vpx.cpp	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_vpx.cpp	2010-06-12 15:43:59 UTC (rev 6363)
@@ -1,115 +0,0 @@
-/***************************************************************************
-            \file              ADM_ffmpeg_vdpau.cpp  
-            \brief Decoder using half ffmpeg/half VDPAU
-
-    The ffmpeg part is to preformat inputs for VDPAU
-    VDPAU is loaded dynamically to be able to make a binary
-        and have something working even if the target machine
-        does not have vdpau
-    Some part, especially get/buffer and ip_age borrowed from xbmc
-        as the api from ffmpeg is far from clear....
-
-
- ***************************************************************************/
-
-/***************************************************************************
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include &quot;ADM_default.h&quot;
-#include &quot;config.h&quot;
-#ifdef USE_VPX
-#include &quot;ADM_vpx.h&quot;
-#include &quot;vpx/vpx_decoder.h&quot;
-#include &quot;vpx/vp8dx.h&quot;
-#define VPX ((vpx_codec_ctx_t *)vpx)
-/**
-    \fn ctor
-*/
-decoderVPX::decoderVPX (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp)
-        : decoders(  w,   h,  fcc,   extraDataLen,  extraData,  bpp)
-{   
-    alive=false;
-    vpx=NULL;
-    vpx_codec_dec_cfg_t cfg;
-    vpx_codec_flags_t flags=0; //VPX_CODEC_USE_POSTPROC
-    vpx_codec_ctx_t *instance=new vpx_codec_ctx_t;
-    const struct vpx_codec_iface *iface = &amp;vpx_codec_vp8_dx_algo;
-    
-    memset(instance,0,sizeof(*instance));
-    memset(&amp;cfg,0,sizeof(cfg));
-    cfg.threads=1;
-    cfg.w=w;
-    cfg.h=h;
-    if(VPX_CODEC_OK!=vpx_codec_dec_init(instance, iface, &amp;cfg, flags))
-    {
-        delete instance;
-        ADM_warning(&quot;Vpx init ko\n&quot;);
-    }else
-    {
-        alive=true;
-        vpx=(void *)instance;
-        ADM_info(&quot;Vpx init ok\n&quot;);
-
-    }
-}
-/**
-    \fn dtor
-*/
-decoderVPX::~decoderVPX ()
-{
-    if(vpx)
-    {
-        vpx_codec_ctx_t *a=VPX;
-        delete a;
-        vpx=NULL;
-    }
-    ADM_info(&quot;Destroying VPX decoder\n&quot;);
-}
-/**
-    \fn uncompress
-*/
-bool    decoderVPX::uncompress (ADMCompressedImage * in, ADMImage * out)
-{
-    if (vpx_codec_decode(VPX, in-&gt;data, in-&gt;dataLength, NULL, 0) != VPX_CODEC_OK) 
-    {
-        ADM_warning(&quot;Error decoding VPX\n&quot;);
-        return false;
-    }
-    struct vpx_image *img;
-    const void *iter = NULL;
-    img = vpx_codec_get_frame(VPX, &amp;iter);
-    if(img)
-    {
-            if (img-&gt;fmt != VPX_IMG_FMT_I420) 
-            {
-                ADM_warning(&quot;Wrong Colorspace\n&quot;);
-                return false;
-            }
-            ADMImageRef    *r=out-&gt;castToRef();
-            if(r)
-            {
-                    r-&gt;_planes[0]=img-&gt;planes[0];
-                    r-&gt;_planes[1]=img-&gt;planes[1];
-                    r-&gt;_planes[2]=img-&gt;planes[2];
-                    r-&gt;_planeStride[0]=img-&gt;stride[0];
-                    r-&gt;_planeStride[1]=img-&gt;stride[1];
-                    r-&gt;_planeStride[2]=img-&gt;stride[2];
-                    r-&gt;_colorspace=ADM_COLOR_YV12;
-                    r-&gt;Pts=in-&gt;demuxerPts;
-                    r-&gt;flags=in-&gt;flags;
-                    return true;
-            }
-                
-            ADM_warning(&quot;Only ref for VPX decoder\n&quot;);
-
-    }
-    return false;
-}
-#endif
-// EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/CMakeLists.txt	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/CMakeLists.txt	2010-06-12 15:43:59 UTC (rev 6363)
@@ -1,7 +1,7 @@
 SET(ADM_videoCodec_SRCS
         ADM_ffmpeg_vdpau.cpp
         ADM_videoCodec.cpp
-        ADM_vpx.cpp
+        ADM_dynVideoDecoder.cpp
 )
 
 ADD_LIBRARY(ADM_videocodec6 STATIC ${ADM_videoCodec_SRCS})

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-06-12 15:43:59 UTC (rev 6363)
@@ -68,6 +68,7 @@
 extern void getUIDescription(char*);
 extern uint8_t ADM_ad_loadPlugins(const char *path);
 extern uint8_t ADM_vf_loadPlugins(const char *path);
+extern uint8_t ADM_vd6_loadPlugins(const char *path);
 extern uint8_t ADM_av_loadPlugins(const char *path);
 extern uint8_t ADM_ae_loadPlugins(const char *path);
 extern uint8_t ADM_dm_loadPlugins(const char *path);
@@ -229,6 +230,7 @@
     char *dmPlugins = ADM_getInstallRelativePath(startDir,&quot;ADM_plugins6&quot;,&quot;demuxers&quot;);    
     char *mxPlugins = ADM_getInstallRelativePath(startDir,&quot;ADM_plugins6&quot;,&quot;muxers&quot;);    
     char *vePlugins = ADM_getInstallRelativePath(startDir,&quot;ADM_plugins6&quot;,&quot;videoEncoders&quot;);    
+    char *vdPlugins = ADM_getInstallRelativePath(startDir,&quot;ADM_plugins6&quot;,&quot;videoDecoders&quot;);    
     char *vfPlugins = ADM_getInstallRelativePath(startDir,&quot;ADM_plugins6&quot;,&quot;videoFilters&quot;);
 
     ADM_mx_loadPlugins(mxPlugins);
@@ -252,6 +254,10 @@
     ADM_vf_loadPlugins(vfPlugins);
     delete [] vfPlugins;
 
+    ADM_vd6_loadPlugins(vdPlugins);
+    delete [] vdPlugins;
+
+
     // load local audio decoder plugins
 	adPlugins=ADM_getHomeRelativePath(&quot;plugins6&quot;,&quot;audioDecoder&quot;);
 	ADM_ad_loadPlugins(adPlugins);

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/CMakeLists.txt	2010-06-12 15:43:59 UTC (rev 6363)
@@ -17,12 +17,9 @@
 IF (NOT QT4_FOUND)
         MESSAGE(FATAL_ERROR &quot;Qt4 NOT FOUND&quot;)
 ENDIF (NOT QT4_FOUND)
-include(admCheckVpx)
 ##########################################
 # Config
 ##########################################
-# LibVPX
-checkVpxDec()
 
 SET(CONFIG_HEADER_TYPE ADM_BUILD_QT4)
 SET(UI_SUFFIX qt4)
@@ -123,10 +120,6 @@
         TARGET_LINK_LIBRARIES(avidemux3_qt4 ${SDL_LIBRARY})
 ENDIF (USE_SDL)
 
-# LibVPX
-IF (USE_VPX)
-        TARGET_LINK_LIBRARIES(avidemux3_qt4 ${VPX_LIBRARY_DIR})
-ENDIF (USE_VPX)
 
 
 ###########################################

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_coreVideoDecoderInternal.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_coreVideoDecoderInternal.h	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreVideoCodec/include/ADM_coreVideoDecoderInternal.h	2010-06-12 15:43:59 UTC (rev 6363)
@@ -0,0 +1,81 @@
+/**
+    \file  ADM_coreVideoDecoderInternal.h
+    \brief interface to video decoder plugins
+
+*/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef VIDEODECODERINTERNAL_H
+#define VIDEODECODERINTERNAL_H
+
+#define ADM_VIDEO_DECODER_API_VERSION 1
+#include &quot;ADM_codec.h&quot;
+
+/*!
+  This structure defines a video DECODER
+  \param DECODER DECODER attached to this descriptor
+  \param name The name of the codec
+  \param configure Function to call to configure the codec
+  \param param : An opaque structure that contains the codec specific configuration datas
+*/
+typedef struct
+{
+    const char   *decoderName;      // Internal name (tag)
+    const char   *menuName;         // Displayed name (in menu)
+    const char   *description;      // Short description
+
+    uint32_t     apiVersion;            // const
+    decoders     *(*create)(uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp);
+    void         (*destroy)(decoders *codec);
+    bool         (*configure)(void);                                // Call UI to set it up
+    uint32_t     major,minor,patch;     // Version of the plugin
+    uint32_t     *fccs;                 // List of supported fourCCs ending by 0
+    void         *opaque;               // Hide stuff in here
+}ADM_videoDecoderDesc;
+
+// Macros to declare video decoder
+/**************************************************************************/
+#define ADM_DECLARE_VIDEO_DECODER_PREAMBLE(Class) \
+static decoders * create (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp)\
+{ \
+  Class *r= new Class (w,h,fcc,extraDataLen,extraData,bpp); \
+  if(!r-&gt;initializedOk()) {delete r;return NULL;} \
+  return r;}\
+\
+static void destroy (decoders * in) \
+{\
+  Class *z = (Class *) in; \
+  delete z; \
+} 
+//******************************************************
+
+#define ADM_DECLARE_VIDEO_DECODER_MAIN(name,menuName,desc,fcc,configure,maj,minV,patch) \
+static ADM_videoDecoderDesc DECODERDesc={\
+    name,\
+    menuName,\
+    desc,\
+    ADM_VIDEO_DECODER_API_VERSION,\
+    &amp;create,\
+    &amp;destroy,\
+    configure,\
+    maj,minV,patch,\
+    fcc,\
+    NULL\
+};\
+extern &quot;C&quot; ADM_videoDecoderDesc *getInfo (void) \
+{ \
+  return &DECODERDesc; \
+}  
+
+#ifndef QT_TR_NOOP
+#define QT_TR_NOOP(x) x
+#endif
+#endif
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/CMakeLists.txt	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/CMakeLists.txt	2010-06-12 15:43:59 UTC (rev 6363)
@@ -0,0 +1 @@
+ADD_SUBDIRECTORY(vpx)

Copied: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/ADM_vpx.cpp (from rev 6361, branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_vpx.cpp)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/src/ADM_vpx.cpp	2010-06-11 18:08:27 UTC (rev 6361)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/ADM_vpx.cpp	2010-06-12 15:43:59 UTC (rev 6363)
@@ -0,0 +1,112 @@
+/***************************************************************************
+            \file              ADM_ffmpeg_vdpau.cpp  
+            \brief Decoder using half ffmpeg/half VDPAU
+
+    The ffmpeg part is to preformat inputs for VDPAU
+    VDPAU is loaded dynamically to be able to make a binary
+        and have something working even if the target machine
+        does not have vdpau
+    Some part, especially get/buffer and ip_age borrowed from xbmc
+        as the api from ffmpeg is far from clear....
+
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include &quot;ADM_default.h&quot;
+#include &quot;ADM_vpx.h&quot;
+#include &quot;vpx/vpx_decoder.h&quot;
+#include &quot;vpx/vp8dx.h&quot;
+#define VPX ((vpx_codec_ctx_t *)vpx)
+/**
+    \fn ctor
+*/
+decoderVPX::decoderVPX (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp)
+        : decoders(  w,   h,  fcc,   extraDataLen,  extraData,  bpp)
+{   
+    alive=false;
+    vpx=NULL;
+    vpx_codec_dec_cfg_t cfg;
+    vpx_codec_flags_t flags=0; //VPX_CODEC_USE_POSTPROC
+    vpx_codec_ctx_t *instance=new vpx_codec_ctx_t;
+    const struct vpx_codec_iface *iface = &amp;vpx_codec_vp8_dx_algo;
+    
+    memset(instance,0,sizeof(*instance));
+    memset(&amp;cfg,0,sizeof(cfg));
+    cfg.threads=1;
+    cfg.w=w;
+    cfg.h=h;
+    if(VPX_CODEC_OK!=vpx_codec_dec_init(instance, iface, &amp;cfg, flags))
+    {
+        delete instance;
+        ADM_warning(&quot;Vpx init ko\n&quot;);
+    }else
+    {
+        alive=true;
+        vpx=(void *)instance;
+        ADM_info(&quot;Vpx init ok\n&quot;);
+
+    }
+}
+/**
+    \fn dtor
+*/
+decoderVPX::~decoderVPX ()
+{
+    if(vpx)
+    {
+        vpx_codec_ctx_t *a=VPX;
+        delete a;
+        vpx=NULL;
+    }
+    ADM_info(&quot;Destroying VPX decoder\n&quot;);
+}
+/**
+    \fn uncompress
+*/
+bool    decoderVPX::uncompress (ADMCompressedImage * in, ADMImage * out)
+{
+    if (vpx_codec_decode(VPX, in-&gt;data, in-&gt;dataLength, NULL, 0) != VPX_CODEC_OK) 
+    {
+        ADM_warning(&quot;Error decoding VPX\n&quot;);
+        return false;
+    }
+    struct vpx_image *img;
+    const void *iter = NULL;
+    img = vpx_codec_get_frame(VPX, &amp;iter);
+    if(img)
+    {
+            if (img-&gt;fmt != VPX_IMG_FMT_I420) 
+            {
+                ADM_warning(&quot;Wrong Colorspace\n&quot;);
+                return false;
+            }
+            ADMImageRef    *r=out-&gt;castToRef();
+            if(r)
+            {
+                    r-&gt;_planes[0]=img-&gt;planes[0];
+                    r-&gt;_planes[1]=img-&gt;planes[1];
+                    r-&gt;_planes[2]=img-&gt;planes[2];
+                    r-&gt;_planeStride[0]=img-&gt;stride[0];
+                    r-&gt;_planeStride[1]=img-&gt;stride[1];
+                    r-&gt;_planeStride[2]=img-&gt;stride[2];
+                    r-&gt;_colorspace=ADM_COLOR_YV12;
+                    r-&gt;Pts=in-&gt;demuxerPts;
+                    r-&gt;flags=in-&gt;flags;
+                    return true;
+            }
+                
+            ADM_warning(&quot;Only ref for VPX decoder\n&quot;);
+
+    }
+    return false;
+}
+// EOF

Copied: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/ADM_vpx.h (from rev 6361, branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/include/ADM_vpx.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_videoCodec/include/ADM_vpx.h	2010-06-11 18:08:27 UTC (rev 6361)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/ADM_vpx.h	2010-06-12 15:43:59 UTC (rev 6363)
@@ -0,0 +1,50 @@
+/***************************************************************************
+            \file  ADM_vpx.h
+            \brief I/f to libvpx (decoder)
+
+    The ffmpeg part is to preformat inputs for VDPAU
+    VDPAU is loaded dynamically to be able to make a binary
+        and have something working even if the target machine
+        does not have vdpau
+    Some part, especially get/buffer and ip_age borrowed from xbmc
+        as the api from ffmpeg is far from clear....
+
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_VPX_H
+#define ADM_VPX_H
+#include &quot;ADM_codec.h&quot;
+/**
+    \class decoderVpx
+*/
+class decoderVPX:public decoders
+{
+protected:
+                    bool alive;
+                    void     *vpx;
+public:
+            // public API
+                    decoderVPX (uint32_t w, uint32_t h,uint32_t fcc, uint32_t extraDataLen, uint8_t *extraData,uint32_t bpp);
+                    ~decoderVPX();
+    virtual bool    uncompress (ADMCompressedImage * in, ADMImage * out);
+    virtual bool bFramePossible (void)
+      {
+        return 0;
+      }
+    virtual const char *getDecoderName(void) {return &quot;LibVPX&quot;;}
+    virtual bool  initializedOk(void)        {return alive;};
+    virtual bool dontcopy (void)             {return true;}
+};
+
+#endif
+//EOF
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/CMakeLists.txt	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/CMakeLists.txt	2010-06-12 15:43:59 UTC (rev 6363)
@@ -0,0 +1,19 @@
+INCLUDE(vd_plugin)
+include(admCheckVpx)
+# LibVPX
+checkVpxDec()
+IF (USE_VPX)
+
+SET(vpx_SRCS 
+        vpxPlugin.cpp
+        ADM_vpx.cpp
+)
+INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})
+INCLUDE_DIRECTORIES(${VPX_INCLUDE_DIR} ${VPX_INCLUDE_DIR}/vpx)
+
+ADD_LIBRARY(ADM_vd_vpx SHARED ${vpx_SRCS})
+TARGET_LINK_LIBRARIES(ADM_vd_vpx ${VPX_LIBRARY_DIR})
+INIT_VIDEO_DECODER(ADM_vd_vpx)
+INSTALL_VIDEO_DECODER(ADM_vd_vpx)
+
+ENDIF (USE_VPX)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/vpxPlugin.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/vpxPlugin.cpp	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_videoDecoder/vpx/vpxPlugin.cpp	2010-06-12 15:43:59 UTC (rev 6363)
@@ -0,0 +1,25 @@
+/***************************************************************************
+                          \fn     vpxPlugin
+                          \brief  Video decoder Plugin for libvpx
+                          \author mean <A HREF="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">fixounet at free.fr</A> (C) 2010
+ ***************************************************************************/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include &quot;ADM_default.h&quot;
+#include &quot;ADM_coreVideoDecoderInternal.h&quot;
+#include &quot;ADM_vpx.h&quot;
+static uint32_t fccs[]={MKFCC('V','P','8',' '),0};
+ADM_DECLARE_VIDEO_DECODER_PREAMBLE(decoderVPX);
+ADM_DECLARE_VIDEO_DECODER_MAIN(&quot;vpx&quot;,
+                               &quot;VP8/WebmM&quot;,
+                               &quot;Decoder using libvpx (c) mean 2010&quot;,
+                                fccs, // No configuration
+                                NULL,
+                                1,0,0
+);
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/CMakeLists.txt	2010-06-12 12:54:11 UTC (rev 6362)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/CMakeLists.txt	2010-06-12 15:43:59 UTC (rev 6363)
@@ -148,6 +148,7 @@
     ADD_SUBDIRECTORY(ADM_audioDecoders)
     ADD_SUBDIRECTORY(ADM_audioDevices)
     ADD_SUBDIRECTORY(ADM_videoEncoder)
+    ADD_SUBDIRECTORY(ADM_videoDecoder)
     ADD_SUBDIRECTORY(ADM_audioEncoders)
     ADD_SUBDIRECTORY(ADM_demuxers)
     ADD_SUBDIRECTORY(ADM_muxers)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003553.html">[Avidemux-svn-commit] r6362 -	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/xml
</A></li>
	<LI>Next message: <A HREF="003555.html">[Avidemux-svn-commit] r6364 -	branches/avidemux_2.6_branch_mean/cmake
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3554">[ date ]</a>
              <a href="thread.html#3554">[ thread ]</a>
              <a href="subject.html#3554">[ subject ]</a>
              <a href="author.html#3554">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
