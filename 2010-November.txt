From mean at mail.berlios.de  Mon Nov  1 08:49:37 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  1 Nov 2010 08:49:37 +0100
Subject: [Avidemux-svn-commit] r6722 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <20101101074938.3603C480A98@sheep.berlios.de>

Author: mean
Date: 2010-11-01 08:49:37 +0100 (Mon, 01 Nov 2010)
New Revision: 6722

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
Log:
[save] Return proper status when saving

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2010-10-28 06:01:40 UTC (rev 6721)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2010-11-01 07:49:37 UTC (rev 6722)
@@ -235,7 +235,7 @@
 */
 bool admSaver::save(void)
 {
-    int ret=1;
+    int ret=false;
     uint64_t startAudioTime=markerA; // Actual start time (for both audio & video actually)
     ADM_info("Audio starting time %s\n",ADM_us2plain(startAudioTime));
     ADM_info("[A_Save] Saving..\n");
@@ -357,7 +357,7 @@
         GUI_Error_HIG("Muxer","Cannot open ");
     }else
     {
-        muxer->save();
+        ret=muxer->save();
         muxer->close();
     }
     delete video;
@@ -367,6 +367,6 @@
         delete astreams[i];
         astreams[i]=NULL;
     }
-    return true;
+    return ret;
 }
 //EOF



From mean at mail.berlios.de  Mon Nov  1 08:49:39 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  1 Nov 2010 08:49:39 +0100
Subject: [Avidemux-svn-commit] r6723 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui
Message-ID: <20101101074939.56976480A98@sheep.berlios.de>

Author: mean
Date: 2010-11-01 08:49:39 +0100 (Mon, 01 Nov 2010)
New Revision: 6723

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
Log:
[recent/QT4] Do not call several recent files

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-11-01 07:49:37 UTC (rev 6722)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_userInterfaces/ADM_gui/Q_gui2.cpp	2010-11-01 07:49:39 UTC (rev 6723)
@@ -576,7 +576,7 @@
     {
         if(names[i])
         {
-            recentFileAction[i]=recentFiles->addAction(QString::fromUtf8(names[i]));
+            recentFileAction[i]=recentFiles->addAction(QString('0'+i)+QString(":")+QString::fromUtf8(names[i]));
         }else
             recentFileAction[i]=NULL;
     }
@@ -588,7 +588,16 @@
 void MainWindow::searchRecentFiles(QAction * action)
 {
     for(int i=0;i<4;i++)
-            if(recentFileAction[i]==action) HandleAction((Action)(ACT_RECENT0+i));
+    {
+            QAction *a= recentFileAction[i];
+            if(!a) continue;
+
+            if(a==action) 
+            {
+                HandleAction((Action)(ACT_RECENT0+i));
+                return;
+            }
+    }
 }
 void MainWindow::mousePressEvent(QMouseEvent* event)
 {



From mean at mail.berlios.de  Mon Nov  1 09:14:38 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  1 Nov 2010 09:14:38 +0100
Subject: [Avidemux-svn-commit] r6724 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv
Message-ID: <20101101081438.8186D480A98@sheep.berlios.de>

Author: mean
Date: 2010-11-01 09:14:38 +0100 (Mon, 01 Nov 2010)
New Revision: 6724

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp
Log:
[Flv/Demuxer] Dump extraData

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp	2010-11-01 07:49:39 UTC (rev 6723)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp	2010-11-01 08:14:38 UTC (rev 6724)
@@ -272,10 +272,11 @@
         }
         else    
         {
-            printf("[FLV] found some extradata %"LU"\n",r);
+            ADM_info("[FLV] found some extradata %"LU"\n",r);
             trk->extraData=new uint8_t[r];
             trk->extraDataLen=r;
             read(r,trk->extraData);
+            mixDump(trk->extraData,r);
             r=0;            
         }
         *remain=r;



From mean at mail.berlios.de  Mon Nov  1 09:14:39 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  1 Nov 2010 09:14:39 +0100
Subject: [Avidemux-svn-commit] r6725 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi
Message-ID: <20101101081439.6D6B8480A98@sheep.berlios.de>

Author: mean
Date: 2010-11-01 09:14:39 +0100 (Mon, 01 Nov 2010)
New Revision: 6725

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/op_aviwrite.cpp
Log:
[avi/muxer] If we already have a potentially valid extraData set use it rather than guessing a replacement one

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/op_aviwrite.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/op_aviwrite.cpp	2010-11-01 08:14:38 UTC (rev 6724)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_muxers/muxerAvi/op_aviwrite.cpp	2010-11-01 08:14:39 UTC (rev 6725)
@@ -319,12 +319,24 @@
             wav.blockalign=1024;
             wav.bitspersample = 0;
 
-            int SRI=4;	// Default 44.1 khz
-            for(int i=0;i<16;i++) if(wav.frequency==aacBitrate[i]) SRI=i;
+            uint32_t aLen;
+            uint8_t  *aData;
+            stream->getExtraData(&aLen,&aData);
+
             aacHeader[0]=0x2;
             aacHeader[1]=0x0;
-            aacHeader[2]=(2<<3)+(SRI>>1); // Profile LOW
-            aacHeader[3]=((SRI&1)<<7)+((wav.channels)<<3);
+            if(2==aLen)
+            {
+                aacHeader[2]=aData[0];
+                aacHeader[3]=aData[1];
+            }else
+            {
+                int SRI=4;	// Default 44.1 khz
+                for(int i=0;i<16;i++) if(wav.frequency==aacBitrate[i]) SRI=i;
+            
+                aacHeader[2]=(2<<3)+(SRI>>1); // Profile LOW
+                aacHeader[3]=((SRI&1)<<7)+((wav.channels)<<3);
+            }
 
 
             extra=&(aacHeader[0]);



From mean at mail.berlios.de  Sun Nov  7 10:09:39 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Nov 2010 10:09:39 +0100
Subject: [Avidemux-svn-commit] r6726 - in
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers:
	. Mxf
Message-ID: <20101107090939.7D4D0480F1B@sheep.berlios.de>

Author: mean
Date: 2010-11-07 10:09:39 +0100 (Sun, 07 Nov 2010)
New Revision: 6726

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/ADM_mxf.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/ADM_mxf.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/ADM_mxfPlugin.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/CMakeLists.txt
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/CMakeLists.txt
Log:
[MXF/Demuxer] Skeleton

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/CMakeLists.txt	2010-11-01 08:14:39 UTC (rev 6725)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/CMakeLists.txt	2010-11-07 09:09:39 UTC (rev 6726)
@@ -7,4 +7,5 @@
 ADD_SUBDIRECTORY(MpegTS)
 ADD_SUBDIRECTORY(Asf)
 ADD_SUBDIRECTORY(AvsProxy)
+ADD_SUBDIRECTORY(Mxf)
 #

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/ADM_mxf.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/ADM_mxf.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/ADM_mxf.cpp	2010-11-07 09:09:39 UTC (rev 6726)
@@ -0,0 +1,113 @@
+/***************************************************************************
+     \file                     ADM_mxf.cpp
+     \brief MXF demuxer
+     \author mean, fixounet at free.fr (C) 2010
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "ADM_default.h"
+
+#include <string.h>
+#include <math.h>
+
+#include "ADM_mxf.h"
+
+
+#define aprintf(...) {}
+/**
+    \fn ctor
+*/
+mxfHeader::mxfHeader(void)
+{
+	
+}
+/**
+    \fn getTime
+*/
+
+uint64_t                   mxfHeader::getTime(uint32_t frameNum)
+{
+    return 0;
+}
+/**
+    \fn getVideoDuration
+*/
+
+uint64_t                   mxfHeader::getVideoDuration(void)
+{
+    return 0;
+}
+/**
+    \fn getFrameSize
+*/
+uint8_t                 mxfHeader::getFrameSize(uint32_t frame,uint32_t *size)
+{
+    return 0;
+}
+/**
+    \fn getFrame
+*/
+uint8_t mxfHeader::getFrame(uint32_t framenum, ADMCompressedImage *img)
+{
+	return 0;
+}
+/**
+    \fn close
+*/
+uint8_t mxfHeader::close(void)
+{
+	return true;
+}
+
+/**
+    \fn open
+*/
+uint8_t mxfHeader::open(const char *inname)
+{
+    
+    return false;
+}
+/**
+    \fn setFlag
+*/
+
+uint8_t mxfHeader::setFlag(uint32_t frame, uint32_t flags)
+{
+    UNUSED_ARG(frame);
+    UNUSED_ARG(flags);
+    return 0;
+}
+/**
+    \fn getFlags
+*/
+
+uint32_t mxfHeader::getFlags(uint32_t frame, uint32_t * flags)
+{
+    UNUSED_ARG(frame);
+    UNUSED_ARG(flags);
+    return 0;
+}
+/**
+    \fn getPtsDts
+*/
+bool       mxfHeader::getPtsDts(uint32_t frame,uint64_t *pts,uint64_t *dts)
+{
+    return false;
+}
+/**
+    \fn setPtsDts
+*/
+
+bool       mxfHeader::setPtsDts(uint32_t frame,uint64_t pts,uint64_t dts)
+{
+    return false;
+}
+// EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/ADM_mxf.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/ADM_mxf.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/ADM_mxf.h	2010-11-07 09:09:39 UTC (rev 6726)
@@ -0,0 +1,80 @@
+/***************************************************************************
+     \file                     ADM_mxf.cpp
+     \brief MXF demuxer
+     \author mean, fixounet at free.fr (C) 2010
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+
+
+#ifndef ADM_MXF_H
+#define ADM_MXF_H
+
+#include "ADM_Video.h"
+#include "ADM_audioStream.h"
+
+/**
+    \class mxfHeader
+    \brief Demuxers for mxf format
+
+*/
+class mxfHeader         :public vidHeader
+{
+protected:
+
+
+public:
+//  static int checkFourCC(uint8_t *in, uint8_t *fourcc);
+
+virtual   void 				Dump(void) {};
+
+                            mxfHeader( void );
+                            ~mxfHeader(  ) { };
+// AVI io
+virtual 	uint8_t			open(const char *name);
+virtual 	uint8_t			close(void) ;
+  //__________________________
+  //				 Info
+  //__________________________
+
+  //__________________________
+  //				 Audio
+  //__________________________
+
+
+virtual 	WAVHeader              *getAudioInfo(uint32_t i ) {return NULL;} ;
+virtual 	uint8_t                 getAudioStream(uint32_t i,ADM_audioStream  **audio) {*audio=NULL;return 1;}
+virtual     uint8_t                 getNbAudioStreams(void) {return 0;}
+
+    
+// Frames
+  //__________________________
+  //				 video
+  //__________________________
+
+virtual 	uint8_t  setFlag(uint32_t frame,uint32_t flags);
+virtual 	uint32_t getFlags(uint32_t frame,uint32_t *flags);
+virtual 	uint8_t  getFrame(uint32_t framenum,ADMCompressedImage *);
+
+virtual   uint64_t                   getTime(uint32_t frameNum);
+virtual   uint64_t                   getVideoDuration(void);
+virtual 	uint8_t                 getFrameSize(uint32_t frame,uint32_t *size);
+
+virtual   bool       getPtsDts(uint32_t frame,uint64_t *pts,uint64_t *dts);
+virtual   bool       setPtsDts(uint32_t frame,uint64_t pts,uint64_t dts);
+
+
+};
+
+
+#endif
+
+

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/ADM_mxfPlugin.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/ADM_mxfPlugin.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/ADM_mxfPlugin.cpp	2010-11-07 09:09:39 UTC (rev 6726)
@@ -0,0 +1,44 @@
+/***************************************************************************
+     \file                     ADM_mxf.cpp
+     \brief MXF demuxer
+     \author mean, fixounet at free.fr (C) 2010
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "ADM_mxf.h"
+#include "ADM_demuxerInternal.h"
+#include "fourcc.h"
+
+ADM_DEMUXER_BEGIN( mxfHeader, 50,
+                    1,0,0,
+                    "MXF",
+                    "MXF demuxer plugin (c) Mean 2010"
+                );
+
+/**
+    \fn Probe
+*/
+
+extern "C"  uint32_t         probe(uint32_t magic, const char *fileName)
+{
+uint32_t result=0;
+
+    if(magic==0x342b0e06) 
+    {
+
+      printf("\n\t MXF file detected...\n");
+      return 100;
+    }
+    
+    printf (" [mxfHeader] Cannot open that (%x)\n",magic);
+    return 0;
+}
+// EOF
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mxf/CMakeLists.txt	2010-11-07 09:09:39 UTC (rev 6726)
@@ -0,0 +1,15 @@
+# Demuxer for mxfture
+# PNG etc...
+
+include(dm_plugin)
+
+SET(ADM_mxf_SRCS 
+	ADM_mxfPlugin.cpp
+	ADM_mxf.cpp
+)
+
+ADD_LIBRARY(ADM_dm_mxf SHARED ${ADM_mxf_SRCS})
+
+INIT_DEMUXER(ADM_dm_mxf)
+INSTALL_DEMUXER(ADM_dm_mxf)
+



From mean at mail.berlios.de  Sun Nov  7 18:24:05 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Nov 2010 18:24:05 +0100
Subject: [Avidemux-svn-commit] r6729 - in branches/avidemux_2.6_branch_mean:
	avidemux/qt4/ADM_jobs avidemux/qt4/ADM_jobs/include
	avidemux/qt4/ADM_jobs/src avidemux_core/ADM_coreJobs/include
	avidemux_core/ADM_coreJobs/src
Message-ID: <20101107172405.5B568480F1B@sheep.berlios.de>

Author: mean
Date: 2010-11-07 18:24:05 +0100 (Sun, 07 Nov 2010)
New Revision: 6729

Added:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/uiJobs.ui
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/ADM_coreJobs.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp
Log:
[jobs] Skeleton of dedicated app

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/CMakeLists.txt	2010-11-07 17:24:05 UTC (rev 6729)
@@ -0,0 +1 @@
+ADD_SUBDIRECTORY(src)

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-07 17:24:05 UTC (rev 6729)
@@ -0,0 +1,22 @@
+#ifndef Q_job_h
+#define Q_job_h
+
+#include <QtGui/QWidget>
+#include "ui_uiJobs.h"
+
+/**
+    \class jobWindow
+*/
+class jobWindow   : public QDialog 
+{
+	Q_OBJECT
+
+public:
+                jobWindow(void);
+	virtual     ~jobWindow();	    
+	
+protected:
+    Ui_jobs     ui;
+//public slots:
+};
+#endif	// Q_gui2_h

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-07 09:10:03 UTC (rev 6728)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-07 17:24:05 UTC (rev 6729)
@@ -1,9 +1,54 @@
+/**
+    \file   ADM_jobControl
+    \author mean fixounet at free.Fr (c) 2010
+
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "T_jobs.h"
 #include "ADM_default.h"
 #include "ADM_coreJobs.h"
 
+
+/**
+    \fn ctor
+*/
+jobWindow::jobWindow(void) : QDialog()
+{
+    ui.setupUi(this);
+}
+/**
+    \fn dtor
+*/
+jobWindow::~jobWindow()
+{
+
+}
+
+/**
+    \fn jobRun
+*/
 bool jobRun(void)
 {
+    QApplication *app=new QApplication(0,NULL);
+    jobWindow *jWindow=new jobWindow();
+    jWindow->exec();
+    delete jWindow;
+    delete app;
+    return true;
+}
 
+
+#if 0
+bool jobRun(void)
+{
+
         ADM_jobDropAllJobs();
 
         vector <ADMJob> jobs;
@@ -56,3 +101,4 @@
         }
         return true;
 }
+#endif
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt	2010-11-07 09:10:03 UTC (rev 6728)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt	2010-11-07 17:24:05 UTC (rev 6729)
@@ -4,14 +4,24 @@
 ADD_DEFINITIONS(-DADM_UI_TYPE_BUILD=ADM_UI_QT4)
 SET(CONFIG_HEADER_TYPE ADM_BUILD_QT4)
 SET(UI_SUFFIX qt4)
-
+include_directories(../include ${QT_INCLUDE_DIR} ${CMAKE_CURRENT_BINARY_DIR})
 ###########################################
 # Executable
 ###########################################
+#
+SET(UI uiJobs.ui)
+SET(headers ../include/T_jobs.h)
+QT4_WRAP_UI(ADM_JOBS_headers ${UI})
+QT4_WRAP_CPP(ADM_JOBS_source ${headers}
+                ADM_jobControl.cpp)
 SET(ADM_JOB_SRCS 
                 ADM_jobs.cpp
-                ADM_jobControl.cpp
+                 ADM_jobControl.cpp
+                ${ADM_JOBS_headers}
+                ${ADM_JOBS_source}
+                
         )
+
 ###########################################
 # Executable
 ###########################################

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/uiJobs.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/uiJobs.ui	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/uiJobs.ui	2010-11-07 17:24:05 UTC (rev 6729)
@@ -0,0 +1,71 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<ui version="4.0">
+ <class>jobs</class>
+ <widget class="QDialog" name="jobs">
+  <property name="windowModality">
+   <enum>Qt::WindowModal</enum>
+  </property>
+  <property name="geometry">
+   <rect>
+    <x>0</x>
+    <y>0</y>
+    <width>645</width>
+    <height>515</height>
+   </rect>
+  </property>
+  <property name="windowTitle">
+   <string>Avidemux Jobs</string>
+  </property>
+  <layout class="QVBoxLayout" name="verticalLayout">
+   <item>
+    <widget class="QListView" name="listView"/>
+   </item>
+   <item>
+    <layout class="QHBoxLayout" name="horizontalLayout">
+     <item>
+      <widget class="QPushButton" name="pushButtonRunAll">
+       <property name="statusTip">
+        <string>Run all pending jobs</string>
+       </property>
+       <property name="text">
+        <string>Run jobs</string>
+       </property>
+      </widget>
+     </item>
+     <item>
+      <widget class="QPushButton" name="pushButtonCleanup">
+       <property name="toolTip">
+        <string>Delete already executed jobs</string>
+       </property>
+       <property name="text">
+        <string>Cleanup</string>
+       </property>
+      </widget>
+     </item>
+     <item>
+      <spacer name="horizontalSpacer">
+       <property name="orientation">
+        <enum>Qt::Horizontal</enum>
+       </property>
+       <property name="sizeHint" stdset="0">
+        <size>
+         <width>40</width>
+         <height>20</height>
+        </size>
+       </property>
+      </spacer>
+     </item>
+     <item>
+      <widget class="QPushButton" name="pushButtonQuit">
+       <property name="text">
+        <string>Quit</string>
+       </property>
+      </widget>
+     </item>
+    </layout>
+   </item>
+  </layout>
+ </widget>
+ <resources/>
+ <connections/>
+</ui>

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/ADM_coreJobs.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/ADM_coreJobs.h	2010-11-07 09:10:03 UTC (rev 6728)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/ADM_coreJobs.h	2010-11-07 17:24:05 UTC (rev 6729)
@@ -15,10 +15,8 @@
  ***************************************************************************/
 #ifndef ADM_COREJOBS_H
 #define ADM_COREJOBS_H
-#include <string>
-#include <vector>
-using std::vector;
-using std::string;
+#include "ADM_cpp.h"
+#include "ADM_default.h"
 /**
     \enum ADM_JOB_STATUS
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp	2010-11-07 09:10:03 UTC (rev 6728)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp	2010-11-07 17:24:05 UTC (rev 6729)
@@ -13,8 +13,8 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
+#include "ADM_coreJobs.h"
 #include "ADM_default.h"
-#include "ADM_coreJobs.h"
 #include "ADM_sqlite3.h"
 #include "libsqlitewrapped.h"
 #include "libjobdb.h"



From mean at mail.berlios.de  Sun Nov  7 19:10:26 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Nov 2010 19:10:26 +0100
Subject: [Avidemux-svn-commit] r6730 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src
Message-ID: <20101107181027.3569E480F1B@sheep.berlios.de>

Author: mean
Date: 2010-11-07 19:10:26 +0100 (Sun, 07 Nov 2010)
New Revision: 6730

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt
Log:
[win32]

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt	2010-11-07 17:24:05 UTC (rev 6729)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt	2010-11-07 18:10:26 UTC (rev 6730)
@@ -30,6 +30,9 @@
 ADD_SOURCE_CFLAGS(ADM_jobs.cpp "-DADM_SUBVERSION=${ADM_SUBVERSION}")
 
 ###########################################
+TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_coreJobs)
+TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_coreUtils6)
+TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_core6)
 TARGET_LINK_LIBRARIES(avidemux3_jobs ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY})
 
 ###########################################
@@ -53,9 +56,6 @@
 ENDIF (APPLE)
 #
 #
-TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_coreJobs)
-TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_coreUtils6)
-TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_core6)
 
 
 ###########################################



From mean at mail.berlios.de  Sun Nov  7 19:19:33 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Nov 2010 19:19:33 +0100
Subject: [Avidemux-svn-commit] r6731 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src
Message-ID: <20101107181933.8AFA7480F1B@sheep.berlios.de>

Author: mean
Date: 2010-11-07 19:19:33 +0100 (Sun, 07 Nov 2010)
New Revision: 6731

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt
Log:
[win32] try2

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt	2010-11-07 18:10:26 UTC (rev 6730)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt	2010-11-07 18:19:33 UTC (rev 6731)
@@ -30,16 +30,13 @@
 ADD_SOURCE_CFLAGS(ADM_jobs.cpp "-DADM_SUBVERSION=${ADM_SUBVERSION}")
 
 ###########################################
-TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_coreJobs)
-TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_coreUtils6)
-TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_core6)
 TARGET_LINK_LIBRARIES(avidemux3_jobs ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY})
 
 ###########################################
 # OS Specific
 ###########################################
 IF (WIN32)
-	target_link_libraries(ADM_osSupport)
+	target_link_libraries(avidemux3_jobs ADM_osSupport)
 
 	IF (MINGW)
 		target_link_libraries(avidemux3_jobs -mno-cygwin)
@@ -54,6 +51,9 @@
 	# for Leopard but it doesn't hurt Tiger
 	ADD_TARGET_LDFLAGS(avidemux3_jobs "-Wl,-dylib_file,/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib:/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib")
 ENDIF (APPLE)
+TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_coreJobs)
+TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_coreUtils6)
+TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_core6)
 #
 #
 



From mean at mail.berlios.de  Sun Nov  7 19:25:51 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Nov 2010 19:25:51 +0100
Subject: [Avidemux-svn-commit] r6732 - branches/avidemux_2.6_branch_mean
Message-ID: <20101107182551.D7A15480F1B@sheep.berlios.de>

Author: mean
Date: 2010-11-07 19:25:51 +0100 (Sun, 07 Nov 2010)
New Revision: 6732

Modified:
   branches/avidemux_2.6_branch_mean/bootStrapCrossMingw_w32.sh
Log:
[win32] verbose

Modified: branches/avidemux_2.6_branch_mean/bootStrapCrossMingw_w32.sh
===================================================================
--- branches/avidemux_2.6_branch_mean/bootStrapCrossMingw_w32.sh	2010-11-07 18:19:33 UTC (rev 6731)
+++ branches/avidemux_2.6_branch_mean/bootStrapCrossMingw_w32.sh	2010-11-07 18:25:51 UTC (rev 6732)
@@ -23,7 +23,7 @@
         mkdir $BUILDDIR || fail mkdir
         cd $BUILDDIR 
         sh $TOP/foreignBuilds/$SCRIPT $EXTRA || fail cmake
-        make -j 2 > /tmp/log$BUILDDIR || fail make
+        make -j 2 VERBOSE=1 || fail make
         make install || fail make_install
 }
 



From mean at mail.berlios.de  Sun Nov  7 19:52:46 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Nov 2010 19:52:46 +0100
Subject: [Avidemux-svn-commit] r6733 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src
Message-ID: <20101107185246.D16F9480F1B@sheep.berlios.de>

Author: mean
Date: 2010-11-07 19:52:46 +0100 (Sun, 07 Nov 2010)
New Revision: 6733

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/CMakeLists.txt
Log:
[coreJobs] win32

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/CMakeLists.txt	2010-11-07 18:25:51 UTC (rev 6732)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/CMakeLists.txt	2010-11-07 18:52:46 UTC (rev 6733)
@@ -13,5 +13,5 @@
 	TARGET_LINK_LIBRARIES(ADM_coreJobs -Wl,-read_only_relocs,suppress)
 ENDIF (APPLE)
 INCLUDE_DIRECTORIES(../include)
-#TARGET_LINK_LIBRARIES(ADM_coreJobs ADM_core6 ADM_coreUI6  ADM_coreUtils6)
+TARGET_LINK_LIBRARIES(ADM_coreJobs ADM_core6 )
 ADM_INSTALL_LIB(ADM_coreJobs)



From mean at mail.berlios.de  Sun Nov  7 20:04:13 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun,  7 Nov 2010 20:04:13 +0100
Subject: [Avidemux-svn-commit] r6734 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src
Message-ID: <20101107190413.C2CEF480F1B@sheep.berlios.de>

Author: mean
Date: 2010-11-07 20:04:13 +0100 (Sun, 07 Nov 2010)
New Revision: 6734

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
Log:
[Jobs] compatibility with older qt4

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-07 18:52:46 UTC (rev 6733)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-07 19:04:13 UTC (rev 6734)
@@ -36,7 +36,7 @@
 */
 bool jobRun(void)
 {
-    QApplication *app=new QApplication(0,NULL);
+    QApplication *app=new QApplication(0,NULL,0);
     jobWindow *jWindow=new jobWindow();
     jWindow->exec();
     delete jWindow;



From mean at mail.berlios.de  Mon Nov  8 07:30:03 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  8 Nov 2010 07:30:03 +0100
Subject: [Avidemux-svn-commit] r6735 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src
Message-ID: <20101108063003.3E9704810D5@sheep.berlios.de>

Author: mean
Date: 2010-11-08 07:30:02 +0100 (Mon, 08 Nov 2010)
New Revision: 6735

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobs.cpp
Log:
[jobs/qt4] Fix QApplication init

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-07 19:04:13 UTC (rev 6734)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-08 06:30:02 UTC (rev 6735)
@@ -34,9 +34,9 @@
 /**
     \fn jobRun
 */
-bool jobRun(void)
+bool jobRun(int ac,char **av)
 {
-    QApplication *app=new QApplication(0,NULL,0);
+    QApplication *app=new QApplication(ac,av,0);
     jobWindow *jWindow=new jobWindow();
     jWindow->exec();
     delete jWindow;

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobs.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobs.cpp	2010-11-07 19:04:13 UTC (rev 6734)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobs.cpp	2010-11-08 06:30:02 UTC (rev 6735)
@@ -49,7 +49,7 @@
 
 extern uint8_t  quotaInit(void);
 extern uint8_t win32_netInit(void);
-extern bool jobRun(void);
+extern bool jobRun(int ac, char **av);
 
 
 int main(int argc, char *argv[])
@@ -145,7 +145,7 @@
 
     // Init jobs
     ADM_jobInit();
-    jobRun();
+    jobRun(argc,argv);
 
 #ifdef __MINGW32__
 	__except1(exceptionHandler);



From mean at mail.berlios.de  Mon Nov  8 08:04:09 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  8 Nov 2010 08:04:09 +0100
Subject: [Avidemux-svn-commit] r6736 - in
	branches/avidemux_2.6_branch_mean/avidemux/common: . ADM_commonUI
Message-ID: <20101108070410.247E84810D5@sheep.berlios.de>

Author: mean
Date: 2010-11-08 08:04:09 +0100 (Mon, 08 Nov 2010)
New Revision: 6736

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h
   branches/avidemux_2.6_branch_mean/avidemux/common/A_functions.h
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp
Log:
[Jobs] Add Queue entry placeholder in menu

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h	2010-11-08 06:30:02 UTC (rev 6735)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_commonUI/myOwnMenu.h	2010-11-08 07:04:09 UTC (rev 6736)
@@ -31,6 +31,7 @@
             {MENU_ACTION,"Open",    NULL,ACT_OPEN_VIDEO,       MKICON(fileopen), "Ctrl+O"},
             {MENU_ACTION,"Append",  NULL,ACT_APPEND_VIDEO     ,NULL,             "Ctrl+A"},
             {MENU_ACTION,"Save",    NULL,ACT_SAVE_VIDEO       ,MKICON(filesaveas),"Ctrl+S"},
+            {MENU_ACTION,"Queue",   NULL,ACT_SAVE_QUEUE       ,NULL              ,"Ctrl+U"},
             {MENU_SUBMENU,"Save as Image",    NULL,ACT_DUMMY    ,NULL,NULL},
             {MENU_SUBACTION,"Save as BMP",    NULL,ACT_SAVE_BMP ,NULL,NULL},
             {MENU_SUBACTION,"Save as Jpeg",   NULL,ACT_SAVE_JPG ,NULL,NULL},

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/A_functions.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/A_functions.h	2010-11-08 06:30:02 UTC (rev 6735)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/A_functions.h	2010-11-08 07:04:09 UTC (rev 6736)
@@ -31,7 +31,7 @@
 void 			A_saveAudioDecoded	(char *name);
 void 			A_saveAVI		(char *name);
 void 			A_playAvi		(void);
-
+void            A_queueJob      (void);
 int  A_saveAudioCopy (const char *name);
 int  A_saveJpg (const char *name);
 int  A_saveBunchJpg(const char *name);

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names	2010-11-08 06:30:02 UTC (rev 6735)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_action.names	2010-11-08 07:04:09 UTC (rev 6736)
@@ -18,6 +18,7 @@
 ACT(SAVE_AUDIO)
 ACT(SAVE_JS_PROJECT)
 ACT(SAVE_PY_PROJECT)
+ACT(SAVE_QUEUE)
 ACT(SAVE_END)
 
 // Project

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp	2010-11-08 06:30:02 UTC (rev 6735)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp	2010-11-08 07:04:09 UTC (rev 6736)
@@ -45,6 +45,9 @@
 {
     switch(action)
     {
+    case ACT_SAVE_QUEUE:
+            GUI_Error_HIG("!","Not implemented yet.");
+            break;
     case ACT_SAVE_PY_PROJECT:
             GUI_FileSelWrite (QT_TR_NOOP("Select pyProject to Save"), A_savePyProject);
             UI_refreshCustomMenu();



From mean at mail.berlios.de  Mon Nov  8 08:04:11 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon,  8 Nov 2010 08:04:11 +0100
Subject: [Avidemux-svn-commit] r6737 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src
Message-ID: <20101108070411.7DF604810D5@sheep.berlios.de>

Author: mean
Date: 2010-11-08 08:04:11 +0100 (Mon, 08 Nov 2010)
New Revision: 6737

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt
Log:
[jobs/qt4] Dont need OSsupport

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt	2010-11-08 07:04:09 UTC (rev 6736)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt	2010-11-08 07:04:11 UTC (rev 6737)
@@ -36,7 +36,7 @@
 # OS Specific
 ###########################################
 IF (WIN32)
-	target_link_libraries(avidemux3_jobs ADM_osSupport)
+#	target_link_libraries(avidemux3_jobs ADM_osSupport)
 
 	IF (MINGW)
 		target_link_libraries(avidemux3_jobs -mno-cygwin)



From mean at mail.berlios.de  Thu Nov 11 08:53:54 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 08:53:54 +0100
Subject: [Avidemux-svn-commit] r6740 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src
Message-ID: <20101111075354.74FFA481047@sheep.berlios.de>

Author: mean
Date: 2010-11-11 08:53:54 +0100 (Thu, 11 Nov 2010)
New Revision: 6740

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp
Log:
[jobs] Create database if it does not exist

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp	2010-11-11 07:53:52 UTC (rev 6739)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp	2010-11-11 07:53:54 UTC (rev 6740)
@@ -20,7 +20,88 @@
 #include "libjobdb.h"
 static char *dbFile=NULL;
 Database    *mydb=NULL;
+
+#define ADM_DB_SCHEMA 2
+
+static const char *createString1="\
+CREATE TABLE version(\
+value integer not null\
+);";
+static const char *createString2="\
+CREATE TABLE jobs(\
+id integer primary key autoincrement not null,\
+jscript varchar(100) default '' not null,\
+jobname varchar(100) default '' not null,\
+outputFile varchar(256) default '' not null,\
+status integer,\
+startTime date,\
+endTime date\
+);\
+";
+
 /**
+    \fn ADM_jobInitializeDb
+*/
+static bool ADM_jobInitializeDb(void)
+{
+    bool r=true;
+    Database *m=new Database(dbFile);
+    if(!m->Connected())
+    {
+        ADM_warning("Cannot create database  %s \n",dbFile);
+        return false;
+    }
+    ADM_info("Creating database schema...\n");
+    Query q(*m);
+    r=q.execute(createString1);
+    r=q.execute(createString2);
+    q.execute("COMMIT;");
+    
+    if(r){
+        // update version
+        char s[256];
+        sprintf(s,"INSERT INTO version (value) VALUES (%d);",ADM_DB_SCHEMA);
+        r=q.execute(s);
+        delete m;
+    }
+    return r;
+}
+/**
+        \fn dbInit
+*/
+static bool dbInit(void)
+{
+    mydb=new Database(dbFile);
+    if(!mydb->Connected())
+    {
+        delete mydb;
+        mydb=NULL;
+        return false;
+    }
+    return true;
+}
+/**
+        \fn dbCleanup
+*/
+
+static bool dbCleanup(void)
+{
+    if(mydb)
+    {
+        delete mydb;
+        mydb=NULL;
+    }
+    return true;
+}
+/**
+    \fn ADM_jobCheckVersion
+    \brief returns true if the db has the right version
+*/
+static bool ADM_jobCheckVersion(void)
+{
+    return true;
+}
+/**
     \fn ADM_jobInit
     \brief init sql and friends
 */
@@ -29,20 +110,38 @@
     dbFile=new char[1024];
     strcpy(dbFile,ADM_getBaseDir());
     strcat(dbFile,"/jobs.sql");
-
+    
+    ADM_info("Initializing database (%s)\n",dbFile);
     if(!ADM_fileExist(dbFile))
     {
         ADM_warning("[Jobs] jobs.sql does not exist, creating from default...\n");
-        return false;
+        if(!ADM_jobInitializeDb())
+            return false;
+        ADM_info("Database created\n");
     }
-    mydb=new Database(dbFile);
-    if(!mydb->Connected())
+    if(false==dbInit())
     {
-        ADM_warning("Cannot use database...\n");
-        delete mydb;
-        mydb=NULL;
+        ADM_warning("Cannot initialize database \n");
+        dbCleanup();
         return false;
     }
+    // Check DB version...
+    if(false==ADM_jobCheckVersion())
+    {
+        ADM_info("Bad database version...\n");
+        dbCleanup();
+        unlink(dbFile);
+        if(true==ADM_jobInitializeDb())
+        {
+            if(false==dbInit())
+            {
+                dbCleanup();
+                ADM_warning("Cannot recreate database\n");
+                return false;
+            }
+        }
+    }
+    //
     ADM_info("Successfully connected to jobs database..\n");
     return true;
 }
@@ -51,11 +150,7 @@
 */
 bool    ADM_jobShutDown(void)
 {
-    if(mydb)
-    {
-        delete mydb;
-        mydb=NULL;
-    }
+    dbCleanup();
     ADM_info("Shutting down jobs database\n");
     return true;
 }



From mean at mail.berlios.de  Thu Nov 11 08:53:55 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 08:53:55 +0100
Subject: [Avidemux-svn-commit] r6741 -
	branches/avidemux_2.6_branch_mean/cmake/sql
Message-ID: <20101111075355.876DB481047@sheep.berlios.de>

Author: mean
Date: 2010-11-11 08:53:55 +0100 (Thu, 11 Nov 2010)
New Revision: 6741

Added:
   branches/avidemux_2.6_branch_mean/cmake/sql/update.sh
Modified:
   branches/avidemux_2.6_branch_mean/cmake/sql/jobs.sql
Log:
[jobs] Add schema/class udate script

Modified: branches/avidemux_2.6_branch_mean/cmake/sql/jobs.sql
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/sql/jobs.sql	2010-11-11 07:53:54 UTC (rev 6740)
+++ branches/avidemux_2.6_branch_mean/cmake/sql/jobs.sql	2010-11-11 07:53:55 UTC (rev 6741)
@@ -1,12 +1,5 @@
-SQLite format 3   @                                                                     -?-   ? ??                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     P++Ytablesqlite_sequencesqlite_sequenceCREATE TABLE sqlite_sequence(name,seq)??otablejobsjobsCREATE TABLE jobs(
-id integer primary key autoincrement not null,
-jscript varchar(100) default '' not null,
-jobname varchar(100) default '' not null,
-outputFile varchar(256) default '' not null,
-status integer,
-startTime date,
-endTime date
-)+SQLite format 3   @                                                                     -?+   e ??e                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   P++Ytablesqlite_sequencesqlite_sequenceCREATE TABLE sqlite_sequence(name,seq)?~?_tablejobsjobsCREATE TABLE jobs(id integer primary key autoincrement not null,jscript varchar(100) default '' not null,jobname varchar(100) default '' not null,outputFile varchar(256) default '' not null,status integer,startTime date,endTime date)FetableversionversionCREAT
 E TABLE version(value integer not null)+   ? ?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                    
\ No newline at end of file

Added: branches/avidemux_2.6_branch_mean/cmake/sql/update.sh
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/sql/update.sh	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/cmake/sql/update.sh	2010-11-11 07:53:55 UTC (rev 6741)
@@ -0,0 +1,2 @@
+sqlite3 ~/.avidemux6/jobs.sql .d > dump
+sql2class -sqlite -prefix -lib /usr dump



From mean at mail.berlios.de  Thu Nov 11 08:53:56 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 08:53:56 +0100
Subject: [Avidemux-svn-commit] r6742 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src
Message-ID: <20101111075356.9E421481047@sheep.berlios.de>

Author: mean
Date: 2010-11-11 08:53:56 +0100 (Thu, 11 Nov 2010)
New Revision: 6742

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp
Log:
[jobs] Check db schema version

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp	2010-11-11 07:53:55 UTC (rev 6741)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp	2010-11-11 07:53:56 UTC (rev 6742)
@@ -21,7 +21,7 @@
 static char *dbFile=NULL;
 Database    *mydb=NULL;
 
-#define ADM_DB_SCHEMA 2
+#define ADM_DB_SCHEMA 3
 
 static const char *createString1="\
 CREATE TABLE version(\
@@ -99,7 +99,24 @@
 */
 static bool ADM_jobCheckVersion(void)
 {
-    return true;
+    if(!mydb) return false;
+    Query q(*mydb);
+	q.get_result("select * from version");
+	if(!q.fetch_row())
+    {
+        ADM_warning("Cannot get version\n");
+        return false;
+    }
+    int dbVersion=q.getval();
+    q.free_result();
+    ADM_info("Db version %d, our version %d\n",dbVersion,ADM_DB_SCHEMA);
+    if(dbVersion==ADM_DB_SCHEMA)
+    {
+        ADM_info("Same version, continuing..\n");
+        return true;
+    }
+    ADM_info("Version mismatch, recreating db..\n");
+    return false;
 }
 /**
     \fn ADM_jobInit



From mean at mail.berlios.de  Thu Nov 11 08:53:57 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 08:53:57 +0100
Subject: [Avidemux-svn-commit] r6743 - in
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs: include src
Message-ID: <20101111075357.D57AA481047@sheep.berlios.de>

Author: mean
Date: 2010-11-11 08:53:57 +0100 (Thu, 11 Nov 2010)
New Revision: 6743

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/uiJobs.ui
Log:
[jobs/ui] Preliminary ui

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-11 07:53:56 UTC (rev 6742)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-11 07:53:57 UTC (rev 6743)
@@ -3,7 +3,9 @@
 
 #include <QtGui/QWidget>
 #include "ui_uiJobs.h"
-
+#include <vector>
+using std::vector;
+class ADMJob;
 /**
     \class jobWindow
 */
@@ -16,7 +18,9 @@
 	virtual     ~jobWindow();	    
 	
 protected:
-    Ui_jobs     ui;
+    Ui_jobs     ui;
+    void        refreshList(void);
+    vector      <ADMJob> listOfJob;
 //public slots:
 };
 #endif	// Q_gui2_h

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-11 07:53:56 UTC (rev 6742)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-11 07:53:57 UTC (rev 6743)
@@ -15,13 +15,67 @@
 #include "ADM_default.h"
 #include "ADM_coreJobs.h"
 
+
+static QTableWidgetItem *fromText(const string &t)
+{
+    QString s(QString::fromUtf8(t.c_str()));
+    QTableWidgetItem *w=new QTableWidgetItem(s,0);
+    return w;
+}
 
 /**
+    \fn refreshList
+*/
+void jobWindow::refreshList(void)
+{
+      QTableWidget *list=ui.tableWidget;
+      list->clear();
+      listOfJob.clear();
+      if(false==ADM_jobGet(listOfJob)) return ;
+
+      int n=listOfJob.size();
+      ADM_info("Found %d jobs\n",(int)n);
+      if(!n) return;
+      list->setRowCount(n);
+      for(int i=0;i<n;i++)
+      {
+           QTableWidgetItem *nm=fromText(listOfJob[i].jobName);
+           QTableWidgetItem *out=fromText(listOfJob[i].outputFileName);
+           string s;
+            switch(listOfJob[i].status)
+            {
+                case ADM_JOB_IDLE:
+                            s=string("Ready");
+                            break;
+                case ADM_JOB_RUNNING:
+                            s=string("Running....");
+                            break;
+                case ADM_JOB_OK:
+                            s=string("Success");
+                            break;
+                case ADM_JOB_KO:
+                            s=string("Failed");
+                            break;
+                default:
+                            s=string("???");
+                            break;
+            }
+        QTableWidgetItem *status=fromText (s);
+        list->setItem(i,0,nm);
+        list->setItem(i,1,out);
+        list->setItem(i,2,status);
+      }
+}
+
+
+/**
     \fn ctor
 */
 jobWindow::jobWindow(void) : QDialog()
 {
     ui.setupUi(this);
+    ui.tableWidget->setColumnCount(3); // Job name, fileName, Status
+    refreshList();
 }
 /**
     \fn dtor

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/uiJobs.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/uiJobs.ui	2010-11-11 07:53:56 UTC (rev 6742)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/uiJobs.ui	2010-11-11 07:53:57 UTC (rev 6743)
@@ -18,7 +18,7 @@
   </property>
   <layout class="QVBoxLayout" name="verticalLayout">
    <item>
-    <widget class="QListView" name="listView"/>
+    <widget class="QTableWidget" name="tableWidget"/>
    </item>
    <item>
     <layout class="QHBoxLayout" name="horizontalLayout">



From mean at mail.berlios.de  Thu Nov 11 08:53:53 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 08:53:53 +0100
Subject: [Avidemux-svn-commit] r6739 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <20101111075353.4B7E4480EF3@sheep.berlios.de>

Author: mean
Date: 2010-11-11 08:53:52 +0100 (Thu, 11 Nov 2010)
New Revision: 6739

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/A_functions.h
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp
Log:
[jobs] UI to queue job

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/A_functions.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/A_functions.h	2010-11-09 20:41:33 UTC (rev 6738)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/A_functions.h	2010-11-11 07:53:52 UTC (rev 6739)
@@ -44,4 +44,6 @@
 int  A_saveAudioProcessed (const char *name);
 int  A_Save(const char *name);
 
+void A_queueJob(const char *jobName,const char *outputFile);
+
 #endif
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp	2010-11-09 20:41:33 UTC (rev 6738)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_save.cpp	2010-11-11 07:53:52 UTC (rev 6739)
@@ -32,6 +32,8 @@
 #include "DIA_fileSel.h"
 #include "DIA_working.h"
 #include "ADM_preview.h"
+#include "DIA_factory.h"
+#include "ADM_coreJobs.h"
 // Local prototypes
 #include "A_functions.h"
 int      A_Save(const char *name);
@@ -46,7 +48,18 @@
     switch(action)
     {
     case ACT_SAVE_QUEUE:
-            GUI_Error_HIG("!","Not implemented yet.");
+            {
+                char *oFile=NULL;
+                char *oText=NULL;
+                diaElemFile wFile(1,&oFile,QT_TR_NOOP("Output file"),"");
+                diaElemText wText(&oText,QT_TR_NOOP("Job name"));
+                diaElem *elems[2]={&wText,&wFile};
+  
+                if(  diaFactoryRun(QT_TR_NOOP("Queue job to jobList"),2,elems))
+                {
+                    A_queueJob(oText,oFile);
+                }
+            }
             break;
     case ACT_SAVE_PY_PROJECT:
             GUI_FileSelWrite (QT_TR_NOOP("Select pyProject to Save"), A_savePyProject);
@@ -469,6 +482,27 @@
         }
         return 1;
 }
-
+/**
+    \fn A_queueJob
+    \brief Save current stuff as py script and create the associated job
+*/
+void A_queueJob(const char *jobName,const char *outputFile)
+{
+    ADMJob job;
+            job.outputFileName=string(outputFile);
+            job.jobName=string(jobName);
+#warning make sure it is unique
+            job.scriptName=string(jobName);
+            if(false==ADM_jobAdd(job))
+            {
+                GUI_Error_HIG("Queue","Cannot add job %s",jobName);
+                return;
+            }
+            string completePath=string(ADM_getJobDir());
+            completePath=completePath+string("/")+job.scriptName;
+            // Save the script...
+            video_body->saveAsPyScript(completePath.c_str());
+            
+}
 //EOF
 



From mean at mail.berlios.de  Thu Nov 11 09:48:12 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 09:48:12 +0100
Subject: [Avidemux-svn-commit] r6744 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv
Message-ID: <20101111084813.1C719480EF3@sheep.berlios.de>

Author: mean
Date: 2010-11-11 09:48:12 +0100 (Thu, 11 Nov 2010)
New Revision: 6744

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp
Log:
[flv] Handle nicely object_end tag

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp	2010-11-11 07:53:57 UTC (rev 6743)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp	2010-11-11 08:48:12 UTC (rev 6744)
@@ -129,7 +129,9 @@
             printf("type :%d : ",type);
             switch(type)
             {
-                case AMF_DATA_TYPE_OBJECT_END:break;
+                case AMF_DATA_TYPE_OBJECT_END:
+                                fseek(_fd,endPos,SEEK_SET);
+                                break;
                 case AMF_DATA_TYPE_OBJECT: 
                 {
                         printf("\n");



From mean at mail.berlios.de  Thu Nov 11 17:06:10 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 17:06:10 +0100
Subject: [Avidemux-svn-commit] r6745 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4
Message-ID: <20101111160610.0F45F48058B@sheep.berlios.de>

Author: mean
Date: 2010-11-11 17:06:09 +0100 (Thu, 11 Nov 2010)
New Revision: 6745

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4/ADM_mp4Indexer.cpp
Log:
[mp4] Fix playback of P103xxx.MOV (LPCM in mov)

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4/ADM_mp4Indexer.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4/ADM_mp4Indexer.cpp	2010-11-11 08:48:12 UTC (rev 6744)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_mp4/ADM_mp4Indexer.cpp	2010-11-11 16:06:09 UTC (rev 6745)
@@ -147,7 +147,7 @@
               // Normally they have all the same duration
               if(info->nbStts!=1) printf("WARNING: Same size, different duration\n");
 
-              float sampleDuration,totalDuration=0;
+              double sampleDuration,totalDuration=0;
               
                 sampleDuration=info->SttsC[0];
                 sampleDuration*=1000.*1000.;
@@ -198,7 +198,7 @@
                           // The last one...
                                 newindex[w].offset=track->index[i].offset+part*one_go;
                                 newindex[w].size=sz;
-                                newindex[w].time=track->index[i].time+part*time_increment+((time_increment*sz)/one_go); 
+                                newindex[w].time=track->index[i].time+part*time_increment;
                                 w++;
                     }
                     delete [] track->index;



From mean at mail.berlios.de  Thu Nov 11 18:06:54 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 18:06:54 +0100
Subject: [Avidemux-svn-commit] r6746 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv
Message-ID: <20101111170654.7047748058B@sheep.berlios.de>

Author: mean
Date: 2010-11-11 18:06:54 +0100 (Thu, 11 Nov 2010)
New Revision: 6746

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp
Log:
[Flv] Fix Zapping.flv

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp	2010-11-11 16:06:09 UTC (rev 6745)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp	2010-11-11 17:06:54 UTC (rev 6746)
@@ -350,6 +350,7 @@
     size=read24();
     pts=read24();
     read32(); // ???
+    if(!size) continue;
     uint32_t remaining=size;
     //printf("[FLV] At %08x found type %x size %u pts%u\n",pos,type,size,pts);
     switch(type)



From mean at mail.berlios.de  Thu Nov 11 18:06:56 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 18:06:56 +0100
Subject: [Avidemux-svn-commit] r6747 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv
Message-ID: <20101111170656.1256548058B@sheep.berlios.de>

Author: mean
Date: 2010-11-11 18:06:55 +0100 (Thu, 11 Nov 2010)
New Revision: 6747

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.h
Log:
[flv] Get width and height when metadata happens later

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp	2010-11-11 17:06:54 UTC (rev 6746)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.cpp	2010-11-11 17:06:55 UTC (rev 6747)
@@ -226,13 +226,14 @@
         while(ftello(_fd)<endPos-4)
         {
             char *s=readFlvString();
-            printf("[FlvType]  String : %s",s);
+            printf("[FlvType]  String : %s ",s);
             
             if(false==parseOneMeta(s,endPos)) goto endit;
         }
     }
 endit:
     fseeko(_fd,endPos,SEEK_SET);
+    updateDimensionWithMeta(videoCodec);
     return 1;
 }
 /**
@@ -393,9 +394,9 @@
             remaining--;
             int frameType=flags>>4;
             
-            int codec=(flags)&0xf;
+            videoCodec=(flags)&0xf;
             
-            if(codec==FLV_CODECID_VP6 || codec==FLV_CODECID_VP6A)
+            if(videoCodec==FLV_CODECID_VP6 || videoCodec==FLV_CODECID_VP6A)
             {
               read8(); // 1 byte of extraData
               remaining--;
@@ -403,10 +404,10 @@
             }
             if(firstVideo==true) // first frame..
             {
-                if(!setVideoHeader(codec,&remaining)) return 0;
+                if(!setVideoHeader(videoCodec,&remaining)) return 0;
                 firstVideo=false;
             }
-            if(codec==FLV_CODECID_H264)
+            if(videoCodec==FLV_CODECID_H264)
             {
                 if(true==extraHeader(videoTrack,&remaining,true,&cts)) continue;
 
@@ -453,6 +454,27 @@
   
   return 1;
 }
+bool flvHeader::updateDimensionWithMeta(uint32_t codec)
+{
+    if(codec==0xFFFF) return false;
+    printf("We got metadata : %d x %d\n",(int)metaWidth,(int)metaHeight,(int)codec);
+    if( metaWidth && metaHeight )
+    {
+        switch(codec)
+        {
+            case FLV_CODECID_VP6A:
+            case FLV_CODECID_H264:
+            case FLV_CODECID_VP6:
+
+                    _video_bih.biHeight=_mainaviheader.dwHeight=metaHeight ;
+                    _video_bih.biWidth=_mainaviheader.dwWidth=metaWidth;
+                    break;
+            default:break;
+        }
+    }
+    return true;
+}
+
 /**
       \fn setVideoHeader
       \brief Set codec and stuff
@@ -475,14 +497,10 @@
       default :                         _videostream.fccHandler=_video_bih.biCompression=fourCC::get((uint8_t *)"XXX");break;
       
     }
-     if( metaWidth && metaHeight )
-        if( codec==FLV_CODECID_VP6A  || codec==FLV_CODECID_H264 || codec==FLV_CODECID_VP6) 
-        {
-                _video_bih.biHeight=_mainaviheader.dwHeight=metaHeight ;
-                _video_bih.biWidth=_mainaviheader.dwWidth=metaWidth;
-        }
 
-    if(codec==FLV_CODECID_H263)
+    updateDimensionWithMeta(codec);
+
+    if(codec==FLV_CODECID_H263 && *remaining)
     {
       uint32_t len=*remaining,width,height;
       uint32_t pos=ftello(_fd);
@@ -647,7 +665,9 @@
 */
 
  flvHeader::flvHeader( void ) : vidHeader()
-{ 
+{
+    metaWidth=metaHeight=metaFps1000=0; 
+    videoCodec=0xFFFF;
     _fd=NULL;
     _filename=NULL;
     videoTrack=NULL;

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.h	2010-11-11 17:06:54 UTC (rev 6746)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_inputs/ADM_flv/ADM_flv.h	2010-11-11 17:06:55 UTC (rev 6747)
@@ -88,7 +88,7 @@
     uint8_t                 getAudioStreamsInfo(uint32_t *nbStreams, audioInfo **infos);
     flvAudio                *_audioStream;
     /* */
-    uint32_t                metaWidth,metaHeight,metaFps1000;
+    uint32_t                metaWidth,metaHeight,metaFps1000,videoCodec;
     
     uint8_t     read(uint32_t len, uint8_t *where);
     uint8_t     read8(void);
@@ -108,7 +108,7 @@
     bool        parseOneMeta(const char *s,uint64_t endPos);
     void        setProperties(const char *name,float value);
     char        *readFlvString(void);
- 
+    bool        updateDimensionWithMeta(uint32_t codec);
 
   public:
 



From mean at mail.berlios.de  Thu Nov 11 18:07:36 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 18:07:36 +0100
Subject: [Avidemux-svn-commit] r6749 -
	branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec
Message-ID: <20101111170736.9EF7E480906@sheep.berlios.de>

Author: mean
Date: 2010-11-11 18:07:36 +0100 (Thu, 11 Nov 2010)
New Revision: 6749

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec/ADM_codecwav.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec/ADM_lpcm.cpp
Log:
[wav codec] Cosmetic

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec/ADM_codecwav.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec/ADM_codecwav.cpp	2010-11-11 17:07:33 UTC (rev 6748)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec/ADM_codecwav.cpp	2010-11-11 17:07:36 UTC (rev 6749)
@@ -20,7 +20,7 @@
 
 ADM_AudiocodecWav::ADM_AudiocodecWav( uint32_t fourcc ) : ADM_Audiocodec(fourcc)
 {
-
+    ADM_info("Creating not swapped wav decoder (PCM)\n");
 }
 ADM_AudiocodecWav::~ADM_AudiocodecWav()
 {

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec/ADM_lpcm.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec/ADM_lpcm.cpp	2010-11-11 17:07:33 UTC (rev 6748)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_audiocodec/ADM_lpcm.cpp	2010-11-11 17:07:36 UTC (rev 6749)
@@ -33,6 +33,7 @@
 	channelMapping[3] = ADM_CH_LFE;
 	channelMapping[4] = ADM_CH_REAR_LEFT;
 	channelMapping[5] = ADM_CH_REAR_RIGHT;
+    ADM_info("Creating swapped wav decoder (LPCM)\n");
 }
 
 ADM_AudiocodecWavSwapped::~ADM_AudiocodecWavSwapped()
@@ -61,14 +62,14 @@
 		return 1;
 
 	if (nbIn&1) {
-		printf("Error: nbIn (%i) odd in lpcm", nbIn);
+		ADM_error("Error: nbIn (%i) odd in lpcm", nbIn);
 		abort();
 	}
 
 	int16_t sample;
 	*nbOut=nbIn / 2;
 	for (int i = 0; i < *nbOut; i++) {
-		sample = (*inptr << 8 | *(inptr+1));
+		sample = (inptr[0] << 8) | inptr[1];
 		*(outptr++) = (float)sample / 32768;
 		inptr += 2;
 	}



From mean at mail.berlios.de  Thu Nov 11 18:07:34 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 18:07:34 +0100
Subject: [Avidemux-svn-commit] r6748 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv
Message-ID: <20101111170734.2B58948058B@sheep.berlios.de>

Author: mean
Date: 2010-11-11 18:07:33 +0100 (Thu, 11 Nov 2010)
New Revision: 6748

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp
Log:
[flv] Handle nicely object_end (2.6)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp	2010-11-11 17:06:55 UTC (rev 6747)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp	2010-11-11 17:07:33 UTC (rev 6748)
@@ -127,7 +127,9 @@
             printf("type :%d : ",type);
             switch(type)
             {
-                case AMF_DATA_TYPE_OBJECT_END:break;
+                case AMF_DATA_TYPE_OBJECT_END:
+                                fseek(_fd,endPos,SEEK_SET);
+                                break;
                 case AMF_DATA_TYPE_OBJECT: 
                 {
                         printf("\n");



From mean at mail.berlios.de  Thu Nov 11 18:07:39 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 18:07:39 +0100
Subject: [Avidemux-svn-commit] r6751 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4
Message-ID: <20101111170739.8407948058B@sheep.berlios.de>

Author: mean
Date: 2010-11-11 18:07:39 +0100 (Thu, 11 Nov 2010)
New Revision: 6751

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Indexer.cpp
Log:
[mov] Fix split up with low duration per sample (fixes #111)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Indexer.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Indexer.cpp	2010-11-11 17:07:37 UTC (rev 6750)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Mp4/ADM_mp4Indexer.cpp	2010-11-11 17:07:39 UTC (rev 6751)
@@ -149,7 +149,7 @@
               // Normally they have all the same duration
               if(info->nbStts!=1) printf("WARNING: Same size, different duration\n");
 
-              float sampleDuration,totalDuration=0;
+              double sampleDuration,totalDuration=0;
               
                 sampleDuration=info->SttsC[0];
                 sampleDuration*=1000.*1000.;
@@ -166,6 +166,9 @@
                       // rebuild a new index
                       printf("We have %u chunks but it should be split into \n",info->nbCo);
                       printf("around %u chunks. adjusting..(SzIdentical %u)\n",info->nbCo+max,info->SzIndentical);
+                      printf("info->SttsC[0]=%d\n",(int)info->SttsC[0]);
+                      printf("trackScale=%d\n",(int)trackScale);
+                      printf("Sample duration =%f\n",(float)sampleDuration);
                       uint32_t newNbCo=track->nbIndex+max*2; // *2 is enough, should be.
                       uint32_t w=0;
                       uint32_t one_go;
@@ -176,6 +179,7 @@
                      MP4Index *newindex=new MP4Index[newNbCo];
 
                     int64_t time_increment=(int64_t)((one_go/info->SzIndentical)*sampleDuration);  // Nb sample*duration of one sample
+                    printf("Time increment = %d\n",(int)time_increment);
                     for(i=0;i<track->nbIndex;i++)
                     {
                       uint32_t sz;
@@ -202,7 +206,7 @@
                           // The last one...
                                 newindex[w].offset=track->index[i].offset+part*one_go;
                                 newindex[w].size=sz;
-                                newindex[w].dts=track->index[i].dts+part*time_increment+((time_increment*sz)/one_go); 
+                                newindex[w].dts=track->index[i].dts+part*time_increment; 
                                 newindex[w].pts=ADM_COMPRESSED_NO_PTS;
                                 w++;
                     }



From mean at mail.berlios.de  Thu Nov 11 18:07:41 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 18:07:41 +0100
Subject: [Avidemux-svn-commit] r6752 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv
Message-ID: <20101111170741.BBBC248058B@sheep.berlios.de>

Author: mean
Date: 2010-11-11 18:07:41 +0100 (Thu, 11 Nov 2010)
New Revision: 6752

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp
Log:
[Flv] Fix zapping.flv

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp	2010-11-11 17:07:39 UTC (rev 6751)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp	2010-11-11 17:07:41 UTC (rev 6752)
@@ -367,6 +367,7 @@
     size=read24();
     dts=read24();
     read32(); // ???
+    if(!size) continue;
     uint32_t remaining=size;
     //printf("[FLV] At %08x found type %x size %u pts%u\n",pos,type,size,dts);
     switch(type)



From mean at mail.berlios.de  Thu Nov 11 18:07:38 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 18:07:38 +0100
Subject: [Avidemux-svn-commit] r6750 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad
Message-ID: <20101111170738.2B453480906@sheep.berlios.de>

Author: mean
Date: 2010-11-11 18:07:37 +0100 (Thu, 11 Nov 2010)
New Revision: 6750

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp
Log:
[faad] Cosmetic

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp	2010-11-11 17:07:36 UTC (rev 6749)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_audioDecoders/ADM_ad_faad/ADM_ad_faad.cpp	2010-11-11 17:07:37 UTC (rev 6750)
@@ -180,7 +180,7 @@
 			res=(long int)faacDecInit(_instance,inptr,nbIn,&srate,&chan);
 			if(res>=0)
 			{
-				printf("Faad Inited : rate:%"LU" chan:%"LU" off:%ld\n",srate,chan,res);
+				printf("Faad Inited : rate:%d chan:%d off:%ld\n",(int)srate,(int)chan,res);
 				_inited=1;
 				first=1;
 				head=tail=0;



From mean at mail.berlios.de  Thu Nov 11 18:07:43 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Thu, 11 Nov 2010 18:07:43 +0100
Subject: [Avidemux-svn-commit] r6753 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv
Message-ID: <20101111170743.89CE948058B@sheep.berlios.de>

Author: mean
Date: 2010-11-11 18:07:43 +0100 (Thu, 11 Nov 2010)
New Revision: 6753

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.h
Log:
[Flv] Fix WxH when metadata happens after 1st frame

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp	2010-11-11 17:07:41 UTC (rev 6752)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.cpp	2010-11-11 17:07:43 UTC (rev 6753)
@@ -224,13 +224,14 @@
         while(ftello(_fd)<endPos-4)
         {
             char *s=readFlvString();
-            printf("[FlvType]  String : %s",s);
+            printf("[FlvType]  String : %s ",s);
             
             if(false==parseOneMeta(s,endPos)) goto endit;
         }
     }
 endit:
     fseeko(_fd,endPos,SEEK_SET);
+    updateDimensionWithMeta(videoCodec);
     return 1;
 }
 /**
@@ -410,9 +411,9 @@
             remaining--;
             int frameType=flags>>4;
 
-            int codec=(flags)&0xf;
+            videoCodec=(flags)&0xf;
 
-            if(codec==FLV_CODECID_VP6 || codec==FLV_CODECID_VP6A)
+            if(videoCodec==FLV_CODECID_VP6 || videoCodec==FLV_CODECID_VP6A)
             {
               read8(); // 1 byte of extraData
               remaining--;
@@ -421,10 +422,10 @@
             
             if(firstVideo==true) // first frame..
             {
-                if(!setVideoHeader(codec,&remaining)) return 0;
+                if(!setVideoHeader(videoCodec,&remaining)) return 0;
                 firstVideo=false;
             }
-            if(codec==FLV_CODECID_H264)
+            if(videoCodec==FLV_CODECID_H264)
             {
                 if(true==extraHeader(videoTrack,&remaining,true,&cts)) continue;
                 int64_t sum=cts+dts;
@@ -506,6 +507,29 @@
       \fn setVideoHeader
       \brief Set codec and stuff
 */
+bool flvHeader::updateDimensionWithMeta(uint32_t codec)
+{
+    if(codec==0xFFFF) return false;
+    ADM_info("We got metadata : %d x %d\n",(int)metaWidth,(int)metaHeight,(int)codec);
+    if( metaWidth && metaHeight )
+    {
+        switch(codec)
+        {
+            case FLV_CODECID_VP6A:
+            case FLV_CODECID_H264:
+            case FLV_CODECID_VP6:
+
+                    _video_bih.biHeight=_mainaviheader.dwHeight=metaHeight ;
+                    _video_bih.biWidth=_mainaviheader.dwWidth=metaWidth;
+                    break;
+            default:break;
+        }
+    }
+    return true;
+}
+/**
+    \fn setVideoHeader
+*/
 uint8_t flvHeader::setVideoHeader(uint8_t codec,uint32_t *remaining)
 {
     printf("[FLV] Video Codec:%u\n",codec);
@@ -522,13 +546,9 @@
         MKFLV(VP6A,VP6A);
         default : _videostream.fccHandler=_video_bih.biCompression=fourCC::get((uint8_t *)"XXX");break;
     }
-    if( metaWidth && metaHeight )
-        if( codec==FLV_CODECID_VP6A  || codec==FLV_CODECID_H264 || codec==FLV_CODECID_VP6) 
-        {
-                _video_bih.biHeight=_mainaviheader.dwHeight=metaHeight ;
-                _video_bih.biWidth=_mainaviheader.dwWidth=metaWidth;
-        }
-    if(codec==FLV_CODECID_H263)
+    updateDimensionWithMeta(codec);
+
+    if(codec==FLV_CODECID_H263 && *remaining)
     {
   
       uint32_t pos=ftello(_fd);
@@ -719,7 +739,7 @@
 
  flvHeader::flvHeader( void ) : vidHeader()
 {
-
+    videoCodec=0xFFFF;
     _fd=NULL;
     _filename=NULL;
     videoTrack=NULL;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.h	2010-11-11 17:07:41 UTC (rev 6752)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/Flv/ADM_flv.h	2010-11-11 17:07:43 UTC (rev 6753)
@@ -102,7 +102,7 @@
     ADM_audioStream         *_audioStream;
     ADM_flvAccess           *access;
     /* */
-    uint32_t            metaWidth,metaHeight,metaFps1000;
+    uint32_t            metaWidth,metaHeight,metaFps1000,videoCodec;
 
     uint8_t     read(uint32_t len, uint8_t *where);
     uint8_t     read8(void);
@@ -122,6 +122,7 @@
     void        setProperties(const char *name,float value);
     uint32_t    searchMinimum(void);
     bool        parseOneMeta(const char *key,uint64_t endPos);
+    bool        updateDimensionWithMeta(uint32_t codec);
   public:
 
 



From mean at mail.berlios.de  Sat Nov 13 15:25:58 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 13 Nov 2010 15:25:58 +0100
Subject: [Avidemux-svn-commit] r6755 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20101113142558.1CEFA480F68@sheep.berlios.de>

Author: mean
Date: 2010-11-13 15:25:57 +0100 (Sat, 13 Nov 2010)
New Revision: 6755

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsAudio.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsComputeTimeStamp.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp
Log:
[TS/H264] new indexer, no audio

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsAudio.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsAudio.cpp	2010-11-13 14:25:55 UTC (rev 6754)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsAudio.cpp	2010-11-13 14:25:57 UTC (rev 6755)
@@ -75,6 +75,7 @@
 */
 uint64_t  ADM_tsAccess::getDurationInUs(void)
 {
+    if(!seekPoints.size()) return 0;
     // Take last seek point; should be accurate enough
     return timeConvert(seekPoints[seekPoints.size()-1].dts);
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsComputeTimeStamp.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsComputeTimeStamp.cpp	2010-11-13 14:25:55 UTC (rev 6754)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsComputeTimeStamp.cpp	2010-11-13 14:25:57 UTC (rev 6755)
@@ -48,6 +48,7 @@
         for(int i=0;i<listOfAudioTracks.size();i++)
         {
             vector          <ADM_mpgAudioSeekPoint > *seekPoints=&(listOfAudioTracks[i]->access->seekPoints);
+            if(!((*seekPoints).size())) continue;
             uint64_t secondDts=(*seekPoints)[0].dts;
             uint64_t secondSize=(*seekPoints)[0].size;
             if(secondSize && listOfAudioTracks[i]->header.byterate)
@@ -100,6 +101,7 @@
         }
         for(int i=0;i<listOfAudioTracks.size();i++)
         {
+            if(!listOfAudioTracks[i]->access->seekPoints.size()) continue;
             uint64_t a=listOfAudioTracks[i]->access->seekPoints[0].dts;
             if(a<startDts) startDts=a;
         }

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-11-13 14:25:55 UTC (rev 6754)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-11-13 14:25:57 UTC (rev 6755)
@@ -16,6 +16,31 @@
  *                                                                         *
  ***************************************************************************/
 #include "ADM_tsIndex.h"
+
+static const uint32_t FPS[16]={
+                0,                      // 0
+                23976,          // 1 (23.976 fps) - FILM
+                24000,          // 2 (24.000 fps)
+                25000,          // 3 (25.000 fps) - PAL
+                29970,          // 4 (29.970 fps) - NTSC
+                30000,          // 5 (30.000 fps)
+                50000,          // 6 (50.000 fps) - PAL noninterlaced
+                59940,          // 7 (59.940 fps) - NTSC noninterlaced
+                60000,          // 8 (60.000 fps)
+                0,                      // 9
+                0,                      // 10
+                0,                      // 11
+                0,                      // 12
+                0,                      // 13
+                0,                      // 14
+                0                       // 15
+        };
+static const uint32_t  VC1_ar[16][2] = {  // From VLC
+                        { 0, 0}, { 1, 1}, {12,11}, {10,11}, {16,11}, {40,33},
+                        {24,11}, {20,11}, {32,11}, {80,33}, {18,11}, {15,11},
+                        {64,33}, {160,99},{ 0, 0}, { 0, 0}};
+
+
 /**
       \fn TsIndexer 
       \brief main indexing loop for mpeg2 payload

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h	2010-11-13 14:25:55 UTC (rev 6754)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h	2010-11-13 14:25:57 UTC (rev 6755)
@@ -46,30 +46,6 @@
 #endif
 static const char Structure[4]={'X','T','B','F'}; // X Top Bottom Frame
 static const char Type[5]={'X','I','P','B','D'};
-
-static const uint32_t FPS[16]={
-                0,                      // 0
-                23976,          // 1 (23.976 fps) - FILM
-                24000,          // 2 (24.000 fps)
-                25000,          // 3 (25.000 fps) - PAL
-                29970,          // 4 (29.970 fps) - NTSC
-                30000,          // 5 (30.000 fps)
-                50000,          // 6 (50.000 fps) - PAL noninterlaced
-                59940,          // 7 (59.940 fps) - NTSC noninterlaced
-                60000,          // 8 (60.000 fps)
-                0,                      // 9
-                0,                      // 10
-                0,                      // 11
-                0,                      // 12
-                0,                      // 13
-                0,                      // 14
-                0                       // 15
-        };
-static const uint32_t  VC1_ar[16][2] = {  // From VLC
-                        { 0, 0}, { 1, 1}, {12,11}, {10,11}, {16,11}, {40,33},
-                        {24,11}, {20,11}, {32,11}, {80,33}, {18,11}, {15,11},
-                        {64,33}, {160,99},{ 0, 0}, { 0, 0}};
-
 #define VC1_MAX_SEQ_SIZE 64
 class TSVideo
 {
@@ -126,9 +102,28 @@
         VC1Context() {advanced=false;interlaced=false;interpolate=false;}
 
 };
+/**
+    \class H264Unit
+*/
+class H264Unit
+{
+public:
+    int             unitType;
+    dmxPacketInfo   packetInfo;
+    uint64_t        consumedSoFar;
+    uint32_t        overRead;
+    int             imageType;
+    pictureStructure imageStructure;
+    uint32_t        recoveryCount;
+                    H264Unit() {memset(this,0,sizeof(*this));recoveryCount=0xff;imageStructure=pictureFrame;}
+};
+enum
+{
+    unitTypeSei=1,
+    unitTypePic=2,
+    unitTypeSps=3
+};
 
-
-
 /**
     \class TsIndexer
 */
@@ -151,6 +146,9 @@
         bool                    decodeSEI(uint32_t nalSize, uint8_t *org,uint32_t *recoveryLength,pictureStructure *nextpicstruct);
         bool                    decodeVC1Seq(tsGetBits &bits,TSVideo &video);
         bool                    decodeVC1Pic(tsGetBits &bits,uint32_t &frameType,uint32_t &frameStructure);
+        // H264
+        bool                    addUnit(indexerData &data,int unitType,const H264Unit &unit,uint32_t overRead);
+        bool                    dumpUnits(indexerData &data,uint64_t nextConsumed);
 public:
                 TsIndexer(listOfTsAudioTracks *tr);
                 ~TsIndexer();

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp	2010-11-13 14:25:55 UTC (rev 6754)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp	2010-11-13 14:25:57 UTC (rev 6755)
@@ -17,7 +17,88 @@
  ***************************************************************************/
 #include "ADM_tsIndex.h"
 
+static vector <H264Unit> listOfUnits;
 /**
+    \fn dumpUnits
+*/
+bool TsIndexer::dumpUnits(indexerData &data,uint64_t nextConsumed)
+{
+        // if it contain a SPS or a intra/idr, we start a new line
+        bool mustFlush=false;
+        int n=listOfUnits.size();
+        int picIndex=0;
+        H264Unit *unit=&(listOfUnits[0]);
+        pictureStructure pictStruct=pictureFrame;
+        
+        // if I, IDR or SPS we start a new line
+        for(int i=0;i<n;i++)
+        {
+            switch(listOfUnits[i].unitType)
+            {
+                case unitTypeSps: mustFlush=true;;break;
+                case unitTypePic: 
+                            picIndex=i;
+                            if(listOfUnits[i].imageType==1 || listOfUnits[i].imageType==4)
+                            mustFlush=true;
+                            break;
+                case unitTypeSei:
+                            pictStruct=listOfUnits[i].imageStructure;
+                            break;
+                default:
+                        ADM_assert(0);
+                        break;
+            }
+        }
+        dmxPacketInfo *pic=&(listOfUnits[picIndex].packetInfo);
+        dmxPacketInfo *p=&(unit->packetInfo);
+        H264Unit      *picUnit=&(listOfUnits[picIndex]);
+        if(mustFlush) 
+        {
+            data.beginPts=pic->pts;
+            data.beginDts=pic->dts;
+            // start a new line
+            qfprintf(index,"\nVideo at:%08"LLX":%04"LX" Pts:%08"LLD":%08"LLD" ",
+                        p->startAt,p->offset-unit->overRead,pic->pts,pic->dts);
+        }
+       
+        
+            int64_t deltaPts,deltaDts;
+
+            if(data.beginPts==-1 || pic->pts==-1) deltaPts=-1;
+                else deltaPts=pic->pts-data.beginPts;
+
+            if(data.beginDts==-1 || pic->dts==-1) deltaDts=-1;
+                else deltaDts=pic->dts-data.beginDts;            
+
+
+            qfprintf(index," %c%c:%06"LX":%"LLD":%"LLD,
+                                    Type[picUnit->imageType],
+                                    Structure[pictStruct&3],
+                                    nextConsumed-beginConsuming,
+                                    deltaPts,deltaDts);
+        beginConsuming=nextConsumed;
+        listOfUnits.clear();
+        return true;
+}
+/**
+    \fn addUnit
+*/
+bool TsIndexer::addUnit(indexerData &data,int unitType2,const H264Unit &unit,uint32_t overRead)
+{
+        H264Unit myUnit=unit;
+        myUnit.unitType=unitType2;
+        myUnit.overRead=overRead;
+        int n=listOfUnits.size();
+        if(n)
+            if(listOfUnits[n-1].unitType==unitTypePic)
+            {
+                dumpUnits(data,myUnit.consumedSoFar-overRead);
+            }
+        listOfUnits.push_back(myUnit);
+        return true;
+}
+
+/**
         \fn decodeSEI
         \brief decode SEI to get short ref I
         @param recoveryLength # of recovery frame
@@ -95,16 +176,20 @@
 */  
 bool TsIndexer::runH264(const char *file,ADM_TS_TRACK *videoTrac)
 {
-bool    pic_started=false;
+bool    decodingImage=false;
 bool    seq_found=false;
+bool    firstSps=true;
 
 TSVideo video;
 indexerData  data;    
-dmxPacketInfo info;
+dmxPacketInfo tmpInfo;
 TS_PESpacket SEI_nal(0);
 bool result=false;
-uint32_t recoveryCount=0xff;
+H264Unit thisUnit;
 
+    beginConsuming=0;
+    listOfUnits.clear();
+
     printf("Starting H264 indexer\n");
     if(!videoTrac) return false;
     if(videoTrac[0].trackType!=ADM_TS_H264)
@@ -116,7 +201,6 @@
 
     memset(&data,0,sizeof(data));
     data.picStructure=pictureFrame;
-    pictureStructure nextPicStruct=pictureFrame;
     string indexName=string(file);
     indexName=indexName+string(".idx2");
     index=qfopen(indexName,(const char*)"wt");
@@ -151,7 +235,7 @@
           uint8_t buffer[60] ; // should be enough
           uint32_t xA,xR;
           // Get info
-          pkt->getInfo(&info);
+          pkt->getInfo(&tmpInfo);
           pkt->read(SPS_READ_AHEAD,buffer);
           if (extractSPSInfo(buffer, SPS_READ_AHEAD,&spsInfo))
           {
@@ -167,17 +251,17 @@
               writeAudio();
               qfprintf(index,"[Data]");
               // Rewind
-              pkt->seek(info.startAt,info.offset-5);
+              pkt->seek(tmpInfo.startAt,tmpInfo.offset-5);
               break;              
           };
       }
       
         if(!seq_found) goto the_end;
-        data.state=idx_startAtImage;
+        
+        decodingImage=false;
     //******************
     // 2 Index
     //******************
-
       while(1)
       {
         int startCode=pkt->findStartCode();
@@ -198,7 +282,7 @@
         aprintf("[%02x] Nal :0x%x,ref=%d,lastRef=%d at : %d \n",fullStartCode,startCode,ref,lastRefIdc,pkt->getConsumed()-beginConsuming);
         
           // Ignore multiple chunk of the same pic
-          if((startCode==NAL_NON_IDR || startCode==NAL_IDR)&&pic_started )  //&& ref==lastRefIdc) 
+          if((startCode==NAL_NON_IDR || startCode==NAL_IDR)&&decodingImage )
           {
             aprintf("Still capturing, ignore\n");
             continue;
@@ -209,14 +293,11 @@
                   case NAL_AU_DELIMITER:
                         {
                           aprintf("AU DELIMITER\n");
-                          pic_started = false;
+                          decodingImage = false;
                         }
                           break;
                   case NAL_SEI:
-                    {
-#if 0
-                        printf(">>SEI\n");
-#else
+                        {
                         // Load the whole NAL
                             SEI_nal.empty();
                             uint32_t code=0xffff+0xffff0000;
@@ -230,36 +311,31 @@
                             aprintf("[SEI] Nal size :%d\n",SEI_nal.payloadSize);
                             if(SEI_nal.payloadSize>=7)
                                 decodeSEI(SEI_nal.payloadSize-4,
-                                    SEI_nal.payload,&recoveryCount,&nextPicStruct);
-                            else printf("[SEI] Too short size+4=%d\n",*(SEI_nal.payload));
+                                    SEI_nal.payload,&(thisUnit.recoveryCount),&(thisUnit.imageStructure));
+                            else 
+                                    printf("[SEI] Too short size+4=%d\n",*(SEI_nal.payload));
                             startCode=pkt->readi8();
-
-                              if( data.state!=idx_startAtGopOrSeq)
-                              {
-                                  pic_started = false;
-                                  pkt->getInfo(&info);
-                                  data.frameType=2;
-                                  Mark(&data,&info,5+SEI_nal.payloadSize+1);
-                                  data.state=idx_startAtGopOrSeq;
-                                  recoveryCount=0xff;
-                               }
+                            decodingImage=false;
+                            pkt->getInfo(&thisUnit.packetInfo);
+                            thisUnit.consumedSoFar=pkt->getConsumed();
+                            addUnit(data,unitTypeSei,thisUnit,5+SEI_nal.payloadSize+1);                            
                             goto resume;
-#endif
-                        }
+                            }
                             break;
                   
                   case NAL_SPS:
-                              pic_started = false;
-                              aprintf("Sps \n");
-                              pkt->getInfo(&info);
-                              data.frameType=1;
-                              Mark(&data,&info,5);
-                              data.state=idx_startAtGopOrSeq;
-                              recoveryCount=0xff;
+                                decodingImage=false;
+                                pkt->getInfo(&thisUnit.packetInfo);
+                                if(firstSps)
+                                {
+                                    pkt->setConsumed(5); // reset consume counter
+                                    firstSps=false;
+                                }
+                                thisUnit.consumedSoFar=pkt->getConsumed();
+                                addUnit(data,unitTypeSps,thisUnit,5);
                           break;
 
                   case NAL_IDR:
-                    //zprintf("KOWABOUNGA\n");
                   case NAL_NON_IDR:
                     {
 #define NON_IDR_PRE_READ 8
@@ -287,29 +363,28 @@
                         switch(slice_type)
                         {
 
-                            case 0 : data.frameType=2;break; // P
-                            case 1 : data.frameType=3;break; // B
-                            case 2 : data.frameType=1;break; // I
-                            default : data.frameType=2;break; // SP/SI
+                            case 0 : thisUnit.imageType=2;break; // P
+                            case 1 : thisUnit.imageType=3;break; // B
+                            case 2 : thisUnit.imageType=1;break; // I
+                            default : thisUnit.imageType=2;break; // SP/SI
                         }
-                      if(startCode==NAL_IDR) data.frameType=4; // IDR
-                      aprintf("[>>>>>>>>] Pic Type %"LU" Recovery %"LU"\n",data.frameType,recoveryCount);
-                      if(data.frameType==1 && !recoveryCount) data.frameType=4; //I  + Recovery=0 = IDR!
-                      data.picStructure=nextPicStruct;
-                      if(data.state==idx_startAtGopOrSeq) 
-                      {
-                              currentFrameType=data.frameType;;
-                              updateUI();
-                              
-                      }else
-                      {
-                            pkt->getInfo(&info);
-                            Mark(&data,&info,5+NON_IDR_PRE_READ);
-                       }
-                      data.state=idx_startAtImage;
+                      if(startCode==NAL_IDR) thisUnit.imageType=4; // IDR
+                      aprintf("[>>>>>>>>] Pic Type %"LU" Recovery %"LU"\n",thisUnit.imageType,recoveryCount);
+                      if(thisUnit.imageType==1 && !thisUnit.recoveryCount) 
+                                thisUnit.imageType=4; //I  + Recovery=0 = IDR!
+
                       data.nbPics++;
-                      pic_started = true;
-                      recoveryCount=0xff;
+
+                      
+
+                      decodingImage=true;
+                      pkt->getInfo(&thisUnit.packetInfo);
+                      thisUnit.consumedSoFar=pkt->getConsumed();
+
+                      addUnit(data,unitTypePic,thisUnit,5+NON_IDR_PRE_READ);
+                        // reset to default
+                      thisUnit.imageStructure=pictureFrame;
+                      thisUnit.recoveryCount=0xff;
                     }
                   
                     break;
@@ -320,7 +395,7 @@
       result=true;
 the_end:
         printf("\n");
-        Mark(&data,&info,0);
+#warning TODO PURGE    
         qfprintf(index,"\n[End]\n");
         qfclose(index);
         index=NULL;
@@ -330,6 +405,7 @@
         return result; 
 }
 
+
 /********************************************************************************************/
 /********************************************************************************************/
 /********************************************************************************************/



From mean at mail.berlios.de  Sat Nov 13 15:25:55 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 13 Nov 2010 15:25:55 +0100
Subject: [Avidemux-svn-commit] r6754 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20101113142556.35514480F56@sheep.berlios.de>

Author: mean
Date: 2010-11-13 15:25:55 +0100 (Sat, 13 Nov 2010)
New Revision: 6754

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/CMakeLists.txt
Log:
[Ts/H264] Put h264 in its own file

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-11-11 17:07:43 UTC (rev 6753)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-11-13 14:25:55 UTC (rev 6754)
@@ -15,169 +15,8 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-
-#include "ADM_cpp.h"
-using std::string;
-#include "ADM_default.h"
-#include "ADM_demuxerInternal.h"
-#include "fourcc.h"
-
-#include "dmxTSPacket.h"
-
-#include "avidemutils.h"
-#include "ADM_quota.h"
-#include "ADM_tsAudioProbe.h"
-#include "DIA_working.h"
-#include "ADM_tsPatPmt.h"
-#include "ADM_videoInfoExtractor.h"
-#include "ADM_h264_tag.h"
-#include "ADM_clock.h"
-#include "ADM_indexFile.h"
-#include "ADM_getbits.h"
-#include "ADM_tsGetBits.h"
-#include "ADM_coreUtils.h"
-
-#if (1) || !defined(ADM_DEBUG)
-#define aprintf(...) {}
-#else
-#define aprintf printf
-#endif
-static const char Structure[4]={'X','T','B','F'}; // X Top Bottom Frame
-static const char Type[5]={'X','I','P','B','D'};
-
-static const uint32_t FPS[16]={
-                0,                      // 0
-                23976,          // 1 (23.976 fps) - FILM
-                24000,          // 2 (24.000 fps)
-                25000,          // 3 (25.000 fps) - PAL
-                29970,          // 4 (29.970 fps) - NTSC
-                30000,          // 5 (30.000 fps)
-                50000,          // 6 (50.000 fps) - PAL noninterlaced
-                59940,          // 7 (59.940 fps) - NTSC noninterlaced
-                60000,          // 8 (60.000 fps)
-                0,                      // 9
-                0,                      // 10
-                0,                      // 11
-                0,                      // 12
-                0,                      // 13
-                0,                      // 14
-                0                       // 15
-        };
-static const uint32_t  VC1_ar[16][2] = {  // From VLC
-                        { 0, 0}, { 1, 1}, {12,11}, {10,11}, {16,11}, {40,33},
-                        {24,11}, {20,11}, {32,11}, {80,33}, {18,11}, {15,11},
-                        {64,33}, {160,99},{ 0, 0}, { 0, 0}};
-
-#define VC1_MAX_SEQ_SIZE 64
-class TSVideo
-{
-public:
-    TSVideo(void) {w=h=fps=interlaced=ar=pid=frameCount=fieldCount=0;extraDataLength=0;}
-    uint32_t w;
-    uint32_t h;
-    uint32_t fps;
-    uint32_t interlaced;
-    uint32_t ar;
-    uint32_t pid;
-    uint32_t frameCount;
-    uint32_t fieldCount;
-    uint32_t extraDataLength;
-    uint8_t  extraData[VC1_MAX_SEQ_SIZE];
-};
-
-typedef enum
-{
-    idx_startAtImage,
-    idx_startAtGopOrSeq
-}indexerState;
-
-typedef enum
-{
-    pictureFrame=3,
-    pictureTopField=1, 
-    pictureBottomField=2
-}pictureStructure;
-
-typedef struct
-{
-    uint64_t pts,dts; //startAt;
-    //uint32_t offset;
-    uint32_t frameType;
-    pictureStructure picStructure;
-    uint32_t nbPics;
-    indexerState state;
-    tsPacketLinear *pkt;
-    int32_t        nextOffset;
-    uint64_t beginPts,beginDts;
-    uint64_t prevPts,prevDts;
-}indexerData;
-
+#include "ADM_tsIndex.h"
 /**
-    \class VC1Context
-*/
-class VC1Context
-{
-public:
-        bool advanced;
-        bool interlaced;
-        bool interpolate;
-        VC1Context() {advanced=false;interlaced=false;interpolate=false;}
-
-};
-
-
-
-/**
-    \class TsIndexer
-*/
-class TsIndexer
-{
-protected:
-        uint32_t        currentFrameType;
-        uint32_t        beginConsuming;
-        indexerState    currentIndexState;
-        uint64_t        fullSize;
-        Clock           ticktock;
-        VC1Context      vc1Context;
-protected:
-        FILE                    *index;
-        tsPacketLinearTracker   *pkt;
-        listOfTsAudioTracks     *audioTracks;
-        DIA_workingBase         *ui;
-        ADM_SPSInfo             spsInfo;
-        void                    updateUI(void);
-        bool                    decodeSEI(uint32_t nalSize, uint8_t *org,uint32_t *recoveryLength,pictureStructure *nextpicstruct);
-        bool                    decodeVC1Seq(tsGetBits &bits,TSVideo &video);
-        bool                    decodeVC1Pic(tsGetBits &bits,uint32_t &frameType,uint32_t &frameStructure);
-public:
-                TsIndexer(listOfTsAudioTracks *tr);
-                ~TsIndexer();
-        bool    runMpeg2(const char *file,ADM_TS_TRACK *videoTrac);
-        bool    runH264(const char *file,ADM_TS_TRACK *videoTrac);
-        bool    runVC1(const char *file,ADM_TS_TRACK *videoTrac);
-        bool    writeVideo(TSVideo *video,ADM_TS_TRACK_TYPE trkType);
-        bool    writeAudio(void);
-        bool    writeSystem(const char *filename,bool append);
-        bool    Mark(indexerData *data,dmxPacketInfo *s,uint32_t overRead);
-        bool    updatePicStructure(TSVideo &video,indexerData &idata, const uint32_t t)
-                        {
-                                            switch(t)
-                                            {
-                                                case 3: video.frameCount++;
-                                                        idata.picStructure=pictureFrame;
-                                                        break;
-                                                case 1:  idata.picStructure=pictureTopField;
-                                                         video.fieldCount++;
-                                                         break;
-                                                case 2:  idata.picStructure=pictureBottomField;
-                                                         video.fieldCount++;
-                                                         break;
-                                                default: ADM_warning("frame type 0 met, this is illegal\n");
-                                            }
-                                            return true;
-                        }
-};
-/**
       \fn TsIndexer 
       \brief main indexing loop for mpeg2 payload
 */
@@ -273,319 +112,6 @@
         ui->update( (uint32_t)pos);
 }
 /**
-        \fn decodeSEI
-        \brief decode SEI to get short ref I
-        @param recoveryLength # of recovery frame
-        \return true if recovery found
-*/
-bool TsIndexer::decodeSEI(uint32_t nalSize, uint8_t *org,uint32_t *recoveryLength,
-                pictureStructure *picStruct)
-{
-    
-    uint8_t *payload=(uint8_t *)alloca(nalSize+16);
-    bool r=false;
-    nalSize=ADM_unescapeH264(nalSize,org,payload);
-    uint8_t *tail=payload+nalSize;
-    *picStruct=pictureFrame; // frame
-    while( payload<tail-2)
-    {
-                uint32_t sei_type=0,sei_size=0;
-                while(payload[0]==0xff) {sei_type+=0xff;payload++;};
-                sei_type+=payload[0];payload++;
-                while(payload[0]==0xff) {sei_size+=0xff;payload++;};
-                sei_size+=payload[0];payload++;
-                aprintf("  [SEI] Type : 0x%x size:%d\n",sei_type,sei_size);
-                switch(sei_type) // Recovery point
-                {
-
-                       case 1:
-                            {
-                                if(spsInfo.hasStructInfo)
-                                {
-                                    getBits bits(sei_size,payload);
-                                    payload+=sei_size;
-                                    if(spsInfo.CpbDpbToSkip)
-                                    {
-                                            bits.get(spsInfo.CpbDpbToSkip);
-                                    }
-                                    //printf("Consumed: %d,\n",bits.getConsumedBits());
-                                    int pic=bits.get(4);
-                                    aprintf("Pic struct: %d,\n",pic);
-                                    switch(pic) 
-                                    {
-                                        case 0: *picStruct=pictureFrame; break;
-                                        case 3:
-                                        case 4: *picStruct=pictureFrame;
-                                        case 1: *picStruct=pictureTopField;break;
-                                        case 2: *picStruct=pictureBottomField;break;
-                                        default:*picStruct=pictureFrame;
-                                    }
-                                    
-                                }else
-                                        payload+=sei_size;
-                            }
-                            break;
-
-                       case 6:
-                        {
-                            getBits bits(sei_size,payload);
-                            payload+=sei_size;
-                            *recoveryLength=bits.getUEG();
-                            aprintf("[SEI] Recovery :%"LU"\n",*recoveryLength);
-                            r=true;
-                            break;
-                        }
-                        default:
-                            payload+=sei_size;
-                            break;
-                }
-    }
-    if(payload+1<tail) ADM_warning("Bytes left in SEI %d\n",(int)(tail-payload));
-    return r;
-}
-
-/**
-    \fn runH264
-    \brief Index H264 stream
-*/  
-bool TsIndexer::runH264(const char *file,ADM_TS_TRACK *videoTrac)
-{
-bool    pic_started=false;
-bool    seq_found=false;
-
-TSVideo video;
-indexerData  data;    
-dmxPacketInfo info;
-TS_PESpacket SEI_nal(0);
-bool result=false;
-uint32_t recoveryCount=0xff;
-
-    printf("Starting H264 indexer\n");
-    if(!videoTrac) return false;
-    if(videoTrac[0].trackType!=ADM_TS_H264)
-    {
-        printf("[Ts Indexer] Only H264 video supported\n");
-        return false;
-    }
-    video.pid=videoTrac[0].trackPid;
-
-    memset(&data,0,sizeof(data));
-    data.picStructure=pictureFrame;
-    pictureStructure nextPicStruct=pictureFrame;
-    string indexName=string(file);
-    indexName=indexName+string(".idx2");
-    index=qfopen(indexName,(const char*)"wt");
-
-    if(!index)
-    {
-        printf("[PsIndex] Cannot create %s\n",indexName.c_str());
-        return false;
-    }
-
-    writeSystem(file,true);
-    pkt=new tsPacketLinearTracker(videoTrac->trackPid, audioTracks);
-
-    FP_TYPE append=FP_APPEND;
-    pkt->open(file,append);
-    data.pkt=pkt;
-    fullSize=pkt->getSize();
-    int lastRefIdc=0;
-    //******************
-    // 1 search SPS
-    //******************
-#define SPS_READ_AHEAD 32
-      while(1)
-      {
-        int startCode=pkt->findStartCode();
-
-        if(startCode&0x80) continue; // Marker missing
-        startCode&=0x1f;
-        if(startCode!=NAL_SPS) continue;
-
-          // Got SPS!
-          uint8_t buffer[60] ; // should be enough
-          uint32_t xA,xR;
-          // Get info
-          pkt->getInfo(&info);
-          pkt->read(SPS_READ_AHEAD,buffer);
-          if (extractSPSInfo(buffer, SPS_READ_AHEAD,&spsInfo))
-          {
-              
-              printf("[TsIndexer] Found video %"LU"x%"LU", fps=%"LU"\n",video.w,video.h,video.fps);
-              seq_found=1;
-              video.w=spsInfo.width;
-              video.h=spsInfo.height;
-              video.fps=spsInfo.fps1000;
-              xA=spsInfo.darNum;
-              xR=spsInfo.darDen;
-              writeVideo(&video,ADM_TS_H264);
-              writeAudio();
-              qfprintf(index,"[Data]");
-              // Rewind
-              pkt->seek(info.startAt,info.offset-5);
-              break;              
-          };
-      }
-      
-        if(!seq_found) goto the_end;
-        data.state=idx_startAtImage;
-    //******************
-    // 2 Index
-    //******************
-
-      while(1)
-      {
-        int startCode=pkt->findStartCode();
-resume:
-        if(!pkt->stillOk()) break;
-
-//  1:0 2:Nal ref idc 5:Nal Type
-        if(startCode&0x80) 
-        {
-            printf("[Ts] Nal Marker missing:%x\n",startCode);
-            continue; // Marker missing
-        }
-        int fullStartCode=startCode;
-        int ref=(startCode>>5)&3;
-
-        startCode&=0x1f; // Ignore nal ref IDR
-        
-        aprintf("[%02x] Nal :0x%x,ref=%d,lastRef=%d at : %d \n",fullStartCode,startCode,ref,lastRefIdc,pkt->getConsumed()-beginConsuming);
-        
-          // Ignore multiple chunk of the same pic
-          if((startCode==NAL_NON_IDR || startCode==NAL_IDR)&&pic_started )  //&& ref==lastRefIdc) 
-          {
-            aprintf("Still capturing, ignore\n");
-            continue;
-          }
-                
-          switch(startCode)
-                  {
-                  case NAL_AU_DELIMITER:
-                        {
-                          aprintf("AU DELIMITER\n");
-                          pic_started = false;
-                        }
-                          break;
-                  case NAL_SEI:
-                    {
-#if 0
-                        printf(">>SEI\n");
-#else
-                        // Load the whole NAL
-                            SEI_nal.empty();
-                            uint32_t code=0xffff+0xffff0000;
-                            while((code!=1) && pkt->stillOk())
-                            {
-                                uint8_t r=pkt->readi8();
-                                code=(code<<8)+r;
-                                SEI_nal.pushByte(r);
-                            }
-                            if(!pkt->stillOk()) goto resume;
-                            aprintf("[SEI] Nal size :%d\n",SEI_nal.payloadSize);
-                            if(SEI_nal.payloadSize>=7)
-                                decodeSEI(SEI_nal.payloadSize-4,
-                                    SEI_nal.payload,&recoveryCount,&nextPicStruct);
-                            else printf("[SEI] Too short size+4=%d\n",*(SEI_nal.payload));
-                            startCode=pkt->readi8();
-
-                              if( data.state!=idx_startAtGopOrSeq)
-                              {
-                                  pic_started = false;
-                                  pkt->getInfo(&info);
-                                  data.frameType=2;
-                                  Mark(&data,&info,5+SEI_nal.payloadSize+1);
-                                  data.state=idx_startAtGopOrSeq;
-                                  recoveryCount=0xff;
-                               }
-                            goto resume;
-#endif
-                        }
-                            break;
-                  
-                  case NAL_SPS:
-                              pic_started = false;
-                              aprintf("Sps \n");
-                              pkt->getInfo(&info);
-                              data.frameType=1;
-                              Mark(&data,&info,5);
-                              data.state=idx_startAtGopOrSeq;
-                              recoveryCount=0xff;
-                          break;
-
-                  case NAL_IDR:
-                    //zprintf("KOWABOUNGA\n");
-                  case NAL_NON_IDR:
-                    {
-#define NON_IDR_PRE_READ 8
-                      aprintf("Pic start last ref:%d cur ref:%d nb=%d\n",lastRefIdc,ref,data.nbPics);
-                      lastRefIdc=ref;
-                        
-                      uint8_t bufr[NON_IDR_PRE_READ+4];
-                      uint8_t header[NON_IDR_PRE_READ+4];
-                      
-                   
-                        pkt->read(NON_IDR_PRE_READ,bufr);
-                        // unescape...
-                        ADM_unescapeH264(NON_IDR_PRE_READ,bufr,header);
-                        //
-                        getBits bits(NON_IDR_PRE_READ,header);
-                        int first_mb_in_slice,slice_type;
-
-                        first_mb_in_slice= bits.getUEG();
-                        slice_type= bits.getUEG31();
-                        if(slice_type>9) 
-                        {
-                            printf("[TsIndexer] Bad slice type\n");
-                        }
-                        if(slice_type>4) slice_type-=5;
-                        switch(slice_type)
-                        {
-
-                            case 0 : data.frameType=2;break; // P
-                            case 1 : data.frameType=3;break; // B
-                            case 2 : data.frameType=1;break; // I
-                            default : data.frameType=2;break; // SP/SI
-                        }
-                      if(startCode==NAL_IDR) data.frameType=4; // IDR
-                      aprintf("[>>>>>>>>] Pic Type %"LU" Recovery %"LU"\n",data.frameType,recoveryCount);
-                      if(data.frameType==1 && !recoveryCount) data.frameType=4; //I  + Recovery=0 = IDR!
-                      data.picStructure=nextPicStruct;
-                      if(data.state==idx_startAtGopOrSeq) 
-                      {
-                              currentFrameType=data.frameType;;
-                              updateUI();
-                              
-                      }else
-                      {
-                            pkt->getInfo(&info);
-                            Mark(&data,&info,5+NON_IDR_PRE_READ);
-                       }
-                      data.state=idx_startAtImage;
-                      data.nbPics++;
-                      pic_started = true;
-                      recoveryCount=0xff;
-                    }
-                  
-                    break;
-                  default:
-                      break;
-          }
-      } // End while
-      result=true;
-the_end:
-        printf("\n");
-        Mark(&data,&info,0);
-        qfprintf(index,"\n[End]\n");
-        qfclose(index);
-        index=NULL;
-        audioTracks=NULL;
-        delete pkt;
-        pkt=NULL;
-        return result; 
-}
-//***********************************************************************
-/**
     \fn runMpeg2
 */  
 bool TsIndexer::runMpeg2(const char *file,ADM_TS_TRACK *videoTrac)

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h	2010-11-13 14:25:55 UTC (rev 6754)
@@ -0,0 +1,189 @@
+/***************************************************************************
+                        Mpeg2 in PS indexer                                            
+                             
+    VC1: /!\ Escaping not done (yet)
+
+    copyright            : (C) 2005/2009 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_TS_INDEX_H
+#define ADM_TS_INDEX_H
+
+#include "ADM_cpp.h"
+using std::string;
+#include "ADM_default.h"
+#include "ADM_demuxerInternal.h"
+#include "fourcc.h"
+
+#include "dmxTSPacket.h"
+
+#include "avidemutils.h"
+#include "ADM_quota.h"
+#include "ADM_tsAudioProbe.h"
+#include "DIA_working.h"
+#include "ADM_tsPatPmt.h"
+#include "ADM_videoInfoExtractor.h"
+#include "ADM_h264_tag.h"
+#include "ADM_clock.h"
+#include "ADM_indexFile.h"
+#include "ADM_getbits.h"
+#include "ADM_tsGetBits.h"
+#include "ADM_coreUtils.h"
+
+#if (1) || !defined(ADM_DEBUG)
+#define aprintf(...) {}
+#else
+#define aprintf printf
+#endif
+static const char Structure[4]={'X','T','B','F'}; // X Top Bottom Frame
+static const char Type[5]={'X','I','P','B','D'};
+
+static const uint32_t FPS[16]={
+                0,                      // 0
+                23976,          // 1 (23.976 fps) - FILM
+                24000,          // 2 (24.000 fps)
+                25000,          // 3 (25.000 fps) - PAL
+                29970,          // 4 (29.970 fps) - NTSC
+                30000,          // 5 (30.000 fps)
+                50000,          // 6 (50.000 fps) - PAL noninterlaced
+                59940,          // 7 (59.940 fps) - NTSC noninterlaced
+                60000,          // 8 (60.000 fps)
+                0,                      // 9
+                0,                      // 10
+                0,                      // 11
+                0,                      // 12
+                0,                      // 13
+                0,                      // 14
+                0                       // 15
+        };
+static const uint32_t  VC1_ar[16][2] = {  // From VLC
+                        { 0, 0}, { 1, 1}, {12,11}, {10,11}, {16,11}, {40,33},
+                        {24,11}, {20,11}, {32,11}, {80,33}, {18,11}, {15,11},
+                        {64,33}, {160,99},{ 0, 0}, { 0, 0}};
+
+#define VC1_MAX_SEQ_SIZE 64
+class TSVideo
+{
+public:
+    TSVideo(void) {w=h=fps=interlaced=ar=pid=frameCount=fieldCount=0;extraDataLength=0;}
+    uint32_t w;
+    uint32_t h;
+    uint32_t fps;
+    uint32_t interlaced;
+    uint32_t ar;
+    uint32_t pid;
+    uint32_t frameCount;
+    uint32_t fieldCount;
+    uint32_t extraDataLength;
+    uint8_t  extraData[VC1_MAX_SEQ_SIZE];
+};
+
+typedef enum
+{
+    idx_startAtImage,
+    idx_startAtGopOrSeq
+}indexerState;
+
+typedef enum
+{
+    pictureFrame=3,
+    pictureTopField=1, 
+    pictureBottomField=2
+}pictureStructure;
+
+typedef struct
+{
+    uint64_t pts,dts; //startAt;
+    //uint32_t offset;
+    uint32_t frameType;
+    pictureStructure picStructure;
+    uint32_t nbPics;
+    indexerState state;
+    tsPacketLinear *pkt;
+    int32_t        nextOffset;
+    uint64_t beginPts,beginDts;
+    uint64_t prevPts,prevDts;
+}indexerData;
+
+/**
+    \class VC1Context
+*/
+class VC1Context
+{
+public:
+        bool advanced;
+        bool interlaced;
+        bool interpolate;
+        VC1Context() {advanced=false;interlaced=false;interpolate=false;}
+
+};
+
+
+
+/**
+    \class TsIndexer
+*/
+class TsIndexer
+{
+protected:
+        uint32_t        currentFrameType;
+        uint32_t        beginConsuming;
+        indexerState    currentIndexState;
+        uint64_t        fullSize;
+        Clock           ticktock;
+        VC1Context      vc1Context;
+protected:
+        FILE                    *index;
+        tsPacketLinearTracker   *pkt;
+        listOfTsAudioTracks     *audioTracks;
+        DIA_workingBase         *ui;
+        ADM_SPSInfo             spsInfo;
+        void                    updateUI(void);
+        bool                    decodeSEI(uint32_t nalSize, uint8_t *org,uint32_t *recoveryLength,pictureStructure *nextpicstruct);
+        bool                    decodeVC1Seq(tsGetBits &bits,TSVideo &video);
+        bool                    decodeVC1Pic(tsGetBits &bits,uint32_t &frameType,uint32_t &frameStructure);
+public:
+                TsIndexer(listOfTsAudioTracks *tr);
+                ~TsIndexer();
+        bool    runMpeg2(const char *file,ADM_TS_TRACK *videoTrac);
+        bool    runH264(const char *file,ADM_TS_TRACK *videoTrac);
+        bool    runVC1(const char *file,ADM_TS_TRACK *videoTrac);
+        bool    writeVideo(TSVideo *video,ADM_TS_TRACK_TYPE trkType);
+        bool    writeAudio(void);
+        bool    writeSystem(const char *filename,bool append);
+        bool    Mark(indexerData *data,dmxPacketInfo *s,uint32_t overRead);
+        bool    updatePicStructure(TSVideo &video,indexerData &idata, const uint32_t t)
+                        {
+                                            switch(t)
+                                            {
+                                                case 3: video.frameCount++;
+                                                        idata.picStructure=pictureFrame;
+                                                        break;
+                                                case 1:  idata.picStructure=pictureTopField;
+                                                         video.fieldCount++;
+                                                         break;
+                                                case 2:  idata.picStructure=pictureBottomField;
+                                                         video.fieldCount++;
+                                                         break;
+                                                default: ADM_warning("frame type 0 met, this is illegal\n");
+                                            }
+                                            return true;
+                        }
+};
+/********************************************************************************************/
+/********************************************************************************************/
+/********************************************************************************************/
+/********************************************************************************************/
+
+//
+#endif
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp	2010-11-13 14:25:55 UTC (rev 6754)
@@ -0,0 +1,340 @@
+/***************************************************************************
+                        Mpeg2 in PS indexer                                            
+                             
+    VC1: /!\ Escaping not done (yet)
+
+    copyright            : (C) 2005/2009 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_tsIndex.h"
+
+/**
+        \fn decodeSEI
+        \brief decode SEI to get short ref I
+        @param recoveryLength # of recovery frame
+        \return true if recovery found
+*/
+bool TsIndexer::decodeSEI(uint32_t nalSize, uint8_t *org,uint32_t *recoveryLength,
+                pictureStructure *picStruct)
+{
+    
+    uint8_t *payload=(uint8_t *)alloca(nalSize+16);
+    bool r=false;
+    nalSize=ADM_unescapeH264(nalSize,org,payload);
+    uint8_t *tail=payload+nalSize;
+    *picStruct=pictureFrame; // frame
+    while( payload<tail-2)
+    {
+                uint32_t sei_type=0,sei_size=0;
+                while(payload[0]==0xff) {sei_type+=0xff;payload++;};
+                sei_type+=payload[0];payload++;
+                while(payload[0]==0xff) {sei_size+=0xff;payload++;};
+                sei_size+=payload[0];payload++;
+                aprintf("  [SEI] Type : 0x%x size:%d\n",sei_type,sei_size);
+                switch(sei_type) // Recovery point
+                {
+
+                       case 1:
+                            {
+                                if(spsInfo.hasStructInfo)
+                                {
+                                    getBits bits(sei_size,payload);
+                                    payload+=sei_size;
+                                    if(spsInfo.CpbDpbToSkip)
+                                    {
+                                            bits.get(spsInfo.CpbDpbToSkip);
+                                    }
+                                    //printf("Consumed: %d,\n",bits.getConsumedBits());
+                                    int pic=bits.get(4);
+                                    aprintf("Pic struct: %d,\n",pic);
+                                    switch(pic) 
+                                    {
+                                        case 0: *picStruct=pictureFrame; break;
+                                        case 3:
+                                        case 4: *picStruct=pictureFrame;
+                                        case 1: *picStruct=pictureTopField;break;
+                                        case 2: *picStruct=pictureBottomField;break;
+                                        default:*picStruct=pictureFrame;
+                                    }
+                                    
+                                }else
+                                        payload+=sei_size;
+                            }
+                            break;
+
+                       case 6:
+                        {
+                            getBits bits(sei_size,payload);
+                            payload+=sei_size;
+                            *recoveryLength=bits.getUEG();
+                            aprintf("[SEI] Recovery :%"LU"\n",*recoveryLength);
+                            r=true;
+                            break;
+                        }
+                        default:
+                            payload+=sei_size;
+                            break;
+                }
+    }
+    if(payload+1<tail) ADM_warning("Bytes left in SEI %d\n",(int)(tail-payload));
+    return r;
+}
+
+/**
+    \fn runH264
+    \brief Index H264 stream
+*/  
+bool TsIndexer::runH264(const char *file,ADM_TS_TRACK *videoTrac)
+{
+bool    pic_started=false;
+bool    seq_found=false;
+
+TSVideo video;
+indexerData  data;    
+dmxPacketInfo info;
+TS_PESpacket SEI_nal(0);
+bool result=false;
+uint32_t recoveryCount=0xff;
+
+    printf("Starting H264 indexer\n");
+    if(!videoTrac) return false;
+    if(videoTrac[0].trackType!=ADM_TS_H264)
+    {
+        printf("[Ts Indexer] Only H264 video supported\n");
+        return false;
+    }
+    video.pid=videoTrac[0].trackPid;
+
+    memset(&data,0,sizeof(data));
+    data.picStructure=pictureFrame;
+    pictureStructure nextPicStruct=pictureFrame;
+    string indexName=string(file);
+    indexName=indexName+string(".idx2");
+    index=qfopen(indexName,(const char*)"wt");
+
+    if(!index)
+    {
+        printf("[PsIndex] Cannot create %s\n",indexName.c_str());
+        return false;
+    }
+
+    writeSystem(file,true);
+    pkt=new tsPacketLinearTracker(videoTrac->trackPid, audioTracks);
+
+    FP_TYPE append=FP_APPEND;
+    pkt->open(file,append);
+    data.pkt=pkt;
+    fullSize=pkt->getSize();
+    int lastRefIdc=0;
+    //******************
+    // 1 search SPS
+    //******************
+#define SPS_READ_AHEAD 32
+      while(1)
+      {
+        int startCode=pkt->findStartCode();
+
+        if(startCode&0x80) continue; // Marker missing
+        startCode&=0x1f;
+        if(startCode!=NAL_SPS) continue;
+
+          // Got SPS!
+          uint8_t buffer[60] ; // should be enough
+          uint32_t xA,xR;
+          // Get info
+          pkt->getInfo(&info);
+          pkt->read(SPS_READ_AHEAD,buffer);
+          if (extractSPSInfo(buffer, SPS_READ_AHEAD,&spsInfo))
+          {
+              
+              printf("[TsIndexer] Found video %"LU"x%"LU", fps=%"LU"\n",video.w,video.h,video.fps);
+              seq_found=1;
+              video.w=spsInfo.width;
+              video.h=spsInfo.height;
+              video.fps=spsInfo.fps1000;
+              xA=spsInfo.darNum;
+              xR=spsInfo.darDen;
+              writeVideo(&video,ADM_TS_H264);
+              writeAudio();
+              qfprintf(index,"[Data]");
+              // Rewind
+              pkt->seek(info.startAt,info.offset-5);
+              break;              
+          };
+      }
+      
+        if(!seq_found) goto the_end;
+        data.state=idx_startAtImage;
+    //******************
+    // 2 Index
+    //******************
+
+      while(1)
+      {
+        int startCode=pkt->findStartCode();
+resume:
+        if(!pkt->stillOk()) break;
+
+//  1:0 2:Nal ref idc 5:Nal Type
+        if(startCode&0x80) 
+        {
+            printf("[Ts] Nal Marker missing:%x\n",startCode);
+            continue; // Marker missing
+        }
+        int fullStartCode=startCode;
+        int ref=(startCode>>5)&3;
+
+        startCode&=0x1f; // Ignore nal ref IDR
+        
+        aprintf("[%02x] Nal :0x%x,ref=%d,lastRef=%d at : %d \n",fullStartCode,startCode,ref,lastRefIdc,pkt->getConsumed()-beginConsuming);
+        
+          // Ignore multiple chunk of the same pic
+          if((startCode==NAL_NON_IDR || startCode==NAL_IDR)&&pic_started )  //&& ref==lastRefIdc) 
+          {
+            aprintf("Still capturing, ignore\n");
+            continue;
+          }
+                
+          switch(startCode)
+                  {
+                  case NAL_AU_DELIMITER:
+                        {
+                          aprintf("AU DELIMITER\n");
+                          pic_started = false;
+                        }
+                          break;
+                  case NAL_SEI:
+                    {
+#if 0
+                        printf(">>SEI\n");
+#else
+                        // Load the whole NAL
+                            SEI_nal.empty();
+                            uint32_t code=0xffff+0xffff0000;
+                            while((code!=1) && pkt->stillOk())
+                            {
+                                uint8_t r=pkt->readi8();
+                                code=(code<<8)+r;
+                                SEI_nal.pushByte(r);
+                            }
+                            if(!pkt->stillOk()) goto resume;
+                            aprintf("[SEI] Nal size :%d\n",SEI_nal.payloadSize);
+                            if(SEI_nal.payloadSize>=7)
+                                decodeSEI(SEI_nal.payloadSize-4,
+                                    SEI_nal.payload,&recoveryCount,&nextPicStruct);
+                            else printf("[SEI] Too short size+4=%d\n",*(SEI_nal.payload));
+                            startCode=pkt->readi8();
+
+                              if( data.state!=idx_startAtGopOrSeq)
+                              {
+                                  pic_started = false;
+                                  pkt->getInfo(&info);
+                                  data.frameType=2;
+                                  Mark(&data,&info,5+SEI_nal.payloadSize+1);
+                                  data.state=idx_startAtGopOrSeq;
+                                  recoveryCount=0xff;
+                               }
+                            goto resume;
+#endif
+                        }
+                            break;
+                  
+                  case NAL_SPS:
+                              pic_started = false;
+                              aprintf("Sps \n");
+                              pkt->getInfo(&info);
+                              data.frameType=1;
+                              Mark(&data,&info,5);
+                              data.state=idx_startAtGopOrSeq;
+                              recoveryCount=0xff;
+                          break;
+
+                  case NAL_IDR:
+                    //zprintf("KOWABOUNGA\n");
+                  case NAL_NON_IDR:
+                    {
+#define NON_IDR_PRE_READ 8
+                      aprintf("Pic start last ref:%d cur ref:%d nb=%d\n",lastRefIdc,ref,data.nbPics);
+                      lastRefIdc=ref;
+                        
+                      uint8_t bufr[NON_IDR_PRE_READ+4];
+                      uint8_t header[NON_IDR_PRE_READ+4];
+                      
+                   
+                        pkt->read(NON_IDR_PRE_READ,bufr);
+                        // unescape...
+                        ADM_unescapeH264(NON_IDR_PRE_READ,bufr,header);
+                        //
+                        getBits bits(NON_IDR_PRE_READ,header);
+                        int first_mb_in_slice,slice_type;
+
+                        first_mb_in_slice= bits.getUEG();
+                        slice_type= bits.getUEG31();
+                        if(slice_type>9) 
+                        {
+                            printf("[TsIndexer] Bad slice type\n");
+                        }
+                        if(slice_type>4) slice_type-=5;
+                        switch(slice_type)
+                        {
+
+                            case 0 : data.frameType=2;break; // P
+                            case 1 : data.frameType=3;break; // B
+                            case 2 : data.frameType=1;break; // I
+                            default : data.frameType=2;break; // SP/SI
+                        }
+                      if(startCode==NAL_IDR) data.frameType=4; // IDR
+                      aprintf("[>>>>>>>>] Pic Type %"LU" Recovery %"LU"\n",data.frameType,recoveryCount);
+                      if(data.frameType==1 && !recoveryCount) data.frameType=4; //I  + Recovery=0 = IDR!
+                      data.picStructure=nextPicStruct;
+                      if(data.state==idx_startAtGopOrSeq) 
+                      {
+                              currentFrameType=data.frameType;;
+                              updateUI();
+                              
+                      }else
+                      {
+                            pkt->getInfo(&info);
+                            Mark(&data,&info,5+NON_IDR_PRE_READ);
+                       }
+                      data.state=idx_startAtImage;
+                      data.nbPics++;
+                      pic_started = true;
+                      recoveryCount=0xff;
+                    }
+                  
+                    break;
+                  default:
+                      break;
+          }
+      } // End while
+      result=true;
+the_end:
+        printf("\n");
+        Mark(&data,&info,0);
+        qfprintf(index,"\n[End]\n");
+        qfclose(index);
+        index=NULL;
+        audioTracks=NULL;
+        delete pkt;
+        pkt=NULL;
+        return result; 
+}
+
+/********************************************************************************************/
+/********************************************************************************************/
+/********************************************************************************************/
+/********************************************************************************************/
+
+//
+
+//EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/CMakeLists.txt	2010-11-11 17:07:43 UTC (rev 6753)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/CMakeLists.txt	2010-11-13 14:25:55 UTC (rev 6754)
@@ -3,6 +3,7 @@
 	ADM_ts.cpp
 	ADM_tsPlugin.cpp
 	ADM_tsIndex.cpp
+	ADM_tsIndexH264.cpp
 	ADM_tsReadIndex.cpp
 	ADM_tsAudio.cpp
 	ADM_tsAudioProbe.cpp



From mean at mail.berlios.de  Sat Nov 13 15:26:03 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 13 Nov 2010 15:26:03 +0100
Subject: [Avidemux-svn-commit] r6757 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20101113142603.50574480F56@sheep.berlios.de>

Author: mean
Date: 2010-11-13 15:26:03 +0100 (Sat, 13 Nov 2010)
New Revision: 6757

Added:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexMpeg2.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexVC1.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/CMakeLists.txt
Log:
[TsIndexer] SPlit + add VC1 support (not tested much)

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-11-13 14:25:59 UTC (rev 6756)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-11-13 14:26:03 UTC (rev 6757)
@@ -35,10 +35,6 @@
                 0,                      // 14
                 0                       // 15
         };
-static const uint32_t  VC1_ar[16][2] = {  // From VLC
-                        { 0, 0}, { 1, 1}, {12,11}, {10,11}, {16,11}, {40,33},
-                        {24,11}, {20,11}, {32,11}, {80,33}, {18,11}, {15,11},
-                        {64,33}, {160,99},{ 0, 0}, { 0, 0}};
 
 
 /**
@@ -137,383 +133,6 @@
         ui->update( (uint32_t)pos);
 }
 /**
-    \fn runMpeg2
-*/  
-bool TsIndexer::runMpeg2(const char *file,ADM_TS_TRACK *videoTrac)
-{
-uint32_t temporal_ref,val;
-uint8_t buffer[50*1024];
-bool seq_found=false;
-
-TSVideo video;
-indexerData  data;    
-dmxPacketInfo info;
-
-    if(!videoTrac) return false;
-    if(videoTrac[0].trackType!=ADM_TS_MPEG2)
-    {
-        printf("[Ts Indexer] Only Mpeg2 video supported\n");
-        return false;
-    }
-    video.pid=videoTrac[0].trackPid;
-
-    memset(&data,0,sizeof(data));
-    data.picStructure=pictureFrame;
-
-    string indexName=string(file);
-    indexName=indexName+string(".idx2");
-    index=qfopen(indexName,"wt");
-
-    if(!index)
-    {
-        printf("[PsIndex] Cannot create %s\n",indexName.c_str());
-        return false;
-    }
-    writeSystem(file,true);
-    pkt=new tsPacketLinearTracker(videoTrac->trackPid, audioTracks);
-
-    FP_TYPE append=FP_APPEND;
-    pkt->open(file,append);
-    data.pkt=pkt;
-    fullSize=pkt->getSize();
-    int startCode;
-#define likely(x) x
-#define unlikely(x) x
-      while(1)
-      {
-        startCode=pkt->findStartCode();
-        if(!pkt->stillOk()) break;
-
-          switch(startCode)
-                  {
-                  case 0xB3: // sequence start
-                          if(seq_found)
-                          {
-                                  pkt->getInfo(&info);
-                                  data.frameType=1;
-                                  Mark(&data,&info,4);
-                                  data.state=idx_startAtGopOrSeq;
-                                  pkt->forward(8);  // Ignore
-                                  continue;
-                          }
-                          //
-                          seq_found=1;
-                          val=pkt->readi32();
-                          video.w=val>>20;
-                          video.w=((video.w+15)&~15);
-                          video.h= (((val>>8) & 0xfff)+15)& ~15;
-
-                          video.ar = (val >> 4) & 0xf;
-                          video.fps= FPS[val & 0xf];
-                          pkt->forward(4);
-                          writeVideo(&video,ADM_TS_MPEG2);
-                          writeAudio();
-                          qfprintf(index,"[Data]");
-                          pkt->getInfo(&info);
-                          data.frameType=1;
-                          Mark(&data,&info,4+8);
-                          data.state=idx_startAtGopOrSeq;
-                          continue;
-
-                          break;
-                    case 0xB5: //  extension
-                                { 
-                                    uint8_t id=pkt->readi8()>>4;
-                                    uint8_t two;
-                                    switch(id)
-                                    {
-                                        case 1: // Sequence extension
-                                            val=(val>>3)&1; // gop type progressive, unreliable, not used
-                                            break;
-                                        case 8: // picture coding extension (mpeg2)
-                                        {
-                                            // skip motion vector
-                                            uint8_t picture_structure;
-                                            pkt->forward(1); // 4*4 bits
-                                            two=pkt->readi8();
-                                            picture_structure=(two)&3;
-                                            
-                                            //printf("Picture type %02x struct:%x\n",two,picture_structure);
-                                            updatePicStructure(video,data,picture_structure);
-                                        }
-                                        default:break;
-                                    }
-                                }
-                                break;
-                  case 0xb8: // GOP
-                          // Update ui
-                            {
-                               updateUI();
-
-                            }
-
-                          if(!seq_found) continue;
-                          if(data.state==idx_startAtGopOrSeq) 
-                          {         
-                                  continue;;
-                          }
-                          pkt->getInfo(&info);
-                          Mark(&data,&info,4);
-                          data.state=idx_startAtGopOrSeq;
-                          break;
-                  case 0x00 : // picture
-                        {
-                          int type;
-                          if(!seq_found)
-                          { 
-                                  continue;
-                                  printf("[TsIndexer]No sequence start yet, skipping..\n");
-                          }
-                          
-                          val=pkt->readi16();
-                          temporal_ref=val>>6;
-                          type=7 & (val>>3);
-                          if( type<1 ||  type>3)
-                          {
-                                  printf("[Indexer]Met illegal pic at %"LLX" + %"LX"\n",
-                                                  info.startAt,info.offset);
-                                  continue;
-                          }
-                          
-                          
-                          if(data.state==idx_startAtGopOrSeq) 
-                          {
-                                  currentFrameType=type;
-                          }else
-                            {
-                                  data.frameType=type;
-                                  pkt->getInfo(&info);
-                                  Mark(&data,&info,4+2);
-
-
-                            }
-                            data.state=idx_startAtImage;
-                            data.nbPics++;
-                        }
-                          break;
-                  default:
-                    break;
-                  }
-      }
-    
-        printf("\n");
-        Mark(&data,&info,2);
-        qfprintf(index,"\n[End]\n");
-        qfprintf(index,"\n# Found %"LU" images \n",data.nbPics); // Size
-        qfprintf(index,"# Found %"LU" frame pictures\n",video.frameCount); // Size
-        qfprintf(index,"# Found %"LU" field pictures\n",video.fieldCount); // Size
-        qfclose(index);
-        index=NULL;
-        audioTracks=NULL;
-        delete pkt;
-        pkt=NULL;
-        return 1; 
-}
-/**
-    \fn runVC1
-    \brief Index VC1 stream
-*/  
-bool TsIndexer::runVC1(const char *file,ADM_TS_TRACK *videoTrac)
-{
-uint32_t temporal_ref,val;
-uint8_t buffer[50*1024];
-bool seq_found=false;
-
-TSVideo video;
-indexerData  data;    
-dmxPacketInfo info;
-
-
-    if(!videoTrac) return false;
-    if(videoTrac[0].trackType!=ADM_TS_VC1)
-    {
-        printf("[Ts Indexer] Only VC1 video supported\n");
-        return false;
-    }
-    video.pid=videoTrac[0].trackPid;
-
-    memset(&data,0,sizeof(data));
-    data.picStructure=pictureFrame;
-    
-    string indexName=string(file);
-    indexName=indexName+string(".idx2");
-    index=qfopen(indexName,"wt");
-
-    if(!index)
-    {
-        printf("[PsIndex] Cannot create %s\n",indexName.c_str());
-        return false;
-    }
-    writeSystem(file,true);
-    pkt=new tsPacketLinearTracker(videoTrac->trackPid, audioTracks);
-
-    FP_TYPE append=FP_APPEND;
-    pkt->open(file,append);
-    data.pkt=pkt;
-    fullSize=pkt->getSize();
-    int startCode;
-#define likely(x) x
-#define unlikely(x) x
-      while(1)
-      {
-        startCode=pkt->findStartCode();
-        if(!pkt->stillOk()) break;
-
-          switch(startCode)
-                  {
-                  case 0x0f: // sequence start
-                          
-                          if(seq_found)
-                          {
-                              if(data.state==idx_startAtGopOrSeq)       
-                                  continue;;
-                              pkt->getInfo(&info);
-                              data.frameType=1; // next frame is assumed to be intra
-                              Mark(&data,&info,4); // startcode
-                              data.state=idx_startAtGopOrSeq;
-                              updateUI();
-                              break;
-                          }
-                          // Verify it is high/advanced profile
-                          {
-                          int seqSize=0;
-                          tsGetBits bits(pkt);
-                          if(!bits.peekBits(1)) continue; // simple/main profile
-
-                          if(!decodeVC1Seq(bits,video)) continue;
-
-                          seqSize=bits.getConsumed();
-                          video.extraDataLength=seqSize+4+1;
-                          memcpy(video.extraData+4,bits.data,seqSize);
-                            // Add info so that ffmpeg is happy
-                          video.extraData[0]=0;
-                          video.extraData[1]=0;
-                          video.extraData[2]=1;
-                          video.extraData[3]=0xf;
-                          video.extraData[seqSize+4+0]=0;
-                          seq_found=1;
-                          // Hi Profile
-                          printf("[VC1] Found seq start with %d x %d video\n",(int)video.w,(int)video.h);
-                          printf("[VC1] FPS : %d\n",(int)video.fps);
-                          printf("[VC1] sequence header is %d bytes\n",(int)seqSize);
-                          writeVideo(&video,ADM_TS_VC1);
-                          writeAudio();
-                          qfprintf(index,"[Data]");
-                          pkt->getInfo(&info);
-                          data.frameType=1; // Force first frame to be intra
-                          Mark(&data,&info,seqSize+4);
-                          data.state=idx_startAtGopOrSeq;
-                          continue;
-                          }
-                          break;
-                    case 0x0D: //  Picture start
-                        { 
-                          int type;
-                          uint8_t buffer[4];
-                          uint32_t fType,sType;
-                          if(!seq_found)
-                          { 
-                                  continue;
-                                  printf("[TsIndexer]No sequence start yet, skipping..\n");
-                          }      
-                          tsGetBits bits(pkt);
-                          if(!decodeVC1Pic(bits,fType,sType)) continue;
-                          updatePicStructure(video,data,sType);
-                          if(data.state==idx_startAtGopOrSeq) 
-                          {
-                                  currentFrameType=fType;
-                          }else
-                            {
-                                  data.frameType=fType;
-                                  pkt->getInfo(&info);
-                                  Mark(&data,&info,bits.getConsumed());
-                            }
-                            data.state=idx_startAtImage;
-                            data.nbPics++;
-                        }
-                          break;
-                  default:
-                    break;
-                  }
-      }
-    
-        printf("\n");
-        Mark(&data,&info,2);
-        qfprintf(index,"\n[End]\n");
-        qfprintf(index,"\n# Found %"LU" images \n",data.nbPics); // Size
-        qfprintf(index,"# Found %"LU" frame pictures\n",video.frameCount); // Size
-        qfprintf(index,"# Found %"LU" field pictures\n",video.fieldCount); // Size
-        qfclose(index);
-        index=NULL;
-        audioTracks=NULL;
-        delete pkt;
-        pkt=NULL;
-        return 1; 
-}
-/**
-    \fn   Mark
-    \brief update the file
-
-    The offset part is due to the fact that we read 2 bytes from the pic header to know the pic type.
-    So when going from a pic to a pic, it is self cancelling.
-    If the beginning is not a pic, but a gop start for example, we had to add/remove those.
-
-*/
-bool  TsIndexer::Mark(indexerData *data,dmxPacketInfo *info,uint32_t overRead)
-{
-        aprintf("********************** MARK ******************\n");
-        uint32_t consumed=pkt->getConsumed()-overRead;
-        if(data->nbPics)
-        {
-            int64_t deltaPts,deltaDts;
-
-            if(data->beginPts==-1 || data->prevPts==-1) deltaPts=-1;
-                else deltaPts=data->prevPts-data->beginPts;
-
-            if(data->beginDts==-1 || data->prevDts==-1) deltaDts=-1;
-                else deltaDts=data->prevDts-data->beginDts;
-
-            qfprintf(index," %c%c:%06"LX":%"LLD":%"LLD,
-                                    Type[currentFrameType],
-                                    Structure[data->picStructure&3],
-                                    consumed-beginConsuming,
-                                    deltaPts,deltaDts);
-            beginConsuming=consumed;
-        }else
-        {  // Our first Pic
-            beginConsuming=0;
-            pkt->setConsumed(overRead);
-        }
-            
-        // If audio, also dump audio
-        if(data->frameType==1 || data->frameType==4) // I or IDR
-        {
-            data->beginPts=info->pts;
-            data->beginDts=info->dts;
-            if(audioTracks)
-            {
-                qfprintf(index,"\nAudio bf:%08"LLX" ",info->startAt);
-                packetTSStats *s;
-                uint32_t na;
-                pkt->getStats(&na,&s);      
-                ADM_assert(na==audioTracks->size());
-                for(int i=0;i<na;i++)
-                {   
-                    packetTSStats *current=s+i;
-                    qfprintf(index,"Pes:%x:%08"LLX":%"LD":%"LLD" ",
-                                current->pid,current->startAt,current->startSize,current->startDts);
-                }                
-            }
-            // start a new line
-            qfprintf(index,"\nVideo at:%08"LLX":%04"LX" Pts:%08"LLD":%08"LLD" ",info->startAt,info->offset-overRead,info->pts,info->dts);
-        }
-        currentFrameType=data->frameType;
-        data->prevDts=info->dts;
-        data->prevPts=info->pts;
-    return true;
-}
-
-/**
     \fn writeVideo
     \brief Write Video section of index file
 */
@@ -579,220 +198,101 @@
     }
     return true;
 }
+
+
 /**
-    \fn decodeVc1Seq
-    \brief http://wiki.multimedia.cx/index.php?title=VC-1#Setup_Data_.2F_Sequence_Layer
-#warning we should de-escape it!
-        Large part of this borrowed from VLC
-        Advanced/High profile only
+    \fn dumpUnits
 */
-bool TsIndexer::decodeVC1Seq(tsGetBits &bits,TSVideo &video)
+bool TsIndexer::dumpUnits(indexerData &data,uint64_t nextConsumed,const dmxPacketInfo *nextPacket)
 {
-
-int v;
-int consumed;
-    vc1Context.advanced=true;
-
-#define VX(a,b) v=bits.getBits(a);printf("[VC1] %d "#b"\n",v);consumed+=a;
-    VX(2,profile);
-    VX(3,level);
-
-    VX(2,chroma_format);
-    VX(3,Q_frame_rate_unused);
-    VX(5,Q_bit_unused);
-
-    VX(1,postproc_flag);
-
-    VX(12,coded_width);
-    video.w=v*2+2;
-    VX(12,coded_height);
-    video.h=v*2+2;
-
-    VX(1,pulldown_flag);
-    VX(1,interlaced_flag);
-    vc1Context.interlaced=v;
-    VX(1,frame_counter_flag);
-
-    VX(1,interpolation_flag);
-    vc1Context.interpolate=v;
-
-    VX(1,reserved_bit);
-    VX(1,psf);
-
-    VX(1,display_extension);
-    if(v)
-    {
-         VX(14,display_extension_coded_width);
-         VX(14,display_extension_coded_height);
-         VX(1,aspect_ratio_flag);
-     
-
-         if(v)
-         {
-                VX(4,aspect_ratio);
-                switch(v)
-                {
-                    case 15: video.ar=(bits.getBits(8)<<16)+bits.getBits(8);
-                             break;
-                    default:
-                             video.ar=(VC1_ar[v][0]<<16)+(VC1_ar[v][1]<<16);
-                             break;
-                }
-                printf("[VC1] Aspect ratio %d x %d\n",video.ar>>8,video.ar&0xff);
-         }
-    
-        VX(1,frame_rate);
-        if(v)
+        // if it contain a SPS or a intra/idr, we start a new line
+        bool mustFlush=false;
+        int n=listOfUnits.size();
+        int picIndex=0;
+        H264Unit *unit=&(listOfUnits[0]);
+        pictureStructure pictStruct=pictureFrame;
+        
+        // if I, IDR or SPS we start a new line
+        for(int i=0;i<n;i++)
         {
-                VX(1,frame_rate32_flag);
-                if(v)
-                {
-                    VX(16,frame_rate32);
-                    float f=v;
-                    f=(f+1)/32;
-                    f*=1000;
-                    video.fps=(uint32_t)f;
-                }else
-                {
-                    float den,num;
-                    VX(8,frame_rate_num)
-                    switch( v )
-                        {
-                        case 1: num = 24000; break;
-                        case 2: num = 25000; break;
-                        case 3: num = 30000; break;
-                        case 4: num = 50000; break;
-                        case 5: num = 60000; break;
-                        case 6: num = 48000; break;
-                        case 7: num = 72000; break;
-                        }
-                    VX(4,frame_rate_den)
-                    switch( v )
-                        {
-                        default:
-                        case 1: den = 1000; break;
-                        case 2: den = 1001; break;
-                        }
-
-                    float f=num*1000;
-                    f/=den;
-                    video.fps=(uint32_t)f;
-                }
-            }else
+            switch(listOfUnits[i].unitType)
             {
-                video.fps=25000;
+                case unitTypeSps: mustFlush=true;;break;
+                case unitTypePic: 
+                            picIndex=i;
+                            if(listOfUnits[i].imageType==1 || listOfUnits[i].imageType==4)
+                            mustFlush=true;
+                            break;
+                case unitTypeSei:
+                            pictStruct=listOfUnits[i].imageStructure;
+                            break;
+                default:
+                        ADM_assert(0);
+                        break;
             }
-            //
-            VX(1,color_flag);
-            if(v){
-                    VX(8,color_prim);
-                    VX(8,transfer_char);
-                    VX(8,matrix_coef);
-                }
-    }
-    VX(1,hrd_param_flag);
-    int leaky=0;
-    if(v)
-    {
-        VX(5,hrd_num_leaky_buckets);
-        leaky=v;
-        VX(4,bitrate_exponent);
-        VX(4,buffer_size_exponent);
-        for(int i = 0; i < leaky; i++) 
+        }
+        dmxPacketInfo *pic=&(listOfUnits[picIndex].packetInfo);
+        dmxPacketInfo *p=&(unit->packetInfo);
+        H264Unit      *picUnit=&(listOfUnits[picIndex]);
+        if(mustFlush) 
         {
-                bits.getBits(16);
-                bits.getBits(16);
+            if(audioTracks)
+            {
+                qfprintf(index,"\nAudio bf:%08"LLX" ",nextPacket->startAt);
+                packetTSStats *s;
+                uint32_t na;
+                pkt->getStats(&na,&s);      
+                ADM_assert(na==audioTracks->size());
+                for(int i=0;i<na;i++)
+                {   
+                    packetTSStats *current=s+i;
+                    qfprintf(index,"Pes:%x:%08"LLX":%"LD":%"LLD" ",
+                                current->pid,current->startAt,current->startSize,current->startDts);
+                }                
+            }
+            data.beginPts=pic->pts;
+            data.beginDts=pic->dts;
+            // start a new line
+            qfprintf(index,"\nVideo at:%08"LLX":%04"LX" Pts:%08"LLD":%08"LLD" ",
+                        p->startAt,p->offset-unit->overRead,pic->pts,pic->dts);
         }
-    }
-    // Now we need an entry point
-    bits.flush();
-    uint8_t a[4];
-    uint8_t entryPoint[4]={0,0,1,0x0E};
-    for(int i=0;i<4;i++) a[i]=bits.getBits(8);
-    for(int i=0;i<4;i++) printf("%02x ",a[i]);
-    printf(" as marker\n");
-    if(memcmp(a,entryPoint,4))
-    {
-        ADM_warning("Bad entry point");
-        return false;
-    }
-    VX(6,ep_flags);
-    VX(1,extended_mv);
-    int extended_mv=v;
-    VX(6,ep_flags2);
+       
+        
+            int64_t deltaPts,deltaDts;
 
-    for(int i=0;i<leaky;i++)
-            bits.getBits(8);
-    VX(1,ep_coded_dimension);
-    if(v)
-    {
-         VX(12,ep_coded_width);
-         VX(12,ep_coded_height);
-    }
-    if(extended_mv) VX(1,dmv);
-    VX(1,range_mappy_flags);
-    if(v) VX(3,mappy_flags);
-    VX(1,range_mappuv_flags);
-    if(v) VX(3,mappuv_flags);
-    return true;
+            if(data.beginPts==-1 || pic->pts==-1) deltaPts=-1;
+                else deltaPts=pic->pts-data.beginPts;
 
+            if(data.beginDts==-1 || pic->dts==-1) deltaDts=-1;
+                else deltaDts=pic->dts-data.beginDts;            
+
+
+            qfprintf(index," %c%c:%06"LX":%"LLD":%"LLD,
+                                    Type[picUnit->imageType],
+                                    Structure[pictStruct&3],
+                                    nextConsumed-beginConsuming,
+                                    deltaPts,deltaDts);
+        beginConsuming=nextConsumed;
+        listOfUnits.clear();
+        return true;
 }
 /**
-    \fn decodeVC1Pic
-    \brief Decode info from VC1 picture
-    Borrowed a lot from VLC also
-
+    \fn addUnit
 */
-bool TsIndexer::decodeVC1Pic(tsGetBits &bits,uint32_t &frameType,uint32_t &frameStructure)
+bool TsIndexer::addUnit(indexerData &data,int unitType2,const H264Unit &unit,uint32_t overRead)
 {
-    frameStructure=3;
-    bool field=false;
-    if(vc1Context.interlaced)
-    {
-        if(bits.getBits(1))
-        {
-            if(bits.getBits(1))
-               field=true;
-        }
-    }
-    if(field)
-    {
-            int fieldType=bits.getBits(3);
-            frameStructure=1; // Top
-            switch(fieldType)
+        H264Unit myUnit=unit;
+        myUnit.unitType=unitType2;
+        myUnit.overRead=overRead;
+        int n=listOfUnits.size();
+        if(n)
+            if(listOfUnits[n-1].unitType==unitTypePic)
             {
-                case 0: /* II */
-                case 1: /* IP */
-                case 2: /* PI */
-                    frameType=1;
-                    break;
-                case 3: /* PP */
-                    frameType=2;
-                    break;
-                case 4: /* BB */
-                case 5: /* BBi */
-                case 6: /* BiB */
-                case 7: /* BiBi */
-                    frameType=3;
-                    break;
-
+                dumpUnits(data,myUnit.consumedSoFar-overRead,&(unit.packetInfo));
+                updateUI();
             }
-    }else
-    {
-                frameStructure=3; // frame
-                if( !bits.getBits(1))
-                    frameType=2;
-                else if( !bits.getBits(1))
-                    frameType=3;
-                else if( !bits.getBits(1))
-                    frameType=1;
-                else if( !bits.getBits(1))
-                    frameType=3;
-                else
-                    frameType=2;
-    }
-
-    return true;
+        listOfUnits.push_back(myUnit);
+        return true;
 }
 /********************************************************************************************/
 /********************************************************************************************/

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h	2010-11-13 14:25:59 UTC (rev 6756)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h	2010-11-13 14:26:03 UTC (rev 6757)
@@ -121,7 +121,8 @@
 {
     unitTypeSei=1,
     unitTypePic=2,
-    unitTypeSps=3
+    unitTypeSps=3,
+    unitTypePicInfo=4
 };
 
 /**
@@ -130,12 +131,13 @@
 class TsIndexer
 {
 protected:
-        uint32_t        currentFrameType;
         uint32_t        beginConsuming;
-        indexerState    currentIndexState;
         uint64_t        fullSize;
         Clock           ticktock;
         VC1Context      vc1Context;
+        vector <H264Unit> listOfUnits;
+        H264Unit        thisUnit;
+        bool            decodingImage;
 protected:
         FILE                    *index;
         tsPacketLinearTracker   *pkt;
@@ -158,18 +160,17 @@
         bool    writeVideo(TSVideo *video,ADM_TS_TRACK_TYPE trkType);
         bool    writeAudio(void);
         bool    writeSystem(const char *filename,bool append);
-        bool    Mark(indexerData *data,dmxPacketInfo *s,uint32_t overRead);
-        bool    updatePicStructure(TSVideo &video,indexerData &idata, const uint32_t t)
+        bool    updatePicStructure(TSVideo &video,const uint32_t t)
                         {
                                             switch(t)
                                             {
                                                 case 3: video.frameCount++;
-                                                        idata.picStructure=pictureFrame;
+                                                        thisUnit.imageStructure=pictureFrame;
                                                         break;
-                                                case 1:  idata.picStructure=pictureTopField;
+                                                case 1:  thisUnit.imageStructure=pictureTopField;
                                                          video.fieldCount++;
                                                          break;
-                                                case 2:  idata.picStructure=pictureBottomField;
+                                                case 2:  thisUnit.imageStructure=pictureBottomField;
                                                          video.fieldCount++;
                                                          break;
                                                 default: ADM_warning("frame type 0 met, this is illegal\n");

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp	2010-11-13 14:25:59 UTC (rev 6756)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp	2010-11-13 14:26:03 UTC (rev 6757)
@@ -17,102 +17,8 @@
  ***************************************************************************/
 #include "ADM_tsIndex.h"
 
-static vector <H264Unit> listOfUnits;
-/**
-    \fn dumpUnits
-*/
-bool TsIndexer::dumpUnits(indexerData &data,uint64_t nextConsumed,const dmxPacketInfo *nextPacket)
-{
-        // if it contain a SPS or a intra/idr, we start a new line
-        bool mustFlush=false;
-        int n=listOfUnits.size();
-        int picIndex=0;
-        H264Unit *unit=&(listOfUnits[0]);
-        pictureStructure pictStruct=pictureFrame;
-        
-        // if I, IDR or SPS we start a new line
-        for(int i=0;i<n;i++)
-        {
-            switch(listOfUnits[i].unitType)
-            {
-                case unitTypeSps: mustFlush=true;;break;
-                case unitTypePic: 
-                            picIndex=i;
-                            if(listOfUnits[i].imageType==1 || listOfUnits[i].imageType==4)
-                            mustFlush=true;
-                            break;
-                case unitTypeSei:
-                            pictStruct=listOfUnits[i].imageStructure;
-                            break;
-                default:
-                        ADM_assert(0);
-                        break;
-            }
-        }
-        dmxPacketInfo *pic=&(listOfUnits[picIndex].packetInfo);
-        dmxPacketInfo *p=&(unit->packetInfo);
-        H264Unit      *picUnit=&(listOfUnits[picIndex]);
-        if(mustFlush) 
-        {
-            if(audioTracks)
-            {
-                qfprintf(index,"\nAudio bf:%08"LLX" ",nextPacket->startAt);
-                packetTSStats *s;
-                uint32_t na;
-                pkt->getStats(&na,&s);      
-                ADM_assert(na==audioTracks->size());
-                for(int i=0;i<na;i++)
-                {   
-                    packetTSStats *current=s+i;
-                    qfprintf(index,"Pes:%x:%08"LLX":%"LD":%"LLD" ",
-                                current->pid,current->startAt,current->startSize,current->startDts);
-                }                
-            }
-            data.beginPts=pic->pts;
-            data.beginDts=pic->dts;
-            // start a new line
-            qfprintf(index,"\nVideo at:%08"LLX":%04"LX" Pts:%08"LLD":%08"LLD" ",
-                        p->startAt,p->offset-unit->overRead,pic->pts,pic->dts);
-        }
-       
-        
-            int64_t deltaPts,deltaDts;
 
-            if(data.beginPts==-1 || pic->pts==-1) deltaPts=-1;
-                else deltaPts=pic->pts-data.beginPts;
-
-            if(data.beginDts==-1 || pic->dts==-1) deltaDts=-1;
-                else deltaDts=pic->dts-data.beginDts;            
-
-
-            qfprintf(index," %c%c:%06"LX":%"LLD":%"LLD,
-                                    Type[picUnit->imageType],
-                                    Structure[pictStruct&3],
-                                    nextConsumed-beginConsuming,
-                                    deltaPts,deltaDts);
-        beginConsuming=nextConsumed;
-        listOfUnits.clear();
-        return true;
-}
 /**
-    \fn addUnit
-*/
-bool TsIndexer::addUnit(indexerData &data,int unitType2,const H264Unit &unit,uint32_t overRead)
-{
-        H264Unit myUnit=unit;
-        myUnit.unitType=unitType2;
-        myUnit.overRead=overRead;
-        int n=listOfUnits.size();
-        if(n)
-            if(listOfUnits[n-1].unitType==unitTypePic)
-            {
-                dumpUnits(data,myUnit.consumedSoFar-overRead,&(unit.packetInfo));
-            }
-        listOfUnits.push_back(myUnit);
-        return true;
-}
-
-/**
         \fn decodeSEI
         \brief decode SEI to get short ref I
         @param recoveryLength # of recovery frame
@@ -190,7 +96,7 @@
 */  
 bool TsIndexer::runH264(const char *file,ADM_TS_TRACK *videoTrac)
 {
-bool    decodingImage=false;
+
 bool    seq_found=false;
 bool    firstSps=true;
 
@@ -199,8 +105,8 @@
 dmxPacketInfo tmpInfo;
 TS_PESpacket SEI_nal(0);
 bool result=false;
-H264Unit thisUnit;
 
+
     beginConsuming=0;
     listOfUnits.clear();
 

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexMpeg2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexMpeg2.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexMpeg2.cpp	2010-11-13 14:26:03 UTC (rev 6757)
@@ -0,0 +1,218 @@
+/***************************************************************************
+                        Mpeg2 in PS indexer                                            
+                             
+    VC1: /!\ Escaping not done (yet)
+
+    copyright            : (C) 2005/2009 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_tsIndex.h"
+
+static const uint32_t FPS[16]={
+                0,                      // 0
+                23976,          // 1 (23.976 fps) - FILM
+                24000,          // 2 (24.000 fps)
+                25000,          // 3 (25.000 fps) - PAL
+                29970,          // 4 (29.970 fps) - NTSC
+                30000,          // 5 (30.000 fps)
+                50000,          // 6 (50.000 fps) - PAL noninterlaced
+                59940,          // 7 (59.940 fps) - NTSC noninterlaced
+                60000,          // 8 (60.000 fps)
+                0,                      // 9
+                0,                      // 10
+                0,                      // 11
+                0,                      // 12
+                0,                      // 13
+                0,                      // 14
+                0                       // 15
+        };
+
+
+/**
+    \fn runMpeg2
+*/  
+bool TsIndexer::runMpeg2(const char *file,ADM_TS_TRACK *videoTrac)
+{
+uint32_t temporal_ref,val;
+uint8_t buffer[50*1024];
+bool seq_found=false;
+H264Unit thisUnit;
+
+beginConsuming=0;
+
+TSVideo video;
+indexerData  data;    
+dmxPacketInfo tmpInfo;
+
+    listOfUnits.clear();
+
+    if(!videoTrac) return false;
+    if(videoTrac[0].trackType!=ADM_TS_MPEG2)
+    {
+        printf("[Ts Indexer] Only Mpeg2 video supported\n");
+        return false;
+    }
+    video.pid=videoTrac[0].trackPid;
+
+    memset(&data,0,sizeof(data));
+
+    string indexName=string(file);
+    indexName=indexName+string(".idx2");
+    index=qfopen(indexName,"wt");
+
+    if(!index)
+    {
+        printf("[PsIndex] Cannot create %s\n",indexName.c_str());
+        return false;
+    }
+    writeSystem(file,true);
+    pkt=new tsPacketLinearTracker(videoTrac->trackPid, audioTracks);
+
+    FP_TYPE append=FP_APPEND;
+    pkt->open(file,append);
+    data.pkt=pkt;
+    fullSize=pkt->getSize();
+    int startCode;
+    decodingImage=false;
+    
+#define likely(x) x
+#define unlikely(x) x
+      while(1)
+      {
+        startCode=pkt->findStartCode();
+        if(!pkt->stillOk()) break;
+
+          switch(startCode)
+                  {
+// B2: User Data
+                  case 0xB3: // sequence start
+                          if(seq_found)
+                          {
+                                decodingImage=false;
+                                pkt->getInfo(&thisUnit.packetInfo);
+                                thisUnit.consumedSoFar=pkt->getConsumed();
+                                addUnit(data,unitTypeSps,thisUnit,4);
+                                pkt->forward(8);  // Ignore
+                                continue;
+                          }
+                          pkt->setConsumed(4); // reset consumed counter
+                          //
+                          seq_found=1;
+                          val=pkt->readi32();                    //+4
+                          video.w=val>>20;
+                          video.w=((video.w+15)&~15);
+                          video.h= (((val>>8) & 0xfff)+15)& ~15;
+
+                          video.ar = (val >> 4) & 0xf;
+                          video.fps= FPS[val & 0xf];
+                          pkt->forward(4);                      //+4
+                          writeVideo(&video,ADM_TS_MPEG2);
+                          writeAudio();
+                          qfprintf(index,"[Data]");
+
+                          decodingImage=false;
+                          pkt->getInfo(&thisUnit.packetInfo);
+                          thisUnit.consumedSoFar=pkt->getConsumed();
+                          addUnit(data,unitTypeSps,thisUnit,4+4+4);
+                          continue;
+                          break;
+#warning FIXME, update pic field info.... It triggers a end-of-pic message as it is
+#if 0
+                    case 0xB5: //  extension
+                                { 
+                                    uint8_t id=pkt->readi8()>>4;  // +1
+                                    uint8_t two;
+                                    switch(id)
+                                    {
+                                        case 1: // Sequence extension
+                                            val=(val>>3)&1; // gop type progressive, unreliable, not used
+                                            break;
+                                        case 8: // picture coding extension (mpeg2)
+                                        {
+                                            // skip motion vector
+                                            uint8_t picture_structure;
+                                            pkt->forward(1); // 4*4 bits   // +1
+                                            two=pkt->readi8();             // +1
+                                            picture_structure=(two)&3;
+                                            
+                                            //printf("Picture type %02x struct:%x\n",two,picture_structure);
+                                            updatePicStructure(video,picture_structure);
+                                            pkt->getInfo(&thisUnit.packetInfo);
+                                            thisUnit.consumedSoFar=pkt->getConsumed();
+                                            addUnit(data,unitTypePicInfo,thisUnit,4+1+1+1);
+                                        }
+                                        default:break;
+                                    }
+                                }
+                                break;
+#endif
+                  case 0xb8: // GOP
+                          // Update ui                        
+                          if(!seq_found) continue;
+
+                          pkt->getInfo(&thisUnit.packetInfo);
+                          thisUnit.consumedSoFar=pkt->getConsumed();
+                          addUnit(data,unitTypeSps,thisUnit,4);
+                          break;
+                  case 0x00 : // picture
+                        {
+                          int type;
+                          if(!seq_found)
+                          { 
+                                  printf("[TsIndexer]No sequence start yet, skipping..\n");
+                                  continue;
+                          }
+                          
+                          val=pkt->readi16();             // +2
+                          
+                          temporal_ref=val>>6;
+                          type=7 & (val>>3);
+                          if( type<1 ||  type>3)
+                          {
+                                  printf("[Indexer]Met illegal pic at %"LLX" + %"LX"\n",
+                                                  thisUnit.packetInfo.startAt,thisUnit.packetInfo.offset);
+                                  continue;
+                          }
+                          
+                          pkt->getInfo(&thisUnit.packetInfo);
+                          thisUnit.consumedSoFar=pkt->getConsumed();
+                          thisUnit.imageType=type;
+                          addUnit(data,unitTypePic,thisUnit,4+2);
+                          data.nbPics++;
+                        }
+                          break;
+                  default:
+                    break;
+                  }
+      }
+    
+        printf("\n");
+        qfprintf(index,"\n[End]\n");
+        qfprintf(index,"\n# Found %"LU" images \n",data.nbPics); // Size
+        qfprintf(index,"# Found %"LU" frame pictures\n",video.frameCount); // Size
+        qfprintf(index,"# Found %"LU" field pictures\n",video.fieldCount); // Size
+        qfclose(index);
+        index=NULL;
+        audioTracks=NULL;
+        delete pkt;
+        pkt=NULL;
+        return 1; 
+}
+
+/********************************************************************************************/
+/********************************************************************************************/
+/********************************************************************************************/
+/********************************************************************************************/
+
+//
+
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexVC1.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexVC1.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexVC1.cpp	2010-11-13 14:26:03 UTC (rev 6757)
@@ -0,0 +1,385 @@
+/***************************************************************************
+                        Mpeg2 in PS indexer                                            
+                             
+    VC1: /!\ Escaping not done (yet)
+
+    copyright            : (C) 2005/2009 by mean
+    email                : fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_tsIndex.h"
+
+static const uint32_t  VC1_ar[16][2] = {  // From VLC
+                        { 0, 0}, { 1, 1}, {12,11}, {10,11}, {16,11}, {40,33},
+                        {24,11}, {20,11}, {32,11}, {80,33}, {18,11}, {15,11},
+                        {64,33}, {160,99},{ 0, 0}, { 0, 0}};
+
+
+/**
+    \fn runVC1
+    \brief Index VC1 stream
+*/  
+bool TsIndexer::runVC1(const char *file,ADM_TS_TRACK *videoTrac)
+{
+uint32_t temporal_ref,val;
+uint8_t buffer[50*1024];
+bool seq_found=false;
+
+TSVideo video;
+indexerData  data;    
+dmxPacketInfo info;
+
+
+    if(!videoTrac) return false;
+    if(videoTrac[0].trackType!=ADM_TS_VC1)
+    {
+        printf("[Ts Indexer] Only VC1 video supported\n");
+        return false;
+    }
+    video.pid=videoTrac[0].trackPid;
+
+    memset(&data,0,sizeof(data));
+    data.picStructure=pictureFrame;
+    
+    string indexName=string(file);
+    indexName=indexName+string(".idx2");
+    index=qfopen(indexName,"wt");
+
+    if(!index)
+    {
+        printf("[PsIndex] Cannot create %s\n",indexName.c_str());
+        return false;
+    }
+    writeSystem(file,true);
+    pkt=new tsPacketLinearTracker(videoTrac->trackPid, audioTracks);
+
+    FP_TYPE append=FP_APPEND;
+    pkt->open(file,append);
+    data.pkt=pkt;
+    fullSize=pkt->getSize();
+    int startCode;
+    decodingImage=false;
+#define likely(x) x
+#define unlikely(x) x
+      while(1)
+      {
+        startCode=pkt->findStartCode();
+        if(!pkt->stillOk()) break;
+
+          switch(startCode)
+                  {
+                  case 0x0f: // sequence start
+                          
+                          if(seq_found)
+                          {
+                              pkt->getInfo(&thisUnit.packetInfo);
+                              thisUnit.consumedSoFar=pkt->getConsumed();
+                              addUnit(data,unitTypeSps,thisUnit,4);
+                              decodingImage=false;
+                              break;
+                          }
+                          // Verify it is high/advanced profile
+                          {
+                          int seqSize=0;
+                          tsGetBits bits(pkt);
+                          if(!bits.peekBits(1)) continue; // simple/main profile
+
+                          if(!decodeVC1Seq(bits,video)) continue;
+
+                          seqSize=bits.getConsumed();
+                          video.extraDataLength=seqSize+4+1;
+                          memcpy(video.extraData+4,bits.data,seqSize);
+                            // Add info so that ffmpeg is happy
+                          video.extraData[0]=0;
+                          video.extraData[1]=0;
+                          video.extraData[2]=1;
+                          video.extraData[3]=0xf;
+                          video.extraData[seqSize+4+0]=0;
+                          seq_found=1;
+                          // Hi Profile
+                          printf("[VC1] Found seq start with %d x %d video\n",(int)video.w,(int)video.h);
+                          printf("[VC1] FPS : %d\n",(int)video.fps);
+                          printf("[VC1] sequence header is %d bytes\n",(int)seqSize);
+                          writeVideo(&video,ADM_TS_VC1);
+                          writeAudio();
+                          qfprintf(index,"[Data]");
+                          
+                          pkt->getInfo(&thisUnit.packetInfo);
+                          thisUnit.consumedSoFar=pkt->getConsumed();
+                          addUnit(data,unitTypeSps,thisUnit,seqSize+4);
+                          decodingImage=false;
+                          
+                          continue;
+                          }
+                          break;
+                    case 0x0D: //  Picture start
+                        { 
+                          int type;
+                          uint8_t buffer[4];
+                          uint32_t fType,sType;
+                          if(!seq_found)
+                          { 
+                                  continue;
+                                  printf("[TsIndexer]No sequence start yet, skipping..\n");
+                          }      
+                          pkt->getInfo(&thisUnit.packetInfo);
+                          thisUnit.consumedSoFar=pkt->getConsumed();
+                          
+                          tsGetBits bits(pkt);
+                          if(!decodeVC1Pic(bits,fType,sType)) continue;
+                          thisUnit.imageType=fType;
+                          updatePicStructure(video,sType);
+                          addUnit(data,unitTypePic,thisUnit,4);
+                          decodingImage=true;
+                          data.nbPics++;
+                        }
+                          break;
+                  default:
+                    break;
+                  }
+      }
+    
+        printf("\n");
+//        Mark(&data,&info,2);
+        qfprintf(index,"\n[End]\n");
+        qfprintf(index,"\n# Found %"LU" images \n",data.nbPics); // Size
+        qfprintf(index,"# Found %"LU" frame pictures\n",video.frameCount); // Size
+        qfprintf(index,"# Found %"LU" field pictures\n",video.fieldCount); // Size
+        qfclose(index);
+        index=NULL;
+        audioTracks=NULL;
+        delete pkt;
+        pkt=NULL;
+        return 1; 
+}
+/**
+    \fn decodeVc1Seq
+    \brief http://wiki.multimedia.cx/index.php?title=VC-1#Setup_Data_.2F_Sequence_Layer
+#warning we should de-escape it!
+        Large part of this borrowed from VLC
+        Advanced/High profile only
+*/
+bool TsIndexer::decodeVC1Seq(tsGetBits &bits,TSVideo &video)
+{
+
+int v;
+int consumed;
+    vc1Context.advanced=true;
+
+#define VX(a,b) v=bits.getBits(a);printf("[VC1] %d "#b"\n",v);consumed+=a;
+    VX(2,profile);
+    VX(3,level);
+
+    VX(2,chroma_format);
+    VX(3,Q_frame_rate_unused);
+    VX(5,Q_bit_unused);
+
+    VX(1,postproc_flag);
+
+    VX(12,coded_width);
+    video.w=v*2+2;
+    VX(12,coded_height);
+    video.h=v*2+2;
+
+    VX(1,pulldown_flag);
+    VX(1,interlaced_flag);
+    vc1Context.interlaced=v;
+    VX(1,frame_counter_flag);
+
+    VX(1,interpolation_flag);
+    vc1Context.interpolate=v;
+
+    VX(1,reserved_bit);
+    VX(1,psf);
+
+    VX(1,display_extension);
+    if(v)
+    {
+         VX(14,display_extension_coded_width);
+         VX(14,display_extension_coded_height);
+         VX(1,aspect_ratio_flag);
+     
+
+         if(v)
+         {
+                VX(4,aspect_ratio);
+                switch(v)
+                {
+                    case 15: video.ar=(bits.getBits(8)<<16)+bits.getBits(8);
+                             break;
+                    default:
+                             video.ar=(VC1_ar[v][0]<<16)+(VC1_ar[v][1]<<16);
+                             break;
+                }
+                printf("[VC1] Aspect ratio %d x %d\n",video.ar>>8,video.ar&0xff);
+         }
+    
+        VX(1,frame_rate);
+        if(v)
+        {
+                VX(1,frame_rate32_flag);
+                if(v)
+                {
+                    VX(16,frame_rate32);
+                    float f=v;
+                    f=(f+1)/32;
+                    f*=1000;
+                    video.fps=(uint32_t)f;
+                }else
+                {
+                    float den,num;
+                    VX(8,frame_rate_num)
+                    switch( v )
+                        {
+                        case 1: num = 24000; break;
+                        case 2: num = 25000; break;
+                        case 3: num = 30000; break;
+                        case 4: num = 50000; break;
+                        case 5: num = 60000; break;
+                        case 6: num = 48000; break;
+                        case 7: num = 72000; break;
+                        }
+                    VX(4,frame_rate_den)
+                    switch( v )
+                        {
+                        default:
+                        case 1: den = 1000; break;
+                        case 2: den = 1001; break;
+                        }
+
+                    float f=num*1000;
+                    f/=den;
+                    video.fps=(uint32_t)f;
+                }
+            }else
+            {
+                video.fps=25000;
+            }
+            //
+            VX(1,color_flag);
+            if(v){
+                    VX(8,color_prim);
+                    VX(8,transfer_char);
+                    VX(8,matrix_coef);
+                }
+    }
+    VX(1,hrd_param_flag);
+    int leaky=0;
+    if(v)
+    {
+        VX(5,hrd_num_leaky_buckets);
+        leaky=v;
+        VX(4,bitrate_exponent);
+        VX(4,buffer_size_exponent);
+        for(int i = 0; i < leaky; i++) 
+        {
+                bits.getBits(16);
+                bits.getBits(16);
+        }
+    }
+    // Now we need an entry point
+    bits.flush();
+    uint8_t a[4];
+    uint8_t entryPoint[4]={0,0,1,0x0E};
+    for(int i=0;i<4;i++) a[i]=bits.getBits(8);
+    for(int i=0;i<4;i++) printf("%02x ",a[i]);
+    printf(" as marker\n");
+    if(memcmp(a,entryPoint,4))
+    {
+        ADM_warning("Bad entry point");
+        return false;
+    }
+    VX(6,ep_flags);
+    VX(1,extended_mv);
+    int extended_mv=v;
+    VX(6,ep_flags2);
+
+    for(int i=0;i<leaky;i++)
+            bits.getBits(8);
+    VX(1,ep_coded_dimension);
+    if(v)
+    {
+         VX(12,ep_coded_width);
+         VX(12,ep_coded_height);
+    }
+    if(extended_mv) VX(1,dmv);
+    VX(1,range_mappy_flags);
+    if(v) VX(3,mappy_flags);
+    VX(1,range_mappuv_flags);
+    if(v) VX(3,mappuv_flags);
+    return true;
+
+}
+/**
+    \fn decodeVC1Pic
+    \brief Decode info from VC1 picture
+    Borrowed a lot from VLC also
+
+*/
+bool TsIndexer::decodeVC1Pic(tsGetBits &bits,uint32_t &frameType,uint32_t &frameStructure)
+{
+    frameStructure=3;
+    bool field=false;
+    if(vc1Context.interlaced)
+    {
+        if(bits.getBits(1))
+        {
+            if(bits.getBits(1))
+               field=true;
+        }
+    }
+    if(field)
+    {
+            int fieldType=bits.getBits(3);
+            frameStructure=1; // Top
+            switch(fieldType)
+            {
+                case 0: /* II */
+                case 1: /* IP */
+                case 2: /* PI */
+                    frameType=1;
+                    break;
+                case 3: /* PP */
+                    frameType=2;
+                    break;
+                case 4: /* BB */
+                case 5: /* BBi */
+                case 6: /* BiB */
+                case 7: /* BiBi */
+                    frameType=3;
+                    break;
+
+            }
+    }else
+    {
+                frameStructure=3; // frame
+                if( !bits.getBits(1))
+                    frameType=2;
+                else if( !bits.getBits(1))
+                    frameType=3;
+                else if( !bits.getBits(1))
+                    frameType=1;
+                else if( !bits.getBits(1))
+                    frameType=3;
+                else
+                    frameType=2;
+    }
+
+    return true;
+}
+/********************************************************************************************/
+/********************************************************************************************/
+/********************************************************************************************/
+/********************************************************************************************/
+
+//
+
+//EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/CMakeLists.txt	2010-11-13 14:25:59 UTC (rev 6756)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/CMakeLists.txt	2010-11-13 14:26:03 UTC (rev 6757)
@@ -4,6 +4,8 @@
 	ADM_tsPlugin.cpp
 	ADM_tsIndex.cpp
 	ADM_tsIndexH264.cpp
+        ADM_tsIndexVC1.cpp
+        ADM_tsIndexMpeg2.cpp
 	ADM_tsReadIndex.cpp
 	ADM_tsAudio.cpp
 	ADM_tsAudioProbe.cpp



From mean at mail.berlios.de  Sat Nov 13 15:26:05 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 13 Nov 2010 15:26:05 +0100
Subject: [Avidemux-svn-commit] r6758 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20101113142605.5F04D480F56@sheep.berlios.de>

Author: mean
Date: 2010-11-13 15:26:05 +0100 (Sat, 13 Nov 2010)
New Revision: 6758

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexMpeg2.cpp
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexVC1.cpp
Log:
[TsIndexer] cleanup

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h	2010-11-13 14:26:03 UTC (rev 6757)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h	2010-11-13 14:26:05 UTC (rev 6758)
@@ -63,11 +63,6 @@
     uint8_t  extraData[VC1_MAX_SEQ_SIZE];
 };
 
-typedef enum
-{
-    idx_startAtImage,
-    idx_startAtGopOrSeq
-}indexerState;
 
 typedef enum
 {
@@ -83,7 +78,6 @@
     uint32_t frameType;
     pictureStructure picStructure;
     uint32_t nbPics;
-    indexerState state;
     tsPacketLinear *pkt;
     int32_t        nextOffset;
     uint64_t beginPts,beginDts;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp	2010-11-13 14:26:03 UTC (rev 6757)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp	2010-11-13 14:26:05 UTC (rev 6758)
@@ -1,10 +1,6 @@
 /***************************************************************************
-                        Mpeg2 in PS indexer                                            
-                             
-    VC1: /!\ Escaping not done (yet)
-
-    copyright            : (C) 2005/2009 by mean
-    email                : fixounet at free.fr
+    \brief TS indexer, H264 video
+    \author mean fixounet at free.fr
  ***************************************************************************/
 
 /***************************************************************************
@@ -315,7 +311,6 @@
       result=true;
 the_end:
         printf("\n");
-#warning TODO PURGE    
         qfprintf(index,"\n[End]\n");
         qfclose(index);
         index=NULL;

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexMpeg2.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexMpeg2.cpp	2010-11-13 14:26:03 UTC (rev 6757)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexMpeg2.cpp	2010-11-13 14:26:05 UTC (rev 6758)
@@ -1,10 +1,6 @@
 /***************************************************************************
-                        Mpeg2 in PS indexer                                            
-                             
-    VC1: /!\ Escaping not done (yet)
-
-    copyright            : (C) 2005/2009 by mean
-    email                : fixounet at free.fr
+    \brief TS indexer, Mpeg2 video
+    \author mean fixounet at free.fr
  ***************************************************************************/
 
 /***************************************************************************

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexVC1.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexVC1.cpp	2010-11-13 14:26:03 UTC (rev 6757)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexVC1.cpp	2010-11-13 14:26:05 UTC (rev 6758)
@@ -1,10 +1,6 @@
 /***************************************************************************
-                        Mpeg2 in PS indexer                                            
-                             
-    VC1: /!\ Escaping not done (yet)
-
-    copyright            : (C) 2005/2009 by mean
-    email                : fixounet at free.fr
+    \brief TS indexer, VC1 video
+    \author mean fixounet at free.fr
  ***************************************************************************/
 
 /***************************************************************************



From mean at mail.berlios.de  Sat Nov 13 15:26:00 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 13 Nov 2010 15:26:00 +0100
Subject: [Avidemux-svn-commit] r6756 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20101113142600.2B6F2480F68@sheep.berlios.de>

Author: mean
Date: 2010-11-13 15:25:59 +0100 (Sat, 13 Nov 2010)
New Revision: 6756

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp
Log:
[TS/H264] Add audio back

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h	2010-11-13 14:25:57 UTC (rev 6755)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.h	2010-11-13 14:25:59 UTC (rev 6756)
@@ -148,7 +148,7 @@
         bool                    decodeVC1Pic(tsGetBits &bits,uint32_t &frameType,uint32_t &frameStructure);
         // H264
         bool                    addUnit(indexerData &data,int unitType,const H264Unit &unit,uint32_t overRead);
-        bool                    dumpUnits(indexerData &data,uint64_t nextConsumed);
+        bool                    dumpUnits(indexerData &data,uint64_t nextConsumed,const dmxPacketInfo *nextPacket);
 public:
                 TsIndexer(listOfTsAudioTracks *tr);
                 ~TsIndexer();

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp	2010-11-13 14:25:57 UTC (rev 6755)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndexH264.cpp	2010-11-13 14:25:59 UTC (rev 6756)
@@ -21,7 +21,7 @@
 /**
     \fn dumpUnits
 */
-bool TsIndexer::dumpUnits(indexerData &data,uint64_t nextConsumed)
+bool TsIndexer::dumpUnits(indexerData &data,uint64_t nextConsumed,const dmxPacketInfo *nextPacket)
 {
         // if it contain a SPS or a intra/idr, we start a new line
         bool mustFlush=false;
@@ -54,6 +54,20 @@
         H264Unit      *picUnit=&(listOfUnits[picIndex]);
         if(mustFlush) 
         {
+            if(audioTracks)
+            {
+                qfprintf(index,"\nAudio bf:%08"LLX" ",nextPacket->startAt);
+                packetTSStats *s;
+                uint32_t na;
+                pkt->getStats(&na,&s);      
+                ADM_assert(na==audioTracks->size());
+                for(int i=0;i<na;i++)
+                {   
+                    packetTSStats *current=s+i;
+                    qfprintf(index,"Pes:%x:%08"LLX":%"LD":%"LLD" ",
+                                current->pid,current->startAt,current->startSize,current->startDts);
+                }                
+            }
             data.beginPts=pic->pts;
             data.beginDts=pic->dts;
             // start a new line
@@ -92,7 +106,7 @@
         if(n)
             if(listOfUnits[n-1].unitType==unitTypePic)
             {
-                dumpUnits(data,myUnit.consumedSoFar-overRead);
+                dumpUnits(data,myUnit.consumedSoFar-overRead,&(unit.packetInfo));
             }
         listOfUnits.push_back(myUnit);
         return true;



From mean at mail.berlios.de  Sun Nov 14 09:34:21 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Nov 2010 09:34:21 +0100
Subject: [Avidemux-svn-commit] r6760 -
	branches/avidemux_2.6_branch_mean/addons
Message-ID: <20101114083421.EE226480FB1@sheep.berlios.de>

Author: mean
Date: 2010-11-14 09:34:21 +0100 (Sun, 14 Nov 2010)
New Revision: 6760

Added:
   branches/avidemux_2.6_branch_mean/addons/ts_to_mkv.bash
Log:
[Script] Ts 2 mkv

Added: branches/avidemux_2.6_branch_mean/addons/ts_to_mkv.bash
===================================================================
--- branches/avidemux_2.6_branch_mean/addons/ts_to_mkv.bash	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/addons/ts_to_mkv.bash	2010-11-14 08:34:21 UTC (rev 6760)
@@ -0,0 +1,26 @@
+
+
+INDIR=/work/samples/in
+OUTDIR=/work/samples/out
+SCRIPT=/tmp/script
+for i in $INDIR/*; do
+echo "Processing $i"
+infile="$i"
+name=` echo $i | sed 's/^.*\///g'`
+outfile=` echo $name | sed 's/mpg$/mkv/g'`
+echo "$infile -> $outfile"
+if [ -f "$OUTDIR/$outfile" ] ; then 
+   echo "   $outfile already present, skipping"
+else
+   echo "Creating script file..."
+        rm -f $SCRIPT
+        echo "adm=Avidemux()" > $SCRIPT
+        echo "adm.loadVideo(\"$infile\")" >> $SCRIPT
+        echo "adm.setContainer(\"MKV\")" >> $SCRIPT
+        echo "adm.save(\"$OUTDIR"/"$outfile\")" >> $SCRIPT
+        cat $SCRIPT
+        echo "Running script..."
+        avidemux3_cli --runpy $SCRIPT --quit
+# >& /tmp/log_ts2mkv
+fi
+done



From mean at mail.berlios.de  Sun Nov 14 09:34:20 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Nov 2010 09:34:20 +0100
Subject: [Avidemux-svn-commit] r6759 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg:
	libavcodec libavformat
Message-ID: <20101114083421.17C584808C8@sheep.berlios.de>

Author: mean
Date: 2010-11-14 09:34:20 +0100 (Sun, 14 Nov 2010)
New Revision: 6759

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat/CMakeLists.txt
Log:
[FFmpeg] remove duplicate entries

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt	2010-11-13 14:26:05 UTC (rev 6758)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavcodec/CMakeLists.txt	2010-11-14 08:34:20 UTC (rev 6759)
@@ -26,7 +26,7 @@
         dca.c
         ac3enc.c  ac3.c  ac3tab.c   ac3_parser.c
         eac3dec.c ac3dec.c ac3dec_data.c eac3dec_data.c
-        aacenc.c aaccoder.c  aactab.c psymodel.c aacpsy.c iirfilter.c
+        aacenc.c aaccoder.c  aactab.c psymodel.c  iirfilter.c
 	dvbsub_parser.c  dvbsubdec.c  dvbsub.c  xiph.c  sp5xdec.c  
         nellymoserdec.c nellymoser.c
 	ADM_lavcodec.cpp  pthread.c  huffman.c  wmv2dec.c  wmv2.c  h264pred.c  intrax8.c

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat/CMakeLists.txt	2010-11-13 14:26:05 UTC (rev 6758)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_ffmpeg/libavformat/CMakeLists.txt	2010-11-14 08:34:20 UTC (rev 6759)
@@ -4,7 +4,6 @@
 	mpeg.c  utils.c  avio.c  aviobuf.c  cutils.c  img2.c  file.c  mpegtsenc.c
 	movenc.c  avi.c avienc.c  wav.c  mov.c  matroska.c  isom.c  isom.h  
 	flvenc.c  matroskaenc.c metadata.c metadata_compat.c options.c
-        flacenc.c
 	avc.c raw.c  riff.c
         mpegenc.c
         movenchint.c sdp.c adtsenc.c flacenc.c flacenc_header.c vorbiscomment.c



From mean at mail.berlios.de  Sun Nov 14 09:38:22 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 14 Nov 2010 09:38:22 +0100
Subject: [Avidemux-svn-commit] r6761 -
	branches/avidemux_2.6_branch_mean/addons
Message-ID: <20101114083822.8DE314808C8@sheep.berlios.de>

Author: mean
Date: 2010-11-14 09:38:22 +0100 (Sun, 14 Nov 2010)
New Revision: 6761

Modified:
   branches/avidemux_2.6_branch_mean/addons/ts_to_mkv.bash
Log:
[ts2mkv]

Modified: branches/avidemux_2.6_branch_mean/addons/ts_to_mkv.bash
===================================================================
--- branches/avidemux_2.6_branch_mean/addons/ts_to_mkv.bash	2010-11-14 08:34:21 UTC (rev 6760)
+++ branches/avidemux_2.6_branch_mean/addons/ts_to_mkv.bash	2010-11-14 08:38:22 UTC (rev 6761)
@@ -1,9 +1,10 @@
+#!/bin/bash
 
-
-INDIR=/work/samples/in
-OUTDIR=/work/samples/out
+INDIR=/capture/links
+OUTDIR=/capture/linksMkv
 SCRIPT=/tmp/script
-for i in $INDIR/*; do
+mkdir -p $OUTDIR
+for i in $INDIR/*.mpg; do
 echo "Processing $i"
 infile="$i"
 name=` echo $i | sed 's/^.*\///g'`



From mean at mail.berlios.de  Mon Nov 15 07:26:31 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Nov 2010 07:26:31 +0100
Subject: [Avidemux-svn-commit] r6762 - in
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs: include src
Message-ID: <20101115062631.A99F8481185@sheep.berlios.de>

Author: mean
Date: 2010-11-15 07:26:31 +0100 (Mon, 15 Nov 2010)
New Revision: 6762

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
Log:
[Jobs] Slightly better ui

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-14 08:38:22 UTC (rev 6761)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-15 06:26:31 UTC (rev 6762)
@@ -5,6 +5,16 @@
 #include "ui_uiJobs.h"
 #include <vector>
 using std::vector;
+
+typedef enum
+{
+    JobAction_setReady,
+    JobAction_setOk,
+    JobAction_runNow,
+    JobAction_delete
+}JobAction;
+
+
 class ADMJob;
 /**
     \class jobWindow
@@ -16,11 +26,24 @@
 public:
                 jobWindow(void);
 	virtual     ~jobWindow();	    
-	
 protected:
+    int         getActiveIndex(void)	;
+    bool        runOneJob(ADMJob &job)   ;
+
+protected:
     Ui_jobs     ui;
     void        refreshList(void);
-    vector      <ADMJob> listOfJob;
-//public slots:
+    vector      <ADMJob> listOfJob;
+    void        runAction(JobAction action);
+public slots:
+    // Actions
+    
+    void        del(void); 
+    void        setOk(void); 
+    void        setReady(void); 
+    void        runNow(void); 
+    void        quit(void);
+    void        runAllJob(void);
 };
 #endif	// Q_gui2_h
+

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-14 08:38:22 UTC (rev 6761)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-15 06:26:31 UTC (rev 6762)
@@ -16,13 +16,19 @@
 #include "ADM_coreJobs.h"
 
 
-static QTableWidgetItem *fromText(const string &t)
+static QTableWidgetItem *fromText(const string &t,int id)
 {
     QString s(QString::fromUtf8(t.c_str()));
-    QTableWidgetItem *w=new QTableWidgetItem(s,0);
+    QTableWidgetItem *w=new QTableWidgetItem(s,id);
+    Qt::ItemFlags flags=w->flags();
+    flags&=~Qt::ItemIsEditable;
+    w->setFlags(flags);
     return w;
 }
-
+string date2String(uint64_t date)
+{
+    return string("12/12/2010 10:20:10");
+}
 /**
     \fn refreshList
 */
@@ -31,6 +37,23 @@
       QTableWidget *list=ui.tableWidget;
       list->clear();
       listOfJob.clear();
+      
+      
+      
+      
+// set titles
+     QTableWidgetItem *jb=fromText("Job",255);
+     QTableWidgetItem *outputFile=fromText("Output",255);
+     QTableWidgetItem *status=fromText("Status",255);
+     QTableWidgetItem *start=fromText("Start Time",255);
+     QTableWidgetItem *end=fromText("End Time",255);
+     ui.tableWidget->setHorizontalHeaderItem(0,jb);
+     ui.tableWidget->setHorizontalHeaderItem(1,outputFile);
+     ui.tableWidget->setHorizontalHeaderItem(2,start);
+     ui.tableWidget->setHorizontalHeaderItem(3,end);
+     ui.tableWidget->setHorizontalHeaderItem(4,status);
+
+
       if(false==ADM_jobGet(listOfJob)) return ;
 
       int n=listOfJob.size();
@@ -39,9 +62,11 @@
       list->setRowCount(n);
       for(int i=0;i<n;i++)
       {
-           QTableWidgetItem *nm=fromText(listOfJob[i].jobName);
-           QTableWidgetItem *out=fromText(listOfJob[i].outputFileName);
+           QTableWidgetItem *nm=fromText(listOfJob[i].jobName,i);
+           QTableWidgetItem *out=fromText(listOfJob[i].outputFileName,i);
            string s;
+           string start="X";
+           string end="X";
             switch(listOfJob[i].status)
             {
                 case ADM_JOB_IDLE:
@@ -52,30 +77,61 @@
                             break;
                 case ADM_JOB_OK:
                             s=string("Success");
+                            start=date2String(listOfJob[i].startTime);
+                            end=date2String(listOfJob[i].endTime);
                             break;
                 case ADM_JOB_KO:
                             s=string("Failed");
+                            start=date2String(listOfJob[i].startTime);
+                            end=date2String(listOfJob[i].endTime);
                             break;
                 default:
                             s=string("???");
                             break;
             }
-        QTableWidgetItem *status=fromText (s);
+        QTableWidgetItem *status=fromText (s,i);
+        QTableWidgetItem *startItem=fromText (start,i);
+        QTableWidgetItem *endItem=fromText (end,i);
         list->setItem(i,0,nm);
         list->setItem(i,1,out);
-        list->setItem(i,2,status);
+        list->setItem(i,2,startItem);
+        list->setItem(i,3,endItem);
+        list->setItem(i,4,status);
       }
+      list->resizeColumnsToContents();
 }
 
 
 /**
     \fn ctor
-*/
+*/
+#define QT_NOOP(x) x
 jobWindow::jobWindow(void) : QDialog()
 {
     ui.setupUi(this);
-    ui.tableWidget->setColumnCount(3); // Job name, fileName, Status
-    refreshList();
+    ui.tableWidget->setColumnCount(5); // Job name, fileName, Status
+
+    // Add some right click menu...
+    ui.tableWidget->setContextMenuPolicy(Qt::ActionsContextMenu);
+    // Add some right click menu...
+   QAction *del = new  QAction(QString("Delete"),this);
+   QAction *runNow = new  QAction(QString("Run Now"),this);
+   QAction *setOk = new  QAction(QString("Force Status to success"),this);
+   QAction *setReady = new  QAction(QString("Force Status to ready"),this);
+   ui.tableWidget->addAction(del);
+   ui.tableWidget->addAction(runNow);
+   ui.tableWidget->addAction(setOk);
+   ui.tableWidget->addAction(setReady);
+   connect(del,SIGNAL(activated()),this,    SLOT(del()));
+   connect(runNow,SIGNAL(activated()),this, SLOT(runNow()));
+   connect(setOk,SIGNAL(activated()),this,  SLOT(setOk()));
+   connect(setReady,SIGNAL(activated()),this,SLOT(setReady()));
+
+   connect(ui.pushButtonQuit,SIGNAL(pressed()),this,SLOT(quit()));
+   connect(ui.pushButtonRunAll,SIGNAL(pressed()),this,SLOT(runAllJob()));
+
+   refreshList();
+
 }
 /**
     \fn dtor
@@ -97,8 +153,116 @@
     delete app;
     return true;
 }
+/**
+    \fn del
+    \brief delete the currently selected jobs
+*/
+int jobWindow::getActiveIndex(void)
+{
+        QTableWidgetItem *item=ui.tableWidget->currentItem();
+        if(!item) return -1;
+        int index=item->type(); 
+        return index;
+}
+/**
+    \fn runAction
+*/
+void jobWindow::runAction(JobAction action)
+{
+        int index=getActiveIndex();
+        ADM_info("%d command for index %d\n",action,index);
+        if(index==-1) return;
+        // get the job
+        if(index>listOfJob.size())
+        {
+            ADM_error("index out of bound : %d/%d\n",index,listOfJob.size());
+            return ;
+        }
+        ADMJob *j=&(listOfJob[index]);
+        switch(action)
+        {
+            case   JobAction_setReady:          
+                        j->status=ADM_JOB_IDLE;
+                        ADM_jobUpdate(*j);
+                        refreshList();
+                        break;
+            case   JobAction_setOk:
+                        j->status=ADM_JOB_OK;
+                        ADM_jobUpdate(*j);
+                        refreshList();
+                        break;
+            case   JobAction_runNow:
+                        {
+                            runOneJob(*j);
+                        }
+                        break;
+                        
+            default:
+                        ADM_warning("Command %d no handled\n",action);
+                        break;
+        }
+}
 
+void jobWindow::del(void)
+{
+    runAction(JobAction_delete);
+}
+void jobWindow::setOk(void)
+{
+    runAction(JobAction_setOk);
+}
+void jobWindow::setReady(void)
+{
+    runAction(JobAction_setReady);
+}
+void jobWindow::runNow(void)
+{
+    runAction(JobAction_runNow);
+}
+ 
+/**
+    \fn runOneJob
+*/
+bool jobWindow::runOneJob( ADMJob &job)   
+{
+    bool r=false;
+    job.startTime=getTimeOfTheDay();
+    job.status=ADM_JOB_RUNNING;
+    ADM_jobUpdate(job);
+    
+    r=true; // << exec
 
+    if(r) job.status=ADM_JOB_OK;
+        else job.status=ADM_JOB_KO;
+    job.endTime=getTimeOfTheDay();
+    ADM_jobUpdate(job);
+    refreshList();
+    ADM_info("Running job id = %d\n",job.id);
+    return r;
+}
+/**
+    \fn quit
+    \brief run selected jobs whatever its status
+*/
+
+void jobWindow::quit(void)
+{
+    done(1);
+}
+/**
+    \fn runAllJob
+*/
+void jobWindow::runAllJob(void)
+{
+    int n=listOfJob.size();
+    for(int i=0;i<n;i++)
+    {
+            ADMJob *j=&(listOfJob[i]);
+            if(j->status==ADM_JOB_IDLE)
+                runOneJob(*j);
+    }
+    return ;
+}
 #if 0
 bool jobRun(void)
 {
@@ -155,4 +319,4 @@
         }
         return true;
 }
-#endif
\ No newline at end of file
+#endif



From mean at mail.berlios.de  Mon Nov 15 07:26:32 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 15 Nov 2010 07:26:32 +0100
Subject: [Avidemux-svn-commit] r6763 -
	branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS
Message-ID: <20101115062632.BF481481185@sheep.berlios.de>

Author: mean
Date: 2010-11-15 07:26:32 +0100 (Mon, 15 Nov 2010)
New Revision: 6763

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
Log:
[TsIndexer] Workaround bug on win32

Modified: branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-11-15 06:26:31 UTC (rev 6762)
+++ branches/avidemux_2.6_branch_mean/avidemux_plugins/ADM_demuxers/MpegTS/ADM_tsIndex.cpp	2010-11-15 06:26:32 UTC (rev 6763)
@@ -267,11 +267,10 @@
                 else deltaDts=pic->dts-data.beginDts;            
 
 
-            qfprintf(index," %c%c:%06"LX":%"LLD":%"LLD,
-                                    Type[picUnit->imageType],
-                                    Structure[pictStruct&3],
-                                    nextConsumed-beginConsuming,
-                                    deltaPts,deltaDts);
+        qfprintf(index," %c%c",Type[picUnit->imageType],Structure[pictStruct&3]);
+        qfprintf(index,":%06"LX,nextConsumed-beginConsuming);
+        qfprintf(index,":%"LLD":%"LLD,deltaPts,deltaDts);
+    
         beginConsuming=nextConsumed;
         listOfUnits.clear();
         return true;



From mean at mail.berlios.de  Sat Nov 20 09:28:16 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 20 Nov 2010 09:28:16 +0100
Subject: [Avidemux-svn-commit] r6764 - in
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs: include src
Message-ID: <20101120082816.92B02480B59@sheep.berlios.de>

Author: mean
Date: 2010-11-20 09:28:16 +0100 (Sat, 20 Nov 2010)
New Revision: 6764

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt
Log:
[Jobs] Begin to hook spawn etc...

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-15 06:26:32 UTC (rev 6763)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-20 08:28:16 UTC (rev 6764)
@@ -4,8 +4,10 @@
 #include <QtGui/QWidget>
 #include "ui_uiJobs.h"
 #include <vector>
+#include <string>
+using std::string;
 using std::vector;
-
+class jobWindow;
 typedef enum
 {
     JobAction_setReady,
@@ -14,6 +16,13 @@
     JobAction_delete
 }JobAction;
 
+typedef struct
+{
+    jobWindow *me;
+    const char *exeName;
+    string script;
+    string outputFile;
+}spawnData;
 
 class ADMJob;
 /**
@@ -25,11 +34,12 @@
 
 public:
                 jobWindow(void);
-	virtual     ~jobWindow();	    
+	virtual     ~jobWindow();
+    bool        runProcess(spawnData *data);
 protected:
     int         getActiveIndex(void)	;
     bool        runOneJob(ADMJob &job)   ;
-
+    bool        spawnChild(const char *exeName, const string &script, const string &outputFile);
 protected:
     Ui_jobs     ui;
     void        refreshList(void);

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-15 06:26:32 UTC (rev 6763)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-20 08:28:16 UTC (rev 6764)
@@ -221,26 +221,6 @@
 }
  
 /**
-    \fn runOneJob
-*/
-bool jobWindow::runOneJob( ADMJob &job)   
-{
-    bool r=false;
-    job.startTime=getTimeOfTheDay();
-    job.status=ADM_JOB_RUNNING;
-    ADM_jobUpdate(job);
-    
-    r=true; // << exec
-
-    if(r) job.status=ADM_JOB_OK;
-        else job.status=ADM_JOB_KO;
-    job.endTime=getTimeOfTheDay();
-    ADM_jobUpdate(job);
-    refreshList();
-    ADM_info("Running job id = %d\n",job.id);
-    return r;
-}
-/**
     \fn quit
     \brief run selected jobs whatever its status
 */

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt	2010-11-15 06:26:32 UTC (rev 6763)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt	2010-11-20 08:28:16 UTC (rev 6764)
@@ -16,7 +16,8 @@
                 ADM_jobControl.cpp)
 SET(ADM_JOB_SRCS 
                 ADM_jobs.cpp
-                 ADM_jobControl.cpp
+                ADM_jobControl.cpp
+                ADM_runOneJob.cpp
                 ${ADM_JOBS_headers}
                 ${ADM_JOBS_source}
                 



From mean at mail.berlios.de  Sat Nov 20 09:28:18 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 20 Nov 2010 09:28:18 +0100
Subject: [Avidemux-svn-commit] r6765 - in branches/avidemux_2.6_branch_mean:
	avidemux/common avidemux_core/ADM_core/include
	avidemux_core/ADM_core/src
Message-ID: <20101120082818.27F61480B59@sheep.berlios.de>

Author: mean
Date: 2010-11-20 09:28:17 +0100 (Sat, 20 Nov 2010)
New Revision: 6765

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_misc.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_misc.cpp
Log:
[core] Add simple time handling functions

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-11-20 08:28:16 UTC (rev 6764)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/main.cpp	2010-11-20 08:28:17 UTC (rev 6765)
@@ -184,10 +184,11 @@
 #if defined(__USE_LARGEFILE) && defined(__USE_LARGEFILE64)
 	printf("\nLarge file available: %d offset\n", __USE_FILE_OFFSET64);
 #endif
-
+        // getTime
+        printf("Current time :%s\n",ADM_epochToString(ADM_getSecondsSinceEpoch()));
 	// Start counting memory
 	ADM_memStatInit();
-    ADM_InitMemcpy();
+        ADM_InitMemcpy();
 	printf("\nInitialising prefs\n");
 	initPrefs();
 	prefs->load();

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_misc.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_misc.h	2010-11-20 08:28:16 UTC (rev 6764)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/include/ADM_misc.h	2010-11-20 08:28:17 UTC (rev 6765)
@@ -30,8 +30,11 @@
 void            ADM_LowerCase(char *string);
 
 uint32_t        getTime( int called );
-uint32_t 	getTimeOfTheDay(void);
+uint32_t 	    getTimeOfTheDay(void);
 
+uint64_t        ADM_getSecondsSinceEpoch(void);
+const char      *ADM_epochToString(uint64_t epoch);
+
 #ifdef HAVE_GETTIMEOFDAY
 	#define TIMZ struct timezone
 #else

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_misc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_misc.cpp	2010-11-20 08:28:16 UTC (rev 6764)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_misc.cpp	2010-11-20 08:28:17 UTC (rev 6765)
@@ -73,6 +73,32 @@
     tt += 1000 * (timev.tv_sec - timev_s.tv_sec);
     return (tt);
 }
+
+/**
+    \fn    ADM_getSecondsSinceEpoch
+    \brief returns the number of seconds since epoch
+*/
+uint64_t ADM_getSecondsSinceEpoch(void)
+{
+    struct timeval timev;
+    TIMZ timez;
+
+    uint64_t tt;
+
+   
+    tt =  (timev.tv_sec);
+    return tt;
+}
+/**
+    \fn ADM_epochToString
+    \brief convert number of second to string
+*/
+const char *ADM_epochToString(uint64_t epoch)
+{
+    time_t clock=(__TIME_T_TYPE)epoch;
+    return ctime(&clock);
+}
+
 uint32_t getTimeOfTheDay(void)
 {
   



From mean at mail.berlios.de  Sat Nov 20 09:28:19 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 20 Nov 2010 09:28:19 +0100
Subject: [Avidemux-svn-commit] r6766 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src
Message-ID: <20101120082819.50613480B59@sheep.berlios.de>

Author: mean
Date: 2010-11-20 09:28:19 +0100 (Sat, 20 Nov 2010)
New Revision: 6766

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_misc.cpp
Log:
[Epoch] Calling the actual function helps...

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_misc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_misc.cpp	2010-11-20 08:28:17 UTC (rev 6765)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_misc.cpp	2010-11-20 08:28:19 UTC (rev 6766)
@@ -85,8 +85,8 @@
 
     uint64_t tt;
 
-   
-    tt =  (timev.tv_sec);
+    gettimeofday(&timev, &timez);
+    tt =  (uint64_t)(timev.tv_sec);
     return tt;
 }
 /**



From mean at mail.berlios.de  Sat Nov 20 09:28:20 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 20 Nov 2010 09:28:20 +0100
Subject: [Avidemux-svn-commit] r6767 -
	branches/avidemux_2.6_branch_mean/cmake/sql
Message-ID: <20101120082820.513B2480B59@sheep.berlios.de>

Author: mean
Date: 2010-11-20 09:28:20 +0100 (Sat, 20 Nov 2010)
New Revision: 6767

Removed:
   branches/avidemux_2.6_branch_mean/cmake/sql/jobs.sql
   branches/avidemux_2.6_branch_mean/cmake/sql/str-jobs
Modified:
   branches/avidemux_2.6_branch_mean/cmake/sql/update.sh
Log:
[sql] Properly generate include/src

Deleted: branches/avidemux_2.6_branch_mean/cmake/sql/jobs.sql
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/sql/jobs.sql	2010-11-20 08:28:19 UTC (rev 6766)
+++ branches/avidemux_2.6_branch_mean/cmake/sql/jobs.sql	2010-11-20 08:28:20 UTC (rev 6767)
@@ -1,5 +0,0 @@
-SQLite format 3   @                                                                     -?-   e ??e                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   P++Ytablesqlite_sequencesqlite_sequenceCREATE TABLE sqlite_sequence(name,seq)?~?_tablejobsjobsCREATE TABLE jobs(id integer primary key autoincrement not null,jscript varchar(100) default '' not null,jobname varchar(100) default '' not null,outputFile varchar(256) default '' not null,status integer,startTime date,endTime date)FetableversionversionCREATE T
 ABLE version(value integer not null)-   ? ?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                    -                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                             -                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                 
\ No newline at end of file

Deleted: branches/avidemux_2.6_branch_mean/cmake/sql/str-jobs
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/sql/str-jobs	2010-11-20 08:28:19 UTC (rev 6766)
+++ branches/avidemux_2.6_branch_mean/cmake/sql/str-jobs	2010-11-20 08:28:20 UTC (rev 6767)
@@ -1,12 +0,0 @@
-PRAGMA foreign_keys=OFF;
-BEGIN TRANSACTION;
-CREATE TABLE jobs(
-id integer primary key autoincrement not null,
-jscript varchar(100) default '' not null,
-jobname varchar(100) default '' not null,
-outputFile varchar(256) default '' not null,
-status integer,
-startTime date,
-endTime date
-);
-COMMIT;

Modified: branches/avidemux_2.6_branch_mean/cmake/sql/update.sh
===================================================================
--- branches/avidemux_2.6_branch_mean/cmake/sql/update.sh	2010-11-20 08:28:19 UTC (rev 6766)
+++ branches/avidemux_2.6_branch_mean/cmake/sql/update.sh	2010-11-20 08:28:20 UTC (rev 6767)
@@ -1,2 +1,3 @@
 sqlite3 ~/.avidemux6/jobs.sql .d > dump
-sql2class -sqlite -prefix -lib /usr dump
+#sql2class -sqlite -global -license -wrapped  -lib $PWD dump
+sql2class -sqlite -build -global -prefix $PWD -lib sqlJobs -namespace db -overwrite dump



From mean at mail.berlios.de  Sat Nov 20 09:28:21 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 20 Nov 2010 09:28:21 +0100
Subject: [Avidemux-svn-commit] r6768 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs:
	include src
Message-ID: <20101120082821.840AE480B59@sheep.berlios.de>

Author: mean
Date: 2010-11-20 09:28:21 +0100 (Sat, 20 Nov 2010)
New Revision: 6768

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/sqlJobs.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/sqlJobs.cpp
Removed:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/libjobdb.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/libjobdb.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/CMakeLists.txt
Log:
[sql] Update generated code

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/libjobdb.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/libjobdb.h	2010-11-20 08:28:20 UTC (rev 6767)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/libjobdb.h	2010-11-20 08:28:21 UTC (rev 6768)
@@ -1,104 +0,0 @@
-/*
- *	 /home/fx/workspace/gitted/cmake/sql/include/libjobdb.h
- *	 Generated by sql2class v1.9.3 by (C) AH 2000-2006
- *	  using command line
- *	  $ sql2class -build -sqlite -lib libjobdb str-jobs -namespace db -overwrite -prefix /home/fx/workspace/gitted/cmake/sql/
- *	 Date: Sat Nov  6 16:51:41 2010
- */
-
-/*
-Copyright (C) 2001-2006  Anders Hedstrom (grymse at alhem.net)
-
-This program is free software; you can redistribute it and/or
-modify it under the terms of the GNU General Public License
-as published by the Free Software Foundation; either version 2
-of the License, or (at your option) any later version.
-
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
-
-You should have received a copy of the GNU General Public License
-along with this program; if not, write to the Free Software
-Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-*/
-
-#include <stdio.h>
-#include <stdlib.h>
-#include <string.h>
-#include <ADM_sqlite3.h>
-#include <libsqlitewrapped.h>
-#include <map>
-
-#include <vector>
-#include <string>
-
-#ifndef _LIBJOBDB_H
-#define _LIBJOBDB_H
-
-#ifdef _WIN32
-#define strncasecmp strnicmp
-#define strcasecmp stricmp
-#endif // _WIN32
-
-/**
- **  Class 'Jobs' and 'cJobs'
- **/
-
-namespace db
-{
-class Jobs {
-public:
-	Jobs(Database *);
-	Jobs(Database *,const std::string& );
-	Jobs(Database *,Query *,int = 0 /* offset */);
-	Jobs(Database&,long id);
-	~Jobs();
-	Database& GetDatabase() { return *database; }
-
-	unsigned long long int insert();
-	void update();
-	void save();
-	void erase();
-	std::string xml();
-	std::string xml(const std::string& ,const std::string& );
-	size_t num_cols();
-
-	long GetId() { return this -> id; }
-	void SetId(long x) { this -> id = x; }
-	const char *GetJscript() { return this -> jscript.c_str(); }
-	void SetJscript(const std::string&  x) { this -> jscript = x; }
-	const char *GetJobname() { return this -> jobname.c_str(); }
-	void SetJobname(const std::string&  x) { this -> jobname = x; }
-	const char *GetOutputfile() { return this -> outputfile.c_str(); }
-	void SetOutputfile(const std::string&  x) { this -> outputfile = x; }
-	long GetStatus() { return this -> status; }
-	void SetStatus(long x) { this -> status = x; }
-	const char *GetStarttime() { return this -> starttime.c_str(); }
-	void SetStarttime(const std::string&  x) { this -> starttime = x; }
-	const char *GetEndtime() { return this -> endtime.c_str(); }
-	void SetEndtime(const std::string&  x) { this -> endtime = x; }
-
-	// table columns
-private:
-	long                     id; // integer
-	std::string              jscript; // varchar(100)
-	std::string              jobname; // varchar(100)
-	std::string              outputfile; // varchar(256)
-	long                     status; // integer
-	std::string              starttime; // date
-	std::string              endtime; // date
-	//
-	void clear();
-	void spawn(const std::string& );
-	void spawn(Query *,int = 0 /* offset */);
-	void select(const std::string& );
-	void update(long id);
-	//
-	Database *database;
-	short new_object;
-}; // End of class 'Jobs'
-
-} // end of namespace
-#endif // _LIBJOBDB_H

Copied: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/sqlJobs.h (from rev 6767, branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/libjobdb.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/sqlJobs.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/sqlJobs.h	2010-11-20 08:28:21 UTC (rev 6768)
@@ -0,0 +1,142 @@
+/*
+ *	 /home/fx/workspace/gitted/cmake/sql/include/sqlJobs.h
+ *	 Generated by sql2class v1.9.3 by (C) AH 2000-2006
+ *	  using command line
+ *	  $ sql2class -sqlite -build -global -prefix /home/fx/workspace/gitted/cmake/sql -lib sqlJobs -namespace db -overwrite dump
+ *	 Date: Fri Nov 19 08:03:54 2010
+ */
+
+/*
+Copyright (C) 2001-2006  Anders Hedstrom (grymse at alhem.net)
+
+This program is free software; you can redistribute it and/or
+modify it under the terms of the GNU General Public License
+as published by the Free Software Foundation; either version 2
+of the License, or (at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+*/
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include <ADM_sqlite3.h>
+#include <libsqlitewrapped.h>
+#include <map>
+
+#include <vector>
+#include <string>
+
+#ifndef _SQLJOBS_H
+#define _SQLJOBS_H
+
+#ifdef _WIN32
+#define strncasecmp strnicmp
+#define strcasecmp stricmp
+#endif // _WIN32
+
+/**
+ **  Class 'Version' and 'cVersion'
+ **/
+
+namespace db
+{
+class Version {
+public:
+	Version(Database *);
+	Version(Database *,const std::string& );
+	Version(Database *,Query *,int = 0 /* offset */);
+	~Version();
+	Database& GetDatabase() { return *database; }
+
+	unsigned long long int insert();
+	void save();
+	std::string xml();
+	std::string xml(const std::string& ,const std::string& );
+	size_t num_cols();
+
+	long GetValue() { return this -> value; }
+	void SetValue(long x) { this -> value = x; }
+
+	// table columns
+private:
+	long                     value; // integer
+	//
+	void clear();
+	void spawn(const std::string& );
+	void spawn(Query *,int = 0 /* offset */);
+	void select(const std::string& );
+	//
+	Database *database;
+	short new_object;
+}; // End of class 'Version'
+
+} // end of namespace
+
+/**
+ **  Class 'Jobs' and 'cJobs'
+ **/
+
+namespace db
+{
+class Jobs {
+public:
+	Jobs(Database *);
+	Jobs(Database *,const std::string& );
+	Jobs(Database *,Query *,int = 0 /* offset */);
+	Jobs(Database&,long id);
+	~Jobs();
+	Database& GetDatabase() { return *database; }
+
+	unsigned long long int insert();
+	void update();
+	void save();
+	void erase();
+	std::string xml();
+	std::string xml(const std::string& ,const std::string& );
+	size_t num_cols();
+
+	long GetId() { return this -> id; }
+	void SetId(long x) { this -> id = x; }
+	const char *GetJscript() { return this -> jscript.c_str(); }
+	void SetJscript(const std::string&  x) { this -> jscript = x; }
+	const char *GetJobname() { return this -> jobname.c_str(); }
+	void SetJobname(const std::string&  x) { this -> jobname = x; }
+	const char *GetOutputfile() { return this -> outputfile.c_str(); }
+	void SetOutputfile(const std::string&  x) { this -> outputfile = x; }
+	long GetStatus() { return this -> status; }
+	void SetStatus(long x) { this -> status = x; }
+	long GetStarttime() { return this -> starttime; }
+	void SetStarttime(long x) { this -> starttime = x; }
+	long GetEndtime() { return this -> endtime; }
+	void SetEndtime(long x) { this -> endtime = x; }
+
+	// table columns
+private:
+	long                     id; // integer
+	std::string              jscript; // varchar(100)
+	std::string              jobname; // varchar(100)
+	std::string              outputfile; // varchar(256)
+	long                     status; // integer
+	long                     starttime; // integer
+	long                     endtime; // integer
+	//
+	void clear();
+	void spawn(const std::string& );
+	void spawn(Query *,int = 0 /* offset */);
+	void select(const std::string& );
+	void update(long id);
+	//
+	Database *database;
+	short new_object;
+}; // End of class 'Jobs'
+
+} // end of namespace
+#endif // _SQLJOBS_H

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/CMakeLists.txt	2010-11-20 08:28:20 UTC (rev 6767)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/CMakeLists.txt	2010-11-20 08:28:21 UTC (rev 6768)
@@ -1,7 +1,7 @@
 SET(ADM_coreJobs_SRCS 
         ADM_coreJobs.cpp
         sqlite3.c
-        libjobdb.cpp
+        sqlJobs.cpp
         Database.cpp
         Query.cpp
         StderrLog.cpp

Deleted: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/libjobdb.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/libjobdb.cpp	2010-11-20 08:28:20 UTC (rev 6767)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/libjobdb.cpp	2010-11-20 08:28:21 UTC (rev 6768)
@@ -1,264 +0,0 @@
-/*
- *	 /home/fx/workspace/gitted/cmake/sql/src/libjobdb/libjobdb.cpp
- *	 Generated by sql2class v1.9.3 by (C) AH 2000-2006
- *	  using command line
- *	  $ sql2class -build -sqlite -lib libjobdb str-jobs -namespace db -overwrite -prefix /home/fx/workspace/gitted/cmake/sql/
- *	 Date: Sat Nov  6 16:51:41 2010
- */
-
-/*
-Copyright (C) 2001-2006  Anders Hedstrom (grymse at alhem.net)
-
-This program is free software; you can redistribute it and/or
-modify it under the terms of the GNU General Public License
-as published by the Free Software Foundation; either version 2
-of the License, or (at your option) any later version.
-
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
-
-You should have received a copy of the GNU General Public License
-along with this program; if not, write to the Free Software
-Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-*/
-#include <libjobdb.h>
-
-namespace db {
-
-/**
- **  Begin class 'Jobs'
- **/
-
-Jobs::Jobs(Database *db)
-{
-	database = db;
-	new_object = 1;
-	clear();
-}
-
-
-Jobs::Jobs(Database *db,const std::string& sql)
-{
-	database = db;
-	new_object = 1;
-	spawn(sql);
-}
-
-
-Jobs::Jobs(Database *db,Query *qd,int offset)
-{
-	database = db;
-	new_object = 0;
-	spawn(qd, offset);
-}
-
-
-Jobs::Jobs(Database& db,long i_id):database(&db),new_object(1)
-{
-	Query q(*database);
-	std::string sql = "select * from jobs where ";
-	{
-		char slask[100];
-		sprintf(slask,"id='%ld'",i_id);
-		sql += slask;
-	}
-	spawn(sql);
-}
-
-
-Jobs::~Jobs()
-{
-}
-
-
-void Jobs::select(const std::string& sql)
-{
-	spawn(sql);
-}
-
-
-unsigned long long int Jobs::insert()
-{
-	Query q(*database);
-	std::string sql;
-
-	sql = "insert into jobs(jscript,jobname,outputFile,status,startTime,endTime)";
-	sql += " values('" + q.GetDatabase().safestr(this -> jscript) + "'";
-	sql += ", '" + q.GetDatabase().safestr(this -> jobname) + "'";
-	sql += ", '" + q.GetDatabase().safestr(this -> outputfile) + "'";
-	{
-		char slask[100];
-		sprintf(slask,", %ld",this -> status);
-		sql += slask;
-	}
-	sql += ", '" + q.GetDatabase().safestr(this -> starttime) + "'";
-	sql += ", '" + q.GetDatabase().safestr(this -> endtime) + "'";
-	sql += ")";
-	q.execute(sql);
-	new_object = 0;
-	unsigned long long int inserted_id = q.insert_id();
-	id = inserted_id;
-	return inserted_id;
-}
-
-
-void Jobs::update()
-{
-	update(this -> id);
-}
-
-
-void Jobs::update(long i_id)
-{
-	Query q(*database);
-	std::string sql;
-	sql += "update jobs set jscript='" + q.GetDatabase().safestr(this -> jscript) + "'";
-	sql += ", jobname='" + q.GetDatabase().safestr(this -> jobname) + "'";
-	sql += ", outputFile='" + q.GetDatabase().safestr(this -> outputfile) + "'";
-	{
-		char slask[200];
-		sprintf(slask,", status=%ld",this -> status);
-		sql += slask;
-	}
-	sql += ", startTime='" + q.GetDatabase().safestr(this -> starttime) + "'";
-	sql += ", endTime='" + q.GetDatabase().safestr(this -> endtime) + "'";
-	{
-		char slask[200];
-		sprintf(slask," where id='%ld'",i_id);
-		sql += slask;
-	}
-	q.execute(sql);
-}
-
-
-void Jobs::save()
-{
-	if (new_object)
-		insert();
-	else
-		update();
-}
-
-
-void Jobs::erase()
-{
-	if (!new_object)
-	{
-		std::string sql = "delete from jobs where";
-		Query q(*database);
-		{
-			char slask[200];
-			sprintf(slask," id='%ld'",this -> id);
-			sql += slask;
-		}
-		q.execute(sql);
-	}
-}
-
-
-std::string Jobs::xml()
-{
-	Query q(*database);
-	std::string dest;
-	char slask[200];
-	dest = "<JOBS>";
-	sprintf(slask,"<ID>%ld</ID>",this -> id);
-	dest += slask;
-	dest += "<JSCRIPT>" + q.GetDatabase().xmlsafestr(this -> jscript) + "</JSCRIPT>";
-	dest += "<JOBNAME>" + q.GetDatabase().xmlsafestr(this -> jobname) + "</JOBNAME>";
-	dest += "<OUTPUTFILE>" + q.GetDatabase().xmlsafestr(this -> outputfile) + "</OUTPUTFILE>";
-	sprintf(slask,"<STATUS>%ld</STATUS>",this -> status);
-	dest += slask;
-	dest += "<STARTTIME>" + q.GetDatabase().xmlsafestr(this -> starttime) + "</STARTTIME>";
-	dest += "<ENDTIME>" + q.GetDatabase().xmlsafestr(this -> endtime) + "</ENDTIME>";
-	dest += "</JOBS>";
-	return dest;
-}
-
-
-std::string Jobs::xml(const std::string& tag,const std::string& xvalx)
-{
-	Query q(*database);
-	std::string dest;
-	char slask[200];
-	dest = "<JOBS " + tag + "=\"" + xvalx + "\">";
-	sprintf(slask,"<ID>%ld</ID>",this -> id);
-	dest += slask;
-	dest += "<JSCRIPT>" + q.GetDatabase().xmlsafestr(this -> jscript) + "</JSCRIPT>";
-	dest += "<JOBNAME>" + q.GetDatabase().xmlsafestr(this -> jobname) + "</JOBNAME>";
-	dest += "<OUTPUTFILE>" + q.GetDatabase().xmlsafestr(this -> outputfile) + "</OUTPUTFILE>";
-	sprintf(slask,"<STATUS>%ld</STATUS>",this -> status);
-	dest += slask;
-	dest += "<STARTTIME>" + q.GetDatabase().xmlsafestr(this -> starttime) + "</STARTTIME>";
-	dest += "<ENDTIME>" + q.GetDatabase().xmlsafestr(this -> endtime) + "</ENDTIME>";
-	dest += "</JOBS>";
-	return dest;
-}
-
-
-size_t Jobs::num_cols()
-{
-	return 7;
-}
-
-
-void Jobs::clear()
-{
-	this -> id = 0;
-	this -> jscript = "";
-	this -> jobname = "";
-	this -> outputfile = "";
-	this -> status = 0;
-	this -> starttime = "";
-	this -> endtime = "";
-}
-
-
-void Jobs::spawn(const std::string& sql)
-{
-	Query q(*database);
-	std::string temp;
-
-	clear();
-
-	if (!strncasecmp(sql.c_str(),"select * ",9))
-	{
-		temp = "select id,jscript,jobname,outputFile,status,startTime,endTime " + sql.substr(9);
-	} else
-		temp = sql;
-	q.get_result(temp);
-	if (q.fetch_row())
-	{
-		this -> id = q.getval(0);																				// 0 - id integer
-		this -> jscript = q.getstr(1);																				// 1 - jscript varchar(100)
-		this -> jobname = q.getstr(2);																				// 2 - jobname varchar(100)
-		this -> outputfile = q.getstr(3);																				// 3 - outputfile varchar(256)
-		this -> status = q.getval(4);																				// 4 - status integer
-		this -> starttime = q.getstr(5);																				// 5 - starttime date
-		this -> endtime = q.getstr(6);																				// 6 - endtime date
-		new_object = 0;
-	} else
-		clear();
-	q.free_result();
-}
-
-
-void Jobs::spawn(Query *qd,int offset)
-{
-	clear();
-
-	this -> id = qd -> getval(0 + offset);																				// 0 - id integer
-	this -> jscript = qd -> getstr(1 + offset);																				// 1 - jscript varchar(100)
-	this -> jobname = qd -> getstr(2 + offset);																				// 2 - jobname varchar(100)
-	this -> outputfile = qd -> getstr(3 + offset);																				// 3 - outputfile varchar(256)
-	this -> status = qd -> getval(4 + offset);																				// 4 - status integer
-	this -> starttime = qd -> getstr(5 + offset);																				// 5 - starttime date
-	this -> endtime = qd -> getstr(6 + offset);																				// 6 - endtime date
-}
-
-
-// End of implementation of class 'Jobs'
-
-} // End of namespace

Copied: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/sqlJobs.cpp (from rev 6767, branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/libjobdb.cpp)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/sqlJobs.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/sqlJobs.cpp	2010-11-20 08:28:21 UTC (rev 6768)
@@ -0,0 +1,424 @@
+/*
+ *	 /home/fx/workspace/gitted/cmake/sql/src/sqlJobs/sqlJobs.cpp
+ *	 Generated by sql2class v1.9.3 by (C) AH 2000-2006
+ *	  using command line
+ *	  $ sql2class -sqlite -build -global -prefix /home/fx/workspace/gitted/cmake/sql -lib sqlJobs -namespace db -overwrite dump
+ *	 Date: Fri Nov 19 08:03:54 2010
+ */
+
+/*
+Copyright (C) 2001-2006  Anders Hedstrom (grymse at alhem.net)
+
+This program is free software; you can redistribute it and/or
+modify it under the terms of the GNU General Public License
+as published by the Free Software Foundation; either version 2
+of the License, or (at your option) any later version.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+*/
+#include <sqlJobs.h>
+
+namespace db {
+
+/**
+ **  Begin class 'Version'
+ **/
+
+Version::Version(Database *db)
+{
+	database = db;
+	new_object = 1;
+	clear();
+}
+
+
+Version::Version(Database *db,const std::string& sql)
+{
+	database = db;
+	new_object = 1;
+	spawn(sql);
+}
+
+
+Version::Version(Database *db,Query *qd,int offset)
+{
+	database = db;
+	new_object = 0;
+	spawn(qd, offset);
+}
+
+
+Version::~Version()
+{
+}
+
+
+void Version::select(const std::string& sql)
+{
+	spawn(sql);
+}
+
+
+unsigned long long int Version::insert()
+{
+	Query q(*database);
+	std::string sql;
+
+	sql = "insert into version(value)";
+	{
+		char slask[100];
+		sprintf(slask," values(%ld",this -> value);
+		sql += slask;
+	}
+	sql += ")";
+	q.execute(sql);
+	new_object = 0;
+	unsigned long long int inserted_id = q.insert_id();
+	value = inserted_id;
+	return inserted_id;
+}
+
+
+void Version::save()
+{
+	if (new_object)
+		insert();
+}
+
+
+std::string Version::xml()
+{
+	Query q(*database);
+	std::string dest;
+	char slask[200];
+	dest = "<VERSION>";
+	sprintf(slask,"<VALUE>%ld</VALUE>",this -> value);
+	dest += slask;
+	dest += "</VERSION>";
+	return dest;
+}
+
+
+std::string Version::xml(const std::string& tag,const std::string& xvalx)
+{
+	Query q(*database);
+	std::string dest;
+	char slask[200];
+	dest = "<VERSION " + tag + "=\"" + xvalx + "\">";
+	sprintf(slask,"<VALUE>%ld</VALUE>",this -> value);
+	dest += slask;
+	dest += "</VERSION>";
+	return dest;
+}
+
+
+size_t Version::num_cols()
+{
+	return 1;
+}
+
+
+void Version::clear()
+{
+	this -> value = 0;
+}
+
+
+void Version::spawn(const std::string& sql)
+{
+	Query q(*database);
+	std::string temp;
+
+	clear();
+
+	if (!strncasecmp(sql.c_str(),"select * ",9))
+	{
+		temp = "select value " + sql.substr(9);
+	} else
+		temp = sql;
+	q.get_result(temp);
+	if (q.fetch_row())
+	{
+		this -> value = q.getval(0);																				// 0 - value integer
+		new_object = 0;
+	} else
+		clear();
+	q.free_result();
+}
+
+
+void Version::spawn(Query *qd,int offset)
+{
+	clear();
+
+	this -> value = qd -> getval(0 + offset);																				// 0 - value integer
+}
+
+
+// End of implementation of class 'Version'
+
+} // End of namespace
+namespace db {
+
+/**
+ **  Begin class 'Jobs'
+ **/
+
+Jobs::Jobs(Database *db)
+{
+	database = db;
+	new_object = 1;
+	clear();
+}
+
+
+Jobs::Jobs(Database *db,const std::string& sql)
+{
+	database = db;
+	new_object = 1;
+	spawn(sql);
+}
+
+
+Jobs::Jobs(Database *db,Query *qd,int offset)
+{
+	database = db;
+	new_object = 0;
+	spawn(qd, offset);
+}
+
+
+Jobs::Jobs(Database& db,long i_id):database(&db),new_object(1)
+{
+	Query q(*database);
+	std::string sql = "select * from jobs where ";
+	{
+		char slask[100];
+		sprintf(slask,"id='%ld'",i_id);
+		sql += slask;
+	}
+	spawn(sql);
+}
+
+
+Jobs::~Jobs()
+{
+}
+
+
+void Jobs::select(const std::string& sql)
+{
+	spawn(sql);
+}
+
+
+unsigned long long int Jobs::insert()
+{
+	Query q(*database);
+	std::string sql;
+
+	sql = "insert into jobs(jscript,jobname,outputFile,status,startTime,endTime)";
+	sql += " values('" + q.GetDatabase().safestr(this -> jscript) + "'";
+	sql += ", '" + q.GetDatabase().safestr(this -> jobname) + "'";
+	sql += ", '" + q.GetDatabase().safestr(this -> outputfile) + "'";
+	{
+		char slask[100];
+		sprintf(slask,", %ld",this -> status);
+		sql += slask;
+	}
+	{
+		char slask[100];
+		sprintf(slask,", %ld",this -> starttime);
+		sql += slask;
+	}
+	{
+		char slask[100];
+		sprintf(slask,", %ld",this -> endtime);
+		sql += slask;
+	}
+	sql += ")";
+	q.execute(sql);
+	new_object = 0;
+	unsigned long long int inserted_id = q.insert_id();
+	id = inserted_id;
+	return inserted_id;
+}
+
+
+void Jobs::update()
+{
+	update(this -> id);
+}
+
+
+void Jobs::update(long i_id)
+{
+	Query q(*database);
+	std::string sql;
+	sql += "update jobs set jscript='" + q.GetDatabase().safestr(this -> jscript) + "'";
+	sql += ", jobname='" + q.GetDatabase().safestr(this -> jobname) + "'";
+	sql += ", outputFile='" + q.GetDatabase().safestr(this -> outputfile) + "'";
+	{
+		char slask[200];
+		sprintf(slask,", status=%ld",this -> status);
+		sql += slask;
+	}
+	{
+		char slask[200];
+		sprintf(slask,", startTime=%ld",this -> starttime);
+		sql += slask;
+	}
+	{
+		char slask[200];
+		sprintf(slask,", endTime=%ld",this -> endtime);
+		sql += slask;
+	}
+	{
+		char slask[200];
+		sprintf(slask," where id='%ld'",i_id);
+		sql += slask;
+	}
+	q.execute(sql);
+}
+
+
+void Jobs::save()
+{
+	if (new_object)
+		insert();
+	else
+		update();
+}
+
+
+void Jobs::erase()
+{
+	if (!new_object)
+	{
+		std::string sql = "delete from jobs where";
+		Query q(*database);
+		{
+			char slask[200];
+			sprintf(slask," id='%ld'",this -> id);
+			sql += slask;
+		}
+		q.execute(sql);
+	}
+}
+
+
+std::string Jobs::xml()
+{
+	Query q(*database);
+	std::string dest;
+	char slask[200];
+	dest = "<JOBS>";
+	sprintf(slask,"<ID>%ld</ID>",this -> id);
+	dest += slask;
+	dest += "<JSCRIPT>" + q.GetDatabase().xmlsafestr(this -> jscript) + "</JSCRIPT>";
+	dest += "<JOBNAME>" + q.GetDatabase().xmlsafestr(this -> jobname) + "</JOBNAME>";
+	dest += "<OUTPUTFILE>" + q.GetDatabase().xmlsafestr(this -> outputfile) + "</OUTPUTFILE>";
+	sprintf(slask,"<STATUS>%ld</STATUS>",this -> status);
+	dest += slask;
+	sprintf(slask,"<STARTTIME>%ld</STARTTIME>",this -> starttime);
+	dest += slask;
+	sprintf(slask,"<ENDTIME>%ld</ENDTIME>",this -> endtime);
+	dest += slask;
+	dest += "</JOBS>";
+	return dest;
+}
+
+
+std::string Jobs::xml(const std::string& tag,const std::string& xvalx)
+{
+	Query q(*database);
+	std::string dest;
+	char slask[200];
+	dest = "<JOBS " + tag + "=\"" + xvalx + "\">";
+	sprintf(slask,"<ID>%ld</ID>",this -> id);
+	dest += slask;
+	dest += "<JSCRIPT>" + q.GetDatabase().xmlsafestr(this -> jscript) + "</JSCRIPT>";
+	dest += "<JOBNAME>" + q.GetDatabase().xmlsafestr(this -> jobname) + "</JOBNAME>";
+	dest += "<OUTPUTFILE>" + q.GetDatabase().xmlsafestr(this -> outputfile) + "</OUTPUTFILE>";
+	sprintf(slask,"<STATUS>%ld</STATUS>",this -> status);
+	dest += slask;
+	sprintf(slask,"<STARTTIME>%ld</STARTTIME>",this -> starttime);
+	dest += slask;
+	sprintf(slask,"<ENDTIME>%ld</ENDTIME>",this -> endtime);
+	dest += slask;
+	dest += "</JOBS>";
+	return dest;
+}
+
+
+size_t Jobs::num_cols()
+{
+	return 7;
+}
+
+
+void Jobs::clear()
+{
+	this -> id = 0;
+	this -> jscript = "";
+	this -> jobname = "";
+	this -> outputfile = "";
+	this -> status = 0;
+	this -> starttime = 0;
+	this -> endtime = 0;
+}
+
+
+void Jobs::spawn(const std::string& sql)
+{
+	Query q(*database);
+	std::string temp;
+
+	clear();
+
+	if (!strncasecmp(sql.c_str(),"select * ",9))
+	{
+		temp = "select id,jscript,jobname,outputFile,status,startTime,endTime " + sql.substr(9);
+	} else
+		temp = sql;
+	q.get_result(temp);
+	if (q.fetch_row())
+	{
+		this -> id = q.getval(0);																				// 0 - id integer
+		this -> jscript = q.getstr(1);																				// 1 - jscript varchar(100)
+		this -> jobname = q.getstr(2);																				// 2 - jobname varchar(100)
+		this -> outputfile = q.getstr(3);																				// 3 - outputfile varchar(256)
+		this -> status = q.getval(4);																				// 4 - status integer
+		this -> starttime = q.getval(5);																				// 5 - starttime integer
+		this -> endtime = q.getval(6);																				// 6 - endtime integer
+		new_object = 0;
+	} else
+		clear();
+	q.free_result();
+}
+
+
+void Jobs::spawn(Query *qd,int offset)
+{
+	clear();
+
+	this -> id = qd -> getval(0 + offset);																				// 0 - id integer
+	this -> jscript = qd -> getstr(1 + offset);																				// 1 - jscript varchar(100)
+	this -> jobname = qd -> getstr(2 + offset);																				// 2 - jobname varchar(100)
+	this -> outputfile = qd -> getstr(3 + offset);																				// 3 - outputfile varchar(256)
+	this -> status = qd -> getval(4 + offset);																				// 4 - status integer
+	this -> starttime = qd -> getval(5 + offset);																				// 5 - starttime integer
+	this -> endtime = qd -> getval(6 + offset);																				// 6 - endtime integer
+}
+
+
+// End of implementation of class 'Jobs'
+
+} // End of namespace



From mean at mail.berlios.de  Sat Nov 20 09:28:22 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 20 Nov 2010 09:28:22 +0100
Subject: [Avidemux-svn-commit] r6769 - in branches/avidemux_2.6_branch_mean:
	avidemux/qt4/ADM_jobs/src avidemux_core/ADM_coreJobs/include
	avidemux_core/ADM_coreJobs/src
Message-ID: <20101120082822.E9EF5480B59@sheep.berlios.de>

Author: mean
Date: 2010-11-20 09:28:22 +0100 (Sat, 20 Nov 2010)
New Revision: 6769

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/sqlJobs.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/sqlJobs.cpp
Log:
[jobs] Nicer sql, handle date

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-20 08:28:21 UTC (rev 6768)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-20 08:28:22 UTC (rev 6769)
@@ -27,7 +27,8 @@
 }
 string date2String(uint64_t date)
 {
-    return string("12/12/2010 10:20:10");
+    if(!date) return string("N/A");
+    return string(ADM_epochToString(date));
 }
 /**
     \fn refreshList

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/sqlJobs.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/sqlJobs.h	2010-11-20 08:28:21 UTC (rev 6768)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/include/sqlJobs.h	2010-11-20 08:28:22 UTC (rev 6769)
@@ -3,7 +3,7 @@
  *	 Generated by sql2class v1.9.3 by (C) AH 2000-2006
  *	  using command line
  *	  $ sql2class -sqlite -build -global -prefix /home/fx/workspace/gitted/cmake/sql -lib sqlJobs -namespace db -overwrite dump
- *	 Date: Fri Nov 19 08:03:54 2010
+ *	 Date: Sat Nov 20 09:19:55 2010
  */
 
 /*

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp	2010-11-20 08:28:21 UTC (rev 6768)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/ADM_coreJobs.cpp	2010-11-20 08:28:22 UTC (rev 6769)
@@ -17,7 +17,7 @@
 #include "ADM_default.h"
 #include "ADM_sqlite3.h"
 #include "libsqlitewrapped.h"
-#include "libjobdb.h"
+#include "sqlJobs.h"
 static char *dbFile=NULL;
 Database    *mydb=NULL;
 
@@ -211,8 +211,8 @@
 #define OP(x,y) myJob.Set##x(y);
 
         OP(Status,ADM_JOB_IDLE)
-        OP(Starttime,"")
-        OP(Endtime,"")
+        OP(Starttime,0)
+        OP(Endtime,0)
         myJob.save();
         return true;
 }
@@ -235,8 +235,8 @@
         newJob.jobName=oneJob.GetJobname();
         newJob.scriptName=oneJob.GetJscript();
         newJob.outputFileName=oneJob.GetOutputfile();
-        newJob.startTime=0;
-        newJob.endTime=0;
+        newJob.startTime=oneJob.GetStarttime();
+        newJob.endTime=oneJob.GetEndtime();
         newJob.status=(ADM_JOB_STATUS)oneJob.GetStatus();
         jobs.push_back(newJob);
 	}
@@ -254,8 +254,8 @@
     int id=job.id;
     db::Jobs myJob(*mydb,id);
 #warning detect invalid one ?
-//    myJob.SetStarttime(job.startTime);
-//    myJob.SetEndtime(job.endTime);
+    myJob.SetStarttime(job.startTime);
+    myJob.SetEndtime(job.endTime);
     myJob.SetStatus(job.status);
     myJob.save();
     return true;

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/sqlJobs.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/sqlJobs.cpp	2010-11-20 08:28:21 UTC (rev 6768)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreJobs/src/sqlJobs.cpp	2010-11-20 08:28:22 UTC (rev 6769)
@@ -3,7 +3,7 @@
  *	 Generated by sql2class v1.9.3 by (C) AH 2000-2006
  *	  using command line
  *	  $ sql2class -sqlite -build -global -prefix /home/fx/workspace/gitted/cmake/sql -lib sqlJobs -namespace db -overwrite dump
- *	 Date: Fri Nov 19 08:03:54 2010
+ *	 Date: Sat Nov 20 09:19:55 2010
  */
 
 /*



From mean at mail.berlios.de  Sat Nov 20 09:35:06 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 20 Nov 2010 09:35:06 +0100
Subject: [Avidemux-svn-commit] r6770 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src
Message-ID: <20101120083506.729D8480B59@sheep.berlios.de>

Author: mean
Date: 2010-11-20 09:35:06 +0100 (Sat, 20 Nov 2010)
New Revision: 6770

Added:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
Log:
[jobs] forgotten file

Added: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-20 08:35:06 UTC (rev 6770)
@@ -0,0 +1,121 @@
+/**
+    \file   ADM_jobControl
+    \author mean fixounet at free.Fr (c) 2010
+
+*/
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "T_jobs.h"
+#include "ADM_default.h"
+#include "ADM_coreJobs.h"
+
+
+/**
+    \fn spawnerBoomerang
+    \brief Allow to do class -> plain C -> class 
+*/
+static void *spawnerBoomerang(void *arg)
+{
+    spawnData    *data=(spawnData *)arg;
+    data->me->runProcess(data);
+    return NULL;
+}
+
+bool spawnProcess(const char *processName, int argc, const string argv[])
+{
+    ADM_info("Starting <%s>\n",processName);
+    string command=string(processName);
+    for(int i=0;i<argc;i++)
+    {
+        ADM_info("%d : %s\n",i,argv[i].c_str());
+        command+=string(" ")+argv[i];
+    }
+    ADM_info("=>%s\n",command.c_str());
+    ADM_info("==================== Start of spawner process job ================\n");
+    system(command.c_str());
+    ADM_info("==================== End of spawner process job ================\n");
+    return true;
+}
+
+/**
+    \fn runProcess
+    \brief Thread can will run a process
+*/
+bool jobWindow::runProcess(spawnData *data)
+{
+    // 3 args in our case...
+    string argv[3];
+    argv[0]=string("--runpy \"")+data->script+string("\" ");
+    argv[1]=string("--save \"")+data->outputFile+string("\" ");
+    argv[2]=string("--quit");
+    return spawnProcess(data->exeName,3,argv);
+}
+/**
+    \fn spawnChild
+    \brief Spawn a child to execute a commande
+*/
+bool jobWindow::spawnChild(const char *exeName, const string &script, const string &outputFile)
+{
+    spawnData data;
+            data.script=script;
+            data.outputFile=outputFile;
+            data.exeName=exeName;
+            data.me=this;
+            pthread_t threadId;
+        // Have to spawn a thread that will handle the exec...
+            if( pthread_create(&threadId,NULL,
+                                spawnerBoomerang, &data))
+            {
+                ADM_error("Spawn failed\n");
+                return false;
+            }
+            // Everything is fine, give process 1 second to use the stack allocated data....
+            ADM_usleep(1000*1000LL);
+            ADM_info("Spawning successfull\n");
+            return true;
+}
+ 
+/**
+    \fn runOneJob
+*/
+bool jobWindow::runOneJob( ADMJob &job)   
+{
+    bool r=false;
+    job.startTime=ADM_getSecondsSinceEpoch();
+    job.status=ADM_JOB_RUNNING;
+    ADM_jobUpdate(job);
+    
+    // 1- Start listening to socket
+
+    // 2- Spawn  child
+    string ScriptFullPath;
+    ScriptFullPath=string(ADM_getJobDir())+string("/")+string(job.scriptName);
+    if(false==spawnChild("avidemux3_qt4",ScriptFullPath,job.outputFileName))
+    {
+        ADM_error("Cannot spawn child\n");
+        r=false;
+        goto done;
+    }
+
+    // 3- Wait for connect...
+
+    // 4- wait for complete and/or success message
+    
+
+    // 5-Done, do the cleanup
+done:
+
+    if(r) job.status=ADM_JOB_OK;
+        else job.status=ADM_JOB_KO;
+    job.endTime=ADM_getSecondsSinceEpoch();
+    ADM_jobUpdate(job);
+    refreshList();
+    ADM_info("Running job id = %d\n",job.id);
+    return r;
+}



From mean at mail.berlios.de  Sat Nov 20 09:56:12 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 20 Nov 2010 09:56:12 +0100
Subject: [Avidemux-svn-commit] r6771 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src
Message-ID: <20101120085613.147A7480B79@sheep.berlios.de>

Author: mean
Date: 2010-11-20 09:56:12 +0100 (Sat, 20 Nov 2010)
New Revision: 6771

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_misc.cpp
Log:
[Jobs] win32 time_t

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_misc.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_misc.cpp	2010-11-20 08:35:06 UTC (rev 6770)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_core/src/ADM_misc.cpp	2010-11-20 08:56:12 UTC (rev 6771)
@@ -95,7 +95,7 @@
 */
 const char *ADM_epochToString(uint64_t epoch)
 {
-    time_t clock=(__TIME_T_TYPE)epoch;
+    time_t clock=(time_t)epoch;
     return ctime(&clock);
 }
 



From mean at mail.berlios.de  Sat Nov 20 10:11:38 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 20 Nov 2010 10:11:38 +0100
Subject: [Avidemux-svn-commit] r6772 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src
Message-ID: <20101120091138.B171E480B79@sheep.berlios.de>

Author: mean
Date: 2010-11-20 10:11:38 +0100 (Sat, 20 Nov 2010)
New Revision: 6772

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
Log:
[Jobs] win32 pthread

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-20 08:56:12 UTC (rev 6771)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-20 09:11:38 UTC (rev 6772)
@@ -14,8 +14,8 @@
 #include "T_jobs.h"
 #include "ADM_default.h"
 #include "ADM_coreJobs.h"
+#include "pthread.h"
 
-
 /**
     \fn spawnerBoomerang
     \brief Allow to do class -> plain C -> class 



From mean at mail.berlios.de  Sat Nov 27 09:01:29 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:29 +0100
Subject: [Avidemux-svn-commit] r6773 - in
	branches/avidemux_2.6_branch_mean/avidemux_core: .
	ADM_coreSocket ADM_coreSocket/include ADM_coreSocket/src
Message-ID: <20101127080129.AA321480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:29 +0100 (Sat, 27 Nov 2010)
New Revision: 6773

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/CMakeLists.txt
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/CMakeLists.txt
Log:
[socket]

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/CMakeLists.txt	2010-11-27 08:01:29 UTC (rev 6773)
@@ -0,0 +1 @@
+ADD_SUBDIRECTORY(src)

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h	2010-11-27 08:01:29 UTC (rev 6773)
@@ -0,0 +1,39 @@
+/***************************************************************************
+    \file   ADM_coreSocket.h
+    \author (C) 2007-2010 by mean  fixounet at free.fr
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef AVS_CORE_SOCKET_H
+#define AVS_CORE_SOCKET_H
+#include "ADM_threads.h"
+
+/**
+    \class ADM_Socket
+*/
+class ADM_Socket       
+{
+    protected:
+        int         mySocket;
+        admMutex    lock;
+    public:
+        bool     bindAndAccept(uint32_t *port);
+        bool     connectTo(uint32_t port);
+        bool     rxData(uint32_t howmuch, uint8_t *where);
+        bool     txData(uint32_t howmuch, uint8_t *where);
+        bool     close(void);
+    public:
+
+        ADM_Socket( void );
+        ~ADM_Socket(  );
+};
+#endif
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:29 UTC (rev 6773)
@@ -0,0 +1,159 @@
+/***************************************************************************
+    \file ADM_coreSocket.cpp
+    \brief Handle socket network part 
+    \author (C) 2007-2010 by mean  fixounet at free.fr
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#ifdef __MINGW32__
+#include <windows.h>
+#include <winbase.h>
+#include <io.h>
+#include <winsock2.h>
+#else
+#include <sys/types.h>
+#include <sys/socket.h>
+#include <netinet/in.h>
+#include <arpa/inet.h>
+#include <netinet/tcp.h>
+#endif
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include <math.h>
+#include <errno.h>
+#include "ADM_default.h"
+
+#include "ADM_coreSocket.h"
+
+#define MAGGIC 0xDEADBEEF
+
+#define aprintf(...) {}
+//#define DEBUG_NET
+/**
+    \fn connectTo
+*/
+bool ADM_Socket::connectTo(uint32_t port)
+{
+ #ifdef __MINGW32__
+ mySocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
+ #else
+ mySocket = socket(PF_INET, SOCK_STREAM, 0);
+ #endif
+    if(mySocket==-1)
+    {
+        ADM_error("Socket creation failed\n");
+        return 0;
+    }
+    struct sockaddr_in  service;
+    service.sin_family = AF_INET;
+#ifdef DEBUG_NET
+    service.sin_addr.s_addr = inet_addr("192.168.0.21");
+#else
+    service.sin_addr.s_addr = inet_addr("127.0.0.1");
+#endif    
+    service.sin_port = htons(port);
+    
+// Set socket to lowdelay, else it will be choppy
+    int flag = 1;
+    setsockopt( mySocket, IPPROTO_TCP, TCP_NODELAY, (char *)&flag, sizeof(flag) );
+
+
+    if(connect(mySocket,(struct sockaddr *)&service,sizeof(service)))
+    {
+        ADM_error("[ADMSocket]Socket connect error %d on port %d\n",errno,port);
+        return 0;
+    }
+    ADM_info("[ADMSocket]Connected to port %d, socket %d\n",port,mySocket);
+    return 1;
+}
+/**
+    \fn close
+*/
+bool ADM_Socket::close(void)
+{
+    if(mySocket)
+    {
+        int er;
+#ifdef __MINGW32__
+		er=shutdown(mySocket,SD_BOTH);
+#else
+        er=shutdown(mySocket,SHUT_RDWR);
+#endif
+        if(er) ADM_error("[ADMSocket]Error when socket shutdown  %d (socket %d)\n",er,mySocket);
+        mySocket=0;
+    }
+    return 1;
+}
+/**
+    \fn rxData
+*/
+bool ADM_Socket::rxData(uint32_t howmuch, uint8_t *where)
+{
+uint32_t got=0;
+int rx;
+    while(got<howmuch)
+    {
+        rx=recv(mySocket,(char *)where,howmuch-got,0);
+        if(rx<0)
+        {
+          perror("RxData");
+          return 0;
+        }
+        where+=rx;
+        got+=rx;
+    }
+  return 1;
+}
+/**
+    \fn txData
+*/
+bool ADM_Socket::txData(uint32_t howmuch, uint8_t *where)
+{
+uint32_t got=0,tx;
+    while(got<howmuch)
+    {
+        tx=send(mySocket,(char *)where,howmuch-got,0);
+         if(tx<0)
+        {
+          perror("TxData");
+          return 0;
+        }
+        where+=tx;
+        got+=tx;
+    }
+  return 1;
+}
+/**
+    \fn bindAndAccept
+    \brief bind to any port and accept incoming packets
+*/
+bool     ADM_Socket::bindAndAccept(uint32_t *port)
+{
+
+}
+/**
+    \fn ctor
+*/
+ADM_Socket::ADM_Socket()
+{
+    mySocket=0;
+}
+/**
+    \fn dtor
+*/
+ADM_Socket::~ADM_Socket()
+{
+    close();
+}
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/CMakeLists.txt	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/CMakeLists.txt	2010-11-27 08:01:29 UTC (rev 6773)
@@ -0,0 +1,13 @@
+SET(ADMcoreSocket_SRCS
+        ADM_coreSocket.cpp
+)	
+#*************************************************
+ADD_LIBRARY(ADM_coreSocket6 SHARED ${ADMcoreSocket_SRCS})
+TARGET_LINK_LIBRARIES(ADM_coreSocket6  ADM_core6 ADM_coreUtils6)
+INCLUDE_DIRECTORIES(../include)
+if(WIN32)
+        target_link_libraries(ADM_coreSocket6 wsock32)
+endif(WIN32)
+ADM_INSTALL_LIB(ADM_coreSocket6)
+
+



From mean at mail.berlios.de  Sat Nov 27 09:01:30 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:30 +0100
Subject: [Avidemux-svn-commit] r6774 - in
	branches/avidemux_2.6_branch_mean/avidemux_core: .
	ADM_coreSocket/include ADM_coreSocket/src
Message-ID: <20101127080130.E810C480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:30 +0100 (Sat, 27 Nov 2010)
New Revision: 6774

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
Log:
[coreSocket] Wrap socket management

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h	2010-11-27 08:01:29 UTC (rev 6773)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h	2010-11-27 08:01:30 UTC (rev 6774)
@@ -12,8 +12,8 @@
  *   (at your option) any later version.                                   *
  *                                                                         *
  ***************************************************************************/
-#ifndef AVS_CORE_SOCKET_H
-#define AVS_CORE_SOCKET_H
+#ifndef ADM_CORE_SOCKET_H
+#define ADM_CORE_SOCKET_H
 #include "ADM_threads.h"
 
 /**
@@ -23,9 +23,10 @@
 {
     protected:
         int         mySocket;
-        admMutex    lock;
+        admMutex    lock;       
+        bool        create(void);
     public:
-        bool     bindAndAccept(uint32_t *port);
+        bool     createBindAndAccept(uint32_t *port);
         bool     connectTo(uint32_t port);
         bool     rxData(uint32_t howmuch, uint8_t *where);
         bool     txData(uint32_t howmuch, uint8_t *where);

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:29 UTC (rev 6773)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:30 UTC (rev 6774)
@@ -135,12 +135,78 @@
   return 1;
 }
 /**
-    \fn bindAndAccept
+    \fn create
+    \brief create a TCP socket
+*/
+bool ADM_Socket::create(void)
+{
+      mySocket = socket(AF_INET, SOCK_STREAM, 0);
+      if(mySocket<0) return false;
+      return true;
+
+}
+/**
+    \fn createBindAndAccept
     \brief bind to any port and accept incoming packets
 */
-bool     ADM_Socket::bindAndAccept(uint32_t *port)
+bool     ADM_Socket::createBindAndAccept(uint32_t *port)
 {
 
+
+    if(!create())
+    {
+        ADM_error("Cannot create socket\n");
+        return false;
+    }
+
+  sockaddr_in service;
+  service.sin_family = AF_INET;
+#define BIND_ADR "127.0.0.1"
+    service.sin_addr.s_addr = inet_addr(BIND_ADR);
+	printf("Binding on %s\n",BIND_ADR);
+
+  *port=0;
+  service.sin_port = 0; // bind to any port
+
+#ifdef __MINGW32__
+        #define SADDR SOCKADDR
+        #define SADDR_IN SOCKADDR
+#else
+        #define SADDR struct sockaddr
+        #define SADDR_IN struct sockaddr_in    
+#endif
+
+  int one=true;
+  if (bind( mySocket,  (SADDR *)&service, sizeof(service))) 
+  {
+		ADM_error("bind() failed  \n");
+		fflush(stdout);
+		close();
+		return false;
+  }
+   // Get port 
+    socklen_t len=sizeof( service);
+    if ( getsockname ( mySocket, (SADDR *)& service, &len ) < 0 ) 
+    {
+        ADM_error("Getsockname failed\n");
+        fflush(stdout);
+        close();
+        return false;
+    }
+    *port= ntohs ( ((SADDR_IN *)&service)->sin_port ); 
+     
+   // Set high buffer + low delay
+    ADM_info("Socket bound to port %u\n",(unsigned int)*port);
+
+    int er=listen(mySocket,1);
+	if(er)
+	{
+		ADM_error("Error in listen\n");
+		fflush(stdout);
+        return false;
+	}
+
+    return true;
 }
 /**
     \fn ctor

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-11-27 08:01:29 UTC (rev 6773)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/CMakeLists.txt	2010-11-27 08:01:30 UTC (rev 6774)
@@ -71,6 +71,7 @@
 ADD_SUBDIRECTORY(ADM_coreVideoFilter)
 ADD_SUBDIRECTORY(ADM_ffmpeg)
 ADD_SUBDIRECTORY(ADM_coreJobs)
+ADD_SUBDIRECTORY(ADM_coreSocket)
 
 if (NOT USE_SYSTEM_SPIDERMONKEY)
 	ADD_SUBDIRECTORY(ADM_smjs)



From mean at mail.berlios.de  Sat Nov 27 09:01:32 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:32 +0100
Subject: [Avidemux-svn-commit] r6775 - in
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs: include src
Message-ID: <20101127080132.43E07480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:32 +0100 (Sat, 27 Nov 2010)
New Revision: 6775

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt
Log:
[Jobs] Begin to use socket between jobs and avidemux

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-27 08:01:30 UTC (rev 6774)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-27 08:01:32 UTC (rev 6775)
@@ -8,6 +8,9 @@
 using std::string;
 using std::vector;
 class jobWindow;
+#include "ADM_default.h"
+#include "ADM_coreSocket/include/ADM_coreSocket.h"
+
 typedef enum
 {
     JobAction_setReady,
@@ -37,9 +40,13 @@
 	virtual     ~jobWindow();
     bool        runProcess(spawnData *data);
 protected:
+    ADM_Socket  mySocket;
+    uint32_t    localPort;
+protected:
     int         getActiveIndex(void)	;
     bool        runOneJob(ADMJob &job)   ;
-    bool        spawnChild(const char *exeName, const string &script, const string &outputFile);
+    bool        spawnChild(const char *exeName, const string &script, const string &outputFile);
+    bool        popup(const char *errorMessage);
 protected:
     Ui_jobs     ui;
     void        refreshList(void);

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-27 08:01:30 UTC (rev 6774)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-27 08:01:32 UTC (rev 6775)
@@ -14,8 +14,8 @@
 #include "T_jobs.h"
 #include "ADM_default.h"
 #include "ADM_coreJobs.h"
+#include "DIA_coreToolkit.h"
 
-
 static QTableWidgetItem *fromText(const string &t,int id)
 {
     QString s(QString::fromUtf8(t.c_str()));
@@ -131,7 +131,14 @@
    connect(ui.pushButtonQuit,SIGNAL(pressed()),this,SLOT(quit()));
    connect(ui.pushButtonRunAll,SIGNAL(pressed()),this,SLOT(runAllJob()));
 
-   refreshList();
+    // Start our socket
+   if(false==mySocket.createBindAndAccept(&localPort))
+    {
+        popup("Cannot bind socket");
+        exit(-1);
+    }
+    ADM_info("Socket bound to %d\n",(int)localPort);
+    refreshList();
 
 }
 /**
@@ -141,8 +148,14 @@
 {
 
 }
-
 /**
+*/
+bool        jobWindow::popup(const char *errorMessage)
+{
+    ADM_error("%s\n",errorMessage);
+    return true;
+}
+/**
     \fn jobRun
 */
 bool jobRun(int ac,char **av)

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:30 UTC (rev 6774)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:32 UTC (rev 6775)
@@ -50,11 +50,12 @@
 bool jobWindow::runProcess(spawnData *data)
 {
     // 3 args in our case...
-    string argv[3];
-    argv[0]=string("--runpy \"")+data->script+string("\" ");
-    argv[1]=string("--save \"")+data->outputFile+string("\" ");
-    argv[2]=string("--quit");
-    return spawnProcess(data->exeName,3,argv);
+    string argv[4];
+    argv[0]=string("--nogui ");
+    argv[1]=string("--runpy \"")+data->script+string("\" ");
+    argv[2]=string("--save \"")+data->outputFile+string("\" ");
+    argv[3]=string("--quit");
+    return spawnProcess(data->exeName,4,argv);
 }
 /**
     \fn spawnChild

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt	2010-11-27 08:01:30 UTC (rev 6774)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/CMakeLists.txt	2010-11-27 08:01:32 UTC (rev 6775)
@@ -31,6 +31,7 @@
 ADD_SOURCE_CFLAGS(ADM_jobs.cpp "-DADM_SUBVERSION=${ADM_SUBVERSION}")
 
 ###########################################
+TARGET_LINK_LIBRARIES(avidemux3_jobs ADM_coreSocket6)
 TARGET_LINK_LIBRARIES(avidemux3_jobs ${QT_QTGUI_LIBRARY} ${QT_QTCORE_LIBRARY})
 
 ###########################################



From mean at mail.berlios.de  Sat Nov 27 09:01:33 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:33 +0100
Subject: [Avidemux-svn-commit] r6776 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket:
	include src
Message-ID: <20101127080133.7DE06480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:33 +0100 (Sat, 27 Nov 2010)
New Revision: 6776

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
Log:
[coreSocket] Begin to add socket management to jobs

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h	2010-11-27 08:01:32 UTC (rev 6775)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h	2010-11-27 08:01:33 UTC (rev 6776)
@@ -17,24 +17,26 @@
 #include "ADM_threads.h"
 
 /**
-    \class ADM_Socket
+    \class ADM_socket
+    \brief Wrapper around socket/tcp
 */
-class ADM_Socket       
+class ADM_socket       
 {
     protected:
         int         mySocket;
         admMutex    lock;       
         bool        create(void);
     public:
-        bool     createBindAndAccept(uint32_t *port);
-        bool     connectTo(uint32_t port);
-        bool     rxData(uint32_t howmuch, uint8_t *where);
-        bool     txData(uint32_t howmuch, uint8_t *where);
-        bool     close(void);
+        ADM_socket *waitForConnect(uint32_t timeoutMs);
+        bool        createBindAndAccept(uint32_t *port);
+        bool        connectTo(uint32_t port);
+        bool        rxData(uint32_t howmuch, uint8_t *where);
+        bool        txData(uint32_t howmuch, uint8_t *where);
+        bool        close(void);
     public:
-
-        ADM_Socket( void );
-        ~ADM_Socket(  );
+        ADM_socket(int newSocket);
+        ADM_socket( void );
+        ~ADM_socket(  );
 };
 #endif
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:32 UTC (rev 6775)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:33 UTC (rev 6776)
@@ -40,23 +40,37 @@
 
 #define aprintf(...) {}
 //#define DEBUG_NET
+
+#ifdef __MINGW32__
+        #define SADDR    SOCKADDR
+        #define SADDR_IN SOCKADDR
+        #define SERROR   SOCKET_ERROR
+        #define SNET     AF_INET
+        #define SPROTO   IPPROTO_TCP
+        #define SCLOSE   SD_BOTH
+#else
+        #define SADDR struct    sockaddr
+        #define SADDR_IN struct sockaddr_in    
+        #define SERROR          -1
+        #define SNET            PF_INET
+        #define SPROTO          0
+        #define SCLOSE          SHUT_RDWR
+#endif
+
+
 /**
     \fn connectTo
 */
-bool ADM_Socket::connectTo(uint32_t port)
+bool ADM_socket::connectTo(uint32_t port)
 {
- #ifdef __MINGW32__
- mySocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
- #else
- mySocket = socket(PF_INET, SOCK_STREAM, 0);
- #endif
+ mySocket = socket(SNET, SOCK_STREAM, SPROTO);
     if(mySocket==-1)
     {
         ADM_error("Socket creation failed\n");
         return 0;
     }
     struct sockaddr_in  service;
-    service.sin_family = AF_INET;
+    service.sin_family = SNET;
 #ifdef DEBUG_NET
     service.sin_addr.s_addr = inet_addr("192.168.0.21");
 #else
@@ -80,16 +94,12 @@
 /**
     \fn close
 */
-bool ADM_Socket::close(void)
+bool ADM_socket::close(void)
 {
     if(mySocket)
     {
         int er;
-#ifdef __MINGW32__
-		er=shutdown(mySocket,SD_BOTH);
-#else
-        er=shutdown(mySocket,SHUT_RDWR);
-#endif
+		er=shutdown(mySocket,SCLOSE);
         if(er) ADM_error("[ADMSocket]Error when socket shutdown  %d (socket %d)\n",er,mySocket);
         mySocket=0;
     }
@@ -98,7 +108,7 @@
 /**
     \fn rxData
 */
-bool ADM_Socket::rxData(uint32_t howmuch, uint8_t *where)
+bool ADM_socket::rxData(uint32_t howmuch, uint8_t *where)
 {
 uint32_t got=0;
 int rx;
@@ -118,7 +128,7 @@
 /**
     \fn txData
 */
-bool ADM_Socket::txData(uint32_t howmuch, uint8_t *where)
+bool ADM_socket::txData(uint32_t howmuch, uint8_t *where)
 {
 uint32_t got=0,tx;
     while(got<howmuch)
@@ -138,7 +148,7 @@
     \fn create
     \brief create a TCP socket
 */
-bool ADM_Socket::create(void)
+bool ADM_socket::create(void)
 {
       mySocket = socket(AF_INET, SOCK_STREAM, 0);
       if(mySocket<0) return false;
@@ -149,7 +159,7 @@
     \fn createBindAndAccept
     \brief bind to any port and accept incoming packets
 */
-bool     ADM_Socket::createBindAndAccept(uint32_t *port)
+bool     ADM_socket::createBindAndAccept(uint32_t *port)
 {
 
 
@@ -168,13 +178,6 @@
   *port=0;
   service.sin_port = 0; // bind to any port
 
-#ifdef __MINGW32__
-        #define SADDR SOCKADDR
-        #define SADDR_IN SOCKADDR
-#else
-        #define SADDR struct sockaddr
-        #define SADDR_IN struct sockaddr_in    
-#endif
 
   int one=true;
   if (bind( mySocket,  (SADDR *)&service, sizeof(service))) 
@@ -209,16 +212,62 @@
     return true;
 }
 /**
+    \fn waitForConnect
+    \brief wait for incoming TCP connection...
+    \return null if no connection
+*/
+ADM_socket *ADM_socket::waitForConnect(uint32_t timeoutMs)
+{
+    //
+        if(!mySocket)
+        {
+            ADM_error("Wait for connect called with no socket opened\n");
+            return NULL;        
+        }
+    // Wait for connect...
+        fd_set set;
+        FD_ZERO(&set);
+        FD_SET(mySocket,&set);
+        struct timeval timeout; 
+
+        timeout.tv_sec=timeoutMs/1000;
+        timeout.tv_usec=((timeoutMs)-(timeout.tv_sec*1000))*1000;
+        
+        int evt=select(1+mySocket,&set,NULL,NULL,&timeout);
+        if(evt<0) 
+        {
+            ADM_error("Select failed\n");
+            return NULL;
+        }
+
+        int workSocket = SERROR;
+        workSocket = accept( mySocket, NULL, NULL);
+        if(SERROR==workSocket) 
+        {
+            ADM_error("Accept failed\n");
+            return NULL;
+        }
+        return new ADM_socket(workSocket);
+}
+/**
     \fn ctor
 */
-ADM_Socket::ADM_Socket()
+ADM_socket::ADM_socket()
 {
     mySocket=0;
 }
 /**
+    \fn ctor
+*/
+ADM_socket::ADM_socket(int newSocket)
+{
+    mySocket=newSocket;
+}
+
+/**
     \fn dtor
 */
-ADM_Socket::~ADM_Socket()
+ADM_socket::~ADM_socket()
 {
     close();
 }



From mean at mail.berlios.de  Sat Nov 27 09:01:34 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:34 +0100
Subject: [Avidemux-svn-commit] r6777 - in branches/avidemux_2.6_branch_mean:
	avidemux/qt4/ADM_jobs/include avidemux/qt4/ADM_jobs/src
	avidemux_core/ADM_coreSocket/src
Message-ID: <20101127080134.D9BD6480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:34 +0100 (Sat, 27 Nov 2010)
New Revision: 6777

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
Log:
[coreSocket/jobs] Accept incoming stuff

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-27 08:01:33 UTC (rev 6776)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-27 08:01:34 UTC (rev 6777)
@@ -40,7 +40,7 @@
 	virtual     ~jobWindow();
     bool        runProcess(spawnData *data);
 protected:
-    ADM_Socket  mySocket;
+    ADM_socket  mySocket;
     uint32_t    localPort;
 protected:
     int         getActiveIndex(void)	;

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-27 08:01:33 UTC (rev 6776)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-27 08:01:34 UTC (rev 6777)
@@ -138,6 +138,7 @@
         exit(-1);
     }
     ADM_info("Socket bound to %d\n",(int)localPort);
+    //ADM_socket *n=mySocket.waitForConnect(5000);
     refreshList();
 
 }

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:33 UTC (rev 6776)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:34 UTC (rev 6777)
@@ -90,6 +90,7 @@
     bool r=false;
     job.startTime=ADM_getSecondsSinceEpoch();
     job.status=ADM_JOB_RUNNING;
+    ADM_socket *runSocket=NULL;
     ADM_jobUpdate(job);
     
     // 1- Start listening to socket
@@ -105,7 +106,12 @@
     }
 
     // 3- Wait for connect...
-
+    runSocket=mySocket.waitForConnect(6*1000);
+    if(!runSocket)
+    {
+        ADM_error("No connect\n");
+        goto done;
+    }
     // 4- wait for complete and/or success message
     
 

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:33 UTC (rev 6776)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:34 UTC (rev 6777)
@@ -37,7 +37,7 @@
 #include "ADM_coreSocket.h"
 
 #define MAGGIC 0xDEADBEEF
-
+#define BIND_ADR "127.0.0.1"
 #define aprintf(...) {}
 //#define DEBUG_NET
 
@@ -63,19 +63,14 @@
 */
 bool ADM_socket::connectTo(uint32_t port)
 {
- mySocket = socket(SNET, SOCK_STREAM, SPROTO);
-    if(mySocket==-1)
+    if(false==create())
     {
-        ADM_error("Socket creation failed\n");
-        return 0;
+        ADM_error("Canno create socket\n");
+        return false;
     }
     struct sockaddr_in  service;
     service.sin_family = SNET;
-#ifdef DEBUG_NET
-    service.sin_addr.s_addr = inet_addr("192.168.0.21");
-#else
-    service.sin_addr.s_addr = inet_addr("127.0.0.1");
-#endif    
+    service.sin_addr.s_addr = inet_addr(BIND_ADR);
     service.sin_port = htons(port);
     
 // Set socket to lowdelay, else it will be choppy
@@ -161,8 +156,6 @@
 */
 bool     ADM_socket::createBindAndAccept(uint32_t *port)
 {
-
-
     if(!create())
     {
         ADM_error("Cannot create socket\n");
@@ -171,9 +164,9 @@
 
   sockaddr_in service;
   service.sin_family = AF_INET;
-#define BIND_ADR "127.0.0.1"
+
     service.sin_addr.s_addr = inet_addr(BIND_ADR);
-	printf("Binding on %s\n",BIND_ADR);
+	ADM_info("Binding on %s\n",BIND_ADR);
 
   *port=0;
   service.sin_port = 0; // bind to any port
@@ -230,17 +223,20 @@
         FD_SET(mySocket,&set);
         struct timeval timeout; 
 
-        timeout.tv_sec=timeoutMs/1000;
-        timeout.tv_usec=((timeoutMs)-(timeout.tv_sec*1000))*1000;
-        
+        uint32_t sec=timeoutMs/1000;
+
+        timeout.tv_sec=sec;
+        timeout.tv_usec=((timeoutMs-sec*1000))*1000; // us
+        //ADM_info("Selecting\n");
         int evt=select(1+mySocket,&set,NULL,NULL,&timeout);
-        if(evt<0) 
+        if(evt<=0) 
         {
             ADM_error("Select failed\n");
             return NULL;
         }
 
         int workSocket = SERROR;
+        ADM_info("Accepting...\n");
         workSocket = accept( mySocket, NULL, NULL);
         if(SERROR==workSocket) 
         {



From mean at mail.berlios.de  Sat Nov 27 09:01:36 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:36 +0100
Subject: [Avidemux-svn-commit] r6778 - in
	branches/avidemux_2.6_branch_mean/avidemux/common: . ADM_toolkit
Message-ID: <20101127080136.19B99480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:35 +0100 (Sat, 27 Nov 2010)
New Revision: 6778

Added:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.h
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp
Log:
[slave] add slave commands

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp	2010-11-27 08:01:35 UTC (rev 6778)
@@ -0,0 +1,62 @@
+/***************************************************************************
+    \file ADM_slave
+    \brief handle slave (i.e. started from a controlling daemon)
+   \author (C) 2010  mean fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#include "ADM_default.h"
+#include "ADM_coreSocket/include/ADM_coreSocket.h"
+#include "ADM_slave.h"
+static ADM_socket *mySocket=NULL;
+/**
+    \fn ADM_slaveConnect
+    \brief connect to port given as arg
+*/
+bool ADM_slaveConnect(uint32_t port)
+{
+    mySocket=new ADM_socket();
+    if(!mySocket->connectTo(port))
+    {
+        ADM_error("Failed to connect to port %d\n",(int)port);
+        delete mySocket;
+        mySocket=NULL;
+    }
+    ADM_info("Connected to port %d\n",(int)port);
+    return true;
+}
+/**
+    \fn ADM_slaveShutdown
+    \brief kill socket
+*/
+bool ADM_slaveShutdown(void)
+{
+    if(mySocket)
+    {
+        ADM_info("Closing slave socket\n");
+        delete mySocket;
+        mySocket=NULL;
+        
+    }
+    return true;
+}
+/**
+    \fn ADM_slaveReportProgress
+*/
+bool ADM_slaveReportProgress(uint32_t percent)
+{
+    if(!mySocket)    return true;
+    ADM_info("Report : %d %%\n",percent);
+    return true;
+}
+
+
+
+//EOF

Added: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.h	2010-11-27 08:01:35 UTC (rev 6778)
@@ -0,0 +1,24 @@
+/***************************************************************************
+    \file ADM_slave
+    \brief handle slave (i.e. started from a controlling daemon)
+   \author (C) 2010  mean fixounet at free.fr
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_SLAVE_H
+#define ADM_SLAVE_H
+
+bool ADM_slaveConnect(uint32_t port);
+bool ADM_slaveShutdown(void );
+bool ADM_slaveReportProgress(uint32_t percent);
+
+#endif
+
+//EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp	2010-11-27 08:01:34 UTC (rev 6777)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_toolkit/automation.cpp	2010-11-27 08:01:35 UTC (rev 6778)
@@ -44,6 +44,8 @@
 #include "ADM_videoEncoderApi.h"
 #include "ADM_audioFilter/include/ADM_audioFilterInterface.h"
 
+extern bool ADM_slaveConnect(uint32_t port);
+
 extern int A_loadNone( void );
 extern void GUI_Quiet( void);
 extern void GUI_Verbose( void);
@@ -82,6 +84,7 @@
 static void call_videoconf(char *p) ;
 static int searchReactionTable(char *string);
 static void call_setPP(char *v,char *s);
+static void call_slave(char *p);
 //static void call_v2v(char *a,char *b,char *c);
 static void call_probePat(char *p);
 static void save(char*name);
@@ -128,6 +131,7 @@
 {
         //{"js",                  0,"Dump the javascript functions",(one_arg_type)ADM_dumpJSHooks},
         {"nogui",               0,"Run in silent mode",		(one_arg_type)GUI_Quiet}   ,
+        {"slave",			1,"run as slave, master is on port arg",		(one_arg_type)call_slave},
         {"run",			1,"load and run a script",		(one_arg_type)A_parseECMAScript},
         {"runpy",			1,"load and run a pyScript",		(one_arg_type)A_parseTinyPyScript},
         {"audio-normalize",	1,"activate normalization",		call_normalize},
@@ -401,6 +405,17 @@
 		printf("\n Audio bitrate %"LD"\n",i);
 		audioFilter_SetBitrate(i);
 }
+void call_slave(char *p)
+{
+		uint32_t i;
+		sscanf(p,"%"LU,&i);
+		printf("Slace on port  %"LU"\n",i);
+		if(!ADM_slaveConnect(i))
+        {
+                ADM_error("Cannot connect to master\n");
+                exit(-1);
+        }
+}
 void call_fps(char *p)
 {
 



From mean at mail.berlios.de  Sat Nov 27 09:01:37 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:37 +0100
Subject: [Avidemux-svn-commit] r6779 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src
Message-ID: <20101127080137.337CD480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:37 +0100 (Sat, 27 Nov 2010)
New Revision: 6779

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
Log:
[jobs] run avidemux in slave mode

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:35 UTC (rev 6778)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:37 UTC (rev 6779)
@@ -50,12 +50,15 @@
 bool jobWindow::runProcess(spawnData *data)
 {
     // 3 args in our case...
-    string argv[4];
+    string argv[5];
+    char str[100];
+    sprintf(str,"--slave %d",localPort);
     argv[0]=string("--nogui ");
-    argv[1]=string("--runpy \"")+data->script+string("\" ");
-    argv[2]=string("--save \"")+data->outputFile+string("\" ");
-    argv[3]=string("--quit");
-    return spawnProcess(data->exeName,4,argv);
+    argv[1]=string(str);
+    argv[2]=string("--runpy \"")+data->script+string("\" ");
+    argv[3]=string("--save \"")+data->outputFile+string("\" ");
+    argv[4]=string("--quit");
+    return spawnProcess(data->exeName,5,argv);
 }
 /**
     \fn spawnChild



From mean at mail.berlios.de  Sat Nov 27 09:01:38 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:38 +0100
Subject: [Avidemux-svn-commit] r6780 - in branches/avidemux_2.6_branch_mean:
	avidemux/common avidemux/qt4/ADM_jobs/include
	avidemux/qt4/ADM_jobs/src avidemux_core/ADM_coreSocket/include
	avidemux_core/ADM_coreSocket/src
Message-ID: <20101127080138.9F73D480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:38 +0100 (Sat, 27 Nov 2010)
New Revision: 6780

Added:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreCommandSocket.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreCommandSocket.cpp
Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/CMakeLists.txt
Log:
[socket/jobs] Add commandSocket to exchange message between jobs and avidemux

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp	2010-11-27 08:01:37 UTC (rev 6779)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp	2010-11-27 08:01:38 UTC (rev 6780)
@@ -13,16 +13,16 @@
  *                                                                         *
  ***************************************************************************/
 #include "ADM_default.h"
-#include "ADM_coreSocket/include/ADM_coreSocket.h"
+#include "ADM_coreSocket/include/ADM_coreCommandSocket.h"
 #include "ADM_slave.h"
-static ADM_socket *mySocket=NULL;
+static ADM_commandSocket *mySocket=NULL;
 /**
     \fn ADM_slaveConnect
     \brief connect to port given as arg
 */
 bool ADM_slaveConnect(uint32_t port)
 {
-    mySocket=new ADM_socket();
+    mySocket=new ADM_commandSocket();
     if(!mySocket->connectTo(port))
     {
         ADM_error("Failed to connect to port %d\n",(int)port);

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-27 08:01:37 UTC (rev 6779)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/include/T_jobs.h	2010-11-27 08:01:38 UTC (rev 6780)
@@ -9,7 +9,7 @@
 using std::vector;
 class jobWindow;
 #include "ADM_default.h"
-#include "ADM_coreSocket/include/ADM_coreSocket.h"
+#include "ADM_coreSocket/include/ADM_coreCommandSocket.h"
 
 typedef enum
 {
@@ -40,7 +40,7 @@
 	virtual     ~jobWindow();
     bool        runProcess(spawnData *data);
 protected:
-    ADM_socket  mySocket;
+    ADM_commandSocket  mySocket;
     uint32_t    localPort;
 protected:
     int         getActiveIndex(void)	;

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:37 UTC (rev 6779)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:38 UTC (rev 6780)
@@ -116,7 +116,14 @@
         goto done;
     }
     // 4- wait for complete and/or success message
-    
+    while(runSocket->isAlive()) 
+    {
+        ADM_usleep(1000*1000*1000);
+        printf(".\n");
+    }
+    ADM_info("** End of slave process **\n");
+    ADM_info("** End of slave process **\n");
+    ADM_info("** End of slave process **\n");
 
     // 5-Done, do the cleanup
 done:
@@ -125,6 +132,7 @@
         else job.status=ADM_JOB_KO;
     job.endTime=ADM_getSecondsSinceEpoch();
     ADM_jobUpdate(job);
+    if(runSocket) delete runSocket;
     refreshList();
     ADM_info("Running job id = %d\n",job.id);
     return r;

Copied: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreCommandSocket.h (from rev 6779, branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h)
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreCommandSocket.h	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreCommandSocket.h	2010-11-27 08:01:38 UTC (rev 6780)
@@ -0,0 +1,61 @@
+/***************************************************************************
+    \file   ADM_coreSocket.h
+    \author (C) 2007-2010 by mean  fixounet at free.fr
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef ADM_CORE_COMMAND_SOCKET_H
+#define ADM_CORE_COMMAND_SOCKET_H
+#include "ADM_coreSocket.h"
+
+#define ADM_COMMAND_SOCKET_MAX_PAYLOAD 16
+
+/**
+    \enum ADM_socketCommand
+*/
+typedef enum
+{
+    ADM_socketCommand_Hello=1,
+    ADM_socketCommand_End=2,
+    ADM_socketCommand_Progress=3,
+}ADM_socketCommand;
+
+/**
+        \struct ADM_socketMessage
+*/
+typedef struct
+{
+public:
+    ADM_socketCommand command;
+    uint32_t payloadLength;
+    uint8_t  payload[ADM_COMMAND_SOCKET_MAX_PAYLOAD];
+    bool     getPayloadAsUint32_t(uint32_t *v);
+    bool     setPayloadAsUint32_t(uint32_t v);
+}ADM_socketMessage;
+
+
+/**
+    \class ADM_commandSocket
+    \brief Wrapper around socket/tcp
+*/
+class ADM_commandSocket : public ADM_socket       
+{
+    protected:
+    public:
+        bool sendMessage(const ADM_socketMessage &msg);
+        bool getMessage(ADM_socketMessage &msg);
+    public:
+        ADM_commandSocket(int newSocket);
+        ADM_commandSocket( void );
+        ~ADM_commandSocket(  );
+};
+#endif
+//EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h	2010-11-27 08:01:37 UTC (rev 6779)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h	2010-11-27 08:01:38 UTC (rev 6780)
@@ -33,10 +33,11 @@
         bool        rxData(uint32_t howmuch, uint8_t *where);
         bool        txData(uint32_t howmuch, uint8_t *where);
         bool        close(void);
+        bool        isAlive(void);
     public:
         ADM_socket(int newSocket);
         ADM_socket( void );
-        ~ADM_socket(  );
+virtual ~ADM_socket(  );
 };
 #endif
 //EOF

Added: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreCommandSocket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreCommandSocket.cpp	                        (rev 0)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreCommandSocket.cpp	2010-11-27 08:01:38 UTC (rev 6780)
@@ -0,0 +1,82 @@
+/***************************************************************************
+    \file ADM_coreCommandSocket.cpp
+    \brief Handle socket network part 
+    \author (C) 2007-2010 by mean  fixounet at free.fr
+
+ ***************************************************************************/
+
+/***************************************************************************
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include "ADM_default.h"
+#include "ADM_coreCommandSocket.h"
+
+/**
+    \fn ctor
+*/
+ADM_commandSocket::ADM_commandSocket()  : ADM_socket()
+{
+    mySocket=0;
+}
+/**
+    \fn ctor
+*/
+ADM_commandSocket::ADM_commandSocket(int newSocket) : ADM_socket(newSocket)
+{
+    
+}
+
+/**
+    \fn dtor
+*/
+ADM_commandSocket::~ADM_commandSocket()
+{
+}
+/**
+    
+*/
+bool ADM_commandSocket::sendMessage(const ADM_socketMessage &msg)
+{
+    return false;
+}
+/**
+    \fn 
+*/
+bool ADM_commandSocket::getMessage(ADM_socketMessage &msg)
+{
+    return false;
+}
+/**
+    \fn getPayloadAsUint32_t
+*/
+bool     ADM_socketMessage::getPayloadAsUint32_t(uint32_t *v)
+{
+    if(payloadLength!=4)
+    {
+        ADM_error("payload is not uint32\n");
+        return false;
+    }
+    uint32_t a=(payload[0])+(payload[1]<<8)+(payload[2]<<16)+(payload[4]<<24);
+    *v=a;
+    return true;
+}
+/**
+    \fn setPayloadAsUint32_t
+*/
+bool     ADM_socketMessage::setPayloadAsUint32_t(uint32_t v)
+{
+    uint8_t *p=payload;
+    *p++=(v&0xff);v>>=8;
+    *p++=(v&0xff);v>>=8;
+    *p++=(v&0xff);v>>=8;
+    *p++=(v&0xff);v>>=8;
+    payloadLength=4;    
+    return true;
+}
+// EOF
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:37 UTC (rev 6779)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:38 UTC (rev 6780)
@@ -246,6 +246,29 @@
         return new ADM_socket(workSocket);
 }
 /**
+    \fn isAlive
+*/
+bool ADM_socket::isAlive(void)
+{
+    if(!mySocket) return false;
+        fd_set set;
+        FD_ZERO(&set);
+        FD_SET(mySocket,&set);
+        struct timeval timeout; 
+
+        timeout.tv_sec=0;
+        timeout.tv_usec=100000; // 100 us check
+        //ADM_info("Selecting\n");
+        int evt=select(1+mySocket,&set,&set,&set,&timeout);
+        if(evt<0) 
+        {
+            ADM_error("Select failed\n");
+            return false;
+        }
+
+    return true;
+}
+/**
     \fn ctor
 */
 ADM_socket::ADM_socket()

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/CMakeLists.txt
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/CMakeLists.txt	2010-11-27 08:01:37 UTC (rev 6779)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/CMakeLists.txt	2010-11-27 08:01:38 UTC (rev 6780)
@@ -1,5 +1,6 @@
 SET(ADMcoreSocket_SRCS
         ADM_coreSocket.cpp
+        ADM_coreCommandSocket.cpp
 )	
 #*************************************************
 ADD_LIBRARY(ADM_coreSocket6 SHARED ${ADMcoreSocket_SRCS})



From mean at mail.berlios.de  Sat Nov 27 09:01:39 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:39 +0100
Subject: [Avidemux-svn-commit] r6781 -
	branches/avidemux_2.6_branch_mean/avidemux
Message-ID: <20101127080139.C9574480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:39 +0100 (Sat, 27 Nov 2010)
New Revision: 6781

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
Log:
[avidemux] Link to socket

Modified: branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-11-27 08:01:38 UTC (rev 6780)
+++ branches/avidemux_2.6_branch_mean/avidemux/commonCmakeApplication.cmake	2010-11-27 08:01:39 UTC (rev 6781)
@@ -48,6 +48,7 @@
 ../common/gui_action.cpp
 ../common/gui_blackframes.cpp
 ../common/ADM_gettext.cpp
+../common/ADM_slave.cpp
 )
 
 #############################################
@@ -66,6 +67,7 @@
 ADM_coreMuxer6
 ADM_coreUI6
 ADM_coreUtils6
+ADM_coreSocket6
 ADM_coreVideoEncoder6
 ADM_coreVideoFilter6
 ADM_coreImageLoader6



From mean at mail.berlios.de  Sat Nov 27 09:01:41 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:41 +0100
Subject: [Avidemux-svn-commit] r6782 - in branches/avidemux_2.6_branch_mean:
	avidemux/common avidemux/qt4/ADM_jobs/src
	avidemux_core/ADM_coreSocket/include
	avidemux_core/ADM_coreSocket/src
Message-ID: <20101127080141.30DE6480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:41 +0100 (Sat, 27 Nov 2010)
New Revision: 6782

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreCommandSocket.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreCommandSocket.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
Log:
[coreSocket] Use simple protocol above socket (handshake etc...)

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp	2010-11-27 08:01:39 UTC (rev 6781)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp	2010-11-27 08:01:41 UTC (rev 6782)
@@ -15,6 +15,7 @@
 #include "ADM_default.h"
 #include "ADM_coreSocket/include/ADM_coreCommandSocket.h"
 #include "ADM_slave.h"
+#include "DIA_coreToolkit.h"
 static ADM_commandSocket *mySocket=NULL;
 /**
     \fn ADM_slaveConnect
@@ -22,6 +23,7 @@
 */
 bool ADM_slaveConnect(uint32_t port)
 {
+    uint32_t version;
     mySocket=new ADM_commandSocket();
     if(!mySocket->connectTo(port))
     {
@@ -30,7 +32,31 @@
         mySocket=NULL;
     }
     ADM_info("Connected to port %d\n",(int)port);
+ // 3b- handshake
+    ADM_info("Waiting for hello message...\n");
+    ADM_socketMessage msg;
+    msg.setPayloadAsUint32_t(ADM_COMMAND_SOCKET_VERSION);
+    msg.command=ADM_socketCommand_Hello;
+    if(!mySocket->sendMessage(msg))
+    {
+        GUI_Error_HIG("","Cannot send hello message");
+        goto done;
+    }
+    if(!mySocket->getMessage(msg))
+    {
+        GUI_Error_HIG("","Cannot get hello message");
+        goto done;
+    }
+    
+    if(!msg.getPayloadAsUint32_t(&version) || version!=ADM_COMMAND_SOCKET_VERSION)
+    {
+        GUI_Error_HIG("","Wrong command version\n");
+        goto done;
+    }
     return true;
+done:
+    ADM_assert(0);
+    return false;
 }
 /**
     \fn ADM_slaveShutdown

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:39 UTC (rev 6781)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:41 UTC (rev 6782)
@@ -91,9 +91,10 @@
 bool jobWindow::runOneJob( ADMJob &job)   
 {
     bool r=false;
+    uint32_t version;
     job.startTime=ADM_getSecondsSinceEpoch();
     job.status=ADM_JOB_RUNNING;
-    ADM_socket *runSocket=NULL;
+    ADM_commandSocket *runSocket=NULL;
     ADM_jobUpdate(job);
     
     // 1- Start listening to socket
@@ -115,6 +116,27 @@
         ADM_error("No connect\n");
         goto done;
     }
+    // 3b- handshake
+    ADM_info("Waiting for hello message...\n");
+    ADM_socketMessage msg;
+    msg.setPayloadAsUint32_t(ADM_COMMAND_SOCKET_VERSION);
+    msg.command=ADM_socketCommand_Hello;
+    if(!runSocket->sendMessage(msg))
+    {
+        popup("Cannot send hello message");
+        goto done;
+    }
+    if(!runSocket->getMessage(msg))
+    {
+        popup("Cannot get hello message");
+        goto done;
+    }
+    
+    if(!msg.getPayloadAsUint32_t(&version) || version!=ADM_COMMAND_SOCKET_VERSION)
+    {
+        popup("Wrong command version\n");
+        goto done;
+    }
     // 4- wait for complete and/or success message
     while(runSocket->isAlive()) 
     {

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreCommandSocket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreCommandSocket.h	2010-11-27 08:01:39 UTC (rev 6781)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreCommandSocket.h	2010-11-27 08:01:41 UTC (rev 6782)
@@ -16,6 +16,8 @@
 #define ADM_CORE_COMMAND_SOCKET_H
 #include "ADM_coreSocket.h"
 
+#define ADM_COMMAND_SOCKET_VERSION 2
+
 #define ADM_COMMAND_SOCKET_MAX_PAYLOAD 16
 
 /**
@@ -31,7 +33,7 @@
 /**
         \struct ADM_socketMessage
 */
-typedef struct
+class ADM_socketMessage
 {
 public:
     ADM_socketCommand command;
@@ -39,7 +41,7 @@
     uint8_t  payload[ADM_COMMAND_SOCKET_MAX_PAYLOAD];
     bool     getPayloadAsUint32_t(uint32_t *v);
     bool     setPayloadAsUint32_t(uint32_t v);
-}ADM_socketMessage;
+};
 
 
 /**
@@ -50,6 +52,7 @@
 {
     protected:
     public:
+        virtual ADM_commandSocket *waitForConnect(uint32_t timeoutMs);
         bool sendMessage(const ADM_socketMessage &msg);
         bool getMessage(ADM_socketMessage &msg);
     public:

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h	2010-11-27 08:01:39 UTC (rev 6781)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreSocket.h	2010-11-27 08:01:41 UTC (rev 6782)
@@ -27,11 +27,11 @@
         admMutex    lock;       
         bool        create(void);
     public:
-        ADM_socket *waitForConnect(uint32_t timeoutMs);
+virtual ADM_socket *waitForConnect(uint32_t timeoutMs);
         bool        createBindAndAccept(uint32_t *port);
         bool        connectTo(uint32_t port);
         bool        rxData(uint32_t howmuch, uint8_t *where);
-        bool        txData(uint32_t howmuch, uint8_t *where);
+        bool        txData(uint32_t howmuch, const uint8_t *where);
         bool        close(void);
         bool        isAlive(void);
     public:

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreCommandSocket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreCommandSocket.cpp	2010-11-27 08:01:39 UTC (rev 6781)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreCommandSocket.cpp	2010-11-27 08:01:41 UTC (rev 6782)
@@ -17,6 +17,22 @@
 #include "ADM_default.h"
 #include "ADM_coreCommandSocket.h"
 
+
+static bool     uint32_to_char(uint32_t v,uint8_t *p)
+ {
+    *p++=(v&0xff);v>>=8;
+    *p++=(v&0xff);v>>=8;
+    *p++=(v&0xff);v>>=8;
+    *p++=(v&0xff);v>>=8;
+    return true;
+}
+static bool     char_to_uint32(uint32_t *v,uint8_t *p)
+ {
+    uint32_t a=(p[0])+(p[1]<<8)+(p[2]<<16)+(p[4]<<24);
+    *v=a;
+    return true;
+}
+
 /**
     \fn ctor
 */
@@ -39,18 +55,56 @@
 {
 }
 /**
-    
+        \fn sendMessage
 */
 bool ADM_commandSocket::sendMessage(const ADM_socketMessage &msg)
 {
-    return false;
+
+#define TXX(u,v) if(!txData(u,tmp)) {ADM_error(v" error sending data\n");return false;}
+
+    uint8_t tmp[4];
+    if(!mySocket) return false;
+    // 1- Send command as uint8_t
+    tmp[0]=(uint8_t)msg.command;
+    TXX(1,"command");
+    
+    // 2- Send size as uint32_t
+    uint32_to_char(msg.payloadLength,tmp);
+    TXX(4,"payloadLength");
+    if(msg.payloadLength)
+    {
+        if(!txData(msg.payloadLength,msg.payload))
+        {
+            ADM_error("Cannot send payload for command %d\n",msg.command);
+            return false;
+        }
+    }
+    return true;
 }
 /**
-    \fn 
+    \fn getMessage
 */
 bool ADM_commandSocket::getMessage(ADM_socketMessage &msg)
 {
-    return false;
+#define RXX(u,v) if(!rxData(u,tmp)) {ADM_error(v" error rxing data\n");return false;}
+    uint8_t tmp[4];
+    if(!mySocket) return false;
+    // 1- Send command as uint8_t
+    RXX(1,"command");
+    msg.command=(ADM_socketCommand)tmp[0];
+    RXX(4,"payloadLength");
+    char_to_uint32(&(msg.payloadLength),tmp);
+    if(msg.payloadLength)
+    {
+        ADM_assert(msg.payloadLength<ADM_COMMAND_SOCKET_MAX_PAYLOAD);
+        if(!rxData(msg.payloadLength,msg.payload)) 
+        {
+                ADM_error(" error rxing payload\n");
+                return false;
+        }
+
+    }
+    return true;
 }
 /**
     \fn getPayloadAsUint32_t
@@ -62,8 +116,8 @@
         ADM_error("payload is not uint32\n");
         return false;
     }
-    uint32_t a=(payload[0])+(payload[1]<<8)+(payload[2]<<16)+(payload[4]<<24);
-    *v=a;
+
+    char_to_uint32(v,payload);
     return true;
 }
 /**
@@ -71,12 +125,19 @@
 */
 bool     ADM_socketMessage::setPayloadAsUint32_t(uint32_t v)
 {
-    uint8_t *p=payload;
-    *p++=(v&0xff);v>>=8;
-    *p++=(v&0xff);v>>=8;
-    *p++=(v&0xff);v>>=8;
-    *p++=(v&0xff);v>>=8;
+    uint32_to_char(v,payload);
     payloadLength=4;    
     return true;
 }
+
+/**
+    \fn waitForConnect
+    \brief wait for incoming TCP connection...
+    \return null if no connection
+*/
+ADM_commandSocket *ADM_commandSocket::waitForConnect(uint32_t timeoutMs)
+{
+#warning fixme badly
+    return (ADM_commandSocket *)ADM_socket::waitForConnect(timeoutMs);
+}
 // EOF
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:39 UTC (rev 6781)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:41 UTC (rev 6782)
@@ -123,7 +123,7 @@
 /**
     \fn txData
 */
-bool ADM_socket::txData(uint32_t howmuch, uint8_t *where)
+bool ADM_socket::txData(uint32_t howmuch, const uint8_t *where)
 {
 uint32_t got=0,tx;
     while(got<howmuch)



From mean at mail.berlios.de  Sat Nov 27 09:01:42 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:42 +0100
Subject: [Avidemux-svn-commit] r6783 - in
	branches/avidemux_2.6_branch_mean/avidemux: common qt4/ADM_jobs/src
Message-ID: <20101127080142.853B7480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:42 +0100 (Sat, 27 Nov 2010)
New Revision: 6783

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
Log:
[jobs/socket] Factorize handshake, fix msg marshalling

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp	2010-11-27 08:01:41 UTC (rev 6782)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp	2010-11-27 08:01:42 UTC (rev 6783)
@@ -33,26 +33,11 @@
     }
     ADM_info("Connected to port %d\n",(int)port);
  // 3b- handshake
-    ADM_info("Waiting for hello message...\n");
-    ADM_socketMessage msg;
-    msg.setPayloadAsUint32_t(ADM_COMMAND_SOCKET_VERSION);
-    msg.command=ADM_socketCommand_Hello;
-    if(!mySocket->sendMessage(msg))
+    if(!mySocket->handshake())
     {
-        GUI_Error_HIG("","Cannot send hello message");
+        ADM_error("Cannot handshake\n");
         goto done;
     }
-    if(!mySocket->getMessage(msg))
-    {
-        GUI_Error_HIG("","Cannot get hello message");
-        goto done;
-    }
-    
-    if(!msg.getPayloadAsUint32_t(&version) || version!=ADM_COMMAND_SOCKET_VERSION)
-    {
-        GUI_Error_HIG("","Wrong command version\n");
-        goto done;
-    }
     return true;
 done:
     ADM_assert(0);

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:41 UTC (rev 6782)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:42 UTC (rev 6783)
@@ -57,7 +57,7 @@
     argv[1]=string(str);
     argv[2]=string("--runpy \"")+data->script+string("\" ");
     argv[3]=string("--save \"")+data->outputFile+string("\" ");
-    argv[4]=string("--quit");
+    argv[4]=string("--quit > /tmp/prout.log");
     return spawnProcess(data->exeName,5,argv);
 }
 /**
@@ -116,27 +116,11 @@
         ADM_error("No connect\n");
         goto done;
     }
-    // 3b- handshake
-    ADM_info("Waiting for hello message...\n");
-    ADM_socketMessage msg;
-    msg.setPayloadAsUint32_t(ADM_COMMAND_SOCKET_VERSION);
-    msg.command=ADM_socketCommand_Hello;
-    if(!runSocket->sendMessage(msg))
+    if(!runSocket->handshake())
     {
-        popup("Cannot send hello message");
+        popup("Cannot handshake");
         goto done;
     }
-    if(!runSocket->getMessage(msg))
-    {
-        popup("Cannot get hello message");
-        goto done;
-    }
-    
-    if(!msg.getPayloadAsUint32_t(&version) || version!=ADM_COMMAND_SOCKET_VERSION)
-    {
-        popup("Wrong command version\n");
-        goto done;
-    }
     // 4- wait for complete and/or success message
     while(runSocket->isAlive()) 
     {



From mean at mail.berlios.de  Sat Nov 27 09:01:43 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:43 +0100
Subject: [Avidemux-svn-commit] r6784 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src
Message-ID: <20101127080143.A0B18480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:43 +0100 (Sat, 27 Nov 2010)
New Revision: 6784

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
Log:
[jobs/socket] close socket on error

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:42 UTC (rev 6783)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:43 UTC (rev 6784)
@@ -122,10 +122,19 @@
         goto done;
     }
     // 4- wait for complete and/or success message
-    while(runSocket->isAlive()) 
+    ADM_socketMessage msg;
+    while(1)
     {
-        ADM_usleep(1000*1000*1000);
-        printf(".\n");
+        if(!runSocket->isAlive())
+        {
+            ADM_info("Exiting loop\n");
+            break;
+        }
+        if(runSocket->pollMessage(msg))
+        {
+            ADM_info("Got a new message %d\n",msg.command);
+        }
+        ADM_usleep(1000*1000); // Refresh once per sec
     }
     ADM_info("** End of slave process **\n");
     ADM_info("** End of slave process **\n");



From mean at mail.berlios.de  Sat Nov 27 09:01:44 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:44 +0100
Subject: [Avidemux-svn-commit] r6785 - in
	branches/avidemux_2.6_branch_mean/avidemux: common qt4/ADM_jobs/src
Message-ID: <20101127080144.C62D8480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:44 +0100 (Sat, 27 Nov 2010)
New Revision: 6785

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp
   branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.h
   branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
Log:
[jobs/socket] Return and processjob status

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp	2010-11-27 08:01:43 UTC (rev 6784)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.cpp	2010-11-27 08:01:44 UTC (rev 6785)
@@ -67,6 +67,18 @@
     ADM_info("Report : %d %%\n",percent);
     return true;
 }
+/**
+    \fn ADM_slaveReportProgress
+*/
+bool ADM_slaveSendResult(bool result)
+{
+    if(!mySocket)    return true;
+    ADM_socketMessage msg;
+    msg.setPayloadAsUint32_t(result);
+    msg.command=ADM_socketCommand_End;
+    mySocket->sendMessage(msg);
+    return true;
+}
 
 
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.h	2010-11-27 08:01:43 UTC (rev 6784)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/ADM_slave.h	2010-11-27 08:01:44 UTC (rev 6785)
@@ -18,7 +18,7 @@
 bool ADM_slaveConnect(uint32_t port);
 bool ADM_slaveShutdown(void );
 bool ADM_slaveReportProgress(uint32_t percent);
-
+bool ADM_slaveSendResult(bool result);
 #endif
 
 //EOF

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2010-11-27 08:01:43 UTC (rev 6784)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gui_savenew.cpp	2010-11-27 08:01:44 UTC (rev 6785)
@@ -39,6 +39,7 @@
 #include "ADM_filterChain.h"
 #include "ADM_videoEncoderApi.h"
 #include "ADM_vidMisc.h"
+#include "ADM_slave.h"
 /*
 
 */
@@ -130,6 +131,7 @@
     admSaver *save=new admSaver(name);
     bool r=save->save();
     delete save;
+    ADM_slaveSendResult(r);
     return (int)r;
 }
 

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:43 UTC (rev 6784)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-27 08:01:44 UTC (rev 6785)
@@ -96,6 +96,8 @@
     job.status=ADM_JOB_RUNNING;
     ADM_commandSocket *runSocket=NULL;
     ADM_jobUpdate(job);
+    ADM_socketMessage msg;
+    uint32_t v;
     
     // 1- Start listening to socket
 
@@ -122,7 +124,7 @@
         goto done;
     }
     // 4- wait for complete and/or success message
-    ADM_socketMessage msg;
+    
     while(1)
     {
         if(!runSocket->isAlive())
@@ -133,6 +135,31 @@
         if(runSocket->pollMessage(msg))
         {
             ADM_info("Got a new message %d\n",msg.command);
+            switch(msg.command)
+            {
+                case ADM_socketCommand_End:
+                            if(msg.getPayloadAsUint32_t(&v))
+                            {
+                                    r=(bool)v;
+                                    ADM_info("Result is %d\n",r);
+                                    goto done;
+                            }else
+                            {
+                                    ADM_error("Can read End payload   \n");
+                            }
+                            break;
+                case ADM_socketCommand_Progress:
+                            if(msg.getPayloadAsUint32_t(&v))
+                            {
+                                    printf("Progress %d %%\n",(int)v);
+                            }else
+                            {
+                                    ADM_error("Can read End payload   \n");
+                            }
+                            break;
+                default:        ADM_error("Unknown command\n");
+                                break;
+            }
         }
         ADM_usleep(1000*1000); // Refresh once per sec
     }



From mean at mail.berlios.de  Sat Nov 27 09:01:45 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sat, 27 Nov 2010 09:01:45 +0100
Subject: [Avidemux-svn-commit] r6786 - in
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket:
	include src
Message-ID: <20101127080145.E740A480FAA@sheep.berlios.de>

Author: mean
Date: 2010-11-27 09:01:45 +0100 (Sat, 27 Nov 2010)
New Revision: 6786

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreCommandSocket.h
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreCommandSocket.cpp
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
Log:
[jobs/socket] Return and processjob status

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreCommandSocket.h
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreCommandSocket.h	2010-11-27 08:01:44 UTC (rev 6785)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/include/ADM_coreCommandSocket.h	2010-11-27 08:01:45 UTC (rev 6786)
@@ -55,6 +55,13 @@
         virtual ADM_commandSocket *waitForConnect(uint32_t timeoutMs);
         bool sendMessage(const ADM_socketMessage &msg);
         bool getMessage(ADM_socketMessage &msg);
+        bool pollMessage(ADM_socketMessage &msg);
+        bool handshake(void);
+        bool isAlive(void)
+                {
+                    if(mySocket) return true;
+                    return false;
+                }
     public:
         ADM_commandSocket(int newSocket);
         ADM_commandSocket( void );

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreCommandSocket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreCommandSocket.cpp	2010-11-27 08:01:44 UTC (rev 6785)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreCommandSocket.cpp	2010-11-27 08:01:45 UTC (rev 6786)
@@ -28,7 +28,7 @@
 }
 static bool     char_to_uint32(uint32_t *v,uint8_t *p)
  {
-    uint32_t a=(p[0])+(p[1]<<8)+(p[2]<<16)+(p[4]<<24);
+    uint32_t a=(p[0])+(p[1]<<8)+(p[2]<<16)+(p[3]<<24);
     *v=a;
     return true;
 }
@@ -107,6 +107,48 @@
     return true;
 }
 /**
+    \fn pollMessage
+*/
+bool ADM_commandSocket::pollMessage(ADM_socketMessage &msg)
+{
+//
+        if(!mySocket)
+        {
+            ADM_error("Wait for connect called with no socket opened\n");
+            return NULL;        
+        }
+    // Wait for connect...
+        fd_set set,er;
+        FD_ZERO(&set);
+        FD_ZERO(&er);
+        FD_SET(mySocket,&set);
+        FD_SET(mySocket,&er);
+        struct timeval timeout; 
+
+        timeout.tv_sec=0;
+        timeout.tv_usec=10*1000; // us
+        //ADM_info("Selecting\n");
+        int evt=select(1+mySocket,&set,NULL,&er,&timeout);
+        if(evt<0) 
+        {
+            ADM_error("Socket disconnected\n");
+            close();
+            return false;
+        }
+        
+        if(FD_ISSET(mySocket,&er))
+        {
+            ADM_error("OOPs socket is in error\n");
+        }
+        if(!evt)
+        {
+            printf(".");
+            return false;
+        }
+        return getMessage(msg);
+}
+
+/**
     \fn getPayloadAsUint32_t
 */
 bool     ADM_socketMessage::getPayloadAsUint32_t(uint32_t *v)
@@ -140,4 +182,39 @@
 #warning fixme badly
     return (ADM_commandSocket *)ADM_socket::waitForConnect(timeoutMs);
 }
+/**
+    \fn handshake
+*/
+bool ADM_commandSocket::handshake(void)
+{
+    uint32_t version;
+    ADM_info("Waiting for hello message...\n");
+    ADM_socketMessage msg;
+    msg.setPayloadAsUint32_t(ADM_COMMAND_SOCKET_VERSION);
+    msg.command=ADM_socketCommand_Hello;
+    if(!sendMessage(msg))
+    {
+        ADM_error("Cannot send hello message");
+        goto done;
+    }
+    if(!getMessage(msg))
+    {
+        ADM_error("Cannot get hello message");
+        goto done;
+    }
+    if(msg.command!=ADM_socketCommand_Hello)
+    {
+        ADM_error("Replys is not a hello \n");
+        goto done;
+    }
+    if(!msg.getPayloadAsUint32_t(&version) || version!=ADM_COMMAND_SOCKET_VERSION)
+    {
+        ADM_error("Wrong command version\n");
+        goto done;
+    }
+    ADM_info("Got hello message, continuing...\n");
+    return true;
+done:
+    return false;
+}
 // EOF
\ No newline at end of file

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:44 UTC (rev 6785)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-27 08:01:45 UTC (rev 6786)
@@ -110,15 +110,16 @@
     while(got<howmuch)
     {
         rx=recv(mySocket,(char *)where,howmuch-got,0);
-        if(rx<0)
+        if(rx<=0)
         {
           perror("RxData");
-          return 0;
+          close();
+          return false;
         }
         where+=rx;
         got+=rx;
     }
-  return 1;
+  return true;
 }
 /**
     \fn txData



From gruntster at mail.berlios.de  Sun Nov 28 10:14:05 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 28 Nov 2010 10:14:05 +0100
Subject: [Avidemux-svn-commit] r6787 - in
	branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264:
	. qt4
Message-ID: <20101128091405.893D0480FC7@sheep.berlios.de>

Author: gruntster
Date: 2010-11-28 10:14:05 +0100 (Sun, 28 Nov 2010)
New Revision: 6787

Modified:
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
   branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
Log:
[x264] support core version 110

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-11-27 08:01:45 UTC (rev 6786)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.cpp	2010-11-28 09:14:05 UTC (rev 6787)
@@ -94,6 +94,13 @@
 	connect(ui.dct8x8CheckBox, SIGNAL(toggled(bool)), this, SLOT(dct8x8CheckBox_toggled(bool)));
 	connect(ui.p8x8CheckBox, SIGNAL(toggled(bool)), this, SLOT(p8x8CheckBox_toggled(bool)));
 
+#if X264_BUILD < 110
+	ui.weightedPPredictComboBox->clear();
+	ui.weightedPPredictComboBox->addItem(tr("Disabled"));
+	ui.weightedPPredictComboBox->addItem(tr("Blind Offset"));
+	ui.weightedPPredictComboBox->addItem(tr("Smart Analysis"));
+#endif
+
 	// Frame tab
 	connect(ui.loopFilterCheckBox, SIGNAL(toggled(bool)), this, SLOT(loopFilterCheckBox_toggled(bool)));
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-11-27 08:01:45 UTC (rev 6786)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/qt4/x264ConfigDialog.ui	2010-11-28 09:14:05 UTC (rev 6787)
@@ -1131,12 +1131,12 @@
                 </item>
                 <item>
                  <property name="text">
-                  <string>Blind Offset</string>
+                  <string>Weighted References</string>
                  </property>
                 </item>
                 <item>
                  <property name="text">
-                  <string>Smart Analysis</string>
+                  <string>Weighted References + Duplicates</string>
                  </property>
                 </item>
                </widget>

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-11-27 08:01:45 UTC (rev 6786)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Options.cpp	2010-11-28 09:14:05 UTC (rev 6787)
@@ -1386,9 +1386,15 @@
 		case X264_WEIGHTP_NONE:
 			strcpy((char*)xmlBuffer, "none");
 			break;
+#if X264_BUILD < 110
 		case X264_WEIGHTP_BLIND:
 			strcpy((char*)xmlBuffer, "blind");
 			break;
+#else
+		case X264_WEIGHTP_SIMPLE:
+			strcpy((char*)xmlBuffer, "simple");
+			break;
+#endif
 		case X264_WEIGHTP_SMART:
 			strcpy((char*)xmlBuffer, "smart");
 			break;
@@ -1895,8 +1901,13 @@
 			{
 				int weightedPredPFrames = X264_WEIGHTP_NONE;
 
+#if X264_BUILD < 110
 				if (strcmp(content, "blind") == 0)
 					weightedPredPFrames = X264_WEIGHTP_BLIND;
+#else
+				if (strcmp(content, "simple") == 0)
+					weightedPredPFrames = X264_WEIGHTP_SIMPLE;
+#endif
 				else if (strcmp(content, "smart") == 0)
 					weightedPredPFrames = X264_WEIGHTP_SMART;
 

Modified: branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd
===================================================================
--- branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2010-11-27 08:01:45 UTC (rev 6786)
+++ branches/avidemux_2.5_branch_gruntster/plugins/ADM_videoEncoder/ADM_vidEnc_x264/x264Param.xsd	2010-11-28 09:14:05 UTC (rev 6787)
@@ -335,7 +335,9 @@
                       <xs:simpleType>
                         <xs:restriction base="xs:string">
                           <xs:enumeration value="none"/>
+						  <!-- blind deprecated core 110 -->
                           <xs:enumeration value="blind"/>
+						  <xs:enumeration value="simple"/>
                           <xs:enumeration value="smart"/>
                         </xs:restriction>
                       </xs:simpleType>



From gruntster at mail.berlios.de  Sun Nov 28 10:20:37 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 28 Nov 2010 10:20:37 +0100
Subject: [Avidemux-svn-commit] r6788 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries
Message-ID: <20101128092037.53192480FC7@sheep.berlios.de>

Author: gruntster
Date: 2010-11-28 10:20:36 +0100 (Sun, 28 Nov 2010)
New Revision: 6788

Removed:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg_r20602.tar.gz
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/libswscale_r29964.tar.gz
Log:
[ffmpeg] remove old tarballs

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/ffmpeg_r20602.tar.gz
===================================================================
(Binary files differ)

Deleted: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_libraries/libswscale_r29964.tar.gz
===================================================================
(Binary files differ)



From gruntster at mail.berlios.de  Sun Nov 28 10:23:33 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 28 Nov 2010 10:23:33 +0100
Subject: [Avidemux-svn-commit] r6789 -
	branches/avidemux_2.5_branch_gruntster/cmake_compile_check
Message-ID: <20101128092333.D9F53480FC7@sheep.berlios.de>

Author: gruntster
Date: 2010-11-28 10:23:33 +0100 (Sun, 28 Nov 2010)
New Revision: 6789

Modified:
   branches/avidemux_2.5_branch_gruntster/cmake_compile_check/aften_check.cpp
Log:
[aften] add support for git version of Aften

Modified: branches/avidemux_2.5_branch_gruntster/cmake_compile_check/aften_check.cpp
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake_compile_check/aften_check.cpp	2010-11-28 09:20:36 UTC (rev 6788)
+++ branches/avidemux_2.5_branch_gruntster/cmake_compile_check/aften_check.cpp	2010-11-28 09:23:33 UTC (rev 6789)
@@ -5,13 +5,16 @@
 int main(int argc, char **argv)
 {
 	const char* aftenVersion = aften_get_version();
-//        fprintf(stderr,"Aften version = %s\n",aftenVersion);
+	//fprintf(stderr, "Aften version = %s\n", aftenVersion);
+
 	if (strcmp(aftenVersion, "0.07") == 0)
 		return 7;
 	else if (strcmp(aftenVersion, "0.0.8") == 0)
 		return 8;
-        else if (strcmp(aftenVersion, "SVN") == 0)
-                return 99;
+	else if (strcmp(aftenVersion, "SVN") == 0)
+		return 99;
+	else if (strncmp(aftenVersion, "git", 3) == 0)
+		return 99;
 
-	return 0;
+	return -1;
 }



From gruntster at mail.berlios.de  Sun Nov 28 10:25:29 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 28 Nov 2010 10:25:29 +0100
Subject: [Avidemux-svn-commit] r6790 -
	branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include
Message-ID: <20101128092529.D53A6480FC7@sheep.berlios.de>

Author: gruntster
Date: 2010-11-28 10:25:29 +0100 (Sun, 28 Nov 2010)
New Revision: 6790

Modified:
   branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h
Log:
[mingw64] compilation fix

Modified: branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h
===================================================================
--- branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h	2010-11-28 09:23:33 UTC (rev 6789)
+++ branches/avidemux_2.5_branch_gruntster/avidemux/ADM_core/include/ADM_assert.h	2010-11-28 09:25:29 UTC (rev 6790)
@@ -24,9 +24,9 @@
 	#if defined(__MINGW64_VERSION_STR)
 		#if defined (__WIN64)
 			#include <intrin.h>
-		#else
-			#include <wchar.h>
 		#endif
+
+		#include <wchar.h>
 	#endif
 #endif
 



From gruntster at mail.berlios.de  Sun Nov 28 10:41:13 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 28 Nov 2010 10:41:13 +0100
Subject: [Avidemux-svn-commit] r6791 - in
	branches/avidemux_2.5_branch_gruntster/cmake: . patches
Message-ID: <20101128094113.E9B2B480FC7@sheep.berlios.de>

Author: gruntster
Date: 2010-11-28 10:41:13 +0100 (Sun, 28 Nov 2010)
New Revision: 6791

Added:
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_Makefile.patch
Modified:
   branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
   branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_ffv1.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch
   branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_matroskaenc.c.patch
Log:
[ffmpeg] update FFmpeg to r25831 & libswscale to r32647

Modified: branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2010-11-28 09:25:29 UTC (rev 6790)
+++ branches/avidemux_2.5_branch_gruntster/cmake/admFFmpegBuild.cmake	2010-11-28 09:41:13 UTC (rev 6791)
@@ -1,7 +1,7 @@
 include(admFFmpegUtil)
 
-set(FFMPEG_VERSION 25041)	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=10ef19af69162ac8bbdb697af33228fefb8006e1;sf=tgz
-set(SWSCALE_VERSION 32049)	# http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=12463fadc6566a4a6ebe01aa98dade211e5955fc;sf=tgz
+set(FFMPEG_VERSION 25831)	# http://git.ffmpeg.org/?p=ffmpeg;a=snapshot;h=95fe12b28a9c50f6c1ca2298fad7febfbbd20550;sf=tgz
+set(SWSCALE_VERSION 32647)	# http://git.ffmpeg.org/?p=libswscale;a=snapshot;h=e75b939d479ce8120d2d30d7275849e3377a990e;sf=tgz
 
 set(LIBRARY_SOURCE_DIR "${CMAKE_SOURCE_DIR}/avidemux/ADM_libraries")
 set(FFMPEG_SOURCE_DIR "${LIBRARY_SOURCE_DIR}/ffmpeg")

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2010-11-28 09:25:29 UTC (rev 6790)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/createPatches.sh	2010-11-28 09:41:13 UTC (rev 6791)
@@ -30,5 +30,6 @@
 updatePatch libavformat file.c
 updatePatch libavformat isom.c
 updatePatch libavformat matroskaenc.c
+updatePatch libavformat Makefile
 updatePatch libavutil avutil.h
 

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2010-11-28 09:25:29 UTC (rev 6790)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_avcodec.h.patch	2010-11-28 09:41:13 UTC (rev 6791)
@@ -1,8 +1,8 @@
-*** libavcodec/avcodec.h.old	Sun Sep  5 02:05:26 2010
---- libavcodec/avcodec.h	Sun Sep  5 02:05:26 2010
+*** libavcodec/avcodec.h.old	Fri Nov 26 17:53:30 2010
+--- libavcodec/avcodec.h	Fri Nov 26 17:53:30 2010
 ***************
-*** 626,631 ****
---- 626,633 ----
+*** 663,668 ****
+--- 663,670 ----
   #define CODEC_FLAG2_PSY           0x00080000 ///< Use psycho visual optimizations.
   #define CODEC_FLAG2_SSIM          0x00100000 ///< Compute SSIM during encoding, error[] values are undefined.
   #define CODEC_FLAG2_INTRA_REFRESH 0x00200000 ///< Use periodic insertion of intra blocks instead of keyframes.
@@ -12,8 +12,8 @@
   /* Unsupported options :
    *              Syntax Arithmetic coding (SAC)
 ***************
-*** 1508,1513 ****
---- 1510,1516 ----
+*** 1550,1555 ****
+--- 1552,1558 ----
        * - decoding: unused
        */
       int rc_max_rate;
@@ -22,8 +22,8 @@
       /**
        * minimum bitrate
 ***************
-*** 1522,1527 ****
---- 1525,1532 ----
+*** 1564,1569 ****
+--- 1567,1574 ----
        * - decoding: unused
        */
       int rc_buffer_size;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_ffv1.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_ffv1.c.patch	2010-11-28 09:25:29 UTC (rev 6790)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_ffv1.c.patch	2010-11-28 09:41:13 UTC (rev 6791)
@@ -1,8 +1,8 @@
-*** libavcodec/ffv1.c.old	Tue Jul  6 19:51:19 2010
---- libavcodec/ffv1.c	Tue Jul  6 19:51:19 2010
+*** libavcodec/ffv1.c.old	Fri Nov 26 17:53:32 2010
+--- libavcodec/ffv1.c	Fri Nov 26 17:53:32 2010
 ***************
-*** 1112,1117 ****
---- 1112,1119 ----
+*** 1734,1739 ****
+--- 1734,1741 ----
           clear_state(f);
       }else{
           p->key_frame= 0;

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch	2010-11-28 09:25:29 UTC (rev 6790)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h263dec.c.patch	2010-11-28 09:41:13 UTC (rev 6791)
@@ -1,8 +1,8 @@
-*** libavcodec/h263dec.c.old	Mon Jun  7 19:34:58 2010
---- libavcodec/h263dec.c	Mon Jun  7 19:34:58 2010
+*** libavcodec/h263dec.c.old	Fri Nov 26 17:53:32 2010
+--- libavcodec/h263dec.c	Fri Nov 26 17:53:32 2010
 ***************
-*** 119,124 ****
---- 119,143 ----
+*** 120,125 ****
+--- 120,144 ----
   
       return 0;
   }
@@ -29,8 +29,8 @@
   av_cold int ff_h263_decode_end(AVCodecContext *avctx)
   {
 ***************
-*** 414,419 ****
---- 433,444 ----
+*** 415,420 ****
+--- 434,445 ----
       } else {
           ret = h263_decode_picture_header(s);
       }
@@ -44,8 +44,8 @@
       if(ret==FRAME_SKIPPED) return get_consumed_bytes(s, buf_size);
   
 ***************
-*** 709,714 ****
---- 734,747 ----
+*** 710,715 ****
+--- 735,748 ----
   
   assert(s->current_picture.pict_type == s->current_picture_ptr->pict_type);
   assert(s->current_picture.pict_type == s->pict_type);

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2010-11-28 09:25:29 UTC (rev 6790)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_h264.c.patch	2010-11-28 09:41:13 UTC (rev 6791)
@@ -1,8 +1,8 @@
-*** libavcodec/h264.c.old	Tue Jul  6 19:51:21 2010
---- libavcodec/h264.c	Tue Jul  6 19:51:21 2010
+*** libavcodec/h264.c.old	Fri Nov 26 17:53:33 2010
+--- libavcodec/h264.c	Fri Nov 26 17:53:33 2010
 ***************
-*** 3382,3387 ****
---- 3382,3400 ----
+*** 3395,3400 ****
+--- 3395,3413 ----
       return 0;
   }
   

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2010-11-28 09:25:29 UTC (rev 6790)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavcodec_utils.c.patch	2010-11-28 09:41:13 UTC (rev 6791)
@@ -1,8 +1,8 @@
-*** libavcodec/utils.c.old	Sun Sep  5 02:05:45 2010
---- libavcodec/utils.c	Sun Sep  5 02:05:45 2010
+*** libavcodec/utils.c.old	Fri Nov 26 17:53:37 2010
+--- libavcodec/utils.c	Fri Nov 26 17:53:37 2010
 ***************
-*** 642,651 ****
---- 642,653 ----
+*** 655,664 ****
+--- 655,666 ----
   
       if((avctx->codec->capabilities & CODEC_CAP_DELAY) || avpkt->size){
           //FIXME remove the check below _after_ ensuring that all audio check that the available space is enough

Added: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_Makefile.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_Makefile.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_Makefile.patch	2010-11-28 09:41:13 UTC (rev 6791)
@@ -0,0 +1,19 @@
+*** libavformat/Makefile.old	Sun Nov 28 09:30:28 2010
+--- libavformat/Makefile	Sun Nov 28 09:30:28 2010
+***************
+*** 114,120 ****
+                                              riff.o isom.o rmdec.o rm.o
+  OBJS-$(CONFIG_MATROSKA_MUXER)            += matroskaenc.o matroska.o \
+                                              riff.o isom.o avc.o \
+!                                             flacenc_header.o
+  OBJS-$(CONFIG_MD5_MUXER)                 += md5enc.o
+  OBJS-$(CONFIG_MJPEG_DEMUXER)             += rawdec.o
+  OBJS-$(CONFIG_MJPEG_MUXER)               += rawenc.o
+--- 114,120 ----
+                                              riff.o isom.o rmdec.o rm.o
+  OBJS-$(CONFIG_MATROSKA_MUXER)            += matroskaenc.o matroska.o \
+                                              riff.o isom.o avc.o \
+!                                             flacenc_header.o avlanguage.o
+  OBJS-$(CONFIG_MD5_MUXER)                 += md5enc.o
+  OBJS-$(CONFIG_MJPEG_DEMUXER)             += rawdec.o
+  OBJS-$(CONFIG_MJPEG_MUXER)               += rawenc.o

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch	2010-11-28 09:25:29 UTC (rev 6790)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_isom.c.patch	2010-11-28 09:41:13 UTC (rev 6791)
@@ -1,7 +1,7 @@
-*** libavformat/isom.c.old	Tue Jul  6 19:51:27 2010
---- libavformat/isom.c	Tue Jul  6 19:51:27 2010
+*** libavformat/isom.c.old	Fri Nov 26 17:53:40 2010
+--- libavformat/isom.c	Fri Nov 26 17:53:40 2010
 ***************
-*** 215,221 ****
+*** 222,228 ****
       { CODEC_ID_MP1, MKTAG('.', 'm', 'p', '1') }, /* MPEG layer 1 */
       { CODEC_ID_MP2, MKTAG('.', 'm', 'p', '2') }, /* MPEG layer 2 */
   
@@ -9,7 +9,7 @@
       { CODEC_ID_MP3, 0x6D730055 }, /* MPEG layer 3 */
   
   /*  { CODEC_ID_OGG_VORBIS, MKTAG('O', 'g', 'g', 'S') }, *//* sample files at http://heroinewarrior.com/xmovie.php3 use this tag */
---- 215,224 ----
+--- 222,231 ----
       { CODEC_ID_MP1, MKTAG('.', 'm', 'p', '1') }, /* MPEG layer 1 */
       { CODEC_ID_MP2, MKTAG('.', 'm', 'p', '2') }, /* MPEG layer 2 */
   

Modified: branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_matroskaenc.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_matroskaenc.c.patch	2010-11-28 09:25:29 UTC (rev 6790)
+++ branches/avidemux_2.5_branch_gruntster/cmake/patches/libavformat_matroskaenc.c.patch	2010-11-28 09:41:13 UTC (rev 6791)
@@ -1,8 +1,8 @@
-*** libavformat/matroskaenc.c.old	Tue Jul  6 19:51:28 2010
---- libavformat/matroskaenc.c	Tue Jul  6 19:51:28 2010
+*** libavformat/matroskaenc.c.old	Fri Nov 26 17:53:41 2010
+--- libavformat/matroskaenc.c	Fri Nov 26 17:53:41 2010
 ***************
-*** 407,412 ****
---- 407,413 ----
+*** 410,415 ****
+--- 410,416 ----
   
   static int put_xiph_codecpriv(AVFormatContext *s, ByteIOContext *pb, AVCodecContext *codec)
   {
@@ -11,8 +11,8 @@
       int header_len[3];
       int first_header_size;
 ***************
-*** 431,436 ****
---- 432,459 ----
+*** 434,439 ****
+--- 435,462 ----
           put_buffer(pb, header_start[j], header_len[j]);
   
       return 0;
@@ -42,8 +42,8 @@
   
   static void get_aac_sample_rates(AVFormatContext *s, AVCodecContext *codec, int *sample_rate, int *output_sample_rate)
 ***************
-*** 549,554 ****
---- 572,595 ----
+*** 552,557 ****
+--- 575,598 ----
           put_ebml_uint (pb, MATROSKA_ID_TRACKUID        , i + 1);
           put_ebml_uint (pb, MATROSKA_ID_TRACKFLAGLACING , 0);    // no lacing (yet)
   



From gruntster at mail.berlios.de  Sun Nov 28 10:48:11 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 28 Nov 2010 10:48:11 +0100
Subject: [Avidemux-svn-commit] r6792 - in
	branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts:
	. avidemux faac faad fontconfig js lame libogg libvorbis
	libvpx nspr opencore-amr x264 xvid
Message-ID: <20101128094811.B9EAF480FC7@sheep.berlios.de>

Author: gruntster
Date: 2010-11-28 10:48:11 +0100 (Sun, 28 Nov 2010)
New Revision: 6792

Added:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faac/
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faac/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faad/
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faad/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/fontconfig/
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/fontconfig/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/fontconfig/libtool.patch
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/Makefile.ref.patch
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/WINNT6.1.mk
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/jsnum.c.patch
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/configure.patch
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/nasm.h.patch
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libogg/
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libogg/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvorbis/
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvorbis/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvorbis/libtool.patch
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/configure.patch
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/configure.sh.patch
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/amrnb_Makefile.in
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/amrwb_Makefile.in
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/Perform Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/configure.patch
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/nasm.inc.patch
Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Set Avidemux Environment Variables.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/x264/Perform Build.bat
Log:
[win] more build scripts

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat	2010-11-28 09:41:13 UTC (rev 6791)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/Set Common Environment Variables.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -3,26 +3,18 @@
 set nsisDir=%ProgramFiles32%\NSIS
 
 set devDir=E:\Dev
+set msysDir=E:/Dev/MSYS
 
-if "%BuildBits%" == "32" (
-	set msysDir=E:/Dev/MSYS
-	set qtDir=%devDir%\Qt
-	set CFLAGS=-m32 
-	set CXXFLAGS=-m32
-	set LDFLAGS=-m32
-	goto :setVars )
+if "%BuildBits%" == "32" goto :setVars
+if "%BuildBits%" == "64" goto :setVars
 
-if "%BuildBits%" == "64" (
-	set msysDir=E:/Dev/MSYS-64
-	set qtDir=%devDir%\Qt-64
-	goto :setVars )
-
 echo Error - BuildBits variable not set
 goto error
 
 :setVars
-set mingwDir=%devDir%\MinGW64
-set usrLocalDir=%msysDir%/local
+set mingwDir=%devDir%\MinGW%BuildBits%
+set usrLocalDir=%msysDir%/local%BuildBits%
+set qtDir=%devDir%\Qt%BuildBits%
 set CMAKE_INCLUDE_PATH=%usrLocalDir%/include
 set CMAKE_LIBRARY_PATH=%usrLocalDir%/lib
 set PKG_CONFIG_PATH=%usrLocalDir%\lib\pkgconfig
@@ -30,6 +22,8 @@
 set CFLAGS=%CFLAGS% -I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
 set CXXFLAGS=%CXXFLAGS% -I%CMAKE_INCLUDE_PATH% -L%CMAKE_LIBRARY_PATH%
 set LDFLAGS=%LDFLAGS% -shared-libgcc -lstdc++ -L%CMAKE_LIBRARY_PATH%
+set admBuildDir=%devDir%\avidemux_2.5_build%BuildBits%
+set admSdkBuildDir=%devDir%\avidemux_2.5_build%BuildBits%_sdk
 
 if exist "%qtDir%" (
 	for /f %%d in ('dir /b /ad /on %qtDir%') do set qtVer=%%d
@@ -73,7 +67,7 @@
 	goto error
 )
 
-set PATH=%cmakeDir%;%mingwDir%\bin;%usrLocalDir%\bin;%msysDir%\bin;%msysDir%\local32\bin;%qtDir%\bin;%PATH%
+set PATH=%cmakeDir%;%mingwDir%\bin;%usrLocalDir%\bin;%msysDir%\bin;%msysDir%\local-shared\bin;%qtDir%\bin;c:\strawberry\perl\bin;%PATH%
 
 goto end
 

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Set Avidemux Environment Variables.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Set Avidemux Environment Variables.bat	2010-11-28 09:41:13 UTC (rev 6791)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Set Avidemux Environment Variables.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -33,17 +33,11 @@
 	goto error
 )
 
-if "%BuildBits%" == "32" (
-	set buildFolder=build
-	set buildPluginFolder=buildPlugins)
+set buildFolder=build%BuildBits%
+set buildPluginFolder=buildPlugins%BuildBits%
+set buildDir=%admBuildDir%
+set sdkBuildDir=%admSdkBuildDir%
 
-if "%BuildBits%" == "64" (
-	set buildFolder=build64
-	set buildPluginFolder=buildPlugins64)
-
-set buildDir=%devDir%\avidemux_2.5_%buildFolder%
-set sdkBuildDir=%devDir%\avidemux_2.5_%buildFolder%_sdk
-
 set curDir=%CD%
 cd ..\..\..\..
 set sourceDir=%CD%
@@ -54,11 +48,9 @@
 	goto error
 )
 
-if "%BuildBits%" == "32" (set jsFolder=js)
-if "%BuildBits%" == "64" (set jsFolder=js-64)
-
+set jsFolder=js-1.7.0-%BuildBits%
 set SpiderMonkeySourceDir=%devDir%\%jsFolder%\src
-set SpiderMonkeyLibDir=%devDir%\%jsFolder%\src\WINNT6.0_OPT.OBJ
+set SpiderMonkeyLibDir=%devDir%\%jsFolder%\src\WINNT6.1_OPT.OBJ
 
 goto end
 

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faac/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faac/Perform Build.bat	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faac/Perform Build.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,62 @@
+ at echo off
+
+echo MSYS build for FAAC
+echo ===================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto :eof
+
+verify >nul
+call "../Set Common Environment Variables"
+if errorlevel 1 goto end
+
+set package=faac-1.28.tar.gz
+set sourceFolder=faac-1.28-%BuildBits%
+set tarFolder=faac-1.28
+set curDir=%CD%
+
+if not exist %package% (
+	echo.
+	echo Downloading
+	wget http://downloads.sourceforge.net/faac/%package%
+)
+
+if errorlevel 1 goto end
+
+echo.
+echo Preparing
+rm -r -f "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+mkdir "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+tar xfz "%package%" -C "%devDir%/%sourceFolder%"
+if errorlevel 1 goto end
+
+cd "%devDir%\%sourceFolder%"
+
+for /f "delims=" %%a in ('dir /b %tarFolder%') do (
+  move "%CD%\%tarFolder%\%%a" "%CD%"
+)
+
+copy ".\include\*.h" "%usrLocalDir%\include"
+cd libfaac
+gcc -s -O3 -shared -I../include *.c -o"%usrLocalDir%/bin/libfaac.dll" -Wl,--out-implib,"%usrLocalDir%/lib/libfaac.a"
+if errorlevel 1 goto end
+
+copy "%usrLocalDir%\bin\libfaac.dll" "%admBuildDir%"
+goto end
+
+:error
+echo Error
+
+:end
+pause
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faad/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faad/Perform Build.bat	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/faad/Perform Build.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,62 @@
+ at echo off
+
+echo MSYS build for FAAD
+echo ===================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto :eof
+
+verify >nul
+call "../Set Common Environment Variables"
+if errorlevel 1 goto end
+
+set package=faad2-2.7.tar.gz
+set sourceFolder=faac-2.7-%BuildBits%
+set tarFolder=faad2-2.7
+set curDir=%CD%
+
+if not exist %package% (
+	echo.
+	echo Downloading
+	wget http://downloads.sourceforge.net/faac/%package%
+)
+
+if errorlevel 1 goto end
+
+echo.
+echo Preparing
+rm -r -f "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+mkdir "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+tar xfz "%package%" -C "%devDir%/%sourceFolder%"
+if errorlevel 1 goto end
+
+cd "%devDir%\%sourceFolder%"
+
+for /f "delims=" %%a in ('dir /b %tarFolder%') do (
+  move "%CD%\%tarFolder%\%%a" "%CD%"
+)
+
+copy ".\include\*.h" "%usrLocalDir%\include"
+cd libfaad
+gcc -s -O3 -DHAVE_MEMCPY=1 -DHAVE_STRING_H=1 -DHAVE_STDINT_H=1 -I../include -I"." *.c -shared -o "%usrLocalDir%/bin/libfaad2.dll" -Wl,--out-implib,"%usrLocalDir%/lib/libfaad.a"
+if errorlevel 1 goto end
+
+copy "%usrLocalDir%\bin\libfaad2.dll" "%admBuildDir%"
+goto end
+
+:error
+echo Error
+
+:end
+pause
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/fontconfig/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/fontconfig/Perform Build.bat	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/fontconfig/Perform Build.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,77 @@
+ at echo off
+
+echo MSYS build for fontconfig
+echo =========================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto :eof
+
+verify >nul
+call "../Set Common Environment Variables"
+if errorlevel 1 goto end
+
+set package=fontconfig-2.8.0.tar.gz
+set sourceFolder=fontconfig-2.8.0-%BuildBits%
+set tarFolder=fontconfig-2.8.0
+set curDir=%CD%
+
+if not exist %package% (
+	echo.
+	echo Downloading
+	wget http://fontconfig.org/release/%package%
+)
+
+if errorlevel 1 goto end
+
+echo.
+echo Preparing
+rm -r -f "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+mkdir "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+tar xfz "%package%" -C "%devDir%/%sourceFolder%"
+if errorlevel 1 goto end
+
+cd "%devDir%\%sourceFolder%"
+
+for /f "delims=" %%a in ('dir /b %tarFolder%') do (
+  move "%CD%\%tarFolder%\%%a" "%CD%"
+)
+
+echo.
+echo Configuring
+sh ./configure --prefix="%usrLocalDir%" --disable-static
+
+if "%BuildBits%" == "64" (
+	echo.
+	echo Patching
+	patch -p0 -i "%curDir%\libtool.patch"
+)
+
+if errorlevel 1 goto end
+echo.
+pause
+
+make install
+if errorlevel 1 goto end
+
+del "%usrLocalDir%\etc\fonts\fonts.conf.bak"
+copy "%usrLocalDir%\bin\libfontconfig-1.dll" "%admBuildDir%"
+xcopy /s/y "%usrLocalDir%\etc\fonts\*.*" "%admBuildDir%\etc\fonts\"
+
+goto end
+
+:error
+echo Error
+
+:end
+pause
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/fontconfig/libtool.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/fontconfig/libtool.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/fontconfig/libtool.patch	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,11 @@
+--- libtool.orig	2010-11-27 22:40:35 +0000
++++ libtool	2010-11-27 22:52:21 +0000
+@@ -117,7 +117,7 @@
+ reload_cmds="\$LD\$reload_flag -o \$output\$reload_objs"
+ 
+ # Method to check whether dependent libraries are shared objects.
+-deplibs_check_method="file_magic file format pei*-i386(.*architecture: i386)?"
++deplibs_check_method="file_magic file format pei*-x86-64(.*architecture: i386)?"
+ 
+ # Command to use when deplibs_check_method == "file_magic".
+ file_magic_cmd="\$OBJDUMP -f"

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/Makefile.ref.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/Makefile.ref.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/Makefile.ref.patch	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,11 @@
+--- src/Makefile.ref.orig	2010-11-28 02:53:57 +0000
++++ src/Makefile.ref	2010-11-28 02:53:12 +0000
+@@ -94,7 +94,7 @@
+ ifeq ($(OS_ARCH),WINNT)
+ _MSC_VER = $(shell $(CC) 2>&1 | sed -n 's/.*Compiler Version \([0-9]*\)\.\([0-9]*\).*/\1\2/p')
+ ifeq (,$(filter-out 1200 1300 1310,$(_MSC_VER)))
+-CFLAGS += -Op
++#CFLAGS += -Op
+ else
+ CFLAGS += -fp:precise
+ endif

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/Perform Build.bat	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/Perform Build.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,76 @@
+ at echo off
+
+%~d0
+cd "%~dp0"
+
+echo MSYS build for SpiderMonkey
+echo ===========================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto :eof
+
+verify >nul
+call "../Set Common Environment Variables"
+if errorlevel 1 goto end
+
+set package=js-1.7.0.tar.gz
+set sourceFolder=js-1.7.0-%BuildBits%
+set tarFolder=js
+set curDir=%CD%
+
+if not exist %package% (
+	echo.
+	echo Downloading
+	wget http://ftp.mozilla.org/pub/mozilla.org/js/%package%
+)
+
+if errorlevel 1 goto end
+
+echo.
+echo Preparing
+rm -r -f "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+mkdir "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+tar xfz "%package%" -C "%devDir%/%sourceFolder%"
+if errorlevel 1 goto end
+
+cd "%devDir%\%sourceFolder%"
+
+for /f "delims=" %%a in ('dir /b %tarFolder%') do (
+	move "%CD%\%tarFolder%\%%a" "%CD%"
+)
+
+echo.
+echo Patching
+copy "%curDir%\WINNT6.1.mk" .\src\config
+patch -p0 -i "%curDir%\Makefile.ref.patch"
+patch -p0 -i "%curDir%\jsnum.c.patch"
+
+echo.
+cd src
+windres -i js3240.rc -o jsres.o -O coff
+set CFLAGS=%CFLAGS% -I"%usrLocalDir%/include/nspr"
+make -f Makefile.ref JS_DIST="%usrLocalDir%" BUILD_OPT=1 JS_HAS_FILE_OBJECT=1 XLDFLAGS="%LDFLAGS% jsres.o -L%usrLocalDir%/lib -lnspr4"
+if errorlevel 1 goto end
+echo.
+
+copy "WINNT6.1_OPT.OBJ\libjs.dll" "%usrLocalDir%\bin"
+copy "%usrLocalDir%\bin\libjs.dll" "%admBuildDir%"
+
+goto end
+
+:error
+echo Error
+
+:end
+pause
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/WINNT6.1.mk
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/WINNT6.1.mk	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/WINNT6.1.mk	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,26 @@
+CC = gcc
+CCC = g++
+LD = g++
+
+CFLAGS +=  -Wall -Wno-format
+OS_CFLAGS = -D_X86_=1 -DXP_WIN -DXP_WIN32 -DWIN32 -D_WINDOWS -D_WIN32 -DWINVER=0x500 -D_WIN32_WINNT=0x500 -D_MINGW -DEXPORT_JS_API
+
+XMKSHLIBOPTS += -Wl,--out-implib=$(OBJDIR)/libjs.dll.a
+RANLIB = ranlib
+MKSHLIB = $(LD) -shared $(XMKSHLIBOPTS)
+
+ifdef BUILD_OPT
+OS_CFLAGS += -s
+endif
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = x86
+GFX_ARCH = win32
+
+JSDLL_CFLAGS = -DEXPORT_JS_API
+OS_LIBS = -lm -lc
+
+PREBUILT_CPUCFG = 1
+SO_SUFFIX=dll
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/jsnum.c.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/jsnum.c.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/js/jsnum.c.patch	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,11 @@
+--- src/jsnum.c.orig	2007-04-06 21:53:22 +0100
++++ src/jsnum.c	2010-11-28 03:00:05 +0000
+@@ -528,7 +528,7 @@
+  * to 53 bit mantissa.
+  * On Alpha platform this is handled via Compiler option.
+  */
+-#define FIX_FPU() _control87(MCW_EM | PC_53, MCW_EM | MCW_PC)
++#define FIX_FPU() _control87(_MCW_EM | _PC_53, _MCW_EM | _MCW_PC)
+ 
+ #else
+ 

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/Perform Build.bat	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/Perform Build.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,78 @@
+ at echo off
+
+echo MSYS build for LAME
+echo ===================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto :eof
+
+verify >nul
+call "../Set Common Environment Variables"
+if errorlevel 1 goto end
+
+set package=lame-3.98.4.tar.gz
+set sourceFolder=lame-3.98.4-%BuildBits%
+set tarFolder=lame-3.98.4
+set curDir=%CD%
+
+if not exist %package% (
+	echo.
+	echo Downloading
+	wget http://sourceforge.net/projects/lame/files/lame/3.98.4/%package%/download/
+)
+
+if errorlevel 1 goto end
+
+echo.
+echo Preparing
+rm -r -f "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+mkdir "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+tar xfz "%package%" -C "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+cd "%devDir%\%sourceFolder%"
+
+for /f "delims=" %%a in ('dir /b %tarFolder%') do (
+  move "%CD%\%tarFolder%\%%a" "%CD%"
+)
+
+if "%BuildBits%" == "64" (
+	echo.
+	echo Patching
+	patch -p0 -i "%curDir%\configure.patch"
+	patch -p0 -i "%curDir%\nasm.h.patch"
+)
+
+echo.
+echo Configuring
+
+sh ./configure --prefix="%usrLocalDir%" --disable-static --enable-nasm
+
+if errorlevel 1 goto end
+echo.
+pause
+
+make install
+if errorlevel 1 goto end
+
+strip "%usrLocalDir%\bin\libmp3lame-0.dll"
+copy "%usrLocalDir%\bin\libmp3lame-0.dll" "%admBuildDir%"
+
+goto end
+
+:error
+echo Error
+
+:end
+pause
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/configure.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/configure.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/configure.patch	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,11 @@
+--- configure.orig	2010-03-22 20:40:17 +0000
++++ configure	2010-11-27 20:28:19 +0000
+@@ -30152,7 +30152,7 @@
+ case $host_os in
+ 	*cygwin*|*mingw32*)
+ 		CYGWIN=yes
+-		NASM_FORMAT="-f win32 -DWIN32"
++		NASM_FORMAT="-f win64 -DWIN32"
+ 		;;
+ 	*darwin*)
+ 		NASM_FORMAT="-f macho"

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/nasm.h.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/nasm.h.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/lame/nasm.h.patch	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,13 @@
+--- libmp3lame/i386/nasm.h.orig	2010-11-27 20:30:25 +0000
++++ libmp3lame/i386/nasm.h	2010-11-27 20:28:15 +0000
+@@ -45,7 +45,9 @@
+ %endif
+ 
+ %ifdef WIN32
+-	%define _NAMING
++	%ifnidn __OUTPUT_FORMAT__,win64
++		%define _NAMING
++	%endif
+ %endif
+ 
+ %ifdef __tos__

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libogg/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libogg/Perform Build.bat	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libogg/Perform Build.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,70 @@
+ at echo off
+
+echo MSYS build for libogg
+echo =====================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto :eof
+
+verify >nul
+call "../Set Common Environment Variables"
+if errorlevel 1 goto end
+
+set package=libogg-1.2.1.tar.gz
+set sourceFolder=libogg-1.2.1-%BuildBits%
+set tarFolder=libogg-1.2.1
+set curDir=%CD%
+
+if not exist %package% (
+	echo.
+	echo Downloading
+	wget http://downloads.xiph.org/releases/ogg/%package%
+)
+
+if errorlevel 1 goto end
+
+echo.
+echo Preparing
+rm -r -f "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+mkdir "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+tar xfz "%package%" -C "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+cd "%devDir%\%sourceFolder%"
+
+for /f "delims=" %%a in ('dir /b %tarFolder%') do (
+  move "%CD%\%tarFolder%\%%a" "%CD%"
+)
+
+echo.
+echo Configuring
+
+sh ./configure --prefix="%usrLocalDir%" --disable-static
+
+if errorlevel 1 goto end
+echo.
+pause
+
+make install-strip
+if errorlevel 1 goto end
+
+copy "%usrLocalDir%\bin\libogg-0.dll" "%admBuildDir%"
+
+goto end
+
+:error
+echo Error
+
+:end
+pause
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvorbis/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvorbis/Perform Build.bat	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvorbis/Perform Build.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,75 @@
+ at echo off
+
+echo MSYS build for libvorbis
+echo ========================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto :eof
+
+verify >nul
+call "../Set Common Environment Variables"
+if errorlevel 1 goto end
+
+set package=libvorbis-1.3.2.tar.gz
+set sourceFolder=libvorbis-1.3.2-%BuildBits%
+set tarFolder=libvorbis-1.3.2
+set curDir=%CD%
+
+if not exist %package% (
+	echo.
+	echo Downloading
+	wget http://downloads.xiph.org/releases/vorbis/%package%
+)
+
+if errorlevel 1 goto end
+
+echo.
+echo Preparing
+rm -r -f "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+mkdir "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+tar xfz "%package%" -C "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+cd "%devDir%\%sourceFolder%"
+
+for /f "delims=" %%a in ('dir /b %tarFolder%') do (
+	move "%CD%\%tarFolder%\%%a" "%CD%"
+)
+
+echo.
+echo Configuring
+
+sh ./configure --prefix="%usrLocalDir%" --disable-static --disable-examples --disable-docs
+
+echo.
+echo Patching
+patch -p0 -i "%curDir%\libtool.patch"
+
+if errorlevel 1 goto end
+echo.
+pause
+
+make install-strip
+if errorlevel 1 goto end
+
+copy "%usrLocalDir%\bin\libvorbis-0.dll" "%admBuildDir%"
+copy "%usrLocalDir%\bin\libvorbisenc-2.dll" "%admBuildDir%"
+
+goto end
+
+:error
+echo Error
+
+:end
+pause
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvorbis/libtool.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvorbis/libtool.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvorbis/libtool.patch	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,24 @@
+--- libtool.orig	2010-11-27 19:32:53 +0000
++++ libtool	2010-11-27 19:33:08 +0000
+@@ -6446,8 +6446,8 @@
+ 		esac
+ 		else
+ 		  eval libdir=`${SED} -n -e 's/^libdir=\(.*\)$/\1/p' $deplib`
+-		  test -z "$libdir" && \
+-		    func_fatal_error "\`$deplib' is not a valid libtool archive"
++		  #test -z "$libdir" && \
++		    #func_fatal_error "\`$deplib' is not a valid libtool archive"
+ 		  test "$absdir" != "$libdir" && \
+ 		    func_warning "\`$deplib' seems to be moved"
+ 
+@@ -8570,8 +8570,8 @@
+ 		func_basename "$deplib"
+ 		name="$func_basename_result"
+ 		eval libdir=`${SED} -n -e 's/^libdir=\(.*\)$/\1/p' $deplib`
+-		test -z "$libdir" && \
+-		  func_fatal_error "\`$deplib' is not a valid libtool archive"
++		#test -z "$libdir" && \
++		  #func_fatal_error "\`$deplib' is not a valid libtool archive"
+ 		newdependency_libs="$newdependency_libs $libdir/$name"
+ 		;;
+ 	      *) newdependency_libs="$newdependency_libs $deplib" ;;

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/Perform Build.bat	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/Perform Build.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,74 @@
+ at echo off
+
+echo MSYS build for libvpx
+echo =====================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto :eof
+
+verify >nul
+call "../Set Common Environment Variables"
+if errorlevel 1 goto end
+
+set package=libvpx-v0.9.5.tar.bz2
+set sourceFolder=libvpx-0.9.5-%BuildBits%
+set tarFolder=libvpx-v0.9.5
+set curDir=%CD%
+
+if not exist %package% (
+	echo.
+	echo Downloading
+	wget http://webm.googlecode.com/files/%package%
+)
+
+if errorlevel 1 goto end
+
+echo.
+echo Preparing
+rm -r -f "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+mkdir "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+tar xfj "%package%" -C "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+cd "%devDir%\%sourceFolder%"
+
+for /f "delims=" %%a in ('dir /b %tarFolder%') do (
+  move "%CD%\%tarFolder%\%%a" "%CD%"
+)
+
+echo.
+echo Patching
+patch -p0 -i "%curDir%\configure.patch"
+patch -p0 -i "%curDir%\configure.sh.patch"
+
+echo.
+echo Configuring
+
+if "%BuildBits%" == "32" sh ./configure --prefix="%usrLocalDir%" --disable-vp8-encoder
+if "%BuildBits%" == "64" sh ./configure --prefix="%usrLocalDir%" --disable-vp8-encoder --target=x86_64-win64-gcc
+
+if errorlevel 1 goto end
+echo.
+pause
+
+make install
+if errorlevel 1 goto end
+
+goto end
+
+:error
+echo Error
+
+:end
+pause
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/configure.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/configure.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/configure.patch	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,10 @@
+--- configure.orig	2010-11-27 11:16:30 +0000
++++ configure	2010-11-27 11:15:53 +0000
+@@ -117,6 +117,7 @@
+ all_platforms="${all_platforms} x86_64-linux-gcc"
+ all_platforms="${all_platforms} x86_64-linux-icc"
+ all_platforms="${all_platforms} x86_64-solaris-gcc"
++all_platforms="${all_platforms} x86_64-win64-gcc"
+ all_platforms="${all_platforms} x86_64-win64-vs8"
+ all_platforms="${all_platforms} x86_64-win64-vs9"
+ all_platforms="${all_platforms} universal-darwin8-gcc"

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/configure.sh.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/configure.sh.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/libvpx/configure.sh.patch	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,17 @@
+--- build/make/configure.sh.orig	2010-10-28 14:14:14 +0100
++++ build/make/configure.sh	2010-11-27 11:45:42 +0000
+@@ -877,8 +877,12 @@
+         [ "${AS##*/}" = nasm ] && add_asflags -Ox
+         AS_SFX=.asm
+         case  ${tgt_os} in
+-            win*)
+-                add_asflags -f win${bits}
++            win32)
++                add_asflags -f win32
++                enabled debug && add_asflags -g dwarf2
++            ;;
++			win64)
++                add_asflags -f x64
+                 enabled debug && add_asflags -g dwarf2
+             ;;
+             linux*|solaris*)

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/Perform Build.bat	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/nspr/Perform Build.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,80 @@
+ at echo off
+
+%~d0
+cd "%~dp0"
+
+echo MSYS build for nspr
+echo ===================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto :eof
+
+verify >nul
+call "../Set Common Environment Variables"
+if errorlevel 1 goto end
+
+set package=nspr-4.8.6.tar.gz
+set sourceFolder=nspr-4.8.6-%BuildBits%
+set tarFolder=nspr-4.8.6
+set curDir=%CD%
+
+if not exist %package% (
+	echo.
+	echo Downloading
+	wget ftp://ftp.mozilla.org/pub/mozilla.org/nspr/releases/v4.8.6/src/%package%
+)
+
+if errorlevel 1 goto end
+
+echo.
+echo Preparing
+rm -r -f "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+mkdir "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+tar xfz "%package%" -C "%devDir%/%sourceFolder%"
+if errorlevel 1 goto end
+
+cd "%devDir%\%sourceFolder%"
+
+for /f "delims=" %%a in ('dir /b %tarFolder%') do (
+	move "%CD%\%tarFolder%\%%a" "%CD%"
+)
+
+echo.
+echo Configuring
+cd mozilla\nsprpub
+sh ./configure --prefix="%usrLocalDir%" --enable-strip --enable-win32-target=WIN95 --enable-optimize --disable-debug
+
+if errorlevel 1 goto end
+echo.
+pause
+
+make
+if errorlevel 1 goto end
+
+make install
+if errorlevel 1 goto end
+
+move "%usrLocalDir%\lib\nspr4.dll" "%usrLocalDir%\bin"
+copy "%usrLocalDir%\bin\nspr4.dll" "%admBuildDir%"
+
+pexports "%usrLocalDir%/bin/nspr4.dll" > nspr4.def
+dlltool -d nspr4.def -l "%usrLocalDir%/lib/nspr4.dll.a"
+
+goto end
+
+:error
+echo Error
+
+:end
+pause
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/Perform Build.bat	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/Perform Build.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,75 @@
+ at echo off
+
+echo MSYS build for opencore-amr
+echo ===========================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto :eof
+
+verify >nul
+call "../Set Common Environment Variables"
+if errorlevel 1 goto end
+
+set package=opencore-amr-0.1.2.tar.gz
+set sourceFolder=opencore-amr-0.1.2-%BuildBits%
+set tarFolder=opencore-amr-0.1.2
+set curDir=%CD%
+
+if not exist %package% (
+	echo.
+	echo Downloading
+	wget http://sourceforge.net/projects/opencore-amr/files/opencore-amr/0.1.2/%package%/download
+)
+
+if errorlevel 1 goto end
+
+echo.
+echo Preparing
+rm -r -f "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+mkdir "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+tar xfz "%package%" -C "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+cd "%devDir%\%sourceFolder%"
+
+for /f "delims=" %%a in ('dir /b %tarFolder%') do (
+  move "%CD%\%tarFolder%\%%a" "%CD%"
+)
+
+echo.
+echo Patching
+patch -p0 -i "%curDir%\amrnb_Makefile.in"
+patch -p0 -i "%curDir%\amrwb_Makefile.in"
+
+echo.
+echo Configuring
+
+sh ./configure --prefix="%usrLocalDir%" --disable-static
+
+if errorlevel 1 goto end
+echo.
+pause
+
+make install-strip
+if errorlevel 1 goto end
+
+copy "%usrLocalDir%\bin\libopencore-amrnb-0.dll" "%admBuildDir%"
+copy "%usrLocalDir%\bin\libopencore-amrwb-0.dll" "%admBuildDir%"
+
+goto end
+
+:error
+echo Error
+
+:end
+pause
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/amrnb_Makefile.in
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/amrnb_Makefile.in	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/amrnb_Makefile.in	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,11 @@
+--- amrnb/Makefile.in.orig	2009-09-18 18:45:43 +0100
++++ amrnb/Makefile.in	2010-11-27 20:52:08 +0000
+@@ -274,7 +274,7 @@
+ pkgconfigdir = $(libdir)/pkgconfig
+ pkgconfig_DATA = opencore-amrnb.pc
+ lib_LTLIBRARIES = libopencore-amrnb.la
+-libopencore_amrnb_la_LDFLAGS = -version-info @OPENCORE_AMRNB_VERSION@
++libopencore_amrnb_la_LDFLAGS = -version-info @OPENCORE_AMRNB_VERSION@ -no-undefined
+ 
+ # Our sources to include. There are certain sources we exclude and they are
+ # $(DEC_SRC_DIR)/decoder_gsm_amr.cpp

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/amrwb_Makefile.in
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/amrwb_Makefile.in	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/opencore-amr/amrwb_Makefile.in	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,11 @@
+--- amrwb/Makefile.in.orig	2010-11-27 20:54:46 +0000
++++ amrwb/Makefile.in	2010-11-27 20:52:45 +0000
+@@ -250,7 +250,7 @@
+ pkgconfigdir = $(libdir)/pkgconfig
+ pkgconfig_DATA = opencore-amrwb.pc
+ lib_LTLIBRARIES = libopencore-amrwb.la
+-libopencore_amrwb_la_LDFLAGS = -version-info @OPENCORE_AMRWB_VERSION@
++libopencore_amrwb_la_LDFLAGS = -version-info @OPENCORE_AMRWB_VERSION@ -no-undefined
+ 
+ # Our sources to include. There are certain sources we exclude and they are
+ # $(DEC_SRC_DIR)/decoder_amr_wb.cpp

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/x264/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/x264/Perform Build.bat	2010-11-28 09:41:13 UTC (rev 6791)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/x264/Perform Build.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -16,7 +16,7 @@
 verify >nul
 call "../Set Common Environment Variables"
 
-if errorlevel 1 goto error
+if errorlevel 1 goto end
 
 set PATH=%PATH%;%devDir%\Git\bin
 
@@ -24,32 +24,26 @@
 del "%usrLocalDir%\include\x264.h"
 cd "%devDir%"
 
-if "%BuildBits%" == "32" (
-	set sourceFolder=x264
-	set buildFolder=build
-)
-
-if "%BuildBits%" == "64" (
-	set sourceFolder=x264-64
-	set buildFolder=build64
-	set configFlags=--host=x86_64-pc-mingw32
-)
-
+set sourceFolder=x264-%BuildBits%
 rm -r -f %sourceFolder%
+if errorlevel 1 goto end
 
 echo Downloading from git
 git clone git://git.videolan.org/x264.git %sourceFolder%
 if errorlevel 1 goto end
 
 cd "%devDir%/%sourceFolder%"
-sh ./configure --prefix=/usr/local --enable-shared %configFlags%
+
+if "%BuildBits%" == "32" sh ./configure --prefix=%usrLocalDir% --enable-shared
+if "%BuildBits%" == "64" sh ./configure --prefix=%usrLocalDir% --enable-shared --host=x86_64-pc-mingw32
+
 if errorlevel 1 goto end
 
 make install
 if errorlevel 1 goto end
 
-del "%devDir%\avidemux_2.5_%buildFolder%\libx264-*.dll"
-copy "%usrLocalDir%/bin/libx264-*.dll" "%devDir%\avidemux_2.5_%buildFolder%"
+del "%admBuildDir%\libx264-*.dll"
+copy "%usrLocalDir%/bin/libx264-*.dll" "%admBuildDir%"
 
 :end
 pause
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/Perform Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/Perform Build.bat	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/Perform Build.bat	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,79 @@
+ at echo off
+
+echo MSYS build for Xvid
+echo ===================
+echo 1. 32-bit build
+echo 2. 64-bit build
+echo X. Exit
+echo.
+
+choice /c 12x
+
+if errorlevel 1 set BuildBits=32
+if errorlevel 2 set BuildBits=64
+if errorlevel 3 goto :eof
+
+verify >nul
+call "../Set Common Environment Variables"
+if errorlevel 1 goto end
+
+set package=xvidcore-1.2.2.tar.gz
+set sourceFolder=xvidcore-1.2.2-%BuildBits%
+set curDir=%CD%
+
+if not exist %package% (
+	echo.
+	echo Downloading
+	wget http://downloads.xvid.org/downloads/%package%
+)
+
+if errorlevel 1 goto end
+
+echo.
+echo Preparing
+rm -r -f "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+mkdir "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+tar xfz "%package%" -C "%devDir%\%sourceFolder%"
+if errorlevel 1 goto end
+
+cd "%devDir%\%sourceFolder%"
+
+for /f "delims=" %%a in ('dir /b xvidcore') do (
+  move "%CD%\xvidcore\%%a" "%CD%"
+)
+
+echo.
+echo Patching
+patch -p0 -i "%curDir%\configure.patch"
+patch -p0 -i "%curDir%\nasm.inc.patch"
+
+echo.
+echo Configuring
+cd build\generic
+
+if "%BuildBits%" == "32" sh ./configure --prefix="%usrLocalDir%"
+if "%BuildBits%" == "64" sh ./configure --prefix="%usrLocalDir%" --build=x86_64-pc-mingw32
+if errorlevel 1 goto end
+echo.
+pause
+
+make LDFLAGS="%LDFLAGS% -Wl,-s"
+if errorlevel 1 goto end
+
+make install
+if errorlevel 1 goto end
+
+move "%usrLocalDir%\lib\xvidcore.dll" "%usrLocalDir%\bin"
+copy "%usrLocalDir%\bin\xvidcore.dll" "%admBuildDir%"
+copy ".\=build\xvidcore.dll.a" "%usrLocalDir%\lib"
+goto end
+
+:error
+echo Error
+
+:end
+pause
\ No newline at end of file

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/configure.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/configure.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/configure.patch	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,11 @@
+--- build/generic/configure.orig	2009-05-28 18:13:31 +0100
++++ build/generic/configure	2010-11-27 10:25:35 +0000
+@@ -1319,7 +1319,7 @@
+ API_MAJOR="4"
+ API_MINOR="2"
+ 
+-minimum_yasm_minor_version=8
++minimum_yasm_minor_version=1
+ minimum_nasm_minor_version=0
+ minimum_nasm_major_version=2
+ nasm_prog="nasm"

Added: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/nasm.inc.patch
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/nasm.inc.patch	                        (rev 0)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/xvid/nasm.inc.patch	2010-11-28 09:48:11 UTC (rev 6792)
@@ -0,0 +1,16 @@
+--- src/nasm.inc.orig	2009-05-28 16:04:35 +0100
++++ src/nasm.inc	2010-11-27 10:51:04 +0000
+@@ -157,9 +157,10 @@
+ %define XVID_MOVSXD movsx
+ %endif
+ 
+-
+-%ifdef WINDOWS
+-      %define PREFIX
++%ifndef ARCH_IS_X86_64
++      %ifdef WINDOWS
++            %define PREFIX
++      %endif
+ %endif
+ 
+ %ifdef NO_PREFIX



From mean at mail.berlios.de  Sun Nov 28 11:24:06 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 28 Nov 2010 11:24:06 +0100
Subject: [Avidemux-svn-commit] r6793 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src
Message-ID: <20101128102406.78E2C480FC7@sheep.berlios.de>

Author: mean
Date: 2010-11-28 11:24:06 +0100 (Sun, 28 Nov 2010)
New Revision: 6793

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/uiJobs.ui
Log:
[jobs] Use cli/qt4

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-28 09:48:11 UTC (rev 6792)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_runOneJob.cpp	2010-11-28 10:24:06 UTC (rev 6793)
@@ -104,8 +104,18 @@
     // 2- Spawn  child
     string ScriptFullPath;
     ScriptFullPath=string(ADM_getJobDir())+string("/")+string(job.scriptName);
-    if(false==spawnChild("avidemux3_qt4",ScriptFullPath,job.outputFileName))
+#ifdef _WIN32
+    #define MKEXE(x) "avidemux3_"#x".exe"
+#else
+    #define MKEXE(x) "avidemux3_"#x
+#endif
+    const char *avidemuxVersion=MKEXE(cli);
+    if(ui.checkBoxUseQt4->isChecked())
     {
+        avidemuxVersion=MKEXE(qt4);
+    }
+    if(false==spawnChild(avidemuxVersion,ScriptFullPath,job.outputFileName))
+    {
         ADM_error("Cannot spawn child\n");
         r=false;
         goto done;

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/uiJobs.ui
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/uiJobs.ui	2010-11-28 09:48:11 UTC (rev 6792)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/uiJobs.ui	2010-11-28 10:24:06 UTC (rev 6793)
@@ -43,6 +43,16 @@
       </widget>
      </item>
      <item>
+      <widget class="QCheckBox" name="checkBoxUseQt4">
+       <property name="toolTip">
+        <string>If you use VDPAU you cannot use CLI version</string>
+       </property>
+       <property name="text">
+        <string>use QT4 version</string>
+       </property>
+      </widget>
+     </item>
+     <item>
       <spacer name="horizontalSpacer">
        <property name="orientation">
         <enum>Qt::Horizontal</enum>



From mean at mail.berlios.de  Sun Nov 28 11:24:07 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 28 Nov 2010 11:24:07 +0100
Subject: [Avidemux-svn-commit] r6794 -
	branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src
Message-ID: <20101128102407.A1121480FC7@sheep.berlios.de>

Author: mean
Date: 2010-11-28 11:24:07 +0100 (Sun, 28 Nov 2010)
New Revision: 6794

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
Log:
[jobs] Display duration

Modified: branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-28 10:24:06 UTC (rev 6793)
+++ branches/avidemux_2.6_branch_mean/avidemux/qt4/ADM_jobs/src/ADM_jobControl.cpp	2010-11-28 10:24:07 UTC (rev 6794)
@@ -29,7 +29,16 @@
 {
     if(!date) return string("N/A");
     return string(ADM_epochToString(date));
+}
+string duration2String(uint64_t date)
+{
+char tmp[100];
+    if(!date) return string("N/A");
+//    printf("Delta : %d\n",(int)date);
+    sprintf(tmp,"%d s",(int)date);
+    return string(tmp);
 }
+
 /**
     \fn refreshList
 */
@@ -39,20 +48,19 @@
       list->clear();
       listOfJob.clear();
       
-      
-      
-      
 // set titles
      QTableWidgetItem *jb=fromText("Job",255);
      QTableWidgetItem *outputFile=fromText("Output",255);
      QTableWidgetItem *status=fromText("Status",255);
      QTableWidgetItem *start=fromText("Start Time",255);
      QTableWidgetItem *end=fromText("End Time",255);
+     QTableWidgetItem *duration=fromText("Duration",255);
      ui.tableWidget->setHorizontalHeaderItem(0,jb);
      ui.tableWidget->setHorizontalHeaderItem(1,outputFile);
      ui.tableWidget->setHorizontalHeaderItem(2,start);
      ui.tableWidget->setHorizontalHeaderItem(3,end);
-     ui.tableWidget->setHorizontalHeaderItem(4,status);
+     ui.tableWidget->setHorizontalHeaderItem(4,duration);
+     ui.tableWidget->setHorizontalHeaderItem(5,status);
 
 
       if(false==ADM_jobGet(listOfJob)) return ;
@@ -66,8 +74,10 @@
            QTableWidgetItem *nm=fromText(listOfJob[i].jobName,i);
            QTableWidgetItem *out=fromText(listOfJob[i].outputFileName,i);
            string s;
+           string dur="N/A";
            string start="X";
            string end="X";
+           uint64_t timeTaken=0;
             switch(listOfJob[i].status)
             {
                 case ADM_JOB_IDLE:
@@ -80,11 +90,15 @@
                             s=string("Success");
                             start=date2String(listOfJob[i].startTime);
                             end=date2String(listOfJob[i].endTime);
+                            timeTaken=listOfJob[i].endTime-listOfJob[i].startTime;
+                            dur=duration2String(timeTaken);
                             break;
                 case ADM_JOB_KO:
                             s=string("Failed");
                             start=date2String(listOfJob[i].startTime);
                             end=date2String(listOfJob[i].endTime);
+                            timeTaken=listOfJob[i].endTime-listOfJob[i].startTime;
+                            dur=duration2String(timeTaken);
                             break;
                 default:
                             s=string("???");
@@ -93,11 +107,13 @@
         QTableWidgetItem *status=fromText (s,i);
         QTableWidgetItem *startItem=fromText (start,i);
         QTableWidgetItem *endItem=fromText (end,i);
+        QTableWidgetItem *durItem=fromText (dur,i);
         list->setItem(i,0,nm);
         list->setItem(i,1,out);
         list->setItem(i,2,startItem);
         list->setItem(i,3,endItem);
-        list->setItem(i,4,status);
+        list->setItem(i,4,durItem);
+        list->setItem(i,5,status);
       }
       list->resizeColumnsToContents();
 }
@@ -110,7 +126,7 @@
 jobWindow::jobWindow(void) : QDialog()
 {
     ui.setupUi(this);
-    ui.tableWidget->setColumnCount(5); // Job name, fileName, Status
+    ui.tableWidget->setColumnCount(6); // Job name, fileName, Status
 
     // Add some right click menu...
     ui.tableWidget->setContextMenuPolicy(Qt::ActionsContextMenu);



From gruntster at mail.berlios.de  Sun Nov 28 14:54:03 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 28 Nov 2010 14:54:03 +0100
Subject: [Avidemux-svn-commit] r6795 - in
	branches/avidemux_2.5_branch_gruntster/platforms/windows:
	build_scripts/avidemux build_scripts/avidemux/Tools installer
Message-ID: <20101128135403.AEB00480FC7@sheep.berlios.de>

Author: gruntster
Date: 2010-11-28 14:54:03 +0100 (Sun, 28 Nov 2010)
New Revision: 6795

Modified:
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1c. Post-build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2. Create Packages.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2b. Package SDK.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2c. Package Build.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/Build Plugins.bat
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/gennotes.sh
   branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/gentouch.sh
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
   branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/genlog.sh
Log:
[win] update avidemux build scripts and installer

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1c. Post-build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1c. Post-build.bat	2010-11-28 10:24:07 UTC (rev 6794)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/1c. Post-build.bat	2010-11-28 13:54:03 UTC (rev 6795)
@@ -1,98 +1,100 @@
-mkdir "%sdkBuildDir%\lib"
-move "%buildDir%\lib\*.a" "%sdkBuildDir%\lib"
+mkdir "%sdkBuildDir%\lib%BuildBits%"
+move "%buildDir%\lib\*.a" "%sdkBuildDir%\lib%BuildBits%"
 del /s "%buildDir%\*.a"
 
-mkdir "%sdkBuildDir%\plugin-examples"
-cd "%sdkBuildDir%\plugin-examples"
-copy "%curDir%\Tools\Build Plugins.bat" "%sdkBuildDir%\plugin-examples"
+if "%BuildBits%" == "32" (
+	mkdir "%sdkBuildDir%\plugin-examples"
+	cd "%sdkBuildDir%\plugin-examples"
+	copy "%curDir%\Tools\Build Plugins.bat" "%sdkBuildDir%\plugin-examples"
 
-mkdir "audioDecoders"
-mkdir "audioDecoders\ac3"
-xcopy /s "%sourceDir%\plugins\ADM_audioDecoders\ADM_ad_ac3" "audioDecoders\ac3"
+	mkdir "audioDecoders"
+	mkdir "audioDecoders\ac3"
+	xcopy /s "%sourceDir%\plugins\ADM_audioDecoders\ADM_ad_ac3" "audioDecoders\ac3"
 
-mkdir "audioDevices"
-mkdir "audioDevices\win32"
-xcopy /s "%sourceDir%\plugins\ADM_audioDevices\Win32" "audioDevices\win32"
+	mkdir "audioDevices"
+	mkdir "audioDevices\win32"
+	xcopy /s "%sourceDir%\plugins\ADM_audioDevices\Win32" "audioDevices\win32"
 
-mkdir "audioEncoders"
-mkdir "audioEncoders\pcm"
-xcopy /s "%sourceDir%\plugins\ADM_audioEncoders\pcm" "audioEncoders\pcm"
+	mkdir "audioEncoders"
+	mkdir "audioEncoders\pcm"
+	xcopy /s "%sourceDir%\plugins\ADM_audioEncoders\pcm" "audioEncoders\pcm"
 
-mkdir "videoEncoders"
-mkdir "videoEncoders\mpeg2enc"
-mkdir "videoEncoders\mpeg2enc\common"
-xcopy /s "%sourceDir%\plugins\ADM_videoEncoder\ADM_vidEnc_mpeg2enc" "videoEncoders\mpeg2enc"
-xcopy /s "%sourceDir%\plugins\ADM_videoEncoder\common" "videoEncoders\mpeg2enc\common"
-xcopy /s "%msysDir%\local\lib\libxml2.dll.a" "videoEncoders\mpeg2enc"
-xcopy /s "%msysDir%\local\include\libxml2" "videoEncoders\mpeg2enc"
-rmdir /s/q "videoEncoders\mpeg2enc\mpeg2enc\altivec"
+	mkdir "videoEncoders"
+	mkdir "videoEncoders\mpeg2enc"
+	mkdir "videoEncoders\mpeg2enc\common"
+	xcopy /s "%sourceDir%\plugins\ADM_videoEncoder\ADM_vidEnc_mpeg2enc" "videoEncoders\mpeg2enc"
+	xcopy /s "%sourceDir%\plugins\ADM_videoEncoder\common" "videoEncoders\mpeg2enc\common"
+	xcopy /s "%usrLocalDir%\lib\libxml2.dll.a" "videoEncoders\mpeg2enc"
+	xcopy /s "%usrLocalDir%\include\libxml2" "videoEncoders\mpeg2enc"
+	rmdir /s/q "videoEncoders\mpeg2enc\mpeg2enc\altivec"
 
-mkdir "videoFilters"
-mkdir "videoFilters\fade"
-xcopy /s "%sourceDir%\plugins\ADM_videoFilters\Fade" "videoFilters\fade"
+	mkdir "videoFilters"
+	mkdir "videoFilters\fade"
+	xcopy /s "%sourceDir%\plugins\ADM_videoFilters\Fade" "videoFilters\fade"
 
-del /s CMakeLists.txt
+	del /s CMakeLists.txt
 
-mkdir "%sdkBuildDir%\include"
-mkdir "%sdkBuildDir%\include\ADM_encoder"
-mkdir "%sdkBuildDir%\include\libavutil"
-cd "%sdkBuildDir%\include"
+	mkdir "%sdkBuildDir%\include"
+	mkdir "%sdkBuildDir%\include\ADM_encoder"
+	mkdir "%sdkBuildDir%\include\libavutil"
+	cd "%sdkBuildDir%\include"
 
-copy "%sourceDir%\%buildFolder%\config\ADM_coreConfig.h"
-copy "%sourceDir%\%buildFolder%\config\libavutil\avconfig.h" libavutil
-copy "%sourceDir%\avidemux\ADM_audiocodec\ADM_ad_plugin.h"
-copy "%sourceDir%\avidemux\ADM_audiocodec\ADM_audiocodec.h"
-copy "%sourceDir%\avidemux\ADM_audiodevice\ADM_audiodevice.h"
-copy "%sourceDir%\avidemux\ADM_audiodevice\ADM_audioDeviceInternal.h"
-copy "%sourceDir%\avidemux\ADM_core\include\ADM_assert.h"
-copy "%sourceDir%\avidemux\ADM_core\include\ADM_clock.h"
-copy "%sourceDir%\avidemux\ADM_core\include\ADM_cpucap.h"
-copy "%sourceDir%\avidemux\ADM_core\include\ADM_default.h"
-copy "%sourceDir%\avidemux\ADM_core\include\ADM_dynamicLoading.h"
-copy "%sourceDir%\avidemux\ADM_core\include\ADM_files.h"
-copy "%sourceDir%\avidemux\ADM_core\include\ADM_inttype.h"
-copy "%sourceDir%\avidemux\ADM_core\include\ADM_mangle.h"
-copy "%sourceDir%\avidemux\ADM_core\include\ADM_misc.h"
-copy "%sourceDir%\avidemux\ADM_coreAudio\include\ADM_audioCodecEnum.h"
-copy "%sourceDir%\avidemux\ADM_coreAudio\include\ADM_audiodef.h"
-copy "%sourceDir%\avidemux\ADM_coreAudio\include\ADM_audioFilter.h"
-copy "%sourceDir%\avidemux\ADM_coreAudio\include\ADM_coreAudio.h"
-copy "%sourceDir%\avidemux\ADM_coreAudio\include\audioencoder.h"
-copy "%sourceDir%\avidemux\ADM_coreAudio\include\audioencoderInternal.h"
-copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_confCouple.h"
-copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_image.h"
-copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_rgb.h"
-copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_videoFilter.h"
-copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_videoFilterCache.h"
-copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_videoFilterDynamic.h"
-copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_videoFilter_iface.h"
-copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_videoFilter_internal.h"
-copy "%sourceDir%\avidemux\ADM_coreUI\include\DIA_coreToolkit.h"
-copy "%sourceDir%\avidemux\ADM_coreUI\include\DIA_factory.h"
-copy "%sourceDir%\avidemux\ADM_coreUI\include\DIA_uiTypes.h"
-copy "%sourceDir%\avidemux\ADM_encoder\ADM_vidEncode.hxx" ADM_encoder
-copy "%sourceDir%\avidemux\ADM_libraries\ffmpeg\libavutil\pixfmt.h" libavutil
-copy "%sourceDir%\avidemux\ADM_plugin\ADM_vidEnc_plugin.h"
-copy "%sourceDir%\avidemux\ADM_plugin\ADM_plugin_translate.h"
+	copy "%sourceDir%\%buildFolder%\config\ADM_coreConfig.h"
+	copy "%sourceDir%\%buildFolder%\config\libavutil\avconfig.h" libavutil
+	copy "%sourceDir%\avidemux\ADM_audiocodec\ADM_ad_plugin.h"
+	copy "%sourceDir%\avidemux\ADM_audiocodec\ADM_audiocodec.h"
+	copy "%sourceDir%\avidemux\ADM_audiodevice\ADM_audiodevice.h"
+	copy "%sourceDir%\avidemux\ADM_audiodevice\ADM_audioDeviceInternal.h"
+	copy "%sourceDir%\avidemux\ADM_core\include\ADM_assert.h"
+	copy "%sourceDir%\avidemux\ADM_core\include\ADM_clock.h"
+	copy "%sourceDir%\avidemux\ADM_core\include\ADM_cpucap.h"
+	copy "%sourceDir%\avidemux\ADM_core\include\ADM_default.h"
+	copy "%sourceDir%\avidemux\ADM_core\include\ADM_dynamicLoading.h"
+	copy "%sourceDir%\avidemux\ADM_core\include\ADM_files.h"
+	copy "%sourceDir%\avidemux\ADM_core\include\ADM_inttype.h"
+	copy "%sourceDir%\avidemux\ADM_core\include\ADM_mangle.h"
+	copy "%sourceDir%\avidemux\ADM_core\include\ADM_misc.h"
+	copy "%sourceDir%\avidemux\ADM_coreAudio\include\ADM_audioCodecEnum.h"
+	copy "%sourceDir%\avidemux\ADM_coreAudio\include\ADM_audiodef.h"
+	copy "%sourceDir%\avidemux\ADM_coreAudio\include\ADM_audioFilter.h"
+	copy "%sourceDir%\avidemux\ADM_coreAudio\include\ADM_coreAudio.h"
+	copy "%sourceDir%\avidemux\ADM_coreAudio\include\audioencoder.h"
+	copy "%sourceDir%\avidemux\ADM_coreAudio\include\audioencoderInternal.h"
+	copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_confCouple.h"
+	copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_image.h"
+	copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_rgb.h"
+	copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_videoFilter.h"
+	copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_videoFilterCache.h"
+	copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_videoFilterDynamic.h"
+	copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_videoFilter_iface.h"
+	copy "%sourceDir%\avidemux\ADM_coreImage\include\ADM_videoFilter_internal.h"
+	copy "%sourceDir%\avidemux\ADM_coreUI\include\DIA_coreToolkit.h"
+	copy "%sourceDir%\avidemux\ADM_coreUI\include\DIA_factory.h"
+	copy "%sourceDir%\avidemux\ADM_coreUI\include\DIA_uiTypes.h"
+	copy "%sourceDir%\avidemux\ADM_encoder\ADM_vidEncode.hxx" ADM_encoder
+	copy "%sourceDir%\avidemux\ADM_libraries\ffmpeg\libavutil\pixfmt.h" libavutil
+	copy "%sourceDir%\avidemux\ADM_plugin\ADM_vidEnc_plugin.h"
+	copy "%sourceDir%\avidemux\ADM_plugin\ADM_plugin_translate.h"
 
-cd "%sourceDir%\po"
-svn revert -R .
-sh qt_update_pro.sh
-echo ./avidemux_blank.ts >> avidemux.pro
-lupdate avidemux.pro
+	cd "%sourceDir%\po"
+	svn revert -R .
+	sh qt_update_pro.sh
+	echo ./avidemux_blank.ts >> avidemux.pro
+	lupdate avidemux.pro
 
-mkdir "%sdkBuildDir%\i18n"
-mkdir "%sdkBuildDir%\i18n\qt4"
-mkdir "%sdkBuildDir%\i18n\gtk"
+	mkdir "%sdkBuildDir%\i18n"
+	mkdir "%sdkBuildDir%\i18n\qt4"
+	mkdir "%sdkBuildDir%\i18n\gtk"
 
-copy *.ts "%sdkBuildDir%\i18n\qt4"
-copy qt_filter_context.xslt "%sdkBuildDir%\i18n\qt4\qt_filter_context.xsl"
-copy "%curDir%\Tools\Build Qt Translations.bat" "%sdkBuildDir%\i18n\qt4\Build Translations.bat"
+	copy *.ts "%sdkBuildDir%\i18n\qt4"
+	copy qt_filter_context.xslt "%sdkBuildDir%\i18n\qt4\qt_filter_context.xsl"
+	copy "%curDir%\Tools\Build Qt Translations.bat" "%sdkBuildDir%\i18n\qt4\Build Translations.bat"
 
-del avidemux_blank.ts
+	del avidemux_blank.ts
 
-sh update_pot.bash
-copy avidemux.pot "%sdkBuildDir%\i18n\gtk"
-for %%A in (*.po) do msgmerge %%A avidemux.pot -o "%sdkBuildDir%\i18n\gtk\%%A"
+	sh update_pot.bash
+	copy avidemux.pot "%sdkBuildDir%\i18n\gtk"
+	for %%A in (*.po) do msgmerge %%A avidemux.pot -o "%sdkBuildDir%\i18n\gtk\%%A"
 
-svn revert -R .
\ No newline at end of file
+	svn revert -R .
+)
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2. Create Packages.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2. Create Packages.bat	2010-11-28 10:24:07 UTC (rev 6794)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2. Create Packages.bat	2010-11-28 13:54:03 UTC (rev 6795)
@@ -29,8 +29,8 @@
 call "Get Revision Number"
 cd ..
 
-set packageDir=%CD%\%revisionNo%
-mkdir %packageDir%
+set packageDir=%CD%\%revisionNo% [%BuildBits%-bit]
+mkdir "%packageDir%"
 
 cd "%curDir%"
 call "2b. Package SDK.bat"

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2b. Package SDK.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2b. Package SDK.bat	2010-11-28 10:24:07 UTC (rev 6794)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2b. Package SDK.bat	2010-11-28 13:54:03 UTC (rev 6795)
@@ -1,6 +1,19 @@
-set baseFile=avidemux_sdk_2.5_r%revisionNo%_win%BuildBits%
-set zipFile=%baseFile%.zip
+set zipFile=avidemux_sdk_2.5_r%revisionNo%_win.zip
 
-cd "%sdkBuildDir%"
+if "%BuildBits%" == "32" (
+	set sdk32BuildDir=%sdkBuildDir%
+	set sdk64BuildDir=%sdkBuildDir:build32=build64%
+)
+
+if "%BuildBits%" == "64" (
+	set sdk32BuildDir=%sdkBuildDir:build64=build32%
+	set sdk64BuildDir=%sdkBuildDir%
+)
+
+cd "%sdk32BuildDir%"
 zip -r "%packageDir%\%zipFile%" *
+
+cd "%sdk64BuildDir%"
+zip -r "%packageDir%\%zipFile%" *
+
 advzip -z -4 "%packageDir%\%zipFile%"
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2c. Package Build.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2c. Package Build.bat	2010-11-28 10:24:07 UTC (rev 6794)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/2c. Package Build.bat	2010-11-28 13:54:03 UTC (rev 6795)
@@ -2,11 +2,14 @@
 set zipFile=%baseFile%.zip
 
 copy "%buildDir%\Change Log.html" "%packageDir%"
-move "Tools\Package Notes.html" "%packageDir%"
+move "Tools\Package Notes [%BuildBits%].html" "%packageDir%\Package Notes.html"
 
 cd %buildDir%
-echo -- Generating GTK+ Installer --
-"%nsisDir%\makensis" /V2 /NOCD /DINST_GTK /DBUILD_BITS=%BuildBits% /DNSIDIR="%curDir%\..\..\installer" /DEXEDIR="%packageDir%" "%curDir%\..\..\installer\avidemux.nsi"
+if "%BuildBits%" == "32" (
+	echo -- Generating GTK+ Installer --
+	"%nsisDir%\makensis" /V2 /NOCD /DINST_GTK /DBUILD_BITS=%BuildBits% /DNSIDIR="%curDir%\..\..\installer" /DEXEDIR="%packageDir%" "%curDir%\..\..\installer\avidemux.nsi"
+)
+
 echo -- Generating Qt Installer --
 "%nsisDir%\makensis" /V2 /NOCD /DINST_QT /DBUILD_BITS=%BuildBits% /DNSIDIR="%curDir%\..\..\installer" /DEXEDIR="%packageDir%" "%curDir%\..\..\installer\avidemux.nsi"
 

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/Build Plugins.bat
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/Build Plugins.bat	2010-11-28 10:24:07 UTC (rev 6794)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/Build Plugins.bat	2010-11-28 13:54:03 UTC (rev 6795)
@@ -1,17 +1,14 @@
 @echo off
 
-if "%1" == "" (
-	echo Usage: "Build Plugins.bat" [MinGW directory]
-	echo e.g. "Build Plugins.bat" C:\MinGW
-	goto :EOF
-)
+if "%1" == "" goto displayUsage
+if "%2" == "" goto displayUsage
 
 set curDir=%CD%
 set includeDir="%curDir%\..\include"
-set libDir="%curDir%\..\lib"
-set ar="%1\bin\ar"
-set gcc="%1\bin\gcc" -O3 -DNDEBUG
-set gxx="%1\bin\g++" -O3 -DNDEBUG -Wl,-enable-auto-import -Wl,-s
+set libDir="%curDir%\..\lib%1"
+set ar="%2\bin\ar"
+set gcc="%2\bin\gcc" -O3 -DNDEBUG
+set gxx="%2\bin\g++" -O3 -DNDEBUG -Wl,-enable-auto-import -Wl,-s
 
 echo ** AC-3 Audio Decoder **
 
@@ -52,4 +49,11 @@
 
 cd videoFilters\fade
 %gxx% -shared *.cpp -o libADM_vf_fade.dll -I%includeDir% -L%libDir% -lADM_coreImage.dll -lADM_core.dll -lADM_coreUI.dll
-cd %curDir%
\ No newline at end of file
+cd %curDir%
+
+goto :EOF
+
+:displayUsage
+	echo Usage: "Build Plugins.bat" [Bitness] [MinGW directory]
+	echo e.g. "Build Plugins.bat" 32 C:\MinGW
+	goto :EOF
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/gennotes.sh
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/gennotes.sh	2010-11-28 10:24:07 UTC (rev 6794)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/gennotes.sh	2010-11-28 13:54:03 UTC (rev 6795)
@@ -1 +1 @@
-xsltproc package_notes.xslt "../Package Notes.xml" > "Package Notes.html"
\ No newline at end of file
+xsltproc package_notes.xslt "../Package Notes.xml" > "Package Notes [$BUILDBITS].html"
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/gentouch.sh
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/gentouch.sh	2010-11-28 10:24:07 UTC (rev 6794)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/build_scripts/avidemux/Tools/gentouch.sh	2010-11-28 13:54:03 UTC (rev 6795)
@@ -1 +1 @@
-xsltproc touch_files.xslt "../Package Notes.xml" > "../Touch 2.5 Files.html"
\ No newline at end of file
+xsltproc touch_files.xslt "../Package Notes.xml" > "../Touch 2.5 Files [$BUILDBITS].html"
\ No newline at end of file

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2010-11-28 10:24:07 UTC (rev 6794)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/avidemux.nsi	2010-11-28 13:54:03 UTC (rev 6795)
@@ -15,17 +15,21 @@
 ##########################
 # Defines
 ##########################
-!define DISPLAYNAME "Avidemux 2.5"
 
+!define PRODUCT_VERSION "2.5.4.${REVISION}"
+!define PRODUCT_NAME "Avidemux 2.5"
+!define PRODUCT_FULLNAME "Avidemux ${PRODUCT_VERSION} (${BUILD_BITS}-bit beta)"
+
 !if ${BUILD_BITS} == 64
-!define INTERNALNAME "Avidemux 2.5 (64-bit)"
+	!define SHORTCUT_NAME "${PRODUCT_NAME}"
+	!define REG_GROUPNAME "${PRODUCT_NAME} (${BUILD_BITS}-bit)"
 !else
-!define INTERNALNAME "Avidemux 2.5"
+	!define SHORTCUT_NAME "${PRODUCT_NAME} (${BUILD_BITS}-bit)"
+	!define REG_GROUPNAME "${PRODUCT_NAME}"
 !endif
 
-!define REGKEY "SOFTWARE\${INTERNALNAME}"
-!define UNINST_REGKEY "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${INTERNALNAME}"
-!define VERSION 2.5.3.${REVISION}
+!define REGKEY "SOFTWARE\${REG_GROUPNAME}"
+!define UNINST_REGKEY "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${REG_GROUPNAME}"
 !define COMPANY "Free Software Foundation"
 !define URL "http://www.avidemux.org"
 
@@ -43,14 +47,14 @@
 !endif
 
 !ifdef INST_BOTH
-OutFile ${EXEDIR}\avidemux_2.5_r${REVISION}_full_win${BUILD_BITS}.exe
-Name "Avidemux 2.5.3 Full beta r${REVISION}"
+OutFile "${EXEDIR}\avidemux_2.5_r${REVISION}_full_win${BUILD_BITS}.exe"
+Name "${PRODUCT_FULLNAME} Full"
 !else ifdef INST_QT
-OutFile ${EXEDIR}\avidemux_2.5_r${REVISION}_win${BUILD_BITS}.exe
-Name "Avidemux 2.5.3 beta r${REVISION}"
+OutFile "${EXEDIR}\avidemux_2.5_r${REVISION}_win${BUILD_BITS}.exe"
+Name "${PRODUCT_FULLNAME}"
 !else ifdef INST_GTK
-OutFile ${EXEDIR}\avidemux_2.5_r${REVISION}_gtk_win${BUILD_BITS}.exe
-Name "Avidemux 2.5.3 GTK+ beta r${REVISION}"
+OutFile "${EXEDIR}\avidemux_2.5_r${REVISION}_gtk_win${BUILD_BITS}.exe"
+Name "${PRODUCT_FULLNAME} GTK+"
 !endif
 
 ##########################
@@ -98,6 +102,7 @@
 ##########################
 # Installer pages
 ##########################
+!define MUI_WELCOMEPAGE_TITLE "${PRODUCT_FULLNAME} Setup Wizard"
 !insertmacro MUI_PAGE_WELCOME
 !insertmacro MUI_PAGE_LICENSE "${NSIDIR}\License.rtf"
  Page custom ReinstallPage ReinstallPageLeave
@@ -115,7 +120,7 @@
 !insertmacro MUI_PAGE_INSTFILES
 !define MUI_FINISHPAGE_RUN
 !define MUI_FINISHPAGE_RUN_FUNCTION RunAvidemux
-!define MUI_FINISHPAGE_RUN_TEXT "Run ${DISPLAYNAME} now"
+!define MUI_FINISHPAGE_RUN_TEXT "Run ${PRODUCT_NAME} now"
 !define MUI_FINISHPAGE_SHOWREADME "$INSTDIR\Change Log.html"
 !define MUI_FINISHPAGE_SHOWREADME_TEXT "View Change Log now"
 !define MUI_FINISHPAGE_LINK "Visit the Avidemux Builds for Windows website"
@@ -137,14 +142,19 @@
 ##########################
 # Installer attributes
 ##########################
-InstallDir "$PROGRAMFILES\${DISPLAYNAME}"
+!if ${BUILD_BITS} == 64
+	InstallDir "$PROGRAMFILES64\${PRODUCT_NAME}"
+!else
+	InstallDir "$PROGRAMFILES\${PRODUCT_NAME}"
+!endif
+
 CRCCheck on
 XPStyle on
 ShowInstDetails nevershow
 ShowUninstDetails nevershow
-VIProductVersion 2.5.3.${REVISION}
+VIProductVersion ${PRODUCT_VERSION}
 VIAddVersionKey ProductName Avidemux
-VIAddVersionKey ProductVersion "${VERSION} (beta)"
+VIAddVersionKey ProductVersion "${PRODUCT_VERSION}"
 VIAddVersionKey FileVersion ""
 VIAddVersionKey FileDescription ""
 VIAddVersionKey LegalCopyright ""
@@ -271,26 +281,25 @@
     ${File} "Change Log.html"
     ${File} zlib1.dll
     ${File} libstdc++*.dll
-    
+
 !if ${BUILD_BITS} == 32
     ${File} freetype6.dll
-    ${File} libnspr4.dll
+	${File} pthreadGC2-w32.dll
 !endif
 
 !if ${BUILD_BITS} == 64
     ${File} libfreetype-6.dll
+	${File} pthreadGC2-w64.dll
 !endif
 
     ${File} libgcc_s_sjlj-1.dll
-    ${File} libogg-0.dll
+	${File} nspr4.dll
     ${File} libjs.dll
     ${File} libADM_core.dll
     ${File} libADM_coreAudio.dll
     ${File} libADM_coreImage.dll
     ${File} libADM_coreUI.dll
-    ${File} libaften.dll
     ${File} libxml2-*.dll
-    ${File} pthreadGC2.dll
     ${File} AUTHORS.
     ${File} COPYING.
     ${File} README.
@@ -396,6 +405,9 @@
 			SetOverwrite on
 			SetOutPath $INSTDIR\plugins\audioDecoder
 			${File} plugins\audioDecoder\libADM_ad_vorbis.dll
+			SetOutPath $INSTDIR
+			${File} libogg-0.dll
+			${File} libvorbis-0.dll
 		${MementoSectionEnd}
 		${MementoSection} "MAD (MPEG)" SecAudDecMad
 			SectionIn 1 2
@@ -435,7 +447,7 @@
 			SetOutPath $INSTDIR\plugins\audioEncoders
 			${File} plugins\audioEncoders\libADM_ae_aften.dll
 			SetOutPath $INSTDIR
-			${File} libaften.dll
+			${File} aften.dll
 		${MementoSectionEnd}
 		${MementoSection} "FAAC (AAC)" SecAudEncFaac
 			SectionIn 1 2
@@ -471,6 +483,7 @@
 			SetOutPath $INSTDIR\plugins\audioEncoders
 			${File} plugins\audioEncoders\libADM_ae_vorbis.dll
 			SetOutPath $INSTDIR
+			${File} libogg-0.dll
 			${File} libvorbis-0.dll
 			${File} libvorbisenc-2.dll
 		${MementoSectionEnd}
@@ -1321,7 +1334,7 @@
     CreateDirectory $SMPROGRAMS\$StartMenuGroup
     !insertmacro MUI_STARTMENU_WRITE_BEGIN Application
     SetOutPath $INSTDIR
-    CreateShortcut "$SMPROGRAMS\$StartMenuGroup\${DISPLAYNAME} GTK+.lnk" $INSTDIR\avidemux2_gtk.exe
+    CreateShortcut "$SMPROGRAMS\$StartMenuGroup\${SHORTCUT_NAME} GTK+.lnk" $INSTDIR\avidemux2_gtk.exe
     !insertmacro MUI_STARTMENU_WRITE_END
 !endif
 ${MementoSectionEnd}
@@ -1331,7 +1344,7 @@
     CreateDirectory $SMPROGRAMS\$StartMenuGroup
     !insertmacro MUI_STARTMENU_WRITE_BEGIN Application
     SetOutPath $INSTDIR
-    CreateShortcut "$SMPROGRAMS\$StartMenuGroup\${DISPLAYNAME}.lnk" $INSTDIR\avidemux2.exe
+    CreateShortcut "$SMPROGRAMS\$StartMenuGroup\${SHORTCUT_NAME}.lnk" $INSTDIR\avidemux2.exe
     !insertmacro MUI_STARTMENU_WRITE_END
 !endif
 ${MementoSectionEnd}
@@ -1347,28 +1360,28 @@
 ${MementoSection} "-Quick Launch GTK+" SecQuickLaunchGtk
 !ifdef INST_GTK
     SetOutPath $INSTDIR
-    CreateShortcut "$QUICKLAUNCH\${DISPLAYNAME} GTK+.lnk" $INSTDIR\avidemux2_gtk.exe
+    CreateShortcut "$QUICKLAUNCH\${SHORTCUT_NAME} GTK+.lnk" $INSTDIR\avidemux2_gtk.exe
 !endif
 ${MementoSectionEnd}
 
 ${MementoSection} "-Quick Launch Qt" SecQuickLaunchQt
 !ifdef INST_QT
     SetOutPath $INSTDIR
-    CreateShortcut "$QUICKLAUNCH\${DISPLAYNAME}.lnk" $INSTDIR\avidemux2.exe
+    CreateShortcut "$QUICKLAUNCH\${SHORTCUT_NAME}.lnk" $INSTDIR\avidemux2.exe
 !endif
 ${MementoSectionEnd}
 
 ${MementoSection} "-Desktop GTK+" SecDesktopGtk
 !ifdef INST_GTK
     SetOutPath $INSTDIR
-    CreateShortcut "$DESKTOP\${DISPLAYNAME} GTK+.lnk" $INSTDIR\avidemux2_gtk.exe
+    CreateShortcut "$DESKTOP\${SHORTCUT_NAME} GTK+.lnk" $INSTDIR\avidemux2_gtk.exe
 !endif
 ${MementoSectionEnd}
 
 ${MementoSection} "-Desktop Qt" SecDesktopQt
 !ifdef INST_QT
     SetOutPath $INSTDIR
-    CreateShortcut "$DESKTOP\${DISPLAYNAME}.lnk" $INSTDIR\avidemux2.exe
+    CreateShortcut "$DESKTOP\${SHORTCUT_NAME}.lnk" $INSTDIR\avidemux2.exe
 !endif
 ${MementoSectionEnd}
 
@@ -1377,11 +1390,11 @@
 Section -post SecUninstaller
     SectionIn 1 2
     WriteRegStr HKLM "${REGKEY}" Path $INSTDIR
-    WriteRegStr HKLM "${REGKEY}" Version ${VERSION}
+    WriteRegStr HKLM "${REGKEY}" Version ${PRODUCT_VERSION}
     SetOutPath $INSTDIR
     WriteUninstaller $INSTDIR\uninstall.exe
-    WriteRegStr HKLM "${UNINST_REGKEY}" DisplayName "${DISPLAYNAME}"
-    WriteRegStr HKLM "${UNINST_REGKEY}" DisplayVersion "${VERSION}"
+    WriteRegStr HKLM "${UNINST_REGKEY}" DisplayName "${SHORTCUT_NAME}"
+    WriteRegStr HKLM "${UNINST_REGKEY}" DisplayVersion "${PRODUCT_VERSION}"
     WriteRegStr HKLM "${UNINST_REGKEY}" DisplayIcon $INSTDIR\uninstall.exe
     WriteRegStr HKLM "${UNINST_REGKEY}" UninstallString $INSTDIR\uninstall.exe
     WriteRegDWORD HKLM "${UNINST_REGKEY}" NoModify 1
@@ -1397,15 +1410,15 @@
 	!insertmacro MUI_STARTMENU_GETFOLDER Application $StartMenuGroup	
 
 !ifdef INST_GTK
-	Delete /REBOOTOK "$QUICKLAUNCH\${DISPLAYNAME} GTK+.lnk"
-    Delete /REBOOTOK "$DESKTOP\${DISPLAYNAME} GTK+.lnk"
-    Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\${DISPLAYNAME} GTK+.lnk"
+	Delete /REBOOTOK "$QUICKLAUNCH\${SHORTCUT_NAME} GTK+.lnk"
+    Delete /REBOOTOK "$DESKTOP\${SHORTCUT_NAME} GTK+.lnk"
+    Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\${SHORTCUT_NAME} GTK+.lnk"
 !endif
 
 !ifdef INST_QT
-    Delete /REBOOTOK "$QUICKLAUNCH\${DISPLAYNAME}.lnk"
-    Delete /REBOOTOK "$DESKTOP\${DISPLAYNAME}.lnk"
-    Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\${DISPLAYNAME}.lnk"
+    Delete /REBOOTOK "$QUICKLAUNCH\${SHORTCUT_NAME}.lnk"
+    Delete /REBOOTOK "$DESKTOP\${SHORTCUT_NAME}.lnk"
+    Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\${SHORTCUT_NAME}.lnk"
 !endif
 
 	Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\Change Log.lnk"
@@ -1445,7 +1458,7 @@
 	ReadRegStr $PreviousVersion HKLM "${REGKEY}" Version
 
 	${If} $PreviousVersion != ""
-		${VersionCompare} ${VERSION} $PreviousVersion $PreviousVersionState
+		${VersionCompare} ${PRODUCT_VERSION} $PreviousVersion $PreviousVersionState
 	${EndIf}
 	
     InitPluginsDir
@@ -1733,7 +1746,7 @@
 	Pop $0
 
 	${If} $PreviousVersionState == 1
-		!insertmacro MUI_HEADER_TEXT "Already Installed" "Choose how you want to install ${DISPLAYNAME}."
+		!insertmacro MUI_HEADER_TEXT "Already Installed" "Choose how you want to install ${PRODUCT_FULLNAME}."
 		nsDialogs::CreateItem /NOUNLOAD STATIC ${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS} 0 0 0 100% 40 "An older version of Avidemux is installed on your system.  Select the operation you want to perform and click Next to continue."
 		Pop $R0
 		nsDialogs::CreateItem /NOUNLOAD BUTTON ${BS_AUTORADIOBUTTON}|${BS_VCENTER}|${BS_MULTILINE}|${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS}|${WS_GROUP}|${WS_TABSTOP} 0 10 55 100% 30 "Upgrade Avidemux using previous settings (recommended)"
@@ -1745,7 +1758,7 @@
 			StrCpy $ReinstallUninstall 1
 		${EndIf}
 	${ElseIf} $PreviousVersionState == 2
-		!insertmacro MUI_HEADER_TEXT "Already Installed" "Choose how you want to install ${DISPLAYNAME}."
+		!insertmacro MUI_HEADER_TEXT "Already Installed" "Choose how you want to install ${PRODUCT_FULLNAME}."
 		nsDialogs::CreateItem /NOUNLOAD STATIC ${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS} 0 0 0 100% 40 "A newer version of Avidemux is already installed! It is not recommended that you downgrade to an older version. Select the operation you want to perform and click Next to continue."
 		Pop $R0
 		nsDialogs::CreateItem /NOUNLOAD BUTTON ${BS_AUTORADIOBUTTON}|${BS_VCENTER}|${BS_MULTILINE}|${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS}|${WS_GROUP}|${WS_TABSTOP} 0 10 55 100% 30 "Downgrade Avidemux using previous settings (recommended)"
@@ -1758,7 +1771,7 @@
 		${EndIf}
 	${ElseIf} $PreviousVersionState == 0
 		!insertmacro MUI_HEADER_TEXT "Already Installed" "Choose the maintenance option to perform."
-		nsDialogs::CreateItem /NOUNLOAD STATIC ${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS} 0 0 0 100% 40 "Avidemux ${VERSION} is already installed. Select the operation you want to perform and click Next to continue."
+		nsDialogs::CreateItem /NOUNLOAD STATIC ${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS} 0 0 0 100% 40 "${PRODUCT_FULLNAME} is already installed. Select the operation you want to perform and click Next to continue."
 		Pop $R0
 		nsDialogs::CreateItem /NOUNLOAD BUTTON ${BS_AUTORADIOBUTTON}|${BS_VCENTER}|${BS_MULTILINE}|${WS_VISIBLE}|${WS_CHILD}|${WS_CLIPSIBLINGS}|${WS_GROUP}|${WS_TABSTOP} 0 10 55 100% 30 "Add/Remove/Reinstall components"
 		Pop $R0

Modified: branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/genlog.sh
===================================================================
--- branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/genlog.sh	2010-11-28 10:24:07 UTC (rev 6794)
+++ branches/avidemux_2.5_branch_gruntster/platforms/windows/installer/genlog.sh	2010-11-28 13:54:03 UTC (rev 6795)
@@ -1,4 +1,4 @@
-svn log --stop-on-copy --xml $SOURCEDIR > svn.xml
-xsltproc svnlog.xslt svn.xml > "$BUILDDIR/Change Log.html"
-xsltproc revision.xslt svn.xml > revision.nsh
-rm svn.xml
+svn log --stop-on-copy --xml $SOURCEDIR > "svn [$BUILDBITS].xml"
+xsltproc svnlog.xslt "svn [$BUILDBITS].xml" > "$BUILDDIR/Change Log.html"
+xsltproc revision.xslt "svn [$BUILDBITS].xml" > revision.nsh
+rm "svn [$BUILDBITS].xml"



From gruntster at mail.berlios.de  Sun Nov 28 16:03:07 2010
From: gruntster at mail.berlios.de (gruntster at mail.berlios.de)
Date: Sun, 28 Nov 2010 16:03:07 +0100
Subject: [Avidemux-svn-commit] r6796 - branches/avidemux_2.5_branch_gruntster
Message-ID: <20101128150308.1F224480FC7@sheep.berlios.de>

Author: gruntster
Date: 2010-11-28 16:03:07 +0100 (Sun, 28 Nov 2010)
New Revision: 6796

Modified:
   branches/avidemux_2.5_branch_gruntster/CMakeLists.txt
Log:
[build] bump version

Modified: branches/avidemux_2.5_branch_gruntster/CMakeLists.txt
===================================================================
--- branches/avidemux_2.5_branch_gruntster/CMakeLists.txt	2010-11-28 13:54:03 UTC (rev 6795)
+++ branches/avidemux_2.5_branch_gruntster/CMakeLists.txt	2010-11-28 15:03:07 UTC (rev 6796)
@@ -97,7 +97,7 @@
 ########################################
 # Standard Avidemux defines
 ########################################
-SET(VERSION 2.5.3)
+SET(VERSION 2.5.4)
 
 # Define internal flags for GTK+ and Qt4 builds.  These are turned off
 # if a showstopper is found.  CLI is automatically assumed as possible
@@ -211,5 +211,5 @@
 ########################################
 INCLUDE(admConfigSummary)
 MESSAGE("")
-
+
 ADD_SUBDIRECTORY(addons/avsfilter)



From mean at mail.berlios.de  Sun Nov 28 17:50:14 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Sun, 28 Nov 2010 17:50:14 +0100
Subject: [Avidemux-svn-commit] r6797 -
	branches/avidemux_2.6_branch_mean/avidemux/common
Message-ID: <20101128165014.A0F58480FC7@sheep.berlios.de>

Author: mean
Date: 2010-11-28 17:50:14 +0100 (Sun, 28 Nov 2010)
New Revision: 6797

Modified:
   branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
Log:
[editor] Dont set project name to null after a reset/edit

Modified: branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-11-28 15:03:07 UTC (rev 6796)
+++ branches/avidemux_2.6_branch_mean/avidemux/common/gtk_gui.cpp	2010-11-28 16:50:14 UTC (rev 6797)
@@ -391,7 +391,7 @@
       		ReSync ();
 
             // forget last project file
-            video_body->setProjectName(NULL);
+            video_body->setProjectName("");
         }
 	break;
 



From mean at mail.berlios.de  Mon Nov 29 21:14:11 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Mon, 29 Nov 2010 21:14:11 +0100
Subject: [Avidemux-svn-commit] r6798 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src
Message-ID: <20101129201411.6689A480034@sheep.berlios.de>

Author: mean
Date: 2010-11-29 21:14:11 +0100 (Mon, 29 Nov 2010)
New Revision: 6798

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
Log:
[coreSocket] Win32 fix

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-28 16:50:14 UTC (rev 6797)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-29 20:14:11 UTC (rev 6798)
@@ -48,6 +48,7 @@
         #define SNET     AF_INET
         #define SPROTO   IPPROTO_TCP
         #define SCLOSE   SD_BOTH
+        #define SSOCKLEN int
 #else
         #define SADDR struct    sockaddr
         #define SADDR_IN struct sockaddr_in    
@@ -55,6 +56,7 @@
         #define SNET            PF_INET
         #define SPROTO          0
         #define SCLOSE          SHUT_RDWR
+        #define SSOCKLEN        socklen_t
 #endif
 
 
@@ -182,7 +184,7 @@
 		return false;
   }
    // Get port 
-    socklen_t len=sizeof( service);
+    SSOCKLEN len=sizeof( service);
     if ( getsockname ( mySocket, (SADDR *)& service, &len ) < 0 ) 
     {
         ADM_error("Getsockname failed\n");



From mean at mail.berlios.de  Tue Nov 30 07:24:07 2010
From: mean at mail.berlios.de (mean at mail.berlios.de)
Date: Tue, 30 Nov 2010 07:24:07 +0100
Subject: [Avidemux-svn-commit] r6799 -
	branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src
Message-ID: <20101130062408.0045C480149@sheep.berlios.de>

Author: mean
Date: 2010-11-30 07:24:07 +0100 (Tue, 30 Nov 2010)
New Revision: 6799

Modified:
   branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
Log:
[socket] win32

Modified: branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp
===================================================================
--- branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-29 20:14:11 UTC (rev 6798)
+++ branches/avidemux_2.6_branch_mean/avidemux_core/ADM_coreSocket/src/ADM_coreSocket.cpp	2010-11-30 06:24:07 UTC (rev 6799)
@@ -43,7 +43,7 @@
 
 #ifdef __MINGW32__
         #define SADDR    SOCKADDR
-        #define SADDR_IN SOCKADDR
+        #define SADDR_IN struct sockaddr_in
         #define SERROR   SOCKET_ERROR
         #define SNET     AF_INET
         #define SPROTO   IPPROTO_TCP



