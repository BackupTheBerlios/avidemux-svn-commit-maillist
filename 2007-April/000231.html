<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Avidemux-svn-commit] r2913 - in	branches/avidemux_2.4_branch/avidemux: .	ADM_libraries/ADM_lavcodec/i386	ADM_userInterfaces/ADM_commonUI ADM_video
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/avidemux-svn-commit/2007-April/index.html" >
   <LINK REL="made" HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r2913%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%20.%0A%09ADM_libraries/ADM_lavcodec/i386%0A%09ADM_userInterfaces/ADM_commonUI%20ADM_video&In-Reply-To=%3C200704011418.l31EIAJC032733%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000232.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Avidemux-svn-commit] r2913 - in	branches/avidemux_2.4_branch/avidemux: .	ADM_libraries/ADM_lavcodec/i386	ADM_userInterfaces/ADM_commonUI ADM_video</H1>
    <B>mean at BerliOS</B> 
    <A HREF="mailto:avidemux-svn-commit%40lists.berlios.de?Subject=Re%3A%20%5BAvidemux-svn-commit%5D%20r2913%20-%20in%0A%09branches/avidemux_2.4_branch/avidemux%3A%20.%0A%09ADM_libraries/ADM_lavcodec/i386%0A%09ADM_userInterfaces/ADM_commonUI%20ADM_video&In-Reply-To=%3C200704011418.l31EIAJC032733%40sheep.berlios.de%3E"
       TITLE="[Avidemux-svn-commit] r2913 - in	branches/avidemux_2.4_branch/avidemux: .	ADM_libraries/ADM_lavcodec/i386	ADM_userInterfaces/ADM_commonUI ADM_video">mean at mail.berlios.de
       </A><BR>
    <I>Sun Apr  1 16:18:10 CEST 2007</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000232.html">[Avidemux-svn-commit] r2914 -	branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/i386
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#231">[ date ]</a>
              <a href="thread.html#231">[ thread ]</a>
              <a href="subject.html#231">[ subject ]</a>
              <a href="author.html#231">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mean
Date: 2007-04-01 16:18:09 +0200 (Sun, 01 Apr 2007)
New Revision: 2913

Modified:
   branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/i386/cputest.c
   branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_accelRender.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.h
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.cpp
   branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.h
   branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidAnimated.cpp
   branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
   branches/avidemux_2.4_branch/avidemux/gtkgui.h
   branches/avidemux_2.4_branch/avidemux/gui_navigate.cpp
   branches/avidemux_2.4_branch/avidemux/guiplay.cpp
Log:
use hw zoom if possible, uncomplete

Modified: branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/i386/cputest.c
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/i386/cputest.c	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/i386/cputest.c	2007-04-01 14:18:09 UTC (rev 2913)
@@ -81,6 +81,7 @@
         cpuid(1, eax, ebx, ecx, std_caps);
         if (std_caps &amp; (1&lt;&lt;23))
             rval |= MM_MMX;
+#if 0	    
         if (std_caps &amp; (1&lt;&lt;25))
             rval |= MM_MMXEXT | MM_SSE;
         if (std_caps &amp; (1&lt;&lt;26))
@@ -89,6 +90,7 @@
             rval |= MM_SSE3;
         if (ecx &amp; 0x00000200 )
             rval |= MM_SSSE3;
+#endif	    
     }
 
     cpuid(0x80000000, max_ext_level, ebx, ecx, edx);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/ADM_preview.cpp	2007-04-01 14:18:09 UTC (rev 2913)
@@ -62,17 +62,56 @@
 static void previewBlit(ADMImage *from,ADMImage *to,uint32_t startx,uint32_t starty);
 
 static   AVDMGenericVideoStream *preview=NULL;
-static ADMImage *previewImage;
+
 static ADM_PREVIEW_MODE previewMode=ADM_PREVIEW_NONE;
-static uint32_t _mainW=0,_mainH=0;
-static uint32_t _displayW=0,_displayH=0;
-static uint32_t defered_display=0;
-static renderZoom zoom=ZOOM_1_1;
+
+static uint32_t             defered_display=0;  /* When 1, it means we are in playback mode */
+static uint32_t             playbackOffset=0;   /* in playback mode, frame 0 = playbackOffset compared to real beginning of the file */
+static renderZoom           zoom=ZOOM_1_1;
 static ADMImage             *resized=NULL;
 static ADM_MplayerResize    *resizer=NULL;
 static ADMImage             *original=NULL;
-static uint32_t _resizedW=0,_resizedH=0;
+
+/*************************************/
+static ADMImage *rdrImage=NULL; /* Unprocessed image */
+static ADMImage *previewImage;  /* Processed image if any */
+
+static uint32_t  rdrPhysicalW=0;  /* W*H of the INPUT window */
+static uint32_t  rdrPhysicalH=0;
+
+static uint32_t  rdrWindowWUnzoomed=0;  /* W*H of the output window WITHOUT zoom */
+static uint32_t  rdrWindowHUnzoomed=0;
+
+static uint32_t  rdrWindowWZoomed=0;    /* Same but with zoom */
+static uint32_t  rdrWindowHZoomed=0;
+
+static uint32_t  rdrHwZoom=0;           /* Hw can do zoom */
+/*************************************/
+extern ADM_Composer *video_body;
+
 /**
+      \fn admPreview::setMainDimension
+      \brief Update width &amp; height of input video
+      @param w : width
+      @param h : height
+*/
+
+void admPreview::setMainDimension(uint32_t w, uint32_t h)
+{
+  if(rdrImage) delete rdrImage;
+  rdrImage=new ADMImage(w,h);
+  rdrPhysicalW=w;
+  rdrPhysicalH=h;
+  
+  rdrWindowWUnzoomed=w;
+  rdrWindowHUnzoomed=h;
+  
+  renderResize(w,h,w,h);
+  
+}
+
+
+/**
       \fn getPreviewMode
       \brief returns current preview mode
       @return current preview mode
@@ -109,18 +148,20 @@
       \brief Enable or disable defered display
 
 */
-void admPreview::deferDisplay(uint32_t onoff)
+void admPreview::deferDisplay(uint32_t onoff,uint32_t startat)
 {
       
       if(onoff)
       {
         renderStartPlaying();
         defered_display=1;
+        playbackOffset=startat;
       }
       else
       {
         renderStopPlaying();
         defered_display=0;
+        playbackOffset=0;
       }
   
 }
@@ -150,27 +191,27 @@
                   /* no break here, not a mistake */
               case  ADM_PREVIEW_NONE:
               
-                  _displayW=_mainW;
-                  _displayH=_mainH;
+                  rdrWindowWUnzoomed=rdrPhysicalW;
+                  rdrWindowHUnzoomed=rdrPhysicalH;
                   break;
               case  ADM_PREVIEW_OUTPUT:
-                  _displayW=preview-&gt;getInfo()-&gt;width;
-                  _displayH=preview-&gt;getInfo()-&gt;height;
+                  rdrWindowWUnzoomed=preview-&gt;getInfo()-&gt;width;
+                  rdrWindowHUnzoomed=preview-&gt;getInfo()-&gt;height;
                   break;
               case  ADM_PREVIEW_SIDE:
               {
                   
-                  _displayH=MAX(_mainH,preview-&gt;getInfo()-&gt;height);
-                  _displayW=_mainW+preview-&gt;getInfo()-&gt;width;
-                  original=new ADMImage(_displayW,_displayH);
+                  rdrWindowHUnzoomed=MAX(rdrPhysicalH,preview-&gt;getInfo()-&gt;height);
+                  rdrWindowWUnzoomed=rdrPhysicalW+preview-&gt;getInfo()-&gt;width;
+                  original=new ADMImage(rdrWindowWUnzoomed,rdrWindowHUnzoomed);
                   break;
               }
               case  ADM_PREVIEW_TOP:
               {
                   
-                  _displayW=MAX(_mainW,preview-&gt;getInfo()-&gt;width);
-                  _displayH=_mainH+preview-&gt;getInfo()-&gt;height;
-                  original=new ADMImage(_displayW,_displayH);
+                  rdrWindowWUnzoomed=MAX(rdrPhysicalW,preview-&gt;getInfo()-&gt;width);
+                  rdrWindowHUnzoomed=rdrPhysicalH+preview-&gt;getInfo()-&gt;height;
+                  original=new ADMImage(rdrWindowWUnzoomed,rdrWindowHUnzoomed);
                   break;
               }
               default: ADM_assert(0);
@@ -188,19 +229,21 @@
                     default : ADM_assert(0);
     
             }
-            _resizedW=(_displayW*mul+3)/4;
-            _resizedH=(_displayH*mul+3)/4;
+            rdrWindowWZoomed=(rdrWindowWUnzoomed*mul+3)/4;
+            rdrWindowHZoomed=(rdrWindowHUnzoomed*mul+3)/4;
+            
     
-            if(_resizedW&amp;1) _resizedW++;
-            if(_resizedH&amp;1) _resizedH++;
+            if(rdrWindowWZoomed&amp;1) rdrWindowWZoomed++;
+            if(rdrWindowHZoomed&amp;1) rdrWindowHZoomed++;
             ADM_assert(!resized);
-            resized=new ADMImage(_resizedW,_resizedH);
+            resized=new ADMImage(rdrWindowWZoomed,rdrWindowHZoomed);
             ADM_assert(!resizer);
-            resizer=new  ADM_MplayerResize(_displayW,_displayH,_resizedW,_resizedH);
-            renderResize(_resizedW,_resizedH);
+            resizer=new  ADM_MplayerResize(rdrWindowWUnzoomed,rdrWindowHUnzoomed,rdrWindowWZoomed,rdrWindowHZoomed);
+            renderResize(rdrWindowWZoomed,rdrWindowHZoomed,rdrWindowWUnzoomed,rdrWindowHUnzoomed);
         }else
         {
-             renderResize(_displayW,_displayH);
+             renderResize(rdrWindowWUnzoomed,rdrWindowHUnzoomed,rdrWindowWUnzoomed,rdrWindowHUnzoomed);
+             rdrHwZoom=0;
         }
 }
 /**
@@ -217,7 +260,7 @@
         ADM_assert(original);
         original=NULL; 
       }
-      renderResize(_mainW,_mainH);
+      renderResize(rdrWindowWUnzoomed,rdrWindowHUnzoomed,rdrWindowWUnzoomed,rdrWindowHUnzoomed);
       if(previewImage)
       {
         delete  previewImage; 
@@ -271,80 +314,74 @@
 }
 
 /**
-      \fn admPreview::setMainDimension
-      \brief Update width &amp; height of input video
-      @param w : width
-      @param h : height
-*/
-
-void admPreview::setMainDimension(uint32_t w, uint32_t h)
-{
-  _mainW=w;
-  _mainH=h;
-  _displayW=w;
-  _displayH=h;
-  renderResize(w,h);
-  
-}
-/**
       \fn admPreview::update
       \brief display data associated with framenum image
       @param image : current main image (input)
       @param framenum, framenumber
 */
 
-void admPreview::update(uint32_t framenum,ADMImage *image)
+uint8_t admPreview::update(uint32_t framenum)
 {
-    uint32_t fl,len;	
+    uint32_t fl,len,flags;	
 
     switch(previewMode)
     {
       case ADM_PREVIEW_NONE:
-        if(image)
+       {
+        if( !video_body-&gt;getUncompressedFrame(framenum+playbackOffset,rdrImage,&amp;flags))
         {
-            if(zoom==ZOOM_1_1 )
+          return 0; 
+        }
+            UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
+
+            if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
             {
                if(!defered_display) 
-                  renderUpdateImage(image-&gt;data);
+                  renderUpdateImage(rdrImage-&gt;data,zoom);
             }else
             {
                 ADM_assert(resizer);
                 ADM_assert(resized);
-                resizer-&gt;resize(image-&gt;data,resized-&gt;data);
+                resizer-&gt;resize(rdrImage-&gt;data,resized-&gt;data);
                 if(!defered_display) 
-                  renderUpdateImage(resized-&gt;data);
+                  renderUpdateImage(resized-&gt;data,zoom);
             }
         }
         break;
       case ADM_PREVIEW_OUTPUT:
             if(framenum&lt;=preview-&gt;getInfo()-&gt;nb_frames-1)
                   {
-                          if(!preview-&gt;getFrameNumberNoAlloc(framenum,&amp;len,previewImage,&amp;fl)) return;
-                          if(zoom==ZOOM_1_1)
+                          if(!preview-&gt;getFrameNumberNoAlloc(framenum,&amp;len,previewImage,&amp;fl)) return 0;
+                          if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
                           {
-                            if(!defered_display) renderUpdateImage(previewImage-&gt;data);
+                            if(!defered_display) renderUpdateImage(previewImage-&gt;data,zoom);
                           }
                           else
                           {
                              resizer-&gt;resize(previewImage-&gt;data,resized-&gt;data);
                              if(!defered_display) 
-                                  renderUpdateImage(resized-&gt;data);
+                                  renderUpdateImage(resized-&gt;data,zoom);
                           }
                   }
             break;
       case ADM_PREVIEW_SEPARATE:
             ADM_assert(preview);
             ADM_assert(previewImage);
-            if(zoom==ZOOM_1_1)
+            if(zoom==ZOOM_1_1 || renderHasAccelZoom()  )
             {
-              if(image &amp;&amp; !defered_display) renderUpdateImage(image-&gt;data);
+              if( !video_body-&gt;getUncompressedFrame(framenum+playbackOffset,rdrImage,&amp;flags))
+              {
+                  return 0; 
+              }
+              UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
+              if(!defered_display) renderUpdateImage(rdrImage-&gt;data,zoom);
             }else
             {
                 ADM_assert(resizer);
                 ADM_assert(resized);
-                resizer-&gt;resize(image-&gt;data,resized-&gt;data);
+                resizer-&gt;resize(rdrImage-&gt;data,resized-&gt;data);
                 if(!defered_display) 
-                  renderUpdateImage(resized-&gt;data);
+                  renderUpdateImage(resized-&gt;data,zoom);
             }
           if( GUI_PreviewStillAlive())
           {
@@ -361,21 +398,27 @@
               ADM_assert(previewImage);
               ADM_assert(original);
               
+              if( !video_body-&gt;getUncompressedFrame(framenum+playbackOffset,rdrImage,&amp;flags))
+              {
+                  return 0; 
+              }
+              UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
+              previewBlit(rdrImage,original,0,0);
               
-              previewBlit(image,original,0,0);
               if(preview-&gt;getFrameNumberNoAlloc(framenum,&amp;len,previewImage,&amp;fl))
               {
-                previewBlit(previewImage,original,_mainW,0);
+                previewBlit(previewImage,original,rdrPhysicalW,0);
               }
-              if(zoom==ZOOM_1_1)
+              else printf(&quot;Cannot get frame %u\n&quot;,framenum);
+              if(zoom==ZOOM_1_1  || renderHasAccelZoom() )
               {
                 if(!defered_display)
-                  renderUpdateImage(original-&gt;data);
+                  renderUpdateImage(original-&gt;data,zoom);
               }else
               {
                 resizer-&gt;resize(original-&gt;data,resized-&gt;data);
                 if(!defered_display) 
-                  renderUpdateImage(resized-&gt;data);
+                  renderUpdateImage(resized-&gt;data,zoom);
               }
               break;
         
@@ -384,20 +427,26 @@
               ADM_assert(previewImage);
               ADM_assert(original);
               
-              previewBlit(image,original,0,0);
+              if( !video_body-&gt;getUncompressedFrame(framenum+playbackOffset,rdrImage,&amp;flags))
+              {
+                  return 0; 
+              }
+              UI_setFrameType(  rdrImage-&gt;flags,rdrImage-&gt;_Qp);
+              previewBlit(rdrImage,original,0,0);
               if(preview-&gt;getFrameNumberNoAlloc(framenum,&amp;len,previewImage,&amp;fl))
               {
-                previewBlit(previewImage,original,0,_mainH);
+                previewBlit(previewImage,original,0,rdrPhysicalH);
               }
-              if(zoom==ZOOM_1_1)
+              else printf(&quot;Cannot get frame %u\n&quot;,framenum);
+              if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
               {
                 if(!defered_display)
-                  renderUpdateImage(original-&gt;data);
+                  renderUpdateImage(original-&gt;data,zoom);
               }else
               {
                 resizer-&gt;resize(original-&gt;data,resized-&gt;data);
                 if(!defered_display) 
-                  renderUpdateImage(resized-&gt;data);
+                  renderUpdateImage(resized-&gt;data,zoom);
               }
               break;
       default: ADM_assert(0);
@@ -419,40 +468,41 @@
       \brief display on screen immediately
 */
 
-void admPreview::displayNow(uint32_t framenum,ADMImage *image)
+void admPreview::displayNow(uint32_t framenum)
 {
+
     uint32_t fl,len;	
 
     switch(previewMode)
     {
       case ADM_PREVIEW_NONE:
            
-           if(zoom==ZOOM_1_1 )
+           if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
             {
-                renderUpdateImage(image-&gt;data);
+                renderUpdateImage(rdrImage-&gt;data,zoom);
             }else
             {
                 ADM_assert(resized);
-                renderUpdateImage(resized-&gt;data);
+                renderUpdateImage(resized-&gt;data,zoom);
             }
         break;
       case ADM_PREVIEW_OUTPUT:
-            if(zoom==ZOOM_1_1 )
+            if(zoom==ZOOM_1_1 || renderHasAccelZoom() )
             {
-                renderUpdateImage(previewImage-&gt;data);
+                renderUpdateImage(previewImage-&gt;data,zoom);
             }else
             {
                 ADM_assert(resized);
-                renderUpdateImage(resized-&gt;data);
+                renderUpdateImage(resized-&gt;data,zoom);
             }
             break;
       case ADM_PREVIEW_SEPARATE:
-            if(zoom==ZOOM_1_1 )
+            if(zoom==ZOOM_1_1 || renderHasAccelZoom()  )
             {
-                renderUpdateImage(image-&gt;data);
+                renderUpdateImage(rdrImage-&gt;data,zoom);
             }else{
                 ADM_assert(resized);
-                renderUpdateImage(resized-&gt;data);
+                renderUpdateImage(resized-&gt;data,zoom);
             }
             if( GUI_PreviewStillAlive())
             {
@@ -461,15 +511,16 @@
           break;
       case ADM_PREVIEW_SIDE:
       case ADM_PREVIEW_TOP:
-            if(zoom==ZOOM_1_1)
+            if(zoom==ZOOM_1_1|| renderHasAccelZoom() )
             {
-               renderUpdateImage(original-&gt;data);
+               renderUpdateImage(original-&gt;data,zoom);
             }else
             {
               ADM_assert(resized);
-              renderUpdateImage(resized-&gt;data);
+              renderUpdateImage(resized-&gt;data,zoom);
             }
               break;
       default: ADM_assert(0);
     }
+
 }

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_accelRender.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_accelRender.h	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_accelRender.h	2007-04-01 14:18:09 UTC (rev 2913)
@@ -17,7 +17,8 @@
                               AccelRender( void) {};
               virtual	uint8_t init(GUI_WindowInfo * window, uint32_t w, uint32_t h)=0;
               virtual	uint8_t end(void)=0;
-              virtual uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h)=0;
+              virtual uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h,renderZoom zoom=ZOOM_1_1)=0;
+              virtual uint8_t hasHwZoom(void) {return 0;}
               
 };
 #endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.cpp	2007-04-01 14:18:09 UTC (rev 2913)
@@ -76,6 +76,7 @@
 static uint8_t		    *lastImage=NULL;
 static void                 *draw=NULL;
 static uint32_t 	     renderW=0,renderH=0;
+static uint32_t              phyW=0,phyH=0; /* Unzoomed size, only used when accel can do hw resize */
 
 //_______________________________________
 /**
@@ -93,7 +94,7 @@
 
 */
 //----------------------------------------
-uint8_t renderResize(uint32_t w, uint32_t h)
+uint8_t renderResize(uint32_t w, uint32_t h,uint32_t pw, uint32_t ph)
 {
 int mul,xx,yy;
 
@@ -105,6 +106,8 @@
         screenBuffer=new uint8_t[w*h*4];
 
 	updateWindowSize( draw,w,h);
+        phyW=pw;
+        phyH=ph;
 	UI_purge();
 	return 1;
 
@@ -115,51 +118,30 @@
 
 */
 //----------------------------------------
-uint8_t renderUpdateImage(uint8_t *ptr)
+uint8_t renderUpdateImage(uint8_t *ptr,renderZoom zoom)
 {
-	
-        ADM_assert(screenBuffer);
-        lastImage=ptr;
 
-	if(!accel_mode)
-	 	GUI_ConvertRGB(ptr,screenBuffer, renderW,renderH);
-	renderRefresh();
-	return 1;
+    ADM_assert(screenBuffer);
+    lastImage=ptr;
 
-}
-/**
-      \fn renderUpdateImageBlit
-      \brief Blit the source into destination
-
-*/
-
-uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t h,uint32_t primary)
-{
-
-        ADM_assert(screenBuffer);
-        lastImage=NULL;
-        if(!accel_mode)
+    if(accel_mode)
+    {
+        if(accel_mode -&gt;hasHwZoom())
         {
-                GUI_ConvertRGBBlit(ptr,screenBuffer, renderW,renderH,startx,starty,w,h,primary);
-                if(primary) renderRefresh();
+           accel_mode-&gt;display(lastImage, phyW, phyH,zoom);
+        }else
+        {
+          accel_mode-&gt;display(lastImage, renderW, renderH,zoom);
         }
-        else
-        { /* Accel mode, in that case we need to blit our part of the image inside the big image
-              It is assumed the accel render part can work with YV12
-          */
-          /* Luma */
-          uint32_t pageR=(renderW*renderH);
-          uint32_t pageS=(w*h);
-          BitBlit(accelSurface+startx+starty*renderW,renderW,ptr,w,w,h);
-          BitBlit(accelSurface+pageR+(startx&gt;&gt;1)+(starty&gt;&gt;1)*(renderW&gt;&gt;1),renderW&gt;&gt;1,ptr+pageS,w&gt;&gt;1,w&gt;&gt;1,h&gt;&gt;1);
-          BitBlit(accelSurface+(pageR*5)/4+(startx&gt;&gt;1)+(starty&gt;&gt;1)*(renderW&gt;&gt;1),renderW&gt;&gt;1,ptr+(pageS*5)/4,w&gt;&gt;1,w&gt;&gt;1,h&gt;&gt;1);
+      
+    }else
+    {
+      GUI_ConvertRGB(ptr,screenBuffer, renderW,renderH);
+      renderRefresh();
+    }
+  return 1;
 
-          lastImage=accelSurface;
-          if(primary) renderRefresh();
-        }
-        return 1;
 }
-
 /**
 	Refresh the image from internal buffer / last image
 	Used for example as call back for X11 events
@@ -208,6 +190,7 @@
 char *displ;
 unsigned int renderI;
 ADM_RENDER_TYPE render;
+uint8_t r=0;
 	ADM_assert(!accel_mode);
 	// First check if local
 	// We do it in a very wrong way : If DISPLAY!=:0.0 we assume remote display
@@ -242,7 +225,9 @@
 #if defined(USE_XV)
 	       case RENDER_XV:
 		accel_mode=new XvAccelRender();
-		if(!accel_mode-&gt;init(&amp;xinfo,renderW,renderH))
+                if(accel_mode-&gt;hasHwZoom()) r=accel_mode-&gt;init(&amp;xinfo,phyW,phyH);
+                else r=accel_mode-&gt;init(&amp;xinfo,renderW,renderH);
+                if(!r)
 		{
 			delete accel_mode;
 			accel_mode=NULL;
@@ -258,7 +243,9 @@
               case RENDER_SDL:
 		printf(&quot;Trying SDL\n&quot;);
 		accel_mode=new sdlAccelRender();
-		if(!accel_mode-&gt;init(&amp;xinfo,renderW,renderH))
+		if(accel_mode-&gt;hasHwZoom()) r=accel_mode-&gt;init(&amp;xinfo,phyW,phyH);
+                else r=accel_mode-&gt;init(&amp;xinfo,renderW,renderH);
+                if(!r)
 		{
 			delete accel_mode;
 			accel_mode=NULL;
@@ -286,8 +273,16 @@
 	
 	return 1;
 }
+/**
+      \fn renderHasAccelZoom
+      \brief returns 1 if accel can do hw zoom
+*/
+uint8_t renderHasAccelZoom(void)
+{
+    if(!accel_mode) return 0;
+    return accel_mode-&gt;hasHwZoom(); 
+}
 
-
 uint8_t renderStopPlaying( void )
 {
 	if(accel_mode)

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_render.h	2007-04-01 14:18:09 UTC (rev 2913)
@@ -49,18 +49,18 @@
 
 ADM_PREVIEW_MODE getPreviewMode(void);
 void             setPreviewMode(ADM_PREVIEW_MODE preview);
-void changePreviewZoom(renderZoom nzoom);
+void             changePreviewZoom(renderZoom nzoom);
 
 class admPreview
 {
   public:
-      static void update(uint32_t framenum,ADMImage *image);
+      static uint8_t update(uint32_t framenum);
       static void start(void);
       static void stop(void);
       static void setMainDimension(uint32_t, uint32_t );
       static void updateFilters(AVDMGenericVideoStream *first,AVDMGenericVideoStream *last);
-      static void deferDisplay(uint32_t onoff);
-      static void displayNow(uint32_t framenum,ADMImage *image);
+      static void deferDisplay(uint32_t onoff,uint32_t startat);
+      static void displayNow(uint32_t framenum);
   
 };
 
@@ -69,16 +69,16 @@
 
 
 uint8_t renderInit( void );
-uint8_t renderResize(uint32_t w, uint32_t h);
+uint8_t renderResize(uint32_t w, uint32_t h,uint32_t phyW,uint32_t phyH);
 uint8_t renderRefresh(void);
 uint8_t renderExpose(void);
-uint8_t renderUpdateImage(uint8_t *ptr);
+uint8_t renderUpdateImage(uint8_t *ptr,renderZoom zoom);
 uint8_t renderUpdateImageBlit(uint8_t *ptr,uint32_t startx, uint32_t starty, uint32_t w, uint32_t,uint32_t primary);
 
 uint8_t renderStartPlaying( void );
 uint8_t renderStopPlaying( void );
+uint8_t renderHasAccelZoom(void);
 
-
 void *UI_getDrawWidget(void);
 void UI_rgbDraw(void *widg,uint32_t w, uint32_t h,uint8_t *ptr);
 void UI_updateDrawWindowSize(void *win,uint32_t w,uint32_t h);

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.cpp	2007-04-01 14:18:09 UTC (rev 2913)
@@ -178,7 +178,7 @@
         dst+=stride;          
     }   
 }
-uint8_t sdlAccelRender::display(uint8_t *ptr, uint32_t w, uint32_t h)
+uint8_t sdlAccelRender::display(uint8_t *ptr, uint32_t w, uint32_t h,renderZoom zoom)
 {
 int pitch;
 int page=w*h;

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.h	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_sdlRender.h	2007-04-01 14:18:09 UTC (rev 2913)
@@ -23,7 +23,7 @@
                                 sdlAccelRender( void ) ;
               virtual	uint8_t init( GUI_WindowInfo * window, uint32_t w, uint32_t h);
               virtual	uint8_t end(void);
-              virtual   uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h);
+              virtual   uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h,renderZoom zoom);
 };
 
 #endif

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.cpp	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.cpp	2007-04-01 14:18:09 UTC (rev 2913)
@@ -49,7 +49,7 @@
 static uint8_t 	GUI_XvList(Display * dis, uint32_t port, uint32_t * fmt);
 static uint8_t 	GUI_XvInit(GUI_WindowInfo * window, uint32_t w, uint32_t h);
 static void 	GUI_XvEnd( void );
-static uint8_t 	GUI_XvDisplay(uint8_t * src, uint32_t w, uint32_t h);
+static uint8_t 	GUI_XvDisplay(uint8_t * src, uint32_t w, uint32_t h,renderZoom zoom);
 static uint8_t 	GUI_XvSync(void);
 
 static uint8_t getAtom(char *string);
@@ -70,9 +70,9 @@
 	 return 1;
 }
 
-uint8_t XvAccelRender::display(uint8_t *ptr, uint32_t w, uint32_t h)
+uint8_t XvAccelRender::display(uint8_t *ptr, uint32_t w, uint32_t h,renderZoom zoom)
 {
-	return GUI_XvDisplay(ptr, w, h);
+	return GUI_XvDisplay(ptr, w, h,zoom);
 }
 //________________Wrapper around Xv_______________
 
@@ -110,9 +110,9 @@
 }
 
 //------------------------------------
-uint8_t GUI_XvDisplay(uint8_t * src, uint32_t w, uint32_t h)
+uint8_t GUI_XvDisplay(uint8_t * src, uint32_t w, uint32_t h,renderZoom zoom)
 {
-
+    uint32_t destW,destH;
     if (xvimage)
       {
 
@@ -122,11 +122,24 @@
 	  // total 1.5*
          XLockDisplay (xv_display);
 	  memcpy(xvimage-&gt;data, src, (w*h*3)&gt;&gt;1);
-	
+          uint32_t factor=4;
+        switch(zoom)
+        {
+            case ZOOM_1_4: factor=1;break;
+            case ZOOM_1_2: factor=2;break;
+            case ZOOM_1_1: factor=4;break;
+            case ZOOM_2:   factor=8;break;
+            case ZOOM_4:   factor=16;break;
+            default : ADM_assert(0);
+          
+        }
+	destW=(w*factor)/4;
+        destH=(h*factor)/4;
+        //printf(&quot;%u x %u =&gt; %u x %u\n&quot;,w,h,destW,destH);
         // And display it !
 #if 1
 	  XvShmPutImage(xv_display, xv_port, xv_win, xv_gc, xvimage, 0, 0, w, h,	// src
-			0, 0, w, h,	// dst
+			0, 0, destW, destH,	// dst
 			False);
 #else
 	 XvPutImage(xv_display, xv_port, xv_win, xv_gc, xvimage, 0, 0, w, h,	// src

Modified: branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.h	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/ADM_userInterfaces/ADM_commonUI/GUI_xvRender.h	2007-04-01 14:18:09 UTC (rev 2913)
@@ -23,7 +23,8 @@
                               XvAccelRender( void ) ;
               virtual	uint8_t init( GUI_WindowInfo *  window, uint32_t w, uint32_t h);
               virtual	uint8_t end(void);				
-              virtual uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h);
+              virtual uint8_t display(uint8_t *ptr, uint32_t w, uint32_t h,renderZoom zoom);
+                      uint8_t hasHwZoom(void) {return 1;}
 };
 #endif
 

Modified: branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidAnimated.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidAnimated.cpp	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/ADM_video/ADM_vidAnimated.cpp	2007-04-01 14:18:09 UTC (rev 2913)
@@ -48,7 +48,7 @@
 #define LOOKUP 4
 #define CACHE_SIZE (LOOKUP*2+3)
 
-extern uint8_t Util_saveJpg (char *name,uint32_t w, uint32_t,ADMImage *image);
+
 extern uint8_t DIA_animated(ANIMATED_PARAM *param);
 
 uint8_t ADMVideoAnimated::configure(AVDMGenericVideoStream *in)

Modified: branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/gtk_gui.cpp	2007-04-01 14:18:09 UTC (rev 2913)
@@ -139,7 +139,7 @@
 uint8_t A_jumpToTime(uint32_t hh,uint32_t mm,uint32_t ss);
 //__________
 extern uint8_t DIA_gotoTime(uint16_t *hh, uint16_t *mm, uint16_t *ss);
-extern uint8_t GUI_getFrame(uint32_t frameno, ADMImage *image, uint32_t *flags);
+extern uint8_t GUI_getFrame(uint32_t frameno,  uint32_t *flags);
 extern int A_SaveUnpackedVop(const char *name);
 extern int A_SavePackedVop(const char *name);
 extern void      videoCodecConfigureUI(void);
@@ -166,7 +166,6 @@
 extern const char * GUI_getCustomScript(uint32_t nb);
 extern gboolean SliderIsShifted;
 
-ADMImage *rdr_decomp_buffer=NULL;
 
 
 
@@ -462,7 +461,7 @@
         case ACT_ZOOM_4_1:
                 currentZoom=(renderZoom)((action-ACT_ZOOM_1_4)+ZOOM_1_4);
                 changePreviewZoom(currentZoom);
-                admPreview::update(curframe,rdr_decomp_buffer);
+                admPreview::update(curframe);
                 break;
 
 
@@ -642,7 +641,7 @@
             admPreview::stop();
             setPreviewMode(newpreview);
             admPreview::start();
-            admPreview::update(curframe,rdr_decomp_buffer);
+            admPreview::update(curframe);
       }
       break;
     case ACT_StopAvi:
@@ -893,7 +892,7 @@
       if (getPreviewMode()!=ADM_PREVIEW_NONE)
       {
          admPreview::start();
-         admPreview::update (curframe,rdr_decomp_buffer);
+         admPreview::update (curframe);
       }
       break;
 
@@ -983,12 +982,6 @@
       filterCleanUp ();
 
 
-      if (rdr_decomp_buffer)
-	{
-	  delete  rdr_decomp_buffer;
-	  rdr_decomp_buffer = NULL;
-	}
-
     }
   DIA_StartBusy ();
   /*
@@ -1106,8 +1099,8 @@
 
   curframe = 0;
   getFirstVideoFilter(); // reinit first filter
-  ADM_assert (rdr_decomp_buffer =new ADMImage(avifileinfo-&gt;width,avifileinfo-&gt;height));
 
+
   //frameStart = 0;
   //frameEnd = avifileinfo-&gt;nb_frames - 1;
   video_body-&gt;getMarkers(&amp;frameStart,&amp;frameEnd);
@@ -1186,15 +1179,8 @@
         
   
   
-  if(!GUI_getFrame( curframe, rdr_decomp_buffer,NULL))
-  {
-    GUI_Error_HIG (_(&quot;Could not decode the frame&quot;), NULL);
-    }
-  else
-    {
-      admPreview::update (curframe,rdr_decomp_buffer);
-      update_status_bar(rdr_decomp_buffer);
-    }
+      admPreview::update (curframe);
+      update_status_bar();
    
    printf(&quot;\n** conf updated **\n&quot;);
 }
@@ -1367,7 +1353,14 @@
 ________________________________________________________*/
 int A_saveJpg (char *name)
 {
-    return (int) Util_saveJpg (name,avifileinfo-&gt;width, avifileinfo-&gt;height,rdr_decomp_buffer);
+  uint8_t fl;
+    ADMImage image(avifileinfo-&gt;width, avifileinfo-&gt;height);
+    if(!GUI_getFrameContent(&amp;image, curframe))
+    {
+      GUI_Error_HIG(_(&quot;Get Frame&quot;),_(&quot;Cannot get this frame to save&quot;));
+      return 0; 
+    }
+    return (int) Util_saveJpg (name,avifileinfo-&gt;width, avifileinfo-&gt;height,NULL);
 }
 #else
 
@@ -1457,7 +1450,7 @@
 	for(curImg=frameStart;curImg&lt;=frameEnd;curImg++)
 	{	
                 working-&gt;update(curImg-frameStart,frameEnd-frameStart);	
-		if (!GUI_getFrame (curImg, src,NULL))
+		if (!GUI_getFrameContent (src,curImg ))
 		{
                   GUI_Error_HIG(_(&quot;Cannot decode frame&quot;), _(&quot;Aborting.&quot;));
 			goto _bunch_abort;
@@ -1530,8 +1523,9 @@
 	bmph.colorEncoding=0;
 */
 
+  ADMImage image(avifileinfo-&gt;width,avifileinfo-&gt;height);
+  GUI_getFrameContent(&amp;image, curframe);
 
-
   printf (&quot;\n %u x %u=%u\n&quot;, bmph.biWidth, bmph.biHeight, sz);
 
   uint8_t *out;
@@ -1543,7 +1537,7 @@
 		return;
 	}
 
-	 if(!COL_yv12rgbBMP(bmph.biWidth, bmph.biHeight,rdr_decomp_buffer-&gt;data, out))
+	 if(!COL_yv12rgbBMP(bmph.biWidth, bmph.biHeight,image.data, out))
 	 {
            GUI_Error_HIG(_(&quot;Error converting to BMP&quot;), NULL);
 		return;
@@ -2131,7 +2125,7 @@
   {
 	work-&gt;update(i, nb);
       	if(!work-&gt;isAlive()) break;
-	if(!GUI_getFrame (i, aImage,NULL))
+	if(!GUI_getFrameContent (aImage,i))
 	{
 		error ++;
 		printf(&quot;Frame %u has error\n&quot;,i);
@@ -2519,7 +2513,7 @@
 /// Update all  informations : current frame # and current time, total frame ...
 ///_____________________________________________________________
 
-void  update_status_bar(ADMImage *frame)
+void  update_status_bar(void)
 {
     char text[80];
     double len;
@@ -2530,8 +2524,7 @@
  
 	UI_updateFrameCount( curframe);
 	UI_updateTimeCount( curframe,avifileinfo-&gt;fps1000);
-        if(frame)
-	       UI_setFrameType(  frame-&gt;flags,frame-&gt;_Qp);
+       
     // progress bar
     len = 100;
     if(avifileinfo-&gt;nb_frames&gt;1)
@@ -2570,6 +2563,15 @@
      UI_setScale(len);
 }
 
+/**
+      \fn GUI_getFrameContent
+      \brief fill image with content of frame frame
+*/
+uint8_t GUI_getFrameContent(ADMImage *image, uint32_t frame)
+{
+  uint32_t flags;
+  if(!video_body-&gt;getUncompressedFrame(frame,image,&amp;flags)) return 0;
+  return 1; 
+}
 
-
 // EOF

Modified: branches/avidemux_2.4_branch/avidemux/gtkgui.h
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gtkgui.h	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/gtkgui.h	2007-04-01 14:18:09 UTC (rev 2913)
@@ -20,7 +20,7 @@
 void 			A_saveAudioDecoded	(char *name);
 void 			A_saveAVI		(char *name);
 void 			A_playAvi		(void);
-void 			update_status_bar(ADMImage *image );
+void 			update_status_bar(void );
 void 			rebuild_status_bar(void );
 
 
@@ -35,13 +35,7 @@
 void GUI_detransient(void );
 void GUI_retransient(void );
 
-typedef enum pipID
-{
-	P_TOOLAME,
-	P_LAME,
-	P_OTHER
-};
- void A_Pipe(pipID who,char *file=NULL );
+uint8_t GUI_getFrameContent(ADMImage *image, uint32_t frame);
 
 //EOF
 

Modified: branches/avidemux_2.4_branch/avidemux/gui_navigate.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/gui_navigate.cpp	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/gui_navigate.cpp	2007-04-01 14:18:09 UTC (rev 2913)
@@ -45,19 +45,18 @@
 #include &quot;ADM_filter/video_filters.h&quot;
     
 extern void    UI_purge(void );
-extern ADMImage *rdr_decomp_buffer;
 //____________________________________
 
-uint8_t GUI_getFrame(uint32_t frameno, ADMImage *image, uint32_t *flags)
+uint8_t GUI_getFrame(uint32_t frameno,  uint32_t *flags)
 {
 uint32_t len;
 
 	//return video_body-&gt;getUncompressedFrame(frameno,image,flags);
 	AVDMGenericVideoStream *filter=getFirstCurrentVideoFilter( );
 	ADM_assert(filter);
-	return filter-&gt;getFrameNumberNoAlloc(frameno,&amp;len,image,flags);
-	
+	return 1;
 
+
 }
 void GUI_NextFrame(void)
 {
@@ -71,15 +70,15 @@
 
     if (avifileinfo)
       {
-        if( !GUI_getFrame(curframe + 1,rdr_decomp_buffer,&amp;flags))
+        if( !GUI_getFrame(curframe + 1,&amp;flags))
         	{
                   GUI_Error_HIG(_(&quot;Decompressing error&quot;),_( &quot;Cannot decode next frame.&quot;));
            	}
            else
             {
                   curframe++;
-                  admPreview::update( curframe,rdr_decomp_buffer) ;
-                  update_status_bar(rdr_decomp_buffer);
+                  admPreview::update( curframe) ;
+                  update_status_bar();
   
                 UI_purge();
             }
@@ -109,13 +108,13 @@
 		else
 		{
                         curframe=f;
-                        if( !GUI_getFrame(curframe,rdr_decomp_buffer,&amp;flags))
+                        if( !GUI_getFrame(curframe,&amp;flags))
                         {
                           GUI_Error_HIG(_(&quot;Decompressing error&quot;),_( &quot;Cannot decode keyframe.&quot;));
                         }
                         
-                        admPreview::update( curframe,rdr_decomp_buffer) ;
-                        update_status_bar(rdr_decomp_buffer);
+                        admPreview::update( curframe) ;
+                        update_status_bar();
                         UI_purge();
 		}
 		
@@ -133,6 +132,11 @@
     uint32_t sz = width * height ;
     const int maxnonb=(width* height)&gt;&gt;8;
 
+    return 0;
+#warning FIXME
+#warning FIXME
+#warning FIXME
+#if 0
     uint8_t *buff;
 
     int cnt4=0;
@@ -146,7 +150,7 @@
 	if(cnt4&gt;=maxnonb)
 	  return(1);
     }
-
+#endif
     return(0);
 }
 //**********************************************************************
@@ -160,8 +164,11 @@
 static int sliceScanNotBlack(int darkness, int maxnonb, int sliceNum)
 {
 
-{
-
+  return 0;
+#warning FIXME
+#warning FIXME
+#warning FIXME
+#if 0
     uint32_t width = avifileinfo-&gt;width;
     uint32_t height = avifileinfo-&gt;height&gt;&gt;3;
     uint32_t sz = width * height ;    
@@ -184,7 +191,7 @@
     }
     //printf(&quot;Slice : %d count:%d max:%d\n&quot;,sliceNum,cnt4,maxnonb);
     return(0);
-}
+#endif
 
 }
 uint8_t  fastIsNotBlack(int darkness)
@@ -218,7 +225,7 @@
    uint16_t reresh_count=0;
    uint32_t orgFrame;
    uint32_t r=1; 
-
+#if 0
     if (playing)
 		return;
     if (! avifileinfo)
@@ -266,9 +273,12 @@
     update_status_bar(rdr_decomp_buffer);
 
    return ;
+#endif
 }
 uint8_t A_ListAllBlackFrames(char *name)
 {
+  return 0;
+#if 0
 // Print a list of all black frames
 //_____________________________________________________________
     uint32_t f;
@@ -339,6 +349,7 @@
      update_status_bar(rdr_decomp_buffer);
 
     return 1;
+#endif
 }
 //**********************************************************************
 
@@ -373,15 +384,15 @@
               return 0;
     
 
-      if( !GUI_getFrame(frame ,rdr_decomp_buffer,&amp;flags))
+      if( !GUI_getFrame(frame ,&amp;flags))
       {
         GUI_Error_HIG(_(&quot;Decompressing error&quot;),_( &quot;Cannot decode the frame.&quot;));
               return 0;
       }
 
       curframe = frame;
-      admPreview::update( curframe,rdr_decomp_buffer) ;
-      update_status_bar(rdr_decomp_buffer);
+      admPreview::update( curframe) ;
+      update_status_bar();
       UI_purge();
       
       return 1;
@@ -409,14 +420,14 @@
             else
             {
                     curframe=f;
-                    if( !GUI_getFrame(curframe,rdr_decomp_buffer,&amp;flags))
+                    if( !GUI_getFrame(curframe,&amp;flags))
                     {
                       GUI_Error_HIG(_(&quot;Decompressing error&quot;),_( &quot;Cannot decode keyframe.&quot;));
                     }
                     
-                    admPreview::update( curframe,rdr_decomp_buffer) ;
+                    admPreview::update( curframe) ;
 
-                    update_status_bar(rdr_decomp_buffer);
+                    update_status_bar();
                     UI_purge();
             }
               

Modified: branches/avidemux_2.4_branch/avidemux/guiplay.cpp
===================================================================
--- branches/avidemux_2.4_branch/avidemux/guiplay.cpp	2007-03-30 16:35:56 UTC (rev 2912)
+++ branches/avidemux_2.4_branch/avidemux/guiplay.cpp	2007-04-01 14:18:09 UTC (rev 2913)
@@ -60,9 +60,9 @@
 
 #define EVEN(x) (x&amp;0xffffffe)
 
- extern ADMImage *rdr_decomp_buffer;
+ 
 
- extern uint8_t GUI_getFrame(uint32_t frameno, ADMImage *image, uint32_t *flags);
+ extern uint8_t GUI_getFrame(uint32_t frameno,  uint32_t *flags);
 //___________________________________
 uint8_t stop_req;
 static int called = 0;
@@ -87,7 +87,6 @@
 
     uint32_t framelen,flags;
     AVDMGenericVideoStream *filter;
-    ADMImage *buffer=NULL;
 
     vids = 0, auds = 0, dauds = 0;
     // check we got everything...
@@ -124,17 +123,10 @@
     one_frame = (uint32_t) floor(1000.*1000.*10. / filter-&gt;getInfo()-&gt;fps1000);
     err = one_frame % 10;
     one_frame /= 10; // Duration of a frame in ms, err =leftover in 1/10 ms
-    buffer=new ADMImage(filter-&gt;getInfo()-&gt;width,filter-&gt;getInfo()-&gt;height);
+    
     // go to RealTime...    
     printf(&quot; One frame : %lu, err=%lu ms\n&quot;, one_frame, err);
-    // read frame in chunk
-    if(!filter-&gt;getFrameNumberNoAlloc(1,&amp;framelen,buffer,&amp;flags))
-    {
-        printf(&quot;\n cannot read frame!\n&quot;);
-        goto abort_play;
-    }
-      curframe++;
-      played_frame++;
+    
     // prepare 1st frame
 
     stop_req = 0;
@@ -148,13 +140,13 @@
      //renderStartPlaying();
 // reset timer reference
     resetTime();
-    admPreview::deferDisplay(1);
-    admPreview::update(played_frame,buffer);
+    admPreview::deferDisplay(1,curframe);
+    admPreview::update(played_frame);
     do
     {
         vids++;
-        admPreview::displayNow(played_frame,buffer);;
-        update_status_bar(buffer);
+        admPreview::displayNow(played_frame);;
+        update_status_bar();
         if (time_a == 0)
             time_a = getTime(0);
         // mark !
@@ -166,12 +158,8 @@
             printf(&quot;\n End met (%lu  / %lu )\n&quot;,played_frame,max);
             goto abort_play;
          }
-        if(!filter-&gt;getFrameNumberNoAlloc(played_frame+1,&amp;framelen,buffer,&amp;flags))
-        {
-            printf(&quot;\n cannot read frame!\n&quot;);
-            goto abort_play;
-        }
-        admPreview::update(played_frame+1,buffer);;
+        
+        admPreview::update(played_frame+1);;
 	curframe++;
 	played_frame++;
 
@@ -222,13 +210,13 @@
     // go back to normal display mode
     //____________________________________
     playing = 0;
-	  delete  buffer;
+    uint32_t f;
           
 	   getFirstVideoFilter( );
-	   GUI_getFrame(curframe, rdr_decomp_buffer, &amp;flags);
-           admPreview::deferDisplay(0);
+	   GUI_getFrame(curframe,&amp;f);
+           admPreview::deferDisplay(0,0);
            // Updated by expose ? admPreview::update(curframe,rdr_decomp_buffer);
-     	   update_status_bar(rdr_decomp_buffer);
+     	   update_status_bar();
 #ifdef HAVE_AUDIO
     if (currentaudiostream)
       {


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000232.html">[Avidemux-svn-commit] r2914 -	branches/avidemux_2.4_branch/avidemux/ADM_libraries/ADM_lavcodec/i386
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#231">[ date ]</a>
              <a href="thread.html#231">[ thread ]</a>
              <a href="subject.html#231">[ subject ]</a>
              <a href="author.html#231">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/avidemux-svn-commit">More information about the Avidemux-svn-commit
mailing list</a><br>
</body></html>
